{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTQ0MzM0", "number": 1124, "title": "Part 1 - Metric notifications", "bodyText": "Added metric interface for a dynamic number of attributes / tags\nEnabled NotificationManager to send notifications through more than one\nNotificationService\n\n\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-01T21:01:47Z", "url": "https://github.com/AthenZ/athenz/pull/1124", "merged": true, "mergeCommit": {"oid": "366052cd65d6399e9ca2b7414b49f7d29737330a"}, "closed": true, "closedAt": "2020-10-02T15:52:53Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOYIiGgFqTUwMDcyNjI3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOoEAMgFqTUwMTI1Mzk5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzI2Mjc3", "url": "https://github.com/AthenZ/athenz/pull/1124#pullrequestreview-500726277", "createdAt": "2020-10-01T21:19:13Z", "commit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxOToxM1rOHbbK5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxOToxM1rOHbbK5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxODc1OQ==", "bodyText": "Will implement this in server_common in next PR", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498518759", "createdAt": "2020-10-01T21:19:13Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java", "diffHunk": "@@ -86,6 +88,15 @@ default void increment(String metric, String requestDomainName, String principal\n         increment(metric, requestDomainName);\n     }\n \n+    /**\n+     * Increment the counter for the specified metric with the specified attributes\n+     * @param metric Name of the counter\n+     * @param attributes Attributes for the metric (tags)\n+     */\n+    default void increment(String metric, Map<String, String> attributes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzI3Mzg4", "url": "https://github.com/AthenZ/athenz/pull/1124#pullrequestreview-500727388", "createdAt": "2020-10-01T21:21:21Z", "commit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToyMToyMVrOHbbN7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToyMToyMVrOHbbN7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxOTUzNQ==", "bodyText": "Notification Manager can now send notifications to multiple Notification Services.\nUsers will need to specify the NotificationServiceFactory classes in a comma-separated property.", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498519535", "createdAt": "2020-10-01T21:21:21Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -30,22 +31,28 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(NotificationManager.class);\n \n-    private NotificationService notificationService;\n+    private List<NotificationService> notificationServices = new ArrayList<>();\n     private ScheduledExecutorService scheduledExecutor;\n     private List<NotificationTask> notificationTasks;\n \n     public NotificationManager(List<NotificationTask> notificationTasks) {\n         this.notificationTasks = notificationTasks;\n-        String notificationServiceFactoryClass = System.getProperty(NOTIFICATION_PROP_SERVICE_FACTORY_CLASS);\n-        if (notificationServiceFactoryClass != null) {\n-            NotificationServiceFactory notificationServiceFactory;\n-            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzMyODAz", "url": "https://github.com/AthenZ/athenz/pull/1124#pullrequestreview-500732803", "createdAt": "2020-10-01T21:31:12Z", "commit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTozMToxMlrOHbbcyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTozMToxMlrOHbbcyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMzMzOQ==", "bodyText": "Load a metric object and pass it to MetricNotificationService.\nThe metric can be a different implementation than the one used by ZTS / ZMS.", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498523339", "createdAt": "2020-10-01T21:31:12Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/MetricNotificationServiceFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification.impl;\n+\n+import com.yahoo.athenz.common.metrics.Metric;\n+import com.yahoo.athenz.common.metrics.MetricFactory;\n+import com.yahoo.athenz.common.server.notification.NotificationService;\n+import com.yahoo.athenz.common.server.notification.NotificationServiceFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.yahoo.athenz.common.ServerCommonConsts.METRIC_DEFAULT_FACTORY_CLASS;\n+\n+public class MetricNotificationServiceFactory implements NotificationServiceFactory {\n+\n+    public static final String NOTIFICATION_PROP_METRIC_FACTORY_CLASS = \"athenz.notification.metric_factory_class\";\n+\n+    private final static Logger LOG = LoggerFactory.getLogger(MetricNotificationServiceFactory.class);\n+\n+    @Override\n+    public NotificationService create() {\n+        return new MetricNotificationService(loadMetricObject());\n+    }\n+\n+    Metric loadMetricObject() {\n+\n+        String metricFactoryClass = System.getProperty(NOTIFICATION_PROP_METRIC_FACTORY_CLASS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzQ2NzIz", "url": "https://github.com/AthenZ/athenz/pull/1124#pullrequestreview-500746723", "createdAt": "2020-10-01T21:58:29Z", "commit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTo1ODoyOVrOHbcFTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTo1ODoyOVrOHbcFTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzcwOQ==", "bodyText": "why are we using this from the mysql library? I believe jetty already has one called identically so maybe we should be using that instead?", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498533709", "createdAt": "2020-10-01T21:58:29Z", "author": {"login": "havetisyan"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n+import com.mysql.cj.util.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a09049d1a73383d06854acf37dc9c8a7d514d6a", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/4a09049d1a73383d06854acf37dc9c8a7d514d6a", "committedDate": "2020-10-02T15:02:28Z", "message": "Part 1 - Metric notifications\n1. Added metric interface for a dynamic number of attributes / tags\n2. Enabled NotificationManager to send notifications through more than one\nNotificationService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "committedDate": "2020-10-02T15:02:40Z", "message": "Added notification types to Notifications\nThey will be used as an attribute when recording metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28bd36789a831f2d3c542ad5123b2c6efbde482f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/28bd36789a831f2d3c542ad5123b2c6efbde482f", "committedDate": "2020-10-02T14:59:07Z", "message": "Added notification types to Notifications\nThey will be used as an attribute when recording metrics"}, "afterCommit": {"oid": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d", "committedDate": "2020-10-02T15:02:40Z", "message": "Added notification types to Notifications\nThey will be used as an attribute when recording metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjUzOTkw", "url": "https://github.com/AthenZ/athenz/pull/1124#pullrequestreview-501253990", "createdAt": "2020-10-02T15:52:45Z", "commit": {"oid": "d32d42e8c8c447f2f0d7d5d9d16f60a53fb6662d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2906, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}