{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MDgxODM1", "number": 1034, "title": "Added query to get all roles for principal", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-07-09T20:38:47Z", "url": "https://github.com/AthenZ/athenz/pull/1034", "merged": true, "mergeCommit": {"oid": "bfce9e2f8e819fe0fd2d88a86a02aac265c30ab9"}, "closed": true, "closedAt": "2020-07-15T16:07:39Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0Hz1nABqjM1MzY4ODkzODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1M7GegFqTQ0OTEwMjc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0699db85c24d92d03dc7855fa22f31fed23f5885", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/0699db85c24d92d03dc7855fa22f31fed23f5885", "committedDate": "2020-07-09T20:30:15Z", "message": "Added query to get all roles for principal"}, "afterCommit": {"oid": "9b8a0a00b65b5ea30b2bb1a43dc2eb3ea7b91387", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/9b8a0a00b65b5ea30b2bb1a43dc2eb3ea7b91387", "committedDate": "2020-07-12T07:00:55Z", "message": "Added query to get all roles for principal"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b8a0a00b65b5ea30b2bb1a43dc2eb3ea7b91387", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/9b8a0a00b65b5ea30b2bb1a43dc2eb3ea7b91387", "committedDate": "2020-07-12T07:00:55Z", "message": "Added query to get all roles for principal"}, "afterCommit": {"oid": "a1697bca4b235edda3115f8342530765ac38c87f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a1697bca4b235edda3115f8342530765ac38c87f", "committedDate": "2020-07-12T08:18:02Z", "message": "Added query to get all roles for principal"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1697bca4b235edda3115f8342530765ac38c87f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/a1697bca4b235edda3115f8342530765ac38c87f", "committedDate": "2020-07-12T08:18:02Z", "message": "Added query to get all roles for principal"}, "afterCommit": {"oid": "6eaaab108dea843fcc122fa854b2d01426f46a05", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/6eaaab108dea843fcc122fa854b2d01426f46a05", "committedDate": "2020-07-12T12:26:25Z", "message": "Added query to get all roles for principal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTIyMjg1", "url": "https://github.com/AthenZ/athenz/pull/1034#pullrequestreview-446922285", "createdAt": "2020-07-13T00:05:39Z", "commit": {"oid": "6eaaab108dea843fcc122fa854b2d01426f46a05"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMDowNTozOVrOGwYJRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMDowNTozOVrOGwYJRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM4MDQyMA==", "bodyText": "can we also extend this to include an optional domainName attribute where I would only return the role names from the given domain name if specified. We don't have an API that just returns the role names that a given principal is member  in a domain so we don't want them to get the full list and then parse and filter out the domain they're interested in.", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453380420", "createdAt": "2020-07-13T00:05:39Z", "author": {"login": "havetisyan"}, "path": "core/zms/src/main/rdl/Role.rdli", "diffHunk": "@@ -129,6 +129,19 @@ resource DomainRoleMembers GET \"/domain/{domainName}/member\" {\n     }\n }\n \n+// Fetch all the roles across domains by either calling or specified principal\n+resource DomainRoleMember GET \"/all_roles?principal={principal}\" (name=GetAllRoles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eaaab108dea843fcc122fa854b2d01426f46a05"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6eaaab108dea843fcc122fa854b2d01426f46a05", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/6eaaab108dea843fcc122fa854b2d01426f46a05", "committedDate": "2020-07-12T12:26:25Z", "message": "Added query to get all roles for principal"}, "afterCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/06aa599d510acef180213cf293282194938d59c7", "committedDate": "2020-07-13T10:43:09Z", "message": "Added query to get all roles for principal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzU4Mzk2", "url": "https://github.com/AthenZ/athenz/pull/1034#pullrequestreview-447358396", "createdAt": "2020-07-13T15:27:35Z", "commit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToyNzozNlrOGwtthg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo1MToyOFrOGwuzxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczMzc2Ng==", "bodyText": "we should remove the previous line", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453733766", "createdAt": "2020-07-13T15:27:36Z", "author": {"login": "havetisyan"}, "path": "clients/java/zms/pom.xml", "diffHunk": "@@ -28,6 +28,7 @@\n \n   <properties>\n     <code.coverage.min>0.42</code.coverage.min>\n+    <code.coverage.min>0.95</code.coverage.min>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNjMyMg==", "bodyText": "we should also return the system disabled flag if we're return all the other attributes", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453736322", "createdAt": "2020-07-13T15:31:15Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -1639,6 +1640,51 @@ public DomainRoleMembers listDomainRoleMembers(String domainName) {\n         return listReviewRoleMembersWithFilter(domainName, (roleMember -> true), \"listDomainRoleMembers\");\n     }\n \n+    @Override\n+    public DomainRoleMember getAllRoles(String principal, String domainName) {\n+        DomainRoleMember domainRoleMember = new DomainRoleMember();\n+        domainRoleMember.setMemberName(principal);\n+        domainRoleMember.setMemberRoles(new ArrayList<>());\n+\n+        if (!StringUtil.isEmpty(domainName)) {\n+            getDomainRolesForPrincipal(principal, domainRoleMember, domainName);\n+        } else {\n+            String[] fnames = getDomainList();\n+            for (String domain : fnames) {\n+                getDomainRolesForPrincipal(principal, domainRoleMember, domain);\n+            }\n+        }\n+\n+        return domainRoleMember;\n+    }\n+\n+    private void getDomainRolesForPrincipal(String principal, DomainRoleMember domainRoleMember, String domain) {\n+        DomainStruct dom = getDomainStruct(domain);\n+        if (dom == null) {\n+            return;\n+        }\n+\n+        for (Role role: dom.getRoles().values()) {\n+            List<RoleMember> roleMembers = role.getRoleMembers();\n+            if (roleMembers == null) {\n+                continue;\n+            }\n+            for (RoleMember roleMember : roleMembers) {\n+                if (!roleMember.getMemberName().equals(principal)) {\n+                    continue;\n+                }\n+\n+                MemberRole memberRole = new MemberRole();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczODE5NA==", "bodyText": "we should. handle the case where we have an invalid domain:\n    if (domainId == 0) {\n        throw notFoundError(caller, ZMSConsts.OBJECT_DOMAIN, domainName);\n    }\n\nand we should have a unit test case for this as well.", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453738194", "createdAt": "2020-07-13T15:33:57Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/jdbc/JDBCConnection.java", "diffHunk": "@@ -3751,6 +3765,65 @@ public DomainRoleMembers listDomainRoleMembers(String domainName) {\n         return listDomainRoleMembersWithQuery(domainName, SQL_GET_DOMAIN_ROLE_MEMBERS, \"listDomainRoleMembers\");\n     }\n \n+    @Override\n+    public DomainRoleMember getAllRoles(String principal, String domainName) {\n+        final String caller = \"getAllRoles\";\n+\n+        int principalId = getPrincipalId(principal);\n+        if (principalId == 0) {\n+            throw notFoundError(caller, ZMSConsts.OBJECT_PRINCIPAL, principal);\n+        }\n+\n+        DomainRoleMember roleMember = new DomainRoleMember();\n+        roleMember.setMemberRoles(new ArrayList<>());\n+        roleMember.setMemberName(principal);\n+        if (StringUtil.isEmpty(domainName)) {\n+            try (PreparedStatement ps = con.prepareStatement(SQL_GET_ALL_ROLES)) {\n+                ps.setInt(1, principalId);\n+                return getRolesForPrincipal(caller, roleMember, ps);\n+            } catch (SQLException ex) {\n+                throw sqlError(ex, caller);\n+            }\n+        } else {\n+            int domainId = getDomainId(domainName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NDM5MA==", "bodyText": "if domainName is specified, we need to validate its value as well", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453744390", "createdAt": "2020-07-13T15:40:57Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2956,6 +2957,34 @@ public DomainRoleMembers getDomainRoleMembers(ResourceContext ctx, String domain\n         return roleMembers;\n     }\n \n+    @Override\n+    public DomainRoleMember getAllRoles(ResourceContext context, String principal, String domainName) {\n+        final String caller = \"getallroles\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        logPrincipal(context);\n+\n+        if (StringUtil.isEmpty(principal)) {\n+            // If principal not specified, get roles for current user\n+            principal = ((RsrcCtxWrapper) context).principal().getFullName();\n+        }\n+        validateRequest(context.request(), caller);\n+        validate(principal, TYPE_ENTITY_NAME, caller);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc1MTc1MA==", "bodyText": "for the uri should be consistent with others and use the first component as the object type, e.g. /domain, /resource,e tc.\nwe should just call it /role instead of /all_roles and instead of getAllRoles, let's call the API as getPrincipalRoles", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r453751750", "createdAt": "2020-07-13T15:51:28Z", "author": {"login": "havetisyan"}, "path": "core/zms/src/main/rdl/Role.rdli", "diffHunk": "@@ -129,6 +129,20 @@ resource DomainRoleMembers GET \"/domain/{domainName}/member\" {\n     }\n }\n \n+// Fetch all the roles across domains by either calling or specified principal\n+resource DomainRoleMember GET \"/all_roles?principal={principal}&domain={domainName}\" (name=GetAllRoles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06aa599d510acef180213cf293282194938d59c7", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/06aa599d510acef180213cf293282194938d59c7", "committedDate": "2020-07-13T10:43:09Z", "message": "Added query to get all roles for principal"}, "afterCommit": {"oid": "d5a953a08431ef099c98c3c44b9d5cd9bdc1d6fb", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/d5a953a08431ef099c98c3c44b9d5cd9bdc1d6fb", "committedDate": "2020-07-13T20:54:33Z", "message": "Added query to get all roles for principal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjQ1NDA5", "url": "https://github.com/AthenZ/athenz/pull/1034#pullrequestreview-448645409", "createdAt": "2020-07-15T05:47:58Z", "commit": {"oid": "d5a953a08431ef099c98c3c44b9d5cd9bdc1d6fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNTo0Nzo1OFrOGxvMOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNTo0Nzo1OFrOGxvMOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgwNjU4Nw==", "bodyText": "we should also lowercase the domainname here", "url": "https://github.com/AthenZ/athenz/pull/1034#discussion_r454806587", "createdAt": "2020-07-15T05:47:58Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -2956,6 +2957,38 @@ public DomainRoleMembers getDomainRoleMembers(ResourceContext ctx, String domain\n         return roleMembers;\n     }\n \n+    @Override\n+    public DomainRoleMember getPrincipalRoles(ResourceContext context, String principal, String domainName) {\n+        final String caller = \"getPrincipalRoles\";\n+        metric.increment(ZMSConsts.HTTP_GET);\n+        logPrincipal(context);\n+\n+        if (StringUtil.isEmpty(principal)) {\n+            // If principal not specified, get roles for current user\n+            principal = ((RsrcCtxWrapper) context).principal().getFullName();\n+        }\n+        validateRequest(context.request(), caller);\n+        validate(principal, TYPE_ENTITY_NAME, caller);\n+\n+        if (!StringUtil.isEmpty(domainName)) {\n+            validate(domainName, TYPE_DOMAIN_NAME, caller);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5a953a08431ef099c98c3c44b9d5cd9bdc1d6fb"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c85590254678b9f0d0a71c618592d010dd5d79", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/e9c85590254678b9f0d0a71c618592d010dd5d79", "committedDate": "2020-07-15T08:49:05Z", "message": "Added query to get all roles for principal"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0c43033f4a453f6f279fbfdd0486517dc39936a", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/e0c43033f4a453f6f279fbfdd0486517dc39936a", "committedDate": "2020-07-15T08:47:53Z", "message": "Fix"}, "afterCommit": {"oid": "e9c85590254678b9f0d0a71c618592d010dd5d79", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/e9c85590254678b9f0d0a71c618592d010dd5d79", "committedDate": "2020-07-15T08:49:05Z", "message": "Added query to get all roles for principal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MTAyNzU1", "url": "https://github.com/AthenZ/athenz/pull/1034#pullrequestreview-449102755", "createdAt": "2020-07-15T16:07:29Z", "commit": {"oid": "e9c85590254678b9f0d0a71c618592d010dd5d79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3000, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}