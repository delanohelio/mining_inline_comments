{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzYzODcx", "number": 995, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMjoxMzo0NlrOEBJCTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowODo1NVrOEB670g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NjMyMDc3OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMjoxMzo0NlrOGc1l0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMTozODoyNlrOGdbBMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg5MTM0NA==", "bodyText": "this implementation doesn't look correct to me. we're setting a templateMetaList object which contains only a single templateMeta which only has a version number. where are the rest of the templates or where are the template names we're storing?", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r432891344", "createdAt": "2020-05-30T22:13:46Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,29 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwNDU2MQ==", "bodyText": "done.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433504561", "createdAt": "2020-06-01T21:38:26Z", "author": {"login": "jothi-prasad"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,29 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg5MTM0NA=="}, "originalCommit": {"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDQ5MTI4OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo1Mjo1MFrOGdcn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo1Mjo1MFrOGdcn5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMDg1NQ==", "bodyText": "we're creating the template meta list every time this api is called and replacing the struct in domain struct. which means it will only have a single template and will be overwritten every time. The implementation needs to be:\nif (domainStruct.getTemplateMeta() == null) {\ndomainStruct.setTemplateMeta(new ArrayList<>());\n}\nArrayList templateMetalist = domainStruct.getTemplateMeta();\n// then iterate through the list and see if we have an object\n// with that template. If yes, update the version only,\n// if not then create a new object and add it to the list", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433530855", "createdAt": "2020-06-01T22:52:50Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,34 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+        TemplateMetaData templateMeta = new TemplateMetaData();\n+        templateMeta.setTemplateName(templateName);\n+        templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+        templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+        templateMeta.setDescription(templateMetaData.getDescription());\n+        templateMeta.setTimestamp(templateMetaData.getTimestamp());\n+        templateMeta.setCurrentVersion(templateMetaData.getLatestVersion());\n+        templateMetalist.add(templateMeta);\n+        domainStruct.setTemplateMeta(templateMetalist);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTQ0NTI4OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzo0MDoyNlrOGdluyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxOTozNVrOGeApgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDA3NA==", "bodyText": "we're missing the handling of the when when templateMetaList is not empty but it doesn't contain the templateName we're updating. In that case, we also need to add a new object.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680074", "createdAt": "2020-06-02T07:40:26Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTA4OA==", "bodyText": "Done.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434121088", "createdAt": "2020-06-02T19:19:35Z", "author": {"login": "jothi-prasad"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDA3NA=="}, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMTQ0NzA5OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzo0MDo1NFrOGdlv3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxOToyNlrOGeApMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0OA==", "bodyText": "these lines 436-439  are not necessary since the domain object only needs to contain the name of the template and the latest version and no other detail.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680348", "createdAt": "2020-06-02T07:40:54Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                }\n+            }\n+        } else {\n+            TemplateMetaData templateMeta = new TemplateMetaData();\n+            templateMeta.setTemplateName(templateName);\n+            templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+            templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+            templateMeta.setDescription(templateMetaData.getDescription());\n+            templateMeta.setTimestamp(templateMetaData.getTimestamp());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTAwOA==", "bodyText": "Done.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434121008", "createdAt": "2020-06-02T19:19:26Z", "author": {"login": "jothi-prasad"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                }\n+            }\n+        } else {\n+            TemplateMetaData templateMeta = new TemplateMetaData();\n+            templateMeta.setTemplateName(templateName);\n+            templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+            templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+            templateMeta.setDescription(templateMetaData.getDescription());\n+            templateMeta.setTimestamp(templateMetaData.getTimestamp());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0OA=="}, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNDQ5NjE4OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowODo1NVrOGeECYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjowNTozOFrOGeFjLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjYxMQ==", "bodyText": "this is not still correct since if you have 2 template in your list, when comparing the first element, you're just overriding the full list.\n#1000\nI created a new PR based on your PR. Remove the setTemplateNameAndVersion method from your PR and use the implementation of updateDomainTemplate method from that PR.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434176611", "createdAt": "2020-06-02T21:08:55Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,41 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwMTM4OA==", "bodyText": "Done.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434201388", "createdAt": "2020-06-02T22:05:38Z", "author": {"login": "jothi-prasad"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,41 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                } else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjYxMQ=="}, "originalCommit": {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1661, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}