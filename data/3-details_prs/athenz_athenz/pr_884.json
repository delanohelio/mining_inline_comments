{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3OTc2NTMx", "number": 884, "title": "Notifications for unrefreshed certificates - Separating EmailNotificationService from providers", "bodyText": "Seperated provider implementation from EmailNotificationService\nCurrently implemented provider: AWSEmailProvider..\nThe tests checking AWS SES functionality in NotificationManagerTest were extracted to a new test class, AWSEmailProviderTest.\nMoved Notification constants from interface to dedicated constants file\n\n\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-02-20T21:11:13Z", "url": "https://github.com/AthenZ/athenz/pull/884", "merged": true, "mergeCommit": {"oid": "a1342341152581c87530d626096371f52cc7a69b"}, "closed": true, "closedAt": "2020-02-24T22:35:39Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGjA_LgFqTM2Mjc4NzQzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHlXR4AFqTM2Mzc1MTA3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzg3NDM0", "url": "https://github.com/AthenZ/athenz/pull/884#pullrequestreview-362787434", "createdAt": "2020-02-21T17:17:23Z", "commit": {"oid": "1969289ad57d57019d8362713e9afce9546e59b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxNzoyM1rOFs-cSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxNzoyM1rOFs-cSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNDcxMg==", "bodyText": "Instead of hardcoding the AWSEmailProvider here, it should come from properties, so that it can be replaced with another EmailProvider for ZMS vs ZTS", "url": "https://github.com/AthenZ/athenz/pull/884#discussion_r382704712", "createdAt": "2020-02-21T17:17:23Z", "author": {"login": "abvaidya"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/NotificationServiceFactoryImpl.java", "diffHunk": "@@ -26,6 +26,6 @@\n \n     @Override\n     public NotificationService create() {\n-        return new EmailNotificationService();\n+        return new EmailNotificationService(new AWSEmailProvider());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1969289ad57d57019d8362713e9afce9546e59b3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzg4MTA3", "url": "https://github.com/AthenZ/athenz/pull/884#pullrequestreview-362788107", "createdAt": "2020-02-21T17:18:34Z", "commit": {"oid": "1969289ad57d57019d8362713e9afce9546e59b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxODozNFrOFs-eXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxODozNFrOFs-eXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNTI0NA==", "bodyText": "Since creating MIMEMessage is common across diff email providers, it can be extracted in the EmailProvider implementation as default method", "url": "https://github.com/AthenZ/athenz/pull/884#discussion_r382705244", "createdAt": "2020-02-21T17:18:34Z", "author": {"login": "abvaidya"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/AWSEmailProvider.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package com.yahoo.athenz.common.server.notification.impl;\n+\n+import com.amazonaws.regions.Region;\n+import com.amazonaws.regions.Regions;\n+import com.amazonaws.services.simpleemail.AmazonSimpleEmailService;\n+import com.amazonaws.services.simpleemail.AmazonSimpleEmailServiceClientBuilder;\n+import com.amazonaws.services.simpleemail.model.RawMessage;\n+import com.amazonaws.services.simpleemail.model.SendRawEmailRequest;\n+import com.amazonaws.services.simpleemail.model.SendRawEmailResult;\n+import com.yahoo.athenz.common.server.notification.EmailProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.mail.Session;\n+import javax.mail.internet.InternetAddress;\n+import javax.mail.internet.MimeBodyPart;\n+import javax.mail.internet.MimeMessage;\n+import javax.mail.internet.MimeMultipart;\n+import java.io.ByteArrayOutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.Collection;\n+import java.util.Properties;\n+\n+import static com.yahoo.athenz.common.server.notification.NotificationServiceConstants.CHARSET_UTF_8;\n+import static com.yahoo.athenz.common.server.notification.NotificationServiceConstants.HTML_LOGO_CID_PLACEHOLDER;\n+\n+public class AWSEmailProvider implements EmailProvider {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AWSEmailProvider.class);\n+    private final AmazonSimpleEmailService ses;\n+\n+    @Override\n+    public boolean sendEmail(String subject, String body, boolean status, Collection<String> recipients, String from, byte[] logoImage) {\n+        try {\n+            Session session = Session.getDefaultInstance(new Properties());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1969289ad57d57019d8362713e9afce9546e59b3"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eac9596a0a8890ff23daeca3a4b16d880e9ac483", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/eac9596a0a8890ff23daeca3a4b16d880e9ac483", "committedDate": "2020-02-24T19:29:57Z", "message": "Seperate provider implementation from EmailNotificationService\n\n- Currently implemented provider: AWSEmailProvider..\n- The tests checking AWS SES functionality in NotificationManagerTest were extracted to a new test class, AWSEmailProviderTest.\n- Moved Notification constants from interface to dedicated constants file\n- Added missing test assertions for Notifications in ZMS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzUxMDc2", "url": "https://github.com/AthenZ/athenz/pull/884#pullrequestreview-363751076", "createdAt": "2020-02-24T22:35:28Z", "commit": {"oid": "eac9596a0a8890ff23daeca3a4b16d880e9ac483"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3052, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}