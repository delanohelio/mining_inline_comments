{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2Mzg1NDU1", "number": 907, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0ODo0OVrODnFRDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNjozNTozNlrODomP3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzA3MzQxOnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0ODo0OVrOF03qJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0ODo0OVrOF03qJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4MjE4Mg==", "bodyText": "Added dependency so athenz-server-common can refer to entities.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390982182", "createdAt": "2020-03-11T13:48:49Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/pom.xml", "diffHunk": "@@ -163,6 +163,12 @@\n       <artifactId>jakarta.mail</artifactId>\n       <version>1.6.4</version>\n     </dependency>\n+      <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzA3NjA5OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/ServerCommonConsts.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0OToyNVrOF03rvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo0OToyNVrOF03rvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4MjU5MQ==", "bodyText": "Moved USER_DOMAIN_PREFIX to common so it can be used by ZTS.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390982591", "createdAt": "2020-03-11T13:49:25Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/ServerCommonConsts.java", "diffHunk": "@@ -21,6 +21,8 @@\n     public static final String OBJECT_ROLE      = \"role\";\n     public static final String USER_DOMAIN      = \"user\";\n \n+    public static final String USER_DOMAIN_PREFIX = \"user.\";\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzA4NDMwOnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo1MToyN1rOF03xLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo1MToyN1rOF03xLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4Mzk4MQ==", "bodyText": "Initiated NotificationManager in ZTS. The daily thread will run but at this point won't send any notifications as the current NotificationTask is not implemented (returns empty collection).", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390983981", "createdAt": "2020-03-11T13:51:27Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -305,8 +308,15 @@ public ZTSImpl(CloudStore implCloudStore, DataStore implDataStore) {\n         // make sure to set the keystore for any instance that requires it\n         \n         setAuthorityKeyStore();\n+\n+        setNotificationManager();\n     }\n-    \n+\n+    private void setNotificationManager() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzEwMzQ0OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo1NTo1MlrOF039Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo1NTo1MlrOF039Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4NzA2Nw==", "bodyText": "Added four new columns but only two of them, expiryTime and hostName can be inserted. The other two, lastNotifiedTime and lastNotifiedServer are updated as part of the Notification logic.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390987067", "createdAt": "2020-03-11T13:55:52Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2475,8 +2485,14 @@ boolean verifyAWSAssumeRole(String domainName, String roleResource, String princ\n         return false;\n     }\n \n-    X509CertRecord insertX509CertRecord(ResourceContext ctx, final String cn, final String provider,\n-            final String instanceId, final String serial, Boolean certUsage) {\n+    X509CertRecord insertX509CertRecord(ResourceContext ctx,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzExOTk0OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMzo1OTo0MlrOF04IBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQyMzo0MTo0NFrOF2cH5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4OTgzMA==", "bodyText": "Currently, always put null (the columns are nullable). Will insert the real values once hca starts sending them as part of the request.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390989830", "createdAt": "2020-03-11T13:59:42Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2678,7 +2696,7 @@ public Response postInstanceRegisterInformation(ResourceContext ctx, InstanceReg\n             // able to validate the certificate during refresh operations\n \n             if (insertX509CertRecord(ctx, cn, provider, certReqInstanceId, certSerial,\n-                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage)) == null) {\n+                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage), null, null) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyODI2OA==", "bodyText": "expiryTime is already available - it must come from the certificate that ZTS generates. only hostname is supposed to come from the service identity agent. We already get those when the host is requesting the hostname to be included in the car, so we there is no need to wait for any changes in the agent.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392528268", "createdAt": "2020-03-13T23:35:36Z", "author": {"login": "havetisyan"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2678,7 +2696,7 @@ public Response postInstanceRegisterInformation(ResourceContext ctx, InstanceReg\n             // able to validate the certificate during refresh operations\n \n             if (insertX509CertRecord(ctx, cn, provider, certReqInstanceId, certSerial,\n-                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage)) == null) {\n+                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage), null, null) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4OTgzMA=="}, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODE5Ng==", "bodyText": "Fixed.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392628196", "createdAt": "2020-03-14T23:41:44Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2678,7 +2696,7 @@ public Response postInstanceRegisterInformation(ResourceContext ctx, InstanceReg\n             // able to validate the certificate during refresh operations\n \n             if (insertX509CertRecord(ctx, cn, provider, certReqInstanceId, certSerial,\n-                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage)) == null) {\n+                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage), null, null) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4OTgzMA=="}, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzEyNzA2OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/CertRecordStoreConnection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMToyN1rOF04MjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMToyN1rOF04MjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk5MDk4OA==", "bodyText": "Similar to the logic of updateRoleMemberExpirationNotificationTimestamp and getNotifyTemporaryRoleMembers in ZMS.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390990988", "createdAt": "2020-03-11T14:01:27Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/CertRecordStoreConnection.java", "diffHunk": "@@ -70,4 +71,20 @@\n      * @return number of records deleted\n      */\n     int deleteExpiredX509CertRecords(int expiryTimeMins);\n+\n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzEzMjQ0OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMjo0NFrOF04P-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMjo0NFrOF04P-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk5MTg2NQ==", "bodyText": "Added 4 new nullable columns. Added tests that verify get / insert / update works correctly with null values for these columns.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390991865", "createdAt": "2020-03-11T14:02:44Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -46,6 +47,10 @@\n     private static final String KEY_PREV_TIME = \"prevTime\";\n     private static final String KEY_PREV_IP = \"prevIP\";\n     private static final String KEY_CLIENT_CERT = \"clientCert\";\n+    private static final String KEY_LAST_NOTIFIED_TIME = \"lastNotifiedTime\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzEzNjE4OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMzozN1rOF04SXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMzozN1rOF04SXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk5MjQ3Nw==", "bodyText": "Our new notification is only for ZTS so at this point these methods are not required.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390992477", "createdAt": "2020-03-11T14:03:37Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/DynamoDBCertRecordStoreConnection.java", "diffHunk": "@@ -179,6 +212,18 @@ public int deleteExpiredX509CertRecords(int expiryTimeMins) {\n         return 0;\n     }\n \n+    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzE0NjMxOnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowNjowM1rOF04ZBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowNjowM1rOF04ZBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk5NDE4Mw==", "bodyText": "At this point this task doesn't return any notifications so no notifications will be sent in ZTS. It will be implemented after verifying the daily thread runs correctly in ZTS and the new columns are being populated.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r390994183", "createdAt": "2020-03-11T14:06:03Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Verizon Media\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.zts.notification;\n+\n+import com.yahoo.athenz.common.server.notification.Notification;\n+import com.yahoo.athenz.common.server.notification.NotificationCommon;\n+import com.yahoo.athenz.common.server.notification.NotificationTask;\n+import com.yahoo.athenz.zts.cert.InstanceCertManager;\n+import com.yahoo.athenz.zts.store.DataStore;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.yahoo.athenz.common.ServerCommonConsts.USER_DOMAIN_PREFIX;\n+\n+public class CertFailedRefreshNotificationTask implements NotificationTask {\n+    private final String serverName;\n+    private final InstanceCertManager instanceCertManager;\n+    private final DataStore dataStore;\n+    private final NotificationCommon notificationCommon;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CertFailedRefreshNotificationTask.class);\n+    private final static String DESCRIPTION = \"certificate failed refresh notification\";\n+\n+    public CertFailedRefreshNotificationTask(InstanceCertManager instanceCertManager, DataStore dataStore, String userDomainPrefix, String serverName) {\n+        this.serverName = serverName;\n+        this.instanceCertManager = instanceCertManager;\n+        this.dataStore = dataStore;\n+        ZTSDomainRoleMembersFetcher ztsDomainRoleMembersFetcher = new ZTSDomainRoleMembersFetcher(dataStore, USER_DOMAIN_PREFIX);\n+        this.notificationCommon = new NotificationCommon(ztsDomainRoleMembersFetcher, userDomainPrefix);\n+    }\n+\n+    @Override\n+    public List<Notification> getNotifications() {\n+        return new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDAzNzgwOnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/JDBCCertRecordStoreConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzoyNjoxM1rOF1BO6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODo1OTozM1rOF3B9TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzOTA1MQ==", "bodyText": "Currently implemented logic is to send notifications for certificates that didn't refresh for more than a day. Notification will be sent once a week for a month.\nWe can change this logic in a future pull request to consider expiration for example.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r391139051", "createdAt": "2020-03-11T17:26:13Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/JDBCCertRecordStoreConnection.java", "diffHunk": "@@ -37,24 +34,35 @@\n \n     private static final String SQL_GET_X509_RECORD = \"SELECT * FROM certificates WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_INSERT_X509_RECORD = \"INSERT INTO certificates \" +\n-            \"(provider, instanceId, service, currentSerial, currentTime, currentIP, prevSerial, prevTime, prevIP, clientCert) \" +\n-            \"VALUES (?, ?,?,?,?,?,?,?,?,?);\";\n+            \"(provider, instanceId, service, currentSerial, currentTime, currentIP, prevSerial, prevTime, prevIP, clientCert, \" +\n+            \"lastNotifiedTime, lastNotifiedServer, expiryTime, hostName) \" +\n+            \"VALUES (?, ?,?,?,?,?,?,?,?,?,?,?,?,?);\";\n     private static final String SQL_UPDATE_X509_RECORD = \"UPDATE certificates SET \" +\n-            \"currentSerial=?, currentTime=?, currentIP=?, prevSerial=?, prevTime=?, prevIP=?\" +\n+            \"currentSerial=?, currentTime=?, currentIP=?, prevSerial=?, prevTime=?, prevIP=?, \" +\n+            \"lastNotifiedTime=?, lastNotifiedServer=?, expiryTime=?, hostName=?\" +\n             \"WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_DELETE_X509_RECORD = \"DELETE from certificates \" +\n             \"WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_DELETE_EXPIRED_X509_RECORDS = \"DELETE FROM certificates \" +\n             \"WHERE currentTime < ADDDATE(NOW(), INTERVAL -? MINUTE);\";\n-    \n-    public static final String DB_COLUMN_SERVICE        = \"service\";\n-    public static final String DB_COLUMN_CURRENT_IP     = \"currentIP\";\n-    public static final String DB_COLUMN_CURRENT_SERIAL = \"currentSerial\";\n-    public static final String DB_COLUMN_CURRENT_TIME   = \"currentTime\";\n-    public static final String DB_COLUMN_PREV_IP        = \"prevIP\";\n-    public static final String DB_COLUMN_PREV_SERIAL    = \"prevSerial\";\n-    public static final String DB_COLUMN_PREV_TIME      = \"prevTime\";\n-    public static final String DB_COLUMN_CLIENT_CERT    = \"clientCert\";\n+    private static final String SQL_UPDATE_UNREFRESHED_X509_RECORDS_NOTIFICATION_TIMESTAMP = \"UPDATE certificates SET lastNotifiedTime=?, lastNotifiedServer=? \" +\n+            \"WHERE currentTime < (CURRENT_DATE - INTERVAL 1 DAY) AND DATEDIFF(CURRENT_TIME, currentTime) IN (1,7,14,21,28) AND (lastNotifiedTime IS NULL || lastNotifiedTime < (CURRENT_DATE - INTERVAL 1 DAY))\";\n+    private static final String SQL_LIST_NOTIFY_UNREFRESHED_X509_RECORDS = \"SELECT * FROM certificates WHERE lastNotifiedTime=? AND lastNotifiedServer=?;\";\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI0ODA3Nw==", "bodyText": "Note this logic was fixed in the up-coming pull request according to our last session. You may ignore it for now.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r393248077", "createdAt": "2020-03-16T18:59:33Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/cert/impl/JDBCCertRecordStoreConnection.java", "diffHunk": "@@ -37,24 +34,35 @@\n \n     private static final String SQL_GET_X509_RECORD = \"SELECT * FROM certificates WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_INSERT_X509_RECORD = \"INSERT INTO certificates \" +\n-            \"(provider, instanceId, service, currentSerial, currentTime, currentIP, prevSerial, prevTime, prevIP, clientCert) \" +\n-            \"VALUES (?, ?,?,?,?,?,?,?,?,?);\";\n+            \"(provider, instanceId, service, currentSerial, currentTime, currentIP, prevSerial, prevTime, prevIP, clientCert, \" +\n+            \"lastNotifiedTime, lastNotifiedServer, expiryTime, hostName) \" +\n+            \"VALUES (?, ?,?,?,?,?,?,?,?,?,?,?,?,?);\";\n     private static final String SQL_UPDATE_X509_RECORD = \"UPDATE certificates SET \" +\n-            \"currentSerial=?, currentTime=?, currentIP=?, prevSerial=?, prevTime=?, prevIP=?\" +\n+            \"currentSerial=?, currentTime=?, currentIP=?, prevSerial=?, prevTime=?, prevIP=?, \" +\n+            \"lastNotifiedTime=?, lastNotifiedServer=?, expiryTime=?, hostName=?\" +\n             \"WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_DELETE_X509_RECORD = \"DELETE from certificates \" +\n             \"WHERE provider=? AND instanceId=? AND service=?;\";\n     private static final String SQL_DELETE_EXPIRED_X509_RECORDS = \"DELETE FROM certificates \" +\n             \"WHERE currentTime < ADDDATE(NOW(), INTERVAL -? MINUTE);\";\n-    \n-    public static final String DB_COLUMN_SERVICE        = \"service\";\n-    public static final String DB_COLUMN_CURRENT_IP     = \"currentIP\";\n-    public static final String DB_COLUMN_CURRENT_SERIAL = \"currentSerial\";\n-    public static final String DB_COLUMN_CURRENT_TIME   = \"currentTime\";\n-    public static final String DB_COLUMN_PREV_IP        = \"prevIP\";\n-    public static final String DB_COLUMN_PREV_SERIAL    = \"prevSerial\";\n-    public static final String DB_COLUMN_PREV_TIME      = \"prevTime\";\n-    public static final String DB_COLUMN_CLIENT_CERT    = \"clientCert\";\n+    private static final String SQL_UPDATE_UNREFRESHED_X509_RECORDS_NOTIFICATION_TIMESTAMP = \"UPDATE certificates SET lastNotifiedTime=?, lastNotifiedServer=? \" +\n+            \"WHERE currentTime < (CURRENT_DATE - INTERVAL 1 DAY) AND DATEDIFF(CURRENT_TIME, currentTime) IN (1,7,14,21,28) AND (lastNotifiedTime IS NULL || lastNotifiedTime < (CURRENT_DATE - INTERVAL 1 DAY))\";\n+    private static final String SQL_LIST_NOTIFY_UNREFRESHED_X509_RECORDS = \"SELECT * FROM certificates WHERE lastNotifiedTime=? AND lastNotifiedServer=?;\";\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzOTA1MQ=="}, "originalCommit": {"oid": "57567e7d26adf3a1a8df78957f1b90b73ee1cf36"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjgxNTE5OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzoyNzo1OVrOF2V7wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQyMzo0MTo1N1rOF2cH7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNjc4Ng==", "bodyText": "this must be    <version>${project.parent.version}</version>", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392526786", "createdAt": "2020-03-13T23:27:59Z", "author": {"login": "havetisyan"}, "path": "libs/java/server_common/pom.xml", "diffHunk": "@@ -163,6 +163,12 @@\n       <artifactId>jakarta.mail</artifactId>\n       <version>1.6.4</version>\n     </dependency>\n+      <dependency>\n+          <groupId>com.yahoo.athenz</groupId>\n+          <artifactId>athenz-zms-core</artifactId>\n+          <version>1.8.51-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a9e696d92ac47fa365cb7e1b2b6bb5db044e28f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODIwNg==", "bodyText": "Fixed.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392628206", "createdAt": "2020-03-14T23:41:57Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/pom.xml", "diffHunk": "@@ -163,6 +163,12 @@\n       <artifactId>jakarta.mail</artifactId>\n       <version>1.6.4</version>\n     </dependency>\n+      <dependency>\n+          <groupId>com.yahoo.athenz</groupId>\n+          <artifactId>athenz-zms-core</artifactId>\n+          <version>1.8.51-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNjc4Ng=="}, "originalCommit": {"oid": "5a9e696d92ac47fa365cb7e1b2b6bb5db044e28f"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjgxNjcxOnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzoyODo1OVrOF2V8nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQyMzo0NDo1OVrOF2cIaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzAwNA==", "bodyText": "why the scope only compile?", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392527004", "createdAt": "2020-03-13T23:28:59Z", "author": {"login": "havetisyan"}, "path": "libs/java/server_common/pom.xml", "diffHunk": "@@ -163,6 +163,12 @@\n       <artifactId>jakarta.mail</artifactId>\n       <version>1.6.4</version>\n     </dependency>\n+      <dependency>\n+          <groupId>com.yahoo.athenz</groupId>\n+          <artifactId>athenz-zms-core</artifactId>\n+          <version>1.8.51-SNAPSHOT</version>\n+          <scope>compile</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a9e696d92ac47fa365cb7e1b2b6bb5db044e28f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYyODMzMQ==", "bodyText": "I let Intellij add the dependency automatically. I will make sure to double-check the generated code next time. Fixed it.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392628331", "createdAt": "2020-03-14T23:44:59Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/pom.xml", "diffHunk": "@@ -163,6 +163,12 @@\n       <artifactId>jakarta.mail</artifactId>\n       <version>1.6.4</version>\n     </dependency>\n+      <dependency>\n+          <groupId>com.yahoo.athenz</groupId>\n+          <artifactId>athenz-zms-core</artifactId>\n+          <version>1.8.51-SNAPSHOT</version>\n+          <scope>compile</scope>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzAwNA=="}, "originalCommit": {"oid": "5a9e696d92ac47fa365cb7e1b2b6bb5db044e28f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMzcyMDM5OnYy", "diffSide": "LEFT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNzoxNzo0NFrOF2dVcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNzoxNzo0NFrOF2dVcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY0ODA1MQ==", "bodyText": "As we talked about on a different pull request, the status will not be part of the interface", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392648051", "createdAt": "2020-03-15T07:17:44Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "diffHunk": "@@ -251,20 +251,21 @@ void processExpiryEntry(StringBuilder body, final String entryNames, final Strin\n \n     boolean sendEmail(Set<String> recipients, String subject, String body) {\n         final AtomicInteger counter = new AtomicInteger();\n-        boolean status = true;\n         // SES imposes a limit of 50 recipients. So we convert the recipients into batches\n         if (recipients.size() > SES_RECIPIENTS_LIMIT_PER_MESSAGE) {\n             final Collection<List<String>> recipientsBatch = recipients.stream()\n                     .collect(Collectors.groupingBy(it -> counter.getAndIncrement() / SES_RECIPIENTS_LIMIT_PER_MESSAGE))\n                     .values();\n+            boolean status = true;\n             for (List<String> recipientsSegment : recipientsBatch) {\n-                status = sendEmailMIME(subject, body, status, recipientsSegment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62ba6ab92b33a7d4a8455c00ddc550a523427ab"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMzcyMDQ4OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNzoxNzo1M1rOF2dVfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNzoxNzo1M1rOF2dVfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY0ODA2MA==", "bodyText": "As we talked about on a different pull request, the status will not be part of the interface", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r392648060", "createdAt": "2020-03-15T07:17:53Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/EmailNotificationService.java", "diffHunk": "@@ -337,7 +338,7 @@ private MimeMessage getMimeMessage(String subject, String body, Collection<Strin\n         return message;\n     }\n \n-    private boolean sendEmailMIME(String subject, String body, boolean status, Collection<String> recipients) {\n+    private boolean sendEmailMIME(String subject, String body, Collection<String> recipients) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62ba6ab92b33a7d4a8455c00ddc550a523427ab"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzODk0NzYxOnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNjoyNjo1NVrOF3PS5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNjoyNjo1NVrOF3PS5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2NjU5OQ==", "bodyText": "we cannot use the certExpiryTime here since the cert signer may not honor what the server is asking  and instead use another expiry time. So the correct value here is to extract the expiry from the newCert that we're about send back to the client.\nalso, for the last hostname argument, why are we passing null instead of info.getHostname()?", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r393466599", "createdAt": "2020-03-17T06:26:55Z", "author": {"login": "havetisyan"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -2678,7 +2700,7 @@ public Response postInstanceRegisterInformation(ResourceContext ctx, InstanceReg\n             // able to validate the certificate during refresh operations\n \n             if (insertX509CertRecord(ctx, cn, provider, certReqInstanceId, certSerial,\n-                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage)) == null) {\n+                    InstanceProvider.ZTS_CERT_USAGE_CLIENT.equalsIgnoreCase(certUsage), certExpiryTime, null) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62ba6ab92b33a7d4a8455c00ddc550a523427ab"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzODk2Mjg1OnYy", "diffSide": "RIGHT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNjozNTozNlrOF3PcfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNjozNTozNlrOF3PcfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2OTA1Mg==", "bodyText": "this one is the recovery mode certificate record. so the correct value should be the expiry of the cert  certificate and not the expiryTime. So we can extract the expiry from cert object passed in and use that.", "url": "https://github.com/AthenZ/athenz/pull/907#discussion_r393469052", "createdAt": "2020-03-17T06:35:36Z", "author": {"login": "havetisyan"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -3117,7 +3129,7 @@ X509CertRecord getValidatedX509CertRecord(ResourceContext ctx, final String prov\n \n             if (cert.getNotBefore().getTime() < x509CertRefreshResetTime) {\n                 x509CertRecord = insertX509CertRecord(ctx, principalName, provider, instanceId,\n-                        cert.getSerialNumber().toString(), false);\n+                        cert.getSerialNumber().toString(), false, expiryTime, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f62ba6ab92b33a7d4a8455c00ddc550a523427ab"}, "originalPosition": 163}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1743, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}