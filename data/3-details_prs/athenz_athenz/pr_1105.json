{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5ODk5Mzg0", "number": 1105, "title": "support adding groups as role members", "bodyText": "since role members can include *'s and group members and group members must only include users and services, updated MemberName definition and switched Groups to use new GroupMemberName definition so the validation takes place correctly.\nintroduced a concept of principal type in member objects so we don't keep parsing to find out if the principal is user, service or group.\n\nI confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-09-04T17:18:24Z", "url": "https://github.com/AthenZ/athenz/pull/1105", "merged": true, "mergeCommit": {"oid": "b0f562ad3c5d9820cb41a776571e4330a4883ed2"}, "closed": true, "closedAt": "2020-09-04T20:53:00Z", "author": {"login": "havetisyan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFodLoAH2gAyNDc5ODk5Mzg0OjJjZjdlNDJhZGRlZGYzOTQwOTU2YjU4NzNmODczOTRhNjFhMzhmMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFrg87AFqTQ4MjkzMTg5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/2cf7e42addedf3940956b5873f87394a61a38f33", "committedDate": "2020-09-04T17:14:56Z", "message": "support adding groups as role members"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyODgwMDQ0", "url": "https://github.com/AthenZ/athenz/pull/1105#pullrequestreview-482880044", "createdAt": "2020-09-04T18:54:45Z", "commit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxODo1NDo0NVrOHNYlqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxOToyMjowNlrOHNZPlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc5NjM5NQ==", "bodyText": "Do we need to add principalType in \"*Membership\" structs as well?", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483796395", "createdAt": "2020-09-04T18:54:45Z", "author": {"login": "abvaidya"}, "path": "core/zms/src/main/rdl/Group.tdl", "diffHunk": "@@ -25,11 +25,12 @@ type GroupMember Struct {\n     ResourceName requestPrincipal (optional); //pending members only - name of the principal requesting the change\n     Timestamp reviewLastNotifiedTime (optional); //for pending membership requests, time when last notification was sent (for file store)\n     Int32 systemDisabled (optional); //user disabled by system based on configured group setting\n+    Int32 principalType (optional); //server use only - principal type: user or service\n }\n \n //The representation for a group membership.\n type GroupMembership Struct {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc5NzA0NA==", "bodyText": "It might be helpful to document in tdl which number represents which type. e.g. user=0, service=1 etc", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483797044", "createdAt": "2020-09-04T18:56:20Z", "author": {"login": "abvaidya"}, "path": "core/zms/src/main/rdl/Role.tdl", "diffHunk": "@@ -30,6 +30,7 @@ type RoleMember Struct {\n     ResourceName requestPrincipal (optional); //pending members only - name of the principal requesting the change\n     Timestamp reviewLastNotifiedTime (optional); //for pending membership requests, time when last notification was sent (for file store)\n     Int32 systemDisabled (optional); //user disabled by system based on configured role setting\n+    Int32 principalType (optional); //server use only - principal type: user, group, or service", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw==", "bodyText": "This method is always going to return true, so does it make sense to just remove it?", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483804713", "createdAt": "2020-09-04T19:16:13Z", "author": {"login": "abvaidya"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3566,7 +3617,7 @@ String enforcedUserAuthorityFilter(final String roleUserAuthorityFilter, final S\n     }\n \n     boolean shouldValidateRoleMembers(final String userAuthorityFilter) {\n-        return validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;\n+        return validateGroupRoleMembers || validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "originalPosition": 327}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNjQ2Mw==", "bodyText": "instead of looping over again, can we set the principal type which adding them to \"normalizedGroupMembers\" above?", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483806463", "createdAt": "2020-09-04T19:20:27Z", "author": {"login": "abvaidya"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -8043,6 +8095,13 @@ void normalizeGroupMembers(Group group) {\n                 addNormalizedGroupMember(normalizedMembers, member);\n             }\n         }\n+\n+        // go through each member and set the principal type\n+\n+        for (GroupMember member : normalizedMembers.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "originalPosition": 366}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNzEyNw==", "bodyText": "I see all references are removed?", "url": "https://github.com/AthenZ/athenz/pull/1105#discussion_r483807127", "createdAt": "2020-09-04T19:22:06Z", "author": {"login": "abvaidya"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -3566,7 +3617,7 @@ String enforcedUserAuthorityFilter(final String roleUserAuthorityFilter, final S\n     }\n \n     boolean shouldValidateRoleMembers(final String userAuthorityFilter) {\n-        return validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;\n+        return validateGroupRoleMembers || validateUserRoleMembers || validateServiceRoleMembers || userAuthorityFilter != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgwNDcxMw=="}, "originalCommit": {"oid": "2cf7e42addedf3940956b5873f87394a61a38f33"}, "originalPosition": 327}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7923fd9b518f1e915bc08e5e821eb1eef16ee359", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/7923fd9b518f1e915bc08e5e821eb1eef16ee359", "committedDate": "2020-09-04T19:53:13Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTMxODk1", "url": "https://github.com/AthenZ/athenz/pull/1105#pullrequestreview-482931895", "createdAt": "2020-09-04T20:48:46Z", "commit": {"oid": "7923fd9b518f1e915bc08e5e821eb1eef16ee359"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2902, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}