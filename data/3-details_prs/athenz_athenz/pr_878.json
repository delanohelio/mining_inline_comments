{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMTA1Nzkz", "number": 878, "title": "If user is expired, prevent sending notifications", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-02-10T12:23:44Z", "url": "https://github.com/AthenZ/athenz/pull/878", "merged": true, "mergeCommit": {"oid": "616fead39ba7f9a9cbb1b19a6529d170f2bef639"}, "closed": true, "closedAt": "2020-02-10T23:09:15Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDAcbDAFqTM1NjExNzkxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDFdDjgFqTM1NjMzMTg3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTE3OTEx", "url": "https://github.com/AthenZ/athenz/pull/878#pullrequestreview-356117911", "createdAt": "2020-02-10T17:18:29Z", "commit": {"oid": "69ba2374dcefec8fd7700a5ca9d8f505da53cae0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzoxODoyOVrOFnul4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzoxODoyOVrOFnul4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMjE0Nw==", "bodyText": "while the logic is correct, I don't want us to carry out additional work if not necessary. e.g. if the principal is not user there is no reason for us to check the expiry (it's just a wasted operation).\nwe should have logic implemented like this:\nif (!roleMember.getMemberName().startsWith(userDomainPrefix)) {\nreturn false;\n}\nreturn (roleMember.getExpiration() == null) || (roleMember.getExpiration().millis() > System.currentTimeMillis());", "url": "https://github.com/AthenZ/athenz/pull/878#discussion_r377202147", "createdAt": "2020-02-10T17:18:29Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/NotificationManager.java", "diffHunk": "@@ -145,13 +145,19 @@ void addDomainRoleRecipients(Notification notification, final String domainName,\n         for (Role role : domain.getRoles()) {\n             if (role.getName().equals(roleName)) {\n                 notification.getRecipients().addAll(role.getRoleMembers().stream()\n-                        .filter(m -> m.getMemberName().startsWith(userDomainPrefix))\n+                        .filter(this::isUnexpiredUser)\n                         .map(RoleMember::getMemberName).collect(Collectors.toSet()));\n                 return;\n             }\n         }\n     }\n \n+    private boolean isUnexpiredUser(RoleMember roleMember) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69ba2374dcefec8fd7700a5ca9d8f505da53cae0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "046ac5e89c6c52be12a4a1dd2e5187d928103db2", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/046ac5e89c6c52be12a4a1dd2e5187d928103db2", "committedDate": "2020-02-10T21:06:26Z", "message": "If user is expired, prevent sending notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMxODcw", "url": "https://github.com/AthenZ/athenz/pull/878#pullrequestreview-356331870", "createdAt": "2020-02-10T23:09:07Z", "commit": {"oid": "046ac5e89c6c52be12a4a1dd2e5187d928103db2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3047, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}