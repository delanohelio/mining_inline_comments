{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTQ0MzM0", "number": 1124, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxOToxM1rOEpokiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTo1ODoyOVrOEppICw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDkxNzg3OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxOToxM1rOHbbK5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxOToxM1rOHbbK5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxODc1OQ==", "bodyText": "Will implement this in server_common in next PR", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498518759", "createdAt": "2020-10-01T21:19:13Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/metrics/Metric.java", "diffHunk": "@@ -86,6 +88,15 @@ default void increment(String metric, String requestDomainName, String principal\n         increment(metric, requestDomainName);\n     }\n \n+    /**\n+     * Increment the counter for the specified metric with the specified attributes\n+     * @param metric Name of the counter\n+     * @param attributes Attributes for the metric (tags)\n+     */\n+    default void increment(String metric, Map<String, String> attributes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDkyMjUxOnYy", "diffSide": "LEFT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToyMToyMVrOHbbN7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToyMToyMVrOHbbN7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxOTUzNQ==", "bodyText": "Notification Manager can now send notifications to multiple Notification Services.\nUsers will need to specify the NotificationServiceFactory classes in a comma-separated property.", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498519535", "createdAt": "2020-10-01T21:21:21Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -30,22 +31,28 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(NotificationManager.class);\n \n-    private NotificationService notificationService;\n+    private List<NotificationService> notificationServices = new ArrayList<>();\n     private ScheduledExecutorService scheduledExecutor;\n     private List<NotificationTask> notificationTasks;\n \n     public NotificationManager(List<NotificationTask> notificationTasks) {\n         this.notificationTasks = notificationTasks;\n-        String notificationServiceFactoryClass = System.getProperty(NOTIFICATION_PROP_SERVICE_FACTORY_CLASS);\n-        if (notificationServiceFactoryClass != null) {\n-            NotificationServiceFactory notificationServiceFactory;\n-            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMDk0NTQ2OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/MetricNotificationServiceFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTozMToxMlrOHbbcyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTozMToxMlrOHbbcyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMzMzOQ==", "bodyText": "Load a metric object and pass it to MetricNotificationService.\nThe metric can be a different implementation than the one used by ZTS / ZMS.", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498523339", "createdAt": "2020-10-01T21:31:12Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/impl/MetricNotificationServiceFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification.impl;\n+\n+import com.yahoo.athenz.common.metrics.Metric;\n+import com.yahoo.athenz.common.metrics.MetricFactory;\n+import com.yahoo.athenz.common.server.notification.NotificationService;\n+import com.yahoo.athenz.common.server.notification.NotificationServiceFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.yahoo.athenz.common.ServerCommonConsts.METRIC_DEFAULT_FACTORY_CLASS;\n+\n+public class MetricNotificationServiceFactory implements NotificationServiceFactory {\n+\n+    public static final String NOTIFICATION_PROP_METRIC_FACTORY_CLASS = \"athenz.notification.metric_factory_class\";\n+\n+    private final static Logger LOG = LoggerFactory.getLogger(MetricNotificationServiceFactory.class);\n+\n+    @Override\n+    public NotificationService create() {\n+        return new MetricNotificationService(loadMetricObject());\n+    }\n+\n+    Metric loadMetricObject() {\n+\n+        String metricFactoryClass = System.getProperty(NOTIFICATION_PROP_METRIC_FACTORY_CLASS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTAwODc1OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTo1ODoyOVrOHbcFTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNTozMTozOFrOHbhl2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzcwOQ==", "bodyText": "why are we using this from the mysql library? I believe jetty already has one called identically so maybe we should be using that instead?", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498533709", "createdAt": "2020-10-01T21:58:29Z", "author": {"login": "havetisyan"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n+import com.mysql.cj.util.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMzk2Mg==", "bodyText": "Yeah, I didn't notice it during auto-import, fixing it", "url": "https://github.com/AthenZ/athenz/pull/1124#discussion_r498623962", "createdAt": "2020-10-02T05:31:38Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationManager.java", "diffHunk": "@@ -16,6 +16,7 @@\n \n package com.yahoo.athenz.common.server.notification;\n \n+import com.mysql.cj.util.StringUtils;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzcwOQ=="}, "originalCommit": {"oid": "3a943d0a4921d7434ef00f27e0b35b5fc2d1ca8c"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1606, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}