{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTQwNDc0", "number": 1077, "title": "Changes in Metrics API", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-08-06T16:44:08Z", "url": "https://github.com/AthenZ/athenz/pull/1077", "merged": true, "mergeCommit": {"oid": "eb54760e5f1b033844fa3763ed6310920ba6da70"}, "closed": true, "closedAt": "2020-08-11T03:57:21Z", "author": {"login": "OferLevi85"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8SrmRgFqTQ2MjY5NDUyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9uqNcAFqTQ2NDczMTY3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjk0NTI1", "url": "https://github.com/AthenZ/athenz/pull/1077#pullrequestreview-462694525", "createdAt": "2020-08-06T16:47:26Z", "commit": {"oid": "765f28daa8d530ed4113f9c8c7592da33de392c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjo0NzoyNlrOG87wlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjo0NzoyNlrOG87wlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU0NjgzOQ==", "bodyText": "Getting the principal domain will require me to start the timer after the principal is authenticated (so not when creating the context).\nFor now, I've decided to leave this out along with the request domain.\nThis will only affect implementers that get the tags at the start of the timer (we send all arguments when stopping the timer)", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r466546839", "createdAt": "2020-08-06T16:47:26Z", "author": {"login": "OferLevi85"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -7231,8 +7231,10 @@ void logPrincipal(ResourceContext ctx) {\n     }\n \n     public ResourceContext newResourceContext(HttpServletRequest request,\n-                                              HttpServletResponse response) {\n-        Object timerMetric = metric.startTiming(\"zms_api_latency\", null);\n+                                              HttpServletResponse response,\n+                                              String httpMethod,\n+                                              String apiName) {\n+        Object timerMetric = metric.startTiming(\"zms_api_latency\", null, null, httpMethod, apiName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765f28daa8d530ed4113f9c8c7592da33de392c9"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "765f28daa8d530ed4113f9c8c7592da33de392c9", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/765f28daa8d530ed4113f9c8c7592da33de392c9", "committedDate": "2020-08-06T16:43:10Z", "message": "Update Metrics Http API to allow arguments when starting timer"}, "afterCommit": {"oid": "4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "committedDate": "2020-08-09T12:01:15Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/4a1df80e8f420f0a8bd9aaf075f2dd1aa8899d92", "committedDate": "2020-08-09T12:01:15Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}, "afterCommit": {"oid": "afcd1d6a577a7354735ece04c3b155601beb28dd", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/afcd1d6a577a7354735ece04c3b155601beb28dd", "committedDate": "2020-08-09T12:27:01Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afcd1d6a577a7354735ece04c3b155601beb28dd", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/afcd1d6a577a7354735ece04c3b155601beb28dd", "committedDate": "2020-08-09T12:27:01Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}, "afterCommit": {"oid": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "committedDate": "2020-08-09T12:31:57Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODcxMTI5", "url": "https://github.com/AthenZ/athenz/pull/1077#pullrequestreview-463871129", "createdAt": "2020-08-09T12:43:54Z", "commit": {"oid": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxMjo0Mzo1NFrOG96xvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxMjo0Mzo1NFrOG96xvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU3OTMyNA==", "bodyText": "Please note that I have changed the caller from \"getaccessext\" to \"getresourceaccessext\". Unlike the call in ZMS, putServiceIdentitySystemMeta, there is no call to verifyAuthorizedServiceOperation so this should affect anything.", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r467579324", "createdAt": "2020-08-09T12:43:54Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/ZTSImpl.java", "diffHunk": "@@ -3643,8 +3643,8 @@ Principal createPrincipalForName(String principalName) {\n     @Override\n     public ResourceAccess getResourceAccessExt(ResourceContext ctx, String action, String resource,\n             String trustDomain, String checkPrincipal) {\n-        \n-        final String caller = \"getaccessext\";\n+\n+        final String caller = ctx.getApiName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f"}, "originalPosition": 200}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/18fa18108864ce6f286c7acbb33080c19af16c6a", "committedDate": "2020-08-09T12:44:26Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/f56887c9e3402f5fe37c4d0b2df2b51f2c54347f", "committedDate": "2020-08-09T12:31:57Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}, "afterCommit": {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a", "author": {"user": {"login": "OferLevi85", "name": "Ofer Levi"}}, "url": "https://github.com/AthenZ/athenz/commit/18fa18108864ce6f286c7acbb33080c19af16c6a", "committedDate": "2020-08-09T12:44:26Z", "message": "Changes in Metrics API\n1. Update Metrics Http API to allow arguments when starting timer\n2. Store apiName (caller) in context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODcxNDU5", "url": "https://github.com/AthenZ/athenz/pull/1077#pullrequestreview-463871459", "createdAt": "2020-08-09T12:48:20Z", "commit": {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxMjo0ODoyMFrOG96zig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxMjo0ODoyMFrOG96zig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU3OTc4Ng==", "bodyText": "Unlike the other methods, I didn't change the caller as the name of the method \"putServiceIdentitySystemMeta\" is different than the caller \"putservicesystemmeta\". Changing this will break the call to verifyAuthorizedServiceOperation as it appears differently in authorized_services.json file", "url": "https://github.com/AthenZ/athenz/pull/1077#discussion_r467579786", "createdAt": "2020-08-09T12:48:20Z", "author": {"login": "OferLevi85"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/ZMSImpl.java", "diffHunk": "@@ -4552,7 +4552,7 @@ public void putServiceIdentitySystemMeta(ResourceContext ctx, String domainName,\n         verifyAuthorizedServiceOperation(principal.getAuthorizedService(), caller);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a"}, "originalPosition": 1273}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzMxNjcw", "url": "https://github.com/AthenZ/athenz/pull/1077#pullrequestreview-464731670", "createdAt": "2020-08-11T03:57:12Z", "commit": {"oid": "18fa18108864ce6f286c7acbb33080c19af16c6a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3044, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}