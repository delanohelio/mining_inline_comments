{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNDAxNDY2", "number": 1005, "title": "adding additional role meta attributes via templates", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-06-12T00:29:10Z", "url": "https://github.com/AthenZ/athenz/pull/1005", "merged": true, "mergeCommit": {"oid": "dacc7420bd0dddcb524587ce2e9e30c0f40b545d"}, "closed": true, "closedAt": "2020-06-20T07:34:17Z", "author": {"login": "jothi-prasad"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqlZTzAFqTQyOTg3NzE2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABctCmBigFqTQzNDQxMDM0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODc3MTY3", "url": "https://github.com/AthenZ/athenz/pull/1005#pullrequestreview-429877167", "createdAt": "2020-06-12T16:24:03Z", "commit": {"oid": "51f1524526d1e369b94cdf1c923affb4feb24fb3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNjoyNDowM1rOGjKL7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNjoyNDo1NlrOGjKNyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMDIzOA==", "bodyText": "The change itself is not sufficient since it's possible that the user has made some changes already and thus we don't want to lose any of those changes. So I want to make our logic a little more smarter.\nWhen applying the template and updating the role, we should read the original values and only override those that have been specified in the template. (let's have a unit test for this case as well).", "url": "https://github.com/AthenZ/athenz/pull/1005#discussion_r439520238", "createdAt": "2020-06-12T16:24:03Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -2820,7 +2820,20 @@ Role updateTemplateRole(Role role, String domainName, List<TemplateParam> params\n         }\n         Role templateRole = new Role()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f1524526d1e369b94cdf1c923affb4feb24fb3"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUyMDcxMw==", "bodyText": "in our test, we should verify that all attributes have been set that are defined in the template to make sure all attributes are correctly processed.", "url": "https://github.com/AthenZ/athenz/pull/1005#discussion_r439520713", "createdAt": "2020-06-12T16:24:56Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/test/java/com/yahoo/athenz/zms/DBServiceTest.java", "diffHunk": "@@ -7012,4 +7012,72 @@ public void testAutoApplySolutionTemplate() {\n \n         zms.deleteTopLevelDomain(mockDomRsrcCtx, domainName, auditRef);\n     }\n+\n+    @Test\n+    public void testApplySolutionTemplateWithRoleMetaData() {\n+\n+        String domainName = \"solutiontemplate-rolemeta\";\n+        String caller = \"testApplySolutionTemplateWithRoleMetaData\";\n+        TopLevelDomain dom1 = createTopLevelDomainObject(domainName,\n+                \"Test Domain1\", \"testOrg\", adminUser);\n+        zms.postTopLevelDomain(mockDomRsrcCtx, auditRef, dom1);\n+\n+        // apply the template\n+\n+        List<String> templates = new ArrayList<>();\n+        templates.add(\"templateWithRoleMeta\");\n+        DomainTemplate domainTemplate = new DomainTemplate().setTemplateNames(templates);\n+        zms.dbService.executePutDomainTemplate(mockDomRsrcCtx, domainName, domainTemplate, auditRef, caller);\n+\n+        DomainTemplateList domainTemplateList = zms.dbService.listDomainTemplates(domainName);\n+        assertEquals(1, domainTemplateList.getTemplateNames().size());\n+\n+        // verify that our role collection includes the expected roles\n+\n+        List<String> names = zms.dbService.listRoles(domainName);\n+        assertEquals(2, names.size());\n+        assertTrue(names.contains(\"admin\"));\n+        assertTrue(names.contains(\"vip_admin\"));\n+\n+        Role role = zms.dbService.getRole(domainName, \"vip_admin\", false, false, false);\n+        assertEquals(domainName + \":role.vip_admin\", role.getName());\n+        assertNull(role.getTrust());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f1524526d1e369b94cdf1c923affb4feb24fb3"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b60adc4e7f191d47c8c5b06ea62b7697e290ca", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/c6b60adc4e7f191d47c8c5b06ea62b7697e290ca", "committedDate": "2020-06-16T18:01:42Z", "message": "adding additional role meta attributes on adding roles via templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd514c3c076c04828ec2fca7509bc7b3049be36", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/2cd514c3c076c04828ec2fca7509bc7b3049be36", "committedDate": "2020-06-16T18:05:24Z", "message": "added merging(Upsert) logic to avoid overwriting existing values"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30c2be1ffe1f067e7d481783d063b4ff351dc594", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/30c2be1ffe1f067e7d481783d063b4ff351dc594", "committedDate": "2020-06-16T02:28:30Z", "message": "added merging(Upsert) logic to avoid overwriting existing values"}, "afterCommit": {"oid": "2cd514c3c076c04828ec2fca7509bc7b3049be36", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/2cd514c3c076c04828ec2fca7509bc7b3049be36", "committedDate": "2020-06-16T18:05:24Z", "message": "added merging(Upsert) logic to avoid overwriting existing values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a326b8e43d2f47a1023c5145537a07309219b6af", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/a326b8e43d2f47a1023c5145537a07309219b6af", "committedDate": "2020-06-17T17:15:55Z", "message": "changing autoupdate flag to boolean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDU1MzYy", "url": "https://github.com/AthenZ/athenz/pull/1005#pullrequestreview-433455362", "createdAt": "2020-06-18T16:32:00Z", "commit": {"oid": "a326b8e43d2f47a1023c5145537a07309219b6af"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjozMjowMFrOGl3O9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjozMjowMFrOGl3O9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1NTQ0NQ==", "bodyText": "we cannot change the behavior of the processRole - that method is used in lots of places.\nthis call must be done only in the method where templates are being handled.", "url": "https://github.com/AthenZ/athenz/pull/1005#discussion_r442355445", "createdAt": "2020-06-18T16:32:00Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/DBService.java", "diffHunk": "@@ -509,6 +509,7 @@ boolean processRole(ObjectStoreConnection con, Role originalRole, String domainN\n         } else {\n             // carrying over auditEnabled from original role\n             role.setAuditEnabled(originalRole.getAuditEnabled());\n+            mergeOriginalRoleAndMetaRoleAttributes(originalRole, role);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a326b8e43d2f47a1023c5145537a07309219b6af"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d77a8a43665f0c1789dfa822bee5b0208540ba5a", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/d77a8a43665f0c1789dfa822bee5b0208540ba5a", "committedDate": "2020-06-18T17:22:05Z", "message": "Merge branch 'master' of https://github.com/yahoo/athenz into rolemeta-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "842100092e141786d84a82fec114f2905682af13", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/842100092e141786d84a82fec114f2905682af13", "committedDate": "2020-06-18T23:37:24Z", "message": "moving merge code out from process role in to template code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDEwMzQy", "url": "https://github.com/AthenZ/athenz/pull/1005#pullrequestreview-434410342", "createdAt": "2020-06-20T07:34:01Z", "commit": {"oid": "842100092e141786d84a82fec114f2905682af13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2970, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}