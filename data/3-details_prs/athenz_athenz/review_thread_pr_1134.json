{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTU1NTIx", "number": 1134, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTozNzoxNlrOEq5Kyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowMzowNlrOErdXuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDEyMjk4OnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTozNzoxNlrOHdXErw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTozNzoxNlrOHdXErw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU0ODc4Mw==", "bodyText": "NotificationToMetricConverter purpose is similar to NotificationToEmailConverter (instead of mail convert to metrics)", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500548783", "createdAt": "2020-10-06T19:37:16Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -26,12 +26,12 @@\n     // key value pair describing additional details about notification\n     private Map<String, String> details;\n \n-    // Type of notification\n-    private String type;\n-\n     // Utility class to convert the notification into an email\n     private NotificationToEmailConverter notificationToEmailConverter;\n \n+    // Utility class to convert the notification into metric attributes\n+    private NotificationToMetricConverter notificationToMetricConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDEzMjQxOnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationMetric.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0MDoxMVrOHdXKqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0MDoxMVrOHdXKqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MDMxMg==", "bodyText": "NotificationMetric holds attributes in the data structure List<String[]> (a list of flat array metric records).\nSo I had to implement custom equals and hashCode (for tests to check equality correctly and to enable holding this structure in a hashmap if we would like to do so in the future).", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500550312", "createdAt": "2020-10-06T19:40:11Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/NotificationMetric.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *  Copyright 2020 Verizon Media\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package com.yahoo.athenz.common.server.notification;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class NotificationMetric {\n+\n+    // Metric attributes as a list of flat arrays\n+    private List<String[]> attributes;\n+\n+    public NotificationMetric(List<String[]> attributes) {\n+        this.attributes = attributes;\n+    }\n+\n+    public List<String[]> getAttributes() {\n+        return attributes;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        NotificationMetric that = (NotificationMetric) o;\n+\n+        if (attributes.size() != ((NotificationMetric) o).attributes.size()) {\n+            return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDE0NjQ1OnYy", "diffSide": "RIGHT", "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/notification/PendingGroupMembershipApprovalNotificationTask.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0NDozMFrOHdXTew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOTo0NDozMFrOHdXTew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU1MjU3MQ==", "bodyText": "There are two notification tasks that don't contain details at all (PendingGroupMembershipApprovalNotificationToMetricConverter and PendingRoleMembershipApprovalNotificationToMetricConverter).\nCurrently, I only record that notification of that type happened. Let me know if I should record the recipients.", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500552571", "createdAt": "2020-10-06T19:44:30Z", "author": {"login": "OferLevi85"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/notification/PendingGroupMembershipApprovalNotificationTask.java", "diffHunk": "@@ -88,4 +91,20 @@ public NotificationEmail getNotificationAsEmail(Notification notification) {\n             return new NotificationEmail(subject, body, fullyQualifiedEmailAddresses);\n         }\n     }\n+\n+    public static class PendingGroupMembershipApprovalNotificationToMetricConverter implements NotificationToMetricConverter {\n+        private final static String NOTIFICATION_TYPE = \"pending_group_membership_approval\";\n+\n+        @Override\n+        public NotificationMetric getNotificationAsMetrics(Notification notification) {\n+            String[] record = new String[] {\n+                    METRIC_NOTIFICATION_TYPE_KEY, NOTIFICATION_TYPE\n+            };\n+\n+            List<String[]> attributes = new ArrayList<>();\n+            attributes.add(record);\n+            // This notification doesn't contain any details. We should consider adding the recipients in their own tags.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a22a52cca1266238d404ce149d520d22e4ca8bdf"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjQ2MDQzOnYy", "diffSide": "RIGHT", "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDozMzozMVrOHds_iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMDozMzozMVrOHds_iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkwNzkxMg==", "bodyText": "I get the currentTime as an interface argument so equality checks will be successful in tests (calculating the currentTime inside each notification makes a difference for attributes such as \"expiry_days\" which can sometimes result in test failures)", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r500907912", "createdAt": "2020-10-07T10:33:31Z", "author": {"login": "OferLevi85"}, "path": "libs/java/server_common/src/main/java/com/yahoo/athenz/common/server/notification/Notification.java", "diffHunk": "@@ -93,6 +86,18 @@ public NotificationEmail getNotificationAsEmail() {\n         return null;\n     }\n \n+    public Notification setNotificationToMetricConverter(NotificationToMetricConverter notificationToMetricConverter) {\n+        this.notificationToMetricConverter = notificationToMetricConverter;\n+        return this;\n+    }\n+\n+    public NotificationMetric getNotificationAsMetrics(Timestamp currentTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDA1NDMyOnYy", "diffSide": "LEFT", "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowMzowNlrOHePIKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowMzowNlrOHePIKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2NzE3Ng==", "bodyText": "I also took advantage of the changes to change the Timestamps used in this notification from \"java.sql.Timestamp\" to \"com.yahoo.rdl.Timestamp\".", "url": "https://github.com/AthenZ/athenz/pull/1134#discussion_r501467176", "createdAt": "2020-10-08T06:03:06Z", "author": {"login": "OferLevi85"}, "path": "servers/zts/src/main/java/com/yahoo/athenz/zts/notification/CertFailedRefreshNotificationTask.java", "diffHunk": "@@ -25,17 +25,18 @@\n import com.yahoo.athenz.zts.ZTSConsts;\n import com.yahoo.athenz.zts.cert.InstanceCertManager;\n import com.yahoo.athenz.zts.store.DataStore;\n+import com.yahoo.rdl.Timestamp;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import java.sql.Timestamp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da05a38e91075fd3fdcba1d2631b27d505323f6"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1613, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}