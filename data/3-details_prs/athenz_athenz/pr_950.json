{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5Mjg2Njgx", "number": 950, "title": "modify using localtime for retrieving modified domains", "bodyText": "Problem\nZMS uses MySQL Connector/J for DB connections. MySQL Connector/J converted to DB's time zone until 5.x, but from 8.x, it doesn't convert to DB's time zone.\n\n5.x (expected behavior): MySQL Connector/J converts GMT to JST when the DB time zone is JST.\n8.x (Unintended behavior): MySQL Connector/J will not convert GMT even if the DB time zone is JST\n\nWhen retrieving modified domains from database server, ZMS generates the query with GMT, but the time zone of database is not GMT, so I cannot retrieve modified domains.\nIs there any way to convert GMT to localtime when retrieving modified domains?\nFix\nThis is an idea to solve this problem.", "createdAt": "2020-04-27T06:41:14Z", "url": "https://github.com/AthenZ/athenz/pull/950", "merged": true, "mergeCommit": {"oid": "377b2963d3ecf118d2e77663175078bc6d98a4b5"}, "closed": true, "closedAt": "2020-04-28T05:19:14Z", "author": {"login": "TakuyaMatsu"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbpuYEAH2gAyNDA5Mjg2NjgxOjc4OTg4Yzg4YmM5NTdlZTE5MGRjODQwMmNkMWQ5Yzg4OWNmM2Q2MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb82Z9AFqTQwMTUwMzA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78988c88bc957ee190dc8402cd1d9c889cf3d631", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/78988c88bc957ee190dc8402cd1d9c889cf3d631", "committedDate": "2020-04-27T06:58:48Z", "message": "modify using localtime for retrieving modified domains"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dfbd8af9a2eb0e704cc07e781ce8e3199e1f570", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/7dfbd8af9a2eb0e704cc07e781ce8e3199e1f570", "committedDate": "2020-04-27T06:38:01Z", "message": "modify using localtime for retrieving modified domains"}, "afterCommit": {"oid": "78988c88bc957ee190dc8402cd1d9c889cf3d631", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/78988c88bc957ee190dc8402cd1d9c889cf3d631", "committedDate": "2020-04-27T06:58:48Z", "message": "modify using localtime for retrieving modified domains"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTA5OTg2", "url": "https://github.com/AthenZ/athenz/pull/950#pullrequestreview-401109986", "createdAt": "2020-04-27T16:14:22Z", "commit": {"oid": "78988c88bc957ee190dc8402cd1d9c889cf3d631"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDoyM1rOGMrrag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNToxNFrOGMruAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTcyMg==", "bodyText": "this becomes a wasted operation if the command itself does not the calendar instance. please retain the original behavior where the calendar is obtained only when its needed.", "url": "https://github.com/AthenZ/athenz/pull/950#discussion_r415951722", "createdAt": "2020-04-27T16:14:23Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/jdbc/JDBCConnection.java", "diffHunk": "@@ -648,6 +649,8 @@ public boolean deleteDomain(String domainName) {\n     PreparedStatement prepareDomainScanStatement(String prefix, long modifiedSince)\n             throws SQLException {\n         \n+        Calendar cal = getCalendarInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78988c88bc957ee190dc8402cd1d9c889cf3d631"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MjM4NA==", "bodyText": "we should not fetch the property and parse it every time. this should be a static member of the class  so we only do it once and never again.", "url": "https://github.com/AthenZ/athenz/pull/950#discussion_r415952384", "createdAt": "2020-04-27T16:15:14Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/jdbc/JDBCConnection.java", "diffHunk": "@@ -666,13 +668,27 @@ PreparedStatement prepareDomainScanStatement(String prefix, long modifiedSince)\n             }\n         } else if (modifiedSince != 0) {\n             ps = con.prepareStatement(SQL_LIST_DOMAIN_MODIFIED);\n-            Calendar cal = Calendar.getInstance(TimeZone.getTimeZone(\"GMT\"));\n             ps.setTimestamp(1, new java.sql.Timestamp(modifiedSince), cal);\n         } else {\n             ps = con.prepareStatement(SQL_LIST_DOMAIN);\n         }\n         return ps;\n     }\n+\n+    Calendar getCalendarInstance() {\n+\n+        Boolean useLocalTimeZone = Boolean.parseBoolean(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78988c88bc957ee190dc8402cd1d9c889cf3d631"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a2db8f8407c21e706048594e827d2f2ddeaa6d4", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/8a2db8f8407c21e706048594e827d2f2ddeaa6d4", "committedDate": "2020-04-27T17:42:24Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fc44a090697e0ddb47457ebf7d770723cbe1ba9", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/1fc44a090697e0ddb47457ebf7d770723cbe1ba9", "committedDate": "2020-04-27T17:06:25Z", "message": "fix"}, "afterCommit": {"oid": "8a2db8f8407c21e706048594e827d2f2ddeaa6d4", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/8a2db8f8407c21e706048594e827d2f2ddeaa6d4", "committedDate": "2020-04-27T17:42:24Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjUwNjIz", "url": "https://github.com/AthenZ/athenz/pull/950#pullrequestreview-401250623", "createdAt": "2020-04-27T19:15:14Z", "commit": {"oid": "8a2db8f8407c21e706048594e827d2f2ddeaa6d4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxOToxNToxNFrOGMzjSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxOToxNTozM1rOGMzkBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4MDcxNQ==", "bodyText": "let's move this code how it was before. as I mentioned in my earlier comment we don't need a calendar object if we're just doing a list domain operation.", "url": "https://github.com/AthenZ/athenz/pull/950#discussion_r416080715", "createdAt": "2020-04-27T19:15:14Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/jdbc/JDBCConnection.java", "diffHunk": "@@ -647,7 +650,9 @@ public boolean deleteDomain(String domainName) {\n \n     PreparedStatement prepareDomainScanStatement(String prefix, long modifiedSince)\n             throws SQLException {\n-        \n+\n+        Calendar cal = Calendar.getInstance(TimeZone.getTimeZone(MYSQL_SERVER_TIMEZONE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2db8f8407c21e706048594e827d2f2ddeaa6d4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4MDkwMA==", "bodyText": "please update this setting to reflect the new name.", "url": "https://github.com/AthenZ/athenz/pull/950#discussion_r416080900", "createdAt": "2020-04-27T19:15:33Z", "author": {"login": "havetisyan"}, "path": "servers/zms/conf/zms.properties", "diffHunk": "@@ -415,3 +415,7 @@ athenz.zms.read_only_mode=false\n # needs to contact most likely a server (e.g. mysql instance)\n # running in a different region.\n #athenz.zms.master_copy_for_signed_domains=false\n+\n+# Boolean value specifying whether using the server's timezone or GMT\n+# at retriving modified domains from DB\n+#athenz.zms.use_local_timezone_in_domain_scan=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2db8f8407c21e706048594e827d2f2ddeaa6d4"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a91ecbeb8aef368bb45197aa05bee070fecb4649", "author": {"user": {"login": "TakuyaMatsu", "name": null}}, "url": "https://github.com/AthenZ/athenz/commit/a91ecbeb8aef368bb45197aa05bee070fecb4649", "committedDate": "2020-04-28T04:40:57Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTAzMDg3", "url": "https://github.com/AthenZ/athenz/pull/950#pullrequestreview-401503087", "createdAt": "2020-04-28T05:15:46Z", "commit": {"oid": "a91ecbeb8aef368bb45197aa05bee070fecb4649"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3102, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}