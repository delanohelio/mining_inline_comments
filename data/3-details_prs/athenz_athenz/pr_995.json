{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzYzODcx", "number": 995, "title": "update DB version when a client applies template", "bodyText": "I confirm that this contribution is made under the terms of the license found in the root directory of this repository's source tree and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-05-28T22:13:59Z", "url": "https://github.com/AthenZ/athenz/pull/995", "merged": true, "mergeCommit": {"oid": "c14f802a3becc39bec7b262761aefe9c5160dd59"}, "closed": true, "closedAt": "2020-06-02T22:53:32Z", "author": {"login": "jothi-prasad"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl1XURgH2gAyNDI0NzYzODcxOmIyMGMyNWYwN2ZiY2Y1YzU5MjZjZDlhN2Y5ZWNlZTcwODRhNDNmYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnc9MxgFqTQyMzExMDEwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf", "committedDate": "2020-05-28T22:11:43Z", "message": "update DB version when a client applies template"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDQ3MTk1", "url": "https://github.com/AthenZ/athenz/pull/995#pullrequestreview-421447195", "createdAt": "2020-05-30T22:13:46Z", "commit": {"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMjoxMzo0NlrOGc1l0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMjoxMzo0NlrOGc1l0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg5MTM0NA==", "bodyText": "this implementation doesn't look correct to me. we're setting a templateMetaList object which contains only a single templateMeta which only has a version number. where are the rest of the templates or where are the template names we're storing?", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r432891344", "createdAt": "2020-05-30T22:13:46Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,29 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20c25f07fbcf5c5926cd9a7f9ecee7084a43faf"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a356edf817c89fe75306e71c7e682554f5e331e0", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/a356edf817c89fe75306e71c7e682554f5e331e0", "committedDate": "2020-06-01T21:36:48Z", "message": "updating additional templatemetadata details in file connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/5e41bc86a691875c6c7eb27d20c44ffc8f66341c", "committedDate": "2020-06-01T21:40:07Z", "message": "removing unused import from test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjMzNjgw", "url": "https://github.com/AthenZ/athenz/pull/995#pullrequestreview-422233680", "createdAt": "2020-06-01T22:52:50Z", "commit": {"oid": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo1Mjo1MFrOGdcn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo1Mjo1MFrOGdcn5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUzMDg1NQ==", "bodyText": "we're creating the template meta list every time this api is called and replacing the struct in domain struct. which means it will only have a single template and will be overwritten every time. The implementation needs to be:\nif (domainStruct.getTemplateMeta() == null) {\ndomainStruct.setTemplateMeta(new ArrayList<>());\n}\nArrayList templateMetalist = domainStruct.getTemplateMeta();\n// then iterate through the list and see if we have an object\n// with that template. If yes, update the version only,\n// if not then create a new object and add it to the list", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433530855", "createdAt": "2020-06-01T22:52:50Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,34 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+        TemplateMetaData templateMeta = new TemplateMetaData();\n+        templateMeta.setTemplateName(templateName);\n+        templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+        templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+        templateMeta.setDescription(templateMetaData.getDescription());\n+        templateMeta.setTimestamp(templateMetaData.getTimestamp());\n+        templateMeta.setCurrentVersion(templateMetaData.getLatestVersion());\n+        templateMetalist.add(templateMeta);\n+        domainStruct.setTemplateMeta(templateMetalist);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e41bc86a691875c6c7eb27d20c44ffc8f66341c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b", "committedDate": "2020-06-02T03:19:49Z", "message": "addressing review comments - change in file connection to handle update version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNDE4Mjk5", "url": "https://github.com/AthenZ/athenz/pull/995#pullrequestreview-422418299", "createdAt": "2020-06-02T07:40:26Z", "commit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzo0MDoyNlrOGdluyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzo0MDo1NFrOGdlv3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDA3NA==", "bodyText": "we're missing the handling of the when when templateMetaList is not empty but it doesn't contain the templateName we're updating. In that case, we also need to add a new object.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680074", "createdAt": "2020-06-02T07:40:26Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY4MDM0OA==", "bodyText": "these lines 436-439  are not necessary since the domain object only needs to contain the name of the template and the latest version and no other detail.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r433680348", "createdAt": "2020-06-02T07:40:54Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,47 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                }\n+            }\n+        } else {\n+            TemplateMetaData templateMeta = new TemplateMetaData();\n+            templateMeta.setTemplateName(templateName);\n+            templateMeta.setKeywordsToReplace(templateMetaData.getKeywordsToReplace());\n+            templateMeta.setAutoUpdate(templateMetaData.getAutoUpdate());\n+            templateMeta.setDescription(templateMetaData.getDescription());\n+            templateMeta.setTimestamp(templateMetaData.getTimestamp());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867bfd01b9f449ba5ddd80b2bdd0423d47a02e3b"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2", "committedDate": "2020-06-02T19:18:55Z", "message": "file connection implementation changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDU5MTM4", "url": "https://github.com/AthenZ/athenz/pull/995#pullrequestreview-423059138", "createdAt": "2020-06-02T21:08:55Z", "commit": {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowODo1NVrOGeECYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowODo1NVrOGeECYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NjYxMQ==", "bodyText": "this is not still correct since if you have 2 template in your list, when comparing the first element, you're just overriding the full list.\n#1000\nI created a new PR based on your PR. Remove the setTemplateNameAndVersion method from your PR and use the implementation of updateDomainTemplate method from that PR.", "url": "https://github.com/AthenZ/athenz/pull/995#discussion_r434176611", "createdAt": "2020-06-02T21:08:55Z", "author": {"login": "havetisyan"}, "path": "servers/zms/src/main/java/com/yahoo/athenz/zms/store/file/FileConnection.java", "diffHunk": "@@ -405,6 +405,41 @@ public boolean insertDomainTemplate(String domainName, String templateName, Stri\n         return true;\n     }\n \n+    @Override\n+    public boolean updateDomainTemplate(String domainName, String templateName, TemplateMetaData templateMetaData) {\n+        DomainStruct domainStruct = getDomainStruct(domainName);\n+        ArrayList<TemplateMetaData> templateMetalist = new ArrayList<>();\n+        if (domainStruct == null) {\n+            throw ZMSUtils.error(ResourceException.NOT_FOUND, \"domain not found\", \"updateDomainTemplate\");\n+        }\n+        if (domainStruct.getTemplates() == null) {\n+            domainStruct.setTemplates(new ArrayList<>());\n+        }\n+        ArrayList<String> templates = domainStruct.getTemplates();\n+        if (!templates.contains(templateName)) {\n+            templates.add(templateName);\n+        }\n+\n+        if (domainStruct.getTemplateMeta() == null) {\n+            domainStruct.setTemplateMeta(new ArrayList<>());\n+        }\n+        ArrayList<TemplateMetaData> templateMetaList = domainStruct.getTemplateMeta();\n+        if (!templateMetaList.isEmpty()) {\n+            for (TemplateMetaData meta : templateMetaList) {\n+                if (meta.getTemplateName().equals(templateName)) {\n+                    meta.setCurrentVersion(templateMetaData.getLatestVersion());\n+                } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0adbbfef5f9e5b6bf1a795a5b75719c3fe963d2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a358e40fb058e1506cc8287a880d0ff7a6f38c79", "author": {"user": null}, "url": "https://github.com/AthenZ/athenz/commit/a358e40fb058e1506cc8287a880d0ff7a6f38c79", "committedDate": "2020-06-02T22:03:00Z", "message": "changes to file implementation based on review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTEwMTA3", "url": "https://github.com/AthenZ/athenz/pull/995#pullrequestreview-423110107", "createdAt": "2020-06-02T22:53:19Z", "commit": {"oid": "a358e40fb058e1506cc8287a880d0ff7a6f38c79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2959, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}