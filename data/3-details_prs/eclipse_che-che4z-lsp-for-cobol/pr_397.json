{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NzYyNTQ5", "number": 397, "title": "Avoid many error messages for copybook downloading", "bodyText": "The middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\nCloses #384\nCloses #390\nSigned-off-by: Anton Grigorev anton.grigorev@broadcom.com", "createdAt": "2020-06-17T10:38:37Z", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397", "merged": true, "mergeCommit": {"oid": "204b97a09328b802a29cad9e3aee17d9357fcbb4"}, "closed": true, "closedAt": "2020-06-18T07:50:14Z", "author": {"login": "grianbrcom"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsJf4TgFqTQzMjMzMjQ5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsZDk6gFqTQzMjk5ODAyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMzMyNDkx", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#pullrequestreview-432332491", "createdAt": "2020-06-17T12:05:42Z", "commit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNTo0M1rOGlCqVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjozMDozMlrOGlDetw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NDEwMw==", "bodyText": "'DoneAnalysisEvent' sounds a little strange, but still applicable. Maybe, something like `AnalysisFinishedEvent' would be more descriptive?", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441494103", "createdAt": "2020-06-17T12:05:43Z", "author": {"login": "temanbrcom"}, "path": "com.ca.lsp.cobol/lsp-core-domain/src/main/java/com/broadcom/lsp/domain/cobol/event/model/DoneAnalysisEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ */\n+\n+package com.broadcom.lsp.domain.cobol.event.model;\n+\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * This class is a data transfer object that contains the uri of analyzed document.\n+ */\n+@NoArgsConstructor\n+@Data\n+public class DoneAnalysisEvent extends DataEvent{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTA2Mg==", "bodyText": "In fact, it more a signal event, not really a data transfer object", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441495062", "createdAt": "2020-06-17T12:07:35Z", "author": {"login": "temanbrcom"}, "path": "com.ca.lsp.cobol/lsp-core-domain/src/main/java/com/broadcom/lsp/domain/cobol/event/model/DoneAnalysisEvent.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright (c) 2020 Broadcom.\n+ * The term \"Broadcom\" refers to Broadcom Inc. and/or its subsidiaries.\n+ *\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *    Broadcom, Inc. - initial API and implementation\n+ */\n+\n+package com.broadcom.lsp.domain.cobol.event.model;\n+\n+import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * This class is a data transfer object that contains the uri of analyzed document.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUwNzUxMQ==", "bodyText": "By the agreement, the method Javadoc should start with a verb", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441507511", "createdAt": "2020-06-17T12:30:32Z", "author": {"login": "temanbrcom"}, "path": "com.ca.lsp.cobol/lsp-service-cobol/src/main/java/com/ca/lsp/cobol/service/CopybookServiceImpl.java", "diffHunk": "@@ -55,11 +63,30 @@ public CopybookServiceImpl(\n     this.files = files;\n \n     dataBus.subscribe(REQUIRED_COPYBOOK_EVENT, this);\n+    dataBus.subscribe(DONE_ANALYSIS_EVENT, this);\n   }\n \n   @Override\n   public void invalidateURICache() {\n     copybookPaths.clear();\n+    copybooksForDownloading.clear();\n+  }\n+\n+  /**\n+   * Depends on DataEvent type it will be handled with appropriate handler:\n+   * {@link #handleRequiredCopybookEvent} or {@link #handleDoneAnalysisEvent}.\n+   *\n+   * @param event must be {@link RequiredCopybookEvent} or {@link DoneAnalysisEvent}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDEyMTU3", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#pullrequestreview-432412157", "createdAt": "2020-06-17T13:40:43Z", "commit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzo0MDo0NFrOGlGRgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzo0MDo0NFrOGlGRgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1MzI4Mg==", "bodyText": "can we extract this middleware, params, etc. in desc. with 'let' to reuse", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441553282", "createdAt": "2020-06-17T13:40:44Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/MiddlewareTest.ts", "diffHunk": "@@ -28,20 +28,33 @@ describe(\"Copybook downloader\", () => {\n         const copybookResolverURI: any = {\n             resolveCopybookURI: jest.fn().mockResolvedValue(\"copybookUri\"),\n         };\n-        const middleware = new Middleware(null, copybookResolverURI);\n-        const params = constructParams(\"broadcom-cobol-lsp.copybook.cobFile.bookName\");\n+        const middleware = new Middleware(copybookResolverURI, null);\n+        const params = constructParams(\"broadcom-cobol-lsp.copybook-resolve.cobFile.bookName\");\n         expect(await middleware.handleConfigurationRequest(params, null, null)).toEqual([\"copybookUri\"]);\n         expect(copybookResolverURI.resolveCopybookURI).toHaveBeenCalledWith(\"bookName\", \"cobFile\");\n     });\n     it(\"Handle copybook request for name with dots\", async () => {\n         const copybookResolverURI: any = {\n             resolveCopybookURI: jest.fn().mockResolvedValue(\"copybookUri\"),\n         };\n-        const middleware = new Middleware(null, copybookResolverURI);\n-        const params = constructParams(\"broadcom-cobol-lsp.copybook.USER.CLIST.COB.bookName\");\n+        const middleware = new Middleware(copybookResolverURI, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDIwMDc1", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#pullrequestreview-432420075", "createdAt": "2020-06-17T13:48:41Z", "commit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzo0ODo0MVrOGlGoxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzo0ODo0MVrOGlGoxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1OTIzNg==", "bodyText": "Regarding to this, also better to define return type in method declaration explicitly", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#discussion_r441559236", "createdAt": "2020-06-17T13:48:41Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/services/Middleware.ts", "diffHunk": "@@ -25,21 +25,28 @@ export class Middleware {\n         return [params.substring(secondDot + 1, lastDot), params.substring(lastDot + 1)];\n     }\n     constructor(\n-        private copybooksPathGenerator: CopybooksPathGenerator,\n-        private copybookResolverURI: CopybookURI) {\n+        private copybookResolverURI: CopybookURI,\n+        private copybookDownloader: CopybookDownloadService) {\n     }\n \n     public async handleConfigurationRequest(\n         params: ConfigurationParams,\n         token: CancellationToken,\n         next: ConfigurationRequest.HandlerSignature) {\n \n-        if (params.items.length === 1) {\n+        if (params.items.length > 0) {\n             const sectionName = params.items[0].section;\n-            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook\")) {\n+            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook-resolve\")) {\n                 const [cobolFileName, copybookName] = Middleware.extractFileAndCopybookNames(sectionName);\n                 return [await this.copybookResolverURI.resolveCopybookURI(copybookName, cobolFileName)];\n             }\n+            if (sectionName.startsWith(\"broadcom-cobol-lsp.copybook-download\")) {\n+                for (const item of params.items) {\n+                    const [cobolFileName, copybookName] = Middleware.extractFileAndCopybookNames(item.section);\n+                    this.copybookDownloader.downloadCopybook(cobolFileName, copybookName);\n+                }\n+                return [];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/2e7e394cb319f2b34472d77fd2c843d99c226726", "committedDate": "2020-06-17T15:15:59Z", "message": "fix: Avoid many error messages for copybook downloading #384\n\nThe middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\n\nCloses #384\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fc82cadf18fc40613375da3187b25802ed268a2", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/0fc82cadf18fc40613375da3187b25802ed268a2", "committedDate": "2020-06-17T10:37:11Z", "message": "fix: Avoid many error messages for copybook downloading #384\n\nThe middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\n\nCloses 384\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}, "afterCommit": {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/2e7e394cb319f2b34472d77fd2c843d99c226726", "committedDate": "2020-06-17T15:15:59Z", "message": "fix: Avoid many error messages for copybook downloading #384\n\nThe middleware process two calls: resolve URI and download copybook.\nThe server synchronously resolves URI copybooks, not in the server cache\nduring document analysis. After the scan, the server sends one call to\nmiddleware with a list of copybooks to download.\nDoneAnalysisEvent was added to the databus.\n\nCloses #384\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTMxNDE1", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#pullrequestreview-432531415", "createdAt": "2020-06-17T15:39:36Z", "commit": {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTk4MDI4", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/397#pullrequestreview-432998028", "createdAt": "2020-06-18T07:10:17Z", "commit": {"oid": "2e7e394cb319f2b34472d77fd2c843d99c226726"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1142, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}