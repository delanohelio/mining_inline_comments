{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMDM0MTg0", "number": 382, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTozNzoxNlrOEDy3DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoxOTowM1rOEDzwkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDE0NDc2OnYy", "diffSide": "RIGHT", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTozNzoxNlrOGhBSwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyMzoyM1rOGhC6GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3NzM3OA==", "bodyText": "You could use this: expect(uri).toMatch(CPY_FOLDER_NAME);", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437277378", "createdAt": "2020-06-09T09:37:16Z", "author": {"login": "grianbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "diffHunk": "@@ -110,3 +116,51 @@ describe(\"With allowed input parameters, the list of URI that represent copybook\n         expect(buildResultArrayFrom([\"HLQ.DATASET1.DATASET2\"], \"PRF\")).toBe(1);\n     });\n });\n+\n+describe(\"Prioritize search criteria for copybooks test suite\", () => {\n+    function provideMockValueForLocalAndDSN(localPath: string, dsnPath: string) {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([localPath]),\n+        }).mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([dsnPath]),\n+        });\n+    }\n+\n+    const profileService: ProfileService = new ProfileService(undefined);\n+    const copybookDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, undefined, undefined, undefined);\n+    const copybookURI: CopybookURI = new CopybookURI(profileService, copybookDownloadService);\n+    profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+    copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+\n+    const spySearchInWorkspace = jest.spyOn(CopybookURI, \"searchInWorkspace\");\n+    test(\"With only a local folder defined in the settings.json, the search is applied locally\", async () => {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValue({\n+            get: jest.fn().mockReturnValue([CPY_FOLDER_NAME]),\n+        });\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri.includes(CPY_FOLDER_NAME)).toBe(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMzgzMg==", "bodyText": "OK", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437303832", "createdAt": "2020-06-09T10:23:23Z", "author": {"login": "zacanbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "diffHunk": "@@ -110,3 +116,51 @@ describe(\"With allowed input parameters, the list of URI that represent copybook\n         expect(buildResultArrayFrom([\"HLQ.DATASET1.DATASET2\"], \"PRF\")).toBe(1);\n     });\n });\n+\n+describe(\"Prioritize search criteria for copybooks test suite\", () => {\n+    function provideMockValueForLocalAndDSN(localPath: string, dsnPath: string) {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([localPath]),\n+        }).mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([dsnPath]),\n+        });\n+    }\n+\n+    const profileService: ProfileService = new ProfileService(undefined);\n+    const copybookDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, undefined, undefined, undefined);\n+    const copybookURI: CopybookURI = new CopybookURI(profileService, copybookDownloadService);\n+    profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+    copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+\n+    const spySearchInWorkspace = jest.spyOn(CopybookURI, \"searchInWorkspace\");\n+    test(\"With only a local folder defined in the settings.json, the search is applied locally\", async () => {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValue({\n+            get: jest.fn().mockReturnValue([CPY_FOLDER_NAME]),\n+        });\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri.includes(CPY_FOLDER_NAME)).toBe(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3NzM3OA=="}, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDE1MzYyOnYy", "diffSide": "RIGHT", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTozOTozNVrOGhBYUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyMzowN1rOGhC5kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3ODgwMQ==", "bodyText": "Another example: expect(uri).not.toBe(\"\");", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437278801", "createdAt": "2020-06-09T09:39:35Z", "author": {"login": "grianbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "diffHunk": "@@ -110,3 +116,51 @@ describe(\"With allowed input parameters, the list of URI that represent copybook\n         expect(buildResultArrayFrom([\"HLQ.DATASET1.DATASET2\"], \"PRF\")).toBe(1);\n     });\n });\n+\n+describe(\"Prioritize search criteria for copybooks test suite\", () => {\n+    function provideMockValueForLocalAndDSN(localPath: string, dsnPath: string) {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([localPath]),\n+        }).mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([dsnPath]),\n+        });\n+    }\n+\n+    const profileService: ProfileService = new ProfileService(undefined);\n+    const copybookDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, undefined, undefined, undefined);\n+    const copybookURI: CopybookURI = new CopybookURI(profileService, copybookDownloadService);\n+    profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+    copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+\n+    const spySearchInWorkspace = jest.spyOn(CopybookURI, \"searchInWorkspace\");\n+    test(\"With only a local folder defined in the settings.json, the search is applied locally\", async () => {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValue({\n+            get: jest.fn().mockReturnValue([CPY_FOLDER_NAME]),\n+        });\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri.includes(CPY_FOLDER_NAME)).toBe(true);\n+        expect(spySearchInWorkspace).toBeCalledTimes(1);\n+\n+    });\n+\n+    test(\"With no settings provided, two search strategies are applied and function return an empty string\", async () => {\n+        profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+        copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+        provideMockValueForLocalAndDSN(\"\", \"\");\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri).toBe(\"\");\n+        expect(spySearchInWorkspace).toBeCalledTimes(2);\n+    });\n+\n+    test(\"With both local and dsn references defined in the settings.json, the search is applied on local resources\" +\n+        \"first\", async () => {\n+        provideMockValueForLocalAndDSN(CPY_FOLDER_NAME, \"\");\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri === \"\").toBe(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMzY5Ng==", "bodyText": "NICE! I will do that way!", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437303696", "createdAt": "2020-06-09T10:23:07Z", "author": {"login": "zacanbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookResolveURITest.ts", "diffHunk": "@@ -110,3 +116,51 @@ describe(\"With allowed input parameters, the list of URI that represent copybook\n         expect(buildResultArrayFrom([\"HLQ.DATASET1.DATASET2\"], \"PRF\")).toBe(1);\n     });\n });\n+\n+describe(\"Prioritize search criteria for copybooks test suite\", () => {\n+    function provideMockValueForLocalAndDSN(localPath: string, dsnPath: string) {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([localPath]),\n+        }).mockReturnValueOnce({\n+            get: jest.fn().mockReturnValueOnce([dsnPath]),\n+        });\n+    }\n+\n+    const profileService: ProfileService = new ProfileService(undefined);\n+    const copybookDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, undefined, undefined, undefined);\n+    const copybookURI: CopybookURI = new CopybookURI(profileService, copybookDownloadService);\n+    profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+    copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+\n+    const spySearchInWorkspace = jest.spyOn(CopybookURI, \"searchInWorkspace\");\n+    test(\"With only a local folder defined in the settings.json, the search is applied locally\", async () => {\n+        vscode.workspace.getConfiguration = jest.fn().mockReturnValue({\n+            get: jest.fn().mockReturnValue([CPY_FOLDER_NAME]),\n+        });\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri.includes(CPY_FOLDER_NAME)).toBe(true);\n+        expect(spySearchInWorkspace).toBeCalledTimes(1);\n+\n+    });\n+\n+    test(\"With no settings provided, two search strategies are applied and function return an empty string\", async () => {\n+        profileService.getProfile = jest.fn().mockReturnValue(\"PRF\");\n+        copybookDownloadService.downloadCopybook = jest.fn().mockReturnValue(\"CPY\");\n+        provideMockValueForLocalAndDSN(\"\", \"\");\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri).toBe(\"\");\n+        expect(spySearchInWorkspace).toBeCalledTimes(2);\n+    });\n+\n+    test(\"With both local and dsn references defined in the settings.json, the search is applied on local resources\" +\n+        \"first\", async () => {\n+        provideMockValueForLocalAndDSN(CPY_FOLDER_NAME, \"\");\n+\n+        const uri: string = await copybookURI.resolveCopybookURI(copybookName, \"PRGNAME\");\n+        expect(uri === \"\").toBe(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3ODgwMQ=="}, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDI4MTI0OnYy", "diffSide": "RIGHT", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoxNTo0MFrOGhCqAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyMzo1NFrOGhC7MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTcxNA==", "bodyText": "CopybookDownloadService sometimes created with null, sometimes with undefined.  Even though they have differences, I think here it is used on  same purpose. Can we use  one ?", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437299714", "createdAt": "2020-06-09T10:15:40Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "diffHunk": "@@ -12,119 +12,207 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n+import * as fs from \"fs-extra\";\n+import * as path from \"path\";\n import * as vscode from \"vscode\";\n+import {C4Z_FOLDER, COPYBOOKS_FOLDER} from \"../constants\";\n import {CopybookDownloadService} from \"../services/CopybookDownloadService\";\n-import {CopybooksPathGenerator} from \"../services/CopybooksPathGenerator\";\n+import {CopybookFix} from \"../services/CopybookFix\";\n+import {CopybooksPathGenerator, createCopybookPath, createDatasetPath} from \"../services/CopybooksPathGenerator\";\n import {CopybookProfile} from \"../services/DownloadQueue\";\n+import {ProfileService} from \"../services/ProfileService\";\n+import {ZoweApi} from \"../services/ZoweApi\";\n import {Type, ZoweError} from \"../services/ZoweError\";\n \n-// tslint:disable: no-unused-expression no-string-literal\n-describe(\"Copybook downloader\", () => {\n-    vscode.workspace.workspaceFolders = [{} as any];\n-    vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n-    const profile = \"zoweProfile\";\n-    const copybookProfile = new CopybookProfile(\"copybook\", profile);\n-    const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n-    it(\"Can download copybook\", async () => {\n-        /* WORK IN PROGRESS\n-                const zoweApi: any = {\n-                    listZOSMFProfiles: jest.fn().mockReturnValue([\"Something\"]),\n-                };\n-                const profileService: any = {\n-                    getProfile: jest.fn().mockReturnValue(profile),\n-                };\n-                const cbd: CopybooksDownloader = new CopybooksDownloader(zoweApi, profileService);\n-                const uri: any = {};\n-                (cbd as any).listMissingCopybooks = () => [\"COPYBVOOK\"];\n-                try {\n-                    await cbd.downloadDependencies(uri);\n-                    cbd.start();\n-                } finally {\n-                    cbd.dispose();\n-                }\n-\n-                expect(zoweApi.listZOSMFProfiles).toBeCalled();\n-        */\n+vscode.workspace.workspaceFolders = [{} as any];\n+vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n+const profile = \"zoweProfile\";\n+const copybookProfile = new CopybookProfile(\"copybook\", profile);\n+const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n+const copybookFix: CopybookFix = new CopybookFix();\n \n+describe(\"Test fetchCopybook against bad and correct configurations\", () => {\n+    let zoweApi: ZoweApi;\n+    let copybookDownloadService: CopybookDownloadService;\n+\n+    beforeAll(() => {\n+        zoweApi = new ZoweApi();\n+        copybookDownloadService = new CopybookDownloadService(copybookFix, zoweApi, null, null);\n     });\n-    it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n-        const zoweApi: any = {\n-            listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n-        };\n-        const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+\n+    test(\"Given a copybook name that is not a valid member on MF, the copybook is not downloaded\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"ANTHMEM\");\n+\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(false);\n+    });\n+\n+    test(\"Given a copybook name but a wrong instance of profile, the copybook is not downloaded and exception is thrown\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        copybookFix.processDownloadError = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", undefined);\n+        expect(result).toBe(false);\n     });\n-    it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+\n+    test(\"Given a copybook name that is a valid member on MF, the fetchCopybook correctly invoke download from MF\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        (copybookDownloadService as any).downloadCopybookFromMFUsingZowe = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(true);\n+    });\n+});\n+describe(\"Receiving an error from zowe api layer, copybooks are not retrivied and user is correctly notified\", () => {\n+    describe(\"Suite of tests related to fetchCopybook\", () => {\n+        it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n+            const zoweApi: any = {\n+                listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n+            };\n+            const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n+            expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+    });\n+\n+    describe(\"Suite of tests related to handleCopybook\", () => {\n         const zoweApi: any = {\n             listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n         };\n         const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset show an error if copybook is not found\", async () => {\n-        const zoweError = new ZoweError(\"not found\", Type.NotFound);\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n-    });\n-    it(\"handleDataset show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+        it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+            expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+\n+        it(\"handleCopybook delete copybook from its internal queue if the copybook is a valid member on MF\", async () => {\n+            // simulate that the copybook required is a valid member name on MF\n+            (cbd as any).fetchCopybook = jest.fn().mockReturnValue(true);\n+\n+            // simulate that the a copybook not found is already defined in a queue\n+            const errorQueue: Set<string> = new Set();\n+            errorQueue.add(\"copybook\");\n+\n+            await (cbd as any).handleCopybook(\"DSNAME1\", copybookProfile, errorQueue);\n+\n+            // after the analysis - since the item in the queue is a valid member on MF it should be removed from the\n+            // error queue\n+            expect(errorQueue.size).toBe(0);\n+        });\n+\n     });\n-    it(\"handleQueue show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+    describe(\"Suite of tests related to handleDataset\", () => {\n+\n+        it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n+        });\n+        it(\"handleDataset show an error if copybook is not found\", async () => {\n+            const zoweError = new ZoweError(\"not found\", Type.NotFound);\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n+        });\n+        it(\"handleDataset show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n     });\n-    it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+\n+    describe(\"Suite of tests related to handleQueue\", () => {\n+        it(\"handleQueue show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n+        it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+        });\n+        it(\"handleQueue handle Connection refused ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+        });\n+        it(\"handleQueue handle No password ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.NoPassword));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"No password in Zowe profile zoweProfile.\");\n+        });\n     });\n-    it(\"handleQueue handle Connection refused ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+});\n+\n+describe(\"Test the creation of folders that contains copybooks downloaded from MF against correct configuration in settings provided by the user\", () => {\n+    function setupScenario() {\n+        const testFolder = path.join(__dirname, C4Z_FOLDER, COPYBOOKS_FOLDER, \"profile\", \"dataset\");\n+        const copybookURIPath = path.join(testFolder, \"copybook\" + \".cpy\");\n+        const zoweApi = new ZoweApi();\n+        const copybooksDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, zoweApi, undefined, undefined);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 260}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDExMg==", "bodyText": "I will try to cleanup as much as possible", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437304112", "createdAt": "2020-06-09T10:23:54Z", "author": {"login": "zacanbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "diffHunk": "@@ -12,119 +12,207 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n+import * as fs from \"fs-extra\";\n+import * as path from \"path\";\n import * as vscode from \"vscode\";\n+import {C4Z_FOLDER, COPYBOOKS_FOLDER} from \"../constants\";\n import {CopybookDownloadService} from \"../services/CopybookDownloadService\";\n-import {CopybooksPathGenerator} from \"../services/CopybooksPathGenerator\";\n+import {CopybookFix} from \"../services/CopybookFix\";\n+import {CopybooksPathGenerator, createCopybookPath, createDatasetPath} from \"../services/CopybooksPathGenerator\";\n import {CopybookProfile} from \"../services/DownloadQueue\";\n+import {ProfileService} from \"../services/ProfileService\";\n+import {ZoweApi} from \"../services/ZoweApi\";\n import {Type, ZoweError} from \"../services/ZoweError\";\n \n-// tslint:disable: no-unused-expression no-string-literal\n-describe(\"Copybook downloader\", () => {\n-    vscode.workspace.workspaceFolders = [{} as any];\n-    vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n-    const profile = \"zoweProfile\";\n-    const copybookProfile = new CopybookProfile(\"copybook\", profile);\n-    const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n-    it(\"Can download copybook\", async () => {\n-        /* WORK IN PROGRESS\n-                const zoweApi: any = {\n-                    listZOSMFProfiles: jest.fn().mockReturnValue([\"Something\"]),\n-                };\n-                const profileService: any = {\n-                    getProfile: jest.fn().mockReturnValue(profile),\n-                };\n-                const cbd: CopybooksDownloader = new CopybooksDownloader(zoweApi, profileService);\n-                const uri: any = {};\n-                (cbd as any).listMissingCopybooks = () => [\"COPYBVOOK\"];\n-                try {\n-                    await cbd.downloadDependencies(uri);\n-                    cbd.start();\n-                } finally {\n-                    cbd.dispose();\n-                }\n-\n-                expect(zoweApi.listZOSMFProfiles).toBeCalled();\n-        */\n+vscode.workspace.workspaceFolders = [{} as any];\n+vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n+const profile = \"zoweProfile\";\n+const copybookProfile = new CopybookProfile(\"copybook\", profile);\n+const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n+const copybookFix: CopybookFix = new CopybookFix();\n \n+describe(\"Test fetchCopybook against bad and correct configurations\", () => {\n+    let zoweApi: ZoweApi;\n+    let copybookDownloadService: CopybookDownloadService;\n+\n+    beforeAll(() => {\n+        zoweApi = new ZoweApi();\n+        copybookDownloadService = new CopybookDownloadService(copybookFix, zoweApi, null, null);\n     });\n-    it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n-        const zoweApi: any = {\n-            listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n-        };\n-        const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+\n+    test(\"Given a copybook name that is not a valid member on MF, the copybook is not downloaded\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"ANTHMEM\");\n+\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(false);\n+    });\n+\n+    test(\"Given a copybook name but a wrong instance of profile, the copybook is not downloaded and exception is thrown\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        copybookFix.processDownloadError = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", undefined);\n+        expect(result).toBe(false);\n     });\n-    it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+\n+    test(\"Given a copybook name that is a valid member on MF, the fetchCopybook correctly invoke download from MF\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        (copybookDownloadService as any).downloadCopybookFromMFUsingZowe = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(true);\n+    });\n+});\n+describe(\"Receiving an error from zowe api layer, copybooks are not retrivied and user is correctly notified\", () => {\n+    describe(\"Suite of tests related to fetchCopybook\", () => {\n+        it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n+            const zoweApi: any = {\n+                listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n+            };\n+            const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n+            expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+    });\n+\n+    describe(\"Suite of tests related to handleCopybook\", () => {\n         const zoweApi: any = {\n             listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n         };\n         const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset show an error if copybook is not found\", async () => {\n-        const zoweError = new ZoweError(\"not found\", Type.NotFound);\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n-    });\n-    it(\"handleDataset show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+        it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+            expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+\n+        it(\"handleCopybook delete copybook from its internal queue if the copybook is a valid member on MF\", async () => {\n+            // simulate that the copybook required is a valid member name on MF\n+            (cbd as any).fetchCopybook = jest.fn().mockReturnValue(true);\n+\n+            // simulate that the a copybook not found is already defined in a queue\n+            const errorQueue: Set<string> = new Set();\n+            errorQueue.add(\"copybook\");\n+\n+            await (cbd as any).handleCopybook(\"DSNAME1\", copybookProfile, errorQueue);\n+\n+            // after the analysis - since the item in the queue is a valid member on MF it should be removed from the\n+            // error queue\n+            expect(errorQueue.size).toBe(0);\n+        });\n+\n     });\n-    it(\"handleQueue show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+    describe(\"Suite of tests related to handleDataset\", () => {\n+\n+        it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n+        });\n+        it(\"handleDataset show an error if copybook is not found\", async () => {\n+            const zoweError = new ZoweError(\"not found\", Type.NotFound);\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n+        });\n+        it(\"handleDataset show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n     });\n-    it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+\n+    describe(\"Suite of tests related to handleQueue\", () => {\n+        it(\"handleQueue show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n+        it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+        });\n+        it(\"handleQueue handle Connection refused ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+        });\n+        it(\"handleQueue handle No password ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.NoPassword));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"No password in Zowe profile zoweProfile.\");\n+        });\n     });\n-    it(\"handleQueue handle Connection refused ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+});\n+\n+describe(\"Test the creation of folders that contains copybooks downloaded from MF against correct configuration in settings provided by the user\", () => {\n+    function setupScenario() {\n+        const testFolder = path.join(__dirname, C4Z_FOLDER, COPYBOOKS_FOLDER, \"profile\", \"dataset\");\n+        const copybookURIPath = path.join(testFolder, \"copybook\" + \".cpy\");\n+        const zoweApi = new ZoweApi();\n+        const copybooksDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, zoweApi, undefined, undefined);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTcxNA=="}, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 260}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDI5MjAwOnYy", "diffSide": "RIGHT", "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoxOTowM1rOGhCxFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoyNDowM1rOGhC7iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMTUyNw==", "bodyText": "we can remove these comments, method has good naming", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437301527", "createdAt": "2020-06-09T10:19:03Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "diffHunk": "@@ -12,119 +12,207 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n+import * as fs from \"fs-extra\";\n+import * as path from \"path\";\n import * as vscode from \"vscode\";\n+import {C4Z_FOLDER, COPYBOOKS_FOLDER} from \"../constants\";\n import {CopybookDownloadService} from \"../services/CopybookDownloadService\";\n-import {CopybooksPathGenerator} from \"../services/CopybooksPathGenerator\";\n+import {CopybookFix} from \"../services/CopybookFix\";\n+import {CopybooksPathGenerator, createCopybookPath, createDatasetPath} from \"../services/CopybooksPathGenerator\";\n import {CopybookProfile} from \"../services/DownloadQueue\";\n+import {ProfileService} from \"../services/ProfileService\";\n+import {ZoweApi} from \"../services/ZoweApi\";\n import {Type, ZoweError} from \"../services/ZoweError\";\n \n-// tslint:disable: no-unused-expression no-string-literal\n-describe(\"Copybook downloader\", () => {\n-    vscode.workspace.workspaceFolders = [{} as any];\n-    vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n-    const profile = \"zoweProfile\";\n-    const copybookProfile = new CopybookProfile(\"copybook\", profile);\n-    const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n-    it(\"Can download copybook\", async () => {\n-        /* WORK IN PROGRESS\n-                const zoweApi: any = {\n-                    listZOSMFProfiles: jest.fn().mockReturnValue([\"Something\"]),\n-                };\n-                const profileService: any = {\n-                    getProfile: jest.fn().mockReturnValue(profile),\n-                };\n-                const cbd: CopybooksDownloader = new CopybooksDownloader(zoweApi, profileService);\n-                const uri: any = {};\n-                (cbd as any).listMissingCopybooks = () => [\"COPYBVOOK\"];\n-                try {\n-                    await cbd.downloadDependencies(uri);\n-                    cbd.start();\n-                } finally {\n-                    cbd.dispose();\n-                }\n-\n-                expect(zoweApi.listZOSMFProfiles).toBeCalled();\n-        */\n+vscode.workspace.workspaceFolders = [{} as any];\n+vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n+const profile = \"zoweProfile\";\n+const copybookProfile = new CopybookProfile(\"copybook\", profile);\n+const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n+const copybookFix: CopybookFix = new CopybookFix();\n \n+describe(\"Test fetchCopybook against bad and correct configurations\", () => {\n+    let zoweApi: ZoweApi;\n+    let copybookDownloadService: CopybookDownloadService;\n+\n+    beforeAll(() => {\n+        zoweApi = new ZoweApi();\n+        copybookDownloadService = new CopybookDownloadService(copybookFix, zoweApi, null, null);\n     });\n-    it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n-        const zoweApi: any = {\n-            listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n-        };\n-        const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+\n+    test(\"Given a copybook name that is not a valid member on MF, the copybook is not downloaded\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"ANTHMEM\");\n+\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(false);\n+    });\n+\n+    test(\"Given a copybook name but a wrong instance of profile, the copybook is not downloaded and exception is thrown\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        copybookFix.processDownloadError = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", undefined);\n+        expect(result).toBe(false);\n     });\n-    it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+\n+    test(\"Given a copybook name that is a valid member on MF, the fetchCopybook correctly invoke download from MF\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        (copybookDownloadService as any).downloadCopybookFromMFUsingZowe = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(true);\n+    });\n+});\n+describe(\"Receiving an error from zowe api layer, copybooks are not retrivied and user is correctly notified\", () => {\n+    describe(\"Suite of tests related to fetchCopybook\", () => {\n+        it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n+            const zoweApi: any = {\n+                listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n+            };\n+            const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n+            expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+    });\n+\n+    describe(\"Suite of tests related to handleCopybook\", () => {\n         const zoweApi: any = {\n             listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n         };\n         const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset show an error if copybook is not found\", async () => {\n-        const zoweError = new ZoweError(\"not found\", Type.NotFound);\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n-    });\n-    it(\"handleDataset show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+        it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+            expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+\n+        it(\"handleCopybook delete copybook from its internal queue if the copybook is a valid member on MF\", async () => {\n+            // simulate that the copybook required is a valid member name on MF\n+            (cbd as any).fetchCopybook = jest.fn().mockReturnValue(true);\n+\n+            // simulate that the a copybook not found is already defined in a queue\n+            const errorQueue: Set<string> = new Set();\n+            errorQueue.add(\"copybook\");\n+\n+            await (cbd as any).handleCopybook(\"DSNAME1\", copybookProfile, errorQueue);\n+\n+            // after the analysis - since the item in the queue is a valid member on MF it should be removed from the\n+            // error queue\n+            expect(errorQueue.size).toBe(0);\n+        });\n+\n     });\n-    it(\"handleQueue show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+    describe(\"Suite of tests related to handleDataset\", () => {\n+\n+        it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n+        });\n+        it(\"handleDataset show an error if copybook is not found\", async () => {\n+            const zoweError = new ZoweError(\"not found\", Type.NotFound);\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n+        });\n+        it(\"handleDataset show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n     });\n-    it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+\n+    describe(\"Suite of tests related to handleQueue\", () => {\n+        it(\"handleQueue show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n+        it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+        });\n+        it(\"handleQueue handle Connection refused ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+        });\n+        it(\"handleQueue handle No password ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.NoPassword));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"No password in Zowe profile zoweProfile.\");\n+        });\n     });\n-    it(\"handleQueue handle Connection refused ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+});\n+\n+describe(\"Test the creation of folders that contains copybooks downloaded from MF against correct configuration in settings provided by the user\", () => {\n+    function setupScenario() {\n+        const testFolder = path.join(__dirname, C4Z_FOLDER, COPYBOOKS_FOLDER, \"profile\", \"dataset\");\n+        const copybookURIPath = path.join(testFolder, \"copybook\" + \".cpy\");\n+        const zoweApi = new ZoweApi();\n+        const copybooksDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, zoweApi, undefined, undefined);\n+\n+        zoweApi.fetchMember = jest.fn().mockReturnValue(\"\");\n+        (createCopybookPath as any) = jest.fn().mockReturnValue(copybookURIPath);\n+        (createDatasetPath as any) = jest.fn().mockReturnValue(testFolder);\n+        return {copybookURIPath, copybooksDownloadService};\n+    }\n+\n+    function cleanupScenario() {\n+        fs.remove(path.join(__dirname, C4Z_FOLDER));\n+    }\n+\n+    test(\"With a valid configuration of dataset, copybook is created on FS\", async () => {\n+        const {copybookURIPath, copybooksDownloadService} = setupScenario();\n+        await (copybooksDownloadService as any).downloadCopybookFromMFUsingZowe(\"dataset\", \"copybook\", \"profile\");\n+        expect(fs.existsSync(copybookURIPath)).toBe(true);\n+\n+        // remove folder and file created to run the scenario", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 277}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwNDIwMA==", "bodyText": "sure!", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/382#discussion_r437304200", "createdAt": "2020-06-09T10:24:03Z", "author": {"login": "zacanbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/CopybookDownloadServiceTest.ts", "diffHunk": "@@ -12,119 +12,207 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n+import * as fs from \"fs-extra\";\n+import * as path from \"path\";\n import * as vscode from \"vscode\";\n+import {C4Z_FOLDER, COPYBOOKS_FOLDER} from \"../constants\";\n import {CopybookDownloadService} from \"../services/CopybookDownloadService\";\n-import {CopybooksPathGenerator} from \"../services/CopybooksPathGenerator\";\n+import {CopybookFix} from \"../services/CopybookFix\";\n+import {CopybooksPathGenerator, createCopybookPath, createDatasetPath} from \"../services/CopybooksPathGenerator\";\n import {CopybookProfile} from \"../services/DownloadQueue\";\n+import {ProfileService} from \"../services/ProfileService\";\n+import {ZoweApi} from \"../services/ZoweApi\";\n import {Type, ZoweError} from \"../services/ZoweError\";\n \n-// tslint:disable: no-unused-expression no-string-literal\n-describe(\"Copybook downloader\", () => {\n-    vscode.workspace.workspaceFolders = [{} as any];\n-    vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n-    const profile = \"zoweProfile\";\n-    const copybookProfile = new CopybookProfile(\"copybook\", profile);\n-    const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n-    it(\"Can download copybook\", async () => {\n-        /* WORK IN PROGRESS\n-                const zoweApi: any = {\n-                    listZOSMFProfiles: jest.fn().mockReturnValue([\"Something\"]),\n-                };\n-                const profileService: any = {\n-                    getProfile: jest.fn().mockReturnValue(profile),\n-                };\n-                const cbd: CopybooksDownloader = new CopybooksDownloader(zoweApi, profileService);\n-                const uri: any = {};\n-                (cbd as any).listMissingCopybooks = () => [\"COPYBVOOK\"];\n-                try {\n-                    await cbd.downloadDependencies(uri);\n-                    cbd.start();\n-                } finally {\n-                    cbd.dispose();\n-                }\n-\n-                expect(zoweApi.listZOSMFProfiles).toBeCalled();\n-        */\n+vscode.workspace.workspaceFolders = [{} as any];\n+vscode.window.showInformationMessage = () => Promise.resolve(\"Download Copybooks\");\n+const profile = \"zoweProfile\";\n+const copybookProfile = new CopybookProfile(\"copybook\", profile);\n+const zoweGeneralError = new ZoweError(\"zowe error\", Type.General);\n+const copybookFix: CopybookFix = new CopybookFix();\n \n+describe(\"Test fetchCopybook against bad and correct configurations\", () => {\n+    let zoweApi: ZoweApi;\n+    let copybookDownloadService: CopybookDownloadService;\n+\n+    beforeAll(() => {\n+        zoweApi = new ZoweApi();\n+        copybookDownloadService = new CopybookDownloadService(copybookFix, zoweApi, null, null);\n     });\n-    it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n-        const zoweApi: any = {\n-            listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n-        };\n-        const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+\n+    test(\"Given a copybook name that is not a valid member on MF, the copybook is not downloaded\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"ANTHMEM\");\n+\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(false);\n+    });\n+\n+    test(\"Given a copybook name but a wrong instance of profile, the copybook is not downloaded and exception is thrown\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        copybookFix.processDownloadError = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", undefined);\n+        expect(result).toBe(false);\n     });\n-    it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+\n+    test(\"Given a copybook name that is a valid member on MF, the fetchCopybook correctly invoke download from MF\", async () => {\n+        zoweApi.listMembers = jest.fn().mockReturnValue(\"copybook\");\n+        (copybookDownloadService as any).downloadCopybookFromMFUsingZowe = jest.fn();\n+        const result = await (copybookDownloadService as any).fetchCopybook(\"HLQ.DSN1\", copybookProfile);\n+        expect(result).toBe(true);\n+    });\n+});\n+describe(\"Receiving an error from zowe api layer, copybooks are not retrivied and user is correctly notified\", () => {\n+    describe(\"Suite of tests related to fetchCopybook\", () => {\n+        it(\"fetchCopybook rethrow ZoweError from zoweApi\", async () => {\n+            const zoweApi: any = {\n+                listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n+            };\n+            const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n+            expect((cbd as any).fetchCopybook(null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+    });\n+\n+    describe(\"Suite of tests related to handleCopybook\", () => {\n         const zoweApi: any = {\n             listMembers: jest.fn().mockRejectedValue(zoweGeneralError),\n         };\n         const cbd = new CopybookDownloadService(null, zoweApi, null, null);\n-        expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n-    });\n-    it(\"handleDataset show an error if copybook is not found\", async () => {\n-        const zoweError = new ZoweError(\"not found\", Type.NotFound);\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n-    });\n-    it(\"handleDataset show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const cbd = new CopybookDownloadService(null, null, null, null);\n-        (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        const toDownload = [copybookProfile];\n-        const progress = {report: jest.fn()};\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+        it(\"handleCopybook rethrow ZoweError from zoweApi\", async () => {\n+            expect((cbd as any).handleCopybook(null, null, null)).rejects.toEqual(zoweGeneralError);\n+        });\n+\n+        it(\"handleCopybook delete copybook from its internal queue if the copybook is a valid member on MF\", async () => {\n+            // simulate that the copybook required is a valid member name on MF\n+            (cbd as any).fetchCopybook = jest.fn().mockReturnValue(true);\n+\n+            // simulate that the a copybook not found is already defined in a queue\n+            const errorQueue: Set<string> = new Set();\n+            errorQueue.add(\"copybook\");\n+\n+            await (cbd as any).handleCopybook(\"DSNAME1\", copybookProfile, errorQueue);\n+\n+            // after the analysis - since the item in the queue is a valid member on MF it should be removed from the\n+            // error queue\n+            expect(errorQueue.size).toBe(0);\n+        });\n+\n     });\n-    it(\"handleQueue show an error for non ZoweError\", async () => {\n-        const errorMessage = \"The error\";\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+\n+    describe(\"Suite of tests related to handleDataset\", () => {\n+\n+        it(\"handleDataset rethow non NotFound ZoweErrors\", async () => {\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweGeneralError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            expect((cbd as any).handleDataset(null, toDownload, null, progress)).rejects.toEqual(zoweGeneralError);\n+        });\n+        it(\"handleDataset show an error if copybook is not found\", async () => {\n+            const zoweError = new ZoweError(\"not found\", Type.NotFound);\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(zoweError);\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Dataset DATA.SET not found.\");\n+        });\n+        it(\"handleDataset show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const cbd = new CopybookDownloadService(null, null, null, null);\n+            (cbd as any).handleCopybook = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            const toDownload = [copybookProfile];\n+            const progress = {report: jest.fn()};\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleDataset(\"DATA.SET\", toDownload, null, progress);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n     });\n-    it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+\n+    describe(\"Suite of tests related to handleQueue\", () => {\n+        it(\"handleQueue show an error for non ZoweError\", async () => {\n+            const errorMessage = \"The error\";\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new Error(errorMessage));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"Error: \" + errorMessage);\n+        });\n+        it(\"handleQueue handle Invalid credentials ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.InvalidCredentials));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Incorrect credentials in Zowe profile zoweProfile.\");\n+        });\n+        it(\"handleQueue handle Connection refused ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage)\n+                .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+        });\n+        it(\"handleQueue handle No password ZoweError\", async () => {\n+            const pathGenerator = new CopybooksPathGenerator(null);\n+            pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n+            const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n+            (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.NoPassword));\n+            vscode.window.showErrorMessage = jest.fn();\n+            await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n+            expect(vscode.window.showErrorMessage).toHaveBeenCalledWith(\"No password in Zowe profile zoweProfile.\");\n+        });\n     });\n-    it(\"handleQueue handle Connection refused ZoweError\", async () => {\n-        const pathGenerator = new CopybooksPathGenerator(null);\n-        pathGenerator.listDatasets = jest.fn().mockResolvedValue([\"dataset\"]);\n-        const cbd = new CopybookDownloadService(null, null, null, pathGenerator);\n-        (cbd as any).handleDataset = jest.fn().mockRejectedValue(new ZoweError(\"\", Type.ConnRefused));\n-        vscode.window.showErrorMessage = jest.fn();\n-        await (cbd as any).handleQueue(copybookProfile, new Set(), null);\n-        expect(vscode.window.showErrorMessage)\n-            .toHaveBeenCalledWith(\"Connection to mainframe using Zowe profile zoweProfile failed.\");\n+});\n+\n+describe(\"Test the creation of folders that contains copybooks downloaded from MF against correct configuration in settings provided by the user\", () => {\n+    function setupScenario() {\n+        const testFolder = path.join(__dirname, C4Z_FOLDER, COPYBOOKS_FOLDER, \"profile\", \"dataset\");\n+        const copybookURIPath = path.join(testFolder, \"copybook\" + \".cpy\");\n+        const zoweApi = new ZoweApi();\n+        const copybooksDownloadService: CopybookDownloadService = new CopybookDownloadService(undefined, zoweApi, undefined, undefined);\n+\n+        zoweApi.fetchMember = jest.fn().mockReturnValue(\"\");\n+        (createCopybookPath as any) = jest.fn().mockReturnValue(copybookURIPath);\n+        (createDatasetPath as any) = jest.fn().mockReturnValue(testFolder);\n+        return {copybookURIPath, copybooksDownloadService};\n+    }\n+\n+    function cleanupScenario() {\n+        fs.remove(path.join(__dirname, C4Z_FOLDER));\n+    }\n+\n+    test(\"With a valid configuration of dataset, copybook is created on FS\", async () => {\n+        const {copybookURIPath, copybooksDownloadService} = setupScenario();\n+        await (copybooksDownloadService as any).downloadCopybookFromMFUsingZowe(\"dataset\", \"copybook\", \"profile\");\n+        expect(fs.existsSync(copybookURIPath)).toBe(true);\n+\n+        // remove folder and file created to run the scenario", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMTUyNw=="}, "originalCommit": {"oid": "9a8aa0cf35db8c2660ef8abfa8500c3b62d1c84a"}, "originalPosition": 277}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4054, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}