{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDc4NTg1", "number": 379, "title": "test: Add ZoweApi unit tests for client", "bodyText": "Signed-off-by: Anton Grigorev anton.grigorev@broadcom.com", "createdAt": "2020-06-05T14:16:21Z", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379", "merged": true, "mergeCommit": {"oid": "a979a0085a0bcaddf7d0e1aef4c02b4b7ccd9e4a"}, "closed": true, "closedAt": "2020-06-09T07:28:42Z", "author": {"login": "grianbrcom"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpNUdAgFqTQyNjA3MjgzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpf7AUgFqTQyNjg1ODkzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDcyODMw", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426072830", "createdAt": "2020-06-08T09:48:05Z", "commit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDkyNDE1", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426092415", "createdAt": "2020-06-08T10:15:40Z", "commit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDoxNTo0MVrOGgXgwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMDoxNTo0MVrOGgXgwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU5MjgzNA==", "bodyText": "Optional: did you consider to have a setup() and tearDown() to initialize and rollback the env variable?\nSince seems important to restore the env var at the end of the test I prefer to have it in a method to avoid any problem if in the future we'll refactor this test and accidentally remove the finally clause.", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#discussion_r436592834", "createdAt": "2020-06-08T10:15:41Z", "author": {"login": "zacanbrcom"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/ZoweApiTest.ts", "diffHunk": "@@ -12,25 +12,131 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n-import { BasicProfileManager, Session } from \"@zowe/imperative\";\n+import { RestClient } from \"@zowe/imperative\";\n+import { Session } from \"inspector\";\n+import { homedir } from \"os\";\n+import * as path from \"path\";\n import { ZoweApi } from \"../services/ZoweApi\";\n import { Type, ZoweError } from \"../services/ZoweError\";\n-jest.mock(\"@zowe/imperative\");\n+\n+const loadMock = jest.fn();\n+const loadAllMock = jest.fn();\n+jest.mock(\"@zowe/imperative/lib/profiles/src/BasicProfileManager\", () => {\n+    return {\n+        BasicProfileManager: jest.fn().mockImplementation(() => {\n+            return {\n+                load: loadMock,\n+                loadAll: loadAllMock,\n+                getDefaultProfileName: () => \"defaultName\",\n+            };\n+        }),\n+    };\n+});\n \n beforeEach(() => {\n-    (BasicProfileManager as any).mockClear();\n+    loadMock.mockClear();\n+    loadAllMock.mockClear();\n });\n \n describe(\"ZoweApi\", () => {\n+    it(\"listZOSMFProfiles returns map of founded profiles\", async () => {\n+        const profile = {\n+            name: \"foo\",\n+            password: \"bar\",\n+        };\n+        const profileFound = {\n+            name: \"profileName\",\n+            failNotFound: true,\n+            profile: profile,\n+        };\n+        const profileNotFound = {\n+            name: \"wrongName\",\n+            failNotFound: false,\n+        };\n+        loadAllMock.mockResolvedValue([profileFound, profileNotFound]);\n+        const zoweApi = new ZoweApi();\n+        const expectedMap = {\n+            profileName: profile,\n+        };\n+        await expect(zoweApi.listZOSMFProfiles()).resolves.toEqual(expectedMap);\n+        expect(loadAllMock).toBeCalledTimes(1);\n+    });\n+    it(\"getDefaultProfileName works as expected\", () => {\n+        const zoweApi = new ZoweApi();\n+        expect(zoweApi.getDefaultProfileName()).toBe(\"defaultName\");\n+    });\n+    it(\"fetchMember call RestClient with right path\", async () => {\n+        const getExpectStringMock = jest.fn().mockResolvedValue(\"content\");\n+        RestClient.getExpectString = getExpectStringMock;\n+        const zoweApi = new ZoweApi();\n+        const createSessionMock = jest.fn().mockResolvedValue(new Session());\n+        zoweApi.createSession = createSessionMock;\n+        await expect(zoweApi.fetchMember(\"dataSet\", \"theMember\", \"profile\")).resolves.toEqual(\"content\");\n+        expect(getExpectStringMock).toBeCalledTimes(1);\n+        expect(getExpectStringMock.mock.calls[0][1]).toBe(\"/zosmf/restfiles/ds/dataSet(theMember)\");\n+        expect(createSessionMock).toBeCalledWith(\"profile\");\n+    });\n+    it(\"listMember call RestClient with right path\", async () => {\n+        const getExpectJsonMock = jest.fn().mockResolvedValue({\n+            items: [\n+                {member: \"member1\"},\n+                {member: \"member2\"},\n+            ],\n+        });\n+        RestClient.getExpectJSON = getExpectJsonMock;\n+        const zoweApi = new ZoweApi();\n+        const createSessionMock = jest.fn().mockResolvedValue(new Session());\n+        zoweApi.createSession = createSessionMock;\n+        await expect(zoweApi.listMembers(\"dataSet\", \"profile\")).resolves.toStrictEqual([\"member1\", \"member2\"]);\n+        expect(createSessionMock).toBeCalledWith(\"profile\");\n+        expect(getExpectJsonMock).toBeCalledTimes(1);\n+        expect(getExpectJsonMock.mock.calls[0][1]).toBe(\"/zosmf/restfiles/ds/dataSet/member\")\n+    });\n     it(\"throw No Password error if profile don't have a password\", async () => {\n-        (BasicProfileManager as any).load = jest.fn().mockResolvedValue({profile: {password: \"\"}});\n+        loadMock.mockResolvedValue({profile: {password: \"\"}});\n         const zoweApi = new ZoweApi();\n         const expectedError = new ZoweError(\"No password\", Type.NoPassword);\n-        expect(zoweApi.createSession(\"zoweProfile\")).rejects.toEqual(expectedError);\n+        await expect(zoweApi.createSession(\"zoweProfile\")).rejects.toEqual(expectedError);\n+        expect(loadMock).toBeCalledWith({name: \"zoweProfile\"});\n     });\n     it(\"createSession works fine if password is set\", async () => {\n-        (BasicProfileManager as any).load = jest.fn().mockResolvedValue({profile: {password: \"secret\"}});\n+        loadMock.mockResolvedValue({profile: {password: \"secret\", host: \"theHost\"}});\n+        const zoweApi = new ZoweApi();\n+        const expectedSession = {\n+            hostname: \"theHost\",\n+            password: \"secret\",\n+            type: \"basic\",\n+        };\n+        expect(zoweApi.createSession(\"zoweProfile\")).resolves.toEqual({ISession: expectedSession});\n+        expect(loadMock).toBeCalledWith({name: \"zoweProfile\"});\n+    });\n+    it(\"Creates profile params with ZOWE_CLI_HOME env variable\", () => {\n+        const OLD_ZOWE_CLI_HOME = process.env.ZOWE_CLI_HOME;\n+        process.env.ZOWE_CLI_HOME = \"zoweHome\";\n+        const zoweApi = new ZoweApi();\n+        const expectedParams = {\n+            profileRootDirectory: path.join(\"zoweHome\", \"profiles\"),\n+            type: \"zosmf\",\n+        };\n+        try {\n+            expect((zoweApi as any).createProfileParams()).toEqual(expectedParams)\n+        } finally {\n+            process.env.ZOWE_CLI_HOME = OLD_ZOWE_CLI_HOME;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDk1NjIx", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426095621", "createdAt": "2020-06-08T10:20:25Z", "commit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTUwMTk3", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426150197", "createdAt": "2020-06-08T11:48:22Z", "commit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjEzNTU5", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426213559", "createdAt": "2020-06-08T13:05:42Z", "commit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzowNTo0MlrOGgc0pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzowNzoyNlrOGgc60g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3OTg0NQ==", "bodyText": "jest.clearAllMocks()   can be used instead of all", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#discussion_r436679845", "createdAt": "2020-06-08T13:05:42Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/ZoweApiTest.ts", "diffHunk": "@@ -12,25 +12,131 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n-import { BasicProfileManager, Session } from \"@zowe/imperative\";\n+import { RestClient } from \"@zowe/imperative\";\n+import { Session } from \"inspector\";\n+import { homedir } from \"os\";\n+import * as path from \"path\";\n import { ZoweApi } from \"../services/ZoweApi\";\n import { Type, ZoweError } from \"../services/ZoweError\";\n-jest.mock(\"@zowe/imperative\");\n+\n+const loadMock = jest.fn();\n+const loadAllMock = jest.fn();\n+jest.mock(\"@zowe/imperative/lib/profiles/src/BasicProfileManager\", () => {\n+    return {\n+        BasicProfileManager: jest.fn().mockImplementation(() => {\n+            return {\n+                load: loadMock,\n+                loadAll: loadAllMock,\n+                getDefaultProfileName: () => \"defaultName\",\n+            };\n+        }),\n+    };\n+});\n \n beforeEach(() => {\n-    (BasicProfileManager as any).mockClear();\n+    loadMock.mockClear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY4MTQyNg==", "bodyText": "const zoweApi can reused to get out the duplication, via initializing it in beforeEach", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#discussion_r436681426", "createdAt": "2020-06-08T13:07:26Z", "author": {"login": "asatklichov"}, "path": "clients/cobol-lsp-vscode-extension/src/__tests__/ZoweApiTest.ts", "diffHunk": "@@ -12,25 +12,131 @@\n  *   Broadcom, Inc. - initial API and implementation\n  */\n \n-import { BasicProfileManager, Session } from \"@zowe/imperative\";\n+import { RestClient } from \"@zowe/imperative\";\n+import { Session } from \"inspector\";\n+import { homedir } from \"os\";\n+import * as path from \"path\";\n import { ZoweApi } from \"../services/ZoweApi\";\n import { Type, ZoweError } from \"../services/ZoweError\";\n-jest.mock(\"@zowe/imperative\");\n+\n+const loadMock = jest.fn();\n+const loadAllMock = jest.fn();\n+jest.mock(\"@zowe/imperative/lib/profiles/src/BasicProfileManager\", () => {\n+    return {\n+        BasicProfileManager: jest.fn().mockImplementation(() => {\n+            return {\n+                load: loadMock,\n+                loadAll: loadAllMock,\n+                getDefaultProfileName: () => \"defaultName\",\n+            };\n+        }),\n+    };\n+});\n \n beforeEach(() => {\n-    (BasicProfileManager as any).mockClear();\n+    loadMock.mockClear();\n+    loadAllMock.mockClear();\n });\n \n describe(\"ZoweApi\", () => {\n+    it(\"listZOSMFProfiles returns map of founded profiles\", async () => {\n+        const profile = {\n+            name: \"foo\",\n+            password: \"bar\",\n+        };\n+        const profileFound = {\n+            name: \"profileName\",\n+            failNotFound: true,\n+            profile: profile,\n+        };\n+        const profileNotFound = {\n+            name: \"wrongName\",\n+            failNotFound: false,\n+        };\n+        loadAllMock.mockResolvedValue([profileFound, profileNotFound]);\n+        const zoweApi = new ZoweApi();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9a49a492109c0330cbe590164ec02acb86238da", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/a9a49a492109c0330cbe590164ec02acb86238da", "committedDate": "2020-06-08T14:55:15Z", "message": "test: Add ZoweApi unit tests for client\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7eebffe9d4252e9a8cc27977eccefbecdffaafaa", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/7eebffe9d4252e9a8cc27977eccefbecdffaafaa", "committedDate": "2020-06-05T14:11:14Z", "message": "test: Add ZoweApi unit tests for client\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}, "afterCommit": {"oid": "a9a49a492109c0330cbe590164ec02acb86238da", "author": {"user": {"login": "grianbrcom", "name": "Anton Grigorev"}}, "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/commit/a9a49a492109c0330cbe590164ec02acb86238da", "committedDate": "2020-06-08T14:55:15Z", "message": "test: Add ZoweApi unit tests for client\n\nSigned-off-by: Anton Grigorev <anton.grigorev@broadcom.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODQ5NzU1", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426849755", "createdAt": "2020-06-09T07:15:06Z", "commit": {"oid": "a9a49a492109c0330cbe590164ec02acb86238da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODU4OTM3", "url": "https://github.com/eclipse/che-che4z-lsp-for-cobol/pull/379#pullrequestreview-426858937", "createdAt": "2020-06-09T07:28:29Z", "commit": {"oid": "a9a49a492109c0330cbe590164ec02acb86238da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1125, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}