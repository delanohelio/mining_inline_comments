{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NjY2ODE4", "number": 506, "title": "Refactor salt from compliance config into Salt class", "bodyText": "Changes:\n\nRemoving salt from ComplianceConfig as it is not reloaded as part of it. Enabling/Disabling compliance for audit logging should not change the field anonymization behavior.\nRefactored the salt usage into a separate FLS configuration class (inner class of DlsFlsConfig which could store other DlsFls configurations)\nMoved all the associated tests.\nOpenDistroSecurityFlsDlsIndexSearcherWrapper was called per index, so the config had to be injected down from top level into DlsFlsFilterLeafReader (where its being used) to avoid being created everytime", "createdAt": "2020-06-15T17:09:59Z", "url": "https://github.com/opensearch-project/security/pull/506", "merged": true, "mergeCommit": {"oid": "2dbf4e00c17a64dd4bee7a7ac1dd5cc67907aacb"}, "closed": true, "closedAt": "2020-06-24T23:03:02Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct-EZ8AFqTQzNTQzMjM0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuiOYqgFqTQzNzA2MjA1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDMyMzQx", "url": "https://github.com/opensearch-project/security/pull/506#pullrequestreview-435432341", "createdAt": "2020-06-23T04:33:48Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNDozMzo0OVrOGnY5aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNDo1MToyOFrOGnZJvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk1NTU2Mw==", "bodyText": "nit: pass Salt to MaskedFieldsMap.extractMaskedFields and add private final Salt salt to MaskedFieldsMap.", "url": "https://github.com/opensearch-project/security/pull/506#discussion_r443955563", "createdAt": "2020-06-23T04:33:49Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/DlsFlsFilterLeafReader.java", "diffHunk": "@@ -106,23 +106,25 @@\n     private final MaskedFieldsMap maskedFieldsMap;\n     private final ShardId shardId;\n     private final boolean maskFields;\n+    private final Salt salt;\n \n     private DlsGetEvaluator dge = null;\n \n \n     DlsFlsFilterLeafReader(final LeafReader delegate, final Set<String> includesExcludes,\n                            final Query dlsQuery, final IndexService indexService, final ThreadContext threadContext,\n                            final ClusterService clusterService,\n-                           final AuditLog auditlog, final Set<String> maskedFields, final ShardId shardId) {\n+                           final AuditLog auditlog, final Set<String> maskedFields, final ShardId shardId, final Salt salt) {\n         super(delegate);\n \n-        maskFields = (auditlog.getComplianceConfig().isEnabled() && maskedFields != null && maskedFields.size() > 0);\n+        maskFields = (maskedFields != null && maskedFields.size() > 0);\n \n         this.indexService = indexService;\n         this.threadContext = threadContext;\n         this.clusterService = clusterService;\n         this.auditlog = auditlog;\n-        this.maskedFieldsMap = MaskedFieldsMap.extractMaskedFields(maskFields, maskedFields, auditlog.getComplianceConfig().getSalt16());\n+        this.salt = salt;\n+        this.maskedFieldsMap = MaskedFieldsMap.extractMaskedFields(maskFields, maskedFields, this.salt.getSalt16());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk1OTU5OQ==", "bodyText": "I don't think it is necessary to limit copyright for this file", "url": "https://github.com/opensearch-project/security/pull/506#discussion_r443959599", "createdAt": "2020-06-23T04:50:59Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/Salt.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Portions Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk1OTc0Mw==", "bodyText": "Add copyright", "url": "https://github.com/opensearch-project/security/pull/506#discussion_r443959743", "createdAt": "2020-06-23T04:51:28Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/configuration/SaltTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistroforelasticsearch.security.configuration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTcyNDU2", "url": "https://github.com/opensearch-project/security/pull/506#pullrequestreview-436172456", "createdAt": "2020-06-23T21:30:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTozMDowOFrOGn7Vqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTozMDowOFrOGn7Vqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxOTg1MA==", "bodyText": "Is the similar check on line 1099 necessary? If it is removed here, should it be also removed in getRuntimeMaskedFieldInfo()?", "url": "https://github.com/opensearch-project/security/pull/506#discussion_r444519850", "createdAt": "2020-06-23T21:30:08Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/DlsFlsFilterLeafReader.java", "diffHunk": "@@ -106,23 +106,25 @@\n     private final MaskedFieldsMap maskedFieldsMap;\n     private final ShardId shardId;\n     private final boolean maskFields;\n+    private final Salt salt;\n \n     private DlsGetEvaluator dge = null;\n \n \n     DlsFlsFilterLeafReader(final LeafReader delegate, final Set<String> includesExcludes,\n                            final Query dlsQuery, final IndexService indexService, final ThreadContext threadContext,\n                            final ClusterService clusterService,\n-                           final AuditLog auditlog, final Set<String> maskedFields, final ShardId shardId) {\n+                           final AuditLog auditlog, final Set<String> maskedFields, final ShardId shardId, final Salt salt) {\n         super(delegate);\n \n-        maskFields = (auditlog.getComplianceConfig().isEnabled() && maskedFields != null && maskedFields.size() > 0);\n+        maskFields = (maskedFields != null && maskedFields.size() > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTc2OTQ1", "url": "https://github.com/opensearch-project/security/pull/506#pullrequestreview-436176945", "createdAt": "2020-06-23T21:38:07Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e995508dae323c5fdf8f80ad344ff08a6bcecf7d", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/e995508dae323c5fdf8f80ad344ff08a6bcecf7d", "committedDate": "2020-06-23T22:06:53Z", "message": "Refactor salt from compliance config into salt class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTkzNTAy", "url": "https://github.com/opensearch-project/security/pull/506#pullrequestreview-436193502", "createdAt": "2020-06-23T22:09:30Z", "commit": {"oid": "e995508dae323c5fdf8f80ad344ff08a6bcecf7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDYyMDU2", "url": "https://github.com/opensearch-project/security/pull/506#pullrequestreview-437062056", "createdAt": "2020-06-24T22:59:05Z", "commit": {"oid": "e995508dae323c5fdf8f80ad344ff08a6bcecf7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2959, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}