{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0OTcxNjMw", "number": 850, "title": "Adding requested tenant to the thread context transient info for consumption", "bodyText": "Issue #, if available:\nDescription of changes:\nAdding requested tenant to the thread context transient info for consumption\nWhy this change is required?\nWhen transport action is invoked, thread context has information related to user and roles. this change adds tenant along with user and roles to consume by plugins. This helps plugin getting user requested tenant for its operation (like filing data based on tenant) without making another \"authinfo\" call.\nTests:\nmvn test tested on 7.9.1.\nValidated that the common-utils:User.parse() does not break with this change\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-20T21:52:31Z", "url": "https://github.com/opensearch-project/security/pull/850", "merged": true, "mergeCommit": {"oid": "7131b6a7ed2716697d7425ed441dcb7484f0b4ef"}, "closed": true, "closedAt": "2020-12-01T23:42:35Z", "author": {"login": "akbhatta"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeewU3AFqTUzNTgwNzg1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiCuiTAFqTU0MjM4Nzk4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODA3ODU2", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-535807856", "createdAt": "2020-11-20T22:04:53Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjowNDo1M1rOH3iS8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjowNDo1M1rOH3iS8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg==", "bodyText": "thanks @akbhatta . Could you pls add an overloaded method instead of changing existing method to main backward compatibility ? something like  getUserRolesTenantString", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r527995632", "createdAt": "2020-11-20T22:04:53Z", "author": {"login": "skkosuri-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -265,6 +265,9 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     }\n \n     public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+        return name + \"|\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODE1MTI5", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-535815129", "createdAt": "2020-11-20T22:20:07Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODE3OTcz", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-535817973", "createdAt": "2020-11-20T22:26:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoyNjozM1rOH3iywA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoyNjozM1rOH3iywA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMzc3Ng==", "bodyText": "renamed. keeping \"user_and_roles\" same for compatibility.", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r528003776", "createdAt": "2020-11-20T22:26:33Z", "author": {"login": "akbhatta"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -265,6 +265,9 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     }\n \n     public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+        return name + \"|\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5NTYzMg=="}, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjA3NjI4", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-541207628", "createdAt": "2020-11-30T19:05:42Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDA0NjQ4", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-541404648", "createdAt": "2020-12-01T00:39:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDozOTozOFrOH8Th4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDozOTozOFrOH8Th4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5NjU3Ng==", "bodyText": "Can requestedTenant be null? Will it be better to skip requestedTenant if it is not set?", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r532996576", "createdAt": "2020-12-01T00:39:38Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -264,7 +264,10 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n \n-    public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+    public final String getUserRolesTenantString() {\n+        return name + \"|\"\n+                + String.join(\",\", getRoles()) + \"|\"\n+                + String.join(\",\", getOpenDistroSecurityRoles()) + \"|\"\n+                + requestedTenant;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDEzMDg3", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-541413087", "createdAt": "2020-12-01T01:02:17Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMTowMjoxN1rOH8UAQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMTowMjoxN1rOH8UAQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwNDM1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final String tenantStringPart;\n          \n          \n            \n                    final ImmutableList.Builder<String> builder = ImmutableList.builder();\n          \n          \n            \n                    builder.add(name, String.join(\",\", getRoles()),  String.join(\",\", getOpenDistroSecurityRoles()));\n          \n          \n            \n                    if (!Strings.isNullOrEmpty(requestedTenant)) {\n          \n          \n            \n                        builder.add(requestedTenant);\n          \n          \n            \n                    }\n          \n          \n            \n                    return String.join(\"|\", builder.build());", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533004354", "createdAt": "2020-12-01T01:02:17Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -264,7 +264,16 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n \n-    public final String getUserRolesString() {\n-        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());\n+    public final String getUserRolesTenantString() {\n+        final String tenantStringPart;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDI2MDk2", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-541426096", "createdAt": "2020-12-01T01:38:32Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDMzODMw", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-541433830", "createdAt": "2020-12-01T02:00:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMjowMDo0MlrOH8VKiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMjowMDo0MlrOH8VKiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMzM2OQ==", "bodyText": "why we are not changing this to USER_ROLES_TENANT ?\nI know that it was failing UT but we should be able to fix that? and what backward compatibility you were mentioning in your previous comment?", "url": "https://github.com/opensearch-project/security/pull/850#discussion_r533023369", "createdAt": "2020-12-01T02:00:42Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -303,7 +303,7 @@ public int order() {\n             }\n \n             if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_AND_ROLES) == null) {\n-                threadContext.putTransient(OPENDISTRO_SECURITY_USER_AND_ROLES, user.getUserRolesString());\n+                threadContext.putTransient(OPENDISTRO_SECURITY_USER_AND_ROLES, user.getUserRolesTenantString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77089ce997f7035088a01a07254cb71da9907079", "author": {"user": {"login": "akbhatta", "name": "Anantha Krishna Bhatta"}}, "url": "https://github.com/opensearch-project/security/commit/77089ce997f7035088a01a07254cb71da9907079", "committedDate": "2020-12-01T22:02:51Z", "message": "Adding requested tenant to the thread context transient info for consumption\n\nValidated that the common-utils:User.parse() does not break with this change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzYzMzc0", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-542363374", "createdAt": "2020-12-01T22:51:18Z", "commit": {"oid": "77089ce997f7035088a01a07254cb71da9907079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzg3OTg3", "url": "https://github.com/opensearch-project/security/pull/850#pullrequestreview-542387987", "createdAt": "2020-12-01T23:41:18Z", "commit": {"oid": "77089ce997f7035088a01a07254cb71da9907079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2667, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}