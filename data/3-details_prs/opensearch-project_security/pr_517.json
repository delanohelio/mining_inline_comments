{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODcyMjc3", "number": 517, "title": "Remove the faulty index exists check and have more predictable behavior", "bodyText": "Issue #, if available:\nDescription of changes:\n\nclusterService.state().metaData().hasConcreteIndex(opendistrosecurityIndex) checks if index exists with a cached copy and it incorrectly determines index is absent especially when the cluster bootstraps.\nRemoved the above check as its incorrectly functioning.\nadded a try, catch around index creation to capture index/resource exists exception\nUpdated log statements\nSame behavior as we currently have\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-23T23:17:36Z", "url": "https://github.com/opensearch-project/security/pull/517", "merged": true, "mergeCommit": {"oid": "15e7d452ae198db63dda60c835f06e615c5c292c"}, "closed": true, "closedAt": "2020-06-29T20:36:40Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvLo_VgFqTQzODY0MDkzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwIeroAFqTQzOTUzMzk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQwOTMx", "url": "https://github.com/opensearch-project/security/pull/517#pullrequestreview-438640931", "createdAt": "2020-06-26T23:14:15Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzoxNDoxNVrOGpxBIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzoxNDoxNVrOGpxBIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NzkwNw==", "bodyText": "Is this try necessary?", "url": "https://github.com/opensearch-project/security/pull/517#discussion_r446447907", "createdAt": "2020-06-26T23:14:15Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java", "diffHunk": "@@ -126,30 +128,36 @@ public void run() {\n                                 final ThreadContext threadContext = threadPool.getThreadContext();\n                                 try(StoredContext ctx = threadContext.stashContext()) {\n                                     threadContext.putHeader(ConfigConstants.OPENDISTRO_SECURITY_CONF_REQUEST_HEADER, \"true\");\n-                                    LOGGER.info(\"Will create {} index so we can apply default config\", opendistrosecurityIndex);\n-\n-                                    Map<String, Object> indexSettings = new HashMap<>();\n-                                    indexSettings.put(\"index.number_of_shards\", 1);\n-                                    indexSettings.put(\"index.auto_expand_replicas\", \"0-all\");\n-\n-                                    boolean ok = client.admin().indices().create(new CreateIndexRequest(opendistrosecurityIndex)\n-                                            .settings(indexSettings))\n-                                            .actionGet().isAcknowledged();\n-                                    LOGGER.info(\"Index {} created?: {}\", opendistrosecurityIndex, ok);\n-                                    if(ok) {\n-                                        ConfigHelper.uploadFile(client, cd+\"config.yml\", opendistrosecurityIndex, CType.CONFIG, DEFAULT_CONFIG_VERSION);\n-                                        ConfigHelper.uploadFile(client, cd+\"roles.yml\", opendistrosecurityIndex, CType.ROLES, DEFAULT_CONFIG_VERSION);\n-                                        ConfigHelper.uploadFile(client, cd+\"roles_mapping.yml\", opendistrosecurityIndex, CType.ROLESMAPPING, DEFAULT_CONFIG_VERSION);\n-                                        ConfigHelper.uploadFile(client, cd+\"internal_users.yml\", opendistrosecurityIndex, CType.INTERNALUSERS, DEFAULT_CONFIG_VERSION);\n-                                        ConfigHelper.uploadFile(client, cd+\"action_groups.yml\", opendistrosecurityIndex, CType.ACTIONGROUPS, DEFAULT_CONFIG_VERSION);\n-                                        if(DEFAULT_CONFIG_VERSION == 2) {\n-                                            ConfigHelper.uploadFile(client, cd+\"tenants.yml\", opendistrosecurityIndex, CType.TENANTS, DEFAULT_CONFIG_VERSION);\n+\n+                                    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18187a0b0865d3c174ea30da69a59816f4cdb4cc", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/18187a0b0865d3c174ea30da69a59816f4cdb4cc", "committedDate": "2020-06-29T16:11:22Z", "message": "Remove the faulty index exists check and have more predictable behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzkyODQy", "url": "https://github.com/opensearch-project/security/pull/517#pullrequestreview-439392842", "createdAt": "2020-06-29T18:22:36Z", "commit": {"oid": "18187a0b0865d3c174ea30da69a59816f4cdb4cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDY5MDYy", "url": "https://github.com/opensearch-project/security/pull/517#pullrequestreview-439469062", "createdAt": "2020-06-29T20:18:25Z", "commit": {"oid": "18187a0b0865d3c174ea30da69a59816f4cdb4cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTMzOTU3", "url": "https://github.com/opensearch-project/security/pull/517#pullrequestreview-439533957", "createdAt": "2020-06-29T22:07:12Z", "commit": {"oid": "18187a0b0865d3c174ea30da69a59816f4cdb4cc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2794, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}