{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MzkxNDk2", "number": 333, "title": "Fix updating password hash without replacing the entry", "bodyText": "Bug:\n\nUpdating user hash was replacing the entire entry causing it to lose the roles attached to it directly from internal users api.\nNot returning bad request when both password and hash are not provided or empty", "createdAt": "2020-03-30T04:03:39Z", "url": "https://github.com/opensearch-project/security/pull/333", "merged": true, "mergeCommit": {"oid": "a09fcc47f1b0679d3fe0ec6fdb9adc8be5a073c2"}, "closed": true, "closedAt": "2020-03-31T18:11:21Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSmZdNgH2gAyMzk1MzkxNDk2OjUwZDZlNGIyYzRjNGZmMDkwZjkxZTg5NDhjMDZjYTFiM2M0ZmZmMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTG2ybgFqTM4NDk2NzkyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50d6e4b2c4c4ff090f91e8948c06ca1b3c4fff29", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/50d6e4b2c4c4ff090f91e8948c06ca1b3c4fff29", "committedDate": "2020-03-30T04:00:55Z", "message": "Fix updating password hash without replacing the entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/fd44054ee71acd3356b0c934c46e5fe1608e9113", "committedDate": "2020-03-30T05:02:46Z", "message": "Change test password"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDc2Nzc5", "url": "https://github.com/opensearch-project/security/pull/333#pullrequestreview-384076779", "createdAt": "2020-03-30T17:30:04Z", "commit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzozMDowNFrOF90hfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxODowNjowM1rOF9155w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM2Nzk5Ng==", "bodyText": "Should this be part of CredentialsValidator?", "url": "https://github.com/opensearch-project/security/pull/333#discussion_r400367996", "createdAt": "2020-03-30T17:30:04Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AccountValidator.java", "diffHunk": "@@ -27,5 +27,7 @@ public AccountValidator(RestRequest request, BytesReference ref, Settings esSett\n         super(request, ref, esSettings, param);\n         allowedKeys.put(\"current_password\", DataType.STRING);\n         mandatoryKeys.add(\"current_password\");\n+        mandatoryOrKeys.add(\"hash\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4Nzk5Mg==", "bodyText": "rename hash to currentHash to be consistent with currentPassword", "url": "https://github.com/opensearch-project/security/pull/333#discussion_r400387992", "createdAt": "2020-03-30T18:01:38Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AccountApiAction.java", "diffHunk": "@@ -197,32 +198,27 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n \n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(content);\n         final String currentPassword = content.get(\"current_password\").asText();\n-        final String hash = ((Hashed) internalUser.getCEntry(username)).getHash();\n+        final Hashed internalUserEntry = (Hashed) internalUser.getCEntry(username);\n+        final String hash = internalUserEntry.getHash();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4OTAxMg==", "bodyText": "// if password is set, it takes precedence over hash\n        final String password = securityJsonNode.get(\"password\").asString();\n        final String hash;\n        if (Strings.isNullOrEmpty(password)) {\n            hash = securityJsonNode.get(\"hash\").asString();\n        } else {\n            hash = hash(password.toCharArray());\n        }\n        if (Strings.isNullOrEmpty(hash)) {\n            badRequestResponse(channel, \"Both provided password and hash cannot be null/empty.\");\n            return;\n        }\n\n        internalUserEntry.setHash(hash);", "url": "https://github.com/opensearch-project/security/pull/333#discussion_r400389012", "createdAt": "2020-03-30T18:03:20Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AccountApiAction.java", "diffHunk": "@@ -197,32 +198,27 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n \n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(content);\n         final String currentPassword = content.get(\"current_password\").asText();\n-        final String hash = ((Hashed) internalUser.getCEntry(username)).getHash();\n+        final Hashed internalUserEntry = (Hashed) internalUser.getCEntry(username);\n+        final String hash = internalUserEntry.getHash();\n \n         if (hash == null || !OpenBSDBCrypt.checkPassword(hash, currentPassword.toCharArray())) {\n             badRequestResponse(channel, \"Could not validate your current password.\");\n             return;\n         }\n \n-        ObjectNode contentAsNode = (ObjectNode) content;\n-        contentAsNode.remove(\"current_password\");\n-\n         // if password is set, it takes precedence over hash\n-        final String plainTextPassword = securityJsonNode.get(\"password\").asString();\n-        final String origHash = securityJsonNode.get(\"hash\").asString();\n-        if (plainTextPassword != null && plainTextPassword.length() > 0) {\n-            contentAsNode.remove(\"password\");\n-            contentAsNode.put(\"hash\", hash(plainTextPassword.toCharArray()));\n-        } else if (origHash != null && origHash.length() > 0) {\n-            contentAsNode.remove(\"password\");\n-        } else if (plainTextPassword != null && plainTextPassword.isEmpty() && origHash == null) {\n-            contentAsNode.remove(\"password\");\n+        final String providedPassword = securityJsonNode.get(\"password\").asString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5MDYzMQ==", "bodyText": "test with empty hash?", "url": "https://github.com/opensearch-project/security/pull/333#discussion_r400390631", "createdAt": "2020-03-30T18:06:03Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AccountApiTest.java", "diffHunk": "@@ -94,6 +96,16 @@ public void testPutAccount() throws Exception {\n         response = rh.executePutRequest(ENDPOINT, payload, encodeBasicHeader(testUser, testPass));\n         assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n \n+        // test - bad request as hash/password is missing\n+        payload = \"{\\\"current_password\\\":\\\"\" + testPass + \"\\\"}\";\n+        response = rh.executePutRequest(ENDPOINT, payload, encodeBasicHeader(testUser, testPass));\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+\n+        // test - bad request as hash/password is empty", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd44054ee71acd3356b0c934c46e5fe1608e9113"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5f35e1c3854004e030c133d8cc30ed898893483", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/e5f35e1c3854004e030c133d8cc30ed898893483", "committedDate": "2020-03-30T18:26:55Z", "message": "Address code reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MjYyMzQ2", "url": "https://github.com/opensearch-project/security/pull/333#pullrequestreview-384262346", "createdAt": "2020-03-30T21:58:59Z", "commit": {"oid": "e5f35e1c3854004e030c133d8cc30ed898893483"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQ1ODky", "url": "https://github.com/opensearch-project/security/pull/333#pullrequestreview-384345892", "createdAt": "2020-03-31T01:36:21Z", "commit": {"oid": "e5f35e1c3854004e030c133d8cc30ed898893483"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozNjoyMVrOF-CM_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTozNjoyMVrOF-CM_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MjEyNg==", "bodyText": "Does this mean user always need to pass key \"hash\": \"\" even if user just want to pass string password or vice-versa ?", "url": "https://github.com/opensearch-project/security/pull/333#discussion_r400592126", "createdAt": "2020-03-31T01:36:21Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AccountValidator.java", "diffHunk": "@@ -27,5 +27,7 @@ public AccountValidator(RestRequest request, BytesReference ref, Settings esSett\n         super(request, ref, esSettings, param);\n         allowedKeys.put(\"current_password\", DataType.STRING);\n         mandatoryKeys.add(\"current_password\");\n+        mandatoryOrKeys.add(\"hash\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f35e1c3854004e030c133d8cc30ed898893483"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d71d0e8daa29914ea993876670cd4d569b8089", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/c4d71d0e8daa29914ea993876670cd4d569b8089", "committedDate": "2020-03-31T16:56:54Z", "message": "Remove mandatory or keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTU0MTMx", "url": "https://github.com/opensearch-project/security/pull/333#pullrequestreview-384954131", "createdAt": "2020-03-31T17:31:25Z", "commit": {"oid": "c4d71d0e8daa29914ea993876670cd4d569b8089"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTY3OTI3", "url": "https://github.com/opensearch-project/security/pull/333#pullrequestreview-384967927", "createdAt": "2020-03-31T17:49:55Z", "commit": {"oid": "c4d71d0e8daa29914ea993876670cd4d569b8089"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3041, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}