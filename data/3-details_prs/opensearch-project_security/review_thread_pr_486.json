{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODI0Nzcz", "number": 486, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozNzo0N1rOEEvSZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMToyMjo1OFrOEE5w6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDA0NTE4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozNzo0N1rOGijHNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozNzo0N1rOGijHNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4MDA1Mg==", "bodyText": "nit: move load() inside if (opendistroSecurityRoles != null)", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438880052", "createdAt": "2020-06-11T15:37:47Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDA0ODI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozODoxN1rOGijJJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozODoxN1rOGijJJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4MDU0OA==", "bodyText": "nit: avoid extra empty line", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438880548", "createdAt": "2020-06-11T15:38:17Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDA3MTY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo0Mjo0MFrOGijXwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNjoyODo0MVrOGilW5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDI4OA==", "bodyText": "read-only->reserved?", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438884288", "createdAt": "2020-06-11T15:42:40Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (isHidden(rolesConfiguration, role)) {\n+                    notFound(channel, \"Role '\"+role+\"' is not found.\");\n+                    return;\n+                }\n+\n+                if (isReserved(rolesConfiguration, role)) {\n+                    forbidden(channel, \"Role '\" + role + \"' is read-only.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxNjgzNg==", "bodyText": "Will update to reserved", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438916836", "createdAt": "2020-06-11T16:28:41Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (isHidden(rolesConfiguration, role)) {\n+                    notFound(channel, \"Role '\"+role+\"' is not found.\");\n+                    return;\n+                }\n+\n+                if (isReserved(rolesConfiguration, role)) {\n+                    forbidden(channel, \"Role '\" + role + \"' is read-only.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDI4OA=="}, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDA3NjAyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo0Mzo0MVrOGijaoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo0Mzo0MVrOGijaoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTAyNA==", "bodyText": "private final internalUsersConfiguration", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438885024", "createdAt": "2020-06-11T15:43:41Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -244,45 +245,54 @@ public void unregisterDCFListener(Object listener) {\n     \n     private static class InternalUsersModelV7 extends InternalUsersModel {\n         \n-        SecurityDynamicConfiguration<InternalUserV7> configuration;\n+        SecurityDynamicConfiguration<InternalUserV7> internalUserV7SecurityDynamicConfiguration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDA3NzYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo0NDowMlrOGijboA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo0NDowMlrOGijboA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTI4MA==", "bodyText": "private final rolesConfiguration", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438885280", "createdAt": "2020-06-11T15:44:02Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -244,45 +245,54 @@ public void unregisterDCFListener(Object listener) {\n     \n     private static class InternalUsersModelV7 extends InternalUsersModel {\n         \n-        SecurityDynamicConfiguration<InternalUserV7> configuration;\n+        SecurityDynamicConfiguration<InternalUserV7> internalUserV7SecurityDynamicConfiguration;\n+\n+        SecurityDynamicConfiguration<RoleV7> roleV7SecurityDynamicConfiguration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDExOTMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo1MTozM1rOGij2Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTo1MTozM1rOGij2Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5MjA1NQ==", "bodyText": "!roleV7SecurityDynamicConfiguration.getCEntry(role).isHidden() && !roleV7SecurityDynamicConfiguration.getCEntry(role).isReserved()\nnit: introduce private boolean isHiddenOrReserved(String role) helper method\nadd unit tests\nnit: indentation does not look right", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438892055", "createdAt": "2020-06-11T15:51:33Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -244,45 +245,54 @@ public void unregisterDCFListener(Object listener) {\n     \n     private static class InternalUsersModelV7 extends InternalUsersModel {\n         \n-        SecurityDynamicConfiguration<InternalUserV7> configuration;\n+        SecurityDynamicConfiguration<InternalUserV7> internalUserV7SecurityDynamicConfiguration;\n+\n+        SecurityDynamicConfiguration<RoleV7> roleV7SecurityDynamicConfiguration;\n         \n-        public InternalUsersModelV7(SecurityDynamicConfiguration<InternalUserV7> configuration) {\n+        public InternalUsersModelV7(SecurityDynamicConfiguration<InternalUserV7> internalUserV7SecurityDynamicConfiguration, SecurityDynamicConfiguration<RoleV7> roleV7SecurityDynamicConfiguration) {\n             super();\n-            this.configuration = configuration;\n+            this.internalUserV7SecurityDynamicConfiguration = internalUserV7SecurityDynamicConfiguration;\n+            this.roleV7SecurityDynamicConfiguration = roleV7SecurityDynamicConfiguration;\n         }\n \n         @Override\n         public boolean exists(String user) {\n-            return configuration.exists(user);\n+            return internalUserV7SecurityDynamicConfiguration.exists(user);\n         }\n \n         @Override\n         public List<String> getBackenRoles(String user) {\n-            InternalUserV7 tmp = configuration.getCEntry(user);\n+            InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n             return tmp==null?null:tmp.getBackend_roles();\n         }\n \n         @Override\n         public Map<String, String> getAttributes(String user) {\n-            InternalUserV7 tmp = configuration.getCEntry(user);\n+            InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n             return tmp==null?null:tmp.getAttributes();\n         }\n \n         @Override\n         public String getDescription(String user) {\n-            InternalUserV7 tmp = configuration.getCEntry(user);\n+            InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n             return tmp==null?null:tmp.getDescription();\n         }\n \n         @Override\n         public String getHash(String user) {\n-            InternalUserV7 tmp = configuration.getCEntry(user);\n+            InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n             return tmp==null?null:tmp.getHash();\n         }\n         \n         public List<String> getOpenDistroSecurityRoles(String user) {\n-            InternalUserV7 tmp = configuration.getCEntry(user);\n-            return tmp==null?Collections.emptyList():tmp.getOpendistro_security_roles();\n+            InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n+\n+            // Filtering out hidden and reserved roles for existing users\n+            return tmp==null? ImmutableList.of():\n+                                    tmp.getOpendistro_security_roles()\n+                                        .stream()\n+                                        .filter(role -> roleV7SecurityDynamicConfiguration.getCEntry(role).isHidden() || roleV7SecurityDynamicConfiguration.getCEntry(role).isReserved())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDIxNzEzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNjoxNTozM1rOGik1yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNjoxNTozM1rOGik1yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwODM2MQ==", "bodyText": "nit: move roles.getCEntries().size() to the next line.", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r438908361", "createdAt": "2020-06-11T16:15:33Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -189,13 +189,14 @@ public void onChange(Map<CType, SecurityDynamicConfiguration<?>> typeToConfig) {\n \n                 log.debug(\"Static tenants loaded ({})\", staticTenants.getCEntries().size());\n \n-                log.debug(\"Static configuration loaded (total roles: {}/total action groups: {}/total tenants: {})\", roles.getCEntries().size(), actionGroups.getCEntries().size(), tenants.getCEntries().size());\n+                log.debug(\"Static configuration loaded (total roles: {}/total action groups: {}/total tenants: {})\", roles.getCEntries().size(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDgzNjk4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxOToxMToyOFrOGirF9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDozNjo0MlrOGit7LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxMDgwNQ==", "bodyText": "if role is hidden and if we throw \"Role is not found\", user may try to create a role with same name.\nWhat will happen if someone try to create a role with same name as of hidden role?", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439010805", "createdAt": "2020-06-11T19:11:28Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (isHidden(rolesConfiguration, role)) {\n+                    notFound(channel, \"Role '\"+role+\"' is not found.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA1MDYxNw==", "bodyText": "We currently prevent users from modifying hidden roles -\nPUT  _opendistro/_security/api/roles/ES_hidden\n{\n  \"status\": \"FORBIDDEN\",\n  \"message\": \"Resource 'ES_hidden' is not available.\"\n}", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439050617", "createdAt": "2020-06-11T20:23:07Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (isHidden(rolesConfiguration, role)) {\n+                    notFound(channel, \"Role '\"+role+\"' is not found.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxMDgwNQ=="}, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA1NzE5Ng==", "bodyText": "We can make this clearer for the user by mentioning the role is hidden but am unsure if that is a security concern. Right now we default to saying Role is not found in any case where the role is hidden -\nhttps://github.com/opendistro-for-elasticsearch/security/blob/ed6f901838e80e14116057bbffde02a3cf89e27e/src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AbstractApiAction.java#L151-L154", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439057196", "createdAt": "2020-06-11T20:36:42Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,41 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+\n+        // Don't allow user to add reserved or hidden role\n+        final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (isHidden(rolesConfiguration, role)) {\n+                    notFound(channel, \"Role '\"+role+\"' is not found.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxMDgwNQ=="}, "originalCommit": {"oid": "7054096d099f0245a76e86b9e54e4c644b30b773"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTc1NzIzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMToyMDoxNVrOGi0EQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNzo1ODo1NVrOGjM-5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1NzgyNQ==", "bodyText": "move if (rolesConfiguration.getCEntry(role) == null) to here:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (isHidden(rolesConfiguration, role)) {\n          \n          \n            \n                            if (!rolesConfiguration.exists(role) || isHidden(rolesConfiguration, role)) {", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439157825", "createdAt": "2020-06-12T01:20:15Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,44 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+        // Don't allow user to add hidden, reserved or non-existent role\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (rolesConfiguration.getCEntry(role) == null) {\n+                    notFound(channel, \"Role '\"+role+\"' does not exist.\");\n+                }\n+\n+                if (isHidden(rolesConfiguration, role)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMDA4NQ==", "bodyText": "I am slightly conflicted about treating hidden and non-existent roles the same way.\nFor non-existent roles the customer can resolve the issue by creating the new role, for hidden roles this will not be possible. If we return the same error message for both do you think it will cause confusion for the customer?", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439510085", "createdAt": "2020-06-12T16:08:43Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,44 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+        // Don't allow user to add hidden, reserved or non-existent role\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (rolesConfiguration.getCEntry(role) == null) {\n+                    notFound(channel, \"Role '\"+role+\"' does not exist.\");\n+                }\n+\n+                if (isHidden(rolesConfiguration, role)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1NzgyNQ=="}, "originalCommit": null, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU2NjA1Mw==", "bodyText": "Hidden resource(role) means that for all practical purposes it can't be distinguished from not existing resource(role). Check, for example, how patch request for hidden resource/role is handled. The only exception where it is not possible to avoid exposing hidden resources is create(put) request.", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439566053", "createdAt": "2020-06-12T17:58:55Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -99,22 +99,44 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         // TODO it might be sensible to consolidate this with the overridden method in\n         // order to minimize duplicated logic\n \n-        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), false);\n+        final SecurityDynamicConfiguration<?> internalUsersConfiguration = load(getConfigName(), false);\n \n-        if (isHidden(configuration, username)) {\n+        if (isHidden(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is not available.\");\n             return;\n         }\n \n         // check if resource is writeable\n-        if (!isReservedAndAccessible(configuration, username)) {\n+        if (!isReservedAndAccessible(internalUsersConfiguration, username)) {\n             forbidden(channel, \"Resource '\" + username + \"' is read-only.\");\n             return;\n         }\n \n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n+        // Don't allow user to add hidden, reserved or non-existent role\n+        final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n+        if (opendistroSecurityRoles != null) {\n+            final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            for (final String role: opendistroSecurityRoles) {\n+\n+                if (rolesConfiguration.getCEntry(role) == null) {\n+                    notFound(channel, \"Role '\"+role+\"' does not exist.\");\n+                }\n+\n+                if (isHidden(rolesConfiguration, role)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1NzgyNQ=="}, "originalCommit": null, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTc2MTcxOnYy", "diffSide": "RIGHT", "path": "src/test/resources/roles.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMToyMjo1OFrOGi0G3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMToyMjo1OFrOGi0G3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODQ5Mg==", "bodyText": "add new line", "url": "https://github.com/opensearch-project/security/pull/486#discussion_r439158492", "createdAt": "2020-06-12T01:22:58Z", "author": {"login": "vrozov"}, "path": "src/test/resources/roles.yml", "diffHunk": "@@ -1031,3 +1031,54 @@ role_foo_all:\n         - indices:data/read/*\n         - indices:admin/*\n         - indices:monitor/*\n+\n+xyz_sr:\n+  reserved: false\n+  hidden: false\n+  description: \"Migrated from v6 (all types mapped)\"\n+  cluster_permissions:\n+    - \"OPENDISTRO_SECURITY_CLUSTER_COMPOSITE_OPS_RO\"\n+  index_permissions:\n+    - index_patterns:\n+        - \"twitter\"\n+        - \"analytics\"\n+      dls: null\n+      fls: null\n+      masked_fields: null\n+      allowed_actions:\n+        - \"*\"\n+  tenant_permissions: []\n+\n+xyz_sr_hidden:\n+  reserved: false\n+  hidden: true\n+  description: \"Migrated from v6 (all types mapped)\"\n+  cluster_permissions:\n+    - \"OPENDISTRO_SECURITY_CLUSTER_COMPOSITE_OPS_RO\"\n+  index_permissions:\n+    - index_patterns:\n+        - \"twitter\"\n+        - \"analytics\"\n+      dls: null\n+      fls: null\n+      masked_fields: null\n+      allowed_actions:\n+        - \"*\"\n+  tenant_permissions: []\n+\n+xyz_sr_reserved:\n+  reserved: true\n+  hidden: false\n+  description: \"Migrated from v6 (all types mapped)\"\n+  cluster_permissions:\n+    - \"OPENDISTRO_SECURITY_CLUSTER_COMPOSITE_OPS_RO\"\n+  index_permissions:\n+    - index_patterns:\n+        - \"twitter\"\n+        - \"analytics\"\n+      dls: null\n+      fls: null\n+      masked_fields: null\n+      allowed_actions:\n+        - \"*\"\n+  tenant_permissions: []", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2470, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}