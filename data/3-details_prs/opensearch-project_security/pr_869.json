{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMjg2Njk4", "number": 869, "title": "Fix for java.io.OptionalDataException that is caused by changes to User object after it is put on thread context.", "bodyText": "Issue #, if available:\norg.elasticsearch.transport.RemoteTransportException: [][][indices:admin/aliases/get]\nCaused by: org.elasticsearch.ElasticsearchException: java.io.OptionalDataException\n\tat com.amazon.opendistroforelasticsearch.security.support.Base64Helper.deserializeObject(Base64Helper.java:185) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.auditlog.impl.AbstractAuditLog.getUser(AbstractAuditLog.java:626) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.auditlog.impl.AbstractAuditLog.logMissingPrivileges(AbstractAuditLog.java:234) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditLogImpl.logMissingPrivileges(AuditLogImpl.java:187) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.auditlog.AuditLogSslExceptionHandler.logError(AuditLogSslExceptionHandler.java:77) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.ssl.transport.OpenDistroSecuritySSLRequestHandler.messageReceived(OpenDistroSecuritySSLRequestHandler.java:158) ~[?:?]\n\tat com.amazon.opendistroforelasticsearch.security.OpenDistroSecurityPlugin$7$1.messageReceived(OpenDistroSecurityPlugin.java:626) ~[?:?]\n\tat com.amazonaws.elasticsearch.iam.IamTransportRequestHandler.messageReceived(IamTransportRequestHandler.java:55) ~[?:?]\n\tat com.amazonaws.elasticsearch.ccs.CrossClusterRequestInterceptor$CrossClusterRequestHandler.messageReceived(CrossClusterRequestInterceptor.java:133) ~[?:?]\n\tat com.amazon.opendistro.elasticsearch.performanceanalyzer.transport.PerformanceAnalyzerTransportRequestHandler.messageReceived(PerformanceAnalyzerTransportRequestHandler.java:48) ~[?:?]\n\nDescription of changes:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-04T05:00:23Z", "url": "https://github.com/opensearch-project/security/pull/869", "merged": true, "mergeCommit": {"oid": "f382a820ad8512c878a1eaa85bf604e2d4aa4b7d"}, "closed": true, "closedAt": "2020-12-04T19:02:22Z", "author": {"login": "vrozov"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiv2x9AH2gAyNTMyMjg2Njk4Ojg3MTE2YzhiYTA4ZTRhNjlmMjY3OGNjMGU0MjE2MzFiZGM2MDkxNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi8gKvAFqTU0NTIyMDEyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160", "author": {"user": {"login": "vrozov", "name": "Vlad Rozov"}}, "url": "https://github.com/opensearch-project/security/commit/87116c8ba08e4a69f2678cc0e421631bdc609160", "committedDate": "2020-12-04T04:16:02Z", "message": "Fix for java.io.OptionalDataException that is caused by changes to User object after it is put on thread context."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjY1NzY2", "url": "https://github.com/opensearch-project/security/pull/869#pullrequestreview-544665766", "createdAt": "2020-12-04T05:25:44Z", "commit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDgwMzgw", "url": "https://github.com/opensearch-project/security/pull/869#pullrequestreview-545080380", "createdAt": "2020-12-04T15:53:50Z", "commit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTcyNzYw", "url": "https://github.com/opensearch-project/security/pull/869#pullrequestreview-545172760", "createdAt": "2020-12-04T17:50:30Z", "commit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzo1MDozMVrOH_be8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzo1MDozMVrOH_be8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI3MjYyNQ==", "bodyText": "can mappedRoles be null?", "url": "https://github.com/opensearch-project/security/pull/869#discussion_r536272625", "createdAt": "2020-12-04T17:50:31Z", "author": {"login": "akbhatta"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -167,6 +174,21 @@ public boolean isInitialized() {\n         return configModel !=null && configModel.getSecurityRoles() != null && dcm != null;\n     }\n \n+    private void setUserInfoInThreadContext(User user, Collection<String> mappedRoles) {\n+        if (threadContext.getTransient(OPENDISTRO_SECURITY_USER_INFO_THREAD_CONTEXT) == null) {\n+            final ImmutableList.Builder<String> builder = ImmutableList.builder();\n+            builder.add(user.getName(),\n+                    String.join(\",\", user.getRoles()),\n+                    String.join(\",\", Stream.concat(user.getOpenDistroSecurityRoles().stream(), mappedRoles.stream())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjIwMTIy", "url": "https://github.com/opensearch-project/security/pull/869#pullrequestreview-545220122", "createdAt": "2020-12-04T19:00:06Z", "commit": {"oid": "87116c8ba08e4a69f2678cc0e421631bdc609160"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2680, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}