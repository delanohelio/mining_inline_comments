{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0Mzk4NDgx", "number": 926, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNTozOVrOFRq2iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDo1NTo0NVrOFRrhZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MDcyMjAxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNTozOVrOIYO9rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNTozOVrOIYO9rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MTkwMQ==", "bodyText": "minor: you can return presponse once outside the if/else block", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562281901", "createdAt": "2021-01-22T00:15:39Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);\n+                return presponse;\n+            } else {\n+                presponse.allowed = true;\n+                return presponse;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MDcyMzkyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNjoyOFrOIYO-1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNjoyOFrOIYO-1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MjE5OA==", "bodyText": "why two log.info's instead of one?", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562282198", "createdAt": "2021-01-22T00:16:28Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU0MDgzMTczOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDo1NTo0NVrOIYQAAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDo1NTo0NVrOIYQAAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI5ODg4MA==", "bodyText": "Should \"cluster\" be hardcoded to the log message format string?", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562298880", "createdAt": "2021-01-22T00:55:45Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,22 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]. No permissions for {}\", \"cluster\", user, action0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2204, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}