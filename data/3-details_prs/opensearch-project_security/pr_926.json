{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0Mzk4NDgx", "number": 926, "title": "Short circuit privilege evaluation for bulk requests without index resolution", "bodyText": "opendistro-for-elasticsearch/security pull request intake form\nPlease provide as much details as possible to get feedback/acceptance on your PR quickly\n\nCategory: (Enhancement, New feature, Bug fix, Test fix, Refactoring, Maintenance, Documentation)\n\n\nEnhancement (performance)\n\n\nGithub Issue # or road-map entry, if available:\n\n\nN/A\n\n\nDescription of changes:\n\n\nShort circuit bulk requests if tenant is not specified (default tenant)\nSkip index resolution\nOnly evaluation that is done at top level is checking if the user has privileges to perform the request. Other evaluations are done in lower level in BulkShardRequest\n\n\nWhy these changes are required?\n\n\nPerformance improvement\n\n\n\nWhat is the old behavior before changes and new behavior after changes? (Please add any example/logs/screen-shot if available)\n\n\nTesting done: (Please provide details of testing done: Unit testing, integration testing and manual testing)\n\n\n\nAutomated tests\n\n\nTO-DOs, if any: (Please describe pending items and provide Github issues# for each of them)\n\n\nN/A\n\n\nIs it backport from master branch? (If yes, please add backport PR # and commits #)\n\n\nN/A\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-22T22:11:05Z", "url": "https://github.com/opensearch-project/security/pull/926", "merged": true, "mergeCommit": {"oid": "d9459dd54ca503f4cf00df9835877a90b1831745"}, "closed": true, "closedAt": "2021-01-22T07:00:40Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdv3D03AH2gAyNTQ0Mzk4NDgxOjk4ZjMzOWU4OWI1MWQyNzJkZmQ4N2E2Y2UyN2JlOWYzNTI4YzJlMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdygA3CgFqTU3MzkxNDY0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/98f339e89b51d272dfd87a6ce27be9f3528c2e20", "committedDate": "2021-01-13T22:00:38Z", "message": "Short circuit privilege evaluation for bulk requests without index resolution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczNzgxMDY4", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573781068", "createdAt": "2021-01-21T22:14:45Z", "commit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczODM5Njcx", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573839671", "createdAt": "2021-01-22T00:15:38Z", "commit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNTozOVrOIYO9rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNTozOVrOIYO9rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MTkwMQ==", "bodyText": "minor: you can return presponse once outside the if/else block", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562281901", "createdAt": "2021-01-22T00:15:39Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);\n+                return presponse;\n+            } else {\n+                presponse.allowed = true;\n+                return presponse;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczODM5OTk3", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573839997", "createdAt": "2021-01-22T00:16:28Z", "commit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNjoyOFrOIYO-1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDoxNjoyOFrOIYO-1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI4MjE5OA==", "bodyText": "why two log.info's instead of one?", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562282198", "createdAt": "2021-01-22T00:16:28Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,24 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]\", \"cluster\", user, action0,\n+                        securityRoles.getRoleNames());\n+                log.info(\"No permissions for {}\", presponse.missingPrivileges);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f339e89b51d272dfd87a6ce27be9f3528c2e20"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe", "committedDate": "2021-01-22T00:30:18Z", "message": "CR review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczODU3MTYy", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573857162", "createdAt": "2021-01-22T00:55:44Z", "commit": {"oid": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDo1NTo0NVrOIYQAAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQwMDo1NTo0NVrOIYQAAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjI5ODg4MA==", "bodyText": "Should \"cluster\" be hardcoded to the log message format string?", "url": "https://github.com/opensearch-project/security/pull/926#discussion_r562298880", "createdAt": "2021-01-22T00:55:45Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -220,6 +221,22 @@ public PrivilegesEvaluatorResponse evaluate(final User user, String action0, fin\n             log.debug(\"mapped roles: {}\",mappedRoles.toString());\n         }\n \n+        if (request instanceof BulkRequest && (Strings.isNullOrEmpty(user.getRequestedTenant()))) {\n+            // Shortcut for bulk actions. The details are checked on the lower level of the BulkShardRequests (Action indices:data/write/bulk[s]).\n+            // This shortcut is only possible if the default tenant is selected, as we might need to rewrite the request for non-default tenants.\n+            // No further access check for the default tenant is necessary, as access will be also checked on the TransportShardBulkAction level.\n+\n+            if (!securityRoles.impliesClusterPermissionPermission(action0)) {\n+                presponse.missingPrivileges.add(action0);\n+                presponse.allowed = false;\n+                log.info(\"No {}-level perm match for {} [Action [{}]] [RolesChecked {}]. No permissions for {}\", \"cluster\", user, action0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9941f43e3e151aeb6ebd8fcfab8e6bf04267ffe"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf5289f2fd1694fbc50f38785bc69103fdb46a4f", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/bf5289f2fd1694fbc50f38785bc69103fdb46a4f", "committedDate": "2021-01-22T01:15:33Z", "message": "CR review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczODY4MDE2", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573868016", "createdAt": "2021-01-22T01:24:15Z", "commit": {"oid": "bf5289f2fd1694fbc50f38785bc69103fdb46a4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczOTE0NjQ4", "url": "https://github.com/opensearch-project/security/pull/926#pullrequestreview-573914648", "createdAt": "2021-01-22T02:51:21Z", "commit": {"oid": "bf5289f2fd1694fbc50f38785bc69103fdb46a4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2622, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}