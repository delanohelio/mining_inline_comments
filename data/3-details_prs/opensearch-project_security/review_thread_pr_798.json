{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5ODE2MjI4", "number": 798, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1NDo0MlrOEyKbeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowODoxM1rOEyKkxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDM1MTI4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1NDo0MlrOHoplaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo0Nzo0OVrOHpTyBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ==", "bodyText": "nit: populate only if there is a call to chain. If access is denied, it is necessary to populate OPENDISTRO_SECURITY_USER_ROLES_STRING?", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512386409", "createdAt": "2020-10-27T02:54:42Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -291,7 +292,11 @@ public int order() {\n             if (log.isDebugEnabled()) {\n                 log.debug(pres);\n             }\n-            \n+\n+            if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_ROLES_STRING) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1ODc1OA==", "bodyText": "Does this require order of plugins loading to be enforced? If yes, how that will be done?", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512958758", "createdAt": "2020-10-27T19:12:26Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -291,7 +292,11 @@ public int order() {\n             if (log.isDebugEnabled()) {\n                 log.debug(pres);\n             }\n-            \n+\n+            if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_ROLES_STRING) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ=="}, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3Nzc2Ng==", "bodyText": "Discussed with @skkosuri-amzn, the ordering needs to be researched. Can be done as a follow up PR.", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r513077766", "createdAt": "2020-10-27T22:47:49Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -291,7 +292,11 @@ public int order() {\n             if (log.isDebugEnabled()) {\n                 log.debug(pres);\n             }\n-            \n+\n+            if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_ROLES_STRING) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ=="}, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDM1ODgwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1ODo0M1rOHoppug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowNToxMVrOHopwhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NzUxNA==", "bodyText": "Can roles or odfe roles contain ,?", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512387514", "createdAt": "2020-10-27T02:58:43Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -263,4 +263,8 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     public final Set<String> getOpenDistroSecurityRoles() {\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n+\n+    public final String getUserRolesString() {\n+        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4OTI1Mw==", "bodyText": "As far as I know, it can't contain ,. Pipe separated string format is used at other places including : UserInjector, RolesInjector.", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512389253", "createdAt": "2020-10-27T03:05:11Z", "author": {"login": "skkosuri-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -263,4 +263,8 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     public final Set<String> getOpenDistroSecurityRoles() {\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n+\n+    public final String getUserRolesString() {\n+        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NzUxNA=="}, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDM3NTA4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowODoxM1rOHopzdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzoyNzoyM1rOHoqGtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MDAwNQ==", "bodyText": "For consistency with injected_user (that is also a String) please rename to remove STRING: OPENDISTRO_SECURITY_USER_ROLES_STRING ->OPENDISTRO_SECURITY_USER_AND_ROLES, \"user_roles_string\" -> \"user&roles\" or \"user_and_roles\".", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512390005", "createdAt": "2020-10-27T03:08:13Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "diffHunk": "@@ -99,6 +99,8 @@\n     public static final String OPENDISTRO_SECURITY_USER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user\";\n     public static final String OPENDISTRO_SECURITY_USER_HEADER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user_header\";\n \n+    public static final String OPENDISTRO_SECURITY_USER_ROLES_STRING = OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_roles_string\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5NDkzNA==", "bodyText": "Renamed. thanks.", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512394934", "createdAt": "2020-10-27T03:27:23Z", "author": {"login": "skkosuri-amzn"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "diffHunk": "@@ -99,6 +99,8 @@\n     public static final String OPENDISTRO_SECURITY_USER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user\";\n     public static final String OPENDISTRO_SECURITY_USER_HEADER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user_header\";\n \n+    public static final String OPENDISTRO_SECURITY_USER_ROLES_STRING = OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_roles_string\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MDAwNQ=="}, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2216, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}