{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MjQ0NTQ4", "number": 691, "title": "Redact request body for APIs that may contain plaintext password", "bodyText": "Issue #, if available:\nDescription of changes:\n\nCurrently 3 APIs may contain plaintext passwords which may be audit logged\n\n/_opendistro/_security/api/account\n/_opendistro/_security/api/internalusers\n/_opendistro/_security/api/user\n\n\nRedact if any of the above requests contain request body (primarily PUT/PATCH) but want to consider possibility of customer accidentally supplying the plain text password for GET requests\nReplace with __SENSITIVE__ so that customer knows some content is redacted\nAdded tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-04T03:40:09Z", "url": "https://github.com/opensearch-project/security/pull/691", "merged": true, "mergeCommit": {"oid": "c6c53e8b7221e85998a3d1e0b4642f8c66edf680"}, "closed": true, "closedAt": "2020-09-04T06:32:38Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFdEBnAFqTQ4MjM0MDM5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFfERngFqTQ4MjM4NTY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzQwMzk4", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482340398", "createdAt": "2020-09-04T03:58:29Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMzo1ODozMFrOHM-qdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMzo1ODozMFrOHM-qdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3MTYzOA==", "bodyText": "Should we check if request body contains \"password\"?", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483371638", "createdAt": "2020-09-04T03:58:30Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")\n+                        || path.startsWith(\"/_opendistro/_security/api/internalusers\")\n+                        || path.startsWith(\"/_opendistro/_security/api/user\")) {\n+                    auditInfo.put(REQUEST_BODY, \"__SENSITIVE__\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzQzODU3", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482343857", "createdAt": "2020-09-04T04:10:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDoxMDo0N1rOHM-2Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDoxMDo0N1rOHM-2Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDY3OA==", "bodyText": "public static final String SENSITIVE = \"__SENSITIVE__\";", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483374678", "createdAt": "2020-09-04T04:10:47Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")\n+                        || path.startsWith(\"/_opendistro/_security/api/internalusers\")\n+                        || path.startsWith(\"/_opendistro/_security/api/user\")) {\n+                    auditInfo.put(REQUEST_BODY, \"__SENSITIVE__\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzUyODc4", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482352878", "createdAt": "2020-09-04T04:39:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDozOToxMlrOHM_SPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDozOToxMlrOHM_SPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4MTgyMw==", "bodyText": "private static Pattern PATH = Pattern.compile(\"/_opendistro/_security/api/(account.*|internalusers.*|user.*)\");", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483381823", "createdAt": "2020-09-04T04:39:12Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzY0MzEy", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482364312", "createdAt": "2020-09-04T05:18:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNToxODowOFrOHM_6Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNToxODowOFrOHM_6Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5MjA3NA==", "bodyText": "Is this used anywhere? I might be overlooking", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483392074", "createdAt": "2020-09-04T05:18:08Z", "author": {"login": "palashhedau"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -55,6 +56,10 @@\n \n     //clustername and cluster uuid\n     private static final WildcardMatcher AUTHORIZATION_HEADER = WildcardMatcher.from(\"Authorization\", false);\n+    private static final String SENSITIVE = \"__SENSITIVE__\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzY5Nzc2", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482369776", "createdAt": "2020-09-04T05:35:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTozNTozOVrOHNAM4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTozNTozOVrOHNAM4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5NjgzNQ==", "bodyText": "In case requestBody is null, this will work right?", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483396835", "createdAt": "2020-09-04T05:35:39Z", "author": {"login": "palashhedau"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +327,25 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                try {\n+                    final Tuple<XContentType, BytesReference> xContentTuple = request.contentOrSourceParam();\n+                    final String requestBody =  XContentHelper.convertToJson(xContentTuple.v2(), false, xContentTuple.v1());\n+                    if (path != null && requestBody != null\n+                            && SENSITIVE_PATHS.matcher(path).find()\n+                            && requestBody.contains(SENSITIVE_KEY)) {\n+                        auditInfo.put(REQUEST_BODY, SENSITIVE_REPLACEMENT_VALUE);\n+                    } else {\n+                        auditInfo.put(REQUEST_BODY, requestBody);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzc1NzQw", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482375740", "createdAt": "2020-09-04T05:53:00Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo1MzowMFrOHNAgng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo1MzowMFrOHNAgng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQwMTg4Ng==", "bodyText": "nit: matches() is IMO a better fit.", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483401886", "createdAt": "2020-09-04T05:53:00Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +327,25 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                try {\n+                    final Tuple<XContentType, BytesReference> xContentTuple = request.contentOrSourceParam();\n+                    final String requestBody =  XContentHelper.convertToJson(xContentTuple.v2(), false, xContentTuple.v1());\n+                    if (path != null && requestBody != null\n+                            && SENSITIVE_PATHS.matcher(path).find()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzc1ODgy", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482375882", "createdAt": "2020-09-04T05:53:26Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzc3OTA3", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482377907", "createdAt": "2020-09-04T05:58:59Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ba30b02dd499e1f70c52b1e927feca8805dd29", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/87ba30b02dd499e1f70c52b1e927feca8805dd29", "committedDate": "2020-09-04T06:03:17Z", "message": "Redact request body for APIs that may contain plaintext password"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzgyMDUx", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482382051", "createdAt": "2020-09-04T06:10:00Z", "commit": {"oid": "87ba30b02dd499e1f70c52b1e927feca8805dd29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzg1NjU3", "url": "https://github.com/opensearch-project/security/pull/691#pullrequestreview-482385657", "createdAt": "2020-09-04T06:18:35Z", "commit": {"oid": "87ba30b02dd499e1f70c52b1e927feca8805dd29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2735, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}