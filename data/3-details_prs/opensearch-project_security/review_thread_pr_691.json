{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MjQ0NTQ4", "number": 691, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMzo1ODoyOVrOEgOxsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo1MzowMFrOEgQBqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjMxOTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMzo1ODozMFrOHM-qdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMzo1ODozMFrOHM-qdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3MTYzOA==", "bodyText": "Should we check if request body contains \"password\"?", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483371638", "createdAt": "2020-09-04T03:58:30Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")\n+                        || path.startsWith(\"/_opendistro/_security/api/internalusers\")\n+                        || path.startsWith(\"/_opendistro/_security/api/user\")) {\n+                    auditInfo.put(REQUEST_BODY, \"__SENSITIVE__\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjM0MDI3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDoxMDo0N1rOHM-2Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDoxMDo0N1rOHM-2Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM3NDY3OA==", "bodyText": "public static final String SENSITIVE = \"__SENSITIVE__\";", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483374678", "createdAt": "2020-09-04T04:10:47Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")\n+                        || path.startsWith(\"/_opendistro/_security/api/internalusers\")\n+                        || path.startsWith(\"/_opendistro/_security/api/user\")) {\n+                    auditInfo.put(REQUEST_BODY, \"__SENSITIVE__\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjM4ODEwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDozOToxMlrOHM_SPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDozOToxMlrOHM_SPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4MTgyMw==", "bodyText": "private static Pattern PATH = Pattern.compile(\"/_opendistro/_security/api/(account.*|internalusers.*|user.*)\");", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483381823", "createdAt": "2020-09-04T04:39:12Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +323,19 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                if (path.startsWith(\"/_opendistro/_security/api/account\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjQ1ODc1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNToxODowOFrOHM_6Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNToxODowOFrOHM_6Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5MjA3NA==", "bodyText": "Is this used anywhere? I might be overlooking", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483392074", "createdAt": "2020-09-04T05:18:08Z", "author": {"login": "palashhedau"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -55,6 +56,10 @@\n \n     //clustername and cluster uuid\n     private static final WildcardMatcher AUTHORIZATION_HEADER = WildcardMatcher.from(\"Authorization\", false);\n+    private static final String SENSITIVE = \"__SENSITIVE__\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjQ5MDkwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTozNTozOVrOHNAM4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo0OTowMFrOHNAb_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5NjgzNQ==", "bodyText": "In case requestBody is null, this will work right?", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483396835", "createdAt": "2020-09-04T05:35:39Z", "author": {"login": "palashhedau"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +327,25 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                try {\n+                    final Tuple<XContentType, BytesReference> xContentTuple = request.contentOrSourceParam();\n+                    final String requestBody =  XContentHelper.convertToJson(xContentTuple.v2(), false, xContentTuple.v1());\n+                    if (path != null && requestBody != null\n+                            && SENSITIVE_PATHS.matcher(path).find()\n+                            && requestBody.contains(SENSITIVE_KEY)) {\n+                        auditInfo.put(REQUEST_BODY, SENSITIVE_REPLACEMENT_VALUE);\n+                    } else {\n+                        auditInfo.put(REQUEST_BODY, requestBody);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQwMDcwMA==", "bodyText": "Actually requestBody must not be null there as per original behavior. Let me check if the null check can be removed", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483400700", "createdAt": "2020-09-04T05:49:00Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +327,25 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                try {\n+                    final Tuple<XContentType, BytesReference> xContentTuple = request.contentOrSourceParam();\n+                    final String requestBody =  XContentHelper.convertToJson(xContentTuple.v2(), false, xContentTuple.v1());\n+                    if (path != null && requestBody != null\n+                            && SENSITIVE_PATHS.matcher(path).find()\n+                            && requestBody.contains(SENSITIVE_KEY)) {\n+                        auditInfo.put(REQUEST_BODY, SENSITIVE_REPLACEMENT_VALUE);\n+                    } else {\n+                        auditInfo.put(REQUEST_BODY, requestBody);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM5NjgzNQ=="}, "originalCommit": null, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjUyNDU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo1MzowMFrOHNAgng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNTo1MzowMFrOHNAgng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQwMTg4Ng==", "bodyText": "nit: matches() is IMO a better fit.", "url": "https://github.com/opensearch-project/security/pull/691#discussion_r483401886", "createdAt": "2020-09-04T05:53:00Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditMessage.java", "diffHunk": "@@ -323,12 +327,25 @@ void addRestMethod(final RestRequest.Method method) {\n \n     void addRestRequestInfo(final RestRequest request, final AuditConfig.Filter filter) {\n         if (request != null) {\n-            addPath(request.path());\n+            final String path = request.path();\n+            addPath(path);\n             addRestHeaders(request.getHeaders(), filter.shouldExcludeSensitiveHeaders());\n             addRestParams(request.params());\n             addRestMethod(request.method());\n             if (filter.shouldLogRequestBody() && request.hasContentOrSourceParam()) {\n-                addTupleToRequestBody(request.contentOrSourceParam());\n+                try {\n+                    final Tuple<XContentType, BytesReference> xContentTuple = request.contentOrSourceParam();\n+                    final String requestBody =  XContentHelper.convertToJson(xContentTuple.v2(), false, xContentTuple.v1());\n+                    if (path != null && requestBody != null\n+                            && SENSITIVE_PATHS.matcher(path).find()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2298, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}