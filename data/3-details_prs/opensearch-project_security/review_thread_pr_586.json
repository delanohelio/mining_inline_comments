{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NzgyOTgw", "number": 586, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjoyOTo1MVrOESdt2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0Njo1MlrOESfhHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3Nzk2Njk5OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/OpendistroSecurityRolesTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjoyOTo1MVrOG3qMcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoxMTowNFrOG3rwfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE3Ng==", "bodyText": "Is this supposed to be True or False ?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461016176", "createdAt": "2020-07-27T16:29:51Z", "author": {"login": "dinusX"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/OpendistroSecurityRolesTests.java", "diffHunk": "@@ -79,11 +80,15 @@ public void testOpenDistroSecurityRoles() throws Exception {\n \t\tAssert.assertTrue(resc.getBody().contains(\"sr_user\"));\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr\"));\n \n-\t\t// Ensure hidden reserved and non-existent roles are not available\n+\t\t// Opendistro_security_roles cannot contain roles that don't exist.\n \t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_non_existent\"));\n-\t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_hidden\"));\n+\n+\t\t// Opendistro_security_roles can contain reserved roles.\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_reserved\"));\n \n+\t\t// Opendistro_security_roles cannot contain roles that are hidden in rolesmapping.yml.\n+\t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_hidden\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0MTc4OQ==", "bodyText": "False, good catch. Was an error in the test + test config. I have fixed this.", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461041789", "createdAt": "2020-07-27T17:11:04Z", "author": {"login": "debjanibnrj"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/OpendistroSecurityRolesTests.java", "diffHunk": "@@ -79,11 +80,15 @@ public void testOpenDistroSecurityRoles() throws Exception {\n \t\tAssert.assertTrue(resc.getBody().contains(\"sr_user\"));\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr\"));\n \n-\t\t// Ensure hidden reserved and non-existent roles are not available\n+\t\t// Opendistro_security_roles cannot contain roles that don't exist.\n \t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_non_existent\"));\n-\t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_hidden\"));\n+\n+\t\t// Opendistro_security_roles can contain reserved roles.\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_reserved\"));\n \n+\t\t// Opendistro_security_roles cannot contain roles that are hidden in rolesmapping.yml.\n+\t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_hidden\"));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE3Ng=="}, "originalCommit": null, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODE4MzUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyNToyMlrOG3sRVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyNToyMlrOG3sRVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MDE5Ng==", "bodyText": "nit: use exists? same as original code?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461050196", "createdAt": "2020-07-27T17:25:22Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -115,18 +115,24 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n-        // Don't allow user to add hidden, reserved or non-existent role\n+        // Don't allow user to add hidden, reserved or non-existent rolesmapping\n         final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n         if (opendistroSecurityRoles != null) {\n             final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            final SecurityDynamicConfiguration<?> rolesmappingConfiguration = load(CType.ROLESMAPPING, false);\n             for (final String role: opendistroSecurityRoles) {\n \n-                if (!rolesConfiguration.exists(role) || rolesConfiguration.isHidden(role)) {\n+                if (rolesConfiguration.getCEntry(role) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODI2MjA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0Njo1MlrOG3tBeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0Njo1MlrOG3tBeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyMA==", "bodyText": "We can add the roles check here itself having the same definition as \"isHiddenOrNonExistent\" ?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461062520", "createdAt": "2020-07-27T17:46:52Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -300,23 +307,23 @@ public String getHash(String user) {\n         public List<String> getOpenDistroSecurityRoles(String user) {\n             InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n \n-            // Filtering out hidden and non-existent roles for existing users\n+            // Opendistro security roles should only contain roles that exist in the roles dynamic config.\n+            // We should filter out any roles that have hidden rolesmapping.\n             return tmp == null ? ImmutableList.of() :\n-                tmp.getOpendistro_security_roles().stream().filter(role -> !isHiddenOrNonExistent(role)).collect(ImmutableList.toImmutableList());\n+                tmp.getOpendistro_security_roles().stream().filter(role -> !isRolesMappingHidden(role) && rolesV7SecurityDynamicConfiguration.exists(role)).collect(ImmutableList.toImmutableList());\n         }\n \n-        // We will remove opendistro security mapping for roles that are hidden or non-existent in the roles configuration\n-        private boolean isHiddenOrNonExistent(String rolename) {\n-            final RoleV7 role = roleV7SecurityDynamicConfiguration.getCEntry(rolename);\n-            return role == null || role.isHidden();\n+        // Remove any hidden rolesmapping from the opendistro security roles\n+        private boolean isRolesMappingHidden(String rolename) {\n+            final RoleMappingsV7 roleMapping = rolesMappingsV7SecurityDynamicConfiguration.getCEntry(rolename);\n+            return roleMapping!=null && roleMapping.isHidden();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2371, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}