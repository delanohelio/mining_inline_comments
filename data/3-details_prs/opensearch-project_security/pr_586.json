{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NzgyOTgw", "number": 586, "title": "Removing hidden/reserved roles added via rolesmapping", "bodyText": "Earlier the InternalUsers API was filtering out all hidden/reserved roles.\nWe will just restrict it to hidden/reserved roles associated via rolesmapping. This will ensure behaviour of rolesmapping and internalusers API is the same.\nIssue #, if available:\nDescription of changes:\nTested via unit tests and manually with opendistro-1.9.0.0 -\nRolesMapping API\n\n\nAdd a new user\ncurl -XPUT -H \"Content-type: application/json\"  --cacert root-ca.pem --key kirk-key.pem --cert kirk.pem -d \"{ \"password\": \\\u201dXXXX\"}\" https://localhost:9200/_opendistro/_security/api/internalusers/testuser\n\n\nAssociate with reserved rolesmapping - super admin (should pass)\n| => curl -XPUT -H \"Content-type: application/json\"  --cacert root-ca.pem --key kirk-key.pem --cert kirk.pem -d \"{ \"users\": [\"kibanaserver\", \"testuser\"], \"\\reserved\": true}\" https://localhost:9200/_opendistro/_security/api/rolesmapping/kibana_server\n{\"status\":\"OK\",\"message\":\"'kibana_server' updated.\"}\n\n\nAssociate with reserved rolesmapping - non-super admin (should fail)\n| =>\ncurl -XPUT -H \"Content-type: application/json\" -k -u admin:admin --cacert root-ca.pem -d \"{ \"users\": [\"kibanaserver\", \"testuser\"]}\" https://localhost:9200/_opendistro/_security/api/rolesmapping/kibana_server --key esnode-key.pem --cert esnode.pem\n\n\n{\"status\":\"FORBIDDEN\",\"message\":\"Resource 'kibana_server' is read-only.\"}____________________________________________________\nInternalUsers API\ncurl -k -XPUT --cacert root-ca.pem --key esnode-key.pem --cert esnode.pem -u admin:admin https://localhost:9200/_opendistro/_security/api/internalusers/testuser  -d \"{ \"password\": \"XXXXX\"}\" -H \"Content-type: application/json\"\n\nAssociate with reserved rolesmapping - non-super admin (should fail)\ncurl -k -XPUT --cacert root-ca.pem --key esnode-key.pem --cert esnode.pem -u admin:admin https://localhost:9200/_opendistro/_security/api/internalusers/testuser  -d \"{ \"password\": \"XXXXX\", \"opendistro_security_roles\": [\"kibana_server\"]}\" -H \"Content-type: application/json\"\n\n{\"status\":\"FORBIDDEN\",\"message\":\"Role 'kibana_server' is read-only.\"}_______________________________________________________________\n\nAssociate with reserved rolesmapping (superadmin) - pass\n\ncurl -k -XPUT --cacert root-ca.pem --key kirk-key.pem --cert kirk.pem -u admin:admin https://localhost:9200/_opendistro/_security/api/internalusers/testuser  -d \"{ \"password\": \"XXXXX\", \"opendistro_security_roles\": [\"kibana_server\"]}\" -H \"Content-type: application/json\"\n{\"status\":\"OK\",\"message\":\"'kibana_server' updated.\"}\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-26T17:50:09Z", "url": "https://github.com/opensearch-project/security/pull/586", "merged": true, "mergeCommit": {"oid": "4a6ed34b8788260403fe09ccd40c0d96136428d2"}, "closed": true, "closedAt": "2020-07-27T22:38:58Z", "author": {"login": "debjanibnrj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5EcKmgFqTQ1NTk0NDU3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5JnZ0gFqTQ1NjE4MDM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTQ0NTcy", "url": "https://github.com/opensearch-project/security/pull/586#pullrequestreview-455944572", "createdAt": "2020-07-27T16:29:51Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjoyOTo1MVrOG3qMcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNjoyOTo1MVrOG3qMcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE3Ng==", "bodyText": "Is this supposed to be True or False ?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461016176", "createdAt": "2020-07-27T16:29:51Z", "author": {"login": "dinusX"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/OpendistroSecurityRolesTests.java", "diffHunk": "@@ -79,11 +80,15 @@ public void testOpenDistroSecurityRoles() throws Exception {\n \t\tAssert.assertTrue(resc.getBody().contains(\"sr_user\"));\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr\"));\n \n-\t\t// Ensure hidden reserved and non-existent roles are not available\n+\t\t// Opendistro_security_roles cannot contain roles that don't exist.\n \t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_non_existent\"));\n-\t\tAssert.assertFalse(resc.getBody().contains(\"xyz_sr_hidden\"));\n+\n+\t\t// Opendistro_security_roles can contain reserved roles.\n \t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_reserved\"));\n \n+\t\t// Opendistro_security_roles cannot contain roles that are hidden in rolesmapping.yml.\n+\t\tAssert.assertTrue(resc.getBody().contains(\"xyz_sr_hidden\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTg2NzQ5", "url": "https://github.com/opensearch-project/security/pull/586#pullrequestreview-455986749", "createdAt": "2020-07-27T17:25:22Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyNToyMlrOG3sRVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0Njo1MlrOG3tBeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MDE5Ng==", "bodyText": "nit: use exists? same as original code?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461050196", "createdAt": "2020-07-27T17:25:22Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/InternalUsersApiAction.java", "diffHunk": "@@ -115,18 +115,24 @@ protected void handlePut(RestChannel channel, final RestRequest request, final C\n         final ObjectNode contentAsNode = (ObjectNode) content;\n         final SecurityJsonNode securityJsonNode = new SecurityJsonNode(contentAsNode);\n \n-        // Don't allow user to add hidden, reserved or non-existent role\n+        // Don't allow user to add hidden, reserved or non-existent rolesmapping\n         final List<String> opendistroSecurityRoles = securityJsonNode.get(\"opendistro_security_roles\").asList();\n         if (opendistroSecurityRoles != null) {\n             final SecurityDynamicConfiguration<?> rolesConfiguration = load(CType.ROLES, false);\n+            final SecurityDynamicConfiguration<?> rolesmappingConfiguration = load(CType.ROLESMAPPING, false);\n             for (final String role: opendistroSecurityRoles) {\n \n-                if (!rolesConfiguration.exists(role) || rolesConfiguration.isHidden(role)) {\n+                if (rolesConfiguration.getCEntry(role) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyMA==", "bodyText": "We can add the roles check here itself having the same definition as \"isHiddenOrNonExistent\" ?", "url": "https://github.com/opensearch-project/security/pull/586#discussion_r461062520", "createdAt": "2020-07-27T17:46:52Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -300,23 +307,23 @@ public String getHash(String user) {\n         public List<String> getOpenDistroSecurityRoles(String user) {\n             InternalUserV7 tmp = internalUserV7SecurityDynamicConfiguration.getCEntry(user);\n \n-            // Filtering out hidden and non-existent roles for existing users\n+            // Opendistro security roles should only contain roles that exist in the roles dynamic config.\n+            // We should filter out any roles that have hidden rolesmapping.\n             return tmp == null ? ImmutableList.of() :\n-                tmp.getOpendistro_security_roles().stream().filter(role -> !isHiddenOrNonExistent(role)).collect(ImmutableList.toImmutableList());\n+                tmp.getOpendistro_security_roles().stream().filter(role -> !isRolesMappingHidden(role) && rolesV7SecurityDynamicConfiguration.exists(role)).collect(ImmutableList.toImmutableList());\n         }\n \n-        // We will remove opendistro security mapping for roles that are hidden or non-existent in the roles configuration\n-        private boolean isHiddenOrNonExistent(String rolename) {\n-            final RoleV7 role = roleV7SecurityDynamicConfiguration.getCEntry(rolename);\n-            return role == null || role.isHidden();\n+        // Remove any hidden rolesmapping from the opendistro security roles\n+        private boolean isRolesMappingHidden(String rolename) {\n+            final RoleMappingsV7 roleMapping = rolesMappingsV7SecurityDynamicConfiguration.getCEntry(rolename);\n+            return roleMapping!=null && roleMapping.isHidden();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe", "author": {"user": {"login": "debjanibnrj", "name": "Debjani Banerjee"}}, "url": "https://github.com/opensearch-project/security/commit/6c1f002b25d77f2636c86b419dc4be7a00f889fe", "committedDate": "2020-07-27T18:24:47Z", "message": "Removing hidden/reserved roles added via rolesmapping\n\nEarlier the InternalUsers API was filtering out all hidden/reserved roles. We will just restrict it to hidden/reserved roles associated via rolesmapping. This will ensure behaviour of rolesmapping and internalusers API is the same."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe", "author": {"user": {"login": "debjanibnrj", "name": "Debjani Banerjee"}}, "url": "https://github.com/opensearch-project/security/commit/6c1f002b25d77f2636c86b419dc4be7a00f889fe", "committedDate": "2020-07-27T18:24:47Z", "message": "Removing hidden/reserved roles added via rolesmapping\n\nEarlier the InternalUsers API was filtering out all hidden/reserved roles. We will just restrict it to hidden/reserved roles associated via rolesmapping. This will ensure behaviour of rolesmapping and internalusers API is the same."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDI5NzM5", "url": "https://github.com/opensearch-project/security/pull/586#pullrequestreview-456029739", "createdAt": "2020-07-27T18:25:49Z", "commit": {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTgwMzk0", "url": "https://github.com/opensearch-project/security/pull/586#pullrequestreview-456180394", "createdAt": "2020-07-27T22:31:57Z", "commit": {"oid": "6c1f002b25d77f2636c86b419dc4be7a00f889fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2833, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}