{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4ODAyMzU3", "number": 690, "title": "Restrict configured indices access to adminDn only.", "bodyText": "Issue #, if available:\nhttps://github.com/opendistro-for-elasticsearch/security/issues/666\nDescription of changes:\nhttps://github.com/opendistro-for-elasticsearch/security/issues/666\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-03T18:15:06Z", "url": "https://github.com/opensearch-project/security/pull/690", "merged": true, "mergeCommit": {"oid": "d420f16ed1e37244e1d437d5f73740237c5ded8f"}, "closed": true, "closedAt": "2020-09-28T18:08:48Z", "author": {"login": "skkosuri-amzn"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFUrgsgH2gAyNDc4ODAyMzU3OjA2ZWM1NjQ5ZWQ0YmIyMzViNmVjNzc4YTZlZTQ3ODhhYTZjM2U5ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNXkf6AFqTQ5Nzc3NTExOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06ec5649ed4bb235b6ec778a6ee4788aa6c3e9e2", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/06ec5649ed4bb235b6ec778a6ee4788aa6c3e9e2", "committedDate": "2020-09-03T18:12:29Z", "message": "Restrict configured indices access to adminDn. Issue# 666"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/218cf6ba88d399237c96240f2189eaf60864d01a", "committedDate": "2020-09-04T15:44:23Z", "message": "allow request without user from plugin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDc2MDAz", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-487076003", "createdAt": "2020-09-11T19:39:57Z", "commit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxOTozOTo1N1rOHQrhqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowMDo1NVrOHQsKIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI1MjM5Mw==", "bodyText": "what about read?  indices:data/read*\nCan't we deny all using indices:data/* and indices:admin/*  and cluster:admin/snapshot/restore* ?\nSystem indices should not be accessed directly for any actions for nonAdminDN  (Super admin).", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r487252393", "createdAt": "2020-09-11T19:39:57Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/OpenDistroSystemIndexAccessEvaluator.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Portions Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.security.privileges;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.resolver.IndexResolverReplacer;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.RealtimeRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Blocks requests for below actions and configured index for all non adminDNs.\n+ */\n+public class OpenDistroSystemIndexAccessEvaluator {\n+\n+    private final Logger log = LogManager.getLogger(this.getClass());\n+\n+    private final AuditLog auditLog;\n+    private final WildcardMatcher indexMatcher;\n+    private final Boolean systemIndexEnabled;\n+    private final WildcardMatcher deniedActionMatcher;\n+\n+\n+    public OpenDistroSystemIndexAccessEvaluator(final Settings settings, AuditLog auditLog) {\n+        this.indexMatcher = WildcardMatcher.from(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_DEFAULT));\n+        this.systemIndexEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_DEFAULT);\n+        this.auditLog = auditLog;\n+\n+        final List<String> indexDeniedActionPatterns = new ArrayList<String>();\n+        indexDeniedActionPatterns.add(\"indices:data/write*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI1NDkxNA==", "bodyText": "Can you cover this in UT?", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r487254914", "createdAt": "2020-09-11T19:45:21Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/OpenDistroSystemIndexAccessEvaluator.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Portions Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.security.privileges;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.resolver.IndexResolverReplacer;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.RealtimeRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Blocks requests for below actions and configured index for all non adminDNs.\n+ */\n+public class OpenDistroSystemIndexAccessEvaluator {\n+\n+    private final Logger log = LogManager.getLogger(this.getClass());\n+\n+    private final AuditLog auditLog;\n+    private final WildcardMatcher indexMatcher;\n+    private final Boolean systemIndexEnabled;\n+    private final WildcardMatcher deniedActionMatcher;\n+\n+\n+    public OpenDistroSystemIndexAccessEvaluator(final Settings settings, AuditLog auditLog) {\n+        this.indexMatcher = WildcardMatcher.from(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_DEFAULT));\n+        this.systemIndexEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_DEFAULT);\n+        this.auditLog = auditLog;\n+\n+        final List<String> indexDeniedActionPatterns = new ArrayList<String>();\n+        indexDeniedActionPatterns.add(\"indices:data/write*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/delete*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/mapping/delete*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/mapping/put*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/freeze*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/settings/update*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/aliases\");\n+        indexDeniedActionPatterns.add(\"indices:admin/close*\");\n+        indexDeniedActionPatterns.add(\"cluster:admin/snapshot/restore*\");\n+        this.deniedActionMatcher = WildcardMatcher.from(indexDeniedActionPatterns);\n+    }\n+\n+    public PrivilegesEvaluatorResponse evaluate(final ActionRequest request, final Task task, final String action,\n+                                                final IndexResolverReplacer.Resolved requestedResolved, final PrivilegesEvaluatorResponse presponse, final boolean isAdminDn) {\n+\n+        if (!systemIndexEnabled) {\n+            return presponse;\n+        }\n+\n+        if (indexMatcher.matchAny(requestedResolved.getAllIndices()) && deniedActionMatcher.test(action) && !isAdminDn) {\n+            auditLog.logMissingPrivileges(action, request, task);\n+            log.warn(action + \" for '{}' index/indices is not allowed for a non adminDN user\", indexMatcher);\n+            presponse.allowed = false;\n+            return presponse.markComplete();\n+        }\n+\n+        if (requestedResolved.isLocalAll() && deniedActionMatcher.test(action) && !isAdminDn) {\n+            auditLog.logMissingPrivileges(action, request, task);\n+            log.warn(action + \" for '_all' indices is not allowed for a non adminDN user\");\n+            presponse.allowed = false;\n+            return presponse.markComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI1Nzc4NQ==", "bodyText": "Can we explore combining condition check on line#71 and line#78?", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r487257785", "createdAt": "2020-09-11T19:51:03Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/OpenDistroSystemIndexAccessEvaluator.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Portions Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.security.privileges;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.resolver.IndexResolverReplacer;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.RealtimeRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Blocks requests for below actions and configured index for all non adminDNs.\n+ */\n+public class OpenDistroSystemIndexAccessEvaluator {\n+\n+    private final Logger log = LogManager.getLogger(this.getClass());\n+\n+    private final AuditLog auditLog;\n+    private final WildcardMatcher indexMatcher;\n+    private final Boolean systemIndexEnabled;\n+    private final WildcardMatcher deniedActionMatcher;\n+\n+\n+    public OpenDistroSystemIndexAccessEvaluator(final Settings settings, AuditLog auditLog) {\n+        this.indexMatcher = WildcardMatcher.from(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_DEFAULT));\n+        this.systemIndexEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_KEY, ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_DEFAULT);\n+        this.auditLog = auditLog;\n+\n+        final List<String> indexDeniedActionPatterns = new ArrayList<String>();\n+        indexDeniedActionPatterns.add(\"indices:data/write*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/delete*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/mapping/delete*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/mapping/put*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/freeze*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/settings/update*\");\n+        indexDeniedActionPatterns.add(\"indices:admin/aliases\");\n+        indexDeniedActionPatterns.add(\"indices:admin/close*\");\n+        indexDeniedActionPatterns.add(\"cluster:admin/snapshot/restore*\");\n+        this.deniedActionMatcher = WildcardMatcher.from(indexDeniedActionPatterns);\n+    }\n+\n+    public PrivilegesEvaluatorResponse evaluate(final ActionRequest request, final Task task, final String action,\n+                                                final IndexResolverReplacer.Resolved requestedResolved, final PrivilegesEvaluatorResponse presponse, final boolean isAdminDn) {\n+\n+        if (!systemIndexEnabled) {\n+            return presponse;\n+        }\n+\n+        if (indexMatcher.matchAny(requestedResolved.getAllIndices()) && deniedActionMatcher.test(action) && !isAdminDn) {\n+            auditLog.logMissingPrivileges(action, request, task);\n+            log.warn(action + \" for '{}' index/indices is not allowed for a non adminDN user\", indexMatcher);\n+            presponse.allowed = false;\n+            return presponse.markComplete();\n+        }\n+\n+        if (requestedResolved.isLocalAll() && deniedActionMatcher.test(action) && !isAdminDn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2Mjc1Mg==", "bodyText": "why are we allowing admin to search system indices?\nSystem indices will be accessible through es APIs only for AdminDN.  All the other user including admin will be able to access index only through APIs defined by respective plugin.", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r487262752", "createdAt": "2020-09-11T20:00:55Z", "author": {"login": "hardik-k-shah"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/system_indices/SystemIndicesTests.java", "diffHunk": "@@ -0,0 +1,547 @@\n+/*\n+ * Portions Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.security.system_indices;\n+\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.DynamicSecurityConfig;\n+import com.amazon.opendistroforelasticsearch.security.test.SingleClusterTest;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.file.FileHelper;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.rest.RestHelper;\n+import org.apache.http.Header;\n+import org.apache.http.HttpStatus;\n+import org.elasticsearch.action.admin.cluster.repositories.put.PutRepositoryRequest;\n+import org.elasticsearch.action.admin.cluster.snapshots.create.CreateSnapshotRequest;\n+import org.elasticsearch.action.admin.indices.close.CloseIndexRequest;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.client.transport.TransportClient;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestStatus;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static junit.framework.TestCase.assertTrue;\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ *  Test for opendistro system indices, to restrict configured indices access to adminDn\n+ *  Refer:    \"opendistro_security.system_indices.enabled\"\n+ *            \"opendistro_security.system_indices.indices\";\n+ */\n+public class SystemIndicesTests extends SingleClusterTest {\n+\n+    private static final List<String> listOfIndexesToTest = Arrays.asList(\"config1\", \"config2\");\n+    private static final String matchAllQuery = \"{\\n\\\"query\\\": {\\\"match_all\\\": {}}}\";\n+    private static final String allAccessUser = \"admin_all_access\";\n+    private static final Header allAccessUserHeader = encodeBasicHeader(allAccessUser, allAccessUser);\n+    private static final String generalErrorMessage = String.format(\"no permissions for [] and User [name=%s, backend_roles=[], requestedTenant=null]\", allAccessUser);\n+\n+    private void setupSystemIndicesDisabledWithSsl() throws Exception {\n+\n+        Settings systemIndexSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_KEY, false)\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_KEY, listOfIndexesToTest)\n+                .put(\"opendistro_security.ssl.http.enabled\",true)\n+                .put(\"opendistro_security.ssl.http.keystore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"node-0-keystore.jks\"))\n+                .put(\"opendistro_security.ssl.http.truststore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"truststore.jks\"))\n+                .put(\"path.repo\", repositoryPath.getRoot().getAbsolutePath())\n+                .build();\n+        setup(Settings.EMPTY,\n+                new DynamicSecurityConfig()\n+                        .setConfig(\"config_system_indices.yml\")\n+                        .setSecurityRoles(\"roles_system_indices.yml\")\n+                        .setSecurityInternalUsers(\"internal_users_system_indices.yml\")\n+                        .setSecurityRolesMapping(\"roles_mapping_system_indices.yml\"),\n+                systemIndexSettings,\n+                true);\n+    }\n+\n+    private void setupSystemIndicesEnabledWithSsl() throws Exception {\n+\n+        Settings systemIndexSettings = Settings.builder()\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_ENABLED_KEY, true)\n+                .putList(ConfigConstants.OPENDISTRO_SECURITY_SYSTEM_INDICES_KEY, listOfIndexesToTest)\n+                .put(\"opendistro_security.ssl.http.enabled\",true)\n+                .put(\"opendistro_security.ssl.http.keystore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"node-0-keystore.jks\"))\n+                .put(\"opendistro_security.ssl.http.truststore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"truststore.jks\"))\n+                .put(\"path.repo\", repositoryPath.getRoot().getAbsolutePath())\n+                .build();\n+        setup(Settings.EMPTY,\n+                new DynamicSecurityConfig()\n+                        .setConfig(\"config_system_indices.yml\")\n+                        .setSecurityRoles(\"roles_system_indices.yml\")\n+                        .setSecurityInternalUsers(\"internal_users_system_indices.yml\")\n+                        .setSecurityRolesMapping(\"roles_mapping_system_indices.yml\"),\n+                systemIndexSettings,\n+                true);\n+    }\n+\n+    /**\n+     * Creates a set of test indices and indexes one document into each index.\n+     *\n+     * @throws Exception\n+     */\n+    private void createTestIndicesAndDocs() {\n+        try (TransportClient tc = getInternalTransportClient()) {\n+            for (String index : listOfIndexesToTest) {\n+                tc.admin().indices().create(new CreateIndexRequest(index)).actionGet();\n+                tc.index(new IndexRequest(index).setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE).id(\"document1\").source(\"{ \\\"foo\\\": \\\"bar\\\" }\", XContentType.JSON)).actionGet();\n+            }\n+        }\n+    }\n+\n+    private void createSnapshots() {\n+        try (TransportClient tc = getInternalTransportClient()) {\n+            for (String index : listOfIndexesToTest) {\n+                tc.admin().cluster().putRepository(new PutRepositoryRequest(index).type(\"fs\").settings(Settings.builder().put(\"location\", repositoryPath.getRoot().getAbsolutePath() + \"/\" + index))).actionGet();\n+                tc.admin().cluster().createSnapshot(new CreateSnapshotRequest(index, index + \"_1\").indices(index).includeGlobalState(true).waitForCompletion(true)).actionGet();\n+            }\n+        }\n+    }\n+\n+    private RestHelper keyStoreRestHelper() {\n+        RestHelper restHelper = restHelper();\n+        restHelper.keystore = \"kirk-keystore.jks\";\n+        restHelper.enableHTTPClientSSL = true;\n+        restHelper.trustHTTPServerCertificate = true;\n+        restHelper.sendAdminCertificate = true;\n+        return restHelper;\n+    }\n+\n+    private RestHelper sslRestHelper() {\n+        RestHelper restHelper = restHelper();\n+        restHelper.enableHTTPClientSSL = true;\n+        return restHelper;\n+    }\n+\n+    /***************************************************************************************************************************\n+     * Search api tests. Search is a special case.\n+     ***************************************************************************************************************************/\n+\n+    private void validateSearchResponse(RestHelper.HttpResponse response, int expectecdHits) throws IOException {\n+        assertEquals(RestStatus.OK.getStatus(), response.getStatusCode());\n+\n+        XContentParser xcp = XContentType.JSON.xContent().createParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE, response.getBody());\n+        SearchResponse searchResponse = SearchResponse.fromXContent(xcp);\n+        assertEquals(RestStatus.OK, searchResponse.status());\n+        assertEquals(expectecdHits, searchResponse.getHits().getHits().length);\n+        assertEquals(0, searchResponse.getFailedShards());\n+        assertEquals(5, searchResponse.getSuccessfulShards());\n+    }\n+\n+    @Test\n+    public void testSearchAsSuperAdmin() throws Exception {\n+        setupSystemIndicesDisabledWithSsl();\n+        createTestIndicesAndDocs();\n+        RestHelper restHelper = keyStoreRestHelper();\n+\n+        //search system indices\n+        for (String index : listOfIndexesToTest) {\n+            validateSearchResponse(restHelper.executePostRequest(index + \"/_search\", matchAllQuery), 1);\n+        }\n+\n+        //search all indices\n+        RestHelper.HttpResponse response = restHelper.executePostRequest(\"/_search\", matchAllQuery);\n+        assertEquals(RestStatus.OK.getStatus(), response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testSearchAsAdmin() throws Exception {\n+        setupSystemIndicesDisabledWithSsl();\n+        createTestIndicesAndDocs();\n+        RestHelper restHelper = sslRestHelper();\n+\n+        //search system indices\n+        for (String index : listOfIndexesToTest) {\n+            validateSearchResponse(restHelper.executePostRequest(index + \"/_search\", matchAllQuery, allAccessUserHeader), 1);\n+        }\n+\n+        //search all indices\n+        RestHelper.HttpResponse response = restHelper.executePostRequest(\"/_search\", matchAllQuery, allAccessUserHeader);\n+        assertEquals(RestStatus.OK.getStatus(), response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testSearchWithSystemIndicesAsSuperAdmin() throws Exception {\n+        setupSystemIndicesEnabledWithSsl();\n+        createTestIndicesAndDocs();\n+        RestHelper restHelper = keyStoreRestHelper();\n+\n+        //search system indices\n+        for (String index : listOfIndexesToTest) {\n+            validateSearchResponse(restHelper.executePostRequest(index + \"/_search\", matchAllQuery), 1);\n+        }\n+\n+        //search all indices\n+        RestHelper.HttpResponse response = restHelper.executePostRequest(\"/_search\", matchAllQuery);\n+        assertEquals(RestStatus.OK.getStatus(), response.getStatusCode());\n+    }\n+\n+\n+    @Test\n+    public void testSearchWithSystemIndicesAsAdmin() throws Exception {\n+        setupSystemIndicesEnabledWithSsl();\n+        createTestIndicesAndDocs();\n+        RestHelper restHelper = sslRestHelper();\n+\n+        for (String index : listOfIndexesToTest) {\n+            validateSearchResponse(restHelper.executePostRequest(index + \"/_search\", matchAllQuery, allAccessUserHeader), 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218cf6ba88d399237c96240f2189eaf60864d01a"}, "originalPosition": 210}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e0c41ff0669057f5e0bda656781ae298dbf6bd", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/e2e0c41ff0669057f5e0bda656781ae298dbf6bd", "committedDate": "2020-09-19T00:51:49Z", "message": "Merge branch 'master' into systemindices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/96237ca805661da7663e6bbeb42b7bb778217489", "committedDate": "2020-09-19T05:02:19Z", "message": "Merged system index evaluator to security index evaluator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjk3NDk0", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-493697494", "createdAt": "2020-09-22T17:36:57Z", "commit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzozNjo1N1rOHWFPEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0ODoxMVrOHWH1oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNjQ5OQ==", "bodyText": "# Enable system indices", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r492916499", "createdAt": "2020-09-22T17:36:57Z", "author": {"login": "hardik-k-shah"}, "path": "securityconfig/elasticsearch.yml.example", "diffHunk": "@@ -217,3 +217,9 @@ opendistro_security.audit.type: internal_elasticsearch\n # Specify a list of indices to mark as protected. These indices will only be visible / mutable by members of the above setting, in addition to needing permission to the index via a normal role.\n # opendistro_security.protected_indices.indices: ['.opendistro-alerting-config', '.opendistro-ism-*']\n \n+# System indices are similar to security index, except the contents are not encrypted.\n+# Indices configured as system indices can be accessed by only super-admin and no role will provide access to these indices.\n+# Enable protected indices", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkzMzk0MQ==", "bodyText": "should we add isSystemIndexRequest() check here?", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r492933941", "createdAt": "2020-09-22T18:06:13Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/OpenDistroSecurityIndexSearcherWrapper.java", "diffHunk": "@@ -87,7 +93,12 @@ public final DirectoryReader apply(DirectoryReader reader) throws IOException {\n         if (isSecurityIndexRequest() && !isAdminAuthenticatedOrInternalRequest()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1ODgzNg==", "bodyText": "make sure this is not by mistake..", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r492958836", "createdAt": "2020-09-22T18:47:42Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -36,7 +36,6 @@\n import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1OTEzNw==", "bodyText": "\"Portions\" is not required. Amazon has full copyright on this file.", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r492959137", "createdAt": "2020-09-22T18:48:11Z", "author": {"login": "hardik-k-shah"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/system_indices/SystemIndicesTests.java", "diffHunk": "@@ -0,0 +1,547 @@\n+/*\n+ * Portions Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9e9e1c7d142f3cee8f995861a43625acb9ddb0e", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/c9e9e1c7d142f3cee8f995861a43625acb9ddb0e", "committedDate": "2020-09-22T21:57:05Z", "message": "minor cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MDU1NTYx", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-496055561", "createdAt": "2020-09-25T01:37:49Z", "commit": {"oid": "c9e9e1c7d142f3cee8f995861a43625acb9ddb0e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMTozNzo0OVrOHXyA3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMTo0Mjo1MVrOHXyF3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5ODcxNw==", "bodyText": "IMO, the entire class needs to be modified. I'll do this in a follow up PR.", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r494698717", "createdAt": "2020-09-25T01:37:49Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/OpenDistroSecurityIndexSearcherWrapper.java", "diffHunk": "@@ -87,7 +93,12 @@ public final DirectoryReader apply(DirectoryReader reader) throws IOException {\n         if (isSecurityIndexRequest() && !isAdminAuthenticatedOrInternalRequest()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkzMzk0MQ=="}, "originalCommit": {"oid": "96237ca805661da7663e6bbeb42b7bb778217489"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5OTEyNQ==", "bodyText": "Boolean -> boolean", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r494699125", "createdAt": "2020-09-25T01:39:30Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/OpenDistroSecurityIndexAccessEvaluator.java", "diffHunk": "@@ -58,12 +58,18 @@\n     private final WildcardMatcher securityDeniedActionMatcher;\n     private final IndexResolverReplacer irr;\n     private final boolean filterSecurityIndex;\n-    \n+\n+    // for system-indices configuration\n+    private final WildcardMatcher systemIndexMatcher;\n+    private final Boolean systemIndexEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9e9e1c7d142f3cee8f995861a43625acb9ddb0e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5OTk5Nw==", "bodyText": "use Java logical &&, not bitwise &.", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r494699997", "createdAt": "2020-09-25T01:42:51Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/OpenDistroSecurityIndexAccessEvaluator.java", "diffHunk": "@@ -147,4 +153,8 @@ public PrivilegesEvaluatorResponse evaluate(final ActionRequest request, final T\n         }\n         return presponse;\n     }\n+\n+    private boolean matchAnySystemIndices(final Resolved requestedResolved){\n+        return systemIndexEnabled & systemIndexMatcher.matchAny(requestedResolved.getAllIndices());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9e9e1c7d142f3cee8f995861a43625acb9ddb0e"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70de716e6cd167cb7664a5ad6711c2cb61d43fb6", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/70de716e6cd167cb7664a5ad6711c2cb61d43fb6", "committedDate": "2020-09-25T14:44:53Z", "message": "Minor refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzY1MzQ2", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-496765346", "createdAt": "2020-09-25T19:48:43Z", "commit": {"oid": "70de716e6cd167cb7664a5ad6711c2cb61d43fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODg1Nzc2", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-496885776", "createdAt": "2020-09-25T21:56:35Z", "commit": {"oid": "70de716e6cd167cb7664a5ad6711c2cb61d43fb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMTo1NjozNVrOHYUinA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMTo1NjozNVrOHYUinA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI2NDQxMg==", "bodyText": "you also need to make change in demo installation script to reflect this configuration for ODFE docker.\nhttps://github.com/opendistro-for-elasticsearch/security/blob/master/tools/install_demo_configuration.sh.", "url": "https://github.com/opensearch-project/security/pull/690#discussion_r495264412", "createdAt": "2020-09-25T21:56:35Z", "author": {"login": "hardik-k-shah"}, "path": "securityconfig/elasticsearch.yml.example", "diffHunk": "@@ -217,3 +217,9 @@ opendistro_security.audit.type: internal_elasticsearch\n # Specify a list of indices to mark as protected. These indices will only be visible / mutable by members of the above setting, in addition to needing permission to the index via a normal role.\n # opendistro_security.protected_indices.indices: ['.opendistro-alerting-config', '.opendistro-ism-*']\n \n+# System indices are similar to security index, except the contents are not encrypted.\n+# Indices configured as system indices can be accessed by only super-admin and no role will provide access to these indices.\n+# Enable system indices\n+# opendistro_security.system_indices.enabled: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70de716e6cd167cb7664a5ad6711c2cb61d43fb6"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Nzc1MTE4", "url": "https://github.com/opensearch-project/security/pull/690#pullrequestreview-497775118", "createdAt": "2020-09-28T18:05:56Z", "commit": {"oid": "70de716e6cd167cb7664a5ad6711c2cb61d43fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2731, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}