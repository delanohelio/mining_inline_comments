{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MjQwNjcy", "number": 409, "title": "Hot reloading audit configuration", "bodyText": "Hot-reloading for audit configuration:\n\nUsers can hot reload audit configuration (audit config filter + compliance config)\nInitial configuration can be specified in securityconfig/audit.yml file\n\n_meta:\n  type: \"audit\"\n  config_version: 2\n\nconfig:\n  # turn on-off audit logging\n  enabled: true\n  audit:\n    # rest\n    enable_rest: true\n    disabled_rest_categories:\n      - AUTHENTICATED\n      - GRANTED_PRIVILEGES\n\n    # transport\n    enable_transport: true\n    disabled_transport_categories:\n      - AUTHENTICATED\n      - GRANTED_PRIVILEGES\n\n    # ignore\n    ignore_users:\n      - kibanaserver\n    ignore_requests: []\n\n    # verbose attributes\n    resolve_bulk_requests: false\n    log_request_body: true\n    resolve_indices: true\n    exclude_sensitive_headers: true\n\n  compliance:\n    # turn on-off compliance\n    enabled: true\n\n    # configs\n    internal_config: true\n    external_config: true\n\n    # compliance read\n    read_metadata_only: true\n    read_watched_fields: []\n    read_ignore_users: []\n\n    # compliance write\n    write_metadata_only: true\n    write_log_diffs: false\n    write_watched_indices: []\n    write_ignore_users: []\n\n\n\nUsers can use REST API for updating the config. Blocking updates to certain fields is not implemented yet in this PR\n\nGET _opendistro/_security/api/audit/\nPATCH _opendistro/_security/api/audit/\nPUT _opendistro/_security/api/audit/config\n\nClass components for reviewing:\n\nAuditConfig (underlying configuration class which is serialized / deserialized when written to or read from config). This can be V6, V7 (note: its same for audit)\nAuditModel and AuditModelImpl (interfaces with Audit class). Mainly used for interfacing v6, v7 .. versions\nAuditApiAction (rest handler for audit configuration)\nAuditValidator (basic validator for rest api)\nAuditLog and AuditLogImpl (subscribes to and listens for audit config changes). All other components fetch config from AuditLog\nAuditMigrator (packaged tool similar to securityAdmin to migrate elasticsearch.yml settings to audit.yml)\n\nOther main updates:\n\nUpdated all tests\nUpdated the supporting classes ie: SecurityAdmin.", "createdAt": "2020-04-23T22:55:19Z", "url": "https://github.com/opensearch-project/security/pull/409", "merged": true, "mergeCommit": {"oid": "bca8fe37b06eb8eb930321247619e5bd85b6c5c0"}, "closed": true, "closedAt": "2020-07-07T17:46:11Z", "author": {"login": "sujithvm"}, "timelineItems": {"totalCount": 76, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcalYPugFqTM5OTUzOTYxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyphsEAFqTQ0NDExNjI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTM5NjE0", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-399539614", "createdAt": "2020-04-23T23:13:47Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoxMzo0OFrOGK_02w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoyMDoyNlrOGK_-bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NDY2Nw==", "bodyText": "Moving environment and externalConfigLogged to AuditLogImpl to consolidate audit logging changes.\nWhen node starts, configuration may not be loaded yet to log external configuration and this OpenDistroSecurityPlugin must be subscribed as well. To avoid doing that, moved the functionality to AuditLogImpl", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414184667", "createdAt": "2020-04-23T23:13:48Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -188,9 +189,7 @@\n     private final boolean sslOnly;\n     private final List<String> demoCertHashes = new ArrayList<String>(3);\n     private volatile OpenDistroSecurityFilter odsf;\n-    private volatile Environment environment;\n     private volatile IndexResolverReplacer irr;\n-    private AtomicBoolean externalConfigLogged = new AtomicBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NTIzOA==", "bodyText": "complianceConfig may be null when IndexModule is called for .opendistro_security index.\nComplianceIndexingOperationListenerImpl checks for null hence removing this logic.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414185238", "createdAt": "2020-04-23T23:15:20Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -514,14 +513,8 @@ public void onIndexModule(IndexModule indexModule) {\n \n                 final ComplianceIndexingOperationListener ciol;\n \n-                assert complianceConfig!=null:\"compliance config must not be null here\";\n-                \n-                if(complianceConfig.writeHistoryEnabledForIndex(indexModule.getIndex().getName())) {\n-                    ciol = ReflectionHelper.instantiateComplianceListener(Objects.requireNonNull(auditLog));\n-                    indexModule.addIndexOperationListener(ciol);\n-                } else {\n-                    ciol = new ComplianceIndexingOperationListener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NjA0OA==", "bodyText": "Removing registration of audit logging params. These must be migrated to new audit.yml.\nCluster startup will fail if they are provided. This is desired as part of deprecating the old way of specifying config in elasticsearch.yml.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414186048", "createdAt": "2020-04-23T23:17:27Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -896,22 +892,6 @@ public Settings additionalSettings() {\n             settings.add(Setting.groupSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_ENDPOINTS + \".\",  Property.NodeScope));\n             settings.add(Setting.intSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_THREADPOOL_SIZE, 10, Property.NodeScope, Property.Filtered));\n             settings.add(Setting.intSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_THREADPOOL_MAX_QUEUE_LEN, 100*1000, Property.NodeScope, Property.Filtered));\n-            settings.add(Setting.boolSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true, Property.NodeScope, Property.Filtered));\n-            settings.add(Setting.boolSetting(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true, Property.NodeScope, Property.Filtered));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NjE0Nw==", "bodyText": "Subscribe for changes", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414186147", "createdAt": "2020-04-23T23:17:49Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditLogImpl.java", "diffHunk": "@@ -94,126 +97,155 @@ public void run() {\n \n \t}\n \n+\t@Subscribe\n+    public void onAuditModelChanged(final AuditModel auditModel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4Njk1Ng==", "bodyText": "These 3 params\n\nopendistrosecurityIndex\ntype\nindex\nare fed from elasticsearch.yml.\nThey are not reloadable but they are needed to determine if internal index is being updated or the current index is storing audit logs if destination is set to internal elasticsearch (ie: dont audit log an index used for storing audit logs) .", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414186956", "createdAt": "2020-04-23T23:19:57Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/compliance/ComplianceConfig.java", "diffHunk": "@@ -206,6 +204,36 @@ public static ComplianceConfig from(Settings settings) {\n                 index);\n     }\n \n+    /**\n+     * Create compliance configuration from auditModel\n+     * saltAsString - Read from settings. Not hot-reloaded. Used for anonymization of fields in FLS using consistent hash.\n+     * opendistrosecurityIndex - used to determine if internal index is written to or read from.\n+     * type - checks if log destination used is internal elasticsearch.\n+     * index - the index used for storing audit logs to avoid monitoring it.\n+     * @param auditModel audit model\n+     * @param settings settings\n+     * @return ComplianceConfig\n+     */\n+    public static ComplianceConfig from(AuditModel auditModel, Settings settings) {\n+        final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n+        final String type = settings.get(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_TYPE_DEFAULT, null);\n+        final String index = settings.get(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DEFAULT_PREFIX + ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ES_INDEX, \"'security-auditlog-'YYYY.MM.dd\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NzExOQ==", "bodyText": "Rest handler for audit configuration", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r414187119", "createdAt": "2020-04-23T23:20:26Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiAction.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AuditValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Rest handler for fetching and updating audit configuration.\n+ * Supported REST endpoints\n+ * GET _opendistro/_security/api/audit/\n+ * {\n+ *   \"config\" : {\n+ *     \"enable_rest\" : true,\n+ *     \"disabled_rest_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"enable_transport\" : true,\n+ *     \"disabled_transport_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"internal_config\" : true,\n+ *     \"external_config\" : true,\n+ *     \"resolve_bulk_requests\" : false,\n+ *     \"log_request_body\" : true,\n+ *     \"resolve_indices\" : true,\n+ *     \"exclude_sensitive_headers\" : true,\n+ *     \"ignore_users\" : [\n+ *       \"kibanaserver\"\n+ *     ],\n+ *     \"ignore_requests\" : [ ],\n+ *     \"immutable_indices\" : [ ],\n+ *     \"read_metadata_only\" : true,\n+ *     \"read_watched_fields\" : [ ],\n+ *     \"read_ignore_users\" : [ ],\n+ *     \"write_metadata_only\" : true,\n+ *     \"write_log_diffs\" : false,\n+ *     \"write_watched_indices\" : [ ],\n+ *     \"write_ignore_users\" : [ ],\n+ *     \"salt\" : \"aaaabbbbccccdddd\"\n+ *   }\n+ * }\n+ *\n+ * PUT _opendistro/_security/api/audit/config\n+ * {\n+ *     \"enable_rest\" : true,\n+ *     \"disabled_rest_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"enable_transport\" : true,\n+ *     \"disabled_transport_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"internal_config\" : true,\n+ *     \"external_config\" : true,\n+ *     \"resolve_bulk_requests\" : false,\n+ *     \"log_request_body\" : true,\n+ *     \"resolve_indices\" : true,\n+ *     \"exclude_sensitive_headers\" : true,\n+ *     \"ignore_users\" : [\n+ *       \"kibanaserver\"\n+ *     ],\n+ *     \"ignore_requests\" : [ ],\n+ *     \"immutable_indices\" : [ ],\n+ *     \"read_metadata_only\" : true,\n+ *     \"read_watched_fields\" : [ ],\n+ *     \"read_ignore_users\" : [ ],\n+ *     \"write_metadata_only\" : true,\n+ *     \"write_log_diffs\" : false,\n+ *     \"write_watched_indices\" : [ ],\n+ *     \"write_ignore_users\" : [ ],\n+ *     \"salt\" : \"aaaabbbbccccdddd\"\n+ *   }\n+ *\n+ * PATCH _opendistro/_security/api/audit/config\n+ * [{\"op\": \"replace\", \"path\": \"/config/enable_rest\", \"value\": \"true\"}]\n+ */\n+public class AuditApiAction extends PatchableResourceApiAction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDIzNDU1", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-400423455", "createdAt": "2020-04-25T19:17:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOToxNzoxM1rOGL5Qdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOToxNzoxM1rOGL5Qdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEyNTYyMw==", "bodyText": "Is there config_version 1?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r415125623", "createdAt": "2020-04-25T19:17:13Z", "author": {"login": "vrozov"}, "path": "securityconfig/audit.yml", "diffHunk": "@@ -0,0 +1,49 @@\n+_meta:\n+  type: \"audit\"\n+  config_version: 2", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDMzMDk3", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-400433097", "createdAt": "2020-04-25T21:31:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozMTowM1rOGL6pPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozMTowM1rOGL6pPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0ODM1MA==", "bodyText": "Is there a plan to backport the functionality to v6?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r415148350", "createdAt": "2020-04-25T21:31:03Z", "author": {"login": "vrozov"}, "path": "legacy/securityconfig_v6/audit.yml", "diffHunk": "@@ -0,0 +1,45 @@\n+config:", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDMzNjA4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-400433608", "createdAt": "2020-04-25T21:38:25Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozODoyNVrOGL6t7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozODoyNVrOGL6t7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTU0OA==", "bodyText": "What is the migration path from prior versions?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r415149548", "createdAt": "2020-04-25T21:38:25Z", "author": {"login": "vrozov"}, "path": "securityconfig/audit.yml", "diffHunk": "@@ -0,0 +1,49 @@\n+_meta:", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDM0MDQ2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-400434046", "createdAt": "2020-04-25T21:45:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo0NToyM1rOGL6yMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo0NToyM1rOGL6yMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MDY0Mg==", "bodyText": "Please clarify the object model. I don't see why it is necessary to introduce AuditModel interface with AuditModelImpl implementation that delegates everything to Audit.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r415150642", "createdAt": "2020-04-25T21:45:23Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/AuditModel.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzUwOTQy", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401350942", "createdAt": "2020-04-27T21:46:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo0NjozM1rOGM5HEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo0NjozM1rOGM5HEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3MTc5NQ==", "bodyText": "typo: \"at least\". Will it be better to use \"Salt must be 16 bytes long\". Note that 16 chars != 16 bytes.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416171795", "createdAt": "2020-04-27T21:46:33Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AbstractConfigurationValidator.java", "diffHunk": "@@ -282,9 +282,15 @@ private void addErrorMessage(final XContentBuilder builder, final String message\n     }\n \n     public static enum ErrorType {\n-        NONE(\"ok\"), INVALID_CONFIGURATION(\"Invalid configuration\"), INVALID_PASSWORD(\"Invalid password\"), WRONG_DATATYPE(\"Wrong datatype\"),\n-        BODY_NOT_PARSEABLE(\"Could not parse content of request.\"), PAYLOAD_NOT_ALLOWED(\"Request body not allowed for this action.\"),\n-        PAYLOAD_MANDATORY(\"Request body required for this action.\"), SECURITY_NOT_INITIALIZED(\"Security index not initialized\");\n+        NONE(\"ok\"),\n+        INVALID_CONFIGURATION(\"Invalid configuration\"),\n+        INVALID_PASSWORD(\"Invalid password\"),\n+        WRONG_DATATYPE(\"Wrong datatype\"),\n+        BODY_NOT_PARSEABLE(\"Could not parse content of request.\"),\n+        PAYLOAD_NOT_ALLOWED(\"Request body not allowed for this action.\"),\n+        PAYLOAD_MANDATORY(\"Request body required for this action.\"),\n+        SECURITY_NOT_INITIALIZED(\"Security index not initialized\"),\n+        INVALID_SALT(\"Salt must be atleast 16 chars long. If greater, only the first 16 bytes will used for salting.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzUzNjM0", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401353634", "createdAt": "2020-04-27T21:51:20Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1MToyMFrOGM5RNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1MToyMFrOGM5RNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3NDM4OQ==", "bodyText": "content length 1 is probably not valid, but content length 2 is probably not valid either, should it be this.content.length() > 0 to distinguish from not empty content?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416174389", "createdAt": "2020-04-27T21:51:20Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AuditValidator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.Audit;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.compress.NotXContentException;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AuditValidator extends AbstractConfigurationValidator {\n+\n+    private static final List<Tuple<String, DataType>> KEYS = ImmutableList.of(\n+            // rest\n+            new Tuple<>(Audit.Key.ENABLE_REST, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_REST_CATEGORIES, DataType.ARRAY),\n+\n+            // transport\n+            new Tuple<>(Audit.Key.ENABLE_TRANSPORT, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_TRANSPORT_CATEGORIES, DataType.ARRAY),\n+\n+            // attributes\n+            new Tuple<>(Audit.Key.RESOLVE_BULK_REQUESTS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.LOG_REQUEST_BODY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.RESOLVE_INDICES, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXCLUDE_SENSITIVE_HEADERS, DataType.BOOLEAN),\n+\n+            // config\n+            new Tuple<>(Audit.Key.INTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+\n+            // ignore\n+            new Tuple<>(Audit.Key.IGNORE_USERS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.IGNORE_REQUESTS, DataType.ARRAY),\n+\n+            // compliance read\n+            new Tuple<>(Audit.Key.READ_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.READ_WATCHED_FIELDS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.READ_IGNORE_USERS, DataType.ARRAY),\n+\n+            // compliance write\n+            new Tuple<>(Audit.Key.WRITE_LOG_DIFFS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_WATCHED_INDICES, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.WRITE_IGNORE_USERS, DataType.ARRAY),\n+\n+            // immutable\n+            new Tuple<>(Audit.Key.IMMUTABLE_INDICES, DataType.ARRAY),\n+\n+            // salt\n+            new Tuple<>(Audit.Key.SALT, DataType.STRING)\n+    );\n+\n+    public AuditValidator(final RestRequest request,\n+                          final BytesReference ref,\n+                          final Settings esSettings,\n+                          final Object... param) {\n+        super(request, ref, esSettings, param);\n+        KEYS.forEach(x -> allowedKeys.put(x.v1(), x.v2()));\n+    }\n+\n+    @Override\n+    public boolean validate() {\n+        if (!super.validate()) {\n+            return false;\n+        }\n+\n+        if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n+                && this.content != null\n+                && this.content.length() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzU1NDIw", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401355420", "createdAt": "2020-04-27T21:54:26Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1NDoyNlrOGM5XyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1NDoyNlrOGM5XyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3NjA3Mg==", "bodyText": "Use smart logging. Do you mean to log invalid content or exception? Exception will be logged anyway.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416176072", "createdAt": "2020-04-27T21:54:26Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AuditValidator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.Audit;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.compress.NotXContentException;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AuditValidator extends AbstractConfigurationValidator {\n+\n+    private static final List<Tuple<String, DataType>> KEYS = ImmutableList.of(\n+            // rest\n+            new Tuple<>(Audit.Key.ENABLE_REST, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_REST_CATEGORIES, DataType.ARRAY),\n+\n+            // transport\n+            new Tuple<>(Audit.Key.ENABLE_TRANSPORT, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_TRANSPORT_CATEGORIES, DataType.ARRAY),\n+\n+            // attributes\n+            new Tuple<>(Audit.Key.RESOLVE_BULK_REQUESTS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.LOG_REQUEST_BODY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.RESOLVE_INDICES, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXCLUDE_SENSITIVE_HEADERS, DataType.BOOLEAN),\n+\n+            // config\n+            new Tuple<>(Audit.Key.INTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+\n+            // ignore\n+            new Tuple<>(Audit.Key.IGNORE_USERS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.IGNORE_REQUESTS, DataType.ARRAY),\n+\n+            // compliance read\n+            new Tuple<>(Audit.Key.READ_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.READ_WATCHED_FIELDS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.READ_IGNORE_USERS, DataType.ARRAY),\n+\n+            // compliance write\n+            new Tuple<>(Audit.Key.WRITE_LOG_DIFFS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_WATCHED_INDICES, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.WRITE_IGNORE_USERS, DataType.ARRAY),\n+\n+            // immutable\n+            new Tuple<>(Audit.Key.IMMUTABLE_INDICES, DataType.ARRAY),\n+\n+            // salt\n+            new Tuple<>(Audit.Key.SALT, DataType.STRING)\n+    );\n+\n+    public AuditValidator(final RestRequest request,\n+                          final BytesReference ref,\n+                          final Settings esSettings,\n+                          final Object... param) {\n+        super(request, ref, esSettings, param);\n+        KEYS.forEach(x -> allowedKeys.put(x.v1(), x.v2()));\n+    }\n+\n+    @Override\n+    public boolean validate() {\n+        if (!super.validate()) {\n+            return false;\n+        }\n+\n+        if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n+                && this.content != null\n+                && this.content.length() > 1) {\n+            try {\n+                final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n+                if (contentAsMap != null) {\n+                    // validate the audit categories\n+                    if (!validateAuditCategories(contentAsMap)) {\n+                        this.errorType = ErrorType.BODY_NOT_PARSEABLE;\n+                        return false;\n+                    }\n+                    // validate salt\n+                    if (!validateSalt(contentAsMap)) {\n+                        this.errorType = ErrorType.INVALID_SALT;\n+                        return false;\n+                    }\n+                }\n+            } catch (NotXContentException e) {\n+                //this.content is not valid json/yaml\n+                log.error(\"Invalid xContent: \" + e, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzU3NTM5", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401357539", "createdAt": "2020-04-27T21:58:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1ODoxNFrOGM5frQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1ODoxNFrOGM5frQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3ODA5Mw==", "bodyText": "nit: consider using Java streams API.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416178093", "createdAt": "2020-04-27T21:58:14Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AuditValidator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.Audit;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.compress.NotXContentException;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AuditValidator extends AbstractConfigurationValidator {\n+\n+    private static final List<Tuple<String, DataType>> KEYS = ImmutableList.of(\n+            // rest\n+            new Tuple<>(Audit.Key.ENABLE_REST, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_REST_CATEGORIES, DataType.ARRAY),\n+\n+            // transport\n+            new Tuple<>(Audit.Key.ENABLE_TRANSPORT, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_TRANSPORT_CATEGORIES, DataType.ARRAY),\n+\n+            // attributes\n+            new Tuple<>(Audit.Key.RESOLVE_BULK_REQUESTS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.LOG_REQUEST_BODY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.RESOLVE_INDICES, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXCLUDE_SENSITIVE_HEADERS, DataType.BOOLEAN),\n+\n+            // config\n+            new Tuple<>(Audit.Key.INTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+\n+            // ignore\n+            new Tuple<>(Audit.Key.IGNORE_USERS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.IGNORE_REQUESTS, DataType.ARRAY),\n+\n+            // compliance read\n+            new Tuple<>(Audit.Key.READ_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.READ_WATCHED_FIELDS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.READ_IGNORE_USERS, DataType.ARRAY),\n+\n+            // compliance write\n+            new Tuple<>(Audit.Key.WRITE_LOG_DIFFS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_WATCHED_INDICES, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.WRITE_IGNORE_USERS, DataType.ARRAY),\n+\n+            // immutable\n+            new Tuple<>(Audit.Key.IMMUTABLE_INDICES, DataType.ARRAY),\n+\n+            // salt\n+            new Tuple<>(Audit.Key.SALT, DataType.STRING)\n+    );\n+\n+    public AuditValidator(final RestRequest request,\n+                          final BytesReference ref,\n+                          final Settings esSettings,\n+                          final Object... param) {\n+        super(request, ref, esSettings, param);\n+        KEYS.forEach(x -> allowedKeys.put(x.v1(), x.v2()));\n+    }\n+\n+    @Override\n+    public boolean validate() {\n+        if (!super.validate()) {\n+            return false;\n+        }\n+\n+        if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n+                && this.content != null\n+                && this.content.length() > 1) {\n+            try {\n+                final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n+                if (contentAsMap != null) {\n+                    // validate the audit categories\n+                    if (!validateAuditCategories(contentAsMap)) {\n+                        this.errorType = ErrorType.BODY_NOT_PARSEABLE;\n+                        return false;\n+                    }\n+                    // validate salt\n+                    if (!validateSalt(contentAsMap)) {\n+                        this.errorType = ErrorType.INVALID_SALT;\n+                        return false;\n+                    }\n+                }\n+            } catch (NotXContentException e) {\n+                //this.content is not valid json/yaml\n+                log.error(\"Invalid xContent: \" + e, e);\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private boolean validateAuditCategories(final Map<String, Object> contentAsMap) {\n+        for (String key: ImmutableList.of(Audit.Key.DISABLED_REST_CATEGORIES, Audit.Key.DISABLED_TRANSPORT_CATEGORIES)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzU3ODMz", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401357833", "createdAt": "2020-04-27T21:58:48Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1ODo0OFrOGM5g1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1ODo0OFrOGM5g1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3ODM5MA==", "bodyText": "Avoid double get()", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416178390", "createdAt": "2020-04-27T21:58:48Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AuditValidator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.Audit;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.compress.NotXContentException;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AuditValidator extends AbstractConfigurationValidator {\n+\n+    private static final List<Tuple<String, DataType>> KEYS = ImmutableList.of(\n+            // rest\n+            new Tuple<>(Audit.Key.ENABLE_REST, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_REST_CATEGORIES, DataType.ARRAY),\n+\n+            // transport\n+            new Tuple<>(Audit.Key.ENABLE_TRANSPORT, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_TRANSPORT_CATEGORIES, DataType.ARRAY),\n+\n+            // attributes\n+            new Tuple<>(Audit.Key.RESOLVE_BULK_REQUESTS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.LOG_REQUEST_BODY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.RESOLVE_INDICES, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXCLUDE_SENSITIVE_HEADERS, DataType.BOOLEAN),\n+\n+            // config\n+            new Tuple<>(Audit.Key.INTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+\n+            // ignore\n+            new Tuple<>(Audit.Key.IGNORE_USERS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.IGNORE_REQUESTS, DataType.ARRAY),\n+\n+            // compliance read\n+            new Tuple<>(Audit.Key.READ_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.READ_WATCHED_FIELDS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.READ_IGNORE_USERS, DataType.ARRAY),\n+\n+            // compliance write\n+            new Tuple<>(Audit.Key.WRITE_LOG_DIFFS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_WATCHED_INDICES, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.WRITE_IGNORE_USERS, DataType.ARRAY),\n+\n+            // immutable\n+            new Tuple<>(Audit.Key.IMMUTABLE_INDICES, DataType.ARRAY),\n+\n+            // salt\n+            new Tuple<>(Audit.Key.SALT, DataType.STRING)\n+    );\n+\n+    public AuditValidator(final RestRequest request,\n+                          final BytesReference ref,\n+                          final Settings esSettings,\n+                          final Object... param) {\n+        super(request, ref, esSettings, param);\n+        KEYS.forEach(x -> allowedKeys.put(x.v1(), x.v2()));\n+    }\n+\n+    @Override\n+    public boolean validate() {\n+        if (!super.validate()) {\n+            return false;\n+        }\n+\n+        if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n+                && this.content != null\n+                && this.content.length() > 1) {\n+            try {\n+                final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n+                if (contentAsMap != null) {\n+                    // validate the audit categories\n+                    if (!validateAuditCategories(contentAsMap)) {\n+                        this.errorType = ErrorType.BODY_NOT_PARSEABLE;\n+                        return false;\n+                    }\n+                    // validate salt\n+                    if (!validateSalt(contentAsMap)) {\n+                        this.errorType = ErrorType.INVALID_SALT;\n+                        return false;\n+                    }\n+                }\n+            } catch (NotXContentException e) {\n+                //this.content is not valid json/yaml\n+                log.error(\"Invalid xContent: \" + e, e);\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private boolean validateAuditCategories(final Map<String, Object> contentAsMap) {\n+        for (String key: ImmutableList.of(Audit.Key.DISABLED_REST_CATEGORIES, Audit.Key.DISABLED_TRANSPORT_CATEGORIES)) {\n+            try {\n+                if (contentAsMap.containsKey(key)) {\n+                    AuditCategory.parse((Collection<String>) contentAsMap.get(key));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzU3OTkw", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-401357990", "createdAt": "2020-04-27T21:59:05Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1OTowNVrOGM5hYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMTo1OTowNVrOGM5hYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE3ODUzMA==", "bodyText": "Avoid double get().", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r416178530", "createdAt": "2020-04-27T21:59:05Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/AuditValidator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.Audit;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.compress.NotXContentException;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AuditValidator extends AbstractConfigurationValidator {\n+\n+    private static final List<Tuple<String, DataType>> KEYS = ImmutableList.of(\n+            // rest\n+            new Tuple<>(Audit.Key.ENABLE_REST, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_REST_CATEGORIES, DataType.ARRAY),\n+\n+            // transport\n+            new Tuple<>(Audit.Key.ENABLE_TRANSPORT, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.DISABLED_TRANSPORT_CATEGORIES, DataType.ARRAY),\n+\n+            // attributes\n+            new Tuple<>(Audit.Key.RESOLVE_BULK_REQUESTS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.LOG_REQUEST_BODY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.RESOLVE_INDICES, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXCLUDE_SENSITIVE_HEADERS, DataType.BOOLEAN),\n+\n+            // config\n+            new Tuple<>(Audit.Key.INTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.EXTERNAL_CONFIG_ENABLED, DataType.BOOLEAN),\n+\n+            // ignore\n+            new Tuple<>(Audit.Key.IGNORE_USERS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.IGNORE_REQUESTS, DataType.ARRAY),\n+\n+            // compliance read\n+            new Tuple<>(Audit.Key.READ_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.READ_WATCHED_FIELDS, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.READ_IGNORE_USERS, DataType.ARRAY),\n+\n+            // compliance write\n+            new Tuple<>(Audit.Key.WRITE_LOG_DIFFS, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_METADATA_ONLY, DataType.BOOLEAN),\n+            new Tuple<>(Audit.Key.WRITE_WATCHED_INDICES, DataType.ARRAY),\n+            new Tuple<>(Audit.Key.WRITE_IGNORE_USERS, DataType.ARRAY),\n+\n+            // immutable\n+            new Tuple<>(Audit.Key.IMMUTABLE_INDICES, DataType.ARRAY),\n+\n+            // salt\n+            new Tuple<>(Audit.Key.SALT, DataType.STRING)\n+    );\n+\n+    public AuditValidator(final RestRequest request,\n+                          final BytesReference ref,\n+                          final Settings esSettings,\n+                          final Object... param) {\n+        super(request, ref, esSettings, param);\n+        KEYS.forEach(x -> allowedKeys.put(x.v1(), x.v2()));\n+    }\n+\n+    @Override\n+    public boolean validate() {\n+        if (!super.validate()) {\n+            return false;\n+        }\n+\n+        if ((request.method() == RestRequest.Method.PUT || request.method() == RestRequest.Method.PATCH)\n+                && this.content != null\n+                && this.content.length() > 1) {\n+            try {\n+                final Map<String, Object> contentAsMap = XContentHelper.convertToMap(this.content, false, XContentType.JSON).v2();\n+                if (contentAsMap != null) {\n+                    // validate the audit categories\n+                    if (!validateAuditCategories(contentAsMap)) {\n+                        this.errorType = ErrorType.BODY_NOT_PARSEABLE;\n+                        return false;\n+                    }\n+                    // validate salt\n+                    if (!validateSalt(contentAsMap)) {\n+                        this.errorType = ErrorType.INVALID_SALT;\n+                        return false;\n+                    }\n+                }\n+            } catch (NotXContentException e) {\n+                //this.content is not valid json/yaml\n+                log.error(\"Invalid xContent: \" + e, e);\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private boolean validateAuditCategories(final Map<String, Object> contentAsMap) {\n+        for (String key: ImmutableList.of(Audit.Key.DISABLED_REST_CATEGORIES, Audit.Key.DISABLED_TRANSPORT_CATEGORIES)) {\n+            try {\n+                if (contentAsMap.containsKey(key)) {\n+                    AuditCategory.parse((Collection<String>) contentAsMap.get(key));\n+                }\n+            } catch (Exception e) {\n+                log.error(\"Could not parse body of key {}\", key);\n+                return false;\n+            }\n+        }\n+        return true;\n+    }\n+\n+    private boolean validateSalt(final Map<String, Object> contentAsMap) {\n+        if (contentAsMap.containsKey(Audit.Key.SALT)) {\n+            final String salt = (String) contentAsMap.get(Audit.Key.SALT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b946897590572e73022766daca7b802ffa119e5", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/7b946897590572e73022766daca7b802ffa119e5", "committedDate": "2020-05-23T00:57:12Z", "message": "Code changes for Audit config hot reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "590ac469fe5a66fa2c4118debe5c23a7523b3e7a", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/590ac469fe5a66fa2c4118debe5c23a7523b3e7a", "committedDate": "2020-05-23T00:57:12Z", "message": "Test changes for Audit config hot reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8749ca8b16430f731785d2dd0384c37f8d2891e3", "author": {"user": {"login": "vrozov", "name": "Vlad Rozov"}}, "url": "https://github.com/opensearch-project/security/commit/8749ca8b16430f731785d2dd0384c37f8d2891e3", "committedDate": "2020-05-23T00:57:12Z", "message": "code review (#173)\n\n* code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ef6b5fa8117a66796dde9bc69417abc6dfb5b69", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/0ef6b5fa8117a66796dde9bc69417abc6dfb5b69", "committedDate": "2020-05-23T00:57:12Z", "message": "code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "690720596ae3c23d165dcf508e501d19d55a0bcc", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/690720596ae3c23d165dcf508e501d19d55a0bcc", "committedDate": "2020-05-23T00:57:12Z", "message": "Remove immutable indices and salt from config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d21542a1c7a760389de37717b802c6aed89b340", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/0d21542a1c7a760389de37717b802c6aed89b340", "committedDate": "2020-05-23T00:57:12Z", "message": "Separate out audit and compliance and use AuditConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "723878aa8c62e1b4fe03e1933adac3ccbcc59eb8", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/723878aa8c62e1b4fe03e1933adac3ccbcc59eb8", "committedDate": "2020-05-23T00:57:12Z", "message": "remove redundant read from settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81e73b48bb7c02cc70401cc7b96fa015c709b428", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/81e73b48bb7c02cc70401cc7b96fa015c709b428", "committedDate": "2020-05-23T00:57:12Z", "message": "Revert back the config loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383a2fdce6efc46a8de571b28ba8b1bb4201cfe1", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/383a2fdce6efc46a8de571b28ba8b1bb4201cfe1", "committedDate": "2020-05-23T00:57:12Z", "message": "Put audit config if absent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fa082bb4893c13a4c9b4175829d0c65b2a8cede", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/5fa082bb4893c13a4c9b4175829d0c65b2a8cede", "committedDate": "2020-05-23T00:57:12Z", "message": "add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3173edfc105488638ecfc668a5f7ffc7e786e281", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/3173edfc105488638ecfc668a5f7ffc7e786e281", "committedDate": "2020-05-23T00:57:12Z", "message": "add support for audit log enabled and compliance enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d97f203b261e2e3e2d41012f486fc2a818c0159e", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/d97f203b261e2e3e2d41012f486fc2a818c0159e", "committedDate": "2020-05-23T00:57:12Z", "message": "Convert read watch fields to mpa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0030d4a004daa508d50e294801eb5b22c4b9648a", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/0030d4a004daa508d50e294801eb5b22c4b9648a", "committedDate": "2020-05-23T00:57:12Z", "message": "migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23b978a7a04cade1afba557f38d2b6336d2cb779", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/23b978a7a04cade1afba557f38d2b6336d2cb779", "committedDate": "2020-05-23T00:57:12Z", "message": "Log deprecation warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/5a81a60cc05d37d92a965e8cb03a5214c10e03c1", "committedDate": "2020-05-23T00:57:12Z", "message": "remove unwanted diffs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODU5MDMw", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-432859030", "createdAt": "2020-06-18T00:17:48Z", "commit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoxNzo0OFrOGlbf6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoxNzo0OFrOGlbf6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMTAzNQ==", "bodyText": "Covered in #491", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r441901035", "createdAt": "2020-06-18T00:17:48Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -514,14 +511,8 @@ public void onIndexModule(IndexModule indexModule) {\n \n                 final ComplianceIndexingOperationListener ciol;\n \n-                assert complianceConfig!=null:\"compliance config must not be null here\";\n-                \n-                if(complianceConfig.writeHistoryEnabledForIndex(indexModule.getIndex().getName())) {\n-                    ciol = ReflectionHelper.instantiateComplianceListener(Objects.requireNonNull(auditLog));\n-                    indexModule.addIndexOperationListener(ciol);\n-                } else {\n-                    ciol = new ComplianceIndexingOperationListener();\n-                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODU5MTQ5", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-432859149", "createdAt": "2020-06-18T00:18:10Z", "commit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoxODoxMVrOGlbgVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDo0NzowNlrOGlb7tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMTE0Mg==", "bodyText": "Register on the event bus to listen on any audit config changes", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r441901142", "createdAt": "2020-06-18T00:18:11Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -787,6 +777,10 @@ public AsyncSender interceptSender(AsyncSender sender) {\n         dcf.registerDCFListener(irr);\n         dcf.registerDCFListener(xffResolver);\n         dcf.registerDCFListener(evaluator);\n+        if (!(auditLog instanceof NullAuditLog)) {\n+            // Don't register if advanced modules is disabled in which case auditlog is instance of NullAuditLog\n+            dcf.registerDCFListener(auditLog);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMTgzNA==", "bodyText": "Removed external config loading because when node starts, compliance config is not available YET (because it needs to fetch from index). Check in AuditLogImpl\nprotected void onComplianceConfigChanged(ComplianceConfig complianceConfig) {\n        this.complianceConfig = complianceConfig;\n        enableRoutes();\n        this.complianceConfig.log(log);\n        logExternalConfig();\n    }", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r441901834", "createdAt": "2020-06-18T00:21:11Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -1014,13 +1008,6 @@ public void onNodeStarted() {\n         }\n         final Set<ModuleInfo> securityModules = ReflectionHelper.getModulesLoaded();\n         log.info(\"{} Open Distro Security modules loaded so far: {}\", securityModules.size(), securityModules);\n-        if (auditLog != null) {\n-            final ComplianceConfig complianceConfig = auditLog.getComplianceConfig();\n-            if(complianceConfig != null && complianceConfig.isEnabled() && complianceConfig.shouldLogExternalConfig() && !externalConfigLogged.getAndSet(true)) {\n-                log.info(\"logging external config\");\n-                auditLog.logExternalConfig(settings, environment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwODE0OA==", "bodyText": "Hot-reloading for audit logging configuration in tests", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r441908148", "createdAt": "2020-06-18T00:47:06Z", "author": {"login": "sujithvm"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/AbstractAuditlogiUnitTest.java", "diffHunk": "@@ -40,9 +41,19 @@ protected String getResourceFolder() {\n     }\n \n     protected final void setup(Settings additionalSettings) throws Exception {\n-        final Settings nodeSettings = defaultNodeSettings(additionalSettings);\n+        final Settings.Builder auditSettingsBuilder = Settings.builder();\n+        final Settings.Builder additionalSettingsBuilder = Settings.builder().put(additionalSettings);\n+        AuditConfig.DEPRECATED_KEYS.forEach(key -> {\n+            if (additionalSettingsBuilder.get(key) != null) {\n+                auditSettingsBuilder.put(key, additionalSettings.get(key));\n+                additionalSettingsBuilder.remove(key);\n+            }\n+        });\n+\n+        final Settings nodeSettings = defaultNodeSettings(additionalSettingsBuilder.build());\n         setup(Settings.EMPTY, new DynamicSecurityConfig(), nodeSettings, init);\n         rh = restHelper();\n+        updateAuditConfig(auditSettingsBuilder.build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a81a60cc05d37d92a965e8cb03a5214c10e03c1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fff72d074682f64d30ed3b30f5368c12b86e90d", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/8fff72d074682f64d30ed3b30f5368c12b86e90d", "committedDate": "2020-06-25T09:26:58Z", "message": "Merge remote-tracking branch 'upstream/master' into auditlog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/4f73103e842c3fc94bc00dfb07a7042f78ade09f", "committedDate": "2020-06-25T17:07:24Z", "message": "Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTU1MjA0", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-437955204", "createdAt": "2020-06-26T01:10:35Z", "commit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMToxMDozNlrOGpQqzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMToxMDozNlrOGpQqzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxNzkwMg==", "bodyText": "audit.yml.example?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r445917902", "createdAt": "2020-06-26T01:10:36Z", "author": {"login": "vrozov"}, "path": "legacy/securityconfig_v6/audit.yml", "diffHunk": "@@ -0,0 +1,46 @@\n+config:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTU4OTA4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-437958908", "createdAt": "2020-06-26T01:24:28Z", "commit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMToyNDoyOFrOGpQ3ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMToyNDoyOFrOGpQ3ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyMTE4Mg==", "bodyText": "Add new line", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r445921182", "createdAt": "2020-06-26T01:24:28Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/routing/AuditMessageRouter.java", "diffHunk": "@@ -41,138 +45,148 @@\n \n public class AuditMessageRouter {\n \n-\tprotected final Logger log = LogManager.getLogger(this.getClass());\n-\tfinal AuditLogSink defaultSink;\n-\tfinal Map<AuditCategory, List<AuditLogSink>> categorySinks = new EnumMap<>(AuditCategory.class);\n-\tfinal SinkProvider sinkProvider;\n-\tfinal AsyncStoragePool storagePool;\n-\tprivate boolean hasMultipleEndpoints;\n-\tprivate boolean areRoutesEnabled;\n-\n-\tpublic AuditMessageRouter(final Settings settings, final Client clientProvider, ThreadPool threadPool, final Path configPath) {\n-\t\tthis.sinkProvider = new SinkProvider(settings, clientProvider, threadPool, configPath);\n-\t\tthis.storagePool = new AsyncStoragePool(ThreadPoolConfig.getConfig(settings));\n-\n-\t\t// get the default sink\n-\t\tthis.defaultSink = sinkProvider.getDefaultSink();\n-\t\tif (defaultSink == null) {\n-\t\t\tlog.warn(\"No default storage available, audit log may not work properly. Please check configuration.\");\n-\t\t}\n-\t}\n-\n-\tpublic boolean isEnabled() {\n-\t\treturn defaultSink != null;\n-\t}\n-\n-\tpublic final void route(final AuditMessage msg) {\n-\t\tif (!isEnabled()) {\n-\t\t\t// should not happen since we check in AuditLogImpl, so this is just a safeguard\n-\t\t\tlog.error(\"#route(AuditMessage) called but message router is disabled\");\n-\t\t\treturn;\n-\t\t}\n-\t\t// if we do not run the compliance features or no extended configuration is present, only log to default.\n-\t\tif (!areRoutesEnabled || !hasMultipleEndpoints) {\n-\t\t\tstore(defaultSink, msg);\n-\t\t} else {\n-\t\t\tfor (AuditLogSink sink : categorySinks.get(msg.getCategory())) {\n-\t\t\t\tstore(sink, msg);\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\tpublic final void close() {\n-\t\t// shutdown storage pool\n-\t\tstoragePool.close();\n-\t\t// close default\n-\t\tsinkProvider.close();\n-\t}\n-\n-\tprotected final void close(List<AuditLogSink> sinks) {\n-\t\tfor (AuditLogSink sink : sinks) {\n-\t\t\ttry {\n-\t\t\t\tlog.info(\"Closing {}\", sink.getClass().getSimpleName());\n-\t\t\t\tsink.close();\n-\t\t\t} catch (Exception ex) {\n-\t\t\t\tlog.info(\"Could not close delegate '{}' due to '{}'\", sink.getClass().getSimpleName(), ex.getMessage());\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\tpublic final boolean enableRoutes(Settings settings) {\n-\t\tcheckState(isEnabled(), \"AuditMessageRouter is disabled\");\n-\t\tareRoutesEnabled = true;\n-\t\tMap<String, Object> routesConfiguration = Utils.convertJsonToxToStructuredMap(settings.getAsSettings(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_ROUTES));\n-\t\tif (!routesConfiguration.isEmpty()) {\n-\t\t\thasMultipleEndpoints = true;\n-\t\t\t// first set up all configured routes. We do it this way so category names are case insensitive\n-\t\t\t// and we can warn if a non-existing category has been detected.\n-\t\t\tfor (Entry<String, Object> routesEntry : routesConfiguration.entrySet()) {\n-\t\t\t\tlog.trace(\"Setting up routes for endpoint {}, configuraton is {}\", routesEntry.getKey(), routesEntry.getValue());\n-\t\t\t\tString categoryName = routesEntry.getKey();\n-\t\t\t\ttry {\n-\t\t\t\t\tAuditCategory category = AuditCategory.valueOf(categoryName.toUpperCase());\n-\t\t\t\t\t// warn for duplicate definitions\n-\t\t\t\t\tif (categorySinks.get(category) != null) {\n-\t\t\t\t\t\tlog.warn(\"Duplicate routing configuration detected for category {}, skipping.\", category);\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t\tList<AuditLogSink> sinksForCategory = createSinksForCategory(category, settings.getAsSettings(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_ROUTES + \".\" + categoryName));\n-\t\t\t\t\tif (!sinksForCategory.isEmpty()) {\n-\t\t\t\t\t\tcategorySinks.put(category, sinksForCategory);\n-\t\t\t\t\t\tif(log.isTraceEnabled()) {\n-\t\t\t\t\t\t\tlog.debug(\"Created {} endpoints for category {}\", sinksForCategory.size(), category );\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tlog.debug(\"No valid endpoints found for category {} adding only default.\", category );\n-\n-\t\t\t\t\t}\n-\t\t\t\t} catch (Exception e ) {\n-\t\t\t\t\tlog.error(\"Invalid category '{}' found in routing configuration. Must be one of: {}\", categoryName, AuditCategory.values());\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\t// for all non-configured categories we automatically set up the default endpoint\n-\t\t\tfor(AuditCategory category : AuditCategory.values()) {\n-\t\t\t\tif (!categorySinks.containsKey(category)) {\n-\t\t\t\t\tif (log.isDebugEnabled()) {\n-\t\t\t\t\t\tlog.debug(\"No endpoint configured for category {}, adding default endpoint\", category);\n-\t\t\t\t\t}\n-\t\t\t\t\tcategorySinks.put(category, Collections.singletonList(defaultSink));\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\treturn hasMultipleEndpoints;\n-\t}\n-\n-\tprivate final List<AuditLogSink> createSinksForCategory(AuditCategory category, Settings configuration) {\n-\t\tList<AuditLogSink> sinksForCategory = new LinkedList<>();\n-\t\tList<String> sinks = configuration.getAsList(\"endpoints\");\n-\t\tif (sinks == null || sinks.isEmpty()) {\n-\t\t\tlog.error(\"No endpoints configured for category {}\", category);\n-\t\t\treturn sinksForCategory;\n-\t\t}\n-\t\tfor (String sinkName : sinks) {\n-\t\t\tAuditLogSink sink = sinkProvider.getSink(sinkName);\n-\t\t\tif (sink != null && !sinksForCategory.contains(sink)) {\n-\t\t\t\tsinksForCategory.add(sink);\n-\t\t\t} else {\n-\t\t\t\tlog.error(\"Configured endpoint '{}' not available\", sinkName);\n-\t\t\t}\n-\t\t}\n-\t\treturn sinksForCategory;\n-\t}\n-\n-\tprivate final void store(AuditLogSink sink, AuditMessage msg) {\n-\t\tif (sink.isHandlingBackpressure()) {\n-\t\t\tsink.store(msg);\n-\t\t\tif (log.isTraceEnabled()) {\n-\t\t\t\tlog.trace(\"stored on sink {} synchronously\", sink.getClass().getSimpleName());\n-\t\t\t}\n-\t\t} else {\n-\t\t\tstoragePool.submit(msg, sink);\n-\t\t\tif (log.isTraceEnabled()) {\n-\t\t\t\tlog.trace(\"will store on sink {} asynchronously\", sink.getClass().getSimpleName());\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-}\n+    protected final Logger log = LogManager.getLogger(this.getClass());\n+    final AuditLogSink defaultSink;\n+    volatile Map<AuditCategory, List<AuditLogSink>> categorySinks;\n+    final SinkProvider sinkProvider;\n+    final AsyncStoragePool storagePool;\n+\n+    public AuditMessageRouter(final Settings settings, final Client clientProvider, ThreadPool threadPool, final Path configPath) {\n+        this(\n+            new SinkProvider(settings, clientProvider, threadPool, configPath),\n+            new AsyncStoragePool(ThreadPoolConfig.getConfig(settings))\n+        );\n+    }\n+\n+    @VisibleForTesting\n+    public AuditMessageRouter(SinkProvider sinkProvider, AsyncStoragePool storagePool) {\n+        this.sinkProvider = sinkProvider;\n+        this.storagePool = storagePool;\n+\n+        // get the default sink\n+        this.defaultSink = sinkProvider.getDefaultSink();\n+        if (defaultSink == null) {\n+            log.warn(\"No default storage available, audit log may not work properly. Please check configuration.\");\n+        }\n+    }\n+\n+    public boolean isEnabled() {\n+        return defaultSink != null;\n+    }\n+\n+    public final void route(final AuditMessage msg) {\n+        if (!isEnabled()) {\n+            // should not happen since we check in AuditLogImpl, so this is just a safeguard\n+            log.error(\"#route(AuditMessage) called but message router is disabled\");\n+            return;\n+        }\n+        checkState(categorySinks != null, \"categorySinks is null, prior to route() call enableRoutes().\");\n+        // if we do not run the compliance features or no extended configuration is present, only log to default.\n+        List<AuditLogSink> auditLogSinks = categorySinks.get(msg.getCategory());\n+        if (auditLogSinks == null) {\n+            store(defaultSink, msg);\n+        } else {\n+            auditLogSinks.stream().forEach(sink -> store(sink, msg));\n+        }\n+    }\n+\n+    public final void close() {\n+        // shutdown storage pool\n+        storagePool.close();\n+        // close default\n+        sinkProvider.close();\n+    }\n+\n+    protected final void close(List<AuditLogSink> sinks) {\n+        for (AuditLogSink sink : sinks) {\n+            try {\n+                log.info(\"Closing {}\", sink.getClass().getSimpleName());\n+                sink.close();\n+            } catch (Exception ex) {\n+                log.info(\"Could not close delegate '{}' due to '{}'\", sink.getClass().getSimpleName(), ex.getMessage());\n+            }\n+        }\n+    }\n+\n+    public final void enableRoutes(Settings settings) {\n+        checkState(isEnabled(), \"AuditMessageRouter is disabled\");\n+        if (categorySinks != null) {\n+            return;\n+        }\n+        Map<String, Object> routesConfiguration = Utils.convertJsonToxToStructuredMap(settings.getAsSettings(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_ROUTES));\n+        EnumSet<AuditCategory> presentAuditCategory = EnumSet.noneOf(AuditCategory.class);\n+        categorySinks = routesConfiguration.entrySet().stream()\n+            .peek(entry -> log.trace(\"Setting up routes for endpoint {}, configuration is {}\", entry.getKey(), entry.getValue()))\n+            .map(entry -> {\n+                String categoryName = entry.getKey();\n+                try {\n+                    // first set up all configured routes. We do it this way so category names are case insensitive\n+                    // and we can warn if a non-existing category has been detected.\n+                    AuditCategory auditCategory = AuditCategory.valueOf(categoryName.toUpperCase());\n+                    return Maps.immutableEntry(auditCategory, createSinksForCategory(auditCategory, (Map<String, List<String>>)entry.getValue()));\n+                } catch (IllegalArgumentException e) {\n+                    log.error(\"Invalid category '{}' found in routing configuration. Must be one of: {}\", categoryName, AuditCategory.values());\n+                    return null;\n+                }\n+            })\n+            .filter(entry -> {\n+                if (entry != null) {\n+                    AuditCategory category = entry.getKey();\n+                    List<AuditLogSink> auditLogSinks = entry.getValue();\n+                    if (auditLogSinks.isEmpty()) {\n+                        log.debug(\"No valid endpoints found for category {}.\", category);\n+                        return false;\n+                    }\n+                    if (presentAuditCategory.add(category)) {\n+                        log.debug(\"Created {} endpoints for category {}\", auditLogSinks.size(), category);\n+                        return true;\n+                    }\n+                    log.warn(\"Duplicate routing configuration {} detected for category {}, skipping.\", auditLogSinks, category);\n+                }\n+                return false;\n+            })\n+            .collect(\n+                Maps.toImmutableEnumMap(\n+                    Map.Entry::getKey,\n+                    Map.Entry::getValue\n+                )\n+            );\n+\n+        // for all non-configured categories we automatically set up the default endpoint\n+        log.warn(\"No endpoint configured for categories {}, using default endpoint\", EnumSet.complementOf(presentAuditCategory));\n+    }\n+\n+    private final List<AuditLogSink> createSinksForCategory(AuditCategory category, Map<String, List<String>> configuration) {\n+        List<AuditLogSink> sinksForCategory = new LinkedList<>();\n+        List<String> sinks = configuration.get(\"endpoints\");\n+        if (sinks != null && !sinks.isEmpty()) {\n+            for (String sinkName : sinks) {\n+                AuditLogSink sink = sinkProvider.getSink(sinkName);\n+                if (sink != null && !sinksForCategory.contains(sink)) {\n+                    sinksForCategory.add(sink);\n+                } else {\n+                    log.error(\"Configured endpoint '{}' not available\", sinkName);\n+                }\n+            }\n+        }\n+        if (sinksForCategory.isEmpty()) {\n+            log.error(\"No endpoints configured for category {}\", category);\n+        }\n+        return sinksForCategory;\n+    }\n+\n+    private final void store(AuditLogSink sink, AuditMessage msg) {\n+        if (sink.isHandlingBackpressure()) {\n+            sink.store(msg);\n+            if (log.isTraceEnabled()) {\n+                log.trace(\"stored on sink {} synchronously\", sink.getClass().getSimpleName());\n+            }\n+        } else {\n+            storagePool.submit(msg, sink);\n+            if (log.isTraceEnabled()) {\n+                log.trace(\"will store on sink {} asynchronously\", sink.getClass().getSimpleName());\n+            }\n+        }\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "originalPosition": 301}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTg2MTEy", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-437986112", "createdAt": "2020-06-26T03:06:04Z", "commit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMzowNjowNFrOGpSSRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMzowNjowNFrOGpSSRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk0NDM4OQ==", "bodyText": "undo the change", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r445944389", "createdAt": "2020-06-26T03:06:04Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/compliance/ComplianceConfig.java", "diffHunk": "@@ -388,4 +381,4 @@ public boolean readHistoryEnabledForField(String index, String field) {\n         }\n         return matcher.test(field);\n     }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f73103e842c3fc94bc00dfb07a7042f78ade09f"}, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497b5c6678b47aad8f633ebc1e07b215c9dc1626", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/497b5c6678b47aad8f633ebc1e07b215c9dc1626", "committedDate": "2020-06-29T16:34:37Z", "message": "Code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/0428f4e7cccd5a45593d185f723a226d0e575683", "committedDate": "2020-06-29T21:39:08Z", "message": "Merge remote-tracking branch 'upstream/master' into auditlog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTU1NjY4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439555668", "createdAt": "2020-06-29T22:52:49Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjo1Mjo0OVrOGqlSBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjo1Mjo0OVrOGqlSBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwNDE5OA==", "bodyText": "Is this change necessary?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447304198", "createdAt": "2020-06-29T22:52:49Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/TracingTests.java", "diffHunk": "@@ -49,15 +50,21 @@ public void testHTTPTrace() throws Exception {\n \n         final Settings settings = Settings.builder()\n                 .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_TYPE_DEFAULT, \"debug\")\n-                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS, \"*\")\n-                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_WATCHED_INDICES, \"*\")\n-                .put(\"opendistro_security.audit.resolve_bulk_requests\", true)\n                 .put(\"opendistro_security.audit.config.log4j.logger_name\", \"opendistro_security_action_trace\")\n                 .put(\"opendistro_security.audit.config.log4j.level\", \"TRACE\")\n                 .build();\n \n         setup(Settings.EMPTY, new DynamicSecurityConfig(), settings, true, ClusterConfiguration.DEFAULT);\n \n+        Settings auditSettings = Settings.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTYzODk4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439563898", "createdAt": "2020-06-29T23:14:55Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzoxNDo1NVrOGqluwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzoxNDo1NVrOGqluwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxMTU1Mw==", "bodyText": "file mask should be the same as other .sh files.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447311553", "createdAt": "2020-06-29T23:14:55Z", "author": {"login": "vrozov"}, "path": "tools/audit_config_migrater.sh", "diffHunk": "@@ -0,0 +1,26 @@\n+#!/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTY0NjY2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439564666", "createdAt": "2020-06-29T23:17:06Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzoxNzowNlrOGqlxYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzoxNzowNlrOGqlxYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxMjIyNw==", "bodyText": "Is this change necessary?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447312227", "createdAt": "2020-06-29T23:17:06Z", "author": {"login": "vrozov"}, "path": "src/test/resources/nodes_dn.yml", "diffHunk": "@@ -0,0 +1,4 @@\n+---", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTcyMzEx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439572311", "createdAt": "2020-06-29T23:38:15Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzozODoxNVrOGqmNJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMzozODoxNVrOGqmNJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMxOTMzNQ==", "bodyText": "nit: static", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447319335", "createdAt": "2020-06-29T23:38:15Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/test/DynamicSecurityConfig.java", "diffHunk": "@@ -50,6 +50,7 @@\n     private String securityInternalUsers = \"internal_users.yml\";\n     private String securityActionGroups = \"action_groups.yml\";\n     private String securityNodesDn = \"nodes_dn.yml\";\n+    private String securityAudit = \"audit.yml\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTgwNzk2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439580796", "createdAt": "2020-06-30T00:03:14Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDowMzoxNFrOGqmtfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDowMzoxNFrOGqmtfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyNzYxMg==", "bodyText": "Why is it OK to use this file?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447327612", "createdAt": "2020-06-30T00:03:14Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/AbstractAuditlogiUnitTest.java", "diffHunk": "@@ -105,9 +116,22 @@ protected boolean validateJson(final String json) {\n \n     protected AuditMessageRouter createMessageRouterComplianceEnabled(Settings settings) {\n         AuditMessageRouter router = new AuditMessageRouter(settings, null, null, null);\n-        if (router.isEnabled()) {\n-            router.enableRoutes(settings);\n-        }\n+        router.enableRoutes(settings);\n         return router;\n     }\n+\n+    protected void updateAuditConfig(final Settings settings) throws Exception {\n+        updateAuditConfig(AuditTestUtils.createAuditPayload(settings));\n+    }\n+\n+    protected void updateAuditConfig(final String payload) throws Exception {\n+        final boolean sendAdminCertificate = rh.sendAdminCertificate;\n+        final String keystore = rh.keystore;\n+        rh.sendAdminCertificate = true;\n+        rh.keystore = \"auditlog/kirk-keystore.jks\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTg2OTk1", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439586995", "createdAt": "2020-06-30T00:22:37Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDoyMjozN1rOGqnGfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDoyMjozN1rOGqnGfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzNDAxNQ==", "bodyText": "nit: add new line", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447334015", "createdAt": "2020-06-30T00:22:37Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;\n+        @JsonProperty(value = Key.INTERNAL_CONFIG_ENABLED)\n+        private boolean internalConfigEnabled = true;\n+        @JsonProperty(value = Key.EXTERNAL_CONFIG_ENABLED)\n+        private boolean externalConfigEnabled = false;\n+        @JsonProperty(value = Key.READ_METADATA_ONLY)\n+        private boolean readMetadataOnly = true;\n+        @JsonProperty(value = Key.READ_WATCHED_FIELDS)\n+        private Map<String, Set<String>> readWatchedFields = Collections.emptyMap();\n+        @JsonProperty(value = Key.READ_IGNORE_USERS)\n+        private Set<String> readIgnoreUsers = Collections.emptySet();\n+        @JsonProperty(value = Key.WRITE_METADATA_ONLY)\n+        private boolean writeMetadataOnly = true;\n+        @JsonProperty(value = Key.WRITE_LOG_DIFFS)\n+        private boolean writeLogDiffs = false;\n+        @JsonProperty(value = Key.WRITE_WATCHED_INDICES)\n+        private List<String> writeWatchedIndices = Collections.emptyList();\n+        @JsonProperty(value = Key.WRITE_IGNORE_USERS)\n+        private Set<String> writeIgnoreUsers = Collections.emptySet();\n+\n+        /**\n+         * Checks if compliance auditing is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isComplianceEnabled() {\n+            return complianceEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit compliance events\n+         * @param complianceEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setComplianceEnabled(boolean complianceEnabled) {\n+            this.complianceEnabled = complianceEnabled;\n+        }\n+\n+        /**\n+         * Check if auditing of internal opendistro security index is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isInternalConfigEnabled() {\n+            return internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit internal opendistro security index\n+         * @param internalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setInternalConfigEnabled(boolean internalConfigEnabled) {\n+            this.internalConfigEnabled = internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if auditing of external configuration files is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isExternalConfigEnabled() {\n+            return externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit external configuration files\n+         * @param externalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setExternalConfigEnabled(boolean externalConfigEnabled) {\n+            this.externalConfigEnabled = externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc read requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isReadMetadataOnly() {\n+            return readMetadataOnly;\n+        }\n+\n+        /**\n+         * Set if only metadata or field names are to be logged for doc read requests\n+         * @param readMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setReadMetadataOnly(boolean readMetadataOnly) {\n+            this.readMetadataOnly = readMetadataOnly;\n+        }\n+\n+        /**\n+         * Get list of fields to watch for, in a document in an index\n+         * @return index name mapped to a set of fields\n+         */\n+        @JsonIgnore\n+        public Map<String, Set<String>> getReadWatchedFields() {\n+            return readWatchedFields;\n+        }\n+\n+        /**\n+         * Set list of fields to watch for, in a document in an index\n+         * @param readWatchedFields index name mapped to a set of fields\n+         */\n+        @JsonSetter(value = Key.READ_WATCHED_FIELDS, nulls = Nulls.AS_EMPTY)\n+        public void setReadWatchedFields(Map<String, Set<String>> readWatchedFields) {\n+            if (readWatchedFields != null) {\n+                this.readWatchedFields = readWatchedFields;\n+            } else {\n+                this.readWatchedFields = Collections.emptyMap();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc read requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getReadIgnoreUsers() {\n+            return readIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc read requests\n+         * @param readIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.READ_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setReadIgnoreUsers(Set<String> readIgnoreUsers) {\n+            if (readIgnoreUsers != null) {\n+                this.readIgnoreUsers = readIgnoreUsers;\n+            } else {\n+                this.readIgnoreUsers = Collections.emptySet();\n+            }\n         }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteMetadataOnly() {\n+            return writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Set whether to log only metadata for doc write requests\n+         * @param writeMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteMetadataOnly(boolean writeMetadataOnly) {\n+            this.writeMetadataOnly = writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Checks if only diffs are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteLogDiffs() {\n+            return writeLogDiffs;\n+        }\n+\n+        /**\n+         * Set whether to log only diffs for doc write requests\n+         * @param writeLogDiffs true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteLogDiffs(boolean writeLogDiffs) {\n+            this.writeLogDiffs = writeLogDiffs;\n+        }\n+\n+        /**\n+         * Get list of indices to watch for doc write requests\n+         * @return indices\n+         */\n+        @JsonIgnore\n+        public List<String> getWriteWatchedIndices() {\n+            return writeWatchedIndices;\n+        }\n+\n+        /**\n+         * Set indices to watch for doc write requests\n+         * @param writeWatchedIndices indices\n+         */\n+        @JsonSetter(value = Key.WRITE_WATCHED_INDICES, nulls = Nulls.AS_EMPTY)\n+        public void setWriteWatchedIndices(List<String> writeWatchedIndices) {\n+            if (writeWatchedIndices != null) {\n+                this.writeWatchedIndices = writeWatchedIndices;\n+            } else {\n+                this.writeWatchedIndices = Collections.emptyList();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc write requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getWriteIgnoreUsers() {\n+            return writeIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc write requests\n+         * @param writeIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.WRITE_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setWriteIgnoreUsers(Set<String> writeIgnoreUsers) {\n+            if (writeIgnoreUsers != null) {\n+                this.writeIgnoreUsers = writeIgnoreUsers;\n+            } else {\n+                this.readIgnoreUsers = Collections.emptySet();\n+            }\n+        }\n+    }\n+\n+    public static class Key {\n+        public static final String ENABLED = \"enabled\";\n+        public static final String AUDIT = \"audit\";\n+        public static final String COMPLIANCE = \"compliance\";\n+        public static final String ENABLE_REST = \"enable_rest\";\n+        public static final String DISABLED_REST_CATEGORIES = \"disabled_rest_categories\";\n+        public static final String ENABLE_TRANSPORT = \"enable_transport\";\n+        public static final String DISABLED_TRANSPORT_CATEGORIES = \"disabled_transport_categories\";\n+        public static final String INTERNAL_CONFIG_ENABLED = \"internal_config\";\n+        public static final String EXTERNAL_CONFIG_ENABLED = \"external_config\";\n+        public static final String RESOLVE_BULK_REQUESTS = \"resolve_bulk_requests\";\n+        public static final String LOG_REQUEST_BODY = \"log_request_body\";\n+        public static final String RESOLVE_INDICES = \"resolve_indices\";\n+        public static final String EXCLUDE_SENSITIVE_HEADERS = \"exclude_sensitive_headers\";\n+        public static final String IGNORE_USERS = \"ignore_users\";\n+        public static final String IGNORE_REQUESTS = \"ignore_requests\";\n+        public static final String READ_METADATA_ONLY = \"read_metadata_only\";\n+        public static final String READ_WATCHED_FIELDS = \"read_watched_fields\";\n+        public static final String READ_IGNORE_USERS = \"read_ignore_users\";\n+        public static final String WRITE_METADATA_ONLY = \"write_metadata_only\";\n+        public static final String WRITE_LOG_DIFFS = \"write_log_diffs\";\n+        public static final String WRITE_WATCHED_INDICES = \"write_watched_indices\";\n+        public static final String WRITE_IGNORE_USERS = \"write_ignore_users\";\n+    }\n+\n+    private static final List<String> DEFAULT_IGNORED_USERS_LIST = ImmutableList.copyOf(DEFAULT_IGNORED_USERS);\n+    private static final List<String> DEFAULT_DISABLED_CATEGORIES_LIST = DEFAULT_DISABLED_CATEGORIES.stream().map(Enum::name).collect(Collectors.toList());\n+\n+    /**\n+     * Generate audit logging configuration from settings defined in elasticsearch.yml\n+     * @param settings settings\n+     * @return audit configuration filter\n+     */\n+    public static AuditConfig from(Settings settings) {\n+        final AuditConfig auditConfig = new AuditConfig();\n+        final Filter audit = new Filter();\n+        final Compliance compliance = new Compliance();\n+        audit.setRestApiAuditEnabled(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true));\n+        audit.setTransportApiAuditEnabled(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true));\n+        audit.setResolveBulkRequests(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false));\n+        audit.setLogRequestBody(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true));\n+        audit.setResolveIndices(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true));\n+        audit.setExcludeSensitiveHeaders(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true));\n+\n+        audit.setDisabledRestCategories(AuditCategory.parse(getSettingAsSet(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES_LIST,\n+                true)));\n+\n+        audit.setDisabledTransportCategories(AuditCategory.parse(getSettingAsSet(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+                DEFAULT_DISABLED_CATEGORIES_LIST,\n+                true)));\n+\n+        audit.setIgnoreUsers(getSettingAsSet(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS_LIST,\n+                false));\n+\n+        audit.setIgnoreRequests(ImmutableSet.copyOf(settings.getAsList(\n+                ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+                Collections.emptyList())));\n+\n+        compliance.setExternalConfigEnabled(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_EXTERNAL_CONFIG_ENABLED, false));\n+        compliance.setInternalConfigEnabled(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_INTERNAL_CONFIG_ENABLED, false));\n+        compliance.setReadMetadataOnly(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_METADATA_ONLY, false));\n+        compliance.setWriteMetadataOnly(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_METADATA_ONLY, false));\n+        compliance.setWriteLogDiffs(settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_LOG_DIFFS, false));\n+\n+        final List<String> setReadWatchedFieldsList = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS,\n+                Collections.emptyList(), false);\n+        //opendistro_security.compliance.pii_fields:\n+        //  - indexpattern,fieldpattern,fieldpattern,....\n+        Map<String, Set<String>> readEnabledFields = setReadWatchedFieldsList.stream()\n+                .map(watchedReadField -> watchedReadField.split(\",\"))\n+                .filter(split -> split.length != 0 && !Strings.isNullOrEmpty(split[0]))\n+                .collect(Collectors.toMap(\n+                        split -> split[0],\n+                        split -> split.length == 1 ?\n+                                Collections.singleton(\"*\") : Arrays.stream(split).skip(1).collect(Collectors.toSet())\n+                ));\n+        compliance.setReadWatchedFields(readEnabledFields);\n+\n+        compliance.setWriteWatchedIndices(settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_WATCHED_INDICES, Collections.emptyList()));\n+        compliance.setReadIgnoreUsers(getSettingAsSet(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS_LIST,\n+                false));\n+        compliance.setWriteIgnoreUsers(getSettingAsSet(\n+                settings,\n+                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+                DEFAULT_IGNORED_USERS_LIST,\n+                false));\n+        auditConfig.setFilter(audit);\n+        auditConfig.setCompliance(compliance);\n+        return auditConfig;\n     }\n \n-    public static Set<String> getSettingAsSet(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n+    private static Set<String> getSettingAsSet(final Settings settings, final String key, final List<String> defaultList, final boolean ignoreCaseForNone) {\n         final List<String> list = settings.getAsList(key, defaultList);\n         if (list.size() == 1 && \"NONE\".equals(ignoreCaseForNone? list.get(0).toUpperCase() : list.get(0))) {\n             return Collections.emptySet();\n         }\n         return ImmutableSet.copyOf(list);\n     }\n-}\n+\n+    /**\n+     * List of keys that are deprecated\n+     */\n+    public static final List<String> DEPRECATED_KEYS = ImmutableList.of(\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_INTERNAL_CONFIG_ENABLED,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_EXTERNAL_CONFIG_ENABLED,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_METADATA_ONLY,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_METADATA_ONLY,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_LOG_DIFFS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_WATCHED_INDICES\n+    );\n+\n+    public static Set<String> getDeprecatedKeys(final Settings settings) {\n+        return AuditConfig.DEPRECATED_KEYS\n+                .stream()\n+                .filter(settings::hasValue)\n+                .collect(Collectors.toSet());\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 881}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTk0MDA4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439594008", "createdAt": "2020-06-30T00:45:38Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0NTozOVrOGqnioQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo0NTozOVrOGqnioQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0MTIxNw==", "bodyText": "This constructor should take configCompliance and store it as a member variable instead of copying each individual value.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447341217", "createdAt": "2020-06-30T00:45:39Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/compliance/ComplianceConfig.java", "diffHunk": "@@ -162,38 +158,35 @@ public void log(Logger logger) {\n      * @return compliance configuration\n      */\n     public static ComplianceConfig from(Settings settings) {\n-        final boolean logExternalConfig = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_EXTERNAL_CONFIG_ENABLED, false);\n-        final boolean logInternalConfig = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_INTERNAL_CONFIG_ENABLED, false);\n-        final boolean logReadMetadataOnly = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_METADATA_ONLY, false);\n-        final boolean logWriteMetadataOnly = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_METADATA_ONLY, false);\n-        final boolean logDiffsForWrite = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_LOG_DIFFS, false);\n-        final List<String> watchedReadFields = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS,\n-                Collections.emptyList(), false);\n-        final List<String> watchedWriteIndices = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_WATCHED_INDICES, Collections.emptyList());\n+        final AuditConfig.Compliance compliance = AuditConfig.from(settings).getCompliance();\n+        return from(compliance, settings);\n+    }\n+\n+    /**\n+     * Create compliance configuration from audit\n+     * opendistrosecurityIndex - used to determine if internal index is written to or read from.\n+     * type - checks if log destination used is internal elasticsearch.\n+     * index - the index used for storing audit logs to avoid monitoring it.\n+     * @param configCompliance configCompliance\n+     * @param settings settings\n+     * @return ComplianceConfig\n+     */\n+    public static ComplianceConfig from(AuditConfig.Compliance configCompliance, Settings settings) {\n         final String opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n         final String type = settings.get(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_TYPE_DEFAULT, null);\n         final String index = settings.get(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DEFAULT_PREFIX + ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ES_INDEX, \"'security-auditlog-'YYYY.MM.dd\");\n-        final Set<String> ignoredComplianceUsersForRead = AuditConfig.getSettingAsSet(\n-                settings,\n-                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n-                AuditConfig.DEFAULT_IGNORED_USERS,\n-                false);\n-        final Set<String> ignoredComplianceUsersForWrite = AuditConfig.getSettingAsSet(\n-                settings,\n-                ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n-                AuditConfig.DEFAULT_IGNORED_USERS,\n-                false);\n \n         return new ComplianceConfig(\n-                logExternalConfig,\n-                logInternalConfig,\n-                logReadMetadataOnly,\n-                watchedReadFields,\n-                ignoredComplianceUsersForRead,\n-                logWriteMetadataOnly,\n-                logDiffsForWrite,\n-                watchedWriteIndices,\n-                ignoredComplianceUsersForWrite,\n+                configCompliance.isComplianceEnabled(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTk1Nzky", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439595792", "createdAt": "2020-06-30T00:51:44Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1MTo0NFrOGqnpZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1MTo0NFrOGqnpZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0Mjk0OQ==", "bodyText": "IMO, it will be better to move those strings to Filter or Compliance classes instead of sharing them in a single class. It is OK to do this in a follow up PR.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447342949", "createdAt": "2020-06-30T00:51:44Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;\n+        @JsonProperty(value = Key.INTERNAL_CONFIG_ENABLED)\n+        private boolean internalConfigEnabled = true;\n+        @JsonProperty(value = Key.EXTERNAL_CONFIG_ENABLED)\n+        private boolean externalConfigEnabled = false;\n+        @JsonProperty(value = Key.READ_METADATA_ONLY)\n+        private boolean readMetadataOnly = true;\n+        @JsonProperty(value = Key.READ_WATCHED_FIELDS)\n+        private Map<String, Set<String>> readWatchedFields = Collections.emptyMap();\n+        @JsonProperty(value = Key.READ_IGNORE_USERS)\n+        private Set<String> readIgnoreUsers = Collections.emptySet();\n+        @JsonProperty(value = Key.WRITE_METADATA_ONLY)\n+        private boolean writeMetadataOnly = true;\n+        @JsonProperty(value = Key.WRITE_LOG_DIFFS)\n+        private boolean writeLogDiffs = false;\n+        @JsonProperty(value = Key.WRITE_WATCHED_INDICES)\n+        private List<String> writeWatchedIndices = Collections.emptyList();\n+        @JsonProperty(value = Key.WRITE_IGNORE_USERS)\n+        private Set<String> writeIgnoreUsers = Collections.emptySet();\n+\n+        /**\n+         * Checks if compliance auditing is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isComplianceEnabled() {\n+            return complianceEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit compliance events\n+         * @param complianceEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setComplianceEnabled(boolean complianceEnabled) {\n+            this.complianceEnabled = complianceEnabled;\n+        }\n+\n+        /**\n+         * Check if auditing of internal opendistro security index is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isInternalConfigEnabled() {\n+            return internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit internal opendistro security index\n+         * @param internalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setInternalConfigEnabled(boolean internalConfigEnabled) {\n+            this.internalConfigEnabled = internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if auditing of external configuration files is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isExternalConfigEnabled() {\n+            return externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit external configuration files\n+         * @param externalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setExternalConfigEnabled(boolean externalConfigEnabled) {\n+            this.externalConfigEnabled = externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc read requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isReadMetadataOnly() {\n+            return readMetadataOnly;\n+        }\n+\n+        /**\n+         * Set if only metadata or field names are to be logged for doc read requests\n+         * @param readMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setReadMetadataOnly(boolean readMetadataOnly) {\n+            this.readMetadataOnly = readMetadataOnly;\n+        }\n+\n+        /**\n+         * Get list of fields to watch for, in a document in an index\n+         * @return index name mapped to a set of fields\n+         */\n+        @JsonIgnore\n+        public Map<String, Set<String>> getReadWatchedFields() {\n+            return readWatchedFields;\n+        }\n+\n+        /**\n+         * Set list of fields to watch for, in a document in an index\n+         * @param readWatchedFields index name mapped to a set of fields\n+         */\n+        @JsonSetter(value = Key.READ_WATCHED_FIELDS, nulls = Nulls.AS_EMPTY)\n+        public void setReadWatchedFields(Map<String, Set<String>> readWatchedFields) {\n+            if (readWatchedFields != null) {\n+                this.readWatchedFields = readWatchedFields;\n+            } else {\n+                this.readWatchedFields = Collections.emptyMap();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc read requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getReadIgnoreUsers() {\n+            return readIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc read requests\n+         * @param readIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.READ_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setReadIgnoreUsers(Set<String> readIgnoreUsers) {\n+            if (readIgnoreUsers != null) {\n+                this.readIgnoreUsers = readIgnoreUsers;\n+            } else {\n+                this.readIgnoreUsers = Collections.emptySet();\n+            }\n         }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteMetadataOnly() {\n+            return writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Set whether to log only metadata for doc write requests\n+         * @param writeMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteMetadataOnly(boolean writeMetadataOnly) {\n+            this.writeMetadataOnly = writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Checks if only diffs are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteLogDiffs() {\n+            return writeLogDiffs;\n+        }\n+\n+        /**\n+         * Set whether to log only diffs for doc write requests\n+         * @param writeLogDiffs true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteLogDiffs(boolean writeLogDiffs) {\n+            this.writeLogDiffs = writeLogDiffs;\n+        }\n+\n+        /**\n+         * Get list of indices to watch for doc write requests\n+         * @return indices\n+         */\n+        @JsonIgnore\n+        public List<String> getWriteWatchedIndices() {\n+            return writeWatchedIndices;\n+        }\n+\n+        /**\n+         * Set indices to watch for doc write requests\n+         * @param writeWatchedIndices indices\n+         */\n+        @JsonSetter(value = Key.WRITE_WATCHED_INDICES, nulls = Nulls.AS_EMPTY)\n+        public void setWriteWatchedIndices(List<String> writeWatchedIndices) {\n+            if (writeWatchedIndices != null) {\n+                this.writeWatchedIndices = writeWatchedIndices;\n+            } else {\n+                this.writeWatchedIndices = Collections.emptyList();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc write requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getWriteIgnoreUsers() {\n+            return writeIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc write requests\n+         * @param writeIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.WRITE_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setWriteIgnoreUsers(Set<String> writeIgnoreUsers) {\n+            if (writeIgnoreUsers != null) {\n+                this.writeIgnoreUsers = writeIgnoreUsers;\n+            } else {\n+                this.readIgnoreUsers = Collections.emptySet();\n+            }\n+        }\n+    }\n+\n+    public static class Key {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 738}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/7bd495a1919dc2216a66f408b3f10af40a1c717c", "committedDate": "2020-06-30T01:03:42Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjA4OTgy", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439608982", "createdAt": "2020-06-30T01:34:35Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozNDozNVrOGqoaIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozNDozNVrOGqoaIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NTQyNw==", "bodyText": "How is it enforced that isAuditConfigDocPresentInIndex is initialized before isAuditConfigDocPresentInIndex() is called?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447355427", "createdAt": "2020-06-30T01:34:35Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationLoaderSecurity7.java", "diffHunk": "@@ -84,6 +87,14 @@\n         log.debug(\"Index is: {}\", securityIndex);\n     }\n \n+    /**\n+     * Checks if audit config doc is present in security index\n+     * @return true/false\n+     */\n+    boolean isAuditConfigDocPresentInIndex() {\n+        return isAuditConfigDocPresentInIndex.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjEwMjYw", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439610260", "createdAt": "2020-06-30T01:38:35Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozODozNVrOGqoe3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozODozNVrOGqoe3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NjYzOA==", "bodyText": "What is the final agreement on the case where audit entries are present both in the index and elasticsearch.yml?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447356638", "createdAt": "2020-06-30T01:38:35Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java", "diffHunk": "@@ -195,6 +204,21 @@ public void run() {\n                         }\n                     }\n \n+                    final Set<String> deprecatedAuditKeysInSettings = AuditConfig.getDeprecatedKeys(settings);\n+                    if (!deprecatedAuditKeysInSettings.isEmpty()) {\n+                        LOGGER.warn(\"Following keys {} are deprecated in elasticsearch settings. They will be removed in plugin v2.0.0.0\", deprecatedAuditKeysInSettings);\n+                    }\n+                    final boolean isAuditConfigDocPresentInIndex = cl.isAuditConfigDocPresentInIndex();\n+                    if (isAuditConfigDocPresentInIndex) {\n+                        if (!deprecatedAuditKeysInSettings.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjEwNDEx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439610411", "createdAt": "2020-06-30T01:39:00Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozOTowMFrOGqofVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTozOTowMFrOGqofVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1Njc1Ng==", "bodyText": "nit: add new line", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447356756", "createdAt": "2020-06-30T01:39:00Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java", "diffHunk": "@@ -377,4 +405,4 @@ private static String formatDate(long date) {\n     public static int getDefaultConfigVersion() {\n         return ConfigurationRepository.DEFAULT_CONFIG_VERSION;\n     }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjE1Njg4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439615688", "createdAt": "2020-06-30T01:56:04Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTo1NjowNVrOGqoyfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTo1NjowNVrOGqoyfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2MTY2MQ==", "bodyText": "Use RESOURCE_NAME", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447361661", "createdAt": "2020-06-30T01:56:05Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiAction.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AuditValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+/**\n+ * Rest handler for fetching and updating audit configuration.\n+ * Supported REST endpoints\n+ * GET _opendistro/_security/api/audit/\n+ * {\n+ *   \"config\" : {\n+ *     \"audit\" : {\n+ *       \"enable_rest\" : true,\n+ *       \"disabled_rest_categories\" : [\n+ *         \"GRANTED_PRIVILEGES\",\n+ *         \"SSL_EXCEPTION\"\n+ *       ],\n+ *       \"enable_transport\" : true,\n+ *       \"disabled_transport_categories\" : [\n+ *         \"GRANTED_PRIVILEGES\",\n+ *         \"AUTHENTICATED\"\n+ *       ],\n+ *       \"resolve_bulk_requests\" : false,\n+ *       \"log_request_body\" : true,\n+ *       \"resolve_indices\" : true,\n+ *       \"exclude_sensitive_headers\" : true,\n+ *       \"ignore_users\" : [\n+ *         \"kibanaserver\"\n+ *       ],\n+ *       \"ignore_requests\" : [ ]\n+ *     },\n+ *     \"compliance\" : {\n+ *       \"internal_config\" : true,\n+ *       \"external_config\" : true,\n+ *       \"read_metadata_only\" : true,\n+ *       \"read_watched_fields\" : { },\n+ *       \"read_ignore_users\" : [ ],\n+ *       \"write_metadata_only\" : true,\n+ *       \"write_log_diffs\" : false,\n+ *       \"write_watched_indices\" : [ ],\n+ *       \"write_ignore_users\" : [ ]\n+ *     }\n+ *   }\n+ * }\n+ *\n+ * PUT _opendistro/_security/api/audit/config\n+ * {\n+ *   \"audit\":{\n+ *     \"enable_rest\":true,\n+ *     \"disabled_rest_categories\":[\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"SSL_EXCEPTION\"\n+ *     ],\n+ *     \"enable_transport\":true,\n+ *     \"disabled_transport_categories\":[\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"resolve_bulk_requests\":false,\n+ *     \"log_request_body\":true,\n+ *     \"resolve_indices\":true,\n+ *     \"exclude_sensitive_headers\":true,\n+ *     \"ignore_users\":[ ],\n+ *     \"ignore_requests\":[ ]\n+ *   },\n+ *   \"compliance\":{\n+ *     \"internal_config\":true,\n+ *     \"external_config\":true,\n+ *     \"read_metadata_only\":true,\n+ *     \"read_watched_fields\":{ },\n+ *     \"read_ignore_users\":[ ],\n+ *     \"write_metadata_only\":true,\n+ *     \"write_log_diffs\":false,\n+ *     \"write_watched_indices\":[ ],\n+ *     \"write_ignore_users\":[ ]\n+ *   }\n+ * }\n+ *\n+ * PATCH _opendistro/_security/api/audit\n+ * [{\"op\": \"replace\", \"path\": \"/config/audit/enable_rest\", \"value\": \"true\"}]\n+ * [{\"op\": \"replace\", \"path\": \"/config/compliance/internal_config\", \"value\": \"true\"}]\n+ */\n+public class AuditApiAction extends PatchableResourceApiAction {\n+    private static final List<Route> routes = ImmutableList.of(\n+            new Route(RestRequest.Method.GET, \"/_opendistro/_security/api/audit/\"),\n+            new Route(RestRequest.Method.PUT, \"/_opendistro/_security/api/audit/{name}\"),\n+            new Route(RestRequest.Method.PATCH, \"/_opendistro/_security/api/audit/\")\n+    );\n+\n+    private static final String RESOURCE_NAME = \"config\";\n+    private final PrivilegesEvaluator privilegesEvaluator;\n+    private final ThreadContext threadContext;\n+\n+    public AuditApiAction(final Settings settings,\n+                          final Path configPath,\n+                          final RestController controller,\n+                          final Client client,\n+                          final AdminDNs adminDNs,\n+                          final ConfigurationRepository cl,\n+                          final ClusterService cs,\n+                          final PrincipalExtractor principalExtractor,\n+                          final PrivilegesEvaluator privilegesEvaluator,\n+                          final ThreadPool threadPool,\n+                          final AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, privilegesEvaluator, threadPool, auditLog);\n+        this.privilegesEvaluator = privilegesEvaluator;\n+        this.threadContext = threadPool.getThreadContext();\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return routes;\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(final RestChannel channel, final RestRequest request, final Client client) throws IOException {\n+        // if audit config doc is not available in security index,\n+        // disable audit APIs\n+        if (!cl.isAuditHotReloadingEnabled()) {\n+            notImplemented(channel, request.method());\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    @Override\n+    protected void handlePut(final RestChannel channel, final RestRequest request, final Client client, final JsonNode content) throws IOException {\n+        if (!\"config\".equals(request.param(\"name\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 149}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjE2NzQx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439616741", "createdAt": "2020-06-30T01:59:36Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTo1OTozNlrOGqo2OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMTo1OTozNlrOGqo2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2MjYxNw==", "bodyText": "Can you move this to a separate PR, I am not sure why NodesDn was not included before.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447362617", "createdAt": "2020-06-30T01:59:36Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/ValidateApiAction.java", "diffHunk": "@@ -96,13 +98,17 @@ protected void handleGet(RestChannel channel, RestRequest request, Client client\n             final SecurityDynamicConfiguration<InternalUserV6> internalUsersV6 = (SecurityDynamicConfiguration<InternalUserV6>) load(CType.INTERNALUSERS, true, acceptInvalid);\n             final SecurityDynamicConfiguration<RoleV6> rolesV6 = (SecurityDynamicConfiguration<RoleV6>) load(CType.ROLES, true, acceptInvalid);\n             final SecurityDynamicConfiguration<RoleMappingsV6> rolesmappingV6 = (SecurityDynamicConfiguration<RoleMappingsV6>) load(CType.ROLESMAPPING, true, acceptInvalid);\n+            final SecurityDynamicConfiguration<NodesDn> nodesDnV6 = (SecurityDynamicConfiguration<NodesDn>) load(CType.NODESDN, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjE5OTUx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439619951", "createdAt": "2020-06-30T02:09:32Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjowOTozMlrOGqpBUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjowOTozMlrOGqpBUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2NTQ1Ng==", "bodyText": "Order in which tests are executed by JUnit is not defined, this may be the first one to be executed and it will set sendAdminCertificate to true.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447365456", "createdAt": "2020-06-30T02:09:32Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/compliance/ComplianceAuditlogTest.java", "diffHunk": "@@ -86,6 +93,36 @@ public void testSourceFilter() throws Exception {\n         Assert.assertTrue(validateMsgs(TestAuditlogImpl.messages));\n     }\n \n+    @Test\n+    public void testComplianceEnable() throws Exception {\n+        Settings additionalSettings = Settings.builder()\n+                .put(\"opendistro_security.audit.type\", TestAuditlogImpl.class.getName())\n+                .build();\n+\n+        setup(additionalSettings);\n+        rh.sendAdminCertificate = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjIyNDY3", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439622467", "createdAt": "2020-06-30T02:17:16Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoxNzoxNlrOGqpKPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoxNzoxNlrOGqpKPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2Nzc0MQ==", "bodyText": "Is the change necessary? Can't it rely on settings to configure audit in the test not directly related to it?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447367741", "createdAt": "2020-06-30T02:17:16Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/TracingTests.java", "diffHunk": "@@ -332,11 +333,17 @@ public void uncaughtException(Thread t, Throwable e) {\n     @Test\n     public void testAdvancedMapping() throws Exception {\n         Settings settings = Settings.builder()\n-                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS, \"*\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjI0MTQ0", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439624144", "createdAt": "2020-06-30T02:22:44Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoyMjo0NFrOGqpPyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoyMjo0NFrOGqpPyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2OTE2MA==", "bodyText": "Why java block ({ ... }) is necessary?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447369160", "createdAt": "2020-06-30T02:22:44Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java", "diffHunk": "@@ -0,0 +1,285 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditTestUtils;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.rest.RestHelper;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.http.Header;\n+import org.apache.http.HttpStatus;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper.readTree;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertFalse;\n+\n+public class AuditApiActionTest extends AbstractRestApiUnitTest {\n+\n+    private static final String ENDPOINT = \"/_opendistro/_security/api/audit\";\n+    private static final String CONFIG_ENDPOINT = \"/_opendistro/_security/api/audit/config\";\n+\n+    @Test\n+    public void testInvalidPath() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response;\n+\n+        // should have /config for put request\n+        response = rh.executePutRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+\n+        // no post supported\n+        response = rh.executePostRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+\n+        // should have /config for patch request\n+        response = rh.executePatchRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+\n+        // no delete supported\n+        response = rh.executeDeleteRequest(ENDPOINT);\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testBadRequest() throws Exception {\n+        setupWithRestRoles();\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+\n+        // test bad patch request\n+        testBoolean(\"/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/audit/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/compliance/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/compliance/disabled_rest_categories\", HttpStatus.SC_BAD_REQUEST);\n+\n+        testPutAction(\"{}\", HttpStatus.SC_BAD_REQUEST);\n+        testPutAction(\"{\\\"test\\\": \\\"val\\\"}\", HttpStatus.SC_BAD_REQUEST);\n+\n+        // incorrect category\n+        final String jsonValue = DefaultObjectMapper.writeValueAsString(ImmutableList.of(\"RANDOM\", \"Test\"), true);\n+        RestHelper.HttpResponse response;\n+        response = rh.executePatchRequest(ENDPOINT, \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"\" + \"/config/audit/disabled_rest_categories\" + \"\\\",\\\"value\\\": \" + jsonValue + \"}]\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        response = rh.executePatchRequest(ENDPOINT, \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"\" + \"/config/audit/disabled_transport_categories\" + \"\\\",\\\"value\\\": \" + jsonValue + \"}]\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testApi() throws Exception {\n+        setupWithRestRoles();\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+\n+        // admin cred with roles in test yml files\n+        final Header adminCredsHeader = encodeBasicHeader(\"sarek\", \"sarek\");\n+        // non-admin\n+        final Header nonAdminCredsHeader = encodeBasicHeader(\"random\", \"random\");\n+\n+        {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjI1MTQz", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439625143", "createdAt": "2020-06-30T02:25:54Z", "commit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoyNTo1NVrOGqpTJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoyNTo1NVrOGqpTJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3MDAyMg==", "bodyText": "nit: take desired sendAdminCertificate as a parameter for testActions.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447370022", "createdAt": "2020-06-30T02:25:55Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java", "diffHunk": "@@ -0,0 +1,285 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditTestUtils;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.rest.RestHelper;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.http.Header;\n+import org.apache.http.HttpStatus;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Test;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper.readTree;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertFalse;\n+\n+public class AuditApiActionTest extends AbstractRestApiUnitTest {\n+\n+    private static final String ENDPOINT = \"/_opendistro/_security/api/audit\";\n+    private static final String CONFIG_ENDPOINT = \"/_opendistro/_security/api/audit/config\";\n+\n+    @Test\n+    public void testInvalidPath() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response;\n+\n+        // should have /config for put request\n+        response = rh.executePutRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+\n+        // no post supported\n+        response = rh.executePostRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+\n+        // should have /config for patch request\n+        response = rh.executePatchRequest(ENDPOINT, \"{\\\"xxx\\\": 1}\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+\n+        // no delete supported\n+        response = rh.executeDeleteRequest(ENDPOINT);\n+        assertEquals(HttpStatus.SC_METHOD_NOT_ALLOWED, response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testBadRequest() throws Exception {\n+        setupWithRestRoles();\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+\n+        // test bad patch request\n+        testBoolean(\"/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/audit/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/compliance/test\", HttpStatus.SC_BAD_REQUEST);\n+        testBoolean(\"/config/compliance/disabled_rest_categories\", HttpStatus.SC_BAD_REQUEST);\n+\n+        testPutAction(\"{}\", HttpStatus.SC_BAD_REQUEST);\n+        testPutAction(\"{\\\"test\\\": \\\"val\\\"}\", HttpStatus.SC_BAD_REQUEST);\n+\n+        // incorrect category\n+        final String jsonValue = DefaultObjectMapper.writeValueAsString(ImmutableList.of(\"RANDOM\", \"Test\"), true);\n+        RestHelper.HttpResponse response;\n+        response = rh.executePatchRequest(ENDPOINT, \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"\" + \"/config/audit/disabled_rest_categories\" + \"\\\",\\\"value\\\": \" + jsonValue + \"}]\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        response = rh.executePatchRequest(ENDPOINT, \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"\" + \"/config/audit/disabled_transport_categories\" + \"\\\",\\\"value\\\": \" + jsonValue + \"}]\");\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+    }\n+\n+    @Test\n+    public void testApi() throws Exception {\n+        setupWithRestRoles();\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+\n+        // admin cred with roles in test yml files\n+        final Header adminCredsHeader = encodeBasicHeader(\"sarek\", \"sarek\");\n+        // non-admin\n+        final Header nonAdminCredsHeader = encodeBasicHeader(\"random\", \"random\");\n+\n+        {\n+            // No creds, no admin certificate - UNAUTHORIZED\n+            rh.sendAdminCertificate = false;\n+            testActions(HttpStatus.SC_UNAUTHORIZED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bd495a1919dc2216a66f408b3f10af40a1c717c"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d73716524cfb98d830220d60908cf05f4da8cb1", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/9d73716524cfb98d830220d60908cf05f4da8cb1", "committedDate": "2020-06-30T02:34:54Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjMyMDYz", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439632063", "createdAt": "2020-06-30T02:48:34Z", "commit": {"oid": "9d73716524cfb98d830220d60908cf05f4da8cb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjo0ODozNVrOGqpqvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjo0ODozNVrOGqpqvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3NjA2Mg==", "bodyText": "isAuditConfigDocPresentInIndex must be set before latch is updated to avoid possibility of the waiting thread using not updated state.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447376062", "createdAt": "2020-06-30T02:48:35Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationLoaderSecurity7.java", "diffHunk": "@@ -101,6 +112,11 @@ public void success(SecurityDynamicConfiguration<?> dConf) {\n                 if(log.isDebugEnabled()) {\n                     log.debug(\"Received config for {} (of {}) with current latch value={}\", dConf.getCType().toLCString(), Arrays.toString(events), latch.getCount());\n                 }\n+                // Audit configuration doc is available in the index.\n+                // Configuration can be hot-reloaded.\n+                if (dConf.getCType() == CType.AUDIT) {\n+                    isAuditConfigDocPresentInIndex.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d73716524cfb98d830220d60908cf05f4da8cb1"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a40d25bd4a74bf93dbcaeea21a787182bf7e3015", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/a40d25bd4a74bf93dbcaeea21a787182bf7e3015", "committedDate": "2020-06-30T08:27:23Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzIzOTA5", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-440323909", "createdAt": "2020-06-30T19:32:29Z", "commit": {"oid": "a40d25bd4a74bf93dbcaeea21a787182bf7e3015"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTU1NzAw", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-439555700", "createdAt": "2020-06-29T22:52:55Z", "commit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjo1Mjo1NVrOGqlSJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMTo1ODowNFrOGrP7XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwNDIzMA==", "bodyText": "what is the difference between { } and  [ ] ?\nread_watched_fields: {}\nwrite_watched_indices: []", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447304230", "createdAt": "2020-06-29T22:52:55Z", "author": {"login": "hardik-k-shah"}, "path": "securityconfig/audit.yml.example", "diffHunk": "@@ -0,0 +1,52 @@\n+_meta:\n+  type: \"audit\"\n+  config_version: 2\n+\n+config:\n+  # enable/disable auditlog\n+  enabled: true\n+\n+  audit:\n+    # rest\n+    enable_rest: true\n+    disabled_rest_categories:\n+      - AUTHENTICATED\n+      - GRANTED_PRIVILEGES\n+\n+    # transport\n+    enable_transport: true\n+    disabled_transport_categories:\n+      - AUTHENTICATED\n+      - GRANTED_PRIVILEGES\n+\n+    # ignore\n+    ignore_users:\n+      - kibanaserver\n+    ignore_requests: []\n+\n+    # verbose attributes\n+    resolve_bulk_requests: false\n+    log_request_body: true\n+    resolve_indices: true\n+    exclude_sensitive_headers: true\n+\n+  compliance:\n+    # enable/disable compliance\n+    enabled: true\n+\n+    # configs\n+    internal_config: true\n+    external_config: false\n+\n+    # compliance read\n+    read_metadata_only: true\n+    read_watched_fields: {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMzOTYyMg==", "bodyText": "will this loose audit-logging for  changes in external config (.yml changes) during node boot up?\nhow did we test to make sure its current functionality?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447339622", "createdAt": "2020-06-30T00:40:02Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/AuditLog.java", "diffHunk": "@@ -72,10 +73,12 @@\n     void logDocumentRead(String index, String id, ShardId shardId, Map<String, String> fieldNameValues);\n     void logDocumentWritten(ShardId shardId, GetResult originalIndex, Index currentIndex, IndexResult result);\n     void logDocumentDeleted(ShardId shardId, Delete delete, DeleteResult result);\n-    void logExternalConfig(Settings settings, Environment environment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5MTQ3OQ==", "bodyText": "private boolean logRequestBody = true;  --> should we log request body by default?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447891479", "createdAt": "2020-06-30T18:24:08Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -1,167 +1,363 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n \n import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n-\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonSetter;\n+import com.fasterxml.jackson.annotation.Nulls;\n import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableSet;\n import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.settings.Settings;\n \n import java.util.Arrays;\n import java.util.Collections;\n import java.util.EnumSet;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n /**\n  * Class represents configuration for audit logging.\n+ * Expected class structure\n+ * {\n+ *   \"enabled\": true,\n+ *   \"audit\" : {\n+ *     \"enable_rest\" : true,\n+ *     \"disabled_rest_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"SSL_EXCEPTION\"\n+ *     ],\n+ *     \"enable_transport\" : true,\n+ *     \"disabled_transport_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"resolve_bulk_requests\" : false,\n+ *     \"log_request_body\" : true,\n+ *     \"resolve_indices\" : true,\n+ *     \"exclude_sensitive_headers\" : true,\n+ *     \"ignore_users\" : [\n+ *       \"kibanaserver\"\n+ *     ],\n+ *     \"ignore_requests\" : [ ]\n+ *   },\n+ *   \"compliance\" : {\n+ *     \"enabled\": true,\n+ *     \"internal_config\" : true,\n+ *     \"external_config\" : true,\n+ *     \"read_metadata_only\" : true,\n+ *     \"read_watched_fields\" : { },\n+ *     \"read_ignore_users\" : [ ],\n+ *     \"write_metadata_only\" : true,\n+ *     \"write_log_diffs\" : false,\n+ *     \"write_watched_indices\" : [ ],\n+ *     \"write_ignore_users\" : [ ]\n+ *   }\n+ * }\n  */\n public class AuditConfig {\n \n-    public static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final Set<String> DEFAULT_IGNORED_USERS = Collections.singleton(\"kibanaserver\");\n+    private static final EnumSet<AuditCategory> DEFAULT_DISABLED_CATEGORIES = EnumSet.of(\n+            AuditCategory.AUTHENTICATED, AuditCategory.GRANTED_PRIVILEGES);\n+\n+    @JsonProperty(value = Key.ENABLED)\n+    private boolean auditLogEnabled = true;\n+    @JsonProperty(value = Key.AUDIT)\n+    private Filter filter = new Filter();\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    private Compliance compliance = new Compliance();\n+\n+    @JsonIgnore\n+    public boolean isEnabled() {\n+        return auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public void setEnabled(boolean auditLogEnabled) {\n+        this.auditLogEnabled = auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public Filter getFilter() {\n+        return filter;\n+    }\n \n-    private AuditConfig() { }\n+    @JsonProperty(value = Key.AUDIT)\n+    public void setFilter(Filter filter) {\n+        this.filter = filter;\n+    }\n+\n+    @JsonIgnore\n+    public Compliance getCompliance() {\n+        return compliance;\n+    }\n+\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    public void setCompliance(Compliance compliance) {\n+        this.compliance = compliance;\n+    }\n \n     /**\n      * Filter represents set of filtering configuration settings for audit logging.\n      * Audit logger will use these settings to determine what audit logs are to be generated.\n      */\n     public static class Filter {\n-        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n-                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n-                        AuditCategory.GRANTED_PRIVILEGES.toString());\n-\n-        private final boolean isRestApiAuditEnabled;\n-        private final boolean isTransportApiAuditEnabled;\n-        private final boolean resolveBulkRequests;\n-        private final boolean logRequestBody;\n-        private final boolean resolveIndices;\n-        private final boolean excludeSensitiveHeaders;\n-        private final WildcardMatcher ignoredAuditUsersMatcher;\n-        private final WildcardMatcher ignoredAuditRequestsMatcher;\n-        private final EnumSet<AuditCategory> disabledRestCategories;\n-        private final EnumSet<AuditCategory> disabledTransportCategories;\n-\n-        private Filter(final boolean isRestApiAuditEnabled,\n-                       final boolean isTransportApiAuditEnabled,\n-                       final boolean resolveBulkRequests,\n-                       final boolean logRequestBody,\n-                       final boolean resolveIndices,\n-                       final boolean excludeSensitiveHeaders,\n-                       final Set<String> ignoredAuditUsers,\n-                       final Set<String> ignoredAuditRequests,\n-                       final EnumSet<AuditCategory> disabledRestCategories,\n-                       final EnumSet<AuditCategory> disabledTransportCategories) {\n-            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n-            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n-            this.resolveBulkRequests = resolveBulkRequests;\n-            this.logRequestBody = logRequestBody;\n-            this.resolveIndices = resolveIndices;\n-            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n-            this.ignoredAuditUsersMatcher = WildcardMatcher.from(ignoredAuditUsers);\n-            this.ignoredAuditRequestsMatcher = WildcardMatcher.from(ignoredAuditRequests);\n-            this.disabledRestCategories = disabledRestCategories;\n-            this.disabledTransportCategories = disabledTransportCategories;\n-        }\n-\n-        /**\n-         * Generate audit logging configuration from settings defined in elasticsearch.yml\n-         * @param settings settings\n-         * @return audit configuration filter\n-         */\n-        public static Filter from(Settings settings) {\n-            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n-\n-            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final Set<String> ignoredAuditUsers = getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n-                    DEFAULT_IGNORED_USERS,\n-                    false);\n-\n-            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n-                    Collections.emptyList()));\n-\n-            return new Filter(isRestApiAuditEnabled,\n-                    isTransportAuditEnabled,\n-                    resolveBulkRequests,\n-                    logRequestBody,\n-                    resolveIndices,\n-                    excludeSensitiveHeaders,\n-                    ignoredAuditUsers,\n-                    ignoreAuditRequests,\n-                    disabledRestCategories,\n-                    disabledTransportCategories);\n-        }\n+        @JsonProperty(value = Key.ENABLE_REST)\n+        private boolean isRestApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_REST_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledRestCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.ENABLE_TRANSPORT)\n+        private boolean isTransportApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_TRANSPORT_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledTransportCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.RESOLVE_BULK_REQUESTS)\n+        private boolean resolveBulkRequests = false;\n+        @JsonProperty(value = Key.LOG_REQUEST_BODY)\n+        private boolean logRequestBody = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NDgxMg==", "bodyText": "Can you please add sample about wildcard support in YML file?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447954812", "createdAt": "2020-06-30T20:19:51Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -1,167 +1,363 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n \n import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n-\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonSetter;\n+import com.fasterxml.jackson.annotation.Nulls;\n import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableSet;\n import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.settings.Settings;\n \n import java.util.Arrays;\n import java.util.Collections;\n import java.util.EnumSet;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n /**\n  * Class represents configuration for audit logging.\n+ * Expected class structure\n+ * {\n+ *   \"enabled\": true,\n+ *   \"audit\" : {\n+ *     \"enable_rest\" : true,\n+ *     \"disabled_rest_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"SSL_EXCEPTION\"\n+ *     ],\n+ *     \"enable_transport\" : true,\n+ *     \"disabled_transport_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"resolve_bulk_requests\" : false,\n+ *     \"log_request_body\" : true,\n+ *     \"resolve_indices\" : true,\n+ *     \"exclude_sensitive_headers\" : true,\n+ *     \"ignore_users\" : [\n+ *       \"kibanaserver\"\n+ *     ],\n+ *     \"ignore_requests\" : [ ]\n+ *   },\n+ *   \"compliance\" : {\n+ *     \"enabled\": true,\n+ *     \"internal_config\" : true,\n+ *     \"external_config\" : true,\n+ *     \"read_metadata_only\" : true,\n+ *     \"read_watched_fields\" : { },\n+ *     \"read_ignore_users\" : [ ],\n+ *     \"write_metadata_only\" : true,\n+ *     \"write_log_diffs\" : false,\n+ *     \"write_watched_indices\" : [ ],\n+ *     \"write_ignore_users\" : [ ]\n+ *   }\n+ * }\n  */\n public class AuditConfig {\n \n-    public static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final Set<String> DEFAULT_IGNORED_USERS = Collections.singleton(\"kibanaserver\");\n+    private static final EnumSet<AuditCategory> DEFAULT_DISABLED_CATEGORIES = EnumSet.of(\n+            AuditCategory.AUTHENTICATED, AuditCategory.GRANTED_PRIVILEGES);\n+\n+    @JsonProperty(value = Key.ENABLED)\n+    private boolean auditLogEnabled = true;\n+    @JsonProperty(value = Key.AUDIT)\n+    private Filter filter = new Filter();\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    private Compliance compliance = new Compliance();\n+\n+    @JsonIgnore\n+    public boolean isEnabled() {\n+        return auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public void setEnabled(boolean auditLogEnabled) {\n+        this.auditLogEnabled = auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public Filter getFilter() {\n+        return filter;\n+    }\n \n-    private AuditConfig() { }\n+    @JsonProperty(value = Key.AUDIT)\n+    public void setFilter(Filter filter) {\n+        this.filter = filter;\n+    }\n+\n+    @JsonIgnore\n+    public Compliance getCompliance() {\n+        return compliance;\n+    }\n+\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    public void setCompliance(Compliance compliance) {\n+        this.compliance = compliance;\n+    }\n \n     /**\n      * Filter represents set of filtering configuration settings for audit logging.\n      * Audit logger will use these settings to determine what audit logs are to be generated.\n      */\n     public static class Filter {\n-        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n-                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n-                        AuditCategory.GRANTED_PRIVILEGES.toString());\n-\n-        private final boolean isRestApiAuditEnabled;\n-        private final boolean isTransportApiAuditEnabled;\n-        private final boolean resolveBulkRequests;\n-        private final boolean logRequestBody;\n-        private final boolean resolveIndices;\n-        private final boolean excludeSensitiveHeaders;\n-        private final WildcardMatcher ignoredAuditUsersMatcher;\n-        private final WildcardMatcher ignoredAuditRequestsMatcher;\n-        private final EnumSet<AuditCategory> disabledRestCategories;\n-        private final EnumSet<AuditCategory> disabledTransportCategories;\n-\n-        private Filter(final boolean isRestApiAuditEnabled,\n-                       final boolean isTransportApiAuditEnabled,\n-                       final boolean resolveBulkRequests,\n-                       final boolean logRequestBody,\n-                       final boolean resolveIndices,\n-                       final boolean excludeSensitiveHeaders,\n-                       final Set<String> ignoredAuditUsers,\n-                       final Set<String> ignoredAuditRequests,\n-                       final EnumSet<AuditCategory> disabledRestCategories,\n-                       final EnumSet<AuditCategory> disabledTransportCategories) {\n-            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n-            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n-            this.resolveBulkRequests = resolveBulkRequests;\n-            this.logRequestBody = logRequestBody;\n-            this.resolveIndices = resolveIndices;\n-            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n-            this.ignoredAuditUsersMatcher = WildcardMatcher.from(ignoredAuditUsers);\n-            this.ignoredAuditRequestsMatcher = WildcardMatcher.from(ignoredAuditRequests);\n-            this.disabledRestCategories = disabledRestCategories;\n-            this.disabledTransportCategories = disabledTransportCategories;\n-        }\n-\n-        /**\n-         * Generate audit logging configuration from settings defined in elasticsearch.yml\n-         * @param settings settings\n-         * @return audit configuration filter\n-         */\n-        public static Filter from(Settings settings) {\n-            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n-\n-            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final Set<String> ignoredAuditUsers = getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n-                    DEFAULT_IGNORED_USERS,\n-                    false);\n-\n-            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n-                    Collections.emptyList()));\n-\n-            return new Filter(isRestApiAuditEnabled,\n-                    isTransportAuditEnabled,\n-                    resolveBulkRequests,\n-                    logRequestBody,\n-                    resolveIndices,\n-                    excludeSensitiveHeaders,\n-                    ignoredAuditUsers,\n-                    ignoreAuditRequests,\n-                    disabledRestCategories,\n-                    disabledTransportCategories);\n-        }\n+        @JsonProperty(value = Key.ENABLE_REST)\n+        private boolean isRestApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_REST_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledRestCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.ENABLE_TRANSPORT)\n+        private boolean isTransportApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_TRANSPORT_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledTransportCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.RESOLVE_BULK_REQUESTS)\n+        private boolean resolveBulkRequests = false;\n+        @JsonProperty(value = Key.LOG_REQUEST_BODY)\n+        private boolean logRequestBody = true;\n+        @JsonProperty(value = Key.RESOLVE_INDICES)\n+        private boolean resolveIndices = true;\n+        @JsonProperty(value = Key.EXCLUDE_SENSITIVE_HEADERS)\n+        private boolean excludeSensitiveHeaders = true;\n+        @JsonProperty(value = Key.IGNORE_USERS)\n+        private Set<String> ignoredAuditUsers = DEFAULT_IGNORED_USERS;\n+        @JsonProperty(value = Key.IGNORE_REQUESTS)\n+        private Set<String> ignoreAuditRequests = Collections.emptySet();\n+\n+        @JsonIgnore\n+        private WildcardMatcher ignoredAuditUsersMatcher;\n+        @JsonIgnore\n+        private WildcardMatcher ignoredAuditRequestsMatcher;\n \n         /**\n          * Checks if auditing for REST API is enabled or disabled\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean isRestApiAuditEnabled() {\n             return isRestApiAuditEnabled;\n         }\n \n+        /**\n+         * Enable or disable REST API auditing\n+         * @param enableRest true/false\n+         */\n+        @JsonIgnore\n+        public void setRestApiAuditEnabled(boolean enableRest) {\n+            this.isRestApiAuditEnabled = enableRest;\n+        }\n+\n+        /**\n+         * Disabled categories for REST API auditing\n+         * @return set of categories\n+         */\n+        @JsonIgnore\n+        public EnumSet<AuditCategory> getDisabledRestCategories() {\n+            return disabledRestCategories;\n+        }\n+\n+        /**\n+         * Set categories to ignore REST API auditing\n+         * @param disabledRestCategories categories\n+         */\n+        @JsonSetter(value = Key.DISABLED_REST_CATEGORIES, nulls = Nulls.AS_EMPTY)\n+        public void setDisabledRestCategories(Set<AuditCategory> disabledRestCategories) {\n+            if (disabledRestCategories != null && !disabledRestCategories.isEmpty()) {\n+                if (disabledRestCategories instanceof EnumSet) {\n+                    this.disabledRestCategories = (EnumSet) disabledRestCategories;\n+                } else {\n+                    this.disabledRestCategories = EnumSet.copyOf(disabledRestCategories);\n+                }\n+            } else {\n+                this.disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n+            }\n+        }\n+\n         /**\n          * Checks if auditing for Transport API is enabled or disabled\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean isTransportApiAuditEnabled() {\n             return isTransportApiAuditEnabled;\n         }\n \n         /**\n-         * Checks if bulk requests must be resolved during auditing\n+         * Enable or disable Transport API auditing\n+         * @param enableTransport true/false\n+         */\n+        @JsonIgnore\n+        public void setTransportApiAuditEnabled(boolean enableTransport) {\n+            this.isTransportApiAuditEnabled = enableTransport;\n+        }\n+\n+        /**\n+         * Disabled categories for Transport API auditing\n+         * @return set of categories\n+         */\n+        @JsonIgnore\n+        public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+            return disabledTransportCategories;\n+        }\n+\n+        /**\n+         *  Set categories to ignore Transport API auditing\n+         * @param disabledTransportCategories categories\n+         */\n+        @JsonSetter(value = Key.DISABLED_TRANSPORT_CATEGORIES, nulls = Nulls.AS_EMPTY)\n+        public void setDisabledTransportCategories(Set<AuditCategory> disabledTransportCategories) {\n+            if (disabledTransportCategories != null && !disabledTransportCategories.isEmpty()) {\n+                if (disabledTransportCategories instanceof EnumSet) {\n+                    this.disabledTransportCategories = (EnumSet) disabledTransportCategories;\n+                } else {\n+                    this.disabledTransportCategories = EnumSet.copyOf(disabledTransportCategories);\n+                }\n+            } else {\n+                this.disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n+            }\n+        }\n+\n+        /**\n+         * Check if bulk requests must be resolved during auditing\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldResolveBulkRequests() {\n             return resolveBulkRequests;\n         }\n \n+        /**\n+         * Set if bulk requests must be resolved during auditing\n+         * @param resolveBulkRequests true/false\n+         */\n+        @JsonIgnore\n+        public void setResolveBulkRequests(boolean resolveBulkRequests) {\n+            this.resolveBulkRequests = resolveBulkRequests;\n+        }\n+\n         /**\n          * Checks if request body must be logged\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldLogRequestBody() {\n             return logRequestBody;\n         }\n \n+        /**\n+         * Set if request body must be logged\n+         * @param logRequestBody true/false\n+         */\n+        @JsonIgnore\n+        public void setLogRequestBody(boolean logRequestBody) {\n+            this.logRequestBody = logRequestBody;\n+        }\n+\n         /**\n          * Check if indices must be resolved during auditing\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldResolveIndices() {\n             return resolveIndices;\n         }\n \n         /**\n-         * Checks if sensitive headers eg: Authorization must be excluded in log messages\n+         * Set if indices must be resolved during auditing\n+         * @param resolveIndices true/false\n+         */\n+        @JsonIgnore\n+        public void setResolveIndices(boolean resolveIndices) {\n+            this.resolveIndices = resolveIndices;\n+        }\n+\n+        /**\n+         * Checks if sensitive headers eg: Authorization must be excluded in audit log messages\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldExcludeSensitiveHeaders() {\n             return excludeSensitiveHeaders;\n         }\n \n+        /**\n+         * Set  if sensitive headers must be excluded from audit log messages\n+         * @param excludeSensitiveHeaders true/false\n+         */\n+        @JsonIgnore\n+        public void setExcludeSensitiveHeaders(boolean excludeSensitiveHeaders) {\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        }\n+\n+        /**\n+         * Get users for whom auditing must be ignored.\n+         * @return set of users\n+         */\n+        @JsonIgnore\n+        public Set<String> getIgnoredAuditUsers() {\n+            return ignoredAuditUsers;\n+        }\n+\n+        /**\n+         * Set of users for whom auditing must be ignored.\n+         * @param ignoreUsers users\n+         */\n+        @JsonSetter(value = Key.IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setIgnoreUsers(Set<String> ignoreUsers) {\n+            if (ignoreUsers != null) {\n+                this.ignoredAuditUsers = ignoreUsers;\n+            } else {\n+                this.ignoredAuditUsers = Collections.emptySet();\n+            }\n+            ignoredAuditUsersMatcher = WildcardMatcher.from(this.ignoredAuditUsers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 421}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NjU5NQ==", "bodyText": "please add sample in YML", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447956595", "createdAt": "2020-06-30T20:23:14Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -1,167 +1,363 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n package com.amazon.opendistroforelasticsearch.security.auditlog.config;\n \n import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n-\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonSetter;\n+import com.fasterxml.jackson.annotation.Nulls;\n import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableSet;\n import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.settings.Settings;\n \n import java.util.Arrays;\n import java.util.Collections;\n import java.util.EnumSet;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n /**\n  * Class represents configuration for audit logging.\n+ * Expected class structure\n+ * {\n+ *   \"enabled\": true,\n+ *   \"audit\" : {\n+ *     \"enable_rest\" : true,\n+ *     \"disabled_rest_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"SSL_EXCEPTION\"\n+ *     ],\n+ *     \"enable_transport\" : true,\n+ *     \"disabled_transport_categories\" : [\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"resolve_bulk_requests\" : false,\n+ *     \"log_request_body\" : true,\n+ *     \"resolve_indices\" : true,\n+ *     \"exclude_sensitive_headers\" : true,\n+ *     \"ignore_users\" : [\n+ *       \"kibanaserver\"\n+ *     ],\n+ *     \"ignore_requests\" : [ ]\n+ *   },\n+ *   \"compliance\" : {\n+ *     \"enabled\": true,\n+ *     \"internal_config\" : true,\n+ *     \"external_config\" : true,\n+ *     \"read_metadata_only\" : true,\n+ *     \"read_watched_fields\" : { },\n+ *     \"read_ignore_users\" : [ ],\n+ *     \"write_metadata_only\" : true,\n+ *     \"write_log_diffs\" : false,\n+ *     \"write_watched_indices\" : [ ],\n+ *     \"write_ignore_users\" : [ ]\n+ *   }\n+ * }\n  */\n public class AuditConfig {\n \n-    public static final List<String> DEFAULT_IGNORED_USERS = Collections.singletonList(\"kibanaserver\");\n+    private static final Set<String> DEFAULT_IGNORED_USERS = Collections.singleton(\"kibanaserver\");\n+    private static final EnumSet<AuditCategory> DEFAULT_DISABLED_CATEGORIES = EnumSet.of(\n+            AuditCategory.AUTHENTICATED, AuditCategory.GRANTED_PRIVILEGES);\n+\n+    @JsonProperty(value = Key.ENABLED)\n+    private boolean auditLogEnabled = true;\n+    @JsonProperty(value = Key.AUDIT)\n+    private Filter filter = new Filter();\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    private Compliance compliance = new Compliance();\n+\n+    @JsonIgnore\n+    public boolean isEnabled() {\n+        return auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public void setEnabled(boolean auditLogEnabled) {\n+        this.auditLogEnabled = auditLogEnabled;\n+    }\n+\n+    @JsonIgnore\n+    public Filter getFilter() {\n+        return filter;\n+    }\n \n-    private AuditConfig() { }\n+    @JsonProperty(value = Key.AUDIT)\n+    public void setFilter(Filter filter) {\n+        this.filter = filter;\n+    }\n+\n+    @JsonIgnore\n+    public Compliance getCompliance() {\n+        return compliance;\n+    }\n+\n+    @JsonProperty(value = Key.COMPLIANCE)\n+    public void setCompliance(Compliance compliance) {\n+        this.compliance = compliance;\n+    }\n \n     /**\n      * Filter represents set of filtering configuration settings for audit logging.\n      * Audit logger will use these settings to determine what audit logs are to be generated.\n      */\n     public static class Filter {\n-        private static final List<String> DEFAULT_DISABLED_CATEGORIES =\n-                Arrays.asList(AuditCategory.AUTHENTICATED.toString(),\n-                        AuditCategory.GRANTED_PRIVILEGES.toString());\n-\n-        private final boolean isRestApiAuditEnabled;\n-        private final boolean isTransportApiAuditEnabled;\n-        private final boolean resolveBulkRequests;\n-        private final boolean logRequestBody;\n-        private final boolean resolveIndices;\n-        private final boolean excludeSensitiveHeaders;\n-        private final WildcardMatcher ignoredAuditUsersMatcher;\n-        private final WildcardMatcher ignoredAuditRequestsMatcher;\n-        private final EnumSet<AuditCategory> disabledRestCategories;\n-        private final EnumSet<AuditCategory> disabledTransportCategories;\n-\n-        private Filter(final boolean isRestApiAuditEnabled,\n-                       final boolean isTransportApiAuditEnabled,\n-                       final boolean resolveBulkRequests,\n-                       final boolean logRequestBody,\n-                       final boolean resolveIndices,\n-                       final boolean excludeSensitiveHeaders,\n-                       final Set<String> ignoredAuditUsers,\n-                       final Set<String> ignoredAuditRequests,\n-                       final EnumSet<AuditCategory> disabledRestCategories,\n-                       final EnumSet<AuditCategory> disabledTransportCategories) {\n-            this.isRestApiAuditEnabled = isRestApiAuditEnabled;\n-            this.isTransportApiAuditEnabled = isTransportApiAuditEnabled;\n-            this.resolveBulkRequests = resolveBulkRequests;\n-            this.logRequestBody = logRequestBody;\n-            this.resolveIndices = resolveIndices;\n-            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n-            this.ignoredAuditUsersMatcher = WildcardMatcher.from(ignoredAuditUsers);\n-            this.ignoredAuditRequestsMatcher = WildcardMatcher.from(ignoredAuditRequests);\n-            this.disabledRestCategories = disabledRestCategories;\n-            this.disabledTransportCategories = disabledTransportCategories;\n-        }\n-\n-        /**\n-         * Generate audit logging configuration from settings defined in elasticsearch.yml\n-         * @param settings settings\n-         * @return audit configuration filter\n-         */\n-        public static Filter from(Settings settings) {\n-            final boolean isRestApiAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, true);\n-            final boolean isTransportAuditEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, true);\n-            final boolean resolveBulkRequests = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false);\n-            final boolean logRequestBody = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY, true);\n-            final boolean resolveIndices = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES, true);\n-            final boolean excludeSensitiveHeaders = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS, true);\n-\n-            final EnumSet<AuditCategory> disabledRestCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final EnumSet<AuditCategory> disabledTransportCategories = AuditCategory.parse(getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n-                    DEFAULT_DISABLED_CATEGORIES,\n-                    true));\n-\n-            final Set<String> ignoredAuditUsers = getSettingAsSet(\n-                    settings,\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n-                    DEFAULT_IGNORED_USERS,\n-                    false);\n-\n-            final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(settings.getAsList(\n-                    ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n-                    Collections.emptyList()));\n-\n-            return new Filter(isRestApiAuditEnabled,\n-                    isTransportAuditEnabled,\n-                    resolveBulkRequests,\n-                    logRequestBody,\n-                    resolveIndices,\n-                    excludeSensitiveHeaders,\n-                    ignoredAuditUsers,\n-                    ignoreAuditRequests,\n-                    disabledRestCategories,\n-                    disabledTransportCategories);\n-        }\n+        @JsonProperty(value = Key.ENABLE_REST)\n+        private boolean isRestApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_REST_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledRestCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.ENABLE_TRANSPORT)\n+        private boolean isTransportApiAuditEnabled = true;\n+        @JsonProperty(value = Key.DISABLED_TRANSPORT_CATEGORIES)\n+        private EnumSet<AuditCategory> disabledTransportCategories = DEFAULT_DISABLED_CATEGORIES;\n+        @JsonProperty(value = Key.RESOLVE_BULK_REQUESTS)\n+        private boolean resolveBulkRequests = false;\n+        @JsonProperty(value = Key.LOG_REQUEST_BODY)\n+        private boolean logRequestBody = true;\n+        @JsonProperty(value = Key.RESOLVE_INDICES)\n+        private boolean resolveIndices = true;\n+        @JsonProperty(value = Key.EXCLUDE_SENSITIVE_HEADERS)\n+        private boolean excludeSensitiveHeaders = true;\n+        @JsonProperty(value = Key.IGNORE_USERS)\n+        private Set<String> ignoredAuditUsers = DEFAULT_IGNORED_USERS;\n+        @JsonProperty(value = Key.IGNORE_REQUESTS)\n+        private Set<String> ignoreAuditRequests = Collections.emptySet();\n+\n+        @JsonIgnore\n+        private WildcardMatcher ignoredAuditUsersMatcher;\n+        @JsonIgnore\n+        private WildcardMatcher ignoredAuditRequestsMatcher;\n \n         /**\n          * Checks if auditing for REST API is enabled or disabled\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean isRestApiAuditEnabled() {\n             return isRestApiAuditEnabled;\n         }\n \n+        /**\n+         * Enable or disable REST API auditing\n+         * @param enableRest true/false\n+         */\n+        @JsonIgnore\n+        public void setRestApiAuditEnabled(boolean enableRest) {\n+            this.isRestApiAuditEnabled = enableRest;\n+        }\n+\n+        /**\n+         * Disabled categories for REST API auditing\n+         * @return set of categories\n+         */\n+        @JsonIgnore\n+        public EnumSet<AuditCategory> getDisabledRestCategories() {\n+            return disabledRestCategories;\n+        }\n+\n+        /**\n+         * Set categories to ignore REST API auditing\n+         * @param disabledRestCategories categories\n+         */\n+        @JsonSetter(value = Key.DISABLED_REST_CATEGORIES, nulls = Nulls.AS_EMPTY)\n+        public void setDisabledRestCategories(Set<AuditCategory> disabledRestCategories) {\n+            if (disabledRestCategories != null && !disabledRestCategories.isEmpty()) {\n+                if (disabledRestCategories instanceof EnumSet) {\n+                    this.disabledRestCategories = (EnumSet) disabledRestCategories;\n+                } else {\n+                    this.disabledRestCategories = EnumSet.copyOf(disabledRestCategories);\n+                }\n+            } else {\n+                this.disabledRestCategories = EnumSet.noneOf(AuditCategory.class);\n+            }\n+        }\n+\n         /**\n          * Checks if auditing for Transport API is enabled or disabled\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean isTransportApiAuditEnabled() {\n             return isTransportApiAuditEnabled;\n         }\n \n         /**\n-         * Checks if bulk requests must be resolved during auditing\n+         * Enable or disable Transport API auditing\n+         * @param enableTransport true/false\n+         */\n+        @JsonIgnore\n+        public void setTransportApiAuditEnabled(boolean enableTransport) {\n+            this.isTransportApiAuditEnabled = enableTransport;\n+        }\n+\n+        /**\n+         * Disabled categories for Transport API auditing\n+         * @return set of categories\n+         */\n+        @JsonIgnore\n+        public EnumSet<AuditCategory> getDisabledTransportCategories() {\n+            return disabledTransportCategories;\n+        }\n+\n+        /**\n+         *  Set categories to ignore Transport API auditing\n+         * @param disabledTransportCategories categories\n+         */\n+        @JsonSetter(value = Key.DISABLED_TRANSPORT_CATEGORIES, nulls = Nulls.AS_EMPTY)\n+        public void setDisabledTransportCategories(Set<AuditCategory> disabledTransportCategories) {\n+            if (disabledTransportCategories != null && !disabledTransportCategories.isEmpty()) {\n+                if (disabledTransportCategories instanceof EnumSet) {\n+                    this.disabledTransportCategories = (EnumSet) disabledTransportCategories;\n+                } else {\n+                    this.disabledTransportCategories = EnumSet.copyOf(disabledTransportCategories);\n+                }\n+            } else {\n+                this.disabledTransportCategories = EnumSet.noneOf(AuditCategory.class);\n+            }\n+        }\n+\n+        /**\n+         * Check if bulk requests must be resolved during auditing\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldResolveBulkRequests() {\n             return resolveBulkRequests;\n         }\n \n+        /**\n+         * Set if bulk requests must be resolved during auditing\n+         * @param resolveBulkRequests true/false\n+         */\n+        @JsonIgnore\n+        public void setResolveBulkRequests(boolean resolveBulkRequests) {\n+            this.resolveBulkRequests = resolveBulkRequests;\n+        }\n+\n         /**\n          * Checks if request body must be logged\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldLogRequestBody() {\n             return logRequestBody;\n         }\n \n+        /**\n+         * Set if request body must be logged\n+         * @param logRequestBody true/false\n+         */\n+        @JsonIgnore\n+        public void setLogRequestBody(boolean logRequestBody) {\n+            this.logRequestBody = logRequestBody;\n+        }\n+\n         /**\n          * Check if indices must be resolved during auditing\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldResolveIndices() {\n             return resolveIndices;\n         }\n \n         /**\n-         * Checks if sensitive headers eg: Authorization must be excluded in log messages\n+         * Set if indices must be resolved during auditing\n+         * @param resolveIndices true/false\n+         */\n+        @JsonIgnore\n+        public void setResolveIndices(boolean resolveIndices) {\n+            this.resolveIndices = resolveIndices;\n+        }\n+\n+        /**\n+         * Checks if sensitive headers eg: Authorization must be excluded in audit log messages\n          * @return true/false\n          */\n+        @JsonIgnore\n         public boolean shouldExcludeSensitiveHeaders() {\n             return excludeSensitiveHeaders;\n         }\n \n+        /**\n+         * Set  if sensitive headers must be excluded from audit log messages\n+         * @param excludeSensitiveHeaders true/false\n+         */\n+        @JsonIgnore\n+        public void setExcludeSensitiveHeaders(boolean excludeSensitiveHeaders) {\n+            this.excludeSensitiveHeaders = excludeSensitiveHeaders;\n+        }\n+\n+        /**\n+         * Get users for whom auditing must be ignored.\n+         * @return set of users\n+         */\n+        @JsonIgnore\n+        public Set<String> getIgnoredAuditUsers() {\n+            return ignoredAuditUsers;\n+        }\n+\n+        /**\n+         * Set of users for whom auditing must be ignored.\n+         * @param ignoreUsers users\n+         */\n+        @JsonSetter(value = Key.IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setIgnoreUsers(Set<String> ignoreUsers) {\n+            if (ignoreUsers != null) {\n+                this.ignoredAuditUsers = ignoreUsers;\n+            } else {\n+                this.ignoredAuditUsers = Collections.emptySet();\n+            }\n+            ignoredAuditUsersMatcher = WildcardMatcher.from(this.ignoredAuditUsers);\n+        }\n+\n+        /**\n+         * Request patterns that must be ignored.\n+         * @return set of request patterns\n+         */\n+        @JsonIgnore\n+        public Set<String> getIgnoredAuditRequests() {\n+            return ignoreAuditRequests;\n+        }\n+\n+        /**\n+         * Set requests to be ignored using api auditing\n+         * @param ignoreRequests request patterns\n+         */\n+        @JsonSetter(value = Key.IGNORE_REQUESTS, nulls = Nulls.AS_EMPTY)\n+        public void setIgnoreRequests(Set<String> ignoreRequests) {\n+            if (ignoreRequests != null) {\n+                this.ignoreAuditRequests = ignoreRequests;\n+            } else {\n+                this.ignoreAuditRequests = Collections.emptySet();\n+            }\n+            ignoredAuditRequestsMatcher = WildcardMatcher.from(this.ignoreAuditRequests);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 444}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NzU2Nw==", "bodyText": "Are we setting default to true?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447957567", "createdAt": "2020-06-30T20:25:05Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 521}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1NzkzNw==", "bodyText": "Does internalConfig is for logging changes to security index?\nIncluding audit logging config / cert Dn hot-reloading changes along with user/action/roles/role-mapping ?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r447957937", "createdAt": "2020-06-30T20:25:52Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;\n+        @JsonProperty(value = Key.INTERNAL_CONFIG_ENABLED)\n+        private boolean internalConfigEnabled = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 523}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwMjQ1OA==", "bodyText": "Should we support pattern for read and write ignore user as well?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r448002458", "createdAt": "2020-06-30T21:56:56Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;\n+        @JsonProperty(value = Key.INTERNAL_CONFIG_ENABLED)\n+        private boolean internalConfigEnabled = true;\n+        @JsonProperty(value = Key.EXTERNAL_CONFIG_ENABLED)\n+        private boolean externalConfigEnabled = false;\n+        @JsonProperty(value = Key.READ_METADATA_ONLY)\n+        private boolean readMetadataOnly = true;\n+        @JsonProperty(value = Key.READ_WATCHED_FIELDS)\n+        private Map<String, Set<String>> readWatchedFields = Collections.emptyMap();\n+        @JsonProperty(value = Key.READ_IGNORE_USERS)\n+        private Set<String> readIgnoreUsers = Collections.emptySet();\n+        @JsonProperty(value = Key.WRITE_METADATA_ONLY)\n+        private boolean writeMetadataOnly = true;\n+        @JsonProperty(value = Key.WRITE_LOG_DIFFS)\n+        private boolean writeLogDiffs = false;\n+        @JsonProperty(value = Key.WRITE_WATCHED_INDICES)\n+        private List<String> writeWatchedIndices = Collections.emptyList();\n+        @JsonProperty(value = Key.WRITE_IGNORE_USERS)\n+        private Set<String> writeIgnoreUsers = Collections.emptySet();\n+\n+        /**\n+         * Checks if compliance auditing is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isComplianceEnabled() {\n+            return complianceEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit compliance events\n+         * @param complianceEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setComplianceEnabled(boolean complianceEnabled) {\n+            this.complianceEnabled = complianceEnabled;\n+        }\n+\n+        /**\n+         * Check if auditing of internal opendistro security index is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isInternalConfigEnabled() {\n+            return internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit internal opendistro security index\n+         * @param internalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setInternalConfigEnabled(boolean internalConfigEnabled) {\n+            this.internalConfigEnabled = internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if auditing of external configuration files is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isExternalConfigEnabled() {\n+            return externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit external configuration files\n+         * @param externalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setExternalConfigEnabled(boolean externalConfigEnabled) {\n+            this.externalConfigEnabled = externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc read requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isReadMetadataOnly() {\n+            return readMetadataOnly;\n+        }\n+\n+        /**\n+         * Set if only metadata or field names are to be logged for doc read requests\n+         * @param readMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setReadMetadataOnly(boolean readMetadataOnly) {\n+            this.readMetadataOnly = readMetadataOnly;\n+        }\n+\n+        /**\n+         * Get list of fields to watch for, in a document in an index\n+         * @return index name mapped to a set of fields\n+         */\n+        @JsonIgnore\n+        public Map<String, Set<String>> getReadWatchedFields() {\n+            return readWatchedFields;\n+        }\n+\n+        /**\n+         * Set list of fields to watch for, in a document in an index\n+         * @param readWatchedFields index name mapped to a set of fields\n+         */\n+        @JsonSetter(value = Key.READ_WATCHED_FIELDS, nulls = Nulls.AS_EMPTY)\n+        public void setReadWatchedFields(Map<String, Set<String>> readWatchedFields) {\n+            if (readWatchedFields != null) {\n+                this.readWatchedFields = readWatchedFields;\n+            } else {\n+                this.readWatchedFields = Collections.emptyMap();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc read requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getReadIgnoreUsers() {\n+            return readIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc read requests\n+         * @param readIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.READ_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setReadIgnoreUsers(Set<String> readIgnoreUsers) {\n+            if (readIgnoreUsers != null) {\n+                this.readIgnoreUsers = readIgnoreUsers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 651}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwMjkwOA==", "bodyText": "what about index pattern?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r448002908", "createdAt": "2020-06-30T21:58:04Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -214,31 +397,368 @@ public void log(Logger logger) {\n             logger.info(\"Bulk requests resolution is {} during request auditing.\", resolveBulkRequests ? \"enabled\" : \"disabled\");\n             logger.info(\"Index resolution is {} during request auditing.\", resolveIndices ? \"enabled\" : \"disabled\");\n             logger.info(\"Sensitive headers auditing is {}.\", excludeSensitiveHeaders ? \"enabled\" : \"disabled\");\n-            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsersMatcher);\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return \"Filter{\" +\n-                    \"isRestApiAuditEnabled=\" + isRestApiAuditEnabled +\n-                    \", disabledRestCategories=\" + disabledRestCategories +\n-                    \", isTransportApiAuditEnabled=\" + isTransportApiAuditEnabled +\n-                    \", disabledTransportCategories=\" + disabledTransportCategories +\n-                    \", resolveBulkRequests=\" + resolveBulkRequests +\n-                    \", logRequestBody=\" + logRequestBody +\n-                    \", resolveIndices=\" + resolveIndices +\n-                    \", excludeSensitiveHeaders=\" + excludeSensitiveHeaders +\n-                    \", ignoredAuditUsers=\" + ignoredAuditUsersMatcher +\n-                    \", ignoreAuditRequests=\" + ignoredAuditRequestsMatcher +\n-                    '}';\n+            logger.info(\"Auditing requests from {} users is disabled.\", ignoredAuditUsers);\n+        }\n+    }\n+\n+    public static class Compliance {\n+        @JsonProperty(value = Key.ENABLED)\n+        private boolean complianceEnabled = true;\n+        @JsonProperty(value = Key.INTERNAL_CONFIG_ENABLED)\n+        private boolean internalConfigEnabled = true;\n+        @JsonProperty(value = Key.EXTERNAL_CONFIG_ENABLED)\n+        private boolean externalConfigEnabled = false;\n+        @JsonProperty(value = Key.READ_METADATA_ONLY)\n+        private boolean readMetadataOnly = true;\n+        @JsonProperty(value = Key.READ_WATCHED_FIELDS)\n+        private Map<String, Set<String>> readWatchedFields = Collections.emptyMap();\n+        @JsonProperty(value = Key.READ_IGNORE_USERS)\n+        private Set<String> readIgnoreUsers = Collections.emptySet();\n+        @JsonProperty(value = Key.WRITE_METADATA_ONLY)\n+        private boolean writeMetadataOnly = true;\n+        @JsonProperty(value = Key.WRITE_LOG_DIFFS)\n+        private boolean writeLogDiffs = false;\n+        @JsonProperty(value = Key.WRITE_WATCHED_INDICES)\n+        private List<String> writeWatchedIndices = Collections.emptyList();\n+        @JsonProperty(value = Key.WRITE_IGNORE_USERS)\n+        private Set<String> writeIgnoreUsers = Collections.emptySet();\n+\n+        /**\n+         * Checks if compliance auditing is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isComplianceEnabled() {\n+            return complianceEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit compliance events\n+         * @param complianceEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setComplianceEnabled(boolean complianceEnabled) {\n+            this.complianceEnabled = complianceEnabled;\n+        }\n+\n+        /**\n+         * Check if auditing of internal opendistro security index is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isInternalConfigEnabled() {\n+            return internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit internal opendistro security index\n+         * @param internalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setInternalConfigEnabled(boolean internalConfigEnabled) {\n+            this.internalConfigEnabled = internalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if auditing of external configuration files is enabled\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isExternalConfigEnabled() {\n+            return externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Set whether to audit external configuration files\n+         * @param externalConfigEnabled true/false\n+         */\n+        @JsonIgnore\n+        public void setExternalConfigEnabled(boolean externalConfigEnabled) {\n+            this.externalConfigEnabled = externalConfigEnabled;\n+        }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc read requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isReadMetadataOnly() {\n+            return readMetadataOnly;\n+        }\n+\n+        /**\n+         * Set if only metadata or field names are to be logged for doc read requests\n+         * @param readMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setReadMetadataOnly(boolean readMetadataOnly) {\n+            this.readMetadataOnly = readMetadataOnly;\n+        }\n+\n+        /**\n+         * Get list of fields to watch for, in a document in an index\n+         * @return index name mapped to a set of fields\n+         */\n+        @JsonIgnore\n+        public Map<String, Set<String>> getReadWatchedFields() {\n+            return readWatchedFields;\n+        }\n+\n+        /**\n+         * Set list of fields to watch for, in a document in an index\n+         * @param readWatchedFields index name mapped to a set of fields\n+         */\n+        @JsonSetter(value = Key.READ_WATCHED_FIELDS, nulls = Nulls.AS_EMPTY)\n+        public void setReadWatchedFields(Map<String, Set<String>> readWatchedFields) {\n+            if (readWatchedFields != null) {\n+                this.readWatchedFields = readWatchedFields;\n+            } else {\n+                this.readWatchedFields = Collections.emptyMap();\n+            }\n+        }\n+\n+        /**\n+         * Get users ignored for auditing doc read requests\n+         * @return set of ignored users\n+         */\n+        @JsonIgnore\n+        public Set<String> getReadIgnoreUsers() {\n+            return readIgnoreUsers;\n+        }\n+\n+        /**\n+         * Set users to be ignored for auditing doc read requests\n+         * @param readIgnoreUsers users\n+         */\n+        @JsonSetter(value = Key.READ_IGNORE_USERS, nulls = Nulls.AS_EMPTY)\n+        public void setReadIgnoreUsers(Set<String> readIgnoreUsers) {\n+            if (readIgnoreUsers != null) {\n+                this.readIgnoreUsers = readIgnoreUsers;\n+            } else {\n+                this.readIgnoreUsers = Collections.emptySet();\n+            }\n         }\n+\n+        /**\n+         * Checks if only metadata or field names are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteMetadataOnly() {\n+            return writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Set whether to log only metadata for doc write requests\n+         * @param writeMetadataOnly true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteMetadataOnly(boolean writeMetadataOnly) {\n+            this.writeMetadataOnly = writeMetadataOnly;\n+        }\n+\n+        /**\n+         * Checks if only diffs are to be logged for doc write requests\n+         * @return true/false\n+         */\n+        @JsonIgnore\n+        public boolean isWriteLogDiffs() {\n+            return writeLogDiffs;\n+        }\n+\n+        /**\n+         * Set whether to log only diffs for doc write requests\n+         * @param writeLogDiffs true/false\n+         */\n+        @JsonIgnore\n+        public void setWriteLogDiffs(boolean writeLogDiffs) {\n+            this.writeLogDiffs = writeLogDiffs;\n+        }\n+\n+        /**\n+         * Get list of indices to watch for doc write requests\n+         * @return indices\n+         */\n+        @JsonIgnore\n+        public List<String> getWriteWatchedIndices() {\n+            return writeWatchedIndices;\n+        }\n+\n+        /**\n+         * Set indices to watch for doc write requests\n+         * @param writeWatchedIndices indices\n+         */\n+        @JsonSetter(value = Key.WRITE_WATCHED_INDICES, nulls = Nulls.AS_EMPTY)\n+        public void setWriteWatchedIndices(List<String> writeWatchedIndices) {\n+            if (writeWatchedIndices != null) {\n+                this.writeWatchedIndices = writeWatchedIndices;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0428f4e7cccd5a45593d185f723a226d0e575683"}, "originalPosition": 709}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/10a0364651675214231d1a9da7f803a8fa091be1", "committedDate": "2020-07-06T08:05:29Z", "message": "Update REST permission info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzU2MDE2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443356016", "createdAt": "2020-07-06T19:37:41Z", "commit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTozNzo0MVrOGtkneA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjoyMDoyMlrOGto53Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzOTAzMg==", "bodyText": "Why we need this?\nShould we also log internalConfig ?\nwhat about logging external/internal config changes for \"onAuditConfigFilterChanged\" ?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450439032", "createdAt": "2020-07-06T19:37:41Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -98,22 +103,26 @@\n         writeClasses.add(DeleteRequest.class.getSimpleName());\n     }\n \n-    protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService, final boolean dlsFlsAvailable) {\n+    protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService, final Environment environment) {\n         super();\n         this.threadPool = threadPool;\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n-        this.auditConfigFilter = AuditConfig.Filter.from(settings);\n-        this.auditConfigFilter.log(log);\n         this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-        if (dlsFlsAvailable) {\n-            this.complianceConfig = ComplianceConfig.from(settings);\n-            this.complianceConfig.log(log);\n-        } else {\n-            this.complianceConfig = null;\n-            log.debug(\"Compliance config is null because DLS-FLS is not available.\");\n-        }\n+        this.environment = environment;\n+    }\n+\n+    protected void onAuditConfigFilterChanged(AuditConfig.Filter auditConfigFilter) {\n+        this.auditConfigFilter = auditConfigFilter;\n+        this.auditConfigFilter.log(log);\n+    }\n+\n+    protected void onComplianceConfigChanged(ComplianceConfig complianceConfig) {\n+        this.complianceConfig = complianceConfig;\n+        enableRoutes();\n+        this.complianceConfig.log(log);\n+        logExternalConfig();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MjI1Mg==", "bodyText": "Why do we depend on dlsFls?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450442252", "createdAt": "2020-07-06T19:44:40Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditLogImpl.java", "diffHunk": "@@ -40,31 +41,43 @@\n import org.elasticsearch.transport.TransportRequest;\n \n import com.amazon.opendistroforelasticsearch.security.auditlog.routing.AuditMessageRouter;\n+import org.greenrobot.eventbus.Subscribe;\n \n public final class AuditLogImpl extends AbstractAuditLog {\n \n \tprivate final AuditMessageRouter messageRouter;\n-\tprivate final boolean enabled;\n-\n-\tAuditLogImpl(final Settings settings, final Path configPath, Client clientProvider, ThreadPool threadPool,\n-\t\t\t\t final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n-\t\tthis(settings, configPath, clientProvider, threadPool, resolver, clusterService, false);\n-\t}\n-\n-\tpublic AuditLogImpl(final Settings settings, final Path configPath, Client clientProvider, ThreadPool threadPool,\n-\t\t\t\t\t\tfinal IndexNameExpressionResolver resolver, final ClusterService clusterService, final boolean dlsFlsAvailable) {\n-\t\tsuper(settings, threadPool, resolver, clusterService, dlsFlsAvailable);\n-\n-\t\tthis.messageRouter = new AuditMessageRouter(settings, clientProvider, threadPool, configPath);\n-\t\tthis.enabled = messageRouter.isEnabled();\n-\t\tif (enabled) {\n-\t\t\tComplianceConfig complianceConfig = getComplianceConfig();\n-\t\t\tif (complianceConfig != null && complianceConfig.isEnabled()) {\n-\t\t\t\tmessageRouter.enableRoutes(settings);\n-\t\t\t}\n+\tprivate final Settings settings;\n+\tprivate final boolean dlsFlsAvailable;\n+\tprivate final boolean messageRouterEnabled;\n+\tprivate volatile boolean enabled;\n+\n+\tpublic AuditLogImpl(final Settings settings,\n+\t\t\tfinal Path configPath,\n+\t\t\tfinal Client clientProvider,\n+\t\t\tfinal ThreadPool threadPool,\n+\t\t\tfinal IndexNameExpressionResolver resolver,\n+\t\t\tfinal ClusterService clusterService) {\n+\t\tthis(settings, configPath, clientProvider, threadPool, resolver, clusterService, null, true);\n+\t}\n+\n+\tpublic AuditLogImpl(final Settings settings,\n+\t\t\t\t\t\tfinal Path configPath,\n+\t\t\t\t\t\tfinal Client clientProvider,\n+\t\t\t\t\t\tfinal ThreadPool threadPool,\n+\t\t\t\t\t\tfinal IndexNameExpressionResolver resolver,\n+\t\t\t\t\t\tfinal ClusterService clusterService,\n+\t\t\t\t\t\tfinal Environment environment,\n+\t\t\t\t\t\tfinal boolean dlsFlsAvailable) {\n+\t\tsuper(settings, threadPool, resolver, clusterService, environment);\n+\t\tthis.settings = settings;\n+\t\tthis.dlsFlsAvailable = dlsFlsAvailable;\n+\t\tif (!dlsFlsAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwNzQxMQ==", "bodyText": "Lets add comments why this is the right place for logExternalConfig?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450507411", "createdAt": "2020-07-06T22:15:06Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -98,22 +103,26 @@\n         writeClasses.add(DeleteRequest.class.getSimpleName());\n     }\n \n-    protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService, final boolean dlsFlsAvailable) {\n+    protected AbstractAuditLog(Settings settings, final ThreadPool threadPool, final IndexNameExpressionResolver resolver, final ClusterService clusterService, final Environment environment) {\n         super();\n         this.threadPool = threadPool;\n         this.settings = settings;\n         this.resolver = resolver;\n         this.clusterService = clusterService;\n-        this.auditConfigFilter = AuditConfig.Filter.from(settings);\n-        this.auditConfigFilter.log(log);\n         this.opendistrosecurityIndex = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CONFIG_INDEX_NAME, ConfigConstants.OPENDISTRO_SECURITY_DEFAULT_CONFIG_INDEX);\n-        if (dlsFlsAvailable) {\n-            this.complianceConfig = ComplianceConfig.from(settings);\n-            this.complianceConfig.log(log);\n-        } else {\n-            this.complianceConfig = null;\n-            log.debug(\"Compliance config is null because DLS-FLS is not available.\");\n-        }\n+        this.environment = environment;\n+    }\n+\n+    protected void onAuditConfigFilterChanged(AuditConfig.Filter auditConfigFilter) {\n+        this.auditConfigFilter = auditConfigFilter;\n+        this.auditConfigFilter.log(log);\n+    }\n+\n+    protected void onComplianceConfigChanged(ComplianceConfig complianceConfig) {\n+        this.complianceConfig = complianceConfig;\n+        enableRoutes();\n+        this.complianceConfig.log(log);\n+        logExternalConfig();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzOTAzMg=="}, "originalCommit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwOTI3Nw==", "bodyText": "enable/disable or SSLOnlyMode\nso lets raise separate PR to remove this flag", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450509277", "createdAt": "2020-07-06T22:20:22Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditLogImpl.java", "diffHunk": "@@ -40,31 +41,43 @@\n import org.elasticsearch.transport.TransportRequest;\n \n import com.amazon.opendistroforelasticsearch.security.auditlog.routing.AuditMessageRouter;\n+import org.greenrobot.eventbus.Subscribe;\n \n public final class AuditLogImpl extends AbstractAuditLog {\n \n \tprivate final AuditMessageRouter messageRouter;\n-\tprivate final boolean enabled;\n-\n-\tAuditLogImpl(final Settings settings, final Path configPath, Client clientProvider, ThreadPool threadPool,\n-\t\t\t\t final IndexNameExpressionResolver resolver, final ClusterService clusterService) {\n-\t\tthis(settings, configPath, clientProvider, threadPool, resolver, clusterService, false);\n-\t}\n-\n-\tpublic AuditLogImpl(final Settings settings, final Path configPath, Client clientProvider, ThreadPool threadPool,\n-\t\t\t\t\t\tfinal IndexNameExpressionResolver resolver, final ClusterService clusterService, final boolean dlsFlsAvailable) {\n-\t\tsuper(settings, threadPool, resolver, clusterService, dlsFlsAvailable);\n-\n-\t\tthis.messageRouter = new AuditMessageRouter(settings, clientProvider, threadPool, configPath);\n-\t\tthis.enabled = messageRouter.isEnabled();\n-\t\tif (enabled) {\n-\t\t\tComplianceConfig complianceConfig = getComplianceConfig();\n-\t\t\tif (complianceConfig != null && complianceConfig.isEnabled()) {\n-\t\t\t\tmessageRouter.enableRoutes(settings);\n-\t\t\t}\n+\tprivate final Settings settings;\n+\tprivate final boolean dlsFlsAvailable;\n+\tprivate final boolean messageRouterEnabled;\n+\tprivate volatile boolean enabled;\n+\n+\tpublic AuditLogImpl(final Settings settings,\n+\t\t\tfinal Path configPath,\n+\t\t\tfinal Client clientProvider,\n+\t\t\tfinal ThreadPool threadPool,\n+\t\t\tfinal IndexNameExpressionResolver resolver,\n+\t\t\tfinal ClusterService clusterService) {\n+\t\tthis(settings, configPath, clientProvider, threadPool, resolver, clusterService, null, true);\n+\t}\n+\n+\tpublic AuditLogImpl(final Settings settings,\n+\t\t\t\t\t\tfinal Path configPath,\n+\t\t\t\t\t\tfinal Client clientProvider,\n+\t\t\t\t\t\tfinal ThreadPool threadPool,\n+\t\t\t\t\t\tfinal IndexNameExpressionResolver resolver,\n+\t\t\t\t\t\tfinal ClusterService clusterService,\n+\t\t\t\t\t\tfinal Environment environment,\n+\t\t\t\t\t\tfinal boolean dlsFlsAvailable) {\n+\t\tsuper(settings, threadPool, resolver, clusterService, environment);\n+\t\tthis.settings = settings;\n+\t\tthis.dlsFlsAvailable = dlsFlsAvailable;\n+\t\tif (!dlsFlsAvailable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MjI1Mg=="}, "originalCommit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDg3NDk3", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443487497", "createdAt": "2020-07-07T00:35:01Z", "commit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMDozNTowMlrOGtrSqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMDozNTowMlrOGtrSqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU0ODM5NA==", "bodyText": "Are we blocking all APIs including get?\nI thought get we are allowing and returning value of elasticsearch.yml", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450548394", "createdAt": "2020-07-07T00:35:02Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiAction.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AuditValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+/**\n+ * Rest handler for fetching and updating audit configuration.\n+ * Supported REST endpoints\n+ * GET _opendistro/_security/api/audit/\n+ * {\n+ *   \"config\" : {\n+ *     \"audit\" : {\n+ *       \"enable_rest\" : true,\n+ *       \"disabled_rest_categories\" : [\n+ *         \"GRANTED_PRIVILEGES\",\n+ *         \"SSL_EXCEPTION\"\n+ *       ],\n+ *       \"enable_transport\" : true,\n+ *       \"disabled_transport_categories\" : [\n+ *         \"GRANTED_PRIVILEGES\",\n+ *         \"AUTHENTICATED\"\n+ *       ],\n+ *       \"resolve_bulk_requests\" : false,\n+ *       \"log_request_body\" : true,\n+ *       \"resolve_indices\" : true,\n+ *       \"exclude_sensitive_headers\" : true,\n+ *       \"ignore_users\" : [\n+ *         \"kibanaserver\"\n+ *       ],\n+ *       \"ignore_requests\" : [ ]\n+ *     },\n+ *     \"compliance\" : {\n+ *       \"internal_config\" : true,\n+ *       \"external_config\" : true,\n+ *       \"read_metadata_only\" : true,\n+ *       \"read_watched_fields\" : { },\n+ *       \"read_ignore_users\" : [ ],\n+ *       \"write_metadata_only\" : true,\n+ *       \"write_log_diffs\" : false,\n+ *       \"write_watched_indices\" : [ ],\n+ *       \"write_ignore_users\" : [ ]\n+ *     }\n+ *   }\n+ * }\n+ *\n+ * PUT _opendistro/_security/api/audit/config\n+ * {\n+ *   \"audit\":{\n+ *     \"enable_rest\":true,\n+ *     \"disabled_rest_categories\":[\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"SSL_EXCEPTION\"\n+ *     ],\n+ *     \"enable_transport\":true,\n+ *     \"disabled_transport_categories\":[\n+ *       \"GRANTED_PRIVILEGES\",\n+ *       \"AUTHENTICATED\"\n+ *     ],\n+ *     \"resolve_bulk_requests\":false,\n+ *     \"log_request_body\":true,\n+ *     \"resolve_indices\":true,\n+ *     \"exclude_sensitive_headers\":true,\n+ *     \"ignore_users\":[ ],\n+ *     \"ignore_requests\":[ ]\n+ *   },\n+ *   \"compliance\":{\n+ *     \"internal_config\":true,\n+ *     \"external_config\":true,\n+ *     \"read_metadata_only\":true,\n+ *     \"read_watched_fields\":{ },\n+ *     \"read_ignore_users\":[ ],\n+ *     \"write_metadata_only\":true,\n+ *     \"write_log_diffs\":false,\n+ *     \"write_watched_indices\":[ ],\n+ *     \"write_ignore_users\":[ ]\n+ *   }\n+ * }\n+ *\n+ * PATCH _opendistro/_security/api/audit\n+ * [{\"op\": \"replace\", \"path\": \"/config/audit/enable_rest\", \"value\": \"true\"}]\n+ * [{\"op\": \"replace\", \"path\": \"/config/compliance/internal_config\", \"value\": \"true\"}]\n+ */\n+public class AuditApiAction extends PatchableResourceApiAction {\n+    private static final List<Route> routes = ImmutableList.of(\n+            new Route(RestRequest.Method.GET, \"/_opendistro/_security/api/audit/\"),\n+            new Route(RestRequest.Method.PUT, \"/_opendistro/_security/api/audit/{name}\"),\n+            new Route(RestRequest.Method.PATCH, \"/_opendistro/_security/api/audit/\")\n+    );\n+\n+    private static final String RESOURCE_NAME = \"config\";\n+    private final PrivilegesEvaluator privilegesEvaluator;\n+    private final ThreadContext threadContext;\n+\n+    public AuditApiAction(final Settings settings,\n+                          final Path configPath,\n+                          final RestController controller,\n+                          final Client client,\n+                          final AdminDNs adminDNs,\n+                          final ConfigurationRepository cl,\n+                          final ClusterService cs,\n+                          final PrincipalExtractor principalExtractor,\n+                          final PrivilegesEvaluator privilegesEvaluator,\n+                          final ThreadPool threadPool,\n+                          final AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, privilegesEvaluator, threadPool, auditLog);\n+        this.privilegesEvaluator = privilegesEvaluator;\n+        this.threadContext = threadPool.getThreadContext();\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return routes;\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(final RestChannel channel, final RestRequest request, final Client client) throws IOException {\n+        // if audit config doc is not available in security index,\n+        // disable audit APIs\n+        if (!cl.isAuditHotReloadingEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10a0364651675214231d1a9da7f803a8fa091be1"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/3f82e54f60cf1d736c4fff932fb590d1e369c4d6", "committedDate": "2020-07-07T02:28:50Z", "message": "code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac02a9d956be93961b849527306e9a19af4a3538", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/ac02a9d956be93961b849527306e9a19af4a3538", "committedDate": "2020-07-07T02:37:57Z", "message": "Merge remote-tracking branch 'upstream/master' into auditlog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTI2MzUx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443526351", "createdAt": "2020-07-07T02:49:12Z", "commit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMjo0OToxM1rOGttW-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMjo1MTo1NVrOGttZpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MjI2Ng==", "bodyText": "Add Example or remove Eg:", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450582266", "createdAt": "2020-07-07T02:49:13Z", "author": {"login": "hardik-k-shah"}, "path": "legacy/securityconfig_v6/audit.yml.example", "diffHunk": "@@ -1,46 +1,77 @@\n config:\n-  # enable/disable auditlog\n+  # enable/disable audit logging\n   enabled: true\n \n   audit:\n-    # rest\n+    # Enable/disable REST API auditing\n     enable_rest: true\n+\n+    # Categories to exclude from REST API auditing\n     disabled_rest_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # transport\n+    # Enable/disable Transport API auditing\n     enable_transport: true\n+\n+    # Categories to exclude from Transport API auditing\n     disabled_transport_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # ignore\n+    # Users to be excluded from auditing. Wildcard patterns are supported\n     ignore_users:\n       - kibanaserver\n+\n+    # Requests to be excluded from auditing. Wildcard patterns are supported\n     ignore_requests: []\n \n-    # verbose attributes\n+    # Log individual operations in a bulk request\n     resolve_bulk_requests: false\n+\n+    # Include the body of the request (if available) for both REST and the transport layer\n     log_request_body: true\n+\n+    # Logs all indices affected by a request. Resolves aliases and wildcards/date patterns\n     resolve_indices: true\n+\n+    # Exclude sensitive headers from being included in the logs. Eg: Authorization\n     exclude_sensitive_headers: true\n \n   compliance:\n     # enable/disable compliance\n     enabled: true\n \n-    # configs\n+    # Log updates to internal security changes\n     internal_config: true\n-    external_config: true\n \n-    # compliance read\n+    # Log external config files for the node\n+    external_config: false\n+\n+    # Log only metadata of the document for read events\n     read_metadata_only: true\n+\n+    # Map of indexes and fields to monitor for read events. Wildcard patterns are supported for both index names and fields. Eg:\n+    # read_watched_fields: {\n+    #   \"twitter\": [\"message\"]\n+    #   \"logs-*\": [\"id\", \"attr*\"]\n+    # }\n     read_watched_fields: {}\n-    read_ignore_users: []\n \n-    # compliance write\n+    # List of users to ignore for read events\n+    read_ignore_users:\n+      - kibanaserver\n+\n+    # Log only metadata of the document for write events\n     write_metadata_only: true\n+\n+    # Log only diffs for document updates\n     write_log_diffs: false\n+\n+    # List of indices to watch for write events. Wildcard patterns are supported\n+    # write_watched_indices: [\"twitter\", \"logs-*\"]\n     write_watched_indices: []\n-    write_ignore_users: []\n+\n+    # List of users to ignore for write events. Wildcard patterns are supported. Eg:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MjMyNA==", "bodyText": "wildcard pattern?", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450582324", "createdAt": "2020-07-07T02:49:28Z", "author": {"login": "hardik-k-shah"}, "path": "legacy/securityconfig_v6/audit.yml.example", "diffHunk": "@@ -1,46 +1,77 @@\n config:\n-  # enable/disable auditlog\n+  # enable/disable audit logging\n   enabled: true\n \n   audit:\n-    # rest\n+    # Enable/disable REST API auditing\n     enable_rest: true\n+\n+    # Categories to exclude from REST API auditing\n     disabled_rest_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # transport\n+    # Enable/disable Transport API auditing\n     enable_transport: true\n+\n+    # Categories to exclude from Transport API auditing\n     disabled_transport_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # ignore\n+    # Users to be excluded from auditing. Wildcard patterns are supported\n     ignore_users:\n       - kibanaserver\n+\n+    # Requests to be excluded from auditing. Wildcard patterns are supported\n     ignore_requests: []\n \n-    # verbose attributes\n+    # Log individual operations in a bulk request\n     resolve_bulk_requests: false\n+\n+    # Include the body of the request (if available) for both REST and the transport layer\n     log_request_body: true\n+\n+    # Logs all indices affected by a request. Resolves aliases and wildcards/date patterns\n     resolve_indices: true\n+\n+    # Exclude sensitive headers from being included in the logs. Eg: Authorization\n     exclude_sensitive_headers: true\n \n   compliance:\n     # enable/disable compliance\n     enabled: true\n \n-    # configs\n+    # Log updates to internal security changes\n     internal_config: true\n-    external_config: true\n \n-    # compliance read\n+    # Log external config files for the node\n+    external_config: false\n+\n+    # Log only metadata of the document for read events\n     read_metadata_only: true\n+\n+    # Map of indexes and fields to monitor for read events. Wildcard patterns are supported for both index names and fields. Eg:\n+    # read_watched_fields: {\n+    #   \"twitter\": [\"message\"]\n+    #   \"logs-*\": [\"id\", \"attr*\"]\n+    # }\n     read_watched_fields: {}\n-    read_ignore_users: []\n \n-    # compliance write\n+    # List of users to ignore for read events", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MjUyOA==", "bodyText": "same as above", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450582528", "createdAt": "2020-07-07T02:50:14Z", "author": {"login": "hardik-k-shah"}, "path": "securityconfig/audit.yml.example", "diffHunk": "@@ -3,50 +3,79 @@ _meta:\n   config_version: 2\n \n config:\n-  # enable/disable auditlog\n+  # enable/disable audit logging\n   enabled: true\n \n   audit:\n-    # rest\n+    # Enable/disable REST API auditing\n     enable_rest: true\n+\n+    # Categories to exclude from REST API auditing\n     disabled_rest_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # transport\n+    # Enable/disable Transport API auditing\n     enable_transport: true\n+\n+    # Categories to exclude from Transport API auditing\n     disabled_transport_categories:\n       - AUTHENTICATED\n       - GRANTED_PRIVILEGES\n \n-    # ignore\n+    # Users to be excluded from auditing. Wildcard patterns are supported\n     ignore_users:\n       - kibanaserver\n+\n+    # Requests to be excluded from auditing. Wildcard patterns are supported\n     ignore_requests: []\n \n-    # verbose attributes\n+    # Log individual operations in a bulk request\n     resolve_bulk_requests: false\n+\n+    # Include the body of the request (if available) for both REST and the transport layer\n     log_request_body: true\n+\n+    # Logs all indices affected by a request. Resolves aliases and wildcards/date patterns\n     resolve_indices: true\n+\n+    # Exclude sensitive headers from being included in the logs. Eg: Authorization\n     exclude_sensitive_headers: true\n \n   compliance:\n     # enable/disable compliance\n     enabled: true\n \n-    # configs\n+    # Log updates to internal security changes\n     internal_config: true\n+\n+    # Log external config files for the node\n     external_config: false\n \n-    # compliance read\n+    # Log only metadata of the document for read events\n     read_metadata_only: true\n+\n+    # Map of indexes and fields to monitor for read events. Wildcard patterns are supported for both index names and fields. Eg:\n+    # read_watched_fields: {\n+    #   \"twitter\": [\"message\"]\n+    #   \"logs-*\": [\"id\", \"attr*\"]\n+    # }\n     read_watched_fields: {}\n+\n+    # List of users to ignore for read events\n     read_ignore_users:\n       - kibanaserver\n \n-    # compliance write\n+    # Log only metadata of the document for write events\n     write_metadata_only: true\n+\n+    # Log only diffs for document updates\n     write_log_diffs: false\n+\n+    # List of indices to watch for write events. Wildcard patterns are supported\n+    # write_watched_indices: [\"twitter\", \"logs-*\"]\n     write_watched_indices: []\n+\n+    # List of users to ignore for write events. Wildcard patterns are supported. Eg:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4Mjk1MA==", "bodyText": "And externalConfig parameter can be hot-reloadable which will impact functionality of \"logExternalConfig()\"", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450582950", "createdAt": "2020-07-07T02:51:55Z", "author": {"login": "hardik-k-shah"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AbstractAuditLog.java", "diffHunk": "@@ -122,6 +122,8 @@ protected void onComplianceConfigChanged(ComplianceConfig complianceConfig) {\n         this.complianceConfig = complianceConfig;\n         enableRoutes();\n         this.complianceConfig.log(log);\n+        // External config is audit logged only once per node start and config from index is not available at that time.\n+        // The audit event will be created only if enabled and not already logged.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f82e54f60cf1d736c4fff932fb590d1e369c4d6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf5be4b35184edf13331b7d9aec5611ad1bfd67", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/5bf5be4b35184edf13331b7d9aec5611ad1bfd67", "committedDate": "2020-07-07T04:52:48Z", "message": "Serialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdfc2819e3a280d44d43164fa395c4a7985655d3", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/cdfc2819e3a280d44d43164fa395c4a7985655d3", "committedDate": "2020-07-07T05:11:55Z", "message": "Merge remote-tracking branch 'upstream/master' into auditlog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/c0a9f1f3df69f06ed8f8cf4df0da14114b146b03", "committedDate": "2020-07-07T05:18:41Z", "message": "code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTcxODM4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443571838", "createdAt": "2020-07-07T05:28:40Z", "commit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNToyODo0MFrOGtvmyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNToyODo0MFrOGtvmyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxOTA4Mg==", "bodyText": "Duplicate import. Please check merge.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450619082", "createdAt": "2020-07-07T05:28:40Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -17,6 +18,9 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper.getOrDefault;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTcyMTA4", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443572108", "createdAt": "2020-07-07T05:29:28Z", "commit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNToyOToyOFrOGtvnzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNToyOToyOFrOGtvnzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYxOTM0MA==", "bodyText": "nit: add new line.", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450619340", "createdAt": "2020-07-07T05:29:28Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -340,4 +344,36 @@ public String toString() {\n                     '}';\n         }\n     }\n-}\n+\n+    /**\n+     * List of keys that are deprecated\n+     */\n+    public static final List<String> DEPRECATED_KEYS = ImmutableList.of(\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_LOG_REQUEST_BODY,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_INDICES,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_EXCLUDE_SENSITIVE_HEADERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_AUDIT_IGNORE_REQUESTS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_INTERNAL_CONFIG_ENABLED,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_EXTERNAL_CONFIG_ENABLED,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_METADATA_ONLY,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_READ_WATCHED_FIELDS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_METADATA_ONLY,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_LOG_DIFFS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_IGNORE_USERS,\n+            ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_WATCHED_INDICES\n+    );\n+\n+    public static Set<String> getDeprecatedKeys(final Settings settings) {\n+        return AuditConfig.DEPRECATED_KEYS\n+                .stream()\n+                .filter(settings::hasValue)\n+                .collect(Collectors.toSet());\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39ad3d24eccac5e5221a3058d561bcf3afa46f25", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/39ad3d24eccac5e5221a3058d561bcf3afa46f25", "committedDate": "2020-07-07T05:30:26Z", "message": "add newlines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTc1NTM2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443575536", "createdAt": "2020-07-07T05:40:03Z", "commit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTo0MDowM1rOGtvyyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNTo0MDowM1rOGtvyyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyMjE1Mg==", "bodyText": "it can be kept private", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450622152", "createdAt": "2020-07-07T05:40:03Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -105,7 +109,7 @@ public static AuditConfig from(final Settings settings) {\n      * Audit logger will use these settings to determine what audit logs are to be generated.\n      */\n     public static class Filter {\n-        private static final Filter DEFAULT = Filter.from(Settings.EMPTY);\n+        public static final Filter DEFAULT = Filter.from(Settings.EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0a9f1f3df69f06ed8f8cf4df0da14114b146b03"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjEwMjk2", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443610296", "createdAt": "2020-07-07T06:57:54Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjo1Nzo1NFrOGtxcWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjo1Nzo1NFrOGtxcWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0OTE3Ng==", "bodyText": "This can be simplified to ImmutableSet.of(\"enable_rest\", ...).containsAll(properties.keySet()) with ImmutableSet.of(...) being private static Set<String>", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450649176", "createdAt": "2020-07-07T06:57:54Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfig.java", "diffHunk": "@@ -161,6 +164,24 @@ static Filter from(Map<String, Object> properties) {\n             final Set<String> ignoredAuditUsers = ImmutableSet.copyOf(getOrDefault(properties, \"ignore_users\", DEFAULT_IGNORED_USERS));\n             final Set<String> ignoreAuditRequests = ImmutableSet.copyOf(getOrDefault(properties, \"ignore_requests\", Collections.emptyList()));\n \n+            boolean invalid = properties.keySet()", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjIwMzg3", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-443620387", "createdAt": "2020-07-07T07:14:54Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzoxNDo1NFrOGtx5dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzoxNDo1NFrOGtx5dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY1NjYyOQ==", "bodyText": "nit: undo this change", "url": "https://github.com/opensearch-project/security/pull/409#discussion_r450656629", "createdAt": "2020-07-07T07:14:54Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/auditlog/config/AuditConfigFilterTest.java", "diffHunk": "@@ -111,4 +111,4 @@ public void testEmpty() {\n         assertTrue(auditConfigFilter.getDisabledRestCategories().isEmpty());\n         assertTrue(auditConfigFilter.getDisabledTransportCategories().isEmpty());\n     }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73f9611f251332e0d51e06b036722ffe9a90bc59", "author": {"user": {"login": "sujithvm", "name": "Sujith Vadakkepat"}}, "url": "https://github.com/opensearch-project/security/commit/73f9611f251332e0d51e06b036722ffe9a90bc59", "committedDate": "2020-07-07T07:28:22Z", "message": "Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDQwMzAz", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-444040303", "createdAt": "2020-07-07T16:07:34Z", "commit": {"oid": "73f9611f251332e0d51e06b036722ffe9a90bc59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTE2Mjkx", "url": "https://github.com/opensearch-project/security/pull/409#pullrequestreview-444116291", "createdAt": "2020-07-07T17:45:12Z", "commit": {"oid": "73f9611f251332e0d51e06b036722ffe9a90bc59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2892, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}