{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MzMwMTQ2", "number": 234, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMjowNjo1N1rODgg3uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMjo1ODo0N1rODghVbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NDE5NTc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMjowNjo1N1rOFqwk4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMDozNToyMVrOFqyNxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDM4NQ==", "bodyText": "I am not sure if we should change channel to innerChannel here.", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380380385", "createdAt": "2020-02-17T22:06:57Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "diffHunk": "@@ -126,16 +126,9 @@ protected void messageReceivedDecorate(final T request, final TransportRequestHa\n \n             String channelType = transportChannel.getChannelType();\n \n-            if(!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n-                Class wrappedChannelCls = transportChannel.getClass();\n-\n-                try {\n-                    Method getInnerChannel = wrappedChannelCls.getMethod(\"getInnerChannel\", null);\n-                    TransportChannel innerChannel = (TransportChannel)(getInnerChannel.invoke(transportChannel));\n-                    channelType = innerChannel.getChannelType();\n-                } catch (NoSuchMethodException ex) {\n-                    throw new RuntimeException(\"Unknown channel type \" + channelType + \" does not implement getInnerChannel method.\");\n-                }\n+            if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+                TransportChannel innerChannel = getInnerChannel(transportChannel);\n+                channelType = innerChannel.getChannelType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwNzIzOA==", "bodyText": "Afaik its fine to change channel to innerChannel here.\nIn our previous PR's we override the channelType value instead of the channel value but the idea behind the two seem to be the same - https://github.com/opendistro-for-elasticsearch/security-ssl/pull/2/files; https://github.com/opendistro-for-elasticsearch/security/pull/3/files.", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380407238", "createdAt": "2020-02-18T00:35:21Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/OpenDistroSecurityRequestHandler.java", "diffHunk": "@@ -126,16 +126,9 @@ protected void messageReceivedDecorate(final T request, final TransportRequestHa\n \n             String channelType = transportChannel.getChannelType();\n \n-            if(!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n-                Class wrappedChannelCls = transportChannel.getClass();\n-\n-                try {\n-                    Method getInnerChannel = wrappedChannelCls.getMethod(\"getInnerChannel\", null);\n-                    TransportChannel innerChannel = (TransportChannel)(getInnerChannel.invoke(transportChannel));\n-                    channelType = innerChannel.getChannelType();\n-                } catch (NoSuchMethodException ex) {\n-                    throw new RuntimeException(\"Unknown channel type \" + channelType + \" does not implement getInnerChannel method.\");\n-                }\n+            if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+                TransportChannel innerChannel = getInnerChannel(transportChannel);\n+                channelType = innerChannel.getChannelType();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDM4NQ=="}, "originalCommit": null, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NDE5NjY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMjowNzozN1rOFqwlYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMzo1NDoyM1rOFqx0xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA==", "bodyText": "Also wondering if this check should come after the following if (!\"transport\".equals(channel.getChannelType())) check", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380380514", "createdAt": "2020-02-17T22:07:37Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTQyOA==", "bodyText": "Please include comments about why this check needs to be there.", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391428", "createdAt": "2020-02-17T22:58:00Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MzIyNQ==", "bodyText": "Sure. Will add comments. Can you verify the logic ?", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380393225", "createdAt": "2020-02-17T23:07:37Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5NzYzOQ==", "bodyText": "Logic seems fine for PA. As an extra measure we can verify that the returned channel from getInnerChannel is of channelType transport.", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380397639", "createdAt": "2020-02-17T23:32:52Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODE1NA==", "bodyText": "throw a runtime error if its not basic and transport ?", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398154", "createdAt": "2020-02-17T23:36:27Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODY5NQ==", "bodyText": "I think so, esp since we're expecting the Wrapper classes getInnerChannel to return a transport channel.", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398695", "createdAt": "2020-02-17T23:40:01Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwMDgzOA==", "bodyText": "We are getting a transport channel but the issue is with the channelType, custom implementations may pass", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380400838", "createdAt": "2020-02-17T23:54:23Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {\n+            channel = getInnerChannel(channel);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM4MDUxNA=="}, "originalCommit": null, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NDI3MTgyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMjo1ODo0N1rOFqxQmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMzozNToyOVrOFqxpvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng==", "bodyText": "Wasn't this originally - (!\"netty\".equals(channel.getChannelType()) && !\"direct\".equals(channel.getChannelType())) based on https://github.com/opendistro-for-elasticsearch/security-ssl/pull/2/files.\nWhy are we checking for !channelType.equals(\"transport\")?", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391576", "createdAt": "2020-02-17T22:58:47Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTgyNQ==", "bodyText": "Maybe its changed from elastic side elastic/elasticsearch#40074", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380391825", "createdAt": "2020-02-17T23:00:15Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng=="}, "originalCommit": null, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5ODAxMw==", "bodyText": "Thanks for clarifying", "url": "https://github.com/opensearch-project/security/pull/234#discussion_r380398013", "createdAt": "2020-02-17T23:35:29Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/ssl/transport/OpenDistroSecuritySSLRequestHandler.java", "diffHunk": "@@ -81,6 +82,11 @@ public final void messageReceived(T request, TransportChannel channel, Task task\n             channel.sendResponse(exception);\n             throw exception;\n         }\n+\n+        String channelType = channel.getChannelType();\n+        if (!channelType.equals(\"direct\") && !channelType.equals(\"transport\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM5MTU3Ng=="}, "originalCommit": null, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2520, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}