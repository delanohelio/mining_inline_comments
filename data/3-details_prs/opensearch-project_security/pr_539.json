{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNzM1NTg4", "number": 539, "title": "Decrypt assertions", "bodyText": "Issue #, if available:\nProblem discussed here: https://discuss.opendistrocommunity.dev/t/saml-encrypted-assertion-problem/530/2\nDescription of changes:\nPorting over PR from deprecated project: opendistro-for-elasticsearch/deprecated-security-advanced-modules#29\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-01T14:24:29Z", "url": "https://github.com/opensearch-project/security/pull/539", "merged": true, "mergeCommit": {"oid": "cfd083a126c55ab98a60496c5ff3ad4490bee41d"}, "closed": true, "closedAt": "2020-07-22T22:01:13Z", "author": {"login": "jcleezer"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwtknRAFqTQ0MDk4OTM1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3hBdtgFqTQ1MzY2ODE0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTg5MzUz", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-440989353", "createdAt": "2020-07-01T15:43:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTo0MzoxMlrOGrrarg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNzoxOTo1NVrOGruxug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MzI5NA==", "bodyText": "Avoid changing import order", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r448453294", "createdAt": "2020-07-01T15:43:12Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/HTTPSamlAuthenticator.java", "diffHunk": "@@ -15,60 +15,56 @@\n \n package com.amazon.dlic.auth.http.saml;\n \n-import java.net.URL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUwODM0Ng==", "bodyText": "I don't see why is it necessary to load key every time here instead of doing it once as it is done.", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r448508346", "createdAt": "2020-07-01T17:19:55Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -184,6 +190,25 @@ private void initIdpCerts(IDPSSODescriptor idpSsoDescriptor, HashMap<String, Obj\n         }\n     }\n \n+    private void initSpSignaturePrivateKey(Settings settings, HashMap<String, Object> configProperties, Path configPath) throws SamlConfigException {\n+        try {\n+            PrivateKey result = PemKeyReader.loadKeyFromStream(settings.get(\"sp.signature_private_key_password\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1", "committedDate": "2020-07-01T20:37:12Z", "message": "Pass SP Signature Private Key to Saml2SettingsProvider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1", "committedDate": "2020-07-01T20:37:12Z", "message": "Pass SP Signature Private Key to Saml2SettingsProvider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjM0NjY2", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-441234666", "createdAt": "2020-07-01T22:25:40Z", "commit": {"oid": "d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNTo0MFrOGr3RUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNjoyOFrOGr3SNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzUwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String spSignaturePrivateKey;\n          \n          \n            \n                private final String spSignaturePrivateKey;", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r448647504", "createdAt": "2020-07-01T22:25:40Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -54,8 +55,9 @@\n     private String idpEntityId;\n     private Saml2Settings cachedSaml2Settings;\n     private DateTime metadataUpdateTime;\n+    private String spSignaturePrivateKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzczNA==", "bodyText": "missing this.spSignaturePrivateKey = spSignaturePrivateKey", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r448647734", "createdAt": "2020-07-01T22:26:28Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -54,8 +55,9 @@\n     private String idpEntityId;\n     private Saml2Settings cachedSaml2Settings;\n     private DateTime metadataUpdateTime;\n+    private String spSignaturePrivateKey;\n \n-    Saml2SettingsProvider(Settings esSettings, MetadataResolver metadataResolver) {\n+    Saml2SettingsProvider(Settings esSettings, MetadataResolver metadataResolver, PrivateKey spSignaturePrivateKey) {\n         this.esSettings = esSettings;\n         this.metadataResolver = metadataResolver;\n         this.idpEntityId = esSettings.get(\"idp.entity_id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d576b32c6e9935a3bd2e1bebe9ea7528d6ebb1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218111980069b9912debb00fa4771c890a34967d", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/218111980069b9912debb00fa4771c890a34967d", "committedDate": "2020-07-02T17:03:00Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a60cfda7a4bdf030be128b2ffd7c7aba342e99", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/f1a60cfda7a4bdf030be128b2ffd7c7aba342e99", "committedDate": "2020-07-02T17:04:49Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/21ff3d628da026a42691a304262330dbd1e5d2d1", "committedDate": "2020-07-13T21:14:18Z", "message": "Add test for encrypted assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjM2MTk2", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-450236196", "createdAt": "2020-07-16T21:41:15Z", "commit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQyMTo0MToxNlrOGy9xwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzoyNTo1MlrOGzbLaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5NDE0NA==", "bodyText": "Please don't use wildcard import.", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456094144", "createdAt": "2020-07-16T21:41:16Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/dlic/auth/http/saml/MockSamlIdpServer.java", "diffHunk": "@@ -37,14 +37,11 @@\n import java.security.cert.Certificate;\n import java.security.cert.CertificateException;\n import java.security.cert.X509Certificate;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.Enumeration;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5Nzg4Nw==", "bodyText": "nit: undo new line", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456097887", "createdAt": "2020-07-16T21:49:40Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/dlic/auth/http/saml/MockSamlIdpServer.java", "diffHunk": "@@ -180,6 +169,7 @@\n     private String endpointQueryString;\n     private String defaultAssertionConsumerService;\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1MDU1MQ==", "bodyText": "extra space", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456550551", "createdAt": "2020-07-17T16:34:55Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -49,16 +50,18 @@\n public class Saml2SettingsProvider {\n     protected final static Logger log = LogManager.getLogger(Saml2SettingsProvider.class);\n \n-    private Settings esSettings;\n-    private MetadataResolver metadataResolver;\n-    private String idpEntityId;\n-    private Saml2Settings cachedSaml2Settings;\n-    private DateTime metadataUpdateTime;\n+    private final Settings esSettings;\n+    private final MetadataResolver metadataResolver;\n+    private final String idpEntityId;\n+    private final PrivateKey spSignaturePrivateKey;\n+    private  Saml2Settings cachedSaml2Settings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1MjkwMg==", "bodyText": "nit: move to initMisc()", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456552902", "createdAt": "2020-07-17T16:39:39Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -89,6 +92,8 @@ Saml2Settings get() throws SamlConfigException {\n \n             SettingsBuilder settingsBuilder = new SettingsBuilder();\n \n+            configProperties.put(SettingsBuilder.SP_PRIVATEKEY_PROPERTY_KEY, this.spSignaturePrivateKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NDU1NQ==", "bodyText": "Please add this as decryptAssertionsTest() (keep basicTest() as is).", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456574555", "createdAt": "2020-07-17T17:23:09Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/dlic/auth/http/saml/HTTPSamlAuthenticatorTest.java", "diffHunk": "@@ -124,9 +124,13 @@ public void basicTest() throws Exception {\n         mockSamlIdpServer.loadSigningKeys(\"saml/kirk-keystore.jks\", \"kirk\");\n         mockSamlIdpServer.setAuthenticateUser(\"horst\");\n         mockSamlIdpServer.setEndpointQueryString(null);\n+        mockSamlIdpServer.setSpSignatureCertificate(spSigningCertificate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NTg0OA==", "bodyText": "nit: this.encryptAssertion = encryptAssertion; on a separate line.", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r456575848", "createdAt": "2020-07-17T17:25:52Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/dlic/auth/http/saml/MockSamlIdpServer.java", "diffHunk": "@@ -1103,6 +1111,8 @@ public void setSignResponses(boolean signResponses) {\n         this.signResponses = signResponses;\n     }\n \n+    public void setEncryptAssertion(boolean encryptAssertion) { this.encryptAssertion = encryptAssertion;}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ff3d628da026a42691a304262330dbd1e5d2d1"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0895272761a0118b35eeca2ea7ea5288f4bc7819", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/0895272761a0118b35eeca2ea7ea5288f4bc7819", "committedDate": "2020-07-17T18:07:00Z", "message": "PR Tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "923c4ea535f78f77b55dc80eccb9853e3fbe18fd", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/923c4ea535f78f77b55dc80eccb9853e3fbe18fd", "committedDate": "2020-07-17T18:10:33Z", "message": "Remove wildcard import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f922963809c0b7267b45a1ca8b736c6c793456af", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/f922963809c0b7267b45a1ca8b736c6c793456af", "committedDate": "2020-07-17T18:11:40Z", "message": "Remove extra line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwOTkxMjky", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-450991292", "createdAt": "2020-07-17T22:43:15Z", "commit": {"oid": "f922963809c0b7267b45a1ca8b736c6c793456af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTk5MjE1", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-453599215", "createdAt": "2020-07-22T18:58:21Z", "commit": {"oid": "f922963809c0b7267b45a1ca8b736c6c793456af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1ODoyMVrOG1wDgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1ODoyMVrOG1wDgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNTA0Mg==", "bodyText": "Curious where we are using spSignaturePrivateKey in the Saml2SettingsProvider.", "url": "https://github.com/opensearch-project/security/pull/539#discussion_r459015042", "createdAt": "2020-07-22T18:58:21Z", "author": {"login": "debjanibnrj"}, "path": "src/main/java/com/amazon/dlic/auth/http/saml/Saml2SettingsProvider.java", "diffHunk": "@@ -133,6 +136,7 @@ private boolean isUpdateRequired() {\n     private void initMisc(HashMap<String, Object> configProperties) {\n         configProperties.put(SettingsBuilder.STRICT_PROPERTY_KEY, true);\n         configProperties.put(SettingsBuilder.SECURITY_REJECT_UNSOLICITED_RESPONSES_WITH_INRESPONSETO, true);\n+        configProperties.put(SettingsBuilder.SP_PRIVATEKEY_PROPERTY_KEY, this.spSignaturePrivateKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f922963809c0b7267b45a1ca8b736c6c793456af"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjY4MTQ0", "url": "https://github.com/opensearch-project/security/pull/539#pullrequestreview-453668144", "createdAt": "2020-07-22T20:40:23Z", "commit": {"oid": "f922963809c0b7267b45a1ca8b736c6c793456af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2804, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}