{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMDE1Mjc2", "number": 816, "title": "Fix empty password issue in upgrade from 6x to 7x", "bodyText": "Issue #, if available:\nDescription of changes:\nUnrecognized field \"password\" exception gets thrown out during migrating from 6.x to 7.x.\nThis PR is to fix the logic handling empty password in migration.\nRelated PRs:\nSome of the review comments are in this old PR - https://github.com/opendistro-for-elasticsearch/security/pull/809\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-29T05:05:32Z", "url": "https://github.com/opensearch-project/security/pull/816", "merged": true, "mergeCommit": {"oid": "4a1caefc3cf2330fdd15840a0a4457497b0fb7c6"}, "closed": true, "closedAt": "2020-11-02T21:49:21Z", "author": {"login": "cliu123"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXW513gFqTUxOTk4MjEzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYrIJXAFqTUyMTk5MjA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTgyMTM3", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-519982137", "createdAt": "2020-10-29T18:58:34Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1ODozNVrOHqqVqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1ODozNVrOHqqVqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5NTkxMw==", "bodyText": "Any tests?", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r514495913", "createdAt": "2020-10-29T18:58:35Z", "author": {"login": "sujithvm"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/InternalUserV6.java", "diffHunk": "@@ -79,6 +79,12 @@ public String getHash() {\n         public void setHash(String hash) {\n             this.hash = hash;\n         }\n+        /**\n+         * Method that gets invoked when \"password\" field is present in serialized JSON.\n+         * Serialized JSON is expected not to have \"password\" field or have an empty password.\n+         * Hence, password field should not be set in InternalUserV6 object in deserialization.\n+         */\n+        public void setPassword(String password){}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTU0MDQ3", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-520954047", "createdAt": "2020-10-30T19:00:58Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTowMDo1OFrOHrcYog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1NDowN1rOHreJ_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNTg3NA==", "bodyText": "nit: add empty line before and after.", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515315874", "createdAt": "2020-10-30T19:00:58Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/InternalUserV6.java", "diffHunk": "@@ -79,6 +79,12 @@ public String getHash() {\n         public void setHash(String hash) {\n             this.hash = hash;\n         }\n+        /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0NDM4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public void setPassword(String password){}\n          \n          \n            \n                    public void setPassword(String password){\n          \n          \n            \n                      // no-op setter. Due to a bug in 6.x, empty \"password\" may be saved to the internalusers doc. Ignore it.\n          \n          \n            \n                    }", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515344380", "createdAt": "2020-10-30T19:52:52Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/InternalUserV6.java", "diffHunk": "@@ -79,6 +79,12 @@ public String getHash() {\n         public void setHash(String hash) {\n             this.hash = hash;\n         }\n+        /**\n+         * Method that gets invoked when \"password\" field is present in serialized JSON.\n+         * Serialized JSON is expected not to have \"password\" field or have an empty password.\n+         * Hence, password field should not be set in InternalUserV6 object in deserialization.\n+         */\n+        public void setPassword(String password){}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0NDg5NA==", "bodyText": "Is it necessary to hardcode base64 encoded string? Can it be programmatically encoded for readability?", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515344894", "createdAt": "2020-10-30T19:54:07Z", "author": {"login": "vrozov"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/MigrationTests.java", "diffHunk": "@@ -137,6 +136,29 @@ public void testSecurityValidateWithInvalidConfig() throws Exception {\n \n     }\n \n+    @Test\n+    public void testSecurityMigrateWithEmptyPassword() throws Exception{\n+        final Settings settings = Settings.builder().put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_HTTP_CLIENTAUTH_MODE, \"REQUIRE\")\n+                .put(\"opendistro_security.ssl.http.enabled\", true)\n+                .put(\"opendistro_security.ssl.http.keystore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"migration/node-0-keystore.jks\"))\n+                .put(\"opendistro_security.ssl.http.truststore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"migration/truststore.jks\"))\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_ACCEPT_INVALID_CONFIG, true)\n+                .build();\n+        setup(Settings.EMPTY, new DynamicSecurityConfig().setSecurityInternalUsers(\"internal_users2.yml\").setLegacy(), settings, true);\n+        final RestHelper rh = restHelper(); //ssl resthelper\n+\n+        rh.enableHTTPClientSSL = true;\n+        rh.trustHTTPServerCertificate = true;\n+        rh.sendAdminCertificate = true;\n+        rh.keystore = \"kirk-keystore.jks\";\n+        \n+        String body = \"{\\\"internalusers\\\":\\\"eyJsb2dzdGFzaCI6eyJoYXNoIjoiIiwicm9sZXMiOlsibG9nc3Rhc2giXX0sIlN0ZXBoZW5fMTIzIjp7Imhhc2giOiIiLCAicGFzc3dvcmQiOiIifSwic25hcHNob3RyZXN0b3JlIjp7Imhhc2giOiIiLCJyb2xlcyI6WyJzbmFwc2hvdHJlc3RvcmUiXX0sImFkbWluIjp7ImF0dHJpYnV0ZXMiOnsiYXR0cmlidXRlMSI6InZhbHVlMSIsImF0dHJpYnV0ZTMiOiJ2YWx1ZTMiLCJhdHRyaWJ1dGUyIjoidmFsdWUyIn0sInJlYWRvbmx5IjoidHJ1ZSIsImhhc2giOiIiLCJyb2xlcyI6WyJhZG1pbiJdfSwia2liYW5hc2VydmVyIjp7InJlYWRvbmx5IjoidHJ1ZSIsImhhc2giOiIifSwia2liYW5hcm8iOnsiaGFzaCI6IiIsInJvbGVzIjpbImtpYmFuYXVzZXIiLCJyZWFkYWxsIl19LCJyZWFkYWxsIjp7Imhhc2giOiIiLCJyb2xlcyI6WyJyZWFkYWxsIl19fQoK\\\"}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDQwOTkx", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-521040991", "createdAt": "2020-10-30T21:16:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMToxNjo0M1rOHrgtpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMToxNjo0M1rOHrgtpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4Njc5MA==", "bodyText": "nit: include only whats relevant for the test", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515386790", "createdAt": "2020-10-30T21:16:43Z", "author": {"login": "sujithvm"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/MigrationTests.java", "diffHunk": "@@ -137,6 +137,31 @@ public void testSecurityValidateWithInvalidConfig() throws Exception {\n \n     }\n \n+    @Test\n+    public void testSecurityMigrateWithEmptyPassword() throws Exception{\n+        final Settings settings = Settings.builder().put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_HTTP_CLIENTAUTH_MODE, \"REQUIRE\")\n+                .put(\"opendistro_security.ssl.http.enabled\", true)\n+                .put(\"opendistro_security.ssl.http.keystore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"migration/node-0-keystore.jks\"))\n+                .put(\"opendistro_security.ssl.http.truststore_filepath\", FileHelper.getAbsoluteFilePathFromClassPath(\"migration/truststore.jks\"))\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_UNSUPPORTED_ACCEPT_INVALID_CONFIG, true)\n+                .build();\n+        setup(Settings.EMPTY, new DynamicSecurityConfig().setSecurityInternalUsers(\"internal_users2.yml\").setLegacy(), settings, true);\n+        final RestHelper rh = restHelper(); //ssl resthelper\n+\n+        rh.enableHTTPClientSSL = true;\n+        rh.trustHTTPServerCertificate = true;\n+        rh.sendAdminCertificate = true;\n+        rh.keystore = \"kirk-keystore.jks\";\n+\n+        String internalUsersWithEmptyPassword = \"{\\\"logstash\\\":{\\\"hash\\\":\\\"\\\",\\\"roles\\\":[\\\"logstash\\\"]},\\\"Stephen_123\\\":{\\\"hash\\\":\\\"\\\", \\\"password\\\":\\\"\\\"},\\\"snapshotrestore\\\":{\\\"hash\\\":\\\"\\\",\\\"roles\\\":[\\\"snapshotrestore\\\"]},\\\"admin\\\":{\\\"attributes\\\":{\\\"attribute1\\\":\\\"value1\\\",\\\"attribute3\\\":\\\"value3\\\",\\\"attribute2\\\":\\\"value2\\\"},\\\"readonly\\\":\\\"true\\\",\\\"hash\\\":\\\"\\\",\\\"roles\\\":[\\\"admin\\\"]},\\\"kibanaserver\\\":{\\\"readonly\\\":\\\"true\\\",\\\"hash\\\":\\\"\\\"},\\\"kibanaro\\\":{\\\"hash\\\":\\\"\\\",\\\"roles\\\":[\\\"kibanauser\\\",\\\"readall\\\"]},\\\"readall\\\":{\\\"hash\\\":\\\"\\\",\\\"roles\\\":[\\\"readall\\\"]}}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDQxMTIz", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-521041123", "createdAt": "2020-10-30T21:17:03Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTA0Nzc1", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-521104775", "createdAt": "2020-10-31T02:15:27Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMjoxNToyN1rOHrkMmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMjoyMDo0M1rOHrkOPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ0Mzg2Nw==", "bodyText": "Sorry, by \"after\" I mean to add empty line after the method, so one method is separated from another.", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515443867", "createdAt": "2020-10-31T02:15:27Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/InternalUserV6.java", "diffHunk": "@@ -79,6 +79,12 @@ public String getHash() {\n         public void setHash(String hash) {\n             this.hash = hash;\n         }\n+        /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNTg3NA=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ0NDI4NA==", "bodyText": "Delete '/** .. */comment (it uses doc style comment, and it should not be doc). It should be sufficient to have a single line comment insidesetPassword()` method body.", "url": "https://github.com/opensearch-project/security/pull/816#discussion_r515444284", "createdAt": "2020-10-31T02:20:43Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/InternalUserV6.java", "diffHunk": "@@ -79,6 +79,12 @@ public String getHash() {\n         public void setHash(String hash) {\n             this.hash = hash;\n         }\n+        /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNTg3NA=="}, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b32477a52e2c2f71365c9b934b702110f6a7393", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/4b32477a52e2c2f71365c9b934b702110f6a7393", "committedDate": "2020-10-31T06:16:39Z", "message": "Fix empty password issue in upgrade from 6x to 7x\n\nCo-authored-by: Vlad Rozov <vrozov@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "4b32477a52e2c2f71365c9b934b702110f6a7393", "author": {"user": null}, "url": "https://github.com/opensearch-project/security/commit/4b32477a52e2c2f71365c9b934b702110f6a7393", "committedDate": "2020-10-31T06:16:39Z", "message": "Fix empty password issue in upgrade from 6x to 7x\n\nCo-authored-by: Vlad Rozov <vrozov@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTUwODA5", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-521150809", "createdAt": "2020-10-31T16:16:43Z", "commit": {"oid": "4b32477a52e2c2f71365c9b934b702110f6a7393"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTkyMDg3", "url": "https://github.com/opensearch-project/security/pull/816#pullrequestreview-521992087", "createdAt": "2020-11-02T21:06:14Z", "commit": {"oid": "4b32477a52e2c2f71365c9b934b702110f6a7393"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2650, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}