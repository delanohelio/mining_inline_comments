{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5ODE2MjI4", "number": 798, "title": "Add user & roles to the thread context ", "bodyText": "Issue #, if available:\nDescription of changes:\n\nAdd user & roles info as a string to the thread context.\nFormat of the string:  username|backend_role1,backend_role2|odferole1,odferole2\nThis string is accessable only in transport layer, as the odferoles are resolved only in transport layer.\nkey : _opendistro_security_user_roles_string\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-26T07:05:43Z", "url": "https://github.com/opensearch-project/security/pull/798", "merged": true, "mergeCommit": {"oid": "ca90ce991987b9d154141b495f76578fd6175e44"}, "closed": true, "closedAt": "2020-10-27T22:48:38Z", "author": {"login": "skkosuri-amzn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSRO-ggH2gAyNTA5ODE2MjI4OmUyYzMzYTdmNmZhNTliNzg5ZTk4YjJjYmM1OTMwZmY2Nzg1YTJmMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWw_RFgFqTUxODIwNzQ0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2c33a7f6fa59b789e98b2cbc5930ff6785a2f35", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/e2c33a7f6fa59b789e98b2cbc5930ff6785a2f35", "committedDate": "2020-10-13T23:32:37Z", "message": "demo config for plugins security and default alerting roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "773fb63ca3cc27068001856c739e6b5b7125758a", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/773fb63ca3cc27068001856c739e6b5b7125758a", "committedDate": "2020-10-14T04:16:33Z", "message": "fix spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69bf2473dcba3bb4ab8c413277b1e52195f642e8", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/69bf2473dcba3bb4ab8c413277b1e52195f642e8", "committedDate": "2020-10-16T21:23:08Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/security into config_changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1342491126d05ed4bd6352783165daf50cf690a", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/c1342491126d05ed4bd6352783165daf50cf690a", "committedDate": "2020-10-24T23:15:42Z", "message": "Add openditro roles to the User"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d55c6c37e85d5e98205e82005a4b41d54388d45", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/1d55c6c37e85d5e98205e82005a4b41d54388d45", "committedDate": "2020-10-24T23:16:51Z", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/security into config_changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/05334c0ee7c1da3ad9b62d2546b2412922bcc010", "committedDate": "2020-10-26T00:59:40Z", "message": "Add user roles to thread context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTIyNzI1", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517122725", "createdAt": "2020-10-26T19:49:50Z", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjQ3OTkz", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517247993", "createdAt": "2020-10-26T23:29:51Z", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzEyNjg0", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517312684", "createdAt": "2020-10-27T02:54:42Z", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1NDo0MlrOHoplaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1NDo0MlrOHoplaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NjQwOQ==", "bodyText": "nit: populate only if there is a call to chain. If access is denied, it is necessary to populate OPENDISTRO_SECURITY_USER_ROLES_STRING?", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512386409", "createdAt": "2020-10-27T02:54:42Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityFilter.java", "diffHunk": "@@ -291,7 +292,11 @@ public int order() {\n             if (log.isDebugEnabled()) {\n                 log.debug(pres);\n             }\n-            \n+\n+            if(threadContext.getTransient(OPENDISTRO_SECURITY_USER_ROLES_STRING) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzEzOTc5", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517313979", "createdAt": "2020-10-27T02:58:43Z", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1ODo0M1rOHoppug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1ODo0M1rOHoppug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4NzUxNA==", "bodyText": "Can roles or odfe roles contain ,?", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512387514", "createdAt": "2020-10-27T02:58:43Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/User.java", "diffHunk": "@@ -263,4 +263,8 @@ public final void addOpenDistroSecurityRoles(final Collection<String> securityRo\n     public final Set<String> getOpenDistroSecurityRoles() {\n         return this.openDistroSecurityRoles == null ? Collections.emptySet() : Collections.unmodifiableSet(this.openDistroSecurityRoles);\n     }\n+\n+    public final String getUserRolesString() {\n+        return name + \"|\" + String.join(\",\", getRoles()) + \"|\" + String.join(\",\", getOpenDistroSecurityRoles());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzE2OTEw", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517316910", "createdAt": "2020-10-27T03:08:13Z", "commit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowODoxM1rOHopzdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowODoxM1rOHopzdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MDAwNQ==", "bodyText": "For consistency with injected_user (that is also a String) please rename to remove STRING: OPENDISTRO_SECURITY_USER_ROLES_STRING ->OPENDISTRO_SECURITY_USER_AND_ROLES, \"user_roles_string\" -> \"user&roles\" or \"user_and_roles\".", "url": "https://github.com/opensearch-project/security/pull/798#discussion_r512390005", "createdAt": "2020-10-27T03:08:13Z", "author": {"login": "vrozov"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigConstants.java", "diffHunk": "@@ -99,6 +99,8 @@\n     public static final String OPENDISTRO_SECURITY_USER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user\";\n     public static final String OPENDISTRO_SECURITY_USER_HEADER = OPENDISTRO_SECURITY_CONFIG_PREFIX+\"user_header\";\n \n+    public static final String OPENDISTRO_SECURITY_USER_ROLES_STRING = OPENDISTRO_SECURITY_CONFIG_PREFIX + \"user_roles_string\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05334c0ee7c1da3ad9b62d2546b2412922bcc010"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43982037fc7eca376951cdb926c69becb5824023", "author": {"user": {"login": "skkosuri-amzn", "name": "Sriram"}}, "url": "https://github.com/opensearch-project/security/commit/43982037fc7eca376951cdb926c69becb5824023", "committedDate": "2020-10-27T03:25:52Z", "message": "Renames the option to OPENDISTRO_SECURITY_USER_AND_ROLES"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzY4OTU1", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-517368955", "createdAt": "2020-10-27T05:59:07Z", "commit": {"oid": "43982037fc7eca376951cdb926c69becb5824023"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDM3MjI2", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-518037226", "createdAt": "2020-10-27T18:51:34Z", "commit": {"oid": "43982037fc7eca376951cdb926c69becb5824023"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjA3NDQw", "url": "https://github.com/opensearch-project/security/pull/798#pullrequestreview-518207440", "createdAt": "2020-10-27T22:48:07Z", "commit": {"oid": "43982037fc7eca376951cdb926c69becb5824023"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2642, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}