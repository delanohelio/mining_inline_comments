{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODQyOTUx", "number": 876, "title": "Fix AuthCredentials equality", "bodyText": "Fixes #873.\nDescription of changes:\nThis PR fixes the AuthCredentials class to correctly consider two AuthCredentials equal if they have the same username and both instances have null passwords. Before this PR, if both instances had null passwords, they would be considered not equal, causing them to never be cached. This fixes caching for backends using anonymous authentication.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-04T23:25:49Z", "url": "https://github.com/opensearch-project/security/pull/876", "merged": true, "mergeCommit": {"oid": "6c8b86d130498930bfc8a1de49e164fcc77f9469"}, "closed": true, "closedAt": "2021-02-03T18:26:20Z", "author": {"login": "nicot"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdtSIpnABqjQxNzIxNjE5MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2ka6-AFqTU4MjY2MDgzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4OTkzMTU2", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-578993156", "createdAt": "2021-01-29T07:18:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzoxODoxNFrOIcX2gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzoxODoxNFrOIcX2gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMTgyNw==", "bodyText": "Do we need to add && Objects.equals(password, other.password) here?", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566621827", "createdAt": "2021-01-29T07:18:14Z", "author": {"login": "cliu123"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/user/AuthCredentials.java", "diffHunk": "@@ -175,19 +176,16 @@ public int hashCode() {\n     public boolean equals(Object obj) {\n         if (this == obj)\n             return true;\n-        if (obj == null)\n-            return false;\n-        if (getClass() != obj.getClass())\n+        if (obj == null || getClass() != obj.getClass()) {\n             return false;\n+        }\n+\n         AuthCredentials other = (AuthCredentials) obj;\n-        if (internalPasswordHash == null || other.internalPasswordHash == null || !MessageDigest.isEqual(internalPasswordHash, other.internalPasswordHash))\n-            return false;\n-        if (username == null) {\n-            if (other.username != null)\n-                return false;\n-        } else if (!username.equals(other.username))\n-            return false;\n-        return true;\n+        return Objects.equals(username, other.username)\n+            && Objects.equals(nativeCredentials, other.nativeCredentials)\n+            && Objects.equals(backendRoles, other.backendRoles)\n+            && MessageDigest.isEqual(internalPasswordHash, other.internalPasswordHash)\n+            && Objects.equals(attributes, other.attributes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4OTk1OTI1", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-578995925", "createdAt": "2021-01-29T07:23:41Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzoyMzo0MVrOIcX-YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzoyMzo0MVrOIcX-YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYyMzg0MQ==", "bodyText": "Add 2 test cases?\n\nobject.internalPasswordHash == null && other.internalPasswordHash == null ==> equals() returns true\nobject.internalPasswordHash == null && other.internalPasswordHash == <non-null value> ==> equals() returns false.", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566623841", "createdAt": "2021-01-29T07:23:41Z", "author": {"login": "cliu123"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/user/AuthCredentialsTests.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package com.amazon.opendistroforelasticsearch.security.user;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class AuthCredentialsTests {\n+  @Test\n+  public void testEquality() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5MDA0NTQ3", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-579004547", "createdAt": "2021-01-29T07:40:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzo0MDozOVrOIcYYww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzo0MDozOVrOIcYYww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDU5NQ==", "bodyText": "Why is this change necessary? It doesn't look related to your change to me. Did I miss anything?", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566630595", "createdAt": "2021-01-29T07:40:39Z", "author": {"login": "cliu123"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/cache/CachingTest.java", "diffHunk": "@@ -58,7 +58,7 @@ public void testRestCaching() throws Exception {\n \n         Assert.assertEquals(3, DummyHTTPAuthenticator.getCount());\n         Assert.assertEquals(1, DummyAuthorizer.getCount());\n-        Assert.assertEquals(3, DummyAuthenticationBackend.getAuthCount());\n+        Assert.assertEquals(1, DummyAuthenticationBackend.getAuthCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5MDA0NjIy", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-579004622", "createdAt": "2021-01-29T07:40:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzo0MDo0NlrOIcYY8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQwNzo0MDo0NlrOIcYY8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjYzMDY0MA==", "bodyText": "Why is this change necessary? It doesn't look related to your change to me. Did I miss anything?", "url": "https://github.com/opensearch-project/security/pull/876#discussion_r566630640", "createdAt": "2021-01-29T07:40:46Z", "author": {"login": "cliu123"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/cache/CachingTest.java", "diffHunk": "@@ -103,7 +103,7 @@ public void testRestCachingWithImpersonation() throws Exception {\n \n         Assert.assertEquals(4, DummyHTTPAuthenticator.getCount());\n         Assert.assertEquals(3, DummyAuthorizer.getCount());\n-        Assert.assertEquals(4, DummyAuthenticationBackend.getAuthCount());\n+        Assert.assertEquals(1, DummyAuthenticationBackend.getAuthCount());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5", "author": {"user": {"login": "nicot", "name": "Nico Tonozzi"}}, "url": "https://github.com/opensearch-project/security/commit/56a1b05334930640f38a45e7b6cbfb40944ea0a5", "committedDate": "2021-01-29T23:24:05Z", "message": "Fix AuthCredentials equality\n\nThis commit fixes the AuthCredentials class to correctly consider two AuthCredentials equal if they have the same username and both instances have null passwords. Before this commit, if both instances had null passwords, they would be considered not equal, causing them to never be cached. This fixes caching for backends using anonymous authentication."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5", "author": {"user": {"login": "nicot", "name": "Nico Tonozzi"}}, "url": "https://github.com/opensearch-project/security/commit/56a1b05334930640f38a45e7b6cbfb40944ea0a5", "committedDate": "2021-01-29T23:24:05Z", "message": "Fix AuthCredentials equality\n\nThis commit fixes the AuthCredentials class to correctly consider two AuthCredentials equal if they have the same username and both instances have null passwords. Before this commit, if both instances had null passwords, they would be considered not equal, causing them to never be cached. This fixes caching for backends using anonymous authentication."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5NzExNjEx", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-579711611", "createdAt": "2021-01-30T01:22:22Z", "commit": {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgyNjYwODM1", "url": "https://github.com/opensearch-project/security/pull/876#pullrequestreview-582660835", "createdAt": "2021-02-03T18:15:08Z", "commit": {"oid": "56a1b05334930640f38a45e7b6cbfb40944ea0a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2683, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}