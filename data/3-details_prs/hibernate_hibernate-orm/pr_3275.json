{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxOTg3MDU0", "number": 3275, "title": "Wip/6.0 Fix a double-checked locking implementation imperfection", "bodyText": "Double checked locking is subtle and error-prone. There is some imperfection as per https://en.wikipedia.org/wiki/Double-checked_locking. See code review self-comment for details.", "createdAt": "2020-03-01T03:28:05Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3275", "merged": true, "mergeCommit": {"oid": "cf461639582b99c428c8ce155c4de01ba5a6f9d9"}, "closed": true, "closedAt": "2020-03-19T19:02:51Z", "author": {"login": "NathanQingyangXu"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJQfW8AH2gAyMzgxOTg3MDU0OmUwOWMwZTkwOTBmNWVkNGY3MTYyNDRjYTdhMmY1YjNhMDlkOTEyZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJQk0jAFqTM2NjgzMjcxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e09c0e9090f5ed4f716244ca7a2f5b3a09d912ea", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/e09c0e9090f5ed4f716244ca7a2f5b3a09d912ea", "committedDate": "2020-03-01T03:24:08Z", "message": "Fix a subtle double-checked locking issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/e70bab9928c134d1750ffc0a83642c9c64e74a39", "committedDate": "2020-03-01T03:25:49Z", "message": "Fix a subtle double-checked locking issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODMyNzAz", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#pullrequestreview-366832703", "createdAt": "2020-03-01T03:29:20Z", "commit": {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMzoyOToyMFrOFwMDSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMzoyOToyMFrOFwMDSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3MzQxOA==", "bodyText": "Without the above statement, there is no reason to check again at the next statement for localCopy would always be null.", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#discussion_r386073418", "createdAt": "2020-03-01T03:29:20Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/persister/collection/AbstractCollectionPersister.java", "diffHunk": "@@ -744,18 +744,21 @@ protected void logStaticSQL() {\n \t\t}\n \t}\n \n-\tprivate CollectionLoader standardCollectionLoader;\n+\tprivate volatile CollectionLoader standardCollectionLoader;\n \n \t@Override\n \tpublic void initialize(Object key, SharedSessionContractImplementor session) throws HibernateException {\n //\t\tgetAppropriateInitializer( key, session ).initialize( key, session );\n \t\tdetermineLoaderToUse( key, session ).load( key, session );\n \t}\n \n+\t// lazily initialize instance field via 'double-checked locking'\n+\t// see https://en.wikipedia.org/wiki/Double-checked_locking on why 'volatile' and local copy is used\n \tprotected CollectionLoader getStandardCollectionLoader() {\n \t\tCollectionLoader localCopy = standardCollectionLoader;\n \t\tif ( localCopy == null ) {\n \t\t\tsynchronized (this) {\n+\t\t\t\tlocalCopy = standardCollectionLoader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODMyNzE4", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#pullrequestreview-366832718", "createdAt": "2020-03-01T03:30:05Z", "commit": {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMzozMDowNlrOFwMDWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwMzozMDowNlrOFwMDWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3MzQzMg==", "bodyText": "The volatile keyword is mandatory to benefit from the 'local copy' paradigm later.", "url": "https://github.com/hibernate/hibernate-orm/pull/3275#discussion_r386073432", "createdAt": "2020-03-01T03:30:06Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/persister/collection/AbstractCollectionPersister.java", "diffHunk": "@@ -744,18 +744,21 @@ protected void logStaticSQL() {\n \t\t}\n \t}\n \n-\tprivate CollectionLoader standardCollectionLoader;\n+\tprivate volatile CollectionLoader standardCollectionLoader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70bab9928c134d1750ffc0a83642c9c64e74a39"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3190, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}