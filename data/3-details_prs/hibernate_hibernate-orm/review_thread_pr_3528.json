{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MDg2MDk2", "number": 3528, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoxMjo1N1rOEeX4sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoxMToxOFrOEfBdNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjg0MDgzOnYy", "diffSide": "RIGHT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/path/AbstractFromImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoxMjo1OFrOHJ_RnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMjoyNDo0MlrOHKLQnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNTkzMg==", "bodyText": "I'm not sure this will generate the correct HQL. Maybe this should be the following\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif ( getAlias() == null ) {\n          \n          \n            \n            \t\tif ( super.getAlias() == null ) {\n          \n      \n    \n    \n  \n\nand you should revert the other changes in this file", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r480235932", "createdAt": "2020-08-31T16:12:58Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/path/AbstractFromImpl.java", "diffHunk": "@@ -81,12 +81,7 @@ protected boolean canBeDereferenced() {\n \t@Override\n \tpublic void prepareAlias(RenderingContext renderingContext) {\n \t\tif ( getAlias() == null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQzMjI4NA==", "bodyText": "I think it should be fine. I removed the getAlias() overloading method in this class (to ensure new alias is generated rather than reusing the correlated parent's alias), so both getAlias() and 'setAlias()` would be from the parent class.\nBut as you suggested, we need to revert back partially to the previous implementation for performance reason (only create new alias when the correlated root is of LEFT JOIN), then I need to reconsider the issue.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r480432284", "createdAt": "2020-08-31T22:24:42Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/path/AbstractFromImpl.java", "diffHunk": "@@ -81,12 +81,7 @@ protected boolean canBeDereferenced() {\n \t@Override\n \tpublic void prepareAlias(RenderingContext renderingContext) {\n \t\tif ( getAlias() == null ) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNTkzMg=="}, "originalCommit": null, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjg3ODM1OnYy", "diffSide": "LEFT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoyMjozMVrOHJ_nnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0MzoxM1rOHK8ofw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MTU2Nw==", "bodyText": "IMO this should be reverted and we should specially handle the left join case instead as this kind of querying might result in worse performance for some cases. A subquery like select ... from alias.elementCollection will only use the join table in the SQL. AFAIU, the changes you are doing here will always use the owner entity table in the from clause and then join the join table.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r480241567", "createdAt": "2020-08-31T16:22:31Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -286,52 +287,17 @@ private FromImplementor locateImplicitSelection() {\n \t\treturn implicitSelection;\n \t}\n \n-\t@SuppressWarnings({ \"unchecked\" })\n \tprivate void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n \t\trenderingContext.getClauseStack().push( Clause.FROM );\n \n \t\ttry {\n \t\t\tjpaqlQuery.append( \" from \" );\n-\t\t\tString sep = \"\";\n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\t( (FromImplementor) root ).prepareAlias( renderingContext );\n-\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\tsep = \", \";\n-\t\t\t\tjpaqlQuery.append( ( (FromImplementor) root ).renderTableExpression( renderingContext ) );\n-\t\t\t}\n \n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\trenderJoins( jpaqlQuery, renderingContext, root.getJoins() );\n-\t\t\t\tif ( root instanceof RootImpl ) {\n-\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) root ).getTreats();\n-\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n-\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n-\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\trenderFetches( jpaqlQuery, renderingContext, root.getFetches() );\n-\t\t\t}\n+\t\t\tdoRenderFrom( getRoots(), jpaqlQuery, renderingContext );\n \n \t\t\tif ( isSubQuery ) {\n \t\t\t\tif ( correlationRoots != null ) {\n-\t\t\t\t\tfor ( FromImplementor<?, ?> correlationRoot : correlationRoots ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQzNDA4NQ==", "bodyText": "yeah, that is the gist of the original implementation plan. I agree we should consider the LEFT JOIN correlated root as a special case to boost performance, though the downside is the code might be harder to read and maintain.\nWill do as you suggested. Again, this PR might involve lots of back and forth.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r480434085", "createdAt": "2020-08-31T22:27:21Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -286,52 +287,17 @@ private FromImplementor locateImplicitSelection() {\n \t\treturn implicitSelection;\n \t}\n \n-\t@SuppressWarnings({ \"unchecked\" })\n \tprivate void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n \t\trenderingContext.getClauseStack().push( Clause.FROM );\n \n \t\ttry {\n \t\t\tjpaqlQuery.append( \" from \" );\n-\t\t\tString sep = \"\";\n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\t( (FromImplementor) root ).prepareAlias( renderingContext );\n-\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\tsep = \", \";\n-\t\t\t\tjpaqlQuery.append( ( (FromImplementor) root ).renderTableExpression( renderingContext ) );\n-\t\t\t}\n \n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\trenderJoins( jpaqlQuery, renderingContext, root.getJoins() );\n-\t\t\t\tif ( root instanceof RootImpl ) {\n-\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) root ).getTreats();\n-\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n-\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n-\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\trenderFetches( jpaqlQuery, renderingContext, root.getFetches() );\n-\t\t\t}\n+\t\t\tdoRenderFrom( getRoots(), jpaqlQuery, renderingContext );\n \n \t\t\tif ( isSubQuery ) {\n \t\t\t\tif ( correlationRoots != null ) {\n-\t\t\t\t\tfor ( FromImplementor<?, ?> correlationRoot : correlationRoots ) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MTU2Nw=="}, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0MTIxNQ==", "bodyText": "After investigation, I found HHH-14197 has different root cause so I exclude that ticket outside this PR and will create its own PR in near future.\nUpdated as your suggestion. Thanks.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481241215", "createdAt": "2020-09-01T15:43:13Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -286,52 +287,17 @@ private FromImplementor locateImplicitSelection() {\n \t\treturn implicitSelection;\n \t}\n \n-\t@SuppressWarnings({ \"unchecked\" })\n \tprivate void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n \t\trenderingContext.getClauseStack().push( Clause.FROM );\n \n \t\ttry {\n \t\t\tjpaqlQuery.append( \" from \" );\n-\t\t\tString sep = \"\";\n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\t( (FromImplementor) root ).prepareAlias( renderingContext );\n-\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\tsep = \", \";\n-\t\t\t\tjpaqlQuery.append( ( (FromImplementor) root ).renderTableExpression( renderingContext ) );\n-\t\t\t}\n \n-\t\t\tfor ( Root root : getRoots() ) {\n-\t\t\t\trenderJoins( jpaqlQuery, renderingContext, root.getJoins() );\n-\t\t\t\tif ( root instanceof RootImpl ) {\n-\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) root ).getTreats();\n-\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n-\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n-\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\trenderFetches( jpaqlQuery, renderingContext, root.getFetches() );\n-\t\t\t}\n+\t\t\tdoRenderFrom( getRoots(), jpaqlQuery, renderingContext );\n \n \t\t\tif ( isSubQuery ) {\n \t\t\t\tif ( correlationRoots != null ) {\n-\t\t\t\t\tfor ( FromImplementor<?, ?> correlationRoot : correlationRoots ) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MTU2Nw=="}, "originalCommit": null, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY0MzcwOnYy", "diffSide": "RIGHT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODowOTowMVrOHLCaKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMToyMjoxNFrOHLIuSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNTg1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tjpaqlQuery.append( \" and (\" );\n          \n          \n            \n            \t\t\t\t\tjpaqlQuery.append( \" and \" );", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481335851", "createdAt": "2020-09-01T18:09:01Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -341,20 +358,48 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t}\n \n \tprotected void renderWhereClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n-\t\tif ( getRestriction() == null ) {\n+\t\tfinal String correlationRestrictionWhereFragment = getCorrelationRestrictionsWhereFragment();\n+\t\tif ( getRestriction() == null && correlationRestrictionWhereFragment.isEmpty() ) {\n \t\t\treturn;\n \t\t}\n \n \t\trenderingContext.getClauseStack().push( Clause.WHERE );\n \t\ttry {\n-\t\t\tjpaqlQuery.append( \" where \" )\n-\t\t\t\t\t.append( ( (Renderable) getRestriction() ).render( renderingContext ) );\n+\t\t\tjpaqlQuery.append( \" where \" );\n+\t\t\tjpaqlQuery.append( correlationRestrictionWhereFragment );\n+\t\t\tif ( getRestriction() != null ) {\n+\t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n+\t\t\t\t\tjpaqlQuery.append( \" and (\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzNzQwMA==", "bodyText": "My concern is without the parenthesis, there might be issue if the original SQL is 'or' compound predicate. For instance, the original SQL might be:\nwhere alias0.name = 'haha' or alias0.field1 is null\n\nthen without parenthesis, the following erroneous SQL would be created:\nwhere alias1 = alias0 and alias0.name = 'haha' or alias0.name is null\n\nNo such concern exists?", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481437400", "createdAt": "2020-09-01T21:18:16Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -341,20 +358,48 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t}\n \n \tprotected void renderWhereClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n-\t\tif ( getRestriction() == null ) {\n+\t\tfinal String correlationRestrictionWhereFragment = getCorrelationRestrictionsWhereFragment();\n+\t\tif ( getRestriction() == null && correlationRestrictionWhereFragment.isEmpty() ) {\n \t\t\treturn;\n \t\t}\n \n \t\trenderingContext.getClauseStack().push( Clause.WHERE );\n \t\ttry {\n-\t\t\tjpaqlQuery.append( \" where \" )\n-\t\t\t\t\t.append( ( (Renderable) getRestriction() ).render( renderingContext ) );\n+\t\t\tjpaqlQuery.append( \" where \" );\n+\t\t\tjpaqlQuery.append( correlationRestrictionWhereFragment );\n+\t\t\tif ( getRestriction() != null ) {\n+\t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n+\t\t\t\t\tjpaqlQuery.append( \" and (\" );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNTg1MQ=="}, "originalCommit": null, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzOTMwNA==", "bodyText": "updated as you suggest", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481439304", "createdAt": "2020-09-01T21:22:14Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -341,20 +358,48 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t}\n \n \tprotected void renderWhereClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n-\t\tif ( getRestriction() == null ) {\n+\t\tfinal String correlationRestrictionWhereFragment = getCorrelationRestrictionsWhereFragment();\n+\t\tif ( getRestriction() == null && correlationRestrictionWhereFragment.isEmpty() ) {\n \t\t\treturn;\n \t\t}\n \n \t\trenderingContext.getClauseStack().push( Clause.WHERE );\n \t\ttry {\n-\t\t\tjpaqlQuery.append( \" where \" )\n-\t\t\t\t\t.append( ( (Renderable) getRestriction() ).render( renderingContext ) );\n+\t\t\tjpaqlQuery.append( \" where \" );\n+\t\t\tjpaqlQuery.append( correlationRestrictionWhereFragment );\n+\t\t\tif ( getRestriction() != null ) {\n+\t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n+\t\t\t\t\tjpaqlQuery.append( \" and (\" );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNTg1MQ=="}, "originalCommit": null, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY0NTAyOnYy", "diffSide": "RIGHT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODowOToyNVrOHLCbEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODowOToyNVrOHLCbEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNjA4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n          \n          \n            \n            \t\t\t\t\tjpaqlQuery.append( \")\" );\n          \n          \n            \n            \t\t\t\t}", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481336080", "createdAt": "2020-09-01T18:09:25Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -341,20 +358,48 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t}\n \n \tprotected void renderWhereClause(StringBuilder jpaqlQuery, RenderingContext renderingContext) {\n-\t\tif ( getRestriction() == null ) {\n+\t\tfinal String correlationRestrictionWhereFragment = getCorrelationRestrictionsWhereFragment();\n+\t\tif ( getRestriction() == null && correlationRestrictionWhereFragment.isEmpty() ) {\n \t\t\treturn;\n \t\t}\n \n \t\trenderingContext.getClauseStack().push( Clause.WHERE );\n \t\ttry {\n-\t\t\tjpaqlQuery.append( \" where \" )\n-\t\t\t\t\t.append( ( (Renderable) getRestriction() ).render( renderingContext ) );\n+\t\t\tjpaqlQuery.append( \" where \" );\n+\t\t\tjpaqlQuery.append( correlationRestrictionWhereFragment );\n+\t\t\tif ( getRestriction() != null ) {\n+\t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n+\t\t\t\t\tjpaqlQuery.append( \" and (\" );\n+\t\t\t\t}\n+\t\t\t\tjpaqlQuery.append( ( (Renderable) getRestriction() ).render( renderingContext ) );\n+\t\t\t\tif ( !correlationRestrictionWhereFragment.isEmpty() ) {\n+\t\t\t\t\tjpaqlQuery.append( \")\" );\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY1MTM3OnYy", "diffSide": "RIGHT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoxMToxM1rOHLCe9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMToyMTo0MVrOHLItRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNzA3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, correlationRoot.getFetches() );\n          \n      \n    \n    \n  \n\nSubquery can't have fetches", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481337077", "createdAt": "2020-09-01T18:11:13Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -318,18 +318,35 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t\t\t\t\t\tfinal FromImplementor correlationParent = correlationRoot.getCorrelationParent();\n \t\t\t\t\t\tcorrelationParent.prepareAlias( renderingContext );\n \t\t\t\t\t\tfinal String correlationRootAlias = correlationParent.getAlias();\n-\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n-\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n-\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\tif ( correlationRoot.canBeReplacedByCorrelatedParentInSubQuery() ) {\n+\t\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n+\t\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n+\t\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( sep );\n+\t\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n+\t\t\t\t\t\t\t\t\t\t.append( '.' )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n+\t\t\t\t\t\t\t\t\t\t.append( \" as \" )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n+\t\t\t\t\t\t\t\tsep = \", \";\n+\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse {\n+\t\t\t\t\t\t\tcorrelationRoot.prepareAlias( renderingContext );\n \t\t\t\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n-\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n-\t\t\t\t\t\t\t\t\t.append( '.' )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n-\t\t\t\t\t\t\t\t\t.append( \" as \" )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n \t\t\t\t\t\t\tsep = \", \";\n-\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\tjpaqlQuery.append( correlationRoot.renderTableExpression( renderingContext ) );\n+\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationRoot.getJoins() );\n+\t\t\t\t\t\t\tif ( correlationRoot instanceof Root ) {\n+\t\t\t\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) correlationRoot ).getTreats();\n+\t\t\t\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n+\t\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n+\t\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, correlationRoot.getFetches() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzOTA0NQ==", "bodyText": "thanks. deleted.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481439045", "createdAt": "2020-09-01T21:21:41Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -318,18 +318,35 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t\t\t\t\t\tfinal FromImplementor correlationParent = correlationRoot.getCorrelationParent();\n \t\t\t\t\t\tcorrelationParent.prepareAlias( renderingContext );\n \t\t\t\t\t\tfinal String correlationRootAlias = correlationParent.getAlias();\n-\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n-\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n-\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\tif ( correlationRoot.canBeReplacedByCorrelatedParentInSubQuery() ) {\n+\t\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n+\t\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n+\t\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( sep );\n+\t\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n+\t\t\t\t\t\t\t\t\t\t.append( '.' )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n+\t\t\t\t\t\t\t\t\t\t.append( \" as \" )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n+\t\t\t\t\t\t\t\tsep = \", \";\n+\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse {\n+\t\t\t\t\t\t\tcorrelationRoot.prepareAlias( renderingContext );\n \t\t\t\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n-\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n-\t\t\t\t\t\t\t\t\t.append( '.' )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n-\t\t\t\t\t\t\t\t\t.append( \" as \" )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n \t\t\t\t\t\t\tsep = \", \";\n-\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\tjpaqlQuery.append( correlationRoot.renderTableExpression( renderingContext ) );\n+\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationRoot.getJoins() );\n+\t\t\t\t\t\t\tif ( correlationRoot instanceof Root ) {\n+\t\t\t\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) correlationRoot ).getTreats();\n+\t\t\t\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n+\t\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n+\t\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, correlationRoot.getFetches() );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNzA3Nw=="}, "originalCommit": null, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY1MTc1OnYy", "diffSide": "RIGHT", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoxMToxOFrOHLCfKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMToyMTozMlrOHLIs8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNzEyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );\n          \n      \n    \n    \n  \n\nSubquery can't have fetches", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481337129", "createdAt": "2020-09-01T18:11:18Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -318,18 +318,35 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t\t\t\t\t\tfinal FromImplementor correlationParent = correlationRoot.getCorrelationParent();\n \t\t\t\t\t\tcorrelationParent.prepareAlias( renderingContext );\n \t\t\t\t\t\tfinal String correlationRootAlias = correlationParent.getAlias();\n-\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n-\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n-\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\tif ( correlationRoot.canBeReplacedByCorrelatedParentInSubQuery() ) {\n+\t\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n+\t\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n+\t\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( sep );\n+\t\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n+\t\t\t\t\t\t\t\t\t\t.append( '.' )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n+\t\t\t\t\t\t\t\t\t\t.append( \" as \" )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n+\t\t\t\t\t\t\t\tsep = \", \";\n+\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse {\n+\t\t\t\t\t\t\tcorrelationRoot.prepareAlias( renderingContext );\n \t\t\t\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n-\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n-\t\t\t\t\t\t\t\t\t.append( '.' )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n-\t\t\t\t\t\t\t\t\t.append( \" as \" )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n \t\t\t\t\t\t\tsep = \", \";\n-\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\tjpaqlQuery.append( correlationRoot.renderTableExpression( renderingContext ) );\n+\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationRoot.getJoins() );\n+\t\t\t\t\t\t\tif ( correlationRoot instanceof Root ) {\n+\t\t\t\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) correlationRoot ).getTreats();\n+\t\t\t\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n+\t\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n+\t\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzODk2Mw==", "bodyText": "deleted. thanks.", "url": "https://github.com/hibernate/hibernate-orm/pull/3528#discussion_r481438963", "createdAt": "2020-09-01T21:21:32Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/QueryStructure.java", "diffHunk": "@@ -318,18 +318,35 @@ private void renderFromClause(StringBuilder jpaqlQuery, RenderingContext renderi\n \t\t\t\t\t\tfinal FromImplementor correlationParent = correlationRoot.getCorrelationParent();\n \t\t\t\t\t\tcorrelationParent.prepareAlias( renderingContext );\n \t\t\t\t\t\tfinal String correlationRootAlias = correlationParent.getAlias();\n-\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n-\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n-\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\tif ( correlationRoot.canBeReplacedByCorrelatedParentInSubQuery() ) {\n+\t\t\t\t\t\t\tfor ( Join<?, ?> correlationJoin : correlationRoot.getJoins() ) {\n+\t\t\t\t\t\t\t\tfinal JoinImplementor correlationJoinImpl = (JoinImplementor) correlationJoin;\n+\t\t\t\t\t\t\t\t// IMPL NOTE: reuse the sep from above!\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( sep );\n+\t\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n+\t\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n+\t\t\t\t\t\t\t\t\t\t.append( '.' )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n+\t\t\t\t\t\t\t\t\t\t.append( \" as \" )\n+\t\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n+\t\t\t\t\t\t\t\tsep = \", \";\n+\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse {\n+\t\t\t\t\t\t\tcorrelationRoot.prepareAlias( renderingContext );\n \t\t\t\t\t\t\tjpaqlQuery.append( sep );\n-\t\t\t\t\t\t\tcorrelationJoinImpl.prepareAlias( renderingContext );\n-\t\t\t\t\t\t\tjpaqlQuery.append( correlationRootAlias )\n-\t\t\t\t\t\t\t\t\t.append( '.' )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAttribute().getName() )\n-\t\t\t\t\t\t\t\t\t.append( \" as \" )\n-\t\t\t\t\t\t\t\t\t.append( correlationJoinImpl.getAlias() );\n \t\t\t\t\t\t\tsep = \", \";\n-\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationJoinImpl.getJoins() );\n+\t\t\t\t\t\t\tjpaqlQuery.append( correlationRoot.renderTableExpression( renderingContext ) );\n+\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, correlationRoot.getJoins() );\n+\t\t\t\t\t\t\tif ( correlationRoot instanceof Root ) {\n+\t\t\t\t\t\t\t\tSet<TreatedRoot> treats = ( (RootImpl) correlationRoot ).getTreats();\n+\t\t\t\t\t\t\t\tfor ( TreatedRoot treat : treats ) {\n+\t\t\t\t\t\t\t\t\trenderJoins( jpaqlQuery, renderingContext, treat.getJoins() );\n+\t\t\t\t\t\t\t\t\trenderFetches( jpaqlQuery, renderingContext, treat.getFetches() );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzNzEyOQ=="}, "originalCommit": null, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4174, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}