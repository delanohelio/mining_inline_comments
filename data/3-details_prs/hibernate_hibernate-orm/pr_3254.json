{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MTU5ODUz", "number": 3254, "title": "HHH-12338 - Incorrect metamodel for basic collections", "bodyText": "This fix is needed so that we can map List, Set, or Map entity attributes to JSON columns or to map List entity attributes to ARRAY columns, as explained in this Hibernate Types project issue.\nInitially, this was integrated into 5.2.17, but it was causing the HHH-12581 issue, so it got reverted completely.\nI this it's worth addressing it via a fix instead of removing this functionality altogether.\n@sebersole @Naros If you have time to review it, I'd really appreciate it.", "createdAt": "2020-02-21T08:14:18Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3254", "merged": true, "mergeCommit": {"oid": "17c5fab50e9a1c90a96a01498b8c95b1646194cc"}, "closed": true, "closedAt": "2021-03-04T12:22:37Z", "author": {"login": "vladmihalcea"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGgZhaAFqTM2MjY1NjEwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd_0CidABqjQ0MDc1MzUzMjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjU2MTA0", "url": "https://github.com/hibernate/hibernate-orm/pull/3254#pullrequestreview-362656104", "createdAt": "2020-02-21T14:14:27Z", "commit": {"oid": "c10d266ffa51b9a50d3617ee641d8005f6fd6451"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDoxNDoyN1rOFs4Mzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDoxNDoyN1rOFs4Mzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwMjQ0Ng==", "bodyText": "One-shot usage of TypeUtils.containsAnnotation(Element, String) is okay, but multiple invocations won't be as efficient as\nAnnotationMirror annotationMirrors =  element.getAnnotationMirrors();\n// go about checking based on one-pass on the `AnnotationMirror` collection using methods from TypeUtil\n\nFurthermore, I do think we can reformat the above code in some way to improve readability. For instance, I spent quite some time figuring out how the parenthesis pairs match up above.\nIgnore the performance concern if irrelevant; but I do think we can improve the code as following\nif ( TypeUtils.containsAnnotation( element, Constants.CONVERT, Constants.HIBERNATE_TYPE ) && ! TypeUtils.containsAnnotation( element, Constants.ONE_TO_MANY, Constants.MANY_TO_MANY, Constants.ELEMENT_COLLECTION) ) {\n... ...\n}\n\nprovided performance concern could be ignored", "url": "https://github.com/hibernate/hibernate-orm/pull/3254#discussion_r382602446", "createdAt": "2020-02-21T14:14:27Z", "author": {"login": "NathanQingyangXu"}, "path": "tooling/metamodel-generator/src/main/java/org/hibernate/jpamodelgen/annotation/MetaAttributeGenerationVisitor.java", "diffHunk": "@@ -138,6 +138,16 @@ private AnnotationMetaAttribute createMetaCollectionAttribute(DeclaredType decla\n \t\t\t\taccessTypeInfo.setDefaultAccessType( entity.getEntityAccessTypeInfo().getAccessType() );\n \t\t\t}\n \t\t}\n+\t\tif (( TypeUtils.containsAnnotation( element, Constants.CONVERT ) ||\n+\t\t\t\tTypeUtils.containsAnnotation( element, Constants.HIBERNATE_TYPE ) ) &&\n+\t\t\t\t!isCollectionAssociation( element )\n+\t\t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c10d266ffa51b9a50d3617ee641d8005f6fd6451"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODUyNDk4", "url": "https://github.com/hibernate/hibernate-orm/pull/3254#pullrequestreview-362852498", "createdAt": "2020-02-21T19:09:12Z", "commit": {"oid": "12f4244f78d22f2ebbc03f25b7ef26f9728cb847"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjA5Mjk5", "url": "https://github.com/hibernate/hibernate-orm/pull/3254#pullrequestreview-507209299", "createdAt": "2020-10-13T08:50:21Z", "commit": {"oid": "12f4244f78d22f2ebbc03f25b7ef26f9728cb847"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwODo1MDoyMlrOHgcLig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwODo1MDoyMlrOHgcLig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc3ODE4Ng==", "bodyText": "I don't think this is according to the JPA specification, but I didn't look into it to find a reference. My gut tells me, this should be fixed by annotating the target attribute with @Basic so IMO it should look like the following:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif ( TypeUtils.containsAnnotation(\n          \n          \n            \n            \t\t\t\telement,\n          \n          \n            \n            \t\t\t\tConstants.CONVERT,\n          \n          \n            \n            \t\t\t\tConstants.HIBERNATE_TYPE\n          \n          \n            \n            \t\t) && !TypeUtils.containsAnnotation(\n          \n          \n            \n            \t\t\t\telement,\n          \n          \n            \n            \t\t\t\tConstants.ONE_TO_MANY,\n          \n          \n            \n            \t\t\t\tConstants.MANY_TO_MANY,\n          \n          \n            \n            \t\t\t\tConstants.ELEMENT_COLLECTION\n          \n          \n            \n            \t\t) ) {\n          \n          \n            \n            \t\t\treturn new AnnotationMetaSingleAttribute(\n          \n          \n            \n            \t\t\t\t\tentity,\n          \n          \n            \n            \t\t\t\t\telement,\n          \n          \n            \n            \t\t\t\t\tTypeUtils.toTypeString( declaredType )\n          \n          \n            \n            \t\t\t);\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tif ( TypeUtils.containsAnnotation(\n          \n          \n            \n            \t\t\t\telement,\n          \n          \n            \n            \t\t\t\tConstants.CONVERT,\n          \n          \n            \n            \t\t\t\tConstants.HIBERNATE_TYPE,\n          \n          \n            \n            \t\t\t\tConstants.BASIC\n          \n          \n            \n            \t\t) ) {\n          \n          \n            \n            \t\t\treturn new AnnotationMetaSingleAttribute(\n          \n          \n            \n            \t\t\t\t\tentity,\n          \n          \n            \n            \t\t\t\t\telement,\n          \n          \n            \n            \t\t\t\t\tTypeUtils.toTypeString( declaredType )\n          \n          \n            \n            \t\t\t);\n          \n          \n            \n            \t\t}", "url": "https://github.com/hibernate/hibernate-orm/pull/3254#discussion_r503778186", "createdAt": "2020-10-13T08:50:22Z", "author": {"login": "beikov"}, "path": "tooling/metamodel-generator/src/main/java/org/hibernate/jpamodelgen/annotation/MetaAttributeGenerationVisitor.java", "diffHunk": "@@ -138,6 +138,22 @@ private AnnotationMetaAttribute createMetaCollectionAttribute(DeclaredType decla\n \t\t\t\taccessTypeInfo.setDefaultAccessType( entity.getEntityAccessTypeInfo().getAccessType() );\n \t\t\t}\n \t\t}\n+\t\tif ( TypeUtils.containsAnnotation(\n+\t\t\t\telement,\n+\t\t\t\tConstants.CONVERT,\n+\t\t\t\tConstants.HIBERNATE_TYPE\n+\t\t) && !TypeUtils.containsAnnotation(\n+\t\t\t\telement,\n+\t\t\t\tConstants.ONE_TO_MANY,\n+\t\t\t\tConstants.MANY_TO_MANY,\n+\t\t\t\tConstants.ELEMENT_COLLECTION\n+\t\t) ) {\n+\t\t\treturn new AnnotationMetaSingleAttribute(\n+\t\t\t\t\tentity,\n+\t\t\t\t\telement,\n+\t\t\t\t\tTypeUtils.toTypeString( declaredType )\n+\t\t\t);\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12f4244f78d22f2ebbc03f25b7ef26f9728cb847"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd55044946e6e6d4a252b2aad4f2411482df7aa", "author": {"user": {"login": "vladmihalcea", "name": "Vlad Mihalcea"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/abd55044946e6e6d4a252b2aad4f2411482df7aa", "committedDate": "2021-03-04T11:29:37Z", "message": "HHH-12338 - Incorrect metamodel for basic collections"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12f4244f78d22f2ebbc03f25b7ef26f9728cb847", "author": {"user": {"login": "vladmihalcea", "name": "Vlad Mihalcea"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/12f4244f78d22f2ebbc03f25b7ef26f9728cb847", "committedDate": "2020-02-21T18:47:51Z", "message": "Simplify conditional logic based on the PR review comments"}, "afterCommit": {"oid": "abd55044946e6e6d4a252b2aad4f2411482df7aa", "author": {"user": {"login": "vladmihalcea", "name": "Vlad Mihalcea"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/abd55044946e6e6d4a252b2aad4f2411482df7aa", "committedDate": "2021-03-04T11:29:37Z", "message": "HHH-12338 - Incorrect metamodel for basic collections"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3171, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}