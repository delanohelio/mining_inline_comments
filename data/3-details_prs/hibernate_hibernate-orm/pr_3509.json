{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNzU5MzA2", "number": 3509, "title": "HHH-10282 Short-hand enum syntax support for HQL", "bodyText": "", "createdAt": "2020-08-21T17:39:01Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3509", "merged": true, "mergeCommit": {"oid": "bbeb7ecff1711b9e0d73013a3dfc10019e6b9ef4"}, "closed": true, "closedAt": "2020-11-09T14:57:18Z", "author": {"login": "beikov"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBIxSTAFqTQ3MjY4ODA0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABda2MqLAFqTUyNjM0OTIwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjg4MDQ4", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-472688048", "createdAt": "2020-08-21T18:04:14Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxODowNDoxNFrOHE2d2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxODowNDoxNFrOHE2d2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ==", "bodyText": "We might use CollectionHelper.mapOfSize( enumConstants.length ) to avoid map resizing. new HashMap( n ) doesn't necessarily achieve the user's goal (if the hashing conflict doesn't exist, the hashMap would be expanded for sure, which defeats the purpose of the intention).", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r474848729", "createdAt": "2020-08-21T18:04:14Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/hql/internal/SemanticQueryBuilder.java", "diffHunk": "@@ -218,7 +228,26 @@ public static SqmStatement buildSemanticModel(\n \tpublic SemanticQueryBuilder(SqmCreationOptions creationOptions, SqmCreationContext creationContext) {\n \t\tthis.creationOptions = creationOptions;\n \t\tthis.creationContext = creationContext;\n-\n+\t\tthis.possibleEnumNames = new HashSet<>();\n+\t\tthis.enumCache = new HashMap<>();\n+\t\tcreationContext.getJpaMetamodel().visitManagedTypes( managedDomainType -> {\n+\t\t\tmanagedDomainType.visitAttributes( persistentAttribute -> {\n+\t\t\t\tif ( persistentAttribute.getJavaType().isEnum() ) {\n+\t\t\t\t\t@SuppressWarnings(\"unchecked\")\n+\t\t\t\t\tClass<Enum<?>> enumClass = (Class<Enum<?>>) persistentAttribute.getJavaType();\n+\t\t\t\t\tMap<String, Enum<?>> enumValues = enumCache.get( enumClass );\n+\t\t\t\t\tif ( enumValues == null ) {\n+\t\t\t\t\t\tEnum<?>[] enumConstants = enumClass.getEnumConstants();\n+\t\t\t\t\t\tenumValues = new HashMap<>( enumConstants.length );", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzkyODQ4", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-473392848", "createdAt": "2020-08-24T11:53:03Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0Mjg5OTUw", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-524289950", "createdAt": "2020-11-05T14:03:13Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNDowMzoxM1rOHuEsoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNDoyMzo1NFrOHuFoww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3MzUwNQ==", "bodyText": "I'm curious where null is being put into this queue?  That seems wrong", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518073505", "createdAt": "2020-11-05T14:03:13Z", "author": {"login": "sebersole"}, "path": "hibernate-core/src/main/java/org/hibernate/boot/internal/InFlightMetadataCollectorImpl.java", "diffHunk": "@@ -1664,7 +1664,7 @@ private void processValueResolvers(MetadataBuildingContext buildingContext) {\n \n \t\twhile ( ! valueResolvers.isEmpty() ) {\n \t\t\tfinal boolean anyRemoved = valueResolvers.removeIf(\n-\t\t\t\t\tresolver -> resolver.apply( buildingContext )\n+\t\t\t\t\tresolver -> resolver == null || resolver.apply( buildingContext )", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3NjUzMA==", "bodyText": "Seems like this will break in cases of de-typed domain models (aka \"map mode\").  Depends how we end up deciding to handle that in building the JPA metamodel.  Regardless, its easy enough to handle here simply by checking for persistentAttribute.getJavaType() == null", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518076530", "createdAt": "2020-11-05T14:07:35Z", "author": {"login": "sebersole"}, "path": "hibernate-core/src/main/java/org/hibernate/metamodel/model/domain/internal/JpaMetamodelImpl.java", "diffHunk": "@@ -493,6 +500,34 @@ public void processJpa(\n \t\t\tfor ( EmbeddableDomainType<?> embeddable : context.getEmbeddableTypeSet() ) {\n \t\t\t\tthis.jpaEmbeddableDescriptorMap.put( embeddable.getJavaType(), embeddable );\n \t\t\t}\n+\t\t\tStream.concat(\n+\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n+\t\t\t\t\tStream.concat(\n+\t\t\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n+\t\t\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n+\t\t\t\t\t)\n+\t\t\t).forEach( managedDomainType -> {\n+\t\t\t\tmanagedDomainType.visitAttributes( persistentAttribute -> {\n+\t\t\t\t\tif ( persistentAttribute.getJavaType().isEnum() ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NTQ1MA==", "bodyText": "Few things in this block to keep in mind...\n\nWe prefer to define final variables as final.  You have quite a few here.\nWe prefer code blocks use braces, including switch branches (i.e., case NOT_EQUAL: { ... })", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518085450", "createdAt": "2020-11-05T14:19:36Z", "author": {"login": "sebersole"}, "path": "hibernate-core/src/main/java/org/hibernate/query/hql/internal/SemanticQueryBuilder.java", "diffHunk": "@@ -1283,28 +1283,89 @@ else if ( ctx.GREATER_EQUAL()!=null ) {\n \n \t@Override\n \tpublic SqmComparisonPredicate visitComparisonPredicate(HqlParser.ComparisonPredicateContext ctx) {\n+\t\tComparisonOperator comparisonOperator = (ComparisonOperator) ctx.comparisonOperator().accept( this );", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4ODg5OQ==", "bodyText": "Really, the mapping here is only need to get the converter (if one).  I wonder if we should instead simply pass in the converter?", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518088899", "createdAt": "2020-11-05T14:23:54Z", "author": {"login": "sebersole"}, "path": "hibernate-core/src/main/java/org/hibernate/query/sql/internal/NativeSelectQueryPlanImpl.java", "diffHunk": "@@ -140,8 +144,12 @@ public NativeSelectQueryPlanImpl(\n \t\t\t\t\t\t\ttype = StandardBasicTypes.OBJECT_TYPE;\n \t\t\t\t\t\t}\n \n-\t\t\t\t\t\tfinal JdbcMapping jdbcMapping = ( (BasicValuedMapping) type ).getJdbcMapping();\n-\t\t\t\t\t\tfinal JdbcParameterImpl jdbcParameter = new JdbcParameterImpl( jdbcMapping );\n+\t\t\t\t\t\tBasicValuedMapping basicValuedMapping = (BasicValuedMapping) type;\n+\t\t\t\t\t\tfinal JdbcMapping jdbcMapping = basicValuedMapping.getJdbcMapping();\n+\t\t\t\t\t\tfinal JdbcParameterImpl jdbcParameter = new JdbcParameterImpl(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d6a005b923c964875006fe6f705b128b0ea6e2", "author": {"user": {"login": "beikov", "name": "Christian Beikov"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/00d6a005b923c964875006fe6f705b128b0ea6e2", "committedDate": "2020-11-09T14:29:28Z", "message": "HHH-10282 Short-hand enum syntax support for HQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "author": {"user": {"login": "beikov", "name": "Christian Beikov"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/d5a35128ab99a05dddb8b925f49168e8b2a9725b", "committedDate": "2020-11-09T14:29:28Z", "message": "Fix issues with query splitting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "author": {"user": {"login": "beikov", "name": "Christian Beikov"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/d5a35128ab99a05dddb8b925f49168e8b2a9725b", "committedDate": "2020-11-09T14:29:28Z", "message": "Fix issues with query splitting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzIxNjMw", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-526321630", "createdAt": "2020-11-09T14:40:54Z", "commit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0MDo1NFrOHvx6rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0MDo1NFrOHvx6rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2Mjk1OQ==", "bodyText": "We might consider the following pattern:\nStream.of( \n\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n\t\t\t).flatMap( Function.identity() ).forEach( ... )\n\nAs per https://www.techempower.com/blog/2016/10/19/efficient-multiple-stream-concatenation-in-java/, the flatmap approach performs better when the stream sizes are not large.", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519862959", "createdAt": "2020-11-09T14:40:54Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/metamodel/model/domain/internal/JpaMetamodelImpl.java", "diffHunk": "@@ -493,6 +500,34 @@ public void processJpa(\n \t\t\tfor ( EmbeddableDomainType<?> embeddable : context.getEmbeddableTypeSet() ) {\n \t\t\t\tthis.jpaEmbeddableDescriptorMap.put( embeddable.getJavaType(), embeddable );\n \t\t\t}\n+\t\t\tStream.concat(\n+\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n+\t\t\t\t\tStream.concat(\n+\t\t\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n+\t\t\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n+\t\t\t\t\t)\n+\t\t\t).forEach( managedDomainType -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzM5MzA5", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-526339309", "createdAt": "2020-11-09T14:58:06Z", "commit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo1ODowNlrOHvyubQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo1ODowNlrOHvyubQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NjIwNQ==", "bodyText": "I think we could eliminate two unnecessary generics warning by making use of <T> above.", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519876205", "createdAt": "2020-11-09T14:58:06Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/query/internal/QueryParameterBindingImpl.java", "diffHunk": "@@ -227,6 +229,15 @@ public void setBindValues(\n \t\tthis.explicitTemporalPrecision = temporalTypePrecision;\n \t}\n \n+\t@Override\n+\tpublic MappingModelExpressable getType() {\n+\t\treturn type;\n+\t}\n+\n+\t@Override\n+\tpublic void setType(MappingModelExpressable type) {\n+\t\tthis.type = type;\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzQ0Mjky", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-526344292", "createdAt": "2020-11-09T15:03:02Z", "commit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowMzowMlrOHvy9EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowMzowMlrOHvy9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTk1Mw==", "bodyText": "I think it would be ideal to include negation counterparts for each of the new testing cases above.", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519879953", "createdAt": "2020-11-09T15:03:02Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/test/java/org/hibernate/test/enums/OrdinalEnumTypeTest.java", "diffHunk": "@@ -109,6 +109,46 @@ public void testEnumAsBindParameterAndExtract() {\n \t\t} );\n \t}\n \n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumShortHandSyntax() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\"select id from Person where originalHairColor = BLONDE\")\n+\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumQualifiedShortHandSyntax() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor = HairColor.BLONDE\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumShortHandSyntaxInPredicate() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor in (BLONDE, BROWN)\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumQualifiedShortHandSyntaxInPredicate() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor in (HairColor.BLONDE, HairColor.BROWN)\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzQ5MjA1", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#pullrequestreview-526349205", "createdAt": "2020-11-09T15:07:57Z", "commit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowNzo1OFrOHvzLIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowNzo1OFrOHvzLIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4MzU1NA==", "bodyText": "I think it is one of @sebersole 's personal styles to leave out the blank line before the first element statement in a class. I prefer the above change but it is not a big deal.\nAnother style of Steve is to leave out the space delimiter between generic types as following:\nMap<K,V> map; // I would prefer Map<K, V> map\n\nBut I don't think it is a big deal and they have become my style components as well, :).", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519883554", "createdAt": "2020-11-09T15:07:58Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/sql/exec/internal/JdbcParameterImpl.java", "diffHunk": "@@ -13,6 +13,7 @@\n  * @author Steve Ebersole\n  */\n public class JdbcParameterImpl extends AbstractJdbcParameter {\n+\n \tpublic JdbcParameterImpl(JdbcMapping jdbcMapping) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2868, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}