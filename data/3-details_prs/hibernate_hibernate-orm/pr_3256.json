{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NTI1MjEz", "number": 3256, "title": "HHH-13875 : Optional one-to-one does not always join the associated entity table when querying", "bodyText": "https://hibernate.atlassian.net/browse/HHH-13875\n@jwgmeligmeyling, could you please take a look at this? It is related to https://hibernate.atlassian.net/browse/HHH-12775.", "createdAt": "2020-02-22T00:23:47Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3256", "merged": true, "mergeCommit": {"oid": "a7261ad0533f8cc1eabd299a62e5daef8735faae"}, "closed": true, "closedAt": "2020-02-24T20:28:23Z", "author": {"login": "gbadner"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGoQsiAH2gAyMzc4NTI1MjEzOjdlM2FlODM3ODk1Yzk1ZWI0NGYyZmYzNjJjYmM0YjIwODBlZDQxNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHefPxAFqTM2MzQzMjI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e3ae837895c95eb44f2ff362cbc4b2080ed4150", "author": {"user": {"login": "gbadner", "name": null}}, "url": "https://github.com/hibernate/hibernate-orm/commit/7e3ae837895c95eb44f2ff362cbc4b2080ed4150", "committedDate": "2020-02-21T23:24:04Z", "message": "HHH-13875 : Added test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20aba6dd9eb1fde7976d7633c9c5304056902cde", "author": {"user": {"login": "gbadner", "name": null}}, "url": "https://github.com/hibernate/hibernate-orm/commit/20aba6dd9eb1fde7976d7633c9c5304056902cde", "committedDate": "2020-02-21T23:32:29Z", "message": "HHH-13875 : Optional one-to-one does not always join the associated entity table when querying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDIzODIz", "url": "https://github.com/hibernate/hibernate-orm/pull/3256#pullrequestreview-363023823", "createdAt": "2020-02-22T11:14:55Z", "commit": {"oid": "20aba6dd9eb1fde7976d7633c9c5304056902cde"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxMToxNDo1NVrOFtKsjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxMToxNDo1NVrOFtKsjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNTQ4Ng==", "bodyText": "Interesting, I thought entityType.isNullable() would imply !isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName ).\nObviously the API of the PropertyMapping gets a little bit vague here. Most code assumes that properties in the PropertyMapping are actually deducible from just the association owners subclass column span, which nullable properties are inherently not. In that sense, it doesn't make sense for the property to be considered here. As far as I remember, this was at least how these were handled at the time I wrote this originally. It might have changed since, or I might just as well have simply overlooked this case.\nAnyways, I expected joinIsNeeded for generateJoin && entityType.isNullable - so nothing worries me here. The tests that the two of us introduced with HHH-12775 and others are also still passing. The tests for this PR are very extensive.  So I am sure this change is fine!", "url": "https://github.com/hibernate/hibernate-orm/pull/3256#discussion_r382905486", "createdAt": "2020-02-22T11:14:55Z", "author": {"login": "jwgmeligmeyling"}, "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/DotNode.java", "diffHunk": "@@ -394,11 +394,14 @@ private void dereferenceEntity(\n \n \t\tif ( isDotNode( parent ) ) {\n \t\t\t// our parent is another dot node, meaning we are being further dereferenced.\n-\t\t\t// thus we need to generate a join unless the parent refers to the associated\n-\t\t\t// entity's PK (because 'our' table would know the FK).\n+\t\t\t// thus we need to generate a join unless the association is non-nullable and\n+\t\t\t// parent refers to the associated entity's PK (because 'our' table would know the FK).\n \t\t\tparentAsDotNode = (DotNode) parent;\n \t\t\tproperty = parentAsDotNode.propertyName;\n-\t\t\tjoinIsNeeded = generateJoin && !isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName );\n+\t\t\tjoinIsNeeded = generateJoin && (\n+\t\t\t\t\tentityType.isNullable() ||\n+\t\t\t\t\t!isPropertyEmbeddedInJoinProperties( parentAsDotNode.propertyName )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20aba6dd9eb1fde7976d7633c9c5304056902cde"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDMyMjgw", "url": "https://github.com/hibernate/hibernate-orm/pull/3256#pullrequestreview-363432280", "createdAt": "2020-02-24T14:34:50Z", "commit": {"oid": "20aba6dd9eb1fde7976d7633c9c5304056902cde"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3177, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}