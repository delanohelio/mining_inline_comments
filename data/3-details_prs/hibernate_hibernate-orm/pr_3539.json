{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTYyMjQ5", "number": 3539, "title": "HHH-14201 Fix EntityJoinFromElement JOIN order issue", "bodyText": "https://hibernate.atlassian.net/browse/HHH-14201\n\nSometimes we generated SQL with wrong JOIN order. The root cause is we always reserve all the EntityJoinFromElements without inserting them into AST tree,  until the last moment when we simply append them to the root level. However, it seems EntityJoinFromElement could show up anywhere and our special treatment of EntityJoinFromElement ends up with wrong SQL (some dbs could optimize by reverting back join order; whereas others simply accept it as it is and end up with error).\nThe solution is to insert all EntityJoinFromElements back into the AST tree to ensure their original position or depth-first traversal order.", "createdAt": "2020-09-03T11:28:18Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3539", "merged": true, "mergeCommit": {"oid": "886083ab77f6ac41711c053b5bca097868c9b7c3"}, "closed": true, "closedAt": "2020-09-14T08:04:08Z", "author": {"login": "NathanQingyangXu"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGUo9KgBqjM3MzQ0ODI4MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGtbUggBqjM3Mzg3MzUxMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ4MDI1", "url": "https://github.com/hibernate/hibernate-orm/pull/3539#pullrequestreview-483648025", "createdAt": "2020-09-07T16:01:11Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMToxMVrOHOD5lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMToxMVrOHOD5lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjAwNQ==", "bodyText": "The above changes include:\n\nadd ENTITY_JOIN to tableJoin so it can show up anywhere and SQL generated won't ignore it;\nchange the variable name to better reflect that ENTITY_JOIN is not special (original naming implies that it is only at the top level).", "url": "https://github.com/hibernate/hibernate-orm/pull/3539#discussion_r484506005", "createdAt": "2020-09-07T16:01:11Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/antlr/sql-gen.g", "diffHunk": "@@ -309,12 +309,13 @@ fromTable\n \t// Write the table node (from fragment) and all the join fragments associated with it.\n \t: #( a:FROM_FRAGMENT  { out(a); } (tableJoin [ a ])* { fromFragmentSeparator(a); } )\n \t| #( b:JOIN_FRAGMENT  { out(b); } (tableJoin [ b ])* { fromFragmentSeparator(b); } )\n-\t| #( e:ENTITY_JOIN    { out(e); } (tableJoin [ e ])* { fromFragmentSeparator(e); } )\n+\t| #( c:ENTITY_JOIN    { out(c); } (tableJoin [ c ])* { fromFragmentSeparator(c); } )\n \t;\n \n tableJoin [ AST parent ]\n-\t: #( c:JOIN_FRAGMENT { out(\" \"); out(c); } (tableJoin [ c ] )* )\n-\t| #( d:FROM_FRAGMENT { nestedFromFragment(d,parent); } (tableJoin [ d ] )* )\n+\t: #( d:JOIN_FRAGMENT { out(\" \"); out(d); } (tableJoin [ d ] )* )\n+\t| #( e:FROM_FRAGMENT { nestedFromFragment(e,parent); } (tableJoin [ e ] )* )\n+\t| #( f:ENTITY_JOIN   { out(\" \"); out(f); } (tableJoin [ f ] )* )\n \t;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ5MDU4", "url": "https://github.com/hibernate/hibernate-orm/pull/3539#pullrequestreview-483649058", "createdAt": "2020-09-07T16:03:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMzozOFrOHOD8ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMzozOFrOHOD8ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjc4Mg==", "bodyText": "Now the above field has been redundant for it is included in fromElements which reserves join order via LinkedHashSet.", "url": "https://github.com/hibernate/hibernate-orm/pull/3539#discussion_r484506782", "createdAt": "2020-09-07T16:03:38Z", "author": {"login": "NathanQingyangXu"}, "path": "hibernate-core/src/main/java/org/hibernate/hql/internal/ast/tree/FromClause.java", "diffHunk": "@@ -61,8 +61,6 @@\n \t */\n \tprivate List impliedElements = new LinkedList();\n \n-\tprivate List<EntityJoinFromElement> entityJoinFromElements;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "2187869d8a827d666b5435889cd2614999fb9ee8", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/2187869d8a827d666b5435889cd2614999fb9ee8", "committedDate": "2020-09-08T01:36:04Z", "message": "HHH-14201 fix HQL JOIN order issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "2187869d8a827d666b5435889cd2614999fb9ee8", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/2187869d8a827d666b5435889cd2614999fb9ee8", "committedDate": "2020-09-08T01:36:04Z", "message": "HHH-14201 fix HQL JOIN order issue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2903, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}