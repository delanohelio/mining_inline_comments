{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMjI2NjIx", "number": 3513, "title": "HHH-14178 Make new collection skip delete-orphan ", "bodyText": "https://hibernate.atlassian.net/browse/HHH-14178\nThe root cause of the unexpected exception reported is our failure to detect whether some collection is newly instantiated.\nSo below is the original code snippet:\nfinal boolean deleteOrphans = style.hasOrphanDelete()\n\t\t\t\t&& action.deleteOrphans()\n\t\t\t\t&& elemType.isEntityType()\n\t\t\t\t// a newly instantiated collection can't have orphans\n\t\t\t\t&& child instanceof PersistentCollection;\n\n\t\tif ( deleteOrphans ) {\n\nNotice the comment for the last condition to decide whether deleteOrphan should be done. However, child is always of PersistentCollection type (we have collection field substitution logic before reaching here), so it boils down to the fact that we have no safety net against running 'delete-orphan' for new collection field.\nHow to detect whether some PersistentCollection is newly instantiated?\nI added a new default method to `PersistentCollection' as following and added its usage in the above code snippet:\n\tdefault boolean isNewlyInstantiated() {\n\t\treturn getKey() == null && !isDirty();\n\t}\n\nI am open to suggestion regarding the above code logic or even better way.", "createdAt": "2020-08-24T02:47:16Z", "url": "https://github.com/hibernate/hibernate-orm/pull/3513", "merged": true, "mergeCommit": {"oid": "e1ff70519a6e8941c3e580dd423892b62ef19810"}, "closed": true, "closedAt": "2020-08-31T12:43:12Z", "author": {"login": "NathanQingyangXu"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCIBRlgBqjM2ODY5NjQ3NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEP3fRgFqTQ3ODQ3NzM4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDQzODUy", "url": "https://github.com/hibernate/hibernate-orm/pull/3513#pullrequestreview-478443852", "createdAt": "2020-08-31T09:08:15Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTowODoxNVrOHJwtww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwOTowODoxNVrOHJwtww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk5NzM3OQ==", "bodyText": "Remove", "url": "https://github.com/hibernate/hibernate-orm/pull/3513#discussion_r479997379", "createdAt": "2020-08-31T09:08:15Z", "author": {"login": "beikov"}, "path": "hibernate-core/src/main/java/org/hibernate/engine/internal/Cascade.java", "diffHunk": "@@ -565,6 +566,10 @@ private static void cascadeCollectionElements(\n \t\t}\n \t}\n \n+\tprivate static boolean isCollectionNewlyInstantiated(PersistentCollection pc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af6deb0e53408754d034bab0980bb095f4bd2292", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/af6deb0e53408754d034bab0980bb095f4bd2292", "committedDate": "2020-08-31T10:00:13Z", "message": "HHH-14178 Fix the issue collections visiting could be skipped (e.g., versioned entity) in AbstractSaveEventListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "af6deb0e53408754d034bab0980bb095f4bd2292", "author": {"user": {"login": "NathanQingyangXu", "name": "Nathan Xu"}}, "url": "https://github.com/hibernate/hibernate-orm/commit/af6deb0e53408754d034bab0980bb095f4bd2292", "committedDate": "2020-08-31T10:00:13Z", "message": "HHH-14178 Fix the issue collections visiting could be skipped (e.g., versioned entity) in AbstractSaveEventListener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDc3Mzg3", "url": "https://github.com/hibernate/hibernate-orm/pull/3513#pullrequestreview-478477387", "createdAt": "2020-08-31T10:02:07Z", "commit": {"oid": "af6deb0e53408754d034bab0980bb095f4bd2292"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2874, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}