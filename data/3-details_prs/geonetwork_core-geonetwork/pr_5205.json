{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDUzODcw", "number": 5205, "title": "Enhancements and bug fixes for non-standard projections", "bodyText": "What has been fixed?\nThis PR (version 2 of #5204) addresses several issues:\n\n[3.10.4] Alternative map projection without defined extents throws JS errors (#5115)\nsearch result bounds are not drawn if search map is not in 3857/4326 (#5152)\nsupport for alternative projections in editor bounds map (#5153)\n\nProposed solutions\nIn order to properly fix the extents/bounding boxes for alternative projections, it is crucial to make the \"default extent\" in the admin panel (Settings -> User interface) for projections a truly mandatory field. If alternative projections do not have a maximum extent, some reprojection functions fail. This should fix issues #5115 and #5152, so that metadata bounding boxes can be displayed on the map again.\nIssue #5153 is caused by a timing issue. In edit mode, metadata bounding boxes are constructed from EPSG:4326 coordinates before the map has been created. As target projection, the Map Projection setting (from Settings -> User interface) is used by default (EPSG:3857 normally). However, it is possible that the user specified an alternative projection in the config-viewer.xml, but that projection setting is only read after the bounding box has been created and transformed, causing the bounding box to have bad coordinates and appear at the wrong spot on the map. The solution is to construct and transform the bounding box when the maps creationPromise has been resolved.\nProjection settings enhancement\nOld/current projection fields:\n\nProposed/new projection fields:\n\nBecause people do not always know a valid extent for the given projection from the top of their heads, I've created ProjectionService.js that looks up the projection settings from EPSG.io for a given EPSG code, which is the reason why the Code and Label fields have been switched now. By pressing the globe button next to the EPSG field, all projection settings (including the Proj4 definition string) now get populated automatically. Users can always override this of course, but note that all projection fields must now have a value if the given EPSG is non-standard (i.e. 4326 or 3857).\nFurthermore, the highlighted \"maximum extent\" fields in the image above used to be X/Y fields, but I have discovered that this was wrong: these field values are mapped to the worldExtent property in the OpenLayers Projection object and OL expects them to be longitude-latitude values and not projected X/Y values.\nI have changed them to lon-lat fields and when the user presses the globe button to auto-populate the projection settings, the world extent will be filled in here as-is from EPSG.io and projected to the X/Y values for the default extent.\nOpenLayers GML converter patch\nI noticed that for GML FeatureMembers, the srsDimension tag is ignored by the OpenLayers GML formatter (ol.format.GML), causing the formatter to always output 3D features. This means that when the user creates/modifies a bounding polygon in the editor (advanced view), the displayed WKT and GeoJSON strings have 3 dimensions (e.g. POLYGON Z, where Z is always 0.0 for each coordinate). Commit 39f72ff introduces a function that forces the output feature to become 2D if the input had srsDimension=\"2\".\nNote\nThis PR also paves the way for issue #4811.", "createdAt": "2020-11-24T12:45:33Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205", "merged": true, "mergeCommit": {"oid": "8faed17417e9c78d80d92bc85d24b3750b77a193"}, "closed": true, "closedAt": "2020-12-01T15:54:09Z", "author": {"login": "GeoSander"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcJWXCgH2gAyNTI2NDUzODcwOmQ3YjRhODI0ZjlkOTA5MGU3ODdlZWFmZDgwNjQzYjA5NzVmYzY5MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfrgFZgFqTUzNzYzMDM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7b4a824f9d9090e787eeafd80643b0975fc6907", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/d7b4a824f9d9090e787eeafd80643b0975fc6907", "committedDate": "2020-11-13T16:00:41Z", "message": "Added service to query EPSG.io for proj4 defs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffa6a021cfc4a641ef0b748e98e950695c9a0620", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/ffa6a021cfc4a641ef0b748e98e950695c9a0620", "committedDate": "2020-11-13T16:01:28Z", "message": "Integrated ProjectionService into UiConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a816835a8ce7b2d36a369ba3bc3ea28b923b7d9", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/5a816835a8ce7b2d36a369ba3bc3ea28b923b7d9", "committedDate": "2020-11-24T12:38:10Z", "message": "Added/updated translations for projection fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be47749d32336eb8aa7b59645f861fa889a89439", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/be47749d32336eb8aa7b59645f861fa889a89439", "committedDate": "2020-11-24T12:39:06Z", "message": "Removed trailing comma, improved parsing of missing bbox or proj4 def"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "480545db2233e1bbd04ca3fbb2a3cb5151680582", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/480545db2233e1bbd04ca3fbb2a3cb5151680582", "committedDate": "2020-11-24T12:40:33Z", "message": "Use stops in extent transformations (more accurate)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9146204d7b6be7530259a4a43401fd72a09311e2", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/9146204d7b6be7530259a4a43401fd72a09311e2", "committedDate": "2020-11-24T12:40:59Z", "message": "Moved drawing of bbox after map was created (fixes #5153)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0363169eda760cbed679b49d8b0e25e15a569ff4", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/0363169eda760cbed679b49d8b0e25e15a569ff4", "committedDate": "2020-11-24T12:41:24Z", "message": "Draw bounds after map creation, apply 10% buffer to fit extent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f72ff6cb42c5921ff37b6aa4524c7c4359b519", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/39f72ff6cb42c5921ff37b6aa4524c7c4359b519", "committedDate": "2020-11-24T12:41:47Z", "message": "Fix dimensions for geometry created by ol.format.GML"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683", "author": {"user": {"login": "GeoSander", "name": "Sander Schaminee"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/3cd98a525af9132dda89b66e034761a6840a9683", "committedDate": "2020-11-24T12:41:51Z", "message": "Fixed ES5 compatibility"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTg4NjI0", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#pullrequestreview-537588624", "createdAt": "2020-11-24T15:08:38Z", "commit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTowODozOVrOH5FSMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTowODozOVrOH5FSMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYxNzQ1OA==", "bodyText": "Map now exactly fits the bounds, but this does not look very nice. This adds a buffer to the feature so the map is zoomed out a little.", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#discussion_r529617458", "createdAt": "2020-11-24T15:08:39Z", "author": {"login": "GeoSander"}, "path": "web-ui/src/main/resources/catalog/components/edit/bounding/BoundingDirective.js", "diffHunk": "@@ -171,6 +171,12 @@\n               return false;\n             };\n \n+            function getEnlargedExtent(feature) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjIyMjYz", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#pullrequestreview-537622263", "createdAt": "2020-11-24T15:23:47Z", "commit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNToyMzo0OFrOH5GB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNToyMzo0OFrOH5GB-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYyOTY4OA==", "bodyText": "Because the EPSG.io lookup uses the Code field, it makes sense to turn the Label and Code field around: Code first, then Label field.", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#discussion_r529629688", "createdAt": "2020-11-24T15:23:48Z", "author": {"login": "GeoSander"}, "path": "web-ui/src/main/resources/catalog/components/admin/uiconfig/partials/projectionSwitcher.html", "diffHunk": "@@ -3,59 +3,71 @@\n \t\tng-init=\"parentIndex=$index\">\n \t\t<td>\n \t\t\t<div class=\"input-group\">\n-\t\t\t\t<span class=\"input-group-addon\" data-translate=\"\">ui-label</span> <input", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjMwMzkx", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#pullrequestreview-537630391", "createdAt": "2020-11-24T15:29:51Z", "commit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNToyOTo1MVrOH5GgaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNToyOTo1MVrOH5GgaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYzNzQ4MQ==", "bodyText": "We use EPSG.io because:\n\nIt offers a Proj4 definition (unlike EPSG.org for example)\nIt comes recommended by OpenLayers as well (see here and here)", "url": "https://github.com/geonetwork/core-geonetwork/pull/5205#discussion_r529637481", "createdAt": "2020-11-24T15:29:51Z", "author": {"login": "GeoSander"}, "path": "web-ui/src/main/resources/catalog/components/admin/uiconfig/ProjectionService.js", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright (C) 2001-2016 Food and Agriculture Organization of the\n+ * United Nations (FAO-UN), United Nations World Food Programme (WFP)\n+ * and United Nations Environment Programme (UNEP)\n+ *\n+ * This program is free software; you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation; either version 2 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful, but\n+ * WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA\n+ *\n+ * Contact: Jeroen Ticheler - FAO - Viale delle Terme di Caracalla 2,\n+ * Rome - Italy. email: geonetwork@osgeo.org\n+ */\n+\n+(function() {\n+  goog.provide('gn_projection_service');\n+\n+  var module = angular.module('gn_projection_service', [\n+  ]);\n+\n+  // constants\n+  var SERVICE_REST_URL = 'https://EPSG.io';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cd98a525af9132dda89b66e034761a6840a9683"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1699, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}