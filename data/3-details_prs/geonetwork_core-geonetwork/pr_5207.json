{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjY2ODIy", "number": 5207, "title": "Fixed some keycloak issues when calling API's ", "bodyText": "autodetect-bearer-only needs to be set to true\n\n\nquery string was not in the redirect url so parameters were being dropped. Added query string to redirect.\n\n\nFixed bug with creating groups - it was missing labels.\n\n\nFixed bearer token parsing - it was attempting to redirect bearer token request to signin page.\n\n\nReverted this change (thank you @zoran995)\n\n\n\n\nIn a reverse proxy situation, the request could be http when the server is setup to use https and this was causing issues. Ensure it is using https if the server is configured that way.\n\nFor the reverse proxy issue - this fixed our issue with keycloak but I cannot help but think that this should be fixed at a global level? Or maybe there is already a configuration that would support this situation?\n\nAlso including a script that can be used to help test the api\nkeycloak-api-test.zip", "createdAt": "2020-11-24T18:10:51Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/5207", "merged": true, "mergeCommit": {"oid": "6b5a9053a3db47c93f218d0cb4ce6ebbc9fce50d"}, "closed": true, "closedAt": "2020-12-16T13:19:43Z", "author": {"login": "ianwallen"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdftoJaAH2gAyNTI2NjY2ODIyOjkzNTkyYWZiOTQzZDZiNGQ5ZDBhM2VhYWE4YWRkZWUwNDVhYTViMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmu0vkAFqTU1MzY3NjYwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "93592afb943d6b4d9d0a3eaaa8addee045aa5b37", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/93592afb943d6b4d9d0a3eaaa8addee045aa5b37", "committedDate": "2020-11-24T17:58:28Z", "message": "Fixed some issues when calling API's autodetect-bearer-only needs to be set to true query string was not in the redirect url so parameters were being dropped. Added query string to redirect. In a reverse proxy situation, the request could be http when the server is setup to use https and this was causing issues. Ensure it is using https if the server is configured that way."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79d0bd5ae2d5f99fac2c620f45129c99ecd3ed4", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/f79d0bd5ae2d5f99fac2c620f45129c99ecd3ed4", "committedDate": "2020-12-08T18:54:55Z", "message": "Fix bug in creating new group where the group language values were not being set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea459eeb7c259dc96c495eebf8a15bcdd753642a", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/ea459eeb7c259dc96c495eebf8a15bcdd753642a", "committedDate": "2020-12-08T19:33:26Z", "message": "Fixed issue where api calls were not being authenticated correctly and they were being redirected when they should not be."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3cfab014e0809cfa4bdf05521444e5b4d3b804a", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/f3cfab014e0809cfa4bdf05521444e5b4d3b804a", "committedDate": "2020-12-08T19:41:15Z", "message": "Remove http/https redirect caused by reverse proxy as this seems like a hack and the real solution seems to be to configure application server and keycloak correctly.\nhttps://www.keycloak.org/docs/latest/server_installation/#enable-https-ssl-with-a-reverse-proxy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "647bac25c936525dba4856065e59a43a41bb28d5", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/647bac25c936525dba4856065e59a43a41bb28d5", "committedDate": "2020-12-11T15:24:57Z", "message": "Fix resource selection so that it always gets the resource from the current client. This fixes and issue where a client from the same realm makes a api call using the token. It was using the issuer but in this case the issuer was the other client and we don't want that as it was not setting the proper permissions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDQ0MDc5", "url": "https://github.com/geonetwork/core-geonetwork/pull/5207#pullrequestreview-553444079", "createdAt": "2020-12-16T08:15:34Z", "commit": {"oid": "647bac25c936525dba4856065e59a43a41bb28d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODoxNTozNVrOIG47-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODoxNTozNVrOIG47-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA5NTIyNQ==", "bodyText": "I would add a comment explaining a bit the checks done, for example about the AdapterConstants values checks and in case that makes sense wrap them in a function.", "url": "https://github.com/geonetwork/core-geonetwork/pull/5207#discussion_r544095225", "createdAt": "2020-12-16T08:15:35Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java", "diffHunk": "@@ -58,12 +59,24 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n         HttpServletResponse servletResponse = (HttpServletResponse) response;\n \n         if (servletRequest.getPathInfo() != null &&\n-                !(servletRequest.getContextPath() + KeycloakUtil.getSigninPath()).equals(servletRequest.getRequestURI())  &&\n-                !(servletRequest.getPathInfo()).equals(\"/k_logout\")  &&\n-                !isAuthenticated() ) {\n+            !KeycloakAuthenticationProcessingFilter.DEFAULT_REQUEST_MATCHER.matches(servletRequest) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "647bac25c936525dba4856065e59a43a41bb28d5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a40dc35f38588327fececd6fa61273b42785a00f", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/a40dc35f38588327fececd6fa61273b42785a00f", "committedDate": "2020-12-16T11:07:46Z", "message": "Added comment explaining condition for sign in page redirect."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNjc2NjA1", "url": "https://github.com/geonetwork/core-geonetwork/pull/5207#pullrequestreview-553676605", "createdAt": "2020-12-16T13:19:36Z", "commit": {"oid": "a40dc35f38588327fececd6fa61273b42785a00f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1701, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}