{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMTI1NTMz", "number": 5231, "title": "Updated validation api so that it supports working copy and fixed other validation bugs", "bodyText": "Updated validation api so that it supports passing the approved flag so that it is possible to validate approved records only when workflow is enabled and there is a working copy.\nAlso updated the report so that it indicates uuid of the record and if it is a draft or not.  This also help clarify the report so that we know what record is valid/invalid.\nAlso fixed bug where numberOfRecords was set to \"0\"\nThere was another bug in which all validations seemed to fail with errors if there was a report. It was only checking for the existence of the report instead of check if the report contained failedAssert or failedSchematronVerification errors.\nPrior to this update validating a record with a working copy will produce something like the following.\n{\n  \"errors\": [],\n  \"infos\": [],\n  \"uuid\": \"d96c8a52-79d3-486a-8f7f-fc46e9fbf224\",\n  \"metadata\": [\n    116,\n    135\n  ],\n  \"metadataErrors\": {\n    \"116\": [\n      {\n        \"message\": \"Is invalid\",\n        \"date\": \"2020-12-02T07:41:32\",\n        \"stack\": \"\"\n      }\n    ],\n    \"135\": [\n      {\n        \"message\": \"Is invalid\",\n        \"date\": \"2020-12-02T07:41:32\",\n        \"stack\": \"\"\n      }\n    ]\n  },\n  \"metadataInfos\": {},\n  \"numberOfRecordNotFound\": 0,\n  \"numberOfRecordsNotEditable\": 0,\n  \"numberOfRecordsWithErrors\": 2,\n  \"numberOfRecords\": 0,\n  \"numberOfNullRecords\": 0,\n  \"numberOfRecordsProcessed\": 2,\n  \"type\": \"SimpleMetadataProcessingReport\",\n  \"running\": false,\n  \"ellapsedTimeInSeconds\": 2,\n  \"startIsoDateTime\": \"2020-12-02T07:41:31\",\n  \"totalTimeInSeconds\": 2,\n  \"endIsoDateTime\": \"2020-12-02T07:41:33\"\n}\n\nBased on this, we don't know if this was just one metadata uuid or multiple? And we cannot tell which one is the draft/working copy.\nAfter these changes are applied, the report will look like the following.\n{\n  \"errors\": [],\n  \"infos\": [],\n  \"uuid\": \"626b8a49-621a-42cc-ba84-eaa67b7bf71b\",\n  \"metadata\": [\n    116,\n    135\n  ],\n  \"metadataErrors\": {\n    \"116\": [\n      {\n        \"message\": \"Is invalid\",\n        \"uuid\": \"da165110-88fd-11da-a88f-000d939bc5d8\",\n        \"draft\": false,\n        \"date\": \"2020-12-02T12:03:16\",\n        \"stack\": \"\"\n      }\n    ]\n  },\n  \"metadataInfos\": {\n    \"135\": [\n      {\n        \"message\": \"Is valid\",\n        \"uuid\": \"da165110-88fd-11da-a88f-000d939bc5d8\",\n        \"draft\": true,\n        \"date\": \"2020-12-02T12:03:29\"\n      }\n    ]\n  },\n  \"numberOfRecordsNotEditable\": 0,\n  \"numberOfRecordNotFound\": 0,\n  \"numberOfRecords\": 2,\n  \"numberOfNullRecords\": 0,\n  \"numberOfRecordsWithErrors\": 1,\n  \"numberOfRecordsProcessed\": 2,\n  \"type\": \"SimpleMetadataProcessingReport\",\n  \"running\": false,\n  \"totalTimeInSeconds\": 26,\n  \"startIsoDateTime\": \"2020-12-02T12:03:06\",\n  \"endIsoDateTime\": \"2020-12-02T12:03:32\",\n  \"ellapsedTimeInSeconds\": 26\n}", "createdAt": "2020-12-02T16:11:46Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231", "merged": true, "mergeCommit": {"oid": "a8cdf148595178ff2a85bee7e1ee7f2c2c77df6d"}, "closed": true, "closedAt": "2021-01-04T09:46:10Z", "author": {"login": "ianwallen"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiOYgfAH2gAyNTMxMTI1NTMzOjdmZDJhYzZjN2ViZDMxMmZkNGQzYTQzZjdmYTE4M2M4MTIyOGU2NWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdszKE2AFqTU2MDg5NTA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7fd2ac6c7ebd312fd4d3a43f7fa183c81228e65e", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/7fd2ac6c7ebd312fd4d3a43f7fa183c81228e65e", "committedDate": "2020-12-02T13:16:06Z", "message": "Updated validation api so that it supports passing the approved flag so that it is possible to validate approved records only when workflow is enabled and there is a working copy.\nAlso updated the report so that it indicates uuid of the record and if it is a draft or not.  This also help clarify the report so that we know what record is valid/invalid.\nAlso fixed bug where numberOfRecords was set to \"0\" in validate api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f161024c3552edec5d1e142c5f450371f145646b", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/f161024c3552edec5d1e142c5f450371f145646b", "committedDate": "2020-12-02T16:08:44Z", "message": "Fixed validation bug - it was only checking for the existence of the report instead of check if the report contained failedAssert or failedSchematronVerification errors.\nSo if the report only contained assert that passed, it was still returning that the record was invalid."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTc3Mzc0", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#pullrequestreview-548977374", "createdAt": "2020-12-10T09:00:43Z", "commit": {"oid": "f161024c3552edec5d1e142c5f450371f145646b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOTowMDo0M1rOIC-Xlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOTowMDo0M1rOIC-Xlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk4OTkxMQ==", "bodyText": "This check is not correct, when created a new metadata the record is stored in the Metadata table, not in the MetadataDraft table.\nmetadataRepository.findAllByUuid(uuid) should return 1 record if the metadata is approved or is draft, but never published and 2 records if the metadata is published and also has a draft copy. Not really optimal, but maybe can be used these conditions for the checks.", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#discussion_r539989911", "createdAt": "2020-12-10T09:00:43Z", "author": {"login": "josegar74"}, "path": "services/src/main/java/org/fao/geonet/api/processing/ValidateApi.java", "diffHunk": "@@ -183,27 +188,40 @@ public SimpleMetadataProcessingReport validateRecords(\n             ServiceContext serviceContext = ApiUtils.createServiceContext(request);\n \n             Set<String> records = ApiUtils.getUuidsParameterOrSelection(uuids, bucket, userSession);\n+            report.setTotalRecords(records.size());\n \n             for (String uuid : records) {\n-                if (!metadataRepository.existsMetadataUuid(uuid)) {\n-                    report.incrementNullRecords();\n-                }\n+                int loopConditionCount = 0;\n                 for (AbstractMetadata record : metadataRepository.findAllByUuid(uuid)) {\n-                    if (!accessMan.canEdit(serviceContext, String.valueOf(record.getId()))) {\n-                        report.addNotEditableMetadataId(record.getId());\n-                    } else {\n-                        boolean isValid = validator.doValidate(record, serviceContext.getLanguage());\n-                        if (isValid) {\n-                            report.addMetadataInfos(record.getId(), \"Is valid\");\n-                            new RecordValidationTriggeredEvent(record.getId(), ApiUtils.getUserSession(request.getSession()).getUserIdAsInt(), \"1\").publish(applicationContext);\n+                    if (approved == null ||\n+                        (approved == true && !(record instanceof MetadataDraft)) ||\n+                        (approved == false && record instanceof MetadataDraft)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f161024c3552edec5d1e142c5f450371f145646b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57a9da624a054bfef911f3cfb3fdb51984226b7a", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/57a9da624a054bfef911f3cfb3fdb51984226b7a", "committedDate": "2020-12-10T21:39:02Z", "message": "Fix bug with not detecting approved draft correctly.\n    Add new function to test if Published Approved or Draft\n    Added approved to the report."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNTkzMzI1", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#pullrequestreview-553593325", "createdAt": "2020-12-16T11:24:56Z", "commit": {"oid": "57a9da624a054bfef911f3cfb3fdb51984226b7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMToyNDo1NlrOIHAl5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMToyNDo1NlrOIHAl5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIyMDY0NA==", "bodyText": "Update the message to approved instead of  draft", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#discussion_r544220644", "createdAt": "2020-12-16T11:24:56Z", "author": {"login": "josegar74"}, "path": "services/src/main/java/org/fao/geonet/api/processing/report/MetadataProcessingReport.java", "diffHunk": "@@ -89,39 +94,88 @@ public MetadataProcessingReport() {\n         return metadataErrors;\n     }\n \n-    public synchronized void addMetadataError(int metadataId, Exception error) {\n+    public synchronized void addMetadataError(int metadataId, String metadataUUID, boolean draft, boolean approved,\n+                                              Exception error) {\n+        Report errorReport = new ErrorReport(error);\n+        errorReport.setUuid(metadataUUID);\n+        errorReport.setDraft(draft);\n+        errorReport.setApproved(approved);\n         if (this.metadataErrors.get(metadataId) == null) {\n             List<Report> errors = new ArrayList<>();\n-            errors.add(new ErrorReport(error));\n+            errors.add(errorReport);\n             this.metadataErrors.put(metadataId, errors);\n         } else {\n-            this.metadataErrors.get(metadataId).add(new ErrorReport(error));\n+            this.metadataErrors.get(metadataId).add(errorReport);\n         }\n     }\n \n-    public synchronized void addMetadataError(int metadataId, String error) {\n+    public void addMetadataError(AbstractMetadata metadata, Exception error) {\n+        addMetadataError(metadata.getId(), metadata.getUuid(), isMetadataDraft(metadata.getId()),\n+            isMetadataApproved(metadata.getId()), error);\n+    }\n+\n+    public synchronized void addMetadataError(int metadataId, String metadataUUID, boolean draft, boolean approved,\n+                                              String error) {\n+        Report errorReport = new ErrorReport(error);\n+        errorReport.setUuid(metadataUUID);\n+        errorReport.setDraft(draft);\n+        errorReport.setApproved(approved);\n         if (this.metadataErrors.get(metadataId) == null) {\n             List<Report> errors = new ArrayList<>();\n-            errors.add(new ErrorReport(error));\n+            errors.add(errorReport);\n             this.metadataErrors.put(metadataId, errors);\n         } else {\n-            this.metadataErrors.get(metadataId).add(new ErrorReport(error));\n+            this.metadataErrors.get(metadataId).add(errorReport);\n         }\n     }\n \n+    public void addMetadataError(AbstractMetadata metadata, String error) {\n+        addMetadataError(metadata.getId(), metadata.getUuid(), isMetadataDraft(metadata.getId()),\n+            isMetadataApproved(metadata.getId()), error);\n+    }\n+\n     @XmlElement(name = \"infos\")\n     public Map<Integer, List<InfoReport>> getMetadataInfos() {\n         return metadataInfos;\n     }\n \n-    public void addMetadataInfos(int metadataId, String message) {\n+    public void addMetadataInfos(int metadataId, String metadataUUID, boolean draft, boolean approved, String message) {\n+        InfoReport infoReport = new InfoReport(message);\n+        infoReport.setUuid(metadataUUID);\n+        infoReport.setDraft(draft);\n+        infoReport.setApproved(approved);\n         if (this.metadataInfos.get(metadataId) == null) {\n             List<InfoReport> infos = new ArrayList<>();\n-            infos.add(new InfoReport(message));\n+            infos.add(infoReport);\n             this.metadataInfos.put(metadataId, infos);\n         } else {\n-            this.metadataInfos.get(metadataId).add(new InfoReport(message));\n+            this.metadataInfos.get(metadataId).add(infoReport);\n+        }\n+    }\n+\n+    public void addMetadataInfos(AbstractMetadata metadata, String message) {\n+        addMetadataInfos(metadata.getId(), metadata.getUuid(), isMetadataDraft(metadata.getId()),\n+            isMetadataApproved(metadata.getId()), message);\n+    }\n+\n+    private boolean isMetadataDraft(int metadataId) {\n+        boolean metadataDraft = false;\n+        try {\n+            metadataDraft = ApplicationContextHolder.get().getBean(IMetadataUtils.class).isMetadataDraft(metadataId);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Error detecting if metadata is draft\");\n+        }\n+        return metadataDraft;\n+    }\n+\n+    private boolean isMetadataApproved(int metadataId) {\n+        boolean metadataApproved = false;\n+        try {\n+            metadataApproved = ApplicationContextHolder.get().getBean(IMetadataUtils.class).isMetadataApproved(metadataId);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Error detecting if metadata is draft\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57a9da624a054bfef911f3cfb3fdb51984226b7a"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNTk0NjMy", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#pullrequestreview-553594632", "createdAt": "2020-12-16T11:26:37Z", "commit": {"oid": "57a9da624a054bfef911f3cfb3fdb51984226b7a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdba862e8b5900bff0e4581ccff27efefbf56d82", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/cdba862e8b5900bff0e4581ccff27efefbf56d82", "committedDate": "2020-12-16T11:54:24Z", "message": "Fixed exception message for checking if metadata is approved."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODk1MDg3", "url": "https://github.com/geonetwork/core-geonetwork/pull/5231#pullrequestreview-560895087", "createdAt": "2021-01-04T09:46:04Z", "commit": {"oid": "cdba862e8b5900bff0e4581ccff27efefbf56d82"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1714, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}