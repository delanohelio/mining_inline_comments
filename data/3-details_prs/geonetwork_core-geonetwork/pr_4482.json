{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDc4ODY4", "number": 4482, "title": "fix memory leak due to incorrect ref count handling (#4481)", "bodyText": "See #4481\nI've modified TaxonomyIndexTracker so that it does a better job of releasing TaxonomyReaders.\nDuring harvesting, maybeRefresh() would be called (often).  The \"openIfChanged()\" call would create a new DirectoryTaxonomyReader.  However, the old one would not be released.\nWhen you create a TaxonomyReader, it will have a ref count of 1.  There wasn't any code that would decrement it so it would always go in the expiredReader list.\nI've modified this so it would be better at handling the ref counts.  The reference that TaxonomyIndexTracker keeps (for this.taxonomyReader) is one reference count (the one that is automatically created when you create a TaxonomyReader).  If someone calls aquire(), then it gets a 2nd reference count.\nIf maybeRefresh() creates another TaxonomyReader, it is throwing away its old one.  So, when TaxonomyIndexTracker no longer needs the old Reader, it decrements the ref count and it will be likely be released.\nThis means that code that calls aquire() should release (close or decrement the reference) when it's finished with it.  I noticed that this isn't happened (I put some comments in the code to indicate where) - however, this doesn't seem to be a major leak problem.  This PR doesn't fix this (existing) problem (which doesn't seem to be causing any issues).\nSince the ref count is pretty complex, I've put quite a few comments in the code -- hopefully this will make sense to others in the future.", "createdAt": "2020-02-27T21:19:46Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482", "merged": true, "mergeCommit": {"oid": "4e19660d40f8438917bcbc821006f8de6e7d2e48"}, "closed": true, "closedAt": "2020-05-01T08:57:29Z", "author": {"login": "davidblasby"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIh5k9AH2gAyMzgxMDc4ODY4OmRmZTQ4Y2U3MGIxM2Q1MDlmYWU1YTA0MzRiNTMyYzFmY2U2YjMwZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXs0R6AFqTM5MzM3OTA2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "author": {"user": null}, "url": "https://github.com/geonetwork/core-geonetwork/commit/dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "committedDate": "2020-02-27T21:07:14Z", "message": "4481: fix memory leak due to incorrect ref count handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTg3ODQ3", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#pullrequestreview-366187847", "createdAt": "2020-02-28T06:47:03Z", "commit": {"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNjo0NzowM1rOFvq_pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNjo0NzowM1rOFvq_pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUzMTgxMg==", "bodyText": "The taxonomyReader is used in LuceneSearcher and CatalogSearcher during the searches to build the facet summary.  In LuceneSearcher:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java\n    \n    \n        Lines 1649 to 1662\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           private TopDocs performQuery(ServiceContext context, int startHit, int endHit, boolean buildSummary) throws Exception { \n        \n\n        \n          \n               IndexAndTaxonomy indexAndTaxonomy = _sm.getIndexReader(_language.presentationLanguage, _versionToken); \n        \n\n        \n          \n               _versionToken = indexAndTaxonomy.version; \n        \n\n        \n          \n               Pair<TopDocs, Element> results; \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   results = doSearchAndMakeSummary(endHit, startHit, endHit, \n        \n\n        \n          \n                       _language.presentationLanguage, \n        \n\n        \n          \n                       _summaryConfig, _luceneConfig, \n        \n\n        \n          \n                       indexAndTaxonomy.indexReader, \n        \n\n        \n          \n                       _query, _filter, _sort, indexAndTaxonomy.taxonomyReader, \n        \n\n        \n          \n                       buildSummary); \n        \n\n        \n          \n               } finally { \n        \n\n        \n          \n                   _sm.releaseIndexReader(indexAndTaxonomy); \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nProbably can be closed, but the existing code is not even calling IndexAndTaxonomy.close(), but _sm.releaseIndexReader(indexAndTaxonomy); that does the same code as in IndexAndTaxonomy.close():\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java\n    \n    \n        Lines 1211 to 1213\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           public void releaseIndexReader(IndexAndTaxonomy reader) throws InterruptedException, IOException { \n        \n\n        \n          \n               reader.indexReader.releaseToNRTManager(); \n        \n\n        \n          \n           }", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#discussion_r385531812", "createdAt": "2020-02-28T06:47:03Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/search/IndexAndTaxonomy.java", "diffHunk": "@@ -44,5 +44,7 @@ public IndexAndTaxonomy(long version, GeonetworkMultiReader indexReader, Taxonom\n     @Override\n     public void close() throws IOException {\n         indexReader.releaseToNRTManager();\n+        //TODO: this has a taxonomyReader in it, and it should be \"closed\" (decrement a ref)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTg4ODU5", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#pullrequestreview-366188859", "createdAt": "2020-02-28T06:50:10Z", "commit": {"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzc5MDYx", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#pullrequestreview-393379061", "createdAt": "2020-04-15T00:19:16Z", "commit": {"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1671, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}