{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMTE0MDc4", "number": 4815, "title": "Es active filters", "bodyText": "Implementation of the active filters.\n\nTODO :\n\nmanage datestamp removing by the use of https://github.com/geonetwork/core-geonetwork/blob/4.0.x/web-ui/src/main/resources/catalog/components/search/searchmanager/SearchFormDirective.js#L436-L437 or by a new specific function?", "createdAt": "2020-06-30T15:34:56Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815", "merged": true, "mergeCommit": {"oid": "0b26dc1cb6290ef9183f3ddf79702b2a2a453e98"}, "closed": true, "closedAt": "2020-07-03T12:57:24Z", "author": {"login": "davinciagf"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwVbVzgH2gAyNDQyMTE0MDc4OjkxYzRhZDQzMzFmNjM3MGExODg3OThlNTc0NDQzNjMwOTFmYzBjZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxOh2egH2gAyNDQyMTE0MDc4OjhkZjhmN2QxNzU3YTkzY2Y1MzM0NjkyZTczYmZhZGM1NWZmNmQ0ZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91c4ad4331f6370a188798e57444363091fc0cd9", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/91c4ad4331f6370a188798e57444363091fc0cd9", "committedDate": "2020-06-30T13:12:19Z", "message": "ES - Active filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/3359ad4a63374fa31c6b0244a11cd9827468052e", "committedDate": "2020-06-30T15:29:15Z", "message": "Active filter - add several values for a facet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODEyMjg5", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#pullrequestreview-440812289", "createdAt": "2020-07-01T12:13:45Z", "commit": {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoxMzo0NVrOGrjUyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMzo1MjoyNVrOGrm2BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMDcxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    let elem = {};\n          \n          \n            \n                                    var elem = {};", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448320713", "createdAt": "2020-07-01T12:13:45Z", "author": {"login": "jahow"}, "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -179,20 +179,45 @@\n                 }\n \n                 // general case\n-                scope.currentFilters.push({\n-                  key: filterKey,\n-                  value: value\n-                });\n+                if (filterKey===\"query_string\"){\n+                  angular.forEach(JSON.parse(value), function(facetValues, facetKey) {\n+                    if (typeof facetValues === 'object') {\n+                      angular.forEach(facetValues, function (values, facetValuesKey) {\n+                        let elem = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM3MjI5MQ==", "bodyText": "Commented code should be removed", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448372291", "createdAt": "2020-07-01T13:43:04Z", "author": {"login": "jahow"}, "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -179,20 +179,45 @@\n                 }\n \n                 // general case\n-                scope.currentFilters.push({\n-                  key: filterKey,\n-                  value: value\n-                });\n+                if (filterKey===\"query_string\"){\n+                  angular.forEach(JSON.parse(value), function(facetValues, facetKey) {\n+                    if (typeof facetValues === 'object') {\n+                      angular.forEach(facetValues, function (values, facetValuesKey) {\n+                        let elem = {};\n+                        elem[facetValuesKey]=values;\n+                        scope.currentFilters.push({\n+                          key: facetKey,\n+                          value: elem\n+                        })\n+                      })\n+                    }\n+                    else {\n+                      scope.currentFilters.push({\n+                        key: facetKey,\n+                        value: facetValues\n+                      })\n+                    }\n+                  })\n+                }\n+                else {\n+                }\n               }\n             }, true);\n \n             scope.removeFilter = function(filter) {\n-              if (filter.isFacet) {\n+              removeFacetElement=[]\n+              removeFacetElement.push(filter.key)\n+              if (Object.keys(filter.value)[0] != 0)\n+                removeFacetElement.push(Object.keys(filter.value)[0])\n+              else\n+                removeFacetElement.push(filter.value)\n+              ngSearchFormCtrl.updateState(removeFacetElement, true);\n+              /*if (filter.isFacet) {\n                 var facetQuery = removeFacet(filter.facetKey, getSearchParams()['facet.q']);\n                 setSearchParameter('facet.q', facetQuery);\n               } else {\n                 setSearchParameter(filter.key, null);\n-              }\n+              }*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM3ODM3Mg==", "bodyText": "Same here, commented out code should be removed.", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448378372", "createdAt": "2020-07-01T13:52:25Z", "author": {"login": "jahow"}, "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js", "diffHunk": "@@ -227,7 +262,7 @@\n         }\n       });\n \n-      return result;\n+      return result;*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3359ad4a63374fa31c6b0244a11cd9827468052e"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9968580e10e34f0c791a2b86a32ff6fa5951642", "author": {"user": {"login": "fxprunayre", "name": "Fran\u00e7ois Prunayre"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/b9968580e10e34f0c791a2b86a32ff6fa5951642", "committedDate": "2020-07-02T06:55:39Z", "message": "Update web-ui/src/main/resources/catalog/components/search/searchfiltertag/SearchFilterTagsDirective.js\n\nCo-authored-by: Olivier Guyot <olivier.guyot@camptocamp.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11653ed8e2d684726487fb604938960b776bba66", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/11653ed8e2d684726487fb604938960b776bba66", "committedDate": "2020-07-02T07:22:37Z", "message": "Active filter - remove comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5363099585a377e19d950a28e44dcf505fe36ea8", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/5363099585a377e19d950a28e44dcf505fe36ea8", "committedDate": "2020-07-02T08:48:33Z", "message": "Active filter - add active filter for any"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dba0b77c51efe24b0e12c8b2678b4eb67247309f", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/dba0b77c51efe24b0e12c8b2678b4eb67247309f", "committedDate": "2020-07-02T09:00:19Z", "message": "Merge remote-tracking branch 'AGF/ES_activeFilters' into ES_activeFilters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjEzNDMx", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#pullrequestreview-441613431", "createdAt": "2020-07-02T12:05:55Z", "commit": {"oid": "5363099585a377e19d950a28e44dcf505fe36ea8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjowNTo1NVrOGsJ6UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToxMzowMlrOGsRRTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1MjkxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                };\n          \n          \n            \n                }", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r448952912", "createdAt": "2020-07-02T12:05:55Z", "author": {"login": "jahow"}, "path": "web-ui/src/main/resources/catalog/components/search/searchmanager/SearchFormDirective.js", "diffHunk": "@@ -432,22 +432,26 @@\n     }\n \n     this.updateState = function(path, value, doNotRemove) {\n-      var filters = $scope.searchObj.state.filters;\n-      var getter = parse(path.join('^^^'));\n-      var existingValue = getter(filters);\n-      if(angular.isUndefined(existingValue) || doNotRemove) {\n-        var setter = getter.assign;\n-        setter(filters, value)\n+      if(path[0] === 'any') {\n+        delete $scope.searchObj.params.any;\n       } else {\n-        if(existingValue !== value) {\n+        var filters = $scope.searchObj.state.filters;\n+        var getter = parse(path.join('^^^'));\n+        var existingValue = getter(filters);\n+        if(angular.isUndefined(existingValue) || doNotRemove) {\n           var setter = getter.assign;\n           setter(filters, value)\n         } else {\n-          removeKey(filters, path)\n+          if(existingValue !== value) {\n+            var setter = getter.assign;\n+            setter(filters, value)\n+          } else {\n+            removeKey(filters, path)\n+          }\n         }\n       }\n       this.triggerSearch();\n-    }\n+    };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5363099585a377e19d950a28e44dcf505fe36ea8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MzQ4Ng==", "bodyText": "The translate directive should be added here, otherwise the translation does not happen.", "url": "https://github.com/geonetwork/core-geonetwork/pull/4815#discussion_r449073486", "createdAt": "2020-07-02T15:13:02Z", "author": {"login": "jahow"}, "path": "web-ui/src/main/resources/catalog/components/search/searchfiltertag/partials/searchFilterTagsTemplate.html", "diffHunk": "@@ -12,7 +12,10 @@\n        ng-repeat=\"filter in currentFilters\"\n        ng-click=\"removeFilter(filter)\">\n       <span class=\"fa fa-times text-danger delete-icon\"></span>\n-      <strong class=\"text-no-wrap text-uppercase\" translate>{{filter.key}}</strong>\n+      <strong class=\"text-no-wrap text-uppercase\" translate>\n+        <span ng-if=\"filter.key!='any'\">{{('facet-' + filter.key)}}</span>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dba0b77c51efe24b0e12c8b2678b4eb67247309f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9631024a3fe3ed1ba298d7bb5b7250af1de62f83", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/9631024a3fe3ed1ba298d7bb5b7250af1de62f83", "committedDate": "2020-07-03T07:15:46Z", "message": "Active filter - fix translate dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df8f7d1757a93cf5334692e73bfadc55ff6d4e4", "author": {"user": {"login": "davinciagf", "name": null}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/8df8f7d1757a93cf5334692e73bfadc55ff6d4e4", "committedDate": "2020-07-03T07:44:01Z", "message": "Update web-ui/src/main/resources/catalog/components/search/searchmanager/SearchFormDirective.js\n\nCo-authored-by: Olivier Guyot <olivier.guyot@camptocamp.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1594, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}