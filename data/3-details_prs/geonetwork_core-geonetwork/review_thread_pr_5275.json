{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMzg2Mzc3", "number": 5275, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMzowMjoyM1rOFHyJng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMzowMzoyNFrOFHyKog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNzA2MDE0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMzowMjoyNFrOIJXhJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0xM1QwODo1NDo0OVrOJH5arA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ==", "bodyText": "There's some previous code doing similar stuff:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java\n    \n    \n        Lines 918 to 920\n      in\n      c264cde\n    \n    \n    \n    \n\n        \n          \n           if (metadataId.isPresent()) { \n        \n\n        \n          \n               metadata = metadataUtils.findOne(metadataId.get()); \n        \n\n        \n          \n           }", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693415", "createdAt": "2020-12-21T13:02:24Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI2MDUyNA==", "bodyText": "Indeed", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r612260524", "createdAt": "2021-04-13T08:54:49Z", "author": {"login": "fxprunayre"}, "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ=="}, "originalCommit": {"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNzA2Mjc0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMzowMzoyNFrOIJXirQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMzoxOTozMlrOIJX_TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ==", "bodyText": "update-fixed-info is applied before the metadata is saved in the database, no? I think this code will retrieve the previous change date?", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693805", "createdAt": "2020-12-21T13:03:24Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {\n+                    java.util.Optional<Metadata> record = metadataRepository.findById(metadataId.get());\n+                    if (record.isPresent()) {\n+                        changeDate = record.get().getDataInfo().getChangeDate().getDateAndTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcwMTEzMw==", "bodyText": "Metadata object is modified before so this is fine.\nBut it does not work on newly created record because the record is not yet in the database. Not sure how can this be solved without adding the creation date as method parameter?", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546701133", "createdAt": "2020-12-21T13:19:32Z", "author": {"login": "fxprunayre"}, "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {\n+                    java.util.Optional<Metadata> record = metadataRepository.findById(metadataId.get());\n+                    if (record.isPresent()) {\n+                        changeDate = record.get().getDataInfo().getChangeDate().getDateAndTime();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ=="}, "originalCommit": {"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4250, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}