{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNzY2ODA5", "number": 5279, "title": "Fix some working copy merge issues", "bodyText": "Create replaceDataDir to be used when merging a draft back to approved record. The previous copyDataDir would just copy the data and not remove the records that were deleted in the draft.\nAlso added cleanup of draft resources after the draft is merged to the approved record.\nPrior to this release it was not possible to remove a resource.\n\nEnable workflow\nCreate new metadata and add thumbnail image (image1)\nApprove/publish the metadata\nEdit metadata - it should create a new working copy\nIn the file store remove the image - but keep the thumbnail link in the metadata record.  Thumbnail should show up as broken image.\nAlso add a new thumbnail - different image (image2).\nSave the metadata record and approve\n\n2 Bugs that are fixed with these changes.\n\nThe thumbnail in the approved version is visible even when it should have been removed.  (image1 was not removed from approved metadata folder)\nIf you go on the filesystem - you will see (image2) still exists in the draft metadata folder when it should have been removed when draft was removed after the approval.", "createdAt": "2020-12-18T20:48:30Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/5279", "merged": true, "mergeCommit": {"oid": "f4f63808d6e3547e4f06b739b4a83fccb1272729"}, "closed": true, "closedAt": "2021-01-07T12:11:06Z", "author": {"login": "ianwallen"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdneXBngH2gAyNTQyNzY2ODA5OjNkN2FmMGM3OTY3YjU2ZjNjZGIyZWY5OWNkNWEzYTNjZWY2NTQwOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtje4TAH2gAyNTQyNzY2ODA5OmIyZjkwYjBlM2M0YTJjNmM1Mjc5OGE4ZTNlNjkxOGJkNDUzODU4ZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d7af0c7967b56f3cdb2ef99cd5a3a3cef654093", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/3d7af0c7967b56f3cdb2ef99cd5a3a3cef654093", "committedDate": "2020-12-18T20:42:35Z", "message": "Create replaceDataDir to be used when merging a draft back to approved record. The previous copyDataDir would just copy the data and not remove the records that were deleted in the draft. Also added cleanup of resources after the draft is merged to the approved record."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad", "committedDate": "2021-01-04T11:59:50Z", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into working_copy_replace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxODE0ODU5", "url": "https://github.com/geonetwork/core-geonetwork/pull/5279#pullrequestreview-561814859", "createdAt": "2021-01-05T14:07:36Z", "commit": {"oid": "f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNDowNzozN1rOIOYhsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNDowNzozN1rOIOYhsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk1MjgxOA==", "bodyText": "This code is updating the list in the parameter l, can cause some side effects. I would create a copied list instead of relying to clone the list in the function call as done later:\n exceptMetadataResource(new ArrayList<>(targetResources), sourceResources);", "url": "https://github.com/geonetwork/core-geonetwork/pull/5279#discussion_r551952818", "createdAt": "2021-01-05T14:07:37Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/api/records/attachments/StoreUtils.java", "diffHunk": "@@ -80,6 +77,82 @@ public static void copyDataDir(ServiceContext context, String oldUuid, String ne\n         }\n     }\n \n+    /**\n+     * Ues to to remove items from a metadataResource list\n+     *\n+     * @param l left list\n+     * @param r right list\n+     * @return l except r\n+     */\n+    private static List<MetadataResource> exceptMetadataResource(List<MetadataResource> l, List<MetadataResource> r)  {\n+        Map<String,MetadataResource> rMap = new HashMap<>();\n+        for (MetadataResource mr : r) rMap.put(mr.getId(),mr);\n+\n+        Iterator<MetadataResource> itr = l.iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f752f8b8d3b2a0b4b6e9e454479f7766a55a46ad"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97b7ccf09a270c64bc61a1b2d814b5dd47abc6bf", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/97b7ccf09a270c64bc61a1b2d814b5dd47abc6bf", "committedDate": "2021-01-05T19:57:43Z", "message": "Update exceptMetadataResource so that it makes a clone of the data that it modifies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f90b0e3c4a2c6c52798a8e3e6918bd453858df", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/b2f90b0e3c4a2c6c52798a8e3e6918bd453858df", "committedDate": "2021-01-06T18:04:14Z", "message": "Minor corrections to typos in comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1735, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}