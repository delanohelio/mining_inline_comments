{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDUzNDU5", "number": 4931, "title": "Security enhancement - support for Keycloak", "bodyText": "Add security enhancement - Keycloak/OpenID Connect support\nTo perform a quick test against an existing keycloak setup the following can be done.\n\nUpdate  web/src/main/webapp/WEB-INF/config-security/config-security.xml to enable keycloak\nbuild and startup the geonetwork application with https and the following environment variables set.\n\nKEYCLOAK_AUTH_SERVER_URL={keycloak url}\nKEYCLOAK_REALM={realm name}\nKEYCLOAK_RESOURCE={client name}\nKEYCLOAK_SECRET={client secret}\nKEYCLOAK_DISABLE_TRUST_MANAGER={true|false}\n\nIf using example setup from the following.\nhttps://www.keycloak.org/getting-started/getting-started-docker\nThen the values would be\nKEYCLOAK_AUTH_SERVER_URL=http://localhost:8080/auth\nKEYCLOAK_REALM=myrealm\nKEYCLOAK_RESOURCE=myclient\nKEYCLOAK_SECRET={get secret from going to client configuration under Clients -> myclient -> Credentials}\nKEYCLOAK_DISABLE_TRUST_MANAGER=true\n\nIf testing with local host then you may want to set KEYCLOAK_DISABLE_TRUST_MANAGER=true  For production it is recommended to use HTTPS and also set this value to false (false is the default if not supplied)\nYou can also setup more advance keycloak settings by editing the following\nweb/src/main/webapp/WEB-INF/config-security/keycloak.json\nGeonetowk client URL configurations\nEnsure that when you configure your client that you setup the valid redirect uris to your geonetwork installation.\ni.e. https://localhost:8443/geonetwork/*\nIf this is not setup correctly you may get and error indicating that a wrong redirect uri was supplied.\nAlso if wanting to test the client backchannel logout then ensure that the admin URL is also set to the geonetwork installation.\nHere is a sample configuration.\n\nSample user/role/group setup\n(Assuming client is called myclient)\nSample Role setup\nIn your client role settings (clients -> myclient -> roles). Add the following roles\n\nAdministrator\nRegisteredUser\nGuest\nsample:UserAdmin\nsample:Reviewer\nsample:Editor\nsample:RegisteredUser\n\nSample Group configuration\n\nGo to keycloak groups (left menu).\nCreate a new group called \"Administrator\"\nEdit the group. Go to Role Mappings -> Client Roles (myclient) -> select the administrator roles and click on \"Add selected\"\nAny user part of the Administrator group will not be an administrator for the myclient applicaton.\n\nSample User configuration\n\n\nGo to keycloak users (left menu)\n\n\nAdd user if not already done so.  Then go to that user.\n\n\nGo to role Mappings -> Client Roles (myclient) -> select the available roles to be applied and click on \"Add selected\"\n\n\nor\n\nGo to Groups -> Available Groups -> Click on the Administrator Group and then click on \"Join\"\n\nSingle Signout\nIf testing Single Signout, you may need to ensure that you have proper certificates for keycloak and the geonetwork application.\nAnd ensure the truststore has been setup https://www.keycloak.org/docs/4.8/server_installation/index.html#_truststore\nNote: we had some difficulties testing this using localhost due to the https requirements and our corporate network did not allow us to add root certificates required for the truststore.  So we only tested this on a deployed server environment with real domain names.\nYou will also need to ensure that the Admin URL is configured as identified in the URL Configurations above.\nTo test Single Signout, you generally require multiple clients on the same realm.  However it is possible to test this by killing the sessions from within Keycloak. So in our case, we initially tested this logic by first login into Geonetwork. - Then go to keycloak Users - and locate the user then go to the Sessions tab.  Then when you logout the user, the system should send a client backchannel request to admin url specified in the url configuration.  This should terminate your geonetwork session. If you then refresh your GN session - you should no longer be logged in.  Note: This will only work if the admin url can be successfully called from keycloak server.  So if there are issues with this functionality, you may want to check the keycloak logs for errors.\nIdentity provider (IDP) issues\nIf testing with and IDP that does not support BackChannel logout you may want to use the parameter .  In this case you may want to add the parameter KEYCLOAK_IDPLOGOUTURL.  It has to be in the format similar to https://idp.example.com/logout?redirect={RedirecUrl}.  {RedirecUrl} is required in the url.\nFor example. In our case were are using Azure Active Directory (AD) for testing. Azure AD does not support BackChannel logout so we used the following url for KEYCLOAK_IDPLOGOUTURL.\nhttps://login.microsoftonline.com/common/oauth2/logout?post_logout_redirect_uri={RedirecUrl}\nComments/testing welcome\n** Future changes **\n\nAdd documentation - will do this after changes have been accepted.\nInvestigate pushing GN group changes back to keycloak  or block group changes if only managed via keycloak.\nRoles are currently assigned in the format of group:role  - i.e. sample:editor - investigate better option", "createdAt": "2020-08-12T23:14:00Z", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931", "merged": true, "mergeCommit": {"oid": "1173a817e14d6d4cc8f66aeeb2b3980df76ce245"}, "closed": true, "closedAt": "2020-11-18T07:18:05Z", "author": {"login": "ianwallen"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-Tg0nAH2gAyNDY3MDUzNDU5OjBhN2JlZWI5ZWJlZGJhM2I1YTljNzg3NTk1MmU3NzA4MzBkZDlmNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddbjXJAFqTUzMjUwOTkzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a7beeb9ebedba3b5a9c7875952e770830dd9f74", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/0a7beeb9ebedba3b5a9c7875952e770830dd9f74", "committedDate": "2020-08-12T22:53:26Z", "message": "Security enhancement implementation of the Keycloak adapter for OpenID Connect support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "099708633d7fcdbd86ab365f566d1651c175578e", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/099708633d7fcdbd86ab365f566d1651c175578e", "committedDate": "2020-09-11T16:25:29Z", "message": "Added SSO on guest pages which uses a public client to check if already logged in.\n   Added public client option for cases where we may be using a public client and confidential client.\n   Added required scripts for SSO check\nAdded getSecurityProvider function so that we can get the provider and potentially do special logic.\nUpdate override variables so that they can come from environment variables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d1b6495dd2a946672795be3ac7cf2ed021f28a", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/f4d1b6495dd2a946672795be3ac7cf2ed021f28a", "committedDate": "2020-09-16T19:42:35Z", "message": "Updated login redirect\n   Added requestCache - taken from ShibbolethPreAuthFilter\n   Updated to use querystring (redirectUrl) value if it exists.\n   If not then default to context root."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f0c0e3fccec86dc9807d04838ec7ad389cae7fa", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/3f0c0e3fccec86dc9807d04838ec7ad389cae7fa", "committedDate": "2020-09-17T12:13:08Z", "message": "Added public-client option to keycloak json so that it is configurable.\nAdded autologin logic and make it the default.\nUpdated keycloak configuration to support autologin - had to add special filter to do the redirect if not logged in.\nFixed bug with missing client id - it would occur when using confidential client and no public client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25fe011b5cc937ef5e35d0d956434a9d6b9f1157", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/25fe011b5cc937ef5e35d0d956434a9d6b9f1157", "committedDate": "2020-09-17T20:51:31Z", "message": "Changed default to autologin\nRemoved hard coded /signin and base it on the pathinfo from the LoginUrlAuthenticationEntryPoint configuration.\nChange logoutSuccessUrl to use context root instead of hard coded /geonetwork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2a0529565511871387b55e51a78db1891ebc86", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/bc2a0529565511871387b55e51a78db1891ebc86", "committedDate": "2020-09-22T13:54:01Z", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into add_keycloak_support\n\n# Conflicts:\n#\tweb/src/main/webapp/WEB-INF/config-security/config-security.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9706be6c516639549aa3c44ad38c529a9b3a6c", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/3c9706be6c516639549aa3c44ad38c529a9b3a6c", "committedDate": "2020-10-21T19:01:12Z", "message": "Apply changes required for client back channel logout via admin url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31eb33deffba922a4ff377cd3cd3cafc9ff3503a", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/31eb33deffba922a4ff377cd3cd3cafc9ff3503a", "committedDate": "2020-10-21T19:04:26Z", "message": "Merge branch 'master' of https://github.com/geonetwork/core-geonetwork into add_keycloak_support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfffef564387293cebc6fe034f9cfecf3459c64d", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/dfffef564387293cebc6fe034f9cfecf3459c64d", "committedDate": "2020-10-21T19:38:38Z", "message": "Removed isSSO function as we really only need to know the type of form for the login\nAlso added missing HttpSessionEventPublisher.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d84d97275df254a3750659ab7ce53b568ac3d300", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/d84d97275df254a3750659ab7ce53b568ac3d300", "committedDate": "2020-10-26T11:17:35Z", "message": "Forgot to commit this change as part of the removal of issso in recent commits.\nThis fixes bug with logintype=link not working."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd70fade630dd9bb9386f5c2d84d76a1a66a8b4", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/ddd70fade630dd9bb9386f5c2d84d76a1a66a8b4", "committedDate": "2020-10-30T19:56:11Z", "message": "Add IDP logout parameter so that it is possible to do a front channel logout to the IDP."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6", "committedDate": "2020-10-30T19:59:06Z", "message": "Merge branch 'add_keycloak_support' of https://github.com/ianwallen/core-geonetwork into add_keycloak_support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMDc0NTcw", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#pullrequestreview-531074570", "createdAt": "2020-11-16T08:28:01Z", "commit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODoyODowMlrOHzsZYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToxNTo0MFrOHzu1PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NjgxNw==", "bodyText": "Add file header", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523966817", "createdAt": "2020-11-16T08:28:02Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.fao.geonet.kernel.security.keycloak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzMyMw==", "bodyText": "Should be used StringUtils.isEmpty or just need to check for null?", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523967323", "createdAt": "2020-11-16T08:28:59Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.fao.geonet.kernel.security.keycloak;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.fao.geonet.utils.Log;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;\n+\n+import javax.annotation.PostConstruct;\n+\n+public class KeycloakUtil {\n+    public static String signinPath = null;\n+    private static LoginUrlAuthenticationEntryPoint loginUrlAuthenticationEntryPoint;\n+\n+    @Autowired\n+    private LoginUrlAuthenticationEntryPoint loginUrlAuthenticationEntryPoint0;\n+\n+    @PostConstruct\n+    private void init () {\n+        loginUrlAuthenticationEntryPoint = this.loginUrlAuthenticationEntryPoint0;\n+    }\n+\n+    public static String getSigninPath() {\n+        if (signinPath == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2NzYyOQ==", "bodyText": "Add file header", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523967629", "createdAt": "2020-11-16T08:29:31Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/keycloakPreAuthActionsLoginFilter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.fao.geonet.kernel.security.keycloak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MjA1Mg==", "bodyText": "Just to confirm this file is really required?", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523972052", "createdAt": "2020-11-16T08:37:23Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/keycloak/KeycloakHttpSessionManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2016 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+// Changes were taken from org.keycloak/keycloak-adapter-core/11.0.1 as there were bugs in current version\n+// that we prevending the Admin URL client backchannel logout from working.\n+// If upgrading maven dependency then it may be possible that the most recent KeycloakHttpSessionManager can be used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzY2MA==", "bodyText": "Just to check this file is required?", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r523973660", "createdAt": "2020-11-16T08:40:16Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/listener/HttpSessionEventPublisher.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package org.fao.geonet.kernel.security.listener;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.security.web.session.HttpSessionCreatedEvent;\n+import org.springframework.security.web.session.HttpSessionDestroyedEvent;\n+import org.springframework.web.context.support.WebApplicationContextUtils;\n+\n+import javax.servlet.ServletContext;\n+import javax.servlet.http.HttpSessionEvent;\n+import javax.servlet.http.HttpSessionListener;\n+\n+/* This is just a copy of the org.springframework.security.web.session.HttpSessionEventPublisher", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNjcxNg==", "bodyText": "Does this configuration affects LDAP or CAS providers?", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#discussion_r524006716", "createdAt": "2020-11-16T09:15:40Z", "author": {"login": "josegar74"}, "path": "core/src/main/java/org/fao/geonet/kernel/security/SecurityProviderConfiguration.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ *  Copyright (C) 2014 GeoSolutions S.A.S.\n+ *  http://www.geo-solutions.it\n+ *\n+ *  GPLv3 + Classpath exception\n+ *\n+ *  This program is free software: you can redistribute it and/or modify\n+ *  it under the terms of the GNU General Public License as published by\n+ *  the Free Software Foundation, either version 3 of the License, or\n+ *  (at your option) any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful,\n+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ *  GNU General Public License for more details.\n+ *\n+ *  You should have received a copy of the GNU General Public License\n+ *  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package org.fao.geonet.kernel.security;\n+\n+import org.fao.geonet.ApplicationContextHolder;\n+import org.fao.geonet.exceptions.BadInputEx;\n+import org.fao.geonet.exceptions.BadParameterEx;\n+\n+import java.util.Map;\n+\n+/**\n+ * Some basic configuration info to be used by all security\n+ *\n+ */\n+public interface SecurityProviderConfiguration {\n+\n+\tpublic enum LoginType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37eeb661f562dab6a0855d4c8e8ed838bfcf7fd6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e99fa6e1cd1d0c3decb1437ebc8f024c5974607f", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/e99fa6e1cd1d0c3decb1437ebc8f024c5974607f", "committedDate": "2020-11-16T12:21:37Z", "message": "Updated documentation and headers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1f26dc86f1b2f28f4c6906ebc7e90e1c60f423", "author": {"user": {"login": "ianwallen", "name": "Ian"}}, "url": "https://github.com/geonetwork/core-geonetwork/commit/5b1f26dc86f1b2f28f4c6906ebc7e90e1c60f423", "committedDate": "2020-11-17T11:57:50Z", "message": "Change default login type to LINK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTA5OTMw", "url": "https://github.com/geonetwork/core-geonetwork/pull/4931#pullrequestreview-532509930", "createdAt": "2020-11-17T15:47:06Z", "commit": {"oid": "5b1f26dc86f1b2f28f4c6906ebc7e90e1c60f423"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1782, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}