{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTU1MDAw", "number": 2024, "title": "fix: Do cleanup after LogWatchCallback finished", "bodyText": "I wrote some code to watch logs from a container in a pod, but found that when the pod was deleted, log inputstream that got from PodOperationsImpl.watchLog().getOutput() didn't close and read would hang forever.\nTo reproduce the issue, following the steps below :\nStep 1. create a simple pod, any image will be ok as long as it can long run and give some output continuously . (Infact, if the pod is not exists, the java code here would hang in the same way)\napiVersion: v1\nkind: Pod\nmetadata:\n  name: t01\n  namespace: test\nspec:\n  containers:\n  - image: any-image\n    name: default\n\n\nStep 2: Run the code\npublic static void main(String[] args) throws IOException {\n        KubernetesClient client = new DefaultKubernetesClient();\n        InputStream in = client.pods()\n                .inNamespace(\"test\")\n                .withName(\"t01\")\n                .inContainer(\"default\")\n                .watchLog()\n                .getOutput();\n\n        byte[] buf = new byte[1024];\n        int len = -1;\n        while ((len = in.read(buf)) > -1) {  // hang here\n            System.out.println(\"read len \" + len);\n        }\n        System.out.println(\"finished\");\n    }\n\nStep 3:  delete the pod kubectl -n test delete pod t01, After the pod is deleted, Java code still hang at the line in.read(buf)\nThe reson is that LogWatchCallback not close the newly created piped stream, It has close and cleanUp methods but nowhere would call that.\nThis fix had been tested.", "createdAt": "2020-02-25T12:34:41Z", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024", "merged": true, "mergeCommit": {"oid": "dea9994655400362aaca94e933086efbcd60029e"}, "closed": true, "closedAt": "2020-02-28T09:06:15Z", "author": {"login": "jzwlqx"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHxabZAFqTM2NDEwNzUxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIa6IPABqjMwNzc3ODc0ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MTA3NTEw", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024#pullrequestreview-364107510", "createdAt": "2020-02-25T12:37:46Z", "commit": {"oid": "6449dc4d4e080a708c1630d6e3d994e08490135e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDM3OTQ2", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024#pullrequestreview-365437946", "createdAt": "2020-02-27T06:23:49Z", "commit": {"oid": "6449dc4d4e080a708c1630d6e3d994e08490135e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoyMzo0OVrOFvGdig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoyMzo0OVrOFvGdig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMzI1OA==", "bodyText": "nit: add a space before finally {", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024#discussion_r384933258", "createdAt": "2020-02-27T06:23:49Z", "author": {"login": "rohanKanojia"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/BlockingInputStreamPumper.java", "diffHunk": "@@ -60,6 +60,8 @@ public void run() {\n           } else {\n             LOGGER.debug(\"Interrupted while pumping stream.\");\n           }\n+        }finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6449dc4d4e080a708c1630d6e3d994e08490135e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDM3OTk1", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024#pullrequestreview-365437995", "createdAt": "2020-02-27T06:23:58Z", "commit": {"oid": "6449dc4d4e080a708c1630d6e3d994e08490135e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6449dc4d4e080a708c1630d6e3d994e08490135e", "author": {"user": {"login": "jzwlqx", "name": "Jizhong Jiang"}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/6449dc4d4e080a708c1630d6e3d994e08490135e", "committedDate": "2020-02-25T11:38:13Z", "message": "fix: Do cleanup after LogWatchCallback finished"}, "afterCommit": {"oid": "3b948d61ccb879c5717b6202d75e80344443483e", "author": {"user": {"login": "jzwlqx", "name": "Jizhong Jiang"}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/3b948d61ccb879c5717b6202d75e80344443483e", "committedDate": "2020-02-27T11:22:12Z", "message": "fix: Do cleanup after LogWatchCallback finished"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjA5NjEz", "url": "https://github.com/fabric8io/kubernetes-client/pull/2024#pullrequestreview-365609613", "createdAt": "2020-02-27T11:33:50Z", "commit": {"oid": "3b948d61ccb879c5717b6202d75e80344443483e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62cb3d69bd5ae5e85a21daf8c4998e57d54c6471", "author": {"user": {"login": "jzwlqx", "name": "Jizhong Jiang"}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/62cb3d69bd5ae5e85a21daf8c4998e57d54c6471", "committedDate": "2020-02-27T12:57:39Z", "message": "fix: Do cleanup after LogWatchCallback finished"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b948d61ccb879c5717b6202d75e80344443483e", "author": {"user": {"login": "jzwlqx", "name": "Jizhong Jiang"}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/3b948d61ccb879c5717b6202d75e80344443483e", "committedDate": "2020-02-27T11:22:12Z", "message": "fix: Do cleanup after LogWatchCallback finished"}, "afterCommit": {"oid": "62cb3d69bd5ae5e85a21daf8c4998e57d54c6471", "author": {"user": {"login": "jzwlqx", "name": "Jizhong Jiang"}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/62cb3d69bd5ae5e85a21daf8c4998e57d54c6471", "committedDate": "2020-02-27T12:57:39Z", "message": "fix: Do cleanup after LogWatchCallback finished"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3495, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}