{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MjM4NDg3", "number": 2501, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MDoyN1rOElqdsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNjowMzoxMFrOE3Eh5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3OTI4NDk5OnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MDoyN1rOHVQh5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MDoyN1rOHVQh5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1Mjk2Ng==", "bodyText": "We can make the application go into an infinite loop in case some server error is permanently (or for a long period) affecting the server.\nMaybe we should add a a MAX_RETRIES limit and check it here too.", "url": "https://github.com/fabric8io/kubernetes-client/pull/2501#discussion_r492052966", "createdAt": "2020-09-21T13:40:27Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -396,19 +397,36 @@ public final T createOrReplace(T... items) {\n       return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n \n-    try {\n-      // Create\n-      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n-      return create(itemToCreateOrReplace);\n-    } catch (KubernetesClientException exception) {\n-      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n-        throw exception;\n+    final CompletableFuture<T> future = new CompletableFuture<>();\n+    while (!future.isDone()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38265b7b132082cf0b63e656efdc958ac7e98ef6"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3OTI5MDU1OnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MTozNlrOHVQlPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0MTozNlrOHVQlPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1MzgyMw==", "bodyText": "I think you mentioned that 503 could also be returned in some cases.\nMaybe better to check for the whole family (5xx) or a list of 5xx statuses. WDYT?", "url": "https://github.com/fabric8io/kubernetes-client/pull/2501#discussion_r492053823", "createdAt": "2020-09-21T13:41:36Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -396,19 +397,36 @@ public final T createOrReplace(T... items) {\n       return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n \n-    try {\n-      // Create\n-      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n-      return create(itemToCreateOrReplace);\n-    } catch (KubernetesClientException exception) {\n-      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n-        throw exception;\n+    final CompletableFuture<T> future = new CompletableFuture<>();\n+    while (!future.isDone()) {\n+      try {\n+        // Create\n+        KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+        future.complete(create(itemToCreateOrReplace));\n+      } catch (KubernetesClientException exception) {\n+        final T itemFromServer;\n+        if (exception.getCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38265b7b132082cf0b63e656efdc958ac7e98ef6"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MDE0NDE2OnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/Utils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMjowOTozN1rOHkLMfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMjowOTozN1rOHkLMfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5NDIwNA==", "bodyText": "Hi, Shall we let this in for now or shall we handle it separately while fixing #2489", "url": "https://github.com/fabric8io/kubernetes-client/pull/2501#discussion_r507694204", "createdAt": "2020-10-19T12:09:37Z", "author": {"login": "rohanKanojia"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/Utils.java", "diffHunk": "@@ -358,6 +358,7 @@ public static String getPluralFromKind(String kind) {\n         break;\n       case \"NetworkPolicy\":\n       case \"PodSecurityPolicy\":\n+      case \"ServiceEntry\": // an Istio resource. Needed as getPluralFromKind is currently not configurable #2489", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38265b7b132082cf0b63e656efdc958ac7e98ef6"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODA0OTcxOnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/Utils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTowMjo0OVrOHvpbWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTowMjo0OVrOHvpbWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcyMzg2NQ==", "bodyText": "Since this is not checking if the HTTP status code belongs to a server error family (code >= 500), and for our use-case we just want to retry if one of these status codes is returned by the server, it's probably a good idea to move the method to CreateOrReplaceHelper class.\nMaybe also rename it to shouldRetry or something like that, which suggests that the procedure is only retried for some specific status codes.", "url": "https://github.com/fabric8io/kubernetes-client/pull/2501#discussion_r519723865", "createdAt": "2020-11-09T11:02:49Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/utils/Utils.java", "diffHunk": "@@ -471,4 +473,11 @@ public static String getSystemPathVariable() {\n   private static String getOperatingSystemFromSystemProperty() {\n     return System.getProperty(OS_NAME);\n   }\n+\n+  public static boolean isHttpStatusCodeFromErrorEncounteredByServer(int code) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57838a0c2cb8ba3be027417963c016d048ef2f47"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTgxMzQ4OnYy", "diffSide": "RIGHT", "path": "kubernetes-itests/src/test/java/io/fabric8/kubernetes/CreateOrReplaceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNjowMzoxMFrOHwM_-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNjowMzoxMFrOHwM_-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMwNjY4MA==", "bodyText": "this belongs to a teardown method.\nIf this test fails, it won't be cleaned up and probably the rest of tests that run after will fail too (if this cleanup is really necessary)", "url": "https://github.com/fabric8io/kubernetes-client/pull/2501#discussion_r520306680", "createdAt": "2020-11-10T06:03:10Z", "author": {"login": "manusa"}, "path": "kubernetes-itests/src/test/java/io/fabric8/kubernetes/CreateOrReplaceIT.java", "diffHunk": "@@ -232,6 +239,98 @@ public void testCreateOrReplaceIngress() {\n     client.network().ingresses().inNamespace(session.getNamespace()).withName(ingress.getMetadata().getName()).delete();\n   }\n \n+  @Test\n+  public void testCreateOrReplaceGenericResource() {\n+    // Given\n+    ConfigMap configMap = new ConfigMapBuilder()\n+      .withNewMetadata().withName(\"resource-cm-1\").endMetadata()\n+      .addToData(\"a1\", \"A1\")\n+      .addToData(\"a2\", \"A2\")\n+      .build();\n+\n+    // When\n+    ConfigMap createdResource = client.resource(configMap).inNamespace(session.getNamespace()).createOrReplace();\n+    configMap.setData(Collections.singletonMap(\"b1\", \"B1\"));\n+    ConfigMap replacedResource = client.resource(configMap).inNamespace(session.getNamespace()).createOrReplace();\n+\n+    // Then\n+    assertNotNull(createdResource);\n+    assertEquals(2, createdResource.getData().size());\n+    assertEquals(\"A1\", createdResource.getData().get(\"a1\"));\n+    assertEquals(\"A2\", createdResource.getData().get(\"a2\"));\n+    assertNotNull(replacedResource);\n+    assertEquals(1, replacedResource.getData().size());\n+    assertEquals(\"B1\", replacedResource.getData().get(\"b1\"));\n+    // Cleanup\n+    client.resource(configMap).inNamespace(session.getNamespace()).delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd4be1b13816e6cdeb13abbe27e24d70da5ab3c"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3701, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}