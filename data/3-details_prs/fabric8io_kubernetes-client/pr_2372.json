{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzM2NjY2", "number": 2372, "title": "Fix #2292: Update BaseOperation#createOrReplace()", "bodyText": "Description\n\nFix #2292\n\nUpdated BaseOperation#createOrReplace to fallback to replace() after doing create() rather than get() -> replace()\nUpdated ResourceCompare#equals() to only compare entities present in provided resource when compared with\nresource from cluster.\n\nType of change\n\n\n Bug fix (non-breaking change which fixes an issue)\n Feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to change\n Chore (non-breaking change which doesn't affect codebase;\ntest, version modification, documentation, etc.)\n\nChecklist\n\n Code contributed by me aligns with current project license: Apache 2.0\n I Added CHANGELOG entry regarding this change\n I have implemented unit tests to cover my changes\n I have added/updated the javadocs and other documentation accordingly\n No new bugs, code smells, etc. in SonarCloud report\n I tested my code in Kubernetes\n I tested my code in OpenShift", "createdAt": "2020-07-27T18:44:21Z", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372", "merged": true, "mergeCommit": {"oid": "14cae945ee20ce1ac980d492e53d388aa93eb371"}, "closed": true, "closedAt": "2020-07-31T08:41:02Z", "author": {"login": "rohanKanojia"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5GdCpgFqTQ1NjA0Njk0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6OvqKgBqjM2MDcxNzE4OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDQ2OTQ3", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-456046947", "createdAt": "2020-07-27T18:50:55Z", "commit": {"oid": "b67dbb57193346c1a4675ea29f4088623a4beed2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b67dbb57193346c1a4675ea29f4088623a4beed2", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/b67dbb57193346c1a4675ea29f4088623a4beed2", "committedDate": "2020-07-27T18:40:19Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}, "afterCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/0005c580b90b1027bb7b3cd4f456e3615fe26e86", "committedDate": "2020-07-27T19:43:05Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjM4MjAx", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-456638201", "createdAt": "2020-07-28T13:37:19Z", "commit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozNzoxOVrOG4M8XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozNzoxOVrOG4M8XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NTUwMQ==", "bodyText": "I'm guessing this recurses into this function", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461585501", "createdAt": "2020-07-28T13:37:19Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjQwMDcx", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-456640071", "createdAt": "2020-07-28T13:39:21Z", "commit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozOToyMVrOG4NCEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozOToyMVrOG4NCEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4Njk2Mg==", "bodyText": "Are we sure we want to reuse the resourceVersion retrieved in line 416? Or maybe use the one of the latest version retrieved from the server (427)?", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461586962", "createdAt": "2020-07-28T13:39:21Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n-    if (fromServer().get() == null) {\n-      return create(item);\n-    } else {\n-      return replace(item);\n+\n+    String resourceVersion = KubernetesResourceUtil.getResourceVersion(itemToCreateOrReplace);\n+    try {\n+      // Create\n+      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+      return create(itemToCreateOrReplace);\n+    } catch (KubernetesClientException exception) {\n+      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n+        throw exception;\n+      }\n+\n+      // Conflict; Do Replace\n+      T itemFromServer = fromServer().get();\n+      if (ResourceCompare.equals(itemFromServer, itemToCreateOrReplace)) {\n+        // Nothing changed, ignore\n+        return itemToCreateOrReplace;\n+      } else {\n+        KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, resourceVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjQyMTM4", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-456642138", "createdAt": "2020-07-28T13:41:32Z", "commit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0MTozMlrOG4NIdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0MTozMlrOG4NIdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4ODU5OQ==", "bodyText": "Will a PUT in the server of the same resource update its resource version (propagate event to watchers, etc.)? if so, maybe this is something expected from users invoking this function. WDYT?", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461588599", "createdAt": "2020-07-28T13:41:32Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n-    if (fromServer().get() == null) {\n-      return create(item);\n-    } else {\n-      return replace(item);\n+\n+    String resourceVersion = KubernetesResourceUtil.getResourceVersion(itemToCreateOrReplace);\n+    try {\n+      // Create\n+      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+      return create(itemToCreateOrReplace);\n+    } catch (KubernetesClientException exception) {\n+      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n+        throw exception;\n+      }\n+\n+      // Conflict; Do Replace\n+      T itemFromServer = fromServer().get();\n+      if (ResourceCompare.equals(itemFromServer, itemToCreateOrReplace)) {\n+        // Nothing changed, ignore\n+        return itemToCreateOrReplace;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjUwMTIz", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-456650123", "createdAt": "2020-07-28T13:49:51Z", "commit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0OTo1MVrOG4Ngkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0OTo1MVrOG4Ngkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU5NDc3MA==", "bodyText": "You are getting sonar issues here. In order to make sure exception is thrown in the right place:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThrows(KubernetesClientException.class, () -> client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build()).createOrReplace());\n          \n          \n            \n                Pod pod = client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build());\n          \n          \n            \n                // When\n          \n          \n            \n                assertThrows(KubernetesClientException.class, () -> pod.createOrReplace());\n          \n      \n    \n    \n  \n\nSame for the rest of warnings.", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461594770", "createdAt": "2020-07-28T13:49:51Z", "author": {"login": "manusa"}, "path": "kubernetes-tests/src/test/java/io/fabric8/kubernetes/client/mock/CreateOrReplaceResourceTest.java", "diffHunk": "@@ -70,10 +75,21 @@ public void testResourceCreate() throws Exception {\n   }\n \n   @Test\n-  public void testCreate() throws Exception {\n-    server.expect().get().withPath(\"/api/v1/namespaces/test/pods/pod123\").andReturn(404, new StatusBuilder().build()).always();\n+  @DisplayName(\"Should throw Exception on failed create\")\n+  void testResourceCreateFailure() {\n+    // Given\n+    server.expect().post().withPath(\"/api/v1/namespaces/test/pods\").andReturn(HttpURLConnection.HTTP_BAD_REQUEST, new PodBuilder()\n+      .withNewMetadata().withResourceVersion(\"12345\").endMetadata().build()).once();\n+    KubernetesClient client = server.getClient();\n \n-    server.expect().post().withPath(\"/api/v1/namespaces/test/pods\").andReturn(201, new PodBuilder()\n+    // When\n+    assertThrows(KubernetesClientException.class, () -> client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build()).createOrReplace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/0005c580b90b1027bb7b3cd4f456e3615fe26e86", "committedDate": "2020-07-27T19:43:05Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}, "afterCommit": {"oid": "ae070516ccd429c23b52bddc6b67981c50acd0ba", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/ae070516ccd429c23b52bddc6b67981c50acd0ba", "committedDate": "2020-07-29T07:16:19Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjEzNzMx", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#pullrequestreview-457613731", "createdAt": "2020-07-29T15:02:56Z", "commit": {"oid": "ae070516ccd429c23b52bddc6b67981c50acd0ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2652139fd7b293a42b3b02d38f130bb2b5b4caf2", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/2652139fd7b293a42b3b02d38f130bb2b5b4caf2", "committedDate": "2020-07-31T07:04:08Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae070516ccd429c23b52bddc6b67981c50acd0ba", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/ae070516ccd429c23b52bddc6b67981c50acd0ba", "committedDate": "2020-07-29T07:16:19Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}, "afterCommit": {"oid": "2652139fd7b293a42b3b02d38f130bb2b5b4caf2", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/fabric8io/kubernetes-client/commit/2652139fd7b293a42b3b02d38f130bb2b5b4caf2", "committedDate": "2020-07-31T07:04:08Z", "message": "Fix #2292: Update BaseOperation#createOrReplace()"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3721, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}