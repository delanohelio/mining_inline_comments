{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzM2NjY2", "number": 2372, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozNzoxOVrOES0LCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0OTo1MVrOES0htg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTY0NjE4OnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozNzoxOVrOG4M8XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0MDo1MFrOG4NGag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NTUwMQ==", "bodyText": "I'm guessing this recurses into this function", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461585501", "createdAt": "2020-07-28T13:37:19Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4ODA3NA==", "bodyText": "Yes, I think previously also it was like this.", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461588074", "createdAt": "2020-07-28T13:40:50Z", "author": {"login": "rohanKanojia"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4NTUwMQ=="}, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTY1NTExOnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozOToyMVrOG4NCEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzozOToyMVrOG4NCEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4Njk2Mg==", "bodyText": "Are we sure we want to reuse the resourceVersion retrieved in line 416? Or maybe use the one of the latest version retrieved from the server (427)?", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461586962", "createdAt": "2020-07-28T13:39:21Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n-    if (fromServer().get() == null) {\n-      return create(item);\n-    } else {\n-      return replace(item);\n+\n+    String resourceVersion = KubernetesResourceUtil.getResourceVersion(itemToCreateOrReplace);\n+    try {\n+      // Create\n+      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+      return create(itemToCreateOrReplace);\n+    } catch (KubernetesClientException exception) {\n+      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n+        throw exception;\n+      }\n+\n+      // Conflict; Do Replace\n+      T itemFromServer = fromServer().get();\n+      if (ResourceCompare.equals(itemFromServer, itemToCreateOrReplace)) {\n+        // Nothing changed, ignore\n+        return itemToCreateOrReplace;\n+      } else {\n+        KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, resourceVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTY2NTE4OnYy", "diffSide": "RIGHT", "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0MTozMlrOG4NIdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzoxNTo1OVrOG4roWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4ODU5OQ==", "bodyText": "Will a PUT in the server of the same resource update its resource version (propagate event to watchers, etc.)? if so, maybe this is something expected from users invoking this function. WDYT?", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461588599", "createdAt": "2020-07-28T13:41:32Z", "author": {"login": "manusa"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n-    if (fromServer().get() == null) {\n-      return create(item);\n-    } else {\n-      return replace(item);\n+\n+    String resourceVersion = KubernetesResourceUtil.getResourceVersion(itemToCreateOrReplace);\n+    try {\n+      // Create\n+      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+      return create(itemToCreateOrReplace);\n+    } catch (KubernetesClientException exception) {\n+      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n+        throw exception;\n+      }\n+\n+      // Conflict; Do Replace\n+      T itemFromServer = fromServer().get();\n+      if (ResourceCompare.equals(itemFromServer, itemToCreateOrReplace)) {\n+        // Nothing changed, ignore\n+        return itemToCreateOrReplace;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4ODI4MQ==", "bodyText": "I checked and doing a PUT with same resource doesn't change resource version or add any event to watcher", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r462088281", "createdAt": "2020-07-29T07:15:59Z", "author": {"login": "rohanKanojia"}, "path": "kubernetes-client/src/main/java/io/fabric8/kubernetes/client/dsl/base/BaseOperation.java", "diffHunk": "@@ -395,24 +397,41 @@ public D createOrReplaceWithNew() throws KubernetesClientException {\n \n   @Override\n   public T createOrReplace(T... items) {\n-    T item = getItem();\n+    T itemToCreateOrReplace = getItem();\n     if (items.length > 1) {\n       throw new IllegalArgumentException(\"Too many items to create.\");\n     } else if (items.length == 1) {\n-      item = items[0];\n+      itemToCreateOrReplace = items[0];\n     }\n \n-    if (item == null) {\n+    if (itemToCreateOrReplace == null) {\n       throw new IllegalArgumentException(\"Nothing to create.\");\n     }\n \n-    if (Utils.isNullOrEmpty(name) && item instanceof HasMetadata) {\n-      return withName(((HasMetadata)item).getMetadata().getName()).createOrReplace(item);\n+    if (Utils.isNullOrEmpty(name)) {\n+\n+      return withName(itemToCreateOrReplace.getMetadata().getName()).createOrReplace(itemToCreateOrReplace);\n     }\n-    if (fromServer().get() == null) {\n-      return create(item);\n-    } else {\n-      return replace(item);\n+\n+    String resourceVersion = KubernetesResourceUtil.getResourceVersion(itemToCreateOrReplace);\n+    try {\n+      // Create\n+      KubernetesResourceUtil.setResourceVersion(itemToCreateOrReplace, null);\n+      return create(itemToCreateOrReplace);\n+    } catch (KubernetesClientException exception) {\n+      if (exception.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n+        throw exception;\n+      }\n+\n+      // Conflict; Do Replace\n+      T itemFromServer = fromServer().get();\n+      if (ResourceCompare.equals(itemFromServer, itemToCreateOrReplace)) {\n+        // Nothing changed, ignore\n+        return itemToCreateOrReplace;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU4ODU5OQ=="}, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTcwNDIyOnYy", "diffSide": "RIGHT", "path": "kubernetes-tests/src/test/java/io/fabric8/kubernetes/client/mock/CreateOrReplaceResourceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0OTo1MVrOG4Ngkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMzo0OTo1MVrOG4Ngkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU5NDc3MA==", "bodyText": "You are getting sonar issues here. In order to make sure exception is thrown in the right place:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThrows(KubernetesClientException.class, () -> client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build()).createOrReplace());\n          \n          \n            \n                Pod pod = client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build());\n          \n          \n            \n                // When\n          \n          \n            \n                assertThrows(KubernetesClientException.class, () -> pod.createOrReplace());\n          \n      \n    \n    \n  \n\nSame for the rest of warnings.", "url": "https://github.com/fabric8io/kubernetes-client/pull/2372#discussion_r461594770", "createdAt": "2020-07-28T13:49:51Z", "author": {"login": "manusa"}, "path": "kubernetes-tests/src/test/java/io/fabric8/kubernetes/client/mock/CreateOrReplaceResourceTest.java", "diffHunk": "@@ -70,10 +75,21 @@ public void testResourceCreate() throws Exception {\n   }\n \n   @Test\n-  public void testCreate() throws Exception {\n-    server.expect().get().withPath(\"/api/v1/namespaces/test/pods/pod123\").andReturn(404, new StatusBuilder().build()).always();\n+  @DisplayName(\"Should throw Exception on failed create\")\n+  void testResourceCreateFailure() {\n+    // Given\n+    server.expect().post().withPath(\"/api/v1/namespaces/test/pods\").andReturn(HttpURLConnection.HTTP_BAD_REQUEST, new PodBuilder()\n+      .withNewMetadata().withResourceVersion(\"12345\").endMetadata().build()).once();\n+    KubernetesClient client = server.getClient();\n \n-    server.expect().post().withPath(\"/api/v1/namespaces/test/pods\").andReturn(201, new PodBuilder()\n+    // When\n+    assertThrows(KubernetesClientException.class, () -> client.resource(new PodBuilder().withNewMetadata().withName(\"pod123\").endMetadata().build()).createOrReplace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0005c580b90b1027bb7b3cd4f456e3615fe26e86"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3760, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}