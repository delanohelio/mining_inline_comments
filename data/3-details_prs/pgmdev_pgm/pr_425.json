{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MDY5NDg0", "number": 425, "title": "Introduce non-dynamic map pools", "bodyText": "Map Pool Improvements \ud83d\uddfa\ufe0f\nChanges to map pools, including a command to set specific map pools and the introduction of non-dynamic pools.\nNon-Dynamic Pools\nRunning events can be difficult atm due to map pools dynamically adjusting to accommodate player counts. The solution is to introduce non-dynamic pools. When a non-dynamic pool is set, PGM will not adapt to different player counts as long as a staff member is online (this can be disabled via config if desired) and the non-dynamic pool is set. If the match ends and no staff are online, it will revert to an appropriate dynamic pool or this can be done manually.\nChanges to map-pools.yml:\nThe major change that has been made to the map-pool file is the addition of a dynamic: field. By default no changes are required for current servers, as all map-pools will be set as dynamic unless specified false. The following config would be used if for example an all-blitz map pool was desired:\npools:\n  blitz:\n    type: ordered\n    enabled: true\n    dynamic: false\n    players: 1\n    maps: ...\nWhen dynamic is set to false. This pool will never be set automatically by player counts, so players: is irrelevant.\nIf a staff member wants this pool to be set, they would simply execute /setpool blitz\nAlso added is a new event, MapPoolAdjustEvent which is called whenever the map pool is switched (both dynamically and non, including a isForced to determine if it was set by command). I'm hoping this will allow other plugins to listen for the event in order to add cool features, for example broadcasting a special message when a specific map pool is loaded.\nOther Changes\n\nAdd a random option to map pools\n\nWhen type: random is set in the map-pools.yml, it will follow a rotation style but at complete random.\n\n\nAdd a staff broadcast to /setnext\nAdjust /pools format to include # of maps (non-dynamic pools do not show player counts)\nFix so blitz maps don't bug dynamic pools (instead of counting obs at 0.5, upped to 0.85 for blitz. Thanks @Pablete1234 )\nRenamed a method from ModerationCommands to better fit its purpose.\n\nScreenshots\nAdditional information shown under /pools includes the map count per pool. Also non-dynamic pools can be identified by not having a players field.\n\nWhen /setpool <pool> is used, a useful message will be broadcast to inform staff.\n\nSimilar to the previous screenshot, now staff will be alerted when a map is /setnext\n\nFeedback\nAfter performing testing for a few days, I've yet to find any major problems so everything should be good \ud83d\udc4d\nAs always I am open to feedback of any kind and will make changes where needed.\nOnly design question I had:\n\nWas it a good idea to add the map-pools.require-staff to config, or was that unnecessary?\n\nSigned-off-by: applenick applenick@users.noreply.github.com", "createdAt": "2020-04-22T06:11:27Z", "url": "https://github.com/PGMDev/PGM/pull/425", "merged": true, "mergeCommit": {"oid": "809a95547e56fc2c7007b57e8213bc382d5a0ad3"}, "closed": true, "closedAt": "2020-04-26T19:22:20Z", "author": {"login": "applenick"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaCA5PAH2gAyNDA3MDY5NDg0OjM5OTFiYTc3ODIwZDhiMjZiODUzMjQzMWM2ZTZkNGNmY2I1YzM2OWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbfq4eAH2gAyNDA3MDY5NDg0OjMzODIzZjc0OGRhNGFjMzUwMzc1Y2QyZjNmOTc3NTdlMWY4YjAxNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3991ba77820d8b26b8532431c6e6d4cfcb5c369d", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/3991ba77820d8b26b8532431c6e6d4cfcb5c369d", "committedDate": "2020-04-22T06:08:54Z", "message": "Introduce non-dynamic map pools\n* /setpool command and new random order option for map pools\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/fac796da30411477a8bf3758efcfdf69d80a2728", "committedDate": "2020-04-22T07:03:47Z", "message": "Update random -> shuffled\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MjYyNzg0", "url": "https://github.com/PGMDev/PGM/pull/425#pullrequestreview-398262784", "createdAt": "2020-04-22T14:41:18Z", "commit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNDo0MToxOVrOGJ6Jew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNDo0MToxOVrOGJ6Jew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0MzA2Nw==", "bodyText": "Not sure this event is necessary. Since you're just printing to chat, I would skip the event and just print.", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413043067", "createdAt": "2020-04-22T14:41:19Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/events/MapPoolAdjustEvent.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tc.oc.pgm.events;\n+\n+import javax.annotation.Nullable;\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.event.Event;\n+import org.bukkit.event.HandlerList;\n+import tc.oc.pgm.api.match.Match;\n+import tc.oc.pgm.rotation.MapPool;\n+\n+/** MapPoolAdjustEvent is called when the active {@link MapPool} is set to another * */\n+public class MapPoolAdjustEvent extends Event {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjI5OTg2", "url": "https://github.com/PGMDev/PGM/pull/425#pullrequestreview-398629986", "createdAt": "2020-04-22T22:18:53Z", "commit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjoxODo1M1rOGKOLXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjozMDo0M1rOGKOg2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MTIzMQ==", "bodyText": "Based on the wording in #326 i do not think PGM should depend on the community module being present.", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413371231", "createdAt": "2020-04-22T22:18:53Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/commands/AdminCommands.java", "diffHunk": "@@ -12,23 +12,30 @@\n import javax.annotation.Nullable;\n import net.kyori.text.TranslatableComponent;\n import net.kyori.text.format.TextColor;\n-import org.bukkit.ChatColor;\n+import net.md_5.bungee.api.ChatColor;\n import org.bukkit.command.CommandSender;\n import tc.oc.pgm.api.PGM;\n import tc.oc.pgm.api.Permissions;\n import tc.oc.pgm.api.map.MapInfo;\n import tc.oc.pgm.api.map.MapOrder;\n import tc.oc.pgm.api.match.Match;\n-import tc.oc.pgm.api.match.MatchManager;\n import tc.oc.pgm.api.party.Competitor;\n+import tc.oc.pgm.community.commands.ModerationCommands;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MjExMw==", "bodyText": "Im guessing this will be displayed if someone does /setpool -r and there is no dynamic pools present? I think there should be a more intuitive response if so (e.g \"No dynamic pools loaded\")\nThis could maybe be located in getAppropriateDynamicPool?", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413372113", "createdAt": "2020-04-22T22:20:35Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/commands/AdminCommands.java", "diffHunk": "@@ -115,13 +124,61 @@ public static void setNext(\n                   .translate(\"command.admin.cancelRestart.restartUnqueued\", sender));\n     }\n \n-    sender.sendMessage(\n-        ChatColor.DARK_PURPLE\n-            + AllTranslations.get()\n-                .translate(\n-                    \"command.admin.set.success\",\n-                    sender,\n-                    ChatColor.GOLD + map.getName() + ChatColor.DARK_PURPLE));\n+    Component mapName = new PersonalizedText(map.getName()).color(ChatColor.DARK_PURPLE);\n+    Component successful =\n+        new PersonalizedTranslatable(\n+                \"command.admin.set.success\",\n+                ModerationCommands.formatStaffName(sender, match),\n+                mapName)\n+            .getPersonalizedText()\n+            .color(ChatColor.GRAY);\n+    ChatDispatcher.broadcastAdminChatMessage(successful, match);\n+  }\n+\n+  @Command(\n+      aliases = {\"setpool\", \"setrot\"},\n+      desc = \"Set a custom map pool or revert to dynamic\",\n+      usage = \"[pool name] -r (revert to dynamic)\",\n+      flags = \"r\",\n+      perms = Permissions.SETNEXT)\n+  public static void setPool(\n+      CommandSender sender,\n+      Match match,\n+      MapOrder mapOrder,\n+      @Nullable String poolName,\n+      @Switch('r') boolean reset)\n+      throws CommandException {\n+    if (!match.getCountdown().getAll(CycleCountdown.class).isEmpty()) {\n+      sender.sendMessage(\n+          new PersonalizedTranslatable(\"command.admin.setPool.activeCycle\")\n+              .getPersonalizedText()\n+              .color(ChatColor.RED));\n+      return;\n+    }\n+    MapPoolManager mapPoolManager = MapPoolCommands.getMapPoolManager(sender, mapOrder);\n+    MapPool newPool =\n+        reset\n+            ? mapPoolManager.getAppropriateDynamicPool(match).orElse(null)\n+            : mapPoolManager.getMapPoolByName(poolName);\n+\n+    if (newPool == null) {\n+      Component noPoolError =\n+          new PersonalizedTranslatable(\"command.pools.noPoolMatch\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3NjczMA==", "bodyText": "What about *0.5 so it stays consistent with the line above?", "url": "https://github.com/PGMDev/PGM/pull/425#discussion_r413376730", "createdAt": "2020-04-22T22:30:43Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/rotation/MapPoolManager.java", "diffHunk": "@@ -170,15 +172,30 @@ public void setNextMap(MapInfo map) {\n     activeMapPool.setNextMap(map); // Notify pool a next map has been set\n   }\n \n-  @Override\n-  public void matchEnded(Match match) {\n-    int activePlayers = match.getPlayers().size() - (match.getObservers().size() / 2);\n-\n-    mapPools.stream()\n+  public Optional<MapPool> getAppropriateDynamicPool(Match match) {\n+    int obs =\n+        match.getModule(BlitzMatchModule.class) != null\n+            ? (int) (match.getObservers().size() * 0.85)\n+            : (match.getObservers().size() / 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac796da30411477a8bf3758efcfdf69d80a2728"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc", "committedDate": "2020-04-23T07:06:10Z", "message": "Add timelimit flag to /setpool\n* Also clean up various things\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTM5MjE0", "url": "https://github.com/PGMDev/PGM/pull/425#pullrequestreview-400539214", "createdAt": "2020-04-26T19:15:51Z", "commit": {"oid": "0837db3cf78b1f306e6a9a7dd9fdbe53c950dbcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33823f748da4ac350375cd2f3f97757e1f8b0154", "author": {"user": {"login": "Electroid", "name": "Ashcon Partovi"}}, "url": "https://github.com/PGMDev/PGM/commit/33823f748da4ac350375cd2f3f97757e1f8b0154", "committedDate": "2020-04-26T19:15:56Z", "message": "Merge branch 'master' into non-dynamic-pools"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 478, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}