{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MzE5MzEz", "number": 681, "title": "Cleanup player components & name decorations", "bodyText": "This is mainly a refactor of the player component.\nSimplifies the many different methods for rendering into a single method, also prefix components now appear everywhere instead of specifically chat messages and join/leave messages.\nIt also flattens the path to viewer-dependant name rendering", "createdAt": "2020-10-17T17:34:34Z", "url": "https://github.com/PGMDev/PGM/pull/681", "merged": true, "mergeCommit": {"oid": "7fdc210c34e1675e79d02bb18d834fc29323de92"}, "closed": true, "closedAt": "2020-10-26T18:48:03Z", "author": {"login": "Pablete1234"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTeauEAH2gAyNTA1MzE5MzEzOjgwNTI0YWIxNmQ0ODY5ZmU2OTRlMjg5NTJhZTc0ZGYwMWMzNjM5MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWY8ndAFqTUxNzA3ODI3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80524ab16d4869fe694e28952ae74df01c363910", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/80524ab16d4869fe694e28952ae74df01c363910", "committedDate": "2020-10-17T17:28:08Z", "message": "Cleanup player components & name decorations\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDA0NTU3", "url": "https://github.com/PGMDev/PGM/pull/681#pullrequestreview-511004557", "createdAt": "2020-10-17T18:04:04Z", "commit": {"oid": "80524ab16d4869fe694e28952ae74df01c363910"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDE2NjUw", "url": "https://github.com/PGMDev/PGM/pull/681#pullrequestreview-511016650", "createdAt": "2020-10-17T21:33:56Z", "commit": {"oid": "80524ab16d4869fe694e28952ae74df01c363910"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QyMTozMzo1NlrOHjf_gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QyMTozMzo1NlrOHjf_gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjM3MA==", "bodyText": "player ? :)", "url": "https://github.com/PGMDev/PGM/pull/681#discussion_r506986370", "createdAt": "2020-10-17T21:33:56Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/namedecorations/NameDecorationRegistryImpl.java", "diffHunk": "@@ -1,98 +1,148 @@\n package tc.oc.pgm.namedecorations;\n \n import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n import net.kyori.text.Component;\n import net.kyori.text.TextComponent;\n import net.kyori.text.format.TextColor;\n-import net.md_5.bungee.api.ChatColor;\n import org.bukkit.Bukkit;\n+import org.bukkit.ChatColor;\n import org.bukkit.entity.Player;\n import org.bukkit.event.EventHandler;\n+import org.bukkit.event.EventPriority;\n import org.bukkit.event.Listener;\n+import org.bukkit.event.player.PlayerJoinEvent;\n+import org.bukkit.metadata.FixedMetadataValue;\n+import org.bukkit.metadata.MetadataValue;\n import tc.oc.pgm.api.PGM;\n import tc.oc.pgm.api.event.NameDecorationChangeEvent;\n import tc.oc.pgm.api.party.Party;\n import tc.oc.pgm.api.player.MatchPlayer;\n import tc.oc.pgm.events.PlayerJoinMatchEvent;\n import tc.oc.pgm.events.PlayerPartyChangeEvent;\n+import tc.oc.pgm.util.named.NameDecorationProvider;\n import tc.oc.pgm.util.text.TextFormatter;\n+import tc.oc.pgm.util.text.types.PlayerComponent;\n \n+@SuppressWarnings(\"UnstableApiUsage\")\n public class NameDecorationRegistryImpl implements NameDecorationRegistry, Listener {\n \n+  private final MetadataValue METADATA_VALUE = new FixedMetadataValue(PGM.get(), this);\n+\n   private NameDecorationProvider provider;\n+  private final LoadingCache<UUID, DecorationCacheEntry> decorationCache =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.HOURS)\n+          .build(new CacheLoader<UUID, DecorationCacheEntry>() {\n+            @Override\n+            public DecorationCacheEntry load(@Nonnull UUID uuid) {\n+              return new DecorationCacheEntry(uuid);\n+            }\n+          });\n \n   public NameDecorationRegistryImpl(@Nullable NameDecorationProvider provider) {\n-    this.provider = provider;\n+    setProvider(provider);\n+  }\n+\n+  @EventHandler(priority = EventPriority.LOW)\n+  public void onPlayerJoin(PlayerJoinEvent e) {\n+    e.getPlayer().setMetadata(METADATA_KEY, METADATA_VALUE);\n   }\n \n   @EventHandler\n   public void onJoinMatch(PlayerJoinMatchEvent event) {\n     Player player = event.getPlayer().getBukkit();\n-    player.setDisplayName(getDecoratedName(player, event.getNewParty()));\n+    Party party = event.getNewParty();\n+    player.setDisplayName(getDecoratedName(player, party == null ? null : party.getColor()));\n   }\n \n   @EventHandler\n   public void onPartyChange(PlayerPartyChangeEvent event) {\n     Player player = event.getPlayer().getBukkit();\n-    player.setDisplayName(getDecoratedName(player, event.getNewParty()));\n+    Party party = event.getNewParty();\n+    player.setDisplayName(getDecoratedName(player, party == null ? null : party.getColor()));\n   }\n \n   @EventHandler\n   public void onNameDecorationChange(NameDecorationChangeEvent event) {\n     if (event.getUUID() == null) return;\n+    decorationCache.invalidate(event.getUUID());\n \n     final Player player = Bukkit.getPlayer(event.getUUID());\n     final MatchPlayer matchPlayer = PGM.get().getMatchManager().getPlayer(player);\n     if (matchPlayer == null) return;\n \n-    matchPlayer.getBukkit().setDisplayName(getDecoratedName(player, matchPlayer.getParty()));\n+    matchPlayer.getBukkit().setDisplayName(getDecoratedName(player, matchPlayer.getParty().getColor()));\n   }\n \n   @Override\n-  public String getDecoratedName(Player player, Party party) {\n+  public String getDecoratedName(Player player, ChatColor partyColor) {\n     return getPrefix(player.getUniqueId())\n-        + (party == null ? ChatColor.RESET : party.getColor())\n+        + (partyColor == null ? ChatColor.RESET : partyColor)\n         + player.getName()\n         + getSuffix(player.getUniqueId())\n         + ChatColor.WHITE;\n   }\n \n   @Override\n-  public Component getDecoratedNameComponent(Player player, Party party) {\n+  public Component getDecoratedNameComponent(Player player, ChatColor partyColor) {\n     return TextComponent.builder()\n         .append(getPrefixComponent(player.getUniqueId()))\n         .append(\n             player.getName(),\n-            party == null ? TextColor.WHITE : TextFormatter.convert(party.getColor()))\n+            partyColor == null ? TextColor.WHITE : TextFormatter.convert(partyColor))\n         .append(getSuffixComponent(player.getUniqueId()))\n         .build();\n   }\n \n   public String getPrefix(UUID uuid) {\n-    return provider != null ? provider.getPrefix(uuid) : \"\";\n+    return decorationCache.getUnchecked(uuid).prefix;\n   }\n \n   public String getSuffix(UUID uuid) {\n-    return provider != null ? provider.getSuffix(uuid) : \"\";\n+    return decorationCache.getUnchecked(uuid).suffix;\n+  }\n+\n+  public TextColor getColor(UUID uuid) {\n+    MatchPlayer pl = PGM.get().getMatchManager().getPlayer(uuid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80524ab16d4869fe694e28952ae74df01c363910"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "committedDate": "2020-10-17T23:46:06Z", "message": "Comply with formatter, and minor changes\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83a21ba2fa3375c695991a7ac1fbdbbd6b654d2e", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/83a21ba2fa3375c695991a7ac1fbdbbd6b654d2e", "committedDate": "2020-10-17T23:38:14Z", "message": "Comply with formatter, and minor changes"}, "afterCommit": {"oid": "0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "committedDate": "2020-10-17T23:46:06Z", "message": "Comply with formatter, and minor changes\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjEzNzkw", "url": "https://github.com/PGMDev/PGM/pull/681#pullrequestreview-513213790", "createdAt": "2020-10-20T23:51:37Z", "commit": {"oid": "0a7bd871be0c8f00047a8ac176fe1a8b037f2755"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17d1cd885e95ae9e64de3d9daa4696cb8229696c", "author": {"user": {"login": "Electroid", "name": "Ashcon Partovi"}}, "url": "https://github.com/PGMDev/PGM/commit/17d1cd885e95ae9e64de3d9daa4696cb8229696c", "committedDate": "2020-10-20T23:51:54Z", "message": "Merge branch 'dev' into player-component-cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de8930b7bf5d2ec7fb9174a24fd9aaea987bb934", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/de8930b7bf5d2ec7fb9174a24fd9aaea987bb934", "committedDate": "2020-10-25T23:02:28Z", "message": "Merge branch 'dev' into player-component-cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDc4Mjcy", "url": "https://github.com/PGMDev/PGM/pull/681#pullrequestreview-517078272", "createdAt": "2020-10-26T18:47:30Z", "commit": {"oid": "de8930b7bf5d2ec7fb9174a24fd9aaea987bb934"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 335, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}