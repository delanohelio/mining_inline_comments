{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NDYzMzQ4", "number": 245, "title": "Add soft dependency on ViaVersion", "bodyText": "Signed-off-by: Meeples10 8867705+Meeples10@users.noreply.github.com\nIf a ViaVersion is installed on the server, the usual way of getting a player's client protocol version always returns 47. This change would allow an external plugin to set the player's protocol version to the correct value by retrieving it from ViaVersion (see \u00a7Get the players protocol version in the ViaVersion docs), which in turn would allow PGM to behave differently for 1.7, 1.8, 1.15, etc. players. This could be used to fix #16.", "createdAt": "2020-01-18T20:42:21Z", "url": "https://github.com/PGMDev/PGM/pull/245", "merged": true, "mergeCommit": {"oid": "5c4971768646c46f8ba46252cb404ee72a0cdd15"}, "closed": true, "closedAt": "2020-01-27T05:48:25Z", "author": {"login": "Meeples10"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7pcUZAH2gAyMzY0NDYzMzQ4OjcxYjQ2ZjVmOTExZTNkMmJlMWRmZmY5MzcyNWIzNDFhM2I2MGM3ZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-TatMAH2gAyMzY0NDYzMzQ4OjA4MmEwZTBmMmUyZGNiN2ZmYzQyNWI0ZjJjOTA1NDc1NjVlNDU1MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "71b46f5f911e3d2be1dfff93725b341a3b60c7ff", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/71b46f5f911e3d2be1dfff93725b341a3b60c7ff", "committedDate": "2020-01-18T20:33:30Z", "message": "Add a field in MatchPlayer for the client's protocol version\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTYzNzk1", "url": "https://github.com/PGMDev/PGM/pull/245#pullrequestreview-344963795", "createdAt": "2020-01-18T21:35:40Z", "commit": {"oid": "71b46f5f911e3d2be1dfff93725b341a3b60c7ff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQyMTozNTo0MFrOFfML5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQyMTozNTo0MFrOFfML5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTgzMA==", "bodyText": "Put this in nmshacks", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368249830", "createdAt": "2020-01-18T21:35:40Z", "author": {"login": "Pablete1234"}, "path": "src/main/java/tc/oc/pgm/match/MatchPlayerImpl.java", "diffHunk": "@@ -75,6 +78,9 @@ public MatchPlayerImpl(Match match, Player player) {\n     this.frozen = new AtomicBoolean(false);\n     this.dead = new AtomicBoolean(false);\n     this.visible = new AtomicBoolean(false);\n+    this.protocolVersion =\n+        new AtomicInteger(\n+            ((CraftPlayer) player).getHandle().playerConnection.networkManager.protocolVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71b46f5f911e3d2be1dfff93725b341a3b60c7ff"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca620b278d9399266f2dccd5199003eb2ecdc11d", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/ca620b278d9399266f2dccd5199003eb2ecdc11d", "committedDate": "2020-01-18T21:39:11Z", "message": "Add NMSHacks#getProtocolVersion(Player)\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1144a2cb3c42cdc5fde6e002448318f7d8e78bcc", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/1144a2cb3c42cdc5fde6e002448318f7d8e78bcc", "committedDate": "2020-01-18T23:19:43Z", "message": "Add soft dependency on ViaVersion\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8443f7412933d8161fa7a67979950d1ea3020399", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/8443f7412933d8161fa7a67979950d1ea3020399", "committedDate": "2020-01-19T03:32:04Z", "message": "Refactor ViaUtils to use reflection\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTkyNzMz", "url": "https://github.com/PGMDev/PGM/pull/245#pullrequestreview-344992733", "createdAt": "2020-01-19T10:38:12Z", "commit": {"oid": "8443f7412933d8161fa7a67979950d1ea3020399"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMDozODoxMlrOFfOQMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMDozODoxMlrOFfOQMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzY5OA==", "bodyText": "This should use a logger.", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368283698", "createdAt": "2020-01-19T10:38:12Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/util/ViaUtils.java", "diffHunk": "@@ -1,16 +1,48 @@\n package tc.oc.util;\n \n-import org.bukkit.Bukkit;\n+import java.lang.reflect.Method;\n import org.bukkit.entity.Player;\n+import tc.oc.pgm.api.PGM;\n import tc.oc.world.NMSHacks;\n-import us.myles.ViaVersion.api.Via;\n \n public class ViaUtils {\n+  private static boolean enabled;\n+  private static Object viaAPI;\n+  private static Method getPlayerVersion;\n+\n+  static {\n+    try {\n+      viaAPI = Class.forName(\"us.myles.ViaVersion.api.Via\").getMethod(\"getAPI\").invoke(null);\n+      getPlayerVersion =\n+          Class.forName(\"us.myles.ViaVersion.api.ViaAPI\")\n+              .getMethod(\"getPlayerVersion\", Object.class);\n+      enabled = true;\n+    } catch (Exception e) {\n+      PGM.get().getLogger().warning(\"ViaVersion is not installed\");\n+      e.printStackTrace();\n+      enabled = false;\n+    }\n+  }\n+\n   public static boolean enabled() {\n-    return Bukkit.getServer().getPluginManager().getPlugin(\"ViaVersion\") != null;\n+    return enabled;\n   }\n \n+  /**\n+   * @see <a\n+   *     href=\"https://wiki.vg/Protocol_version_numbers\">https://wiki.vg/Protocol_version_numbers</a>\n+   */\n   public static int getProtocolVersion(Player player) {\n-    return enabled() ? Via.getAPI().getPlayerVersion(player) : NMSHacks.getProtocolVersion(player);\n+    int version = NMSHacks.getProtocolVersion(player);\n+    if (enabled()) {\n+      try {\n+        return (int) getPlayerVersion.invoke(viaAPI, player);\n+      } catch (Exception e) {\n+        e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8443f7412933d8161fa7a67979950d1ea3020399"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4823cea77dd1419be8b563111495766ef740c43a", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/4823cea77dd1419be8b563111495766ef740c43a", "committedDate": "2020-01-19T16:20:26Z", "message": "Revert changes to pom.xml\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0005da1a81acfc5da49a592c6b1dd55f63a2aab", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/a0005da1a81acfc5da49a592c6b1dd55f63a2aab", "committedDate": "2020-01-19T19:03:24Z", "message": "Refactor ViaUtils to not use reflection\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe490dd9d3242f11af54da6a7b4db07e01835001", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/fe490dd9d3242f11af54da6a7b4db07e01835001", "committedDate": "2020-01-19T19:39:13Z", "message": "Minor change to ViaUtils and remove debug println\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDI0MDA2", "url": "https://github.com/PGMDev/PGM/pull/245#pullrequestreview-345024006", "createdAt": "2020-01-19T20:23:23Z", "commit": {"oid": "fe490dd9d3242f11af54da6a7b4db07e01835001"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDMxMzI4", "url": "https://github.com/PGMDev/PGM/pull/245#pullrequestreview-345031328", "createdAt": "2020-01-19T22:33:50Z", "commit": {"oid": "fe490dd9d3242f11af54da6a7b4db07e01835001"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjozMzo1MFrOFfQ_IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQyMjozMzo1MFrOFfQ_IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODQ4MQ==", "bodyText": "Can you leave the * import?", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368328481", "createdAt": "2020-01-19T22:33:50Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/listeners/PGMListener.java", "diffHunk": "@@ -1,6 +1,6 @@\n package tc.oc.pgm.listeners;\n \n-import static com.google.common.base.Preconditions.*;\n+import static com.google.common.base.Preconditions.checkNotNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe490dd9d3242f11af54da6a7b4db07e01835001"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787b537e577ac9847675ddc9976e4a98b2582385", "author": {"user": {"login": "Meeples10", "name": null}}, "url": "https://github.com/PGMDev/PGM/commit/787b537e577ac9847675ddc9976e4a98b2582385", "committedDate": "2020-01-19T22:35:27Z", "message": "Undo change made by IDE\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed70f55c744b0bda245012df6179fbe470669df2", "author": {"user": {"login": "AustinLMayes", "name": "Austin Mayes"}}, "url": "https://github.com/PGMDev/PGM/commit/ed70f55c744b0bda245012df6179fbe470669df2", "committedDate": "2020-01-21T03:51:40Z", "message": "Merge branch 'master' into add-player-protocols"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NDI1MzI2", "url": "https://github.com/PGMDev/PGM/pull/245#pullrequestreview-348425326", "createdAt": "2020-01-27T02:35:22Z", "commit": {"oid": "ed70f55c744b0bda245012df6179fbe470669df2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "082a0e0f2e2dcb7ffc425b4f2c90547565e45535", "author": {"user": {"login": "Electroid", "name": "Ashcon Partovi"}}, "url": "https://github.com/PGMDev/PGM/commit/082a0e0f2e2dcb7ffc425b4f2c90547565e45535", "committedDate": "2020-01-27T02:35:36Z", "message": "Merge branch 'master' into add-player-protocols"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 544, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}