{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0Mjc0NTAy", "number": 243, "title": "Add a cooldown to /report, resolves Electroid#242", "bodyText": "Resolves #242\nThe changes were inspired by here\nI did not want to deviate too far from what has been done in the past. The cooldown is implemented with a hard-coded 15 second cooldown, which I feel will be appropriate for most situations.\nIf it is desired I can add a config option or adjust the hard-coded limit, just let me know.\nEdit: Forgot to mention, I did not add a bypass for players with a specific permission. As I can\u2019t really imagine any situation where one would want to bypass this check. Anyway, if that is desired I can happily add it too. (Outdated)\nScreenshot of formatting (what would happen if user spams the command several times):\n\nSigned-off-by: applenick applenick@users.noreply.github.com", "createdAt": "2020-01-17T18:53:34Z", "url": "https://github.com/PGMDev/PGM/pull/243", "merged": true, "mergeCommit": {"oid": "3f3ce548027f37a875b1686fcb0be78cb9bbf8f9"}, "closed": true, "closedAt": "2020-01-20T23:19:53Z", "author": {"login": "applenick"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7TQ-gAH2gAyMzY0Mjc0NTAyOmFiMmFmZWQ5ODc5YmMwNjdhM2QyNmE3NTMwODlmNGIxMmJhMmRjY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8U_KygH2gAyMzY0Mjc0NTAyOjM2NDc3Y2JiYWJiYjBkMmUyMGYyNGE1ZDRjZWRmMzNiOTIyYzdmZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/ab2afed9879bc067a3d26a753089f4b12ba2dcce", "committedDate": "2020-01-17T18:43:12Z", "message": "Add a cooldown to /report\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzgyMzI2", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344782326", "createdAt": "2020-01-17T19:07:16Z", "commit": {"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTowNzoxNlrOFfCd7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTowNzoxNlrOFfCd7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA5MDYwNw==", "bodyText": "Should use a guava expiring cache, and maybe just use the UUID as key (if the command sender is the console just always allow)", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368090607", "createdAt": "2020-01-17T19:07:16Z", "author": {"login": "Pablete1234"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,16 +24,40 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private final Map<CommandSender, Instant> lastReportSent = new WeakHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fdb0482b5e98d9dc0d94394e0c04fe5b16a3aaf", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/6fdb0482b5e98d9dc0d94394e0c04fe5b16a3aaf", "committedDate": "2020-01-17T20:12:51Z", "message": "Use a cache for report cooldowns\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe414456cd1d35066d533a6331b060e0f137685", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/dfe414456cd1d35066d533a6331b060e0f137685", "committedDate": "2020-01-17T20:22:09Z", "message": "Clean up cache for report cooldowns\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0ODI3Njc0", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344827674", "createdAt": "2020-01-17T20:36:42Z", "commit": {"oid": "dfe414456cd1d35066d533a6331b060e0f137685"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMDozNjo0MlrOFfEnGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMDozNjo0MlrOFfEnGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNTcyMA==", "bodyText": "Using uuis, no need for weak keys", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368125720", "createdAt": "2020-01-17T20:36:42Z", "author": {"login": "Pablete1234"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +26,14 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder()\n+          .weakKeys()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe414456cd1d35066d533a6331b060e0f137685"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/abe07e8b03d7870add0bbd256e580db42d1a017f", "committedDate": "2020-01-17T20:47:02Z", "message": "Remove weak keys, and make cooldown message generic\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTM2MTM3", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344936137", "createdAt": "2020-01-18T10:01:05Z", "commit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTM2NDU0", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344936454", "createdAt": "2020-01-18T10:09:16Z", "commit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxMDowOToxNlrOFfKTtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxMDowOToxNlrOFfKTtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxOTA2Mw==", "bodyText": "This should be translatable.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368219063", "createdAt": "2020-01-18T10:09:16Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +40,32 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = lastReportSent.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          throw new CommandException(\n+              AllTranslations.get()\n+                  .translate(\n+                      \"command.cooldown\",\n+                      commandSender,\n+                      ChatColor.AQUA\n+                          + (secondsRemaining\n+                              + \" second\"\n+                              + (secondsRemaining != 1 ? \"s\" : \"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTQ5ODQ3", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344949847", "createdAt": "2020-01-18T16:04:04Z", "commit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729", "committedDate": "2020-01-18T17:17:37Z", "message": "Update report cooldown to use translatable\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTUzNzI1", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-344953725", "createdAt": "2020-01-18T17:34:46Z", "commit": {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzozNDo0NlrOFfLfow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzozNDo0NlrOFfLfow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODQ5OQ==", "bodyText": "I think this should be called LAST_REPORT_SENT.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238499", "createdAt": "2020-01-18T17:34:46Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +25,11 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/6ef42e675fcc391c78944dae445445ecb271dbe5", "committedDate": "2020-01-18T17:50:52Z", "message": "Update report cooldown to actually use translatables\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDAzNzQ3", "url": "https://github.com/PGMDev/PGM/pull/243#pullrequestreview-345003747", "createdAt": "2020-01-19T13:58:39Z", "commit": {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMzo1ODozOVrOFfPA0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMzo1ODozOVrOFfPA0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5NjE0Nw==", "bodyText": "I would use Integer.toString(secondsRemaining), otherwise looks good to me.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368296147", "createdAt": "2020-01-19T13:58:39Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +39,36 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = LAST_REPORT_SENT.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          Component secondsComponent = new PersonalizedText(\"\" + secondsRemaining);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3acbf054b77450703b5c7a98d6a8c2059fe763e0", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/3acbf054b77450703b5c7a98d6a8c2059fe763e0", "committedDate": "2020-01-20T20:21:40Z", "message": "Clean up formatting for seconds remaining\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36477cbbabbb0d2e20f24a5d4cedf33b922c7feb", "author": {"user": {"login": "Pablete1234", "name": "Pablo Herrera"}}, "url": "https://github.com/PGMDev/PGM/commit/36477cbbabbb0d2e20f24a5d4cedf33b922c7feb", "committedDate": "2020-01-20T23:17:29Z", "message": "Merge branch 'master' into report-cooldown"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 542, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}