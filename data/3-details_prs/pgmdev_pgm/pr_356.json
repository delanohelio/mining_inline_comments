{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDU5OTY5", "number": 356, "title": "Chat and Sound improvements", "bodyText": "Chat and Sound improvements\nThis resolves #352 by allowing users to toggle their sound settings to disallow extra sound effects such as admin chat and reports.\nAll Changes Made:\n\nAdjusted setting values for sounds to ALL, MESSAGES, NONE.\n\nALL receive all sounds\nMESSAGES only /msg sounds are played\nNONE no sound effects play\n\n\nColor change for Admin chat to differentiate it from direct messages.\nChanged DM formatting (see below)\nLowered pitch for admin chat sound\n\nNew sound is just a tad bit different so should help tell the difference between different alerts\n\n\nAdded a new /say (team) (message) command to allow staff to speak in team chats while observing.\n\nUpdate: screenshot outdated, see below for new info.\nSigned-off-by: applenick applenick@users.noreply.github.com", "createdAt": "2020-03-13T23:32:42Z", "url": "https://github.com/PGMDev/PGM/pull/356", "merged": true, "mergeCommit": {"oid": "d79e749092751bab05446af10d844c29d614be77"}, "closed": true, "closedAt": "2020-03-23T14:56:31Z", "author": {"login": "applenick"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNoN2tAH2gAyMzg4MDU5OTY5OjU5NTQzYjA1MDRkMjJhZTgwMTExMTRmMzg1MzUxZGNmYjdjNWEwODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQfiBGgH2gAyMzg4MDU5OTY5Ojg1ODcyNDI5NWYyOTBhMjgzZGZiZGVlODI5N2EwNTUyNmUyOTM2Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59543b0504d22ae8011114f385351dcfb7c5a089", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/59543b0504d22ae8011114f385351dcfb7c5a089", "committedDate": "2020-03-14T17:18:26Z", "message": "Differentiate admin chat from messages\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e9cc835827d320e73fea1c161cfc71f146d5d8c", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/2e9cc835827d320e73fea1c161cfc71f146d5d8c", "committedDate": "2020-03-14T17:28:55Z", "message": "Adjust admin chat prefix color\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "560db54d8519304990d7699124de07e749ff1b23", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/560db54d8519304990d7699124de07e749ff1b23", "committedDate": "2020-03-13T23:09:22Z", "message": "Differentiate admin chat from messages\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}, "afterCommit": {"oid": "2e9cc835827d320e73fea1c161cfc71f146d5d8c", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/2e9cc835827d320e73fea1c161cfc71f146d5d8c", "committedDate": "2020-03-14T17:28:55Z", "message": "Adjust admin chat prefix color\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f7349ce9380cfea58ef8e392d8bf8d7564ad14e", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/7f7349ce9380cfea58ef8e392d8bf8d7564ad14e", "committedDate": "2020-03-15T19:47:31Z", "message": "New direct message formatting\n* Revert Admin chat color back to gold\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0ODM2MzMz", "url": "https://github.com/PGMDev/PGM/pull/356#pullrequestreview-374836333", "createdAt": "2020-03-15T21:40:37Z", "commit": {"oid": "7f7349ce9380cfea58ef8e392d8bf8d7564ad14e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQyMTo0MDozN1rOF2hcqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQyMTo0MDozN1rOF2hcqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxNTQzNQ==", "bodyText": "I think this should be translatable too.", "url": "https://github.com/PGMDev/PGM/pull/356#discussion_r392715435", "createdAt": "2020-03-15T21:40:37Z", "author": {"login": "TheMolkaPL"}, "path": "core/src/main/java/tc/oc/pgm/listeners/ChatDispatcher.java", "diffHunk": "@@ -217,6 +218,12 @@ public void sendReply(Match match, Audience audience, MatchPlayer sender, @Text\n     sendDirect(match, sender, receiver.getBukkit(), message);\n   }\n \n+  private static PersonalizedText formatPrivateMessage(String key) {\n+    return new PersonalizedText(\n+        new PersonalizedTranslatable(key).getPersonalizedText().color(ChatColor.GRAY).italic(true),\n+        new PersonalizedText(\" {0}: {1}\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f7349ce9380cfea58ef8e392d8bf8d7564ad14e"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caa3726fff81e652f825918a30ffd971d262e0f3", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/caa3726fff81e652f825918a30ffd971d262e0f3", "committedDate": "2020-03-20T00:08:58Z", "message": "Clean up formatting and add /say command\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6616e45b0f7b708733aee3814a0d7b469ef324ea", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/6616e45b0f7b708733aee3814a0d7b469ef324ea", "committedDate": "2020-03-20T00:26:46Z", "message": "Add /s alias to /say\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTY3NjA1", "url": "https://github.com/PGMDev/PGM/pull/356#pullrequestreview-378967605", "createdAt": "2020-03-22T02:41:23Z", "commit": {"oid": "6616e45b0f7b708733aee3814a0d7b469ef324ea"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDIwMzQy", "url": "https://github.com/PGMDev/PGM/pull/356#pullrequestreview-379020342", "createdAt": "2020-03-22T16:08:35Z", "commit": {"oid": "6616e45b0f7b708733aee3814a0d7b469ef324ea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNjowODozNVrOF5wrMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNjowODozNVrOF5wrMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExMDY0MQ==", "bodyText": "I think this is neat, but we don't need it. If staff want to say something, they can just use global, rarely do you need to address a single team.", "url": "https://github.com/PGMDev/PGM/pull/356#discussion_r396110641", "createdAt": "2020-03-22T16:08:35Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/listeners/ChatDispatcher.java", "diffHunk": "@@ -172,54 +188,91 @@ public void sendDirect(Match match, MatchPlayer sender, Player receiver, @Text S\n                 .color(ChatColor.RED));\n         return; // Only allow staff to message muted players\n       } else {\n-        playMessageSound(matchReceiver);\n+        playSound(matchReceiver, DM_SOUND);\n       }\n     }\n \n     if (sender != null) {\n       lastMessagedBy.put(receiver, sender.getId());\n     }\n \n+    // Send message to receiver\n     send(\n         match,\n         sender,\n         message,\n-        \"[\" + ChatColor.GOLD + \"DM\" + ChatColor.WHITE + \"] {0}: {1}\",\n+        formatPrivateMessage(\"commands.message.from\", matchReceiver.getBukkit()),\n         viewer -> viewer.getBukkit().equals(receiver),\n         null);\n \n+    // Send message to the sender\n     send(\n         match,\n         manager.getPlayer(receiver), // Allow for cross-match messages\n         message,\n-        \"[\" + ChatColor.GOLD + \"DM\" + ChatColor.WHITE + \"] -> {0}: {1}\",\n+        formatPrivateMessage(\"commands.message.to\", sender.getBukkit()),\n         viewer -> viewer.getBukkit().equals(sender.getBukkit()),\n         null);\n   }\n \n+  private String formatPrivateMessage(String key, CommandSender viewer) {\n+    Component action =\n+        new PersonalizedTranslatable(key).getPersonalizedText().color(ChatColor.GRAY).italic(true);\n+    return ComponentRenderers.toLegacyText(\n+        new PersonalizedText(action, new PersonalizedText(\" {0}: {1}\")), viewer);\n+  }\n+\n   @Command(\n       aliases = {\"reply\", \"r\"},\n       desc = \"Reply to a direct message\",\n       usage = \"[message]\")\n   public void sendReply(Match match, Audience audience, MatchPlayer sender, @Text String message) {\n     final MatchPlayer receiver = manager.getPlayer(lastMessagedBy.get(sender.getBukkit()));\n     if (receiver == null) {\n-      audience.sendWarning(\n-          new PersonalizedText(\"Did not find a message to reply to, use /msg\")); // TODO: translate\n+      audience.sendWarning(new PersonalizedTranslatable(\"commands.message.noReply\"));\n       return;\n     }\n \n     sendDirect(match, sender, receiver.getBukkit(), message);\n   }\n \n-  private static MatchPlayer getApproximatePlayer(Match match, String query, CommandSender sender) {\n-    return StringUtils.bestFuzzyMatch(\n-        query,\n-        match.getPlayers().stream()\n-            .collect(\n-                Collectors.toMap(\n-                    player -> player.getBukkit().getName(sender), Function.identity())),\n-        0.75);\n+  @Command(\n+      aliases = {\"s\", \"say\", \"send\", \"sendteam\"},\n+      desc = \"Send a message to a specfic team chat\",\n+      usage = \"[team] [message]\",\n+      perms = Permissions.STAFF)\n+  public void sendOtherTeamChat(\n+      MatchPlayer player, Match match, String targetParty, @Text String message) {\n+    Party party = getApproximateParty(match, targetParty);\n+\n+    if (party == null) {\n+      player.sendWarning(\n+          new PersonalizedTranslatable(\n+              \"commands.chat.send.noParty\", new PersonalizedText(message).color(ChatColor.AQUA)));\n+      return;\n+    }\n+\n+    if (match.isFinished() || party instanceof Tribute) {\n+      player.sendWarning(new PersonalizedTranslatable(\"commands.chat.send.finished\"));\n+      return;\n+    }\n+\n+    if (!player.isObserving()) {\n+      player.sendWarning(new PersonalizedTranslatable(\"commands.chat.send.notObs\"));\n+      return;\n+    }\n+\n+    // Same format as team chat command\n+    send(\n+        match,\n+        player,\n+        message,\n+        party.getChatPrefix().toLegacyText() + PREFIX_FORMAT,\n+        viewer ->\n+            party.equals(viewer.getParty())\n+                || (viewer.isObserving()\n+                    && viewer.getBukkit().hasPermission(Permissions.ADMINCHAT)),\n+        SettingValue.CHAT_TEAM);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6616e45b0f7b708733aee3814a0d7b469ef324ea"}, "originalPosition": 205}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95b28f968ac073979152cc895ee99be3a18391ff", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/95b28f968ac073979152cc895ee99be3a18391ff", "committedDate": "2020-03-22T18:14:46Z", "message": "Remove /say command\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTA1NDE1", "url": "https://github.com/PGMDev/PGM/pull/356#pullrequestreview-379505415", "createdAt": "2020-03-23T14:52:24Z", "commit": {"oid": "95b28f968ac073979152cc895ee99be3a18391ff"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "858724295f290a283dfbdee8297a05526e293678", "author": {"user": {"login": "Electroid", "name": "Ashcon Partovi"}}, "url": "https://github.com/PGMDev/PGM/commit/858724295f290a283dfbdee8297a05526e293678", "committedDate": "2020-03-23T14:53:05Z", "message": "Merge branch 'master' into admin-chat-things"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 464, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}