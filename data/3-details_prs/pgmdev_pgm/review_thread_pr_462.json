{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTIwNTc1", "number": 462, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0MjoyMFrOD6SEqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMDo0NjozNVrOD60XMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDQwMTA3OnYy", "diffSide": "RIGHT", "path": "util/src/main/i18n/templates/moderation.properties", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0MjoyMFrOGSB_Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODo1OToyOVrOGSMGRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MDEzNQ==", "bodyText": "I don't understand this feature", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421560135", "createdAt": "2020-05-07T14:42:20Z", "author": {"login": "Electroid"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,5 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.auto = Majority of staff are vanished. Due to this we've vanished you as well", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU4Mjc3MQ==", "bodyText": "Hey Electroid,\nSo this idea was suggested by @Pablete1234 yesterday. Basically if more than half of the online staff are vanished, any joining staff will be auto-vanished to prevent players from knowing there are staff online (example for watching a suspected hacker).", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421582771", "createdAt": "2020-05-07T15:12:25Z", "author": {"login": "applenick"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,5 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.auto = Majority of staff are vanished. Due to this we've vanished you as well", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MDEzNQ=="}, "originalCommit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcyNTc2NQ==", "bodyText": "This is a nice feature, there may be 2 or 3 staff members online who are watching a hacker vanished, and suddently you join unvanished, broadcasting a join-message to all players. This has already happened and can ruin entire operations", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421725765", "createdAt": "2020-05-07T18:59:29Z", "author": {"login": "Pablete1234"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,5 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.auto = Majority of staff are vanished. Due to this we've vanished you as well", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MDEzNQ=="}, "originalCommit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNjE1MDY0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1NjowOVrOGSTGEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1NjowOVrOGSTGEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDQwMw==", "bodyText": "Make this 30 seconds, which is the login timeout.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840403", "createdAt": "2020-05-07T22:56:09Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNjE1MTc4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1Njo0MVrOGSTGxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMDozNTozN1rOGSU9hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA==", "bodyText": "Maybe you want to do this check in AsyncPreLoginEvent?", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840580", "createdAt": "2020-05-07T22:56:41Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTExMw==", "bodyText": "Also, before the if statement, always invalidate the Cache for the player.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841113", "createdAt": "2020-05-07T22:58:18Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA=="}, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg3MDk4Mw==", "bodyText": "As discussed AsyncPreLoginEvent does not have a way to determine the address used to login to the server with. Sticking with PlayerLoginEvent for now.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421870983", "createdAt": "2020-05-08T00:35:37Z", "author": {"login": "applenick"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA=="}, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNjE1MjYyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1NzowMlrOGSTHNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1NzowMlrOGSTHNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY5Mw==", "bodyText": "You'll want to remove from the Cache", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840693", "createdAt": "2020-05-07T22:57:02Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {\n+    Player player = event.getPlayer();\n+    if (player.hasPermission(Permissions.VANISH)\n+        && !isVanished(player.getUniqueId())\n+        && isVanishSubdomain(event.getHostname())) {\n+      loginSubdomains.put(player.getUniqueId(), event.getHostname());\n+    }\n+  }\n+\n   @EventHandler(priority = EventPriority.MONITOR)\n   public void onJoin(PlayerJoinEvent event) {\n-    if (isVanished(event.getPlayer().getUniqueId())) {\n-      matchManager.getPlayer(event.getPlayer()).setVanished(true);\n+    MatchPlayer player = matchManager.getPlayer(event.getPlayer());\n+    if (isVanished(player.getId())) { // Player is already vanished\n+      player.setVanished(true);\n+    } else if (player\n+        .getBukkit()\n+        .hasPermission(Permissions.VANISH)) { // Player is not vanished, but has permission to\n+\n+      // Automatic vanish if player logs in via a \"vanish\" subdomain.\n+      String domain = loginSubdomains.getIfPresent(player.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNjE1NTgzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1ODozNVrOGSTJMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMzozMTowM1rOGSTyuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTIwMw==", "bodyText": "No need for config, I think this is ok.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841203", "createdAt": "2020-05-07T22:58:35Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -145,6 +177,10 @@ public void checkMatchPlayer(MatchPlayerAddEvent event) {\n     event.getPlayer().setVanished(isVanished(event.getPlayer().getId()));\n   }\n \n+  private boolean isVanishSubdomain(String address) {\n+    return address.startsWith(\"vanish\"); // TODO Maybe allow config value?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1MTgzMg==", "bodyText": "I'd make it vanish., otherwise it may match more than you want, i can only imagine some vanished.network having trouble with it", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421851832", "createdAt": "2020-05-07T23:31:03Z", "author": {"login": "Pablete1234"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -145,6 +177,10 @@ public void checkMatchPlayer(MatchPlayerAddEvent event) {\n     event.getPlayer().setVanished(isVanished(event.getPlayer().getId()));\n   }\n \n+  private boolean isVanishSubdomain(String address) {\n+    return address.startsWith(\"vanish\"); // TODO Maybe allow config value?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTIwMw=="}, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDAxOTA3OnYy", "diffSide": "RIGHT", "path": "util/src/main/i18n/templates/moderation.properties", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMDo0NjozNVrOGS3Qnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMDo0ODoxN1rOGS3RYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjkyNw==", "bodyText": "No need for special message, the hot bar is fine enough.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r422432927", "createdAt": "2020-05-09T00:46:35Z", "author": {"login": "Electroid"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,4 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.domain = You logged in with {0} so we auto-vanished you", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMzEyMQ==", "bodyText": "Ok! I\u2019ll make this change right away", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r422433121", "createdAt": "2020-05-09T00:48:17Z", "author": {"login": "applenick"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,4 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.domain = You logged in with {0} so we auto-vanished you", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjkyNw=="}, "originalCommit": {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1079, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}