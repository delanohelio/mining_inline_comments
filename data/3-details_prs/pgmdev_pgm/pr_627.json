{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MjQ3NDg2", "number": 627, "title": "Improvements to custom voting options", "bodyText": "Improvements to custom voting options\nRecently some staff on OCC have reported some issues with maps added via the /vote command not showing up in the current poll. The main source of this issue stems from the custom map vote selection data being stored in the individual VotingPool instances rather than the MapPoolManager. As when the server switches pools to accommodate player sizes, the custom vote will not carry over. Instead, the selected maps will not show up until the server switches back to the pool in which the maps were selected.\nTo resolve this I refactored the custom vote code into a VotingPoolOptions class, and an instance of that is created and stored in MapPoolManager\nAlso included are several small text fixes that improve some error commands that staff were confused by. An example being attempting to use any /vote command while a vote was in progress would display a disabled message, instead I\u2019ve adjusted that to Unable to modify vote at this time\nThis should resolve all issues that have been reported regarding the /vote command, however if there are any other suggestions just let me know \ud83d\udc4d\nSigned-off-by: applenick applenick@users.noreply.github.com", "createdAt": "2020-08-28T07:53:00Z", "url": "https://github.com/PGMDev/PGM/pull/627", "merged": true, "mergeCommit": {"oid": "356a37f0aeedd3a4f9229ab27db858cdb4e36bf6"}, "closed": true, "closedAt": "2020-08-29T15:03:14Z", "author": {"login": "applenick"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDROtwAFqTQ3NzQ0ODM0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDq-MOgFqTQ3ODEzMzgyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NDQ4MzQx", "url": "https://github.com/PGMDev/PGM/pull/627#pullrequestreview-477448341", "createdAt": "2020-08-28T07:57:43Z", "commit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNzo1Nzo0M1rOHIuSJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwOTowMzoxOFrOHIy1Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODkwODk2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (customVoteMaps.size() < VotingPool.MAX_VOTE_OPTIONS) {\n          \n          \n            \n                if (customVoteMaps.size() <= VotingPool.MAX_VOTE_OPTIONS) {\n          \n      \n    \n    \n  \n\nOr else max would be 4", "url": "https://github.com/PGMDev/PGM/pull/627#discussion_r478908966", "createdAt": "2020-08-28T07:57:43Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/rotation/VotingPoolOptions.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package tc.oc.pgm.rotation;\n+\n+import com.google.common.collect.Maps;\n+import com.google.common.collect.Sets;\n+import java.util.Map;\n+import java.util.Set;\n+import tc.oc.pgm.api.map.MapInfo;\n+\n+public class VotingPoolOptions {\n+\n+  // Set of maps to be used in custom vote selection\n+  private Set<MapInfo> customVoteMaps;\n+\n+  // Whether custom map selection should replace existing entries\n+  private boolean replace;\n+\n+  public VotingPoolOptions() {\n+    this.customVoteMaps = Sets.newHashSet();\n+    this.replace = true;\n+  }\n+\n+  public boolean shouldOverride() {\n+    return customVoteMaps.size() >= VotingPool.MIN_CUSTOM_VOTE_OPTIONS && !replace;\n+  }\n+\n+  public boolean isReplace() {\n+    return replace;\n+  }\n+\n+  public boolean toggleMode() {\n+    this.replace = !replace;\n+    return replace;\n+  }\n+\n+  public boolean addVote(MapInfo map) {\n+    if (customVoteMaps.size() < VotingPool.MAX_VOTE_OPTIONS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk1MDIzNA==", "bodyText": "CustomVotingPoolOptions?\nI think it should reflect that it's only used for the custom overrides, since MapPoll holds the default poll", "url": "https://github.com/PGMDev/PGM/pull/627#discussion_r478950234", "createdAt": "2020-08-28T08:39:32Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/rotation/VotingPoolOptions.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package tc.oc.pgm.rotation;\n+\n+import com.google.common.collect.Maps;\n+import com.google.common.collect.Sets;\n+import java.util.Map;\n+import java.util.Set;\n+import tc.oc.pgm.api.map.MapInfo;\n+\n+public class VotingPoolOptions {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk2MTkyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Map<MapInfo, Double> getCustomVoteMapWeighted() {\n          \n          \n            \n                Map<MapInfo, Double> maps = Maps.newHashMap();\n          \n          \n            \n                customVoteMaps.forEach(map -> maps.put(map, VotingPool.DEFAULT_WEIGHT));\n          \n          \n            \n                return maps;\n          \n          \n            \n              }\n          \n          \n            \n              public Map<MapInfo, Double> getCustomVoteMapWeighted() {\n          \n          \n            \n                return customVoteMaps.stream().collect(Collectors.toMap(map -> map, VotingPool.DEFAULT_WEIGHT));\n          \n          \n            \n              }\n          \n      \n    \n    \n  \n\nI like the one liner at least :)", "url": "https://github.com/PGMDev/PGM/pull/627#discussion_r478961923", "createdAt": "2020-08-28T08:51:50Z", "author": {"login": "KingOfSquares"}, "path": "core/src/main/java/tc/oc/pgm/rotation/VotingPoolOptions.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package tc.oc.pgm.rotation;\n+\n+import com.google.common.collect.Maps;\n+import com.google.common.collect.Sets;\n+import java.util.Map;\n+import java.util.Set;\n+import tc.oc.pgm.api.map.MapInfo;\n+\n+public class VotingPoolOptions {\n+\n+  // Set of maps to be used in custom vote selection\n+  private Set<MapInfo> customVoteMaps;\n+\n+  // Whether custom map selection should replace existing entries\n+  private boolean replace;\n+\n+  public VotingPoolOptions() {\n+    this.customVoteMaps = Sets.newHashSet();\n+    this.replace = true;\n+  }\n+\n+  public boolean shouldOverride() {\n+    return customVoteMaps.size() >= VotingPool.MIN_CUSTOM_VOTE_OPTIONS && !replace;\n+  }\n+\n+  public boolean isReplace() {\n+    return replace;\n+  }\n+\n+  public boolean toggleMode() {\n+    this.replace = !replace;\n+    return replace;\n+  }\n+\n+  public boolean addVote(MapInfo map) {\n+    if (customVoteMaps.size() < VotingPool.MAX_VOTE_OPTIONS) {\n+      this.customVoteMaps.add(map);\n+      return true;\n+    }\n+    return false;\n+  }\n+\n+  public boolean removeMap(MapInfo map) {\n+    return this.customVoteMaps.remove(map);\n+  }\n+\n+  public Set<MapInfo> getCustomVoteMaps() {\n+    return customVoteMaps;\n+  }\n+\n+  public boolean isAdded(MapInfo info) {\n+    return customVoteMaps.stream().anyMatch(s -> s.getName().equalsIgnoreCase(info.getName()));\n+  }\n+\n+  public void clear() {\n+    customVoteMaps.clear();\n+  }\n+\n+  public Map<MapInfo, Double> getCustomVoteMapWeighted() {\n+    Map<MapInfo, Double> maps = Maps.newHashMap();\n+    customVoteMaps.forEach(map -> maps.put(map, VotingPool.DEFAULT_WEIGHT));\n+    return maps;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODk4MzQ3MA==", "bodyText": "If I understand this correctly, this is displayed if you do /vote clear and there is no maps to clear.\nI think this is too vague if I am correct. Maybe something like There are no custom vote options to clear | There are no maps to clear from the vote | No vote options to clear |\u00a0No maps to clear", "url": "https://github.com/PGMDev/PGM/pull/627#discussion_r478983470", "createdAt": "2020-08-28T09:03:18Z", "author": {"login": "KingOfSquares"}, "path": "util/src/main/i18n/templates/map.properties", "diffHunk": "@@ -58,6 +58,8 @@ map.setNext.revert = {0} has removed {1} as the next map\n \n map.noNextMap = No next map\n \n+map.noMapsFound = No maps found", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e453faffcf80b4396311e3da60539ebb51e2922", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/8e453faffcf80b4396311e3da60539ebb51e2922", "committedDate": "2020-08-28T17:19:16Z", "message": "Improvements to custom voting options\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a080a8afe46d79bcc2ecfae54e1cbce35a83eee", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/7a080a8afe46d79bcc2ecfae54e1cbce35a83eee", "committedDate": "2020-08-28T17:48:58Z", "message": "Rename VotingPoolOptions and minor cleanup\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c2c119cb0734d9d9237bbedf8a99e878e276c3e", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/4c2c119cb0734d9d9237bbedf8a99e878e276c3e", "committedDate": "2020-08-28T07:38:21Z", "message": "Improvements to custom voting options\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}, "afterCommit": {"oid": "7a080a8afe46d79bcc2ecfae54e1cbce35a83eee", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/7a080a8afe46d79bcc2ecfae54e1cbce35a83eee", "committedDate": "2020-08-28T17:48:58Z", "message": "Rename VotingPoolOptions and minor cleanup\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTMzODIz", "url": "https://github.com/PGMDev/PGM/pull/627#pullrequestreview-478133823", "createdAt": "2020-08-29T15:02:57Z", "commit": {"oid": "7a080a8afe46d79bcc2ecfae54e1cbce35a83eee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 460, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}