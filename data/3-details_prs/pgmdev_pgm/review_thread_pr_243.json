{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0Mjc0NTAy", "number": 243, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTowNzoxNlrODY6SVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMzo1ODozOVrODZDG5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDQ3MzgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTowNzoxNlrOFfCd7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTozODo1NVrOFfDRxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA5MDYwNw==", "bodyText": "Should use a guava expiring cache, and maybe just use the UUID as key (if the command sender is the console just always allow)", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368090607", "createdAt": "2020-01-17T19:07:16Z", "author": {"login": "Pablete1234"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,16 +24,40 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private final Map<CommandSender, Instant> lastReportSent = new WeakHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMzg3Ng==", "bodyText": "Also exempt players with the Permissions.STAFF", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368103876", "createdAt": "2020-01-17T19:38:55Z", "author": {"login": "Electroid"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,16 +24,40 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private final Map<CommandSender, Instant> lastReportSent = new WeakHashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA5MDYwNw=="}, "originalCommit": {"oid": "ab2afed9879bc067a3d26a753089f4b12ba2dcce"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDY5NjI4OnYy", "diffSide": "RIGHT", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMDozNjo0MlrOFfEnGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMDozNzo1N1rOFfEpNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNTcyMA==", "bodyText": "Using uuis, no need for weak keys", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368125720", "createdAt": "2020-01-17T20:36:42Z", "author": {"login": "Pablete1234"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +26,14 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder()\n+          .weakKeys()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe414456cd1d35066d533a6331b060e0f137685"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjI2MA==", "bodyText": "Ah thanks, I was unsure! I\u2019ll adjust that now", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368126260", "createdAt": "2020-01-17T20:37:57Z", "author": {"login": "applenick"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +26,14 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder()\n+          .weakKeys()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNTcyMA=="}, "originalCommit": {"oid": "dfe414456cd1d35066d533a6331b060e0f137685"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTMyNTg1OnYy", "diffSide": "RIGHT", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxMDowOToxNlrOFfKTtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzoyNjozNlrOFfLecw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxOTA2Mw==", "bodyText": "This should be translatable.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368219063", "createdAt": "2020-01-18T10:09:16Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +40,32 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = lastReportSent.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          throw new CommandException(\n+              AllTranslations.get()\n+                  .translate(\n+                      \"command.cooldown\",\n+                      commandSender,\n+                      ChatColor.AQUA\n+                          + (secondsRemaining\n+                              + \" second\"\n+                              + (secondsRemaining != 1 ? \"s\" : \"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODE5NQ==", "bodyText": "Thanks Molka, I should have done this from the beginning!", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238195", "createdAt": "2020-01-18T17:26:36Z", "author": {"login": "applenick"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +40,32 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = lastReportSent.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          throw new CommandException(\n+              AllTranslations.get()\n+                  .translate(\n+                      \"command.cooldown\",\n+                      commandSender,\n+                      ChatColor.AQUA\n+                          + (secondsRemaining\n+                              + \" second\"\n+                              + (secondsRemaining != 1 ? \"s\" : \"\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxOTA2Mw=="}, "originalCommit": {"oid": "abe07e8b03d7870add0bbd256e580db42d1a017f"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTQ3NjQwOnYy", "diffSide": "RIGHT", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzozNDo0NlrOFfLfow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQxNzo0Mjo0NFrOFfLhFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODQ5OQ==", "bodyText": "I think this should be called LAST_REPORT_SENT.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238499", "createdAt": "2020-01-18T17:34:46Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +25,11 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODg2OA==", "bodyText": "I meant something like this: :P\nhttps://github.com/Electroid/PGM/blob/31ebbcc74002981fcf05dc0af45e861a77d07aca/src/main/i18n/templates/strings.properties#L672-L674\n\nWhoops! \ud83d\ude06\nI\u2019ll make the adjustments now, thanks again haha.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368238868", "createdAt": "2020-01-18T17:42:44Z", "author": {"login": "applenick"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -18,6 +25,11 @@\n \n public class ModerationCommands {\n \n+  private static final int REPORT_COOLDOWN_SECONDS = 15;\n+\n+  private static final Cache<UUID, Instant> lastReportSent =\n+      CacheBuilder.newBuilder().expireAfterWrite(REPORT_COOLDOWN_SECONDS, TimeUnit.SECONDS).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIzODQ5OQ=="}, "originalCommit": {"oid": "567cc7fa5bc84c19bdcdf299ab3cf9f3ecae1729"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTkxOTExOnYy", "diffSide": "RIGHT", "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQxMzo1ODozOVrOFfPA0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDoxODozMlrOFfob7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5NjE0Nw==", "bodyText": "I would use Integer.toString(secondsRemaining), otherwise looks good to me.", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368296147", "createdAt": "2020-01-19T13:58:39Z", "author": {"login": "TheMolkaPL"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +39,36 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = LAST_REPORT_SENT.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          Component secondsComponent = new PersonalizedText(\"\" + secondsRemaining);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMjY4NA==", "bodyText": "Oh snap, I did not see your suggestion! I\u2019m adjusting this right now. \ud83d\udc4d", "url": "https://github.com/PGMDev/PGM/pull/243#discussion_r368712684", "createdAt": "2020-01-20T20:18:32Z", "author": {"login": "applenick"}, "path": "src/main/java/tc/oc/pgm/commands/ModerationCommands.java", "diffHunk": "@@ -27,7 +39,36 @@ public static void report(\n       MatchPlayer matchPlayer,\n       Match match,\n       Player player,\n-      @Text String reason) {\n+      @Text String reason)\n+      throws CommandException {\n+    if (!commandSender.hasPermission(Permissions.STAFF) && commandSender instanceof Player) {\n+      // Check for cooldown\n+      Instant lastReport = LAST_REPORT_SENT.getIfPresent(matchPlayer.getId());\n+      if (lastReport != null) {\n+        Duration timeSinceReport = Duration.between(lastReport, Instant.now());\n+        long secondsRemaining = REPORT_COOLDOWN_SECONDS - timeSinceReport.getSeconds();\n+        if (secondsRemaining > 0) {\n+          Component secondsComponent = new PersonalizedText(\"\" + secondsRemaining);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5NjE0Nw=="}, "originalCommit": {"oid": "6ef42e675fcc391c78944dae445445ecb271dbe5"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1111, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}