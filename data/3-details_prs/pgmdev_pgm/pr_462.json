{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTIwNTc1", "number": 462, "title": "Vanish Improvements", "bodyText": "Vanish Subdomain login\nThis PR adds a requested feature for the /vanish command. The detection of players who login using a subdomain starting with vanish for example vanish.oc.tc. This will allow staff members who wish to forcefully join vanished to do so.\nThanks and if there are any other suggestions for /vanish leave your feedback \ud83d\ude04\nSigned-off-by: applenick applenick@users.noreply.github.com", "createdAt": "2020-05-07T07:53:16Z", "url": "https://github.com/PGMDev/PGM/pull/462", "merged": true, "mergeCommit": {"oid": "7a2a23941d2106cc0f2c37a0741afe3c399e8f88"}, "closed": true, "closedAt": "2020-05-09T14:27:10Z", "author": {"login": "applenick"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce4Xy0gH2gAyNDE0NTIwNTc1OjFjNTE0NzhjZDYzMzY2MWUzOTUwMmY2NjUzZGIwYjY5MWJiNWQ3NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfnUiiAFqTQwODY1NDM4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/1c51478cd633661e39502f6653db0b691bb5d74f", "committedDate": "2020-05-07T07:44:29Z", "message": "Add vanish login features\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTQyOTg4", "url": "https://github.com/PGMDev/PGM/pull/462#pullrequestreview-407542988", "createdAt": "2020-05-07T14:42:20Z", "commit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0MjoyMFrOGSB_Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDo0MjoyMFrOGSB_Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MDEzNQ==", "bodyText": "I don't understand this feature", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421560135", "createdAt": "2020-05-07T14:42:20Z", "author": {"login": "Electroid"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,5 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.auto = Majority of staff are vanished. Due to this we've vanished you as well", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c51478cd633661e39502f6653db0b691bb5d74f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "committedDate": "2020-05-07T15:35:37Z", "message": "Remove staff-count auto vanish\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODkxNjA5", "url": "https://github.com/PGMDev/PGM/pull/462#pullrequestreview-407891609", "createdAt": "2020-05-07T22:56:09Z", "commit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1NjowOVrOGSTGEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjo1ODozNVrOGSTJMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDQwMw==", "bodyText": "Make this 30 seconds, which is the login timeout.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840403", "createdAt": "2020-05-07T22:56:09Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA==", "bodyText": "Maybe you want to do this check in AsyncPreLoginEvent?", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840580", "createdAt": "2020-05-07T22:56:41Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY5Mw==", "bodyText": "You'll want to remove from the Cache", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840693", "createdAt": "2020-05-07T22:57:02Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {\n+    Player player = event.getPlayer();\n+    if (player.hasPermission(Permissions.VANISH)\n+        && !isVanished(player.getUniqueId())\n+        && isVanishSubdomain(event.getHostname())) {\n+      loginSubdomains.put(player.getUniqueId(), event.getHostname());\n+    }\n+  }\n+\n   @EventHandler(priority = EventPriority.MONITOR)\n   public void onJoin(PlayerJoinEvent event) {\n-    if (isVanished(event.getPlayer().getUniqueId())) {\n-      matchManager.getPlayer(event.getPlayer()).setVanished(true);\n+    MatchPlayer player = matchManager.getPlayer(event.getPlayer());\n+    if (isVanished(player.getId())) { // Player is already vanished\n+      player.setVanished(true);\n+    } else if (player\n+        .getBukkit()\n+        .hasPermission(Permissions.VANISH)) { // Player is not vanished, but has permission to\n+\n+      // Automatic vanish if player logs in via a \"vanish\" subdomain.\n+      String domain = loginSubdomains.getIfPresent(player.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTExMw==", "bodyText": "Also, before the if statement, always invalidate the Cache for the player.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841113", "createdAt": "2020-05-07T22:58:18Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA=="}, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTIwMw==", "bodyText": "No need for config, I think this is ok.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841203", "createdAt": "2020-05-07T22:58:35Z", "author": {"login": "Electroid"}, "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -145,6 +177,10 @@ public void checkMatchPlayer(MatchPlayerAddEvent event) {\n     event.getPlayer().setVanished(isVanished(event.getPlayer().getId()));\n   }\n \n+  private boolean isVanishSubdomain(String address) {\n+    return address.startsWith(\"vanish\"); // TODO Maybe allow config value?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/77d80619cbbacd2116a9017fd53eaf52e681bfa9", "committedDate": "2020-05-08T00:34:13Z", "message": "Adjust vanish subdomain and clean up cache\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NTkzNzA1", "url": "https://github.com/PGMDev/PGM/pull/462#pullrequestreview-408593705", "createdAt": "2020-05-09T00:46:35Z", "commit": {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMDo0NjozNVrOGS3Qnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMDo0NjozNVrOGS3Qnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjkyNw==", "bodyText": "No need for special message, the hot bar is fine enough.", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r422432927", "createdAt": "2020-05-09T00:46:35Z", "author": {"login": "Electroid"}, "path": "util/src/main/i18n/templates/moderation.properties", "diffHunk": "@@ -175,3 +175,4 @@ vanish.chat.deny = You can only use the admin chat while vanished\n \n vanish.hotbar = You are currently vanished\n \n+vanish.login.domain = You logged in with {0} so we auto-vanished you", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3a70be2c7243088bb04e87dc7817871eb9e66d5", "author": {"user": {"login": "applenick", "name": "applenick"}}, "url": "https://github.com/PGMDev/PGM/commit/b3a70be2c7243088bb04e87dc7817871eb9e66d5", "committedDate": "2020-05-09T00:54:24Z", "message": "Remove vanish login message\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjU0Mzg5", "url": "https://github.com/PGMDev/PGM/pull/462#pullrequestreview-408654389", "createdAt": "2020-05-09T14:26:28Z", "commit": {"oid": "b3a70be2c7243088bb04e87dc7817871eb9e66d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 497, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}