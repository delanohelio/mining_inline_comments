{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMzMwNDE5", "number": 336, "title": "Add User Option to allow invalid input paths", "bodyText": "While running performance tests, some external tables did not have any\ndata, and when writting data to the partition, they did not create the\nexpected path while reading. To illustrate this better, this is a sample\ncode of what happened:\nCREATE TABLE foo (id int, some_date date)\nDISTRIBUTED BY (id)\nPARTITION BY RANGE (some_date)\n(start('1992-01-01') INCLUSIVE end ('1998-12-31') INCLUSIVE every\n(30), default partition others);\n\nThe stamement above will create 87 partitions. In our experiment, some\nof the partitions did not have any data (there were no records for some\ndate ranges).\nWe then replace the internal partition with an external partition, as\nillustrated below:\nCREATE EXTERNAL TABLE replace_partition_87 (id int, some_date date)\nLOCATION (\n'pxf://bucket/non-existent-path/?PROFILE=s3:parquet&SERVER=s3'\n) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\nALTER TABLE foo\nEXCHANGE PARTITION FOR (RANK(87)) WITH TABLE replace_partition_87\nWITHOUT VALIDATION;\n\nBecause some of the external tables end up with no data, queries fail\nwhen reading the original partitioned table foo. This commit\nintroduces a new user property IGNORE_INVALID_INPUT, which when set to\ntrue, it will ignore the error and return an empty list of fragments.\nThe new table definition would look like this:\nCREATE EXTERNAL TABLE replace_partition_87(id int, some_date date)\nLOCATION (\n'pxf://bucket/non-existent-path/?PROFLE=s3:parquet&IGNORE_INVALID_INPUT=true'\n) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\nThis commit does not change the default behaviour of erroring out when\nthe partition is missing, but rather gives users an option to not error\nout when the input path is missing.", "createdAt": "2020-04-12T12:17:21Z", "url": "https://github.com/greenplum-db/pxf/pull/336", "merged": true, "mergeCommit": {"oid": "c254446aed07344582d36520bb3c20d3cd108076"}, "closed": true, "closedAt": "2020-04-14T01:46:39Z", "author": {"login": "frankgh"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcW9E4_AH2gAyNDAyMzMwNDE5OmU3Y2VkYzVhNTg3MTFhM2I5ODI2OWM2MjgxY2EwMzA5OTUyMjlkM2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXYcfhgFqTM5MjUyNzg0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/e7cedc5a58711a3b98269c6281ca030995229d3f", "committedDate": "2020-04-12T16:41:58Z", "message": "Add User Option to allow invalid input paths\n\nWhile running performance tests, some external tables did not have any\ndata, and when writting data to the partition, they did not create the\nexpected path while reading. To illustrate this better, this is a sample\ncode of what happened:\n\n    CREATE TABLE foo (id int, some_date date)\n    DISTRIBUTED BY (id)\n    PARTITION BY RANGE (some_date)\n    (start('1992-01-01') INCLUSIVE end ('1998-12-31') INCLUSIVE every\n    (30), default partition others);\n\nThe stamement above will create 87 partitions. In our experiment, some\nof the partitions did not have any data (there were no records for some\ndate ranges).\n\nWe then replace the internal partition with an external partition, as\nillustrated below:\n\n    CREATE EXTERNAL TABLE replace_partition_87 (id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFILE=s3:parquet&SERVER=s3'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\n    ALTER TABLE foo\n    EXCHANGE PARTITION FOR (RANK(87)) WITH TABLE replace_partition_87\n    WITHOUT VALIDATION;\n\nBecause some of the external tables end up with no data, queries fail\nwhen reading the original partitioned table `foo`. This commit\nintroduces a new user property `IGNORE_INVALID_INPUT`, which when set to\ntrue, it will ignore the error and return an empty list of fragments.\nThe new table definition would look like this:\n\n    CREATE EXTERNAL TABLE replace_partition_87(id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFLE=s3:parquet&IGNORE_INVALID_INPUT=true'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\nThis commit does not change the default behaviour of erroring out when\nthe partition is missing, but rather gives users an option to not error\nout when the input path is missing."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d913c34851c936a01899035f9b56c87dc997e2d", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/1d913c34851c936a01899035f9b56c87dc997e2d", "committedDate": "2020-04-12T12:04:08Z", "message": "Add User Option to allow invalid input paths\n\nWhile running performance tests, some external tables did not have any\ndata, and when writting data to the partition, they did not create the\nexpected path while reading. To illustrate this better, this is a sample\ncode of what happened:\n\n    CREATE TABLE foo (id int, some_date date)\n    DISTRIBUTED BY (id)\n    PARTITION BY RANGE (some_date)\n    (start('1992-01-01') INCLUSIVE end ('1998-12-31') INCLUSIVE every\n    (30), default partition others);\n\nThe stamement above will create 87 partitions. In our experiment, some\nof the partitions did not have any data (there were no records for some\ndate ranges).\n\nWe then replace the internal partition with an external partition, as\nillustrated below:\n\n    CREATE EXTERNAL TABLE replace_partition_87 (id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFILE=s3:parquet&SERVER=s3'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\n    ALTER TABLE foo\n    EXCHANGE PARTITION FOR (RANK(87)) WITH TABLE replace_partition_87\n    WITHOUT VALIDATION;\n\nBecause some of the external tables end up with no data, queries fail\nwhen reading the original partitioned table `foo`. This commit\nintroduces a new user property `IGNORE_INVALID_INPUT`, which when set to\ntrue, it will ignore the error and return an empty list of fragments.\nThe new table definition would look like this:\n\n    CREATE EXTERNAL TABLE replace_partition_87(id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFLE=s3:parquet&IGNORE_INVALID_INPUT=true'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\nThis commit does not change the default behaviour of erroring out when\nthe partition is missing, but rather gives users an option to not error\nout when the input path is missing."}, "afterCommit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/e7cedc5a58711a3b98269c6281ca030995229d3f", "committedDate": "2020-04-12T16:41:58Z", "message": "Add User Option to allow invalid input paths\n\nWhile running performance tests, some external tables did not have any\ndata, and when writting data to the partition, they did not create the\nexpected path while reading. To illustrate this better, this is a sample\ncode of what happened:\n\n    CREATE TABLE foo (id int, some_date date)\n    DISTRIBUTED BY (id)\n    PARTITION BY RANGE (some_date)\n    (start('1992-01-01') INCLUSIVE end ('1998-12-31') INCLUSIVE every\n    (30), default partition others);\n\nThe stamement above will create 87 partitions. In our experiment, some\nof the partitions did not have any data (there were no records for some\ndate ranges).\n\nWe then replace the internal partition with an external partition, as\nillustrated below:\n\n    CREATE EXTERNAL TABLE replace_partition_87 (id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFILE=s3:parquet&SERVER=s3'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\n    ALTER TABLE foo\n    EXCHANGE PARTITION FOR (RANK(87)) WITH TABLE replace_partition_87\n    WITHOUT VALIDATION;\n\nBecause some of the external tables end up with no data, queries fail\nwhen reading the original partitioned table `foo`. This commit\nintroduces a new user property `IGNORE_INVALID_INPUT`, which when set to\ntrue, it will ignore the error and return an empty list of fragments.\nThe new table definition would look like this:\n\n    CREATE EXTERNAL TABLE replace_partition_87(id int, some_date date)\n    LOCATION (\n    'pxf://bucket/non-existent-path/?PROFLE=s3:parquet&IGNORE_INVALID_INPUT=true'\n    ) FORMAT 'CUSTOM' (formatter = 'pxfwritable_import');\n\nThis commit does not change the default behaviour of erroring out when\nthe partition is missing, but rather gives users an option to not error\nout when the input path is missing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzQ3NjA1", "url": "https://github.com/greenplum-db/pxf/pull/336#pullrequestreview-392347605", "createdAt": "2020-04-13T18:43:04Z", "commit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODo0MzowNFrOGEwr7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODo1NDo0NlrOGExFnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0NTE2Ng==", "bodyText": "maybe declare \"IGNORE_INVALID_INPUT\" as a constant on RequestContext ?", "url": "https://github.com/greenplum-db/pxf/pull/336#discussion_r407645166", "createdAt": "2020-04-13T18:43:04Z", "author": {"login": "denalex"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HdfsDataFragmenter.java", "diffHunk": "@@ -64,7 +66,16 @@ public void initialize(RequestContext context) {\n     @Override\n     public List<Fragment> getFragments() throws Exception {\n         Path path = new Path(hcfsType.getDataUri(jobConf, context));\n-        List<InputSplit> splits = getSplits(path);\n+        List<InputSplit> splits;\n+        try {\n+            splits = getSplits(path);\n+        } catch (InvalidInputException e) {\n+            if (StringUtils.equalsIgnoreCase(\"true\", context.getOption(\"IGNORE_INVALID_INPUT\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0Nzc5OA==", "bodyText": "can we think of a better name ? \"Invalid input\" is not smth exposed to end-users defining path in LOCATION Url, for them it is either \"path\" or \"resource\", in fact we call it in our docs \"path to data\" LOCATION('pxf://<path-to-data>?PROFILE=<profile_name>, so maybe at least IGNORE_INVALID_PATH. It is also not that the path is invalid (like in violation of syntax rules) but more as non-existent, but IGNORE_NON_EXISTENT_PATH is too long and prone to typing errors. I'd prefer 1-2 simple words max.", "url": "https://github.com/greenplum-db/pxf/pull/336#discussion_r407647798", "createdAt": "2020-04-13T18:47:44Z", "author": {"login": "denalex"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HdfsDataFragmenter.java", "diffHunk": "@@ -64,7 +66,16 @@ public void initialize(RequestContext context) {\n     @Override\n     public List<Fragment> getFragments() throws Exception {\n         Path path = new Path(hcfsType.getDataUri(jobConf, context));\n-        List<InputSplit> splits = getSplits(path);\n+        List<InputSplit> splits;\n+        try {\n+            splits = getSplits(path);\n+        } catch (InvalidInputException e) {\n+            if (StringUtils.equalsIgnoreCase(\"true\", context.getOption(\"IGNORE_INVALID_INPUT\"))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0NTE2Ng=="}, "originalCommit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1MTc0MA==", "bodyText": "what about other profiles ? If we introduce such an option, users might expect it to work similarly for other profiles (Hive, JDBC, etc). So maybe have other profiles proactively throw an error if they encounter this setting ? Or will this be too restrictive, since they will essentially ignore the option and error out if they determine actually missing path.", "url": "https://github.com/greenplum-db/pxf/pull/336#discussion_r407651740", "createdAt": "2020-04-13T18:54:46Z", "author": {"login": "denalex"}, "path": "server/pxf-hdfs/src/test/java/org/greenplum/pxf/plugins/hdfs/HdfsFileFragmenterTest.java", "diffHunk": "@@ -74,4 +74,37 @@ public void testFragmenterWilcardPath() throws Exception {\n         assertNotNull(fragmentList);\n         assertEquals(4, fragmentList.size());\n     }\n+\n+    @Test\n+    public void testInvalidInputPath() throws Exception {\n+        expectedException.expect(InvalidInputException.class);\n+        expectedException.expectMessage(\"Input Pattern file:/tmp/non-existent-path-on-disk/*.csv matches 0 files\");\n+\n+        RequestContext context = new RequestContext();\n+        context.setConfig(\"default\");\n+        context.setUser(\"test-user\");\n+        context.setProfileScheme(\"localfile\");\n+        context.setDataSource(\"/tmp/non-existent-path-on-disk/*.csv\");\n+\n+        Fragmenter fragmenter = new HdfsFileFragmenter();\n+        fragmenter.initialize(context);\n+        fragmenter.getFragments();\n+    }\n+\n+    @Test\n+    public void testInvalidInputPathIgnored() throws Exception {\n+        RequestContext context = new RequestContext();\n+        context.setConfig(\"default\");\n+        context.setUser(\"test-user\");\n+        context.setProfileScheme(\"localfile\");\n+        context.addOption(\"IGNORE_INVALID_INPUT\", \"true\");\n+        context.setDataSource(\"/tmp/non-existent-path-on-disk/*.csv\");\n+\n+        Fragmenter fragmenter = new HdfsFileFragmenter();\n+        fragmenter.initialize(context);\n+\n+        List<Fragment> fragmentList = fragmenter.getFragments();\n+        assertNotNull(fragmentList);\n+        assertEquals(0, fragmentList.size());\n+    }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cedc5a58711a3b98269c6281ca030995229d3f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9fc4c3580cfc6ca896cc05ea9ee6a0f5e7be2f2", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/c9fc4c3580cfc6ca896cc05ea9ee6a0f5e7be2f2", "committedDate": "2020-04-13T21:22:46Z", "message": "Address PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTI3ODQ0", "url": "https://github.com/greenplum-db/pxf/pull/336#pullrequestreview-392527844", "createdAt": "2020-04-14T00:35:11Z", "commit": {"oid": "c9fc4c3580cfc6ca896cc05ea9ee6a0f5e7be2f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 28, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}