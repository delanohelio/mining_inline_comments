{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMTI1ODAz", "number": 398, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTozODowNVrOEKq2aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjowOTowNFrOEKrUng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjIzMjczOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTozODowNVrOGr2Lxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1MzowMlrOGr2jqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTcwMw==", "bodyText": "wonder, should we still log at WARN level here to be consistent. Extra context if debug is on is ok.", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448629703", "createdAt": "2020-07-01T21:38:05Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "diffHunk": "@@ -77,9 +77,9 @@ private Void writeToInternal(OutputStream out) throws IOException {\n             // Occurs whenever client (GPDB) decides to end the connection\n             if (LOG.isDebugEnabled()) {\n                 // Stacktrace in debug\n-                LOG.debug(\"Remote connection closed by GPDB\", e);\n+                LOG.debug(String.format(\"Remote connection closed by GPDB (segment %s)\", context.getSegmentId()), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNTgxNw==", "bodyText": "good point", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448635817", "createdAt": "2020-07-01T21:53:02Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "diffHunk": "@@ -77,9 +77,9 @@ private Void writeToInternal(OutputStream out) throws IOException {\n             // Occurs whenever client (GPDB) decides to end the connection\n             if (LOG.isDebugEnabled()) {\n                 // Stacktrace in debug\n-                LOG.debug(\"Remote connection closed by GPDB\", e);\n+                LOG.debug(String.format(\"Remote connection closed by GPDB (segment %s)\", context.getSegmentId()), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTcwMw=="}, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjIzNDAwOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/WritableResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTozODozOVrOGr2Mkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTozODozOVrOGr2Mkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTkwNw==", "bodyText": "same question about WARN level.", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448629907", "createdAt": "2020-07-01T21:38:39Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/WritableResource.java", "diffHunk": "@@ -160,9 +160,9 @@ public WritableResource(BridgeFactory bridgeFactory, SecurityService securitySer\n                 // Occurs whenever client (GPDB) decides to end the connection\n                 if (LOG.isDebugEnabled()) {\n                     // Stacktrace in debug\n-                    LOG.debug(\"Remote connection closed by GPDB\", cae);\n+                    LOG.debug(String.format(\"Remote connection closed by GPDB (segment %s)\", context.getSegmentId()), cae);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjIzODEwOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/resources/application.properties", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MDoxMlrOGr2PBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoxNTowN1rOGr3CsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA==", "bodyText": "do we only give the server 1s to fish up work and shutdown ? What about our thread pool, will threads have a chance to finish reading /writing ? that might take a while", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448630534", "createdAt": "2020-07-01T21:40:12Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/resources/application.properties", "diffHunk": "@@ -7,7 +7,10 @@ management.endpoint.shutdown.enabled=true\n management.health.probes.enabled=true\n \n server.port=${pxf.port:5888}\n+server.shutdown=graceful\n+spring.lifecycle.timeout-per-shutdown-phase=1s", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzIyMQ==", "bodyText": "I wasn't sure about this one, I think what I wanted to achieve is to enable graceful shutdown, and then users can configure the timeout, but I didn't want to set it to a high number. Maybe we can add # export SPRING_LIFECYCLE_TIMEOUT_PER_SHUTDOWN_PHASE=1s in our pxf-env.sh and pxf-env-default.sh templates", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448637221", "createdAt": "2020-07-01T21:56:47Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/resources/application.properties", "diffHunk": "@@ -7,7 +7,10 @@ management.endpoint.shutdown.enabled=true\n management.health.probes.enabled=true\n \n server.port=${pxf.port:5888}\n+server.shutdown=graceful\n+spring.lifecycle.timeout-per-shutdown-phase=1s", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA=="}, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0Mzc2MQ==", "bodyText": "seems like the default is 30 secs: https://docs.spring.io/spring/docs/3.2.4.RELEASE_to_4.0.0.M3/Spring%20Framework%203.2.4.RELEASE/org/springframework/context/support/DefaultLifecycleProcessor.html#setTimeoutPerShutdownPhase(long)\nI think we should discuss whether we need a graceful shutdown at all, it is not like we have a user-facing app with sub-second response time and want to preserve their session. If for us graceful shutdown means not to accept any new work but let existing queries finish, this might take minutes if not hours.", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448643761", "createdAt": "2020-07-01T22:15:07Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/resources/application.properties", "diffHunk": "@@ -7,7 +7,10 @@ management.endpoint.shutdown.enabled=true\n management.health.probes.enabled=true\n \n server.port=${pxf.port:5888}\n+server.shutdown=graceful\n+spring.lifecycle.timeout-per-shutdown-phase=1s", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA=="}, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjI0MzE2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/scripts/pxf", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MTo1OVrOGr2SAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MTo1OVrOGr2SAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTI5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    # initialize PXF 6.x on a PXF 5.x installation that had already been\n          \n          \n            \n                    # initialize PXF 6.x using a pre-existing PXF 5.x configuration", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448631298", "createdAt": "2020-07-01T21:41:59Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/scripts/pxf", "diffHunk": "@@ -214,6 +214,13 @@ function generateUserConfigs()\n     setup_conf_directory \"${PXF_CONF}/servers\"\n     setup_conf_directory \"${PXF_CONF}/servers/default\"\n     setup_conf_directory \"${PXF_CONF}/templates\" \"${PXF_HOME}/templates/user/templates\" 'override'\n+\n+    if [[ ! -f \"${PXF_CONF}/conf/pxf-log4j2.xml\" ]]; then\n+        # copy the new pxf-log4j2.xml if it doesn't exist. This allows us to\n+        # initialize PXF 6.x on a PXF 5.x installation that had already been", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjI0Njc4OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/scripts/pxf-env-default.sh", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0MzoyOFrOGr2UPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0NTowM1rOGr2Wzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTg3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # The number of milliseconds the server will wait, after accepting a\n          \n          \n            \n            # The time interval the server will wait, after accepting a\n          \n      \n    \n    \n  \n\nmessage was inconsistent with the value 5m", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448631871", "createdAt": "2020-07-01T21:43:28Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/scripts/pxf-env-default.sh", "diffHunk": "@@ -47,6 +47,11 @@ export PXF_PORT=${PXF_PORT:=5888}\n # Memory\n export PXF_JVM_OPTS=${PXF_JVM_OPTS:='-Xmx2g -Xms1g'}\n \n+# The number of milliseconds the server will wait, after accepting a", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjUyNg==", "bodyText": "Also, this is too verbose, compared to other properties, maybe just Server connection timeout", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448632526", "createdAt": "2020-07-01T21:45:03Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/scripts/pxf-env-default.sh", "diffHunk": "@@ -47,6 +47,11 @@ export PXF_PORT=${PXF_PORT:=5888}\n # Memory\n export PXF_JVM_OPTS=${PXF_JVM_OPTS:='-Xmx2g -Xms1g'}\n \n+# The number of milliseconds the server will wait, after accepting a", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTg3MQ=="}, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjI1MjY5OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/templates/user/conf/pxf-env.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0NTozNVrOGr2XzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0NTozNVrOGr2XzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjc4MA==", "bodyText": "same comment", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448632780", "createdAt": "2020-07-01T21:45:35Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/templates/user/conf/pxf-env.sh", "diffHunk": "@@ -19,6 +19,11 @@ PXF_CONF=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )/..\" && pwd )\"\n # Memory\n # export PXF_JVM_OPTS=\"-Xmx2g -Xms1g\"\n \n+# The number of milliseconds the server will wait, after accepting a\n+# connection, for the request URI line to be presented. Use a value of -1 to\n+# indicate no (i.e. infinite) timeout.\n+# export PXF_CONNECTION_TIMEOUT=5m", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjMxMDA2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/scripts/pxf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjowOTowNFrOGr26ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjowOTowNFrOGr26ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MTY1OQ==", "bodyText": "this line is no longer needed", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448641659", "createdAt": "2020-07-01T22:09:04Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/scripts/pxf", "diffHunk": "@@ -214,6 +214,13 @@ function generateUserConfigs()\n     setup_conf_directory \"${PXF_CONF}/servers\"\n     setup_conf_directory \"${PXF_CONF}/servers/default\"\n     setup_conf_directory \"${PXF_CONF}/templates\" \"${PXF_HOME}/templates/user/templates\" 'override'\n+\n+    if [[ ! -f \"${PXF_CONF}/conf/pxf-log4j2.xml\" ]]; then\n+        # copy the new pxf-log4j2.xml if it doesn't exist. This allows us to\n+        # initialize PXF 6.x using a pre-existing PXF 5.x configuration\n+        # initialized", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "607bee17bd054d4cc22410f02b631b9a31793de9"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3394, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}