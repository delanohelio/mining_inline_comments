{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNDk5NzYw", "number": 416, "title": "Fix performance issues when writing wide CSV/TEXT rows", "bodyText": "During writing of wide CSV/TEXT rows (1MB+/row) PXF performance would be\ngreatly degraded. The performance degradation occurs at\norg.greenplum.pxf.api.io.Text#setCapacity. Once the original buffer size\nwas exceeded, the setCapacity call would increase the buffer size by 1\nand perform a copy of bytes. This became extremely slow when writing\nwide rows because org.greenplum.pxf.api.io.Text would consume from the\nbuffer until it encountered a line break delimiter (\\n). In this commit,\nwe delay consuming from the InputStream until the writing to HCFS\noccurs, we consume the InputStream during write. The downside of this\napproach is that we don't report the number of tuples written to the\nexternal system correctly anymore, as we will always report a single\ntuple written.", "createdAt": "2020-08-05T16:18:42Z", "url": "https://github.com/greenplum-db/pxf/pull/416", "merged": true, "mergeCommit": {"oid": "08defac290d5bcbba727d153aad066d3efde40ea"}, "closed": true, "closedAt": "2020-08-11T00:43:03Z", "author": {"login": "frankgh"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc74cRtgH2gAyNDYzNDk5NzYwOjVhZTlkODI2MWI2OThlY2FjZjFmNzMzOWQwYTMyNjVmYWUzYjUwYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9BlCEgBqjM2MzYwNDYxMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ae9d8261b698ecacf1f7339d0a3265fae3b50b5", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/5ae9d8261b698ecacf1f7339d0a3265fae3b50b5", "committedDate": "2020-08-05T10:13:11Z", "message": "Fix performance issues when writing wide CSV/TEXT rows\n\nDuring writing of wide CSV/TEXT rows (1MB+/row) PXF performance would be\ngreatly degraded. The performance degradation occurs at\norg.greenplum.pxf.api.io.Text#setCapacity. Once the original buffer size\nwas exceeded, the setCapacity call would increase the buffer size by 1\nand perform a copy of bytes. This became extremely slow when writing\nwide rows because org.greenplum.pxf.api.io.Text would consume from the\nbuffer until it encountered a line break delimiter (\\n). In this commit,\nwe delay consuming from the InputStream until the writing to HCFS\noccurs, we consume the InputStream during write. The downside of this\napproach is that we don't report the number of tuples written to the\nexternal system correctly anymore, as we will always report a single\ntuple written."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTM5OTEw", "url": "https://github.com/greenplum-db/pxf/pull/416#pullrequestreview-462139910", "createdAt": "2020-08-06T02:11:25Z", "commit": {"oid": "5ae9d8261b698ecacf1f7339d0a3265fae3b50b5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMjoxMToyNVrOG8gvLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMjoxMToyNVrOG8gvLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEwNDEwOQ==", "bodyText": "being inside this if means external table was defined with FORMAT \"TEXT\" or \"CSV\", not that the actual profile will be:text, right ? Maybe coincidentally this is only used for :text profiles, but considering we were thinking of getting rid of gpdb_writable I think in the longer term we need to be more selective here and look at the actual profile or resolver to be used.", "url": "https://github.com/greenplum-db/pxf/pull/416#discussion_r466104109", "createdAt": "2020-08-06T02:11:25Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/BridgeInputBuilder.java", "diffHunk": "@@ -45,9 +44,16 @@ public BridgeInputBuilder(RequestContext protocolData) {\n \n     public List<OneField> makeInput(DataInput inputStream) throws Exception {\n         if (protocolData.getOutputFormat() == OutputFormat.TEXT) {\n-            Text txt = new Text();\n-            txt.readFields(inputStream);\n-            return Collections.singletonList(new OneField(DataType.BYTEA.getOID(), txt.getBytes()));\n+            // Avoid copying the bytes from the inputStream directly. This", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae9d8261b698ecacf1f7339d0a3265fae3b50b5"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc4a998f608ece061a3d8bfb80690243b09a89e", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/3dc4a998f608ece061a3d8bfb80690243b09a89e", "committedDate": "2020-08-07T20:10:14Z", "message": "Increase default connection timeout from 20 seconds to 5 minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774626cb4c96cfb908d70d6657d83a4c208b62cc", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/774626cb4c96cfb908d70d6657d83a4c208b62cc", "committedDate": "2020-08-08T14:30:43Z", "message": "Add tests with wide rows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f8c43cd9780a45e33c8223aeb7b4e85621bf6dc", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/4f8c43cd9780a45e33c8223aeb7b4e85621bf6dc", "committedDate": "2020-08-08T14:44:24Z", "message": "fixup! Add tests with wide rows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7288378c82a609809cbe7f0cfc521e3b98e40f8", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/b7288378c82a609809cbe7f0cfc521e3b98e40f8", "committedDate": "2020-08-08T23:25:36Z", "message": "fixup! Add tests with wide rows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03004f28c902bc81122d21241ff8febd9b7d5258", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/03004f28c902bc81122d21241ff8febd9b7d5258", "committedDate": "2020-08-08T15:11:17Z", "message": "fixup! Add tests with wide rows"}, "afterCommit": {"oid": "b7288378c82a609809cbe7f0cfc521e3b98e40f8", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/b7288378c82a609809cbe7f0cfc521e3b98e40f8", "committedDate": "2020-08-08T23:25:36Z", "message": "fixup! Add tests with wide rows"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4832, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}