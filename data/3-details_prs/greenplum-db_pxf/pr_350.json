{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNjkyNjA4", "number": 350, "title": "Use Google Cloud Build to build docker images", "bodyText": "Add new Dockerfile under pxf-build-base to generate a tarball with\nbuild dependencies (.m2 cache, .gradle cache, go cache, tomcat)\nAdd cloudbuild.yml to build images\nAdd cloudbuild pipeline to tag images as latest\nAdd README.md with instructions on how to build images locally", "createdAt": "2020-04-30T16:19:51Z", "url": "https://github.com/greenplum-db/pxf/pull/350", "merged": true, "mergeCommit": {"oid": "f918c9bc78293cf43d385a7b6b8a1ebec5bf7b9e"}, "closed": true, "closedAt": "2020-05-09T10:46:45Z", "author": {"login": "frankgh"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcczi2RgH2gAyNDExNjkyNjA4OmZlMjdhNDk0NTFlM2E5NjI2ZDQ3YzYzYWRkOTllZjNkNWFmNjM4ZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfkIWLAH2gAyNDExNjkyNjA4OjVlMGJlMzg3ZTYzNTdhMzUxMmZjYzVjNzJhNTFlOGM4M2RiYjg2NmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe27a49451e3a9626d47c63add99ef3d5af638d0", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/fe27a49451e3a9626d47c63add99ef3d5af638d0", "committedDate": "2020-04-30T20:59:11Z", "message": "Use Google Cloud Build to build docker images\n\n- Add new Dockerfile under pxf-build-base to generate a tarball with\nbuild dependencies (.m2 cache, .gradle cache, go cache, tomcat)\n- Add cloudbuild.yml to build images\n- Add cloudbuild pipeline to tag images as latest\n- Add README.md with instructions on how to build images locally"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eef9b79dfbc64ab77c1a2b7f39571e8f117b4dea", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/eef9b79dfbc64ab77c1a2b7f39571e8f117b4dea", "committedDate": "2020-04-30T20:25:28Z", "message": "Add rpm-build on centos"}, "afterCommit": {"oid": "fe27a49451e3a9626d47c63add99ef3d5af638d0", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/fe27a49451e3a9626d47c63add99ef3d5af638d0", "committedDate": "2020-04-30T20:59:11Z", "message": "Use Google Cloud Build to build docker images\n\n- Add new Dockerfile under pxf-build-base to generate a tarball with\nbuild dependencies (.m2 cache, .gradle cache, go cache, tomcat)\n- Add cloudbuild.yml to build images\n- Add cloudbuild pipeline to tag images as latest\n- Add README.md with instructions on how to build images locally"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a18fffa2a44cc18a03721d08a7c72b5fb659070a", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/a18fffa2a44cc18a03721d08a7c72b5fb659070a", "committedDate": "2020-05-01T00:20:09Z", "message": "install psi"}, "afterCommit": {"oid": "1095ada6ebf3dc2cdb8c31af1c181a4b5d8f5de2", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/1095ada6ebf3dc2cdb8c31af1c181a4b5d8f5de2", "committedDate": "2020-05-01T01:09:24Z", "message": "Fix python psi and paramiko issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1095ada6ebf3dc2cdb8c31af1c181a4b5d8f5de2", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/1095ada6ebf3dc2cdb8c31af1c181a4b5d8f5de2", "committedDate": "2020-05-01T01:09:24Z", "message": "Fix python psi and paramiko issues"}, "afterCommit": {"oid": "e97ccea5ff2f909b83a111e6ec49490a1aa40e30", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/e97ccea5ff2f909b83a111e6ec49490a1aa40e30", "committedDate": "2020-05-01T01:56:57Z", "message": "Fix python psi and paramiko issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e97ccea5ff2f909b83a111e6ec49490a1aa40e30", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/e97ccea5ff2f909b83a111e6ec49490a1aa40e30", "committedDate": "2020-05-01T01:56:57Z", "message": "Fix python psi and paramiko issues"}, "afterCommit": {"oid": "3bcb18846bb79cfd2ff540802d61b600ae09dc16", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/3bcb18846bb79cfd2ff540802d61b600ae09dc16", "committedDate": "2020-05-01T02:42:58Z", "message": "Fix python psi and paramiko issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d7d1446d828bf53a324ca59d8b9d60fc2462cfb", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/7d7d1446d828bf53a324ca59d8b9d60fc2462cfb", "committedDate": "2020-05-01T11:43:37Z", "message": "Fix python psi and paramiko issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bcb18846bb79cfd2ff540802d61b600ae09dc16", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/3bcb18846bb79cfd2ff540802d61b600ae09dc16", "committedDate": "2020-05-01T02:42:58Z", "message": "Fix python psi and paramiko issues"}, "afterCommit": {"oid": "7d7d1446d828bf53a324ca59d8b9d60fc2462cfb", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/7d7d1446d828bf53a324ca59d8b9d60fc2462cfb", "committedDate": "2020-05-01T11:43:37Z", "message": "Fix python psi and paramiko issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51de695a3b81b397db2ab9918dfd7d42964e5320", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/51de695a3b81b397db2ab9918dfd7d42964e5320", "committedDate": "2020-05-02T00:44:14Z", "message": "Add dep and ginko for the gpdb5 images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e012c1d2d9fd87043c1b16cfaf62b5133806619", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/5e012c1d2d9fd87043c1b16cfaf62b5133806619", "committedDate": "2020-05-02T00:46:45Z", "message": "Use java-1.8.0-openjdk-devel for gpdb5 images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "106e6dcde69a665175d42f961400499c4a7d769d", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/106e6dcde69a665175d42f961400499c4a7d769d", "committedDate": "2020-05-02T12:35:27Z", "message": "Optimize images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700ada4b28a922af7e16e55dfa791e1e47b40499", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/700ada4b28a922af7e16e55dfa791e1e47b40499", "committedDate": "2020-05-02T14:13:41Z", "message": "Remove gpdb6-centos6-* images"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "535e765eef3d883c0e25fea5f9ab989e541a3f1f", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/535e765eef3d883c0e25fea5f9ab989e541a3f1f", "committedDate": "2020-05-02T13:50:04Z", "message": "Remove gpdb6-centos6-* images"}, "afterCommit": {"oid": "700ada4b28a922af7e16e55dfa791e1e47b40499", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/700ada4b28a922af7e16e55dfa791e1e47b40499", "committedDate": "2020-05-02T14:13:41Z", "message": "Remove gpdb6-centos6-* images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8af56b1ba2bc874e86fde6e8760a67ea36874e", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/0d8af56b1ba2bc874e86fde6e8760a67ea36874e", "committedDate": "2020-05-02T14:17:23Z", "message": "Update IMAGE_LIST"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b221eca71b55de244695fe0d74e00d4e18cc3717", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/b221eca71b55de244695fe0d74e00d4e18cc3717", "committedDate": "2020-05-02T14:28:45Z", "message": "ADD -> COPY"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14054fe769935d681d89d7d09c28241c352e2d66", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/14054fe769935d681d89d7d09c28241c352e2d66", "committedDate": "2020-05-04T19:40:47Z", "message": "provide a .pxfrc file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f0ed3a87e4e99af845f9ff14c30cfbcb15ae35f", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/8f0ed3a87e4e99af845f9ff14c30cfbcb15ae35f", "committedDate": "2020-05-04T21:24:01Z", "message": "fix gpdb5-centos6 JAVA_HOME path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "380825961ecc43c82ba81fbf18a972e9bdc61ec7", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/380825961ecc43c82ba81fbf18a972e9bdc61ec7", "committedDate": "2020-05-04T21:42:10Z", "message": "source .bashrc in .bash_profile in ubuntu 18"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dc050d5e803f94d938ab4c219879134d2714d3e", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/6dc050d5e803f94d938ab4c219879134d2714d3e", "committedDate": "2020-05-05T01:32:03Z", "message": "install psi paramiko as gpadmin and export LANG for ubuntu18"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7df4e0991c66cecdab353f88573ab974a75680d", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/b7df4e0991c66cecdab353f88573ab974a75680d", "committedDate": "2020-05-07T03:32:21Z", "message": "Build a dev image, stop building flavor specific images"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deae82f87adbc693072e7f7df84fef91038845be", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/deae82f87adbc693072e7f7df84fef91038845be", "committedDate": "2020-05-07T03:39:05Z", "message": "fix image name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4a32e90076386f0cb354bf1c28e2f0563cb8a4", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/ce4a32e90076386f0cb354bf1c28e2f0563cb8a4", "committedDate": "2020-05-07T11:16:07Z", "message": "Add GPHOME/bin to PATH"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b75a5096ffe20228a90f260b7dbf1805f4d44ca4", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/b75a5096ffe20228a90f260b7dbf1805f4d44ca4", "committedDate": "2020-05-07T11:30:27Z", "message": "Use registry-image instead of docker-image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/19ffff9e18265cbf7653d88ce0b3fb6576602c98", "committedDate": "2020-05-07T17:30:29Z", "message": "Add limits for gpadmin inside the container"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzEwMTU4", "url": "https://github.com/greenplum-db/pxf/pull/350#pullrequestreview-407710158", "createdAt": "2020-05-07T18:01:44Z", "commit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODowMTo0NFrOGSKCmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODozMzo1MlrOGSLMWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5MjA1Nw==", "bodyText": "Can we maybe refer to GCR project ID as GCR_PROJECT_ID so that we can set it up in our dev environments without risking conflict with anything else ? Applies here and in all other files in this PR. Or does it have to be exactly PROJECT_ID for Cloudbuild to set it up properly ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421692057", "createdAt": "2020-05-07T18:01:44Z", "author": {"login": "denalex"}, "path": "concourse/docker/mapr/README.md", "diffHunk": "@@ -0,0 +1,20 @@\n+# How to build the pxf-dev-mapr docker image locally?\n+\n+Build the docker images on your local system. Run the following command to\n+build the image:\n+\n+### CentOS 7\n+\n+```\n+docker build \\\n+  --build-arg=BASE_IMAGE=gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb5-centos7-test-pxf:latest \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5NTY2Mg==", "bodyText": "the proper command to use would be mvn dependency:go-offline which will fetch all pom / jar / plugins.", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421695662", "createdAt": "2020-05-07T18:07:55Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-build-base/Dockerfile", "diffHunk": "@@ -0,0 +1,33 @@\n+FROM maven:3.6-openjdk-8-slim\n+\n+# install build dependencies for PXF\n+RUN apt-get update && \\\n+    apt-get install -y \\\n+        curl \\\n+        git \\\n+        make \\\n+        unzip \\\n+        wget && \\\n+    apt-get clean && \\\n+    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n+\n+# install go && go utilities\n+RUN cd /tmp && \\\n+    wget -O go.tgz -q https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz && \\\n+    tar -C /usr/local -xzf go.tgz && rm go.tgz && \\\n+    GOPATH=/opt/go /usr/local/go/bin/go get github.com/golang/dep/cmd/dep && \\\n+    GOPATH=/opt/go /usr/local/go/bin/go get github.com/onsi/ginkgo/ginkgo\n+\n+ADD . /tmp/pxf_src\n+\n+# build pxf server and pxf automation\n+RUN export BUILD_PARAMS=-Dorg.gradle.daemon=false && \\\n+    GOPATH=/opt/go PATH=/opt/go/bin:/usr/local/go/bin:$PATH make -C /tmp/pxf_src tar && \\\n+    PXF_HOME=/tmp/pxf_src/server/build/stage make -C /tmp/pxf_src/automation dev && \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5NzQ3Mw==", "bodyText": "can we get an example here on what <REGISTRY_PATH> and <PATH_TO_YOUR_DOCKER_WORKSPACE> can look like ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421697473", "createdAt": "2020-05-07T18:10:49Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-base/README.md", "diffHunk": "@@ -0,0 +1,57 @@\n+# How to build pxf-dev-base docker images locally?\n+\n+The generated images are the base images for the CDH, HDP2, HDP3, and MapR\n+images. This guide assumes the PXF repository lives under the `~/workspace/pxf`\n+directory. The `cloudbuild.yaml` file produces the following docker images:\n+\n+### Docker gpdb5-centos6-test-pxf-image image\n+\n+Build this image for Greenplum 5 running on CentOS 6. Run the following\n+command to build the image:\n+\n+    pushd ~/workspace/pxf/concourse/docker/pxf-dev-base/\n+    docker build \\\n+      --build-arg=BASE_IMAGE=<REGISTRY_PATH>/centos-gpdb-dev:6-gcc6.2-llvm3.7 \\\n+      --tag=gpdb5-centos6-test-pxf \\\n+      -f ~/workspace/pxf/concourse/docker/pxf-dev-base/gpdb5/centos6/Dockerfile \\\n+      <PATH_TO_YOUR_DOCKER_WORKSPACE>\n+    popd\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5ODUxOQ==", "bodyText": "where will ${_BASE_IMAGE_REPOSITORY} be defined ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421698519", "createdAt": "2020-05-07T18:12:34Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-base/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,126 @@\n+# In this directory, run the following command to build this builder.\n+# $ gcloud builds submit . --config=cloudbuild.yaml\n+\n+# Increase timeout to 30 minutes\n+timeout: 1800s\n+\n+# Use a bigger machine type to support concurrent docker builds\n+options:\n+  machineType: 'N1_HIGHCPU_32'\n+\n+steps:\n+\n+##############################################################################\n+# GPDB 5 Images\n+##############################################################################\n+\n+# An image for gpdb5 running on CentOS6\n+- name: 'gcr.io/cloud-builders/docker'\n+  id: gpdb5-centos6-test-pxf-image-cache\n+  entrypoint: 'bash'\n+  args:\n+  - '-c'\n+  - |\n+    mkdir -p /workspace/build\n+    docker pull gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb5-centos6-test-pxf:latest || exit 0\n+  waitFor: ['-']\n+\n+- name: 'gcr.io/cloud-builders/docker'\n+  id: gpdb5-centos6-test-pxf-image\n+  args:\n+  - 'build'\n+  - '--build-arg=BASE_IMAGE=${_BASE_IMAGE_REPOSITORY}/centos-gpdb-dev:6-gcc6.2-llvm3.7'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwMTk0NA==", "bodyText": "this will no longer be true for RPM based installs, how can we support both modes for now ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421701944", "createdAt": "2020-05-07T18:18:37Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-base/gpdb5/centos6/Dockerfile", "diffHunk": "@@ -0,0 +1,59 @@\n+ARG BASE_IMAGE=pivotaldata/gpdb-dev:centos6\n+\n+FROM ${BASE_IMAGE}\n+\n+# install Go utilities\n+RUN GOPATH=/opt/go /usr/local/go/bin/go get github.com/golang/dep/cmd/dep \\\n+    && GOPATH=/opt/go /usr/local/go/bin/go get github.com/onsi/ginkgo/ginkgo\n+\n+# add Java 8 and rpm-build\n+RUN yum install -y rpm-build java-1.8.0-openjdk-devel && yum clean all\n+\n+# add minio software\n+RUN useradd -s /sbin/nologin -d /opt/minio minio \\\n+    && mkdir -p /opt/minio/bin \\\n+    && chmod a+rx /opt/minio \\\n+    && mkdir /opt/minio/data \\\n+    && wget -q https://dl.minio.io/server/minio/release/linux-amd64/minio -O /opt/minio/bin/minio \\\n+    && chmod +x /opt/minio/bin/minio \\\n+    && chown -R minio:minio /opt/minio\n+\n+# create user gpadmin since GPDB cannot run under root\n+RUN ssh-keygen -t rsa -N \"\" -f /root/.ssh/id_rsa \\\n+    && cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys \\\n+    && chmod 0600 /root/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /root/.ssh/known_hosts \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_key -N '' -t rsa1 \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa \\\n+    && sed -i -e 's|Defaults    requiretty|#Defaults    requiretty|' /etc/sudoers \\\n+    && sed -ri 's/UsePAM yes/UsePAM no/g;s/PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config \\\n+    && sed -ri 's@^HostKey /etc/ssh/ssh_host_ecdsa_key$@#&@;s@^HostKey /etc/ssh/ssh_host_ed25519_key$@#&@' /etc/ssh/sshd_config \\\n+    && groupadd -g 6000 gpadmin && useradd -u 6000 -g 6000 gpadmin \\\n+    && echo \"gpadmin  ALL=(ALL)       NOPASSWD: ALL\" > /etc/sudoers.d/gpadmin \\\n+    && groupadd supergroup && usermod -a -G supergroup gpadmin \\\n+    && mkdir /home/gpadmin/.ssh \\\n+    && ssh-keygen -t rsa -N \"\" -f /home/gpadmin/.ssh/id_rsa \\\n+    && cat /home/gpadmin/.ssh/id_rsa.pub >> /home/gpadmin/.ssh/authorized_keys \\\n+    && chmod 0600 /home/gpadmin/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd gpadmin 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /home/gpadmin/.ssh/known_hosts \\\n+    && chown -R gpadmin:gpadmin /home/gpadmin/.ssh \\\n+    # remove any java customization\n+    && rm -rf /etc/profile.d/java.sh \\\n+    # configure gpadmin limits\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft core unlimited' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nproc 131072' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nofile 65536' \\\n+    # create .pxfrc\n+    && echo >> ~gpadmin/.pxfrc 'export PGPORT=5432' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GOPATH=/opt/go' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GPHOME=$(find /usr/local/ -name greenplum-db* -type d | head -n1)' \\\n+    && echo >> ~gpadmin/.pxfrc 'export PXF_HOME=${GPHOME}/pxf' \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwMzA1NQ==", "bodyText": "will we still need to source greenplum_path.sh or not ? only for init_gpdb ? I believe it also sets LD_LIBRARY_PATH and messes up python.", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421703055", "createdAt": "2020-05-07T18:20:31Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-base/gpdb5/centos6/Dockerfile", "diffHunk": "@@ -0,0 +1,59 @@\n+ARG BASE_IMAGE=pivotaldata/gpdb-dev:centos6\n+\n+FROM ${BASE_IMAGE}\n+\n+# install Go utilities\n+RUN GOPATH=/opt/go /usr/local/go/bin/go get github.com/golang/dep/cmd/dep \\\n+    && GOPATH=/opt/go /usr/local/go/bin/go get github.com/onsi/ginkgo/ginkgo\n+\n+# add Java 8 and rpm-build\n+RUN yum install -y rpm-build java-1.8.0-openjdk-devel && yum clean all\n+\n+# add minio software\n+RUN useradd -s /sbin/nologin -d /opt/minio minio \\\n+    && mkdir -p /opt/minio/bin \\\n+    && chmod a+rx /opt/minio \\\n+    && mkdir /opt/minio/data \\\n+    && wget -q https://dl.minio.io/server/minio/release/linux-amd64/minio -O /opt/minio/bin/minio \\\n+    && chmod +x /opt/minio/bin/minio \\\n+    && chown -R minio:minio /opt/minio\n+\n+# create user gpadmin since GPDB cannot run under root\n+RUN ssh-keygen -t rsa -N \"\" -f /root/.ssh/id_rsa \\\n+    && cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys \\\n+    && chmod 0600 /root/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /root/.ssh/known_hosts \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_key -N '' -t rsa1 \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa \\\n+    && sed -i -e 's|Defaults    requiretty|#Defaults    requiretty|' /etc/sudoers \\\n+    && sed -ri 's/UsePAM yes/UsePAM no/g;s/PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config \\\n+    && sed -ri 's@^HostKey /etc/ssh/ssh_host_ecdsa_key$@#&@;s@^HostKey /etc/ssh/ssh_host_ed25519_key$@#&@' /etc/ssh/sshd_config \\\n+    && groupadd -g 6000 gpadmin && useradd -u 6000 -g 6000 gpadmin \\\n+    && echo \"gpadmin  ALL=(ALL)       NOPASSWD: ALL\" > /etc/sudoers.d/gpadmin \\\n+    && groupadd supergroup && usermod -a -G supergroup gpadmin \\\n+    && mkdir /home/gpadmin/.ssh \\\n+    && ssh-keygen -t rsa -N \"\" -f /home/gpadmin/.ssh/id_rsa \\\n+    && cat /home/gpadmin/.ssh/id_rsa.pub >> /home/gpadmin/.ssh/authorized_keys \\\n+    && chmod 0600 /home/gpadmin/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd gpadmin 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /home/gpadmin/.ssh/known_hosts \\\n+    && chown -R gpadmin:gpadmin /home/gpadmin/.ssh \\\n+    # remove any java customization\n+    && rm -rf /etc/profile.d/java.sh \\\n+    # configure gpadmin limits\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft core unlimited' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nproc 131072' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nofile 65536' \\\n+    # create .pxfrc\n+    && echo >> ~gpadmin/.pxfrc 'export PGPORT=5432' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GOPATH=/opt/go' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GPHOME=$(find /usr/local/ -name greenplum-db* -type d | head -n1)' \\\n+    && echo >> ~gpadmin/.pxfrc 'export PXF_HOME=${GPHOME}/pxf' \\\n+    && echo >> ~gpadmin/.pxfrc 'export PXF_CONF=/home/gpadmin/pxf' \\\n+    && echo >> ~gpadmin/.pxfrc 'export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk.x86_64' \\\n+    && echo >> ~gpadmin/.pxfrc 'export PATH=${GPHOME}/bin:${PXF_HOME}/bin:${GOPATH}/bin:/usr/local/go/bin:$PATH' \\\n+    && ln -s ~gpadmin/.pxfrc ~root \\\n+    && echo >> ~gpadmin/.bashrc 'source ~/.pxfrc' \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNDA5Ng==", "bodyText": "should we default to centos7 base ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421704096", "createdAt": "2020-05-07T18:22:32Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-server/Dockerfile", "diffHunk": "@@ -1,19 +1,22 @@\n-ARG BASE_IMAGE=gpdb-pxf-dev:centos6\n+ARG BASE_IMAGE=pivotaldata/gpdb-pxf-dev:centos6", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNTUzNg==", "bodyText": "does it mean they will have to edit the template or just set the env variable before running the gcloud command ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421705536", "createdAt": "2020-05-07T18:24:42Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-server/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,58 @@\n+# In this directory, run the following command to build this builder.\n+# $ gcloud builds submit . --config=cloudbuild.yaml\n+# You will need to provide replacements for _SINGLECLUSTER_BUCKET", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNjE3Nw==", "bodyText": "I think we are trying to use [[ for checks", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421706177", "createdAt": "2020-05-07T18:25:48Z", "author": {"login": "denalex"}, "path": "concourse/scripts/check_docker_images_and_tag.bash", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+COMMIT_SHA=$(cat pxf_src/.git/ref)\n+echo \"Checking images for PXF SHA-1: ${COMMIT_SHA}\"\n+\n+if [ -z \"$IMAGE_LIST\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwODYxNg==", "bodyText": "should we echo smth here ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421708616", "createdAt": "2020-05-07T18:29:55Z", "author": {"login": "denalex"}, "path": "concourse/scripts/check_docker_images_and_tag.bash", "diffHunk": "@@ -0,0 +1,61 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+COMMIT_SHA=$(cat pxf_src/.git/ref)\n+echo \"Checking images for PXF SHA-1: ${COMMIT_SHA}\"\n+\n+if [ -z \"$IMAGE_LIST\" ]; then\n+  echo \"The IMAGE_LIST needs to be provided\"\n+  exit 1\n+fi\n+\n+gcloud config set project \"$GOOGLE_PROJECT_ID\"\n+gcloud auth activate-service-account --key-file=<(echo \"$GOOGLE_CREDENTIALS\")\n+\n+# Don't quote $IMAGE_LIST to allow array\n+IMAGE_NAMES=(${IMAGE_LIST})\n+\n+# wait 1 minute before checking\n+sleep 1m\n+# get the build id\n+BUILD_ID=$(gcloud builds list --ongoing --filter \"images='gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${IMAGE_NAMES[0]}:${COMMIT_SHA}'\" | awk 'FNR == 2 {print $1}')\n+\n+# Wait ~ 40 minutes\n+for i in {0..40}\n+do\n+  if [ -n \"$BUILD_ID\" ]; then\n+    echo \"Checking status for build with ID: ${BUILD_ID}\"\n+    # if we have the $BUILD_ID, check the status using it\n+    STATUS=$(gcloud builds list --filter \"status='SUCCESS' AND build_id='${BUILD_ID}'\" 2>&1 | awk 'FNR == 2 {print $1}')\n+  else\n+    echo \"Checking status with filter images='gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${IMAGE_NAMES[0]}:${COMMIT_SHA}'\"\n+    # otherwise, let's use the image name\n+    STATUS=$(gcloud builds list --filter \"status='SUCCESS' AND images='gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${IMAGE_NAMES[0]}:${COMMIT_SHA}'\" 2>&1 | awk 'FNR == 2 {print $1}')\n+  fi\n+\n+  if [ -n \"$STATUS\" ]; then\n+    echo \"Cloud build completed with ID ${STATUS}\"\n+\n+    for image in \"${IMAGE_NAMES[@]}\"\n+    do\n+      # we need to untag latest first\n+      gcloud container images untag --quiet \"gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${image}:latest\" || true\n+      # tag image with latest\n+      echo \"Tagging gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${image}:${COMMIT_SHA} with latest\"\n+      gcloud container images add-tag --quiet \\\n+        \"gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${image}:${COMMIT_SHA}\" \\\n+        \"gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${image}:latest\"\n+    done\n+\n+    exit 0\n+  else\n+    echo \"Attempt ${i}: Checking cloud build status\"\n+  fi\n+\n+  # sleep for 1 min\n+  sleep 1m\n+done\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcxMDkzNg==", "bodyText": "Would be nice to document how CloudBuild / Concourse tie things together. There are good instructions on how to build Docker images locally and also documentation on how to submit cloudbuild yaml files to Google. However, it is not very clear how everything ties together and what to do on a Docker image change.", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r421710936", "createdAt": "2020-05-07T18:33:52Z", "author": {"login": "denalex"}, "path": "concourse/docker/README.md", "diffHunk": "@@ -1,9 +1,40 @@\n-#Docker container for GPDB development/testing\n-##Requirements\n+# Docker container for GPDB development/testing\n+## Requirements\n \n - docker 1.13 (with 3-4 GB allocated for docker host)\n \n Map-R 5.2 Image\n ```\n docker run --rm --privileged -p 8443:8443 -it pivotaldata/gpdb-dev:centos6-mapr5.2\n-```\n\\ No newline at end of file\n+```\n+\n+## Available docker images\n+\n+<table>\n+  <tr>\n+    <td>&nbsp;</td>\n+    <td colspan=\"2\">Greenplum 5</td>\n+    <td colspan=\"2\">Greenplum 6</td>\n+  </tr>\n+  <tr>\n+    <td>&nbsp;</td>\n+    <td>CentOS6</td>\n+    <td>CentOS7</td>\n+    <td>CentOS7</td>\n+    <td>Ubuntu 18.04</td>\n+  </tr>\n+  <tr>\n+    <td>Base Image</td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb5-centos6-test-pxf\">gpdb5-centos6-test-pxf</a> </td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb5-centos7-test-pxf\">gpdb5-centos7-test-pxf</a> </td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb6-centos7-test-pxf\">gpdb6-centos7-test-pxf</a> </td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb6-ubuntu18.04-test-pxf\">gpdb6-ubuntu18.04-test-pxf</a> </td>\n+  </tr>\n+  <tr>\n+    <td>MapR</td>\n+    <td> N/A </td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb5-centos7-test-pxf-mapr\">gpdb5-centos7-test-pxf-mapr</a> </td>\n+    <td> <a href=\"https://console.cloud.google.com/gcr/images/${PROJECT_ID}/GLOBAL/gpdb-pxf-dev/gpdb6-centos7-test-pxf-mapr\">gpdb6-centos7-test-pxf-mapr</a> </td>\n+    <td> N/A </td>\n+  </tr>\n+</table>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a9f154d7ed440ae7a542cdc20429d9cfe223d14", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/6a9f154d7ed440ae7a542cdc20429d9cfe223d14", "committedDate": "2020-05-08T23:54:59Z", "message": "Use mvn dependency:go-offline to generate pom/jars deps in .m2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c584a452207e6ceef787dbab7547b1a54a71eca", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/6c584a452207e6ceef787dbab7547b1a54a71eca", "committedDate": "2020-05-09T00:17:53Z", "message": "Add readme to generate tarball with deps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36a1adf643b635a77e6de927e80e9122d2dd2b0e", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/36a1adf643b635a77e6de927e80e9122d2dd2b0e", "committedDate": "2020-05-09T00:19:07Z", "message": "add correct pxf_home in .pxfrc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5eea8e89bb3534033f37d9ebdfee6d7aa3062cc", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/e5eea8e89bb3534033f37d9ebdfee6d7aa3062cc", "committedDate": "2020-05-09T00:34:56Z", "message": "Use centos7 as default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/473cf763cc41460ce9a03321d4b32cfb85561c51", "committedDate": "2020-05-09T01:25:47Z", "message": "PROJECT_ID -> GCR_PROJECT_ID"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjA0MTY5", "url": "https://github.com/greenplum-db/pxf/pull/350#pullrequestreview-408604169", "createdAt": "2020-05-09T02:37:46Z", "commit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjozNzo0NlrOGS37cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjozOTo1OVrOGS38Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0Mzg4OQ==", "bodyText": "this assumes PXF is already installed, which will not be the case in many cases. Since this is image for gp5, we can hardcode /usr/local/pxf-gp5 here. Not so easy for GPHOME up above.", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422443889", "createdAt": "2020-05-09T02:37:46Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-base/gpdb5/centos6/Dockerfile", "diffHunk": "@@ -0,0 +1,59 @@\n+ARG BASE_IMAGE=pivotaldata/gpdb-dev:centos6\n+\n+FROM ${BASE_IMAGE}\n+\n+# install Go utilities\n+RUN GOPATH=/opt/go /usr/local/go/bin/go get github.com/golang/dep/cmd/dep \\\n+    && GOPATH=/opt/go /usr/local/go/bin/go get github.com/onsi/ginkgo/ginkgo\n+\n+# add Java 8 and rpm-build\n+RUN yum install -y rpm-build java-1.8.0-openjdk-devel && yum clean all\n+\n+# add minio software\n+RUN useradd -s /sbin/nologin -d /opt/minio minio \\\n+    && mkdir -p /opt/minio/bin \\\n+    && chmod a+rx /opt/minio \\\n+    && mkdir /opt/minio/data \\\n+    && wget -q https://dl.minio.io/server/minio/release/linux-amd64/minio -O /opt/minio/bin/minio \\\n+    && chmod +x /opt/minio/bin/minio \\\n+    && chown -R minio:minio /opt/minio\n+\n+# create user gpadmin since GPDB cannot run under root\n+RUN ssh-keygen -t rsa -N \"\" -f /root/.ssh/id_rsa \\\n+    && cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys \\\n+    && chmod 0600 /root/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /root/.ssh/known_hosts \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_key -N '' -t rsa1 \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_rsa_key -N '' -t rsa \\\n+    && ssh-keygen -f /etc/ssh/ssh_host_dsa_key -N '' -t dsa \\\n+    && sed -i -e 's|Defaults    requiretty|#Defaults    requiretty|' /etc/sudoers \\\n+    && sed -ri 's/UsePAM yes/UsePAM no/g;s/PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config \\\n+    && sed -ri 's@^HostKey /etc/ssh/ssh_host_ecdsa_key$@#&@;s@^HostKey /etc/ssh/ssh_host_ed25519_key$@#&@' /etc/ssh/sshd_config \\\n+    && groupadd -g 6000 gpadmin && useradd -u 6000 -g 6000 gpadmin \\\n+    && echo \"gpadmin  ALL=(ALL)       NOPASSWD: ALL\" > /etc/sudoers.d/gpadmin \\\n+    && groupadd supergroup && usermod -a -G supergroup gpadmin \\\n+    && mkdir /home/gpadmin/.ssh \\\n+    && ssh-keygen -t rsa -N \"\" -f /home/gpadmin/.ssh/id_rsa \\\n+    && cat /home/gpadmin/.ssh/id_rsa.pub >> /home/gpadmin/.ssh/authorized_keys \\\n+    && chmod 0600 /home/gpadmin/.ssh/authorized_keys \\\n+    && echo -e \"password\\npassword\" | passwd gpadmin 2> /dev/null \\\n+    && { ssh-keyscan localhost; ssh-keyscan 0.0.0.0; } >> /home/gpadmin/.ssh/known_hosts \\\n+    && chown -R gpadmin:gpadmin /home/gpadmin/.ssh \\\n+    # remove any java customization\n+    && rm -rf /etc/profile.d/java.sh \\\n+    # configure gpadmin limits\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft core unlimited' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nproc 131072' \\\n+    && echo >> /etc/security/limits.d/gpadmin-limits.conf 'gpadmin soft nofile 65536' \\\n+    # create .pxfrc\n+    && echo >> ~gpadmin/.pxfrc 'export PGPORT=5432' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GOPATH=/opt/go' \\\n+    && echo >> ~gpadmin/.pxfrc 'export GPHOME=$(find /usr/local/ -name greenplum-db* -type d | head -n1)' \\\n+    && echo >> ~gpadmin/.pxfrc 'export PXF_HOME=$(find /usr/local/ -name pxf-gp* -type d | head -n1)' \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NDA1MA==", "bodyText": "minor: alignment ?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422444050", "createdAt": "2020-05-09T02:39:22Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-server/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,58 @@\n+# In this directory, run the following command to build this builder.\n+# $ gcloud builds submit . --config=cloudbuild.yaml\n+# You will need to provide replacements for _SINGLECLUSTER_BUCKET\n+\n+# Increase timeout to 40 minutes\n+timeout: 2400s\n+\n+steps:\n+- name: 'gcr.io/cloud-builders/gsutil'\n+  id: pxf-build-dependencies\n+  args: ['cp', 'gs://${_SINGLECLUSTER_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'build/pxf-build-dependencies.tar.gz']\n+  waitFor: ['-']\n+\n+- name: 'gcr.io/cloud-builders/gsutil'\n+  id: singlecluster-hdp2\n+  args: ['cp', 'gs://${_SINGLECLUSTER_BUCKET}/singlecluster/HDP2/singlecluster-HDP2.tar.gz', 'build/singlecluster-HDP2.tar.gz']\n+  waitFor: ['-']\n+\n+  ##############################################################################", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NDEwNw==", "bodyText": "maybe say so in line 3, i.e. explain how to \"provide replacement\"", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422444107", "createdAt": "2020-05-09T02:39:59Z", "author": {"login": "denalex"}, "path": "concourse/docker/pxf-dev-server/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,58 @@\n+# In this directory, run the following command to build this builder.\n+# $ gcloud builds submit . --config=cloudbuild.yaml\n+# You will need to provide replacements for _SINGLECLUSTER_BUCKET", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNTUzNg=="}, "originalCommit": {"oid": "19ffff9e18265cbf7653d88ce0b3fb6576602c98"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjEwNzkz", "url": "https://github.com/greenplum-db/pxf/pull/350#pullrequestreview-408610793", "createdAt": "2020-05-09T04:19:06Z", "commit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDoxOTowNlrOGS4Xfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNDo0NzozOVrOGS4d7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MTA3MA==", "bodyText": "The cloudbuild pipeline", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422451070", "createdAt": "2020-05-09T04:19:06Z", "author": {"login": "oliverralbertini"}, "path": "concourse/docker/README.md", "diffHunk": "@@ -1,9 +1,52 @@\n-#Docker container for GPDB development/testing\n-##Requirements\n+# Docker container for Greenplum development/testing\n+\n+## Requirements\n \n - docker 1.13 (with 3-4 GB allocated for docker host)\n \n Map-R 5.2 Image\n ```\n docker run --rm --privileged -p 8443:8443 -it pivotaldata/gpdb-dev:centos6-mapr5.2\n-```\n\\ No newline at end of file\n+```\n+\n+PXF uses [Google Cloud Build](https://cloud.google.com/cloud-build) to produce\n+development images that reside in\n+[Google Container Registry (GCR)](https://cloud.google.com/container-registry).\n+\n+The `cloudbuild` pipeline provides visibility into the cloud builds. The cloud\n+build pipeline triggers on changes to `pxf-dev-base` and changes to\n+`pxf-build-base`. The `cloudbuild` is in charge of tagging the images as latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MjAyNg==", "bodyText": "where are we using this one?", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422452026", "createdAt": "2020-05-09T04:35:47Z", "author": {"login": "oliverralbertini"}, "path": "concourse/docker/pxf-dev-server/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,58 @@\n+# In this directory, run the following command to build this builder.\n+# $ gcloud builds submit . --config=cloudbuild.yaml\n+# You will need to provide replacements for _SINGLECLUSTER_BUCKET\n+\n+# Increase timeout to 40 minutes\n+timeout: 2400s\n+\n+steps:\n+- name: 'gcr.io/cloud-builders/gsutil'\n+  id: pxf-build-dependencies\n+  args: ['cp', 'gs://${_SINGLECLUSTER_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'build/pxf-build-dependencies.tar.gz']\n+  waitFor: ['-']\n+\n+- name: 'gcr.io/cloud-builders/gsutil'\n+  id: singlecluster-hdp2\n+  args: ['cp', 'gs://${_SINGLECLUSTER_BUCKET}/singlecluster/HDP2/singlecluster-HDP2.tar.gz', 'build/singlecluster-HDP2.tar.gz']\n+  waitFor: ['-']\n+\n+  ##############################################################################\n+# GPDB 6 CentOS 7 Images\n+##############################################################################\n+\n+# Builds the gpdb6-centos7-test-pxf-hdp2-image image\n+- name: 'gcr.io/cloud-builders/docker'\n+  id: gpdb6-centos7-test-pxf-hdp2-image-cache\n+  entrypoint: 'bash'\n+  args:\n+  - '-c'\n+  - |\n+    docker pull gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2:latest || exit 0\n+  waitFor: ['-']\n+\n+- name: 'gcr.io/cloud-builders/docker'\n+  id: gpdb6-centos7-test-pxf-hdp2-image\n+  args:\n+  - 'build'\n+  - '--build-arg=BASE_IMAGE=gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf:latest'\n+  - '--tag=gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2:$COMMIT_SHA'\n+  - '--cache-from'\n+  - 'gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2:latest'\n+  - '-f'\n+  - 'concourse/docker/pxf-dev-server/Dockerfile'\n+  - 'build/'\n+  waitFor:\n+    - pxf-build-dependencies\n+    - singlecluster-hdp2\n+    - gpdb6-centos7-test-pxf-hdp2-image-cache\n+\n+# Tag the latest version as :latest. We use gcr.io/cloud-builders/docker here\n+- name: 'gcr.io/cloud-builders/docker'\n+  args: ['tag', 'gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2']\n+  wait_for:\n+    - gpdb6-centos7-test-pxf-hdp2-image\n+\n+# Push images to Cloud Build to Container Registry\n+images:\n+- 'gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2'\n+- 'gcr.io/$PROJECT_ID/gpdb-pxf-dev/gpdb6-centos7-test-pxf-hdp2:$COMMIT_SHA'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MjY4OA==", "bodyText": "I would prefer something like:\ngcloud builds list --filter \"status='SUCCESS' AND build_id=${BUILD_ID}\" --format=json | jq -r '.[] | .id'", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422452688", "createdAt": "2020-05-09T04:47:14Z", "author": {"login": "oliverralbertini"}, "path": "concourse/scripts/check_docker_images_and_tag.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+COMMIT_SHA=$(cat pxf_src/.git/ref)\n+echo \"Checking images for PXF SHA-1: ${COMMIT_SHA}\"\n+\n+if [[ -z $IMAGE_LIST ]]; then\n+  echo \"The IMAGE_LIST needs to be provided\"\n+  exit 1\n+fi\n+\n+gcloud config set project \"$GOOGLE_PROJECT_ID\"\n+gcloud auth activate-service-account --key-file=<(echo \"$GOOGLE_CREDENTIALS\")\n+\n+# Don't quote $IMAGE_LIST to allow array\n+IMAGE_NAMES=(${IMAGE_LIST})\n+\n+# wait 1 minute before checking\n+sleep 1m\n+# get the build id\n+BUILD_ID=$(gcloud builds list --ongoing --filter \"images='gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${IMAGE_NAMES[0]}:${COMMIT_SHA}'\" | awk 'FNR == 2 {print $1}')\n+\n+# Wait ~ 40 minutes\n+for i in {0..40}\n+do\n+  if [ -n \"$BUILD_ID\" ]; then\n+    echo \"Checking status for build with ID: ${BUILD_ID}\"\n+    # if we have the $BUILD_ID, check the status using it\n+    STATUS=$(gcloud builds list --filter \"status='SUCCESS' AND build_id='${BUILD_ID}'\" 2>&1 | awk 'FNR == 2 {print $1}')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MjcxOQ==", "bodyText": "same can be done below", "url": "https://github.com/greenplum-db/pxf/pull/350#discussion_r422452719", "createdAt": "2020-05-09T04:47:39Z", "author": {"login": "oliverralbertini"}, "path": "concourse/scripts/check_docker_images_and_tag.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+COMMIT_SHA=$(cat pxf_src/.git/ref)\n+echo \"Checking images for PXF SHA-1: ${COMMIT_SHA}\"\n+\n+if [[ -z $IMAGE_LIST ]]; then\n+  echo \"The IMAGE_LIST needs to be provided\"\n+  exit 1\n+fi\n+\n+gcloud config set project \"$GOOGLE_PROJECT_ID\"\n+gcloud auth activate-service-account --key-file=<(echo \"$GOOGLE_CREDENTIALS\")\n+\n+# Don't quote $IMAGE_LIST to allow array\n+IMAGE_NAMES=(${IMAGE_LIST})\n+\n+# wait 1 minute before checking\n+sleep 1m\n+# get the build id\n+BUILD_ID=$(gcloud builds list --ongoing --filter \"images='gcr.io/${GOOGLE_PROJECT_ID}/gpdb-pxf-dev/${IMAGE_NAMES[0]}:${COMMIT_SHA}'\" | awk 'FNR == 2 {print $1}')\n+\n+# Wait ~ 40 minutes\n+for i in {0..40}\n+do\n+  if [ -n \"$BUILD_ID\" ]; then\n+    echo \"Checking status for build with ID: ${BUILD_ID}\"\n+    # if we have the $BUILD_ID, check the status using it\n+    STATUS=$(gcloud builds list --filter \"status='SUCCESS' AND build_id='${BUILD_ID}'\" 2>&1 | awk 'FNR == 2 {print $1}')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MjY4OA=="}, "originalCommit": {"oid": "473cf763cc41460ce9a03321d4b32cfb85561c51"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7393f1503c70e15ccdd487d745200b391eac04", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/6d7393f1503c70e15ccdd487d745200b391eac04", "committedDate": "2020-05-09T10:40:47Z", "message": "hardcode pxf_home, address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e0be387e6357a3512fcc5c72a51e8c83dbb866c", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/5e0be387e6357a3512fcc5c72a51e8c83dbb866c", "committedDate": "2020-05-09T10:43:26Z", "message": "use beta"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 45, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}