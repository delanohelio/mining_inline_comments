{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNTc2NDQ4", "number": 319, "title": "SecureLoginTest: Fix test pollution", "bodyText": "SecureLoginTest has been failing sporadically on centos7 in Concourse\nduring the compile_pxf job. It turns out that if one of these tests:\n\norg.apache.hadoop.security.LoginSessionTest\norg.apache.hadoop.security.PxfUserGroupInformationTest\n\nruns before SecureLoginTest, we get an error when SecureLogin tries to\nget the default realm when looking up the user. This has to do with\ntest pollution when newing up Hadoop Users, which end up\nsetting the default Kerberos realm for the JVM. This is the Hadoop code\nthat up does that[0].\nThis commit makes sure that\n\nif we change system properties, we change them back after the tests\nwe have default realm set to something so that we don't get empty\nstring\n\n[0] https://github.com/apache/hadoop/blob/826afbeae31ca687bc2f8471dc841b66ed2c6704/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/util/KerberosName.java#L86\nCo-authored-by: Oliver Albertini oalbertini@pivotal.io\nCo-authored-by: Alex Denissov adenissov@pivotal.io", "createdAt": "2020-03-23T18:59:21Z", "url": "https://github.com/greenplum-db/pxf/pull/319", "merged": true, "mergeCommit": {"oid": "82551919f2d1d34d7d905c1de8660a18e75d9863"}, "closed": true, "closedAt": "2020-03-24T01:06:25Z", "author": {"login": "oliverralbertini"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQkAKlABqjMxNTY5MjI3NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQoA2UAFqTM3OTkyODU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0d4a7923ef03aaf59103c1ed297305f77a39fdd", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/f0d4a7923ef03aaf59103c1ed297305f77a39fdd", "committedDate": "2020-03-23T18:57:57Z", "message": "SecureLoginTest: Fix test pollution\n\norg.apache.hadoop.security.{LoginSession,PxfUserGroupInformation}Test\ncause test pollution by newing up Hadoop User objects, which end up\nsetting the default Kerberos realm for the JVM. See this commit where it\nwas fixed here[0].\n\nThis commit makes tests less susceptible to flakes, because we saw that\nSecureLoginTest would fail if the above mentioned tests ran first. We\nonly noticed this behavior on Concourse with centos7.\n\n[0] https://github.com/apache/hadoop/commit/be38e530bb23b134758e29c9101f98cf4e1d2c38#diff-684c0d8f3fe52fd7cdcaefa69205d51d\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}, "afterCommit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/5e6650e514f2729b7e088b4ac0acd97abb28ded2", "committedDate": "2020-03-23T20:05:34Z", "message": "SecureLoginTest: Fix test pollution\n\norg.apache.hadoop.security.{LoginSession,PxfUserGroupInformation}Test\ncause test pollution by newing up Hadoop User objects, which end up\nsetting the default Kerberos realm for the JVM. See this commit where it\nwas fixed here[0].\n\nThis commit makes tests less susceptible to flakes, because we saw that\nSecureLoginTest would fail if the above mentioned tests ran first. We\nonly noticed this behavior on Concourse with centos7.\n\n[0] https://github.com/apache/hadoop/commit/be38e530bb23b134758e29c9101f98cf4e1d2c38#diff-684c0d8f3fe52fd7cdcaefa69205d51d\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzkyMTU2", "url": "https://github.com/greenplum-db/pxf/pull/319#pullrequestreview-379792156", "createdAt": "2020-03-23T20:21:25Z", "commit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDoyMToyNVrOF6Wpow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDoyMToyNVrOF6Wpow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMjgzNQ==", "bodyText": "minor: private methods should go after public/protected", "url": "https://github.com/greenplum-db/pxf/pull/319#discussion_r396732835", "createdAt": "2020-03-23T20:21:25Z", "author": {"login": "frankgh"}, "path": "server/pxf-api/src/test/java/org/greenplum/pxf/api/security/SecureLoginTest.java", "diffHunk": "@@ -34,10 +36,45 @@\n     private static final String PROPERTY_KEY_USER_IMPERSONATION = \"pxf.service.user.impersonation.enabled\";\n     private static final String PROPERTY_KEY_SERVICE_PRINCIPAL = \"pxf.service.kerberos.principal\";\n     private static final String PROPERTY_KEY_SERVICE_KEYTAB = \"pxf.service.kerberos.keytab\";\n+    private static final String PROPERTY_KEY_KERBEROS_KDC = \"java.security.krb5.kdc\";\n+    private static final String PROPERTY_KEY_KERBEROS_REALM = \"java.security.krb5.realm\";\n+    private static String userImpersonationEnabled;\n+    private static String kerberosPrincipal;\n+    private static String kerberosKeytab;\n+    private static String kdcDefault;\n+    private static String realmDefault;\n+\n+    @BeforeClass\n+    public static void setProperties() {\n+        userImpersonationEnabled = System.clearProperty(PROPERTY_KEY_USER_IMPERSONATION);\n+        kerberosPrincipal = System.clearProperty(PROPERTY_KEY_SERVICE_PRINCIPAL);\n+        kerberosKeytab = System.clearProperty(PROPERTY_KEY_SERVICE_KEYTAB);\n+        // simulate presence of krb.conf file\n+        kdcDefault = System.setProperty(PROPERTY_KEY_KERBEROS_KDC, \"localhost\");\n+        realmDefault = System.setProperty(PROPERTY_KEY_KERBEROS_REALM, \"DEFAULT_REALM\");\n+    }\n+\n+    @AfterClass\n+    public static void resetProperties() {\n+        resetProperty(PROPERTY_KEY_USER_IMPERSONATION, userImpersonationEnabled);\n+        resetProperty(PROPERTY_KEY_SERVICE_PRINCIPAL, kerberosPrincipal);\n+        resetProperty(PROPERTY_KEY_SERVICE_KEYTAB, kerberosKeytab);\n+        resetProperty(PROPERTY_KEY_KERBEROS_KDC, kdcDefault);\n+        resetProperty(PROPERTY_KEY_KERBEROS_REALM, realmDefault);\n+    }\n+\n+    private static void resetProperty(String key, String val) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzkyMzQ4", "url": "https://github.com/greenplum-db/pxf/pull/319#pullrequestreview-379792348", "createdAt": "2020-03-23T20:21:42Z", "commit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDoyMTo0MlrOF6WqIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMDoyMTo0MlrOF6WqIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMjk2Mg==", "bodyText": "minor: private methods should go after public/protected", "url": "https://github.com/greenplum-db/pxf/pull/319#discussion_r396732962", "createdAt": "2020-03-23T20:21:42Z", "author": {"login": "frankgh"}, "path": "server/pxf-api/src/test/java/org/apache/hadoop/security/PxfUserGroupInformationTest.java", "diffHunk": "@@ -51,6 +53,32 @@\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n \n+    private static final String PROPERTY_KEY_KERBEROS_KDC = \"java.security.krb5.kdc\";\n+    private static final String PROPERTY_KEY_KERBEROS_REALM = \"java.security.krb5.realm\";\n+    private static String kdcDefault;\n+    private static String realmDefault;\n+\n+    @BeforeClass\n+    public static void setProperties() {\n+        // simulate presence of krb.conf file\n+        kdcDefault = System.setProperty(PROPERTY_KEY_KERBEROS_KDC, \"localhost\");\n+        realmDefault = System.setProperty(PROPERTY_KEY_KERBEROS_REALM, \"DEFAULT_REALM\");\n+    }\n+\n+    @AfterClass\n+    public static void resetProperties() {\n+        resetProperty(PROPERTY_KEY_KERBEROS_KDC, kdcDefault);\n+        resetProperty(PROPERTY_KEY_KERBEROS_REALM, realmDefault);\n+    }\n+\n+    private static void resetProperty(String key, String val) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzkyNjc3", "url": "https://github.com/greenplum-db/pxf/pull/319#pullrequestreview-379792677", "createdAt": "2020-03-23T20:22:12Z", "commit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e6650e514f2729b7e088b4ac0acd97abb28ded2", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/5e6650e514f2729b7e088b4ac0acd97abb28ded2", "committedDate": "2020-03-23T20:05:34Z", "message": "SecureLoginTest: Fix test pollution\n\norg.apache.hadoop.security.{LoginSession,PxfUserGroupInformation}Test\ncause test pollution by newing up Hadoop User objects, which end up\nsetting the default Kerberos realm for the JVM. See this commit where it\nwas fixed here[0].\n\nThis commit makes tests less susceptible to flakes, because we saw that\nSecureLoginTest would fail if the above mentioned tests ran first. We\nonly noticed this behavior on Concourse with centos7.\n\n[0] https://github.com/apache/hadoop/commit/be38e530bb23b134758e29c9101f98cf4e1d2c38#diff-684c0d8f3fe52fd7cdcaefa69205d51d\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}, "afterCommit": {"oid": "3f046d3fa5912a07ed7ed7e663dac4ecd349768e", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/3f046d3fa5912a07ed7ed7e663dac4ecd349768e", "committedDate": "2020-03-23T22:48:54Z", "message": "SecureLoginTest: Fix test pollution\n\nSecureLoginTest has been failing sporadically on centos7 in Concourse\nduring the compile_pxf job. It turns out that if one of these tests:\n\n* org.apache.hadoop.security.LoginSessionTest\n* org.apache.hadoop.security.PxfUserGroupInformationTest\n\nruns before SecureLoginTest, we get an error when SecureLogin tries to\nget the default realm when looking up the user. This has to do with\ntest pollution when newing up Hadoop `User`s, which end up\nsetting the default Kerberos realm for the JVM. This is the Hadoop code\nthat up does that[0].\n\nThis commit makes sure that\n\n* if we change system properties, we change them back after the tests\n* we have default realm set to something so that we don't get empty\n  string\n\n[0] https://github.com/apache/hadoop/blob/826afbeae31ca687bc2f8471dc841b66ed2c6704/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/util/KerberosName.java#L86\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82551919f2d1d34d7d905c1de8660a18e75d9863", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/82551919f2d1d34d7d905c1de8660a18e75d9863", "committedDate": "2020-03-23T23:12:17Z", "message": "SecureLoginTest: Fix test pollution\n\nSecureLoginTest has been failing sporadically on centos7 in Concourse\nduring the compile_pxf job. It turns out that if one of these tests:\n\n* org.apache.hadoop.security.LoginSessionTest\n* org.apache.hadoop.security.PxfUserGroupInformationTest\n\nruns before SecureLoginTest, we get an error when SecureLogin tries to\nget the default realm when looking up the user. This has to do with\ntest pollution when newing up Hadoop `User`s, which end up\nsetting the default Kerberos realm for the JVM. This is the Hadoop code\nthat up does that[0].\n\nThis commit makes sure that\n\n* if we change system properties, we change them back after the tests\n* we have default realm set to something so that we don't get empty\n  string\n\n[0] https://github.com/apache/hadoop/blob/826afbeae31ca687bc2f8471dc841b66ed2c6704/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/util/KerberosName.java#L86\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f046d3fa5912a07ed7ed7e663dac4ecd349768e", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/3f046d3fa5912a07ed7ed7e663dac4ecd349768e", "committedDate": "2020-03-23T22:48:54Z", "message": "SecureLoginTest: Fix test pollution\n\nSecureLoginTest has been failing sporadically on centos7 in Concourse\nduring the compile_pxf job. It turns out that if one of these tests:\n\n* org.apache.hadoop.security.LoginSessionTest\n* org.apache.hadoop.security.PxfUserGroupInformationTest\n\nruns before SecureLoginTest, we get an error when SecureLogin tries to\nget the default realm when looking up the user. This has to do with\ntest pollution when newing up Hadoop `User`s, which end up\nsetting the default Kerberos realm for the JVM. This is the Hadoop code\nthat up does that[0].\n\nThis commit makes sure that\n\n* if we change system properties, we change them back after the tests\n* we have default realm set to something so that we don't get empty\n  string\n\n[0] https://github.com/apache/hadoop/blob/826afbeae31ca687bc2f8471dc841b66ed2c6704/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/util/KerberosName.java#L86\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}, "afterCommit": {"oid": "82551919f2d1d34d7d905c1de8660a18e75d9863", "author": {"user": {"login": "oliverralbertini", "name": "Oliver Albertini"}}, "url": "https://github.com/greenplum-db/pxf/commit/82551919f2d1d34d7d905c1de8660a18e75d9863", "committedDate": "2020-03-23T23:12:17Z", "message": "SecureLoginTest: Fix test pollution\n\nSecureLoginTest has been failing sporadically on centos7 in Concourse\nduring the compile_pxf job. It turns out that if one of these tests:\n\n* org.apache.hadoop.security.LoginSessionTest\n* org.apache.hadoop.security.PxfUserGroupInformationTest\n\nruns before SecureLoginTest, we get an error when SecureLogin tries to\nget the default realm when looking up the user. This has to do with\ntest pollution when newing up Hadoop `User`s, which end up\nsetting the default Kerberos realm for the JVM. This is the Hadoop code\nthat up does that[0].\n\nThis commit makes sure that\n\n* if we change system properties, we change them back after the tests\n* we have default realm set to something so that we don't get empty\n  string\n\n[0] https://github.com/apache/hadoop/blob/826afbeae31ca687bc2f8471dc841b66ed2c6704/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/util/KerberosName.java#L86\n\nCo-authored-by: Oliver Albertini <oalbertini@pivotal.io>\nCo-authored-by: Alex Denissov <adenissov@pivotal.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5OTI4NTYx", "url": "https://github.com/greenplum-db/pxf/pull/319#pullrequestreview-379928561", "createdAt": "2020-03-24T00:46:00Z", "commit": {"oid": "82551919f2d1d34d7d905c1de8660a18e75d9863"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 16, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}