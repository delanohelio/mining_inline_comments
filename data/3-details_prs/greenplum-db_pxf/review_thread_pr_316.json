{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2OTA2MTg4", "number": 316, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjowNjowMVrODn43Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzowODo0OVrODoAkuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMTUyNjU1OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjowNjowMVrOF2Jf7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQxMzo0NDoyMVrOF2ZwsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw==", "bodyText": "Shouldn't we ignore case on the value as well?", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392323053", "createdAt": "2020-03-13T16:06:01Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equals(\"true\", value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae57ca144509219ad8a35d66ca732d4802dba7f5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4Nzk1Nw==", "bodyText": "Did you make a change here?", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392487957", "createdAt": "2020-03-13T21:25:01Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equals(\"true\", value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw=="}, "originalCommit": {"oid": "ae57ca144509219ad8a35d66ca732d4802dba7f5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4OTQ4OQ==", "bodyText": "it is equalsIgnoreCase now", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392589489", "createdAt": "2020-03-14T13:44:21Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equals(\"true\", value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw=="}, "originalCommit": {"oid": "ae57ca144509219ad8a35d66ca732d4802dba7f5"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjcyMDM2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMjoyNDo0NlrOF2VDiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMjo1NDo1N1rOF2VgUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjM5NQ==", "bodyText": "why throw this exception ? We can't recover from it, might as well throw RuntimeException and simplify method signatures", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392512395", "createdAt": "2020-03-13T22:24:46Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTc2Mw==", "bodyText": "yeah, good point", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392519763", "createdAt": "2020-03-13T22:54:57Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjM5NQ=="}, "originalCommit": {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjczMTUxOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMjozMTowNVrOF2VKGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzowNTo1N1rOF2VqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ==", "bodyText": "should we have unit tests that test that we trigger the logic on the header value, case insensitive and that decoding is correct ?", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392514075", "createdAt": "2020-03-13T22:31:05Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());\n                 if (value == null) continue;\n \n-                // Converting to value UTF-8 encoding\n                 String key = entry.getKey();\n-                value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);\n+                if (decodeHeaderValue && StringUtils.startsWithIgnoreCase(key, PROP_PREFIX)) {\n+                    value = URLDecoder.decode(value, StandardCharsets.UTF_8.name());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTcxMw==", "bodyText": "yes! definitely", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392519713", "createdAt": "2020-03-13T22:54:42Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());\n                 if (value == null) continue;\n \n-                // Converting to value UTF-8 encoding\n                 String key = entry.getKey();\n-                value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);\n+                if (decodeHeaderValue && StringUtils.startsWithIgnoreCase(key, PROP_PREFIX)) {\n+                    value = URLDecoder.decode(value, StandardCharsets.UTF_8.name());\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ=="}, "originalCommit": {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyMjI4Nw==", "bodyText": "@denalex  I just added unit tests", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392522287", "createdAt": "2020-03-13T23:05:57Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());\n                 if (value == null) continue;\n \n-                // Converting to value UTF-8 encoding\n                 String key = entry.getKey();\n-                value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);\n+                if (decodeHeaderValue && StringUtils.startsWithIgnoreCase(key, PROP_PREFIX)) {\n+                    value = URLDecoder.decode(value, StandardCharsets.UTF_8.name());\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ=="}, "originalCommit": {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjc5MDM1OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzowODo0OVrOF2VtIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzowODo0OVrOF2VtIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyMzA0MA==", "bodyText": "@oliverralbertini the logic was moved to the getValue method", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392523040", "createdAt": "2020-03-13T23:08:49Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +393,55 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n         RequestMap(MultivaluedMap<String, String> requestHeaders) {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80dd87388e608ba5966fd35b166e60b43ff9553f"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3600, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}