{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODE3MjA5", "number": 394, "title": "Fix queries with limit", "bodyText": "There is an issue with async threads, where we are swallowing the\nClientAbortException when Greenplum closes the connection. This lack of\ncommunication that an IOException has occurred is causing problems with\nsubsequent requests. Re-throwing the exception allows Spring MVC to\ncatch it and mark the connection as broken so it stops writing.\nThe short version of what happens is:\n\nclient drops connection async thread is writing to\nTomcat cleans this up\nRequest/Response/Processor gets put back in pool\nNew connections come in\nProcessor above gets allocated to one of them\nOriginal async thread tries writing again, fails and puts the processor into an error state\nTomcat tries to process the new connection\nProcessor is in an error state so the connection is closed before the request is even read\n\nCo-authored-by: Mark Thomas thomasma@vmware.com\nCo-authored-by: Francisco Guerrero aguerrero@pivotal.io", "createdAt": "2020-06-23T20:56:57Z", "url": "https://github.com/greenplum-db/pxf/pull/394", "merged": true, "mergeCommit": {"oid": "2968c1e45a5cc2e897180fdd5513397f2105eb7b"}, "closed": true, "closedAt": "2020-06-24T22:50:40Z", "author": {"login": "frankgh"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuLp9TgH2gAyNDM4ODE3MjA5OjlmMjlmZWEwOTM5ZjkzMDExYzE4ZjM4ZjAyZWJkYWE4NDI1NTFmNmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuiD7uAFqTQzNzA1NzU1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f29fea0939f93011c18f38f02ebdaa842551f6c", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/9f29fea0939f93011c18f38f02ebdaa842551f6c", "committedDate": "2020-06-23T20:41:23Z", "message": "Fix queries with limit\n\nThere is an issue with async threads, where we are swallowing the\nClientAbortException when Greenplum closes the connection. This lack of\ncommunication that an IOException has occurred is causing problems with\nsubsequent requests. Re-throwing the exception allows Spring MVC to\ncatch it and mark the connection as broken so it stops writing.\n\nThe short version of what happens is:\n- client drops connection async thread is writing to\n- Tomcat cleans this up\n- Request/Response/Processor gets put back in pool\n- New connections come in\n- Processor above gets allocated to one of them\n- Original async thread tries writing again, fails and puts the processor into an error state\n- Tomcat tries to process the new connection\n- Processor is in an error state so the connection is closed before the request is even read\n\nCo-authored-by: Mark Thomas <thomasma@vmware.com>\nCo-authored-by: Francisco Guerrero <aguerrero@pivotal.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTQwODEw", "url": "https://github.com/greenplum-db/pxf/pull/394#pullrequestreview-436940810", "createdAt": "2020-06-24T19:24:56Z", "commit": {"oid": "9f29fea0939f93011c18f38f02ebdaa842551f6c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyNDo1NlrOGof9Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOTozMjoyN1rOGogL4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExOTc5MQ==", "bodyText": "I don't know if we even should log this as error, since this is not really an error condition when GPDB routinely does this. maybe use WARN ?", "url": "https://github.com/greenplum-db/pxf/pull/394#discussion_r445119791", "createdAt": "2020-06-24T19:24:56Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "diffHunk": "@@ -73,17 +73,24 @@ private Void writeToInternal(OutputStream out) throws IOException {\n                 ++recordCount;\n             }\n             LOG.debug(\"Finished streaming fragment {} of resource {}, {} records.\", fragment, dataDir, recordCount);\n-        } catch (ClientAbortException e) {\n-            // Occurs whenever client (GPDB) decides to end the connection\n-            if (LOG.isDebugEnabled()) {\n-                // Stacktrace in debug\n-                LOG.debug(\"Remote connection closed by GPDB\", e);\n+        } catch (Exception e) {\n+            IOException ioe;\n+            if (e instanceof ClientAbortException) {\n+                // Occurs whenever client (GPDB) decides to end the connection\n+                if (LOG.isDebugEnabled()) {\n+                    // Stacktrace in debug\n+                    LOG.debug(\"Remote connection closed by GPDB\", e);\n+                } else {\n+                    LOG.error(\"Remote connection closed by GPDB (Enable debug for stacktrace)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f29fea0939f93011c18f38f02ebdaa842551f6c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEyMzA0OQ==", "bodyText": "I kinda like the previous logic better, where we handle ClientAbortException only and the common block of wrapping any exception as IOException, unless it is already an IOException.", "url": "https://github.com/greenplum-db/pxf/pull/394#discussion_r445123049", "createdAt": "2020-06-24T19:31:20Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "diffHunk": "@@ -73,17 +73,24 @@ private Void writeToInternal(OutputStream out) throws IOException {\n                 ++recordCount;\n             }\n             LOG.debug(\"Finished streaming fragment {} of resource {}, {} records.\", fragment, dataDir, recordCount);\n-        } catch (ClientAbortException e) {\n-            // Occurs whenever client (GPDB) decides to end the connection\n-            if (LOG.isDebugEnabled()) {\n-                // Stacktrace in debug\n-                LOG.debug(\"Remote connection closed by GPDB\", e);\n+        } catch (Exception e) {\n+            IOException ioe;\n+            if (e instanceof ClientAbortException) {\n+                // Occurs whenever client (GPDB) decides to end the connection\n+                if (LOG.isDebugEnabled()) {\n+                    // Stacktrace in debug\n+                    LOG.debug(\"Remote connection closed by GPDB\", e);\n+                } else {\n+                    LOG.error(\"Remote connection closed by GPDB (Enable debug for stacktrace)\");\n+                }\n+                ioe = (ClientAbortException) e;\n+            } else if (e instanceof IOException) {\n+                ioe = (IOException) e;\n             } else {\n-                LOG.error(\"Remote connection closed by GPDB (Enable debug for stacktrace)\");\n+                ioe = new IOException(e.getMessage(), e);\n             }\n-            throw e;\n-        } catch (Exception e) {\n-            throw e instanceof IOException ? (IOException) e : new IOException(e.getMessage(), e);\n+            // Re-throw the exception so Spring MVC is aware that an IO error has occurred\n+            throw ioe;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f29fea0939f93011c18f38f02ebdaa842551f6c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEyMzU1NQ==", "bodyText": "why just not throw cae ?", "url": "https://github.com/greenplum-db/pxf/pull/394#discussion_r445123555", "createdAt": "2020-06-24T19:32:27Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/WritableResource.java", "diffHunk": "@@ -165,6 +165,8 @@ public WritableResource(BridgeFactory bridgeFactory, SecurityService securitySer\n                 } else {\n                     LOG.error(\"Remote connection closed by GPDB (Enable debug for stacktrace)\");\n                 }\n+                ex = cae;\n+                throw ex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f29fea0939f93011c18f38f02ebdaa842551f6c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebb8587361c9d8ab74a57e14e445af6f349764d", "author": {"user": null}, "url": "https://github.com/greenplum-db/pxf/commit/2ebb8587361c9d8ab74a57e14e445af6f349764d", "committedDate": "2020-06-24T19:48:38Z", "message": "Address PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDU3NTU0", "url": "https://github.com/greenplum-db/pxf/pull/394#pullrequestreview-437057554", "createdAt": "2020-06-24T22:47:40Z", "commit": {"oid": "2ebb8587361c9d8ab74a57e14e445af6f349764d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 109, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}