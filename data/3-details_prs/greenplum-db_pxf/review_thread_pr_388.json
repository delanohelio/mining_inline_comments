{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2Nzg5MDU4", "number": 388, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjoyMDoxOFrOEG7kdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo0OTowMVrOEG76RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NzAyOTAyOnYy", "diffSide": "RIGHT", "path": "automation/tincrepo/main/pxf/features/hive/errors/partitionNameMismatch/expected/query01.ans", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjoyMDoxOFrOGmCESA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo1ODozNFrOGmCy6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMjkzNg==", "bodyText": "would \"Ensure ...\" better go into HINT field or that is a separate effort ?", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442532936", "createdAt": "2020-06-18T22:20:18Z", "author": {"login": "denalex"}, "path": "automation/tincrepo/main/pxf/features/hive/errors/partitionNameMismatch/expected/query01.ans", "diffHunk": "@@ -18,5 +15,8 @@\n --\n -- end_matchsubs\n SELECT * from pxf_hive_small_data ORDER BY t1;\n-ERROR:  remote component error (500) from 'SOME_IP:SOME_PORT':  type  Exception Report   Message  Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case   Description  The server encountered an unexpected condition that prevented it from fulfilling the request.   Exception   java.lang.IllegalArgumentException: Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case (libchurl.c:xxx)\n+ERROR:  PXF server error : Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDg3Mw==", "bodyText": "Good point. I can do this", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442544873", "createdAt": "2020-06-18T22:58:34Z", "author": {"login": "frankgh"}, "path": "automation/tincrepo/main/pxf/features/hive/errors/partitionNameMismatch/expected/query01.ans", "diffHunk": "@@ -18,5 +15,8 @@\n --\n -- end_matchsubs\n SELECT * from pxf_hive_small_data ORDER BY t1;\n-ERROR:  remote component error (500) from 'SOME_IP:SOME_PORT':  type  Exception Report   Message  Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case   Description  The server encountered an unexpected condition that prevented it from fulfilling the request.   Exception   java.lang.IllegalArgumentException: Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case (libchurl.c:xxx)\n+ERROR:  PXF server error : Column 's2' does not exist in the Hive schema or Hive Partition. Ensure the column or partition exists and check the name spelling and case", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMjkzNg=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NzAzNTMwOnYy", "diffSide": "RIGHT", "path": "server/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjoyMzoyMlrOGmCIUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo1ODoyNlrOGmCyxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMzk3MQ==", "bodyText": "I thought we are not using log4j 1.2 anymore", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442533971", "createdAt": "2020-06-18T22:23:22Z", "author": {"login": "denalex"}, "path": "server/build.gradle", "diffHunk": "@@ -82,8 +84,12 @@ configure(javaProjects) {\n             dependency(\"com.fasterxml.jackson.core:jackson-core:2.11.0\")\n             dependency(\"com.fasterxml.jackson.core:jackson-annotations:2.11.0\")\n \n-            dependency(\"org.apache.httpcomponents:httpcore:4.4.9\")\n-            dependency(\"org.apache.httpcomponents:httpclient:4.5.5\")\n+            dependency(\"joda-time:joda-time:2.8.1\")\n+\n+            dependency(\"org.apache.commons:commons-lang3:3.10\")\n+\n+            dependency(\"org.slf4j:slf4j-api:1.7.30\")\n+            dependency(\"org.slf4j:slf4j-log4j12:1.7.30\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDgzNw==", "bodyText": "it's a transitive dependency needed by some hadoop jar. A ClassNotFoundException is thrown if misssing", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442544837", "createdAt": "2020-06-18T22:58:26Z", "author": {"login": "frankgh"}, "path": "server/build.gradle", "diffHunk": "@@ -82,8 +84,12 @@ configure(javaProjects) {\n             dependency(\"com.fasterxml.jackson.core:jackson-core:2.11.0\")\n             dependency(\"com.fasterxml.jackson.core:jackson-annotations:2.11.0\")\n \n-            dependency(\"org.apache.httpcomponents:httpcore:4.4.9\")\n-            dependency(\"org.apache.httpcomponents:httpclient:4.5.5\")\n+            dependency(\"joda-time:joda-time:2.8.1\")\n+\n+            dependency(\"org.apache.commons:commons-lang3:3.10\")\n+\n+            dependency(\"org.slf4j:slf4j-api:1.7.30\")\n+            dependency(\"org.slf4j:slf4j-log4j12:1.7.30\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMzk3MQ=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NzA2NjkzOnYy", "diffSide": "RIGHT", "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjozOTo0NFrOGmCcgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMToyNzo0M1rOGmFKIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzOTEzNw==", "bodyText": "what if it is a subclass, does it need configuration also ? ideally should check class-level isAssignableFrom but this is existing code, I guess, so no need to change.", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442539137", "createdAt": "2020-06-18T22:39:44Z", "author": {"login": "denalex"}, "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java", "diffHunk": "@@ -115,25 +110,27 @@\n     }\n \n     /**\n-     * Verifies modifiers are null or integers.\n-     * Modifier is a value assigned to a type,\n-     * e.g. size of a varchar - varchar(size).\n+     * Creates the partition InputFormat.\n      *\n-     * @param modifiers type modifiers to be verified\n-     * @return whether modifiers are null or integers\n+     * @param inputFormatName input format class name\n+     * @param jobConf         configuration data for the Hadoop framework\n+     * @return a {@link org.apache.hadoop.mapred.InputFormat} derived object\n+     * @throws Exception if failed to create input format\n      */\n-    private static boolean verifyIntegerModifiers(String[] modifiers) {\n-        if (modifiers == null) {\n-            return true;\n-        }\n-        for (String modifier : modifiers) {\n-            if (StringUtils.isBlank(modifier) || !StringUtils.isNumeric(modifier)) {\n-                return false;\n-            }\n+    public InputFormat<?, ?> makeInputFormat(String inputFormatName,\n+                                             JobConf jobConf)\n+            throws Exception {\n+        Class<?> c = Class.forName(inputFormatName, true,\n+                JavaUtils.getClassLoader());\n+        InputFormat<?, ?> inputFormat = (InputFormat<?, ?>) c.getDeclaredConstructor().newInstance();\n+\n+        if (\"org.apache.hadoop.mapred.TextInputFormat\".equals(inputFormatName)) {\n+            // TextInputFormat needs a special configuration\n+            ((TextInputFormat) inputFormat).configure(jobConf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MDEzOA==", "bodyText": "We can change it I guess", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442580138", "createdAt": "2020-06-19T01:13:08Z", "author": {"login": "frankgh"}, "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java", "diffHunk": "@@ -115,25 +110,27 @@\n     }\n \n     /**\n-     * Verifies modifiers are null or integers.\n-     * Modifier is a value assigned to a type,\n-     * e.g. size of a varchar - varchar(size).\n+     * Creates the partition InputFormat.\n      *\n-     * @param modifiers type modifiers to be verified\n-     * @return whether modifiers are null or integers\n+     * @param inputFormatName input format class name\n+     * @param jobConf         configuration data for the Hadoop framework\n+     * @return a {@link org.apache.hadoop.mapred.InputFormat} derived object\n+     * @throws Exception if failed to create input format\n      */\n-    private static boolean verifyIntegerModifiers(String[] modifiers) {\n-        if (modifiers == null) {\n-            return true;\n-        }\n-        for (String modifier : modifiers) {\n-            if (StringUtils.isBlank(modifier) || !StringUtils.isNumeric(modifier)) {\n-                return false;\n-            }\n+    public InputFormat<?, ?> makeInputFormat(String inputFormatName,\n+                                             JobConf jobConf)\n+            throws Exception {\n+        Class<?> c = Class.forName(inputFormatName, true,\n+                JavaUtils.getClassLoader());\n+        InputFormat<?, ?> inputFormat = (InputFormat<?, ?>) c.getDeclaredConstructor().newInstance();\n+\n+        if (\"org.apache.hadoop.mapred.TextInputFormat\".equals(inputFormatName)) {\n+            // TextInputFormat needs a special configuration\n+            ((TextInputFormat) inputFormat).configure(jobConf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzOTEzNw=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MzU4NA==", "bodyText": "instead of harcoding the string , I am doing class.getName now", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442583584", "createdAt": "2020-06-19T01:27:43Z", "author": {"login": "frankgh"}, "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java", "diffHunk": "@@ -115,25 +110,27 @@\n     }\n \n     /**\n-     * Verifies modifiers are null or integers.\n-     * Modifier is a value assigned to a type,\n-     * e.g. size of a varchar - varchar(size).\n+     * Creates the partition InputFormat.\n      *\n-     * @param modifiers type modifiers to be verified\n-     * @return whether modifiers are null or integers\n+     * @param inputFormatName input format class name\n+     * @param jobConf         configuration data for the Hadoop framework\n+     * @return a {@link org.apache.hadoop.mapred.InputFormat} derived object\n+     * @throws Exception if failed to create input format\n      */\n-    private static boolean verifyIntegerModifiers(String[] modifiers) {\n-        if (modifiers == null) {\n-            return true;\n-        }\n-        for (String modifier : modifiers) {\n-            if (StringUtils.isBlank(modifier) || !StringUtils.isNumeric(modifier)) {\n-                return false;\n-            }\n+    public InputFormat<?, ?> makeInputFormat(String inputFormatName,\n+                                             JobConf jobConf)\n+            throws Exception {\n+        Class<?> c = Class.forName(inputFormatName, true,\n+                JavaUtils.getClassLoader());\n+        InputFormat<?, ?> inputFormat = (InputFormat<?, ?>) c.getDeclaredConstructor().newInstance();\n+\n+        if (\"org.apache.hadoop.mapred.TextInputFormat\".equals(inputFormatName)) {\n+            // TextInputFormat needs a special configuration\n+            ((TextInputFormat) inputFormat).configure(jobConf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzOTEzNw=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NzA3MjcxOnYy", "diffSide": "RIGHT", "path": "server/pxf-jdbc/src/main/java/org/greenplum/pxf/plugins/jdbc/JdbcAccessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo0MjozN1rOGmCgOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMToxMjo1M1rOGmE8fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MDA5MQ==", "bodyText": "what if someone in China runs this ? would their default charset be different ?", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442540091", "createdAt": "2020-06-18T22:42:37Z", "author": {"login": "denalex"}, "path": "server/pxf-jdbc/src/main/java/org/greenplum/pxf/plugins/jdbc/JdbcAccessor.java", "diffHunk": "@@ -325,7 +326,7 @@ private String getQueryText() {\n             if (LOG.isDebugEnabled()) {\r\n                 LOG.debug(\"Reading text of query={} from {}\", queryName, queryFile.getCanonicalPath());\r\n             }\r\n-            queryText = FileUtils.readFileToString(queryFile);\r\n+            queryText = FileUtils.readFileToString(queryFile, Charset.defaultCharset());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MDA5Mg==", "bodyText": "FileUtils.readFileToString(String) is deprecated, so I switched to using FileUtils.readFileToString(String, Charset) with the default implementation. Effectively making no changes to the current implementation.", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442580092", "createdAt": "2020-06-19T01:12:53Z", "author": {"login": "frankgh"}, "path": "server/pxf-jdbc/src/main/java/org/greenplum/pxf/plugins/jdbc/JdbcAccessor.java", "diffHunk": "@@ -325,7 +326,7 @@ private String getQueryText() {\n             if (LOG.isDebugEnabled()) {\r\n                 LOG.debug(\"Reading text of query={} from {}\", queryName, queryFile.getCanonicalPath());\r\n             }\r\n-            queryText = FileUtils.readFileToString(queryFile);\r\n+            queryText = FileUtils.readFileToString(queryFile, Charset.defaultCharset());\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MDA5MQ=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NzA4NDg0OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/resources/hiveserver2-site.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo0OTowMVrOGmCn-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo1Nzo0MlrOGmCx8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjA3Mw==", "bodyText": "what are these new files for ?", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442542073", "createdAt": "2020-06-18T22:49:01Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/resources/hiveserver2-site.xml", "diffHunk": "@@ -0,0 +1,15 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?><configuration/>\n+<!--\n+  This file is required because initialization of HiveConf fails when it\n+  attempts to find the file in the classloader, then in HIVE_CONF_DIR, then\n+  HIVE_HOME, and finally it tries to find the file in the parent directory\n+  of the jar \"new File(new File(jarUri).getParentFile(), nameInConf)\".\n+  However, because the jar is an \"opaque\" jar (A URI is opaque if, and only if,\n+  it is absolute and its scheme-specific part does not begin with a slash\n+  character ('/'). An opaque URI has a scheme, a scheme-specific part, and\n+  possibly a fragment; all other components are undefined) the `File(jarUri)`\n+  call throws an IllegalArgumentException which causes the HiveConf class to\n+  completely fail to load. Adding this file, allows the `findConfigFile` method\n+  in HiveConf find the desired file by doing `classLoader.getResource(name)`\n+  and it prevents going to the failing branch of the code.\n+-->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDYyNg==", "bodyText": "HiveConf was failing to load because the static { } initialization block would throw an exception. I reported this issue https://issues.apache.org/jira/browse/HIVE-23700\nAdding these files allows HiveConf static block to succeed. Without these files, HiveConf fails to load and ClassNotFoundException is thrown", "url": "https://github.com/greenplum-db/pxf/pull/388#discussion_r442544626", "createdAt": "2020-06-18T22:57:42Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/resources/hiveserver2-site.xml", "diffHunk": "@@ -0,0 +1,15 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?><configuration/>\n+<!--\n+  This file is required because initialization of HiveConf fails when it\n+  attempts to find the file in the classloader, then in HIVE_CONF_DIR, then\n+  HIVE_HOME, and finally it tries to find the file in the parent directory\n+  of the jar \"new File(new File(jarUri).getParentFile(), nameInConf)\".\n+  However, because the jar is an \"opaque\" jar (A URI is opaque if, and only if,\n+  it is absolute and its scheme-specific part does not begin with a slash\n+  character ('/'). An opaque URI has a scheme, a scheme-specific part, and\n+  possibly a fragment; all other components are undefined) the `File(jarUri)`\n+  call throws an IllegalArgumentException which causes the HiveConf class to\n+  completely fail to load. Adding this file, allows the `findConfigFile` method\n+  in HiveConf find the desired file by doing `classLoader.getResource(name)`\n+  and it prevents going to the failing branch of the code.\n+-->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjA3Mw=="}, "originalCommit": {"oid": "fa4094f20ae35f9e401f8a43dc97faf940519b90"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3684, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}