{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NDgwODY4", "number": 383, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1OTo0OVrOEGaiUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMTozODowOVrOEHRGOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTYxNjgxOnYy", "diffSide": "RIGHT", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1OTo0OVrOGlMjTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMDoyMzoyOVrOGmjrrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NjE0Mw==", "bodyText": "I'm okay with this approach, but I'm wondering if we can use use a switch here instead? also, I'm wondering why we don't use the OneField type here and instead type check the value?", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r441656143", "createdAt": "2020-06-17T15:59:49Z", "author": {"login": "frankgh"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -145,6 +144,10 @@ public OneRow setFields(List<OneField> record) {\n             if (field.val instanceof byte[]) {\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n             }\n+            // Avro doesn't have a short, just an int type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4e0b54f12fdf3f965bb1170278bf54b152f62f4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4MzY5NA==", "bodyText": "Couldn't figure out how to do a switch with non-constant types (DataType.BYTEA.getOID(), etc.) but this does seem better now", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443083694", "createdAt": "2020-06-20T00:23:29Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -145,6 +144,10 @@ public OneRow setFields(List<OneField> record) {\n             if (field.val instanceof byte[]) {\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n             }\n+            // Avro doesn't have a short, just an int type", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NjE0Mw=="}, "originalCommit": {"oid": "c4e0b54f12fdf3f965bb1170278bf54b152f62f4"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTYyMzM5OnYy", "diffSide": "RIGHT", "path": "automation/src/test/java/org/greenplum/pxf/automation/features/avro/HdfsWritableAvroTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjowMToyOFrOGlMnXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjowMToyOFrOGlMnXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NzE4MQ==", "bodyText": "these should be static final String arrays\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String[] avroPrimitiveWritableTableCols = new String[]{\n          \n          \n            \n                private static final String[] AVRO_PRIMITIVE_WRITABLE_TABLE_COLS = new String[]{", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r441657181", "createdAt": "2020-06-17T16:01:28Z", "author": {"login": "frankgh"}, "path": "automation/src/test/java/org/greenplum/pxf/automation/features/avro/HdfsWritableAvroTest.java", "diffHunk": "@@ -24,8 +24,21 @@\n \n     private ReadableExternalTable readableExternalTable;\n     private ArrayList<File> filesToDelete;\n-    private final String[] avroPrimitiveTableCols = new String[]{\n+    private final String[] avroPrimitiveWritableTableCols = new String[]{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4e0b54f12fdf3f965bb1170278bf54b152f62f4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTYyNTEwOnYy", "diffSide": "RIGHT", "path": "automation/src/test/java/org/greenplum/pxf/automation/features/avro/HdfsWritableAvroTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjowMTo1NVrOGlMobQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjowMTo1NVrOGlMobQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NzQ1Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String[] avroPrimitiveReadableTableCols = new String[]{\n          \n          \n            \n                private static final String[] AVRO_PRIMITIVE_READABLE_TABLE_COLS = new String[]{", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r441657453", "createdAt": "2020-06-17T16:01:55Z", "author": {"login": "frankgh"}, "path": "automation/src/test/java/org/greenplum/pxf/automation/features/avro/HdfsWritableAvroTest.java", "diffHunk": "@@ -24,8 +24,21 @@\n \n     private ReadableExternalTable readableExternalTable;\n     private ArrayList<File> filesToDelete;\n-    private final String[] avroPrimitiveTableCols = new String[]{\n+    private final String[] avroPrimitiveWritableTableCols = new String[]{\n             \"type_int int\",\n+            \"type_smallint smallint\", // smallint\n+            \"type_long bigint\",\n+            \"type_float real\",\n+            \"type_double float8\",\n+            \"type_string text\",\n+            \"type_bytes bytea\",\n+            \"type_boolean bool\"\n+    };\n+    // values that were written from a smallint column (see above type_smallint)\n+    // must be read back into integer columns\n+    private final String[] avroPrimitiveReadableTableCols = new String[]{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4e0b54f12fdf3f965bb1170278bf54b152f62f4"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MDU1NTkyOnYy", "diffSide": "RIGHT", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMTozNzo0NVrOGmkGDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxODo0NjowM1rOGnMyuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ0NA==", "bodyText": "wonder if you really need double cast, would just (int) field.val work ?", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443090444", "createdAt": "2020-06-20T01:37:45Z", "author": {"login": "denalex"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -141,9 +140,12 @@ public OneRow setFields(List<OneField> record) {\n         GenericRecord genericRecord = new GenericData.Record((Schema) context.getMetadata());\n         int cnt = 0;\n         for (OneField field : record) {\n-            // Avro does not seem to understand regular byte arrays\n-            if (field.val instanceof byte[]) {\n+            if (field.type == DataType.BYTEA.getOID()) {\n+                // Avro does not seem to understand regular byte arrays\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n+            } else if (field.type == DataType.SMALLINT.getOID()) {\n+                // Avro doesn't have a short, just an int type\n+                field.val = (int) (short) field.val;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzODk5MQ==", "bodyText": "With just the single cast, the editor warns of redundant cast. An alternative is this if you prefer:\nfield.val = ((Short) field.val).intValue();", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443138991", "createdAt": "2020-06-20T15:26:11Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -141,9 +140,12 @@ public OneRow setFields(List<OneField> record) {\n         GenericRecord genericRecord = new GenericData.Record((Schema) context.getMetadata());\n         int cnt = 0;\n         for (OneField field : record) {\n-            // Avro does not seem to understand regular byte arrays\n-            if (field.val instanceof byte[]) {\n+            if (field.type == DataType.BYTEA.getOID()) {\n+                // Avro does not seem to understand regular byte arrays\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n+            } else if (field.type == DataType.SMALLINT.getOID()) {\n+                // Avro doesn't have a short, just an int type\n+                field.val = (int) (short) field.val;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ0NA=="}, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzOTQxNQ==", "bodyText": "I think it's fine to keep it as is", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443139415", "createdAt": "2020-06-20T15:32:42Z", "author": {"login": "frankgh"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -141,9 +140,12 @@ public OneRow setFields(List<OneField> record) {\n         GenericRecord genericRecord = new GenericData.Record((Schema) context.getMetadata());\n         int cnt = 0;\n         for (OneField field : record) {\n-            // Avro does not seem to understand regular byte arrays\n-            if (field.val instanceof byte[]) {\n+            if (field.type == DataType.BYTEA.getOID()) {\n+                // Avro does not seem to understand regular byte arrays\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n+            } else if (field.type == DataType.SMALLINT.getOID()) {\n+                // Avro doesn't have a short, just an int type\n+                field.val = (int) (short) field.val;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ0NA=="}, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NzI0Mw==", "bodyText": "To expand on this a bit, when just using (Integer) field.val or (int) field.val I see this error when the writable table has SMALLINT type:\ntype  Exception report   message   java.lang.Short cannot be cast to java.lang.Integer\nWhen casting between primitive types the above should work fine, but with reference types (I think) you need to cast twice in order to affect the underlying data (cast of a reference just changes the reference, not the data itself).", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443757243", "createdAt": "2020-06-22T18:46:03Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -141,9 +140,12 @@ public OneRow setFields(List<OneField> record) {\n         GenericRecord genericRecord = new GenericData.Record((Schema) context.getMetadata());\n         int cnt = 0;\n         for (OneField field : record) {\n-            // Avro does not seem to understand regular byte arrays\n-            if (field.val instanceof byte[]) {\n+            if (field.type == DataType.BYTEA.getOID()) {\n+                // Avro does not seem to understand regular byte arrays\n                 field.val = ByteBuffer.wrap((byte[]) field.val);\n+            } else if (field.type == DataType.SMALLINT.getOID()) {\n+                // Avro doesn't have a short, just an int type\n+                field.val = (int) (short) field.val;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ0NA=="}, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MDU1NjA4OnYy", "diffSide": "RIGHT", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMTozODowOVrOGmkGIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNToyNjo1N1rOGmnD2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ2NQ==", "bodyText": "wonder why this is no longer a member field ?", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443090465", "createdAt": "2020-06-20T01:38:09Z", "author": {"login": "denalex"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -84,7 +83,7 @@ public AvroResolver() {\n     public void initialize(RequestContext requestContext) {\n         super.initialize(requestContext);\n \n-        hcfsType = HcfsType.getHcfsType(configuration, context);\n+        HcfsType hcfsType = HcfsType.getHcfsType(configuration, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzOTAzMg==", "bodyText": "Was only needed for initialize().", "url": "https://github.com/greenplum-db/pxf/pull/383#discussion_r443139032", "createdAt": "2020-06-20T15:26:57Z", "author": {"login": "oliverralbertini"}, "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/AvroResolver.java", "diffHunk": "@@ -84,7 +83,7 @@ public AvroResolver() {\n     public void initialize(RequestContext requestContext) {\n         super.initialize(requestContext);\n \n-        hcfsType = HcfsType.getHcfsType(configuration, context);\n+        HcfsType hcfsType = HcfsType.getHcfsType(configuration, context);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MDQ2NQ=="}, "originalCommit": {"oid": "b150d46f6fef57ea316981562e69ca67641c66df"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3677, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}