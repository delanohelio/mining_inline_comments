{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwOTk5ODUx", "number": 453, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzozNzozMVrOEmMcKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjozMDoxM1rOEmSXSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDg1MTYyOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzozNzozMVrOHWFQWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo0ODoxN1rOHWL0TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNjgyNg==", "bodyText": "I'd prefer to leave this line as before to capture the semantic meaning of the incoming header. we can tie it to releaseUGI logic elsewhere", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r492916826", "createdAt": "2020-09-22T17:37:31Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -101,7 +101,7 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n         final String gpdbUser = getHeaderValue(request, USER_HEADER, true);\n         final String transactionId = getHeaderValue(request, TRANSACTION_ID_HEADER, true);\n         final Integer segmentId = getHeaderValueInt(request, SEGMENT_ID_HEADER, true);\n-        final boolean lastCallForSegment = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);\n+        boolean releaseUgi = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37beefa671d533141a6571645c2a020df0880a83"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNDMzMw==", "bodyText": "sure, makes sense", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493024333", "createdAt": "2020-09-22T20:48:17Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -101,7 +101,7 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n         final String gpdbUser = getHeaderValue(request, USER_HEADER, true);\n         final String transactionId = getHeaderValue(request, TRANSACTION_ID_HEADER, true);\n         final Integer segmentId = getHeaderValueInt(request, SEGMENT_ID_HEADER, true);\n-        final boolean lastCallForSegment = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);\n+        boolean releaseUgi = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNjgyNg=="}, "originalCommit": {"oid": "37beefa671d533141a6571645c2a020df0880a83"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDg3NDYwOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo0MzoyNFrOHWFeCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo0ODo0OFrOHWL1PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyMDMyOA==", "bodyText": "this semantic is not clear now. It would log \"Last fragment call\" if that was indeed last request for fragment data. We don't want to have this printed on error, so maybe have 2 conditions for UGI release - last call and error ?", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r492920328", "createdAt": "2020-09-22T17:43:24Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Last fragment call\" : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37beefa671d533141a6571645c2a020df0880a83"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNDU3Mg==", "bodyText": "I've addressed this issue. I think this wasn't clear in the past either, so I have updated the log message", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493024572", "createdAt": "2020-09-22T20:48:48Z", "author": {"login": "frankgh"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Last fragment call\" : \"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyMDMyOA=="}, "originalCommit": {"oid": "37beefa671d533141a6571645c2a020df0880a83"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTc5NTk2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoxOToxMlrOHWOU-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoxOToxMlrOHWOU-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTQ2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        releaseUgi = true;\n          \n          \n            \n                        exceptionDetected = true;", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493065467", "createdAt": "2020-09-22T22:19:12Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTc5NjQyOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoxOToyNFrOHWOVSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoxOToyNFrOHWOVSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTU0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        releaseUgi = true;\n          \n          \n            \n                        exceptionDetected = true;", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493065544", "createdAt": "2020-09-22T22:19:24Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTgwMzQ2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyMjoxMVrOHWOZdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyMjoxMVrOHWOZdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NjYxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boolean releaseUgi = lastCallForSegment;\n          \n          \n            \n                    boolean exceptionDetected = false;", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493066612", "createdAt": "2020-09-22T22:22:11Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -147,6 +146,7 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             return true;\n         };\n \n+        boolean releaseUgi = lastCallForSegment;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTgwNTYwOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyMzoxN1rOHWOa6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyMzoxN1rOHWOa6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2Njk4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Optimization to cleanup the cache if it is the last fragment\n          \n          \n            \n                        boolean releaseUgi = lastCallForSegment || exceptionDetected;\n          \n          \n            \n                        // Optimization to cleanup the cache if it is the last fragment", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493066984", "createdAt": "2020-09-22T22:23:17Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTgxMDIwOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyNToxOVrOHWOdwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyNToxOVrOHWOdwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NzcxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.debug(\"Releasing proxy user for session: {}. {}\",\n          \n          \n            \n                        LOG.debug(\"Releasing UGI from cache for session: {}. {}\",", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493067712", "createdAt": "2020-09-22T22:25:19Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTgxMTMzOnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyNTo0MlrOHWOecQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjoyNTo0MlrOHWOecQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2Nzg4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.error(\"Error releasing UGICache for session: {}\", session, t);\n          \n          \n            \n                            LOG.error(\"Error releasing UGI from cache for session: {}\", session, t);", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493067889", "createdAt": "2020-09-22T22:25:42Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");\n             try {\n-                ugiCache.release(session, lastCallForSegment);\n+                ugiCache.release(session, releaseUgi);\n             } catch (Throwable t) {\n                 LOG.error(\"Error releasing UGICache for session: {}\", session, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTgyMjE2OnYy", "diffSide": "RIGHT", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjozMDoxM1rOHWOlFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjozMTo0N1rOHWOnSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2OTU4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");\n          \n          \n            \n                                session, exceptionDetected ? \" Exception while processing\" : (lastCallForSegment ? \" Processed last fragment for segment\" : \"\"));", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493069589", "createdAt": "2020-09-22T22:30:13Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MDE1NQ==", "bodyText": "we don't need to explain in the DEBUG log statement, but we need to reflect which path our logic took for troubleshooting, so would like to know why we are calling this -- due to exception or receiving last fragment flag", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493070155", "createdAt": "2020-09-22T22:31:47Z", "author": {"login": "denalex"}, "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2OTU4OQ=="}, "originalCommit": {"oid": "b3a21957e1e74366e5a3c1e3fc155993591f404a"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3476, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}