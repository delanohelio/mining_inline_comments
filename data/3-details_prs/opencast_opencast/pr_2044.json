{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDk0MjQ4", "number": 2044, "title": "Add S3 presigned URL support", "bodyText": "This PR add S3 presigned URL support for Opencast.\nCurrently, when use s3 distribution to store files, anyone can download the media files from S3 or CDN if he/she can obtain the URL of these files.\nBy taking advantage of presigned URL, authorized users will get S3 file with a 'temporal' link with a valid duration. This will protect the media files in case its URLs are leaked.\n\n have a concise title\n close an accompanying issue if one exists\n be against the correct branch (features can only go into develop)\n include migration scripts and documentation, if appropriate\n pass automated tests\n have a clean commit history\n have proper commit messages (title and body) for all commits", "createdAt": "2020-11-04T02:26:38Z", "url": "https://github.com/opencast/opencast/pull/2044", "merged": true, "mergeCommit": {"oid": "19983a39f9f488c35c1d888c440eed42280264d2"}, "closed": true, "closedAt": "2020-11-27T02:27:40Z", "author": {"login": "Gao-Jun"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZHug6gBqjM5NTYwMDMxMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddT-ApABqjQwMDM4NzUyOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e897c79171f794a1cd6f363584067c9d03b436a", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/8e897c79171f794a1cd6f363584067c9d03b436a", "committedDate": "2020-11-02T08:37:22Z", "message": "Add S3 presigned URL support"}, "afterCommit": {"oid": "e7849673cd436f8d506840014407c9bf920f33f6", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/e7849673cd436f8d506840014407c9bf920f33f6", "committedDate": "2020-11-04T06:24:04Z", "message": "Add S3 presigned URL support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7849673cd436f8d506840014407c9bf920f33f6", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/e7849673cd436f8d506840014407c9bf920f33f6", "committedDate": "2020-11-04T06:24:04Z", "message": "Add S3 presigned URL support"}, "afterCommit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/bc0b8b2129c7c1a0b036fc432def78f622949b55", "committedDate": "2020-11-04T07:01:04Z", "message": "Add S3 presigned URL support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTY5MzIy", "url": "https://github.com/opencast/opencast/pull/2044#pullrequestreview-527569322", "createdAt": "2020-11-10T20:11:20Z", "commit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDoxMToyMVrOHwt22A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0Nzo1NVrOHwvBgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0NTAxNg==", "bodyText": "We should be enforcing a maximum here.  Looking at the AWS docs, a simple max of 6 hours ought to do it - then we don't have to figure out what kind of credentials we are working with.", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r520845016", "createdAt": "2020-11-10T20:11:21Z", "author": {"login": "gregorydlogan"}, "path": "modules/distribution-service-aws-s3/src/main/java/org/opencastproject/distribution/aws/s3/AwsS3DistributionServiceImpl.java", "diffHunk": "@@ -227,6 +241,16 @@ public void activate(ComponentContext cc) {\n       pathStyle = Boolean.valueOf(getAWSConfigKey(cc, AWS_S3_PATH_STYLE_CONFIG));\n       logger.info(\"AWS path style is {}\", pathStyle);\n \n+      // AWS presigned URL\n+      String presignedUrlConfigValue = OsgiUtil.getComponentContextProperty(cc, AWS_S3_PRESIGNED_URL_CONFIG, \"false\");\n+      presignedUrl = StringUtils.equalsIgnoreCase(\"true\", presignedUrlConfigValue);\n+      logger.info(\"AWS use presigned URL: {}\", presignedUrl);\n+\n+      // AWS presigned URL expiration time in millis\n+      String presignedUrlExpTimeMillisConfigValue = OsgiUtil.getComponentContextProperty(cc,\n+              AWS_S3_PRESIGNED_URL_VALID_DURATION_CONFIG, null);\n+      presignedUrlValidDuration = NumberUtils.toInt(presignedUrlExpTimeMillisConfigValue, DEFAULT_PRESIGNED_URL_EXPIRE_MILLIS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1ODU5Ng==", "bodyText": "I see a total of four MediaPackageSerializer implementations in the codebase, two of which would always be present.  At runtime you're going to get one of them, but perhaps not the right one.  I can see this especially being true if the adopter is distributing via both S3 and Opencast URL signing since these are both implemented with a serializer.", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r520858596", "createdAt": "2020-11-10T20:37:38Z", "author": {"login": "gregorydlogan"}, "path": "modules/authorization-xacml/src/main/java/org/opencastproject/authorization/xacml/XACMLAuthorizationService.java", "diffHunk": "@@ -110,6 +116,11 @@ public void modified(Map<String, Object> config) {\n     // updated() will handle the configuration update.\n   }\n \n+  @Reference(cardinality = ReferenceCardinality.OPTIONAL)\n+  public void setMediaPackageSerializer(MediaPackageSerializer serializer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NDEzMA==", "bodyText": "There should be a blank line between config and description of the next key.", "url": "https://github.com/opencast/opencast/pull/2044#discussion_r520864130", "createdAt": "2020-11-10T20:47:55Z", "author": {"login": "gregorydlogan"}, "path": "etc/org.opencastproject.distribution.aws.s3.AwsS3DistributionServiceImpl.cfg", "diffHunk": "@@ -44,4 +44,8 @@ org.opencastproject.distribution.aws.s3.distribution.enable=false\n # If you are using another S3 service/provider, please refer to its documentation.\n #org.opencastproject.distribution.aws.s3.path.style=true\n \n-\n+# Enable presigned URL\n+# Leave this commented out to use presigned URL fow AWS S3\n+#org.opencastproject.distribution.aws.s3.presigned.url=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "committedDate": "2020-11-17T06:56:38Z", "message": "Add S3 presigned URL support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc0b8b2129c7c1a0b036fc432def78f622949b55", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/bc0b8b2129c7c1a0b036fc432def78f622949b55", "committedDate": "2020-11-04T07:01:04Z", "message": "Add S3 presigned URL support"}, "afterCommit": {"oid": "2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "author": {"user": {"login": "Gao-Jun", "name": "Gao Jun"}}, "url": "https://github.com/opencast/opencast/commit/2fb4b812ef3d2772672e69d586bcf8ac506f23c0", "committedDate": "2020-11-17T06:56:38Z", "message": "Add S3 presigned URL support"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1733, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}