{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2ODAzNzI2", "number": 1763, "title": "Fix for issue 1280:  Notification of Newer Opencast Version in Admin UI", "bodyText": "This patch adds a notification in the admin UI (behind the bell) if there is a newer version of Opencast available.\nThe notification shows:\n\nif there is a new minor release (e.g. 8.4 -> 8.5)\nif there is a new major release (e.g. 7.4 -> 8.1)\nif your version is no longer supported (older than two major releases)\n\nAdded service in restServiceMonitor.js :\n\ncompares your version to the latest version and adds notification accordingly.\nadds link in the notification to https://docs.opencast.org/r//admin/ to enable the user to update if neccesary.\n\nAdded new endpoint at VersionEndpoint.java :\n\nretrieves latest version from https://api.github.com/repos/opencast/opencast/releases/latest .\nupdates every hour.\nprovides version via /admin-ng/oc-version/version.json .\n\nThis fixes #1280\nYour pull request should\u2026\n\n have a concise title\n close an accompanying issue if one exists\n be against the correct branch (features can only go into develop)\n include migration scripts and documentation, if appropriate\n pass automated testing\n have a clean commit history\n have proper commit messages (title and body) for all commits\n have appropriate tags applied", "createdAt": "2020-08-12T14:20:41Z", "url": "https://github.com/opencast/opencast/pull/1763", "merged": true, "mergeCommit": {"oid": "735ba58bb7c887f449652775eec686715dd7587b"}, "closed": true, "closedAt": "2020-08-19T22:21:32Z", "author": {"login": "mheyen"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-Ly4TgH2gAyNDY2ODAzNzI2OjdkYzdjZDc3ZTU4YmEyMzg3MTdiY2FmM2NhNDRkZTYzMjgzMjgzZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAVmmOAH2gAyNDY2ODAzNzI2OjdlMGJhNjE5M2JlNmIxNWJmM2FmMTg1ZjVhMzAzYTczZWY3YzI0YTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7dc7cd77e58ba238717bcaf3ca44de63283283e2", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/7dc7cd77e58ba238717bcaf3ca44de63283283e2", "committedDate": "2020-08-12T13:53:55Z", "message": "Fix for issue 1280:  Notification of Newer Opencast Version in Admin UI\n\nThis patch adds a notification in the admin UI behind the bell, if there is a newer version of Opencast available.\nThe notification shows:\n- if there is a new minor release (e.g. 8.4 -> 8.5)\n- if there is a new major release (e.g. 7.4 -> 8.1)\n- if your version is no longer supported (older than two major releases)\n\nAdded service in restServiceMonitor.js :\n- compares your version to the latest version and adds notification accordingly.\n- adds link in the notification to https://docs.opencast.org/r/<LATEST VERSION>/admin/ to enable the user to update if neccesary.\n\nAdded new endpoint at VersionEndpoint.java :\n- retrieves latest version from https://api.github.com/repos/opencast/opencast/releases/latest .\n- updates every hour.\n- provides version via /admin-ng/oc-version/version.json .\n\nThis fixes #1280"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDMzNjI3", "url": "https://github.com/opencast/opencast/pull/1763#pullrequestreview-466033627", "createdAt": "2020-08-12T15:33:57Z", "commit": {"oid": "7dc7cd77e58ba238717bcaf3ca44de63283283e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNTozMzo1N1rOG_mzzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNTo0MjoyNlrOG_nNtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0OTMyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      } else if (parseInt(latest_version[0]) - parseInt(my_version[0]) <= 2) {\n          \n          \n            \n                      } else if (parseInt(latest_version[0]) - parseInt(my_version[0]) < 2) {\n          \n      \n    \n    \n  \n\nCurrently, 8.6 is the latest version and 8.x and 7.x is supported.\nIf someone has a 6.4 then 8 - 6 = 2 which should yield the \u2026is no longer supported. Please update.", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r469349327", "createdAt": "2020-08-12T15:33:57Z", "author": {"login": "lkiesow"}, "path": "modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js", "diffHunk": "@@ -45,6 +48,42 @@ angular.module('adminNg.services')\n \n     Monitoring.getActiveMQStats();\n     Monitoring.getBasicServiceStats();\n+    Monitoring.getVersionStats();\n+  };\n+\n+  Monitoring.getVersionStats = function() {\n+    $http.get(MY_VERSION_PATH).then(function(response_my_version) {\n+      $http.get(LATEST_VERSION_PATH).then(function(response_latest_version) {\n+        Monitoring.populateService(LATEST_VERSION_NAME);\n+\n+        if (response_latest_version.status === 200 && response_my_version.status === 200\n+        && response_my_version.data.consistent) {\n+          var my_version = response_my_version.data.version;\n+          var latest_version = response_latest_version.data;\n+          services.service[LATEST_VERSION_NAME].docs_url =\n+            'https://docs.opencast.org/r/' + latest_version[0] + '.x/admin/';\n+\n+          if (parseFloat(my_version) >= parseFloat(latest_version) || my_version.endsWith('SNAPSHOT')) {\n+            services.service[LATEST_VERSION_NAME].status = OK;\n+            services.service[LATEST_VERSION_NAME].error = false;\n+          } else if (my_version[0] == latest_version[0]) {\n+            services.service[LATEST_VERSION_NAME].status = 'There is a minor update available.';\n+            services.service[LATEST_VERSION_NAME].error = true;\n+          } else if (parseInt(latest_version[0]) - parseInt(my_version[0]) <= 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dc7cd77e58ba238717bcaf3ca44de63283283e2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM1MTkwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if (parseFloat(my_version) >= parseFloat(latest_version) || my_version.endsWith('SNAPSHOT')) {\n          \n          \n            \n                      if (parseFloat(my_version) >= parseFloat(latest_version)\n          \n          \n            \n                         || (my_version[0] == latest_version[0] && my_version.endsWith('SNAPSHOT'))) {\n          \n      \n    \n    \n  \n\nThis could also be 4.0.0-SNAPSHOT which could be identified as very old.", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r469351907", "createdAt": "2020-08-12T15:37:39Z", "author": {"login": "lkiesow"}, "path": "modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js", "diffHunk": "@@ -45,6 +48,42 @@ angular.module('adminNg.services')\n \n     Monitoring.getActiveMQStats();\n     Monitoring.getBasicServiceStats();\n+    Monitoring.getVersionStats();\n+  };\n+\n+  Monitoring.getVersionStats = function() {\n+    $http.get(MY_VERSION_PATH).then(function(response_my_version) {\n+      $http.get(LATEST_VERSION_PATH).then(function(response_latest_version) {\n+        Monitoring.populateService(LATEST_VERSION_NAME);\n+\n+        if (response_latest_version.status === 200 && response_my_version.status === 200\n+        && response_my_version.data.consistent) {\n+          var my_version = response_my_version.data.version;\n+          var latest_version = response_latest_version.data;\n+          services.service[LATEST_VERSION_NAME].docs_url =\n+            'https://docs.opencast.org/r/' + latest_version[0] + '.x/admin/';\n+\n+          if (parseFloat(my_version) >= parseFloat(latest_version) || my_version.endsWith('SNAPSHOT')) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dc7cd77e58ba238717bcaf3ca44de63283283e2"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM1NTk1OQ==", "bodyText": "I would make this a warning since it's not something an admin would (or most likely even could) fix.\nAnd use the logger's functionality to handle exceptions:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  logger.error(\"Error while parsing the version: \" + e.toString());\n          \n          \n            \n                  logger.error(\"Error while parsing the Opencast version from GitHub\", e);", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r469355959", "createdAt": "2020-08-12T15:42:26Z", "author": {"login": "lkiesow"}, "path": "modules/admin-ui/src/main/java/org/opencastproject/adminui/endpoint/VersionEndpoint.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.opencastproject.adminui.endpoint;\n+\n+import static org.apache.http.HttpStatus.SC_OK;\n+\n+import org.opencastproject.util.doc.rest.RestQuery;\n+import org.opencastproject.util.doc.rest.RestResponse;\n+import org.opencastproject.util.doc.rest.RestService;\n+\n+import com.google.gson.Gson;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Map;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+@Path(\"/\")\n+@RestService(name = \"VersionService\", title = \"Version service\",\n+  abstractText = \"Provides latest opencast version\",\n+  notes = { \"This service offers the GET method to retrieve the latest opencast version from https://api.github.com .\"})\n+@Component(\n+  immediate = true,\n+  service = VersionEndpoint.class,\n+  property = {\n+    \"service.description=Admin UI - Latest Version Endpoint\",\n+    \"opencast.service.type=org.opencastproject.adminui.endpoint.VersionEndpoint\",\n+    \"opencast.service.path=/admin-ng/oc-version\"\n+  }\n+)\n+public class VersionEndpoint {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(VersionEndpoint.class);\n+\n+  /** The version */\n+  private String version = \"\";\n+\n+  /** GitHub URL */\n+  private String url = \"https://api.github.com/repos/opencast/opencast/releases/latest\";\n+\n+  /** The date */\n+  private long lastUpdated = 0;\n+\n+  private static final Gson gson = new Gson();\n+\n+  /** OSGi callback. */\n+  @Activate\n+  protected void activate() {\n+    logger.info(\"Activate the Admin ui - Latest version endpoint\");\n+  }\n+\n+  @GET\n+  @Path(\"version.json\")\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @RestQuery(name = \"latestversion\", description = \"Returns the latest Opencast version\",\n+          returnDescription = \"Returns the latest Opencast version retrieved from GitHub\",\n+          reponses = { @RestResponse(responseCode = SC_OK, description = \"The latest Opencast version.\") })\n+  public String getVersion() {\n+    if (System.currentTimeMillis() / 1000L - lastUpdated >= 3600) {\n+      updateVersion();\n+    }\n+    return gson.toJson(version);\n+  }\n+\n+  private synchronized void updateVersion() {\n+    if (System.currentTimeMillis() / 1000L - lastUpdated < 3600) {\n+      return;\n+    }\n+    try {\n+      HttpClient client = HttpClientBuilder.create().build();\n+      HttpGet request = new HttpGet(url);\n+      HttpResponse response = client.execute(request);\n+      String responseString = IOUtils.toString(response.getEntity().getContent(), \"utf-8\");\n+      Map data = gson.fromJson(responseString, Map.class);\n+      version = (String) data.get(\"tag_name\");\n+      lastUpdated = System.currentTimeMillis() / 1000L;\n+    } catch (Exception e) {\n+      logger.error(\"Error while parsing the version: \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dc7cd77e58ba238717bcaf3ca44de63283283e2"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "034bd78c3d239a47335a415855a5cf62bdf2ff83", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/034bd78c3d239a47335a415855a5cf62bdf2ff83", "committedDate": "2020-08-13T10:11:47Z", "message": "Update modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js\r\n\r\nremoved minor mistake in version control.\n\nCo-authored-by: Lars Kiesow <lkiesow@uos.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04d8d47c35e50aeb86e12595d27fa12e57159503", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/04d8d47c35e50aeb86e12595d27fa12e57159503", "committedDate": "2020-08-13T10:16:38Z", "message": "Update modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js\r\n\r\nOlder versions including 'SNAPSHOT' are now identified.\n\nCo-authored-by: Lars Kiesow <lkiesow@uos.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fdb7810b96b34d598db8b06142a99f8eda80a98", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/3fdb7810b96b34d598db8b06142a99f8eda80a98", "committedDate": "2020-08-13T13:40:53Z", "message": "Update modules/admin-ui/src/main/java/org/opencastproject/adminui/endpoint/VersionEndpoint.java\n\nchanged error to warning message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/f621ec0286481e59c7459177a102d1c8c1e3b41c", "committedDate": "2020-08-13T13:54:35Z", "message": "Merge remote-tracking branch 'origin/fix-1280' into fix-1280"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODQ3MzU4", "url": "https://github.com/opencast/opencast/pull/1763#pullrequestreview-466847358", "createdAt": "2020-08-13T15:00:08Z", "commit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTowMDowOVrOHAPlxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTowMDowOVrOHAPlxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAxNzQ3OQ==", "bodyText": "This should be re**s**ponses, especially since I'm looking at #1766 too :)", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r470017479", "createdAt": "2020-08-13T15:00:09Z", "author": {"login": "gregorydlogan"}, "path": "modules/admin-ui/src/main/java/org/opencastproject/adminui/endpoint/VersionEndpoint.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.opencastproject.adminui.endpoint;\n+\n+import static org.apache.http.HttpStatus.SC_OK;\n+\n+import org.opencastproject.util.doc.rest.RestQuery;\n+import org.opencastproject.util.doc.rest.RestResponse;\n+import org.opencastproject.util.doc.rest.RestService;\n+\n+import com.google.gson.Gson;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Map;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+@Path(\"/\")\n+@RestService(name = \"VersionService\", title = \"Version service\",\n+  abstractText = \"Provides latest opencast version\",\n+  notes = { \"This service offers the GET method to retrieve the latest opencast version from https://api.github.com .\"})\n+@Component(\n+  immediate = true,\n+  service = VersionEndpoint.class,\n+  property = {\n+    \"service.description=Admin UI - Latest Version Endpoint\",\n+    \"opencast.service.type=org.opencastproject.adminui.endpoint.VersionEndpoint\",\n+    \"opencast.service.path=/admin-ng/oc-version\"\n+  }\n+)\n+public class VersionEndpoint {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(VersionEndpoint.class);\n+\n+  /** The version */\n+  private String version = \"\";\n+\n+  /** GitHub URL */\n+  private String url = \"https://api.github.com/repos/opencast/opencast/releases/latest\";\n+\n+  /** The date */\n+  private long lastUpdated = 0;\n+\n+  private static final Gson gson = new Gson();\n+\n+  /** OSGi callback. */\n+  @Activate\n+  protected void activate() {\n+    logger.info(\"Activate the Admin ui - Latest version endpoint\");\n+  }\n+\n+  @GET\n+  @Path(\"version.json\")\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @RestQuery(name = \"latestversion\", description = \"Returns the latest Opencast version\",\n+          returnDescription = \"Returns the latest Opencast version retrieved from GitHub\",\n+          reponses = { @RestResponse(responseCode = SC_OK, description = \"The latest Opencast version.\") })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODUxODQ3", "url": "https://github.com/opencast/opencast/pull/1763#pullrequestreview-466851847", "createdAt": "2020-08-13T15:04:53Z", "commit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTowNDo1M1rOHAPz8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTowNjoxMlrOHAP3dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAyMTEwNw==", "bodyText": "What was the reasoning behind removing this?", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r470021107", "createdAt": "2020-08-13T15:04:53Z", "author": {"login": "gregorydlogan"}, "path": "modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js", "diffHunk": "@@ -58,11 +98,7 @@ angular.module('adminNg.services')\n         services.service[AMQ_NAME].error = true;\n       }\n     }).catch(function(err) {\n-      Monitoring.populateService(AMQ_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAyMjAwNw==", "bodyText": "Probably only need to check this once, either here, or in updateVersion", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r470022007", "createdAt": "2020-08-13T15:06:12Z", "author": {"login": "gregorydlogan"}, "path": "modules/admin-ui/src/main/java/org/opencastproject/adminui/endpoint/VersionEndpoint.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.opencastproject.adminui.endpoint;\n+\n+import static org.apache.http.HttpStatus.SC_OK;\n+\n+import org.opencastproject.util.doc.rest.RestQuery;\n+import org.opencastproject.util.doc.rest.RestResponse;\n+import org.opencastproject.util.doc.rest.RestService;\n+\n+import com.google.gson.Gson;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.http.HttpResponse;\n+import org.apache.http.client.HttpClient;\n+import org.apache.http.client.methods.HttpGet;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Map;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+@Path(\"/\")\n+@RestService(name = \"VersionService\", title = \"Version service\",\n+  abstractText = \"Provides latest opencast version\",\n+  notes = { \"This service offers the GET method to retrieve the latest opencast version from https://api.github.com .\"})\n+@Component(\n+  immediate = true,\n+  service = VersionEndpoint.class,\n+  property = {\n+    \"service.description=Admin UI - Latest Version Endpoint\",\n+    \"opencast.service.type=org.opencastproject.adminui.endpoint.VersionEndpoint\",\n+    \"opencast.service.path=/admin-ng/oc-version\"\n+  }\n+)\n+public class VersionEndpoint {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(VersionEndpoint.class);\n+\n+  /** The version */\n+  private String version = \"\";\n+\n+  /** GitHub URL */\n+  private String url = \"https://api.github.com/repos/opencast/opencast/releases/latest\";\n+\n+  /** The date */\n+  private long lastUpdated = 0;\n+\n+  private static final Gson gson = new Gson();\n+\n+  /** OSGi callback. */\n+  @Activate\n+  protected void activate() {\n+    logger.info(\"Activate the Admin ui - Latest version endpoint\");\n+  }\n+\n+  @GET\n+  @Path(\"version.json\")\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @RestQuery(name = \"latestversion\", description = \"Returns the latest Opencast version\",\n+          returnDescription = \"Returns the latest Opencast version retrieved from GitHub\",\n+          reponses = { @RestResponse(responseCode = SC_OK, description = \"The latest Opencast version.\") })\n+  public String getVersion() {\n+    if (System.currentTimeMillis() / 1000L - lastUpdated >= 3600) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f621ec0286481e59c7459177a102d1c8c1e3b41c"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2257e7eabaa8ef6426da2e3db39417fc9cdd2417", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/2257e7eabaa8ef6426da2e3db39417fc9cdd2417", "committedDate": "2020-08-14T09:14:43Z", "message": "Update modules/admin-ui/src/main/java/org/opencastproject/adminui/endpoint/VersionEndpoint.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzgzMDU5", "url": "https://github.com/opencast/opencast/pull/1763#pullrequestreview-468783059", "createdAt": "2020-08-17T19:44:10Z", "commit": {"oid": "2257e7eabaa8ef6426da2e3db39417fc9cdd2417"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxOTo0NDoxMFrOHB4cCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxOTo0NDoxMFrOHB4cCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczNTMwNg==", "bodyText": "Testing this, I patched out the endpoint to return \"10.0\" as the version.  This line generates links to https://docs.opencast.org/r/1.x/admin/ rather than https://docs.opencast.org/r/10.x/admin/\nOtherwise looks good and works as expected!", "url": "https://github.com/opencast/opencast/pull/1763#discussion_r471735306", "createdAt": "2020-08-17T19:44:10Z", "author": {"login": "gregorydlogan"}, "path": "modules/admin-ui-frontend/app/scripts/shared/services/restServiceMonitor.js", "diffHunk": "@@ -45,6 +48,43 @@ angular.module('adminNg.services')\n \n     Monitoring.getActiveMQStats();\n     Monitoring.getBasicServiceStats();\n+    Monitoring.getVersionStats();\n+  };\n+\n+  Monitoring.getVersionStats = function() {\n+    $http.get(MY_VERSION_PATH).then(function(response_my_version) {\n+      $http.get(LATEST_VERSION_PATH).then(function(response_latest_version) {\n+        Monitoring.populateService(LATEST_VERSION_NAME);\n+\n+        if (response_latest_version.status === 200 && response_my_version.status === 200\n+        && response_my_version.data.consistent) {\n+          var my_version = response_my_version.data.version;\n+          var latest_version = response_latest_version.data;\n+          services.service[LATEST_VERSION_NAME].docs_url =\n+            'https://docs.opencast.org/r/' + latest_version[0] + '.x/admin/';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2257e7eabaa8ef6426da2e3db39417fc9cdd2417"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e0ba6193be6b15bf3af185f5a303a73ef7c24a3", "author": {"user": {"login": "mheyen", "name": null}}, "url": "https://github.com/opencast/opencast/commit/7e0ba6193be6b15bf3af185f5a303a73ef7c24a3", "committedDate": "2020-08-19T06:27:24Z", "message": "Update restServiceMonitor.js and VersionEndpoint\n\nrestServiceMonitor.js can now handle versions >= 10.0\n\nfixed a mistake in VersionEndpoint.java .\nIt now searches in the list of latest releases for the highest version.\npreviously it received only the latest release, which could have been a minor release for an older version."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1810, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}