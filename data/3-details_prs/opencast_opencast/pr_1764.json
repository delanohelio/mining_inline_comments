{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2ODMzNTI0", "number": 1764, "title": "LTI Context Role Prefix", "bodyText": "This patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to.\nYour pull request should\u2026\n\n have a concise title\n close an accompanying issue if one exists\n be against the correct branch (features can only go into develop)\n include migration scripts and documentation, if appropriate\n pass automated testing\n have a clean commit history\n have proper commit messages (title and body) for all commits\n have appropriate tags applied", "createdAt": "2020-08-12T15:05:21Z", "url": "https://github.com/opencast/opencast/pull/1764", "merged": true, "mergeCommit": {"oid": "6a763e751ab0f8bf38cacc716b631ccfc80c14b4"}, "closed": true, "closedAt": "2020-10-02T15:13:24Z", "author": {"login": "lkiesow"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCX4v0gBqjM2OTAzMjIzNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFha8MgBqjM3Mjg3NDg3ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e02ee5b1014b95f4552c61fe92007d02a665b9a9", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/e02ee5b1014b95f4552c61fe92007d02a665b9a9", "committedDate": "2020-08-12T15:00:38Z", "message": "LTI Context Role Prefix\n\nThis patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\n\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\n\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to."}, "afterCommit": {"oid": "03b4ddefdb9a69856724d39178256c65b1d15896", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/03b4ddefdb9a69856724d39178256c65b1d15896", "committedDate": "2020-08-25T14:14:22Z", "message": "LTI Context Role Prefix\n\nThis patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\n\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\n\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NjM0MjY4", "url": "https://github.com/opencast/opencast/pull/1764#pullrequestreview-479634268", "createdAt": "2020-09-01T11:07:03Z", "commit": {"oid": "03b4ddefdb9a69856724d39178256c65b1d15896"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMTowNzowM1rOHKxYyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMToxNzowM1rOHKxrxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA1Njk3MQ==", "bodyText": "Is the first sentence complete?", "url": "https://github.com/opencast/opencast/pull/1764#discussion_r481056971", "createdAt": "2020-09-01T11:07:03Z", "author": {"login": "mtneug"}, "path": "etc/org.opencastproject.security.lti.LtiLaunchAuthenticationHandler.cfg", "diffHunk": "@@ -61,3 +61,17 @@\n #lti.custom_role_name=Instructor\n #This Role set is an example for a user which can open the editor for an event and upload videos via opencast studio.\n #lti.custom_roles=ROLE_ADMIN_UI,ROLE_API_EVENTS_METADATA_DELETE,ROLE_API_EVENTS_METADATA_EDIT,ROLE_API_EVENTS_METADATA_VIEW,ROLE_UI_EVENTS_DETAILS_COMMENTS_CREATE,ROLE_UI_EVENTS_DETAILS_COMMENTS_DELETE,ROLE_UI_EVENTS_DETAILS_COMMENTS_EDIT,ROLE_UI_EVENTS_DETAILS_COMMENTS_REPLY,ROLE_UI_EVENTS_DETAILS_COMMENTS_RESOLVE,ROLE_UI_EVENTS_DETAILS_COMMENTS_VIEW,ROLE_UI_EVENTS_EDITOR_EDIT,ROLE_UI_EVENTS_EDITOR_VIEW,ROLE_STUDIO\n+\n+# Prefix for LTI context based roles based on OAuth consumer keys.\n+# The LTI context (e.g. the course identifier) is used to generate context roles like \u201c12345_Learner\u201d.\n+# If multiple LTI consumers are used, this can clash, causing users from one consumer to get access to content from\n+# another consumer. The prefix can be used to prevent this by generating context roles like \u201cPREFIX1_123_Learner\u201d and\n+# \u201cPREFIX2_123_Learner\u201d instead.\n+#\n+# Note that context roles starting with \u201cROLE_\u201d in Opencast. Thus, you should not use this as a prefix.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b4ddefdb9a69856724d39178256c65b1d15896"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2MTgzMQ==", "bodyText": "The group is never added! Is anybody relying on having groups like ROLE_GROUP_Learner,\nROLE_GROUP_Instructor? I don't think this was advertised. And as far as I know, no role provider adds these roles.\nI suggest to remove the two above lines and create a new PR if this feature is needed.", "url": "https://github.com/opencast/opencast/pull/1764#discussion_r481061831", "createdAt": "2020-09-01T11:17:03Z", "author": {"login": "mtneug"}, "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -405,31 +425,27 @@ public Authentication createAuthentication(HttpServletRequest request, ConsumerA\n    * @param userAuthorities\n    *          Collection to append to.\n    */\n-  private void enrichRoleGrants(String roles, String context, Collection<GrantedAuthority> userAuthorities) {\n-    // Roles could be a list\n+  private void enrichRoleGrants(String roles, String context, final String rolePrefix,\n+      Collection<GrantedAuthority> userAuthorities) {\n     if (roles != null) {\n+      // Roles could be a list\n       String[] roleList = roles.split(\",\");\n \n       // Use a generic context and learner if none is given:\n       context = StringUtils.isBlank(context) ? DEFAULT_CONTEXT : context;\n \n-      for (String learner : roleList) {\n+      for (final String ltiRole : roleList) {\n         // Build the role\n-        String role;\n-        String group;\n-        if (learner.equals(customRoleName)) {\n-          for (String rolename : customRoles) {\n-            userAuthorities.add(new SimpleGrantedAuthority(rolename));\n+        if (ltiRole.equals(customRoleName)) {\n+          for (String roleName : customRoles) {\n+            userAuthorities.add(new SimpleGrantedAuthority(roleName));\n           }\n         }\n \n-        if (StringUtils.isBlank(learner)) {\n-          role = context + \"_\" + DEFAULT_LEARNER;\n-        } else {\n-          role = context + \"_\" + learner;\n-          group = \"ROLE_GROUP_\" + learner.toUpperCase();\n-          logger.debug(\"Adding group: {}\", group);\n-        }\n+        final String normalizedLtiRole = StringUtils.defaultIfBlank(ltiRole, DEFAULT_LEARNER);\n+        final String role = rolePrefix + context + \"_\" + normalizedLtiRole;\n+        final String group = \"ROLE_GROUP_\" + rolePrefix + normalizedLtiRole.toUpperCase();\n+        logger.debug(\"Adding group: {}\", group);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b4ddefdb9a69856724d39178256c65b1d15896"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f15bee2362a712da96f14349d1139d1cbcef3de", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/8f15bee2362a712da96f14349d1139d1cbcef3de", "committedDate": "2020-09-04T08:54:52Z", "message": "LTI Context Role Prefix\n\nThis patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\n\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\n\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03b4ddefdb9a69856724d39178256c65b1d15896", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/03b4ddefdb9a69856724d39178256c65b1d15896", "committedDate": "2020-08-25T14:14:22Z", "message": "LTI Context Role Prefix\n\nThis patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\n\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\n\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to."}, "afterCommit": {"oid": "8f15bee2362a712da96f14349d1139d1cbcef3de", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/8f15bee2362a712da96f14349d1139d1cbcef3de", "committedDate": "2020-09-04T08:54:52Z", "message": "LTI Context Role Prefix\n\nThis patch allows defining a prefix for LTI context based roles based on\nOAuth consumer keys.\n\nThe LTI context (e.g. the course identifier) is used to generate context\nroles like \u201c12345_Learner\u201d.  If multiple LTI consumers are used, this\ncan clash, causing users from one consumer to get access to content from\nanother consumer. The prefix can be used to prevent this by generating\ncontext roles like \u201cPREFIX1_123_Learner\u201d and \u201cPREFIX2_123_Learner\u201d\ninstead.\n\nThe default is to use no prefix, making LTI in Opencast behave exactly\nthe way it used to."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1813, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}