{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzA5ODcw", "number": 1633, "title": "Using ConcurrentHashMap for synchronizing LTI user login", "bodyText": "This Pull Request is correcting\n#1532\nand\n#1622\nNow we simple using a ConcurrentHashMap to synchronize the user authenticated by LTI.\nWe save the username in the map and removing it in the finally block after user is added or updated.\nThe fix is related to #1532 and the mentioned exceptions.\nThe code of the patches above is not needed anymore.", "createdAt": "2020-06-08T18:13:27Z", "url": "https://github.com/opencast/opencast/pull/1633", "merged": true, "mergeCommit": {"oid": "3170491dbe7dc00983b1c8987215a9147a349ca1"}, "closed": true, "closedAt": "2020-06-10T18:12:07Z", "author": {"login": "otti-ssystems"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpZTMTAFqTQyNjY5MzYxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcprHSHgFqTQyNzUxNzMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjkzNjE5", "url": "https://github.com/opencast/opencast/pull/1633#pullrequestreview-426693619", "createdAt": "2020-06-08T23:42:06Z", "commit": {"oid": "dd4fdb536875c867eb24f932c0194da07cfb464c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MjowN1rOGgz_Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0NDoxM1rOGg0B8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTQxOA==", "bodyText": "This now becomes expected behavior and is not something we need to warn users about, is it?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.warn(\"Concurrent access of user {}. Igoring.\", username);\n          \n          \n            \n                    logger.debug(\"Concurrent access of user {}. Igoring.\", username);", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437059418", "createdAt": "2020-06-08T23:42:07Z", "author": {"login": "lkiesow"}, "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -315,37 +317,36 @@ public Authentication createAuthentication(HttpServletRequest request, ConsumerA\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_USER\"));\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_ANONYMOUS\"));\n \n-\n     // Create/Update the user reference\n     if (createJpaUserReference) {\n-      JpaOrganization organization = fromOrganization(securityService.getOrganization());\n-\n-      JpaUserReference jpaUserReference = userReferenceProvider.findUserReference(username, organization.getId());\n-\n-      Set<JpaRole> jpaRoles = new HashSet<>();\n-      for (GrantedAuthority authority : userAuthorities) {\n-        jpaRoles.add(new JpaRole(authority.getAuthority(), organization));\n-      }\n-\n-      Date loginDate = new Date();\n+      if (attempts.putIfAbsent(username, Boolean.TRUE) != null) {\n+        logger.warn(\"Concurrent access of user {}. Igoring.\", username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd4fdb536875c867eb24f932c0194da07cfb464c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDA4MA==", "bodyText": "Purely nitpicking but it's not that we count attempts so the choice for the name seems a bit odd.\n;aybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);\n          \n          \n            \n              private Map<String, Boolean> activePersistence = new ConcurrentHashMap<>(128);", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437060080", "createdAt": "2020-06-08T23:44:13Z", "author": {"login": "lkiesow"}, "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -137,6 +137,9 @@\n   /** Set of usernames that should not authenticated as themselves even if the OAuth consumer keys is trusted */\n   private Set<String> usernameBlacklist = new HashSet<>();\n \n+  /** concurrent attemtps */\n+  private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd4fdb536875c867eb24f932c0194da07cfb464c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "author": {"user": {"login": "otti-ssystems", "name": "Otti"}}, "url": "https://github.com/opencast/opencast/commit/df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "committedDate": "2020-06-09T18:16:40Z", "message": "refs #4904 FIX using ConcurrentHashMap for LTI login User"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "committedDate": "2020-06-09T18:23:45Z", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd4fdb536875c867eb24f932c0194da07cfb464c", "author": {"user": {"login": "otti-ssystems", "name": "Otti"}}, "url": "https://github.com/opencast/opencast/commit/dd4fdb536875c867eb24f932c0194da07cfb464c", "committedDate": "2020-06-08T18:18:58Z", "message": "Merge branch 'r/8.x' into r4904_concurrent_lti_logins_github_fix_8x"}, "afterCommit": {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "committedDate": "2020-06-09T18:23:45Z", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDUyOTAw", "url": "https://github.com/opencast/opencast/pull/1633#pullrequestreview-427452900", "createdAt": "2020-06-09T18:57:24Z", "commit": {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d53f7bb63e8155cc04be041e31514fbb5130bbb", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/8d53f7bb63e8155cc04be041e31514fbb5130bbb", "committedDate": "2020-06-09T20:24:19Z", "message": "Concurrent LTI Requests\n\nThis patch adds an additional safeguard for handling concurrent\nauthentication requests executed on multiple server."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTE3MzE3", "url": "https://github.com/opencast/opencast/pull/1633#pullrequestreview-427517317", "createdAt": "2020-06-09T20:30:51Z", "commit": {"oid": "8d53f7bb63e8155cc04be041e31514fbb5130bbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1838, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}