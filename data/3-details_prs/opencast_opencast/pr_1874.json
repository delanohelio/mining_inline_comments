{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNjMzMjY3", "number": 1874, "title": "PostgreSQL and auto-generated databases", "bodyText": "As promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup.\n\nWhile this is basically just documentation and the topic has already passed as proposal, it would be great if someone else could read through this before it gets merged.\nYour pull request should\u2026\n\n have a concise title\n close an accompanying issue if one exists\n be against the correct branch (features can only go into develop)\n include migration scripts and documentation, if appropriate\n pass automated testing\n have a clean commit history\n have proper commit messages (title and body) for all commits\n have appropriate tags applied", "createdAt": "2020-09-26T21:57:27Z", "url": "https://github.com/opencast/opencast/pull/1874", "merged": true, "mergeCommit": {"oid": "e2a7e44b25bd34f849d1fac7446a738c048c0efd"}, "closed": true, "closedAt": "2020-10-02T13:13:21Z", "author": {"login": "lkiesow"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMx0IcgBqjM4MTExMzkxOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOlUOMgFqTUwMTA5ODY2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adf3338bf0704e45bd562ab4140b2bf0044616dc", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/adf3338bf0704e45bd562ab4140b2bf0044616dc", "committedDate": "2020-09-26T21:37:23Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}, "afterCommit": {"oid": "05eb4fef8123d70ea8cc19caa0816b3ac3272ae2", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/05eb4fef8123d70ea8cc19caa0816b3ac3272ae2", "committedDate": "2020-09-26T22:05:55Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMDI0NTQy", "url": "https://github.com/opencast/opencast/pull/1874#pullrequestreview-501024542", "createdAt": "2020-10-02T10:28:47Z", "commit": {"oid": "05eb4fef8123d70ea8cc19caa0816b3ac3272ae2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMDoyODo0OFrOHboyXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMDozMjo1NFrOHbo41w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0MTg1NA==", "bodyText": "Does not work with postgresql ... ENGINE creates a syntax error", "url": "https://github.com/opencast/opencast/pull/1874#discussion_r498741854", "createdAt": "2020-10-02T10:28:48Z", "author": {"login": "lwillmann"}, "path": "docs/guides/admin/docs/configuration/database.md", "diffHunk": "@@ -104,49 +103,80 @@ Finally, leave the client and restart the database server to enable the new user\n % systemctl restart mariadb.service\n ```\n \n+PostgreSQL\n+----------\n \n-### Set up the Database Structure\n+Opencast's official PostgreSQL support is still marked as experimental.\n \n-To set up the database structure you can (and should!) use the Opencast ddl scripts. You can find them in\n-`\u2026/docs/scripts/ddl/mysql5.sql` or download them from GitHub.\n+Install PostgreSQL, create a database and a user:\n \n-To import the database structure using the MariaDB client, switch to the directory that contains the `mysql5.sql` file,\n-run the client with a user privileged to create the database structure and switch to the database you want to use\n-(e.g. `opencast`):\n-\n-```sh\n-% mysql -u root -p opencast\n ```\n-\n-Run the ddl script:\n-\n-```\n-mysql> source mysql5.sql;\n+sudo -u postgres psql\n+postgres=# create database opencast;\n+postgres=# create user opencast with encrypted password 'opencast_password';\n+postgres=# grant all privileges on database opencast to opencast;\n ```\n \n-Now, ensure the MariaDB [`wait_timeout`](https://mariadb.com/kb/en/library/server-system-variables/) in `mariadb.cnf`\n-or `mysql.cnf` is bigger than `org.opencastproject.db.jdbc.pool.max.idle.time` in Opencast's `custom.properties`.\n-Raising the `max_connections` in `mariadb.cnf` parameter might be required, too, depending on your installation's size.\n-Reload the configuration into MariaDB, then connect to your database as user `opencast` and verify the values by\n-executing `SHOW VARIABLES LIKE %_timeout;`. A `MySQLNonTransientConnectionException`, for instance \u201cA PooledConnection\n-that has already signaled a Connection error is still in use\u201d, in your Opencast logs might indicate a problem with this\n-configuration.\n \n+Configure Opencast\n+------------------\n \n-### Configure Opencast\n-\n-The following changes must be made in `etc/custom.properties`:\n+The following changes must be made in `etc/custom.properties`.\n+Examples are provided for MariaDB/MySQL and PostgreSQL.\n \n-1. Configure Opencast to use the JDBC driver for MariaDB:\n+1. Configure Opencast to use the JDBC driver for MariaDB or PostgreSQL.\n+   The MariaDB driver will also work for MySQL.\n \n+        # MariaDB/MySQL\n         org.opencastproject.db.jdbc.driver=org.mariadb.jdbc.Driver\n+        # PostgreSQL\n+        org.opencastproject.db.jdbc.driver=org.postgresql.Driver\n \n-2. Configure the host where Opencast should find the database (`localhost`) and the database name (`opencast`). Adjust\n-   the names in this example to match your configuration:\n+2. Configure the host where Opencast will find the database (`127.0.0.1`) and the database name (`opencast`).\n \n-        org.opencastproject.db.jdbc.url=jdbc:mysql://localhost/opencast?useMysqlMetadata=true\n+        # MariaDB/MySQL\n+        org.opencastproject.db.jdbc.url=jdbc:mysql://127.0.0.1/opencast?useMysqlMetadata=true\n+        # PostgreSQL\n+        org.opencastproject.db.jdbc.url=jdbc:postgresql://127.0.0.1/opencast\n \n-3. Configure the username and password with which to access the database:\n+\n+3. Configure the database username and password.\n \n         org.opencastproject.db.jdbc.user=opencast\n         org.opencastproject.db.jdbc.pass=opencast_password\n+\n+\n+OAI-PMH Database (optional)\n+---------------------------\n+\n+The database tables are automatically generated by Opencast when they are needed.\n+One exception to this is the OAI-PMH publication database which requires an additional trigger.\n+Trying to generate the schema automatically will most likely fail.\n+\n+If you want to use OAI-PMH, you must create the necessary table manually.\n+\n+Use the following code to generate the OAI-PMH database table:\n+\n+```sql\n+CREATE TABLE oc_oaipmh (\n+  mp_id VARCHAR(128) NOT NULL,\n+  organization VARCHAR(128) NOT NULL,\n+  repo_id VARCHAR(255) NOT NULL,\n+  series_id VARCHAR(128),\n+  deleted tinyint(1) DEFAULT '0',\n+  modification_date DATETIME DEFAULT NULL,\n+  mediapackage_xml TEXT(65535) NOT NULL,\n+  PRIMARY KEY (mp_id, repo_id, organization),\n+  CONSTRAINT UNQ_oc_oaipmh UNIQUE (modification_date)\n+) ENGINE=InnoDB DEFAULT CHARSET=utf8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05eb4fef8123d70ea8cc19caa0816b3ac3272ae2"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0MzUxMQ==", "bodyText": "Maybe it is helpful to add a comment that by default PostgreSQL uses IDENT-based authentication, thus username and password authorization has to be configured.", "url": "https://github.com/opencast/opencast/pull/1874#discussion_r498743511", "createdAt": "2020-10-02T10:32:54Z", "author": {"login": "lwillmann"}, "path": "docs/guides/admin/docs/configuration/database.md", "diffHunk": "@@ -104,49 +103,80 @@ Finally, leave the client and restart the database server to enable the new user\n % systemctl restart mariadb.service\n ```\n \n+PostgreSQL\n+----------\n \n-### Set up the Database Structure\n+Opencast's official PostgreSQL support is still marked as experimental.\n \n-To set up the database structure you can (and should!) use the Opencast ddl scripts. You can find them in\n-`\u2026/docs/scripts/ddl/mysql5.sql` or download them from GitHub.\n+Install PostgreSQL, create a database and a user:\n \n-To import the database structure using the MariaDB client, switch to the directory that contains the `mysql5.sql` file,\n-run the client with a user privileged to create the database structure and switch to the database you want to use\n-(e.g. `opencast`):\n-\n-```sh\n-% mysql -u root -p opencast\n ```\n-\n-Run the ddl script:\n-\n-```\n-mysql> source mysql5.sql;\n+sudo -u postgres psql\n+postgres=# create database opencast;\n+postgres=# create user opencast with encrypted password 'opencast_password';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05eb4fef8123d70ea8cc19caa0816b3ac3272ae2"}, "originalPosition": 97}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05eb4fef8123d70ea8cc19caa0816b3ac3272ae2", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/05eb4fef8123d70ea8cc19caa0816b3ac3272ae2", "committedDate": "2020-09-26T22:05:55Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}, "afterCommit": {"oid": "f63af76266838384c150ed8f6d8e0c3d5a86a914", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/f63af76266838384c150ed8f6d8e0c3d5a86a914", "committedDate": "2020-10-02T12:30:57Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29e2cd9aa3f11b8c6b7ec83b7380dbf2e167583f", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/29e2cd9aa3f11b8c6b7ec83b7380dbf2e167583f", "committedDate": "2020-10-02T12:37:40Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f63af76266838384c150ed8f6d8e0c3d5a86a914", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/f63af76266838384c150ed8f6d8e0c3d5a86a914", "committedDate": "2020-10-02T12:30:57Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}, "afterCommit": {"oid": "29e2cd9aa3f11b8c6b7ec83b7380dbf2e167583f", "author": {"user": {"login": "lkiesow", "name": "Lars Kiesow"}}, "url": "https://github.com/opencast/opencast/commit/29e2cd9aa3f11b8c6b7ec83b7380dbf2e167583f", "committedDate": "2020-10-02T12:37:40Z", "message": "PostgreSQL and auto-generated databases\n\nAs promised in the proposal \u201cJPA, PostgreSQL and DDL-Scripts\u201d (passed on\nOct 29, 2019) we worked on replacing the current set of MariaDB based\nDDL scripts with a proper auto-generated database. These changes are\nnow merged into the Opencast codebase so that we do not need the DDL\nscripts any longer.\n\nThis patch brings these changes to an end, removing the DDL scripts and\nupdating the documentation to reflect the auto-generated database and\nthe newly added \u2013 for now, still marked as experimental \u2013 support for\nPostgreSQL.\n\nOAI-PMH with it's weird \u2013 and somewhat problematic \u2013 database usage\nstill needs a manual set-up of one table. This has been added to the\ndocumentation but is only necessary if you actually configure and use\nOAI-PMH which is not the case in a default installation.\n\nTo avoid confusion: We still need upgrade scripts. This is only about\nthe initial database setup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMDk4NjYx", "url": "https://github.com/opencast/opencast/pull/1874#pullrequestreview-501098661", "createdAt": "2020-10-02T12:40:45Z", "commit": {"oid": "29e2cd9aa3f11b8c6b7ec83b7380dbf2e167583f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1765, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}