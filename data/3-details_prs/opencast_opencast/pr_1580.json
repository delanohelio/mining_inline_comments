{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODA0Mzgy", "number": 1580, "title": "TagWorkflowOperationHandler now allows wildcards in target flavor", "bodyText": "This pull request should close #1513.\nAs described in the feature request, the TagWorkflowOperationHandler should now allow target flavors starting with */.... When using this wildcard, all MediaPackages passing the operation should keep their flavor type and just change the subtype.\nExample:\nDefined target flavor: */foobar\nMediapackge 1 flavor: presentation/source\nafter passing the TagWorkflowOperationHandler: presentation/source -> presentation/foobar\nMediapackge 2 flavor: somethingelse/source\nafter passing the TagWorkflowOperationHandler: somethingelse/source -> somethingelse/foobar", "createdAt": "2020-05-12T15:33:09Z", "url": "https://github.com/opencast/opencast/pull/1580", "merged": true, "mergeCommit": {"oid": "a67ece488617d23101e16357ab5da0c69105644b"}, "closed": true, "closedAt": "2020-09-30T16:05:56Z", "author": {"login": "marwyg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoETvTAFqTQyNDgxMzcxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN-HKHgBqjM4MjQ5ODA2NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODEzNzEy", "url": "https://github.com/opencast/opencast/pull/1580#pullrequestreview-424813712", "createdAt": "2020-06-04T20:44:14Z", "commit": {"oid": "daef666510a1eed1683ca82ca472ed272d37bb4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "daef666510a1eed1683ca82ca472ed272d37bb4f", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/daef666510a1eed1683ca82ca472ed272d37bb4f", "committedDate": "2020-05-12T15:14:35Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor"}, "afterCommit": {"oid": "7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "committedDate": "2020-06-09T17:49:00Z", "message": "TagWorkflowOperationHandler now allows wildcards in type and subtype."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "committedDate": "2020-06-09T17:49:00Z", "message": "TagWorkflowOperationHandler now allows wildcards in type and subtype."}, "afterCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/ae3986b8d69562a72ac9fcae6bd211139952ad32", "committedDate": "2020-06-10T18:40:52Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjQ3NTYx", "url": "https://github.com/opencast/opencast/pull/1580#pullrequestreview-497647561", "createdAt": "2020-09-28T15:28:23Z", "commit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNToyODoyNFrOHZD7RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNToyOTo0NFrOHZD_KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MDc3Mg==", "bodyText": "This should be WorkflowOperationException", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496040772", "createdAt": "2020-09-28T15:28:24Z", "author": {"login": "gregorydlogan"}, "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTE2MA==", "bodyText": "Ideally this should be a class level constant.", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041160", "createdAt": "2020-09-28T15:28:52Z", "author": {"login": "gregorydlogan"}, "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);\n+      }\n+      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTc2OA==", "bodyText": "This call escapes the *, the following one does not.  They should be the same, right?", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041768", "createdAt": "2020-09-28T15:29:44Z", "author": {"login": "gregorydlogan"}, "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -127,8 +141,21 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n         element.setIdentifier(null);\n         element.setURI(e.getURI()); // use the same URI as the original\n       }\n-      if (configuredTargetFlavor != null)\n-        element.setFlavor(MediaPackageElementFlavor.parseFlavor(configuredTargetFlavor));\n+\n+      if (configuredTargetFlavor != null) {\n+        String targetFlavor = configuredTargetFlavor;\n+\n+        if (wildcardInTargetFlavorType) {\n+          targetFlavor = targetFlavor.replaceFirst(\"\\\\*\", element.getFlavor().getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzA4NjMw", "url": "https://github.com/opencast/opencast/pull/1580#pullrequestreview-497708630", "createdAt": "2020-09-28T16:38:45Z", "commit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjozODo0NVrOHZGxBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjozODo0NVrOHZGxBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4NzMwMw==", "bodyText": "Don't log an error when you throw an exception anyway. The result will just be that you see the same error twice in the logs. Also, I like short messages ;-)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n          \n          \n            \n                            + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n          \n          \n            \n                    logger.error(errorMsg);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);\n          \n          \n            \n                    final String errorMsg = String.format(\"The configured target flavor `%s` has a wrong format.\", configuredTargetFlavor);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496087303", "createdAt": "2020-09-28T16:38:45Z", "author": {"login": "lkiesow"}, "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/ae3986b8d69562a72ac9fcae6bd211139952ad32", "committedDate": "2020-06-10T18:40:52Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}, "afterCommit": {"oid": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "committedDate": "2020-09-30T14:33:44Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "committedDate": "2020-09-30T14:33:44Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}, "afterCommit": {"oid": "d8953199f672eec83d36ac6a939d7fa0ae69174f", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/d8953199f672eec83d36ac6a939d7fa0ae69174f", "committedDate": "2020-09-30T14:43:00Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "committedDate": "2020-09-30T14:59:45Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8953199f672eec83d36ac6a939d7fa0ae69174f", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/d8953199f672eec83d36ac6a939d7fa0ae69174f", "committedDate": "2020-09-30T14:43:00Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}, "afterCommit": {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "author": {"user": null}, "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "committedDate": "2020-09-30T14:59:45Z", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1888, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}