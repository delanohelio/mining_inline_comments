{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjcxODM4", "number": 2067, "title": "fix #2055 Flux#from and Mono#flux apply onAssembly hooks", "bodyText": "", "createdAt": "2020-03-09T15:57:20Z", "url": "https://github.com/reactor/reactor-core/pull/2067", "merged": true, "mergeCommit": {"oid": "bde41ea95edf21a63c2524245abe11763aa7fcc2"}, "closed": true, "closedAt": "2020-04-09T14:26:18Z", "author": {"login": "simonbasle"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMkb5zAFqTM3MjYyOTM5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTHBdDABqjMxODQ1MTc3NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjI5Mzkw", "url": "https://github.com/reactor/reactor-core/pull/2067#pullrequestreview-372629390", "createdAt": "2020-03-11T10:20:13Z", "commit": {"oid": "eca636e5a66bcad7211ad9c0cc8e307d13ec1d07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDoyMDoxM1rOF0w1cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMDoyMDoxM1rOF0w1cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg3MDM4Ng==", "bodyText": "WDYT about splitting it into multiple tests (maybe with some parameterization)?\nIt will be a bit weird when we break one to not know which one exactly :)", "url": "https://github.com/reactor/reactor-core/pull/2067#discussion_r390870386", "createdAt": "2020-03-11T10:20:13Z", "author": {"login": "bsideup"}, "path": "reactor-core/src/test/java/reactor/core/publisher/scenarios/FluxTests.java", "diffHunk": "@@ -1591,6 +1593,48 @@ public void splitBugEventuallyHappens() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void fluxFromCallsAssemblyHook() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eca636e5a66bcad7211ad9c0cc8e307d13ec1d07"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e8dc99a8306feb901c13e88854eb30102bf940d", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/9e8dc99a8306feb901c13e88854eb30102bf940d", "committedDate": "2020-03-12T17:12:19Z", "message": "improve xxxLift stepName(), add public API to convert without hooks"}, "afterCommit": {"oid": "28bebd02482f36161955392ed69c0959f0503da4", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/28bebd02482f36161955392ed69c0959f0503da4", "committedDate": "2020-03-13T15:39:13Z", "message": "fix #2055 Flux#from and Mono#flux apply onAssembly hooks + wrap API\n\nThis commit streamlines the from vs wrap semantics of conversions,\nwhere `wrap` is introduced in `Mono` (also as a package private method).\n\nAdditionally the `from` methods delegates a maximum to `wrap`, and the\n`wrap` semantics are exposed in the public API in `Hooks`. This is\nbecause the differentiator is that these methods don't apply hooks,\nwhich makes them potentially valuable in setting up simple assembly\nhooks.\n\nWe also take that commit as an opportunity to improve the lift operators\n`stepName()` method, which delegates to the lifted publisher."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjMzNjc0", "url": "https://github.com/reactor/reactor-core/pull/2067#pullrequestreview-380233674", "createdAt": "2020-03-24T11:49:56Z", "commit": {"oid": "28bebd02482f36161955392ed69c0959f0503da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo0OTo1NlrOF6spkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo0OTo1NlrOF6spkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5MzI2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif(source instanceof Fuseable){\n          \n          \n            \n            \t\tif(source instanceof Fuseable) {", "url": "https://github.com/reactor/reactor-core/pull/2067#discussion_r397093264", "createdAt": "2020-03-24T11:49:56Z", "author": {"login": "bsideup"}, "path": "reactor-core/src/main/java/reactor/core/publisher/Mono.java", "diffHunk": "@@ -4532,6 +4529,57 @@ public String toString() {\n \t\t\t\tonCancel));\n \t}\n \n+\t/**\n+\t * Unchecked wrap of {@link Publisher} as {@link Mono}, supporting {@link Fuseable} sources.\n+\t * When converting a {@link Mono} or {@link Mono Monos} that have been converted to a {@link Flux} and back,\n+\t * the original {@link Mono} is returned unwrapped.\n+\t * Note that this bypasses {@link Hooks#onEachOperator(String, Function) assembly hooks}.\n+\t *\n+\t * @param source the {@link Publisher} to wrap\n+\t * @param enforceMonoContract {@code} true to wrap publishers without assumption about their cardinality\n+\t * (first {@link Subscriber#onNext(Object)} will cancel the source), {@code false} to behave like {@link #fromDirect(Publisher)}.\n+\t * @param <T> input upstream type\n+\t * @return a wrapped {@link Mono}\n+\t */\n+\tstatic <T> Mono<T> wrap(Publisher<T> source, boolean enforceMonoContract) {\n+\t\t//some sources can be considered already assembled monos\n+\t\t//all conversion methods (from, fromDirect, wrap) must accommodate for this\n+\t\tif (source instanceof Mono) {\n+\t\t\treturn (Mono<T>) source;\n+\t\t}\n+\t\tif (source instanceof FluxSourceMono\n+\t\t\t\t|| source instanceof FluxSourceMonoFuseable) {\n+\t\t\tFluxFromMonoOperator<T, T> wrapper = (FluxFromMonoOperator<T,T>) source;\n+\t\t\t@SuppressWarnings(\"unchecked\")\n+\t\t\tMono<T> extracted = (Mono<T>) wrapper.source;\n+\t\t\treturn extracted;\n+\t\t}\n+\n+\t\t//equivalent to what from used to be, without assembly hooks\n+\t\tif (enforceMonoContract) {\n+\t\t\tif (source instanceof Flux && source instanceof Callable) {\n+\t\t\t\t\t@SuppressWarnings(\"unchecked\") Callable<T> m = (Callable<T>) source;\n+\t\t\t\t\treturn Flux.wrapToMono(m);\n+\t\t\t}\n+\t\t\tif (source instanceof Flux) {\n+\t\t\t\treturn new MonoNext<>((Flux<T>) source);\n+\t\t\t}\n+\t\t\treturn new MonoFromPublisher<>(source);\n+\t\t}\n+\n+\t\t//equivalent to what fromDirect used to be without onAssembly\n+\t\tif(source instanceof Flux && source instanceof Fuseable) {\n+\t\t\treturn new MonoSourceFluxFuseable<>((Flux<T>) source);\n+\t\t}\n+\t\tif (source instanceof Flux) {\n+\t\t\treturn new MonoSourceFlux<>((Flux<T>) source);\n+\t\t}\n+\t\tif(source instanceof Fuseable){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28bebd02482f36161955392ed69c0959f0503da4"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjM2MjUy", "url": "https://github.com/reactor/reactor-core/pull/2067#pullrequestreview-380236252", "createdAt": "2020-03-24T11:53:45Z", "commit": {"oid": "28bebd02482f36161955392ed69c0959f0503da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo1Mzo0NVrOF6sxjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo1Mzo0NVrOF6sxjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5NTMwOA==", "bodyText": "May I ask why not parameterized? :)", "url": "https://github.com/reactor/reactor-core/pull/2067#discussion_r397095308", "createdAt": "2020-03-24T11:53:45Z", "author": {"login": "bsideup"}, "path": "reactor-core/src/test/java/reactor/core/publisher/scenarios/MonoTests.java", "diffHunk": "@@ -304,4 +314,156 @@ public void monoCacheContextHistory() {\n \t\tAssertions.assertThat(cacheHit3).as(\"cacheHit3\").isEqualTo(\"GOOD1\");\n \t\tAssertions.assertThat(contextFillCount).as(\"cacheHit3\").hasValue(4);\n \t}\n+\n+\t@Test\n+\tpublic void monoFromMonoDoesntCallAssemblyHook() {\n+\t\tfinal Mono<Integer> source = Mono.just(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28bebd02482f36161955392ed69c0959f0503da4"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzA1NDkz", "url": "https://github.com/reactor/reactor-core/pull/2067#pullrequestreview-380305493", "createdAt": "2020-03-24T13:27:11Z", "commit": {"oid": "d9b52137c95c50d6a922a99f372e4af482e59b07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDIxODg4", "url": "https://github.com/reactor/reactor-core/pull/2067#pullrequestreview-380421888", "createdAt": "2020-03-24T15:25:55Z", "commit": {"oid": "d9b52137c95c50d6a922a99f372e4af482e59b07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06c9ec87297aea14723b652aa103d70db5567c04", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/06c9ec87297aea14723b652aa103d70db5567c04", "committedDate": "2020-03-31T18:01:23Z", "message": "fix #2055 Flux#from and Mono#flux apply onAssembly hooks + wrap API\n\nThis commit streamlines the from vs wrap semantics of conversions,\nwhere `wrap` is introduced in `Mono` (also as a package private method).\n\nAdditionally the `from` methods delegates a maximum to `wrap`, and the\n`wrap` semantics are exposed in the public API in `Hooks`. This is\nbecause the differentiator is that these methods don't apply hooks,\nwhich makes them potentially valuable in setting up simple assembly\nhooks.\n\nWe also take that commit as an opportunity to improve the lift operators\n`stepName()` method, which delegates to the lifted publisher."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "226abf213a7713ce082ad55e0aa2b96260d9f52c", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/226abf213a7713ce082ad55e0aa2b96260d9f52c", "committedDate": "2020-03-31T18:01:23Z", "message": "formatting: add missing space\n\nCo-Authored-By: Sergei Egorov <1050762+bsideup@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9b52137c95c50d6a922a99f372e4af482e59b07", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/d9b52137c95c50d6a922a99f372e4af482e59b07", "committedDate": "2020-03-24T13:24:25Z", "message": "formatting: add missing space\n\nCo-Authored-By: Sergei Egorov <1050762+bsideup@users.noreply.github.com>"}, "afterCommit": {"oid": "226abf213a7713ce082ad55e0aa2b96260d9f52c", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/226abf213a7713ce082ad55e0aa2b96260d9f52c", "committedDate": "2020-03-31T18:01:23Z", "message": "formatting: add missing space\n\nCo-Authored-By: Sergei Egorov <1050762+bsideup@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2919, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}