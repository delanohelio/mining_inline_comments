{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3MzI1MDc1", "number": 2505, "title": "fix #2502 Generate OSGI Bundle-Version from Europium+ scheme", "bodyText": "This commit ensures that the OSGI Bundle-Version is consistently\ncomparable between snapshots, milestones and release versions using\nthe new versioning scheme introduced in Europium/2020.0, by forcing\na Bundle-Version similar to the old scheme for OSGI.\nSee reactor/reactor#689 for context.", "createdAt": "2020-11-25T10:01:35Z", "url": "https://github.com/reactor/reactor-core/pull/2505", "merged": true, "mergeCommit": {"oid": "666c8c9a1677ffee75412396a5d66bcac2f02753"}, "closed": true, "closedAt": "2020-12-01T09:05:44Z", "author": {"login": "simonbasle"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf82rhgFqTUzODQxMjY5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhnfMFAFqTU0MTA0NjUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDEyNjk2", "url": "https://github.com/reactor/reactor-core/pull/2505#pullrequestreview-538412696", "createdAt": "2020-11-25T11:42:55Z", "commit": {"oid": "f6dbe7c169b8b31a1cfc3d60b2ba915d4dbfe609"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMTo0Mjo1NVrOH5vpHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMTo0Mjo1NVrOH5vpHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMTQ1Mg==", "bodyText": "For export packages, the plugin removes the qualifier from the version when it is *-SNAPSHOT and thus we have only\n${versionNumber.major}.${versionNumber.minor}.${versionNumber.micro} which is not correct for snapshots versions.\nBetter option here will be to add BUILD-timestamp thus we will be able to distinguish between the different snapshot versions.", "url": "https://github.com/reactor/reactor-core/pull/2505#discussion_r530311452", "createdAt": "2020-11-25T11:42:55Z", "author": {"login": "violetagg"}, "path": "build.gradle", "diffHunk": "@@ -48,6 +50,20 @@ ext {\n \t}\n \tprintln \"JDK Javadoc link for this build is ${rootProject.jdkJavadoc}\"\n \n+\tversionNumber = VersionNumber.parse(version.toString())\n+\tif (versionNumber.qualifier == null || versionNumber.qualifier.size() == 0) {\n+\t\tosgiVersion = \"${version}.RELEASE\"\n+\t\tprintln \"$version is a release, will use $osgiVersion for bnd\"\n+\t}\n+\telse if (versionNumber.qualifier.equalsIgnoreCase(\"SNAPSHOT\")) {\n+\t\tosgiVersion = \"${versionNumber.major}.${versionNumber.minor}.${versionNumber.micro}.BUILD-SNAPSHOT\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6dbe7c169b8b31a1cfc3d60b2ba915d4dbfe609"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MTg0NjYx", "url": "https://github.com/reactor/reactor-core/pull/2505#pullrequestreview-539184661", "createdAt": "2020-11-26T10:26:50Z", "commit": {"oid": "c1f79bc59e56d7f1036b09cad8e4bd36e2dac5c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDoyNjo1MFrOH6VJWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDoyNjo1MFrOH6VJWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkyNTkxNQ==", "bodyText": "@simonbasle  I think the issue with the -snapshot version was here. BND is processing -snaptshot the Bundle-Version attribute AFTER it's processing the exports.\nThe reason for that is that you wouldn't want to have export-package versions like 3.4.1.BUILD-202011261127 but you always want to have export-package versions like 3.4.1\nTherefore at the point of the export-package attribute OSGi sees following version:\n3.4.1-SNAPSHOT\nwhich OSGi can't parse as a valid OSGi version because OSGi would require a qualifier with a dot (.):\n3.4.1.SNAPSHOT\nWhen the Bundle-Version is not a valid OSGi version the qualifier is not removed for package exports as BND does for valid OSGi versions. So for Export-Package BND would convert the Bundle-Version \"3.4.1.SNAPSHOT\" into \"3.4.1\" for package exports (valid OSGi version, stripping qualifier) but when it's not a valid OSGi version as with \"3.4.1-SNAPSHOT\" the version is kept as it is so it results in \"3.4.1-SNAPTSHOT\" package versions.\nI would say that this is really inconvenient and I will create a BND issue for that.\nAs a result of that to get proper Export-Package versions we would need to define a custom osgiVersion anyways because we would need to convert the maven version 3.4.1-SNAPSHOT into 3.4.1.SNAPSHOT here therefore using the bnd instruction -snapshot is not really worth it because we have to do the version conversion anyway.", "url": "https://github.com/reactor/reactor-core/pull/2505#discussion_r530925915", "createdAt": "2020-11-26T10:26:50Z", "author": {"login": "swimmesberger"}, "path": "build.gradle", "diffHunk": "@@ -55,13 +55,14 @@ ext {\n \t\tosgiVersion = \"${version}.RELEASE\"\n \t\tprintln \"$version is a release, will use $osgiVersion for bnd\"\n \t}\n-\telse if (versionNumber.qualifier.equalsIgnoreCase(\"SNAPSHOT\")) {\n+\telse if (!versionNumber.qualifier.equalsIgnoreCase(\"SNAPSHOT\")) {\n+\t\tosgiVersion = \"${versionNumber.major}.${versionNumber.minor}.${versionNumber.micro}.${versionNumber.qualifier}\"\n+\t\tprintln \"$version is neither release nor snapshot, will use $osgiVersion for bnd\"\n \t\tosgiVersion = \"${versionNumber.major}.${versionNumber.minor}.${versionNumber.micro}.BUILD-SNAPSHOT\"\n-\t\tprintln \"$version is a snapshot, will use $osgiVersion for bnd\"\n \t}\n \telse {\n-\t\tosgiVersion = \"${versionNumber.major}.${versionNumber.minor}.${versionNumber.micro}.${versionNumber.qualifier}\"\n-\t\tprintln \"$version is neither release nor snapshot, will use $osgiVersion for bnd\"\n+\t\tosgiVersion = version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1f79bc59e56d7f1036b09cad8e4bd36e2dac5c7"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d6e79c4fe65118b4e69d284239c2b8efb81b1b", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/34d6e79c4fe65118b4e69d284239c2b8efb81b1b", "committedDate": "2020-11-27T10:34:07Z", "message": "fix #2502 Generate OSGI Bundle-Version from Europium+ scheme\n\nThis commit ensures that the OSGI Bundle-Version is consistently\ncomparable between snapshots, milestones and release versions using\nthe new versioning scheme introduced in Europium/2020.0, by forcing\na Bundle-Version similar to the old scheme for OSGI.\n\nSee reactor/reactor#689 for context."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ebe267e35dc7a2cc84859b72aca93d746192c34", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/0ebe267e35dc7a2cc84859b72aca93d746192c34", "committedDate": "2020-11-27T10:34:07Z", "message": "use bnd -snapshot to replace -SNAPSHOT with .BUILD-tstamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fe979e5920ce7eb158a5f1fa979460d3bbc5a2a", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/4fe979e5920ce7eb158a5f1fa979460d3bbc5a2a", "committedDate": "2020-11-27T10:34:07Z", "message": "Revert \"use bnd -snapshot to replace -SNAPSHOT with .BUILD-tstamp\"\n\nThis reverts commit c1f79bc59e56d7f1036b09cad8e4bd36e2dac5c7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab0007fc62621cf1fea8115149ab27ad8fe1e83", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/9ab0007fc62621cf1fea8115149ab27ad8fe1e83", "committedDate": "2020-11-27T10:41:23Z", "message": "Manually set OSGI qualifier to BUILD-timestamp for snapshots\n\nThis avoids using BND -snapshot instruction which keeps the `-SNAPSHOT`\npart in the versions inside Export-Package clause.\n\nThe resulting bundle version is sorted below releases (which get\na .RELEASE suffix). Note this means they'll also continue being sorted\nbelow milestones (.Mx suffix) and release candidates (.RCx suffix),\nas was the case in the old scheme."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3501e64ec563f51c57e85e0c6e70f4ac9cf5f4f", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/a3501e64ec563f51c57e85e0c6e70f4ac9cf5f4f", "committedDate": "2020-11-26T09:42:15Z", "message": "Revert \"use bnd -snapshot to replace -SNAPSHOT with .BUILD-tstamp\"\n\nThis reverts commit c1f79bc59e56d7f1036b09cad8e4bd36e2dac5c7."}, "afterCommit": {"oid": "9ab0007fc62621cf1fea8115149ab27ad8fe1e83", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/9ab0007fc62621cf1fea8115149ab27ad8fe1e83", "committedDate": "2020-11-27T10:41:23Z", "message": "Manually set OSGI qualifier to BUILD-timestamp for snapshots\n\nThis avoids using BND -snapshot instruction which keeps the `-SNAPSHOT`\npart in the versions inside Export-Package clause.\n\nThe resulting bundle version is sorted below releases (which get\na .RELEASE suffix). Note this means they'll also continue being sorted\nbelow milestones (.Mx suffix) and release candidates (.RCx suffix),\nas was the case in the old scheme."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "698252a52743aeb093bf44689a6a2113c0a9efa4", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/698252a52743aeb093bf44689a6a2113c0a9efa4", "committedDate": "2020-11-27T17:30:20Z", "message": "Add osgiVersion to Export-Package entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTIwNzM3", "url": "https://github.com/reactor/reactor-core/pull/2505#pullrequestreview-540120737", "createdAt": "2020-11-27T17:46:17Z", "commit": {"oid": "698252a52743aeb093bf44689a6a2113c0a9efa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNzo0NjoxN1rOH7FUvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNzo0NjoxN1rOH7FUvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxNTI2MA==", "bodyText": "I have seen that \"-noimport:=true\" is used in the reactor-test module we could use that here too which would make the manifest a little bit cleaner because the exported packages are then not listed in the import-package attribute and there is not really any downside to it (that I know of).\nThe specification says following (3.6.5):\n\nAn export definition does not imply an automatic import definition. A bundle that exports a package and does not import that package will get that package via its bundle class path. Such an exported only package can be used by other bundles, but the exporting bundle does not accept a substitution for this package from another bundle.\n\nI just think that it should be consistent between all reactor modules. So if you use -noimport for one module it should be used for the others too if not than it should be removed for the reactor-test module (?)", "url": "https://github.com/reactor/reactor-core/pull/2505#discussion_r531715260", "createdAt": "2020-11-27T17:46:17Z", "author": {"login": "swimmesberger"}, "path": "reactor-core/build.gradle", "diffHunk": "@@ -38,7 +38,7 @@ ext {\n \t\t\"Export-Package\": [\n \t\t\t\"!*internal*\",\n \t\t\t\"!reactor.blockhound*\",\n-\t\t\t\"reactor.*\"\n+\t\t\t\"reactor.*;version=$osgiVersion\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "698252a52743aeb093bf44689a6a2113c0a9efa4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDQ2NTEy", "url": "https://github.com/reactor/reactor-core/pull/2505#pullrequestreview-541046512", "createdAt": "2020-11-30T15:57:06Z", "commit": {"oid": "698252a52743aeb093bf44689a6a2113c0a9efa4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2704, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}