{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MjU2MzY3", "number": 2100, "title": "fix #2077 Support doOnDiscard in SerializedSubscriber", "bodyText": "TODO: document which operators better support doOnDiscard transitively.\nAlso test the specific case reported in the #2077 issue (retryWhen)\ufeff", "createdAt": "2020-04-03T16:00:22Z", "url": "https://github.com/reactor/reactor-core/pull/2100", "merged": true, "mergeCommit": {"oid": "cb862ff617e9692a55f0f66386f8d4dd26ae5797"}, "closed": true, "closedAt": "2020-04-20T07:59:54Z", "author": {"login": "simonbasle"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUDETbgH2gAyMzk4MjU2MzY3OjAzNzk4Y2M3OTIwNjFlYmMxZTgwZmZiNDAyMDQ5ZTQxMDhmN2ZhYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYm8W3gFqTM5NTczNzk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "03798cc792061ebc1e80ffb402049e4108f7fab6", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/03798cc792061ebc1e80ffb402049e4108f7fab6", "committedDate": "2020-04-03T15:58:59Z", "message": "fix #2077 Support doOnDiscard in SerializedSubscriber"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzkxNDU0", "url": "https://github.com/reactor/reactor-core/pull/2100#pullrequestreview-387391454", "createdAt": "2020-04-03T16:08:16Z", "commit": {"oid": "03798cc792061ebc1e80ffb402049e4108f7fab6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjowODoxN1rOGAb_5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjowODoxN1rOGAb_5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExMTkxMQ==", "bodyText": "nit: wrong indentation", "url": "https://github.com/reactor/reactor-core/pull/2100#discussion_r403111911", "createdAt": "2020-04-03T16:08:17Z", "author": {"login": "bsideup"}, "path": "reactor-core/src/main/java/reactor/core/publisher/SerializedSubscriber.java", "diffHunk": "@@ -232,6 +259,25 @@ else if (d) {\n \t\t}\n \t}\n \n+\tprivate void discardMultiple(LinkedArrayNode<T> head) {\n+\t\tsynchronized (actual) {\n+\t\tLinkedArrayNode<T> originalHead = head;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03798cc792061ebc1e80ffb402049e4108f7fab6"}, "originalPosition": 162}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9eda6445f8ee7bbe661284cedd9f00d1229deb", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/1d9eda6445f8ee7bbe661284cedd9f00d1229deb", "committedDate": "2020-04-03T16:19:11Z", "message": "polish, remove redundant sync, add more comments and loop iterations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODQzMTEw", "url": "https://github.com/reactor/reactor-core/pull/2100#pullrequestreview-387843110", "createdAt": "2020-04-05T17:47:29Z", "commit": {"oid": "1d9eda6445f8ee7bbe661284cedd9f00d1229deb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxNzo0NzoyOVrOGBCATw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxNzo0ODowMVrOGBCAhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczNDYwNw==", "bodyText": "Should not we use Operators.onNextDropped here?\noperators discard is Reactor only feature, so someone who uses another framework (yeah, if reactor meets non-reactor publisher, then SerializedSubscriber applies) then it is going to be impossible to handle discarded element at all.\nAlso, I found it really confusing having onDrop and discard unintegrated, which means that if no on discard hooks, most likely onDrop should be applied and element should find at least something", "url": "https://github.com/reactor/reactor-core/pull/2100#discussion_r403734607", "createdAt": "2020-04-05T17:47:29Z", "author": {"login": "OlegDokuka"}, "path": "reactor-core/src/main/java/reactor/core/publisher/SerializedSubscriber.java", "diffHunk": "@@ -69,21 +69,23 @@ public void onSubscribe(Subscription s) {\n \t@Override\n \tpublic void onNext(T t) {\n \t\tif (cancelled || done) {\n+\t\t\tOperators.onDiscard(t, actual.currentContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9eda6445f8ee7bbe661284cedd9f00d1229deb"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczNDY0MQ==", "bodyText": "same as above", "url": "https://github.com/reactor/reactor-core/pull/2100#discussion_r403734641", "createdAt": "2020-04-05T17:47:43Z", "author": {"login": "OlegDokuka"}, "path": "reactor-core/src/main/java/reactor/core/publisher/SerializedSubscriber.java", "diffHunk": "@@ -69,21 +69,23 @@ public void onSubscribe(Subscription s) {\n \t@Override\n \tpublic void onNext(T t) {\n \t\tif (cancelled || done) {\n+\t\t\tOperators.onDiscard(t, actual.currentContext());\n \t\t\treturn;\n \t\t}\n \n \t\tsynchronized (this) {\n \t\t\tif (cancelled || done) {\n+\t\t\t\tOperators.onDiscard(t, actual.currentContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9eda6445f8ee7bbe661284cedd9f00d1229deb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczNDY2Mw==", "bodyText": "same as above", "url": "https://github.com/reactor/reactor-core/pull/2100#discussion_r403734663", "createdAt": "2020-04-05T17:48:01Z", "author": {"login": "OlegDokuka"}, "path": "reactor-core/src/main/java/reactor/core/publisher/SerializedSubscriber.java", "diffHunk": "@@ -148,6 +150,11 @@ public void cancel() {\n \t}\n \n \tvoid serAdd(T value) {\n+\t\tif (cancelled) {\n+\t\t\tOperators.onDiscard(value, actual.currentContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9eda6445f8ee7bbe661284cedd9f00d1229deb"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56d530eafab24a12fa6e9c624b2e0f078f54c4a8", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/56d530eafab24a12fa6e9c624b2e0f078f54c4a8", "committedDate": "2020-04-06T08:49:04Z", "message": "Split cancelled vs done cases for onNext: discard vs drop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9cad9abaae4bdc9eac8a57673bf28d173a83a50", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/d9cad9abaae4bdc9eac8a57673bf28d173a83a50", "committedDate": "2020-04-06T08:49:19Z", "message": "add test from the issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6ef818de74da0ad653d6277d60c4648b2136f46", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/e6ef818de74da0ad653d6277d60c4648b2136f46", "committedDate": "2020-04-06T09:46:55Z", "message": "polish test to account for hiccups in async cancellation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e10a2d7862947c99e5d863d1931d8c4961ab6172", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/e10a2d7862947c99e5d863d1931d8c4961ab6172", "committedDate": "2020-04-06T09:48:48Z", "message": "polish test remove onNextDropped evaluation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MjA2NTU2", "url": "https://github.com/reactor/reactor-core/pull/2100#pullrequestreview-388206556", "createdAt": "2020-04-06T12:37:48Z", "commit": {"oid": "e10a2d7862947c99e5d863d1931d8c4961ab6172"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Nzk3MDM3", "url": "https://github.com/reactor/reactor-core/pull/2100#pullrequestreview-394797037", "createdAt": "2020-04-16T16:21:43Z", "commit": {"oid": "e10a2d7862947c99e5d863d1931d8c4961ab6172"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNjoyMTo0M1rOGGtONg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNjoyMTo0M1rOGGtONg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY4NTU1OA==", "bodyText": "dead code, oops", "url": "https://github.com/reactor/reactor-core/pull/2100#discussion_r409685558", "createdAt": "2020-04-16T16:21:43Z", "author": {"login": "simonbasle"}, "path": "reactor-core/src/main/java/reactor/core/publisher/SerializedSubscriber.java", "diffHunk": "@@ -182,22 +206,27 @@ void serDrainLoop(CoreSubscriber<? super T> actual) {\n \n \t\t\tsynchronized (this) {\n \t\t\t\tif (cancelled) {\n+\t\t\t\t\tdiscardMultiple(this.head);\n \t\t\t\t\treturn;\n \t\t\t\t}\n \n-\t\t\t\tif (!missed) {\n-\t\t\t\t\temitting = false;\n+\t\t\t\tif (!concurrentlyAddedContent) {\n+\t\t\t\t\tdrainLoopInProgress = false;\n \t\t\t\t\treturn;\n \t\t\t\t}\n \n-\t\t\t\tmissed = false;\n+\t\t\t\tconcurrentlyAddedContent = false;\n \n \t\t\t\td = done;\n \t\t\t\te = error;\n \t\t\t\tn = head;\n \n \t\t\t\thead = null;\n \t\t\t\ttail = null;\n+\n+//\t\t\t\tif (cancelled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e10a2d7862947c99e5d863d1931d8c4961ab6172"}, "originalPosition": 141}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9965b247c3d89e8177a9318209a237deb4fad41e", "author": {"user": {"login": "simonbasle", "name": "Simon Basl\u00e9"}}, "url": "https://github.com/reactor/reactor-core/commit/9965b247c3d89e8177a9318209a237deb4fad41e", "committedDate": "2020-04-16T16:37:40Z", "message": "Add a bit more javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzM3OTgx", "url": "https://github.com/reactor/reactor-core/pull/2100#pullrequestreview-395737981", "createdAt": "2020-04-17T20:02:35Z", "commit": {"oid": "9965b247c3d89e8177a9318209a237deb4fad41e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2940, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}