{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NDY3ODMy", "number": 2194, "title": "fix #2189 Ensure tools fat jar is the one published", "bodyText": "The reactor-tools subproject is using the shadow plugin to create\na fat jar, and wants this fat jar to replace the main jar. To do so,\nthe normal jar that Gradle produces is replaced with a classifier,\noriginal, and the shadow jar is produced without classifier.\nThe publication is then configured to add the \"shadow\" jar to the\nnormal publication. However, this is incorrect: the Gradle component\nmodel describes that the \"apiElements\" and \"runtimeElements\" use\nthe output of the jar task as the main artifact. As a consequence,\nwhen publishing Gradle module metadata, the module file says that\nthe file to be fetched is the one produced by the jar task, which\nhas the original classifier.\nInstead, if the API and runtime of the reactor-tools project need\nto use the shadow jar, then the shadow jar needs to be set as the\nmain artifact.\nThis is what this commit does:\n\nit replaces the default artifact that Gradle uses publication with\nthe \"shadow\" jar\nit adds the \"original\" jar as an extra, out of context, artifact\nto upload alongside the shadow jar\n\nIn addition, it configures a dummy repository which can be used to\n\"see\" what Gradle would publish. By running the:\npublishMavenJavaPublicationToMockRepository task, Gradle will\ncreate a dummy repository in /build/repo which contains\nwhat it would upload to Artifactory. This way you can quickly\ncheck what is produced before actually releasing. In particular,\nyou can check the module files.\nNote that this problem doesn't happen with Maven consumers because\nMaven doesn't care about variants. Therefore, it only looks for the\n\"main\" jar based on its name. Gradle, on the other hand, is variant\naware, meaning that it will select an artifact based on the variant\ninformation found in the module file.\nThis file tells it to fetch the \"original\" file for the API, so it\ndoes.\nLast but not least, Gradle can actually model that both variants,\nthe \"shadow\" and the \"original\" ones are published, and let the\nconsumers choose which one they need.\nThis can be fixed in a separate PR if you are interested.\nFixes #2189", "createdAt": "2020-06-16T21:08:42Z", "url": "https://github.com/reactor/reactor-core/pull/2194", "merged": true, "mergeCommit": {"oid": "a738652ce14ae962e9c289899327bdd2cd5dcd80"}, "closed": true, "closedAt": "2020-06-19T17:07:59Z", "author": {"login": "melix"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsE_hOgFqTQzMjE0MjcwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsgc-xAFqTQzMzQxNzQ4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTQyNzA5", "url": "https://github.com/reactor/reactor-core/pull/2194#pullrequestreview-432142709", "createdAt": "2020-06-17T07:47:45Z", "commit": {"oid": "46c8668a9b7498bede686988dc2014bad0e75813"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d18dc66dee2566690fcc91892e983943172b00a", "author": {"user": {"login": "melix", "name": "C\u00e9dric Champeau"}}, "url": "https://github.com/reactor/reactor-core/commit/2d18dc66dee2566690fcc91892e983943172b00a", "committedDate": "2020-06-17T07:53:44Z", "message": "Fix incorrect jar being published\n\nThe `reactor-tools` subproject is using the shadow plugin to create\na fat jar, and wants this fat jar to replace the main jar. To do so,\nthe normal jar that Gradle produces is replaced with a classifier,\n`original`, and the shadow jar is produced without classifier.\n\nThe publication is then configured to add the \"shadow\" jar to the\nnormal publication. However, this is incorrect: the Gradle component\nmodel describes that the \"apiElements\" and \"runtimeElements\" use\nthe output of the `jar` task as the main artifact. As a consequence,\nwhen publishing Gradle module metadata, the module file says that\nthe file to be fetched is the one produced by the `jar` task, which\nhas the `original` classifier.\n\nInstead, if the API and runtime of the `reactor-tools` project need\nto use the shadow jar, then the shadow jar needs to be set as the\nmain artifact.\n\nThis is what this commit does:\n\n- it replaces the default artifact that Gradle uses publication with\nthe \"shadow\" jar\n- it adds the \"original\" jar as an extra, out of context, artifact\nto upload alongside the shadow jar\n\nIn addition, it configures a dummy repository which can be used to\n\"see\" what Gradle would publish. By running the:\n\n`publishMavenJavaPublicationToMockRepository` task, Gradle will\ncreate a dummy repository in <rootDir>/build/repo which contains\nwhat it would upload to Artifactory. This way you can quickly\ncheck what is produced before actually releasing. In particular,\nyou can check the module files.\n\nNote that this problem doesn't happen with Maven consumers because\nMaven doesn't care about variants. Therefore, it only looks for the\n\"main\" jar based on its name. Gradle, on the other hand, is variant\naware, meaning that it will select an artifact based on the variant\ninformation found in the module file.\n\nThis file tells it to fetch the \"original\" file for the API, so it\ndoes.\n\nLast but not least, Gradle can actually model that both variants,\nthe \"shadow\" and the \"original\" ones are published, and let the\nconsumers choose which one they need.\n\nThis can be fixed in a separate PR if you are interested.\n\nFixes #2189"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46c8668a9b7498bede686988dc2014bad0e75813", "author": {"user": {"login": "melix", "name": "C\u00e9dric Champeau"}}, "url": "https://github.com/reactor/reactor-core/commit/46c8668a9b7498bede686988dc2014bad0e75813", "committedDate": "2020-06-16T20:58:45Z", "message": "Fix incorrect jar being published\n\nThe `reactor-tools` subproject is using the shadow plugin to create\na fat jar, and wants this fat jar to replace the main jar. To do so,\nthe normal jar that Gradle produces is replaced with a classifier,\n`original`, and the shadow jar is produced without classifier.\n\nThe publication is then configured to add the \"shadow\" jar to the\nnormal publication. However, this is incorrect: the Gradle component\nmodel describes that the \"apiElements\" and \"runtimeElements\" use\nthe output of the `jar` task as the main artifact. As a consequence,\nwhen publishing Gradle module metadata, the module file says that\nthe file to be fetched is the one produced by the `jar` task, which\nhas the `original` classifier.\n\nInstead, if the API and runtime of the `reactor-tools` project need\nto use the shadow jar, then the shadow jar needs to be set as the\nmain artifact.\n\nThis is what this commit does:\n\n- it replaces the default artifact that Gradle uses publication with\nthe \"shadow\" jar\n- it adds the \"original\" jar as an extra, out of context, artifact\nto upload alongside the shadow jar\n\nIn addition, it configures a dummy repository which can be used to\n\"see\" what Gradle would publish. By running the:\n\n`publishMavenJavaPublicationToMockRepository` task, Gradle will\ncreate a dummy repository in <rootDir>/build/repo which contains\nwhat it would upload to Artifactory. This way you can quickly\ncheck what is produced before actually releasing. In particular,\nyou can check the module files.\n\nNote that this problem doesn't happen with Maven consumers because\nMaven doesn't care about variants. Therefore, it only looks for the\n\"main\" jar based on its name. Gradle, on the other hand, is variant\naware, meaning that it will select an artifact based on the variant\ninformation found in the module file.\n\nThis file tells it to fetch the \"original\" file for the API, so it\ndoes.\n\nLast but not least, Gradle can actually model that both variants,\nthe \"shadow\" and the \"original\" ones are published, and let the\nconsumers choose which one they need.\n\nThis can be fixed in a separate PR if you are interested.\n\nFixes #2189"}, "afterCommit": {"oid": "2d18dc66dee2566690fcc91892e983943172b00a", "author": {"user": {"login": "melix", "name": "C\u00e9dric Champeau"}}, "url": "https://github.com/reactor/reactor-core/commit/2d18dc66dee2566690fcc91892e983943172b00a", "committedDate": "2020-06-17T07:53:44Z", "message": "Fix incorrect jar being published\n\nThe `reactor-tools` subproject is using the shadow plugin to create\na fat jar, and wants this fat jar to replace the main jar. To do so,\nthe normal jar that Gradle produces is replaced with a classifier,\n`original`, and the shadow jar is produced without classifier.\n\nThe publication is then configured to add the \"shadow\" jar to the\nnormal publication. However, this is incorrect: the Gradle component\nmodel describes that the \"apiElements\" and \"runtimeElements\" use\nthe output of the `jar` task as the main artifact. As a consequence,\nwhen publishing Gradle module metadata, the module file says that\nthe file to be fetched is the one produced by the `jar` task, which\nhas the `original` classifier.\n\nInstead, if the API and runtime of the `reactor-tools` project need\nto use the shadow jar, then the shadow jar needs to be set as the\nmain artifact.\n\nThis is what this commit does:\n\n- it replaces the default artifact that Gradle uses publication with\nthe \"shadow\" jar\n- it adds the \"original\" jar as an extra, out of context, artifact\nto upload alongside the shadow jar\n\nIn addition, it configures a dummy repository which can be used to\n\"see\" what Gradle would publish. By running the:\n\n`publishMavenJavaPublicationToMockRepository` task, Gradle will\ncreate a dummy repository in <rootDir>/build/repo which contains\nwhat it would upload to Artifactory. This way you can quickly\ncheck what is produced before actually releasing. In particular,\nyou can check the module files.\n\nNote that this problem doesn't happen with Maven consumers because\nMaven doesn't care about variants. Therefore, it only looks for the\n\"main\" jar based on its name. Gradle, on the other hand, is variant\naware, meaning that it will select an artifact based on the variant\ninformation found in the module file.\n\nThis file tells it to fetch the \"original\" file for the API, so it\ndoes.\n\nLast but not least, Gradle can actually model that both variants,\nthe \"shadow\" and the \"original\" ones are published, and let the\nconsumers choose which one they need.\n\nThis can be fixed in a separate PR if you are interested.\n\nFixes #2189"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTc5ODI1", "url": "https://github.com/reactor/reactor-core/pull/2194#pullrequestreview-432179825", "createdAt": "2020-06-17T08:35:49Z", "commit": {"oid": "2d18dc66dee2566690fcc91892e983943172b00a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODozNTo0OVrOGk7ioQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODozNTo0OVrOGk7ioQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NzQ0MQ==", "bodyText": "@melix just curious, why not already available publishToMavenLocal? Or would you recommend against using it?\n/cc @simonbasle", "url": "https://github.com/reactor/reactor-core/pull/2194#discussion_r441377441", "createdAt": "2020-06-17T08:35:49Z", "author": {"login": "bsideup"}, "path": "gradle/setup.gradle", "diffHunk": "@@ -37,6 +37,12 @@ task javadocJar(type: Jar) {\n }\n \n publishing {\n+    repositories {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d18dc66dee2566690fcc91892e983943172b00a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDE3NDgw", "url": "https://github.com/reactor/reactor-core/pull/2194#pullrequestreview-433417480", "createdAt": "2020-06-18T15:47:22Z", "commit": {"oid": "2d18dc66dee2566690fcc91892e983943172b00a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2996, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}