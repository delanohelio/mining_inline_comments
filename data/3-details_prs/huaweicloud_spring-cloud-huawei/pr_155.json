{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Mjc5Njc5", "number": 155, "title": "Optimize discovery module.", "bodyText": "Optimize  discovery module:\n\nsupport AZ affinity\nInstances of different AZ will take a long time. The same AZ instance is preferred.\nuse revision reduce request:\nAccess the service center with revision, and return 304 when there is no updated information.\nhandle empty server list\nAfter the service center goes online again after a period of downtime, because there is no heartbeat renewal, the service center will clean up the normal instances and return them to the empty list.", "createdAt": "2020-03-31T11:51:11Z", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155", "merged": true, "mergeCommit": {"oid": "267971b1ad9503aff95713dc209f64aea2aa5251"}, "closed": true, "closedAt": "2020-04-02T12:27:05Z", "author": {"login": "GuoYL123"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTBtfPAH2gAyMzk2Mjc5Njc5OjI2YjJiN2Q0ZmI5MDdhMDY3M2E0MWEyNTE4ZGFlZmUyZmExZTQxZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTq9p8ABqjMxOTE4Mzc2MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/26b2b7d4fb907a0673a41a2518daefe2fa1e41ee", "committedDate": "2020-03-31T11:50:14Z", "message": "handle empty server list / use revision reduce request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTk5NzIx", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385199721", "createdAt": "2020-04-01T00:51:50Z", "commit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDo1MTo1MVrOF-tMGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDo1MTo1MVrOF-tMGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5NjQwOQ==", "bodyText": "This check seams not neccessary.", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401296409", "createdAt": "2020-04-01T00:51:51Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/Response.java", "diffHunk": "@@ -28,6 +32,21 @@\n \n   private String content;\n \n+  private Map<String, String> headers = new HashMap<>();\n+\n+  public String getHeader(String key) {\n+    if (!headers.containsKey(key)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjA0Mzk0", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385204394", "createdAt": "2020-04-01T01:08:05Z", "commit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowODowNVrOF-tc8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowODowNVrOF-tc8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMDcyMA==", "bodyText": "Define a setter is better, e.g. addServiceReivison(String, String). Or must difine it to be final .", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401300720", "createdAt": "2020-04-01T01:08:05Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceHandler.java", "diffHunk": "@@ -39,9 +41,15 @@\n \n   private static List<ServiceInstance> instanceList = Collections.emptyList();\n \n+  public static Map<String, String> serviceRevision = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjA0Nzk1", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385204795", "createdAt": "2020-04-01T01:09:26Z", "commit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowOToyNlrOF-teVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowOToyNlrOF-teVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTA3OA==", "bodyText": "Formate this code", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401301078", "createdAt": "2020-04-01T01:09:26Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/client/ServiceCombClientTest.java", "diffHunk": "@@ -210,7 +210,7 @@ public void getInstances(@Injectable\n       }\n     };\n     ServiceCombClient serviceCombClient = new ServiceCombClient(url, httpTransport);\n-    List<ServiceInstance> actual = serviceCombClient.getInstances(microservice);\n+    List<ServiceInstance> actual = serviceCombClient.getInstances(microservice,null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjA0OTIw", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385204920", "createdAt": "2020-04-01T01:09:47Z", "commit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowOTo0N1rOF-tesw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTowOTo0N1rOF-tesw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwMTE3MQ==", "bodyText": "Format this code", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401301171", "createdAt": "2020-04-01T01:09:47Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceHandlerTest.java", "diffHunk": "@@ -54,7 +54,7 @@ public void getInstances(@Injectable ServiceCombClient serviceCombClient)\n     microservice.setServiceName(\"testservice\");\n     new Expectations() {\n       {\n-        serviceCombClient.getInstances(microservice);\n+        serviceCombClient.getInstances(microservice,\"0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26b2b7d4fb907a0673a41a2518daefe2fa1e41ee"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "committedDate": "2020-04-01T06:11:01Z", "message": "support multi az"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b887242e31276f1342c8c89d40b938d6986fbd8", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/3b887242e31276f1342c8c89d40b938d6986fbd8", "committedDate": "2020-04-01T04:01:38Z", "message": "support multi az"}, "afterCommit": {"oid": "9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9010b7d0a1a49db3e435dbf74f52cdfa1258298e", "committedDate": "2020-04-01T06:11:01Z", "message": "support multi az"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzE3ODA1", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385317805", "createdAt": "2020-04-01T07:13:03Z", "commit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMzowNFrOF-zj4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMzowNFrOF-zj4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMDgwMw==", "bodyText": "format code", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401400803", "createdAt": "2020-04-01T07:13:04Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/ribbon/ServiceCombServerListTest.java", "diffHunk": "@@ -85,21 +92,23 @@ public URI getUri() {\n \n       @Override\n       public Map<String, String> getMetadata() {\n-        return null;\n+        Map<String, String> map = new HashMap<>();\n+        map.put(\"status\", MicroserviceInstanceStatus.UP.name());\n+        return map;\n       }\n     };\n     instanceList.add(serviceInstance);\n     new Expectations() {\n       {\n         iClientConfig.getClientName();\n         result = \"serviceid11\";\n-        serviceCombClient.getInstances((Microservice) any);\n+        serviceCombClient.getInstances((Microservice) any,null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzE4MTQ5", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385318149", "createdAt": "2020-04-01T07:13:40Z", "commit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMzo0MFrOF-zlEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMzo0MFrOF-zlEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMTEwNQ==", "bodyText": "format code", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401401105", "createdAt": "2020-04-01T07:13:40Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/KieAddrSeekerImpl.java", "diffHunk": "@@ -28,7 +28,7 @@ public String getKieAddr() {\n     microservice.setServiceName(\"servicecomb-kie\");\n     List<ServiceInstance> instanceList;\n     try {\n-      instanceList = serviceCombClient.getInstances(microservice);\n+      instanceList = serviceCombClient.getInstances(microservice,null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzE5NjU5", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385319659", "createdAt": "2020-04-01T07:16:12Z", "commit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxNjoxMlrOF-zpdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxNjoxMlrOF-zpdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMjIzMA==", "bodyText": "I am not sure where getMicroserviceIns is called. Seams use microservice instance id as the key is better. Not all endpoints starts with rest.", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#discussion_r401402230", "createdAt": "2020-04-01T07:16:12Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/discovery/MicroserviceCache.java", "diffHunk": "@@ -35,19 +35,17 @@ public static void initService(List<Microservice> list) {\n         list.forEach(item ->\n                 item.getInstances().forEach(ins -> {\n                     ins.setServiceName(item.getServiceName());\n-                    ins.getEndpoints().forEach(ep -> {\n-                        microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins);\n-                    });\n+                    ins.getEndpoints()\n+                        .forEach(ep -> microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins));\n                 })\n         );\n     }\n \n     public static void initInsList(List<MicroserviceInstance> list, String serviceName) {\n         list.forEach(ins -> {\n             ins.setServiceName(serviceName);\n-            ins.getEndpoints().forEach(ep -> {\n-                microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins);\n-            });\n+            ins.getEndpoints()\n+                .forEach(ep -> microserviceList.put(ep.replaceAll(\"rest://\", \"\"), ins));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzIwMDA1", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/155#pullrequestreview-385320005", "createdAt": "2020-04-01T07:16:47Z", "commit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "committedDate": "2020-04-02T11:53:40Z", "message": "modify as comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8581163399217f047164756d37b3c0ead8b606fa", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/8581163399217f047164756d37b3c0ead8b606fa", "committedDate": "2020-04-01T06:16:48Z", "message": "modify as comment"}, "afterCommit": {"oid": "dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dc5cdba8d14b6c049c887689f07bd86bab7cf9e6", "committedDate": "2020-04-02T11:53:40Z", "message": "modify as comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1827, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}