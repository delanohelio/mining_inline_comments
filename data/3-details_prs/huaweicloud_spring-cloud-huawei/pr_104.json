{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4Njg5OTYw", "number": 104, "title": "[issue #102] aksk logic change / and rename ssl to aksk ", "bodyText": "", "createdAt": "2020-01-02T15:09:18Z", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104", "merged": true, "mergeCommit": {"oid": "c7b457eb7576cc863d07fc34239a61dcbc2f9e7b"}, "closed": true, "closedAt": "2020-01-03T09:06:46Z", "author": {"login": "GuoYL123"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2W3a0gH2gAyMzU4Njg5OTYwOjhhMTQ0Y2RjYjE5YjUwOWVjYmExOGU1OGQzNDM4NzFmNTU3MTBmOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2kx1JgH2gAyMzU4Njg5OTYwOjlmZDdiNGQ2NGQwMjgxZGY5YWNkODkxYTY1NTU1ZGViMTM2Y2M4YjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a144cdcb19b509ecba18e58d343871f55710f9d", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/8a144cdcb19b509ecba18e58d343871f55710f9d", "committedDate": "2020-01-02T10:05:17Z", "message": "add tLSConfig and add DefaultHttpTransport(TLSConfig)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d92860c02bcbac485326d18796bbb2f2ddd3c249", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/d92860c02bcbac485326d18796bbb2f2ddd3c249", "committedDate": "2020-01-02T11:08:34Z", "message": "refactory SSLConfig to AkSkConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2736214a5bbf792cbdd8271fc529539bff03de36", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/2736214a5bbf792cbdd8271fc529539bff03de36", "committedDate": "2020-01-02T14:50:17Z", "message": "delete redundant logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e", "committedDate": "2020-01-02T14:53:55Z", "message": "rename ServiceCombSSLProperties to ServiceCombAkSkProperties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3OTIyNzY1", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104#pullrequestreview-337922765", "createdAt": "2020-01-03T01:06:25Z", "commit": {"oid": "10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QwMTowNjoyNlrOFZ4bjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QwMTowNjoyNlrOFZ4bjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4MzI3OA==", "bodyText": "ShaAKSKCipher can be a constant in AkSkConfig", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104#discussion_r362683278", "createdAt": "2020-01-03T01:06:26Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java", "diffHunk": "@@ -59,35 +60,29 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(DealHeaderUtil.class);\n \n   public static void addAKSKHeader(HttpUriRequest httpRequest,\n-      SSLConfig sslConfig) {\n+      AkSkConfig akSkConfig) {\n     AuthHeaderUtils authHeaderUtils = AuthHeaderUtils.getInstance();\n     Map<String, String> headerMap = authHeaderUtils.genAuthHeaders();\n-    for (Map.Entry<String, String> entry : headerMap.entrySet()) {\n-      httpRequest.addHeader(entry.getKey(), entry.getValue());\n+    if (akSkConfig.isAkSkEmpty() && !CollectionUtils.isEmpty(headerMap)) {\n+      httpRequest.addHeader(X_SERVICE_AK, headerMap.get(X_SERVICE_AK));\n+      httpRequest.addHeader(X_SERVICE_SHA_AKSK, headerMap.get(X_SERVICE_SHA_AKSK));\n+    } else {\n+      httpRequest.addHeader(X_SERVICE_AK, akSkConfig.getAccessKey());\n+      httpRequest.addHeader(X_SERVICE_SHA_AKSK, encode(akSkConfig));\n     }\n-    if (isHeaderMapEmpty(headerMap) && isSSLConfigNotEmpty(sslConfig)) {\n-      httpRequest.addHeader(X_SERVICE_AK, sslConfig.getAccessKey());\n-      httpRequest.addHeader(X_SERVICE_SHA_AKSK,\n-          encode(sslConfig));\n-      httpRequest.addHeader(X_SERVICE_PROJECT, sslConfig.getProject());\n+    if (akSkConfig.isProjectEmpty() && !CollectionUtils.isEmpty(headerMap)) {\n+      httpRequest.addHeader(X_SERVICE_PROJECT, headerMap.get(X_SERVICE_PROJECT));\n+    } else {\n+      httpRequest.addHeader(X_SERVICE_PROJECT, akSkConfig.getProject());\n     }\n   }\n \n-  public static boolean isHeaderMapEmpty(Map<String, String> headerMap) {\n-    return headerMap == null || headerMap.size() == 0;\n-  }\n-\n-  public static boolean isSSLConfigNotEmpty(SSLConfig sslConfig) {\n-    return sslConfig.getAccessKey() != null && sslConfig.getSecretKey() != null && sslConfig.getProject() != null;\n-  }\n-\n-  private static String encode(SSLConfig sslConfig) {\n-\n-    if (\"ShaAKSKCipher\".equalsIgnoreCase(sslConfig.getAkskCustomCipher())) {\n-      return sslConfig.getSecretKey();\n+  private static String encode(AkSkConfig akSkConfig) {\n+    if (\"ShaAKSKCipher\".equalsIgnoreCase(akSkConfig.getAkskCustomCipher())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b88e34f72a83d67a42646f0a12e8da16435e3a", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/e4b88e34f72a83d67a42646f0a12e8da16435e3a", "committedDate": "2020-01-03T01:12:02Z", "message": "read project name from env first / use final string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1019bfc4512fe99b76733f4136377917a490f6c", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/b1019bfc4512fe99b76733f4136377917a490f6c", "committedDate": "2020-01-03T01:58:03Z", "message": "delete DealHeaderUtil.encode() ,move logic to akSkConfig.getSecretKey()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd7b4d64d0281df9acd891a65555deb136cc8b0", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9fd7b4d64d0281df9acd891a65555deb136cc8b0", "committedDate": "2020-01-03T02:17:51Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into tsl\n\n# Conflicts:\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/AkSkConfig.java\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/ServiceCombAkSkProperties.java\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/util/SecretUtil.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1807, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}