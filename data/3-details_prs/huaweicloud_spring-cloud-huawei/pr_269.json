{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzODgwNDkw", "number": 269, "title": "[#268 ] RABC authentication feature ", "bodyText": "", "createdAt": "2020-10-15T07:05:40Z", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269", "merged": true, "mergeCommit": {"oid": "1433a8f7d020bd0d743a732dc7b6c6084c0a89b6"}, "closed": true, "closedAt": "2020-10-21T02:00:23Z", "author": {"login": "GuoYL123"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSsVeUgBqjM4Nzk5MjEyMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUQizcgH2gAyNTAzODgwNDkwOmUzZDRmYjM3ZmE2NDQ0YzJkZTNlMzc1ZjNjN2VlYmM5MGRlNzUyYmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe3426d9b647fab1214bfba7e47f1a44d273a28a", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/fe3426d9b647fab1214bfba7e47f1a44d273a28a", "committedDate": "2020-10-15T07:04:15Z", "message": "add rbac"}, "afterCommit": {"oid": "0f673af00cb9a997203a9f67880265e87e4c7c87", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/0f673af00cb9a997203a9f67880265e87e4c7c87", "committedDate": "2020-10-15T07:06:59Z", "message": "add rbac"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "committedDate": "2020-10-15T07:08:13Z", "message": "add rbac"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f673af00cb9a997203a9f67880265e87e4c7c87", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/0f673af00cb9a997203a9f67880265e87e4c7c87", "committedDate": "2020-10-15T07:06:59Z", "message": "add rbac"}, "afterCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "committedDate": "2020-10-15T07:08:13Z", "message": "add rbac"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTY0MzEz", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#pullrequestreview-509964313", "createdAt": "2020-10-16T02:08:42Z", "commit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjowODo0MlrOHii0BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjoxMDozM1rOHii3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDAwNQ==", "bodyText": "TokenCache.getToken().getToken()\u5199\u6cd5\u4e0d\u592a\u597d\uff0c\u6982\u5ff5\u91cd\u53e0", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984005", "createdAt": "2020-10-16T02:08:42Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java", "diffHunk": "@@ -138,6 +142,9 @@ public void checkServerTrusted(X509Certificate[] chain,\n   private WebSocketClient buildClient() {\n     Map<String, String> signedHeader = new HashMap<>();\n     signedHeader.put(\"x-domain-name\", ServiceRegistryConfig.DEFAULT_PROJECT);\n+    if (TokenCache.getToken() != null) {\n+      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken().getToken());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDgyNQ==", "bodyText": "200 \u80fd\u5426\u7528\u5e38\u91cf", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984825", "createdAt": "2020-10-16T02:10:33Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java", "diffHunk": "@@ -51,12 +62,59 @@\n  **/\n public class DefaultHttpTransport implements HttpTransport {\n \n+  private static final Logger LOGGER = LoggerFactory.getLogger(DefaultHttpTransport.class);\n+\n   private volatile static DefaultHttpTransport DEFAULT_HTTP_TRANSPORT;\n \n   private ServiceCombAkSkProperties serviceCombAkSkProperties;\n \n   private HttpClient httpClient;\n \n+  public void setRBACToken(ServiceCombRBACProperties serviceCombRBACProperties,\n+      String urls) {\n+    if (StringUtils.isEmpty(serviceCombRBACProperties.getName()) ||\n+        StringUtils.isEmpty(serviceCombRBACProperties.getPassword())) {\n+      return;\n+    }\n+    List<String> urlList = URLUtil.dealMultiUrl(urls);\n+    getToken(serviceCombRBACProperties, urlList);\n+  }\n+\n+  private void getToken(ServiceCombRBACProperties serviceCombRBACProperties, List<String> urlList) {\n+    Response response = null;\n+    String url;\n+    for (String s : urlList) {\n+      url = s;\n+      try {\n+        StringEntity stringEntity = new StringEntity(\n+            JsonUtils.OBJ_MAPPER.writeValueAsString(serviceCombRBACProperties), \"utf-8\");\n+        response = this.sendPostRequest(url + \"/v4/token\", stringEntity);\n+        if (response.getStatusCode() == 200) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "committedDate": "2020-10-20T03:52:13Z", "message": "modify as comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1771, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}