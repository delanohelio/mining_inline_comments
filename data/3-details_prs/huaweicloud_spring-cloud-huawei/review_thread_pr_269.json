{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzODgwNDkw", "number": 269, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjowODo0MlrOEuQgVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjoxMDozM1rOEuQiYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTQwMzc0OnYy", "diffSide": "RIGHT", "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjowODo0MlrOHii0BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzo1MzowNFrOHkpqqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDAwNQ==", "bodyText": "TokenCache.getToken().getToken()\u5199\u6cd5\u4e0d\u592a\u597d\uff0c\u6982\u5ff5\u91cd\u53e0", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984005", "createdAt": "2020-10-16T02:08:42Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java", "diffHunk": "@@ -138,6 +142,9 @@ public void checkServerTrusted(X509Certificate[] chain,\n   private WebSocketClient buildClient() {\n     Map<String, String> signedHeader = new HashMap<>();\n     signedHeader.put(\"x-domain-name\", ServiceRegistryConfig.DEFAULT_PROJECT);\n+    if (TokenCache.getToken() != null) {\n+      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken().getToken());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzQ1MQ==", "bodyText": "done", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r508193451", "createdAt": "2020-10-20T03:53:04Z", "author": {"login": "GuoYL123"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java", "diffHunk": "@@ -138,6 +142,9 @@ public void checkServerTrusted(X509Certificate[] chain,\n   private WebSocketClient buildClient() {\n     Map<String, String> signedHeader = new HashMap<>();\n     signedHeader.put(\"x-domain-name\", ServiceRegistryConfig.DEFAULT_PROJECT);\n+    if (TokenCache.getToken() != null) {\n+      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken().getToken());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDAwNQ=="}, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTQwODk5OnYy", "diffSide": "RIGHT", "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMjoxMDozM1rOHii3OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzo1MzoxMFrOHkpqwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDgyNQ==", "bodyText": "200 \u80fd\u5426\u7528\u5e38\u91cf", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984825", "createdAt": "2020-10-16T02:10:33Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java", "diffHunk": "@@ -51,12 +62,59 @@\n  **/\n public class DefaultHttpTransport implements HttpTransport {\n \n+  private static final Logger LOGGER = LoggerFactory.getLogger(DefaultHttpTransport.class);\n+\n   private volatile static DefaultHttpTransport DEFAULT_HTTP_TRANSPORT;\n \n   private ServiceCombAkSkProperties serviceCombAkSkProperties;\n \n   private HttpClient httpClient;\n \n+  public void setRBACToken(ServiceCombRBACProperties serviceCombRBACProperties,\n+      String urls) {\n+    if (StringUtils.isEmpty(serviceCombRBACProperties.getName()) ||\n+        StringUtils.isEmpty(serviceCombRBACProperties.getPassword())) {\n+      return;\n+    }\n+    List<String> urlList = URLUtil.dealMultiUrl(urls);\n+    getToken(serviceCombRBACProperties, urlList);\n+  }\n+\n+  private void getToken(ServiceCombRBACProperties serviceCombRBACProperties, List<String> urlList) {\n+    Response response = null;\n+    String url;\n+    for (String s : urlList) {\n+      url = s;\n+      try {\n+        StringEntity stringEntity = new StringEntity(\n+            JsonUtils.OBJ_MAPPER.writeValueAsString(serviceCombRBACProperties), \"utf-8\");\n+        response = this.sendPostRequest(url + \"/v4/token\", stringEntity);\n+        if (response.getStatusCode() == 200) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzQ3Mg==", "bodyText": "done", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r508193472", "createdAt": "2020-10-20T03:53:10Z", "author": {"login": "GuoYL123"}, "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java", "diffHunk": "@@ -51,12 +62,59 @@\n  **/\n public class DefaultHttpTransport implements HttpTransport {\n \n+  private static final Logger LOGGER = LoggerFactory.getLogger(DefaultHttpTransport.class);\n+\n   private volatile static DefaultHttpTransport DEFAULT_HTTP_TRANSPORT;\n \n   private ServiceCombAkSkProperties serviceCombAkSkProperties;\n \n   private HttpClient httpClient;\n \n+  public void setRBACToken(ServiceCombRBACProperties serviceCombRBACProperties,\n+      String urls) {\n+    if (StringUtils.isEmpty(serviceCombRBACProperties.getName()) ||\n+        StringUtils.isEmpty(serviceCombRBACProperties.getPassword())) {\n+      return;\n+    }\n+    List<String> urlList = URLUtil.dealMultiUrl(urls);\n+    getToken(serviceCombRBACProperties, urlList);\n+  }\n+\n+  private void getToken(ServiceCombRBACProperties serviceCombRBACProperties, List<String> urlList) {\n+    Response response = null;\n+    String url;\n+    for (String s : urlList) {\n+      url = s;\n+      try {\n+        StringEntity stringEntity = new StringEntity(\n+            JsonUtils.OBJ_MAPPER.writeValueAsString(serviceCombRBACProperties), \"utf-8\");\n+        response = this.sendPostRequest(url + \"/v4/token\", stringEntity);\n+        if (response.getStatusCode() == 200) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDgyNQ=="}, "originalCommit": {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1951, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}