{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMzIxNjM4", "number": 295, "title": "[issue #296] register service when retry register / change heartbeat url", "bodyText": "register service when retry register after heartbeat failed.\nchange heartbeat url to '' /registry/microservices/\" + serviceId + \"/instances/\" + instanceId + \"/heartbeat\".\nwebsocket reconnect optimization.", "createdAt": "2020-11-16T02:49:08Z", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295", "merged": true, "mergeCommit": {"oid": "3dd82eaf644f0793d7f647f7d4bf21ef3c611e25"}, "closed": true, "closedAt": "2020-11-19T08:36:21Z", "author": {"login": "GuoYL123"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdc_HRygBqjM5OTg2NTk0MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd-lgNgFqTUzNDE4NDcwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8732cbaa902aabb0d0f6a851073e19166ac72ee1", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/8732cbaa902aabb0d0f6a851073e19166ac72ee1", "committedDate": "2020-11-16T02:46:55Z", "message": "register service when retry register / change heartbeat url"}, "afterCommit": {"oid": "dab28bc45bf9a6dbec9d2a0d81aa7fa558e44ce3", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dab28bc45bf9a6dbec9d2a0d81aa7fa558e44ce3", "committedDate": "2020-11-16T06:29:00Z", "message": "register service when retry register / change heartbeat url"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dab28bc45bf9a6dbec9d2a0d81aa7fa558e44ce3", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/dab28bc45bf9a6dbec9d2a0d81aa7fa558e44ce3", "committedDate": "2020-11-16T06:29:00Z", "message": "register service when retry register / change heartbeat url"}, "afterCommit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85", "committedDate": "2020-11-16T06:55:42Z", "message": "register service when retry register / change heartbeat url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTA3NzMy", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#pullrequestreview-531107732", "createdAt": "2020-11-16T08:45:24Z", "commit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo0NToyNFrOHzs_4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo0NToyNFrOHzs_4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3NjY3Mg==", "bodyText": "\u8fd9\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u6ca1\u6709\u4efb\u4f55\u6709\u6548\u7684\u68c0\u67e5\uff0c\u5efa\u8bae\u5220\u9664\u3002", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#discussion_r523976672", "createdAt": "2020-11-16T08:45:24Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/registry/HeartbeatSchedulerTest.java", "diffHunk": "@@ -33,19 +35,14 @@\n   @Injectable\n   ServiceCombClient serviceCombClient;\n \n-  @Injectable\n-  ServiceCombDiscoveryProperties serviceCombDiscoveryProperties;\n-\n-  @Injectable\n-  TagsProperties tagsProperties;\n+  ServiceCombDiscoveryProperties serviceCombDiscoveryProperties = new ServiceCombDiscoveryProperties();\n \n   @Test\n   public void addAndRemove() {\n     serviceCombDiscoveryProperties.setHealthCheckInterval(10);\n-    HeartbeatScheduler heartbeatScheduler = new HeartbeatScheduler(serviceCombDiscoveryProperties,\n-        serviceCombClient, tagsProperties);\n+    HeartbeatScheduler heartbeatScheduler = new HeartbeatScheduler(serviceCombDiscoveryProperties, serviceCombClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTA4OTg5", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#pullrequestreview-531108989", "createdAt": "2020-11-16T08:46:31Z", "commit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo0NjozMlrOHztCeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo0NjozMlrOHztCeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3NzMzNg==", "bodyText": "\u8fd9\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u6ca1\u6709\u4efb\u4f55\u6709\u6548\u68c0\u67e5\u3002", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#discussion_r523977336", "createdAt": "2020-11-16T08:46:32Z", "author": {"login": "liubao68"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/test/java/com/huaweicloud/servicecomb/discovery/client/ServiceCombClientTest.java", "diffHunk": "@@ -234,7 +235,7 @@ public void heartbeat(@Injectable\n       }\n     };\n     ServiceCombClient serviceCombClient = new ServiceCombClient(url, httpTransport);\n-    serviceCombClient.heartbeat(heartbeatRequest);\n+    serviceCombClient.heartbeat(\"1\", \"2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/4a6e8f362bafa0fe608bd825e0a2e3d9b1b68b85", "committedDate": "2020-11-16T06:55:42Z", "message": "register service when retry register / change heartbeat url"}, "afterCommit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/5109f7dd286ab3e60616ca79d7c7448f92bef3a5", "committedDate": "2020-11-18T03:01:48Z", "message": "register service when retry register / change heartbeat url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjg5MzI3", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#pullrequestreview-533289327", "createdAt": "2020-11-18T10:11:33Z", "commit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoxMTozNFrOH1mYAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoxMTozNFrOH1mYAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2NTMxMw==", "bodyText": "if \u548cif else\u957f\u5f97\u4e00\u6837", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#discussion_r525965313", "createdAt": "2020-11-18T10:11:34Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombServiceRegistry.java", "diffHunk": "@@ -120,39 +119,53 @@ private void startWatch() {\n     }\n   }\n \n-  private void loopRegister(ServiceCombRegistration registration) {\n+  private void loopRegister(Microservice microservice) {\n+    while (true) {\n+      if (doRegister(microservice)) {\n+        break;\n+      }\n+    }\n+  }\n+\n+  private Microservice getMicroservice(ServiceCombRegistration registration) {\n     Microservice microservice = RegistryHandler.buildMicroservice(registration);\n     if (serviceCombSwaggerHandler != null) {\n       serviceCombSwaggerHandler.init(serviceCombDiscoveryProperties.getAppName(),\n           serviceCombDiscoveryProperties.getServiceName());\n       microservice.setSchemas(serviceCombSwaggerHandler.getSchemaIds());\n     }\n-    while (true) {\n-      try {\n-        serviceID = serviceCombClient.getServiceId(microservice);\n-        if (null == serviceID) {\n-          serviceID = serviceCombClient.registerMicroservice(microservice);\n-          if (serviceCombSwaggerHandler != null) {\n-            serviceCombSwaggerHandler.registerSwagger(serviceID, microservice.getSchemas());\n-          }\n-        } else if (serviceCombSwaggerHandler != null) {\n-          List<String> schemas = filterSchema(serviceCombSwaggerHandler.getSchemasSummaryMap());\n-          serviceCombSwaggerHandler.registerSwagger(serviceID, schemas);\n-        }\n-        MicroserviceInstance microserviceInstance = RegistryHandler\n-            .buildMicroServiceInstances(serviceID, microservice, serviceCombDiscoveryProperties,\n-                tagsProperties);\n-        instanceID = serviceCombClient.registerInstance(microserviceInstance);\n-        if (null != instanceID) {\n-          serviceCombClient.autoDiscovery(serviceCombDiscoveryProperties.isAutoDiscovery());\n-          break;\n+    return microservice;\n+  }\n+\n+  private boolean doRegister(Microservice microservice) {\n+    try {\n+      serviceID = serviceCombClient.getServiceId(microservice);\n+      if (null == serviceID) {\n+        serviceID = serviceCombClient.registerMicroservice(microservice);\n+        if (serviceCombSwaggerHandler != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjk4NDYx", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#pullrequestreview-533298461", "createdAt": "2020-11-18T10:22:37Z", "commit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoyMjozOFrOH1m0aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoyMjozOFrOH1m0aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk3MjU4NQ==", "bodyText": "\u8fd9\u91cc\u65e0\u9650\u91cd\u8bd5\u4e0b\u53bb\uff1f\u4f55\u65f6\u7ec8\u6b62", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#discussion_r525972585", "createdAt": "2020-11-18T10:22:38Z", "author": {"login": "tianxiaoliang"}, "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombServiceRegistry.java", "diffHunk": "@@ -94,21 +94,20 @@ public void register(ServiceCombRegistration registration) {\n   private void asyncRegister(ServiceCombRegistration registration) {\n     EXECUTOR.execute(() -> {\n       try {\n-        loopRegister(registration);\n-        RegisterCache.setInstanceID(instanceID);\n-        RegisterCache.setServiceID(serviceID);\n-        if (serviceCombDiscoveryProperties.isWatch()) {\n-          startWatch();\n-        }\n-        LOGGER.info(\"register success,instanceID=\" + instanceID + \";serviceID=\" + serviceID);\n-        heartbeatScheduler.add(registration);\n+        Microservice microservice = getMicroservice(registration);\n+        loopRegister(microservice);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aac41fc1ec3f63d9fe5c9dd89e876bc2c210ddb2", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/aac41fc1ec3f63d9fe5c9dd89e876bc2c210ddb2", "committedDate": "2020-11-19T01:31:24Z", "message": "register service when retry register / change heartbeat url"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5109f7dd286ab3e60616ca79d7c7448f92bef3a5", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/5109f7dd286ab3e60616ca79d7c7448f92bef3a5", "committedDate": "2020-11-18T03:01:48Z", "message": "register service when retry register / change heartbeat url"}, "afterCommit": {"oid": "aac41fc1ec3f63d9fe5c9dd89e876bc2c210ddb2", "author": {"user": {"login": "GuoYL123", "name": "GuoYL"}}, "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/aac41fc1ec3f63d9fe5c9dd89e876bc2c210ddb2", "committedDate": "2020-11-19T01:31:24Z", "message": "register service when retry register / change heartbeat url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTg0NzAx", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/295#pullrequestreview-534184701", "createdAt": "2020-11-19T08:36:07Z", "commit": {"oid": "aac41fc1ec3f63d9fe5c9dd89e876bc2c210ddb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1792, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}