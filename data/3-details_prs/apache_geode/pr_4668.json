{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDc5Njc0", "number": 4668, "title": "GEODE-7760: NPE in Locator during auto-reconnect", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-02-03T19:20:22Z", "url": "https://github.com/apache/geode/pull/4668", "merged": true, "mergeCommit": {"oid": "af8307243e3c8dfb4f0c03b4539eace0b3ea11b3"}, "closed": true, "closedAt": "2020-02-07T16:45:38Z", "author": {"login": "bschuchardt"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAx-WaAH2gAyMzcwNDc5Njc0OmQ3NmRhNWJhYTEwZTUwZmJmYTBkMmNjNmUyODhkNzI0ZTBhNjg3OGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBy5DxgFqTM1NDgzMTQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d76da5baa10e50fbfa0d2cc6e288d724e0a6878d", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/d76da5baa10e50fbfa0d2cc6e288d724e0a6878d", "committedDate": "2020-02-03T19:19:32Z", "message": "GEODE-7760: NPE in Locator during auto-reconnect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "609e8d897413a5aafc7249c8382d9629bb8fb431", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/609e8d897413a5aafc7249c8382d9629bb8fb431", "committedDate": "2020-02-03T20:14:52Z", "message": "empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6604d21c3825ab925d8d3390f83323c105b595e", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/b6604d21c3825ab925d8d3390f83323c105b595e", "committedDate": "2020-02-03T22:22:44Z", "message": "fixes for stress-testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47e61b11135008426f2f8049ca7d7c74d3eeb8c2", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/47e61b11135008426f2f8049ca7d7c74d3eeb8c2", "committedDate": "2020-02-03T22:55:37Z", "message": "working on another stresstest failure\n\nThis test passes all the time outside of stress testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/2e0c7189782806320b050b7081cc5bbbfbf96167", "committedDate": "2020-02-03T23:32:12Z", "message": "ignoring test that seems to have trouble with workingDir/configDir and temporary folders in stress testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjQzOTY2", "url": "https://github.com/apache/geode/pull/4668#pullrequestreview-352643966", "createdAt": "2020-02-03T23:52:09Z", "commit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo1MjowOVrOFlD_8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo1MjowOVrOFlD_8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzE1Mw==", "bodyText": "don't want to mind-read here, what was the rationale for a local copy?", "url": "https://github.com/apache/geode/pull/4668#discussion_r374407153", "createdAt": "2020-02-03T23:52:09Z", "author": {"login": "echobravopapa"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjUxMDQ0", "url": "https://github.com/apache/geode/pull/4668#pullrequestreview-352651044", "createdAt": "2020-02-04T00:12:56Z", "commit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoxMjo1NlrOFlEW6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyMDowNlrOFlEe_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMzAzNQ==", "bodyText": "should \"currentLocator.internalCache\" be changed to \"myCache\"?", "url": "https://github.com/apache/geode/pull/4668#discussion_r374413035", "createdAt": "2020-02-04T00:12:56Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNDYyMA==", "bodyText": "If this expression is true it seems like we just silently returned without starting all of the locator's services. I have seen runs (recently) in which this happens because the InternalDistributedSystem does a concurrent InternalLocator.stop while another thread is executing the restart of this locator. So before returning here should this locator be marked in some way as not having been started? I think the thread that waits for this thread (the one executing startClusterManagementService) just joins and then says we are started.", "url": "https://github.com/apache/geode/pull/4668#discussion_r374414620", "createdAt": "2020-02-04T00:18:26Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNTEwMQ==", "bodyText": "Since this is an instance method on InternalLocator, why don't we just use this.internalCache and this.configurationPersistenceService instead of trying to get the locator from a static. This method should be initializing itself.", "url": "https://github.com/apache/geode/pull/4668#discussion_r374415101", "createdAt": "2020-02-04T00:20:06Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/b3b10f5a9ec7f39e9de907f49c71e2ed9fc9775a", "committedDate": "2020-02-05T23:46:17Z", "message": "remove use of static locator variable in InternalLocator.  added crash test.  unset shutdownHandled after locator restarts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0de2ba169ce193487f3fbe36c8aa869a87b26677", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/0de2ba169ce193487f3fbe36c8aa869a87b26677", "committedDate": "2020-02-06T19:12:19Z", "message": "fixing stresstest issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Nzc2MTYw", "url": "https://github.com/apache/geode/pull/4668#pullrequestreview-354776160", "createdAt": "2020-02-06T21:14:10Z", "commit": {"oid": "0de2ba169ce193487f3fbe36c8aa869a87b26677"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODMxNDMw", "url": "https://github.com/apache/geode/pull/4668#pullrequestreview-354831430", "createdAt": "2020-02-06T22:57:35Z", "commit": {"oid": "0de2ba169ce193487f3fbe36c8aa869a87b26677"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3758, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}