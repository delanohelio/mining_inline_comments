{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODI5NTY1", "number": 5099, "title": "GEODE-8029: Delete orphaned drf files (2nd try)", "bodyText": "This reverts the revert of the original commit and also fixes the\noriginally introduced issues.\n\nThe OpLog initialization now delete unused drf files to prevent the\nproliferation of unused records and files within the system, which\ncan could cause members to fail during startup while recovering\ndisk-stores (especially when they are isolated for gateway-senders).\n\nAdded distributed tests.\nDelete orphaned drf files when deleting the corresponding\ncrf during recovery.\n\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-05-12T16:16:32Z", "url": "https://github.com/apache/geode/pull/5099", "merged": true, "mergeCommit": {"oid": "bc0090dc93643fd4d09c79a4b0c29d883172b546"}, "closed": true, "closedAt": "2020-06-08T18:00:33Z", "author": {"login": "jujoramos"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgmiZGgH2gAyNDE2ODI5NTY1Ojk2ZmI1NzBlYmYwMDE4MWU4YTJkYzI4N2MwNDk3ZjdmYWRkZTExOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpT4YAgFqTQyNjQ1OTMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "96fb570ebf00181e8a2dc287c0497f7fadde1192", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/96fb570ebf00181e8a2dc287c0497f7fadde1192", "committedDate": "2020-05-12T16:05:37Z", "message": "GEODE-8029: Delete orphaned drf files (2nd try)\n\nThis reverts the revert of the original commit and also fixes the\noriginally introduced issues.\n\n----\n\nThe OpLog initialization now delete unused drf files to prevent the\nproliferation of unused records and files within the system, which\ncan could cause members to fail during startup while recovering\ndisk-stores (especially when they are isolated for gateway-senders).\n\n- Added distributed tests.\n- Delete orphaned drf files when deleting the corresponding\n  crf during recovery."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODg3MDg4", "url": "https://github.com/apache/geode/pull/5099#pullrequestreview-423887088", "createdAt": "2020-06-03T20:01:52Z", "commit": {"oid": "96fb570ebf00181e8a2dc287c0497f7fadde1192"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDowMTo1M1rOGerXxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDowMTo1M1rOGerXxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyMTA2Mw==", "bodyText": "This change comes into picture after the recovery is completed - \"initAfterRecovery\".\nThe real problem seems to be during recovery. If there is a periodic recovery this could be fine, but if there are large number of deleted records during the first recovery, the issue may still arise...We may need to have some checks during recovery (before reading the drfs) to avoid reading large deleted records. Please correct me if my understanding is wrong.\nAlso, looking at the other part of the code where \"setHasDeletes\" is called, it looks like it is called before the deleteDRF() - there could be a reason for doing this.\nAnd there is also call to \"getOplogSet().removeDrf(this);\" This may be needed here...", "url": "https://github.com/apache/geode/pull/5099#discussion_r434821063", "createdAt": "2020-06-03T20:01:53Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/Oplog.java", "diffHunk": "@@ -937,14 +937,21 @@ void initAfterRecovery(boolean offline) {\n         // this.crf.raf.seek(this.crf.currSize);\n       } else if (!offline) {\n         // drf exists but crf has been deleted (because it was empty).\n-        // I don't think the drf needs to be opened. It is only used during\n-        // recovery.\n-        // At some point the compacter my identify that it can be deleted.\n         this.crf.RAFClosed = true;\n         deleteCRF();\n+\n+        // See GEODE-8029.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96fb570ebf00181e8a2dc287c0497f7fadde1192"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "558149b28a97b5e5c75aa8fc5a8ea5cbe7bdb66c", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/558149b28a97b5e5c75aa8fc5a8ea5cbe7bdb66c", "committedDate": "2020-06-05T08:34:26Z", "message": "GEODE-8029: Changes requested by reviewers. Improved javadoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDU5MzEw", "url": "https://github.com/apache/geode/pull/5099#pullrequestreview-426459310", "createdAt": "2020-06-08T17:26:45Z", "commit": {"oid": "558149b28a97b5e5c75aa8fc5a8ea5cbe7bdb66c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4512, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}