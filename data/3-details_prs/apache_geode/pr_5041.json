{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDU1NjU4", "number": 5041, "title": "GEODE-8060: Fix flakiness in GemFireCacheImplCloseTest", "bodyText": "I found and fixed the issues causing memcached IntegrationJUnitTest to fail. Please re-review and hopefully it should pass all precheckin jobs this time.\nI hate creating a special package-private method just for the test BUT I can't think of an effective test without getting some sort of state from GemFireCacheImpl that identifies which call or which thread actually performed the close.\nWithout identifying which call or thread performed the close, the test devolves to just asserting that two threads can call close but it can't really assert which call did the actual work of closing GemFireCacheImpl. From a really high level, we don't really care. But at a low level, we don't want the 2nd callers to return before the 1st caller has finished the close (doesn't matter if the 1st caller returns from close() after 2nd callers though which is what causes the flakiness).", "createdAt": "2020-05-04T16:30:16Z", "url": "https://github.com/apache/geode/pull/5041", "merged": true, "mergeCommit": {"oid": "9e957f1db7760aa2bdc767c9c469e926cd490cad"}, "closed": true, "closedAt": "2020-05-06T22:16:51Z", "author": {"login": "kirklund"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceCDgZgH2gAyNDEzMDU1NjU4OmI5N2I5MzgwMzU1Nzk4YzhjNGM0OWM3YzYzYzg5MzViYmU0MGIwMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcesIk2AH2gAyNDEzMDU1NjU4OjQyNTgzYzc5MzQxNjkxYzBlNzQ3ZDc4MDY2NTNhZDg5ZjQyZDZmNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/b97b9380355798c8c4c49c7c63c8935bbe40b00a", "committedDate": "2020-05-04T16:27:27Z", "message": "GEODE-8060: Fix flakiness in GemFireCacheImplCloseTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTYxMTI1", "url": "https://github.com/apache/geode/pull/5041#pullrequestreview-405161125", "createdAt": "2020-05-04T16:43:14Z", "commit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjEzOTQ2", "url": "https://github.com/apache/geode/pull/5041#pullrequestreview-405213946", "createdAt": "2020-05-04T17:53:34Z", "commit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mjc0NDkz", "url": "https://github.com/apache/geode/pull/5041#pullrequestreview-405274493", "createdAt": "2020-05-04T19:17:21Z", "commit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODIwODgw", "url": "https://github.com/apache/geode/pull/5041#pullrequestreview-406820880", "createdAt": "2020-05-06T17:13:41Z", "commit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoxMzo0MlrOGRdFzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoxMzo0MlrOGRdFzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk1NTU5OA==", "bodyText": "The interrupt flag should be reset after catching InterruptedException", "url": "https://github.com/apache/geode/pull/5041#discussion_r420955598", "createdAt": "2020-05-06T17:13:42Z", "author": {"login": "kirklund"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/GemFireCacheImpl.java", "diffHunk": "@@ -2377,15 +2381,25 @@ public void close(String reason, Throwable systemFailureCause, boolean keepAlive\n       } finally {\n         CLOSING_THREAD.remove();\n       }\n+      return true;\n     }\n   }\n \n-  private void waitUntilClosed() {\n-    try {\n-      isClosedLatch.await();\n-    } catch (InterruptedException ignore) {\n-      // ignored\n+  /**\n+   * Returns true if caller waited on the {@code isClosedLatch}.\n+   */\n+  private boolean waitIfClosing(boolean skipAwait) {\n+    if (isClosing) {\n+      if (!skipAwait && !Thread.currentThread().equals(CLOSING_THREAD.get())) {\n+        try {\n+          isClosedLatch.await();\n+        } catch (InterruptedException ignore) {\n+          // ignored", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b97b9380355798c8c4c49c7c63c8935bbe40b00a"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42583c79341691c0e747d7806653ad89f42d6f66", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/42583c79341691c0e747d7806653ad89f42d6f66", "committedDate": "2020-05-06T17:29:00Z", "message": "Fixup interrupt handling"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4662, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}