{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTYzMzQ1", "number": 4753, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTozNToxNlrODkfHCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDo1MTozMVrODmdWnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NTg1MDMzOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/PoolImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTozNToxNlrOFw1f3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTozNToxNlrOFw1f3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1MjQ3OQ==", "bodyText": "Method comment says; its used for tests and gateway. The ticket is mainly talking about connection during singleHop; is this called during single hop?", "url": "https://github.com/apache/geode/pull/4753#discussion_r386752479", "createdAt": "2020-03-03T01:35:16Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/PoolImpl.java", "diffHunk": "@@ -918,10 +918,14 @@ public void returnConnection(Connection conn) {\n   }\n \n   /**\n-   * Test hook that acquires and returns a connection from the pool with a given ServerLocation.\n+   * Borrows a connection to a specific server from the pool.. Used by gateway and tests. Any\n+   * connection\n+   * that is acquired using this method must be returned using returnConnection, even if it is\n+   * destroyed.\n+   *\n    */\n   public Connection acquireConnection(ServerLocation loc) {\n-    return manager.borrowConnection(loc, false);\n+    return manager.borrowConnection(loc, 15000L, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NTg5MTQ3OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTo1ODowNVrOFw14Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxODo0NDoyOVrOFzDYFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1ODY5NQ==", "bodyText": "Based on the previous method comment; for certain commands, even if limit is hit, it's fine to create a new connection. E.g. InterestRegistration(one time ops?) I agree with that one, we need to see the ops which could really impact the system by breaking the limit conditions.\nAlso, if we look into what currently available and whats is expected from the ticket GEODE-6536 requirement:\n\n\nPrevious behavior before this change:\nIf the connection for expected server is not available, it creates a new connection and returns.\n\n\nWith the fix the behavior is:\nIf the connection for a given server is not available, it will wait for certain time and then throws exception.\n\n\nIt seems like both approach is valid based on the application requirement. In certain cases the application may not want to wait for long; instead it may choose to have a new connection created and execute the command to satisfy its response requirement (most of the time networking between the servers/peers are faster and they can take the load).\nIf this borrowConnection is used for singleHop; then we should provide both options for the application, my vote will be for approach #1 as default.\nAlso, with this, both flavors of borrowConnection() methods:\nborrowConnection(long acquireTimeout)\nPooledConnection borrowConnection(ServerLocation server, boolean onlyUseExistingCnx)\nHave lot of common code; we could have a common code that could be used by both?", "url": "https://github.com/apache/geode/pull/4753#discussion_r386758695", "createdAt": "2020-03-03T01:58:05Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwODAxMw==", "bodyText": "As I see this, previous behavior was only to search existing connection in pool, toward designated server. And if we did not find it, then in case onlyUseExistingCnx is set to false we will create new connection, regardless of number of connections.\nMy proposal is, simular to borrowConnections(timeout), if we can not find connection in pool, and number of connections did not reach maximum, we create new connection toward designated server. And implement same retry logic from borrowConnections(timeout).", "url": "https://github.com/apache/geode/pull/4753#discussion_r386908013", "createdAt": "2020-03-03T09:54:34Z", "author": {"login": "mivanac"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1ODY5NQ=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUxOTAzOA==", "bodyText": "@mivanac You have introduced the wait which was not there before, this changes the behavior from caller perspective; It may have impact on the performance of some of the operation. May be reason for the internal test failures and existing user application may encounter the same.\nMay be, you can keep the current behavior as is, and add a new property (similar to free-connection-timeout) to adopt new behavior; when the new property is set it will wait for connection to available.", "url": "https://github.com/apache/geode/pull/4753#discussion_r388519038", "createdAt": "2020-03-05T19:39:01Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1ODY5NQ=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA3NzAxMg==", "bodyText": "Added new parameter, which as default behavior disables waiting till timeout.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389077012", "createdAt": "2020-03-06T18:44:29Z", "author": {"login": "mivanac"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1ODY5NQ=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NTg5NDE0OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTo1OTozNlrOFw15xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTo1OTozNlrOFw15xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1OTExMA==", "bodyText": "Do we need this? The java doc for \"yield\" says, its rarely appropriate and used for testing or debugging.", "url": "https://github.com/apache/geode/pull/4753#discussion_r386759110", "createdAt": "2020-03-03T01:59:36Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,\n+      boolean onlyUseExistingCnx)\n+      throws AllConnectionsInUseException, NoAvailableServersException,\n+      ServerConnectivityException {\n \n-    if (onlyUseExistingCnx) {\n-      throw new AllConnectionsInUseException();\n-    }\n+    PooledConnection connection;\n+    logger.trace(\"Connection borrowConnection single hop connection\");\n+\n+    long waitStart = NOT_WAITING;\n+    try {\n+      long timeout = System.nanoTime() + MILLISECONDS.toNanos(acquireTimeout);\n+      while (true) {\n+\n+        connection =\n+            availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n+\n+        if (null != connection) {\n+          return connection;\n+        }\n+\n+        if (connectionAccounting.tryCreate()) {\n+          try {\n+            connection = createPooledConnection(server);\n \n-    connection = forceCreateConnection(server);\n-    if (null != connection) {\n-      return connection;\n+            if (null != connection) {\n+              return connection;\n+            }\n+            throw new NoAvailableServersException();\n+          } finally {\n+            if (connection == null) {\n+              connectionAccounting.cancelTryCreate();\n+              if (connectionAccounting.isUnderMinimum()) {\n+                startBackgroundPrefill();\n+              }\n+            }\n+          }\n+        }\n+\n+        if (checkShutdownInterruptedOrTimeout(timeout)) {\n+          break;\n+        }\n+\n+        if (!onlyUseExistingCnx) {\n+          connection = forceCreateConnection(server);\n+          if (null != connection) {\n+            return connection;\n+          }\n+          throw new ServerConnectivityException(BORROW_CONN_ERROR_MSG + server);\n+        }\n+\n+        waitStart = beginConnectionWaitStatIfNotStarted(waitStart);\n+\n+        Thread.yield();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTI0MTkwOnYy", "diffSide": "RIGHT", "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImplTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMDo0NTo0N1rOFxV4fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODozODo1OFrOFyfQ_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4MzA3MQ==", "bodyText": "This test is now misnamed, since the test is no longer testing the condition that no connections exist.", "url": "https://github.com/apache/geode/pull/4753#discussion_r387283071", "createdAt": "2020-03-03T20:45:47Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImplTest.java", "diffHunk": "@@ -92,9 +92,18 @@ public void startShouldEatRejectedExecutionException() {\n   @Test\n   public void borrowConnectionThrowsWhenUsingExistingConnectionsAndNoConnectionsExist() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczNDIwMg==", "bodyText": "We are still testing same thing since there is no free connections in pool, since you can not define pool with 0 connections. If you want I can change name ...AndNoFreeConnectionsExist", "url": "https://github.com/apache/geode/pull/4753#discussion_r387734202", "createdAt": "2020-03-04T15:18:29Z", "author": {"login": "mivanac"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImplTest.java", "diffHunk": "@@ -92,9 +92,18 @@ public void startShouldEatRejectedExecutionException() {\n   @Test\n   public void borrowConnectionThrowsWhenUsingExistingConnectionsAndNoConnectionsExist() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4MzA3MQ=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4NTM3Mg==", "bodyText": "Looking at the old code vs the new, it seems like originally we just tried to call borrowConnection() and asserted that we throw an exception, but in the new test we first successfully call the single-argument borrowConnection() and then call the three-arg version and assert that that throws. Given that there are two calls to borrowConnection() in the test and only one of them throws, a test name that explains this difference in behaviour between the calls would be best.", "url": "https://github.com/apache/geode/pull/4753#discussion_r388485372", "createdAt": "2020-03-05T18:38:58Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImplTest.java", "diffHunk": "@@ -92,9 +92,18 @@ public void startShouldEatRejectedExecutionException() {\n   @Test\n   public void borrowConnectionThrowsWhenUsingExistingConnectionsAndNoConnectionsExist() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4MzA3MQ=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTI1NDM1OnYy", "diffSide": "RIGHT", "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerJUnitTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMDo0OTo0OFrOFxWAQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNToxMDo1MFrOFxxFjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4NTA1Nw==", "bodyText": "These test names need to be more descriptive. They should say what part of the code is being tested, using what parameters and what the expected outcome is. It's also unclear to me what these two tests are actually testing that's different between the tests. Both seem to only be asserting that manager.borrowConnection(new ServerLocation(\"localhost\", 5), BORROW_TIMEOUT_MILLIS, true) returns in less than the borrow timeout.\nAlso, InterruptedException is never thrown from these methods and many of the Connection objects which are assigned are never used.", "url": "https://github.com/apache/geode/pull/4753#discussion_r387285057", "createdAt": "2020-03-03T20:49:48Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerJUnitTest.java", "diffHunk": "@@ -361,6 +363,82 @@ public void testBug41516()\n         elapsedMillis >= BORROW_TIMEOUT_MILLIS - ALLOWABLE_ERROR_IN_MILLIS);\n   }\n \n+\n+  @Test\n+  public void testSingleHopRetryConnection()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyODc4MA==", "bodyText": "I will update test names.\nThese tests are aligned with previous tests. And connections are assigned just to fill up connection pool till maximum.", "url": "https://github.com/apache/geode/pull/4753#discussion_r387728780", "createdAt": "2020-03-04T15:10:50Z", "author": {"login": "mivanac"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerJUnitTest.java", "diffHunk": "@@ -361,6 +363,82 @@ public void testBug41516()\n         elapsedMillis >= BORROW_TIMEOUT_MILLIS - ALLOWABLE_ERROR_IN_MILLIS);\n   }\n \n+\n+  @Test\n+  public void testSingleHopRetryConnection()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4NTA1Nw=="}, "originalCommit": {"oid": "b92b08da95a10737ca4ac0c62cce442dca99c880"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ2Mjg2OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1Mzo1NVrOFzKvog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1Mzo1NVrOFzKvog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NzczMA==", "bodyText": "Additional comment could be added to highlight difference between \"setFreeConnectionTimeout\":\nSay:\nIt differs from \"setFreeConnectionTimeout\" which waits for any server connection in the pool, where this waits for a free connection to a specific server.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389197730", "createdAt": "2020-03-06T23:53:55Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "diffHunk": "@@ -238,6 +246,25 @@\n    */\n   PoolFactory setFreeConnectionTimeout(int connectionTimeout);\n \n+\n+  /**\n+   * Sets the server connection timeout for this pool. If the pool has a max connections setting,\n+   * operations will block if there is no free connection towards specific server. The server\n+   * connection timeout\n+   * specifies how long those operations will block waiting for a free connection towards specific\n+   * server before\n+   * receiving an {@link AllConnectionsInUseException}. If max connections is not set this setting\n+   * has no\n+   * effect.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a2d8fc8e4b5813bd36a075598e8460fb404f3c2"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTUxNjc3OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDozNzoxOVrOFzLQOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDozNzoxOVrOFzLQOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjA3NA==", "bodyText": "While trying to find a connection, for given time (acquireTimeout); this may get into a hot-loop; consuming the CPU; can you see if you can wait for a notification which indicates a server connection is available.\nThe above ask is nice to have. Also, currently the other borrowConnection() does not wait based on wait/notify.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389206074", "createdAt": "2020-03-07T00:37:19Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -301,31 +301,68 @@ public Connection borrowConnection(long acquireTimeout)\n     throw new AllConnectionsInUseException();\n   }\n \n-  /**\n-   * Borrow a connection to a specific server. This task currently allows us to break the connection\n-   * limit, because it is used by tasks from the background thread that shouldn't be constrained by\n-   * the limit. They will only violate the limit by 1 connection, and that connection will be\n-   * destroyed when returned to the pool.\n-   */\n   @Override\n-  public PooledConnection borrowConnection(ServerLocation server,\n-      boolean onlyUseExistingCnx) throws AllConnectionsInUseException, NoAvailableServersException {\n-    PooledConnection connection =\n-        availableConnectionManager.useFirst((c) -> c.getServer().equals(server));\n-    if (null != connection) {\n-      return connection;\n-    }\n+  public PooledConnection borrowConnection(ServerLocation server, long acquireTimeout,\n+      boolean onlyUseExistingCnx)\n+      throws AllConnectionsInUseException, NoAvailableServersException,\n+      ServerConnectivityException {\n \n-    if (onlyUseExistingCnx) {\n-      throw new AllConnectionsInUseException();\n-    }\n+    PooledConnection connection;\n+    logger.trace(\"Connection borrowConnection single hop connection\");\n+\n+    long waitStart = NOT_WAITING;\n+    try {\n+      long timeout = System.nanoTime() + MILLISECONDS.toNanos(acquireTimeout);\n+      while (true) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a2d8fc8e4b5813bd36a075598e8460fb404f3c2"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjUyNTE4OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDo0ODo0N1rOFz41tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzo0OToxNFrOF0PkMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1Mjk1MA==", "bodyText": "A timeout of -1 is usually used to imply that the timeout is infinite, i.e. that we will wait forever to obtain a server connection if max connections is set and there is no free connections towards designated server. Would it be possible to change the default value to 0 but still ensure that the original behaviour is preserved?", "url": "https://github.com/apache/geode/pull/4753#discussion_r389952950", "createdAt": "2020-03-09T20:48:47Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "diffHunk": "@@ -73,6 +73,14 @@\n    */\n   int DEFAULT_FREE_CONNECTION_TIMEOUT = 10000;\n \n+  /**\n+   * The default amount of time, in milliseconds, which we will wait for a server connection if max\n+   * connections is set and there is no free connections towards designated server.\n+   * <p>\n+   * Current value: <code>-1</code>.\n+   */\n+  int DEFAULT_SERVER_CONNECTION_TIMEOUT = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "740bcddff41bd582ad3f78e5ff322b109de35313"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2Mjc3MQ==", "bodyText": "For timeout, if you look at the code (checkShutdownInterruptedOrTimeout) -1 means no timeout, because you compare current time against, current + timeout. If we set 0, you will get the code to retry several times until 1ms passes.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389962771", "createdAt": "2020-03-09T21:08:40Z", "author": {"login": "mivanac"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "diffHunk": "@@ -73,6 +73,14 @@\n    */\n   int DEFAULT_FREE_CONNECTION_TIMEOUT = 10000;\n \n+  /**\n+   * The default amount of time, in milliseconds, which we will wait for a server connection if max\n+   * connections is set and there is no free connections towards designated server.\n+   * <p>\n+   * Current value: <code>-1</code>.\n+   */\n+  int DEFAULT_SERVER_CONNECTION_TIMEOUT = -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1Mjk1MA=="}, "originalCommit": {"oid": "740bcddff41bd582ad3f78e5ff322b109de35313"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3MzU1OQ==", "bodyText": "If the comparison in checkShutdownInterruptedOrTimeout was timeout <= System.nanoTime() then this problem would be solved, I think.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389973559", "createdAt": "2020-03-09T21:31:59Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "diffHunk": "@@ -73,6 +73,14 @@\n    */\n   int DEFAULT_FREE_CONNECTION_TIMEOUT = 10000;\n \n+  /**\n+   * The default amount of time, in milliseconds, which we will wait for a server connection if max\n+   * connections is set and there is no free connections towards designated server.\n+   * <p>\n+   * Current value: <code>-1</code>.\n+   */\n+  int DEFAULT_SERVER_CONNECTION_TIMEOUT = -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1Mjk1MA=="}, "originalCommit": {"oid": "740bcddff41bd582ad3f78e5ff322b109de35313"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyNTI5Ng==", "bodyText": "OK. Updated.", "url": "https://github.com/apache/geode/pull/4753#discussion_r390325296", "createdAt": "2020-03-10T13:49:14Z", "author": {"login": "mivanac"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/PoolFactory.java", "diffHunk": "@@ -73,6 +73,14 @@\n    */\n   int DEFAULT_FREE_CONNECTION_TIMEOUT = 10000;\n \n+  /**\n+   * The default amount of time, in milliseconds, which we will wait for a server connection if max\n+   * connections is set and there is no free connections towards designated server.\n+   * <p>\n+   * Current value: <code>-1</code>.\n+   */\n+  int DEFAULT_SERVER_CONNECTION_TIMEOUT = -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1Mjk1MA=="}, "originalCommit": {"oid": "740bcddff41bd582ad3f78e5ff322b109de35313"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjUzNDA3OnYy", "diffSide": "RIGHT", "path": "geode-core/src/test/java/org/apache/geode/cache/client/internal/OpExecutorImplJUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDo1MTozMVrOFz47Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDo1MTozMVrOFz47Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1NDM1NQ==", "bodyText": "When the default value for the timeout is being used, instead of hard-coding the value like here, it would be better to use a reference to the DEFAULT_SERVER_CONNECTION_TIMEOUT defined in PoolFactory.java.", "url": "https://github.com/apache/geode/pull/4753#discussion_r389954355", "createdAt": "2020-03-09T20:51:31Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/test/java/org/apache/geode/cache/client/internal/OpExecutorImplJUnitTest.java", "diffHunk": "@@ -99,7 +99,7 @@ public RuntimeException generateCancelledException(Throwable e) {\n   @Test\n   public void testExecute() throws Exception {\n     OpExecutorImpl exec = new OpExecutorImpl(manager, queueManager, endpointManager, riTracker, 3,\n-        10, cancelCriterion, null);\n+        10, -1, cancelCriterion, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "740bcddff41bd582ad3f78e5ff322b109de35313"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4476, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}