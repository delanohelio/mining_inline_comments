{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDAyMTgx", "number": 4598, "title": "GEODE-7706: throw correct TransactionDataRebalancedException.", "bodyText": "", "createdAt": "2020-01-16T00:38:13Z", "url": "https://github.com/apache/geode/pull/4598", "merged": true, "mergeCommit": {"oid": "b9526d4f18fce46e918a09db2e18d5667a29917d"}, "closed": true, "closedAt": "2020-01-16T17:46:11Z", "author": {"login": "pivotal-eshu"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6vFwrAH2gAyMzYzNDAyMTgxOjE3ZjI5YmE5M2Q5NDIzNjAwYzRjMGYzYjQwN2NjOTAxMTc2NmY1NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb69H3MAFqTM0NDA2NTk0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17f29ba93d9423600c4c0f3b407cc9011766f565", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/17f29ba93d9423600c4c0f3b407cc9011766f565", "committedDate": "2020-01-16T00:34:22Z", "message": "GEODE-7706: throw correct TransactionDataRebalancedException."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjE5Nzg2", "url": "https://github.com/apache/geode/pull/4598#pullrequestreview-343619786", "createdAt": "2020-01-16T01:03:37Z", "commit": {"oid": "17f29ba93d9423600c4c0f3b407cc9011766f565"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMTowMzozN1rOFeLNwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMTowMzozN1rOFeLNwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE4NTM0Ng==", "bodyText": "Is it worth extracting this string to a constant in the PartitionedRegion class so that it can be consistently referred to?", "url": "https://github.com/apache/geode/pull/4598#discussion_r367185346", "createdAt": "2020-01-16T01:03:37Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/test/java/org/apache/geode/internal/cache/PartitionedRegionTest.java", "diffHunk": "@@ -439,6 +443,66 @@ public void generatePRIdShouldNotThrowNumberFormatExceptionIfAnErrorOccursWhileR\n         .doesNotThrowAnyException();\n   }\n \n+  @Test\n+  public void getDataRegionForWriteThrowsTransactionExceptionIfNotDataStore() {\n+    PartitionedRegion spyPartitionedRegion = spy(partitionedRegion);\n+\n+    KeyInfo keyInfo = mock(KeyInfo.class);\n+    when(keyInfo.getBucketId()).thenReturn(1);\n+    doReturn(null).when(spyPartitionedRegion).getDataStore();\n+\n+    Throwable caughtException =\n+        catchThrowable(() -> spyPartitionedRegion.getDataRegionForWrite(keyInfo));\n+\n+    assertThat(caughtException).isInstanceOf(TransactionException.class).hasMessage(\n+        \"PartitionedRegion Transactions cannot execute on nodes with local max memory zero\");\n+  }\n+\n+  @Test\n+  public void getDataRegionForWriteThrowsTransactionDataRebalancedExceptionIfGetInitializedBucketThrowsForceReattemptException()\n+      throws Exception {\n+    PartitionedRegion spyPartitionedRegion = spy(partitionedRegion);\n+\n+    KeyInfo keyInfo = mock(KeyInfo.class);\n+    Object key = new Object();\n+    PartitionedRegionDataStore dataStore = mock(PartitionedRegionDataStore.class);\n+    when(keyInfo.getBucketId()).thenReturn(1);\n+    when(keyInfo.getKey()).thenReturn(key);\n+    when(keyInfo.isCheckPrimary()).thenReturn(true);\n+    doReturn(dataStore).when(spyPartitionedRegion).getDataStore();\n+    doThrow(new ForceReattemptException(\"\")).when(dataStore)\n+        .getInitializedBucketWithKnownPrimaryForId(key, 1);\n+    doReturn(mock(InternalDistributedMember.class)).when(spyPartitionedRegion).createBucket(1, 0,\n+        null);\n+\n+    Throwable caughtException =\n+        catchThrowable(() -> spyPartitionedRegion.getDataRegionForWrite(keyInfo));\n+\n+    assertThat(caughtException).isInstanceOf(TransactionDataRebalancedException.class)\n+        .hasMessage(\"Transactional data moved, due to rebalancing.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17f29ba93d9423600c4c0f3b407cc9011766f565"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDY1OTQy", "url": "https://github.com/apache/geode/pull/4598#pullrequestreview-344065942", "createdAt": "2020-01-16T16:54:25Z", "commit": {"oid": "17f29ba93d9423600c4c0f3b407cc9011766f565"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo1NDoyNVrOFegjLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo1NDoyNVrOFegjLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzNDg5NA==", "bodyText": "These assertions within the tests can be further simplified by using something like the following:\n    assertThatThrownBy(() -> spyPartitionedRegion.getDataRegionForWrite(keyInfo))\n        .isInstanceOf(TransactionException.class)\n        .hasMessage(\"PartitionedRegion Transactions cannot execute on nodes with local max memory zero\");", "url": "https://github.com/apache/geode/pull/4598#discussion_r367534894", "createdAt": "2020-01-16T16:54:25Z", "author": {"login": "jujoramos"}, "path": "geode-core/src/test/java/org/apache/geode/internal/cache/PartitionedRegionTest.java", "diffHunk": "@@ -439,6 +443,66 @@ public void generatePRIdShouldNotThrowNumberFormatExceptionIfAnErrorOccursWhileR\n         .doesNotThrowAnyException();\n   }\n \n+  @Test\n+  public void getDataRegionForWriteThrowsTransactionExceptionIfNotDataStore() {\n+    PartitionedRegion spyPartitionedRegion = spy(partitionedRegion);\n+\n+    KeyInfo keyInfo = mock(KeyInfo.class);\n+    when(keyInfo.getBucketId()).thenReturn(1);\n+    doReturn(null).when(spyPartitionedRegion).getDataStore();\n+\n+    Throwable caughtException =\n+        catchThrowable(() -> spyPartitionedRegion.getDataRegionForWrite(keyInfo));\n+\n+    assertThat(caughtException).isInstanceOf(TransactionException.class).hasMessage(\n+        \"PartitionedRegion Transactions cannot execute on nodes with local max memory zero\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17f29ba93d9423600c4c0f3b407cc9011766f565"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3852, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}