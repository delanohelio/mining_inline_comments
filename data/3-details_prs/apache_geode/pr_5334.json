{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNzc2MjAy", "number": 5334, "title": "GEODE-8240: Back-Port to 1.12", "bodyText": "Back-port to support/1.12 branch, of #5273 fix for GEODE-8240\nI used git cherry-pick -x bfe1ca113124ea958dc02dd9be90cdb0aabe5c4d\nIn resolving conflicts I mostly accepted all non-conflicting changes from 1.12. An exception was that in many places where we were using version.compareTo(other) < 0 or version.compareTo(other) >= 0, I accepted the changes from the cherry-pick commit to replace those with version.isOlderThan(other) or version.isNotOlderThan(other). Those changes were all made by @pivotal-jbarrett on develop and they improve readability.\nThe other change I had to make was to fix the equals(other) method on InternalDistributedMember. That method didn't work when comparing a InternalDistributedMember to a MemberIdentifier. As a result the 1.12 version of GMSJoinLeaveJUnitTest was failing. Fixing equals(other) fixed the test. The alternative would have been a lot of surgery on that test (mocking.). Rather than perturb that test further, I left it alone and fixed IDM.equals(other).\nI did not change InternalDistributedMember.equals(other)\u2014instead, I pulled in a couple minor changes to GMSJoinLeaveJUnitTest from the develop branch, to get that test running with the (wrong/unchanged) IDM.equals(other) functionality. Since this ticket is not about fixing IDM this was the better way to go.\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?", "createdAt": "2020-07-01T15:29:30Z", "url": "https://github.com/apache/geode/pull/5334", "merged": true, "mergeCommit": {"oid": "9dfa7f1b79878bbbceca636275b4eda597bd7712"}, "closed": true, "closedAt": "2020-07-02T16:09:04Z", "author": {"login": "Bill"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwei0lAH2gAyNDQyNzc2MjAyOmU5MWUzMGY0OWQ5ZDJmOTQ0NTAxYzkzMTUxZjA2NGVjZWVmYjczYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwzRFcAFqTQ0MTI2NjAzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e91e30f49d9d2f944501c93151f064eceefb73ab", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/e91e30f49d9d2f944501c93151f064eceefb73ab", "committedDate": "2020-06-30T23:49:38Z", "message": "GEODE-8240: first try cherry-pick 6/30"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a", "committedDate": "2020-07-01T15:27:02Z", "message": "GEODE-8240: correct IDM.equals(Object)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTgwNTQ3", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-440980547", "createdAt": "2020-07-01T15:32:33Z", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozMjozNFrOGrrARg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozMjozNFrOGrrARg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0NjUzNA==", "bodyText": "this equals() method needed repair after the git cherry-pick, in order to get GMSJoinLeaveJUnitTest passing here in 1.12", "url": "https://github.com/apache/geode/pull/5334#discussion_r448446534", "createdAt": "2020-07-01T15:32:34Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/membership/InternalDistributedMember.java", "diffHunk": "@@ -440,15 +441,21 @@ public boolean isPartial() {\n   }\n \n   @Override\n-  public boolean equals(Object o) {\n+  public boolean equals(final Object o) {\n     if (this == o) {\n       return true;\n     }\n-    if (o == null || getClass() != o.getClass()) {\n+    if (o == null) {\n+      return false;\n+    }\n+    if (o instanceof InternalDistributedMember) {\n+      final InternalDistributedMember that = (InternalDistributedMember) o;\n+      return memberIdentifier.equals(that.memberIdentifier);\n+    } else if (o instanceof MemberIdentifier) {\n+      return memberIdentifier.equals(o);\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTM1OTAw", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-441135900", "createdAt": "2020-07-01T19:20:18Z", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToyMDoxOFrOGryb_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToyMDoxOFrOGryb_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2ODMxOA==", "bodyText": "this is the new unit test for GEODE-8240", "url": "https://github.com/apache/geode/pull/5334#discussion_r448568318", "createdAt": "2020-07-01T19:20:18Z", "author": {"login": "Bill"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeaveJUnitTest.java", "diffHunk": "@@ -1589,6 +1590,36 @@ public void testMulticastDiscoveryNotAllowed() {\n     }\n   }\n \n+  // GEODE-8240 could cause this member's identifier to have the wrong version so patch it up\n+  @Test\n+  public void repairWrongVersionInView() throws Exception {\n+\n+    initMocks();\n+\n+    List<MemberIdentifier> viewmembers =\n+        Arrays.asList(new MemberIdentifier[] {mockMembers[0], gmsJoinLeaveMemberId});\n+\n+    final GMSMembershipView<MemberIdentifier> viewWithWrongVersion =\n+        new GMSMembershipView<>(mockMembers[0], 2, viewmembers);\n+\n+    // clone member ID\n+    final MemberIdentifierImpl myMemberIDWithWrongVersion =\n+        new MemberIdentifierImpl(gmsJoinLeaveMemberId.getMemberData());\n+\n+    // this test must live in the 1.12 and later lines so pick a pre-1.12 version\n+    final Version oldVersion = Version.GEODE_1_11_0;\n+    myMemberIDWithWrongVersion.setVersionObjectForTest(oldVersion);\n+\n+    viewWithWrongVersion.remove(gmsJoinLeaveMemberId);\n+    viewWithWrongVersion.add(myMemberIDWithWrongVersion);\n+\n+    gmsJoinLeave.installView(viewWithWrongVersion);\n+\n+    assertThat(\n+        gmsJoinLeave.getView().getCanonicalID(gmsJoinLeaveMemberId).getVersionOrdinalObject())\n+            .isEqualTo(Version.getCurrentVersion());\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTM2ODYw", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-441136860", "createdAt": "2020-07-01T19:22:02Z", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToyMjowMlrOGrye3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToyMjowMlrOGrye3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2OTA1NQ==", "bodyText": "This is the new rolling upgrade test logic that verifies that after the upgrade, all the MemberIdentifiers in the view, report the current version (not an old version.)\nThis is adapted from the original Ericsson PR that showed us the bug that became GEODE-8240. Rather than use gfsh, we are delving into the IDM directly here.", "url": "https://github.com/apache/geode/pull/5334#discussion_r448569055", "createdAt": "2020-07-01T19:22:02Z", "author": {"login": "Bill"}, "path": "geode-core/src/upgradeTest/java/org/apache/geode/internal/cache/rollingupgrade/RollingUpgradeDUnitTest.java", "diffHunk": "@@ -205,6 +210,22 @@ void doTestRollAll(String regionType, String objectType, String startingVersion)\n       verifyValues(objectType, regionName, 0, 10, server2);\n       putAndVerify(objectType, server2, regionName, 15, 25, server1);\n \n+      final short versionOrdinalAfterUpgrade = Version.getCurrentVersion().ordinal();\n+      locator.invoke(() -> {\n+\n+        final Locator theLocator = Locator.getLocator();\n+        final DistributedSystem distributedSystem = theLocator.getDistributedSystem();\n+        final InternalDistributedSystem ids =\n+            (InternalDistributedSystem) distributedSystem;\n+        final DistributionManager distributionManager = ids.getDistributionManager();\n+        final MembershipView<InternalDistributedMember> view =\n+            distributionManager.getDistribution().getView();\n+\n+        for (final InternalDistributedMember member : view.getMembers()) {\n+          assertThat(member.getVersionOrdinal()).isEqualTo(versionOrdinalAfterUpgrade);\n+        }\n+      });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjA0NzUy", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-441204752", "createdAt": "2020-07-01T21:21:20Z", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjExODYx", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-441211861", "createdAt": "2020-07-01T21:35:00Z", "commit": {"oid": "7f9bdfbb7a285abe3a6ac8bdd7d138e0b7e2fb4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd33104c6660a25e1d84d4118ea4a738162d81f", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/abd33104c6660a25e1d84d4118ea4a738162d81f", "committedDate": "2020-07-01T22:12:34Z", "message": "GEODE-8240: back out IDM.equals() change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bfbc51884312142ce686c63fa9784af3a85d773", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/2bfbc51884312142ce686c63fa9784af3a85d773", "committedDate": "2020-07-01T22:37:58Z", "message": "GEODE-8240: spA"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjY2MDMx", "url": "https://github.com/apache/geode/pull/5334#pullrequestreview-441266031", "createdAt": "2020-07-01T23:58:16Z", "commit": {"oid": "2bfbc51884312142ce686c63fa9784af3a85d773"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4349, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}