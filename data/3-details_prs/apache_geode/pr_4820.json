{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTIyNzk2", "number": 4820, "title": "GEODE-7826: start jmx-manager if the Geode Management Rest Service is enabled", "bodyText": "Before the geode management rest service web app is added,\nthe code now starts the jmx-manager. If it can not be started then\nan error will be reported.\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-03-16T22:21:13Z", "url": "https://github.com/apache/geode/pull/4820", "merged": true, "mergeCommit": {"oid": "9700bbc34549886c462ea520de861b827a6267d5"}, "closed": true, "closedAt": "2020-03-24T17:20:55Z", "author": {"login": "dschneider-pivotal"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOVs7TAH2gAyMzg5NTIyNzk2OmU0NDQ1MzI2NTlhMDJhYzViOGU3Y2U0ZTg0MmVlZTgyNmE1MGJiMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ0VqsAFqTM4MDQwMzU1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e444532659a02ac5b8e7ce4e842eee826a50bb39", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/e444532659a02ac5b8e7ce4e842eee826a50bb39", "committedDate": "2020-03-16T22:18:06Z", "message": "Before the geode management rest service web app is added,\nthe code now starts the jmx-manager."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f84572caa2b3180e180c725407fb0ac0dd1a1350", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/f84572caa2b3180e180c725407fb0ac0dd1a1350", "committedDate": "2020-03-17T20:18:02Z", "message": "now checks if manager is already running before starting it.\nAlso if an esception occurs trying to start the manager it is now\nthrown instead of eating it and logging a warning."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5397281204b5276752bd09b51b536fda07b9420", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/e5397281204b5276752bd09b51b536fda07b9420", "committedDate": "2020-03-17T23:04:50Z", "message": "fix for failing dunit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e59d0ab57893a4e64e3a557da68f796e2e012bc", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/9e59d0ab57893a4e64e3a557da68f796e2e012bc", "committedDate": "2020-03-18T00:30:58Z", "message": "fixed test to not start locators with default jmx-manager port by disabling the management service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f4cc9943378e253778b618d92f36ed20387be8b", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/6f4cc9943378e253778b618d92f36ed20387be8b", "committedDate": "2020-03-19T16:32:18Z", "message": "added unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b56f314f63ce2bb58f3866f0a89136b3d092b8", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/78b56f314f63ce2bb58f3866f0a89136b3d092b8", "committedDate": "2020-03-19T18:06:50Z", "message": "fix failing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "822015186cc335173d594584ca7861870e8ac549", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/822015186cc335173d594584ca7861870e8ac549", "committedDate": "2020-03-19T19:35:24Z", "message": "now uses await"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68a07a38af8afafe9b81d9344274c1fee19e9eab", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/68a07a38af8afafe9b81d9344274c1fee19e9eab", "committedDate": "2020-03-19T21:34:51Z", "message": "disabled tests to help DEBUG the one that keeps failing in pr tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2233a229ccd5bb8f197055585916bff0bb8d14", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/8f2233a229ccd5bb8f197055585916bff0bb8d14", "committedDate": "2020-03-19T23:21:39Z", "message": "removed new tests from InternalLocatorIntegrationTest since\nthe geode-web-management war is not available to that test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb0c2192ade0b14c77bca6daa3ceb355ffc895f", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/4fb0c2192ade0b14c77bca6daa3ceb355ffc895f", "committedDate": "2020-03-19T23:23:39Z", "message": "removed one more DEBUG line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/3213a44aad6764869cad84305796f72f10ac2ebf", "committedDate": "2020-03-20T21:44:18Z", "message": "added unit test for InternalLocator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODM4NzA4", "url": "https://github.com/apache/geode/pull/4820#pullrequestreview-378838708", "createdAt": "2020-03-20T22:09:39Z", "commit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjowOTozOVrOF5kgTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyNjozMlrOF5kzgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMTI0NQ==", "bodyText": "I think most of the common setup stuff could be moved into a setup method. Then only the stuff that differs from one test to another would remain. That would make the test-specific details stand out more, and would more clearly express the intent of each test.\nIf only a few setup details remain in each test, and the intent is obvious, that's enough. If there are more than a few details, perhaps they can be hidden in helper methods with that express the intent.", "url": "https://github.com/apache/geode/pull/4820#discussion_r395911245", "createdAt": "2020-03-20T22:09:39Z", "author": {"login": "demery-pivotal"}, "path": "geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.apache.geode.distributed.internal;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.catchThrowable;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.internal.HttpService;\n+import org.apache.geode.internal.cache.InternalCacheForClientAccess;\n+import org.apache.geode.internal.cache.InternalRegionFactory;\n+import org.apache.geode.internal.security.SecurableCommunicationChannel;\n+import org.apache.geode.logging.internal.LoggingSession;\n+import org.apache.geode.management.internal.BaseManagementService;\n+\n+public class InternalLocatorTest {\n+  @Test\n+  public void startClusterManagementServiceWithRestServiceEnabledInvokesStartManager()\n+      throws IOException {\n+    LoggingSession loggingSession = mock(LoggingSession.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjE2Mg==", "bodyText": "Instead of adding a new test-only method, try this:\n\nAdd a new Supplier<InternalCache> parameter to the InternalLocator constructor, and let the constructor store the supplier in a field for later use.\nChange InternalLocator.getCache() to call the supplier instead of calling GemFireCacheImpl.getInstance() directly.\nChange InternalLocator.createLocator(\u2026) and InternalLocatorIntegrationTest to pass GemFireCacheImpl::getInstance to the InternalLocator constructor.\nIn these new tests, pass the mock cache to the InternalLocator constructor.", "url": "https://github.com/apache/geode/pull/4820#discussion_r395916162", "createdAt": "2020-03-20T22:26:32Z", "author": {"login": "demery-pivotal"}, "path": "geode-core/src/test/java/org/apache/geode/distributed/internal/InternalLocatorTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.apache.geode.distributed.internal;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.catchThrowable;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.internal.HttpService;\n+import org.apache.geode.internal.cache.InternalCacheForClientAccess;\n+import org.apache.geode.internal.cache.InternalRegionFactory;\n+import org.apache.geode.internal.security.SecurableCommunicationChannel;\n+import org.apache.geode.logging.internal.LoggingSession;\n+import org.apache.geode.management.internal.BaseManagementService;\n+\n+public class InternalLocatorTest {\n+  @Test\n+  public void startClusterManagementServiceWithRestServiceEnabledInvokesStartManager()\n+      throws IOException {\n+    LoggingSession loggingSession = mock(LoggingSession.class);\n+    DistributionConfigImpl distributionConfig = mock(DistributionConfigImpl.class);\n+    when(distributionConfig.getJmxManager()).thenReturn(true);\n+    when(distributionConfig.getLocators()).thenReturn(\"\");\n+    when(distributionConfig.getSecurableCommunicationChannels())\n+        .thenReturn(new SecurableCommunicationChannel[] {});\n+    when(distributionConfig.getSecurityAuthTokenEnabledComponents()).thenReturn(new String[] {});\n+    InternalLocator internalLocator = new InternalLocator(0, loggingSession, null, null, null, null,\n+        null, null, distributionConfig, null);\n+    InternalCacheForClientAccess cache = mock(InternalCacheForClientAccess.class);\n+    InternalRegionFactory regionFactory = mock(InternalRegionFactory.class);\n+    when(cache.createInternalRegionFactory(RegionShortcut.REPLICATE)).thenReturn(regionFactory);\n+    when(cache.getOptionalService(HttpService.class))\n+        .thenReturn(Optional.of(mock(HttpService.class)));\n+    when(cache.getCacheForProcessingClientRequests()).thenReturn(cache);\n+    BaseManagementService managementService = mock(BaseManagementService.class);\n+    BaseManagementService.setManagementService(cache, managementService);\n+    internalLocator.setInternalCache(cache);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTM1ODcy", "url": "https://github.com/apache/geode/pull/4820#pullrequestreview-379535872", "createdAt": "2020-03-23T15:23:17Z", "commit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMzoxN1rOF6Kfow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMzoxN1rOF6Kfow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMzY2Nw==", "bodyText": "Maybe put a comment here stating why jmxManager is needed when starting management rest service", "url": "https://github.com/apache/geode/pull/4820#discussion_r396533667", "createdAt": "2020-03-23T15:23:17Z", "author": {"login": "jinmeiliao"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -815,6 +822,10 @@ void startClusterManagementService() throws IOException {\n \n     if (distributionConfig.getEnableManagementRestService()) {\n       myCache.getOptionalService(HttpService.class).ifPresent(x -> {\n+        ManagementService managementService = ManagementService.getManagementService(myCache);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3213a44aad6764869cad84305796f72f10ac2ebf"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d973c9d7027022f1980325841f9916272555eca", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/6d973c9d7027022f1980325841f9916272555eca", "committedDate": "2020-03-23T17:58:32Z", "message": "removed the new setInternalCache method that was only used for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1517e1bc8c879d2f58d8ff951eade5825457f411", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/1517e1bc8c879d2f58d8ff951eade5825457f411", "committedDate": "2020-03-23T18:11:56Z", "message": "tests can now inject a mocked AgentUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b252da4e7eb4ce6cf6d656e049f1e83f28cd9c7", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/3b252da4e7eb4ce6cf6d656e049f1e83f28cd9c7", "committedDate": "2020-03-23T18:33:45Z", "message": "common code in unit test is now in shared private helper method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee7de2aca1d9129921c5b5e071928326e27fa23", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/aee7de2aca1d9129921c5b5e071928326e27fa23", "committedDate": "2020-03-23T18:37:28Z", "message": "added comment explaining why the jmx-manager is started\nif the management rest service is."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a30adbd901c69458e17bab80eb331f58c887fbb", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/2a30adbd901c69458e17bab80eb331f58c887fbb", "committedDate": "2020-03-23T19:21:11Z", "message": "Merge branch 'develop' into GEODE-7826"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c77e2eff539244d3b764f97b36c77660edcaf99", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/7c77e2eff539244d3b764f97b36c77660edcaf99", "committedDate": "2020-03-23T23:09:59Z", "message": "Since the locator currently just logs a message if the management rest\nservice can not be started, this is now also the behavior if the\njmx-manager can not be started on behalf of the management rest service.\nIf that happens the management rest service will not be available and\nyou will get a warning logged describing why the jmx-manager could not\nbe started."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDAzNTUz", "url": "https://github.com/apache/geode/pull/4820#pullrequestreview-380403553", "createdAt": "2020-03-24T15:07:36Z", "commit": {"oid": "7c77e2eff539244d3b764f97b36c77660edcaf99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4879, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}