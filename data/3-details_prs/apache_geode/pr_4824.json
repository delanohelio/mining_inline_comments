{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDg3Nzk0", "number": 4824, "title": "GEODE-7565: Allow gateway receivers with same host and port", "bodyText": "Long version:\nhttps://cwiki.apache.org/confluence/display/GEODE/Allow+same+host+and+port+for+all+gateway+receivers\nSummary:\nThere is a problem with Geode WAN replication when GW receivers are configured with the same hostname-for-senders and port on all servers. The reason for such a setup is deploying Geode cluster on a Kubernetes cluster where all GW receivers are reachable from the outside world on the same VIP and port.\nThe problem experienced is that shutting down one server is stopping replication to this cluster until the server is up again. This is because Geode incorrectly assumes there are no more alive servers when just one of them is down, because since they share hostname-for-senders and port, they are treated as one same server.\nWith these changes locator is able to distinguish the different receivers using the same hostname and port so replication is not impacted when one server is stopped.\n( Link to thread in dev mailing list: https://markmail.org/thread/6qakx67rxiokdsec )", "createdAt": "2020-03-18T14:59:48Z", "url": "https://github.com/apache/geode/pull/4824", "merged": true, "mergeCommit": {"oid": "dd23ee8200cba67cea82e57e2e4ccedcdf9e8266"}, "closed": true, "closedAt": "2020-04-17T23:18:12Z", "author": {"login": "alb3rtobr"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO4JMigH2gAyMzkwNDg3Nzk0OmIxODA4NjljNzMwOTVlN2E4MTBiYTJlMWM5MmUyNDNhMDIyMGU4ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYV0uwAFqTM5NTA3OTEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b180869c73095e7a810ba2e1c92e243a0220e888", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/b180869c73095e7a810ba2e1c92e243a0220e888", "committedDate": "2020-03-18T14:25:45Z", "message": "GEODE-7565: GW sender connection failover"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "187ca352a5569add1a993dc7de44af550294ce71", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/187ca352a5569add1a993dc7de44af550294ce71", "committedDate": "2020-03-18T14:44:26Z", "message": "Temp workaround for hanging test case"}, "afterCommit": {"oid": "8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "committedDate": "2020-03-18T15:07:40Z", "message": "Temp workaround for hanging test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bb45d9f45f91713c0fa37f90b5009dfc563441", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/39bb45d9f45f91713c0fa37f90b5009dfc563441", "committedDate": "2020-03-18T15:14:22Z", "message": "GEODE-7565: gw sender pings not reaching gw receivers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "committedDate": "2020-03-18T15:20:48Z", "message": "Temp workaround for hanging test case"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "committedDate": "2020-03-18T15:07:40Z", "message": "Temp workaround for hanging test case"}, "afterCommit": {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "committedDate": "2020-03-18T15:20:48Z", "message": "Temp workaround for hanging test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODE2NTQ0", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-379816544", "createdAt": "2020-03-23T20:57:50Z", "commit": {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjYyOTA1", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-382262905", "createdAt": "2020-03-26T17:52:51Z", "commit": {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Mjo1MVrOF8TQNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Mjo1MVrOF8TQNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3NDMyNg==", "bodyText": "why is this timeout needed?", "url": "https://github.com/apache/geode/pull/4824#discussion_r398774326", "createdAt": "2020-03-26T17:52:51Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/ConnectionPoolImplJUnitTest.java", "diffHunk": "@@ -168,7 +168,7 @@ public void testCacheClose() throws Exception {\n     assertTrue(pool2.isDestroyed());\n   }\n \n-  @Test\n+  @Test(timeout = 5000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cecab4e1850ee084079735048e66c25cc447045", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/2cecab4e1850ee084079735048e66c25cc447045", "committedDate": "2020-03-26T18:26:37Z", "message": "Revert \"GEODE-7565: gw sender pings not reaching gw receivers\"\n\nThis reverts commit 39bb45d9f45f91713c0fa37f90b5009dfc563441."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d53f1854510728e512e2ac805bfc3e6ce3eb41a7", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/d53f1854510728e512e2ac805bfc3e6ce3eb41a7", "committedDate": "2020-03-26T18:33:45Z", "message": "GEODE-7565: Distributed ping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/d8b6d0699de08c5ef9962e1614a692eb54e76a72", "committedDate": "2020-03-27T10:54:29Z", "message": "GEODE-7565: Fix lgtm error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c7b76ab191ae171d63fe7fcd16b562798e4abc0", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/6c7b76ab191ae171d63fe7fcd16b562798e4abc0", "committedDate": "2020-03-27T09:54:39Z", "message": "GEODE-7565: Fix lgtm error"}, "afterCommit": {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/d8b6d0699de08c5ef9962e1614a692eb54e76a72", "committedDate": "2020-03-27T10:54:29Z", "message": "GEODE-7565: Fix lgtm error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTMwNjc1", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-382930675", "createdAt": "2020-03-27T14:53:14Z", "commit": {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo1MzoxNFrOF80uGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo1MzoxNFrOF80uGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjY1MQ==", "bodyText": "This is what is causing the ConnectionPoolImplJUnitTest failure.  That test creates two servers and a pool in the same JVM, so both servers have the same membership ID.  If you delete that test and replace it with a distributedTest that creates the servers in different JVMs it ought to pass.", "url": "https://github.com/apache/geode/pull/4824#discussion_r399322651", "createdAt": "2020-03-27T14:53:14Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/EndpointManagerImpl.java", "diffHunk": "@@ -56,17 +56,17 @@ public EndpointManagerImpl(String poolName, DistributedSystem ds, CancelCriterio\n \n   @Override\n   public Endpoint referenceEndpoint(ServerLocation server, DistributedMember memberId) {\n-    Endpoint endpoint = endpointMap.get(server);\n+    Endpoint endpoint = endpointMap.get(memberId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTY0MTQ1", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-382964145", "createdAt": "2020-03-27T15:29:56Z", "commit": {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f80e68758aba16a34cc0aeed2757afab46b7bb0", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/3f80e68758aba16a34cc0aeed2757afab46b7bb0", "committedDate": "2020-04-01T17:36:12Z", "message": "Revert \"GEODE-7565: GW sender connection failover\"\n\nThis reverts commit b180869c73095e7a810ba2e1c92e243a0220e888."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec095b0e8166cbef4d3a21e805601addf5f52ee", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/bec095b0e8166cbef4d3a21e805601addf5f52ee", "committedDate": "2020-04-02T14:16:46Z", "message": "GEODE-7565: Use ip+port+id for server identification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c4b00f5c5d32a2ec20cb887bbda6f70d88c2a8b", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/0c4b00f5c5d32a2ec20cb887bbda6f70d88c2a8b", "committedDate": "2020-04-02T14:26:10Z", "message": "Fix spotlessJava"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTQ5NTI0", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-386549524", "createdAt": "2020-04-02T15:37:20Z", "commit": {"oid": "0c4b00f5c5d32a2ec20cb887bbda6f70d88c2a8b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3237d1339716fa63e5176828c22f188c3f650af", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/e3237d1339716fa63e5176828c22f188c3f650af", "committedDate": "2020-04-02T15:50:19Z", "message": "Undo not needed change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92a9670e25ebcb237fdc69a696b6c0028815347e", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/92a9670e25ebcb237fdc69a696b6c0028815347e", "committedDate": "2020-04-02T15:50:50Z", "message": "Use getUniqueId instead of getId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/517d6f6a3046fe08778aedacf9a8f88365e75799", "committedDate": "2020-04-02T16:13:37Z", "message": "Remove test timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjA1MjY3", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-386605267", "createdAt": "2020-04-02T16:41:17Z", "commit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njc5ODA5", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-388679809", "createdAt": "2020-04-06T23:09:13Z", "commit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzowOToxM1rOGBtLLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzoyODo1M1rOGBtlig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTkwMA==", "bodyText": "It looks like this is only used by tests, is that right? It might be better to remove this method, which uses and incorrect memberId of \"\"", "url": "https://github.com/apache/geode/pull/4824#discussion_r404441900", "createdAt": "2020-04-06T23:09:13Z", "author": {"login": "upthewaterspout"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/LocatorLoadSnapshot.java", "diffHunk": "@@ -85,49 +86,52 @@ public LocatorLoadSnapshot() {\n   }\n \n   public void addServer(ServerLocation location, String[] groups, ServerLoad initialLoad) {\n-    addServer(location, groups, initialLoad, 30000);\n+    addServer(location, \"\", groups, initialLoad, 30000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg==", "bodyText": "I'm wondering about how this method is handling excludedServers. If the hostname-for-senders of all of the servers is the same, doesn't that mean that as soon as one server is in this excluded server list, no results will be returned?", "url": "https://github.com/apache/geode/pull/4824#discussion_r404447716", "createdAt": "2020-04-06T23:26:02Z", "author": {"login": "upthewaterspout"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/LocatorLoadSnapshot.java", "diffHunk": "@@ -448,6 +489,65 @@ private void updateMap(Map map, ServerLocation location, float load, float loadP\n     }\n   }\n \n+  private void updateMap(Map map, ServerLocation location, String memberId, float load,\n+      float loadPerConnection) {\n+    Map groupMap = (Map) map.get(null);\n+    ServerLocationAndMemberId locationAndMemberId =\n+        new ServerLocationAndMemberId(location, memberId);\n+    LoadHolder holder =\n+        (LoadHolder) groupMap.get(locationAndMemberId);\n+\n+    if (holder != null) {\n+      holder.setLoad(load, loadPerConnection);\n+    }\n+  }\n+\n+  /**\n+   *\n+   * @param groupServers the servers to consider\n+   * @param excludedServers servers to exclude\n+   * @param count how many you want. a negative number means all of them in order of best to worst\n+   * @return a list of best...worst server LoadHolders\n+   */\n+  private List<LoadHolder> findBestServersUsingMemberId(\n+      Map<ServerLocationAndMemberId, LoadHolder> groupServers,\n+      Set<ServerLocation> excludedServers, int count) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799"}, "originalPosition": 265}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0ODY1MA==", "bodyText": "Does this need to take into account the version of the member that is being pinged? Could we be pinging a member with an older version and it will fail to deserialize this message? Or are we assuming all of the receivers will be upgraded before we start getting pings that need to be forwarded to the correct server.", "url": "https://github.com/apache/geode/pull/4824#discussion_r404448650", "createdAt": "2020-04-06T23:28:53Z", "author": {"login": "upthewaterspout"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/tier/sockets/command/Ping.java", "diffHunk": "@@ -60,6 +78,29 @@ public void cmdExecute(final Message clientMessage, final ServerConnection serve\n     }\n   }\n \n+  /**\n+   * Process a ping request that was sent to the wrong server\n+   */\n+  protected void pingCorrectServer(Message clientMessage, DistributedMember targetServer,\n+      ServerConnection serverConnection)\n+      throws IOException {\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\"Received a Ping request from {} intended for {}.  Forwarding the ping...\");\n+    }\n+    if (!serverConnection.getCache().getDistributionManager().isCurrentMember(targetServer)) {\n+      logger.warn(\"Unable to ping non-member {} for client {}\", targetServer,\n+          serverConnection.getProxyID());\n+      writeErrorResponse(clientMessage, MessageType.PING, serverConnection);\n+      serverConnection.setAsTrue(RESPONDED);\n+    } else {\n+      // send a ping message to the server. This is a one-way message that doesn't send a reply\n+      final DistributedPingMessage distributedPingMessage =\n+          new DistributedPingMessage(targetServer, serverConnection.getProxyID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48450aa495e551657a739a9eb7cbfe25e341b22", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/b48450aa495e551657a739a9eb7cbfe25e341b22", "committedDate": "2020-04-07T10:32:42Z", "message": "GEODE-7565: Remove unnecessary method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e1f2143c58681427b2d7c9cf948c4548fb50996", "author": {"user": {"login": "alb3rtobr", "name": "Alberto Bustamante Reyes"}}, "url": "https://github.com/apache/geode/commit/0e1f2143c58681427b2d7c9cf948c4548fb50996", "committedDate": "2020-04-08T09:02:08Z", "message": "GEODE-7565: Fix incomplete debug message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDc5MTA5", "url": "https://github.com/apache/geode/pull/4824#pullrequestreview-395079109", "createdAt": "2020-04-17T00:05:53Z", "commit": {"oid": "0e1f2143c58681427b2d7c9cf948c4548fb50996"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4890, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}