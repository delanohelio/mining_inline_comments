{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMDQwNjQz", "number": 5752, "title": "GEODE-8714: return event to queue at stoping of gw sender", "bodyText": "Do not review\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n[*] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n[*] Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n[*] Is your initial contribution a single, squashed commit?\n\n\n[*] Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-11-14T18:08:34Z", "url": "https://github.com/apache/geode/pull/5752", "merged": true, "mergeCommit": {"oid": "1eb9f344b3f83871e32a521c57068176230fb04e"}, "closed": true, "closedAt": "2020-11-17T07:41:00Z", "author": {"login": "mivanac"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcyovWAH2gAyNTIxMDQwNjQzOjRmODYwMjBkZWM0MTA3MjAyZDJkYWIzM2FjMTlhMzNlOGNlMDhmMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddiWxWgFqTUzMjg5MzQ3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f86020dec4107202d2dab33ac19a33e8ce08f2e", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/4f86020dec4107202d2dab33ac19a33e8ce08f2e", "committedDate": "2020-11-15T16:06:52Z", "message": "GEODE-8714: return event to queue at stoping of gw sender"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b32e38318328136ceae9d785d5a0a4b70636e22", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/7b32e38318328136ceae9d785d5a0a4b70636e22", "committedDate": "2020-11-14T17:59:38Z", "message": "GEODE-8714: return event to queue at stoping of gw sender"}, "afterCommit": {"oid": "4f86020dec4107202d2dab33ac19a33e8ce08f2e", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/4f86020dec4107202d2dab33ac19a33e8ce08f2e", "committedDate": "2020-11-15T16:06:52Z", "message": "GEODE-8714: return event to queue at stoping of gw sender"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a", "committedDate": "2020-11-16T13:59:29Z", "message": "GEODE-8714: added test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDg1OTc5", "url": "https://github.com/apache/geode/pull/5752#pullrequestreview-532085979", "createdAt": "2020-11-17T07:39:24Z", "commit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODkzNDc4", "url": "https://github.com/apache/geode/pull/5752#pullrequestreview-532893478", "createdAt": "2020-11-17T23:19:46Z", "commit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoxOTo0NlrOH1PeqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0MjowMVrOH1P_1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MDE4NQ==", "bodyText": "These casts to Integer are redundant and can be removed.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525590185", "createdAt": "2020-11-17T23:19:46Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MDI4NQ==", "bodyText": "This commented out line should be removed.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525590285", "createdAt": "2020-11-17T23:20:00Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MDQ0NQ==", "bodyText": "These casts to String are redundant and can be removed.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525590445", "createdAt": "2020-11-17T23:20:23Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NDIwMg==", "bodyText": "LogWriterUtils and the getLogWriter() method are both deprecated. LogService#getLogger() should be used instead. This log message also seems redundant, since the same information is already logged as part of the createSenderWithDiskStore() method.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525594202", "createdAt": "2020-11-17T23:29:46Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NTk3MQ==", "bodyText": "LogWriterUtils and the getLogWriter() method are both deprecated. LogService#getLogger() should be used instead. However, for this log message, and the rest that appear in this test, a better approach would be to pass a name to the VM.invoke() method in addition to the lambda, which will result in that name being logged both at the start and end of lambda execution. This prevents the need to add logging throughout the test to know where the test has got to.\ne.g.\nvm4.invoke(\"Do puts to the region\", () -> WANTestBase.doPuts(getTestMethodName(), 10));\nwhich results in the following logging:\n[vm4] [info 2020/11/17 15:37:17.164 PST <RMI TCP Connection(1)-10.0.0.221> tid=0x13] Received method: org.apache.geode.test.dunit.internal.IdentifiableRunnable.run with 0 args on object: IdentifiableRunnable(0:Do puts to the region)\n...\n[vm4]  from org.apache.geode.test.dunit.internal.IdentifiableRunnable.run with 0 args on object: IdentifiableRunnable(0:Do puts to the region) (took 367 ms)", "url": "https://github.com/apache/geode/pull/5752#discussion_r525595971", "createdAt": "2020-11-17T23:34:32Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);\n+\n+    // create PR on remote site\n+    vm2.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+    vm3.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+\n+    // create PR on local site\n+    vm4.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+    // start the senders on local site\n+    startSenderInVMs(\"ln\", vm4, vm5);\n+\n+    // wait for senders to become running\n+    vm4.invoke(waitForSenderRunnable());\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    // start puts in region on local site\n+    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName(), 10));\n+    LogWriterUtils.getLogWriter().info(\"Completed puts in the region\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5ODUyMg==", "bodyText": "See above comment regarding deprecated logging and passing names to the invoke() method to avoid needing to log directly during the test.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525598522", "createdAt": "2020-11-17T23:41:30Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);\n+\n+    // create PR on remote site\n+    vm2.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+    vm3.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+\n+    // create PR on local site\n+    vm4.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+    // start the senders on local site\n+    startSenderInVMs(\"ln\", vm4, vm5);\n+\n+    // wait for senders to become running\n+    vm4.invoke(waitForSenderRunnable());\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    // start puts in region on local site\n+    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName(), 10));\n+    LogWriterUtils.getLogWriter().info(\"Completed puts in the region\");\n+\n+    // --------------------close and rebuild local site\n+    // -------------------------------------------------\n+    // kill the sender in vm5\n+    vm5.invoke(killSenderRunnable());\n+\n+    LogWriterUtils.getLogWriter().info(\"Killed vm5 sender.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5ODU2Nw==", "bodyText": "See above comment regarding deprecated logging and passing names to the invoke() method to avoid needing to log directly during the test.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525598567", "createdAt": "2020-11-17T23:41:41Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);\n+\n+    // create PR on remote site\n+    vm2.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+    vm3.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+\n+    // create PR on local site\n+    vm4.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+    // start the senders on local site\n+    startSenderInVMs(\"ln\", vm4, vm5);\n+\n+    // wait for senders to become running\n+    vm4.invoke(waitForSenderRunnable());\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    // start puts in region on local site\n+    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName(), 10));\n+    LogWriterUtils.getLogWriter().info(\"Completed puts in the region\");\n+\n+    // --------------------close and rebuild local site\n+    // -------------------------------------------------\n+    // kill the sender in vm5\n+    vm5.invoke(killSenderRunnable());\n+\n+    LogWriterUtils.getLogWriter().info(\"Killed vm5 sender.\");\n+\n+    // restart the vm\n+    createCacheInVMs(lnPort, vm5);\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    LogWriterUtils.getLogWriter().info(\"Created back the cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5ODYwNg==", "bodyText": "See above comment regarding deprecated logging and passing names to the invoke() method to avoid needing to log directly during the test.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525598606", "createdAt": "2020-11-17T23:41:49Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);\n+\n+    // create PR on remote site\n+    vm2.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+    vm3.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+\n+    // create PR on local site\n+    vm4.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+    // start the senders on local site\n+    startSenderInVMs(\"ln\", vm4, vm5);\n+\n+    // wait for senders to become running\n+    vm4.invoke(waitForSenderRunnable());\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    // start puts in region on local site\n+    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName(), 10));\n+    LogWriterUtils.getLogWriter().info(\"Completed puts in the region\");\n+\n+    // --------------------close and rebuild local site\n+    // -------------------------------------------------\n+    // kill the sender in vm5\n+    vm5.invoke(killSenderRunnable());\n+\n+    LogWriterUtils.getLogWriter().info(\"Killed vm5 sender.\");\n+\n+    // restart the vm\n+    createCacheInVMs(lnPort, vm5);\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    LogWriterUtils.getLogWriter().info(\"Created back the cache\");\n+\n+    // create senders with disk store\n+    vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2, true, 100, 10, false, true,\n+        null, diskStore2, false));\n+\n+    LogWriterUtils.getLogWriter().info(\"Created the senders back from the disk store.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5ODY3Nw==", "bodyText": "See above comment regarding deprecated logging and passing names to the invoke() method to avoid needing to log directly during the test.", "url": "https://github.com/apache/geode/pull/5752#discussion_r525598677", "createdAt": "2020-11-17T23:42:01Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/parallel/ParallelWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -1897,6 +1897,106 @@ public void testpersistentWanGateway_restartSender_expectAllEventsReceived_scena\n     vm3.invoke(() -> WANTestBase.validateRegionSize(getTestMethodName(), 3000));\n   }\n \n+  /**\n+   * Enable persistence for PR and GatewaySender. Do some puts in local region. Restart 1 server,\n+   * then stop gateway sender, and stop server. After that create receiver on remote site.\n+   * Check if the remote site receives all the events.\n+   */\n+  @Test\n+  public void testPersistentPRWithGatewaySenderPersistenceEnabled_RestartAndStopServer() {\n+    // create locator on local site\n+    Integer lnPort = (Integer) vm0.invoke(() -> WANTestBase.createFirstLocatorWithDSId(1));\n+    // create locator on remote site\n+    Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n+\n+    // create receiver on remote site\n+    createCacheInVMs(nyPort, vm2, vm3);\n+    // createReceiverInVMs(vm2, vm3);\n+\n+    // create cache in local site\n+    createCacheInVMs(lnPort, vm4, vm5);\n+    vm4.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    // create senders with disk store\n+    String diskStore1 = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+    String diskStore2 = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+        true, 100, 10, false, true, null, null, true));\n+\n+    LogWriterUtils.getLogWriter()\n+        .info(\"The DS are: \" + diskStore1 + \",\" + diskStore2);\n+\n+    // create PR on remote site\n+    vm2.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+    vm3.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), null, 1,\n+        13, isOffHeap()));\n+\n+    // create PR on local site\n+    vm4.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+    // start the senders on local site\n+    startSenderInVMs(\"ln\", vm4, vm5);\n+\n+    // wait for senders to become running\n+    vm4.invoke(waitForSenderRunnable());\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    // start puts in region on local site\n+    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName(), 10));\n+    LogWriterUtils.getLogWriter().info(\"Completed puts in the region\");\n+\n+    // --------------------close and rebuild local site\n+    // -------------------------------------------------\n+    // kill the sender in vm5\n+    vm5.invoke(killSenderRunnable());\n+\n+    LogWriterUtils.getLogWriter().info(\"Killed vm5 sender.\");\n+\n+    // restart the vm\n+    createCacheInVMs(lnPort, vm5);\n+    vm5.invoke(() -> setNumDispatcherThreadsForTheRun(2));\n+\n+    LogWriterUtils.getLogWriter().info(\"Created back the cache\");\n+\n+    // create senders with disk store\n+    vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2, true, 100, 10, false, true,\n+        null, diskStore2, false));\n+\n+    LogWriterUtils.getLogWriter().info(\"Created the senders back from the disk store.\");\n+    // create PR on local site\n+    vm5.invoke(() -> WANTestBase.createPersistentPartitionedRegion(getTestMethodName(), \"ln\", 1,\n+        13, isOffHeap()));\n+\n+\n+    LogWriterUtils.getLogWriter().info(\"Created back the partitioned regions\");\n+\n+    LogWriterUtils.getLogWriter().info(\"Waiting for senders running.\");\n+    // wait for senders running\n+    vm5.invoke(waitForSenderRunnable());\n+\n+    LogWriterUtils.getLogWriter().info(\"All the senders are now running...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec64bdd9fd9c2a4cd72a8068576e859d8861d7a"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3881, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}