{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MzM5NTk0", "number": 5770, "title": "GEODE-8745: Closing the queue region when senders are stopped.", "bodyText": "* cleanQueues are applicable only while using persistence\n* when we are closing the region, the disk files are not deleted.\n* hence the values will still be maintained on restart.\n* Advantage will be that we are creating the queue region and its cache listener together\n* previously the region was not closed and cache listener was attached using mutators.\n* this caused secondary events to be missed before the cache listener is activated\n\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-11-24T09:31:46Z", "url": "https://github.com/apache/geode/pull/5770", "merged": true, "mergeCommit": {"oid": "888e4734ac532a4465e2818010c7983ee57009a2"}, "closed": true, "closedAt": "2020-12-01T17:27:42Z", "author": {"login": "nabarunnag"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfmhphABqjQwMzE3NjgzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhuyLxgFqTU0MTQwMDAxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dda43a62d16738ca4a324e2d6f53f5c586f9b76d", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/dda43a62d16738ca4a324e2d6f53f5c586f9b76d", "committedDate": "2020-11-24T09:23:16Z", "message": "GEM-2935: Closing the queue region when senders are stopped.\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}, "afterCommit": {"oid": "d01498140a4474e68be1fc94abbd73a7cbf9f97b", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/d01498140a4474e68be1fc94abbd73a7cbf9f97b", "committedDate": "2020-11-24T09:41:31Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d01498140a4474e68be1fc94abbd73a7cbf9f97b", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/d01498140a4474e68be1fc94abbd73a7cbf9f97b", "committedDate": "2020-11-24T09:41:31Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}, "afterCommit": {"oid": "b1c5c7ede4b5f8668a56301c3e013047878973aa", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/b1c5c7ede4b5f8668a56301c3e013047878973aa", "committedDate": "2020-11-24T10:00:40Z", "message": "GEM-2935: Closing the queue region when senders are stopped.\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1c5c7ede4b5f8668a56301c3e013047878973aa", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/b1c5c7ede4b5f8668a56301c3e013047878973aa", "committedDate": "2020-11-24T10:00:40Z", "message": "GEM-2935: Closing the queue region when senders are stopped.\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}, "afterCommit": {"oid": "fbaad8fed505b234445f924fc301cc4cda1f2101", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/fbaad8fed505b234445f924fc301cc4cda1f2101", "committedDate": "2020-11-24T12:57:09Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/119f99323a995d7bef129364380f63a76f3150d3", "committedDate": "2020-11-24T17:46:32Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbaad8fed505b234445f924fc301cc4cda1f2101", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/fbaad8fed505b234445f924fc301cc4cda1f2101", "committedDate": "2020-11-24T12:57:09Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}, "afterCommit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/119f99323a995d7bef129364380f63a76f3150d3", "committedDate": "2020-11-24T17:46:32Z", "message": "GEM-2935: Closing the queue region when senders are stopped\n\n\t* cleanQueues are applicable only while using persistence\n\t* when we are closing the region, the disk files are not deleted.\n\t* hence the values will still be maintained on restart.\n\t* Advantage will be that we are creating the queue region and its cache listener together\n\t* previously the region was not closed and cache listener was attached using mutators.\n\t* this caused secondary events to be missed before the cache listener is activated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQwMDg2", "url": "https://github.com/apache/geode/pull/5770#pullrequestreview-541140086", "createdAt": "2020-11-30T17:36:35Z", "commit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozNjozNVrOH8GHXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozNjozNVrOH8GHXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3Njc5Ng==", "bodyText": "This change is because the CacheListener to handle the unprocessedEventsMap is set here, hence I wanted the listener to be up and running before the map is initialized so that no events are missed because they were put in the map before the listener was running.", "url": "https://github.com/apache/geode/pull/5770#discussion_r532776796", "createdAt": "2020-11-30T17:36:35Z", "author": {"login": "nabarunnag"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/serial/SerialGatewaySenderEventProcessor.java", "diffHunk": "@@ -111,10 +111,9 @@ public SerialGatewaySenderEventProcessor(AbstractGatewaySender sender, String id\n       ThreadsMonitoring tMonitoring, boolean cleanQueues) {\n     super(\"Event Processor for GatewaySender_\" + id, sender, tMonitoring);\n \n+    initializeMessageQueue(id, cleanQueues);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTUyNzQ2", "url": "https://github.com/apache/geode/pull/5770#pullrequestreview-541152746", "createdAt": "2020-11-30T17:52:26Z", "commit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo1MjoyNlrOH8GwVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo1MjoyNlrOH8GwVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NzI4Nw==", "bodyText": "Instead of using the logger in this test to track progress, you could instead use the invoke() method signature that passes a String description/name as the first parameter, which allows anyone debugging the test to see when the invocation in question starts and finishes. Just personal preference, but I think it makes things neater and provides a little more information to anyone looking at the test output.", "url": "https://github.com/apache/geode/pull/5770#discussion_r532787287", "createdAt": "2020-11-30T17:52:26Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/serial/SerialWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -603,27 +605,32 @@ public void testReplicatedRegionPersistentWanGateway_restartSenderWithCleanQueue\n     vm7.invoke(() -> WANTestBase.createPersistentReplicatedRegion(getTestMethodName() + \"_RR\", \"ln\",\n         isOffHeap()));\n \n+    vm4.invoke(() -> WANTestBase.pauseSender(\"ln\"));\n+    vm5.invoke(() -> WANTestBase.pauseSender(\"ln\"));\n+\n     vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName() + \"_RR\", 1000));\n \n     logger.info(\"Completed puts in the region\");\n \n     vm4.invoke(() -> WANTestBase.stopSender(\"ln\"));\n     vm5.invoke(() -> WANTestBase.stopSender(\"ln\"));\n \n-    logger.info(\"Stopped all the senders. \");\n \n-    // Create receiver on remote site\n-    createReceiverInVMs(vm2, vm3);\n+    logger.info(\"Stopped all the senders. \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDAwMDEx", "url": "https://github.com/apache/geode/pull/5770#pullrequestreview-541400011", "createdAt": "2020-12-01T00:27:11Z", "commit": {"oid": "119f99323a995d7bef129364380f63a76f3150d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3900, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}