{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNTk4NzY2", "number": 5689, "title": "GEODE-8667: Duplicate online Oplog compaction after offline Oplog compaction", "bodyText": "When Oplog.totalCount == 0, no Oplog compaction is needed.\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-10-29T22:10:42Z", "url": "https://github.com/apache/geode/pull/5689", "merged": true, "mergeCommit": {"oid": "6202eceaa89038ce9326e5f518437a5ba1ed93ca"}, "closed": true, "closedAt": "2021-01-04T23:11:16Z", "author": {"login": "jchen21"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXZn8cgH2gAyNTEyNTk4NzY2OmY4YTYxNGFkMDQ1YjFiMGI2YzYzMzZiNTc5YTFmMTNjOTFjODNhZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds9nhkgFqTU2MTM3NjMwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8a614ad045b1b0b6c6336b579a1f13c91c83af1", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/f8a614ad045b1b0b6c6336b579a1f13c91c83af1", "committedDate": "2020-10-29T22:08:45Z", "message": "First attempt to fix the bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54bb79dd9439fd83c19b4380e67190c1300b3ec", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/c54bb79dd9439fd83c19b4380e67190c1300b3ec", "committedDate": "2020-11-04T02:57:20Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c696fce4411b2fc44cd9ef0bb5f77698bb225510", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/c696fce4411b2fc44cd9ef0bb5f77698bb225510", "committedDate": "2020-11-06T00:58:44Z", "message": "Refactor the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb77f01cc840e8aa70a834a99986842736d274c4", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/fb77f01cc840e8aa70a834a99986842736d274c4", "committedDate": "2020-11-06T01:18:34Z", "message": "Fix a test bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTUzMDU1", "url": "https://github.com/apache/geode/pull/5689#pullrequestreview-525553055", "createdAt": "2020-11-06T23:24:14Z", "commit": {"oid": "fb77f01cc840e8aa70a834a99986842736d274c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTc1NDE4", "url": "https://github.com/apache/geode/pull/5689#pullrequestreview-525575418", "createdAt": "2020-11-07T01:07:47Z", "commit": {"oid": "fb77f01cc840e8aa70a834a99986842736d274c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMTowNzo0N1rOHvBxdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMTowNzo0N1rOHvBxdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA3NDE2Nw==", "bodyText": "This fix is incorrect. It only caused the empty oplog (created by the offline compaction) is not deleted by the recovery's auto compaction.\nI modified the dunit test a little bit and proved it.\nUnfortunately, there's no flag or status to show that a compaction is just finished. Even we want to use the empty oplog created by offline compaction, we need to careful arrange the logic. Such as:\nchange  needsCompaction to return int. 1: need to compact, -1: no need to compact, 0: there's one empty file,  only need to delete it.\nBut maybe there's better ideas.", "url": "https://github.com/apache/geode/pull/5689#discussion_r519074167", "createdAt": "2020-11-07T01:07:47Z", "author": {"login": "gesterzhou"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/Oplog.java", "diffHunk": "@@ -5789,9 +5789,8 @@ boolean needsCompaction() {\n       if (((rv / (double) rvHWMtmp) * 100) <= parent.getCompactionThreshold()) {\n         return true;\n       }\n-    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb77f01cc840e8aa70a834a99986842736d274c4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f45c746db001fc0b0c0371e3da3c8fb323da9ad2", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/f45c746db001fc0b0c0371e3da3c8fb323da9ad2", "committedDate": "2020-11-19T01:48:56Z", "message": "Add more condition check for needsCompaction\n\nAfter offline compaction, the Oplog totalCount is zero,\nand totalLiveCount is greater than zero, then there is no need for compaction.\n\nWhen totalCount is zero, and totalLiveCount is less than or equals to zero,\nwhich indicates an empty Oplog, then compaction is needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff18c46b45f927c7970f4e95a1e1b42197be49a8", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/ff18c46b45f927c7970f4e95a1e1b42197be49a8", "committedDate": "2020-12-03T23:48:58Z", "message": "Update totalCount during recovery\n\nIf totalCount == 0 and totalLiveCount > 0, which indicates offline\ncompaction is done for this Oplog. Update totalCount to the value\nof totalLiveCount."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9658616a186dc3b8274083f77fcfdab6922084d", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/f9658616a186dc3b8274083f77fcfdab6922084d", "committedDate": "2020-12-03T23:52:20Z", "message": "Minor change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6c8d3993303bfb310466e34ae0c2e0ea9191c6", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/8a6c8d3993303bfb310466e34ae0c2e0ea9191c6", "committedDate": "2020-12-04T00:04:22Z", "message": "Use a local variable for the value of AtomicLong"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc05c526d65b103004010a51941caa5e43cd18d4", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/fc05c526d65b103004010a51941caa5e43cd18d4", "committedDate": "2020-12-04T23:09:08Z", "message": "Refactor the test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODQxNjQ4", "url": "https://github.com/apache/geode/pull/5689#pullrequestreview-547841648", "createdAt": "2020-12-09T05:18:26Z", "commit": {"oid": "fc05c526d65b103004010a51941caa5e43cd18d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02bcde5e45402154dcc15b25f72f839deccab496", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/02bcde5e45402154dcc15b25f72f839deccab496", "committedDate": "2020-12-15T01:34:57Z", "message": "Minor refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMzc2MzA3", "url": "https://github.com/apache/geode/pull/5689#pullrequestreview-561376307", "createdAt": "2021-01-04T21:57:17Z", "commit": {"oid": "02bcde5e45402154dcc15b25f72f839deccab496"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4001, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}