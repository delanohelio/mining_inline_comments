{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MjY2MDc4", "number": 4798, "title": "GEODE-7863: Reduce ServerCQImpl Contention", "bodyText": "We don't need to lock the entire internal cache for Partitioned\nregions so the implementation is now split by region type, this will\nus to improve/change them independently in the future.\n\nRemoved redundant checks.\nKeep current behavior for Replicate Regions.\nUse ConcurrentMap instead of locking the entire internal cache on\nevery operation for Partition Regions.\nKeep the lock on ServerCQImpl instance only while executing the\nquery and leave stats operations outside of the synchronized block.\n\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-03-12T14:09:51Z", "url": "https://github.com/apache/geode/pull/4798", "merged": true, "mergeCommit": {"oid": "9e3c473e9cf6d72126d0e84319b1192a5e2b6fdb"}, "closed": true, "closedAt": "2020-03-16T10:33:53Z", "author": {"login": "jujoramos"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM8SptgH2gAyMzg3MjY2MDc4OjhmNDA3NGMwNjVjN2U2NGZjMjZiOWEyMjMyMjBmMWNmMjg4YjgxZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNV6TNgFqTM3NDA0ODg1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f4074c065c7e64fc26b9a223220f1cf288b81e2", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/8f4074c065c7e64fc26b9a223220f1cf288b81e2", "committedDate": "2020-03-12T14:07:51Z", "message": "GEODE-7863: Reduce ServerCQImpl Contention\n\nWe don't need to lock the entire internal cache for Partitioned\nregions so the implementation is now split by region type, this will\nus to improve/change them independently in the future.\n\n- Removed redundant checks.\n- Keep current behavior for Replicate Regions.\n- Use ConcurrentMap instead of locking the entire internal cache on\nevery operation for Partition Regions.\n- Keep the lock on ServerCQImpl instance only while executing the\nquery and leave stats operations outside of the synchronized block."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d7b5facceda551e3a65771c3d0a8cfa7a361dba", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/7d7b5facceda551e3a65771c3d0a8cfa7a361dba", "committedDate": "2020-03-13T13:54:13Z", "message": "GEODE-7863: Changed attributes to be final, they do not need to be volatile."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8502ca3d8d88375ee1b1ac42c897505bb9951a4", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/a8502ca3d8d88375ee1b1ac42c897505bb9951a4", "committedDate": "2020-03-13T16:39:10Z", "message": "GEODE-7863: Remove defaults from the interface and add a no-op cache implementation for those cases on which cache is disabled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDQ4ODU4", "url": "https://github.com/apache/geode/pull/4798#pullrequestreview-374048858", "createdAt": "2020-03-13T04:50:18Z", "commit": {"oid": "8f4074c065c7e64fc26b9a223220f1cf288b81e2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwNDo1MDoxOVrOF13jog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwNDo1MDoxOVrOF13jog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAyOTA5MA==", "bodyText": "Not for this diff, but it would be nice to have both cache types set initialized at the same place \ud83e\udd37\u200d\u2642", "url": "https://github.com/apache/geode/pull/4798#discussion_r392029090", "createdAt": "2020-03-13T04:50:19Z", "author": {"login": "jhuynh1"}, "path": "geode-cq/src/main/java/org/apache/geode/cache/query/cq/internal/ServerCQImpl.java", "diffHunk": "@@ -232,17 +218,17 @@ public void registerCq(ClientProxyMembershipID p_clientProxyId, CacheClientNotif\n \n     // Initialize CQ results (key) cache.\n     if (CqServiceProvider.MAINTAIN_KEYS) {\n-      this.cqResultKeys = new HashMap<>();\n       // Currently the CQ Result keys are not cached for the Partitioned\n       // Regions. Supporting this with PR needs more work like forcing\n       // query execution on primary buckets only; and handling the bucket\n       // re-balancing. Once this is added remove the check with PR region.\n       // Only the events which are seen during event processing is\n       // added to the results cache (not from the CQ Results).\n       if (this.isPR) {\n-        this.setCqResultsCacheInitialized();\n+        serverCQCache = new ServerCQCachePartitionRegionImpl();\n+        setCqResultsCacheInitialized();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f4074c065c7e64fc26b9a223220f1cf288b81e2"}, "originalPosition": 99}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4854, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}