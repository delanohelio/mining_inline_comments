{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMzU0NjI2", "number": 4913, "title": "GEODE-7943 add synchronization to Subscriptions class", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-04-07T15:53:04Z", "url": "https://github.com/apache/geode/pull/4913", "merged": true, "mergeCommit": {"oid": "51477e91cd65a14e9396fb7da2876cd8bf2b7dee"}, "closed": true, "closedAt": "2020-04-10T06:45:42Z", "author": {"login": "jdeppe-pivotal"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVVXpyAH2gAyNDAwMzU0NjI2OjlmNTQ1M2I2NDFhYTlkNmEwYWE5ZmFjMDgzZjBlMTIyN2MyMDRkZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWJNtQAH2gAyNDAwMzU0NjI2OjhlYTVmMGY5YTMyOTUzNjdiOWYzZjFkZTdkMTVhYmE3NGNlMDc1ZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f5453b641aa9d6a0aa9fac083f0e1227c204dd4", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/9f5453b641aa9d6a0aa9fac083f0e1227c204dd4", "committedDate": "2020-04-07T15:52:20Z", "message": "GEOE-7943 add synchronization to Subscriptions class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzMwNTMw", "url": "https://github.com/apache/geode/pull/4913#pullrequestreview-389330530", "createdAt": "2020-04-07T17:20:34Z", "commit": {"oid": "9f5453b641aa9d6a0aa9fac083f0e1227c204dd4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyMDozNFrOGCOFNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyMDozNFrOGCOFNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MTA0Nw==", "bodyText": "Technically I think size() needs to be synchronized as well.", "url": "https://github.com/apache/geode/pull/4913#discussion_r404981047", "createdAt": "2020-04-07T17:20:34Z", "author": {"login": "upthewaterspout"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/Subscriptions.java", "diffHunk": "@@ -55,30 +55,37 @@ public boolean exists(Object channelOrPattern, Client client) {\n    * @param channelOrPattern the channel or pattern\n    * @return a list of subscriptions\n    */\n-  public List<Subscription> findSubscriptions(String channelOrPattern) {\n-    return this.subscriptions.stream()\n+  public synchronized List<Subscription> findSubscriptions(String channelOrPattern) {\n+    return subscriptions.stream()\n         .filter(subscription -> subscription.matches(channelOrPattern))\n         .collect(Collectors.toList());\n   }\n \n   /**\n    * Add a new subscription\n    */\n-  public void add(Subscription subscription) {\n-    this.subscriptions.add(subscription);\n+  public synchronized void add(Subscription subscription) {\n+    subscriptions.add(subscription);\n   }\n \n   /**\n    * Remove all subscriptions for a given client\n    */\n-  public void remove(Client client) {\n-    this.subscriptions.removeIf(subscription -> subscription.matchesClient(client));\n+  public synchronized void remove(Client client) {\n+    subscriptions.removeIf(subscription -> subscription.matchesClient(client));\n   }\n \n   /**\n    * Remove a single subscription\n    */\n-  public void remove(Object channel, Client client) {\n-    this.subscriptions.removeIf(subscription -> subscription.isEqualTo(channel, client));\n+  public synchronized void remove(Object channel, Client client) {\n+    subscriptions.removeIf(subscription -> subscription.isEqualTo(channel, client));\n+  }\n+\n+  /**\n+   * @return the total number of all local subscriptions\n+   */\n+  public int size() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f5453b641aa9d6a0aa9fac083f0e1227c204dd4"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzU1MjE2", "url": "https://github.com/apache/geode/pull/4913#pullrequestreview-389355216", "createdAt": "2020-04-07T17:52:43Z", "commit": {"oid": "9f5453b641aa9d6a0aa9fac083f0e1227c204dd4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4becd43529d9cf6a1dbca26885c956149cdfaae9", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/4becd43529d9cf6a1dbca26885c956149cdfaae9", "committedDate": "2020-04-07T21:51:58Z", "message": "Switch to using CopyOnWriteArrayList as the backing structure\n\nAuthored-by: Jens Deppe <jdeppe@vmware.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NTI2Nzkw", "url": "https://github.com/apache/geode/pull/4913#pullrequestreview-389526790", "createdAt": "2020-04-07T22:11:39Z", "commit": {"oid": "4becd43529d9cf6a1dbca26885c956149cdfaae9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2eef94690cd1b33ff14cfb67963e3982d585bbd", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/e2eef94690cd1b33ff14cfb67963e3982d585bbd", "committedDate": "2020-04-08T03:21:39Z", "message": "Revert \"Switch to using CopyOnWriteArrayList as the backing structure\"\n\nThis reverts commit 4becd43529d9cf6a1dbca26885c956149cdfaae9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c708f2a5d2d694ccc5da0222e707a3631a5196", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/01c708f2a5d2d694ccc5da0222e707a3631a5196", "committedDate": "2020-04-08T14:12:07Z", "message": "Add synchronized to size()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b4e2787f1b313025c8f9cb13077a8c58ae99fdb", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/7b4e2787f1b313025c8f9cb13077a8c58ae99fdb", "committedDate": "2020-04-08T15:25:03Z", "message": "Trigger CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMDg3NDQ5", "url": "https://github.com/apache/geode/pull/4913#pullrequestreview-390087449", "createdAt": "2020-04-08T15:30:45Z", "commit": {"oid": "7b4e2787f1b313025c8f9cb13077a8c58ae99fdb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d60ae103a8f9473d84abdcf75b172fd2e1c290b", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/9d60ae103a8f9473d84abdcf75b172fd2e1c290b", "committedDate": "2020-04-09T03:57:01Z", "message": "wat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40c027e24fa34d04512cd2b7ab2faddebf609179", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/40c027e24fa34d04512cd2b7ab2faddebf609179", "committedDate": "2020-04-09T04:23:42Z", "message": "Move test to integrationTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad583e053bb8506d9acac8db62f12701c3b1ff0d", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/ad583e053bb8506d9acac8db62f12701c3b1ff0d", "committedDate": "2020-04-09T16:31:21Z", "message": "Switch back to CopyOnWriteList since it appears not to really introduce memory issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ea5f0f9a3295367b9f3f1de7d15aba74ce075de", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/8ea5f0f9a3295367b9f3f1de7d15aba74ce075de", "committedDate": "2020-04-10T04:16:32Z", "message": "It seems that mock Subscription objects produce a ton of garbage\n\n- Also fix a small cleanup issue in ExpireAtIntegrationTest\n\nAuthored-by: Jens Deppe <jdeppe@vmware.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4755, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}