{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTU0MzA3", "number": 4924, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjowMzoxNVrOD01kkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjozODo0OFrOD02oQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NzMwMjU2OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/ConnectionImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjowMzoxNVrOGJ-Vqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzoxNTowMFrOGKBq1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzExMTcyMg==", "bodyText": "Clean up these TODO:KIRK parts.", "url": "https://github.com/apache/geode/pull/4924#discussion_r413111722", "createdAt": "2020-04-22T16:03:15Z", "author": {"login": "upthewaterspout"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/ConnectionImpl.java", "diffHunk": "@@ -223,6 +223,16 @@ public Socket getSocket() {\n     return theSocket;\n   }\n \n+  @Override\n+  public long getBirthDate() {\n+    return 0; // TODO:KIRK", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd4579bb67e1604cb3245ea244beb8e12faa2c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE0NTI0NQ==", "bodyText": "Thanks for catching those!", "url": "https://github.com/apache/geode/pull/4924#discussion_r413145245", "createdAt": "2020-04-22T16:46:58Z", "author": {"login": "kirklund"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/ConnectionImpl.java", "diffHunk": "@@ -223,6 +223,16 @@ public Socket getSocket() {\n     return theSocket;\n   }\n \n+  @Override\n+  public long getBirthDate() {\n+    return 0; // TODO:KIRK", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzExMTcyMg=="}, "originalCommit": {"oid": "b2dd4579bb67e1604cb3245ea244beb8e12faa2c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjI5NQ==", "bodyText": "Removed", "url": "https://github.com/apache/geode/pull/4924#discussion_r413166295", "createdAt": "2020-04-22T17:15:00Z", "author": {"login": "kirklund"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/ConnectionImpl.java", "diffHunk": "@@ -223,6 +223,16 @@ public Socket getSocket() {\n     return theSocket;\n   }\n \n+  @Override\n+  public long getBirthDate() {\n+    return 0; // TODO:KIRK", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzExMTcyMg=="}, "originalCommit": {"oid": "b2dd4579bb67e1604cb3245ea244beb8e12faa2c"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NzQ3NTg0OnYy", "diffSide": "RIGHT", "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerJUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjozODo0OFrOGJ_-yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjozODo0OFrOGJ_-yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEzODYzMw==", "bodyText": "This does not look like it is asserting the same thing about timeouts any more..", "url": "https://github.com/apache/geode/pull/4924#discussion_r413138633", "createdAt": "2020-04-22T16:38:48Z", "author": {"login": "mhansonp"}, "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerJUnitTest.java", "diffHunk": "@@ -122,278 +138,271 @@ public void tearDown() throws InterruptedException {\n \n   @Test\n   public void testAddVarianceToInterval() {\n-    assertThat(ConnectionManagerImpl.addVarianceToInterval(0)).as(\"Zero gets zero variance\")\n+    assertThat(ConnectionManagerImpl.addVarianceToInterval(0))\n+        .as(\"Zero gets zero variance\")\n         .isEqualTo(0);\n+\n     assertThat(ConnectionManagerImpl.addVarianceToInterval(300000))\n-        .as(\"Large value gets +/-10% variance\").isNotEqualTo(300000).isGreaterThanOrEqualTo(270000)\n+        .as(\"Large value gets +/-10% variance\")\n+        .isNotEqualTo(300000)\n+        .isGreaterThanOrEqualTo(270000)\n         .isLessThanOrEqualTo(330000);\n-    assertThat(ConnectionManagerImpl.addVarianceToInterval(9)).as(\"Small value gets +/-1 variance\")\n-        .isNotEqualTo(9).isGreaterThanOrEqualTo(8).isLessThanOrEqualTo(10);\n+\n+    assertThat(ConnectionManagerImpl.addVarianceToInterval(9))\n+        .as(\"Small value gets +/-1 variance\")\n+        .isNotEqualTo(9)\n+        .isGreaterThanOrEqualTo(8)\n+        .isLessThanOrEqualTo(10);\n   }\n \n   @Test\n-  public void testGet()\n-      throws InterruptedException, AllConnectionsInUseException, NoAvailableServersException {\n+  public void testGet() {\n     manager = new ConnectionManagerImpl(\"pool\", factory, endpointManager, 3, 0, -1, -1, logger,\n         60 * 1000, cancelCriterion, poolStats);\n     manager.start(background);\n \n-    Connection conn[] = new Connection[4];\n-\n-    conn[0] = manager.borrowConnection(0);\n-    Assert.assertEquals(1, factory.creates);\n-\n-    manager.returnConnection(conn[0]);\n-    conn[0] = manager.borrowConnection(0);\n-    Assert.assertEquals(1, factory.creates);\n-    conn[1] = manager.borrowConnection(0);\n-    manager.returnConnection(conn[0]);\n-    manager.returnConnection(conn[1]);\n-    Assert.assertEquals(2, factory.creates);\n-\n-    conn[0] = manager.borrowConnection(0);\n-    conn[1] = manager.borrowConnection(0);\n-    conn[2] = manager.borrowConnection(0);\n-    Assert.assertEquals(3, factory.creates);\n-\n-    try {\n-      conn[4] = manager.borrowConnection(10);\n-      fail(\"Should have received an all connections in use exception\");\n-    } catch (AllConnectionsInUseException e) {\n-      // expected exception\n-    }\n+    Connection connection1 = manager.borrowConnection(0);\n+    assertThat(factory.creates.get()).isEqualTo(1);\n+\n+    manager.returnConnection(connection1);\n+    connection1 = manager.borrowConnection(0);\n+\n+    assertThat(factory.creates.get()).isEqualTo(1);\n+\n+    Connection connection2 = manager.borrowConnection(0);\n+    manager.returnConnection(connection1);\n+    manager.returnConnection(connection2);\n+\n+    assertThat(factory.creates.get()).isEqualTo(2);\n+\n+    manager.borrowConnection(0);\n+    manager.borrowConnection(0);\n+    manager.borrowConnection(0);\n+\n+    assertThat(factory.creates.get()).isEqualTo(3);\n+\n+    Throwable thrown = catchThrowable(() -> {\n+      manager.borrowConnection(10);\n+    });\n+    assertThat(thrown).isInstanceOf(AllConnectionsInUseException.class);\n   }\n \n   @Test\n-  public void testPrefill() throws InterruptedException {\n+  public void testPrefill() {\n     manager = new ConnectionManagerImpl(\"pool\", factory, endpointManager, 10, 2, -1, -1, logger,\n         60 * 1000, cancelCriterion, poolStats);\n     manager.start(background);\n-    final String descrip = manager.toString();\n-    WaitCriterion ev = new WaitCriterion() {\n-      @Override\n-      public boolean done() {\n-        return factory.creates == 2 && factory.destroys == 0;\n-      }\n \n-      @Override\n-      public String description() {\n-        return \"waiting for manager \" + descrip;\n-      }\n-    };\n-    GeodeAwaitility.await().untilAsserted(ev);\n+    await(\"waiting for manager \" + manager).untilAsserted(() -> {\n+      assertThat(factory.creates.get()).isEqualTo(2);\n+      assertThat(factory.destroys.get()).isEqualTo(0);\n+    });\n   }\n \n   @Test\n-  public void testInvalidateConnection()\n-      throws InterruptedException, AllConnectionsInUseException, NoAvailableServersException {\n+  public void testInvalidateConnection() {\n     manager = new ConnectionManagerImpl(\"pool\", factory, endpointManager, 10, 0, 0L, -1, logger,\n         60 * 1000, cancelCriterion, poolStats);\n     manager.start(background);\n \n-    Connection conn = manager.borrowConnection(0);\n-    Assert.assertEquals(1, factory.creates);\n-    Assert.assertEquals(0, factory.destroys);\n-    conn.destroy();\n-    manager.returnConnection(conn);\n-    Assert.assertEquals(1, factory.creates);\n-    Assert.assertEquals(1, factory.destroys);\n-    conn = manager.borrowConnection(0);\n-    Assert.assertEquals(2, factory.creates);\n-    Assert.assertEquals(1, factory.destroys);\n+    Connection connection = manager.borrowConnection(0);\n+\n+    assertThat(factory.creates.get()).isEqualTo(1);\n+    assertThat(factory.destroys.get()).isEqualTo(0);\n+\n+    connection.destroy();\n+    manager.returnConnection(connection);\n+\n+    assertThat(factory.creates.get()).isEqualTo(1);\n+    assertThat(factory.destroys.get()).isEqualTo(1);\n+\n+    manager.borrowConnection(0);\n+\n+    assertThat(factory.creates.get()).isEqualTo(2);\n+    assertThat(factory.destroys.get()).isEqualTo(1);\n   }\n \n   @Test\n-  public void testInvalidateServer()\n-      throws InterruptedException, AllConnectionsInUseException, NoAvailableServersException {\n+  public void testInvalidateServer() {\n     manager = new ConnectionManagerImpl(\"pool\", factory, endpointManager, 10, 0, -1, -1, logger,\n         60 * 1000, cancelCriterion, poolStats);\n     manager.start(background);\n \n     ServerLocation server1 = new ServerLocation(\"localhost\", 1);\n     ServerLocation server2 = new ServerLocation(\"localhost\", 2);\n-    factory.nextServer = server1;\n-    Connection conn1 = manager.borrowConnection(0);\n-    Connection conn2 = manager.borrowConnection(0);\n-    Connection conn3 = manager.borrowConnection(0);\n-    factory.nextServer = server2;\n-    Connection conn4 = manager.borrowConnection(0);\n-\n-    Assert.assertEquals(4, factory.creates);\n-    Assert.assertEquals(0, factory.destroys);\n-\n-    manager.returnConnection(conn2);\n-    endpointManager.serverCrashed(conn2.getEndpoint());\n-    Assert.assertEquals(3, factory.destroys);\n-    conn1.destroy();\n-    manager.returnConnection(conn1);\n-    Assert.assertEquals(3, factory.destroys);\n-    manager.returnConnection(conn3);\n-    manager.returnConnection(conn4);\n-    Assert.assertEquals(3, factory.destroys);\n+    factory.nextServer.set(server1);\n+    Connection connection1 = manager.borrowConnection(0);\n+    Connection connection2 = manager.borrowConnection(0);\n+    Connection connection3 = manager.borrowConnection(0);\n+    factory.nextServer.set(server2);\n+    Connection connection4 = manager.borrowConnection(0);\n+\n+    assertThat(factory.creates.get()).isEqualTo(4);\n+    assertThat(factory.destroys.get()).isEqualTo(0);\n+\n+    manager.returnConnection(connection2);\n+    endpointManager.serverCrashed(connection2.getEndpoint());\n+\n+    assertThat(factory.destroys.get()).isEqualTo(3);\n+\n+    connection1.destroy();\n+    manager.returnConnection(connection1);\n+\n+    assertThat(factory.destroys.get()).isEqualTo(3);\n+\n+    manager.returnConnection(connection3);\n+    manager.returnConnection(connection4);\n+\n+    assertThat(factory.destroys.get()).isEqualTo(3);\n \n     manager.borrowConnection(0);\n-    Assert.assertEquals(4, factory.creates);\n-    Assert.assertEquals(3, factory.destroys);\n+    assertThat(factory.creates.get()).isEqualTo(4);\n+    assertThat(factory.destroys.get()).isEqualTo(3);\n   }\n \n   @Test\n-  public void testIdleExpiration()\n-      throws InterruptedException, AllConnectionsInUseException, NoAvailableServersException {\n-    final long idleTimeoutMillis = 300;\n+  public void testIdleExpiration() throws Exception {\n+    long idleTimeoutMillis = 300;\n     manager =\n         new ConnectionManagerImpl(\"pool\", factory, endpointManager, 5, 2, idleTimeoutMillis, -1,\n             logger, 60 * 1000, cancelCriterion, poolStats);\n     manager.start(background);\n \n-    {\n-      factory.waitWhile(() -> factory.creates < 2);\n-      Assert.assertEquals(2, factory.creates);\n-      Assert.assertEquals(0, factory.destroys);\n-      Assert.assertEquals(0, factory.closes);\n-      Assert.assertEquals(0, poolStats.getIdleExpire());\n-      // no need to wait; dangerous because it gives connections a chance to expire\n-      // //wait for prefill task to finish.\n-      // Thread.sleep(100);\n-    }\n+    await().untilAsserted(() -> {\n+      assertThat(factory.creates.get()).isEqualTo(2);\n+      assertThat(factory.destroys.get()).isEqualTo(0);\n+      assertThat(factory.closes.get()).isEqualTo(0);\n+      assertThat(poolStats.getIdleExpire()).isEqualTo(0);\n+    });\n+\n+    // no need to wait; dangerous because it gives connections a chance to expire\n \n-    Connection conn1 = manager.borrowConnection(500);\n-    Connection conn2 = manager.borrowConnection(500);\n-    Connection conn3 = manager.borrowConnection(500);\n-    Connection conn4 = manager.borrowConnection(500);\n-    Connection conn5 = manager.borrowConnection(500);\n+    Connection connection1 = manager.borrowConnection(500);\n+    Connection connection2 = manager.borrowConnection(500);\n+    Connection connection3 = manager.borrowConnection(500);\n+    Connection connection4 = manager.borrowConnection(500);\n+    Connection connection5 = manager.borrowConnection(500);\n \n     // wait to make sure checked out connections aren't timed out\n     Thread.sleep(idleTimeoutMillis * 2);\n-    Assert.assertEquals(5, factory.creates);\n-    Assert.assertEquals(0, factory.destroys);\n-    Assert.assertEquals(0, factory.closes);\n-    Assert.assertEquals(0, poolStats.getIdleExpire());\n-\n-    {\n-      // make sure a connection that has been passivated can idle-expire\n-      conn1.passivate(true);\n-\n-      long elapsedMillis = factory.waitWhile(() -> factory.destroys < 1);\n-      Assert.assertEquals(5, factory.creates);\n-      Assert.assertEquals(1, factory.destroys);\n-      Assert.assertEquals(1, factory.closes);\n-      Assert.assertEquals(1, poolStats.getIdleExpire());\n-      checkIdleTimeout(idleTimeoutMillis, elapsedMillis);\n-    }\n+    assertThat(factory.creates.get()).isEqualTo(5);\n+    assertThat(factory.destroys.get()).isEqualTo(0);\n+    assertThat(factory.closes.get()).isEqualTo(0);\n+    assertThat(poolStats.getIdleExpire()).isEqualTo(0);\n+\n+    // make sure a connection that has been passivated can idle-expire\n+    connection1.passivate(true);\n+\n+    long elapsedMillis = Timer.measure(() -> {\n+      await().untilAsserted(() -> {\n+        assertThat(factory.creates.get()).isEqualTo(5);\n+        assertThat(factory.destroys.get()).isEqualTo(1);\n+        assertThat(factory.closes.get()).isEqualTo(1);\n+        assertThat(poolStats.getIdleExpire()).isEqualTo(1);\n+      });\n+    });\n+    checkIdleTimeout(idleTimeoutMillis, elapsedMillis);\n \n     // now return all other connections to pool and verify that just 2 expire\n-    manager.returnConnection(conn2);\n-    manager.returnConnection(conn3);\n-    manager.returnConnection(conn4);\n-    manager.returnConnection(conn5);\n-\n-    {\n-      long elapsedMillis = factory.waitWhile(() -> factory.destroys < 3);\n-      Assert.assertEquals(5, factory.creates);\n-      Assert.assertEquals(3, factory.destroys);\n-      Assert.assertEquals(3, factory.closes);\n-      Assert.assertEquals(3, poolStats.getIdleExpire());\n-      checkIdleTimeout(idleTimeoutMillis, elapsedMillis);\n-    }\n+    manager.returnConnection(connection2);\n+    manager.returnConnection(connection3);\n+    manager.returnConnection(connection4);\n+    manager.returnConnection(connection5);\n+\n+    elapsedMillis = Timer.measure(() -> {\n+      await().untilAsserted(() -> {\n+        assertThat(factory.creates.get()).isEqualTo(5);\n+        assertThat(factory.destroys.get()).isEqualTo(3);\n+        assertThat(factory.closes.get()).isEqualTo(3);\n+        assertThat(poolStats.getIdleExpire()).isEqualTo(3);\n+      });\n+    });\n+    checkIdleTimeout(idleTimeoutMillis, elapsedMillis);\n \n     // wait to make sure min-connections don't time out\n     Thread.sleep(idleTimeoutMillis * 2);\n-    Assert.assertEquals(5, factory.creates);\n-    Assert.assertEquals(3, factory.destroys);\n-    Assert.assertEquals(3, factory.closes);\n-    Assert.assertEquals(3, poolStats.getIdleExpire());\n-  }\n-\n-  private void checkIdleTimeout(final long idleTimeoutMillis, long elapsedMillis) {\n-    Assert.assertTrue(\n-        \"Elapsed \" + elapsedMillis + \" is less than idle timeout \" + idleTimeoutMillis,\n-        elapsedMillis >= (idleTimeoutMillis - ALLOWABLE_ERROR_IN_MILLIS));\n-    Assert.assertTrue(\n-        \"Elapsed \" + elapsedMillis + \" is greater than idle timeout \" + idleTimeoutMillis,\n-        elapsedMillis <= (idleTimeoutMillis + ALLOWABLE_ERROR_IN_MILLIS));\n+    assertThat(factory.creates.get()).isEqualTo(5);\n+    assertThat(factory.destroys.get()).isEqualTo(3);\n+    assertThat(factory.closes.get()).isEqualTo(3);\n+    assertThat(poolStats.getIdleExpire()).isEqualTo(3);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd4579bb67e1604cb3245ea244beb8e12faa2c"}, "originalPosition": 453}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4271, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}