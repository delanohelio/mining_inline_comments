{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDM3MzM1", "number": 5403, "title": "GEODE-8385: hang recovering from disk with cyclic dependencies", "bodyText": "This restores the point at which we notify membership listeners of\ndepartures.  We used to do this (in 1.12 and earlier) when a ShutdownMessage\nis received instead of waiting for a new membership view announcing the departure.\nMembership views can take some time to form and install, which can cause\npersistent (disk store) views to be updated later than they used to be.\nIn the case of this ticket the disk store of one member was being\nclosed while another was shutting down.  The member closing its disk\nstore did not see the view announcing that shutdown until most of its\ndisk store regions had closed their persistence advisors.  This left the\ndisk store thinking that the other member was still up at the time it\nwas closed.\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-07-27T22:35:49Z", "url": "https://github.com/apache/geode/pull/5403", "merged": true, "mergeCommit": {"oid": "08316aa05198704d96aefc5497e483052c27a378"}, "closed": true, "closedAt": "2020-07-29T14:58:40Z", "author": {"login": "bschuchardt"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5KK2YAFqTQ1NjE4NjMzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5ds2YAFqTQ1NzA1Njg4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTg2MzMy", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-456186332", "createdAt": "2020-07-27T22:46:09Z", "commit": {"oid": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjo0NjowOVrOG32Nww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMzowOToxOVrOG32uAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxMzEyMw==", "bodyText": "comment lies now that this returns void", "url": "https://github.com/apache/geode/pull/5403#discussion_r461213123", "createdAt": "2020-07-27T22:46:09Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1784,19 +1784,15 @@ private String prettifyReason(String r) {\n   /**\n    * Returns true if id was removed. Returns false if it was not in the list of managers.\n    */\n-  private boolean removeManager(InternalDistributedMember theId, boolean crashed, String p_reason) {\n-    String reason = p_reason;\n-\n-    reason = prettifyReason(reason);\n+  private void removeManager(InternalDistributedMember theId, boolean crashed, String p_reason) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxNzc1MA==", "bodyText": "\u2713 ok to this block of code\u2014I confirmed it's the same as the old block that was under the conditional but no conditional is needed now that removeManager() returns void (and it used to always return true) \u2713", "url": "https://github.com/apache/geode/pull/5403#discussion_r461217750", "createdAt": "2020-07-27T22:59:04Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1862,54 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n+    if (!fromViewChange) {\n+      if (!isCurrentMember(theId)) {\n+        // this is notification from a shutdown message received from a member that is no longer\n+        // part of the cluster\n+        return;\n       }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n+      // else this is from a shutdown message so continue & notify listeners\n+    } else {\n+      if (!memberCrashed) {\n+        // member left the view normally - we've already received a shutdown message and notified\n+        // listeners, so there's nothing more to do here\n+        return;\n       }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    }\n \n-      executors.handleManagerDeparture(theId);\n+    removeManager(theId, memberCrashed, reason);\n+    if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n+      stats.incNodes(-1);\n+    }\n+    String msg;\n+    if (memberCrashed && !shouldInhibitMembershipWarnings()) {\n+      msg =\n+          \"Member at {} unexpectedly left the distributed cache: {}\";\n+      addMemberEvent(new MemberCrashedEvent(theId, reason));\n+    } else {\n+      msg =\n+          \"Member at {} gracefully left the distributed cache: {}\";\n+      addMemberEvent(new MemberDepartedEvent(theId, reason));\n     }\n+    logger.info(msg, new Object[] {theId, prettifyReason(reason)});\n+\n+    executors.handleManagerDeparture(theId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxODc1Mg==", "bodyText": "why did this statement move? should it be in a finally block?", "url": "https://github.com/apache/geode/pull/5403#discussion_r461218752", "createdAt": "2020-07-27T23:01:52Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2366,10 +2375,10 @@ public void memberDeparted(InternalDistributedMember theId, boolean crashed, Str\n           message.setReason(reason); // added for #37950\n           handleIncomingDMsg(message);\n         }\n-        dm.handleManagerDeparture(theId, crashed, reason);\n       } catch (DistributedSystemDisconnectedException se) {\n         // let's not get huffy about it\n       }\n+      dm.handleManagerDeparture(theId, crashed, reason, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMTM3OA==", "bodyText": "Why did the name change to \"GMSMember\" here? It was \"MemberData\" which kinda made sense because GMSMemberData isa MemberData. I could see leaving it alone or maybe making it GMSMemberData.", "url": "https://github.com/apache/geode/pull/5403#discussion_r461221378", "createdAt": "2020-07-27T23:09:19Z", "author": {"login": "Bill"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMemberData.java", "diffHunk": "@@ -399,11 +399,11 @@ public int hashCode() {\n   public String toString() {\n     StringBuilder sb = new StringBuilder(100);\n \n-    sb.append(\"MemberData[\");\n+    sb.append(\"GMSMember[\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80d2b15aa7d0ab75aaef0ac308eecd1ea476e4d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzQ2MTkx", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-456746191", "createdAt": "2020-07-28T15:22:08Z", "commit": {"oid": "9a2d355b763a9a7c50388c20010801bbf3fc0c49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNToyMjowOFrOG4R9vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNToyMjowOFrOG4R9vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2Nzc3Mg==", "bodyText": "nice", "url": "https://github.com/apache/geode/pull/5403#discussion_r461667772", "createdAt": "2020-07-28T15:22:08Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1848,45 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a2d355b763a9a7c50388c20010801bbf3fc0c49"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzQ2OTg4", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-456746988", "createdAt": "2020-07-28T15:22:59Z", "commit": {"oid": "9a2d355b763a9a7c50388c20010801bbf3fc0c49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNToyMjo1OVrOG4SAEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNToyMjo1OVrOG4SAEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2ODM2OQ==", "bodyText": "\u2713 inlined removeManager()", "url": "https://github.com/apache/geode/pull/5403#discussion_r461668369", "createdAt": "2020-07-28T15:22:59Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,41 +1848,45 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason, false);\n   }\n \n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n-\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n-      }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n-      }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\"DistributionManager: removing member <{}>; crashed {}; reason = {}\", theId,\n+          memberCrashed, prettifyReason(reason));\n+    }\n+    removeHostedLocators(theId);\n+    redundancyZones.remove(theId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a2d355b763a9a7c50388c20010801bbf3fc0c49"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzQ5Nzkx", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-456749791", "createdAt": "2020-07-28T15:25:58Z", "commit": {"oid": "9a2d355b763a9a7c50388c20010801bbf3fc0c49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02d830d89d212274e536cdea39c11ae7b16449ed", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/02d830d89d212274e536cdea39c11ae7b16449ed", "committedDate": "2020-07-28T16:53:50Z", "message": "GEODE-8385: hang recovering from disk with cyclic dependencies\n\nThis restores the point at which we notify membership listeners of\ndepartures.  We used to do this (in 1.12 and earlier) when a ShutdownMessage\nis received instead of waiting for a new membership view announcing the departure.\nMembership views can take some time to form and install, which can cause\npersistent (disk store) views to be updated later than they used to be.\n\nIn the case of this ticket the disk store of one member was being\nclosed while another was shutting down.  The member closing its disk\nstore did not see the view announcing that shutdown until most of its\ndisk store regions had closed their persistence advisors.  This left the\ndisk store thinking that the other member was still up at the time it\nwas closed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83e9fb16fa9b842e8c34108bcd3b9a9e58962c58", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/83e9fb16fa9b842e8c34108bcd3b9a9e58962c58", "committedDate": "2020-07-28T16:53:50Z", "message": "fixing things Bill found & removing duplicate processing checks\n\nlisteners are able to cope with duplicate memberDeparted notifications\nand the old code allowed that to happen.  It would be bad if we\nmissed notifying listeners should we get a view change but no\nshutdown message (which is not an ack-ed message)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/c1b04ff3688d14ce69d65220c03c9541cdefedd6", "committedDate": "2020-07-28T16:53:50Z", "message": "cleanup & protect stats from duplicate memberDeparted notification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdef144a2f51ac99ac76586048368cbeda050990", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/fdef144a2f51ac99ac76586048368cbeda050990", "committedDate": "2020-07-28T15:26:18Z", "message": "cleanup & protect stats from duplicate memberDeparted notification"}, "afterCommit": {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/c1b04ff3688d14ce69d65220c03c9541cdefedd6", "committedDate": "2020-07-28T16:53:50Z", "message": "cleanup & protect stats from duplicate memberDeparted notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTAxODI4", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-456901828", "createdAt": "2020-07-28T18:32:43Z", "commit": {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODozMjo0M1rOG4ZVsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODozODo0M1rOG4ZjPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4ODU5Mw==", "bodyText": "Why this is not handleManagerDeparture(theId, false, reason, true)? handleManagerDeparture(theId, false, reason) will not update the stats in line 1887.", "url": "https://github.com/apache/geode/pull/5403#discussion_r461788593", "createdAt": "2020-07-28T18:32:43Z", "author": {"login": "jchen21"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,39 +1848,56 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjA2Mw==", "bodyText": "Would it better to move the logger.info out of the if statement? So regardless the value of fromViewChange, it logs the member departure. It will be helpful when analyzing the logs.", "url": "https://github.com/apache/geode/pull/5403#discussion_r461792063", "createdAt": "2020-07-28T18:38:43Z", "author": {"login": "jchen21"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -1866,39 +1848,56 @@ public void handleConsoleShutdown(InternalDistributedMember theId, boolean crash\n   void shutdownMessageReceived(InternalDistributedMember theId, String reason) {\n     removeHostedLocators(theId);\n     distribution.shutdownMessageReceived(theId, reason);\n+    handleManagerDeparture(theId, false, reason);\n   }\n \n+  /*\n+   * handleManagerDeparted may be invoked multiple times for a member identifier.\n+   * We allow this and inform listeners on each invocation, but only perform some\n+   * actions (such as decrementing the node count) if the change came from a\n+   * membership view.\n+   */\n   @Override\n-  public void handleManagerDeparture(InternalDistributedMember theId, boolean p_crashed,\n-      String p_reason) {\n+  public void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason) {\n+    handleManagerDeparture(theId, memberCrashed, reason, false);\n+  }\n \n+  private void handleManagerDeparture(InternalDistributedMember theId, boolean memberCrashed,\n+      String reason, boolean fromViewChange) {\n     alertingService.removeAlertListener(theId);\n \n+    removeUnfinishedStartup(theId, true);\n+\n     int vmType = theId.getVmKind();\n     if (vmType == ADMIN_ONLY_DM_TYPE) {\n-      removeUnfinishedStartup(theId, true);\n-      handleConsoleShutdown(theId, p_crashed, p_reason);\n+      handleConsoleShutdown(theId, memberCrashed, reason);\n       return;\n     }\n \n-    removeUnfinishedStartup(theId, true);\n-\n-    if (removeManager(theId, p_crashed, p_reason)) {\n-      if (theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n-        stats.incNodes(-1);\n-      }\n-      String msg;\n-      if (p_crashed && !shouldInhibitMembershipWarnings()) {\n-        msg =\n-            \"Member at {} unexpectedly left the distributed cache: {}\";\n-        addMemberEvent(new MemberCrashedEvent(theId, p_reason));\n-      } else {\n-        msg =\n-            \"Member at {} gracefully left the distributed cache: {}\";\n-        addMemberEvent(new MemberDepartedEvent(theId, p_reason));\n-      }\n-      logger.info(msg, new Object[] {theId, prettifyReason(p_reason)});\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\n+          \"DistributionManager: removing member <{}>; crashed {}; reason = {} fromView = {}\", theId,\n+          memberCrashed, prettifyReason(reason), fromViewChange);\n+    }\n+    removeHostedLocators(theId);\n+    redundancyZones.remove(theId);\n \n+    if (fromViewChange && theId.getVmKind() != ClusterDistributionManager.LOCATOR_DM_TYPE) {\n+      stats.incNodes(-1);\n+    }\n+    String msg;\n+    if (memberCrashed && !shouldInhibitMembershipWarnings()) {\n+      msg =\n+          \"Member at {} unexpectedly left the distributed cache: {}\";\n+      addMemberEvent(new MemberCrashedEvent(theId, reason));\n+    } else {\n+      msg =\n+          \"Member at {} gracefully left the distributed cache: {}\";\n+      addMemberEvent(new MemberDepartedEvent(theId, reason));\n+    }\n+    if (fromViewChange) {\n+      logger.info(msg, new Object[] {theId, prettifyReason(reason)});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b04ff3688d14ce69d65220c03c9541cdefedd6"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e63d7ab5e0ec8ea399b73afd873f0c3b4866433a", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/e63d7ab5e0ec8ea399b73afd873f0c3b4866433a", "committedDate": "2020-07-28T21:02:45Z", "message": "simplified handleManagerDeparture & removed duplicate notifications\n\nFollowing Jianxia's advice and simplifying things.  Node counts\nwill now be decremented when we receive a shutdown message.  If\nwe don't get a shutdown message it will be decremented when the\nview changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDU2ODgx", "url": "https://github.com/apache/geode/pull/5403#pullrequestreview-457056881", "createdAt": "2020-07-28T21:55:50Z", "commit": {"oid": "e63d7ab5e0ec8ea399b73afd873f0c3b4866433a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMTo1NTo1MVrOG4gpYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMTo1NTo1MVrOG4gpYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwODMyMA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/geode/pull/5403#discussion_r461908320", "createdAt": "2020-07-28T21:55:51Z", "author": {"login": "jchen21"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMembership.java", "diffHunk": "@@ -688,7 +688,11 @@ private void removeWithViewLock(ID dm, boolean crashed, String reason) {\n       return; // Explicit deletion, no upcall.\n     }\n \n-    listener.memberDeparted(dm, crashed, reason);\n+    if (!shutdownMembers.containsKey(dm)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63d7ab5e0ec8ea399b73afd873f0c3b4866433a"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4240, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}