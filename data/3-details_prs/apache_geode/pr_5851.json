{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODYzMjE4", "number": 5851, "title": "GEODE-8790: Evicted entries sometimes remain in region map", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-12-14T23:23:03Z", "url": "https://github.com/apache/geode/pull/5851", "merged": true, "mergeCommit": {"oid": "2049768ba20aa44a587612f0d328eeaf6e9b1ad8"}, "closed": true, "closedAt": "2021-01-08T02:33:16Z", "author": {"login": "luissson"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmPMrhgBqjQxMTE5NzUwNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt9HBDABqjQxODIyMzcwMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "058bbcca8a82b4396c3bee5687267f8c866d39f1", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/058bbcca8a82b4396c3bee5687267f8c866d39f1", "committedDate": "2020-12-14T23:21:26Z", "message": "spotless fix"}, "afterCommit": {"oid": "a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "committedDate": "2020-12-15T00:28:33Z", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/a8d2bb01dc27d6ffcadc9556697594ef522f0aff", "committedDate": "2020-12-15T00:28:33Z", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region"}, "afterCommit": {"oid": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "committedDate": "2020-12-15T00:29:57Z", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDUxMzAx", "url": "https://github.com/apache/geode/pull/5851#pullrequestreview-563051301", "createdAt": "2021-01-06T21:35:08Z", "commit": {"oid": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMTozNTowOFrOIPWwRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMTozNTowOFrOIPWwRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MjM1Nw==", "bodyText": "I think it would be better to change it so the only the we don't do if we are evicting is handleEntryNotFound(). When evicting we do not want an exception if the entry is already gone.\nSo I would change line 369 to just be an \"else\" and then put a \"if (!isEviction)\" on handleEntryNotFound (even better might be to change handleEntryNotFound to test isEviction and return since this is the only place it is called).\nThen you can get rid of your new code on 375 and 376.\nI do think it is probably correct to call removeEntryOrLeaveTombstone for an eviction just to make sure it follows the normal rules of scheduling a tombstone when concurrency checks are enabled. This method is already a noop if evicting without concurrency checks.", "url": "https://github.com/apache/geode/pull/5851#discussion_r552972357", "createdAt": "2021-01-06T21:35:08Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java", "diffHunk": "@@ -372,6 +372,8 @@ private void retryRemoveWithTombstone() {\n           } finally {\n             removeEntryOrLeaveTombstone();\n           }\n+        } else if (regionEntry == null && !newRegionEntry.isTombstone()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/2fc8e59c3ddcde2dc7714af412b86e7fe0f406e9", "committedDate": "2020-12-15T00:29:57Z", "message": "Adds branch in retryRemoveWithTombstone that removes entries (non-tombstone) that are absent from the region"}, "afterCommit": {"oid": "7157fff8397511f19a808eff45d3718b7393c55a", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/7157fff8397511f19a808eff45d3718b7393c55a", "committedDate": "2021-01-07T00:33:01Z", "message": "refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7157fff8397511f19a808eff45d3718b7393c55a", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/7157fff8397511f19a808eff45d3718b7393c55a", "committedDate": "2021-01-07T00:33:01Z", "message": "refactor"}, "afterCommit": {"oid": "10b60d190d0372bc86fcbd23ca7cc79b71d86757", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/10b60d190d0372bc86fcbd23ca7cc79b71d86757", "committedDate": "2021-01-07T01:08:02Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNjk4ODE1", "url": "https://github.com/apache/geode/pull/5851#pullrequestreview-563698815", "createdAt": "2021-01-07T17:53:48Z", "commit": {"oid": "10b60d190d0372bc86fcbd23ca7cc79b71d86757"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxNzo1Mzo0OFrOIP2O5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxNzo1Mzo0OFrOIP2O5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ4ODEwMA==", "bodyText": "This is just a code style thing but add curlys around the return statement.", "url": "https://github.com/apache/geode/pull/5851#discussion_r553488100", "createdAt": "2021-01-07T17:53:48Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/map/RegionMapDestroy.java", "diffHunk": "@@ -528,6 +528,9 @@ private void handleEntryNotFound() {\n     boolean throwException = false;\n     EntryNotFoundException entryNotFoundException = null;\n \n+    if(isEviction)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b60d190d0372bc86fcbd23ca7cc79b71d86757"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10b60d190d0372bc86fcbd23ca7cc79b71d86757", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/10b60d190d0372bc86fcbd23ca7cc79b71d86757", "committedDate": "2021-01-07T01:08:02Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}, "afterCommit": {"oid": "8f8071838fadfc957b2f5324cc962995790670be", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/8f8071838fadfc957b2f5324cc962995790670be", "committedDate": "2021-01-07T18:22:50Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f8071838fadfc957b2f5324cc962995790670be", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/8f8071838fadfc957b2f5324cc962995790670be", "committedDate": "2021-01-07T18:22:50Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}, "afterCommit": {"oid": "ba855bfb27b631659361159438bdb9eedb672ae6", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/ba855bfb27b631659361159438bdb9eedb672ae6", "committedDate": "2021-01-07T19:59:24Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba855bfb27b631659361159438bdb9eedb672ae6", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/ba855bfb27b631659361159438bdb9eedb672ae6", "committedDate": "2021-01-07T19:59:24Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}, "afterCommit": {"oid": "79854e7014d5b6bf5bca7e1a3e0ac64960096266", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/79854e7014d5b6bf5bca7e1a3e0ac64960096266", "committedDate": "2021-01-07T21:02:48Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzODY2OTE4", "url": "https://github.com/apache/geode/pull/5851#pullrequestreview-563866918", "createdAt": "2021-01-07T22:15:06Z", "commit": {"oid": "79854e7014d5b6bf5bca7e1a3e0ac64960096266"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "committedDate": "2021-01-07T23:49:38Z", "message": "GEODE-8790: Evicted entries sometimes remain in region map (#5851)\n\n- Modifies regionMapDestroy.retryRemoveWithTombstone to handle case where an evicted entry was left in the region map when concurrency checks is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79854e7014d5b6bf5bca7e1a3e0ac64960096266", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/79854e7014d5b6bf5bca7e1a3e0ac64960096266", "committedDate": "2021-01-07T21:02:48Z", "message": "Modifies regionMapDestroy.retryRemoveWithTombstone and regionMapDestroy.handleEntryNotFound to handle evictions without leaving entries in the region map"}, "afterCommit": {"oid": "83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "author": {"user": {"login": "luissson", "name": "Louis Jacome"}}, "url": "https://github.com/apache/geode/commit/83b7116a98f4d0f1d579dd00087490a4a2a37a1e", "committedDate": "2021-01-07T23:49:38Z", "message": "GEODE-8790: Evicted entries sometimes remain in region map (#5851)\n\n- Modifies regionMapDestroy.retryRemoveWithTombstone to handle case where an evicted entry was left in the region map when concurrency checks is enabled"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4301, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}