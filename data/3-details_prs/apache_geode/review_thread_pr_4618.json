{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDE3NDg1", "number": 4618, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzo1MToxNlrODaQlHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMDo0NToyOFrODaW1Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODYxMjE0OnYy", "diffSide": "RIGHT", "path": "geode-core/src/test/java/org/apache/geode/cache/client/internal/PutOpJUnitTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzo1MToxNlrOFhHOcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMToxMjo1M1rOFhRjdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2NTcxNQ==", "bodyText": "I think this method can be entirely removed now that there is an event field in the test, and calls to it can be replaced with usages of the field.", "url": "https://github.com/apache/geode/pull/4618#discussion_r370265715", "createdAt": "2020-01-23T17:51:16Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/test/java/org/apache/geode/cache/client/internal/PutOpJUnitTest.java", "diffHunk": "@@ -16,19 +16,38 @@\n \n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n+import org.junit.Before;\n import org.junit.Test;\n-import org.mockito.Mockito;\n \n import org.apache.geode.cache.Operation;\n import org.apache.geode.internal.cache.EntryEventImpl;\n import org.apache.geode.internal.cache.EventID;\n+import org.apache.geode.internal.cache.RegionEntry;\n+import org.apache.geode.internal.cache.versions.VersionStamp;\n+import org.apache.geode.internal.cache.versions.VersionTag;\n \n public class PutOpJUnitTest {\n+  private final EntryEventImpl event = mock(EntryEventImpl.class);\n+  private final VersionTag versionTag = mock(VersionTag.class);\n+  private final RegionEntry entry = mock(RegionEntry.class);\n+  private final VersionStamp versionStamp = mock(VersionStamp.class);\n+  private final Connection connection = mock(Connection.class);\n+\n+  @Before\n+  public void setup() {\n+    when(event.getEventId()).thenReturn(new EventID());\n+    when(entry.getVersionStamp()).thenReturn(versionStamp);\n+  }\n \n   private EntryEventImpl getEntryEvent() {\n-    EntryEventImpl entryEvent = Mockito.mock(EntryEventImpl.class);\n-    Mockito.when(entryEvent.getEventId()).thenReturn(new EventID());\n+    EntryEventImpl entryEvent = mock(EntryEventImpl.class);\n+    when(entryEvent.getEventId()).thenReturn(new EventID());\n     return entryEvent;\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f60172ddcb427af471a062a560631e9110b6069"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzNDkzNA==", "bodyText": "Done", "url": "https://github.com/apache/geode/pull/4618#discussion_r370434934", "createdAt": "2020-01-24T01:12:53Z", "author": {"login": "pivotal-eshu"}, "path": "geode-core/src/test/java/org/apache/geode/cache/client/internal/PutOpJUnitTest.java", "diffHunk": "@@ -16,19 +16,38 @@\n \n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n+import org.junit.Before;\n import org.junit.Test;\n-import org.mockito.Mockito;\n \n import org.apache.geode.cache.Operation;\n import org.apache.geode.internal.cache.EntryEventImpl;\n import org.apache.geode.internal.cache.EventID;\n+import org.apache.geode.internal.cache.RegionEntry;\n+import org.apache.geode.internal.cache.versions.VersionStamp;\n+import org.apache.geode.internal.cache.versions.VersionTag;\n \n public class PutOpJUnitTest {\n+  private final EntryEventImpl event = mock(EntryEventImpl.class);\n+  private final VersionTag versionTag = mock(VersionTag.class);\n+  private final RegionEntry entry = mock(RegionEntry.class);\n+  private final VersionStamp versionStamp = mock(VersionStamp.class);\n+  private final Connection connection = mock(Connection.class);\n+\n+  @Before\n+  public void setup() {\n+    when(event.getEventId()).thenReturn(new EventID());\n+    when(entry.getVersionStamp()).thenReturn(versionStamp);\n+  }\n \n   private EntryEventImpl getEntryEvent() {\n-    EntryEventImpl entryEvent = Mockito.mock(EntryEventImpl.class);\n-    Mockito.when(entryEvent.getEventId()).thenReturn(new EventID());\n+    EntryEventImpl entryEvent = mock(EntryEventImpl.class);\n+    when(entryEvent.getEventId()).thenReturn(new EventID());\n     return entryEvent;\n   }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2NTcxNQ=="}, "originalCommit": {"oid": "0f60172ddcb427af471a062a560631e9110b6069"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4OTYzNjU5OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/PutOp.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMDo0NToyOFrOFhRKiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMDo1NDozNVrOFhRTKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyODU1Mw==", "bodyText": "It should be \">\" not \"!=\", in the case of \"<\", you should not call the get.", "url": "https://github.com/apache/geode/pull/4618#discussion_r370428553", "createdAt": "2020-01-24T00:45:28Z", "author": {"login": "gesterzhou"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/PutOp.java", "diffHunk": "@@ -299,13 +300,39 @@ protected Object processResponse(Message msg, Connection con) throws Exception {\n           VersionTag tag = (VersionTag) msg.getPart(partIdx).getObject();\n           // we use the client's ID since we apparently don't track the server's ID in connections\n           tag.replaceNullIDs((InternalDistributedMember) con.getEndpoint().getMemberId());\n-          event.setVersionTag(tag);\n+          checkForDeltaConflictAndSetVersionTag(tag, con);\n         }\n         return oldValue;\n       }\n       return null;\n     }\n \n+    void checkForDeltaConflictAndSetVersionTag(VersionTag versionTag, Connection connection)\n+        throws Exception {\n+      RegionEntry regionEntry = ((EntryEventImpl) event).getRegionEntry();\n+      if (regionEntry == null) {\n+        event.setVersionTag(versionTag);\n+        return;\n+      }\n+      VersionStamp versionStamp = regionEntry.getVersionStamp();\n+      if (deltaSent && versionTag.getEntryVersion() != versionStamp.getEntryVersion() + 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f60172ddcb427af471a062a560631e9110b6069"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzMDc2MA==", "bodyText": "I am not sure if client delta put will generate region version less than current local cache version. However, use \">\" might be more clear in this case.", "url": "https://github.com/apache/geode/pull/4618#discussion_r370430760", "createdAt": "2020-01-24T00:54:35Z", "author": {"login": "pivotal-eshu"}, "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/PutOp.java", "diffHunk": "@@ -299,13 +300,39 @@ protected Object processResponse(Message msg, Connection con) throws Exception {\n           VersionTag tag = (VersionTag) msg.getPart(partIdx).getObject();\n           // we use the client's ID since we apparently don't track the server's ID in connections\n           tag.replaceNullIDs((InternalDistributedMember) con.getEndpoint().getMemberId());\n-          event.setVersionTag(tag);\n+          checkForDeltaConflictAndSetVersionTag(tag, con);\n         }\n         return oldValue;\n       }\n       return null;\n     }\n \n+    void checkForDeltaConflictAndSetVersionTag(VersionTag versionTag, Connection connection)\n+        throws Exception {\n+      RegionEntry regionEntry = ((EntryEventImpl) event).getRegionEntry();\n+      if (regionEntry == null) {\n+        event.setVersionTag(versionTag);\n+        return;\n+      }\n+      VersionStamp versionStamp = regionEntry.getVersionStamp();\n+      if (deltaSent && versionTag.getEntryVersion() != versionStamp.getEntryVersion() + 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQyODU1Mw=="}, "originalCommit": {"oid": "0f60172ddcb427af471a062a560631e9110b6069"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3854, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}