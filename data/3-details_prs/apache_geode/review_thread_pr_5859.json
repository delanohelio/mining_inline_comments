{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDk3MzE1", "number": 5859, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNjozOTozM1rOFGzGsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMjowNToxMVrOFN5dZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyNjczMDc0OnYy", "diffSide": "LEFT", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNjozOTozM1rOIH-aFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxODozMjozM1rOIP3dWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMzQyOQ==", "bodyText": "How about putting the lruEntryUpdate(oldRe) and lruEntryCreate(oldRe)calls inside the else for the case in which the value for the new entry is not a tombstone as follows:\n...      \n                  } else { //newValue != Token.TOMBSTONE\n                    int newSize = owner.calculateRegionEntryValueSize(oldRe);\n                    if (!oldIsTombstone) {\n                      lruEntryUpdate(oldRe);\n                      owner.updateSizeOnPut(key, oldSize, newSize);\n                    } else {\n                      lruEntryCreate(oldRe);\n                      owner.updateSizeOnCreate(key, newSize);\n                    }\n...", "url": "https://github.com/apache/geode/pull/5859#discussion_r545233429", "createdAt": "2020-12-17T16:39:33Z", "author": {"login": "albertogpz"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,11 +838,11 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5Nzg5Nw==", "bodyText": "Thanks for taking a look at these changes. I mainly put this PR up to see if it would pass the unit tests. This was the change that I was concerned about. Event though the tests passed, I'm still not sure its a valid change. I have a request to another team to take a look at these changes before I proceed.", "url": "https://github.com/apache/geode/pull/5859#discussion_r545297897", "createdAt": "2020-12-17T18:11:01Z", "author": {"login": "boglesby"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,11 +838,11 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMzQyOQ=="}, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUwMDczOQ==", "bodyText": "I agree with Alberto. I don't see any reason to do call lruEntryUpdate/lruEntryCreate if the next thing we are going to do is call lruEntryDestroy. But it does seem like this code should make sure to call one of lruEntry(Create/Update/Destroy). So I would change it to be:\n                if (result) {\n                  if (oldIsTombstone) {\n                    owner.unscheduleTombstone(oldRe);\n                  }\n                  if (newValue == Token.TOMBSTONE) {\n                    if (!oldIsDestroyedOrRemoved) {\n                      owner.updateSizeOnRemove(key, oldSize);\n                    }\n                    owner.scheduleTombstone(oldRe, entryVersion);\n                    lruEntryDestroy(oldRe);\n                  } else {\n                    int newSize = owner.calculateRegionEntryValueSize(oldRe);\n                    if (!oldIsTombstone) {\n                      owner.updateSizeOnPut(key, oldSize, newSize);\n                      lruEntryUpdate(oldRe);\n                    } else {\n                      owner.updateSizeOnCreate(key, newSize);\n                      lruEntryCreate(oldRe);\n                    }\n                    EntryLogger.logInitialImagePut(_getOwnerObject(), key, newValue);\n                  }\n                }", "url": "https://github.com/apache/geode/pull/5859#discussion_r553500739", "createdAt": "2021-01-07T18:17:41Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,11 +838,11 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMzQyOQ=="}, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUwODE4NQ==", "bodyText": "Great. Thanks a lot @dschneider-pivotal. I'll make the changes you suggest.", "url": "https://github.com/apache/geode/pull/5859#discussion_r553508185", "createdAt": "2021-01-07T18:32:33Z", "author": {"login": "boglesby"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,11 +838,11 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzMzQyOQ=="}, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyNjczNzA3OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/LocalRegion.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNjo0MDo0MlrOIH-dtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODoxMTo0OFrOIICYBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzNDM1OQ==", "bodyText": "I would put this change in a different PR/JIRA as it is about a different bug.", "url": "https://github.com/apache/geode/pull/5859#discussion_r545234359", "createdAt": "2020-12-17T16:40:42Z", "author": {"login": "albertogpz"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/LocalRegion.java", "diffHunk": "@@ -10219,6 +10219,7 @@ public void initializeStats(long numEntriesInVM, long numOverflowOnDisk,\n       long numOverflowBytesOnDisk) {\n     getDiskRegion().getStats().incNumEntriesInVM(numEntriesInVM);\n     getDiskRegion().getStats().incNumOverflowOnDisk(numOverflowOnDisk);\n+    getDiskRegion().getStats().incNumOverflowBytesOnDisk(numOverflowBytesOnDisk);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI5ODQzNg==", "bodyText": "Thanks for the comment. I'll definitely move this change to the correct JIRA.", "url": "https://github.com/apache/geode/pull/5859#discussion_r545298436", "createdAt": "2020-12-17T18:11:48Z", "author": {"login": "boglesby"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/LocalRegion.java", "diffHunk": "@@ -10219,6 +10219,7 @@ public void initializeStats(long numEntriesInVM, long numOverflowOnDisk,\n       long numOverflowBytesOnDisk) {\n     getDiskRegion().getStats().incNumEntriesInVM(numEntriesInVM);\n     getDiskRegion().getStats().incNumOverflowOnDisk(numOverflowOnDisk);\n+    getDiskRegion().getStats().incNumOverflowBytesOnDisk(numOverflowBytesOnDisk);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzNDM1OQ=="}, "originalCommit": {"oid": "0b8df1158cd916b2217bc800881ae2f49fe74241"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMTE3MjIzOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMjowNToxMVrOISXPLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo0MDoxMFrOIS63Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEyNTk5OA==", "bodyText": "One question I have here is, when newValue == Token.TOMBSTONE and oldIsTombstone == true, it used to have lruEntryUpdate(oldRe), which is in the deleted line 844. Now, after the code change, it is not having lruEntryUpdate(oldRe), when newValue == Token.TOMBSTONE and oldIsTombstone == true. Is this expected?", "url": "https://github.com/apache/geode/pull/5859#discussion_r556125998", "createdAt": "2021-01-12T22:05:11Z", "author": {"login": "jchen21"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,24 +838,23 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {\n-                      lruEntryCreate(oldRe);\n-                    } else {\n-                      lruEntryUpdate(oldRe);\n-                    }\n                   }\n                   if (newValue == Token.TOMBSTONE) {\n                     if (!oldIsDestroyedOrRemoved) {\n                       owner.updateSizeOnRemove(key, oldSize);\n                     }\n                     owner.scheduleTombstone(oldRe, entryVersion);\n-                    lruEntryDestroy(oldRe);\n+                    if (!oldIsTombstone) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e2ab245c057844100e1ae827c78a485b65dbc"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcwOTY4Mw==", "bodyText": "Yes. That was part of the problem. The code used to do this (abbreviated):\nif (oldIsTombstone) {\n  if (newValue != Token.TOMBSTONE) {\n    lruEntryCreate(oldRe);\n  } else {\n    lruEntryUpdate(oldRe);\n  }\n}\nif (newValue == Token.TOMBSTONE) {\n  lruEntryDestroy(oldRe);\n}\n\nSo if oldIsTombstone and newValue == Token.TOMBSTONE, both lruEntryUpdate and lruEntryDestroy were called.\nAnd, lruEntryCreate \\ lruEntryUpdate were not called at all when newValue != Token.TOMBSTONE.", "url": "https://github.com/apache/geode/pull/5859#discussion_r556709683", "createdAt": "2021-01-13T17:40:10Z", "author": {"login": "boglesby"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/AbstractRegionMap.java", "diffHunk": "@@ -838,24 +838,23 @@ public boolean initialImagePut(final Object key, final long lastModified, Object\n                 if (result) {\n                   if (oldIsTombstone) {\n                     owner.unscheduleTombstone(oldRe);\n-                    if (newValue != Token.TOMBSTONE) {\n-                      lruEntryCreate(oldRe);\n-                    } else {\n-                      lruEntryUpdate(oldRe);\n-                    }\n                   }\n                   if (newValue == Token.TOMBSTONE) {\n                     if (!oldIsDestroyedOrRemoved) {\n                       owner.updateSizeOnRemove(key, oldSize);\n                     }\n                     owner.scheduleTombstone(oldRe, entryVersion);\n-                    lruEntryDestroy(oldRe);\n+                    if (!oldIsTombstone) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEyNTk5OA=="}, "originalCommit": {"oid": "7c3e2ab245c057844100e1ae827c78a485b65dbc"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4858, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}