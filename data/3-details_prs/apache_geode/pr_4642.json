{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTkyNTc5", "number": 4642, "title": "GEODE-7600-4: Further cleanup", "bodyText": "Cleaning the teardown approach\nchange to wait for event history to be correct.\ngetting rid of a timing issue", "createdAt": "2020-01-28T19:40:24Z", "url": "https://github.com/apache/geode/pull/4642", "merged": true, "mergeCommit": {"oid": "11048af21c6e71575af405d23403737a304b8d8d"}, "closed": true, "closedAt": "2020-01-29T21:29:01Z", "author": {"login": "mhansonp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-2nbBAH2gAyMzY4MTkyNTc5OjMyYTM3MjdjODhlNzBlMjA3MGZjNDcxN2JjNzNlMTZiZjM3MDY3MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_MwRugFqTM1MDQzMzg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32a3727c88e70e2070fc4717bc73e16bf3706711", "author": {"user": {"login": "mhansonp", "name": null}}, "url": "https://github.com/apache/geode/commit/32a3727c88e70e2070fc4717bc73e16bf3706711", "committedDate": "2020-01-28T19:36:10Z", "message": "GEODE-7600-4: Further cleanup\nCleaning the teardown approach\nchange to wait for event history to be correct.\ngetting rid of a timing issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4", "author": {"user": {"login": "mhansonp", "name": null}}, "url": "https://github.com/apache/geode/commit/5944f6c0eedbe76c4839737e11036c51c2e78da4", "committedDate": "2020-01-28T19:49:29Z", "message": "Getting rid of a debug change."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzIyNjk2", "url": "https://github.com/apache/geode/pull/4642#pullrequestreview-349722696", "createdAt": "2020-01-28T21:39:22Z", "commit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTozOToyMlrOFi1hqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTozOToyMlrOFi1hqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3Mjg3Mw==", "bodyText": "Part of this fix was to cleanout the teardown code so it would run correctly.", "url": "https://github.com/apache/geode/pull/4642#discussion_r372072873", "createdAt": "2020-01-28T21:39:22Z", "author": {"login": "mhansonp"}, "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/ConnectionPoolDUnitTest.java", "diffHunk": "@@ -120,24 +119,14 @@ public void setup() {\n \n   @After\n   public void tearDown() {\n-    getSystem();\n-    Invoke.invokeInEveryVM(\"getSystem\", new SerializableRunnable() {\n-      @Override\n-      public void run() {\n-        getSystem();\n-      }\n-    });\n-  }\n-\n-  @Override\n-  public final void postTearDownCacheTestCase() {\n     Invoke.invokeInEveryVM(() -> {\n-      Map<String, Pool> pools = PoolManager.getAll();\n-      assertThat(pools).describedAs(\"found pools remaining after teardown: \" + pools).isEmpty();\n+      if (basicGetCache() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzIzMjY3", "url": "https://github.com/apache/geode/pull/4642#pullrequestreview-349723267", "createdAt": "2020-01-28T21:40:27Z", "commit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo0MDoyOFrOFi1jVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo0MDoyOFrOFi1jVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3MzMwMw==", "bodyText": "This is important to wait so that the server has all the keys so that we don't get invalidates in addition to the Local_Load_Creates", "url": "https://github.com/apache/geode/pull/4642#discussion_r372073303", "createdAt": "2020-01-28T21:40:28Z", "author": {"login": "mhansonp"}, "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/ConnectionPoolDUnitTest.java", "diffHunk": "@@ -1298,75 +1311,70 @@ public void run2() throws CacheException {\n       CertifiableTestCacheListener<Object, Object> ctl =\n           (CertifiableTestCacheListener<Object, Object>) region.getAttributes()\n               .getCacheListeners()[0];\n+\n       for (int i = 0; i < 10; i++) {\n         Object key = i;\n         ctl.waitForDestroyed(key);\n         Region.Entry entry = region.getEntry(key);\n         assertThat(entry).isNull();\n       }\n-      {\n-        List<CacheEvent<Object, Object>> list = ctl.getEventHistory();\n-        assertThat(10).isEqualTo(list.size());\n-        for (int i = 0; i < 10; i++) {\n-          Object key = i;\n-          EntryEvent ee = (EntryEvent) list.get(i);\n-          assertThat(ee.getKey()).isEqualTo(key);\n-          assertThat(ee.getOldValue()).isNull();\n-          assertThat(Operation.DESTROY).isEqualTo(ee.getOperation());\n-          assertThat(\"destroyCB\" + i).isEqualTo(ee.getCallbackArgument());\n-          assertThat(ee.isOriginRemote()).isTrue();\n-        }\n+\n+      List<CacheEvent<Object, Object>> list = assertForOpCount(name, Operation.DESTROY, 10);\n+\n+      for (int i = 0; i < 10; i++) {\n+        Object key = i;\n+        EntryEvent ee = (EntryEvent) list.get(i);\n+        assertThat(ee.getKey()).isEqualTo(key);\n+        assertThat(ee.getOldValue()).isNull();\n+        assertThat(\"destroyCB\" + i).isEqualTo(ee.getCallbackArgument());\n+        assertThat(ee.isOriginRemote()).isTrue();\n       }\n     });\n+\n     vm2.invoke(\"recreate\", () -> {\n       Region<Object, Object> region = getRootRegion().getSubregion(name);\n       for (int i = 0; i < 10; i++) {\n         Object key = i;\n-        region.create(key, \"create\" + i);\n+        region.create(key, \"recreate\" + i, \"recreateCB\" + i);\n       }\n     });\n \n-    vm1.invoke(\"Verify creates\", () -> {\n+    vm1.invoke(\"Verify Local Load Creates\", () -> {\n       Region<Object, Object> region = getRootRegion().getSubregion(name);\n-      CertifiableTestCacheListener<Object, Object> ctl =\n-          (CertifiableTestCacheListener<Object, Object>) region.getAttributes()\n-              .getCacheListeners()[0];\n-      List<CacheEvent<Object, Object>> list = ctl.getEventHistory();\n-      logger\n-          .info(\"history (should be empty): \" + list);\n-      assertThat(list).isEmpty();\n-      // now see if we can get it from the server\n+\n+      await().untilAsserted(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "originalPosition": 309}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzIzNTA2", "url": "https://github.com/apache/geode/pull/4642#pullrequestreview-349723506", "createdAt": "2020-01-28T21:40:51Z", "commit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo0MDo1MVrOFi1kAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo0MDo1MVrOFi1kAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA3MzQ3Mg==", "bodyText": "These are no longer necessary.", "url": "https://github.com/apache/geode/pull/4642#discussion_r372073472", "createdAt": "2020-01-28T21:40:51Z", "author": {"login": "mhansonp"}, "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/ConnectionPoolDUnitTest.java", "diffHunk": "@@ -333,9 +322,6 @@ public void beforeCreate2(EntryEvent event) throws CacheWriterException {\n       Region<Object, Object> region = getRootRegion().getSubregion(name);\n       region.localDestroyRegion();\n     });\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDMzODg3", "url": "https://github.com/apache/geode/pull/4642#pullrequestreview-350433887", "createdAt": "2020-01-29T21:23:45Z", "commit": {"oid": "5944f6c0eedbe76c4839737e11036c51c2e78da4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3747, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}