{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjQ2NTcy", "number": 5114, "title": "Introduce RedisResponse to SET executors", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-05-13T22:29:56Z", "url": "https://github.com/apache/geode/pull/5114", "merged": true, "mergeCommit": {"oid": "6aa2420842249184cc94915e1b207c44b130e2bb"}, "closed": true, "closedAt": "2020-05-19T20:06:45Z", "author": {"login": "jdeppe-pivotal"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchFi9zABqjMzMzQ3NzA1MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci4HJkAH2gAyNDE3NjQ2NTcyOmFlM2ZjOTZmM2VmNjYzYjhiNGU4YTBjYjU3MDIxYzU0OWViMDI5MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ad7b25ceec73dfb0b2653c1a3a5771aaac3229e", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/4ad7b25ceec73dfb0b2653c1a3a5771aaac3229e", "committedDate": "2020-05-14T03:05:07Z", "message": "Fix rat and compile issue"}, "afterCommit": {"oid": "06dd871b1114ffde234fcaaa62af7f922237169b", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/06dd871b1114ffde234fcaaa62af7f922237169b", "committedDate": "2020-05-14T04:12:47Z", "message": "Fix rat and compile issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDk2NjQz", "url": "https://github.com/apache/geode/pull/5114#pullrequestreview-411496643", "createdAt": "2020-05-14T06:25:44Z", "commit": {"oid": "f3fc64184eb6d50678fdcffdf3f073b2b979f9ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjoyNTo0NVrOGVNp6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjoyNTo0NVrOGVNp6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NzAwMA==", "bodyText": "Could you change \"Executor\" to have \"executeCommandsWithResponse\"? For all the old executors we have not converted yet, executeCommandsWithResponse could just call executeCommand and then return null.\nThat would get rid of this instanceof check.", "url": "https://github.com/apache/geode/pull/5114#discussion_r424897000", "createdAt": "2020-05-14T06:25:45Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/RedisCommandType.java", "diffHunk": "@@ -349,9 +350,17 @@ private RedisCommandType(Executor executor, ParameterRequirements parameterRequi\n     this.parameterRequirements = parameterRequirements;\n   }\n \n-  public void executeCommand(Command command, ExecutionHandlerContext executionHandlerContext) {\n+  public RedisResponse executeCommand(Command command,\n+      ExecutionHandlerContext executionHandlerContext) {\n     parameterRequirements.checkParameters(command, executionHandlerContext);\n+\n+    if (executor instanceof ResponseExecutor) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3fc64184eb6d50678fdcffdf3f073b2b979f9ae"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTgwMTMz", "url": "https://github.com/apache/geode/pull/5114#pullrequestreview-411980133", "createdAt": "2020-05-14T16:29:01Z", "commit": {"oid": "12964f882a8de49e11543c72baf5189601de94ec"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjoyOTowMVrOGVki4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjozNDozMVrOGVkxIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MjAzNA==", "bodyText": "It seems like this if expression should use \"!command.isOfType(RedisCommandType.PUBLISH)\".\nYou could get this down to a single \"writeToChannel\" call like so:\nif (response == null && !command.isOfType(PUBLISH) {\nresponse = command.getResponse();\n}\nif (response != null) {\nwriteToChannel(response);\n}", "url": "https://github.com/apache/geode/pull/5114#discussion_r425272034", "createdAt": "2020-05-14T16:29:01Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/ExecutionHandlerContext.java", "diffHunk": "@@ -203,43 +205,42 @@ public void channelInactive(ChannelHandlerContext ctx) {\n   }\n \n   private void executeCommand(ChannelHandlerContext ctx, Command command) throws Exception {\n+    RedisResponse response;\n     if (isAuthenticated) {\n       if (command.isOfType(RedisCommandType.SHUTDOWN)) {\n         this.server.shutdown();\n         return;\n       }\n \n       if (hasTransaction() && !command.isTransactional()) {\n-        executeWithTransaction(ctx, command);\n+        response = executeWithTransaction(ctx, command);\n       } else {\n-        executeWithoutTransaction(command);\n+        response = executeWithoutTransaction(command);\n       }\n \n       if (hasTransaction() && command.isOfType(RedisCommandType.MULTI)) {\n-        writeToChannel(\n-            Coder.getSimpleStringResponse(this.byteBufAllocator, RedisConstants.COMMAND_QUEUED));\n-      } else {\n-        // PUBLISH responses are always deferred\n-        if (command.getCommandType() != RedisCommandType.PUBLISH) {\n-          ByteBuf response = command.getResponse();\n-          writeToChannel(response);\n-        }\n+        response = RedisResponse.string(RedisConstants.COMMAND_QUEUED);\n       }\n-    } else if (command.isOfType(RedisCommandType.QUIT)) {\n-      command.execute(this);\n-      ByteBuf response = command.getResponse();\n-      writeToChannel(response);\n-      channelInactive(ctx);\n     } else if (command.isOfType(RedisCommandType.AUTH)) {\n-      command.execute(this);\n-      ByteBuf response = command.getResponse();\n+      response = command.execute(this);\n+    } else {\n+      response = RedisResponse.error(RedisConstants.ERROR_NOT_AUTH);\n+    }\n+\n+    if (response != null) {\n       writeToChannel(response);\n     } else {\n-      ByteBuf r = Coder.getNoAuthResponse(this.byteBufAllocator, RedisConstants.ERROR_NOT_AUTH);\n-      writeToChannel(r);\n+      // PUBLISH responses are always deferred\n+      if (command.getCommandType() != RedisCommandType.PUBLISH) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12964f882a8de49e11543c72baf5189601de94ec"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3NDM2Ng==", "bodyText": "It looks like these two default impls call each other. executeCommand calls executeCommandWithResponse and then it calls back to executeCommand. Seems like it would do an infinite recursion until the stack overflows.", "url": "https://github.com/apache/geode/pull/5114#discussion_r425274366", "createdAt": "2020-05-14T16:32:30Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/Executor.java", "diffHunk": "@@ -27,9 +27,13 @@\n    * @param command The command to be executed\n    * @param context The execution context by which this command is to be executed\n    */\n-  void executeCommand(Command command, ExecutionHandlerContext context);\n+  default void executeCommand(Command command, ExecutionHandlerContext context) {\n+    executeCommandWithResponse(command, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12964f882a8de49e11543c72baf5189601de94ec"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3NTY4Mg==", "bodyText": "One other idea. I think the plan is to eventually have every executeCommand have a non-null response. But if we are going to continue to have some return \"null\" could they instead return an instance of RedisResponse to represents null?", "url": "https://github.com/apache/geode/pull/5114#discussion_r425275682", "createdAt": "2020-05-14T16:34:31Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/Executor.java", "diffHunk": "@@ -27,9 +27,13 @@\n    * @param command The command to be executed\n    * @param context The execution context by which this command is to be executed\n    */\n-  void executeCommand(Command command, ExecutionHandlerContext context);\n+  default void executeCommand(Command command, ExecutionHandlerContext context) {\n+    executeCommandWithResponse(command, context);\n+  }\n \n-  default void execute(Command command, ExecutionHandlerContext context) {\n+  default RedisResponse executeCommandWithResponse(Command command,\n+      ExecutionHandlerContext context) {\n     executeCommand(command, context);\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12964f882a8de49e11543c72baf5189601de94ec"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4176c0e347f21c6dedc2dc82f9a5c0c3c212f38", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/c4176c0e347f21c6dedc2dc82f9a5c0c3c212f38", "committedDate": "2020-05-14T18:29:23Z", "message": "Review updates"}, "afterCommit": {"oid": "cbe123f86fb72829bc129e0f9a717dff251dd203", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/cbe123f86fb72829bc129e0f9a717dff251dd203", "committedDate": "2020-05-15T16:06:19Z", "message": "Review updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47e39a86164739c5bfc13517ef8df8d514a94a1d", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/47e39a86164739c5bfc13517ef8df8d514a94a1d", "committedDate": "2020-05-15T17:03:50Z", "message": "Introduce RedisResponse to SET executors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7361e6146f3ee9d0853eec5a60950c974c9a5ebc", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/7361e6146f3ee9d0853eec5a60950c974c9a5ebc", "committedDate": "2020-05-15T17:03:53Z", "message": "Fix rat and compile issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257504bc9ffad8baf7a5ca421b89b99c474da4f6", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/257504bc9ffad8baf7a5ca421b89b99c474da4f6", "committedDate": "2020-05-15T17:05:25Z", "message": "Review updates - No need for ResponseExecutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ab4dd6d27984d6b86150a6a9d0ad97e4f92464", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/76ab4dd6d27984d6b86150a6a9d0ad97e4f92464", "committedDate": "2020-05-15T17:05:25Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d01b2f0d624871f1f87e9de812414135c50e5df", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/5d01b2f0d624871f1f87e9de812414135c50e5df", "committedDate": "2020-05-15T17:05:25Z", "message": "Review updates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbe123f86fb72829bc129e0f9a717dff251dd203", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/cbe123f86fb72829bc129e0f9a717dff251dd203", "committedDate": "2020-05-15T16:06:19Z", "message": "Review updates"}, "afterCommit": {"oid": "5d01b2f0d624871f1f87e9de812414135c50e5df", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/5d01b2f0d624871f1f87e9de812414135c50e5df", "committedDate": "2020-05-15T17:05:25Z", "message": "Review updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2777eefeb4bfa91ceaded8d141067f389d60c92", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/e2777eefeb4bfa91ceaded8d141067f389d60c92", "committedDate": "2020-05-15T17:24:43Z", "message": "Spotless...How do I love thee? Let me count the ways..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTk0Njc1", "url": "https://github.com/apache/geode/pull/5114#pullrequestreview-414594675", "createdAt": "2020-05-19T15:58:47Z", "commit": {"oid": "e2777eefeb4bfa91ceaded8d141067f389d60c92"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1ODo0N1rOGXnYyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1ODo0N1rOGXnYyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNTc1Mw==", "bodyText": "can you fix this comment? I have seen this show up before. The comment does not even describe this constant. I would vote for just getting rid of the comment.", "url": "https://github.com/apache/geode/pull/5114#discussion_r427415753", "createdAt": "2020-05-19T15:58:47Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/ExecutionHandlerContext.java", "diffHunk": "@@ -56,7 +58,7 @@\n   private static final Logger logger = LogService.getLogger();\n   private static final int WAIT_REGION_DSTRYD_MILLIS = 100;\n   private static final int MAXIMUM_NUM_RETRIES = (1000 * 60) / WAIT_REGION_DSTRYD_MILLIS; // 60", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2777eefeb4bfa91ceaded8d141067f389d60c92"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae3fc96f3ef663b8b4e8a0cb57021c549eb02935", "author": {"user": {"login": "jdeppe-pivotal", "name": "Jens Deppe"}}, "url": "https://github.com/apache/geode/commit/ae3fc96f3ef663b8b4e8a0cb57021c549eb02935", "committedDate": "2020-05-19T17:42:00Z", "message": "Remove incorrect comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4529, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}