{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MjcwNTc1", "number": 5285, "title": "GEODE-8099: make those gfsh commands that updates cluster configurati\u2026", "bodyText": "\u2026on thead safe.\n\ncommand executor will acquire the lock when executing commands that affects cluster configuration.\nclean up commands that doesn't need to extends implement SingleGfshCommand\nSingleGfshCommand are for those commands that need to update cluster configuration", "createdAt": "2020-06-23T02:12:15Z", "url": "https://github.com/apache/geode/pull/5285", "merged": true, "mergeCommit": {"oid": "b65af0ec91c4b79e8a31cdb616b53d6063ef9a7d"}, "closed": true, "closedAt": "2020-06-25T20:05:44Z", "author": {"login": "jinmeiliao"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct-aCtAH2gAyNDM4MjcwNTc1OjE2MjhjZWUxZDg0YTFlY2Y3OGIwZTZjNmFkM2Y5ZmU1NDJmYzdkN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuzF4jgFqTQzNzc1OTMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "author": {"user": {"login": "jinmeiliao", "name": "Jinmei Liao"}}, "url": "https://github.com/apache/geode/commit/1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "committedDate": "2020-06-23T05:15:14Z", "message": "GEODE-8099: make those gfsh commands that updates cluster configuration thead safe.\n\n* command executor will acquire the lock when executing commands that affects cluster configuration.\n* clean up commands that doesn't need to extends implement SingleGfshCommand\n* SingleGfshCommand are for those commands that need to update cluster configuration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a40bf1692c3d7fe89d11dd72a14c01c1d75bedda", "author": {"user": {"login": "jinmeiliao", "name": "Jinmei Liao"}}, "url": "https://github.com/apache/geode/commit/a40bf1692c3d7fe89d11dd72a14c01c1d75bedda", "committedDate": "2020-06-23T02:11:12Z", "message": "GEODE-8099: make those gfsh commands that updates cluster configuration thead safe.\n\n* command executor will acquire the lock when executing commands that affects cluster configuration.\n* clean up commands that doesn't need to extends implement SingleGfshCommand\n* SingleGfshCommand are for those commands that need to update cluster configuration"}, "afterCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "author": {"user": {"login": "jinmeiliao", "name": "Jinmei Liao"}}, "url": "https://github.com/apache/geode/commit/1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a", "committedDate": "2020-06-23T05:15:14Z", "message": "GEODE-8099: make those gfsh commands that updates cluster configuration thead safe.\n\n* command executor will acquire the lock when executing commands that affects cluster configuration.\n* clean up commands that doesn't need to extends implement SingleGfshCommand\n* SingleGfshCommand are for those commands that need to update cluster configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjU3NjM4", "url": "https://github.com/apache/geode/pull/5285#pullrequestreview-436257638", "createdAt": "2020-06-24T01:06:49Z", "commit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTowNjo0OVrOGn_iXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToxMzo1OVrOGn_pRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4ODYzNw==", "bodyText": "Since \"LocatorClusterManagementService\" is central to the ClusterConfigurationService; will it be better to have the cms-dlock service created in this class; and have helper method to lock and unlock. Assumption is when the lock is requested the Locator Management service will be up and running.\nlockConfigForUpdate() {}\nunLockConfigForUpdate() {}", "url": "https://github.com/apache/geode/pull/5285#discussion_r444588637", "createdAt": "2020-06-24T01:06:49Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/api/LocatorClusterManagementService.java", "diffHunk": "@@ -113,7 +113,7 @@\n public class LocatorClusterManagementService implements ClusterManagementService {\n   @VisibleForTesting\n   // the dlock service name used by the CMS\n-  static final String CMS_DLOCK_SERVICE_NAME = \"CMS_DLOCK_SERVICE\";\n+  public static final String CMS_DLOCK_SERVICE_NAME = \"CMS_DLOCK_SERVICE\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MDAwMw==", "bodyText": "How about naming it as \"updatesClusterConfiguration\" (); they both are same, just another name to consider, its left to you.", "url": "https://github.com/apache/geode/pull/5285#discussion_r444590003", "createdAt": "2020-06-24T01:12:22Z", "author": {"login": "agingade"}, "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/GfshCommand.java", "diffHunk": "@@ -59,6 +59,14 @@ public boolean isOnlineCommandAvailable() {\n     return gfsh.isConnectedAndReady();\n   }\n \n+  /**\n+   * For those commands that could possibly change the cluster configuration, they need to\n+   * override this method to return true.\n+   */\n+  public boolean affectsClusterConfiguration() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MDQwNA==", "bodyText": "How about combining all of the if into an AND condition.\nif (cmsDlockService == null && !(command instanceof GfshCommand) &&...)", "url": "https://github.com/apache/geode/pull/5285#discussion_r444590404", "createdAt": "2020-06-24T01:13:59Z", "author": {"login": "agingade"}, "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/remote/CommandExecutor.java", "diffHunk": "@@ -207,4 +219,32 @@ protected Object invokeCommand(Object command, GfshParseResult parseResult) {\n \n     return resultModel;\n   }\n+\n+  @VisibleForTesting\n+  boolean lockCMS(Object command) {\n+    if (cmsDlockService == null) {\n+      return false;\n+    }\n+    if (!(command instanceof GfshCommand)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODg4NDY4", "url": "https://github.com/apache/geode/pull/5285#pullrequestreview-436888468", "createdAt": "2020-06-24T18:09:03Z", "commit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTA5NjEx", "url": "https://github.com/apache/geode/pull/5285#pullrequestreview-436909611", "createdAt": "2020-06-24T18:39:31Z", "commit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODozOTozMVrOGoedww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODo1ODoxN1rOGofF9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTM2Mw==", "bodyText": "This changes the public API, which could affect those gfsh commands that extend this class.", "url": "https://github.com/apache/geode/pull/5285#discussion_r445095363", "createdAt": "2020-06-24T18:39:31Z", "author": {"login": "jchen21"}, "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/SingleGfshCommand.java", "diffHunk": "@@ -39,7 +42,11 @@\n    *        return value of your command method.\n    * @return a boolean indicating whether a change to the cluster configuration was persisted.\n    */\n-  public boolean updateConfigForGroup(String group, CacheConfig config, Object configObject) {\n-    return false;\n+  public abstract boolean updateConfigForGroup(String group, CacheConfig config,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTQyOQ==", "bodyText": "This changes the public API, which could affect those gfsh commands that extend this class.", "url": "https://github.com/apache/geode/pull/5285#discussion_r445095429", "createdAt": "2020-06-24T18:39:39Z", "author": {"login": "jchen21"}, "path": "geode-gfsh/src/main/java/org/apache/geode/management/cli/SingleGfshCommand.java", "diffHunk": "@@ -39,7 +42,11 @@\n    *        return value of your command method.\n    * @return a boolean indicating whether a change to the cluster configuration was persisted.\n    */\n-  public boolean updateConfigForGroup(String group, CacheConfig config, Object configObject) {\n-    return false;\n+  public abstract boolean updateConfigForGroup(String group, CacheConfig config,\n+      Object configObject);\n+\n+  @Override\n+  public boolean affectsClusterConfiguration() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEwNTY1NQ==", "bodyText": "This constructor is used only by tests. e.g. MemberCommandServiceTest. This also leads to adding a new constructor to a deprecated class MemberCommandService. And then changes to MemberCommandServiceTest. I wonder if it is necessary to make this change.", "url": "https://github.com/apache/geode/pull/5285#discussion_r445105655", "createdAt": "2020-06-24T18:58:17Z", "author": {"login": "jchen21"}, "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/remote/OnlineCommandProcessor.java", "diffHunk": "@@ -53,14 +57,13 @@\n \n   private SecurityService securityService;\n \n-  private InternalCache cache;\n-\n   public OnlineCommandProcessor() {}\n \n   @VisibleForTesting\n-  public OnlineCommandProcessor(Properties cacheProperties, SecurityService securityService,\n-      CommandExecutor commandExecutor, InternalCache cache) {\n-    this.gfshParser = new GfshParser(new CommandManager(cacheProperties, cache));\n+  public OnlineCommandProcessor(GfshParser gfshParser,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1628cee1d84a1ecf78b0e6c6ad3f9fe542fc7d7a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce547022549ee198707da0e14212b609d695a85", "author": {"user": {"login": "jinmeiliao", "name": "Jinmei Liao"}}, "url": "https://github.com/apache/geode/commit/bce547022549ee198707da0e14212b609d695a85", "committedDate": "2020-06-24T20:05:55Z", "message": "more comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzU5MzEw", "url": "https://github.com/apache/geode/pull/5285#pullrequestreview-437759310", "createdAt": "2020-06-25T18:38:11Z", "commit": {"oid": "bce547022549ee198707da0e14212b609d695a85"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4304, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}