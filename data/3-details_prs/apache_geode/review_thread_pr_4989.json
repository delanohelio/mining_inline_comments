{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3OTgwNjYy", "number": 4989, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzozMTozOFrOD1ZFBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjo1NDo1M1rOD27vhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzEyMDA1OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzozMTozOFrOGKz4tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzozMTozNVrOGLX1lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk4OTA0NA==", "bodyText": "Instead of \".size() == 0\" I think \".isEmpty()\" is better.", "url": "https://github.com/apache/geode/pull/4989#discussion_r413989044", "createdAt": "2020-04-23T17:31:38Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5MjQ4Mw==", "bodyText": "Calling \"hgetall\" and then checking the size does not seem thread safe. Couldn't another  thread add to this set and find the existing one we emptied out and add to it right after this thread checks the size and then we will unregister a non-empty hash?\nIf we do have a concurrency issue I'm still okay with this change since it fixes the non-concurrent case. Maybe we could just add a TODO comment that concurrency needs to be addressed?", "url": "https://github.com/apache/geode/pull/4989#discussion_r413992483", "createdAt": "2020-04-23T17:36:49Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk4OTA0NA=="}, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NDg1NQ==", "bodyText": "True, I will update to .isEmpty()", "url": "https://github.com/apache/geode/pull/4989#discussion_r414574855", "createdAt": "2020-04-24T13:26:56Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk4OTA0NA=="}, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3ODA2OQ==", "bodyText": "Yeah, I think we just put in the non-concurrent case for now since we are still deciding on an approach (compound key vs. function/delta vs. something else).  I will add a TODO, though.", "url": "https://github.com/apache/geode/pull/4989#discussion_r414578069", "createdAt": "2020-04-24T13:31:35Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk4OTA0NA=="}, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzE1NzUzOnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzo0MDozNFrOGK0Pfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzozMzozM1rOGLX62A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5NDg3OQ==", "bodyText": "It seems like this code should only unregister if the current type is REDIS_HASH. I thought you were unregistering here but does getRegionProvider().removeKey change the keyRegistar? I will talk with Sarah about this. I might just not understand this code", "url": "https://github.com/apache/geode/pull/4989#discussion_r413994879", "createdAt": "2020-04-23T17:40:34Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3OTQxNg==", "bodyText": "Yes, the removeKey method unregisters the key from the keyRegistrar in addition to deleting it.", "url": "https://github.com/apache/geode/pull/4989#discussion_r414579416", "createdAt": "2020-04-24T13:33:33Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().size() == 0) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5NDg3OQ=="}, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzE2MjgwOnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzo0MTozN1rOGK0SjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzozMTo1OVrOGLX2uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5NTY2MA==", "bodyText": "Same comments on this block as the above hdel", "url": "https://github.com/apache/geode/pull/4989#discussion_r413995660", "createdAt": "2020-04-23T17:41:37Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,15 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n       return newValue;\n     });\n+\n+    if (members().size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3ODM2MA==", "bodyText": "I will update and add a TODO.", "url": "https://github.com/apache/geode/pull/4989#discussion_r414578360", "createdAt": "2020-04-24T13:31:59Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,15 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n       return newValue;\n     });\n+\n+    if (members().size() == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5NTY2MA=="}, "originalCommit": {"oid": "7844427418ddf08113b38ac897332dc8d61f0c8a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTI4NDExOnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjo1NDoyNFrOGM7ENw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMzoxNToxMFrOGNTadg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwMzgzMQ==", "bodyText": "It seems wrong here to refetch the RedisDataType and then blow it away without checking if the type is what we expect. For example here should we check to see if it is == REDIS_SET before calling removeKey?", "url": "https://github.com/apache/geode/pull/4989#discussion_r416203831", "createdAt": "2020-04-27T22:54:24Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,19 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n+      // if(newValue.isEmpty()) {\n+      // context.getRegionProvider().removeKey(key, context.getKeyRegistrar().getType(key));\n+      // }\n+\n       return newValue;\n     });\n+\n+    if (members().isEmpty()) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYwMjc0Mg==", "bodyText": "We actually check the data type in the SREM executor before we create the synchronized set and call SREM.  We can add it again here. We also added a test to make sure the error is thrown and check the message.", "url": "https://github.com/apache/geode/pull/4989#discussion_r416602742", "createdAt": "2020-04-28T13:15:10Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,19 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n+      // if(newValue.isEmpty()) {\n+      // context.getRegionProvider().removeKey(key, context.getKeyRegistrar().getType(key));\n+      // }\n+\n       return newValue;\n     });\n+\n+    if (members().isEmpty()) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwMzgzMQ=="}, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTI4NDU1OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjo1NDozOFrOGM7Egg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMzo1NTo0N1rOGNVSXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwMzkwNg==", "bodyText": "It seems wrong here to refetch the RedisDataType and then blow it away without checking if the type is what we expect. For example here should we check to see if it is == REDIS_HASH before calling removeKey?", "url": "https://github.com/apache/geode/pull/4989#discussion_r416203906", "createdAt": "2020-04-27T22:54:38Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().isEmpty()) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzQzNw==", "bodyText": "Turns out the type was not getting checked for HDel, so we added a test and updated the HDelExecutor and hdel method in GeodeRedisHashSynchronized.  Thanks for pointing this out!", "url": "https://github.com/apache/geode/pull/4989#discussion_r416633437", "createdAt": "2020-04-28T13:55:47Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/GeodeRedisHashSynchronized.java", "diffHunk": "@@ -89,6 +89,11 @@ public int hdel(List<ByteArrayWrapper> subList) {\n       numDeleted.set(oldHash.size() - newHash.size());\n       return newHash;\n     });\n+\n+    if (hgetall().isEmpty()) {\n+      RedisDataType type = context.getKeyRegistrar().getType(key);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwMzkwNg=="}, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTI4NTE2OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjo1NDo1M1rOGM7E5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMzowOToxOFrOGNTKFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwNDAwNQ==", "bodyText": "should this commented out code be removed?", "url": "https://github.com/apache/geode/pull/4989#discussion_r416204005", "createdAt": "2020-04-27T22:54:53Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,19 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n+      // if(newValue.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU5ODU0OA==", "bodyText": "Yes.  We were experimenting with adding it into compute. Thank you for finding that!", "url": "https://github.com/apache/geode/pull/4989#discussion_r416598548", "createdAt": "2020-04-28T13:09:18Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/set/GeodeRedisSetSynchronized.java", "diffHunk": "@@ -59,8 +60,19 @@ public long srem(Collection<ByteArrayWrapper> membersToRemove) {\n       Set<ByteArrayWrapper> newValue = createSet(oldValue);\n       newValue.removeAll(membersToRemove);\n       removedCount.set(oldValue.size() - newValue.size());\n+\n+      // if(newValue.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIwNDAwNQ=="}, "originalCommit": {"oid": "29b17c22b6f878380537f9a0db909b3a6b5a2c35"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4122, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}