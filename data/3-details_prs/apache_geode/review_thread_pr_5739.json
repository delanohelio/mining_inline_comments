{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDQzMTkw", "number": 5739, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzo0NDo0NFrOE4Rqqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMDo0MToyOFrOE5OxAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDQ1MTYzOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzo0NDo0NFrOHyGb2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxMDowMVrOHyJswA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI5NjI4Mg==", "bodyText": "this line is the crucial part of the fix, no?", "url": "https://github.com/apache/geode/pull/5739#discussion_r522296282", "createdAt": "2020-11-12T17:44:44Z", "author": {"login": "echobravopapa"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;\n+      Throwable cause = t;\n+      if (cause != null && !(cause instanceof ForcedDisconnectException)) {\n+        logger.info(\"cluster membership failed due to \", cause);\n+        cause = new ForcedDisconnectException(cause.getMessage());\n       }\n+      dm.setRootCause(cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0OTc2MA==", "bodyText": "yes.  The rest is a small refactor to make DMListener testable", "url": "https://github.com/apache/geode/pull/5739#discussion_r522349760", "createdAt": "2020-11-12T19:10:01Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;\n+      Throwable cause = t;\n+      if (cause != null && !(cause instanceof ForcedDisconnectException)) {\n+        logger.info(\"cluster membership failed due to \", cause);\n+        cause = new ForcedDisconnectException(cause.getMessage());\n       }\n+      dm.setRootCause(cause);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI5NjI4Mg=="}, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDQ5NTY4OnYy", "diffSide": "RIGHT", "path": "geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzo1NToyNVrOHyG3Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowNzo0M1rOHyJnDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMzI2Ng==", "bodyText": "How is this connected to this issue?", "url": "https://github.com/apache/geode/pull/5739#discussion_r522303266", "createdAt": "2020-11-12T17:55:25Z", "author": {"login": "echobravopapa"}, "path": "geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java", "diffHunk": "@@ -79,6 +79,7 @@ public static boolean skipLogMsgs(String type) {\n     expected.add(Pattern.compile(\"SystemAlertManager: A simple Alert.\"));\n \n     expected.add(Pattern.compile(\"org.apache.geode.management.DependenciesNotFoundException\"));\n+    expected.add(Pattern.compile(\"EntryNotFoundException\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0ODMwMQ==", "bodyText": "oops - that was left over from some debugging on another ticket.  I'll get rid of that.", "url": "https://github.com/apache/geode/pull/5739#discussion_r522348301", "createdAt": "2020-11-12T19:07:43Z", "author": {"login": "bschuchardt"}, "path": "geode-dunit/src/main/java/org/apache/geode/test/greplogs/ExpectedStrings.java", "diffHunk": "@@ -79,6 +79,7 @@ public static boolean skipLogMsgs(String type) {\n     expected.add(Pattern.compile(\"SystemAlertManager: A simple Alert.\"));\n \n     expected.add(Pattern.compile(\"org.apache.geode.management.DependenciesNotFoundException\"));\n+    expected.add(Pattern.compile(\"EntryNotFoundException\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMzI2Ng=="}, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDUwNDc4OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzo1NzozN1rOHyG85A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxNDoyMlrOHyJ5-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwNDc0MA==", "bodyText": "extra credit: could the comment \"// added for #37950\" be converted into some words; i.e. whatever that old issue was/fixed etc...", "url": "https://github.com/apache/geode/pull/5739#discussion_r522304740", "createdAt": "2020-11-12T17:57:37Z", "author": {"login": "echobravopapa"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2357,9 +2361,9 @@ public void memberDeparted(InternalDistributedMember theId, boolean crashed, Str\n           message.setIgnoreAlertListenerRemovalFailure(true); // we don't know if it was a listener\n                                                               // so\n           // don't issue a warning\n-          message.setRecipient(localAddress);\n+          message.setRecipient(dm.getDistributionManagerId());\n           message.setReason(reason); // added for #37950", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MzE0NQ==", "bodyText": "I'll just delete that comment", "url": "https://github.com/apache/geode/pull/5739#discussion_r522353145", "createdAt": "2020-11-12T19:14:22Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2357,9 +2361,9 @@ public void memberDeparted(InternalDistributedMember theId, boolean crashed, Str\n           message.setIgnoreAlertListenerRemovalFailure(true); // we don't know if it was a listener\n                                                               // so\n           // don't issue a warning\n-          message.setRecipient(localAddress);\n+          message.setRecipient(dm.getDistributionManagerId());\n           message.setReason(reason); // added for #37950", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwNDc0MA=="}, "originalCommit": {"oid": "377324373be9544a4b2b08d9497923217ff4b7ef"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDY3NTU4OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozODoyNFrOHzC2qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozODoyNFrOHzC2qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjE4NA==", "bodyText": "Good improvement making this inner class static \u2713", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286184", "createdAt": "2020-11-13T23:38:24Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2283,7 +2288,7 @@ public Distribution getDistribution() {\n    * This is the listener implementation for responding from events from the Membership Manager.\n    *\n    */\n-  private class DMListener implements\n+  static class DMListener implements", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDY3NjIzOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozODo1NFrOHzC3FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozODo1NFrOHzC3FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjI5Mw==", "bodyText": "ah now that this inner class is static we have to use an accessor to get at the test hooks \u2713", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286293", "createdAt": "2020-11-13T23:38:54Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;\n+      Throwable cause = t;\n+      if (cause != null && !(cause instanceof ForcedDisconnectException)) {\n+        logger.info(\"cluster membership failed due to \", cause);\n+        cause = new ForcedDisconnectException(cause.getMessage());\n       }\n+      dm.setRootCause(cause);\n       try {\n-        if (membershipTestHooks != null) {\n-          List<MembershipTestHook> l = membershipTestHooks;\n-          for (final MembershipTestHook aL : l) {\n-            MembershipTestHook dml = aL;\n-            dml.beforeMembershipFailure(reason, rootCause);\n+        List<MembershipTestHook> testHooks = dm.getMembershipTestHooks();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDY3ODE2OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozOTo1MFrOHzC4JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozOTo1MFrOHzC4JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NjU2NQ==", "bodyText": "DMListener needs an accessor now ok", "url": "https://github.com/apache/geode/pull/5739#discussion_r523286565", "createdAt": "2020-11-13T23:39:50Z", "author": {"login": "Bill"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2209,6 +2209,11 @@ private void removeAllHealthMonitors() {\n     }\n   }\n \n+  private List<MembershipTestHook> getMembershipTestHooks() {\n+    return membershipTestHooks;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDY4MTczOnYy", "diffSide": "RIGHT", "path": "geode-core/src/test/java/org/apache/geode/distributed/internal/ClusterDistributionManagerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzo0MjowN1rOHzC6Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzo0MjowN1rOHzC6Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NzA5NA==", "bodyText": "It's a little bit surprising that the ClusterDistributionManager test, mocks the ClusterDistributionManager ;-) But I get it and it's ok. It's really a test of the inner DMListener \u2713", "url": "https://github.com/apache/geode/pull/5739#discussion_r523287094", "createdAt": "2020-11-13T23:42:07Z", "author": {"login": "Bill"}, "path": "geode-core/src/test/java/org/apache/geode/distributed/internal/ClusterDistributionManagerTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.distributed.internal;\n+\n+import static org.mockito.ArgumentMatchers.isA;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+import org.junit.Test;\n+\n+import org.apache.geode.ForcedDisconnectException;\n+import org.apache.geode.distributed.internal.membership.api.MemberDisconnectedException;\n+\n+public class ClusterDistributionManagerTest {\n+\n+  @Test\n+  public void membershipFailureProcessingCreatesForcedDisconnectException() {\n+    ClusterDistributionManager manager = mock(ClusterDistributionManager.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NDQ2MjEwOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMDo0MToyOFrOHzkq_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMDo0MToyOFrOHzkq_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg0MDI1NA==", "bodyText": "Can we please start renaming back variables to something more meaningful.", "url": "https://github.com/apache/geode/pull/5739#discussion_r523840254", "createdAt": "2020-11-16T00:41:28Z", "author": {"login": "kohlmu-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/ClusterDistributionManager.java", "diffHunk": "@@ -2293,26 +2298,25 @@ public Distribution getDistribution() {\n \n     @Override\n     public void membershipFailure(String reason, Throwable t) {\n-      exceptionInThreads = true;\n-      rootCause = t;\n-      if (rootCause != null && !(rootCause instanceof ForcedDisconnectException)) {\n-        logger.info(\"cluster membership failed due to \", rootCause);\n-        rootCause = new ForcedDisconnectException(rootCause.getMessage());\n+      dm.exceptionInThreads = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aa1066e719a31e09c012e9bbf78a6b8a3744531"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4633, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}