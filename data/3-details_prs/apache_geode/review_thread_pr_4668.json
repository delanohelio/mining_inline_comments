{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDc5Njc0", "number": 4668, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo1MjowOVrODc0N6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyMDowNlrODc0hmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQyMjQ4OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo1MjowOVrOFlD_8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjoxNjozOFrOFl9-qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzE1Mw==", "bodyText": "don't want to mind-read here, what was the rationale for a local copy?", "url": "https://github.com/apache/geode/pull/4668#discussion_r374407153", "createdAt": "2020-02-03T23:52:09Z", "author": {"login": "echobravopapa"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NzA5Nw==", "bodyText": "this caches the value to ensure that it doesn't go null after this check", "url": "https://github.com/apache/geode/pull/4668#discussion_r375357097", "createdAt": "2020-02-05T16:16:38Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNzE1Mw=="}, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ1OTM3OnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoxMjo1NlrOFlEW6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzo1NToxMlrOFmBZrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMzAzNQ==", "bodyText": "should \"currentLocator.internalCache\" be changed to \"myCache\"?", "url": "https://github.com/apache/geode/pull/4668#discussion_r374413035", "createdAt": "2020-02-04T00:12:56Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxMzE2Nw==", "bodyText": "yes.  It looks like Aditya Anchuri added that code early in 2019.  I'll change it.", "url": "https://github.com/apache/geode/pull/4668#discussion_r375413167", "createdAt": "2020-02-05T17:55:12Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMzAzNQ=="}, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ2OTkzOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoxODoyNlrOFlEdHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoxODoyNlrOFlEdHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNDYyMA==", "bodyText": "If this expression is true it seems like we just silently returned without starting all of the locator's services. I have seen runs (recently) in which this happens because the InternalDistributedSystem does a concurrent InternalLocator.stop while another thread is executing the restart of this locator. So before returning here should this locator be marked in some way as not having been started? I think the thread that waits for this thread (the one executing startClusterManagementService) just joins and then says we are started.", "url": "https://github.com/apache/geode/pull/4668#discussion_r374414620", "createdAt": "2020-02-04T00:18:26Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ3MjkwOnYy", "diffSide": "RIGHT", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyMDowNlrOFlEe_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODowMjoxNlrOFmBoqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNTEwMQ==", "bodyText": "Since this is an instance method on InternalLocator, why don't we just use this.internalCache and this.configurationPersistenceService instead of trying to get the locator from a static. This method should be initializing itself.", "url": "https://github.com/apache/geode/pull/4668#discussion_r374415101", "createdAt": "2020-02-04T00:20:06Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQxNzAwMw==", "bodyText": "yes, I agree.  I'm going to make a pass through InternalLocator and remove the use of the \"locator\" static wherever possible.  These uses all seem to come from cluster-configuration work.", "url": "https://github.com/apache/geode/pull/4668#discussion_r375417003", "createdAt": "2020-02-05T18:02:16Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/InternalLocator.java", "diffHunk": "@@ -773,15 +773,19 @@ private void startCache(DistributedSystem system) throws IOException {\n     startClusterManagementService();\n   }\n \n-  private void startClusterManagementService() throws IOException {\n+  @VisibleForTesting\n+  void startClusterManagementService() throws IOException {\n     startConfigurationPersistenceService();\n \n-    if (internalCache == null) {\n+    InternalCache myCache = this.internalCache;\n+    InternalLocator currentLocator = InternalLocator.locator;\n+\n+    if (myCache == null || currentLocator == null) {\n       return;\n     }\n \n-    clusterManagementService = new LocatorClusterManagementService(locator.internalCache,\n-        locator.configurationPersistenceService);\n+    clusterManagementService = new LocatorClusterManagementService(currentLocator.internalCache,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNTEwMQ=="}, "originalCommit": {"oid": "2e0c7189782806320b050b7081cc5bbbfbf96167"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3746, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}