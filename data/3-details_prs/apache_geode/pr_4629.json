{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTA1NjI5", "number": 4629, "title": "GEODE-7727: modify sender thread to detect release of connection", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n[*] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n[*] Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n[*] Is your initial contribution a single, squashed commit?\n\n\n[*] Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-01-24T16:03:34Z", "url": "https://github.com/apache/geode/pull/4629", "merged": true, "mergeCommit": {"oid": "1a0d9769e482f49e0c725c0d6adc75d324f88958"}, "closed": true, "closedAt": "2020-02-15T07:49:28Z", "author": {"login": "mivanac"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDF8u5gH2gAyMzY2OTA1NjI5OjNhMzNlZWM3Mzg1MGYzNGMyYTVlNDUzZjgxOWMyYTFmYTA5ODczYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEED-6gFqTM1ODYzNzkxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a33eec73850f34c2a5e453f819c2a1fa09873b2", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/3a33eec73850f34c2a5e453f819c2a1fa09873b2", "committedDate": "2020-02-10T23:43:43Z", "message": "GEODE-7727: modify sender thread to detect relese of connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d604444044a566e2a03b44d60ae647751d89057e", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/d604444044a566e2a03b44d60ae647751d89057e", "committedDate": "2020-02-11T10:08:47Z", "message": "GEODE-7727: Update solution only for shared connections"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8555b6f41056e15d8adffbce62da0f2213a65dd", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/f8555b6f41056e15d8adffbce62da0f2213a65dd", "committedDate": "2020-01-24T15:58:51Z", "message": "GEODE-7727: modify sender thread to detect relese of connection"}, "afterCommit": {"oid": "d604444044a566e2a03b44d60ae647751d89057e", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/d604444044a566e2a03b44d60ae647751d89057e", "committedDate": "2020-02-11T10:08:47Z", "message": "GEODE-7727: Update solution only for shared connections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "committedDate": "2020-02-13T15:09:34Z", "message": "GEODE-7727: added test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a17c827692451a928a4ce5afe8bfc6ba46c10180", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/a17c827692451a928a4ce5afe8bfc6ba46c10180", "committedDate": "2020-02-13T12:30:19Z", "message": "GEODE-7727: added test"}, "afterCommit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "committedDate": "2020-02-13T15:09:34Z", "message": "GEODE-7727: added test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzMzNjA4", "url": "https://github.com/apache/geode/pull/4629#pullrequestreview-358333608", "createdAt": "2020-02-13T15:55:18Z", "commit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTo1NToxOFrOFpZVDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjo0NDo0NlrOFpbSVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MDkyNw==", "bodyText": "can this be turned into an await()?  Thread.sleep() often causes tests to fail.", "url": "https://github.com/apache/geode/pull/4629#discussion_r378950927", "createdAt": "2020-02-13T15:55:18Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java", "diffHunk": "@@ -113,6 +114,46 @@ public void basicAcceptConnection() throws Exception {\n     }\n   }\n \n+\n+  @Test\n+  public void testClosingOfSenderConnections() throws Exception {\n+    final VM vm1 = VM.getVM(1);\n+    final VM vm2 = VM.getVM(2);\n+    final VM vm3 = VM.getVM(3);\n+\n+    disconnectAllFromDS();\n+\n+    int port = startLocator();\n+    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n+\n+    vm1.invoke(() -> startServer(properties));\n+    vm2.invoke(() -> startServer(properties));\n+    vm3.invoke(() -> startServer(properties));\n+\n+    Thread.sleep(5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDM0MA==", "bodyText": "The (!isHandShakeReader) test was added here to fix a race condition between the handshake thread and an application thread using the thread-owned Connection.  I think this test needs to remain in place.", "url": "https://github.com/apache/geode/pull/4629#discussion_r378970340", "createdAt": "2020-02-13T16:25:08Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1692,10 +1700,8 @@ private void readMessages() {\n         }\n       }\n     } finally {\n-      if (!isHandShakeReader) {\n-        synchronized (stateLock) {\n-          connectionState = STATE_IDLE;\n-        }\n+      synchronized (stateLock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MDk5OA==", "bodyText": "handshakeRead and handshakeCancelled are only set to true in notifyHandshakeWaiter().  Why do we need to call that method again in this spot?", "url": "https://github.com/apache/geode/pull/4629#discussion_r378980998", "createdAt": "2020-02-13T16:41:26Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1637,8 +1640,13 @@ private void readMessages() {\n               }\n             }\n             isHandShakeReader = true;\n-            // Once we have read the handshake the reader can go away\n-            break;\n+            notifyHandshakeWaiter(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4Mjk5Nw==", "bodyText": "good change here.  It shouldn't be needed since a sharedResource will only invoke this method if isReaderThread==true but having an explicit test is a good idea.", "url": "https://github.com/apache/geode/pull/4629#discussion_r378982997", "createdAt": "2020-02-13T16:44:46Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1637,8 +1640,13 @@ private void readMessages() {\n               }\n             }\n             isHandShakeReader = true;\n-            // Once we have read the handshake the reader can go away\n-            break;\n+            notifyHandshakeWaiter(false);\n+            // Once we have read the handshake for unshared connections, the reader can skip\n+            // processing messages\n+            if (!sharedResource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072377db29986041433c9f39041e33dc002e5f72", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/072377db29986041433c9f39041e33dc002e5f72", "committedDate": "2020-02-13T18:36:29Z", "message": "GEODE-7727: update ater comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34c086d3f1b2237cd517c12aeb4d793cbdd36029", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/34c086d3f1b2237cd517c12aeb4d793cbdd36029", "committedDate": "2020-02-13T17:44:40Z", "message": "GEODE-7727: update ater comments"}, "afterCommit": {"oid": "072377db29986041433c9f39041e33dc002e5f72", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/072377db29986041433c9f39041e33dc002e5f72", "committedDate": "2020-02-13T18:36:29Z", "message": "GEODE-7727: update ater comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b256f77434acbf0072a5b38220e3dd0dc8dded3", "author": {"user": {"login": "mivanac", "name": "Mario Ivanac"}}, "url": "https://github.com/apache/geode/commit/3b256f77434acbf0072a5b38220e3dd0dc8dded3", "committedDate": "2020-02-13T21:21:20Z", "message": "GEODE-7727: update test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjM3OTE0", "url": "https://github.com/apache/geode/pull/4629#pullrequestreview-358637914", "createdAt": "2020-02-14T00:05:45Z", "commit": {"oid": "3b256f77434acbf0072a5b38220e3dd0dc8dded3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3725, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}