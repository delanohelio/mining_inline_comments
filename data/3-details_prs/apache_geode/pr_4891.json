{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MTQ3NzAw", "number": 4891, "title": "GEODE-7919-fix-flaky: shut down threads after tests", "bodyText": "CI failures yesterday: MembershipIntegrationTest > secondMembershipCanJoinUsingTheSecondLocatorToStart\nIt\u2019s failing in both JDK8 and JDK11:\nhttps://concourse.apachegeode-ci.info/teams/main/pipelines/apache-develop-main/jobs/IntegrationTestOpenJDK8/builds/4#A\norg.apache.geode.distributed.internal.membership.gms.MembershipIntegrationTest > secondMembershipCanJoinUsingTheSecondLocatorToStart FAILED\n\n    java.lang.AssertionError: \n\n    Expected size:<2> but was:<1> in:\n\n    <[172.17.0.26(1:locator)<ec><v0>:41002]>\n\n        at org.apache.geode.distributed.internal.membership.gms.MembershipIntegrationTest.secondMembershipCanJoinUsingTheSecondLocatorToStart(MembershipIntegrationTest.java:144)\nLooks like in a number of tests we expect to see two members in the view but see only one. I ran the test a couple hundred times in IntelliJ and was able to reproduce the failures.\nI added a couple methods to the test to shut down locators and memberships because that was a difference I saw introduced with GEODE-7919. But really I think that masks the problem. If you comment out the innards of those two new routines and give this test a couple hundred runs it'll repro the assertion failure.\nI satisfied myself that the solution was to add Awaitility calls around the key assertions so that's what I did.\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-04-01T18:01:24Z", "url": "https://github.com/apache/geode/pull/4891", "merged": true, "mergeCommit": {"oid": "ef6fdc1f76de7792d9edd88db25c8b6fe814ee5e"}, "closed": true, "closedAt": "2020-04-02T17:23:31Z", "author": {"login": "Bill"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTbhjqAH2gAyMzk3MTQ3NzAwOjBlMjIwN2U2OTFiYzkyMDJkMzhmNGNjNzQzNDlmOTBiYjc4N2Y2ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTvIutgFqTM4NjYwODg1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e2207e691bc9202d38f4cc74349f90bb787f6fb", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/0e2207e691bc9202d38f4cc74349f90bb787f6fb", "committedDate": "2020-04-01T17:54:44Z", "message": "GEODE-7919-fix-flaky: shut down threads after tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60949c2b252979a30b3217243018f138ccc8d54", "author": {"user": {"login": "Bill", "name": "Bill Burcham"}}, "url": "https://github.com/apache/geode/commit/f60949c2b252979a30b3217243018f138ccc8d54", "committedDate": "2020-04-01T23:18:58Z", "message": "GEODE-7919-fix-flaky: add Awaitility to soak up latency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTIyNTMx", "url": "https://github.com/apache/geode/pull/4891#pullrequestreview-386522531", "createdAt": "2020-04-02T15:08:39Z", "commit": {"oid": "f60949c2b252979a30b3217243018f138ccc8d54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTM2NjA5", "url": "https://github.com/apache/geode/pull/4891#pullrequestreview-386536609", "createdAt": "2020-04-02T15:23:41Z", "commit": {"oid": "f60949c2b252979a30b3217243018f138ccc8d54"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyMzo0MVrOF_wlrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyMzo0MVrOF_wlrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMDY4NQ==", "bodyText": "were these stop() calls omissions before?", "url": "https://github.com/apache/geode/pull/4891#discussion_r402400685", "createdAt": "2020-04-02T15:23:41Z", "author": {"login": "echobravopapa"}, "path": "geode-membership/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/MembershipIntegrationTest.java", "diffHunk": "@@ -102,21 +115,28 @@ public void twoLocatorsCanStartSequentially()\n \n     final MembershipLocator<MemberIdentifier> locator1 = createLocator(0);\n     locator1.start();\n+\n     final int locatorPort1 = locator1.getPort();\n \n     Membership<MemberIdentifier> membership1 = createMembership(locator1, locatorPort1);\n     start(membership1);\n \n     final MembershipLocator<MemberIdentifier> locator2 = createLocator(0, locatorPort1);\n     locator2.start();\n+\n     final int locatorPort2 = locator2.getPort();\n \n     Membership<MemberIdentifier> membership2 =\n         createMembership(locator2, locatorPort1, locatorPort2);\n     start(membership2);\n \n-    assertThat(membership1.getView().getMembers()).hasSize(2);\n-    assertThat(membership2.getView().getMembers()).hasSize(2);\n+    await().untilAsserted(\n+        () -> assertThat(membership1.getView().getMembers()).hasSize(2));\n+    await().untilAsserted(\n+        () -> assertThat(membership2.getView().getMembers()).hasSize(2));\n+\n+    stop(membership2, membership1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f60949c2b252979a30b3217243018f138ccc8d54"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjA4ODU2", "url": "https://github.com/apache/geode/pull/4891#pullrequestreview-386608856", "createdAt": "2020-04-02T16:45:43Z", "commit": {"oid": "f60949c2b252979a30b3217243018f138ccc8d54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4725, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}