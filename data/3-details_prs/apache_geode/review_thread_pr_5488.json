{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTkwODY2", "number": 5488, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjowMTozNVrOEeXpAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoxNTozNFrOEeX8lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjgwMDY3OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjowMTozNVrOHJ-4mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjowMTozNVrOHJ-4mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyOTUyOA==", "bodyText": "Instead of \"100\" should this be \"MAX_QUEUED_COMMANDS\"?", "url": "https://github.com/apache/geode/pull/5488#discussion_r480229528", "createdAt": "2020-08-31T16:01:35Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -61,17 +64,22 @@\n public class ExecutionHandlerContext extends ChannelInboundHandlerAdapter {\n \n   private static final Logger logger = LogService.getLogger();\n+  private static final Command TERMINATE_COMMAND = new Command();\n \n   private final Client client;\n   private final Channel channel;\n   private final RegionProvider regionProvider;\n   private final PubSub pubsub;\n-  private final EventLoopGroup subscriberGroup;\n   private final ByteBufAllocator byteBufAllocator;\n   private final byte[] authPassword;\n   private final Supplier<Boolean> allowUnsupportedSupplier;\n   private final Runnable shutdownInvoker;\n   private final RedisStats redisStats;\n+  private final EventLoopGroup subscriberGroup;\n+  private final int MAX_QUEUED_COMMANDS =\n+      Integer.getInteger(\"geode.redis.commandQueueSize\", 1000);\n+  private final LinkedBlockingQueue<Command> commandQueue =\n+      new LinkedBlockingQueue<>(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjgxNTI2OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjowNTo0NVrOHJ_B7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo0MTowNlrOHKCQAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzMTkxNw==", "bodyText": "I'd like to discuss what this should synchronize on. The method syncs on this (ExecutionHandlerContext) but the future it creates syncs on the channel. I think it would be better to sync on \"channel\" on this method instead of \"this\"", "url": "https://github.com/apache/geode/pull/5488#discussion_r480231917", "createdAt": "2020-08-31T16:05:45Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -139,6 +164,33 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {\n     }\n   }\n \n+  public EventLoopGroup getSubscriberGroup() {\n+    return subscriberGroup;\n+  }\n+\n+  public synchronized void changeChannelEventLoopGroup(EventLoopGroup newGroup,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI4NDY3NQ==", "bodyText": "Switched method synchronization to synchronize on channel", "url": "https://github.com/apache/geode/pull/5488#discussion_r480284675", "createdAt": "2020-08-31T17:41:06Z", "author": {"login": "jdeppe-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -139,6 +164,33 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {\n     }\n   }\n \n+  public EventLoopGroup getSubscriberGroup() {\n+    return subscriberGroup;\n+  }\n+\n+  public synchronized void changeChannelEventLoopGroup(EventLoopGroup newGroup,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzMTkxNw=="}, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjgzMDgzOnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoxMDoxMVrOHJ_LiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo0MToyN1rOHKCQ1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNDM3Ng==", "bodyText": "Does this warning message make sense? It might but I thought it would just say it FAILED I'm not sure about \"to return\"", "url": "https://github.com/apache/geode/pull/5488#discussion_r480234376", "createdAt": "2020-08-31T16:10:11Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -247,25 +306,16 @@ private RedisResponse handleUnAuthenticatedCommand(Command command) {\n     return response;\n   }\n \n-  public EventLoopGroup getSubscriberGroup() {\n-    return subscriberGroup;\n-  }\n-\n-  public void changeChannelEventLoopGroup(EventLoopGroup newGroup) {\n-    if (newGroup.equals(channel.eventLoop())) {\n-      // already registered with newGroup\n-      return;\n-    }\n-    channel.deregister().addListener((ChannelFutureListener) future -> {\n-      newGroup.register(channel).sync();\n-    });\n-  }\n-\n-  private void logResponse(RedisResponse response) {\n+  private void logResponse(RedisResponse response, String extraMessage, Throwable cause) {\n     if (logger.isDebugEnabled() && response != null) {\n       ByteBuf buf = response.encode(new UnpooledByteBufAllocator(false));\n-      logger.debug(\"Redis command returned: {}\",\n-          Command.getHexEncodedString(buf.array(), buf.readableBytes()));\n+      if (cause == null) {\n+        logger.debug(\"Redis command returned: {} - {}\",\n+            Command.getHexEncodedString(buf.array(), buf.readableBytes()), extraMessage);\n+      } else {\n+        logger.warn(\"Redis command FAILED to return: {} - {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 258}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI4NDg4Nw==", "bodyText": "Changed to debug", "url": "https://github.com/apache/geode/pull/5488#discussion_r480284887", "createdAt": "2020-08-31T17:41:27Z", "author": {"login": "jdeppe-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -247,25 +306,16 @@ private RedisResponse handleUnAuthenticatedCommand(Command command) {\n     return response;\n   }\n \n-  public EventLoopGroup getSubscriberGroup() {\n-    return subscriberGroup;\n-  }\n-\n-  public void changeChannelEventLoopGroup(EventLoopGroup newGroup) {\n-    if (newGroup.equals(channel.eventLoop())) {\n-      // already registered with newGroup\n-      return;\n-    }\n-    channel.deregister().addListener((ChannelFutureListener) future -> {\n-      newGroup.register(channel).sync();\n-    });\n-  }\n-\n-  private void logResponse(RedisResponse response) {\n+  private void logResponse(RedisResponse response, String extraMessage, Throwable cause) {\n     if (logger.isDebugEnabled() && response != null) {\n       ByteBuf buf = response.encode(new UnpooledByteBufAllocator(false));\n-      logger.debug(\"Redis command returned: {}\",\n-          Command.getHexEncodedString(buf.array(), buf.readableBytes()));\n+      if (cause == null) {\n+        logger.debug(\"Redis command returned: {} - {}\",\n+            Command.getHexEncodedString(buf.array(), buf.readableBytes()), extraMessage);\n+      } else {\n+        logger.warn(\"Redis command FAILED to return: {} - {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNDM3Ng=="}, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 258}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjg1MDc3OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoxNTozNFrOHJ_Xfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzo0MjowNVrOHKCSIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNzQzOQ==", "bodyText": "I think we should review the commandQueue code and see if we might continue to process commands in the queue after this happens. For example this code adds TERMINATE_COMMAND to the end of the queue so do we end up still processing any commands already queued? We should also check that the \"quit\" command does not allow commands queued after it to still be processed on the server", "url": "https://github.com/apache/geode/pull/5488#discussion_r480237439", "createdAt": "2020-08-31T16:15:34Z", "author": {"login": "dschneider-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -192,43 +244,50 @@ public void channelInactive(ChannelHandlerContext ctx) {\n     if (logger.isDebugEnabled()) {\n       logger.debug(\"GeodeRedisServer-Connection closing with \" + ctx.channel().remoteAddress());\n     }\n+    commandQueue.offer(TERMINATE_COMMAND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI4NTIxNw==", "bodyText": "This will be addressed in a separate PR.", "url": "https://github.com/apache/geode/pull/5488#discussion_r480285217", "createdAt": "2020-08-31T17:42:05Z", "author": {"login": "jdeppe-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/netty/ExecutionHandlerContext.java", "diffHunk": "@@ -192,43 +244,50 @@ public void channelInactive(ChannelHandlerContext ctx) {\n     if (logger.isDebugEnabled()) {\n       logger.debug(\"GeodeRedisServer-Connection closing with \" + ctx.channel().remoteAddress());\n     }\n+    commandQueue.offer(TERMINATE_COMMAND);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIzNzQzOQ=="}, "originalCommit": {"oid": "dd2e3b010ef574f98773913ad8a512956a116159"}, "originalPosition": 156}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4761, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}