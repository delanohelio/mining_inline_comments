{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDcyMTY5", "number": 5350, "title": "GEODE-8200: Rebalance operations stuck in \"IN_PROGRESS\" state forever", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-07-07T00:43:05Z", "url": "https://github.com/apache/geode/pull/5350", "merged": true, "mergeCommit": {"oid": "426b9de66ae9adadde8f1994b2340fc9de809d81"}, "closed": true, "closedAt": "2020-07-10T21:42:02Z", "author": {"login": "jchen21"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsO346AH2gAyNDQ1MDcyMTY5OjJjNDkwZjZlZjdlNjQxNTZiOGFjY2IyNjBiNjY4YjRkMDM4MTkxZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczqjmXgFqTQ0NjcxMTc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c490f6ef7e64156b8accb260b668b4d038191ef", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/2c490f6ef7e64156b8accb260b668b4d038191ef", "committedDate": "2020-06-17T19:18:28Z", "message": "DUnit test that reproduces the bug.\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a3d9164c3c8b17172312e9ebad62772ddc2bbed", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/9a3d9164c3c8b17172312e9ebad62772ddc2bbed", "committedDate": "2020-06-19T00:31:38Z", "message": "Check locator status before returning result\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f38fd84b7f3321a54f5b3be3972b8e8fa3a8f88", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/4f38fd84b7f3321a54f5b3be3972b8e8fa3a8f88", "committedDate": "2020-06-23T18:42:41Z", "message": "Remove temporary product change\n\nRecord locator as a string instead of InternalDistributedMember\nRemove temporary product change that is used for reproducing the bug\nRemove some debugging messages\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d8006b92a2b23cffb7f33e4ac192c926cd00231", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/6d8006b92a2b23cffb7f33e4ac192c926cd00231", "committedDate": "2020-06-23T18:58:25Z", "message": "spotlessApply\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825810c2717f20b04998ba2b7d831d584d40872c", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/825810c2717f20b04998ba2b7d831d584d40872c", "committedDate": "2020-06-27T00:13:49Z", "message": "Refactor the code and fix unit test failures\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c2e31a36b6a6b3a9489a4c593f35882fc287da", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/35c2e31a36b6a6b3a9489a4c593f35882fc287da", "committedDate": "2020-06-27T01:22:12Z", "message": "Merge branch 'develop' into feature/GEODE-8200"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b11bee272cdeeb2b4f88d396cf3a2b67a302860d", "author": {"user": {"login": "jinmeiliao", "name": "Jinmei Liao"}}, "url": "https://github.com/apache/geode/commit/b11bee272cdeeb2b4f88d396cf3a2b67a302860d", "committedDate": "2020-06-27T01:23:25Z", "message": "add OperationManagementUpgradeTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "268f0b4fb40cf62ff3780ee7529ac08902848b7f", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/268f0b4fb40cf62ff3780ee7529ac08902848b7f", "committedDate": "2020-06-27T01:26:35Z", "message": "Fix deserialization error in rolling upgrade test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867a861887c372746be86dcaa89c0da74a85798c", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/867a861887c372746be86dcaa89c0da74a85798c", "committedDate": "2020-07-06T21:25:41Z", "message": "Validate the locator in OperationHistoryManager\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04e96e33b6b947590f6c7e2c809315c03ebf074b", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/04e96e33b6b947590f6c7e2c809315c03ebf074b", "committedDate": "2020-07-07T00:38:26Z", "message": "Add more tests\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5ba559fce3618894697a514cc48cc29b1b1d34", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/6c5ba559fce3618894697a514cc48cc29b1b1d34", "committedDate": "2020-07-07T17:28:47Z", "message": "Fix the failure of serializable test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12f6a646962c8c1e90fe52418a5e5f3d1bd10f00", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/12f6a646962c8c1e90fe52418a5e5f3d1bd10f00", "committedDate": "2020-07-07T17:59:08Z", "message": "Remove the rolling upgrade test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a890b09dc9056351157dd4f34388f5439b3058", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/b4a890b09dc9056351157dd4f34388f5439b3058", "committedDate": "2020-07-07T19:39:22Z", "message": "Revert \"Remove the rolling upgrade test\"\n\nThis reverts commit 12f6a646962c8c1e90fe52418a5e5f3d1bd10f00."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/830650f602214758bb0535ea0467b668f9aef26e", "committedDate": "2020-07-07T19:55:04Z", "message": "Test rolling upgrade to 1.13 once it is available\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTMwMDUy", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-445130052", "createdAt": "2020-07-08T21:08:11Z", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTowODoxMVrOGu5SHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMToyNDoxNVrOGu5u7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjIwNg==", "bodyText": "this is just one line operation, is this not atomic? If not, can we put the synchronize on the method?", "url": "https://github.com/apache/geode/pull/5350#discussion_r451826206", "createdAt": "2020-07-08T21:08:11Z", "author": {"login": "jinmeiliao"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationState.java", "diffHunk": "@@ -28,12 +28,25 @@\n  */\n public class OperationState<A extends ClusterManagementOperation<V>, V extends OperationResult>\n     implements Identifiable<String> {\n+  private static final long serialVersionUID = 8212319653561969588L;\n   private final String opId;\n   private final A operation;\n   private final Date operationStart;\n   private Date operationEnd;\n   private V result;\n   private Throwable throwable;\n+  private String locator;\n+\n+  public String getLocator() {\n+    return this.locator;\n+  }\n+\n+  public void setLocator(\n+      String locator) {\n+    synchronized (this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzU4Mg==", "bodyText": "instead of adding this interface, you can change the method of recordStart() to add the a locator id parameter, since when started, we should always know what locator started this operation.", "url": "https://github.com/apache/geode/pull/5350#discussion_r451833582", "createdAt": "2020-07-08T21:24:15Z", "author": {"login": "jinmeiliao"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java", "diffHunk": "@@ -53,6 +53,8 @@\n    */\n   <V extends OperationResult> void recordEnd(String opId, V result, Throwable exception);\n \n+  void recordLocator(String opId, String locator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Mjc2NTYw", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-445276560", "createdAt": "2020-07-09T04:09:03Z", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Mjc3MDQ1", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-445277045", "createdAt": "2020-07-09T04:10:55Z", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4396d35a6a04930f67b15841c075d1657168216", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/d4396d35a6a04930f67b15841c075d1657168216", "committedDate": "2020-07-09T22:24:23Z", "message": "Move recordLocator to recordStart\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTY2ODM3", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-445966837", "createdAt": "2020-07-09T21:02:36Z", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMTowMjozNlrOGvhsVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMTowMzoxNVrOGvhtyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4ODI3Nw==", "bodyText": "This is for consistency. setOperationEnd() does the same.", "url": "https://github.com/apache/geode/pull/5350#discussion_r452488277", "createdAt": "2020-07-09T21:02:36Z", "author": {"login": "jchen21"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationState.java", "diffHunk": "@@ -28,12 +28,25 @@\n  */\n public class OperationState<A extends ClusterManagementOperation<V>, V extends OperationResult>\n     implements Identifiable<String> {\n+  private static final long serialVersionUID = 8212319653561969588L;\n   private final String opId;\n   private final A operation;\n   private final Date operationStart;\n   private Date operationEnd;\n   private V result;\n   private Throwable throwable;\n+  private String locator;\n+\n+  public String getLocator() {\n+    return this.locator;\n+  }\n+\n+  public void setLocator(\n+      String locator) {\n+    synchronized (this) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjIwNg=="}, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ4ODY0OA==", "bodyText": "Good point.", "url": "https://github.com/apache/geode/pull/5350#discussion_r452488648", "createdAt": "2020-07-09T21:03:15Z", "author": {"login": "jchen21"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationStateStore.java", "diffHunk": "@@ -53,6 +53,8 @@\n    */\n   <V extends OperationResult> void recordEnd(String opId, V result, Throwable exception);\n \n+  void recordLocator(String opId, String locator);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzU4Mg=="}, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDAyNDM2", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-446002436", "createdAt": "2020-07-09T22:09:20Z", "commit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMjowOToyMFrOGvjfdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMjoxMTo0M1rOGvjisQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNzc1MQ==", "bodyText": "Can this be DistributedID than a String ID. That way we can avoid converting to string in other places?", "url": "https://github.com/apache/geode/pull/5350#discussion_r452517751", "createdAt": "2020-07-09T22:09:20Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationState.java", "diffHunk": "@@ -28,12 +28,25 @@\n  */\n public class OperationState<A extends ClusterManagementOperation<V>, V extends OperationResult>\n     implements Identifiable<String> {\n+  private static final long serialVersionUID = 8212319653561969588L;\n   private final String opId;\n   private final A operation;\n   private final Date operationStart;\n   private Date operationEnd;\n   private V result;\n   private Throwable throwable;\n+  private String locator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxODU3Nw==", "bodyText": "Does it need to be compared? can it be changed to \"equals\"....", "url": "https://github.com/apache/geode/pull/5350#discussion_r452518577", "createdAt": "2020-07-09T22:11:43Z", "author": {"login": "agingade"}, "path": "geode-core/src/main/java/org/apache/geode/management/internal/operation/OperationHistoryManager.java", "diffHunk": "@@ -90,6 +95,27 @@ private static boolean isExpired(long expirationTime, OperationState<?, ?> opera\n     return operationEnd.getTime() <= expirationTime;\n   }\n \n+  private OperationState<?, ?> validateLocator(OperationState<?, ?> operationState) {\n+    if (isLocatorOffline(operationState)) {\n+      operationState.setOperationEnd(new Date(), null,\n+          new RuntimeException(\"Locator that initiated the Rest API operation is offline: \"\n+              + operationState.getLocator()));\n+    }\n+\n+    return operationState;\n+  }\n+\n+  private boolean isLocatorOffline(OperationState operationState) {\n+    if (operationState.getOperationEnd() == null\n+        && (operationState.getLocator() != null)\n+        && cache.getMyId().toString().compareTo(operationState.getLocator()) != 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "830650f602214758bb0535ea0467b668f9aef26e"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0062a1033ea757b9aa1a896017683affba6a5057", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/0062a1033ea757b9aa1a896017683affba6a5057", "committedDate": "2020-07-09T23:11:37Z", "message": "Use equals for string comparison\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4734da93b94bc56dbacd158e600205db46452c0", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/f4734da93b94bc56dbacd158e600205db46452c0", "committedDate": "2020-07-10T18:43:26Z", "message": "Add the missing NOT operator\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzExNzg3", "url": "https://github.com/apache/geode/pull/5350#pullrequestreview-446711787", "createdAt": "2020-07-10T21:31:07Z", "commit": {"oid": "f4734da93b94bc56dbacd158e600205db46452c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4359, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}