{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzY3OTU4", "number": 4977, "title": "GEODE-7851: Pulse refreshes expired access tokens", "bodyText": "If a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\nChanges in Repository:\n\nWhen OAuth is configured, before returning the user's cluster,\ngetCluster() checks whether the user's access token has expired.\nIf the access token has expired, the repository attempts to refresh\nit.  If the refresh succeeds, the repository reconnects the user's\ncluster to JMX and returns it.\nIf the refresh fails, the repository disconnects the user's cluster\nfrom JMX, removes the cluster from the repository, and throws an\nauthentication or authorization exception.\n\nChanges in PulseController:\n\nIf the service call throws an authentication or authorization\nexception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n\nIf a Pulse ajax call returns a 401 status, ajaxPost() redirects the\nbrowser to /pulse/clusterLogout to log the user out and request\nre-authorization.\n\nCo-authored-by: Joris Melchior joris.melchior@gmail.com\nCo-authored-by: Dale Emery demery@pivotal.io\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-04-21T00:14:19Z", "url": "https://github.com/apache/geode/pull/4977", "merged": true, "mergeCommit": {"oid": "2999414d6004b7725fd9652f75dbfdb549a2544d"}, "closed": true, "closedAt": "2020-04-24T18:41:11Z", "author": {"login": "demery-pivotal"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaLcIqAFqTM5ODM4ODgwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABca1ibOgBqjMyNzA1MTE5NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Mzg4ODA3", "url": "https://github.com/apache/geode/pull/4977#pullrequestreview-398388807", "createdAt": "2020-04-22T16:55:10Z", "commit": {"oid": "2bb56b1151f1bb86c6b435a1a0f2c0d2921f6bf5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjo1NToxMFrOGKAx5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzowNzozMFrOGKBVrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1MTcxNg==", "bodyText": "It would be a good idea to document the the Object credentials here is the object that will be put in the jmx environment for connection: jmx.remote.credentials", "url": "https://github.com/apache/geode/pull/4977#discussion_r413151716", "createdAt": "2020-04-22T16:55:10Z", "author": {"login": "jinmeiliao"}, "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/data/Repository.java", "diffHunk": "@@ -80,8 +88,95 @@ public Repository(OAuth2AuthorizedClientService authorizedClientService,\n     this.clusterFactory = clusterFactory;\n   }\n \n+  /**\n+   * this will return a cluster already connected to the geode jmx manager for the user in the\n+   * request\n+   * <p>\n+   * But for multi-user connections to gemfireJMX, i.e pulse that uses gemfire integrated security,\n+   * we will need to get the username from the context\n+   */\n+  public Cluster getCluster() {\n+    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\n+    if (authentication == null) {\n+      return null;\n+    }\n+\n+    if (authentication instanceof OAuth2AuthenticationToken) {\n+      return getClusterWithAuthenticationToken((OAuth2AuthenticationToken) authentication);\n+    }\n+\n+    return getClusterWithUserNameAndPassword(authentication.getName(), null);\n+  }\n+\n+  public Cluster getClusterWithUserNameAndPassword(String userName, String password) {\n+    String[] credentials = {userName, password};\n+    return getClusterWithCredentials(userName, credentials);\n+  }\n+\n+  public Cluster getClusterWithCredentials(String userName, Object credentials) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bb56b1151f1bb86c6b435a1a0f2c0d2921f6bf5"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2MDg3OQ==", "bodyText": "wondering which flow is better. Using the following might get rid of the reconnectToGemfire method in Cluster.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (isExpired(authorizedClient.getAccessToken())) {\n          \n          \n            \n                String userName = authorizedClient.getPrincipalName();\n          \n          \n            \n            \n          \n          \n            \n                if (isExpired(authorizedClient.getAccessToken())) {\n          \n          \n            \n                  logoutUser(userName);\n          \n          \n            \n                  authorizedClient = refreshExpiredClient(authentication, authorizedClient);\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                userName = authorizedClient.getPrincipalName();\n          \n          \n            \n                String credentials = authorizedClient.getAccessToken().getTokenValue();\n          \n          \n            \n                return getClusterWithCredentials(userName, credentials);", "url": "https://github.com/apache/geode/pull/4977#discussion_r413160879", "createdAt": "2020-04-22T17:07:30Z", "author": {"login": "jinmeiliao"}, "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/data/Repository.java", "diffHunk": "@@ -80,8 +88,95 @@ public Repository(OAuth2AuthorizedClientService authorizedClientService,\n     this.clusterFactory = clusterFactory;\n   }\n \n+  /**\n+   * this will return a cluster already connected to the geode jmx manager for the user in the\n+   * request\n+   * <p>\n+   * But for multi-user connections to gemfireJMX, i.e pulse that uses gemfire integrated security,\n+   * we will need to get the username from the context\n+   */\n+  public Cluster getCluster() {\n+    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();\n+    if (authentication == null) {\n+      return null;\n+    }\n+\n+    if (authentication instanceof OAuth2AuthenticationToken) {\n+      return getClusterWithAuthenticationToken((OAuth2AuthenticationToken) authentication);\n+    }\n+\n+    return getClusterWithUserNameAndPassword(authentication.getName(), null);\n+  }\n+\n+  public Cluster getClusterWithUserNameAndPassword(String userName, String password) {\n+    String[] credentials = {userName, password};\n+    return getClusterWithCredentials(userName, credentials);\n+  }\n+\n+  public Cluster getClusterWithCredentials(String userName, Object credentials) {\n+    synchronized (clusterMap) {\n+      Cluster cluster = clusterMap.get(userName);\n+      if (cluster == null) {\n+        logger.info(resourceBundle.getString(\"LOG_MSG_CREATE_NEW_THREAD\") + \" : \" + userName);\n+        cluster = clusterFactory.create(host, port, userName, resourceBundle, this);\n+        // Assign name to thread created\n+        cluster.setName(PulseConstants.APP_NAME + \"-\" + host + \":\" + port + \":\" + userName);\n+        cluster.connectToGemFire(credentials);\n+        if (cluster.isConnectedFlag()) {\n+          clusterMap.put(userName, cluster);\n+        }\n+      }\n+      return cluster;\n+    }\n+  }\n+\n+  /**\n+   * Returns the cluster for the user associated with the given authentication. If the user's\n+   * access token is expired, it is refreshed and the cluster is reconnected to JMX using the fresh\n+   * token. If the refresh fails, the user's cluster is disconnected from JMX and removed from the\n+   * repository.\n+   */\n+  private Cluster getClusterWithAuthenticationToken(OAuth2AuthenticationToken authentication) {\n+    OAuth2AuthorizedClient authorizedClient = getAuthorizedClient(authentication);\n+\n+    if (isExpired(authorizedClient.getAccessToken())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bb56b1151f1bb86c6b435a1a0f2c0d2921f6bf5"}, "originalPosition": 112}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bb56b1151f1bb86c6b435a1a0f2c0d2921f6bf5", "author": {"user": {"login": "jmelchio", "name": "Joris Melchior"}}, "url": "https://github.com/apache/geode/commit/2bb56b1151f1bb86c6b435a1a0f2c0d2921f6bf5", "committedDate": "2020-04-21T00:12:48Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>"}, "afterCommit": {"oid": "1464a4b6abed7d210d1df005dd8814a4e636d00e", "author": {"user": {"login": "demery-pivotal", "name": "Dale Emery"}}, "url": "https://github.com/apache/geode/commit/1464a4b6abed7d210d1df005dd8814a4e636d00e", "committedDate": "2020-04-22T22:20:40Z", "message": "Add logging for token refresh/expiration events\n\n- Add log messages\n  - When an access token expires.\n  - When Pulse reconnects to JMX following a token refresh.\n  - When Pulse disconnects from JMX and logs the user out due to the\n    refresh token expiring.\n- Identify the session using the token's \"sub\" attribute instead of the\n  user's name.\n- Add log4j2's slf4j implementation to the Pulse webapp so that it will\n  actually write the log file.\n\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjU5ODA3", "url": "https://github.com/apache/geode/pull/4977#pullrequestreview-398659807", "createdAt": "2020-04-22T23:28:34Z", "commit": {"oid": "1464a4b6abed7d210d1df005dd8814a4e636d00e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjYyNjE5", "url": "https://github.com/apache/geode/pull/4977#pullrequestreview-398662619", "createdAt": "2020-04-22T23:36:12Z", "commit": {"oid": "1464a4b6abed7d210d1df005dd8814a4e636d00e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMzozNjoxMlrOGKQLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMzozNjoxMlrOGKQLNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQwMzk1Nw==", "bodyText": "probably it would be good to do this in a separate PR so that we can backport this to support branches.", "url": "https://github.com/apache/geode/pull/4977#discussion_r413403957", "createdAt": "2020-04-22T23:36:12Z", "author": {"login": "jinmeiliao"}, "path": "geode-pulse/build.gradle", "diffHunk": "@@ -50,7 +50,9 @@ dependencies {\n   // Needed to fully use log4j instead of commons-logging.\n   implementation('org.apache.logging.log4j:log4j-jcl')\n   implementation('org.apache.logging.log4j:log4j-api')\n-//  implementation('org.apache.logging.log4j:log4j-core')\n+  implementation('org.apache.logging.log4j:log4j-slf4j-impl') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1464a4b6abed7d210d1df005dd8814a4e636d00e"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a9569ace34cf4823743a29405e7fca543279fdc", "author": {"user": {"login": "demery-pivotal", "name": "Dale Emery"}}, "url": "https://github.com/apache/geode/commit/2a9569ace34cf4823743a29405e7fca543279fdc", "committedDate": "2020-04-23T00:31:52Z", "message": "Fix test setup to create OidcIdToken"}, "afterCommit": {"oid": "73ebfcc87179f62285752e7a5ac9c40a150dfd9b", "author": {"user": {"login": "jmelchio", "name": "Joris Melchior"}}, "url": "https://github.com/apache/geode/commit/73ebfcc87179f62285752e7a5ac9c40a150dfd9b", "committedDate": "2020-04-23T00:50:08Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzI1MDYx", "url": "https://github.com/apache/geode/pull/4977#pullrequestreview-398725061", "createdAt": "2020-04-23T02:56:47Z", "commit": {"oid": "73ebfcc87179f62285752e7a5ac9c40a150dfd9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cec946848e24feaa6af5c6260a9bc65805c07ea", "author": {"user": {"login": "demery-pivotal", "name": "Dale Emery"}}, "url": "https://github.com/apache/geode/commit/7cec946848e24feaa6af5c6260a9bc65805c07ea", "committedDate": "2020-04-23T22:52:20Z", "message": "Merge branch 'develop' into geode-7851/refresh"}, "afterCommit": {"oid": "b08cf7f87752abcce67acba7a896aab48f2a0a43", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/b08cf7f87752abcce67acba7a896aab48f2a0a43", "committedDate": "2020-04-24T17:51:22Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271170a8b1034a07e2af5f0765e305e1e47af2c5", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/271170a8b1034a07e2af5f0765e305e1e47af2c5", "committedDate": "2020-04-24T18:09:59Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b08cf7f87752abcce67acba7a896aab48f2a0a43", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/b08cf7f87752abcce67acba7a896aab48f2a0a43", "committedDate": "2020-04-24T17:51:22Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}, "afterCommit": {"oid": "271170a8b1034a07e2af5f0765e305e1e47af2c5", "author": {"user": {"login": "kirklund", "name": "Kirk Lund"}}, "url": "https://github.com/apache/geode/commit/271170a8b1034a07e2af5f0765e305e1e47af2c5", "committedDate": "2020-04-24T18:09:59Z", "message": "GEODE-7851: Pulse refreshes expired access tokens\n\nIf a user's access token expires, Pulse attempts to refresh it. If the\nrefresh fails, Pulse logs the user out and redirects the browser to\n/pulse/clusterLogout.\n\nChanges in Repository:\n- When OAuth is configured, before returning the user's cluster,\n  getCluster() checks whether the user's access token has expired.\n- If the access token has expired, the repository attempts to refresh\n  it.  If the refresh succeeds, the repository reconnects the user's\n  cluster to JMX and returns it.\n- If the refresh fails, the repository disconnects the user's cluster\n  from JMX, removes the cluster from the repository, and throws an\n  authentication or authorization exception.\n\nChanges in PulseController:\n- If the service call throws an authentication or authorization\n  exception, PulseController.  getPulseUpdate() returns a 401 status.\n\nChanges in pulsescript/common.js:\n- If a Pulse ajax call returns a 401 status, ajaxPost() redirects the\n  browser to /pulse/clusterLogout to log the user out and request\n  re-authorization.\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Jinmei Liao <jiliao@pivotal.io>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4839, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}