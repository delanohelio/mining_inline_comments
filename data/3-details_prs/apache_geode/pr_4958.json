{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzQ3NTg1", "number": 4958, "title": "GEODE-7852: test ClientHealthMonitor functionality behind a SNI gateway", "bodyText": "This ensures that a server sitting behind an SNI gateway detects the\nloss of a client and cleans up after it.  In this case the test detects\nthat the server has closed CQs created by the non-durable client.\nSince test code is not accessible in the Docker container that's running\nthe server I've enhanced the StatArchiveReader to be able to report the\nvalues of a statistic and have enabled statistics recording in the\nserver.  Much of this code came from the deprecated SystemAdmin class.\n(cherry picked from commit 376df4c)\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-04-14T18:33:52Z", "url": "https://github.com/apache/geode/pull/4958", "merged": true, "mergeCommit": {"oid": "9db544e876088794de58a0f863e13d17134f1e26"}, "closed": true, "closedAt": "2020-04-16T15:12:12Z", "author": {"login": "bschuchardt"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXn1sQgH2gAyNDAzMzQ3NTg1OjIzYTA5YWQ5NmZhNTg2ZjQyY2M4OGY1NzI0Mjk1NjhkYTU1OTRlOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXrc1OgH2gAyNDAzMzQ3NTg1OjMxM2Y0YjRkZGMzNDgxYmQ4ZWIxNGRlOGIxYjczY2UyZTBhYmI4ZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/23a09ad96fa586f42cc88f572429568da5594e9a", "committedDate": "2020-04-14T18:31:17Z", "message": "GEODE-7852: test ClientHealthMonitor functionality behind a SNI gateway\n\nThis ensures that a server sitting behind an SNI gateway detects the\nloss of a client and cleans up after it.  In this case the test detects\nthat the server has closed CQs created by the non-durable client.\n\nSince test code is not accessible in the Docker container that's running\nthe server I've enhanced the StatArchiveReader to be able to report the\nvalues of a statistic and have enabled statistics recording in the\nserver.\n\n(cherry picked from commit 376df4cc7abc6db38b4b298f8af6f3c53baedf15)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjIxMDkx", "url": "https://github.com/apache/geode/pull/4958#pullrequestreview-393221091", "createdAt": "2020-04-14T19:14:36Z", "commit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOToxNDozNlrOGFdMPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOToyMjo0MVrOGFddyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NDMzMg==", "bodyText": "do we need this log in the test output?", "url": "https://github.com/apache/geode/pull/4958#discussion_r408374332", "createdAt": "2020-04-14T19:14:36Z", "author": {"login": "Bill"}, "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -107,9 +111,18 @@ public void before() throws IOException, InterruptedException {\n \n   }\n \n+  @After\n+  public void after() throws Exception {\n+    String output =\n+        docker.exec(options(\"-T\"), \"geode\", arguments(\"cat\", \"server-dolores/server-dolores.log\"));\n+    System.out.println(\"Server log file--------------------------------\\n\" + output);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NzYwMA==", "bodyText": "Now that we have NotOnWindowsDockerRule, we have the ability for a test to start containers once and to break actual testing into multiple test methods. We do it that way (in SingleServerSNIAcceptanceTest and DualServerSNIAcceptanceTest) for performance reasons\u2014we don't want to take too many minutes out of our CI pipeline, for SNI testing.\nSo for these reasons I think we should do one of two things:\n\nuse NotOnWindowsDockerRule here, and break these tests into multiple test methods\ngo further, and transfer these CQ tests over to the SingleServerSNIAcceptanceTest class (eliminating this test class entirely)\n\nI can see why we might want to do (1) even though it will add more Docker startup/teardown time (versus (2)), since there is some CQ-specific stuff here: 3 fields and an inner (CqListener) class.", "url": "https://github.com/apache/geode/pull/4958#discussion_r408377600", "createdAt": "2020-04-14T19:20:31Z", "author": {"login": "Bill"}, "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -22,6 +22,7 @@\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_REQUIRE_AUTHENTICATION;\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_TRUSTSTORE;\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_TRUSTSTORE_PASSWORD;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODI4Nw==", "bodyText": "do we need/want these stats in the test output?", "url": "https://github.com/apache/geode/pull/4958#discussion_r408378287", "createdAt": "2020-04-14T19:21:42Z", "author": {"login": "Bill"}, "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -152,6 +165,21 @@ public void performSimpleCQOverSNIProxy()\n \n     assertThat(eventUpdateCounter.get()).isEqualTo(62);\n \n+    // verify that the server cleans up when the client connection to the gateway is destroyed\n+    ((PoolImpl) cache.getDefaultPool()).killPrimaryEndpoint();\n+    // since we can't run code in the server let's grab the CQ statistics and verify that\n+    // the CQ has been closed. StatArchiveReader has a main() that we can use to get a printout\n+    // of stat values\n+    await().untilAsserted(() -> {\n+      String stats = docker.exec(options(\"-T\"), \"geode\",\n+          arguments(\"java\", \"-cp\", \"/geode/lib/geode-dependencies.jar\",\n+              \"org.apache.geode.internal.statistics.StatArchiveReader\",\n+              \"stat\", \"server-dolores/statArchive.gfs\", \"CqServiceStats.numCqsClosed\"));\n+      System.out.println(\"stats from server are :\" + stats);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODgyNw==", "bodyText": "this turns on stats for all our SNI tests\u2014not just this one. I assume that is ok but just wanted to remind everybody", "url": "https://github.com/apache/geode/pull/4958#discussion_r408378827", "createdAt": "2020-04-14T19:22:41Z", "author": {"login": "Bill"}, "path": "geode-assembly/src/acceptanceTest/resources/org/apache/geode/client/sni/geode-config/gemfire.properties", "diffHunk": "@@ -15,4 +15,5 @@\n # limitations under the License.\n #\n \n-#empty\n+statistic-sampling-enabled=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a09ad96fa586f42cc88f572429568da5594e9a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1159b9f351bda1ce261966d466be404a4980895", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/e1159b9f351bda1ce261966d466be404a4980895", "committedDate": "2020-04-14T21:54:13Z", "message": "change the docker rule to be a class-rule in case we add more tests to this class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzM5OTYw", "url": "https://github.com/apache/geode/pull/4958#pullrequestreview-393339960", "createdAt": "2020-04-14T22:29:41Z", "commit": {"oid": "e1159b9f351bda1ce261966d466be404a4980895"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "313f4b4ddc3481bd8eb14de8b1b73ce2e0abb8e6", "author": {"user": {"login": "bschuchardt", "name": "Bruce Schuchardt"}}, "url": "https://github.com/apache/geode/commit/313f4b4ddc3481bd8eb14de8b1b73ce2e0abb8e6", "committedDate": "2020-04-14T22:43:45Z", "message": "removed system.out.println per Bill's review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4809, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}