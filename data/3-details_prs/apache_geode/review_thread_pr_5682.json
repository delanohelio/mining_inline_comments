{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjI5NDYx", "number": 5682, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzozMDo1M1rOEzTGnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozMDo0OVrOEzbfeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMjI1ODIxOnYy", "diffSide": "RIGHT", "path": "geode-redis/src/acceptanceTest/java/org/apache/geode/redis/internal/executor/connection/SelectNativeRedisAcceptanceTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzozMDo1M1rOHqb4UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNDoxMDo0M1rOHqdqiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI1OTAyNQ==", "bodyText": "No need to do this here since the super class handles the client setup.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514259025", "createdAt": "2020-10-29T13:30:53Z", "author": {"login": "jdeppe-pivotal"}, "path": "geode-redis/src/acceptanceTest/java/org/apache/geode/redis/internal/executor/connection/SelectNativeRedisAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.apache.geode.redis.internal.executor.connection;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.rules.TestRule;\n+import org.testcontainers.containers.GenericContainer;\n+import redis.clients.jedis.Jedis;\n+\n+import org.apache.geode.test.junit.rules.IgnoreOnWindowsRule;\n+\n+public class SelectNativeRedisAcceptanceTest extends AbstractSelectIntegrationTest {\n+\n+  // Docker compose does not work on windows in CI. Ignore this test on windows\n+  // Using a RuleChain to make sure we ignore the test before the rule comes into play\n+  @ClassRule\n+  public static TestRule ignoreOnWindowsRule = new IgnoreOnWindowsRule();\n+\n+  private GenericContainer<?> redisContainer;\n+\n+  @Before\n+  public void setUp() {\n+    // starting redis in cluster mode\n+    redisContainer =\n+        new GenericContainer<>(\"grokzen/redis-cluster:5.0.9\")\n+            .withExposedPorts(7000)\n+            .withEnv(\"IP\", \"0.0.0.0\");\n+\n+    redisContainer.start();\n+    jedis = new Jedis(\"localhost\", getPort(), REDIS_CLIENT_TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d691af73f93f201de5280dd880915fbb11d19dc8"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI4ODI2NA==", "bodyText": "Good point. I just changed it to a class level method for setup and teardown of the Redis container so it didn't start a new container before each test.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514288264", "createdAt": "2020-10-29T14:10:43Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/acceptanceTest/java/org/apache/geode/redis/internal/executor/connection/SelectNativeRedisAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.apache.geode.redis.internal.executor.connection;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.rules.TestRule;\n+import org.testcontainers.containers.GenericContainer;\n+import redis.clients.jedis.Jedis;\n+\n+import org.apache.geode.test.junit.rules.IgnoreOnWindowsRule;\n+\n+public class SelectNativeRedisAcceptanceTest extends AbstractSelectIntegrationTest {\n+\n+  // Docker compose does not work on windows in CI. Ignore this test on windows\n+  // Using a RuleChain to make sure we ignore the test before the rule comes into play\n+  @ClassRule\n+  public static TestRule ignoreOnWindowsRule = new IgnoreOnWindowsRule();\n+\n+  private GenericContainer<?> redisContainer;\n+\n+  @Before\n+  public void setUp() {\n+    // starting redis in cluster mode\n+    redisContainer =\n+        new GenericContainer<>(\"grokzen/redis-cluster:5.0.9\")\n+            .withExposedPorts(7000)\n+            .withEnv(\"IP\", \"0.0.0.0\");\n+\n+    redisContainer.start();\n+    jedis = new Jedis(\"localhost\", getPort(), REDIS_CLIENT_TIMEOUT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI1OTAyNQ=="}, "originalCommit": {"oid": "d691af73f93f201de5280dd880915fbb11d19dc8"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMjI3ODY5OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/RedisConstants.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzozNTozN1rOHqcFJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoyNTowNlrOHqpGcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MjMxMQ==", "bodyText": "I'm afraid that this error will be a bit misleading since it mentions cluster mode. I think the invalid DB index is better and we should document the limitation of only supporting DB 0. I do realize that this is a bit inconsistent with how native redis reports things.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514262311", "createdAt": "2020-10-29T13:35:37Z", "author": {"login": "jdeppe-pivotal"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/RedisConstants.java", "diffHunk": "@@ -30,6 +30,8 @@\n   public static final String SERVER_ERROR_MESSAGE =\n       \"The server had an internal error please try again\";\n   public static final String SERVER_ERROR_SHUTDOWN = \"The server is shutting down\";\n+  public static final String ERROR_SELECT_CLUSTER_MODE = \"SELECT is not allowed in cluster mode\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d691af73f93f201de5280dd880915fbb11d19dc8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5MDAyMA==", "bodyText": "I definitely understand what you mean.  I think it would be good for us to discuss this.  There is also an ERR DB index is out of range message Redis returns if the user tries to select a DB that is not 0-15, but is still a long.  We could potentially return that instead.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514290020", "createdAt": "2020-10-29T14:13:02Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/RedisConstants.java", "diffHunk": "@@ -30,6 +30,8 @@\n   public static final String SERVER_ERROR_MESSAGE =\n       \"The server had an internal error please try again\";\n   public static final String SERVER_ERROR_SHUTDOWN = \"The server is shutting down\";\n+  public static final String ERROR_SELECT_CLUSTER_MODE = \"SELECT is not allowed in cluster mode\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MjMxMQ=="}, "originalCommit": {"oid": "d691af73f93f201de5280dd880915fbb11d19dc8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3NTYzNQ==", "bodyText": "After some discussion, we decided to return ERR Only DB 0 supported if anything other than 0 is passed in as a DB index argument.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514475635", "createdAt": "2020-10-29T18:25:06Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/RedisConstants.java", "diffHunk": "@@ -30,6 +30,8 @@\n   public static final String SERVER_ERROR_MESSAGE =\n       \"The server had an internal error please try again\";\n   public static final String SERVER_ERROR_SHUTDOWN = \"The server is shutting down\";\n+  public static final String ERROR_SELECT_CLUSTER_MODE = \"SELECT is not allowed in cluster mode\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MjMxMQ=="}, "originalCommit": {"oid": "d691af73f93f201de5280dd880915fbb11d19dc8"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzYzMjU3OnYy", "diffSide": "RIGHT", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/connection/SelectExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozMDo0OVrOHqpUZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozMDo0OVrOHqpUZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3OTIwNQ==", "bodyText": "I changed this so we are no longer parsing the long and just comparing the string value.  Let me know if you think this is the right approach.", "url": "https://github.com/apache/geode/pull/5682#discussion_r514479205", "createdAt": "2020-10-29T18:30:49Z", "author": {"login": "sabbey37"}, "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/connection/SelectExecutor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+package org.apache.geode.redis.internal.executor.connection;\n+\n+import static org.apache.geode.redis.internal.RedisConstants.ERROR_SELECT;\n+\n+import org.apache.geode.redis.internal.executor.AbstractExecutor;\n+import org.apache.geode.redis.internal.executor.RedisResponse;\n+import org.apache.geode.redis.internal.netty.Command;\n+import org.apache.geode.redis.internal.netty.ExecutionHandlerContext;\n+\n+public class SelectExecutor extends AbstractExecutor {\n+\n+  @Override\n+  public RedisResponse executeCommand(Command command, ExecutionHandlerContext context) {\n+    String dbIndexString = command.getStringKey();\n+\n+    if (!dbIndexString.equals(\"0\")) {\n+      return RedisResponse.error(ERROR_SELECT);\n+    }\n+\n+    return RedisResponse.ok();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1198ec4980f1e6006cff2bf81b3bd6d60eb19380"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4601, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}