{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzU5MTIx", "number": 5256, "title": "GEODE-8217: Deserialize attribute before update and remove.", "bodyText": "When preferDeserializedForm is true we deserialize the previous attributes before update or remove.\nDeprecates preferDeserializedForm since when false it's unclear when you will get serialized or unserialized forms of attributes.", "createdAt": "2020-06-16T17:19:30Z", "url": "https://github.com/apache/geode/pull/5256", "merged": true, "mergeCommit": {"oid": "9cc61bf2c0cb91f1a6b551fef6984214e23730e2"}, "closed": true, "closedAt": "2020-06-25T20:57:18Z", "author": {"login": "pivotal-jbarrett"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuJT8uAFqTQzNjAwNjAwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu1DyLAFqTQzNzg1MTk2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDA2MDA0", "url": "https://github.com/apache/geode/pull/5256#pullrequestreview-436006004", "createdAt": "2020-06-23T17:35:44Z", "commit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozNTo0NFrOGnzoww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozNTo0NFrOGnzoww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MzY2Nw==", "bodyText": "I think the method name does not reflect PreferDeserializedForm. It might be better to be explicit instead of using Deprecated.", "url": "https://github.com/apache/geode/pull/5256#discussion_r444393667", "createdAt": "2020-06-23T17:35:44Z", "author": {"login": "pivotal-eshu"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSession.java", "diffHunk": "@@ -231,6 +236,11 @@ public void setOwner(Object manager) {\n     }\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private void setOwnerDeprecated(DeltaSessionManager sessionManager) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 175}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDYwNDgy", "url": "https://github.com/apache/geode/pull/5256#pullrequestreview-436060482", "createdAt": "2020-06-23T18:46:34Z", "commit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODo0NjozNVrOGn2HJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOToyNjoxOFrOGn3beQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQzNDIxNQ==", "bodyText": "Couple of typos here. Should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444434215", "createdAt": "2020-06-23T18:46:35Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSessionManagerConfiguration.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.modules.session.catalina;\n+\n+/**\n+ * Method used by Catalina XML configuration.\n+ */\n+@SuppressWarnings(\"unused\")\n+interface DeltaSessionManagerConfiguration {\n+\n+  void setRegionName(String regionName);\n+\n+  String getRegionName();\n+\n+  void setEnableLocalCache(boolean enableLocalCache);\n+\n+  boolean getEnableLocalCache();\n+\n+  void setMaxActiveSessions(int maxActiveSessions);\n+\n+  int getMaxActiveSessions();\n+\n+  void setRegionAttributesId(String regionType);\n+\n+  String getRegionAttributesId();\n+\n+  void setEnableGatewayDeltaReplication(boolean enableGatewayDeltaReplication);\n+\n+  boolean getEnableGatewayDeltaReplication();\n+\n+  void setEnableGatewayReplication(boolean enableGatewayReplication);\n+\n+  boolean getEnableGatewayReplication();\n+\n+  void setEnableDebugListener(boolean enableDebugListener);\n+\n+  boolean getEnableDebugListener();\n+\n+  boolean isCommitValveEnabled();\n+\n+  void setEnableCommitValve(boolean enable);\n+\n+  boolean isCommitValveFailfastEnabled();\n+\n+  void setEnableCommitValveFailfast(boolean enable);\n+\n+  boolean isBackingCacheAvailable();\n+\n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.\n+   */\n+  @Deprecated\n+  void setPreferDeserializedForm(boolean enable);\n+\n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ0NTg2NA==", "bodyText": "Typo here, should be \"setPreferDeserializedForm\". Also, tests using this method should probably be renamed, since they state the condition \"WhenPreferSerializedFormFalse\" rather than \"WhenPreferDeserializedFormFalse\". It's also a little misleading as a method name, since setPreferDeserializedForm() with no argument would tend to imply setting the value to true rather than false.", "url": "https://github.com/apache/geode/pull/5256#discussion_r444445864", "createdAt": "2020-06-23T19:07:21Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules-tomcat7/src/test/java/org/apache/geode/modules/session/catalina/DeltaSession7Test.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.modules.session.catalina;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+\n+import javax.servlet.http.HttpSessionAttributeListener;\n+import javax.servlet.http.HttpSessionBindingEvent;\n+\n+import org.apache.catalina.Context;\n+import org.apache.juli.logging.Log;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import org.apache.geode.internal.util.BlobHelper;\n+\n+public class DeltaSession7Test extends AbstractDeltaSessionTest {\n+  final HttpSessionAttributeListener listener = mock(HttpSessionAttributeListener.class);\n+\n+  @Before\n+  @Override\n+  public void setup() {\n+    super.setup();\n+\n+    final Context context = mock(Context.class);\n+    when(manager.getContainer()).thenReturn(context);\n+    when(context.getApplicationEventListeners()).thenReturn(new Object[] {listener});\n+    when(context.getLogger()).thenReturn(mock(Log.class));\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeReplaceEvent() throws IOException {\n+    final DeltaSession7 session = spy(new DeltaSession7(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeRemovedEvent() throws IOException {\n+    final DeltaSession7 session = spy(new DeltaSession7(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeReplaceEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession7 session = spy(new DeltaSession7(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeRemovedEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession7 session = spy(new DeltaSession7(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @SuppressWarnings(\"deprecation\")\n+  protected void setPreferSeserializedForm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ0NjI2Ng==", "bodyText": "See comment on DeltaSession7Test.java regarding this typo and method names.", "url": "https://github.com/apache/geode/pull/5256#discussion_r444446266", "createdAt": "2020-06-23T19:08:09Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules-tomcat8/src/test/java/org/apache/geode/modules/session/catalina/DeltaSession8Test.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.modules.session.catalina;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+\n+import javax.servlet.http.HttpSessionAttributeListener;\n+import javax.servlet.http.HttpSessionBindingEvent;\n+\n+import org.apache.catalina.Context;\n+import org.apache.juli.logging.Log;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import org.apache.geode.internal.util.BlobHelper;\n+\n+public class DeltaSession8Test extends AbstractDeltaSessionTest {\n+  final HttpSessionAttributeListener listener = mock(HttpSessionAttributeListener.class);\n+\n+  @Before\n+  @Override\n+  public void setup() {\n+    super.setup();\n+\n+    final Context context = mock(Context.class);\n+    when(manager.getContext()).thenReturn(context);\n+    when(context.getApplicationEventListeners()).thenReturn(new Object[] {listener});\n+    when(context.getLogger()).thenReturn(mock(Log.class));\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeReplaceEvent() throws IOException {\n+    final DeltaSession8 session = spy(new DeltaSession8(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeRemovedEvent() throws IOException {\n+    final DeltaSession8 session = spy(new DeltaSession8(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeReplaceEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession8 session = spy(new DeltaSession8(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeRemovedEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession8 session = spy(new DeltaSession8(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @SuppressWarnings(\"deprecation\")\n+  protected void setPreferSeserializedForm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ0NjQyOA==", "bodyText": "See comment on DeltaSession7Test.java regarding this typo and method names.", "url": "https://github.com/apache/geode/pull/5256#discussion_r444446428", "createdAt": "2020-06-23T19:08:25Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules-tomcat9/src/test/java/org/apache/geode/modules/session/catalina/DeltaSession9Test.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.modules.session.catalina;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+\n+import javax.servlet.http.HttpSessionAttributeListener;\n+import javax.servlet.http.HttpSessionBindingEvent;\n+\n+import org.apache.catalina.Context;\n+import org.apache.juli.logging.Log;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import org.apache.geode.internal.util.BlobHelper;\n+\n+public class DeltaSession9Test extends AbstractDeltaSessionTest {\n+  final HttpSessionAttributeListener listener = mock(HttpSessionAttributeListener.class);\n+\n+  @Before\n+  @Override\n+  public void setup() {\n+    super.setup();\n+\n+    final Context context = mock(Context.class);\n+    when(manager.getContext()).thenReturn(context);\n+    when(context.getApplicationEventListeners()).thenReturn(new Object[] {listener});\n+    when(context.getLogger()).thenReturn(mock(Log.class));\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeReplaceEvent() throws IOException {\n+    final DeltaSession9 session = spy(new DeltaSession9(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesNotLeakedInAttributeRemovedEvent() throws IOException {\n+    final DeltaSession9 session = spy(new DeltaSession9(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isEqualTo(value1);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeReplaceEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession9 session = spy(new DeltaSession9(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    final Object value2 = \"value2\";\n+    session.setAttribute(name, value2);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeReplaced(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @Test\n+  public void serializedAttributesLeakedInAttributeRemovedEventWhenPreferSerializedFormFalse()\n+      throws IOException {\n+    setPreferSeserializedForm();\n+\n+    final DeltaSession9 session = spy(new DeltaSession9(manager));\n+    session.setValid(true);\n+    final String name = \"attribute\";\n+    final Object value1 = \"value1\";\n+    final byte[] serializedValue1 = BlobHelper.serializeToBlob(value1);\n+    // simulates initial deserialized state with serialized attribute values.\n+    session.getAttributes().put(name, serializedValue1);\n+\n+    session.removeAttribute(name);\n+\n+    final ArgumentCaptor<HttpSessionBindingEvent> event =\n+        ArgumentCaptor.forClass(HttpSessionBindingEvent.class);\n+    verify(listener).attributeRemoved(event.capture());\n+    verifyNoMoreInteractions(listener);\n+    assertThat(event.getValue().getValue()).isInstanceOf(byte[].class);\n+  }\n+\n+  @SuppressWarnings(\"deprecation\")\n+  protected void setPreferSeserializedForm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ0NzQ5OQ==", "bodyText": "Typo here, should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444447499", "createdAt": "2020-06-23T19:10:25Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSession.java", "diffHunk": "@@ -69,17 +71,21 @@\n \n   private final transient Object changeLock = new Object();\n \n-  private final List<DeltaSessionAttributeEvent> eventQueue = new ArrayList<>();\n+  private final ArrayList<DeltaSessionAttributeEvent> eventQueue = new ArrayList<>();\n \n   private transient GatewayDeltaEvent currentGatewayDeltaEvent;\n \n   private transient boolean expired = false;\n \n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ0ODg3Ng==", "bodyText": "Can this commented code be removed?", "url": "https://github.com/apache/geode/pull/5256#discussion_r444448876", "createdAt": "2020-06-23T19:12:51Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSession.java", "diffHunk": "@@ -328,14 +353,14 @@ Object getAttributeWithoutDeserialize(String name) {\n   public void invalidate() {\n     super.invalidate();\n     // getOperatingRegion().destroy(this.id, true); // already done in super (remove)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 276}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1Mzk4Ng==", "bodyText": "While we're here, it might be worth cleaning up uses of this warning suppression using the uncheckedCast() method, as used elsewhere in this change set. There is one cast in this method (line 651) and one on line 633 of getSizeInBytes().", "url": "https://github.com/apache/geode/pull/5256#discussion_r444453986", "createdAt": "2020-06-23T19:22:49Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSession.java", "diffHunk": "@@ -616,7 +642,7 @@ public int getSizeInBytes() {\n     return size;\n   }\n \n-  @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+  @SuppressWarnings({\"unchecked\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 559}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NDM3Mg==", "bodyText": "Typo here, should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444454372", "createdAt": "2020-06-23T19:23:35Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSessionManager.java", "diffHunk": "@@ -107,6 +110,10 @@\n \n   private static final boolean DEFAULT_ENABLE_COMMIT_VALVE_FAILFAST = false;\n \n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NDUxMg==", "bodyText": "Typo here, should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444454512", "createdAt": "2020-06-23T19:23:50Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSessionManager.java", "diffHunk": "@@ -130,6 +137,10 @@\n \n   private boolean enableDebugListener = DEFAULT_ENABLE_DEBUG_LISTENER;\n \n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NTUxMw==", "bodyText": "Typo here, should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444455513", "createdAt": "2020-06-23T19:25:43Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSessionManager.java", "diffHunk": "@@ -213,64 +225,78 @@ public boolean getEnableGatewayDeltaReplication() {\n     return false; // disabled\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableGatewayDeltaReplication(boolean enableGatewayDeltaReplication) {\n     // this.enableGatewayDeltaReplication = enableGatewayDeltaReplication;\n     // Disabled. Keeping the method for backward compatibility.\n   }\n \n   @Override\n   public boolean getEnableGatewayReplication() {\n-    return this.enableGatewayReplication;\n+    return enableGatewayReplication;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableGatewayReplication(boolean enableGatewayReplication) {\n     this.enableGatewayReplication = enableGatewayReplication;\n   }\n \n   @Override\n   public boolean getEnableDebugListener() {\n-    return this.enableDebugListener;\n+    return enableDebugListener;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableDebugListener(boolean enableDebugListener) {\n     this.enableDebugListener = enableDebugListener;\n   }\n \n   @Override\n   public boolean isCommitValveEnabled() {\n-    return this.enableCommitValve;\n+    return enableCommitValve;\n   }\n \n+  @Override\n   public void setEnableCommitValve(boolean enable) {\n-    this.enableCommitValve = enable;\n+    enableCommitValve = enable;\n   }\n \n   @Override\n   public boolean isCommitValveFailfastEnabled() {\n-    return this.enableCommitValveFailfast;\n+    return enableCommitValveFailfast;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableCommitValveFailfast(boolean enable) {\n-    this.enableCommitValveFailfast = enable;\n+    enableCommitValveFailfast = enable;\n   }\n \n   @Override\n   public boolean isBackingCacheAvailable() {\n     return sessionCache.isBackingCacheAvailable();\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 206}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NTgwMQ==", "bodyText": "Typo here, should be \"Always prefer deserialized form.\"", "url": "https://github.com/apache/geode/pull/5256#discussion_r444455801", "createdAt": "2020-06-23T19:26:18Z", "author": {"login": "DonalEvans"}, "path": "extensions/geode-modules/src/main/java/org/apache/geode/modules/session/catalina/DeltaSessionManager.java", "diffHunk": "@@ -213,64 +225,78 @@ public boolean getEnableGatewayDeltaReplication() {\n     return false; // disabled\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableGatewayDeltaReplication(boolean enableGatewayDeltaReplication) {\n     // this.enableGatewayDeltaReplication = enableGatewayDeltaReplication;\n     // Disabled. Keeping the method for backward compatibility.\n   }\n \n   @Override\n   public boolean getEnableGatewayReplication() {\n-    return this.enableGatewayReplication;\n+    return enableGatewayReplication;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableGatewayReplication(boolean enableGatewayReplication) {\n     this.enableGatewayReplication = enableGatewayReplication;\n   }\n \n   @Override\n   public boolean getEnableDebugListener() {\n-    return this.enableDebugListener;\n+    return enableDebugListener;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableDebugListener(boolean enableDebugListener) {\n     this.enableDebugListener = enableDebugListener;\n   }\n \n   @Override\n   public boolean isCommitValveEnabled() {\n-    return this.enableCommitValve;\n+    return enableCommitValve;\n   }\n \n+  @Override\n   public void setEnableCommitValve(boolean enable) {\n-    this.enableCommitValve = enable;\n+    enableCommitValve = enable;\n   }\n \n   @Override\n   public boolean isCommitValveFailfastEnabled() {\n-    return this.enableCommitValveFailfast;\n+    return enableCommitValveFailfast;\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  @Override\n   public void setEnableCommitValveFailfast(boolean enable) {\n-    this.enableCommitValveFailfast = enable;\n+    enableCommitValveFailfast = enable;\n   }\n \n   @Override\n   public boolean isBackingCacheAvailable() {\n     return sessionCache.isBackingCacheAvailable();\n   }\n \n-  @SuppressWarnings(\"unused\")\n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.\n+   */\n+  @Deprecated\n+  @Override\n   public void setPreferDeserializedForm(boolean enable) {\n-    this.preferDeserializedForm = enable;\n+    log.warn(\"Use of deprecated preferDeserializedForm property to be removed in future release.\");\n+    if (!enable) {\n+      log.warn(\n+          \"Use of HttpSessionAttributeListener may result in serialized form in HttpSessionBindingEvent.\");\n+    }\n+    preferDeserializedForm = enable;\n   }\n \n+  /**\n+   * @deprecated No replacement. Always refer deserialized form.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e2b66b338ac7013658ee6fc64728f940808cae3"}, "originalPosition": 221}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTg3Njgz", "url": "https://github.com/apache/geode/pull/5256#pullrequestreview-436187683", "createdAt": "2020-06-23T21:57:31Z", "commit": {"oid": "186bf85298b3606d1dff4d58c4673dd05859f1c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8f23deefdf4497e6d7b4d20350fab444ab3dddd", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/a8f23deefdf4497e6d7b4d20350fab444ab3dddd", "committedDate": "2020-06-25T17:56:58Z", "message": "GEODE-8217: Extracts common test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f9088b8f59003cf3a23aa1f0135b8591e78d011", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/9f9088b8f59003cf3a23aa1f0135b8591e78d011", "committedDate": "2020-06-25T17:56:58Z", "message": "GEODE-8217: Deserialize attribute before update and remove."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c4c8932ebbc9e2bf389303ba7594a941bd72cc", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/00c4c8932ebbc9e2bf389303ba7594a941bd72cc", "committedDate": "2020-06-25T17:58:46Z", "message": "Test for preferring serialized form."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32af6c40cafcbf5f5629431dc59d9a8350bda3d4", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/32af6c40cafcbf5f5629431dc59d9a8350bda3d4", "committedDate": "2020-06-25T17:59:25Z", "message": "Cleanup\n\nCleanup\n\nCleanup\n\nCleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e644b29eb538bb023e07433eb2f1967d75e4e96", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/1e644b29eb538bb023e07433eb2f1967d75e4e96", "committedDate": "2020-06-25T17:59:25Z", "message": "Deprecate preferDeserializedForm."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80d10488ec710d5d09e48a68b03017b6cd756ba1", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/80d10488ec710d5d09e48a68b03017b6cd756ba1", "committedDate": "2020-06-25T17:59:25Z", "message": "Extends tests to Tomcat 7, 8 and 9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35881788795d19f9b14bd5a8f01235394d049230", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/35881788795d19f9b14bd5a8f01235394d049230", "committedDate": "2020-06-25T17:59:25Z", "message": "Fixes spelling error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f89c0bf1fe7b39b3806787aaf1a5553aa05392d1", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/f89c0bf1fe7b39b3806787aaf1a5553aa05392d1", "committedDate": "2020-06-25T17:59:25Z", "message": "Correct confusing mix of terms."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87259d6d71a148aba54bcbbca2a82b498f78048f", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/87259d6d71a148aba54bcbbca2a82b498f78048f", "committedDate": "2020-06-25T17:59:25Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "611e73f538ad77bfa20f4e0edd570f8cf9108d20", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/611e73f538ad77bfa20f4e0edd570f8cf9108d20", "committedDate": "2020-06-25T17:59:25Z", "message": "Fixes leak on invalidate/expire."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98f8884520e51aee5c0039a8fb364a6f83453eaf", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/98f8884520e51aee5c0039a8fb364a6f83453eaf", "committedDate": "2020-06-25T17:59:25Z", "message": "Adds Eric's system test."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7feac1a1abb29d54d1f604fb382e6734dbd0d7e6", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/7feac1a1abb29d54d1f604fb382e6734dbd0d7e6", "committedDate": "2020-06-25T17:48:50Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/GEODE-8217"}, "afterCommit": {"oid": "98f8884520e51aee5c0039a8fb364a6f83453eaf", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/98f8884520e51aee5c0039a8fb364a6f83453eaf", "committedDate": "2020-06-25T17:59:25Z", "message": "Adds Eric's system test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "374d4d2302b06ee6fd811f528aa2854aa94bdfe7", "author": {"user": {"login": "pivotal-jbarrett", "name": "Jacob Barrett"}}, "url": "https://github.com/apache/geode/commit/374d4d2302b06ee6fd811f528aa2854aa94bdfe7", "committedDate": "2020-06-25T18:22:57Z", "message": "Rat!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODUxOTY2", "url": "https://github.com/apache/geode/pull/5256#pullrequestreview-437851966", "createdAt": "2020-06-25T20:55:42Z", "commit": {"oid": "374d4d2302b06ee6fd811f528aa2854aa94bdfe7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4473, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}