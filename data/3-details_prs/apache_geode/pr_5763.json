{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjM1MTE4", "number": 5763, "title": "GEODE-8521: detect if a p2p reader thread is hung", "bodyText": "Each p2p reader thread now creates a single instance of AbstractExecutor\nand registers it with the ThreadsMonitoring instance while it is \"dispatching\"\nthe message. It will not be monitored while it is waiting on the socket to read\na message. So this will only report stuck p2p readers that are stuck dispatch\nwhich for inline processing includes processing the message and reading the\ndirect ack.\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-11-19T21:13:09Z", "url": "https://github.com/apache/geode/pull/5763", "merged": true, "mergeCommit": {"oid": "e26d75956bbf12d04c6fab1d6d08b6ce5f58ec25"}, "closed": true, "closedAt": "2020-12-04T01:46:21Z", "author": {"login": "dschneider-pivotal"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddzEmGgH2gAyNTI0MjM1MTE4OmQ4OGM2OWIxMGQ3MzQ4ZmIxZGU4NTVjMDRkZjRkZjhjYTA5YzE3NWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiqnLcAH2gAyNTI0MjM1MTE4OmJjZTVjZDc1YTJlNmZmMjBhYWMxZDAyOTg2ODM4NDU2ZmY4YTZlYjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d88c69b10d7348fb1de855c04df4df8ca09c175b", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/d88c69b10d7348fb1de855c04df4df8ca09c175b", "committedDate": "2020-11-18T19:11:13Z", "message": "minor cleanup of thread monitoring code:\n  -- made some fields final\n  -- removed unused parameters\n  -- marked some methods visible for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90dc93e091b331dd20b90f62a5393cced9d52b33", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/90dc93e091b331dd20b90f62a5393cced9d52b33", "committedDate": "2020-11-18T21:50:39Z", "message": "added createAbstractExecutor, startMonitoring, and stopMonitoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fa49c13267c332d4700fedba3ce501aac1765ca", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/7fa49c13267c332d4700fedba3ce501aac1765ca", "committedDate": "2020-11-19T19:05:18Z", "message": "Merge branch 'develop' into GEODE-8521"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68bcf2f840b86052dff0d42011da9b149eab1475", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/68bcf2f840b86052dff0d42011da9b149eab1475", "committedDate": "2020-11-19T21:03:05Z", "message": "p2p reader threads are now monitored while processing a message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "851268ecf5cf65dd9943b817fc399d681d3d6147", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/851268ecf5cf65dd9943b817fc399d681d3d6147", "committedDate": "2020-11-19T22:11:08Z", "message": "fixed ConnectionTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c7ac0761806f6e2542c538f3f886820a50a30b", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/36c7ac0761806f6e2542c538f3f886820a50a30b", "committedDate": "2020-11-20T00:03:21Z", "message": "force rebuild"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTcwODc5", "url": "https://github.com/apache/geode/pull/5763#pullrequestreview-535570879", "createdAt": "2020-11-20T16:18:22Z", "commit": {"oid": "36c7ac0761806f6e2542c538f3f886820a50a30b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNjoxODoyM1rOH3WbJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNjoxODoyM1rOH3WbJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTEyNw==", "bodyText": "I'm a little concerned about the impact of taking yet another millisecond clock reading on every message that we dispatch.  This should be run through extensive performance testing before merging it to develop.", "url": "https://github.com/apache/geode/pull/5763#discussion_r527801127", "createdAt": "2020-11-20T16:18:23Z", "author": {"login": "bschuchardt"}, "path": "geode-core/src/main/java/org/apache/geode/internal/monitoring/ThreadsMonitoringImpl.java", "diffHunk": "@@ -96,39 +98,60 @@ public void updateThreadStatus() {\n \n   @Override\n   public boolean startMonitor(Mode mode) {\n-    AbstractExecutor absExtgroup;\n+    return startMonitoring(createAbstractExecutor(mode));\n+  }\n+\n+  @Override\n+  public void endMonitor() {\n+    this.monitorMap.remove(Thread.currentThread().getId());\n+  }\n+\n+  @VisibleForTesting\n+  boolean isMonitoring() {\n+    return monitorMap.containsKey(Thread.currentThread().getId());\n+  }\n+\n+  @Override\n+  public AbstractExecutor createAbstractExecutor(Mode mode) {\n     switch (mode) {\n       case FunctionExecutor:\n-        absExtgroup = new FunctionExecutionPooledExecutorGroup(this);\n-        break;\n+        return new FunctionExecutionPooledExecutorGroup();\n       case PooledExecutor:\n-        absExtgroup = new PooledExecutorGroup(this);\n-        break;\n+        return new PooledExecutorGroup();\n       case SerialQueuedExecutor:\n-        absExtgroup = new SerialQueuedExecutorGroup(this);\n-        break;\n+        return new SerialQueuedExecutorGroup();\n       case OneTaskOnlyExecutor:\n-        absExtgroup = new OneTaskOnlyExecutorGroup(this);\n-        break;\n+        return new OneTaskOnlyExecutorGroup();\n       case ScheduledThreadExecutor:\n-        absExtgroup = new ScheduledThreadPoolExecutorWKAGroup(this);\n-        break;\n+        return new ScheduledThreadPoolExecutorWKAGroup();\n       case AGSExecutor:\n-        absExtgroup = new GatewaySenderEventProcessorGroup(this);\n-        break;\n+        return new GatewaySenderEventProcessorGroup();\n+      case P2PReaderExecutor:\n+        return new P2PReaderExecutorGroup();\n       default:\n-        return false;\n+        throw new IllegalStateException(\"Unhandled mode=\" + mode);\n     }\n-    this.monitorMap.put(Thread.currentThread().getId(), absExtgroup);\n+  }\n+\n+  @Override\n+  public boolean startMonitoring(AbstractExecutor executor) {\n+    executor.setStartTime(System.currentTimeMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36c7ac0761806f6e2542c538f3f886820a50a30b"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b811a67f2a5e9dee1b8490d5f329a06ddd48e816", "author": {"user": null}, "url": "https://github.com/apache/geode/commit/b811a67f2a5e9dee1b8490d5f329a06ddd48e816", "committedDate": "2020-11-20T20:58:29Z", "message": "AbstractExecutor can now be suspended and resumed.\nThis does nothing on the base class but on P2PReaderExecutorGroup\nit turns monitoring on and off.\nAlso the monitor thread will now detect a zero startTime\nand in that case set the startTime allowing threads being\nmonitored to not keep setting it themselves (which happens more often)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3fe7aa5e41efad318e5703e62a38e466066a28b", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/c3fe7aa5e41efad318e5703e62a38e466066a28b", "committedDate": "2020-11-20T21:57:34Z", "message": "added integration test coverage for suspend and resume"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5300197fae8574a05d3277e72468b4b5667128a6", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/5300197fae8574a05d3277e72468b4b5667128a6", "committedDate": "2020-11-20T22:41:00Z", "message": "1. the timeInterval and timeLimit that come from gemfire properties\nwill now always be the values configured on the DistributedSystem.\nPreviously the thread monitoring classes had their own instance of\nDistributionConfigImpl which at least in some cases could be inconsistent\nthe the config on the DistributedSystem. Now these two config values\nare passed in to the constructor.\n2. If an instance of ResourceManagerStats can not be found then\nit will now only prevent the monitor from updating the \"numThreadsStuck\"\nstat. Before it prevented it from doing any detection and logging.\nThe lazy initialization of the ResourceManagerStats is now cleaner and does\nnot require the integration test to explicitly call run()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/23d4ee647cfd70db6de82317e0471775373889a1", "committedDate": "2020-11-20T23:11:17Z", "message": "fixed ConnectionTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODIzMzQ5", "url": "https://github.com/apache/geode/pull/5763#pullrequestreview-536823349", "createdAt": "2020-11-23T20:32:16Z", "commit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDc2NzYw", "url": "https://github.com/apache/geode/pull/5763#pullrequestreview-541076760", "createdAt": "2020-11-30T16:27:29Z", "commit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTI0MDQ5", "url": "https://github.com/apache/geode/pull/5763#pullrequestreview-541124049", "createdAt": "2020-11-30T17:17:36Z", "commit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoxNzozNlrOH8FUxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyMjowOFrOH8Fg2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2Mzg0Nw==", "bodyText": "What unit is timeLimit? I recommend either adding a TimeUnit parameter or renaming timeLimit to include Millis or something as a prefix.", "url": "https://github.com/apache/geode/pull/5763#discussion_r532763847", "createdAt": "2020-11-30T17:17:36Z", "author": {"login": "kirklund"}, "path": "geode-core/src/main/java/org/apache/geode/internal/monitoring/ThreadsMonitoringProcess.java", "diffHunk": "@@ -33,73 +31,86 @@\n \n public class ThreadsMonitoringProcess extends TimerTask {\n \n-  private final ThreadsMonitoring threadsMonitoring;\n-  private ResourceManagerStats resourceManagerStats = null;\n   private static final Logger logger = LogService.getLogger();\n+\n+  private final ThreadsMonitoring threadsMonitoring;\n   private final int timeLimit;\n   private final InternalDistributedSystem internalDistributedSystem;\n \n-  private final Properties nonDefault = new Properties();\n-  private final DistributionConfigImpl distributionConfigImpl =\n-      new DistributionConfigImpl(nonDefault);\n+  private ResourceManagerStats resourceManagerStats = null;\n \n   protected ThreadsMonitoringProcess(ThreadsMonitoring tMonitoring,\n-      InternalDistributedSystem iDistributedSystem) {\n-    this.timeLimit = this.distributionConfigImpl.getThreadMonitorTimeLimit();\n+      InternalDistributedSystem iDistributedSystem, int timeLimit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NTcyOA==", "bodyText": "Please indicate the units of measure in the name or an additional parameter.", "url": "https://github.com/apache/geode/pull/5763#discussion_r532765728", "createdAt": "2020-11-30T17:20:22Z", "author": {"login": "kirklund"}, "path": "geode-core/src/test/java/org/apache/geode/internal/monitoring/ThreadsMonitoringProcessJUnitTest.java", "diffHunk": "@@ -34,11 +31,13 @@\n  */\n public class ThreadsMonitoringProcessJUnitTest {\n \n+  private static final int TIME_LIMIT = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NjkzNg==", "bodyText": "I recommend just naming unit tests as P2PReaderExecutorGroupTest (no need to include JUnit)", "url": "https://github.com/apache/geode/pull/5763#discussion_r532766936", "createdAt": "2020-11-30T17:22:08Z", "author": {"login": "kirklund"}, "path": "geode-core/src/test/java/org/apache/geode/internal/monitoring/executor/P2PReaderExecutorGroupJUnitTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.monitoring.executor;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.Test;\n+\n+public class P2PReaderExecutorGroupJUnitTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d4ee647cfd70db6de82317e0471775373889a1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09e06edbaeb63aa5bf3ec88142913453998beb63", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/09e06edbaeb63aa5bf3ec88142913453998beb63", "committedDate": "2020-11-30T21:49:43Z", "message": "renamed P2PReaderExecutorGroupJUnitTest to P2PReaderExecutorGroupTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b165404628c78bafb610b0db64409a3a41b4f15", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/9b165404628c78bafb610b0db64409a3a41b4f15", "committedDate": "2020-11-30T21:56:48Z", "message": "added \"Millis\" time unit designator to names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a10707cfc4bac8f7665d287578027c8cd601290", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/4a10707cfc4bac8f7665d287578027c8cd601290", "committedDate": "2020-11-30T22:13:15Z", "message": "Merge branch 'develop' into GEODE-8521"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9372b03f36d5b723fee70342cfb0d8c702ca8a", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/8f9372b03f36d5b723fee70342cfb0d8c702ca8a", "committedDate": "2020-11-30T22:32:30Z", "message": "split unit test method into two methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8c3e1a51067721f1564f36b0cf66680ff3ac311", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/d8c3e1a51067721f1564f36b0cf66680ff3ac311", "committedDate": "2020-11-30T23:05:09Z", "message": "fixed flaky ThreadsMonitoringImplJUnitTest which would fail\nsometimes due to it creating a background thread that could\ninterfere with unit testing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzgzOTgw", "url": "https://github.com/apache/geode/pull/5763#pullrequestreview-541383980", "createdAt": "2020-11-30T23:46:18Z", "commit": {"oid": "d8c3e1a51067721f1564f36b0cf66680ff3ac311"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf7e2cc297b65b487de82c4d109b6add42ad3a57", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/cf7e2cc297b65b487de82c4d109b6add42ad3a57", "committedDate": "2020-12-01T01:15:56Z", "message": "Merge branch 'develop' into GEODE-8521"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "998359387e1df4775a75f4f1039a16b3547ff771", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/998359387e1df4775a75f4f1039a16b3547ff771", "committedDate": "2020-12-01T17:23:35Z", "message": "removed some unneeded explicit \"this\" references"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d3882b180bfe9c2d77775fa52a703fd8487616", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/38d3882b180bfe9c2d77775fa52a703fd8487616", "committedDate": "2020-12-01T17:24:21Z", "message": "Merge branch 'develop' into GEODE-8521"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce5cd75a2e6ff20aac1d02986838456ff8a6eb9", "author": {"user": {"login": "dschneider-pivotal", "name": "Darrel Schneider"}}, "url": "https://github.com/apache/geode/commit/bce5cd75a2e6ff20aac1d02986838456ff8a6eb9", "committedDate": "2020-12-03T22:09:28Z", "message": "Merge branch 'develop' into GEODE-8521"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3892, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}