{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MDU5ODEw", "number": 5821, "title": "GEODE-8745: Handle race between batch destroy msg and sec event.", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-12-08T01:43:36Z", "url": "https://github.com/apache/geode/pull/5821", "merged": true, "mergeCommit": {"oid": "ccb032e0feaf04fe5e39dfc27f2888ab72fedb82"}, "closed": true, "closedAt": "2020-12-09T23:28:26Z", "author": {"login": "nabarunnag"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkEqSTgBqjQwODMyMDc2Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkmJSpgFqTU0ODY0OTUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7a61c36c388425426ba63bdb0c14bf7e3b1453f", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/e7a61c36c388425426ba63bdb0c14bf7e3b1453f", "committedDate": "2020-12-08T01:39:46Z", "message": "GEODE-8745: Fixing the flaky tests."}, "afterCommit": {"oid": "6ed0c93e122d081ef2549333f7bd26a5b3d6d50a", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/6ed0c93e122d081ef2549333f7bd26a5b3d6d50a", "committedDate": "2020-12-08T07:03:52Z", "message": "GEODE-8745: Fixing the flaky tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTk2NDY3", "url": "https://github.com/apache/geode/pull/5821#pullrequestreview-547596467", "createdAt": "2020-12-08T20:18:47Z", "commit": {"oid": "6ed0c93e122d081ef2549333f7bd26a5b3d6d50a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoxODo0OFrOIB0XEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoxODo0OFrOIB0XEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3NzM2MQ==", "bodyText": "Refer line#1035", "url": "https://github.com/apache/geode/pull/5821#discussion_r538777361", "createdAt": "2020-12-08T20:18:48Z", "author": {"login": "nabarunnag"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/AbstractGatewaySender.java", "diffHunk": "@@ -1068,8 +1068,8 @@ public void distribute(EnumListenerEvent operation, EntryEventImpl event,\n           if (isDebugEnabled) {\n             logger.debug(\"Returning back without putting into the gateway sender queue:\" + event);\n           }\n-          if (this.eventProcessor != null) {\n-            this.eventProcessor.registerEventDroppedInPrimaryQueue(event);\n+          if (this.eventProcessor != null && this.isPrimary()) {\n+            recordDroppedEvent(clonedEvent);\n           }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ed0c93e122d081ef2549333f7bd26a5b3d6d50a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/a5953baa6de17ff13d1342b60559f15a7b3a952b", "committedDate": "2020-12-09T06:10:17Z", "message": "GEODE-8745: Handle race between batch destroy msg and sec event.\n\n   * Primary serial sender receives an event but the sender is not running yet. Hence it has to drop the event.\n   * Primary has to inform the secondary to remove the event from the unprocessedEventsMap.\n   * It has to do that because the event is dropped and the cache listener on the secondary queue will not be triggered to remove it.\n   * Hence, the primary sends BatchDestroyOperation to the secondary with the tail key set to -1 to trigger removal from unprocessedEventMap.\n   * There is a race in which the BatchDestroyOperation arrives before the secondary event.\n   * In this case the event is never removed from the unprocessedEventsMap.\n   * In this fix, if this happens the event ID is placed in the unprocessedTokensMap.\n   * So, when the secondary event arrives, it checks the unprocessedTokensMap and then realizes that the primary has seen the event and there is no need to place the event in the unprocessedEventsMap."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ed0c93e122d081ef2549333f7bd26a5b3d6d50a", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/6ed0c93e122d081ef2549333f7bd26a5b3d6d50a", "committedDate": "2020-12-08T07:03:52Z", "message": "GEODE-8745: Fixing the flaky tests."}, "afterCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/a5953baa6de17ff13d1342b60559f15a7b3a952b", "committedDate": "2020-12-09T06:10:17Z", "message": "GEODE-8745: Handle race between batch destroy msg and sec event.\n\n   * Primary serial sender receives an event but the sender is not running yet. Hence it has to drop the event.\n   * Primary has to inform the secondary to remove the event from the unprocessedEventsMap.\n   * It has to do that because the event is dropped and the cache listener on the secondary queue will not be triggered to remove it.\n   * Hence, the primary sends BatchDestroyOperation to the secondary with the tail key set to -1 to trigger removal from unprocessedEventMap.\n   * There is a race in which the BatchDestroyOperation arrives before the secondary event.\n   * In this case the event is never removed from the unprocessedEventsMap.\n   * In this fix, if this happens the event ID is placed in the unprocessedTokensMap.\n   * So, when the secondary event arrives, it checks the unprocessedTokensMap and then realizes that the primary has seen the event and there is no need to place the event in the unprocessedEventsMap."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDA0ODE5", "url": "https://github.com/apache/geode/pull/5821#pullrequestreview-548004819", "createdAt": "2020-12-09T09:45:26Z", "commit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwOTo0NToyNlrOICLlqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwOTo0NToyNlrOICLlqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1NzkzMA==", "bodyText": "Same logic as in basicHandlePrimaryEntry", "url": "https://github.com/apache/geode/pull/5821#discussion_r539157930", "createdAt": "2020-12-09T09:45:26Z", "author": {"login": "nabarunnag"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/serial/SerialGatewaySenderEventProcessor.java", "diffHunk": "@@ -638,6 +639,17 @@ protected boolean basicHandlePrimaryDestroy(final EventID eventId) {\n         ew.event.release();\n         statistics.incUnprocessedEventsRemovedByPrimary();\n         return true;\n+      } else if (addToUnprocessedTokens) {\n+        // Secondary event may not have arrived\n+        Long mapValue =\n+            Long.valueOf(System.currentTimeMillis() + AbstractGatewaySender.TOKEN_TIMEOUT);\n+        Long oldv = this.unprocessedTokens.put(eventId, mapValue);\n+        if (oldv == null) {\n+          statistics.incUnprocessedTokensAddedByPrimary();\n+        } else {\n+          // its ok for oldv to be non-null\n+          // this shouldn't happen anymore @todo add an assertion here\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTE1Mjg1", "url": "https://github.com/apache/geode/pull/5821#pullrequestreview-548515285", "createdAt": "2020-12-09T19:03:42Z", "commit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTowMzo0MlrOICksMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOToyMjo0M1rOIClcTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2OTIwMw==", "bodyText": "This empty block can probably be replaced with just a comment.", "url": "https://github.com/apache/geode/pull/5821#discussion_r539569203", "createdAt": "2020-12-09T19:03:42Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/serial/SerialGatewaySenderEventProcessor.java", "diffHunk": "@@ -638,6 +639,17 @@ protected boolean basicHandlePrimaryDestroy(final EventID eventId) {\n         ew.event.release();\n         statistics.incUnprocessedEventsRemovedByPrimary();\n         return true;\n+      } else if (addToUnprocessedTokens) {\n+        // Secondary event may not have arrived\n+        Long mapValue =\n+            Long.valueOf(System.currentTimeMillis() + AbstractGatewaySender.TOKEN_TIMEOUT);\n+        Long oldv = this.unprocessedTokens.put(eventId, mapValue);\n+        if (oldv == null) {\n+          statistics.incUnprocessedTokensAddedByPrimary();\n+        } else {\n+          // its ok for oldv to be non-null\n+          // this shouldn't happen anymore @todo add an assertion here\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2OTI5Nw==", "bodyText": "This can just be Long mapValue = System.currentTimeMillis() + AbstractGatewaySender.TOKEN_TIMEOUT;", "url": "https://github.com/apache/geode/pull/5821#discussion_r539569297", "createdAt": "2020-12-09T19:03:52Z", "author": {"login": "DonalEvans"}, "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/serial/SerialGatewaySenderEventProcessor.java", "diffHunk": "@@ -638,6 +639,17 @@ protected boolean basicHandlePrimaryDestroy(final EventID eventId) {\n         ew.event.release();\n         statistics.incUnprocessedEventsRemovedByPrimary();\n         return true;\n+      } else if (addToUnprocessedTokens) {\n+        // Secondary event may not have arrived\n+        Long mapValue =\n+            Long.valueOf(System.currentTimeMillis() + AbstractGatewaySender.TOKEN_TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU3MTc5MA==", "bodyText": "These variables are never used, so I think it should be okay to change these to just\nvm4.invoke(\"Creating DS\", () -> WANTestBase.createSenderWithDiskStore(\"ln\", 2, false, 100, 10, \nfalse, true, null, null, true));\nvm5.invoke(\"Creating DS\", () -> WANTestBase.createSenderWithDiskStore(\"ln\", 2, false, 100, 10, \nfalse, true, null, null, true));", "url": "https://github.com/apache/geode/pull/5821#discussion_r539571790", "createdAt": "2020-12-09T19:07:42Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/serial/SerialWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -577,17 +577,15 @@ public void testReplicatedRegionPersistentWanGateway_restartSenderWithCleanQueue\n     Integer nyPort = (Integer) vm1.invoke(() -> WANTestBase.createFirstRemoteLocator(2, lnPort));\n \n     createCacheInVMs(nyPort, vm2, vm3);\n-    createReceiverInVMs(vm2, vm3);\n \n     createCacheInVMs(lnPort, vm4, vm5, vm6, vm7);\n \n-    String firstDStore = (String) vm4.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n-        false, 100, 10, false, true, null, null, true));\n-    String secondDStore = (String) vm5.invoke(() -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n-        false, 100, 10, false, true, null, null, true));\n-\n-    logger.info(\"The first ds is \" + firstDStore);\n-    logger.info(\"The second ds is \" + secondDStore);\n+    String firstDStore =\n+        (String) vm4.invoke(\"Creating DS\", () -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+            false, 100, 10, false, true, null, null, true));\n+    String secondDStore =\n+        (String) vm5.invoke(\"Creating DS\", () -> WANTestBase.createSenderWithDiskStore(\"ln\", 2,\n+            false, 100, 10, false, true, null, null, true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4MTUxOQ==", "bodyText": "The compiler warning here can be fixed by using AsyncInvocation<?> inv1.", "url": "https://github.com/apache/geode/pull/5821#discussion_r539581519", "createdAt": "2020-12-09T19:22:43Z", "author": {"login": "DonalEvans"}, "path": "geode-wan/src/distributedTest/java/org/apache/geode/internal/cache/wan/serial/SerialWANPersistenceEnabledGatewaySenderDUnitTest.java", "diffHunk": "@@ -605,26 +603,21 @@ public void testReplicatedRegionPersistentWanGateway_restartSenderWithCleanQueue\n     vm7.invoke(() -> WANTestBase.createPersistentReplicatedRegion(getTestMethodName() + \"_RR\", \"ln\",\n         isOffHeap()));\n \n-    vm4.invoke(() -> WANTestBase.pauseSender(\"ln\"));\n-    vm5.invoke(() -> WANTestBase.pauseSender(\"ln\"));\n-\n-    vm4.invoke(() -> WANTestBase.doPuts(getTestMethodName() + \"_RR\", 1000));\n-\n-    logger.info(\"Completed puts in the region\");\n+    vm4.invoke(\"Puts in the region\" + getTestMethodName() + \"_RR\",\n+        () -> WANTestBase.doPuts(getTestMethodName() + \"_RR\", 1000));\n \n-    vm4.invoke(() -> WANTestBase.stopSender(\"ln\"));\n-    vm5.invoke(() -> WANTestBase.stopSender(\"ln\"));\n \n+    vm4.invoke(\"Stopping ln sender\", () -> WANTestBase.stopSender(\"ln\"));\n+    vm5.invoke(\"Stopping ln sender\", () -> WANTestBase.stopSender(\"ln\"));\n \n-    logger.info(\"Stopped all the senders. \");\n-\n-    AsyncInvocation inv1 = vm4.invokeAsync(() -> WANTestBase.startSenderwithCleanQueues(\"ln\"));\n-    logger.info(\"Started the sender in vm 4\");\n+    createReceiverInVMs(vm2, vm3);\n \n-    vm5.invoke(() -> WANTestBase.startSenderwithCleanQueues(\"ln\"));\n-    logger.info(\"Started the sender in vm 5\");\n+    AsyncInvocation inv1 = vm4.invokeAsync(\"Starting sender with clean queues\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5953baa6de17ff13d1342b60559f15a7b3a952b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19fcd34b2917a5129e1607fe851b86dbbd62d721", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/19fcd34b2917a5129e1607fe851b86dbbd62d721", "committedDate": "2020-12-09T20:38:46Z", "message": "GEODE-8745: Resolving review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3d58a575bf2964a106264ba27f06e01ffbe624a", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/a3d58a575bf2964a106264ba27f06e01ffbe624a", "committedDate": "2020-12-09T20:32:14Z", "message": "GEODE-8745: Resolving review comments"}, "afterCommit": {"oid": "19fcd34b2917a5129e1607fe851b86dbbd62d721", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/19fcd34b2917a5129e1607fe851b86dbbd62d721", "committedDate": "2020-12-09T20:38:46Z", "message": "GEODE-8745: Resolving review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjQ5NTMw", "url": "https://github.com/apache/geode/pull/5821#pullrequestreview-548649530", "createdAt": "2020-12-09T22:05:03Z", "commit": {"oid": "19fcd34b2917a5129e1607fe851b86dbbd62d721"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3932, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}