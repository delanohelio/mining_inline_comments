{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1Mzg0MTU4", "number": 5189, "title": "GEODE-7669 Test coverage for Partitioned Region clear with Overflow enabled", "bodyText": "Thank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-05-30T00:21:12Z", "url": "https://github.com/apache/geode/pull/5189", "merged": true, "mergeCommit": {"oid": "ea51fc0e9a0cad2f5ec8d9b648845c5d84573f41"}, "closed": true, "closedAt": "2020-06-04T18:39:05Z", "author": {"login": "jchen21"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgUogMAH2gAyNDI1Mzg0MTU4OjdhZDExOTBkOGNhNTE0YzEyYWY3MDc2YzY1NmVmZGY5MjhkMmNlZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoCDVHAFqTQyNDcwMTAzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7ad1190d8ca514c12af7076c656efdf928d2cefd", "author": {"user": {"login": "gesterzhou", "name": "Xiaojian Zhou"}}, "url": "https://github.com/apache/geode/commit/7ad1190d8ca514c12af7076c656efdf928d2cefd", "committedDate": "2020-05-11T19:14:00Z", "message": "GEODE-7683: introduce BR.cmnClearRegion\n\nCo-authored-by: Xiaojian Zhou <gzhou@pivotal.io>\n\nGEODE-7684: Create messaging class for PR Clear (#4689)\n\n* Added new message class and test\n\nCo-authored-by: Benjamin Ross <bross@pivotal.io>\nCo-authored-by: Donal Evans <doevans@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "362bad56e45f3e984425d76be0fe8c38c14f80aa", "author": {"user": {"login": "gesterzhou", "name": "Xiaojian Zhou"}}, "url": "https://github.com/apache/geode/commit/362bad56e45f3e984425d76be0fe8c38c14f80aa", "committedDate": "2020-05-11T19:14:01Z", "message": "GEODE-7682: add PR.clear  API (#4755)\n\n* GEODE-7683: introduce BR.cmnClearRegion\r\n\r\nCo-authored-by: Xiaojian Zhou <gzhou@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc38e50724fbb751a6294cae5c4ca3439dfdbee3", "author": {"user": {"login": "gesterzhou", "name": "Xiaojian Zhou"}}, "url": "https://github.com/apache/geode/commit/bc38e50724fbb751a6294cae5c4ca3439dfdbee3", "committedDate": "2020-05-11T19:15:22Z", "message": "PR.clear's event id should be created and used in BR (#4805)\n\n* GEODE-7857: PR.clear's event id should be created and used in BR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eae78e7d7ef62875f200d5edb776cc3373eba9f", "author": {"user": {"login": "gesterzhou", "name": "Xiaojian Zhou"}}, "url": "https://github.com/apache/geode/commit/3eae78e7d7ef62875f200d5edb776cc3373eba9f", "committedDate": "2020-05-11T19:15:22Z", "message": "GEODE-7912: cacheWriter should be triggered when PR.clear (#4882)\n\n\r\n        Co-authored-by: Anil <agingade@pivotal.io>\r\n        Co-authored-by: Xiaojian Zhou <gzhou@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f61c16adaac19b0ab664b4ca27a1d0b71cf4537e", "author": {"user": {"login": "gesterzhou", "name": "Xiaojian Zhou"}}, "url": "https://github.com/apache/geode/commit/f61c16adaac19b0ab664b4ca27a1d0b71cf4537e", "committedDate": "2020-05-11T19:15:22Z", "message": "GEODE-7983: Clear region writer callbacks should not be invoked for bucket regions (#4954)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ea87378250c4444b420b389a1ae8a4b83cd40c0", "author": {"user": {"login": "jujoramos", "name": "Juan Jos\u00e9 Ramos"}}, "url": "https://github.com/apache/geode/commit/0ea87378250c4444b420b389a1ae8a4b83cd40c0", "committedDate": "2020-05-11T19:15:59Z", "message": "GEODE-7676: Add PR clear with expiration tests (#4970)\n\nAdded distributed tests to verify the clear operation on Partitioned\r\nRegions works as expected when expiration is configured.\r\n\r\n- Added unit and distributed tests.\r\n- Fixed LocalRegion class to clear the entryExpiryTasks Map whenever\r\n  the cancelAllEntryExpiryTasks method is invoked."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10831981722b2c74e8db2899306b8a02c8435e1e", "author": {"user": {"login": "BenjaminPerryRoss", "name": null}}, "url": "https://github.com/apache/geode/commit/10831981722b2c74e8db2899306b8a02c8435e1e", "committedDate": "2020-05-11T19:16:33Z", "message": "GEODE-7667: Add a 'clear' gfsh command for PR and RR clear (#4818)\n\n* Added clear command and modified remove functionality to clear PR\r\n\r\nAuthored-by: Benjamin Ross <bross@pivotal.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56679c621182ee974b336f2bb0cede3de3a790da", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/56679c621182ee974b336f2bb0cede3de3a790da", "committedDate": "2020-05-11T19:24:16Z", "message": "GEODE-7676: Conversion of duration to seconds."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "780567a758ad199a58ce61a32d5eef3273d277bf", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/780567a758ad199a58ce61a32d5eef3273d277bf", "committedDate": "2020-05-11T20:44:56Z", "message": "GEODE-7894: Moving expiry tasks to AbstractRegion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81102ceb497c00d92adfc55505ba38fe18e7d788", "author": {"user": {"login": "nabarunnag", "name": "Nabarun Nag"}}, "url": "https://github.com/apache/geode/commit/81102ceb497c00d92adfc55505ba38fe18e7d788", "committedDate": "2020-05-11T23:52:50Z", "message": "GEODE-7667: Fixing test to include PR clear help text."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9600213fef5d6adb4fcef4e3ed655553fd0cc21", "author": {"user": {"login": "agingade", "name": null}}, "url": "https://github.com/apache/geode/commit/e9600213fef5d6adb4fcef4e3ed655553fd0cc21", "committedDate": "2020-05-20T23:08:07Z", "message": "GEODE-7678 (2nd PR) - Support for cache-listener and client-notification for Partitioned Region Clear operation  (#5124)\n\n* GEODE-7678: Add support for cache listener and client notification for PR clear\r\n\r\nThe changes are made to PR clear messaging and locking mechanism to preserve\r\ncache-listener and client-events ordering during concurrent cache operation\r\nwhile clear in progress."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a708042b15df2acf26d9edd8aa26dd09d0867670", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/a708042b15df2acf26d9edd8aa26dd09d0867670", "committedDate": "2020-05-27T00:54:28Z", "message": "Initial draft\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1931549fcad58e1031f170fa21e1aef403ac727f", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/1931549fcad58e1031f170fa21e1aef403ac727f", "committedDate": "2020-05-30T00:05:28Z", "message": "Rewrite the tests\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b0afbb081be2a0d101cf960817b13fd603785d", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/70b0afbb081be2a0d101cf960817b13fd603785d", "committedDate": "2020-06-01T18:45:32Z", "message": "Temporarily ignore the tests to test the pipelines\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d682658cc612da3e9fdc82886f2cfdb6a6a6b3", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/c2d682658cc612da3e9fdc82886f2cfdb6a6a6b3", "committedDate": "2020-06-01T21:13:38Z", "message": "Fix the stress test failure\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4183ca970028e380b0ab59542880c592c99e082", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/b4183ca970028e380b0ab59542880c592c99e082", "committedDate": "2020-06-02T22:23:04Z", "message": "Merge branch 'feature/GEODE-7665' into feature/GEODE-7669"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODE3NTc3", "url": "https://github.com/apache/geode/pull/5189#pullrequestreview-423817577", "createdAt": "2020-06-03T18:23:47Z", "commit": {"oid": "b4183ca970028e380b0ab59542880c592c99e082"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODoyMzo0OFrOGeoHLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODoyMzo0OFrOGeoHLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2NzY2MQ==", "bodyText": "I think you need a tearDown method to ensure that Locator and Servers are all stopped in every VM even if any tests failed. You could probably move destroyRegion and destroyDiskStore to tearDown as well (or remove them?).\nClose clients 1st, then servers, then locator (see the order of VMs in Arrays.asList):\n@After\npublic void tearDown() throws Exception {\n  for (VM vm : Arrays.asList(getVM(4), getVM(3), getVM(2), getVM(1), getVM(0)) {\n    vm.invoke(() -> {\n      if (clientCache != null) {\n        clientCache.close();\n      }\n      if (LOCATOR_LAUNCHER.get() != null) {\n        LOCATOR_LAUNCHER.get().stop();\n      }\n      if (SERVER_LAUNCHER.get() != null) {\n        SERVER_LAUNCHER.get().stop();\n      }\n\n      clientCache = null;\n      LOCATOR_LAUNCHER.set(null);\n      SERVER_LAUNCHER.set(null);\n    }\n  }\n}\n\nYou'll need to hoist anything (such as clientCache) to be a private static field/var in the test class so that you can reference it from tearDown() to close it.", "url": "https://github.com/apache/geode/pull/5189#discussion_r434767661", "createdAt": "2020-06-03T18:23:48Z", "author": {"login": "kirklund"}, "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/cache/PartitionedRegionOverflowClearDUnitTest.java", "diffHunk": "@@ -0,0 +1,356 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.internal.cache;\n+\n+import static org.apache.geode.distributed.ConfigurationProperties.ENABLE_CLUSTER_CONFIGURATION;\n+import static org.apache.geode.distributed.ConfigurationProperties.HTTP_SERVICE_PORT;\n+import static org.apache.geode.distributed.ConfigurationProperties.JMX_MANAGER;\n+import static org.apache.geode.distributed.ConfigurationProperties.JMX_MANAGER_PORT;\n+import static org.apache.geode.distributed.ConfigurationProperties.JMX_MANAGER_START;\n+import static org.apache.geode.distributed.ConfigurationProperties.LOCATORS;\n+import static org.apache.geode.distributed.ConfigurationProperties.LOG_FILE;\n+import static org.apache.geode.distributed.ConfigurationProperties.MAX_WAIT_TIME_RECONNECT;\n+import static org.apache.geode.distributed.ConfigurationProperties.MEMBER_TIMEOUT;\n+import static org.apache.geode.distributed.ConfigurationProperties.USE_CLUSTER_CONFIGURATION;\n+import static org.apache.geode.internal.AvailablePortHelper.getRandomAvailableTCPPorts;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.apache.geode.test.dunit.VM.getVMId;\n+import static org.apache.geode.test.dunit.VM.toArray;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.File;\n+import java.io.Serializable;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.DiskStoreFactory;\n+import org.apache.geode.cache.EvictionAction;\n+import org.apache.geode.cache.EvictionAttributes;\n+import org.apache.geode.cache.PartitionAttributesFactory;\n+import org.apache.geode.cache.Region;\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.client.ClientCache;\n+import org.apache.geode.cache.client.ClientCacheFactory;\n+import org.apache.geode.cache.client.ClientRegionShortcut;\n+import org.apache.geode.distributed.LocatorLauncher;\n+import org.apache.geode.distributed.ServerLauncher;\n+import org.apache.geode.distributed.internal.InternalLocator;\n+import org.apache.geode.management.internal.cli.util.CommandStringBuilder;\n+import org.apache.geode.test.dunit.AsyncInvocation;\n+import org.apache.geode.test.dunit.VM;\n+import org.apache.geode.test.dunit.rules.DistributedRule;\n+import org.apache.geode.test.junit.rules.GfshCommandRule;\n+import org.apache.geode.test.junit.rules.serializable.SerializableTemporaryFolder;\n+\n+public class PartitionedRegionOverflowClearDUnitTest implements Serializable {\n+\n+  @Rule\n+  public DistributedRule distributedRule = new DistributedRule();\n+\n+  @Rule\n+  public SerializableTemporaryFolder temporaryFolder = new SerializableTemporaryFolder();\n+\n+  @Rule\n+  public transient GfshCommandRule gfsh = new GfshCommandRule();\n+\n+  private VM server1;\n+  private VM server2;\n+  private VM accessor;\n+  private VM client;\n+\n+  private static final String LOCATOR_NAME = \"locator\";\n+  private static final String SERVER1_NAME = \"server1\";\n+  private static final String SERVER2_NAME = \"server2\";\n+  private static final String SERVER3_NAME = \"server3\";\n+\n+  private File locatorDir;\n+  private File server1Dir;\n+  private File server2Dir;\n+  private File server3Dir;\n+\n+  private String locatorString;\n+\n+  private int locatorPort;\n+  private int locatorJmxPort;\n+  private int locatorHttpPort;\n+  private int serverPort1;\n+  private int serverPort2;\n+  private int serverPort3;\n+\n+  private static final AtomicReference<LocatorLauncher> LOCATOR_LAUNCHER = new AtomicReference<>();\n+\n+  private static final AtomicReference<ServerLauncher> SERVER_LAUNCHER = new AtomicReference<>();\n+\n+  private static final String OVERFLOW_REGION_NAME = \"testOverflowRegion\";\n+\n+  public static final int NUM_ENTRIES = 1000;\n+\n+  @Before\n+  public void setup() throws Exception {\n+    VM locator = getVM(0);\n+    server1 = getVM(1);\n+    server2 = getVM(2);\n+    accessor = getVM(3);\n+    client = getVM(4);\n+\n+    locatorDir = temporaryFolder.newFolder(LOCATOR_NAME);\n+    server1Dir = temporaryFolder.newFolder(SERVER1_NAME);\n+    server2Dir = temporaryFolder.newFolder(SERVER2_NAME);\n+    server3Dir = temporaryFolder.newFolder(SERVER3_NAME);\n+\n+    int[] ports = getRandomAvailableTCPPorts(6);\n+    locatorPort = ports[0];\n+    locatorJmxPort = ports[1];\n+    locatorHttpPort = ports[2];\n+    serverPort1 = ports[3];\n+    serverPort2 = ports[4];\n+    serverPort3 = ports[5];\n+\n+    locator.invoke(\n+        () -> startLocator(locatorDir, locatorPort, locatorJmxPort, locatorHttpPort));\n+    gfsh.connectAndVerify(locatorJmxPort, GfshCommandRule.PortType.jmxManager);\n+\n+    locatorString = \"localhost[\" + locatorPort + \"]\";\n+    server1.invoke(() -> startServer(SERVER1_NAME, server1Dir, locatorString, serverPort1));\n+    server2.invoke(() -> startServer(SERVER2_NAME, server2Dir, locatorString, serverPort2));\n+  }\n+\n+  @Test\n+  public void testGfshClearRegionWithOverflow() throws InterruptedException {\n+    createPartitionRedundantPersistentOverflowRegion();\n+\n+    populateRegion();\n+    assertRegionSize(NUM_ENTRIES);\n+\n+    gfsh.executeAndAssertThat(\"clear region --name=\" + OVERFLOW_REGION_NAME).statusIsSuccess();\n+    assertRegionSize(0);\n+\n+    restartServers();\n+\n+    assertRegionSize(0);\n+\n+    destroyRegion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4183ca970028e380b0ab59542880c592c99e082"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af43bb7697a772dbfe6730cd55aa19aae54f073", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/0af43bb7697a772dbfe6730cd55aa19aae54f073", "committedDate": "2020-06-03T22:58:30Z", "message": "Add tearDown for each test\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67b49f114017c34423dc396d72d9f7a503078e0e", "author": {"user": {"login": "jchen21", "name": "Jianxia Chen"}}, "url": "https://github.com/apache/geode/commit/67b49f114017c34423dc396d72d9f7a503078e0e", "committedDate": "2020-06-03T23:07:58Z", "message": "Move destroy region and disk store to tearDown\n\nAuthored-by: Jianxia Chen <jchen21@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzAxMDMz", "url": "https://github.com/apache/geode/pull/5189#pullrequestreview-424701033", "createdAt": "2020-06-04T18:06:30Z", "commit": {"oid": "67b49f114017c34423dc396d72d9f7a503078e0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4403, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}