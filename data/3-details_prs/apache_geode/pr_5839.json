{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzQxMTc1", "number": 5839, "title": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()", "bodyText": "When a member is unable to contact a join the system due to a failure to contact a locator, we could be a lot more specific, which would help users debug issues in their environment. We currently print out\n\nUnable to join the distributed system.  Operation either timed out, was stopped or Locator does not exist.\n\nThis change makes the exception message more specific. Instead of printing out the same message for 3 different problems, this change separates it out into 3 different messages. In case of a failure to contact a locator, the exception will include the underlying exception from the last locator we tried to contact as a cause. Also, the exception message will include the list of locators we tried to contact.\nThank you for submitting a contribution to Apache Geode.\nIn order to streamline the review of the contribution we ask you\nto ensure the following steps have been taken:\nFor all changes:\n\n\n Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?\n\n\n Has your PR been rebased against the latest commit within the target branch (typically develop)?\n\n\n Is your initial contribution a single, squashed commit?\n\n\n Does gradlew build run cleanly?\n\n\n Have you written or updated unit tests to verify your changes?\n\n\n If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under ASF 2.0?\n\n\nNote:\nPlease ensure that once the PR is submitted, check Concourse for build issues and\nsubmit an update to your PR as soon as possible. If you need help, please send an\nemail to dev@geode.apache.org.", "createdAt": "2020-12-10T23:39:18Z", "url": "https://github.com/apache/geode/pull/5839", "merged": true, "mergeCommit": {"oid": "089c1ba7e20606f8201a4cd8f7221f6adc60ba5c"}, "closed": true, "closedAt": "2021-01-08T22:57:03Z", "author": {"login": "kamilla1201"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk8SplgH2gAyNTM2MzQxMTc1OjNlMzU0NzI5NmU4MmZlNmFjNjlmMmYzMDBhZDk3ODEzMDE3YWQxZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduMtXlAH2gAyNTM2MzQxMTc1OjMxMTI1NzBhOWEzMDgzZTZlOGQ3Yjk3ODQ2MjljMmEwMzM3MmViYWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/3e3547296e82fe6ac69f2f300ad97813017ad1f8", "committedDate": "2020-12-10T23:53:11Z", "message": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed47051d719536af8c5b3be02661b664eaedc148", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/ed47051d719536af8c5b3be02661b664eaedc148", "committedDate": "2020-12-10T23:38:02Z", "message": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()"}, "afterCommit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/3e3547296e82fe6ac69f2f300ad97813017ad1f8", "committedDate": "2020-12-10T23:53:11Z", "message": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/0f96d92b4122d5657c1a8256407f0dc0f6b81878", "committedDate": "2020-12-11T05:45:32Z", "message": "Fix LocatorDUnitTest.testNoLocator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTExMTky", "url": "https://github.com/apache/geode/pull/5839#pullrequestreview-554111192", "createdAt": "2020-12-16T21:47:29Z", "commit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMTo0NzoyOVrOIHak0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMTo1Mjo1MVrOIHawjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NjM1Mw==", "bodyText": "as I'm understanding this change, this section is the critical change to improve upon error reporting... I don't see unit testing for the improvement; there is a new test that looks for the above Exception string. Only it seems that a test could validate the expanded error information has been sent as well.", "url": "https://github.com/apache/geode/pull/5839#discussion_r544646353", "createdAt": "2020-12-16T21:47:29Z", "author": {"login": "echobravopapa"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeave.java", "diffHunk": "@@ -383,40 +383,44 @@ public boolean join() throws MemberStartupException {\n             break;\n           }\n         }\n-        try {\n-          if (found && !state.hasContactedAJoinedLocator) {\n-            // if locators are restarting they may be handing out IDs from a stale view that\n-            // we should go through quickly. Otherwise we should sleep a bit to let failure\n-            // detection select a new coordinator\n-            if (state.possibleCoordinator.getVmViewId() < 0) {\n-              logger.debug(\"sleeping for {} before making another attempt to find the coordinator\",\n-                  retrySleep);\n-              Thread.sleep(retrySleep);\n-            } else {\n+        if (found && !state.hasContactedAJoinedLocator) {\n+          try {\n+            if (hasCoordinatorJoinedCluster(state.possibleCoordinator.getVmViewId(), retrySleep)) {\n               // since we were given a coordinator that couldn't be used we should keep trying\n               tries = 0;\n               giveupTime = System.currentTimeMillis() + timeout;\n             }\n+          } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new MembershipConfigurationException(\n+                \"Retry sleep interrupted. Giving up on joining the distributed system.\");\n           }\n-        } catch (InterruptedException e) {\n-          logger.debug(\"retry sleep interrupted - giving up on joining the distributed system\");\n-          return false;\n         }\n       } // for\n \n       if (!this.isJoined) {\n         logger.debug(\"giving up attempting to join the distributed system after \"\n             + (System.currentTimeMillis() - startTime) + \"ms\");\n-      }\n \n-      // to preserve old behavior we need to throw a MemberStartupException if\n-      // unable to contact any of the locators\n-      if (!this.isJoined && state.hasContactedAJoinedLocator) {\n-        throw new MemberStartupException(\"Unable to join the distributed system in \"\n-            + (System.currentTimeMillis() - startTime) + \"ms\");\n-      }\n+        // to preserve old behavior we need to throw a MemberStartupException if\n+        // unable to contact any of the locators\n+        if (state.hasContactedAJoinedLocator) {\n+          throw new MemberStartupException(\"Unable to join the distributed system in \"\n+              + (System.currentTimeMillis() - startTime) + \"ms\");\n+        }\n \n-      return this.isJoined;\n+        if (state.locatorsContacted == 0) {\n+          throw new MembershipConfigurationException(\n+              \"Unable to join the distributed system. Could not contact any of the locators: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0OTM1OQ==", "bodyText": "looks like this extraction was test driven", "url": "https://github.com/apache/geode/pull/5839#discussion_r544649359", "createdAt": "2020-12-16T21:52:51Z", "author": {"login": "echobravopapa"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeave.java", "diffHunk": "@@ -428,6 +432,24 @@ public boolean join() throws MemberStartupException {\n     }\n   }\n \n+  boolean hasCoordinatorJoinedCluster(int viewId, long retrySleep)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDY4MDAy", "url": "https://github.com/apache/geode/pull/5839#pullrequestreview-556468002", "createdAt": "2020-12-21T15:36:31Z", "commit": {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNTozNjozMVrOIJca4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNjoxNzozN1rOIJd2vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3MzcyOA==", "bodyText": "I like it - using a \"when\" to throw an InterruptedException", "url": "https://github.com/apache/geode/pull/5839#discussion_r546773728", "createdAt": "2020-12-21T15:36:31Z", "author": {"login": "bschuchardt"}, "path": "geode-membership/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeaveJUnitTest.java", "diffHunk": "@@ -1441,24 +1435,74 @@ public void testCoordinatorFindRequestSuccess() throws Exception {\n   public void testCoordinatorFindRequestFailure() throws Exception {\n     try {\n       initMocks(false);\n-      HashSet<MemberIdentifier> registrants = new HashSet<>();\n-      registrants.add(mockMembers[0]);\n-      FindCoordinatorResponse fcr = new FindCoordinatorResponse(mockMembers[0], mockMembers[0],\n-          false, null, registrants, false, true, null);\n+      mockRequestToServer(eq(new HostAndPort(\"localhost\", 12346)));\n       GMSMembershipView view = createView();\n       JoinResponseMessage jrm = new JoinResponseMessage(mockMembers[0], view, 0);\n       gmsJoinLeave.setJoinResponseMessage(jrm);\n \n-      when(locatorClient.requestToServer(eq(new HostAndPort(\"localhost\", 12346)),\n-          isA(FindCoordinatorRequest.class), anyInt(), anyBoolean()))\n-              .thenReturn(fcr);\n-\n-      assertFalse(\"Should not be able to join \", gmsJoinLeave.join());\n+      assertThatThrownBy(() -> gmsJoinLeave.join())\n+          .isInstanceOf(MembershipConfigurationException.class);\n     } finally {\n-\n     }\n   }\n \n+  @Test\n+  public void testJoinFailureWhenSleepInterrupted() throws Exception {\n+    initMocks(false);\n+    mockRequestToServer(isA(HostAndPort.class));\n+\n+    when(mockConfig.getMemberTimeout()).thenReturn(100L);\n+    when(mockConfig.getJoinTimeout()).thenReturn(1000L);\n+\n+    GMSJoinLeave spyGmsJoinLeave = spy(gmsJoinLeave);\n+    when(spyGmsJoinLeave.hasCoordinatorJoinedCluster(-1, GMSJoinLeave.JOIN_RETRY_SLEEP))\n+        .thenThrow(new InterruptedException());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NDY2NQ==", "bodyText": "nice change to make this a \"void\" method that throws an exception if it doesn't succeed in joining the cluster", "url": "https://github.com/apache/geode/pull/5839#discussion_r546774665", "createdAt": "2020-12-21T15:38:13Z", "author": {"login": "bschuchardt"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMembership.java", "diffHunk": "@@ -565,12 +565,7 @@ private void join() throws MemberStartupException {\n         this.isJoining = true; // added for bug #44373\n \n         // connect\n-        boolean ok = services.getJoinLeave().join();\n-\n-        if (!ok) {\n-          throw new MembershipConfigurationException(\"Unable to join the distributed system.  \"\n-              + \"Operation either timed out, was stopped or Locator does not exist.\");\n-        }\n+        services.getJoinLeave().join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NTY3OA==", "bodyText": "This comment needs to be changed to reflect that the method now throws an exception if it's unable to join the cluster.  The comment should say which exception is thrown.  Should the exception be changed to be a checked exception instead of a runtime exception?", "url": "https://github.com/apache/geode/pull/5839#discussion_r546775678", "createdAt": "2020-12-21T15:40:07Z", "author": {"login": "bschuchardt"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/interfaces/JoinLeave.java", "diffHunk": "@@ -29,7 +29,7 @@\n    * joins the distributed system and returns true if successful, false if not. Throws", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5NzI0NQ==", "bodyText": "How about naming this something indicating that a sleep is going to be performed, like \"pauseIfThereIsNoCoordinator\"?", "url": "https://github.com/apache/geode/pull/5839#discussion_r546797245", "createdAt": "2020-12-21T16:17:37Z", "author": {"login": "bschuchardt"}, "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeave.java", "diffHunk": "@@ -428,6 +432,24 @@ public boolean join() throws MemberStartupException {\n     }\n   }\n \n+  boolean hasCoordinatorJoinedCluster(int viewId, long retrySleep)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0OTM1OQ=="}, "originalCommit": {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4317d23794802642b7d92b8b7d59e6fec4fadeac", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/4317d23794802642b7d92b8b7d59e6fec4fadeac", "committedDate": "2021-01-07T16:49:54Z", "message": "Changes after the code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNjg2MzAw", "url": "https://github.com/apache/geode/pull/5839#pullrequestreview-563686300", "createdAt": "2021-01-07T17:36:14Z", "commit": {"oid": "4317d23794802642b7d92b8b7d59e6fec4fadeac"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxNzozNjoxNVrOIP1o5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxNzozNjoxNVrOIP1o5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ3ODM3Mg==", "bodyText": "typo:  \"startLocator\"", "url": "https://github.com/apache/geode/pull/5839#discussion_r553478372", "createdAt": "2021-01-07T17:36:15Z", "author": {"login": "bschuchardt"}, "path": "geode-membership/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeaveJUnitTest.java", "diffHunk": "@@ -115,11 +117,18 @@ public void initMocks(boolean enableNetworkPartition) throws Exception {\n \n   public void initMocks(boolean enableNetworkPartition, boolean useTestGMSJoinLeave)\n       throws Exception {\n+    String locator = \"localhost[12345]\";\n+    initMocks(enableNetworkPartition, useTestGMSJoinLeave, locator, locator);\n+  }\n+\n+  public void initMocks(boolean enableNetworkPartition, boolean useTestGMSJoinLeave,\n+      String locators, String startLoactor)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4317d23794802642b7d92b8b7d59e6fec4fadeac"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNzQ4MDAz", "url": "https://github.com/apache/geode/pull/5839#pullrequestreview-563748003", "createdAt": "2021-01-07T19:06:46Z", "commit": {"oid": "4317d23794802642b7d92b8b7d59e6fec4fadeac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3112570a9a3083e6e8d7b9784629c2a03372ebac", "author": {"user": {"login": "kamilla1201", "name": "Kamilla Aslami"}}, "url": "https://github.com/apache/geode/commit/3112570a9a3083e6e8d7b9784629c2a03372ebac", "committedDate": "2021-01-08T18:06:10Z", "message": "Fix typo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3943, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}