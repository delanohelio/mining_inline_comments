{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNDY3ODQ5", "number": 7767, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxMjoxNToxMFrOD4xAJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0MzowOVrOD6kOlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwODQ5NzAyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxMjoxNToxMFrOGPriLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1MDowMVrOGRgxxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5NTA4Nw==", "bodyText": "If oldest node left cluster user will get not clear exception. What it mean?  Snapshot will be created or not? What user should to do? I suggest to clarify public exceptions.\nFor now, exception looks like:\nclass org.apache.ignite.cluster.ClusterGroupEmptyException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:921)\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:919)\n\tat org.apache.ignite.internal.util.IgniteUtils.convertException(IgniteUtils.java:1077)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.convertException(IgniteFutureImpl.java:168)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.get(IgniteFutureImpl.java:137)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.testClusterSnapshotFromClientNodeStop(IgniteClusterSnapshotSelfTest.java:887)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\n\tat org.apache.ignite.testframework.junits.GridAbstractTest$7.run(GridAbstractTest.java:2213)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: class org.apache.ignite.internal.cluster.ClusterGroupEmptyCheckedException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils.emptyTopologyException(IgniteUtils.java:5062)\n\tat org.apache.ignite.internal.processors.closure.GridClosureProcessor.callAsync(GridClosureProcessor.java:694)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync0(IgniteComputeImpl.java:773)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync(IgniteComputeImpl.java:757)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteSnapshotManager.createSnapshot(IgniteSnapshotManager.java:659)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.lambda$testClusterSnapshotFromClientNodeStop$15(IgniteClusterSnapshotSelfTest.java:883)\n\tat org.apache.ignite.testframework.GridTestUtils.lambda$runAsync$2(GridTestUtils.java:1153)\n\tat org.apache.ignite.testframework.GridTestUtils$7.call(GridTestUtils.java:1474)\n\tat org.apache.ignite.testframework.GridTestThread.run(GridTestThread.java:84)", "url": "https://github.com/apache/ignite/pull/7767#discussion_r419095087", "createdAt": "2020-05-03T12:15:10Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +648,13 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {\n+                return cctx.kernalContext().grid()\n+                    .compute(cctx.kernalContext().grid().cluster()\n+                        .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNjAwNg==", "bodyText": "Fixed.", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421016006", "createdAt": "2020-05-06T18:50:01Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +648,13 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {\n+                return cctx.kernalContext().grid()\n+                    .compute(cctx.kernalContext().grid().cluster()\n+                        .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5NTA4Nw=="}, "originalCommit": {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMTAxODg4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToxNzo1OFrOGRhylA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzozNjoyMlrOGSJGkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjU5Ng==", "bodyText": "What happens if the client will be disconnected? U.oldest(..) can return null.", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421032596", "createdAt": "2020-05-06T19:17:58Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +649,22 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3NjY5MQ==", "bodyText": "Fixed.", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421676691", "createdAt": "2020-05-07T17:36:22Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +649,22 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjU5Ng=="}, "originalCommit": {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzM3NTU4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0MzowOVrOGSeP0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo1OTo1OFrOGSetcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMzEyMw==", "bodyText": "Should this task be marked as @GridInternal ?", "url": "https://github.com/apache/ignite/pull/7767#discussion_r422023123", "createdAt": "2020-05-08T08:43:09Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -1230,4 +1245,37 @@ public ClusterSnapshotFuture(UUID rqId, String name) {\n             return super.onDone(res, err, cancel);\n         }\n     }\n+\n+    /** Start creation of cluster snapshot closure. */\n+    private static class CreateSnapshotClosure implements IgniteClosure<String, Void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAzMDcwNA==", "bodyText": "Added. Thank you!", "url": "https://github.com/apache/ignite/pull/7767#discussion_r422030704", "createdAt": "2020-05-08T08:59:58Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -1230,4 +1245,37 @@ public ClusterSnapshotFuture(UUID rqId, String name) {\n             return super.onDone(res, err, cancel);\n         }\n     }\n+\n+    /** Start creation of cluster snapshot closure. */\n+    private static class CreateSnapshotClosure implements IgniteClosure<String, Void> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMzEyMw=="}, "originalCommit": {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2475, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}