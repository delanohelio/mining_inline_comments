{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjg3MjU4", "number": 7561, "title": "IGNITE-12788 Adds cluster fully rebalanced state metric.", "bodyText": "", "createdAt": "2020-03-23T23:12:40Z", "url": "https://github.com/apache/ignite/pull/7561", "merged": true, "mergeCommit": {"oid": "87d552662408ed701171d7c21cced9141a323c63"}, "closed": true, "closedAt": "2020-03-30T09:16:52Z", "author": {"login": "ololo3000"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQtPiPAH2gAyMzkyNjg3MjU4OmZjODlmMzQ0NzVjM2MzMWI2Y2U2ZjQ0NTM3MjM4N2EyMTQ5NzQ4M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRvkQWAH2gAyMzkyNjg3MjU4OjZkNjNlZmNmMDY2MWQ5MWMwNDdlYTI1Y2NlZmFhYWFjYjY1ZTg5ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc89f34475c3c31b6ce6f445372387a21497483d", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/fc89f34475c3c31b6ce6f445372387a21497483d", "committedDate": "2020-03-24T06:51:34Z", "message": "IGNITE-12788 Adds cluster fully rebalanced state metric."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1f2faec305d7c5b8bf18d29e1f62f22a07d1f18", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d1f2faec305d7c5b8bf18d29e1f62f22a07d1f18", "committedDate": "2020-03-23T23:08:09Z", "message": "IGNITE-12788 Adds cluster fully rebalanced state metric."}, "afterCommit": {"oid": "fc89f34475c3c31b6ce6f445372387a21497483d", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/fc89f34475c3c31b6ce6f445372387a21497483d", "committedDate": "2020-03-24T06:51:34Z", "message": "IGNITE-12788 Adds cluster fully rebalanced state metric."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70bf947d411d31d4698fd58cd8b83dec12e6aca", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/a70bf947d411d31d4698fd58cd8b83dec12e6aca", "committedDate": "2020-03-24T10:23:06Z", "message": "IGNITE-12788 Adds client nodes testing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjEyNzc3", "url": "https://github.com/apache/ignite/pull/7561#pullrequestreview-380212777", "createdAt": "2020-03-24T11:18:35Z", "commit": {"oid": "a70bf947d411d31d4698fd58cd8b83dec12e6aca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxODozNlrOF6rnxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxODozNlrOF6rnxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3NjQyMw==", "bodyText": "allMatch result ignored.", "url": "https://github.com/apache/ignite/pull/7561#discussion_r397076423", "createdAt": "2020-03-24T11:18:36Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/ClusterRebalancedMetricTest.java", "diffHunk": "@@ -0,0 +1,208 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.spi.discovery;\n+\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.GridDhtPartitionDemandMessage;\n+import org.apache.ignite.internal.processors.metric.GridMetricManager;\n+import org.apache.ignite.internal.util.typedef.G;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+import org.apache.ignite.spi.metric.BooleanMetric;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n+import static org.apache.ignite.cache.CacheMode.PARTITIONED;\n+import static org.apache.ignite.cluster.ClusterState.ACTIVE;\n+import static org.apache.ignite.cluster.ClusterState.INACTIVE;\n+import static org.apache.ignite.internal.processors.metric.GridMetricManager.CLUSTER_REBALANCED;\n+import static org.apache.ignite.internal.processors.metric.GridMetricManager.REBALANCE_METRICS;\n+\n+/**\n+ * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric.\n+ */\n+public class ClusterRebalancedMetricTest extends GridCommonAbstractTest {\n+    /** Test cache name. */\n+    private static final String TEST_CACHE = \"TEST_CACHE\";\n+\n+    /**\n+     * @param idx Index of the node to be started.\n+     * @param persistenceEnabled Whether node native persistence is enabled.\n+     */\n+    protected IgniteConfiguration getConfiguration(int idx, boolean persistenceEnabled) throws Exception {\n+        DataRegionConfiguration drCfg = new DataRegionConfiguration()\n+            .setPersistenceEnabled(persistenceEnabled);\n+\n+        DataStorageConfiguration dsCfg = new DataStorageConfiguration()\n+            .setDefaultDataRegionConfiguration(drCfg);\n+\n+        return getConfiguration(getTestIgniteInstanceName(idx))\n+            .setDataStorageConfiguration(dsCfg);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @SuppressWarnings(\"rawtypes\")\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        TestRecordingCommunicationSpi commSpi = new TestRecordingCommunicationSpi();\n+\n+        CacheConfiguration cCfg = new CacheConfiguration(TEST_CACHE)\n+            .setBackups(2)\n+            .setCacheMode(PARTITIONED)\n+            .setAtomicityMode(TRANSACTIONAL);\n+\n+        return super.getConfiguration(igniteInstanceName)\n+            .setCacheConfiguration(cCfg)\n+            .setCommunicationSpi(commSpi)\n+            .setClusterStateOnStart(INACTIVE);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids(true);\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /**\n+     * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric in case of in-memory cluster.\n+     */\n+    @Test\n+    public void testInMemoryClusterRebalancedMetric() throws Exception {\n+        checkClusterRebalancedMetric(false);\n+    }\n+\n+    /**\n+     * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric in case of cluster with native persistence enabled.\n+     */\n+    @Test\n+    public void testPersistenceClusterRebalancedMetric() throws Exception {\n+        checkClusterRebalancedMetric(true);\n+    }\n+\n+    /**\n+     * @param persistenceEnabled Whether native persistence is enabled.\n+     */\n+    public void checkClusterRebalancedMetric(boolean persistenceEnabled) throws Exception {\n+        IgniteEx ignite = startGrid(0, persistenceEnabled);\n+\n+        startClientGrid(1, persistenceEnabled);\n+\n+        assertClusterRebalancedMetricOnAllNodes(false);\n+\n+        ignite.cluster().state(ACTIVE);\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+\n+        ignite.cache(TEST_CACHE).put(\"key\", \"val\");\n+\n+        startClientGrid(2, persistenceEnabled);\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+\n+        TestRecordingCommunicationSpi spi = startGridWithRebalanceBlocked(3, persistenceEnabled);\n+\n+        if (persistenceEnabled) {\n+            awaitPartitionMapExchange(true, true, null, false);\n+\n+            assertClusterRebalancedMetricOnAllNodes(true);\n+\n+            ignite.cluster().setBaselineTopology(ignite.cluster().forServers().nodes());\n+        }\n+\n+        spi.waitForBlocked();\n+\n+        assertClusterRebalancedMetricOnAllNodes(false);\n+\n+        spi.stopBlock();\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+    }\n+\n+    /**\n+     * @param exp Expected value of {@link GridMetricManager#CLUSTER_REBALANCED} metric.\n+     */\n+    private void awaitPmeAndAssertRebalancedMetricOnAllNodes(boolean exp) throws Exception {\n+        awaitPartitionMapExchange(true, true, null, true);\n+\n+        assertClusterRebalancedMetricOnAllNodes(exp);\n+    }\n+\n+    /**\n+     * Checks that {@link GridMetricManager#CLUSTER_REBALANCED} metric is set to {@code exp} on all cluster nodes.\n+     */\n+    private void assertClusterRebalancedMetricOnAllNodes(boolean exp) {\n+        G.allGrids().stream().allMatch(ignite -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a70bf947d411d31d4698fd58cd8b83dec12e6aca"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9326378012f879a8a86a3aab9ef3702c44bc749", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d9326378012f879a8a86a3aab9ef3702c44bc749", "committedDate": "2020-03-24T11:57:35Z", "message": "IGNITE-12788 Refactors test configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d8a7e80e2c36d6961d0d982105d0a630555e226", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/2d8a7e80e2c36d6961d0d982105d0a630555e226", "committedDate": "2020-03-24T11:52:22Z", "message": "IGNITE-12788 Refactors test configuration."}, "afterCommit": {"oid": "d9326378012f879a8a86a3aab9ef3702c44bc749", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d9326378012f879a8a86a3aab9ef3702c44bc749", "committedDate": "2020-03-24T11:57:35Z", "message": "IGNITE-12788 Refactors test configuration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7cba8dbe533e41871e43d46818f2add225e1d6a", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/f7cba8dbe533e41871e43d46818f2add225e1d6a", "committedDate": "2020-03-24T12:08:13Z", "message": "IGNITE-12788 Fixes minor issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984ff9d5e0d3496b6819f8116a61a79c2ca29cf3", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/984ff9d5e0d3496b6819f8116a61a79c2ca29cf3", "committedDate": "2020-03-24T12:19:45Z", "message": "IGNITE-12788 Fixes minor issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f2075dfdd6046d8a20112beba083f976a66e8b4", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/7f2075dfdd6046d8a20112beba083f976a66e8b4", "committedDate": "2020-03-24T16:05:49Z", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state."}, "afterCommit": {"oid": "19775e7466ef8cdb9798aa47e63619741539feb5", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/19775e7466ef8cdb9798aa47e63619741539feb5", "committedDate": "2020-03-24T20:56:30Z", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "committedDate": "2020-03-24T21:28:34Z", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19775e7466ef8cdb9798aa47e63619741539feb5", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/19775e7466ef8cdb9798aa47e63619741539feb5", "committedDate": "2020-03-24T20:56:30Z", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state."}, "afterCommit": {"oid": "9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "committedDate": "2020-03-24T21:28:34Z", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a07e4216a2e7a489a19d9d05866f3149d8715fb", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/0a07e4216a2e7a489a19d9d05866f3149d8715fb", "committedDate": "2020-03-25T08:30:17Z", "message": "IGNITE-12788 Adds a test case for node leaving."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83806ddcc0e8ff45b953a216b7de0d35cf1153c6", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/83806ddcc0e8ff45b953a216b7de0d35cf1153c6", "committedDate": "2020-03-25T07:03:41Z", "message": "IGNITE-12788 Adds a test case for node leaving."}, "afterCommit": {"oid": "0a07e4216a2e7a489a19d9d05866f3149d8715fb", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/0a07e4216a2e7a489a19d9d05866f3149d8715fb", "committedDate": "2020-03-25T08:30:17Z", "message": "IGNITE-12788 Adds a test case for node leaving."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTcyOTM4", "url": "https://github.com/apache/ignite/pull/7561#pullrequestreview-380972938", "createdAt": "2020-03-25T09:20:53Z", "commit": {"oid": "0a07e4216a2e7a489a19d9d05866f3149d8715fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eabf75d986b224caad0813bc2671b14f740ab1b5", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/eabf75d986b224caad0813bc2671b14f740ab1b5", "committedDate": "2020-03-25T10:39:23Z", "message": "IGNITE-12788 Removes unused imports."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f7ceeb936abdc1bd043e3cd57737117ab1387e", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d0f7ceeb936abdc1bd043e3cd57737117ab1387e", "committedDate": "2020-03-25T15:14:37Z", "message": "Merge branch 'master' of https://github.com/apache/ignite into IGNITE-12788"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff92705664d90a0386c3d25bc9e96a131ccf760", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/fff92705664d90a0386c3d25bc9e96a131ccf760", "committedDate": "2020-03-25T15:19:05Z", "message": "IGNITE-12788 Renames rebalnce metric registry to cluster."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ab68a8bd4db6be2930030831b6212b11ea782e", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/20ab68a8bd4db6be2930030831b6212b11ea782e", "committedDate": "2020-03-25T17:37:46Z", "message": "IGNITE-12788 Fixes minor issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "197b5550a5c6070f1c141ae87efe5b46326a037f", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/197b5550a5c6070f1c141ae87efe5b46326a037f", "committedDate": "2020-03-27T07:38:55Z", "message": "IGNITE-12788 Transfers activation check from metric to exchange future side."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bef8881442400661aba3ecc2643703243a26c10", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/6bef8881442400661aba3ecc2643703243a26c10", "committedDate": "2020-03-27T07:33:46Z", "message": "IGNITE-12788 Transfers activation check from metric to exchange future side."}, "afterCommit": {"oid": "197b5550a5c6070f1c141ae87efe5b46326a037f", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/197b5550a5c6070f1c141ae87efe5b46326a037f", "committedDate": "2020-03-27T07:38:55Z", "message": "IGNITE-12788 Transfers activation check from metric to exchange future side."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d63efcf0661d91c047ea25ccefaaaacb65e8984", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/6d63efcf0661d91c047ea25ccefaaaacb65e8984", "committedDate": "2020-03-27T12:07:56Z", "message": "IGNITE-12788 Fixes minor issues."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2775, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}