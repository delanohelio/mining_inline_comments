{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NzgyNDY5", "number": 7795, "title": "IGNITE-12989 TxRecovery should log statuses to TimeBag", "bodyText": "", "createdAt": "2020-05-12T14:58:47Z", "url": "https://github.com/apache/ignite/pull/7795", "merged": true, "mergeCommit": {"oid": "902a94991c083cac2d829ea5464c1b7028d44c4d"}, "closed": true, "closedAt": "2020-05-18T11:35:25Z", "author": {"login": "anton-vinogradov"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgljBcAH2gAyNDE2NzgyNDY5OmU5OGMyOGVhODU2YzQyODJlZGY0NzA1ZmE5YzVhNDI3ZjgwYmEzMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcibjtggFqTQxMzM3NDAyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/e98c28ea856c4282edf4705fa9c5a427f80ba301", "committedDate": "2020-05-12T14:56:24Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODQ3MzI3", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410847327", "createdAt": "2020-05-13T11:53:31Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo1MzozMVrOGUt9FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo1MzozMVrOGUt9FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NzYyMA==", "bodyText": "Typo: future -> fut", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424377620", "createdAt": "2020-05-13T11:53:31Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3016,6 +3031,13 @@ else if (tx.setRollbackOnly())\n                     }\n                 }\n \n+                timeBag.finishGlobalStage(\"Initialized\");\n+\n+                doneFut.markInitialized();\n+\n+                if (txCnt.get() > 0)\n+                    doneFut.listen(future -> finishAndRecordTimings());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODQ5MjEx", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410849211", "createdAt": "2020-05-13T11:56:22Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo1NjoyMlrOGUuC8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMTo1NjoyMlrOGUuC8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3OTEyMw==", "bodyText": "This would be executed on each transaction?\nOr only on recovery after some node failed?", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424379123", "createdAt": "2020-05-13T11:56:22Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3051,6 +3073,37 @@ else if (tx.setRollbackOnly())\n                 cctx.kernalContext().gateway().readUnlock();\n             }\n         }\n+\n+        /**\n+         * @param tx Tx.\n+         * @param failedNode Failed node.\n+         */\n+        private void processPrepared(IgniteInternalTx tx, UUID failedNode) {\n+            IgniteInternalFuture<Boolean> fut = commitIfPrepared(tx, Collections.singleton(failedNode));\n+\n+            if (fut != null)\n+                doneFut.add(fut);\n+\n+            txCnt.incrementAndGet();\n+        }\n+\n+        /**\n+         *\n+         */\n+        private void finishAndRecordTimings() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74c0c63d301e3edc41540e08d2086b3b0d48a9a1", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/74c0c63d301e3edc41540e08d2086b3b0d48a9a1", "committedDate": "2020-05-13T12:03:17Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODY2NjA0", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410866604", "createdAt": "2020-05-13T12:21:39Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjoyMTozOVrOGUu40A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjoyMTozOVrOGUu40A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5MjkxMg==", "bodyText": "Let's wrap in:\nif (log.isInfoEnabled()) {\n            StringBuilder timingsToLog = new StringBuilder();\n\n            timingsToLog.append(\"TxRecovery Status and Timings [txs=\").append(txCnt.get());\n\n            for (String stageTiming : timeBag.stagesTimings())\n                timingsToLog.append(\", \").append(stageTiming);\n\n            timingsToLog.append(\"]\");\n\n            log.info(timingsToLog.toString());\n}", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424392912", "createdAt": "2020-05-13T12:21:39Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3051,6 +3073,37 @@ else if (tx.setRollbackOnly())\n                 cctx.kernalContext().gateway().readUnlock();\n             }\n         }\n+\n+        /**\n+         * @param tx Tx.\n+         * @param failedNode Failed node.\n+         */\n+        private void processPrepared(IgniteInternalTx tx, UUID failedNode) {\n+            IgniteInternalFuture<Boolean> fut = commitIfPrepared(tx, Collections.singleton(failedNode));\n+\n+            if (fut != null)\n+                doneFut.add(fut);\n+\n+            txCnt.incrementAndGet();\n+        }\n+\n+        /**\n+         *\n+         */\n+        private void finishAndRecordTimings() {\n+            timeBag.finishGlobalStage(\"Finished\");\n+\n+            StringBuilder timingsToLog = new StringBuilder();\n+\n+            timingsToLog.append(\"TxRecovery Status and Timings [txs=\").append(txCnt.get());\n+\n+            for (String stageTiming : timeBag.stagesTimings())\n+                timingsToLog.append(\", \").append(stageTiming);\n+\n+            timingsToLog.append(\"]\");\n+\n+            log.info(timingsToLog.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODc5Mzk2", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410879396", "createdAt": "2020-05-13T12:38:11Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjozODoxMlrOGUvgDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjozODoxMlrOGUvgDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjk1OA==", "bodyText": "Let's rename it to preparedTxCnt", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424402958", "createdAt": "2020-05-13T12:38:12Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -2948,6 +2952,15 @@ private void broadcastToNodesSupportingFeature(IgniteRunnable job, IgniteFeature\n         /** */\n         private final MvccCoordinator mvccCrd;\n \n+        /** Time bag to measure and store tx recovery stages times. */\n+        private final TimeBag timeBag = new TimeBag();\n+\n+        /** Prepared tx to be recovered count. */\n+        private final AtomicLong txCnt = new AtomicLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODgxMDI4", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410881028", "createdAt": "2020-05-13T12:40:16Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjo0MDoxNlrOGUvk9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjo0MDoxNlrOGUvk9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDIxNQ==", "bodyText": "Let's check here - is info level enabled.\nOtherwise, we perform a lot of unnecessary work - finishGlobalStage includes acquiring write lock, creating some objects, etc.", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424404215", "createdAt": "2020-05-13T12:40:16Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -2959,6 +2972,8 @@ private TxRecoveryInitRunnable(ClusterNode node, MvccCoordinator mvccCrd) {\n \n         /** {@inheritDoc} */\n         @Override public void run() {\n+            timeBag.finishGlobalStage(\"Started\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODgxMTk0", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-410881194", "createdAt": "2020-05-13T12:40:29Z", "commit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjo0MDoyOVrOGUvlhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMjo0MDoyOVrOGUvlhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDM1OA==", "bodyText": "Let's check here - is info level enabled.\nOtherwise, we perform a lot of unnecessary work - finishGlobalStage includes acquiring write lock, creating some objects, etc.", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424404358", "createdAt": "2020-05-13T12:40:29Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3016,6 +3031,13 @@ else if (tx.setRollbackOnly())\n                     }\n                 }\n \n+                timeBag.finishGlobalStage(\"Initialized\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dad61c278417598c57532ff972acfdefe22d52c4", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/dad61c278417598c57532ff972acfdefe22d52c4", "committedDate": "2020-05-13T12:46:13Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aaa05b55227120dc8877f4c9b0878d9eefd2b30", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/1aaa05b55227120dc8877f4c9b0878d9eefd2b30", "committedDate": "2020-05-15T10:50:01Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into ignite-12989"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bf4d184156158728ef3b80612cfab83aac901d9", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/0bf4d184156158728ef3b80612cfab83aac901d9", "committedDate": "2020-05-15T10:55:32Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ffd7f3f2df9e2b79a3c9411c491cc50d426b3d", "author": {"user": {"login": "anton-vinogradov", "name": "Anton Vinogradov"}}, "url": "https://github.com/apache/ignite/commit/c6ffd7f3f2df9e2b79a3c9411c491cc50d426b3d", "committedDate": "2020-05-18T08:10:42Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMzc0MDI5", "url": "https://github.com/apache/ignite/pull/7795#pullrequestreview-413374029", "createdAt": "2020-05-18T08:25:57Z", "commit": {"oid": "c6ffd7f3f2df9e2b79a3c9411c491cc50d426b3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2639, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}