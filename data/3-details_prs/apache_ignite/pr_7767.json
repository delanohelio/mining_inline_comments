{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNDY3ODQ5", "number": 7767, "title": "IGNITE-12967: Start cluster snapshot from client node", "bodyText": "", "createdAt": "2020-05-02T15:35:45Z", "url": "https://github.com/apache/ignite/pull/7767", "merged": true, "mergeCommit": {"oid": "895eab28a721e57d8ef65423af0e71d73c058c3f"}, "closed": true, "closedAt": "2020-05-08T15:27:45Z", "author": {"login": "Mmuzaf"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdYG67AH2gAyNDEyNDY3ODQ5OmVlYjMxNjFjNGIzOGRhMDBiNzE4NDY2YTI4M2I5NjU4MWE4YzQzNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfODu8gFqTQwODEwMjQ5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eeb3161c4b38da00b718466a283b96581a8c4357", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/eeb3161c4b38da00b718466a283b96581a8c4357", "committedDate": "2020-05-02T15:35:10Z", "message": "IGNITE-12967: Start cluster snapshot from client node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "173965a9b5fed2cde32e19df1b2a0c5583140486", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/173965a9b5fed2cde32e19df1b2a0c5583140486", "committedDate": "2020-05-02T15:45:46Z", "message": "IGNITE-12967: fix client node snapshot start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/5802b49c092dc65adf45af2ac9a212409e199e5f", "committedDate": "2020-05-03T08:40:16Z", "message": "IGNITE-12967: add test with throwing ex on client node"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjEyNDA0", "url": "https://github.com/apache/ignite/pull/7767#pullrequestreview-404612404", "createdAt": "2020-05-03T12:15:09Z", "commit": {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxMjoxNToxMFrOGPriLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxMjoxNToxMFrOGPriLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA5NTA4Nw==", "bodyText": "If oldest node left cluster user will get not clear exception. What it mean?  Snapshot will be created or not? What user should to do? I suggest to clarify public exceptions.\nFor now, exception looks like:\nclass org.apache.ignite.cluster.ClusterGroupEmptyException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:921)\n\tat org.apache.ignite.internal.util.IgniteUtils$6.apply(IgniteUtils.java:919)\n\tat org.apache.ignite.internal.util.IgniteUtils.convertException(IgniteUtils.java:1077)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.convertException(IgniteFutureImpl.java:168)\n\tat org.apache.ignite.internal.util.future.IgniteFutureImpl.get(IgniteFutureImpl.java:137)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.testClusterSnapshotFromClientNodeStop(IgniteClusterSnapshotSelfTest.java:887)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\n\tat org.apache.ignite.testframework.junits.GridAbstractTest$7.run(GridAbstractTest.java:2213)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: class org.apache.ignite.internal.cluster.ClusterGroupEmptyCheckedException: Cluster group is empty.\n\tat org.apache.ignite.internal.util.IgniteUtils.emptyTopologyException(IgniteUtils.java:5062)\n\tat org.apache.ignite.internal.processors.closure.GridClosureProcessor.callAsync(GridClosureProcessor.java:694)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync0(IgniteComputeImpl.java:773)\n\tat org.apache.ignite.internal.IgniteComputeImpl.applyAsync(IgniteComputeImpl.java:757)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteSnapshotManager.createSnapshot(IgniteSnapshotManager.java:659)\n\tat org.apache.ignite.internal.processors.cache.persistence.snapshot.IgniteClusterSnapshotSelfTest.lambda$testClusterSnapshotFromClientNodeStop$15(IgniteClusterSnapshotSelfTest.java:883)\n\tat org.apache.ignite.testframework.GridTestUtils.lambda$runAsync$2(GridTestUtils.java:1153)\n\tat org.apache.ignite.testframework.GridTestUtils$7.call(GridTestUtils.java:1474)\n\tat org.apache.ignite.testframework.GridTestThread.run(GridTestThread.java:84)", "url": "https://github.com/apache/ignite/pull/7767#discussion_r419095087", "createdAt": "2020-05-03T12:15:10Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +648,13 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {\n+                return cctx.kernalContext().grid()\n+                    .compute(cctx.kernalContext().grid().cluster()\n+                        .forNodeId(U.oldest(cctx.kernalContext().discovery().aliveServerNodes(), null).id()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5802b49c092dc65adf45af2ac9a212409e199e5f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91f4cc417ae27eb3fba7237e48298305ab1e308c", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/91f4cc417ae27eb3fba7237e48298305ab1e308c", "committedDate": "2020-05-04T13:21:29Z", "message": "IGNITE-12967: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134a1a64ac8f9f8d96dd52dc13cb68f4c432b139", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/134a1a64ac8f9f8d96dd52dc13cb68f4c432b139", "committedDate": "2020-05-06T18:30:26Z", "message": "Merge branch 'master' into ignite-12967"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8281877c6903ba09bdc02e19913ab14a9f2041e3", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/8281877c6903ba09bdc02e19913ab14a9f2041e3", "committedDate": "2020-05-06T18:43:31Z", "message": "IGNITE-12967: fix minor issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/bbce3760f12baceb94e5f1044ea5acb6548df749", "committedDate": "2020-05-06T18:44:48Z", "message": "IGNITE-12967: revert unnecessary changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTE0NTc3", "url": "https://github.com/apache/ignite/pull/7767#pullrequestreview-406914577", "createdAt": "2020-05-06T19:17:58Z", "commit": {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToxNzo1OFrOGRhylA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToxNzo1OFrOGRhylA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMjU5Ng==", "bodyText": "What happens if the client will be disconnected? U.oldest(..) can return null.", "url": "https://github.com/apache/ignite/pull/7767#discussion_r421032596", "createdAt": "2020-05-06T19:17:58Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -648,6 +649,22 @@ public boolean isSnapshotCreating() {\n             if (!clusterState.hasBaselineTopology())\n                 throw new IgniteException(\"Snapshot operation has been rejected. The baseline topology is not configured for cluster.\");\n \n+            if (cctx.kernalContext().clientNode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbce3760f12baceb94e5f1044ea5acb6548df749"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05334b6080e864ae062ab3a3e2dfd195d4467aa0", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/05334b6080e864ae062ab3a3e2dfd195d4467aa0", "committedDate": "2020-05-06T21:39:43Z", "message": "IGNITE-12967: fix nullpointer exception if client node is the one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f77789643f85f06a45b1d8163d177d015fd89b9", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/3f77789643f85f06a45b1d8163d177d015fd89b9", "committedDate": "2020-05-07T13:44:42Z", "message": "IGNITE-12967: fix exception handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/a058894255bc46d890dc9b1dad4c0ea2a5b67888", "committedDate": "2020-05-07T17:34:06Z", "message": "IGNITE-12967: fix user exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDkzMjE4", "url": "https://github.com/apache/ignite/pull/7767#pullrequestreview-408093218", "createdAt": "2020-05-08T08:43:09Z", "commit": {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0MzowOVrOGSeP0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODo0MzowOVrOGSeP0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMzEyMw==", "bodyText": "Should this task be marked as @GridInternal ?", "url": "https://github.com/apache/ignite/pull/7767#discussion_r422023123", "createdAt": "2020-05-08T08:43:09Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -1230,4 +1245,37 @@ public ClusterSnapshotFuture(UUID rqId, String name) {\n             return super.onDone(res, err, cancel);\n         }\n     }\n+\n+    /** Start creation of cluster snapshot closure. */\n+    private static class CreateSnapshotClosure implements IgniteClosure<String, Void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a058894255bc46d890dc9b1dad4c0ea2a5b67888"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df1274774caa42150ea40ff3e95eb0a14501721c", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/df1274774caa42150ea40ff3e95eb0a14501721c", "committedDate": "2020-05-08T08:59:18Z", "message": "IGNITE-12967: add annotation grid internal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTAyNDkx", "url": "https://github.com/apache/ignite/pull/7767#pullrequestreview-408102491", "createdAt": "2020-05-08T09:00:30Z", "commit": {"oid": "df1274774caa42150ea40ff3e95eb0a14501721c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2614, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}