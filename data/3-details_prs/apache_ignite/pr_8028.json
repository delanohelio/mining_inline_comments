{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTUwMTk3", "number": 8028, "title": "IGNITE-13126: Reduce continuous query heap usage", "bodyText": "Thank you for submitting the pull request to the Apache Ignite.\nIn order to streamline the review of the contribution\nwe ask you to ensure the following steps have been taken:\nThe Contribution Checklist\n\n There is a single JIRA ticket related to the pull request.\n The web-link to the pull request is attached to the JIRA ticket.\n The JIRA ticket has the Patch Available state.\n The pull request body describes changes that have been made.\nThe description explains WHAT and WHY was made instead of HOW.\n The pull request title is treated as the final commit message.\nThe following pattern must be used: IGNITE-XXXX Change summary where XXXX - number of JIRA issue.\n A reviewer has been mentioned through the JIRA comments\n(see the Maintainers list)\n The pull request has been checked by the Teamcity Bot and\nthe green visa attached to the JIRA ticket (see TC.Bot: Check PR)\n\nNotes\n\nHow to Contribute\nCoding abbreviation rules\nCoding Guidelines\nApache Ignite Teamcity Bot\n\nIf you need any help, please email dev@ignite.apache.org or ask an\u0443 advice on http://asf.slack.com #ignite channel.", "createdAt": "2020-07-13T10:01:49Z", "url": "https://github.com/apache/ignite/pull/8028", "merged": true, "mergeCommit": {"oid": "42260b8efe67887d1f42393380f5ed79240c2423"}, "closed": true, "closedAt": "2020-09-14T10:55:01Z", "author": {"login": "Mmuzaf"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0ee05AH2gAyNDQ4MTUwMTk3OmZkNDJjOTdjMTg2YzdjODIyMzk3OTlkYjYzN2Q4MTQ4NDkzZmVkOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIw1hcAFqTQ4NzYzMDczNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd42c97c186c7c82239799db637d8148493fed9b", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/fd42c97c186c7c82239799db637d8148493fed9b", "committedDate": "2020-07-13T10:00:58Z", "message": "IGNITE-13126: change backupQ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bc7e0f8cbcaa6837b21d86821b72094604ae703", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/9bc7e0f8cbcaa6837b21d86821b72094604ae703", "committedDate": "2020-07-13T14:12:50Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6772765b7e83b0ef90a94ea7ee928bdf2c8398b2", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/6772765b7e83b0ef90a94ea7ee928bdf2c8398b2", "committedDate": "2020-07-13T14:22:48Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "309c5c089e544f5aa7bd341288b4f2737ebf0725", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/309c5c089e544f5aa7bd341288b4f2737ebf0725", "committedDate": "2020-07-13T14:34:47Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0ea34ae41725c1b973ccc9cce17a584641ef8f0", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/c0ea34ae41725c1b973ccc9cce17a584641ef8f0", "committedDate": "2020-07-13T14:40:19Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe5582938091adf21fe46651f83073d6e9c5fc5", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/8fe5582938091adf21fe46651f83073d6e9c5fc5", "committedDate": "2020-07-13T14:44:33Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd5a08684f354f8c1af1d1126c717ca66f40dee1", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/fd5a08684f354f8c1af1d1126c717ca66f40dee1", "committedDate": "2020-07-13T15:48:30Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f68ab75611e7ea053e6b546dc70e72f72ff6738", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/2f68ab75611e7ea053e6b546dc70e72f72ff6738", "committedDate": "2020-07-13T15:55:30Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc22390258282bb23aaef2e69509bdb2812cd13c", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/dc22390258282bb23aaef2e69509bdb2812cd13c", "committedDate": "2020-07-14T11:07:00Z", "message": "IGNITE-13126: wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f9356f5e64d47f5bfc4d18f27af9864ee6b42f9", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/0f9356f5e64d47f5bfc4d18f27af9864ee6b42f9", "committedDate": "2020-07-23T17:30:56Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f5ce67ffdaaf42c4087a1500bfb1a4d35e8e263", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/7f5ce67ffdaaf42c4087a1500bfb1a4d35e8e263", "committedDate": "2020-08-03T09:38:20Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1750aa594bba7ad218cd2c753d1931544e8978d4", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/1750aa594bba7ad218cd2c753d1931544e8978d4", "committedDate": "2020-08-03T11:59:36Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da362530e79e8695cda570560f6857e93043710", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/2da362530e79e8695cda570560f6857e93043710", "committedDate": "2020-08-05T13:14:29Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c365757516c71d5bc62e3c93098cb37c665b8419", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/c365757516c71d5bc62e3c93098cb37c665b8419", "committedDate": "2020-09-04T19:46:03Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ce7db2c642dfad4345f72bef7eb4ae74b6713a", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/a1ce7db2c642dfad4345f72bef7eb4ae74b6713a", "committedDate": "2020-09-04T19:58:56Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8e497b96ee2d2b3b327b4fa148c5ace745e9ae1", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/b8e497b96ee2d2b3b327b4fa148c5ace745e9ae1", "committedDate": "2020-09-07T16:54:06Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24f1604dbd20006233502ebaed7a1f0ddb1eb930", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/24f1604dbd20006233502ebaed7a1f0ddb1eb930", "committedDate": "2020-09-07T16:54:47Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba", "committedDate": "2020-09-08T16:48:00Z", "message": "IGNITE-13126 update cq filtered entries creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzUxMjQz", "url": "https://github.com/apache/ignite/pull/8028#pullrequestreview-486751243", "createdAt": "2020-09-11T12:13:31Z", "commit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjoxMzozMlrOHQcW-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjoxOToxNVrOHQchog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMzg5OA==", "bodyText": "Add line break, please", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487003898", "createdAt": "2020-09-11T12:13:32Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java", "diffHunk": "@@ -76,80 +78,58 @@\n     private final GridAtomicLong ackedUpdCntr = new GridAtomicLong(0);\n \n     /**\n-     * @param part Partition number.\n+     * @param currPartCntr Current partition counter.\n      * @param log Continuous query category logger.\n      */\n-    CacheContinuousQueryEventBuffer(int part, IgniteLogger log) {\n-        this.part = part;\n+    CacheContinuousQueryEventBuffer(LongUnaryOperator currPartCntr, IgniteLogger log) {\n+        this.currPartCntr = currPartCntr;\n         this.log = log;\n     }\n \n     /**\n-     * @param part Partition number.\n+     * @param log Continuous query category logger.\n      */\n-    CacheContinuousQueryEventBuffer(int part) {\n-        this(part, null);\n+    CacheContinuousQueryEventBuffer(IgniteLogger log) {\n+        this((backup) -> 0, log);\n     }\n \n     /**\n      * @param updateCntr Acknowledged counter.\n      */\n-    void cleanupBackupQueue(Long updateCntr) {\n-        Iterator<CacheContinuousQueryEntry> it = backupQ.iterator();\n-\n-        while (it.hasNext()) {\n-            CacheContinuousQueryEntry backupEntry = it.next();\n-\n-            if (backupEntry.updateCounter() <= updateCntr)\n-                it.remove();\n-        }\n-\n+    void cleanupOnAck(long updateCntr) {\n+        backupQ.removeIf(backupEntry -> backupEntry.updateCounter() <= updateCntr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwNjYyNg==", "bodyText": "I suggest to revert this change. It's not related to the issue.", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487006626", "createdAt": "2020-09-11T12:19:15Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryPartitionRecovery.java", "diffHunk": "@@ -155,8 +155,8 @@ void resetTopologyCache() {\n                     if (!entry.isFiltered())\n                         entries.add(new CacheContinuousQueryEvent<K, V>(cache, cctx, entry));\n \n-                    if (log.isDebugEnabled())\n-                        log.debug(\"Partition was lost [lastFiredEvt=\" + lastFiredEvt +\n+                    if (log.isInfoEnabled())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODc1NDA1", "url": "https://github.com/apache/ignite/pull/8028#pullrequestreview-486875405", "createdAt": "2020-09-11T14:48:32Z", "commit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDo0ODozMlrOHQiCNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDo0ODozMlrOHQiCNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Njg4Nw==", "bodyText": "Empty map can be returned if entries == null || filteredFactory == null", "url": "https://github.com/apache/ignite/pull/8028#discussion_r487096887", "createdAt": "2020-09-11T14:48:32Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryEventBuffer.java", "diffHunk": "@@ -376,34 +338,32 @@ private Batch initBatch(AffinityTopologyVersion topVer, boolean backup) {\n         /** */\n         private CacheContinuousQueryEntry[] entries;\n \n-        /** */\n-        private final AffinityTopologyVersion topVer;\n-\n         /**\n          * @param filtered Number of filtered events before this batch.\n          * @param entries Entries array.\n-         * @param topVer Current event topology version.\n          * @param startCntr Start counter.\n          */\n-        Batch(long startCntr, long filtered, CacheContinuousQueryEntry[] entries, AffinityTopologyVersion topVer) {\n+        Batch(long startCntr, long filtered, CacheContinuousQueryEntry[] entries) {\n             assert startCntr >= 0;\n             assert filtered >= 0;\n \n             this.startCntr = startCntr;\n             this.filtered = filtered;\n             this.entries = entries;\n-            this.topVer = topVer;\n \n             endCntr = startCntr + BUF_SIZE - 1;\n         }\n \n         /**\n-         * @param res Current entries.\n-         * @return Entries to send as part of backup queue.\n+         * @param filteredFactory Factory which produces filtered entries.\n+         * @return Map of collected entries.\n          */\n-        @Nullable synchronized TreeMap<Long, CacheContinuousQueryEntry> flushCurrentEntries(\n-            @Nullable TreeMap<Long, CacheContinuousQueryEntry> res) {\n-            if (entries == null)\n+        synchronized Map<Long, CacheContinuousQueryEntry> flushCurrentEntries(\n+            BiFunction<Long, Long, CacheContinuousQueryEntry> filteredFactory\n+        ) {\n+            Map<Long, CacheContinuousQueryEntry> res = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7eeae6869c5ad2eb69ed88eb4f4f0b516290ba"}, "originalPosition": 272}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60d29a5ddbac0db19f301242de7fa13b1735deb", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/f60d29a5ddbac0db19f301242de7fa13b1735deb", "committedDate": "2020-09-14T09:57:39Z", "message": "IGNITE-12126 fix review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2425aa1e9ee3ac75f7c623a571d6d33d7b52b776", "author": {"user": {"login": "Mmuzaf", "name": "Maxim Muzafarov"}}, "url": "https://github.com/apache/ignite/commit/2425aa1e9ee3ac75f7c623a571d6d33d7b52b776", "committedDate": "2020-09-14T10:01:22Z", "message": "Merge branch 'master' into ignite-13126"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjMwNzM2", "url": "https://github.com/apache/ignite/pull/8028#pullrequestreview-487630736", "createdAt": "2020-09-14T10:42:32Z", "commit": {"oid": "2425aa1e9ee3ac75f7c623a571d6d33d7b52b776"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3253, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}