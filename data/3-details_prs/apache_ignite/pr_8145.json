{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjIzOTE5", "number": 8145, "title": "IGNITE-13349: Tcp discovery statistics migrated to the new metrics framework.", "bodyText": "Thank you for submitting the pull request to the Apache Ignite.\nIn order to streamline the review of the contribution\nwe ask you to ensure the following steps have been taken:\nThe Contribution Checklist\n\n There is a single JIRA ticket related to the pull request.\n The web-link to the pull request is attached to the JIRA ticket.\n The JIRA ticket has the Patch Available state.\n The pull request body describes changes that have been made.\nThe description explains WHAT and WHY was made instead of HOW.\n The pull request title is treated as the final commit message.\nThe following pattern must be used: IGNITE-XXXX Change summary where XXXX - number of JIRA issue.\n A reviewer has been mentioned through the JIRA comments\n(see the Maintainers list)\n The pull request has been checked by the Teamcity Bot and\nthe green visa attached to the JIRA ticket (see TC.Bot: Check PR)\n\nNotes\n\nHow to Contribute\nCoding abbreviation rules\nCoding Guidelines\nApache Ignite Teamcity Bot\n\nIf you need any help, please email dev@ignite.apache.org or ask an\u0443 advice on http://asf.slack.com #ignite channel.", "createdAt": "2020-08-12T08:52:49Z", "url": "https://github.com/apache/ignite/pull/8145", "merged": true, "mergeCommit": {"oid": "9f4ac43415d4f219d0e48edb0030b93d6c7d6d53"}, "closed": true, "closedAt": "2020-08-18T09:31:10Z", "author": {"login": "nizhikov"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9ziHWgH2gAyNDY2NjIzOTE5OmQzOGY2MzFmMzRlOTJkOGNjNWNiMjY2YTQ3YTYxZmEzZDVjYzY2MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdADn0zgH2gAyNDY2NjIzOTE5OmYyMDdmNTNkMWEyNjQyMDFhOTBiZTRjMDE3MTVjZDU2NDQ1NjQxNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d38f631f34e92d8cc5cb266a47a61fa3d5cc6600", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/d38f631f34e92d8cc5cb266a47a61fa3d5cc6600", "committedDate": "2020-08-11T09:37:53Z", "message": "IGNITE-13347: `InitialSize`, `MaxSize` metrics added to data region metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584e50ec05e507c7efab537373bb78fe61d6068d", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/584e50ec05e507c7efab537373bb78fe61d6068d", "committedDate": "2020-08-11T10:33:29Z", "message": "IGNITE-13347: code review fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a2962d31245bbcf37499f906d7edc08079bcb0", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/71a2962d31245bbcf37499f906d7edc08079bcb0", "committedDate": "2020-08-12T08:45:02Z", "message": "IGNITE-13349: Tcp discovery statistics migrated to the new metrics framework."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4891a42e83a90ac31c6a75513bd8c5ddc3fed64", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/f4891a42e83a90ac31c6a75513bd8c5ddc3fed64", "committedDate": "2020-08-12T08:47:11Z", "message": "Merge branch 'master' into IGNITE-13349"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "120b28ae46a3d3c7ea3dfe6cf802379dd99c08d8", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/120b28ae46a3d3c7ea3dfe6cf802379dd99c08d8", "committedDate": "2020-08-12T14:16:08Z", "message": "IGNITE-13349: Unused code removed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3d26995fee997eecc44e9ad9894b8a04660490", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/5d3d26995fee997eecc44e9ad9894b8a04660490", "committedDate": "2020-08-12T14:48:02Z", "message": "IGNITE-13349: Unused code removed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c499072072c50819c298b2de070b94f65db9019c", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/c499072072c50819c298b2de070b94f65db9019c", "committedDate": "2020-08-17T07:49:12Z", "message": "Merge branch 'master' into IGNITE-13349"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b332e99b77bf39dbb923964e1ca90e5db7e12c0", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/9b332e99b77bf39dbb923964e1ca90e5db7e12c0", "committedDate": "2020-08-17T08:01:42Z", "message": "IGNITE-13349: code style fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MzI3NjE0", "url": "https://github.com/apache/ignite/pull/8145#pullrequestreview-468327614", "createdAt": "2020-08-17T09:58:37Z", "commit": {"oid": "9b332e99b77bf39dbb923964e1ca90e5db7e12c0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOTo1ODozN1rOHBiOog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMDowMDozN1rOHBiS4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM3MTQyNg==", "bodyText": "Do we want to make a set of constants for (\"io\", \"discovery\")?", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471371426", "createdAt": "2020-08-17T09:58:37Z", "author": {"login": "ingvard"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java", "diffHunk": "@@ -2115,6 +2115,20 @@ protected void onExchange(DiscoveryDataPacket dataPacket, ClassLoader clsLdr) {\n     @Override public void spiStart(@Nullable String igniteInstanceName) throws IgniteSpiException {\n         initializeImpl();\n \n+        MetricRegistry discoReg =\n+            ((IgniteEx)ignite()).context().metric().registry(metricName(\"io\", \"discovery\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b332e99b77bf39dbb923964e1ca90e5db7e12c0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM3MjUxNQ==", "bodyText": "Is it mistake?  long duration = U.currentTimeMillis() - startTs;  startTs is always null.", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471372515", "createdAt": "2020-08-17T10:00:37Z", "author": {"login": "ingvard"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/internal/TcpDiscoveryStatistics.java", "diffHunk": "@@ -287,23 +158,18 @@ public synchronized void onMessageProcessingStarted(TcpDiscoveryAbstractMessage\n     public synchronized void onMessageProcessingFinished(TcpDiscoveryAbstractMessage msg) {\n         assert msg != null;\n \n-        Long startTs = msgsProcStartTs.get(msg.id());\n+        Long startTs = msgsProcStartTs.remove(msg.id());\n \n-        if (startTs != null) {\n+        if (startTs == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b332e99b77bf39dbb923964e1ca90e5db7e12c0"}, "originalPosition": 294}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9c500116d904427f665d65bdf7d64981cb926fc", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/a9c500116d904427f665d65bdf7d64981cb926fc", "committedDate": "2020-08-17T10:17:27Z", "message": "IGNITE-13349: revert error fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfe0182bc2ac20adb42f4041e5a016684f100bf9", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/bfe0182bc2ac20adb42f4041e5a016684f100bf9", "committedDate": "2020-08-17T12:07:20Z", "message": "IGNITE-13349: Client mode fixes. Test improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa691d449c5d18ffb8aa0d01b9d11ba0cc3ae68", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/1aa691d449c5d18ffb8aa0d01b9d11ba0cc3ae68", "committedDate": "2020-08-17T12:11:44Z", "message": "IGNITE-13349: Constant introduced."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/a3232c4678bec14cbfabe258182633a24b8e6971", "committedDate": "2020-08-17T12:15:20Z", "message": "IGNITE-13349: code style fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDU1MTEy", "url": "https://github.com/apache/ignite/pull/8145#pullrequestreview-468455112", "createdAt": "2020-08-17T13:19:42Z", "commit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoxOTo0M1rOHBoaMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoyODoyNVrOHBov4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ3MjY5MA==", "bodyText": "Why the public API was changed?", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471472690", "createdAt": "2020-08-17T13:19:43Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java", "diffHunk": "@@ -1358,15 +1363,6 @@ public long getPendingMessagesRegistered() {\n         return stats.pendingMessagesRegistered();\n     }\n \n-    /**\n-     * Gets pending messages discarded count.\n-     *\n-     * @return Pending messages registered count.\n-     */\n-    public long getPendingMessagesDiscarded() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ3NjAwNA==", "bodyText": "Now we can get NPE from public methods until SPI was started.", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471476004", "createdAt": "2020-08-17T13:25:01Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java", "diffHunk": "@@ -359,7 +364,7 @@\n     private Marshaller marsh;\n \n     /** Statistics. */\n-    protected final TcpDiscoveryStatistics stats = new TcpDiscoveryStatistics();\n+    protected TcpDiscoveryStatistics stats;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ3ODI0Mw==", "bodyText": "Can be one-line", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471478243", "createdAt": "2020-08-17T13:28:25Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpi.java", "diffHunk": "@@ -2115,6 +2109,23 @@ protected void onExchange(DiscoveryDataPacket dataPacket, ClassLoader clsLdr) {\n     @Override public void spiStart(@Nullable String igniteInstanceName) throws IgniteSpiException {\n         initializeImpl();\n \n+        MetricRegistry discoReg =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDc2ODA3", "url": "https://github.com/apache/ignite/pull/8145#pullrequestreview-468476807", "createdAt": "2020-08-17T13:46:07Z", "commit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzo0NjowN1rOHBpbfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzo0NjowN1rOHBpbfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ4OTQwNw==", "bodyText": "Why this changed?", "url": "https://github.com/apache/ignite/pull/8145#discussion_r471489407", "createdAt": "2020-08-17T13:46:07Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySpiMBeanTest.java", "diffHunk": "@@ -64,21 +70,121 @@\n      */\n     @Test\n     public void testMBean() throws Exception {\n-        startGrids(3);\n+        int cnt = 3;\n+        int cliIdx = cnt - 1;\n+\n+        startGrids(cnt - 1);\n+        startClientGrid(cliIdx);\n+\n+        ClusterNode crd = U.oldest(grid(0).context().discovery().aliveServerNodes(), null);\n+\n+        assertNotNull(crd);\n \n         try {\n-            for (int i = 0; i < 3; i++) {\n+            for (int i = 0; i < cnt; i++) {\n                 IgniteEx grid = grid(i);\n \n+                MetricRegistry discoReg = grid.context().metric().registry(DISCO_METRICS);\n+\n                 TcpDiscoverySpiMBean bean = getMxBean(grid.context().igniteInstanceName(), \"SPIs\",\n                     TcpDiscoverySpi.class, TcpDiscoverySpiMBean.class);\n \n                 assertNotNull(bean);\n+\n                 assertEquals(grid.cluster().topologyVersion(), bean.getCurrentTopologyVersion());\n+                assertEquals(grid.cluster().topologyVersion(),\n+                    discoReg.<LongMetric>findMetric(\"CurrentTopologyVersion\").value());\n+\n+                if (i != cliIdx) {\n+                    assertEquals(crd.id(), bean.getCoordinator());\n+                    assertEquals(crd.id(), discoReg.<ObjectMetric<UUID>>findMetric(\"Coordinator\").value());\n+                }\n+                else {\n+                    assertNull(bean.getCoordinator());\n+                    assertNull(discoReg.findMetric(\"Coordinator\"));\n+                }\n+\n+                if (grid.localNode().id().equals(bean.getCoordinator())) {\n+                    assertTrue(bean.getCoordinatorSinceTimestamp() > 0);\n+                    assertTrue(discoReg.<LongMetric>findMetric(\"CoordinatorSince\").value() > 0);\n+                }\n+                else {\n+                    assertEquals(0, bean.getCoordinatorSinceTimestamp());\n+\n+                    if (i == cliIdx)\n+                        assertNull(discoReg.findMetric(\"CoordinatorSince\"));\n+                    else\n+                        assertEquals(0L, discoReg.<LongMetric>findMetric(\"CoordinatorSince\").value());\n+                }\n+\n+                // `getNodesJoined` returns count of joined nodes since local node startup.\n+                assertEquals((cnt - 1) - i, bean.getNodesJoined());\n+                assertEquals((cnt - 1) - i, discoReg.<IntMetric>findMetric(\"JoinedNodes\").value());\n+\n+                assertEquals(0L, bean.getNodesFailed());\n+                assertEquals(0, discoReg.<IntMetric>findMetric(\"FailedNodes\").value());\n+\n+                assertEquals(0L, bean.getNodesLeft());\n+                assertEquals(0, discoReg.<IntMetric>findMetric(\"LeftNodes\").value());\n+\n+                assertTrue(bean.getTotalReceivedMessages() > 0);\n+                assertTrue(discoReg.<IntMetric>findMetric(\"TotalReceivedMessages\").value() > 0);\n+\n+                assertTrue(bean.getTotalProcessedMessages() > 0);\n+                assertTrue(discoReg.<IntMetric>findMetric(\"TotalProcessedMessages\").value() > 0);\n+\n+                if (i != cliIdx) {\n+                    assertTrue(bean.getPendingMessagesRegistered() > 0);\n+                    assertTrue(discoReg.<IntMetric>findMetric(\"PendingMessagesRegistered\").value() > 0);\n+                }\n+                else {\n+                    assertEquals(0, bean.getPendingMessagesRegistered());\n+                    assertEquals(0, discoReg.<IntMetric>findMetric(\"PendingMessagesRegistered\").value());\n+                }\n+\n+                assertEquals(0, bean.getPendingMessagesDiscarded());\n \n                 bean.dumpRingStructure();\n                 assertTrue(strLog.toString().contains(\"TcpDiscoveryNodesRing\"));\n+\n+                assertFalse(bean.getProcessedMessages().isEmpty());\n+                assertFalse(bean.getReceivedMessages().isEmpty());\n+                assertTrue(bean.getMaxMessageProcessingTime() > 0);\n+                assertEquals(i == cliIdx, bean.isClientMode());\n+            }\n+\n+            stopGrid(0);\n+\n+            crd = U.oldest(grid(1).context().discovery().aliveServerNodes(), null);\n+\n+            for (int i = 1; i < cnt; i++) {\n+                IgniteEx grid = grid(i);\n+\n+                MetricRegistry discoReg = grid.context().metric().registry(DISCO_METRICS);\n+\n+                TcpDiscoverySpiMBean bean = getMxBean(grid.context().igniteInstanceName(), \"SPIs\",\n+                    TcpDiscoverySpi.class, TcpDiscoverySpiMBean.class);\n+\n+                assertNotNull(bean);\n+\n+                assertEquals(grid.cluster().topologyVersion(), bean.getCurrentTopologyVersion());\n+                assertEquals(grid.cluster().topologyVersion(),\n+                    discoReg.<LongMetric>findMetric(\"CurrentTopologyVersion\").value());\n+\n+                if (i != cliIdx) {\n+                    assertEquals(crd.id(), bean.getCoordinator());\n+                    assertEquals(crd.id(), discoReg.<ObjectMetric<UUID>>findMetric(\"Coordinator\").value());\n+                }\n+\n+                if (grid.localNode().id().equals(crd.id())) {\n+                    assertTrue(bean.getCoordinatorSinceTimestamp() > 0);\n+                    assertTrue(discoReg.<LongMetric>findMetric(\"CoordinatorSince\").value() > 0);\n+                }\n+\n+                assertEquals(1L, bean.getNodesLeft());\n+                assertEquals(1, discoReg.<IntMetric>findMetric(\"LeftNodes\").value());\n             }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3232c4678bec14cbfabe258182633a24b8e6971"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271170baac7a8e4c18314f82c228a073747d1676", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/271170baac7a8e4c18314f82c228a073747d1676", "committedDate": "2020-08-17T13:51:32Z", "message": "IGNITE-13349: public API changes revert."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b19d0b4bde8d2c5528cb2d275184b8907bb70dd1", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/b19d0b4bde8d2c5528cb2d275184b8907bb70dd1", "committedDate": "2020-08-17T14:08:08Z", "message": "IGNITE-13349: review fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTAzMzky", "url": "https://github.com/apache/ignite/pull/8145#pullrequestreview-468503392", "createdAt": "2020-08-17T14:16:55Z", "commit": {"oid": "b19d0b4bde8d2c5528cb2d275184b8907bb70dd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c29c204978f308738b0721a2247fddd15723cbd8", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/c29c204978f308738b0721a2247fddd15723cbd8", "committedDate": "2020-08-17T15:40:59Z", "message": "IGNITE-13349: test fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f207f53d1a264201a90be4c01715cd5644564158", "author": {"user": {"login": "nizhikov", "name": "Nikolay"}}, "url": "https://github.com/apache/ignite/commit/f207f53d1a264201a90be4c01715cd5644564158", "committedDate": "2020-08-18T09:30:27Z", "message": "IGNITE-13349: Ip finder added to the test."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3224, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}