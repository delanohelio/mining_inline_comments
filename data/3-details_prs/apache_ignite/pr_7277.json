{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MjU0NTM0", "number": 7277, "title": "IGNITE-12549 fix mapping queries on replication cache during rebalance", "bodyText": "", "createdAt": "2020-01-21T11:26:21Z", "url": "https://github.com/apache/ignite/pull/7277", "merged": true, "mergeCommit": {"oid": "51ef799c2ea3fdb76fccc433099dcc75359276d8"}, "closed": true, "closedAt": "2020-03-06T08:45:09Z", "author": {"login": "macrergate"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8fS-VAH2gAyMzY1MjU0NTM0OmY3YjJiYjVhMGRjMTRlYzc4ZTJjMDE2ZGVjZWYwOWY0YzYzNWE4ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc39j0bgFqTQ1NDY0ODE0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7b2bb5a0dc14ec78e2c016decef09f4c635a8fd", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/f7b2bb5a0dc14ec78e2c016decef09f4c635a8fd", "committedDate": "2020-01-21T11:18:10Z", "message": "IGNITE-12549 fix mapping queries on replication cache during rebalance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c", "committedDate": "2020-01-21T11:48:58Z", "message": "IGNITE-12549 fix code style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTgzNzg5", "url": "https://github.com/apache/ignite/pull/7277#pullrequestreview-346583789", "createdAt": "2020-01-22T13:27:21Z", "commit": {"oid": "f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyNzoyMVrOFgb-_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMzoyNzoyMVrOFgb-_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NzI0NA==", "bodyText": "I worry about a case when there is no node OWNING all partitions (i.e. actually some partitions are lost). In a such case we will use all affinity nodes for a query execution. And duplicates seems possible. I suggest at least resort to any (single) affinity node in such case. And it looks like the previous behavior was the same.", "url": "https://github.com/apache/ignite/pull/7277#discussion_r369557244", "createdAt": "2020-01-22T13:27:21Z", "author": {"login": "pavlukhin"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +655,22 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);\n \n-                if (cctx.affinityNode())\n+                if (cctx.affinityNode() && !cctx.topology().localPartitionMap().hasMovingPartitions())\n                     return Collections.singletonList(cctx.localNode());\n \n                 Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n \n-                return affNodes.isEmpty() ? affNodes : Collections.singletonList(F.rand(affNodes));\n+                List<ClusterNode> nodes = new ArrayList<>(affNodes);\n+\n+                Collections.shuffle(nodes);\n+\n+                for (ClusterNode node : nodes) {\n+                    if (!cctx.topology().partitions(node.id()).hasMovingPartitions()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a04c96259e7ace7df4a733daccc59353de67e4", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/70a04c96259e7ace7df4a733daccc59353de67e4", "committedDate": "2020-02-14T10:29:53Z", "message": "IGNITE-12549 fix race on topology"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/6053a8b756d88af71cdab1ba40a1bec08345f4a8", "committedDate": "2020-02-14T10:31:42Z", "message": "Merge branch 'master' of https://github.com/apache/ignite into ignite-12549"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzQ0MDIy", "url": "https://github.com/apache/ignite/pull/7277#pullrequestreview-362744022", "createdAt": "2020-02-21T16:14:05Z", "commit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjoxNDowNlrOFs8Xug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjoxODoxMVrOFs8gjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MDc3OA==", "bodyText": "Does the case with explicit partition work correctly after made changes? Previously we had a single node projection for REPLICATED caches, but now not.", "url": "https://github.com/apache/ignite/pull/7277#discussion_r382670778", "createdAt": "2020-02-21T16:14:06Z", "author": {"login": "pavlukhin"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +656,30 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MTg2OA==", "bodyText": "I suppose we can evaluate this branch without holding a topology read lock, cannot we?", "url": "https://github.com/apache/ignite/pull/7277#discussion_r382671868", "createdAt": "2020-02-21T16:16:02Z", "author": {"login": "pavlukhin"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +656,30 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);\n \n-                if (cctx.affinityNode())\n-                    return Collections.singletonList(cctx.localNode());\n+                GridDhtPartitionTopology topology = cctx.topology();\n \n-                Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n+                topology.readLock();\n \n-                return affNodes.isEmpty() ? affNodes : Collections.singletonList(F.rand(affNodes));\n+                try {\n+                    if (cctx.affinityNode() && !topology.localPartitionMap().hasMovingPartitions())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MjgxMw==", "bodyText": "Code style: no curly braces for single-line if statements.", "url": "https://github.com/apache/ignite/pull/7277#discussion_r382672813", "createdAt": "2020-02-21T16:17:45Z", "author": {"login": "pavlukhin"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +656,30 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);\n \n-                if (cctx.affinityNode())\n-                    return Collections.singletonList(cctx.localNode());\n+                GridDhtPartitionTopology topology = cctx.topology();\n \n-                Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n+                topology.readLock();\n \n-                return affNodes.isEmpty() ? affNodes : Collections.singletonList(F.rand(affNodes));\n+                try {\n+                    if (cctx.affinityNode() && !topology.localPartitionMap().hasMovingPartitions())\n+                        return Collections.singletonList(cctx.localNode());\n+\n+                    Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n+\n+                    List<ClusterNode> nodes = new ArrayList<>(affNodes);\n+\n+                    Collections.shuffle(nodes);\n+\n+                    for (ClusterNode node : nodes) {\n+                        if (!topology.partitions(node.id()).hasMovingPartitions()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MzAzNg==", "bodyText": "Code style: finally should go from a new line.", "url": "https://github.com/apache/ignite/pull/7277#discussion_r382673036", "createdAt": "2020-02-21T16:18:11Z", "author": {"login": "pavlukhin"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +656,30 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);\n \n-                if (cctx.affinityNode())\n-                    return Collections.singletonList(cctx.localNode());\n+                GridDhtPartitionTopology topology = cctx.topology();\n \n-                Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n+                topology.readLock();\n \n-                return affNodes.isEmpty() ? affNodes : Collections.singletonList(F.rand(affNodes));\n+                try {\n+                    if (cctx.affinityNode() && !topology.localPartitionMap().hasMovingPartitions())\n+                        return Collections.singletonList(cctx.localNode());\n+\n+                    Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n+\n+                    List<ClusterNode> nodes = new ArrayList<>(affNodes);\n+\n+                    Collections.shuffle(nodes);\n+\n+                    for (ClusterNode node : nodes) {\n+                        if (!topology.partitions(node.id()).hasMovingPartitions()) {\n+                            return Collections.singletonList(node);\n+                        }\n+                    }\n+\n+                    return affNodes;\n+                } finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6053a8b756d88af71cdab1ba40a1bec08345f4a8"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b17f9024b434eac7bd3d9ad1d0da2351f590cc3", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/3b17f9024b434eac7bd3d9ad1d0da2351f590cc3", "committedDate": "2020-02-27T15:49:56Z", "message": "Merge branch 'master' of https://github.com/apache/ignite into ignite-12549"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "504a35271d3fde6a98277a88a4c1cae3ba696f97", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/504a35271d3fde6a98277a88a4c1cae3ba696f97", "committedDate": "2020-02-27T16:01:31Z", "message": "IGNITE-12549 fixed codestyle, added test for scan query by partition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9fda76ed422f20ecd020ba70a464cb6b765b42c", "author": {"user": {"login": "macrergate", "name": "Sergey Kosarev"}}, "url": "https://github.com/apache/ignite/commit/c9fda76ed422f20ecd020ba70a464cb6b765b42c", "committedDate": "2020-02-27T16:06:41Z", "message": "IGNITE-12549 removed wrong changes(another issue)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjQ4MTQ3", "url": "https://github.com/apache/ignite/pull/7277#pullrequestreview-454648147", "createdAt": "2020-07-24T05:55:15Z", "commit": {"oid": "f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTo1NToxNVrOG2j5Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTo1NToxNVrOG2j5Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2NDQwNw==", "bodyText": "!cctx.topology().partitions(node.id()).hasMovingPartitions() is throwing Nullpointer exception at runtime for non-pationed Cache and the Cluster starts without any Cache and then Cline Node join and populate the Cache. cctx.topology().partitions(node.id()) is returning null", "url": "https://github.com/apache/ignite/pull/7277#discussion_r459864407", "createdAt": "2020-07-24T05:55:15Z", "author": {"login": "sumanentc"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/query/GridCacheQueryAdapter.java", "diffHunk": "@@ -654,12 +655,22 @@ private boolean isSafeLossPolicy() {\n                 if (prj != null || part != null)\n                     return nodes(cctx, prj, part);\n \n-                if (cctx.affinityNode())\n+                if (cctx.affinityNode() && !cctx.topology().localPartitionMap().hasMovingPartitions())\n                     return Collections.singletonList(cctx.localNode());\n \n                 Collection<ClusterNode> affNodes = nodes(cctx, null, null);\n \n-                return affNodes.isEmpty() ? affNodes : Collections.singletonList(F.rand(affNodes));\n+                List<ClusterNode> nodes = new ArrayList<>(affNodes);\n+\n+                Collections.shuffle(nodes);\n+\n+                for (ClusterNode node : nodes) {\n+                    if (!cctx.topology().partitions(node.id()).hasMovingPartitions()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3e513013f4b8e3afd49e58e6adb88e6ab3c0e7c"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2878, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}