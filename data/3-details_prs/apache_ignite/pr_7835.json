{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODMzNjk3", "number": 7835, "title": "IGNITE-13012 Make node connection checking rely on the configuration. Simplify node ping routine.", "bodyText": "This PR is first step of improvement and quickening of node failure detection. We should obtain simple, predictable and configurable node pinging.\nFixes:\n\n\nConnection failure is kept within IgniteConfiguration.failureDetectionTimeout instead of 500ms + IgniteConfiguration.failureDetectionTimeout.\n\n\nInterval of connection checking in TCP discovery made rely on configured failure detection timeout. Previous 500ms is the minimal interval at now. This is done to get robust node pinging and keep failure detection timeout accurate.\n\n\nRemoved additional connection checking. This premature node ping relied also on any received message. Imagine: if node 2 receives no message from previous node 1 within some time, it decides to do extra ping next node 3 not waiting for regular ping. This brought mess, confusion and gave no considerable guaranties.\n\n\nBehavior changes:\n\n\nTcpDiscoveryConnectionCheckMessage is not sent if there is a message traffic within actual failure detection timeout because any message checks connection.\n\n\nFailure detection timeout is now overal timeout since last message sent. Not a timeout on current message exchange.", "createdAt": "2020-05-22T10:08:23Z", "url": "https://github.com/apache/ignite/pull/7835", "merged": true, "mergeCommit": {"oid": "87aad40d231f22da700a5034cb82967202eb5a6a"}, "closed": true, "closedAt": "2020-06-24T08:42:45Z", "author": {"login": "Vladsz83"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjvNLlAH2gAyNDIxODMzNjk3OjNiNjY4NTYyMDc3YWRhMzk4MDBmODAxMGJmMjhiYzA4NDIxOGI0NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuF9p4AH2gAyNDIxODMzNjk3OmJlNmUyZWQ0ZTIyYTRjYjZiMzEzNWY4NzNjMDMwYWIyNTM2YzYzOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b668562077ada39800f8010bf28bc084218b462", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/3b668562077ada39800f8010bf28bc084218b462", "committedDate": "2020-05-22T09:53:22Z", "message": "IGNITE-13021 : First impl."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "675c069ef7efbb85c03ed072fe4d497194d04d27", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/675c069ef7efbb85c03ed072fe4d497194d04d27", "committedDate": "2020-05-22T14:56:12Z", "message": "IGNITE-13012 : merged with master. Minor fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ddf057eb49db983c57a22461b0f8644afaa422", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/e4ddf057eb49db983c57a22461b0f8644afaa422", "committedDate": "2020-05-25T08:23:03Z", "message": "IGNITE-13012 : merged with master. Minor fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf93ac157526169db0d1cac1bdb19905d472fdab", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/bf93ac157526169db0d1cac1bdb19905d472fdab", "committedDate": "2020-05-25T11:29:29Z", "message": "IGNITE-13012 : halt timeouts on the ping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e729270020ab8274d32f922596be716f1829d028", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/e729270020ab8274d32f922596be716f1829d028", "committedDate": "2020-05-25T11:29:55Z", "message": "Merge remote-tracking branch 'origin/IGNITE-13012' into IGNITE-13012\n\n# Conflicts:\n#\tmodules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a9f7dfaa08052a64a4a229743eef0c4628fad8", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/47a9f7dfaa08052a64a4a229743eef0c4628fad8", "committedDate": "2020-05-25T16:24:18Z", "message": "IGNITE-13012 : +test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c929faf829c3243b4b511e0fb13ce867a83642e", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/2c929faf829c3243b4b511e0fb13ce867a83642e", "committedDate": "2020-05-25T17:38:09Z", "message": "IGNITE-13012 : redeem of the timeouts. Fixed test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245943a154e0e8cd083ad90a552ce69cf4b989f6", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/245943a154e0e8cd083ad90a552ce69cf4b989f6", "committedDate": "2020-05-25T17:46:11Z", "message": "IGNITE-13012 : redeem of the timeouts. Fixed test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7d58aea09f78dec4f99080f70b472da50b3796f", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/f7d58aea09f78dec4f99080f70b472da50b3796f", "committedDate": "2020-05-26T15:43:07Z", "message": "Merge branch 'master' into IGNITE-13012"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f4dabf5a0bdab538fc9aaa37383880772b80cac", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/8f4dabf5a0bdab538fc9aaa37383880772b80cac", "committedDate": "2020-05-27T10:25:23Z", "message": "IGNITE-13012 : Fixed tests. + a test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62f5d6a2b67ff97a94d08f19c9d4ff4dfff4a3ed", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/62f5d6a2b67ff97a94d08f19c9d4ff4dfff4a3ed", "committedDate": "2020-05-27T14:13:48Z", "message": "IGNITE-13012 : fix of coordinator failure test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc2375627a678008cef6256546af8b333135c941", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/dc2375627a678008cef6256546af8b333135c941", "committedDate": "2020-05-28T07:51:03Z", "message": "IGNITE-13012 : test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjk0NTc3", "url": "https://github.com/apache/ignite/pull/7835#pullrequestreview-421694577", "createdAt": "2020-06-01T09:01:42Z", "commit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwOTowMTo0MlrOGdDnRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMTowNzo0NlrOGdGzxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyMTA5NQ==", "bodyText": "Do we need a method with a single usage?\nWill it be more suitable to inline it?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433121095", "createdAt": "2020-06-01T09:01:42Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java", "diffHunk": "@@ -1916,6 +1924,12 @@ private void clearNodeAddedMessage(TcpDiscoveryAbstractMessage msg) {\n         return threads;\n     }\n \n+    /** @return Total timeout on complete message exchange in network over established connection. */\n+    protected long effectiveExchangeTimeout() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzNzcyOA==", "bodyText": "magic number?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433137728", "createdAt": "2020-06-01T09:40:50Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/GridFailFastNodeFailureDetectionSelfTest.java", "diffHunk": "@@ -107,7 +107,7 @@ public void testFailFast() throws Exception {\n \n         failNode(ignite1);\n \n-        assert failLatch.await(1500, MILLISECONDS);\n+        assert failLatch.await(ignite1.configuration().getFailureDetectionTimeout() + 50, MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NDQ2Ng==", "bodyText": "We should wait FDT - (cutTime - lastMesssentTime) here, not full FDT.\n\n\nThis code will fail if we wait for 0.8 of FDT in the first case and 0.1 in the second, but everything will be fine in general.\nIt seems you should wait for the rest of the timeout at the first case, but for the rest of the rest it at second.", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433154466", "createdAt": "2020-06-01T10:21:01Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java", "diffHunk": "@@ -3611,15 +3602,26 @@ else if (!spi.failureDetectionTimeoutEnabled() && (e instanceof\n                                 if (latencyCheck && log.isInfoEnabled())\n                                     log.info(\"Latency check message has been written to socket: \" + msg.id());\n \n+                                boolean ping = msg instanceof TcpDiscoveryConnectionCheckMessage;\n+\n+                                long timeout = timeoutHelper.nextTimeoutChunk(spi.getSocketTimeout());\n+\n+                                // For the ping we take half of actual failure detection. Another half is the interval.\n                                 spi.writeToSocket(newNextNode ? newNext : next,\n                                     sock,\n                                     out,\n                                     msg,\n-                                    timeoutHelper.nextTimeoutChunk(spi.getSocketTimeout()));\n+                                    ping && spi.failureDetectionTimeoutEnabled() ? timeout / 2 : timeout\n+                                );\n+\n+                                timeout = timeoutHelper.nextTimeoutChunk(ackTimeout0);\n \n                                 long tsNanos0 = System.nanoTime();\n \n-                                int res = spi.readReceipt(sock, timeoutHelper.nextTimeoutChunk(ackTimeout0));\n+                                int res = spi.readReceipt(sock, ping && spi.failureDetectionTimeoutEnabled() ?\n+                                    timeout / 2 : timeout);\n+\n+                                updateLastSentMessageTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3MTUwMw==", "bodyText": "what the reason to set sent time here?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433171503", "createdAt": "2020-06-01T11:03:11Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java", "diffHunk": "@@ -3469,6 +3456,8 @@ else if (log.isTraceEnabled())\n                                         }\n                                     }\n \n+                                    updateLastSentMessageTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3MTU0Ng==", "bodyText": "what the reason to set sent time here?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433171546", "createdAt": "2020-06-01T11:03:17Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java", "diffHunk": "@@ -3574,6 +3563,8 @@ else if (!spi.failureDetectionTimeoutEnabled() && (e instanceof\n \n                                     int res = spi.readReceipt(sock, timeoutHelper.nextTimeoutChunk(ackTimeout0));\n \n+                                    updateLastSentMessageTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3MzE4Mg==", "bodyText": "why changed?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433173182", "createdAt": "2020-06-01T11:07:07Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoveryImpl.java", "diffHunk": "@@ -303,7 +303,7 @@ public int boundPort() throws IgniteSpiException {\n     /**\n      * @return connection check interval.\n      */\n-    public long connectionCheckInterval() {\n+    long connectionCheckInterval() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3MzM5MQ==", "bodyText": "magic number", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433173391", "createdAt": "2020-06-01T11:07:34Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/ConnectionCheckTest.java", "diffHunk": "@@ -0,0 +1,310 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.spi.discovery.tcp;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.Socket;\n+import java.util.concurrent.Exchanger;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.util.GridTestClockTimer;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryAbstractMessage;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryConnectionCheckMessage;\n+import org.apache.ignite.spi.discovery.tcp.messages.TcpDiscoveryNodeFailedMessage;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static com.sun.tools.javac.util.Assert.check;\n+\n+/**\n+ * Checks pinging next node in the ring relies on configured timeouts.\n+ */\n+public class ConnectionCheckTest extends GridCommonAbstractTest {\n+    /** Number of the ping messages to ensure node pinging works well. */\n+    private static final int PING_MESSAGES_CNT_TO_ENSURE = 15;\n+\n+    /** Timer granulation in milliseconds. See {@link GridTestClockTimer}. */\n+    private static final int TIMER_GRANULATION = 10;\n+\n+    /**\n+     * Maximal additional delay before sending the ping message including timer granulation in and other delays\n+     * like code delays and/or GC.\n+     */\n+    private static final int ACCEPTABLE_ADDITIONAL_DELAY = TIMER_GRANULATION + 50;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE3MzQ0Nw==", "bodyText": "magic number?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r433173447", "createdAt": "2020-06-01T11:07:46Z", "author": {"login": "anton-vinogradov"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TcpDiscoverySelfTest.java", "diffHunk": "@@ -1976,7 +1976,8 @@ private void checkFailedCoordinatorNode(SegmentationPolicy segPlc) throws Except\n \n             ignite1.configuration().getDiscoverySpi().failNode(coordId, null);\n \n-            assertTrue(failedLatch.await(2000, MILLISECONDS));\n+            // Wait for the configured timeout + other possible code delays.\n+            assertTrue(failedLatch.await(ignite1.configuration().getFailureDetectionTimeout() + 50, MILLISECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc2375627a678008cef6256546af8b333135c941"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "708934305864f86b40d35a54d71d59c43a248cc5", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/708934305864f86b40d35a54d71d59c43a248cc5", "committedDate": "2020-06-02T09:46:43Z", "message": "IGNITE-13012 : Reverted tests. Failure detection timeout is shared with\nprevious message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3515f40a973c3fb542af32154a626b1d61e92d8e", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/3515f40a973c3fb542af32154a626b1d61e92d8e", "committedDate": "2020-06-02T10:18:25Z", "message": "IGNITE-13012 : fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dca4f19e4c0a06972fd249d22fb15953d1cb21c", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/9dca4f19e4c0a06972fd249d22fb15953d1cb21c", "committedDate": "2020-06-03T10:01:37Z", "message": "IGNITE-13012 : + test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd00c208bb41836b0d5ef08fdcb6565e517f94eb", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/bd00c208bb41836b0d5ef08fdcb6565e517f94eb", "committedDate": "2020-06-03T15:07:44Z", "message": "IGNITE-13012 : + test fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4647253ac8e76f9f2f9c39f51f150b101c05917", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/c4647253ac8e76f9f2f9c39f51f150b101c05917", "committedDate": "2020-06-04T08:50:02Z", "message": "IGNITE-13012 : +10ms as the timer granulation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5370831f07938f4b54cd8ec8dcd012d9d58242d5", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/5370831f07938f4b54cd8ec8dcd012d9d58242d5", "committedDate": "2020-06-04T10:34:41Z", "message": "IGNITE-13012 : test fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ad35e89369cc452f2955e19377d4c250523637", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/a9ad35e89369cc452f2955e19377d4c250523637", "committedDate": "2020-06-04T15:15:22Z", "message": "IGNITE-13012 : + 10ms as acceptable code delay."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8fad436597bfc36d538f8e6897dc6f5ec0a037a", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/a8fad436597bfc36d538f8e6897dc6f5ec0a037a", "committedDate": "2020-06-05T07:17:08Z", "message": "IGNITE-13012 : test redeemed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c426fcd0e63144924c819eadf830ad90392595", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/45c426fcd0e63144924c819eadf830ad90392595", "committedDate": "2020-06-05T12:07:33Z", "message": "IGNITE-13016 : faster test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d58fe44f892978025bedd323d1394e4ee826f8c", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/0d58fe44f892978025bedd323d1394e4ee826f8c", "committedDate": "2020-06-08T22:20:21Z", "message": "Revert \"IGNITE-13134 : test duration fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f7a6082f889c34a588f6d3f07a20612dd723dcc", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/7f7a6082f889c34a588f6d3f07a20612dd723dcc", "committedDate": "2020-06-09T07:07:25Z", "message": "IGNITE-13012 : faster test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde7e7cafb15365b133c133415b54e8a24ae039b", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/dde7e7cafb15365b133c133415b54e8a24ae039b", "committedDate": "2020-06-09T07:10:13Z", "message": "IGNITE-13012 : minority."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b40043b97ab210ea2781b70f08be424f100e65f", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/7b40043b97ab210ea2781b70f08be424f100e65f", "committedDate": "2020-06-09T07:10:39Z", "message": "Merge branch 'master' into IGNITE-13012"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b9735e692e1ff9ff88b2b5c983f9383317726d", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/e1b9735e692e1ff9ff88b2b5c983f9383317726d", "committedDate": "2020-06-15T13:51:49Z", "message": "IGNITE-13012 : spelling fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b07dd53e3c313e407f892b2b3fe7681f44a2ca4", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/1b07dd53e3c313e407f892b2b3fe7681f44a2ca4", "committedDate": "2020-06-15T13:54:04Z", "message": "IGNITE-13012 : empty lines."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4be00090b35127a537b1959dee4cca2f0ba5732", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/a4be00090b35127a537b1959dee4cca2f0ba5732", "committedDate": "2020-06-15T14:37:54Z", "message": "IGNITE-13012 :renaming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c3108fd15e34c0d9ccc59eedfe41f1b3d256b4", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/d9c3108fd15e34c0d9ccc59eedfe41f1b3d256b4", "committedDate": "2020-06-15T14:38:57Z", "message": "IGNITE-13012 :renamings. Removes test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzE3MDEx", "url": "https://github.com/apache/ignite/pull/7835#pullrequestreview-430717011", "createdAt": "2020-06-15T14:47:59Z", "commit": {"oid": "d9c3108fd15e34c0d9ccc59eedfe41f1b3d256b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71435c2c9bebd50ba06a9acdf33a4a42ab064c1f", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/71435c2c9bebd50ba06a9acdf33a4a42ab064c1f", "committedDate": "2020-06-23T12:04:20Z", "message": "reverted removal of 'public'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzI5Njg5", "url": "https://github.com/apache/ignite/pull/7835#pullrequestreview-435729689", "createdAt": "2020-06-23T12:27:56Z", "commit": {"oid": "d9c3108fd15e34c0d9ccc59eedfe41f1b3d256b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjoyNzo1NlrOGnm1XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjoyNzo1NlrOGnm1XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE4MzkwMA==", "bodyText": "Why not to call updateLastSentMessageTime method here as well?", "url": "https://github.com/apache/ignite/pull/7835#discussion_r444183900", "createdAt": "2020-06-23T12:27:56Z", "author": {"login": "sergey-chugunov-1985"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/discovery/tcp/ServerImpl.java", "diffHunk": "@@ -6192,40 +6188,21 @@ private void checkMetricsReceiving() {\n         }\n \n         /**\n-         * Check connection aliveness status.\n+         * Check connection to next node in the ring.\n          */\n         private void checkConnection() {\n             Boolean hasRemoteSrvNodes = null;\n \n-            if (spi.failureDetectionTimeoutEnabled() && !failureThresholdReached &&\n-                U.millisSinceNanos(locNode.lastExchangeTimeNanos()) >= connCheckThreshold &&\n-                spiStateCopy() == CONNECTED &&\n-                (hasRemoteSrvNodes = ring.hasRemoteServerNodes())) {\n-\n-                if (log.isInfoEnabled())\n-                    log.info(\"Local node seems to be disconnected from topology (failure detection timeout \" +\n-                        \"is reached) [failureDetectionTimeout=\" + spi.failureDetectionTimeout() +\n-                        \", connCheckInterval=\" + CON_CHECK_INTERVAL + ']');\n-\n-                failureThresholdReached = true;\n-\n-                // Reset sent time deliberately to force sending connection check message.\n-                lastTimeConnCheckMsgSent = 0;\n-            }\n-\n-            long elapsed = (lastTimeConnCheckMsgSent + CON_CHECK_INTERVAL) - U.currentTimeMillis();\n+            long elapsed = (lastRingMsgSentTime + U.millisToNanos(connCheckInterval)) - System.nanoTime();\n \n             if (elapsed > 0)\n                 return;\n \n             if (hasRemoteSrvNodes == null)\n                 hasRemoteSrvNodes = ring.hasRemoteServerNodes();\n \n-            if (hasRemoteSrvNodes) {\n+            if (hasRemoteSrvNodes)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9c3108fd15e34c0d9ccc59eedfe41f1b3d256b4"}, "originalPosition": 191}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322242a42206004bf73a8dfa9583329eba87b918", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/322242a42206004bf73a8dfa9583329eba87b918", "committedDate": "2020-06-23T13:12:04Z", "message": "IGNITE-13012 : removed redundant hasRemoteSrvNodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6e2ed4e22a4cb6b3135f873c030ab2536c6398", "author": {"user": {"login": "Vladsz83", "name": "Vladimir Steshin"}}, "url": "https://github.com/apache/ignite/commit/be6e2ed4e22a4cb6b3135f873c030ab2536c6398", "committedDate": "2020-06-23T14:03:28Z", "message": "Merge branch 'master' into IGNITE-13012"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2524, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}