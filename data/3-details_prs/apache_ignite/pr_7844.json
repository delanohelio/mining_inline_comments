{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNzk0MDgx", "number": 7844, "title": "IGNITE-12823 .NET: Fix service method calls with typed array args", "bodyText": "Bug: Service calls don't work when one of the parameters is an array other than Object[] - both .NET -> Java and .NET -> .NET.\nReason: array element type is lost when passing service arguments on Java side: GridServiceProxy.invokeMethod() takes Object[] args.\nFix: convert Object[] to T[] right before service invocation by looking at the service method signature to determine the type.", "createdAt": "2020-05-25T15:03:25Z", "url": "https://github.com/apache/ignite/pull/7844", "merged": true, "mergeCommit": {"oid": "b0c5a15e91a64bf02c9ded5ae4eb051ff6a3215a"}, "closed": true, "closedAt": "2020-05-29T20:16:41Z", "author": {"login": "ptupitsyn"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckxM0FAH2gAyNDIyNzk0MDgxOjkwNjU1MzNlMjdiOWY5NzQ0ZmFkODhjYTkxMjRmNzU2MTZlZGE5ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl_q_BgFqTQyMDgyNDY3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9065533e27b9f9744fad88ca9124f75616eda9fa", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/9065533e27b9f9744fad88ca9124f75616eda9fa", "committedDate": "2020-05-25T14:46:42Z", "message": "Add tests and PoC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adb70d51a822b92fd7dac999f592d927813830d3", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/adb70d51a822b92fd7dac999f592d927813830d3", "committedDate": "2020-05-25T14:56:16Z", "message": "Both tests work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc8f02d55639a2177501f9b7340e2124052f09ec", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/bc8f02d55639a2177501f9b7340e2124052f09ec", "committedDate": "2020-05-25T15:02:19Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a70e50656f878c30fb2a5e520d46d44d7fb1fa", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/76a70e50656f878c30fb2a5e520d46d44d7fb1fa", "committedDate": "2020-05-25T20:42:14Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bafd58591d9492f10e0dfff547f499df12cbcab0", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/bafd58591d9492f10e0dfff547f499df12cbcab0", "committedDate": "2020-05-25T20:46:39Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "334e66ba7ab7789831cd897a96ac5daa58337b62", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/334e66ba7ab7789831cd897a96ac5daa58337b62", "committedDate": "2020-05-25T20:49:41Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94de5cab36c21d5e37dfc4348f1782b39d8d6034", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/94de5cab36c21d5e37dfc4348f1782b39d8d6034", "committedDate": "2020-05-25T20:57:39Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "549b25f00b8a9dde834886cfc157e713dc3c4e80", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/549b25f00b8a9dde834886cfc157e713dc3c4e80", "committedDate": "2020-05-25T20:59:50Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dba267a2c605acb7db20f718b57a9f2f1961c9e6", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/dba267a2c605acb7db20f718b57a9f2f1961c9e6", "committedDate": "2020-05-26T18:19:18Z", "message": "Merge remote-tracking branch 'origin/master' into ignite-12823"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e97fc7183b591e8d926872728554349d3f2508", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/01e97fc7183b591e8d926872728554349d3f2508", "committedDate": "2020-05-26T18:34:58Z", "message": "Adding tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38f79f3efc8de1de6aa19cb1ef38c01c34d9923f", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/38f79f3efc8de1de6aa19cb1ef38c01c34d9923f", "committedDate": "2020-05-26T18:37:09Z", "message": "Fix NullRef"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/81b729d29060c7476ae8d354f61b2b26027cb6cf", "committedDate": "2020-05-26T18:38:33Z", "message": "Add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTIyODY5", "url": "https://github.com/apache/ignite/pull/7844#pullrequestreview-419122869", "createdAt": "2020-05-27T12:03:23Z", "commit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjowMzoyM1rOGbGE-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjowMzoyM1rOGbGE-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDMxNQ==", "bodyText": "IgniteServices has a \"keep binary\" flag that makes the server side NOT to deserialize parameters, thus, allowing NOT having Java classes on the server. You need to do this block only if the \"keep binary\" flag is not set. Otherwise it will do that Array.newInstance thing even when \"keep binary = true\".", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431064315", "createdAt": "2020-05-27T12:03:23Z", "author": {"login": "kukushal"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/services/PlatformServices.java", "diffHunk": "@@ -581,6 +582,26 @@ public Object invoke(String mthdName, boolean srvKeepBinary, Object[] args)\n \n                 Method mtd = getMethod(serviceClass, mthdName, args);\n \n+                // Convert Object[] to T[] when required:\n+                // Ignite loses array item types when passing arguments through GridServiceProxy.\n+                for (int i = 0; i < args.length; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTIzNjEz", "url": "https://github.com/apache/ignite/pull/7844#pullrequestreview-419123613", "createdAt": "2020-05-27T12:04:28Z", "commit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjowNDoyOFrOGbGHIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjowNDoyOFrOGbGHIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDg2Nw==", "bodyText": "Please do the same in \"keep binary\" mode.", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431064867", "createdAt": "2020-05-27T12:04:28Z", "author": {"login": "kukushal"}, "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Services/ServicesTest.cs", "diffHunk": "@@ -859,18 +903,28 @@ public void TestCallJavaService()\n             Assert.AreEqual(7, svc.testBinarizable(new PlatformComputeBinarizable {Field = 6}).Field);\n \n             // Binary collections\n-            var arr = new [] {10, 11, 12}.Select(x => new PlatformComputeBinarizable {Field = x}).ToArray<object>();\n+            var arr  = new[] {10, 11, 12}.Select(x => new PlatformComputeBinarizable {Field = x}).ToArray();\n+            var arrOfObj = arr.ToArray<object>();\n+\n             Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableCollection(arr)\n                 .OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n-            Assert.AreEqual(new[] {11, 12, 13},\n-                svc.testBinarizableArray(arr).OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n+\n+            Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableArrayOfObjects(arrOfObj)\n+                .OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n+\n+            Assert.IsNull(svc.testBinarizableArrayOfObjects(null));\n+\n+            Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableArray(arr)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MTI4MjE1", "url": "https://github.com/apache/ignite/pull/7844#pullrequestreview-419128215", "createdAt": "2020-05-27T12:11:04Z", "commit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjoxMTowNFrOGbGUng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjoxMTowNFrOGbGUng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2ODMxOA==", "bodyText": "Can we repeat these checks in \"keep binary\" mode as well? (with\nvar binPrx = Services.WithKeepBinary().GetServiceProxy(SvcName);", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431068318", "createdAt": "2020-05-27T12:11:04Z", "author": {"login": "kukushal"}, "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Services/ServicesTest.cs", "diffHunk": "@@ -413,6 +413,50 @@ public void TestDuckTyping([Values(true, false)] bool local)\n             Assert.IsInstanceOf<InvalidCastException>(ex.InnerException);\n         }\n \n+        /// <summary>\n+        /// Test call service proxy from remote node with a methods having an array of user types and objects.\n+        /// </summary>\n+        [Test]\n+        public void TestCallServiceProxyWithMethodsHavingArrays()\n+        {\n+            // Deploy to the remote node.\n+            var nodeId = Grid2.GetCluster().GetLocalNode().Id;\n+\n+            var cluster = Grid1.GetCluster().ForNodeIds(nodeId);\n+\n+            cluster.GetServices().DeployNodeSingleton(SvcName, new TestIgniteServiceArraySerializable());\n+\n+            var typedArray = new[] {10, 11, 12}\n+                .Select(x => new PlatformComputeBinarizable {Field = x}).ToArray();\n+\n+            var objArray = typedArray.ToArray<object>();\n+\n+            var prx = Services.GetServiceProxy<ITestIgniteServiceArray>(SvcName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e27dd25bc8553a24fe6381ca9cf7c5038cb14fc6", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/e27dd25bc8553a24fe6381ca9cf7c5038cb14fc6", "committedDate": "2020-05-28T20:10:31Z", "message": "Adding tests with binary objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07868674eca40431ebebf3a13885cac74a4193c2", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/07868674eca40431ebebf3a13885cac74a4193c2", "committedDate": "2020-05-28T20:22:43Z", "message": "Adding tests with binary objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7cd9efdfb25aa09efe0d41aa6b09fc22f762ed", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/da7cd9efdfb25aa09efe0d41aa6b09fc22f762ed", "committedDate": "2020-05-28T20:26:12Z", "message": "Adding tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a59a85c0619be6104e93188e77b8b7c6fdb498", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/06a59a85c0619be6104e93188e77b8b7c6fdb498", "committedDate": "2020-05-28T20:27:20Z", "message": "Merge remote-tracking branch 'origin/master' into ignite-12823"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30bfd2d54906819dd6ff996d263f5aa78ef5e0ab", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/30bfd2d54906819dd6ff996d263f5aa78ef5e0ab", "committedDate": "2020-05-28T20:42:17Z", "message": "Adding tests with binary objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39a1070e33ec40fedfb584b55fe267938ace9634", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/39a1070e33ec40fedfb584b55fe267938ace9634", "committedDate": "2020-05-28T20:48:37Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODI0Njc2", "url": "https://github.com/apache/ignite/pull/7844#pullrequestreview-420824676", "createdAt": "2020-05-29T10:12:15Z", "commit": {"oid": "39a1070e33ec40fedfb584b55fe267938ace9634"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2530, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}