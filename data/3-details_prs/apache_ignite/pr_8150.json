{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NDUyOTA4", "number": 8150, "title": "IGNITE-13354 Add ClusterMetrics to the new framework", "bodyText": "Add metrics to the new framework:\n\nTopologyVersion\nTotalBaselineNodes\nTotalServerNodes\nTotalClientNodes\nActiveBaselineNodes", "createdAt": "2020-08-13T15:16:08Z", "url": "https://github.com/apache/ignite/pull/8150", "merged": true, "mergeCommit": {"oid": "054b7916261d146f8c3a08fb5bcad012a9cede6e"}, "closed": true, "closedAt": "2020-08-17T15:23:16Z", "author": {"login": "NSAmelchev"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-gg0qAH2gAyNDY3NDUyOTA4OjNhYThiOTBmNzdmYjM4ODk4MmMwNDEzYzY4MTk0ZGJmZmM4NTYwNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_xoLugFqTQ2ODQyMDE1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3aa8b90f77fb388982c0413c68194dbffc856046", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/3aa8b90f77fb388982c0413c68194dbffc856046", "committedDate": "2020-08-13T14:02:12Z", "message": "Add new metrics. With jmx deprecation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb738a5e01d229de3e4ef451897d9540e1a717e1", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/cb738a5e01d229de3e4ef451897d9540e1a717e1", "committedDate": "2020-08-13T15:12:44Z", "message": "Fix deprecation. Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47e529415f3cb19aaed109219e8ed1b0a3c623f8", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/47e529415f3cb19aaed109219e8ed1b0a3c623f8", "committedDate": "2020-08-13T17:17:53Z", "message": "Fix node stopping/client disconnected cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/ca44839c4c9df3787d6be8527626e09fe686b319", "committedDate": "2020-08-14T10:41:22Z", "message": "Remove TotalNodes metric"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTI0NTIy", "url": "https://github.com/apache/ignite/pull/8150#pullrequestreview-467524522", "createdAt": "2020-08-14T12:09:42Z", "commit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjowOTo0M1rOHAyP_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjowOTo0M1rOHAyP_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4NTM0MA==", "bodyText": "Can we use this metric and all below inside ClusterMetricsMXBeanImpl to keep single method to calculate metric value.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470585340", "createdAt": "2020-08-14T12:09:43Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/ClusterProcessor.java", "diffHunk": "@@ -607,6 +610,33 @@ private Boolean findLastFlag(Collection<Serializable> vals) {\n                 U.error(log, \"Failed to register MBean for cluster: \", e);\n             }\n         }\n+\n+        MetricRegistry reg = ctx.metric().registry(CLUSTER_METRICS);\n+\n+        reg.register(\"TopologyVersion\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTI2NDA4", "url": "https://github.com/apache/ignite/pull/8150#pullrequestreview-467526408", "createdAt": "2020-08-14T12:13:14Z", "commit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjoxMzoxNFrOHAyV6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjoxMzoxNFrOHAyV6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4Njg1Ng==", "bodyText": "Let's use merg.<IntMetrics>findMetric(\"XXX\").value() to avoid type casting.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470586856", "createdAt": "2020-08-14T12:13:14Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterBaselineNodesMetricsSelfTest.java", "diffHunk": "@@ -82,9 +92,13 @@ public void testBaselineNodes() throws Exception {\n         log.info(String.format(\">>> State #1: topology version = %d\", ignite0.cluster().topologyVersion()));\n \n         assertEquals(2, mxBeanCluster.getTotalServerNodes());\n+        assertEquals(2, ((IntMetric)mreg.findMetric(\"TotalServerNodes\")).value());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/d79d2c73cd3a0409dc9130fe639ec36e596b05ba", "committedDate": "2020-08-14T12:56:40Z", "message": "Avoid type casting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTYzMzU2", "url": "https://github.com/apache/ignite/pull/8150#pullrequestreview-467563356", "createdAt": "2020-08-14T13:13:16Z", "commit": {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoxMzoxNlrOHA0E4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoxMzoxNlrOHA0E4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTI2Nw==", "bodyText": "Let's return final modifier.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470615267", "createdAt": "2020-08-14T13:13:16Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterNodeMetricsSelfTest.java", "diffHunk": "@@ -310,7 +314,7 @@ public void testIoMetrics() throws Exception {\n      */\n     @Test\n     public void testClusterNodeMetrics() throws Exception {\n-        final Ignite ignite0 = grid();\n+        IgniteEx ignite0 = grid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ce7d53fc78659517e4dd5e9b0326233d09bf956", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/8ce7d53fc78659517e4dd5e9b0326233d09bf956", "committedDate": "2020-08-14T13:22:55Z", "message": "Revert final var"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5dea474d39b010cb824b70b2bdce05b7893ca34", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/f5dea474d39b010cb824b70b2bdce05b7893ca34", "committedDate": "2020-08-14T13:47:12Z", "message": "Reuse metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/3e9471b156e7b02a91f8d98e433d9c9789d1307a", "committedDate": "2020-08-14T14:26:44Z", "message": "Remove deprecated. Use separate method for metrics registration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjUyMTIz", "url": "https://github.com/apache/ignite/pull/8150#pullrequestreview-468252123", "createdAt": "2020-08-17T08:07:58Z", "commit": {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwODowNzo1OVrOHBejAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwODowNzo1OVrOHBejAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMTEwNQ==", "bodyText": "Let's remove this metric from new framework.\n\"CurrentTopologyVersion\" would be added by the #8145 in the \"io.discovery\" registry.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r471311105", "createdAt": "2020-08-17T08:07:59Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/ClusterMetricsMXBeanImpl.java", "diffHunk": "@@ -47,13 +54,37 @@\n     /** Cluster metrics update mutex. */\n     private final Object clusterMetricsMux = new Object();\n \n+    /** Topology version metric. */\n+    private final LongMetric topVer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92828f0527cc159ca0d012eae53dddb7f6fb6637", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/92828f0527cc159ca0d012eae53dddb7f6fb6637", "committedDate": "2020-08-17T09:27:40Z", "message": "Revert TopologyVersion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f68562b57ddebc512ad9e197d467700a0de1d7", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/e4f68562b57ddebc512ad9e197d467700a0de1d7", "committedDate": "2020-08-17T09:55:03Z", "message": "Move metrics registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41abe9acd173837ca98b1ac6ffd5c1b5f008bea7", "author": {"user": {"login": "NSAmelchev", "name": "Nikita Amelchev"}}, "url": "https://github.com/apache/ignite/commit/41abe9acd173837ca98b1ac6ffd5c1b5f008bea7", "committedDate": "2020-08-17T12:21:21Z", "message": "Move metrics registration 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDIwMTU5", "url": "https://github.com/apache/ignite/pull/8150#pullrequestreview-468420159", "createdAt": "2020-08-17T12:32:33Z", "commit": {"oid": "41abe9acd173837ca98b1ac6ffd5c1b5f008bea7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3233, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}