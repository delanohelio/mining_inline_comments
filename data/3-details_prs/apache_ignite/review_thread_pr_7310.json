{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2ODc2ODYw", "number": 7310, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTo0OTo1N1rODa7SNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDowOToxMlrODbKegA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTYwODg0OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTo0OTo1N1rOFiHmGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0OToyMlrOFibmvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMDM0Nw==", "bodyText": "Metric named ConsistentIdMetric but the constant for looking up named as by nodeId SENT_MESSAGES_BY_NODE_ID_METRIC_NAME why?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371320347", "createdAt": "2020-01-27T15:49:57Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n-                .findMetric(SENT_MESSAGES_BY_NODE_ID_METRIC_NAME);\n+            allSentMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n \n         rcvdMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n+            allRcvdMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n+\n+        sentMsgsCntByConsistentIdMetricFactory = consistentId ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODE4OA==", "bodyText": "I'll rename it.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648188", "createdAt": "2020-01-28T07:49:22Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n-                .findMetric(SENT_MESSAGES_BY_NODE_ID_METRIC_NAME);\n+            allSentMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n \n         rcvdMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n+            allRcvdMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n+\n+        sentMsgsCntByConsistentIdMetricFactory = consistentId ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMDM0Nw=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTczMzMwOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyMTozNFrOFiIy2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxODoyOToxMlrOFiv1uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw==", "bodyText": "Why we should keep this metric if it totally replaced with the new one?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371339993", "createdAt": "2020-01-27T16:21:34Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0Nzg1Mw==", "bodyText": "old JMX API", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647853", "createdAt": "2020-01-28T07:48:28Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk3OTcwNA==", "bodyText": "@ibessonov It seems there are no release with metrics by node. Old metric shows total sent/received message count.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371979704", "createdAt": "2020-01-28T18:29:12Z", "author": {"login": "agura"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY3NjAyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozODozNVrOFibZUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo1MDoyOFrOFiboJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA==", "bodyText": "Why this change?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371644754", "createdAt": "2020-01-28T07:38:35Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTcyMQ==", "bodyText": "Are we still need this factory?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645721", "createdAt": "2020-01-28T07:42:00Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NjkyMw==", "bodyText": "These things won't be exported as metrics. We have them for JMX support only.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371646923", "createdAt": "2020-01-28T07:45:44Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzE3OA==", "bodyText": "And yes, factory saves us from extra allocations, we discussed this privately.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647178", "createdAt": "2020-01-28T07:46:22Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODU1MQ==", "bodyText": "Can we map consistentId -> nodeId when the user requests data to reduce the amount of metrics we store internally?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648551", "createdAt": "2020-01-28T07:50:28Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY3OTc1OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0MDo0OFrOFibbvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0OTo1MFrOFibnVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTM3Mw==", "bodyText": "nodeId should be removed as it not used.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645373", "createdAt": "2020-01-28T07:40:48Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODM0MA==", "bodyText": "It is used in last line of the method.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648340", "createdAt": "2020-01-28T07:49:50Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTM3Mw=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 196}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY4MDE4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0MTowMlrOFibb-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0OTo1OFrOFibniw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTQzNQ==", "bodyText": "nodeId should be removed as it not used.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645435", "createdAt": "2020-01-28T07:41:02Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {\n             sentMsgsMetricsByType.computeIfAbsent(msg.directType(), sentMsgsCntByTypeMetricFactory).increment();\n \n-            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).increment();\n+            sentMsgsMetricsByConsistentId.computeIfAbsent(consistentId, sentMsgsCntByConsistentIdMetricFactory).increment();\n+\n+            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).incrementAndGet();\n         }\n \n         /**\n          * Collects statistics for message received by SPI.\n-         *\n-         * @param msg Received message.\n+         *  @param msg Received message.\n+         * @param consistentId Sender node consistent id.\n          * @param nodeId Sender node id.\n          */\n-        private void onMessageReceived(Message msg, UUID nodeId) {\n+        private void onMessageReceived(Message msg, Object consistentId, UUID nodeId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODM5NQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648395", "createdAt": "2020-01-28T07:49:58Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {\n             sentMsgsMetricsByType.computeIfAbsent(msg.directType(), sentMsgsCntByTypeMetricFactory).increment();\n \n-            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).increment();\n+            sentMsgsMetricsByConsistentId.computeIfAbsent(consistentId, sentMsgsCntByConsistentIdMetricFactory).increment();\n+\n+            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).incrementAndGet();\n         }\n \n         /**\n          * Collects statistics for message received by SPI.\n-         *\n-         * @param msg Received message.\n+         *  @param msg Received message.\n+         * @param consistentId Sender node consistent id.\n          * @param nodeId Sender node id.\n          */\n-        private void onMessageReceived(Message msg, UUID nodeId) {\n+        private void onMessageReceived(Message msg, Object consistentId, UUID nodeId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTQzNQ=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 214}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY4MjMxOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0MjoxNFrOFibdVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo1Nzo1NVrOFibxsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ==", "bodyText": "Are we still need this factory?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645781", "createdAt": "2020-01-28T07:42:14Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzI1MA==", "bodyText": "Yes", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647250", "createdAt": "2020-01-28T07:46:34Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MDk5NA==", "bodyText": "As I see in ticket descriptions we replacing nodeId with the consistentId, but the changes just add another copy of the same numbers, not replacing.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371650994", "createdAt": "2020-01-28T07:57:55Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY4MjcyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0MjoyN1rOFibdjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0ODowM1rOFibk3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTgzOQ==", "bodyText": "Are we still need this factory?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645839", "createdAt": "2020-01-28T07:42:27Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzcxMQ==", "bodyText": "Yes, this collection allows us to use HashMap in ThreadLocal entities without worrying about concurrent access - that was the main optimization point.\nBasically I emulate MetricRegistry with this collection.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647711", "createdAt": "2020-01-28T07:48:03Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTgzOQ=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY4MzAyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0MjozN1rOFibdtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo0ODoxNFrOFiblKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTg3Nw==", "bodyText": "Are we still need this factory?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645877", "createdAt": "2020-01-28T07:42:37Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();\n+\n+    /** Received messages metrics count grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allRcvdMsgsMetricsByNodeId = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0Nzc4NA==", "bodyText": "Yes, replied above.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647784", "createdAt": "2020-01-28T07:48:14Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();\n+\n+    /** Received messages metrics count grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allRcvdMsgsMetricsByNodeId = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTg3Nw=="}, "originalCommit": {"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzcxOTk1OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzo1OTozN1rOFibzqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTo0MToyMlrOFih_hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng==", "bodyText": "consistentId should be a part of session meta (ses.meta(CONSISTENT_ID_META). It has no meaning for the connectionKey class. An thus it will require much less changes in this PR.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371651496", "createdAt": "2020-01-28T07:59:37Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY2MzA1Mg==", "bodyText": "I don't think that this would require less changes, pretty much the same amount.\nI don't see any issues in storing consistentId near to nodeId, looks logical to me. Why do you think that it has no meaning?", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371663052", "createdAt": "2020-01-28T08:32:45Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY5MjUyMA==", "bodyText": "I see the following major reasons:\n\nConnectionKey is a public class from public API. Do you think changing public API is a good idea for a minor bug?\nconsistentId doesn't participate in equals and hashCode methods. For the person, who will take a look at ConnectionKey class the first time this would look weird because consistentId is not the same as nodeId.\nThis field is used only for metrics and does not have any meaning for a session connection key itself.\nYou are passing consistentId key for each constructor rather obtaining it from session attributes directly, so you should change each constructor and this will lead to unnecessary changes.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371692520", "createdAt": "2020-01-28T09:35:39Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcwMDE5MA==", "bodyText": "No, it's not: org.apache.ignite.spi.communication.tcp.internal.ConnectionKey\nIt's absolutely fine, other fields don't participate in equals and hashCode either.\n\nFine, I'll do it and we'll see if it got simpler. Maybe it is, I don't know for sure.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371700190", "createdAt": "2020-01-28T09:50:31Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcwMTQxMA==", "bodyText": "just for the protocol - I disagree with this change)", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371701410", "createdAt": "2020-01-28T09:52:46Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MjgzNg==", "bodyText": "@ibessonov thank you, please, let me know when you'll be done with changes. I'll take a final look.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371752836", "createdAt": "2020-01-28T11:41:22Z", "author": {"login": "Mmuzaf"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, "originalCommit": {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5ODA5NzkyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDowOToxM1rOFifZEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDowOToxM1rOFifZEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxMDIyNg==", "bodyText": "It seems these changes are not required.", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371710226", "createdAt": "2020-01-28T10:09:13Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java", "diffHunk": "@@ -562,20 +569,22 @@\n              */\n             private void onFirstMessage(final GridNioSession ses, Message msg) {\n                 UUID sndId;\n-\n-                ConnectionKey connKey;\n+                int connIdx;\n+                long connCnt;\n \n                 if (msg instanceof NodeIdMessage) {\n                     sndId = U.bytesToUuid(((NodeIdMessage)msg).nodeIdBytes(), 0);\n-                    connKey = new ConnectionKey(sndId, 0, -1);\n+                    connIdx = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af3d3f1d4962f3e53500174d63258c336c516267"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2578, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}