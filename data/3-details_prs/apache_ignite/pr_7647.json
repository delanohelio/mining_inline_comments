{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzAyNzUz", "number": 7647, "title": "IGNITE-12879 Refactors test configuration of discovery messages interceptors.", "bodyText": "", "createdAt": "2020-04-09T09:05:47Z", "url": "https://github.com/apache/ignite/pull/7647", "merged": true, "mergeCommit": {"oid": "9a897835d59475911ed368daa133b8d8fd39e5e8"}, "closed": true, "closedAt": "2020-04-17T08:18:53Z", "author": {"login": "ololo3000"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV9Co5gBqjMyMTg0NTIzOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYLgBmAFqTM5NDU2NDEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0de8af9abd37ea9258ecf15723ea97422f633e2f", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/0de8af9abd37ea9258ecf15723ea97422f633e2f", "committedDate": "2020-04-09T08:48:47Z", "message": "IGNITE-12879 Changes DiscoveryHook class methods naming."}, "afterCommit": {"oid": "5949c0fa49285b20de741043280ff2f46081ff69", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/5949c0fa49285b20de741043280ff2f46081ff69", "committedDate": "2020-04-09T13:58:22Z", "message": "IGNITE-12879 Refactors test configuration of discovery messages interception."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/f342e41600f7e14ad94d502618013dc0c8f1d4b1", "committedDate": "2020-04-09T14:16:10Z", "message": "IGNITE-12879 Refactors test configuration of discovery messages interceptors."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5949c0fa49285b20de741043280ff2f46081ff69", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/5949c0fa49285b20de741043280ff2f46081ff69", "committedDate": "2020-04-09T13:58:22Z", "message": "IGNITE-12879 Refactors test configuration of discovery messages interception."}, "afterCommit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/f342e41600f7e14ad94d502618013dc0c8f1d4b1", "committedDate": "2020-04-09T14:16:10Z", "message": "IGNITE-12879 Refactors test configuration of discovery messages interceptors."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODk0OTEz", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-390894913", "createdAt": "2020-04-09T15:24:22Z", "commit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNDoyMlrOGDdsLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNDoyMlrOGDdsLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NTM1OA==", "bodyText": "Why array needed?", "url": "https://github.com/apache/ignite/pull/7647#discussion_r406285358", "createdAt": "2020-04-09T15:24:22Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TestTcpDiscoverySpi.java", "diffHunk": "@@ -44,4 +52,19 @@\n     @Override public void simulateNodeFailure() {\n         super.simulateNodeFailure();\n     }\n+\n+    /** {@inheritDoc} */\n+    @Override public void setListener(@Nullable DiscoverySpiListener lsnr) {\n+        super.setListener(lsnr ==  null || discoveryHooks == null ? lsnr : wrap(lsnr, discoveryHooks));\n+    }\n+\n+    /**\n+     * Sets interceptors of discovery messages.\n+     *\n+     * @param discoveryHooks Interceptors of discovery messages.\n+     */\n+    @SuppressWarnings(\"AssignmentOrReturnOfFieldWithMutableType\")\n+    public void discoveryHooks(DiscoveryHook... discoveryHooks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTA3MzU3", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-390907357", "createdAt": "2020-04-09T15:38:11Z", "commit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTozODoxMVrOGDeR3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTozODoxMVrOGDeR3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTAwNg==", "bodyText": "I think we should add javadoc and assert that hook should be set before Discovery started.", "url": "https://github.com/apache/ignite/pull/7647#discussion_r406295006", "createdAt": "2020-04-09T15:38:11Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TestTcpDiscoverySpi.java", "diffHunk": "@@ -44,4 +52,19 @@\n     @Override public void simulateNodeFailure() {\n         super.simulateNodeFailure();\n     }\n+\n+    /** {@inheritDoc} */\n+    @Override public void setListener(@Nullable DiscoverySpiListener lsnr) {\n+        super.setListener(lsnr ==  null || discoveryHooks == null ? lsnr : wrap(lsnr, discoveryHooks));\n+    }\n+\n+    /**\n+     * Sets interceptors of discovery messages.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTE3NDE0", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-390917414", "createdAt": "2020-04-09T15:50:03Z", "commit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTo1MDowM1rOGDexSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTo1MDowM1rOGDexSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwMzA0OQ==", "bodyText": "I think we should provide customMsg as argument  (or instead of DiscoverySpiCustomMessage msg) and do not duplicate:\nDiscoveryCustomMessage customMsg = msg == null ?\n    null : (DiscoveryCustomMessage)IgniteUtils.field(msg, \"delegate\");", "url": "https://github.com/apache/ignite/pull/7647#discussion_r406303049", "createdAt": "2020-04-09T15:50:03Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/continuous/IgniteContinuousQueryMetadataUpdateTest.java", "diffHunk": "@@ -57,11 +55,26 @@\n     @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n         IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n \n-        TestDiscoverySpi discoSpi = new TestDiscoverySpi();\n+        TestTcpDiscoverySpi discoSpi = (TestTcpDiscoverySpi)cfg.getDiscoverySpi();\n \n-        discoSpi.setIpFinder(IP_FINDER);\n+        DiscoveryHook discoveryHook = new DiscoveryHook() {\n+            @Override public void beforeDiscovery(DiscoverySpiCustomMessage msg) {\n+                DiscoveryCustomMessage customMsg = msg == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f342e41600f7e14ad94d502618013dc0c8f1d4b1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "334947ce74434f1501d8e95a4c4d5a723f6f35db", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/334947ce74434f1501d8e95a4c4d5a723f6f35db", "committedDate": "2020-04-09T18:07:00Z", "message": "IGNITE-12879 Adds extended DiscoveryHook for custom discovery messages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDQxMTgx", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-391041181", "createdAt": "2020-04-09T18:41:25Z", "commit": {"oid": "334947ce74434f1501d8e95a4c4d5a723f6f35db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo0MToyNVrOGDk5Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo0MToyNVrOGDk5Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwMzM5MA==", "bodyText": "The afterDiscovery will be called not after discovery notifing listeners. delegate.onDiscovery is async.", "url": "https://github.com/apache/ignite/pull/7647#discussion_r406403390", "createdAt": "2020-04-09T18:41:25Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/testframework/GridTestUtils.java", "diffHunk": "@@ -164,32 +169,89 @@ public void ignite(IgniteEx ignite) {\n         }\n     }\n \n+    /**\n+     * Extended {@link DiscoveryHook} for {@link DiscoveryCustomMessage} interception.\n+     */\n+    public static class DiscoveryCustomMessageHook extends DiscoveryHook {\n+        /** {@inheritDoc} */\n+        @Override public void beforeDiscovery(DiscoverySpiCustomMessage msg) {\n+            if (!(msg instanceof CustomMessageWrapper))\n+                return;\n+\n+            beforeDiscovery(unwrap((CustomMessageWrapper)msg));\n+        }\n+\n+        /**\n+         * Handles {@link DiscoveryCustomMessage}.\n+         *\n+         * @param customMsg Intercepted {@link DiscoveryCustomMessage}.\n+         */\n+        public void beforeDiscovery(DiscoveryCustomMessage customMsg) {\n+            // No-op.\n+        }\n+\n+        /** {@inheritDoc} */\n+        @Override public void afterDiscovery(DiscoverySpiCustomMessage msg) {\n+            if (!(msg instanceof CustomMessageWrapper))\n+                return;\n+\n+            afterDiscovery(unwrap((CustomMessageWrapper)msg));\n+        }\n+\n+        /**\n+         * Handles {@link DiscoveryCustomMessage}.\n+         *\n+         * @param customMsg Intercepted {@link DiscoveryCustomMessage}.\n+         */\n+        public void afterDiscovery(DiscoveryCustomMessage customMsg) {\n+            // No-op.\n+        }\n+\n+        /**\n+         * Obtains {@link DiscoveryCustomMessage} from {@link CustomMessageWrapper}.\n+         *\n+         * @param wrapper Wrapper of {@link DiscoveryCustomMessage}.\n+         */\n+        private DiscoveryCustomMessage unwrap(CustomMessageWrapper wrapper) {\n+            return U.field(wrapper, \"delegate\");\n+        }\n+    }\n+\n     /**\n      * Injects {@link DiscoveryHook} into handling logic.\n      */\n     public static final class DiscoverySpiListenerWrapper implements DiscoverySpiListener {\n         /** */\n         private final DiscoverySpiListener delegate;\n \n-        /** */\n-        private final DiscoveryHook hook;\n+        /** Interceptors of discovery messages. */\n+        private final DiscoveryHook[] hooks;\n \n         /**\n          * @param delegate Delegate.\n-         * @param hook Hook.\n+         * @param hooks Interceptors of discovery messages.\n          */\n-        private DiscoverySpiListenerWrapper(DiscoverySpiListener delegate, DiscoveryHook hook) {\n-            this.hook = hook;\n+        private DiscoverySpiListenerWrapper(DiscoverySpiListener delegate, DiscoveryHook[] hooks) {\n+            this.hooks = hooks;\n             this.delegate = delegate;\n         }\n \n         /** {@inheritDoc} */\n-        @Override public IgniteFuture<?> onDiscovery(int type, long topVer, ClusterNode node, Collection<ClusterNode> topSnapshot, @Nullable Map<Long, Collection<ClusterNode>> topHist, @Nullable DiscoverySpiCustomMessage spiCustomMsg) {\n-            hook.handleDiscoveryMessage(spiCustomMsg);\n+        @Override public IgniteFuture<?> onDiscovery(\n+            int type,\n+            long topVer,\n+            ClusterNode node,\n+            Collection<ClusterNode> topSnapshot,\n+            @Nullable Map<Long, Collection<ClusterNode>> topHist,\n+            @Nullable DiscoverySpiCustomMessage spiCustomMsg\n+        ) {\n+            for (DiscoveryHook hook : hooks)\n+                hook.beforeDiscovery(spiCustomMsg);\n \n             IgniteFuture<?> fut = delegate.onDiscovery(type, topVer, node, topSnapshot, topHist, spiCustomMsg);\n \n-            hook.afterDiscovery(spiCustomMsg);\n+            for (DiscoveryHook hook : hooks)\n+                hook.afterDiscovery(spiCustomMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "334947ce74434f1501d8e95a4c4d5a723f6f35db"}, "originalPosition": 118}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a28b785f1ae2da1abc6c32cc7f9ef8c29b29b87f", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/a28b785f1ae2da1abc6c32cc7f9ef8c29b29b87f", "committedDate": "2020-04-09T19:26:37Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "884b87c5a0d90acfd47f144b80ccab5b98597e31", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/884b87c5a0d90acfd47f144b80ccab5b98597e31", "committedDate": "2020-04-09T19:42:04Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "884b87c5a0d90acfd47f144b80ccab5b98597e31", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/884b87c5a0d90acfd47f144b80ccab5b98597e31", "committedDate": "2020-04-09T19:42:04Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "d28b939303d88e1bfbf312a32ee1414a2caad1d2", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d28b939303d88e1bfbf312a32ee1414a2caad1d2", "committedDate": "2020-04-09T19:48:32Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d28b939303d88e1bfbf312a32ee1414a2caad1d2", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/d28b939303d88e1bfbf312a32ee1414a2caad1d2", "committedDate": "2020-04-09T19:48:32Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "3c2569c1ec5803c4c8f93cc5b8675f757e6c274c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/3c2569c1ec5803c4c8f93cc5b8675f757e6c274c", "committedDate": "2020-04-09T19:49:54Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c2569c1ec5803c4c8f93cc5b8675f757e6c274c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/3c2569c1ec5803c4c8f93cc5b8675f757e6c274c", "committedDate": "2020-04-09T19:49:54Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "84e255d1362662ce25ffa53f7ae37edd33bd965c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/84e255d1362662ce25ffa53f7ae37edd33bd965c", "committedDate": "2020-04-09T20:10:06Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84e255d1362662ce25ffa53f7ae37edd33bd965c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/84e255d1362662ce25ffa53f7ae37edd33bd965c", "committedDate": "2020-04-09T20:10:06Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "2d2c5f33e9586ac93297f322e530781531a6980c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/2d2c5f33e9586ac93297f322e530781531a6980c", "committedDate": "2020-04-09T20:44:37Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d2c5f33e9586ac93297f322e530781531a6980c", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/2d2c5f33e9586ac93297f322e530781531a6980c", "committedDate": "2020-04-09T20:44:37Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "f4760d50329c783a7d62b1e4ee90f22473fe6e5e", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/f4760d50329c783a7d62b1e4ee90f22473fe6e5e", "committedDate": "2020-04-09T20:46:15Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4760d50329c783a7d62b1e4ee90f22473fe6e5e", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/f4760d50329c783a7d62b1e4ee90f22473fe6e5e", "committedDate": "2020-04-09T20:46:15Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "62050f2b84bae86faae6c190d1fa7fa9423fbebe", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/62050f2b84bae86faae6c190d1fa7fa9423fbebe", "committedDate": "2020-04-10T05:08:27Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84e4947099fe545b2cfe8d419ab1db02c0fcdf98", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/84e4947099fe545b2cfe8d419ab1db02c0fcdf98", "committedDate": "2020-04-10T05:20:59Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62050f2b84bae86faae6c190d1fa7fa9423fbebe", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/62050f2b84bae86faae6c190d1fa7fa9423fbebe", "committedDate": "2020-04-10T05:08:27Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}, "afterCommit": {"oid": "84e4947099fe545b2cfe8d419ab1db02c0fcdf98", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/84e4947099fe545b2cfe8d419ab1db02c0fcdf98", "committedDate": "2020-04-10T05:20:59Z", "message": "IGNITE-12879 Fixes premature afterDiscovery calling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2ad0366ffa7e9032cd669dc3da01fe190c4249", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/fe2ad0366ffa7e9032cd669dc3da01fe190c4249", "committedDate": "2020-04-10T16:15:06Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae06d319dbca0117037ad7834d5a73d235f6f72f", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/ae06d319dbca0117037ad7834d5a73d235f6f72f", "committedDate": "2020-04-10T16:14:02Z", "message": "IGNITE-12879 Fixes minor issues."}, "afterCommit": {"oid": "fe2ad0366ffa7e9032cd669dc3da01fe190c4249", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/fe2ad0366ffa7e9032cd669dc3da01fe190c4249", "committedDate": "2020-04-10T16:15:06Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c04bd7be256a3616349d95b82877076a19b33186", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/c04bd7be256a3616349d95b82877076a19b33186", "committedDate": "2020-04-13T07:58:58Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb", "committedDate": "2020-04-13T10:23:26Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDI1MDc0", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-394425074", "createdAt": "2020-04-16T08:49:23Z", "commit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo0OToyM1rOGGbGvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo0OToyM1rOGGbGvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4ODczNA==", "bodyText": "Why this deletion?", "url": "https://github.com/apache/ignite/pull/7647#discussion_r409388734", "createdAt": "2020-04-16T08:49:23Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/binary/BinaryMetadataUpdatesFlowTest.java", "diffHunk": "@@ -209,10 +197,7 @@ public void testFlowNoConflictsWithClients() throws Exception {\n             return;\n \n         discoveryHook = new DiscoveryHook() {\n-            @Override public void handleDiscoveryMessage(DiscoverySpiCustomMessage msg) {\n-                DiscoveryCustomMessage customMsg = msg == null ? null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDI1NTE2", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-394425516", "createdAt": "2020-04-16T08:49:56Z", "commit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo0OTo1N1rOGGbIFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo0OTo1N1rOGGbIFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4OTA3Ng==", "bodyText": "Why this deletion?", "url": "https://github.com/apache/ignite/pull/7647#discussion_r409389076", "createdAt": "2020-04-16T08:49:57Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/binary/GridCacheBinaryObjectMetadataExchangeMultinodeTest.java", "diffHunk": "@@ -129,13 +115,10 @@ public void testReadRequestBlockedOnUpdatingMetadata() throws Exception {\n         discoveryHook = new DiscoveryHook() {\n             private volatile IgniteEx ignite;\n \n-            @Override public void handleDiscoveryMessage(DiscoverySpiCustomMessage msg) {\n+            @Override public void beforeDiscovery(DiscoveryCustomMessage customMsg) {\n                 if (finishFut.isDone())\n                     return;\n \n-                DiscoveryCustomMessage customMsg = msg == null ? null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDMxNDc4", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-394431478", "createdAt": "2020-04-16T08:57:16Z", "commit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo1NzoxNlrOGGba6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo1NzoxNlrOGGba6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5Mzg5OA==", "bodyText": "Is the following flow possible? If no, why?\n\naddDiscoveryHook\nsetListener\naddDiscoveryHook <- this hook will be ignored.", "url": "https://github.com/apache/ignite/pull/7647#discussion_r409393898", "createdAt": "2020-04-16T08:57:16Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TestTcpDiscoverySpi.java", "diffHunk": "@@ -44,4 +54,24 @@\n     @Override public void simulateNodeFailure() {\n         super.simulateNodeFailure();\n     }\n+\n+    /** {@inheritDoc} */\n+    @SuppressWarnings(\"ZeroLengthArrayAllocation\")\n+    @Override public void setListener(@Nullable DiscoverySpiListener lsnr) {\n+        super.setListener(lsnr ==  null || discoHooks.isEmpty() ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDMyMzQy", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-394432342", "createdAt": "2020-04-16T08:58:14Z", "commit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo1ODoxNVrOGGbdwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwODo1ODoxNVrOGGbdwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5NDYyNA==", "bodyText": "Let's allocate discoHooks on the first hook addition.", "url": "https://github.com/apache/ignite/pull/7647#discussion_r409394624", "createdAt": "2020-04-16T08:58:15Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/tcp/TestTcpDiscoverySpi.java", "diffHunk": "@@ -31,6 +38,9 @@\n     /** */\n     public boolean ignorePingResponse;\n \n+    /** Interceptors of discovery messages. */\n+    private List<DiscoveryHook> discoHooks = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e428d1c1b0e735be80d6d486f22d3f1d0de0ebb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358509270ccb5587fce418f48699e6910b5f59b9", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/358509270ccb5587fce418f48699e6910b5f59b9", "committedDate": "2020-04-16T09:34:00Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64578ba1f0f5c101ae283649f550eeaf47fba153", "author": {"user": {"login": "ololo3000", "name": "Mikhail Petrov "}}, "url": "https://github.com/apache/ignite/commit/64578ba1f0f5c101ae283649f550eeaf47fba153", "committedDate": "2020-04-16T10:28:11Z", "message": "IGNITE-12879 Fixes minor issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTY0MTM0", "url": "https://github.com/apache/ignite/pull/7647#pullrequestreview-394564134", "createdAt": "2020-04-16T12:04:12Z", "commit": {"oid": "64578ba1f0f5c101ae283649f550eeaf47fba153"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2694, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}