{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NDUyOTA4", "number": 8150, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjowOTo0M1rOEYcjBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwODowNzo1OVrOEY8Nhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MDY4OTk5OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/ClusterProcessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjowOTo0M1rOHAyP_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjo1NDoxMlrOHAzefQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4NTM0MA==", "bodyText": "Can we use this metric and all below inside ClusterMetricsMXBeanImpl to keep single method to calculate metric value.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470585340", "createdAt": "2020-08-14T12:09:43Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/ClusterProcessor.java", "diffHunk": "@@ -607,6 +610,33 @@ private Boolean findLastFlag(Collection<Serializable> vals) {\n                 U.error(log, \"Failed to register MBean for cluster: \", e);\n             }\n         }\n+\n+        MetricRegistry reg = ctx.metric().registry(CLUSTER_METRICS);\n+\n+        reg.register(\"TopologyVersion\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwNTQzNw==", "bodyText": "We can use this metrics for the ClusterMetricsMXBeanImpl implementation. But not for the ClusterLocalNodeMetricsMXBeanImpl.\nMoreover metrics registration should be placed between starting GridMetricManager and beans registration. For example, in the IgniteKernal#registerMetrics()", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470605437", "createdAt": "2020-08-14T12:54:12Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/ClusterProcessor.java", "diffHunk": "@@ -607,6 +610,33 @@ private Boolean findLastFlag(Collection<Serializable> vals) {\n                 U.error(log, \"Failed to register MBean for cluster: \", e);\n             }\n         }\n+\n+        MetricRegistry reg = ctx.metric().registry(CLUSTER_METRICS);\n+\n+        reg.register(\"TopologyVersion\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4NTM0MA=="}, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MDcwMDU1OnYy", "diffSide": "RIGHT", "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterBaselineNodesMetricsSelfTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjoxMzoxNFrOHAyV6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjo1OToxMlrOHAzoFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4Njg1Ng==", "bodyText": "Let's use merg.<IntMetrics>findMetric(\"XXX\").value() to avoid type casting.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470586856", "createdAt": "2020-08-14T12:13:14Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterBaselineNodesMetricsSelfTest.java", "diffHunk": "@@ -82,9 +92,13 @@ public void testBaselineNodes() throws Exception {\n         log.info(String.format(\">>> State #1: topology version = %d\", ignite0.cluster().topologyVersion()));\n \n         assertEquals(2, mxBeanCluster.getTotalServerNodes());\n+        assertEquals(2, ((IntMetric)mreg.findMetric(\"TotalServerNodes\")).value());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwNzg5NA==", "bodyText": "Fixed.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470607894", "createdAt": "2020-08-14T12:59:12Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterBaselineNodesMetricsSelfTest.java", "diffHunk": "@@ -82,9 +92,13 @@ public void testBaselineNodes() throws Exception {\n         log.info(String.format(\">>> State #1: topology version = %d\", ignite0.cluster().topologyVersion()));\n \n         assertEquals(2, mxBeanCluster.getTotalServerNodes());\n+        assertEquals(2, ((IntMetric)mreg.findMetric(\"TotalServerNodes\")).value());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4Njg1Ng=="}, "originalCommit": {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MDg4NTAzOnYy", "diffSide": "RIGHT", "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterNodeMetricsSelfTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoxMzoxNlrOHA0E4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoyMzo1MlrOHA0aQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTI2Nw==", "bodyText": "Let's return final modifier.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470615267", "createdAt": "2020-08-14T13:13:16Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterNodeMetricsSelfTest.java", "diffHunk": "@@ -310,7 +314,7 @@ public void testIoMetrics() throws Exception {\n      */\n     @Test\n     public void testClusterNodeMetrics() throws Exception {\n-        final Ignite ignite0 = grid();\n+        IgniteEx ignite0 = grid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYyMDczNg==", "bodyText": "Reverted.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470620736", "createdAt": "2020-08-14T13:23:52Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterNodeMetricsSelfTest.java", "diffHunk": "@@ -310,7 +314,7 @@ public void testIoMetrics() throws Exception {\n      */\n     @Test\n     public void testClusterNodeMetrics() throws Exception {\n-        final Ignite ignite0 = grid();\n+        IgniteEx ignite0 = grid();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTI2Nw=="}, "originalCommit": {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTg3NzgzOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/ClusterMetricsMXBeanImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwODowNzo1OVrOHBejAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToyOToxOFrOHBhQyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMTEwNQ==", "bodyText": "Let's remove this metric from new framework.\n\"CurrentTopologyVersion\" would be added by the #8145 in the \"io.discovery\" registry.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r471311105", "createdAt": "2020-08-17T08:07:59Z", "author": {"login": "nizhikov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/ClusterMetricsMXBeanImpl.java", "diffHunk": "@@ -47,13 +54,37 @@\n     /** Cluster metrics update mutex. */\n     private final Object clusterMetricsMux = new Object();\n \n+    /** Topology version metric. */\n+    private final LongMetric topVer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1NTU5NA==", "bodyText": "Done.", "url": "https://github.com/apache/ignite/pull/8150#discussion_r471355594", "createdAt": "2020-08-17T09:29:18Z", "author": {"login": "NSAmelchev"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/ClusterMetricsMXBeanImpl.java", "diffHunk": "@@ -47,13 +54,37 @@\n     /** Cluster metrics update mutex. */\n     private final Object clusterMetricsMux = new Object();\n \n+    /** Topology version metric. */\n+    private final LongMetric topVer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMTEwNQ=="}, "originalCommit": {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2713, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}