{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NTQzNjYx", "number": 8004, "title": "IGNITE-13214 .NET: Fix TransactionScope for read operations", "bodyText": "Add StartTxIfNeeded to all cache operations (it was missing for Get, GetAll, TryGet)\nAdd OptimisticTransactionTest with explicit and ambient tests\nAdd exception mapping for IgniteTxOptimisticCheckedException\nFix error handling in ambient transactions - close Ignite tx on Prepare failure", "createdAt": "2020-07-07T17:09:35Z", "url": "https://github.com/apache/ignite/pull/8004", "merged": true, "mergeCommit": {"oid": "0aceb369c0097dadf94fae75456521baf678005a"}, "closed": true, "closedAt": "2020-07-09T18:40:11Z", "author": {"login": "ptupitsyn"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyohayAH2gAyNDQ1NTQzNjYxOjU1OTc2OGEwOWFjOTUwNDdmZjM5M2ViMjc2ZDAzNGE1MjY1NzBkMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczNyOtgH2gAyNDQ1NTQzNjYxOmM3MjVkOWFkOWYwMzg4YzlhOTg2ZWRmZTRiNzhjM2VhN2E5MjU2MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "559768a09ac95047ff393eb276d034a526570d0d", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/559768a09ac95047ff393eb276d034a526570d0d", "committedDate": "2020-07-07T16:35:00Z", "message": "Add TestTransactionScopeWithSerializableIsolationLocksKeysOnRead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d2ccba883bb4edbe29ee1c7d9ee2645fad9dc2c", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/4d2ccba883bb4edbe29ee1c7d9ee2645fad9dc2c", "committedDate": "2020-07-07T16:39:31Z", "message": "Add TestTransactionScopeWithSerializableIsolationLocksKeysOnRead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d191800c0940acbddb5f178a3c4e3d1f5cd0d7d6", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/d191800c0940acbddb5f178a3c4e3d1f5cd0d7d6", "committedDate": "2020-07-07T16:40:53Z", "message": "Get operation fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47bec0dc753f1452842c62b770a4ab4b0596d209", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/47bec0dc753f1452842c62b770a4ab4b0596d209", "committedDate": "2020-07-07T16:55:06Z", "message": "Adding tests for all operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "381febdefb8ae36e82010f9fce99d20b39c083f4", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/381febdefb8ae36e82010f9fce99d20b39c083f4", "committedDate": "2020-07-07T17:00:43Z", "message": "Adding tests for all operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "299a0c3806786a683c8958d3f7173d1a06bb0121", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/299a0c3806786a683c8958d3f7173d1a06bb0121", "committedDate": "2020-07-07T17:02:32Z", "message": "Adding tests for all operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86936946ac1cfb872af69ac90ae059a6d01d39db", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/86936946ac1cfb872af69ac90ae059a6d01d39db", "committedDate": "2020-07-07T17:07:21Z", "message": "Fix done, tests done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjI1Nzc4", "url": "https://github.com/apache/ignite/pull/8004#pullrequestreview-444225778", "createdAt": "2020-07-07T20:28:29Z", "commit": {"oid": "86936946ac1cfb872af69ac90ae059a6d01d39db"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMDoyODoyOVrOGuObeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMDozNDoyNVrOGuOm_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNDA4OA==", "bodyText": "Can ContainsKey and ContainsKeys trigger transnational behavior?", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451124088", "createdAt": "2020-07-07T20:28:29Z", "author": {"login": "gurustron"}, "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheAbstractTransactionalTest.cs", "diffHunk": "@@ -862,6 +862,50 @@ public void TestTransactionScopeAllOperations()\n             }\n         }\n \n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        [Test]\n+        public void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead()\n+        {\n+            Action<Func<ICache<int, int>, int, int>>\n+                test = TestTransactionScopeWithSerializableIsolationLocksKeysOnRead;\n+\n+            test((cache, key) => cache[key]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86936946ac1cfb872af69ac90ae059a6d01d39db"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNzAzOQ==", "bodyText": "To be honest I prefer check the optimistic serializable transaction for throwing exception (as defined in documetation) on commit it seems to me to be more predictable and no need for magic numbers and waits.", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451127039", "createdAt": "2020-07-07T20:34:25Z", "author": {"login": "gurustron"}, "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheAbstractTransactionalTest.cs", "diffHunk": "@@ -862,6 +862,50 @@ public void TestTransactionScopeAllOperations()\n             }\n         }\n \n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        [Test]\n+        public void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead()\n+        {\n+            Action<Func<ICache<int, int>, int, int>>\n+                test = TestTransactionScopeWithSerializableIsolationLocksKeysOnRead;\n+\n+            test((cache, key) => cache[key]);\n+            test((cache, key) => cache.Get(key));\n+            test((cache, key) => cache.GetAsync(key).Result);\n+            test((cache, key) => { int val; return cache.TryGet(key, out val) ? val : 0; });\n+            test((cache, key) => cache.TryGetAsync(key).Result.Value);\n+            test((cache, key) => cache.GetAll(new[] {key}).Single().Value);\n+            test((cache, key) => cache.GetAllAsync(new[] {key}).Result.Single().Value);\n+        }\n+\n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        private void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead(\n+            Func<ICache<int, int>, int, int> readOp)\n+        {\n+            var cache = Cache();\n+            cache.Put(1, 1);\n+\n+            var options = new TransactionOptions {IsolationLevel = IsolationLevel.Serializable};\n+\n+            using (var scope = new TransactionScope(TransactionScopeOption.Required, options))\n+            {\n+                Assert.AreEqual(1, readOp(cache, 1));\n+\n+                var taskFinished = Task.Factory.StartNew(() => cache.Put(1, 2)).Wait(TimeSpan.FromSeconds(1));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86936946ac1cfb872af69ac90ae059a6d01d39db"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "986f81f486818bb891d00bed402f86c7bbc79394", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/986f81f486818bb891d00bed402f86c7bbc79394", "committedDate": "2020-07-08T09:40:33Z", "message": "Merge branch 'master' into ignite-13214"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da47075540bbb147848f4f020d7fbeb1faf7c2de", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/da47075540bbb147848f4f020d7fbeb1faf7c2de", "committedDate": "2020-07-08T12:15:54Z", "message": "Improve TestTransactionScopeWithSerializableIsolationLocksKeysOnRead according to review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "681279a043753374765af35fed42f672d0d9856c", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/681279a043753374765af35fed42f672d0d9856c", "committedDate": "2020-07-08T12:26:06Z", "message": "Add OptimisticTransactionTest (in progress)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c6cf83a51286fb0a73ddb6f37ab6ff75fa04173", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/5c6cf83a51286fb0a73ddb6f37ab6ff75fa04173", "committedDate": "2020-07-08T12:43:17Z", "message": "TestExplicitOptimisticTransactionThrowsExceptionOnConflict done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de7e2df6c620330be980de28d7dc2f7dff16ebe1", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/de7e2df6c620330be980de28d7dc2f7dff16ebe1", "committedDate": "2020-07-08T12:45:23Z", "message": "Add TestAmbientOptimisticTransactionThrowsExceptionOnConflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984e6e385427ab2c59ab16461dea1b1192b4ad26", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/984e6e385427ab2c59ab16461dea1b1192b4ad26", "committedDate": "2020-07-08T12:55:29Z", "message": "Add .NET conversion for IgniteTxOptimisticCheckedException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85259881ba837d31f84217af2c2098debb183ee7", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/85259881ba837d31f84217af2c2098debb183ee7", "committedDate": "2020-07-08T13:07:02Z", "message": "Fix TestAmbientOptimisticTransactionThrowsOptimisticExceptionOnConflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6996124c7b74f39a166cc7e24080e1186ddaa93d", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/6996124c7b74f39a166cc7e24080e1186ddaa93d", "committedDate": "2020-07-08T13:10:33Z", "message": "Update TestAmbientOptimisticTransactionThrowsOptimisticExceptionOnConflict to check for dispose transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d80d4f6b29a369660b38f80866c8bd7c031e93", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/31d80d4f6b29a369660b38f80866c8bd7c031e93", "committedDate": "2020-07-08T21:35:39Z", "message": "Fix cleanup of Ignite transaction on commit failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ad335e4a1a9603a8aeb67e99753b2d910a5305d", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/7ad335e4a1a9603a8aeb67e99753b2d910a5305d", "committedDate": "2020-07-08T21:36:20Z", "message": "Fix cleanup of Ignite transaction on commit failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea28c05f6991a7908a298fd0ba0a2da511ef173", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/6ea28c05f6991a7908a298fd0ba0a2da511ef173", "committedDate": "2020-07-09T09:11:25Z", "message": "Merge branch 'master' into ignite-13214"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8408bc93a143efd43ead6b2cb8bda7f8e87537c6", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/8408bc93a143efd43ead6b2cb8bda7f8e87537c6", "committedDate": "2020-07-09T09:54:08Z", "message": "Merge branch 'master' into ignite-13214"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9775f08d5847ec436e54f5fb29d3b940b5c18f68", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/9775f08d5847ec436e54f5fb29d3b940b5c18f68", "committedDate": "2020-07-09T10:15:34Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba39daecec9a6018878296cce081be11e78afc6", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/2ba39daecec9a6018878296cce081be11e78afc6", "committedDate": "2020-07-09T10:37:47Z", "message": "Move StartTxIfNeeded() calls before NearCache checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c725d9ad9f0388c9a986edfe4b78c3ea7a925635", "author": {"user": {"login": "ptupitsyn", "name": "Pavel Tupitsyn"}}, "url": "https://github.com/apache/ignite/commit/c725d9ad9f0388c9a986edfe4b78c3ea7a925635", "committedDate": "2020-07-09T11:59:51Z", "message": "Remove current enlistment check from transaction manager"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3247, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}