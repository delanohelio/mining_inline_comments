{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDUxMTM5", "number": 5345, "title": "Show schematic outlines while the player has the building tool in the main hand - 2nd try", "bodyText": "This PR makes it so the building tool will render the max-level building schematics and their outlines when the active preview is nearby. This should make it easier to properly align neighboring buildings.", "createdAt": "2020-07-05T19:37:37Z", "url": "https://github.com/ldtteam/minecolonies/pull/5345", "merged": true, "mergeCommit": {"oid": "524cd4968d75308a018cfba28f6d60857017b047"}, "closed": true, "closedAt": "2020-07-12T08:16:39Z", "author": {"login": "JiaYow"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyB3tZgH2gAyNDQ0NDUxMTM5OmY4YmVlYTZlMzk3ZWFmMjQ1N2JjMjYwYzdmNWE1ZjZmOWNiYjEwMmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0IL4rAFqTQ0Njg1NTg2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8beea6e397eaf2457bc260c7f5a5f6f9cbb102c", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/f8beea6e397eaf2457bc260c7f5a5f6f9cbb102c", "committedDate": "2020-07-05T19:33:03Z", "message": "Added previews of nearby buildings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "550c435965bb1aa3605b1f1f12205298d3b35d50", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/550c435965bb1aa3605b1f1f12205298d3b35d50", "committedDate": "2020-07-05T19:44:00Z", "message": "Code beautification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6479a2efd1220812056dde3bdddd117e0b5b5904", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/6479a2efd1220812056dde3bdddd117e0b5b5904", "committedDate": "2020-07-05T20:16:34Z", "message": "Added a workaround for the wrong building mirrors. Will cause a minor fps drop, but in comparison with the structure rendering impact, it's very little."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDM4MDMx", "url": "https://github.com/ldtteam/minecolonies/pull/5345#pullrequestreview-443438031", "createdAt": "2020-07-06T22:07:59Z", "commit": {"oid": "6479a2efd1220812056dde3bdddd117e0b5b5904"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjowODowMFrOGtoovA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjowODowMFrOGtoovA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwNDg5Mg==", "bodyText": "Could we get a highlight on the Tileentity to render aswell? would be very useful for finding buried buildings.\nShould be a simple RenderBox() or so call, the code for that exists in structurize", "url": "https://github.com/ldtteam/minecolonies/pull/5345#discussion_r450504892", "createdAt": "2020-07-06T22:08:00Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/event/ClientEventHandler.java", "diffHunk": "@@ -77,18 +103,128 @@ public static void renderWorldLastEvent(@NotNull final RenderWorldLastEvent even\n         {\n             handleRenderStructure(event, world, player);\n         }\n-        else if (player.getHeldItemMainhand().getItem() == ModItems.scepterGuard)\n+\n+        if (player.getHeldItemMainhand().getItem() == ModItems.scepterGuard)\n         {\n             handleRenderScepterGuard(event, world, player);\n         }\n         else if (player.getHeldItemMainhand().getItem() == ModItems.bannerRallyGuards)\n         {\n             handleRenderBannerRallyGuards(event, world, player);\n         }\n+        else if (player.getHeldItemMainhand().getItem() == com.ldtteam.structurize.items.ModItems.buildTool)\n+        {\n+            handleRenderBuildTool(event, world, player);\n+        }\n+    }\n+\n+    /**\n+     * Renders building bounding boxes into the client\n+     *\n+     * @param event  The caught event\n+     * @param world  The world in which to render\n+     * @param player The player for which to render\n+     */\n+    private static void handleRenderBuildTool(@NotNull final RenderWorldLastEvent event, final ClientWorld world, final PlayerEntity player)\n+    {\n+        final IColonyView colony = IColonyManager.getInstance().getClosestColonyView(world, player.getPosition());\n+        if (colony == null)\n+        {\n+            return;\n+        }\n+\n+        if (Settings.instance.getActiveStructure() == null)\n+        {\n+            return;\n+        }\n+\n+        final BlockPos activePosition = Settings.instance.getPosition();\n+        final Map<BlockPos, Triple<Blueprint, BlockPos, BlockPos>> newCache = new HashMap<>();\n+        for (final IBuildingView buildingView : colony.getBuildings())\n+        {\n+            final BlockPos currentPosition = buildingView.getPosition();\n+\n+            if (activePosition.withinDistance(currentPosition, PREVIEW_RANGE))\n+            {\n+                if (blueprintCache.containsKey(currentPosition))\n+                {\n+                    newCache.put(currentPosition, blueprintCache.get(currentPosition));\n+                }\n+                else\n+                {\n+                    final StructureName sn =\n+                      new StructureName(Structures.SCHEMATICS_PREFIX,\n+                        buildingView.getStyle(),\n+                        buildingView.getSchematicName() + buildingView.getBuildingMaxLevel());\n+\n+                    final String structureName = sn.toString();\n+                    final String md5 = Structures.getMD5(structureName);\n+\n+                    final IStructureHandler wrapper = new LoadOnlyStructureHandler(world, buildingView.getID(), structureName, new PlacementSettings(), true);\n+                    if (!wrapper.hasBluePrint() || !wrapper.isCorrectMD5(md5))\n+                    {\n+                        Log.getLogger().debug(\"Blueprint error, requesting\" + structureName + \" from server.\");\n+                        if (ServerLifecycleHooks.getCurrentServer() == null)\n+                        {\n+                            Network.getNetwork().sendToServer(new SchematicRequestMessage(structureName));\n+                            continue;\n+                        }\n+                    }\n+\n+                    final Blueprint blueprint = wrapper.getBluePrint();\n+\n+                    if (blueprint != null)\n+                    {\n+                        Mirror mirror = buildingView.isMirrored() ? Mirror.FRONT_BACK : Mirror.NONE;\n+\n+                        final TileEntity tileEntity = world.getTileEntity(currentPosition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6479a2efd1220812056dde3bdddd117e0b5b5904"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDM4MDgz", "url": "https://github.com/ldtteam/minecolonies/pull/5345#pullrequestreview-443438083", "createdAt": "2020-07-06T22:08:07Z", "commit": {"oid": "6479a2efd1220812056dde3bdddd117e0b5b5904"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc3b972dff5532106b7e25ddb2572aba8b33c74", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/8cc3b972dff5532106b7e25ddb2572aba8b33c74", "committedDate": "2020-07-06T22:50:52Z", "message": "Swapped two checks because that should slightly increase performance. Also added a comment for a code block, so that future devs know what's up."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ccf976c7981cb7bd9daabd2004c1a1f6df4785", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/c6ccf976c7981cb7bd9daabd2004c1a1f6df4785", "committedDate": "2020-07-10T17:10:39Z", "message": "Merge branch 'version/1.15' into feature/nearby-building-preview"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODU1ODY3", "url": "https://github.com/ldtteam/minecolonies/pull/5345#pullrequestreview-446855867", "createdAt": "2020-07-12T08:02:22Z", "commit": {"oid": "c6ccf976c7981cb7bd9daabd2004c1a1f6df4785"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2095, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}