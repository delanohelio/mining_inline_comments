{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDE2NzEy", "number": 5199, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo0MjoxNlrOEEpb_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDo0MlrOEFfgcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMzA4NjcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo0MjoxNlrOGiZkwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo0Njo0MVrOGiZspg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng==", "bodyText": "is this int even still needed anymore? think you can remove it. Seems like it isnt getting data anymore aswell so logic on it might break", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438723776", "createdAt": "2020-06-11T11:42:16Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "diffHunk": "@@ -117,6 +120,16 @@\n      */\n     private int shipRotation = 0;\n \n+    /**\n+     * List of all spawners.\n+     */\n+    private List<BlockPos> spawners = new ArrayList<>();\n+\n+    /**\n+     * Count of spawners.\n+     */\n+    private int spawnerCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyNDczMQ==", "bodyText": "Backwards compatibility. For ships that are still in some worlds.", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438724731", "createdAt": "2020-06-11T11:44:29Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "diffHunk": "@@ -117,6 +120,16 @@\n      */\n     private int shipRotation = 0;\n \n+    /**\n+     * List of all spawners.\n+     */\n+    private List<BlockPos> spawners = new ArrayList<>();\n+\n+    /**\n+     * Count of spawners.\n+     */\n+    private int spawnerCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng=="}, "originalCommit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyNTc5OA==", "bodyText": "ah ok", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438725798", "createdAt": "2020-06-11T11:46:41Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "diffHunk": "@@ -117,6 +120,16 @@\n      */\n     private int shipRotation = 0;\n \n+    /**\n+     * List of all spawners.\n+     */\n+    private List<BlockPos> spawners = new ArrayList<>();\n+\n+    /**\n+     * Count of spawners.\n+     */\n+    private int spawnerCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng=="}, "originalCommit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTk0MzM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDowMVrOGjtnew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMTo0ODo0M1rOGjuvSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDczMQ==", "bodyText": "Pass in the delta here to do this properly. The Stack requestable can tract counts.", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440100731", "createdAt": "2020-06-15T11:10:01Z", "author": {"login": "OrionDevelopment"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -584,33 +585,43 @@ public void removeMinimumStock(final ItemStack itemStack)\n     public void onColonyTick(final IColony colony)\n     {\n         super.onColonyTick(colony);\n-        final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n \n-        for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n+        if (colony.getWorld().getChunkProvider().isChunkLoaded(new ChunkPos(getPosition().getX() >> 4, getPosition().getZ() >> 4)))\n         {\n-            final ItemStack itemStack = entry.getKey().getItemStack().copy();\n-            final int count = InventoryUtils.getItemCountInProvider(getTileEntity(), stack -> !stack.isEmpty() && stack.isItemEqual(itemStack));\n-            final int delta = entry.getValue() * itemStack.getMaxStackSize() - count;\n-            final IToken<?> request = getMatchingRequest(itemStack, list);\n-            if (delta > 0)\n+            final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n+\n+            for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n             {\n-                if (request == null)\n+                final ItemStack itemStack = entry.getKey().getItemStack().copy();\n+\n+                if (itemStack.isEmpty())\n                 {\n-                    itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n-                    final Stack stack = new Stack(itemStack);\n-                    if (getMainCitizen() != null)\n-                    {\n-                        getMainCitizen().createRequestAsync(stack);\n-                    }\n-                    else\n+                    continue;\n+                }\n+\n+                final int count = InventoryUtils.hasBuildingEnoughElseCount(this, new ItemStorage(itemStack), entry.getValue() * itemStack.getMaxStackSize());\n+                final int delta = (entry.getValue() * itemStack.getMaxStackSize()) - count;\n+                final IToken<?> request = getMatchingRequest(itemStack, list);\n+                if (delta > 0)\n+                {\n+                    if (request == null)\n                     {\n-                        createRequest(stack, false);\n+                        itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n+                        final Stack stack = new Stack(itemStack);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTExMw==", "bodyText": "I'm not doing this on purpose. I want to request 1 by 1", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440119113", "createdAt": "2020-06-15T11:48:43Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -584,33 +585,43 @@ public void removeMinimumStock(final ItemStack itemStack)\n     public void onColonyTick(final IColony colony)\n     {\n         super.onColonyTick(colony);\n-        final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n \n-        for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n+        if (colony.getWorld().getChunkProvider().isChunkLoaded(new ChunkPos(getPosition().getX() >> 4, getPosition().getZ() >> 4)))\n         {\n-            final ItemStack itemStack = entry.getKey().getItemStack().copy();\n-            final int count = InventoryUtils.getItemCountInProvider(getTileEntity(), stack -> !stack.isEmpty() && stack.isItemEqual(itemStack));\n-            final int delta = entry.getValue() * itemStack.getMaxStackSize() - count;\n-            final IToken<?> request = getMatchingRequest(itemStack, list);\n-            if (delta > 0)\n+            final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n+\n+            for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n             {\n-                if (request == null)\n+                final ItemStack itemStack = entry.getKey().getItemStack().copy();\n+\n+                if (itemStack.isEmpty())\n                 {\n-                    itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n-                    final Stack stack = new Stack(itemStack);\n-                    if (getMainCitizen() != null)\n-                    {\n-                        getMainCitizen().createRequestAsync(stack);\n-                    }\n-                    else\n+                    continue;\n+                }\n+\n+                final int count = InventoryUtils.hasBuildingEnoughElseCount(this, new ItemStorage(itemStack), entry.getValue() * itemStack.getMaxStackSize());\n+                final int delta = (entry.getValue() * itemStack.getMaxStackSize()) - count;\n+                final IToken<?> request = getMatchingRequest(itemStack, list);\n+                if (delta > 0)\n+                {\n+                    if (request == null)\n                     {\n-                        createRequest(stack, false);\n+                        itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n+                        final Stack stack = new Stack(itemStack);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDczMQ=="}, "originalCommit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTk0NTQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingCrafter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDo0MlrOGjtowQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDo0MlrOGjtowQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMTA1Nw==", "bodyText": "You will probably need to change that here then too if you adapt the AbstractBuilding to use the Delta in the request.", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440101057", "createdAt": "2020-06-15T11:10:42Z", "author": {"login": "OrionDevelopment"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingCrafter.java", "diffHunk": "@@ -99,20 +99,21 @@ public boolean canBeGathered()\n                     {\n                         for (final ItemStorage itemStorage : recipeStorage.getCleanedInput())\n                         {\n-                            int amount = itemStorage.getAmount();\n+                            int amount = itemStorage.getAmount() * request.getRequest().getCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3101, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}