{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNTQ5Njcw", "number": 4390, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNDoyMlrODlDklA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNjozNFrODlDn8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTgyNDIwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNDoyMlrOFxudUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNjo1MDo0NVrOFy_yew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg==", "bodyText": "Why is this needed?", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387685712", "createdAt": "2020-03-04T14:04:22Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk0ODE3MA==", "bodyText": "it fixes a bug that when a guard collects too much exp it goes into infinite loop.", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388948170", "createdAt": "2020-03-06T14:54:19Z", "author": {"login": "adoxentor"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MjE0Ng==", "bodyText": "Where does this infinite loop come from?", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388952146", "createdAt": "2020-03-06T15:00:33Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MzM2Mg==", "bodyText": "minecolonies/src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenExperienceHandler.java\n    \n    \n        Lines 131 to 134\n      in\n      3f0ac63\n    \n    \n    \n    \n\n        \n          \n           while (ExperienceUtils.getXPNeededForNextLevel(citizen.getCitizenData().getLevel()) < citizen.getCitizenData().getExperience()) \n        \n\n        \n          \n           { \n        \n\n        \n          \n               citizen.getCitizenData().levelUp(); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nSo when level up fails the loop continues, my fix is deleting the excess exp. anther idea is make all of the call tree return bool value so the loop can stop and handle the issue in the top level.", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r388983362", "createdAt": "2020-03-06T15:53:10Z", "author": {"login": "adoxentor"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxMDcyMQ==", "bodyText": "You added * returns true if level up succeeded, but no return value btw =D", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389010721", "createdAt": "2020-03-06T16:38:24Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxNDk4NA==", "bodyText": "this fix work indirectly though, the while's citizenData.getLevel queries the value and the while loop breaks", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389014984", "createdAt": "2020-03-06T16:45:07Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxODIzNQ==", "bodyText": "ahhh", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r389018235", "createdAt": "2020-03-06T16:50:45Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/CitizenData.java", "diffHunk": "@@ -940,6 +941,10 @@ private void increaseLevel()\n             {\n                 this.levelExperienceMap.put(job.getExperienceTag(), new Tuple<>(entry.getA() + 1, entry.getB()));\n             }\n+            else\n+            {\n+                this.levelExperienceMap.put(job.getExperienceTag(),new Tuple<Integer,Double> ((int)MAX_CITIZEN_LEVEL,ExperienceUtils.getXPNeededForNextLevel(MAX_CITIZEN_LEVEL-1)));\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTcxMg=="}, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTgyNTMyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingGuards.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNDozOVrOFxueCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNDozOVrOFxueCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NTg5Ng==", "bodyText": "Good catch, you can remove the comment here.", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387685896", "createdAt": "2020-03-04T14:04:39Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingGuards.java", "diffHunk": "@@ -915,7 +915,7 @@ public void setPlayerToFollow(final PlayerEntity player)\n         if (this.getColony().getWorld() != null)\n         {\n             this.getColony().getWorld().getScoreboard().addPlayerToTeam(player.getScoreboardName(), new ScorePlayerTeam(this.getColony().getWorld().getScoreboard(), TEAM_COLONY_NAME + getColony().getID()));\n-            player.addPotionEffect(new EffectInstance(GLOW_EFFECT, GLOW_EFFECT_DURATION_TEAM, GLOW_EFFECT_MULTIPLIER));\n+            player.addPotionEffect(new EffectInstance(GLOW_EFFECT, GLOW_EFFECT_DURATION_TEAM, GLOW_EFFECT_MULTIPLIER,false,false));//no reason for particales\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTgyNzM2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenExperienceHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNToxNFrOFxufWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNToxNFrOFxufWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NjIzNQ==", "bodyText": "Awesome", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387686235", "createdAt": "2020-03-04T14:05:14Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/entity/citizen/citizenhandlers/CitizenExperienceHandler.java", "diffHunk": "@@ -210,8 +211,16 @@ public void gatherXp()\n     {\n         for (@NotNull final ExperienceOrbEntity orb : getXPOrbsOnGrid())\n         {\n-            addExperience(orb.getXpValue() / 2.0D);\n-            orb.remove();\n+            Vec3d vec3d = new Vec3d(citizen.posX - orb.getPosX(), citizen.posY + (double)this.citizen.getEyeHeight() / 2.0D - orb.getPosY(), citizen.getPosZ() - orb.getPosZ());\n+            double d1 = vec3d.lengthSquared();\n+\n+            if (d1 < 1.0D) {\n+                addExperience(orb.getXpValue() / 2.0D);\n+                orb.remove();\n+                return;\n+            }\n+            double d2 = 1.0D - Math.sqrt(d1) / 8.0D;\n+            orb.setMotion(orb.getMotion().add(vec3d.normalize().scale(d2 * d2 * 0.1D)));\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTgzMjgxOnYy", "diffSide": "LEFT", "path": "src/api/java/com/minecolonies/api/entity/mobs/AbstractEntityMinecoloniesMob.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNjozNFrOFxuioA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDowNjozNFrOFxuioA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY4NzA3Mg==", "bodyText": "This is very old code, didn't know there was a new way around this. Good job", "url": "https://github.com/ldtteam/minecolonies/pull/4390#discussion_r387687072", "createdAt": "2020-03-04T14:06:34Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/entity/mobs/AbstractEntityMinecoloniesMob.java", "diffHunk": "@@ -280,17 +281,6 @@ public ILivingEntityData onInitialSpawn(\n         return super.onInitialSpawn(worldIn, difficultyIn, reason, spawnDataIn, dataTag);\n     }\n \n-    @Override\n-    protected void onDeathUpdate()\n-    {\n-        if (!(this.getAttackingEntity() instanceof PlayerEntity) && (this.recentlyHit > 0 && this.canDropLoot() && world.getGameRules().getBoolean(GameRules.DO_MOB_LOOT)))\n-        {\n-            final int experience = ExperienceOrbEntity.getXPSplit(BARBARIAN_EXP_DROP);\n-            CompatibilityUtils.addEntity(world, new ExperienceOrbEntity(world, this.posX, this.posY, this.posZ, experience));\n-        }\n-        super.onDeathUpdate();\n-    }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0ac6352d78fbfb93a4ec1f808c8e11152e4fea"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3222, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}