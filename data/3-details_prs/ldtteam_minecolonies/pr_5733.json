{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNDkwMTcw", "number": 5733, "title": "Delivery fixes", "bodyText": "Changes proposed in this pull request:\n\nVastly improve smelter crafter madness\nAdd some safeguards to racks\n\n\nReview please", "createdAt": "2020-09-07T15:32:30Z", "url": "https://github.com/ldtteam/minecolonies/pull/5733", "merged": true, "mergeCommit": {"oid": "482d506e89f94a8faab5b76ec074986cbb53e14d"}, "closed": true, "closedAt": "2020-09-08T07:47:27Z", "author": {"login": "Raycoms"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGUARpgH2gAyNDgxNDkwMTcwOjhiNzA4MmU2Y2EzZDA3OTViMTZkMmM1NDcxNzJkNTNjOGE1MGUzOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGlrOggFqTQ4MzY2MDI1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b7082e6ca3d0795b16d2c547172d53c8a50e393", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/8b7082e6ca3d0795b16d2c547172d53c8a50e393", "committedDate": "2020-09-06T19:59:11Z", "message": "Delivery fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b761bef7ee4e7cb80abe0845d0cd5c90c4317ce", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/2b761bef7ee4e7cb80abe0845d0cd5c90c4317ce", "committedDate": "2020-09-07T07:49:03Z", "message": "some cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91b8ab74baa4d532413bb7e6f54c1742306119e5", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/91b8ab74baa4d532413bb7e6f54c1742306119e5", "committedDate": "2020-09-07T15:31:40Z", "message": "Improve smelter crafters + some rack insurances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/a6ec92440a3884b6adae44275c8bd2135669385f", "committedDate": "2020-09-07T15:32:50Z", "message": "Merge branch 'version/1.15' into delivery-fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjM4MTgz", "url": "https://github.com/ldtteam/minecolonies/pull/5733#pullrequestreview-483638183", "createdAt": "2020-09-07T15:40:11Z", "commit": {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo0MDoxMVrOHODaCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo0MDoxMVrOHODaCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ5NzkzMQ==", "bodyText": "stack.isItemEqual is gonna ignore nbt not sure if thats desired", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484497931", "createdAt": "2020-09-07T15:40:11Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIRequestSmelter.java", "diffHunk": "@@ -83,12 +80,37 @@ protected int getActionsDoneUntilDumping()\n     }\n \n     @Override\n-    protected int getExtendedOutputCount(final ItemStack primaryOutput)\n+    protected int getExtendedCount(final ItemStack stack)\n     {\n-        if(currentRecipeStorage != null && currentRecipeStorage.getIntermediate() == Blocks.FURNACE)\n+        if (currentRecipeStorage != null && currentRecipeStorage.getIntermediate() == Blocks.FURNACE)\n         {\n-            return job.getProgress();\n+            int count = 0;\n+            for (final BlockPos pos : getOwnBuilding().getFurnaces())\n+            {\n+                if (WorldUtil.isBlockLoaded(world, pos))\n+                {\n+                    final TileEntity entity = world.getTileEntity(pos);\n+                    if (entity instanceof FurnaceTileEntity)\n+                    {\n+                        final FurnaceTileEntity furnace = (FurnaceTileEntity) entity;\n+\n+                        final ItemStack smeltableSlot = furnace.getStackInSlot(SMELTABLE_SLOT);\n+                        final ItemStack resultSlot = furnace.getStackInSlot(RESULT_SLOT);\n+                        if (stack.isItemEqual(smeltableSlot))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebe28bc3365d67d5af304c183fa62feff23c8f71", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/ebe28bc3365d67d5af304c183fa62feff23c8f71", "committedDate": "2020-09-07T15:56:04Z", "message": "aligned compare method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ4MjUy", "url": "https://github.com/ldtteam/minecolonies/pull/5733#pullrequestreview-483648252", "createdAt": "2020-09-07T16:01:44Z", "commit": {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMTo0NVrOHOD6TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowMTo0NVrOHOD6TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNjE4OQ==", "bodyText": "Should this be resultInCitizenInv?", "url": "https://github.com/ldtteam/minecolonies/pull/5733#discussion_r484506189", "createdAt": "2020-09-07T16:01:45Z", "author": {"login": "Mekle001"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAIRequestSmelter.java", "diffHunk": "@@ -438,92 +435,96 @@ private IAIState fillUpFurnace()\n \n         final int burningCount = countOfBurningFurnaces();\n         final TileEntity entity = world.getTileEntity(walkTo);\n-        if (entity instanceof FurnaceTileEntity)\n+        if (entity instanceof FurnaceTileEntity && currentRecipeStorage != null)\n         {\n             final FurnaceTileEntity furnace = (FurnaceTileEntity) entity;\n             final List<ItemStack> possibleFuels = getOwnBuilding().getAllowedFuel();\n \n+            possibleFuels.removeIf(stack -> stack.isItemEqual(currentRecipeStorage.getPrimaryOutput()));\n+            // There is always only one input.\n+            possibleFuels.removeIf(stack -> stack.isItemEqual(currentRecipeStorage.getCleanedInput().get(0).getItemStack()));\n+\n             //Stoke the furnaces\n-            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(candidate -> item.isItemEqual(candidate)))\n+            if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(item::isItemEqual))\n                   && (hasSmeltableInFurnaceAndNoFuel(furnace) || hasNeitherFuelNorSmeltAble(furnace)))\n             {\n                 InventoryUtils.transferXOfFirstSlotInItemHandlerWithIntoInItemHandler(\n-                  worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(candidate -> item.isItemEqual(candidate)), STACKSIZE,\n+                  worker.getInventoryCitizen(), item -> FurnaceTileEntity.isFuel(item) && possibleFuels.stream().anyMatch(item::isItemEqual), STACKSIZE,\n                   new InvWrapper(furnace), FUEL_SLOT);\n             }\n \n-            if(currentRecipeStorage != null)\n+            final int maxFurnaces = getMaxUsableFurnaces();\n+            final Predicate<ItemStack> smeltable = stack -> currentRecipeStorage.getCleanedInput().get(0).getItemStack().isItemEqual(stack);\n+            final int smeltableInFurnaces = getExtendedCount(currentRecipeStorage.getCleanedInput().get(0).getItemStack());\n+            final int resultInFurnaces = getExtendedCount(currentRecipeStorage.getPrimaryOutput());\n+            final int resultInPlayerInv = InventoryUtils.getItemCountInItemHandler(worker.getInventoryCitizen(), stack -> stack.isItemEqual(currentRecipeStorage.getPrimaryOutput()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6ec92440a3884b6adae44275c8bd2135669385f"}, "originalPosition": 238}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4844e0e89809153855883e8beaa3b22410d5fbe", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/e4844e0e89809153855883e8beaa3b22410d5fbe", "committedDate": "2020-09-07T16:03:49Z", "message": "fix naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abdb0a729a426154d93a5ef1633c608fc91fb76a", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/abdb0a729a426154d93a5ef1633c608fc91fb76a", "committedDate": "2020-09-07T16:03:54Z", "message": "Merge remote-tracking branch 'origin/delivery-fixes' into delivery-fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ5NzI2", "url": "https://github.com/ldtteam/minecolonies/pull/5733#pullrequestreview-483649726", "createdAt": "2020-09-07T16:05:11Z", "commit": {"oid": "abdb0a729a426154d93a5ef1633c608fc91fb76a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjYwMjU3", "url": "https://github.com/ldtteam/minecolonies/pull/5733#pullrequestreview-483660257", "createdAt": "2020-09-07T16:34:29Z", "commit": {"oid": "abdb0a729a426154d93a5ef1633c608fc91fb76a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1918, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}