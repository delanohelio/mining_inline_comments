{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4OTYxMDg3", "number": 4759, "title": "Fix Stock View sometimes not showing all items", "bodyText": "Closes #4758\nCloses #\nCloses #\nChanges proposed in this pull request:\n\nFix item handling in StockView to prevent it from only showing the amount if items from one stack per Item type per rack.\nAdd the Hut block inventory to the stock view.\n\n\nReview please", "createdAt": "2020-04-25T19:50:18Z", "url": "https://github.com/ldtteam/minecolonies/pull/4759", "merged": true, "mergeCommit": {"oid": "b68dd8e21c97ed82cb6f1012e194645da4edb3b5"}, "closed": true, "closedAt": "2020-04-29T08:32:01Z", "author": {"login": "ToMe25"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbLhTRAH2gAyNDA4OTYxMDg3OjhmMzZlODBiNThmMjdmZDJmMDM4Y2RmODNlZmRmMTJlN2JmMjc3YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccUQJbAH2gAyNDA4OTYxMDg3OjQ0MGJkYjE0ZDcxNDA3NmY4NTk4MjMxOWU4ZGQ3NzdhODg1ZmI2NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f36e80b58f27fd2f038cdf83efdf12e7bf277c4", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/8f36e80b58f27fd2f038cdf83efdf12e7bf277c4", "committedDate": "2020-04-25T19:47:22Z", "message": "Fix Stock View sometimes not showing all items"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65914ac9905bfc9493df769e69798f8bb13b6b8", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/d65914ac9905bfc9493df769e69798f8bb13b6b8", "committedDate": "2020-04-25T19:49:40Z", "message": "Fix formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b53e68731433cc4cbd6b87801efbdb8305b3c093", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/b53e68731433cc4cbd6b87801efbdb8305b3c093", "committedDate": "2020-04-25T19:54:27Z", "message": "Merge branch 'version/1.15' into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84fa0aaf06052529fb9c664f27a6f715c3b2bb2b", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/84fa0aaf06052529fb9c664f27a6f715c3b2bb2b", "committedDate": "2020-04-25T20:20:38Z", "message": "Move the fix to TileEntityRack"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDI4NzEy", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400428712", "createdAt": "2020-04-25T20:29:55Z", "commit": {"oid": "84fa0aaf06052529fb9c664f27a6f715c3b2bb2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMDoyOTo1NVrOGL6Ahg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMDoyOTo1NVrOGL6Ahg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNzkyNg==", "bodyText": "int amount = ItemStackUtils.getSize(stack);\nif (content.containsKey(storage))\n{\namount += content.remove(storage);\n}\ncontent.put(storage, amount);\n\nWhy isn't this enough?", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415137926", "createdAt": "2020-04-25T20:29:55Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/tileentities/TileEntityRack.java", "diffHunk": "@@ -225,12 +225,14 @@ public void updateItemStorage()\n                 continue;\n             }\n \n-            final ItemStorage storage = new ItemStorage(stack.copy());\n+            final ItemStack stackCopy = stack.copy();\n+            final ItemStorage storage = new ItemStorage(stackCopy);\n             int amount = ItemStackUtils.getSize(stack);\n             if (content.containsKey(storage))\n             {\n                 amount += content.remove(storage);\n             }\n+            stackCopy.setCount(amount);\n             content.put(storage, amount);\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84fa0aaf06052529fb9c664f27a6f715c3b2bb2b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6", "committedDate": "2020-04-25T21:08:50Z", "message": "Move the fix back to WindowHutAllInventory\n\nas that seems to be the prefered solution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f60f2e9d059d2f00f6d923b273936db8c7faba9", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/3f60f2e9d059d2f00f6d923b273936db8c7faba9", "committedDate": "2020-04-25T21:09:59Z", "message": "oops, formatting again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDMxNzYx", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400431761", "createdAt": "2020-04-25T21:10:51Z", "commit": {"oid": "867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMToxMDo1MVrOGL6cIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMToxMDo1MVrOGL6cIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0NDk5NA==", "bodyText": "This does not work officially, and even though it works in the current Mc version it is not officially supported. As such please change this to use itemstorage instances or use the proposed change by @Raycoms.", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415144994", "createdAt": "2020-04-25T21:10:51Z", "author": {"login": "OrionDevelopment"}, "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -147,7 +147,9 @@ private void updateResources()\n \n                 for (final Map.Entry<ItemStorage, Integer> entry : storage.entrySet())\n                 {\n-                    items.add(new ItemStorage(entry.getKey().getItemStack(), entry.getValue(), false).getItemStack());\n+                \tItemStack stack = entry.getKey().getItemStack().copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867a0ad8b5f1431e1a244fbcd8c0a88e63bf3dc6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c73b0d03a2a62de6e8c2e6fb898a1248ca58dc", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/b9c73b0d03a2a62de6e8c2e6fb898a1248ca58dc", "committedDate": "2020-04-25T21:17:59Z", "message": "Update this to no longer misuse ItemStacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/88ab8f2181756b1fdf8dd38e8ffa6878780c3378", "committedDate": "2020-04-25T21:22:21Z", "message": "Remove ItemStorage List"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDMzNDQ1", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400433445", "createdAt": "2020-04-25T21:36:04Z", "commit": {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozNjowNFrOGL6sbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTozNjowNFrOGL6sbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTE2NQ==", "bodyText": "Yes better, and make this a Map<ItemStorage, Integer> and increment the quantity in the. And keep ItemStorage the same", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415149165", "createdAt": "2020-04-25T21:36:04Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -135,7 +135,7 @@ private void updateResources()\n     {\n         final List<BlockPos> containerList = building.getContainerList();\n \n-        final List<ItemStack> items = new ArrayList<>();\n+        final Map<ItemStorage, ItemStorage> storedItems = new HashMap<>();\n         final World world = building.getColony().getWorld();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDMzNzE0", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400433714", "createdAt": "2020-04-25T21:40:05Z", "commit": {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo0MDowNVrOGL6u3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo0MDowNVrOGL6u3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE0OTc5MA==", "bodyText": "this should not be necessary.", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415149790", "createdAt": "2020-04-25T21:40:05Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/tileentities/TileEntityRack.java", "diffHunk": "@@ -231,6 +231,7 @@ public void updateItemStorage()\n             {\n                 amount += content.remove(storage);\n             }\n+            storage.setAmount(amount);\n             content.put(storage, amount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ab8f2181756b1fdf8dd38e8ffa6878780c3378"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c5286655568afbc7698903b01346915b2af8012", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/2c5286655568afbc7698903b01346915b2af8012", "committedDate": "2020-04-25T21:51:22Z", "message": "Change storedItems to Map<ItemStorage, Integer>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDM0NTc3", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400434577", "createdAt": "2020-04-25T21:52:12Z", "commit": {"oid": "2c5286655568afbc7698903b01346915b2af8012"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo1MjoxMlrOGL63CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMTo1MjoxMlrOGL63CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1MTg4MA==", "bodyText": "Is like this OK, or do i have to find another way to set the amount of the ItemStorage?", "url": "https://github.com/ldtteam/minecolonies/pull/4759#discussion_r415151880", "createdAt": "2020-04-25T21:52:12Z", "author": {"login": "ToMe25"}, "path": "src/main/java/com/minecolonies/coremod/client/gui/WindowHutAllInventory.java", "diffHunk": "@@ -158,29 +165,25 @@ else if (rack instanceof ChestTileEntity)\n                     final ItemStack stack = ((ChestTileEntity) rack).getStackInSlot(slot);\n                     if (!ItemStackUtils.isEmpty(stack))\n                     {\n-                        items.add(stack.copy());\n+                        ItemStorage currentStorage = new ItemStorage(stack.copy());\n+                        if (storedItems.containsKey(currentStorage))\n+                        {\n+                            storedItems.put(currentStorage, storedItems.get(currentStorage) + stack.getCount());\n+                        }\n+                        else\n+                        {\n+                        \tstoredItems.put(currentStorage, stack.getCount());\n+                        }\n                     }\n                 }\n             }\n         }\n \n-        final Map<ItemStorage, ItemStorage> storedItems = new HashMap<>();\n-        for (final ItemStack currentItem : items)\n-        {\n-            final ItemStorage currentStorage = new ItemStorage(currentItem, currentItem.getCount(), false);\n-\n-            if (storedItems.containsKey(currentStorage))\n-            {\n-                final ItemStorage existing = storedItems.get(currentStorage);\n-                existing.setAmount(existing.getAmount() + currentStorage.getAmount());\n-            }\n-            else\n-            {\n-                storedItems.put(currentStorage, currentStorage);\n-            }\n-        }\n-\n-        final List<ItemStorage> filterItems = new ArrayList<>(storedItems.keySet());\n+        final List<ItemStorage> filterItems = new ArrayList<>();\n+        storedItems.forEach((storage, amount) -> {\n+            storage.setAmount(amount);\n+            filterItems.add(storage);\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c5286655568afbc7698903b01346915b2af8012"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8050bca9f8f0077a29845be3064811b44d1b54f8", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/8050bca9f8f0077a29845be3064811b44d1b54f8", "committedDate": "2020-04-26T08:13:02Z", "message": "Add the hut block inventory to the stock view\n\nafter some more conversation with luxustec i now made a working version\nof this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8988840d1a1d99822fdb0e5bb7d407fcd0a513d8", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/8988840d1a1d99822fdb0e5bb7d407fcd0a513d8", "committedDate": "2020-04-26T08:17:26Z", "message": "Remove unnecessary import\n\nalso rename storage map to rackStorage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "207ae1929139ab0424e8df4f53bf691eee31ad5e", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/207ae1929139ab0424e8df4f53bf691eee31ad5e", "committedDate": "2020-04-26T08:49:13Z", "message": "Merge branch 'version/1.15' into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57fbdd425df7e7af61f2859429701bac05f2f47d", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/57fbdd425df7e7af61f2859429701bac05f2f47d", "committedDate": "2020-04-26T08:51:58Z", "message": "Merge branch 'version/1.15' into fix/4758"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNjU2NDQ1", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-400656445", "createdAt": "2020-04-27T06:25:43Z", "commit": {"oid": "57fbdd425df7e7af61f2859429701bac05f2f47d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a2be45cb7f9c150225c34848d43039859516286", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/0a2be45cb7f9c150225c34848d43039859516286", "committedDate": "2020-04-27T08:48:41Z", "message": "Merge branch 'version/1.15' into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "333bef6e3fd771fe5259b39baac4661cd01eeeb6", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/333bef6e3fd771fe5259b39baac4661cd01eeeb6", "committedDate": "2020-04-27T08:49:05Z", "message": "Merge branch 'version/1.15' of https://github.com/ldtteam/minecolonies into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4637a25d457a1812a25d955b978aaf82f1c0f6fa", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/4637a25d457a1812a25d955b978aaf82f1c0f6fa", "committedDate": "2020-04-27T08:49:22Z", "message": "Merge branch 'version/1.15' into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0596f3cc9d88d2df0deaffe4d36d84d8ab2a15ed", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/0596f3cc9d88d2df0deaffe4d36d84d8ab2a15ed", "committedDate": "2020-04-27T08:49:35Z", "message": "Merge branch 'version/1.15' of https://github.com/ldtteam/minecolonies into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9a62af88faa3095aea2f9929c4aa6e9a2852a8", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/fd9a62af88faa3095aea2f9929c4aa6e9a2852a8", "committedDate": "2020-04-27T08:50:36Z", "message": "Merge branch 'fix/4758' of https://github.com/ToMe25/minecolonies into fix/4758"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97430ae99a6a6ab4f5d36dd362cdf3e7425934c6", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/97430ae99a6a6ab4f5d36dd362cdf3e7425934c6", "committedDate": "2020-04-27T09:37:29Z", "message": "Change chest handling to use LockableTileEntity instead of\nChestTileEntity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c438be03527b3b19078d1914a039fa5a0a6a9f", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/81c438be03527b3b19078d1914a039fa5a0a6a9f", "committedDate": "2020-04-27T11:29:44Z", "message": "Remove chest support as it wasn't working anyways"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53c235370bf4e7efba2a568290a66ebc571647cb", "author": {"user": {"login": "ToMe25", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/53c235370bf4e7efba2a568290a66ebc571647cb", "committedDate": "2020-04-27T11:33:09Z", "message": "oops, imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzc0ODUz", "url": "https://github.com/ldtteam/minecolonies/pull/4759#pullrequestreview-402374853", "createdAt": "2020-04-29T05:38:30Z", "commit": {"oid": "53c235370bf4e7efba2a568290a66ebc571647cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "440bdb14d714076f85982319e8dd777a885fb654", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/440bdb14d714076f85982319e8dd777a885fb654", "committedDate": "2020-04-29T08:31:42Z", "message": "Merge branch 'version/1.15' into fix/4758"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2204, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}