{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDE2NzEy", "number": 5199, "title": "Improve spawner in raids, improve ticks", "bodyText": "Closes #5210\nCloses #5106\nCloses #5198\nChanges proposed in this pull request:\n\nTracks spawner position in raid event and regularly checks them\nAlso now uses the O(1) methods of racks better for the minimum stock ticks.\n\n\nReview please", "createdAt": "2020-06-11T11:33:06Z", "url": "https://github.com/ldtteam/minecolonies/pull/5199", "merged": true, "mergeCommit": {"oid": "1c6ecc1eb73d7752d7025c688bfe02cd6cf3a79a"}, "closed": true, "closedAt": "2020-06-15T11:53:25Z", "author": {"login": "Raycoms"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqMmWXgH2gAyNDMzMDE2NzEyOjYyNjQzYTViMWNhYzIzOWYwZDA4YTc2YjQ4YzQ4ODZmMmYyYTBhZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrfRQiAH2gAyNDMzMDE2NzEyOmY5NGY5NzI5NGYyZjkwNDcwODk2NTU2OGU0YzYxMzBiYjRhMTk5ZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/62643a5b1cac239f0d08a76b48c4886f2f2a0afa", "committedDate": "2020-06-11T11:31:39Z", "message": "Improve spawner in raids, improve ticks\n\nTracks spawner position in raid event and regularly checks them\nAlso now uses the O(1) methods of racks better for the minimum stock ticks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODI5NDU3", "url": "https://github.com/ldtteam/minecolonies/pull/5199#pullrequestreview-428829457", "createdAt": "2020-06-11T11:42:16Z", "commit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo0MjoxNlrOGiZkwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo0MjoxNlrOGiZkwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMzc3Ng==", "bodyText": "is this int even still needed anymore? think you can remove it. Seems like it isnt getting data anymore aswell so logic on it might break", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r438723776", "createdAt": "2020-06-11T11:42:16Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/colonyEvents/raidEvents/AbstractShipRaidEvent.java", "diffHunk": "@@ -117,6 +120,16 @@\n      */\n     private int shipRotation = 0;\n \n+    /**\n+     * List of all spawners.\n+     */\n+    private List<BlockPos> spawners = new ArrayList<>();\n+\n+    /**\n+     * Count of spawners.\n+     */\n+    private int spawnerCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b9bf4c2c36bcb0d1dae6937a7f1a0a3ee16f868", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/1b9bf4c2c36bcb0d1dae6937a7f1a0a3ee16f868", "committedDate": "2020-06-11T11:45:06Z", "message": "init at 0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODMyNTcz", "url": "https://github.com/ldtteam/minecolonies/pull/5199#pullrequestreview-428832573", "createdAt": "2020-06-11T11:47:24Z", "commit": {"oid": "62643a5b1cac239f0d08a76b48c4886f2f2a0afa"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc8f05259551c2bb11f504fe82e2fe04c47ff79", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/dcc8f05259551c2bb11f504fe82e2fe04c47ff79", "committedDate": "2020-06-11T15:49:24Z", "message": "fix #5198"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e6b8a60d079a0439e84244daf073e231fd44809", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/0e6b8a60d079a0439e84244daf073e231fd44809", "committedDate": "2020-06-11T16:02:37Z", "message": "adjust for remaining cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d997f410b008d846c16dbcbdef331fec71f7c3", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/f8d997f410b008d846c16dbcbdef331fec71f7c3", "committedDate": "2020-06-11T16:35:37Z", "message": "fix #5106"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd00f7cf8cfd2b0e20c7c7b62166721533a51f3", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/ffd00f7cf8cfd2b0e20c7c7b62166721533a51f3", "committedDate": "2020-06-11T18:10:29Z", "message": "fix armor level ranges #5103"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcc7454ffb7b8be7c4ec486a8701bee3d4d23a31", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/bcc7454ffb7b8be7c4ec486a8701bee3d4d23a31", "committedDate": "2020-06-12T14:40:41Z", "message": "fix #5210"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb859d7f22cf2af5e941df3bb0bf40335c26153a", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/fb859d7f22cf2af5e941df3bb0bf40335c26153a", "committedDate": "2020-06-12T14:53:19Z", "message": "improve task switching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/c7f45c2642f1e721cbce2d005057e3414de315e7", "committedDate": "2020-06-12T19:27:10Z", "message": "fix #5205"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTM0MDE3", "url": "https://github.com/ldtteam/minecolonies/pull/5199#pullrequestreview-430134017", "createdAt": "2020-06-13T11:51:31Z", "commit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTQyOTA4", "url": "https://github.com/ldtteam/minecolonies/pull/5199#pullrequestreview-430542908", "createdAt": "2020-06-15T11:10:00Z", "commit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDowMVrOGjtnew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMToxMDo0MlrOGjtowQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMDczMQ==", "bodyText": "Pass in the delta here to do this properly. The Stack requestable can tract counts.", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440100731", "createdAt": "2020-06-15T11:10:01Z", "author": {"login": "OrionDevelopment"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuilding.java", "diffHunk": "@@ -584,33 +585,43 @@ public void removeMinimumStock(final ItemStack itemStack)\n     public void onColonyTick(final IColony colony)\n     {\n         super.onColonyTick(colony);\n-        final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n \n-        for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n+        if (colony.getWorld().getChunkProvider().isChunkLoaded(new ChunkPos(getPosition().getX() >> 4, getPosition().getZ() >> 4)))\n         {\n-            final ItemStack itemStack = entry.getKey().getItemStack().copy();\n-            final int count = InventoryUtils.getItemCountInProvider(getTileEntity(), stack -> !stack.isEmpty() && stack.isItemEqual(itemStack));\n-            final int delta = entry.getValue() * itemStack.getMaxStackSize() - count;\n-            final IToken<?> request = getMatchingRequest(itemStack, list);\n-            if (delta > 0)\n+            final Collection<IToken<?>> list = getOpenRequestsByRequestableType().getOrDefault(TypeToken.of(Stack.class), new ArrayList<>());\n+\n+            for (final Map.Entry<ItemStorage, Integer> entry : minimumStock.entrySet())\n             {\n-                if (request == null)\n+                final ItemStack itemStack = entry.getKey().getItemStack().copy();\n+\n+                if (itemStack.isEmpty())\n                 {\n-                    itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n-                    final Stack stack = new Stack(itemStack);\n-                    if (getMainCitizen() != null)\n-                    {\n-                        getMainCitizen().createRequestAsync(stack);\n-                    }\n-                    else\n+                    continue;\n+                }\n+\n+                final int count = InventoryUtils.hasBuildingEnoughElseCount(this, new ItemStorage(itemStack), entry.getValue() * itemStack.getMaxStackSize());\n+                final int delta = (entry.getValue() * itemStack.getMaxStackSize()) - count;\n+                final IToken<?> request = getMatchingRequest(itemStack, list);\n+                if (delta > 0)\n+                {\n+                    if (request == null)\n                     {\n-                        createRequest(stack, false);\n+                        itemStack.setCount(Math.min(itemStack.getMaxStackSize(), delta));\n+                        final Stack stack = new Stack(itemStack);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwMTA1Nw==", "bodyText": "You will probably need to change that here then too if you adapt the AbstractBuilding to use the Delta in the request.", "url": "https://github.com/ldtteam/minecolonies/pull/5199#discussion_r440101057", "createdAt": "2020-06-15T11:10:42Z", "author": {"login": "OrionDevelopment"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingCrafter.java", "diffHunk": "@@ -99,20 +99,21 @@ public boolean canBeGathered()\n                     {\n                         for (final ItemStorage itemStorage : recipeStorage.getCleanedInput())\n                         {\n-                            int amount = itemStorage.getAmount();\n+                            int amount = itemStorage.getAmount() * request.getRequest().getCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7f45c2642f1e721cbce2d005057e3414de315e7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f94f97294f2f904708965568e4c6130bb4a199e4", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/f94f97294f2f904708965568e4c6130bb4a199e4", "committedDate": "2020-06-15T11:50:44Z", "message": "add null check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2157, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}