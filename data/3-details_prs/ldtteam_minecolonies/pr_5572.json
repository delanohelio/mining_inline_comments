{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NzQzMDQx", "number": 5572, "title": "Initial version of BetterRecipes", "bodyText": "Changes proposed in this pull request:\n\nAdd a check to normal crafting to possibly improve the recipe\nAdds support for recipe replacement, to avoid changing order of resolution\nAdds new tags to control when recipe modification can happen, requires explicit ingredient marking, and can have products excluded\n\nWhile I believe this is well tested and basically ready to go, I left debug logging in for the moment, as I wanted to get feedback on the probabilities before I did the final cleanup.\nReview please", "createdAt": "2020-08-14T03:18:47Z", "url": "https://github.com/ldtteam/minecolonies/pull/5572", "merged": true, "mergeCommit": {"oid": "53ec027c33b15375d9a77d3dd9b0a69623868ee9"}, "closed": true, "closedAt": "2020-08-14T21:29:23Z", "author": {"login": "Mekle001"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-r1IIAH2gAyNDY3NzQzMDQxOmRiZmY2MDJjYWZiMTJkZjRjNDIzZWFiZmQyZjk2N2IyM2QwMmEzYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-2ymqAH2gAyNDY3NzQzMDQxOmNkZThjOWQwOTk2YzQ0ZDVlNWFhZDRkNjI0OWExN2YyZTUzNWVjOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/dbff602cafb12df4c423eabfd2f967b23d02a3a9", "committedDate": "2020-08-14T03:13:20Z", "message": "Initial version of BetterRecipes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDEzMjgw", "url": "https://github.com/ldtteam/minecolonies/pull/5572#pullrequestreview-467413280", "createdAt": "2020-08-14T08:52:16Z", "commit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MjoxNlrOHAs4tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MjoxNlrOHAs4tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5NzQ2Mg==", "bodyText": "There is an overlap with the above one? I think only storage_blocks should be excluded?", "url": "https://github.com/ldtteam/minecolonies/pull/5572#discussion_r470497462", "createdAt": "2020-08-14T08:52:16Z", "author": {"login": "Raycoms"}, "path": "src/main/resources/data/minecolonies/tags/items/reduceable_product_excluded.json", "diffHunk": "@@ -0,0 +1,11 @@\n+{\n+  \"replace\": false,\n+  \"values\": [\n+    \"#forge:stone\",\n+    \"#forge:cobblestone\",\n+    \"#forge:gravel\",\n+    \"#forge:sand\",\n+    \"#forge:ingots\",\n+    \"#forge:storage_blocks\"\n+  ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDEzOTI3", "url": "https://github.com/ldtteam/minecolonies/pull/5572#pullrequestreview-467413927", "createdAt": "2020-08-14T08:53:12Z", "commit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzoxM1rOHAs6gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzoxM1rOHAs6gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5NzkyMw==", "bodyText": "This seems to go through ALL ingredients to improve then. But it should pick one at random actually.", "url": "https://github.com/ldtteam/minecolonies/pull/5572#discussion_r470497923", "createdAt": "2020-08-14T08:53:13Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -265,6 +267,59 @@ public boolean canRecipeBeAdded(final IToken<?> ignored)\n         return Optional.empty();\n     }\n \n+    /**\n+     * Has a chance to reduce the resource requirements for the recipe in this building\n+     * @param recipe the recipe we're possibly improving\n+     * @param count the number of items (chances) \n+     * @param citizen The citizen, as the primary skill can improve the chances\n+     */\n+    public void improveRecipe(IRecipeStorage recipe, int count, ICitizenData citizen)\n+    {\n+        final double baseChance = 0.0625;\n+        final ResourceLocation reducableIngredients = new ResourceLocation(\"minecolonies\", \"reduceable_ingredient\");\n+        final ResourceLocation reducableProductExclusions = new ResourceLocation(\"minecolonies\", \"reduceable_product_excluded\");\n+        final List<ItemStorage> inputs = recipe.getCleanedInput().stream().sorted(Comparator.comparingInt(ItemStorage::getAmount).reversed()).collect(Collectors.toList());\n+\n+        final double actualChance = Math.min(5.0, (baseChance * count) + (baseChance * citizen.getCitizenSkillHandler().getLevel(getPrimarySkill())));\n+        final double roll = citizen.getRandom().nextDouble() * 100;\n+\n+        Log.getLogger().info(this.getJobName() + \": for \" + recipe.getPrimaryOutput().getItem() + \" improvement roll is \" + roll + \" with an actual chance of: \" + actualChance);\n+        if(roll <= actualChance && !ItemTags.getCollection().getOrCreate(reducableProductExclusions).contains(recipe.getPrimaryOutput().getItem()))\n+        {\n+            ArrayList<ItemStack> newRecipe = new ArrayList<>();\n+            boolean didReduction = false;\n+            Log.getLogger().info(this.getJobName() + \": attempting to improve recipe for: \" + recipe.getPrimaryOutput().getItem());\n+            for(ItemStorage input : inputs)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDE0MDM0", "url": "https://github.com/ldtteam/minecolonies/pull/5572#pullrequestreview-467414034", "createdAt": "2020-08-14T08:53:22Z", "commit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzoyMlrOHAs6zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzoyMlrOHAs6zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5Nzk5OA==", "bodyText": "This could cause logging spam", "url": "https://github.com/ldtteam/minecolonies/pull/5572#discussion_r470497998", "createdAt": "2020-08-14T08:53:22Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -265,6 +267,59 @@ public boolean canRecipeBeAdded(final IToken<?> ignored)\n         return Optional.empty();\n     }\n \n+    /**\n+     * Has a chance to reduce the resource requirements for the recipe in this building\n+     * @param recipe the recipe we're possibly improving\n+     * @param count the number of items (chances) \n+     * @param citizen The citizen, as the primary skill can improve the chances\n+     */\n+    public void improveRecipe(IRecipeStorage recipe, int count, ICitizenData citizen)\n+    {\n+        final double baseChance = 0.0625;\n+        final ResourceLocation reducableIngredients = new ResourceLocation(\"minecolonies\", \"reduceable_ingredient\");\n+        final ResourceLocation reducableProductExclusions = new ResourceLocation(\"minecolonies\", \"reduceable_product_excluded\");\n+        final List<ItemStorage> inputs = recipe.getCleanedInput().stream().sorted(Comparator.comparingInt(ItemStorage::getAmount).reversed()).collect(Collectors.toList());\n+\n+        final double actualChance = Math.min(5.0, (baseChance * count) + (baseChance * citizen.getCitizenSkillHandler().getLevel(getPrimarySkill())));\n+        final double roll = citizen.getRandom().nextDouble() * 100;\n+\n+        Log.getLogger().info(this.getJobName() + \": for \" + recipe.getPrimaryOutput().getItem() + \" improvement roll is \" + roll + \" with an actual chance of: \" + actualChance);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDE0MTk3", "url": "https://github.com/ldtteam/minecolonies/pull/5572#pullrequestreview-467414197", "createdAt": "2020-08-14T08:53:36Z", "commit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzozNlrOHAs7SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1MzozNlrOHAs7SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5ODEyMQ==", "bodyText": "final List", "url": "https://github.com/ldtteam/minecolonies/pull/5572#discussion_r470498121", "createdAt": "2020-08-14T08:53:36Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -265,6 +267,59 @@ public boolean canRecipeBeAdded(final IToken<?> ignored)\n         return Optional.empty();\n     }\n \n+    /**\n+     * Has a chance to reduce the resource requirements for the recipe in this building\n+     * @param recipe the recipe we're possibly improving\n+     * @param count the number of items (chances) \n+     * @param citizen The citizen, as the primary skill can improve the chances\n+     */\n+    public void improveRecipe(IRecipeStorage recipe, int count, ICitizenData citizen)\n+    {\n+        final double baseChance = 0.0625;\n+        final ResourceLocation reducableIngredients = new ResourceLocation(\"minecolonies\", \"reduceable_ingredient\");\n+        final ResourceLocation reducableProductExclusions = new ResourceLocation(\"minecolonies\", \"reduceable_product_excluded\");\n+        final List<ItemStorage> inputs = recipe.getCleanedInput().stream().sorted(Comparator.comparingInt(ItemStorage::getAmount).reversed()).collect(Collectors.toList());\n+\n+        final double actualChance = Math.min(5.0, (baseChance * count) + (baseChance * citizen.getCitizenSkillHandler().getLevel(getPrimarySkill())));\n+        final double roll = citizen.getRandom().nextDouble() * 100;\n+\n+        Log.getLogger().info(this.getJobName() + \": for \" + recipe.getPrimaryOutput().getItem() + \" improvement roll is \" + roll + \" with an actual chance of: \" + actualChance);\n+        if(roll <= actualChance && !ItemTags.getCollection().getOrCreate(reducableProductExclusions).contains(recipe.getPrimaryOutput().getItem()))\n+        {\n+            ArrayList<ItemStack> newRecipe = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbff602cafb12df4c423eabfd2f967b23d02a3a9"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8648e63f25152a95e216dddd8114f3bd379e8ea7", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/8648e63f25152a95e216dddd8114f3bd379e8ea7", "committedDate": "2020-08-14T15:08:24Z", "message": "Merge branch 'version/1.15' into betterrecipes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f93559be69299652dcdab58257932cb0f75fb84", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/9f93559be69299652dcdab58257932cb0f75fb84", "committedDate": "2020-08-14T15:14:54Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d285857efbd1dfc9833a55e48c4d4a27c76c0944", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/d285857efbd1dfc9833a55e48c4d4a27c76c0944", "committedDate": "2020-08-14T15:14:54Z", "message": "Minor recipe tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f1726384cadafe3a4a07436025d4b965ab733e7", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/2f1726384cadafe3a4a07436025d4b965ab733e7", "committedDate": "2020-08-14T15:20:06Z", "message": "Remove logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjYyODI1", "url": "https://github.com/ldtteam/minecolonies/pull/5572#pullrequestreview-467662825", "createdAt": "2020-08-14T15:20:37Z", "commit": {"oid": "d285857efbd1dfc9833a55e48c4d4a27c76c0944"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNToyMDozN1rOHA4qvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNToyMDozN1rOHA4qvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY5MDQ5Mg==", "bodyText": "could use some more constants for the numbers and strings used, instead of \"minecolonies\" use MOD_ID", "url": "https://github.com/ldtteam/minecolonies/pull/5572#discussion_r470690492", "createdAt": "2020-08-14T15:20:37Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/buildings/AbstractBuildingWorker.java", "diffHunk": "@@ -265,6 +267,59 @@ public boolean canRecipeBeAdded(final IToken<?> ignored)\n         return Optional.empty();\n     }\n \n+    /**\n+     * Has a chance to reduce the resource requirements for the recipe in this building\n+     * @param recipe the recipe we're possibly improving\n+     * @param count the number of items (chances) \n+     * @param citizen The citizen, as the primary skill can improve the chances\n+     */\n+    public void improveRecipe(IRecipeStorage recipe, int count, ICitizenData citizen)\n+    {\n+        final double baseChance = 0.0625;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d285857efbd1dfc9833a55e48c4d4a27c76c0944"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fefca7e2e4fe8c666550de58a9dbf200a1ff4cd", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/3fefca7e2e4fe8c666550de58a9dbf200a1ff4cd", "committedDate": "2020-08-14T15:28:50Z", "message": "Feedback on constants"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70339611be2f93f32292f125a358ade415eb0ac", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/a70339611be2f93f32292f125a358ade415eb0ac", "committedDate": "2020-08-14T15:38:13Z", "message": "More constant cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cde8c9d0996c44d5e5aad4d6249a17f2e535ec90", "author": {"user": {"login": "Mekle001", "name": "Mike Garlick"}}, "url": "https://github.com/ldtteam/minecolonies/commit/cde8c9d0996c44d5e5aad4d6249a17f2e535ec90", "committedDate": "2020-08-14T15:59:32Z", "message": "Merge branch 'version/1.15' into betterrecipes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2054, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}