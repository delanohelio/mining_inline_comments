{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNDkwMjE3", "number": 6196, "title": "Fixes and pathing improvements", "bodyText": "Closes #6100\nCloses #6193\nCloses #6198\nChanges proposed in this pull request:\nPathing now also maps corner nodes when going upstairs or dropping down, giving our citizen a more smooth path to follow and fixing some corner cases, like in 6100 where without that node they jump down from a ladder since the next node is diagonal in the opposite direction on the next floor.\nPathing now considers going down through passable blocks, which previously did not work in cases where the passable block is also of walkable ground type, like trapdoors are.\nImproved pathfollow, it is now better at recognizing arrival at a path point and also displays this during debug draw, reached nodes are displayed as orange:\n\nAdjust min raidlevel before the first raid to be a bit lower\nFix pathing trying to drop down from places where the previous block is passable and dropable, e.g. jumping down vines instead of going them down.\nFix random path generation beeing able to end up on blocks a citizen cannot stand upon.\nFix guards doing stuck teleport during combat\nFix guards using rails during combat\nFix visitor zero position check throwing errors on clientside, when some other mods are creating one at 0 0 for\nrendering\nFix raids not spawning at low levels\nFix AI getting stuck when removing tasks\nFix citizen loading the colony to find the team, when not needed to do so\nReview please", "createdAt": "2020-12-04T12:02:59Z", "url": "https://github.com/ldtteam/minecolonies/pull/6196", "merged": true, "mergeCommit": {"oid": "63abaee903b0d59b7eeb7b90c139be3a5c5beb50"}, "closed": true, "closedAt": "2020-12-06T09:38:54Z", "author": {"login": "someaddons"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi16O1AH2gAyNTMyNDkwMjE3OjgxMmYxM2U2MjgxOGM3ZGIyNTJhYmI0YThmNWMwMjdkZDMzYmFhYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjQaCFAFqTU0NTYzNzk5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "812f13e62818c7db252abb4a8f5c027dd33baab4", "author": {"user": {"login": "someaddons", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/812f13e62818c7db252abb4a8f5c027dd33baab4", "committedDate": "2020-12-04T11:19:14Z", "message": "Pathing and other fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee7248ef5a13b3909c00b40beec7add5f011fc2", "author": {"user": {"login": "someaddons", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/7ee7248ef5a13b3909c00b40beec7add5f011fc2", "committedDate": "2020-12-04T12:01:18Z", "message": "fix drop not beeing allowed when dropping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0OTA1Nzk4", "url": "https://github.com/ldtteam/minecolonies/pull/6196#pullrequestreview-544905798", "createdAt": "2020-12-04T12:12:33Z", "commit": {"oid": "7ee7248ef5a13b3909c00b40beec7add5f011fc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjoxMjozM1rOH_OQnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjoxMjozM1rOH_OQnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NTk2NQ==", "bodyText": "I sthis enough to have this here, what happens if combat finishes and they are hungry, or try to retreat with low health?", "url": "https://github.com/ldtteam/minecolonies/pull/6196#discussion_r536055965", "createdAt": "2020-12-04T12:12:33Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/guard/AbstractEntityAIGuard.java", "diffHunk": "@@ -438,6 +440,11 @@ private IAIState checkAndAttackTarget()\n         if (fighttimer > 0)\n         {\n             fighttimer--;\n+            if (fighttimer == 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee7248ef5a13b3909c00b40beec7add5f011fc2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f72583dfb43e11f3c4b6d039635cf96e8fc1a0a", "author": {"user": {"login": "someaddons", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/4f72583dfb43e11f3c4b6d039635cf96e8fc1a0a", "committedDate": "2020-12-04T15:34:09Z", "message": "Fix raids not spawning at low levels\nFix AI getting stuck when removing tasks\nFix citizen loading the colony to find the team, when not needed to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NjM3OTkz", "url": "https://github.com/ldtteam/minecolonies/pull/6196#pullrequestreview-545637993", "createdAt": "2020-12-05T18:07:21Z", "commit": {"oid": "4f72583dfb43e11f3c4b6d039635cf96e8fc1a0a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxODowNzoyMVrOH_9uDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxODowNzozM1rOH_9uIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMzU1MQ==", "bodyText": "Are we sure this can not produce an NPE?\nWould a getOrDefault(..., Collections.emptyList()) not be better here just to be sure.", "url": "https://github.com/ldtteam/minecolonies/pull/6196#discussion_r536833551", "createdAt": "2020-12-05T18:07:21Z", "author": {"login": "OrionDevelopment"}, "path": "src/api/java/com/minecolonies/api/entity/ai/statemachine/basestatemachine/BasicStateMachine.java", "diffHunk": "@@ -92,15 +92,11 @@ public void removeTransition(final T transition)\n     {\n         if (transition instanceof IStateMachineEvent)\n         {\n-            final List<T> temp = new ArrayList<>(eventTransitionMap.get(((IStateMachineEvent<?>) transition).getEventType()));\n-            temp.remove(transition);\n-            eventTransitionMap.put(((IStateMachineEvent<?>) transition).getEventType(), temp);\n+            eventTransitionMap.get(((IStateMachineEvent<?>) transition).getEventType()).removeIf(t -> t == transition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f72583dfb43e11f3c4b6d039635cf96e8fc1a0a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgzMzU3MQ==", "bodyText": "See other comments in the file.", "url": "https://github.com/ldtteam/minecolonies/pull/6196#discussion_r536833571", "createdAt": "2020-12-05T18:07:33Z", "author": {"login": "OrionDevelopment"}, "path": "src/api/java/com/minecolonies/api/entity/ai/statemachine/basestatemachine/BasicStateMachine.java", "diffHunk": "@@ -92,15 +92,11 @@ public void removeTransition(final T transition)\n     {\n         if (transition instanceof IStateMachineEvent)\n         {\n-            final List<T> temp = new ArrayList<>(eventTransitionMap.get(((IStateMachineEvent<?>) transition).getEventType()));\n-            temp.remove(transition);\n-            eventTransitionMap.put(((IStateMachineEvent<?>) transition).getEventType(), temp);\n+            eventTransitionMap.get(((IStateMachineEvent<?>) transition).getEventType()).removeIf(t -> t == transition);\n         }\n         else\n         {\n-            final List<T> temp = new ArrayList<>(transitionMap.get(transition.getState()));\n-            temp.remove(transition);\n-            transitionMap.put(transition.getState(), temp);\n+            transitionMap.get(transition.getState()).removeIf(t -> t == transition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f72583dfb43e11f3c4b6d039635cf96e8fc1a0a"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1703, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}