{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MjgzMTMw", "number": 6160, "title": "#5218 Support more varied fishing rods.  Also improves fisher mainhand equips.", "bodyText": "Targets Issue #5218.  I don't think it's a full enough to be worth the bounty (and I can't accept it), but may be enough for that user's purpose.\nChanges proposed in this pull request:\n\nChanged most tests for fishing rods from == Items.FishingRod to instanceof FishingRodItem.  This allows fishers to use Aquaculture Fishing Rods, and should allow support for most other modded fishing rods (or any other item that implements FishingRodItem, like the XercaMod GrabHook).  May eventually be worth adding a blacklist to avoid the next coming of the MFR \"Fishing Rod\", but most cases I could find were funny rather than dangerous.\nConverted fishing rod's getMiningLevel logic to test against durability and enchantment levels, instead of allowing any usage from any completed hut level.   In a vanilla+minecolonies setup, this basically just requires higher hut tiers for enchanted fishing rods.  With Aquaculture, Wood or Gold for Tier 1, Iron for Tier 2, and Diamond/Neptunium, with an extra hut tier required for enchantments.  This is based on durability, so it should support most common approaches for fishing rods, and falls back to T1 for unbreakable rods.\nFishers who can't find a compatible fishing rod will swap to an air block, and will swap if the mainhand fishing rod doesn't match the first usable fishing rod in their inventory.  Doesn't handle case where a Fisher is fired and then has fishing rod removed from their inventory, but should be more consistent than before.\n\nTests completed:\n\nMinecraft 1.16.4 + structurize-0.13.100-RELEASE, tested Fishers with no rod, an unenchanted wooden rod, and an enchanted III wooden rod at T1, T3, and T4 huts.\nMinecraft 1.16.4 + structurize-0.13.100-RELEASE + Aquaculture 2.1.6, tested Fishers with Wooden, Gold, Iron, Diamond, and Neptuneum fishing rods, and an enchanted Lure/Luck III Neptuneum Rod.  Placed warehouse and blacksmith to test request system and the fishers do ask for generic fishing rods, though I'm not sure I understand why the blacksmith picks a specific recipe to make if multiple are available.\nMinecraft 1.16.4 + structurize-0.13.100-RELEASE + Aquaculture 2.1.6 + XercaMod 1.16.3-1.1, tested Fishers with Grab Hook and Grabbing Grab Hook.  Worked and probably shouldn't, but just had the Fishers reeling in Aquaculture fish.\n\nMy apologies for the spam.  I'm a bit too used to svn, so making a mess with git.\nReview please", "createdAt": "2020-11-26T22:18:34Z", "url": "https://github.com/ldtteam/minecolonies/pull/6160", "merged": true, "mergeCommit": {"oid": "3e97ccf15ed71c55ad47873ef61e9775ea56e12b"}, "closed": true, "closedAt": "2020-11-29T19:08:33Z", "author": {"login": "gattsuru"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgZ7G6AH2gAyNTI4MjgzMTMwOmFkNjgyYTU0NGU4ODNiYWZjNWY5NjQ4YzhlMTgwNWRkOWM3ODA3M2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhVcpdAFqTU0MDUwNjgwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad682a544e883bafc5f9648c8e1805dd9c78073f", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/ad682a544e883bafc5f9648c8e1805dd9c78073f", "committedDate": "2020-11-26T21:35:00Z", "message": "Changed most tests for fishing rods from == Items.FishingRod to instanceof FishingRodItem.  This allows fishers to use Aquaculture Fishing Rods, and should allow support for most other modded fishing rods (or any other item that implements FishingRodItem, like the XercaMod GrabHook).\n\nAlso converted the fishing rod's getMiningLevel logic to test against durability and enchantment levels, instead of allowing any usage from any completed hut level.  In a vanilla+minecolonies setup, this basically just requires higher hut tiers for enchanted fishing rods.  With Aquaculture, Wood or Gold for Tier 1, Iron for Tier 2, and Diamond/Neptunium requiring T3 or higher, with an extra hut tier required per enchantment level (using the same rules as other huts).  A Neptunium Rod with Luck/Lure III thus only works at T5 Fishing Huts.  This is based on durability, so it should support most common approaches for fishing rods, and falls back to T1 if someone makes an invulnerable rod.\n\nFinally, fishers who can't find a compatible fishing rod will swap to an air block, and changes method to check rods so that equipped rod will swap if it doesn't match the intended fishing rod.  This is a little more computationally expensive than the previous approach, but will avoid issue where fisher would appear to be holding a rod they no longer possessed in inventory.  May not solve issue if fisher is fired and then rod is pulled from their inventory."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTc3MzM1", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-539577335", "createdAt": "2020-11-26T23:26:26Z", "commit": {"oid": "ad682a544e883bafc5f9648c8e1805dd9c78073f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzoyNjoyN1rOH6pEHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzoyNjoyN1rOH6pEHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI1MjI1NQ==", "bodyText": "Isn't there a registry where we could get that dynamically? Like maybe getting another tool and comparing the durability to make this more dynamic?", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r531252255", "createdAt": "2020-11-26T23:26:27Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -312,6 +314,20 @@ else if (ToolType.HELMET.equals(toolType)\n                 return getArmorLevel(ArmorItem.getArmorMaterial());\n             }\n         }\n+        else if (stack.getItem() instanceof FishingRodItem)\n+        {\n+            if(stack.getItem().isDamageable())\n+            {\n+                if(stack.getMaxDamage() < DURABILITY_MAX_WOOD_OR_GOLD)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad682a544e883bafc5f9648c8e1805dd9c78073f"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/1c8408fcfee5c4b832ed552ef53c87fe599cbb86", "committedDate": "2020-11-27T05:17:41Z", "message": "Removes hard-coded durability constants, changes ItemStackUtils to use net.minecraft.items.ItemTier.getMaxUses to estimate fishing rod tier levels.  Still requires an offset, but less of a magic number.\n\nAlso moves the calculations out of getMiningLevel into a proper function, and cleans up a trailing comment left from the last commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzg1ODU2", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540385856", "createdAt": "2020-11-28T16:30:04Z", "commit": {"oid": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzg1OTY5", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540385969", "createdAt": "2020-11-28T16:32:01Z", "commit": {"oid": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxNjozMjowMlrOH7aQxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxNjozMjowMlrOH7aQxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1ODMxMA==", "bodyText": "We always add braces, even on those ifs", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532058310", "createdAt": "2020-11-28T16:32:02Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,33 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if(itemStack.getItem() == Items.FISHING_ROD)\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        if(!itemStack.isDamageable())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c8408fcfee5c4b832ed552ef53c87fe599cbb86"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/4e873add3be97ed82e7118a232f76af1706aa0bc", "committedDate": "2020-11-28T17:01:53Z", "message": "Cleanup for compliance with bracket style and method comment rules."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDA0NDE2", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540404416", "createdAt": "2020-11-28T17:03:56Z", "commit": {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDE1MTg0", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540415184", "createdAt": "2020-11-28T20:17:38Z", "commit": {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQyMDoxNzozOFrOH7c7vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQyMDoxODoxOFrOH7c76w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjA3Nw==", "bodyText": "How sure are we this is a good idea.\nI would say if th rod is not damageable it is a max hut level feature.", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532102077", "createdAt": "2020-11-28T20:17:38Z", "author": {"login": "OrionDevelopment"}, "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,42 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     *\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if (itemStack.getItem() == Items.FISHING_ROD)\n+        {\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        }\n+        if (!itemStack.isDamageable())\n+        {\n+            return 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMjEyMw==", "bodyText": "These hardcored constants should be configurable from the config", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532102123", "createdAt": "2020-11-28T20:18:18Z", "author": {"login": "OrionDevelopment"}, "path": "src/api/java/com/minecolonies/api/util/ItemStackUtils.java", "diffHunk": "@@ -479,6 +483,42 @@ else if (damageReductionAmount <= ArmorMaterial.DIAMOND.getDamageReductionAmount\n         return 5;\n     }\n \n+    /**\n+     * Estimates the fishing rod tier from available durability and enchantment status.\n+     *\n+     * @param itemStack the tool to check.\n+     * @return equivalent tool level.\n+     */\n+    private static int getFishingRodLevel(final ItemStack itemStack)\n+    {\n+        if (itemStack.getItem() == Items.FISHING_ROD)\n+        {\n+            return (1 + getMaxEnchantmentLevel(itemStack));\n+        }\n+        if (!itemStack.isDamageable())\n+        {\n+            return 1;\n+        }\n+        /**\n+         *  Because fishing rods don't follow ItemTier values, these numbers require an offset.\n+         *  Wood + 6 is required to allow T1 huts to use up to vanilla fishing rods equivalents.\n+         *  Wood + 22 allows T1 huts to use up to ThermalFoundation Silver fishing rods.\n+         *  Iron + 6 allows T2 huts to use up to ThermalFoundation Iron fishing rods or Aquaculture Iron,\n+         *  while still requiring T3 for ThermalFoundation advanced alloys, Aquaculture Neptunium,\n+         *  or Aquaculture diamond rods.\n+         * */\n+        final int rodDurability = itemStack.getMaxDamage();\n+        if (rodDurability <= (ItemTier.WOOD.getMaxUses() + 22))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e873add3be97ed82e7118a232f76af1706aa0bc"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718af5bb41980d2570ae8234f9ba3fa601995f7e", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/718af5bb41980d2570ae8234f9ba3fa601995f7e", "committedDate": "2020-11-28T22:40:34Z", "message": "Added a configuration option for T1 and T2 fishing rod limits, along with reasonably generous ranges.  Hoping MinecoloniesAPIProxy.getInstance().getConfig().getServer() is the right approach.\n\nSwitched unbreakable fishing rods to require T5 huts.\n\nAdded comments for those configuration options to the en_us.json.  Also fixed some unrelated comments and translations in en_us.json, where either case, typo, or absence were issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce0415e79191df48711a55da8d5975d84d75bcdc", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/ce0415e79191df48711a55da8d5975d84d75bcdc", "committedDate": "2020-11-28T22:44:51Z", "message": "And added a typo last time, so the fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4", "author": {"user": {"login": "gattsuru", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/9bfb811ed913ff30508f88f0773feaf85093b7a4", "committedDate": "2020-11-29T03:07:47Z", "message": "Reinsert training end-of-line, for posix compliance."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDg1OTY4", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540485968", "createdAt": "2020-11-29T14:38:11Z", "commit": {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNDozODoxMlrOH7kC-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNDozODoxMlrOH7kC-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIxODYxNw==", "bodyText": "negative values?", "url": "https://github.com/ldtteam/minecolonies/pull/6160#discussion_r532218617", "createdAt": "2020-11-29T14:38:12Z", "author": {"login": "Raycoms"}, "path": "src/api/java/com/minecolonies/api/configuration/ServerConfiguration.java", "diffHunk": "@@ -955,6 +957,9 @@ protected ServerConfiguration(final ForgeConfigSpec.Builder builder)\n \n         dynamicTreeHarvestSize = defineInteger(builder, \"dynamictreeharvestsize\", 5, 1, 5);\n \n+        fishingRodDurabilityAdjustT2 = defineInteger(builder, \"fishingroddurabilityadjustt2\", 6, -249, 250000);\n+        fishingRodDurabilityAdjustT1 = defineInteger(builder, \"fishingroddurabilityadjustt1\", 22, -58, 250000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDg5MDk1", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540489095", "createdAt": "2020-11-29T15:16:03Z", "commit": {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTA2ODA3", "url": "https://github.com/ldtteam/minecolonies/pull/6160#pullrequestreview-540506807", "createdAt": "2020-11-29T18:56:02Z", "commit": {"oid": "9bfb811ed913ff30508f88f0773feaf85093b7a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1837, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}