{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNDMyMzU2", "number": 5067, "title": "Replaces randomized deliveryman gathering with targeted pickup-requests", "bodyText": "Feature Suggestion\nCurrently, the deliveryman just randomly picks from all gatherable buildings.\nThis PR replaces the randomized mechanism with a pickup-request system, where workers will request pickups when they deem necessary (usually after having gathered a certain amount of items).\nThis significantly increases the efficiency of dmen. Most of their time is now spent dumping their own inventory in preparation for delivery requests (might be also improved in the future), not randomly wandering around aimlessly.\nAlso, the dman hut's request page was bugfixed, it now only shows the request that are actually in progress.\nImplementation\n\nWeighted randomized gathering has been removed.\nWorkers request pickups after dumping their inventory, if certain conditions are met.\n2a. The pickup priority must not be \"Never\".\n2b. The dump must not be part of a crafting request (otherwise the dman would visit the building twice).\n2c. There must be a worker employed at the hut to make the request in the first place.\nThe pickup modes \"Static\" and \"Automatic\" have been removed. There is now a global priority that is internally treated as the initial priority for the pickup request.\nPickup requests are scheduled based on an aging scheduling algorithm. Simply said, requests become more important as they become older, but start with the priority set in the building. For most players, just leaving the pickup priority at 1 (default) will suffice. Players can set the priority between 1 and 10.\nThe aging algorithm can set the priority to 11, thereby making very old requests always more important than new requests.\nWhen a worker's inventory is full, it will always issue a priority-10-pickup-request.\nWhen a deliveryman has nothing to do, it will loiter around in the warehouse.\nThere is a \"Request pickup now\" button that ... requests an immediate pickup. Technically speaking, it requests a pickup at priority 12. You're all welcome.\n\n\nOpen Considerations\nThe pickup ranges are configurable and might change over time. Depending on the colony size, the aging mechanism might raise every request to the maximum of 11 very quickly. If everything is important, nothing is important :-)\nWe'll see ... over time.\nPlease make sure the RS-reset is done correctly in the PR.", "createdAt": "2020-05-24T15:52:01Z", "url": "https://github.com/ldtteam/minecolonies/pull/5067", "merged": true, "mergeCommit": {"oid": "2a9377b4bdb1664ad25578bf2b6806107910b893"}, "closed": true, "closedAt": "2020-05-28T19:22:10Z", "author": {"login": "JiaYow"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjix4KgH2gAyNDIyNDMyMzU2Ojk1ZDIzN2Y4YWIzMTdkNmNhZmI0N2M3M2VjODczZDQxNDQ4YzVkYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcly7hkgH2gAyNDIyNDMyMzU2Ojk5ZDIyODg2ZWRhNzQ2ZTUwMTMxZWM4YTQ3M2ZmMzkzZmEwZWQyZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95d237f8ab317d6cafb47c73ec873d41448c5da1", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/95d237f8ab317d6cafb47c73ec873d41448c5da1", "committedDate": "2020-05-21T19:24:41Z", "message": "PROTOTYPE! DO NOT MERGE! Started work on dman request refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09551b45471e78a0e83c7af70f5752423ff3929f", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/09551b45471e78a0e83c7af70f5752423ff3929f", "committedDate": "2020-05-21T23:58:36Z", "message": "PROTOTYPE! DO NOT MERGE! Mainly reworked Deliveryman AI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee8f836baf67d5e8345ea088c96942bc268190ef", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/ee8f836baf67d5e8345ea088c96942bc268190ef", "committedDate": "2020-05-22T17:43:43Z", "message": "Prepared deliveryman for new pickup system"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a34ee1fb881332e4d39248bb72495788aa0f723", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/4a34ee1fb881332e4d39248bb72495788aa0f723", "committedDate": "2020-05-22T19:15:21Z", "message": "Made workers create a pickup request after dump."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4603247b5bee04ff36ba43e5bea03b7273e0f9cc", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/4603247b5bee04ff36ba43e5bea03b7273e0f9cc", "committedDate": "2020-05-22T21:27:06Z", "message": "Aligned code with reality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94939217b33cccd4a1c934787f70c6826dc28069", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/94939217b33cccd4a1c934787f70c6826dc28069", "committedDate": "2020-05-22T23:07:27Z", "message": "Almost completed prototype. Deliveryman can now pickup on-demand"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3202fa4812b58248fc22ca394e71b768e6da84f9", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/3202fa4812b58248fc22ca394e71b768e6da84f9", "committedDate": "2020-05-23T19:15:46Z", "message": "Added info text on force pickup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d5706dd20ad0f870a00c3d7d7092a558460f0a", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/d8d5706dd20ad0f870a00c3d7d7092a558460f0a", "committedDate": "2020-05-23T23:25:58Z", "message": "Improved overall stability of the dman"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11cd22e03bf6e4f0df7e1ec86c26edbca3a1dd5f", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/11cd22e03bf6e4f0df7e1ec86c26edbca3a1dd5f", "committedDate": "2020-05-24T00:02:50Z", "message": "Adapted delays a bit, and don't request a pickup when another request is already active."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2511aa580136c0526e642a6d152ddf0af31ee67", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/e2511aa580136c0526e642a6d152ddf0af31ee67", "committedDate": "2020-05-24T08:56:01Z", "message": "Updated RS version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bff523867e61ac49cced9927b7616584f46111f", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/3bff523867e61ac49cced9927b7616584f46111f", "committedDate": "2020-05-24T08:56:44Z", "message": "Merge remote-tracking branch 'upstream/version/1.15' into feature/wip-request-pickup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2f58392cc7d4d3c9bf7e171230b00dc44af0822", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/c2f58392cc7d4d3c9bf7e171230b00dc44af0822", "committedDate": "2020-05-24T14:10:34Z", "message": "Made it so that the builder also doesn't keep requesting pickups."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a19b255cafc070a7c75d263f4ff6db25757e7e2", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/4a19b255cafc070a7c75d263f4ff6db25757e7e2", "committedDate": "2020-05-24T15:05:53Z", "message": "Streamlined delays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c619830b632f8886c07316ef8448287c5e7e274", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/5c619830b632f8886c07316ef8448287c5e7e274", "committedDate": "2020-05-24T15:45:48Z", "message": "Removed unnecessary imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzcwOTcx", "url": "https://github.com/ldtteam/minecolonies/pull/5067#pullrequestreview-417370971", "createdAt": "2020-05-24T16:01:30Z", "commit": {"oid": "5c619830b632f8886c07316ef8448287c5e7e274"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNjowMTozMFrOGZvztQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNjowMTozMFrOGZvztQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1MDg2OQ==", "bodyText": "Ahh nice, that's what you mean with this, yes, this works fine", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r429650869", "createdAt": "2020-05-24T16:01:30Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/basic/AbstractEntityAICrafting.java", "diffHunk": "@@ -355,4 +356,10 @@ private int getRequiredProgressForMakingRawMaterial()\n     {\n         return PROGRESS_MULTIPLIER / Math.min(worker.getCitizenData().getJobModifier() + 1, MAX_LEVEL) * HITTING_TIME;\n     }\n+\n+    @Override\n+    public boolean isAfterDumpPickupAllowed()\n+    {\n+        return currentRequest == null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c619830b632f8886c07316ef8448287c5e7e274"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1df41d6bb78b072ca6a70b3249ade20c08dc9090", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/1df41d6bb78b072ca6a70b3249ade20c08dc9090", "committedDate": "2020-05-24T17:41:31Z", "message": "Added a (somewhat lazy) protection against pickup-request spam while inventory is full"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead3609d3fce423bf0e3b5d1fb71d2c650162e54", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/ead3609d3fce423bf0e3b5d1fb71d2c650162e54", "committedDate": "2020-05-24T17:46:41Z", "message": "Added missing comment for isPickupLockEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/b0d717897751eb0bb341b407f70c564a2da2bf6b", "committedDate": "2020-05-24T21:05:51Z", "message": "Use built-in-function instead of isPickupLockEnabled to avoid multiple pickup-requests at once."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDc1MjU0", "url": "https://github.com/ldtteam/minecolonies/pull/5067#pullrequestreview-417475254", "createdAt": "2020-05-25T06:09:53Z", "commit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowOTo1M1rOGZ1rxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjowOTo1M1rOGZ1rxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NzE0MQ==", "bodyText": "Sadly this will never work.\nThe Delivery can not, and will never, have control over execution order of its tasks.\nThe RS handles ordering and as such the DMan should never alter them, since this might mess up request-trees, if one order gets executed before another. Yes you might have it working now, but this is fragile and the RS handles this internally already.", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r429747141", "createdAt": "2020-05-25T06:09:53Z", "author": {"login": "OrionDevelopment"}, "path": "src/api/java/com/minecolonies/api/colony/requestsystem/requestable/deliveryman/AbstractDeliverymanRequestable.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.minecolonies.api.colony.requestsystem.requestable.deliveryman;\n+\n+public abstract class AbstractDeliverymanRequestable implements IDeliverymanRequestable\n+{\n+    ////// --------------------------- NBTConstants --------------------------- \\\\\\\\\\\\\n+    protected static final String NBT_PRIORITY = \"Priority\";\n+    ////// --------------------------- NBTConstants --------------------------- \\\\\\\\\\\\\n+\n+    public static final int MAX_DELIVERYMAN_STANDARD_PRIORITY = 10;\n+    public static final int MAX_DELIVERYMAN_AGING_PRIORITY    = 11;\n+    public static final int MAX_DELIVERYMAN_PLAYER_PRIORITY   = 12;\n+\n+    protected int priority = 0;\n+\n+    protected AbstractDeliverymanRequestable(final int priority)\n+    {\n+        this.priority = priority;\n+    }\n+\n+    @Override\n+    public int getPriority()\n+    {\n+        return priority;\n+    }\n+\n+    @Override\n+    public void incrementPriorityDueToAging()\n+    {\n+        // The priority set by by the aging mechanism can actually exceed the maximum priority that requesters can choose.\n+        // Worst case, the priority queue turns into a FIFO queue for really old requests, with new maximum-priority requests having to wait.\n+        priority = Math.min(MAX_DELIVERYMAN_AGING_PRIORITY, priority + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODM5ODU0", "url": "https://github.com/ldtteam/minecolonies/pull/5067#pullrequestreview-417839854", "createdAt": "2020-05-25T18:35:45Z", "commit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxODozNTo0NVrOGaHwgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxOTowNjoyM1rOGaILEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzI2NQ==", "bodyText": "missing javadoc", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430043265", "createdAt": "2020-05-25T18:35:45Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/PickupRequestResolver.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.ICitizenData;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.manager.IRequestManager;\n+import com.minecolonies.api.colony.requestsystem.request.IRequest;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.constant.TranslationConstants;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.Colony;\n+import com.minecolonies.coremod.colony.jobs.JobDeliveryman;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.core.AbstractRequestResolver;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.text.ITextComponent;\n+import net.minecraft.util.text.TranslationTextComponent;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+\n+public class PickupRequestResolver extends AbstractRequestResolver<Pickup>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MzgzMQ==", "bodyText": "How frequently is this called? might want to use a normal loop instead of streams", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430043831", "createdAt": "2020-05-25T18:38:23Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/PickupRequestResolver.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.ICitizenData;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.manager.IRequestManager;\n+import com.minecolonies.api.colony.requestsystem.request.IRequest;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.BlockPosUtil;\n+import com.minecolonies.api.util.Log;\n+import com.minecolonies.api.util.constant.TranslationConstants;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.Colony;\n+import com.minecolonies.coremod.colony.jobs.JobDeliveryman;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.core.AbstractRequestResolver;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.text.ITextComponent;\n+import net.minecraft.util.text.TranslationTextComponent;\n+import org.jetbrains.annotations.NotNull;\n+import org.jetbrains.annotations.Nullable;\n+\n+import java.util.Comparator;\n+import java.util.List;\n+\n+public class PickupRequestResolver extends AbstractRequestResolver<Pickup>\n+{\n+    public PickupRequestResolver(\n+      @NotNull final ILocation location,\n+      @NotNull final IToken<?> token)\n+    {\n+        super(location, token);\n+    }\n+\n+    @Override\n+    public TypeToken<? extends Pickup> getRequestType()\n+    {\n+        return TypeConstants.PICKUP;\n+    }\n+\n+    @Override\n+    public boolean canResolveRequest(@NotNull final IRequestManager manager, final IRequest<? extends Pickup> requestToCheck)\n+    {\n+        if (manager.getColony().getWorld().isRemote)\n+        {\n+            return false;\n+        }\n+\n+        final Colony colony = (Colony) manager.getColony();\n+        final ICitizenData freeDeliveryMan = colony.getCitizenManager().getCitizens()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NDgyMQ==", "bodyText": "missing javadoc in this class too", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430044821", "createdAt": "2020-05-25T18:42:57Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/colony/requestsystem/resolvers/factory/PickupRequestResolverFactory.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.minecolonies.coremod.colony.requestsystem.resolvers.factory;\n+\n+import com.google.common.reflect.TypeToken;\n+import com.minecolonies.api.colony.requestsystem.factory.IFactoryController;\n+import com.minecolonies.api.colony.requestsystem.location.ILocation;\n+import com.minecolonies.api.colony.requestsystem.resolver.IRequestResolverFactory;\n+import com.minecolonies.api.colony.requestsystem.token.IToken;\n+import com.minecolonies.api.util.constant.TypeConstants;\n+import com.minecolonies.coremod.colony.requestsystem.resolvers.PickupRequestResolver;\n+import net.minecraft.nbt.CompoundNBT;\n+import org.jetbrains.annotations.NotNull;\n+\n+public class PickupRequestResolverFactory implements IRequestResolverFactory<PickupRequestResolver>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0NzYwMA==", "bodyText": "outdated todo? its using ((IBuildingWorker) targetBuilding)::isItemStackInRequest", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430047600", "createdAt": "2020-05-25T18:54:51Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -521,70 +355,74 @@ else if (buildingToDeliver == null)\n             extracted = true;\n             final ItemStack insertionResultStack;\n \n-            if (iTileEntityColonyBuilding.getBuilding() instanceof AbstractBuildingWorker)\n+            // TODO: Please only push items into the target that were actually requested.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 507}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0ODc2Mg==", "bodyText": "think you want to use an ItemStackUtils comparing function for this since afaik requests are also nbt sensitive", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430048762", "createdAt": "2020-05-25T19:00:10Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -596,50 +434,33 @@ else if (buildingToDeliver instanceof TileEntityColonyBuilding)\n      */\n     private IAIState prepareDelivery()\n     {\n-        final IBuildingWorker ownBuilding = getOwnBuilding();\n-        if (ownBuilding instanceof BuildingDeliveryman)\n+        final IRequest<? extends IRequestable> currentTask = job.getCurrentTask();\n+        final IRequestable request = currentTask.getRequest();\n+        if (!(request instanceof Delivery))\n         {\n-            final IRequest<? extends Delivery> request = job.getCurrentTask();\n-            if (request != null)\n-            {\n-                if (job.isReturning())\n-                {\n-                    return DUMPING;\n-                }\n-                ((IBuildingDeliveryman) ownBuilding).setBuildingToDeliver(request.getRequest().getTarget());\n-                if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n-                  itemStack -> request.getRequest().getStack().isItemEqualIgnoreDurability(itemStack)))\n-                {\n-                    return DELIVERY;\n-                }\n+            // The current task has changed since the Decision-state.\n+            // Restart.\n+            return START_WORKING;\n+        }\n \n-                return gatherItems(request);\n-            }\n+        final Delivery delivery = (Delivery) request;\n+        if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n+          itemStack -> delivery.getStack().isItemEqualIgnoreDurability(itemStack)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 629}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1MDA2Ng==", "bodyText": "javadoc here too please :D", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r430050066", "createdAt": "2020-05-25T19:06:23Z", "author": {"login": "someaddons"}, "path": "src/main/java/com/minecolonies/coremod/network/messages/server/colony/building/ForcePickupMessage.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.minecolonies.coremod.network.messages.server.colony.building;\n+\n+import com.minecolonies.api.colony.IColony;\n+import com.minecolonies.api.colony.buildings.IBuilding;\n+import com.minecolonies.api.colony.buildings.views.IBuildingView;\n+import com.minecolonies.api.colony.requestsystem.requestable.deliveryman.Pickup;\n+import com.minecolonies.coremod.network.messages.server.AbstractBuildingServerMessage;\n+import net.minecraft.network.PacketBuffer;\n+import net.minecraftforge.fml.network.NetworkEvent;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.minecolonies.api.colony.requestsystem.requestable.deliveryman.AbstractDeliverymanRequestable.MAX_DELIVERYMAN_PLAYER_PRIORITY;\n+\n+public class ForcePickupMessage extends AbstractBuildingServerMessage<IBuilding>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d717897751eb0bb341b407f70c564a2da2bf6b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deccf790812e9606dee0df91d3dccf2effba469a", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/deccf790812e9606dee0df91d3dccf2effba469a", "committedDate": "2020-05-25T19:22:32Z", "message": "Fixed the stash, made it so that only one pickup request can be active per building, reduced pickup delay to 2 ticks (gathering larger buildings took too long)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2b9ff1f114a99ded4bef9716d967d5d29ca2d43", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/b2b9ff1f114a99ded4bef9716d967d5d29ca2d43", "committedDate": "2020-05-25T19:54:57Z", "message": "Added Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d821950bc74740f327fd6ff826234e4cbac44e2", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/2d821950bc74740f327fd6ff826234e4cbac44e2", "committedDate": "2020-05-25T20:11:21Z", "message": "Merge branch 'up/version/1.15' into feature/request-pickup\n\nConflicts:\n\tsrc/api/java/com/minecolonies/api/util/constant/TranslationConstants.java\n\tsrc/main/java/com/minecolonies/coremod/entity/ai/citizen/builder/EntityAIStructureBuilder.java\n\tsrc/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "844cd2eae24618e468941dc99511ebb1fcebc494", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/844cd2eae24618e468941dc99511ebb1fcebc494", "committedDate": "2020-05-25T20:24:43Z", "message": "Merge branch 'up/version/1.15' into feature/request-pickup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea2300ee1ebcee339fc8eccbfb63d8fff1f5ad6", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/2ea2300ee1ebcee339fc8eccbfb63d8fff1f5ad6", "committedDate": "2020-05-25T20:55:11Z", "message": "Merge branch 'up/version/1.15' into feature/request-pickup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd0e424a710039d30c24bfd11d5661641dcae34", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/4cd0e424a710039d30c24bfd11d5661641dcae34", "committedDate": "2020-05-25T22:07:16Z", "message": "Caught possible nullpointer exception."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51e3213491c7a0abc6f765647e87095be07cf004", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/51e3213491c7a0abc6f765647e87095be07cf004", "committedDate": "2020-05-26T18:22:49Z", "message": "Changed the dman's item comparator to be nbt-sensitive, since the RS will tell the dman *exactly* what to pick up."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aac342d565ef17f85ec20696949296eb6e01780c", "author": {"user": {"login": "JiaYow", "name": "JiaYow"}}, "url": "https://github.com/ldtteam/minecolonies/commit/aac342d565ef17f85ec20696949296eb6e01780c", "committedDate": "2020-05-27T18:28:15Z", "message": "Another attempt to get the item comparison during prepareDelivery() right, using ItemStackUtils this time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDk5ODAy", "url": "https://github.com/ldtteam/minecolonies/pull/5067#pullrequestreview-419499802", "createdAt": "2020-05-27T18:29:43Z", "commit": {"oid": "aac342d565ef17f85ec20696949296eb6e01780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoyOTo0NFrOGbX5Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoyOTo0NFrOGbX5Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1NjE2Nw==", "bodyText": "Looks fine, @OrionDevelopment let's merge this?", "url": "https://github.com/ldtteam/minecolonies/pull/5067#discussion_r431356167", "createdAt": "2020-05-27T18:29:44Z", "author": {"login": "Raycoms"}, "path": "src/main/java/com/minecolonies/coremod/entity/ai/citizen/deliveryman/EntityAIWorkDeliveryman.java", "diffHunk": "@@ -450,7 +450,7 @@ private IAIState prepareDelivery()\n \n         final Delivery delivery = (Delivery) currentTask.getRequest();\n         if (InventoryUtils.hasItemInItemHandler(worker.getInventoryCitizen(),\n-          itemStack -> delivery.getStack().isItemEqual(itemStack)))\n+          itemStack -> ItemStackUtils.compareItemStacksIgnoreStackSize(delivery.getStack(), itemStack)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aac342d565ef17f85ec20696949296eb6e01780c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d22886eda746e50131ec8a473ff393fa0ed2fb", "author": {"user": {"login": "Raycoms", "name": null}}, "url": "https://github.com/ldtteam/minecolonies/commit/99d22886eda746e50131ec8a473ff393fa0ed2fb", "committedDate": "2020-05-28T19:21:33Z", "message": "Merge branch 'version/1.15' into feature/request-pickup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2136, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}