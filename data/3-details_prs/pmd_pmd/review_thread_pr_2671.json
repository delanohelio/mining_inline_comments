{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3Mjk4MTgz", "number": 2671, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1NDoxN1rOET9udw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MDo1MFrOEan6ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzY5NzE5OnYy", "diffSide": "RIGHT", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1NDoxN1rOG5_YQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1NDoxN1rOG5_YQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MDQxNg==", "bodyText": "I would argue, we should not report this case: If we know, that the underlying stream is a ByteArrayInputStream, then we can ignore the case: ByteArrayInputStream (as well as ByteArrayOutputStream, StringReader/-Writer) - see the property ALLOWED_RESOURCE_TYPES.\nThe only problematic code here is, that close() is called (so the programmer had the intention to close the stream), but it is not done in a finally block.... and only bos is closed and not ois.\nBut as mentioned, since this is a ByteArrayInputStream/OutputStream, it is not problematic, but bad style...\nMaybe we should give that case a special message? -> \"bos is not closed within a finally block, thus might not be closed at all in case of exceptions\".\nNote: You can also assert the violation message, that is produced by the rule with\n        <expected-messages>\n            <message>Ensure that resources like this Connection object are closed after use</message>\n        </expected-messages>\n\nSee also https://pmd.github.io/latest/pmd_userdocs_extending_testing.html", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463460416", "createdAt": "2020-07-31T07:54:17Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+import java.io.*;\n+import java.util.function.Supplier;\n+public class Foo {\n+    public Supplier<Integer> bar() throws IOException {\n+        InputStream inputStream = new FileInputStream(\"/test.txt\");\n+        return () -> {\n+            try {\n+                return inputStream.read();\n+            } finally {\n+                inputStream.close();\n+            }\n+        };\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>wrapped ByteArrayInputStream false-negative test</description>\n+        <expected-problems>1</expected-problems>\n+        <expected-linenumbers>5</expected-linenumbers>\n+        <code><![CDATA[\n+import java.io.*;\n+public class Foo {\n+    public void bar() {\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream(new byte[10]);\n+        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bos.toByteArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzcwODE4OnYy", "diffSide": "RIGHT", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1Nzo1MFrOG5_eiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1Nzo1MFrOG5_eiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MjAyNA==", "bodyText": "What happens, if the input stream is used in the lamda, but not closed? Could you add another test case?\nimport java.io.*;\nimport java.util.function.Supplier;\npublic class Foo {\n    public Supplier<Integer> bar() {\n        InputStream inputStream = new FileInputStream(\"/test.txt\");\n        return () -> {\n            try {\n                return inputStream.read();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        };\n    }\n}\nHere we should report a violation.", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463462024", "createdAt": "2020-07-31T07:57:50Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzA2Mjg1OnYy", "diffSide": "RIGHT", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNToxMTozNlrOHEGQgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowNTo0NlrOHELW6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw==", "bodyText": "hm... doubling the violations here is weird. Do we report these cases twice?", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474058883", "createdAt": "2020-08-20T15:11:36Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -543,7 +543,7 @@ public class Bar {\n \n     <test-code>\n         <description>#1375 CloseResource not detected properly - ok</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTI5Mw==", "bodyText": "so, these are the messages:\nn/a:6:\tEnsure that resources like this ResultSet object are closed after use\nn/a:11:\t'rs' is not closed within a finally block, thus might not be closed at all in case of exceptions\nthey kind of mean the same thing: the resultset \"rs\" is maybe not closed after use...", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474135293", "createdAt": "2020-08-20T16:53:14Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -543,7 +543,7 @@ public class Bar {\n \n     <test-code>\n         <description>#1375 CloseResource not detected properly - ok</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw=="}, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MjQ0Mw==", "bodyText": "I'll add a check, so that we don't report violations twice for the same variable.", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474142443", "createdAt": "2020-08-20T17:05:46Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -543,7 +543,7 @@ public class Bar {\n \n     <test-code>\n         <description>#1375 CloseResource not detected properly - ok</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw=="}, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzUyMzYyOnYy", "diffSide": "RIGHT", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MDo1MFrOHEK1oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MDo1MFrOHEK1oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMzkyMA==", "bodyText": "Ok, we have the following reported problems:\nn/a:8:\tEnsure that resources like this Connection object are closed after use\nn/a:9:\tEnsure that resources like this Statement object are closed after use\nn/a:13:\t'rs' is not closed within a finally block, thus might not be closed at all in case of exceptions\nso that seems ok.", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474133920", "createdAt": "2020-08-20T16:50:50Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -377,7 +377,7 @@ public class Test {\n \n     <test-code>\n         <description>#947 CloseResource rule fails if field is marked with annotation</description>\n-        <expected-problems>2</expected-problems>\n+        <expected-problems>3</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 274, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}