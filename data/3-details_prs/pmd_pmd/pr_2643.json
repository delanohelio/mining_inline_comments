{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NDc2MDQ4", "number": 2643, "title": "[java] AvoidCallingFinalize detects some false positives (2578)", "bodyText": "Describe the PR\nI have modified the AvoidCallingFinalizeRule class to fix false positives when variables with name 'finalize' and finalize methods with args are detected as a problem. Also I've added 2 tests validating that the false positive bugs were fixed.\nRelated issues\n\n\nFixes #2578\n\nReady?\n\n\n Added unit tests for fixed bug/feature\n Passing all unit tests\n Complete build ./mvnw clean verify passes (checked automatically by travis)\n Added (in-code) documentation (if needed)", "createdAt": "2020-07-15T13:19:35Z", "url": "https://github.com/pmd/pmd/pull/2643", "merged": true, "mergeCommit": {"oid": "01e48c882bbebef713f204be6e16f72901e08b52"}, "closed": true, "closedAt": "2020-07-17T18:34:44Z", "author": {"login": "Drofff"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1KBoXAH2gAyNDQ5NDc2MDQ4OjVhNmUzZDYwOWU2ZjBlODc3MzZlZjMzOTYyN2E4MDMwNWQ4NDExOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc14FnQgFqTQ1MDg2NjM2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a6e3d609e6f0e87736ef339627a80305d841195", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/5a6e3d609e6f0e87736ef339627a80305d841195", "committedDate": "2020-07-15T12:44:54Z", "message": "[java]AvoidCallingFinalize detects some false positives (2578)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjE3MTk1", "url": "https://github.com/pmd/pmd/pull/2643#pullrequestreview-449217195", "createdAt": "2020-07-15T18:19:40Z", "commit": {"oid": "5a6e3d609e6f0e87736ef339627a80305d841195"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxOTo0MVrOGyKT8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoxOTo0MVrOGyKT8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1MDkzMQ==", "bodyText": "I'm unsure this is actually right\u2026 getArgumentCount returns -1 if the suffix is not actually a method call if I recall correctly\u2026 this would interpret it as an actual no-arg invocation\u2026", "url": "https://github.com/pmd/pmd/pull/2643#discussion_r455250931", "createdAt": "2020-07-15T18:19:41Z", "author": {"login": "jsotuyod"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/AvoidCallingFinalizeRule.java", "diffHunk": "@@ -4,68 +4,100 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import java.util.HashSet;\n+import static java.lang.Math.max;\n+\n import java.util.List;\n-import java.util.Set;\n+import java.util.regex.Pattern;\n \n-import net.sourceforge.pmd.lang.java.ast.ASTCompilationUnit;\n-import net.sourceforge.pmd.lang.java.ast.ASTName;\n+import net.sourceforge.pmd.lang.java.ast.ASTBlock;\n+import net.sourceforge.pmd.lang.java.ast.ASTMethodDeclaration;\n+import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n-import net.sourceforge.pmd.lang.java.symboltable.MethodScope;\n-import net.sourceforge.pmd.lang.symboltable.ScopedNode;\n \n public class AvoidCallingFinalizeRule extends AbstractJavaRule {\n \n-    private Set<MethodScope> checked = new HashSet<>();\n+    private static final Pattern FINALIZE_METHOD_PATTERN = Pattern.compile(\"^(.+\\\\.)?finalize$\");\n \n     @Override\n-    public Object visit(ASTCompilationUnit acu, Object ctx) {\n-        checked.clear();\n-        return super.visit(acu, ctx);\n+    public Object visit(ASTBlock block, Object data) {\n+        if (hasFinalizeMethodCallViolation(block)) {\n+            addViolation(data, block);\n+        }\n+        return super.visit(block, data);\n     }\n \n-    @Override\n-    public Object visit(ASTName name, Object ctx) {\n-        if (name.getImage() == null || !name.getImage().endsWith(\"finalize\")) {\n-            return ctx;\n+    private boolean hasFinalizeMethodCallViolation(ASTBlock block) {\n+        if (isFinalizeMethodBlock(block)) {\n+            return callsNotSuperFinalizeMethod(block);\n         }\n-        if (!checkForViolation(name)) {\n-            return ctx;\n-        }\n-        addViolation(ctx, name);\n-        return ctx;\n+        return callsFinalizeMethod(block);\n     }\n \n-    @Override\n-    public Object visit(ASTPrimaryPrefix pp, Object ctx) {\n-        List<ASTPrimarySuffix> primarySuffixes = pp.getParent().findChildrenOfType(ASTPrimarySuffix.class);\n-        ASTPrimarySuffix firstSuffix = null;\n-        if (!primarySuffixes.isEmpty()) {\n-            firstSuffix = primarySuffixes.get(0);\n-        }\n-        if (firstSuffix == null || firstSuffix.getImage() == null || !firstSuffix.getImage().endsWith(\"finalize\")) {\n-            return super.visit(pp, ctx);\n-        }\n-        if (!checkForViolation(pp)) {\n-            return super.visit(pp, ctx);\n+    private boolean isFinalizeMethodBlock(ASTBlock block) {\n+        ASTMethodDeclaration methodDeclaration = block.getFirstParentOfType(ASTMethodDeclaration.class);\n+        return methodDeclaration != null && isFinalizeMethodDeclaration(methodDeclaration);\n+    }\n+\n+    private boolean isFinalizeMethodDeclaration(ASTMethodDeclaration methodDeclaration) {\n+        return \"finalize\".equals(methodDeclaration.getName()) && methodDeclaration.getArity() == 0;\n+    }\n+\n+    private boolean callsNotSuperFinalizeMethod(ASTBlock block) {\n+        List<ASTPrimaryExpression> primaryExpressions = block.findDescendantsOfType(ASTPrimaryExpression.class);\n+        for (ASTPrimaryExpression primaryExpression : primaryExpressions) {\n+            if (isNotSuperFinalizeMethodCall(primaryExpression)) {\n+                return true;\n+            }\n         }\n-        addViolation(ctx, pp);\n-        return super.visit(pp, ctx);\n+        return false;\n     }\n \n-    private boolean checkForViolation(ScopedNode node) {\n-        MethodScope meth = node.getScope().getEnclosingScope(MethodScope.class);\n-        if (meth != null && \"finalize\".equals(meth.getName())) {\n-            return false;\n+    private boolean isNotSuperFinalizeMethodCall(ASTPrimaryExpression primaryExpression) {\n+        return isFinalizeMethodCall(primaryExpression) && isNotSuperMethodCall(primaryExpression);\n+    }\n+\n+    private boolean isNotSuperMethodCall(ASTPrimaryExpression primaryExpression) {\n+        ASTPrimaryPrefix primaryPrefix = primaryExpression.getFirstChildOfType(ASTPrimaryPrefix.class);\n+        return primaryPrefix == null || !primaryPrefix.usesSuperModifier();\n+    }\n+\n+    private boolean callsFinalizeMethod(ASTBlock block) {\n+        List<ASTPrimaryExpression> primaryExpressions = block.findDescendantsOfType(ASTPrimaryExpression.class);\n+        for (ASTPrimaryExpression primaryExpression : primaryExpressions) {\n+            if (isFinalizeMethodCall(primaryExpression)) {\n+                return true;\n+            }\n         }\n-        if (meth != null && checked.contains(meth)) {\n-            return false;\n+        return false;\n+    }\n+\n+    private boolean isFinalizeMethodCall(ASTPrimaryExpression primaryExpression) {\n+        return hasFinalizeName(primaryExpression) && getArgsCount(primaryExpression) == 0;\n+    }\n+\n+    private boolean hasFinalizeName(ASTPrimaryExpression primaryExpression) {\n+        List<JavaNode> expressionNodes = primaryExpression.findDescendantsOfType(JavaNode.class);\n+        for (JavaNode expressionNode : expressionNodes) {\n+            if (isFinalizeName(expressionNode.getImage())) {\n+                return true;\n+            }\n         }\n-        if (meth != null) {\n-            checked.add(meth);\n+        return false;\n+    }\n+\n+    private boolean isFinalizeName(String name) {\n+        return name != null && FINALIZE_METHOD_PATTERN.matcher(name).find();\n+    }\n+\n+    private int getArgsCount(ASTPrimaryExpression primaryExpression) {\n+        ASTPrimarySuffix primarySuffix = primaryExpression.getFirstChildOfType(ASTPrimarySuffix.class);\n+        if (primarySuffix != null) {\n+            int argsCount = primarySuffix.getArgumentCount();\n+            return max(argsCount, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a6e3d609e6f0e87736ef339627a80305d841195"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eedff056cf863f51685f676186f45a0558a73d1", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/2eedff056cf863f51685f676186f45a0558a73d1", "committedDate": "2020-07-16T08:55:09Z", "message": "AvoidCallingFinalize: addViolation, getArgsCount fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bbb6aab4d25d0c2abc3a7928856f6a330ab4785", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/9bbb6aab4d25d0c2abc3a7928856f6a330ab4785", "committedDate": "2020-07-16T16:21:22Z", "message": "AvoidCallingFinalize: constructor false negative fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDE3NTA2", "url": "https://github.com/pmd/pmd/pull/2643#pullrequestreview-450017506", "createdAt": "2020-07-16T16:29:49Z", "commit": {"oid": "9bbb6aab4d25d0c2abc3a7928856f6a330ab4785"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjoyOTo0OVrOGyy8oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjoyOTo0OVrOGyy8oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxNjcwNA==", "bodyText": "Please add here additional this:\n<expected-linenumbers>4</expected-linenumbers>\n\nThat way, we assert also, on which line we report the violation. Thanks!", "url": "https://github.com/pmd/pmd/pull/2643#discussion_r455916704", "createdAt": "2020-07-16T16:29:49Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/AvoidCallingFinalize.xml", "diffHunk": "@@ -88,6 +88,48 @@ public class InputFinalize {\n     {\n         super.finalize();\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>overloaded finalize is ok</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+public class Foo {\n+    public void foo() {\n+        finalize(\"hello\", \"world\");\n+    }\n+\n+    public void finalize(String ... args) {}\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>variable name false-positive test</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+public class Foo {\n+    private int finalize;\n+\n+    public void bar() {\n+        finalize++;\n+        return finalize;\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>super.finalize in constructor false-negative test</description>\n+        <expected-problems>1</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bbb6aab4d25d0c2abc3a7928856f6a330ab4785"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e48c882bbebef713f204be6e16f72901e08b52", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/01e48c882bbebef713f204be6e16f72901e08b52", "committedDate": "2020-07-17T08:05:55Z", "message": "AvoidCallingFinalize: expected lines added to test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODY2MzY4", "url": "https://github.com/pmd/pmd/pull/2643#pullrequestreview-450866368", "createdAt": "2020-07-17T18:18:26Z", "commit": {"oid": "01e48c882bbebef713f204be6e16f72901e08b52"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODoxODoyN1rOGzcxbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODoxODoyN1rOGzcxbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTk2NQ==", "bodyText": "To be fully correct, we need to call here either super or need to use the rule chain. A primary expression could define a anonymous class, which in turn could have primary expressions which call the finalize method....", "url": "https://github.com/pmd/pmd/pull/2643#discussion_r456601965", "createdAt": "2020-07-17T18:18:27Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/AvoidCallingFinalizeRule.java", "diffHunk": "@@ -4,68 +4,75 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import java.util.HashSet;\n import java.util.List;\n-import java.util.Set;\n+import java.util.regex.Pattern;\n \n-import net.sourceforge.pmd.lang.java.ast.ASTCompilationUnit;\n-import net.sourceforge.pmd.lang.java.ast.ASTName;\n+import net.sourceforge.pmd.lang.java.ast.ASTMethodDeclaration;\n+import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n-import net.sourceforge.pmd.lang.java.symboltable.MethodScope;\n-import net.sourceforge.pmd.lang.symboltable.ScopedNode;\n \n public class AvoidCallingFinalizeRule extends AbstractJavaRule {\n \n-    private Set<MethodScope> checked = new HashSet<>();\n+    private static final Pattern FINALIZE_METHOD_PATTERN = Pattern.compile(\"^(.+\\\\.)?finalize$\");\n \n     @Override\n-    public Object visit(ASTCompilationUnit acu, Object ctx) {\n-        checked.clear();\n-        return super.visit(acu, ctx);\n+    public Object visit(ASTPrimaryExpression primaryExpression, Object data) {\n+        if (isIncorrectFinalizeMethodCall(primaryExpression)) {\n+            addViolation(data, primaryExpression);\n+        }\n+        return data;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01e48c882bbebef713f204be6e16f72901e08b52"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4637, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}