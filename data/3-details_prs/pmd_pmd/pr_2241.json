{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NTI3MDE5", "number": 2241, "title": "[core] Simplify metrics framework", "bodyText": "Introduce a \"DataMap\" type, something to cache values on Node instances\n\nDeprecate getUserData/setUserData from Node. Using the DataMap is better, since any kinds of frameworks can cache their own data at they like. If you don't have the key, you can't even touch or even see the data, so nobody can mess with someone else's data.\n\n\nCache metrics on Nodes.\n\nThis means, we can drop all the stuff about MetricsFacade, MetricsMemoizer, MetricsComputer, QualifiedName, QualifiableNode etc.\nWe don't need to reset the static cache awkwardly\nWe can also stop constraining metrics framework to only a few kinds of nodes. One can define a metric for any node, without having to introduce awkward supertypes like MethodLikeNode\n\n\nAll the framework is condensed into MetricsUtil in pmd-core. Language-specific fa\u00e7ades are deprecated. The only thing, that cannot be made language independent, is ResultOption (in fact, just fetching operation nodes from a type node). This is not a big deal, as the aggregation logic can still be reused, on any Iterable of node.\n\nThis makes the metrics \"framework\" pretty trivial, and very easy to extend.\nI'd like this to be part of 6.21.0, since this avoids publishing LanguageMetricsProvider implementations.", "createdAt": "2020-01-19T11:58:17Z", "url": "https://github.com/pmd/pmd/pull/2241", "merged": true, "mergeCommit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "closed": true, "closedAt": "2020-02-16T11:20:50Z", "author": {"login": "oowekyala"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7059hAH2gAyMzY0NTI3MDE5Ojg0YjU5YzMzNTA1ODc2NmQ0MWIyYjJmNmNjMDVlMjY1MTI0Y2Y5N2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcE1iGwAFqTM1OTM5MTY3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84b59c335058766d41b2b2f6cc05e265124cf97f", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/84b59c335058766d41b2b2f6cc05e265124cf97f", "committedDate": "2020-01-19T09:54:50Z", "message": "Add DataMap on Node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2123ab3d5d7dcfc867ada3af119c3d3e9cb6183e", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/2123ab3d5d7dcfc867ada3af119c3d3e9cb6183e", "committedDate": "2020-01-19T11:35:55Z", "message": "Simplify metrics framework"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f282a3ad5c8da5fb37a1a9d9cecb3bd164b79980", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/f282a3ad5c8da5fb37a1a9d9cecb3bd164b79980", "committedDate": "2020-01-19T11:47:47Z", "message": "Move metric providers back into language handlers\n\nReverts part of #2231"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b707e6e9ffe3d86f60d0448aa7883548b1437566", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/b707e6e9ffe3d86f60d0448aa7883548b1437566", "committedDate": "2020-01-19T12:04:22Z", "message": "Fix caching\n\nNon supported nodes produce NaN which is\nconverted to zero when converting to int"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f87fc16ed3ec18ae4f31fb181258e95f134ceab9", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/f87fc16ed3ec18ae4f31fb181258e95f134ceab9", "committedDate": "2020-01-19T14:10:30Z", "message": "Fix tests\n\nThe tests were wrong, so this changeset\nactually fixes a bug in metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f576bc561a0b553f860494a1fabdcd7a8c2ee54c", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/f576bc561a0b553f860494a1fabdcd7a8c2ee54c", "committedDate": "2020-01-19T15:13:02Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055ae4abf0aa4d87437c58b692ddd06204556f59", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/055ae4abf0aa4d87437c58b692ddd06204556f59", "committedDate": "2020-01-19T23:57:45Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe0fe8bc7dd166f5ca894ea36642376aae83a10", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/8fe0fe8bc7dd166f5ca894ea36642376aae83a10", "committedDate": "2020-01-20T20:25:04Z", "message": "Update documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08544a7539624689f235042892ee7e17105deb1e", "author": {"user": {"login": "oowekyala", "name": "Cl\u00e9ment Fournier"}}, "url": "https://github.com/pmd/pmd/commit/08544a7539624689f235042892ee7e17105deb1e", "committedDate": "2020-01-20T20:54:53Z", "message": "Throw on metric not supported"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzkwNTIx", "url": "https://github.com/pmd/pmd/pull/2241#pullrequestreview-359390521", "createdAt": "2020-02-16T09:23:36Z", "commit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwOToyMzozNlrOFqSixQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwOToyMzozNlrOFqSixQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg4ODMyNQ==", "bodyText": "I think, POOL needs to be a concurrent map, otherwise there might be a chance, that we create two instances for the same... I'll change that before merging", "url": "https://github.com/pmd/pmd/pull/2241#discussion_r379888325", "createdAt": "2020-02-16T09:23:36Z", "author": {"login": "adangel"}, "path": "pmd-core/src/main/java/net/sourceforge/pmd/lang/metrics/ParameterizedMetricKey.java", "diffHunk": "@@ -65,6 +70,7 @@ public int hashCode() {\n      */\n     @SuppressWarnings(\"PMD.SingletonClassReturningNewInstance\")\n     public static <N extends Node> ParameterizedMetricKey<N> getInstance(MetricKey<N> key, MetricOptions options) {\n+        // sharing instances allows using DataMap, which uses reference identity", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzkxMzI4", "url": "https://github.com/pmd/pmd/pull/2241#pullrequestreview-359391328", "createdAt": "2020-02-16T09:38:14Z", "commit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwOTozODoxNVrOFqSmkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwOTozODoxNVrOFqSmkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg4OTI5Nw==", "bodyText": "I see, now the sum actually matches all the methods.... 36=6+4+0+4+4+18 - and the biggest contributor is the method with 18", "url": "https://github.com/pmd/pmd/pull/2241#discussion_r379889297", "createdAt": "2020-02-16T09:38:15Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/metrics/impl/xml/AtfdTest.xml", "diffHunk": "@@ -129,7 +129,7 @@ public class StatementAndBraceFinder extends JavaParserVisitorAdapter {\n         <description>Full example</description> <!-- TODO issues w/ that-->\n         <expected-problems>7</expected-problems>\n         <expected-messages>\n-            <message>'StatementAndBraceFinder' has value 10 highest 6.</message>\n+            <message>'StatementAndBraceFinder' has value 36 highest 18.</message>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzkxNjcx", "url": "https://github.com/pmd/pmd/pull/2241#pullrequestreview-359391671", "createdAt": "2020-02-16T09:44:00Z", "commit": {"oid": "08544a7539624689f235042892ee7e17105deb1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4860, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}