{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4ODA0Nzk4", "number": 2790, "title": "[java] CloseResource: Fix NPE in case of \"var\"", "bodyText": "Describe the PR\nFixes the NPE when trying to determine the type. The type might be null.\nRelated issues\n\nFixes #2755\n\nReady?\n\n\n Added unit tests for fixed bug/feature\n Passing all unit tests\n Complete build ./mvnw clean verify passes (checked automatically by travis)\n Added (in-code) documentation (if needed)", "createdAt": "2020-09-17T16:54:00Z", "url": "https://github.com/pmd/pmd/pull/2790", "merged": true, "mergeCommit": {"oid": "d3ca0319b31329aa7d7cfe24d54270a3cee08317"}, "closed": true, "closedAt": "2020-09-25T12:32:18Z", "author": {"login": "adangel"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJz4bmgH2gAyNDg4ODA0Nzk4OjgxYTcyY2I0M2VmNzdmOTIwNzMyYTRkYjgwYTc4ODVlMTI5ZTZhNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLHHSjAH2gAyNDg4ODA0Nzk4OmYwNDYyNjgwNThlMDRmMTIxZDEyN2I3ZmE4MDJjYmE3ZjAwOTY1MWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/81a72cb43ef77f920732a4db80a7885e129e6a67", "committedDate": "2020-09-17T16:49:21Z", "message": "[java] CloseResource: Fix NPE in case of \"var\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMDAxOTQy", "url": "https://github.com/pmd/pmd/pull/2790#pullrequestreview-492001942", "createdAt": "2020-09-19T14:24:12Z", "commit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQxNDoyNDoxM1rOHUr7LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQxNDoyODo0MFrOHUsCyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ1MzIyOA==", "bodyText": "So we don't get a NPE anymore, but we also don't consider the var as a violation? I wonder, for example, what is the behavior of the rule if you write\nimport java.io.*;\npublic class Foo {\n    public int bar() throws IOException {\n        var inputStream = getInputStreamFromSomewhere();\n        char c = reader.read();\n        return c;\n    }\n\n    InputStream getInputStreamFromSomewhere() { return null; }\n}\nNormally, it should be exactly the same behavior as if var was explicitly written, right? In that case, I'm not sure the rule accounts for that, given we test the ASTType node, not VariableDeclaratorId::getType (which is the type of the var). (Note: since we do that, we are probably failing if the var is declared like InputStream streamArray[])\nI think it would make more sense to test VariableDeclaratorId::getType, though I don't know how that interacts with existing tests", "url": "https://github.com/pmd/pmd/pull/2790#discussion_r491453228", "createdAt": "2020-09-19T14:24:13Z", "author": {"login": "oowekyala"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/CloseResourceRule.java", "diffHunk": "@@ -175,7 +175,7 @@ private void checkForResources(ASTMethodOrConstructorDeclaration methodOrConstru\n         Map<ASTVariableDeclarator, TypeNode> resVars = new HashMap<>();\n         for (ASTVariableDeclarator var : vars) {\n             TypeNode varType = getTypeOfVariable(var);\n-            if (isResourceTypeOrSubtype(varType)) {\n+            if (varType != null && isResourceTypeOrSubtype(varType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ1NTE3OQ==", "bodyText": "I don't really like that this method is undefined. In PMD 7 we have good type resolution, but this method call, and the variable, would have type TypeSystem.UNKNOWN. If we want to use type resolution in this rule later to improve its precision/generality, we have to use \"compilable\" code in tests.\nYou can just define the method in the file, so that typeres can see the signature:\nInputStream getInputStreamFromSomewhere() { return null; }\n\nNote that this is not specific to this PR, but really is a common problem in our tests, because often we just copy-paste the test case provided in the issue, where many types are unresolved.", "url": "https://github.com/pmd/pmd/pull/2790#discussion_r491455179", "createdAt": "2020-09-19T14:28:40Z", "author": {"login": "oowekyala"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1385,6 +1385,27 @@ public class Foo {\n         }\n         Closeables.close(stream, false);\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>[java] [6.27.0] Exception applying rule CloseResource on file ... java.lang.NullPointerException #2755</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+import java.io.*;\n+\n+public class Foo {\n+    public int bar() {\n+        var inputStream = getInputStreamFromSomewhere();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjI4OTM5", "url": "https://github.com/pmd/pmd/pull/2790#pullrequestreview-492228939", "createdAt": "2020-09-20T22:39:38Z", "commit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQyMjozOTozOFrOHU9nug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQyMjozOTozOFrOHU9nug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc0MzE2Mg==", "bodyText": "This is a random place to ask: is it a good idea to use var as a variable name?", "url": "https://github.com/pmd/pmd/pull/2790#discussion_r491743162", "createdAt": "2020-09-20T22:39:38Z", "author": {"login": "KroArtem"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/CloseResourceRule.java", "diffHunk": "@@ -189,7 +189,7 @@ private TypeNode getTypeOfVariable(ASTVariableDeclarator var) {\n \n     private TypeNode getDeclaredTypeOfVariable(ASTVariableDeclarator var) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81a72cb43ef77f920732a4db80a7885e129e6a67"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87890b852a88f9b9762c514682de6aafa211c04d", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/87890b852a88f9b9762c514682de6aafa211c04d", "committedDate": "2020-09-21T17:39:24Z", "message": "[java] CloseResource: Fix test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f046268058e04f121d127b7fa802cba7f009651c", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/f046268058e04f121d127b7fa802cba7f009651c", "committedDate": "2020-09-21T17:47:42Z", "message": "[java] CloseResource: add simple test case for var"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4726, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}