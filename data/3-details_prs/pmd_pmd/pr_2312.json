{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NzI5MTE4", "number": 2312, "title": "[apex] Update ApexCRUDViolation Rule", "bodyText": "PR Description:\nUpdating This rule to support the new feature 'WITH SECURITY_ENFORCED'.  To learn more about this feature go to (https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_classes_with_security_enforced.htm).\nThis fixes #2210.", "createdAt": "2020-02-25T18:19:50Z", "url": "https://github.com/pmd/pmd/pull/2312", "merged": true, "mergeCommit": {"oid": "be72ec153daa2b8c2e4c3184406812c20ecbaed2"}, "closed": true, "closedAt": "2020-03-14T17:36:25Z", "author": {"login": "jarquile"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGQyRQgH2gAyMzc5NzI5MTE4OmRmMTYwOTM1NjI2MTEzOGYwZjg2NTMwNTZlMGNjZGU1MGNkNTk0YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNNIKpgFqTM3NDE2NDYwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df1609356261138f0f8653056e0ccde50cd594b2", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/df1609356261138f0f8653056e0ccde50cd594b2", "committedDate": "2020-02-20T20:03:01Z", "message": "Modify CURD rule to support SECURITY_ENFORCE clause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b944630743494d8a8e956350e3c70ea6884173d", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/8b944630743494d8a8e956350e3c70ea6884173d", "committedDate": "2020-02-20T23:31:19Z", "message": "Modify CURD rule to support regex for SECURITY_ENFORCE clause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54c9887a947f26b04a26c7bd5bfc0e3880d418f", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/c54c9887a947f26b04a26c7bd5bfc0e3880d418f", "committedDate": "2020-02-20T23:57:46Z", "message": "Updated the regex to support case insensitivity in apex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2aba08c9a06d2612ba72856b99aef9c2b87f2b5", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/a2aba08c9a06d2612ba72856b99aef9c2b87f2b5", "committedDate": "2020-02-25T00:27:12Z", "message": "Updated regex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bbb65720ac1fb0120df8759268bda45e6b7ad05", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/7bbb65720ac1fb0120df8759268bda45e6b7ad05", "committedDate": "2020-02-25T18:10:33Z", "message": "Removed 'Accepts Clause WITH SECURITY_ENFORCED Failed' Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/6efc10eb4cb4e05d4904fe39817ba261f8713e7b", "committedDate": "2020-02-26T00:08:18Z", "message": "Fixed syntax error with  'Accepts Clause WITH SECURITY_ENFORCED in a list' Test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzQ2OTIy", "url": "https://github.com/pmd/pmd/pull/2312#pullrequestreview-365746922", "createdAt": "2020-02-27T15:15:48Z", "commit": {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToxNTo0OVrOFvVWLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToxNTo0OVrOFvVWLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA==", "bodyText": "Would node.getNode().getQuery().endsWith(\"WITH SECURITY_ENFORCED\"); produce the same result?", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r385177134", "createdAt": "2020-02-27T15:15:49Z", "author": {"login": "J-Spillane"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +337,15 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node){\n+        if(node instanceof ASTSoqlExpression){\n+            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+            String query = ((ASTSoqlExpression) node).getQuery();\n+            return query.matches(pattern);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34", "committedDate": "2020-02-28T22:21:41Z", "message": "Fixed styling errors during build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Nzg5NTUx", "url": "https://github.com/pmd/pmd/pull/2312#pullrequestreview-366789551", "createdAt": "2020-02-29T10:03:20Z", "commit": {"oid": "57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMDowMzoyMFrOFwInvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxMDoyMTozMlrOFwIrjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNzIxNQ==", "bodyText": "I guess, we could also write query.toUpperCase(Locale.ROOT).contains(\"WITH SECURITY_ENFORCED\").\nBtw. - are multiple spaces between \"WITH\" and \"SECURITY_ENFORCED\" allowed? If yes, then we probably need to use a regex. In that case, we should create a precompiled pattern constant.", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r386017215", "createdAt": "2020-02-29T10:03:20Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +337,15 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node){\n+        if(node instanceof ASTSoqlExpression){\n+            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+            String query = ((ASTSoqlExpression) node).getQuery();\n+            return query.matches(pattern);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA=="}, "originalCommit": {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODExNw==", "bodyText": "I see, we need to make sure, this text is not used inside a quoted string... So we'll need a regex.\nPlease create a private final static field:\nprivate static final Pattern WITH_SECURITY_ENFORCED = Pattern.compile(\"(?i).*[^']\\\\s*WITH\\\\s+SECURITY_ENFORCED\\\\s*[^']*\");\nAnd use it here then like this:\nreturn WITH_SECURITY_ENFORCED.matcher(soqlExpression.getQuery()).matches();", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r386018117", "createdAt": "2020-02-29T10:20:34Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +337,15 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node){\n+        if(node instanceof ASTSoqlExpression){\n+            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+            String query = ((ASTSoqlExpression) node).getQuery();\n+            return query.matches(pattern);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzEzNA=="}, "originalCommit": {"oid": "6efc10eb4cb4e05d4904fe39817ba261f8713e7b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODE4OA==", "bodyText": "We should not need this dependency.... please remove it again.", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r386018188", "createdAt": "2020-02-29T10:21:32Z", "author": {"login": "adangel"}, "path": "pom.xml", "diffHunk": "@@ -1015,4 +1015,10 @@\n         <module>pmd-doc</module>\n         <module>pmd-lang-test</module>\n     </modules>\n+    <dependencies>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57279e11dbc6a2e4b68e138bbe6dfc2fda95ba34"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/7b34f04be18969a54687b9c02ca209c65b6d0ebb", "committedDate": "2020-03-09T22:55:48Z", "message": "create a local pattern for the class and update isSecurityEnforced"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDQ1MzYx", "url": "https://github.com/pmd/pmd/pull/2312#pullrequestreview-373445361", "createdAt": "2020-03-12T10:41:55Z", "commit": {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo0MTo1NVrOF1ZXrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo0NjoyNlrOF1Zh7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDUwOQ==", "bodyText": "Please remove this commented code - this is failing the build:\n[INFO] --- maven-checkstyle-plugin:3.1.1:check (checkstyle-check) @ pmd-apex ---\n[INFO] There are 4 errors reported by Checkstyle 8.30 with /net/sourceforge/pmd/pmd-checkstyle-config.xml ruleset.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[348] (indentation) CommentsIndentation: Comment has incorrect indentation level 0, expected is 10, indentation should be the same level as line 349.", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391534509", "createdAt": "2020-03-12T10:41:55Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +339,19 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n+//        if (node instanceof ASTSoqlExpression) {\n+//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+//            String query = ((ASTSoqlExpression) node).getQuery();\n+//            return query.matches(pattern);\n+//        }\n+//        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNTg2Mg==", "bodyText": "There seems to be some indentation problem which is failing the build. It seems, these lines are indented with two spaces too much...\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[349] (indentation) Indentation: 'if' has incorrect indentation level 10, expected level should be 8.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[351] (indentation) Indentation: 'if rcurly' has incorrect indentation level 10, expected level should be 8.\n[ERROR] src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java:[352] (indentation) Indentation: 'method def' child has incorrect indentation level 10, expected level should be 8.", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391535862", "createdAt": "2020-03-12T10:44:16Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -337,6 +339,19 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n         return false;\n     }\n \n+    private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n+//        if (node instanceof ASTSoqlExpression) {\n+//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n+//            String query = ((ASTSoqlExpression) node).getQuery();\n+//            return query.matches(pattern);\n+//        }\n+//        return false;\n+          if (node instanceof ASTSoqlExpression) {\n+            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+          }\n+          return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNzEzNQ==", "bodyText": "Please combine the 3 if statements to avoid nesting:\nif (!typeToDMLOperationMapping.containsKey(typeCheck)\n    && !isProperESAPICheckForDML(typeCheck, crudMethod)\n    && !isWithSecurityEnforced(node)) {\n...", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r391537135", "createdAt": "2020-03-12T10:46:26Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -506,7 +521,9 @@ private void validateCRUDCheckPresent(final AbstractApexNode<?> node, final Obje\n             final String typeCheck) {\n         if (!typeToDMLOperationMapping.containsKey(typeCheck)) {\n             if (!isProperESAPICheckForDML(typeCheck, crudMethod)) {\n-                addViolation(data, node);\n+                if (!isWithSecurityEnforced(node)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b34f04be18969a54687b9c02ca209c65b6d0ebb"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be72ec153daa2b8c2e4c3184406812c20ecbaed2", "author": {"user": null}, "url": "https://github.com/pmd/pmd/commit/be72ec153daa2b8c2e4c3184406812c20ecbaed2", "committedDate": "2020-03-12T21:06:13Z", "message": "Fixed more style changes and improved logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTY0NjAz", "url": "https://github.com/pmd/pmd/pull/2312#pullrequestreview-374164603", "createdAt": "2020-03-13T09:44:47Z", "commit": {"oid": "be72ec153daa2b8c2e4c3184406812c20ecbaed2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo0NDo0N1rOF19T7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo0NDo0N1rOF19T7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMzM3Mg==", "bodyText": "@jarquile\nThe build is still failing (see https://travis-ci.org/github/pmd/pmd/builds/661704547?utm_source=github_status&utm_medium=notification):\n[INFO] --- maven-pmd-plugin:3.13.0:check (default) @ pmd-apex ---\n\n[INFO] PMD version: 6.22.0\n\n[INFO] PMD Failure: net.sourceforge.pmd.lang.apex.rule.security.ApexCRUDViolationRule:345 Rule:UnnecessaryLocalBeforeReturn Priority:1 Consider simply returning the value vs storing it in local variable 'temp'.\n\nJust write return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\nAnd remove the comment.", "url": "https://github.com/pmd/pmd/pull/2312#discussion_r392123372", "createdAt": "2020-03-13T09:44:47Z", "author": {"login": "adangel"}, "path": "pmd-apex/src/main/java/net/sourceforge/pmd/lang/apex/rule/security/ApexCRUDViolationRule.java", "diffHunk": "@@ -340,16 +340,11 @@ private boolean isLastMethodName(final ASTMethodCallExpression methodNode, final\n     }\n \n     private boolean isWithSecurityEnforced(final AbstractApexNode<?> node) {\n-//        if (node instanceof ASTSoqlExpression) {\n-//            String pattern = \"(?i).*[^']\\\\s*WITH SECURITY_ENFORCED\\\\s*[^']*\";\n-//            String query = ((ASTSoqlExpression) node).getQuery();\n-//            return query.matches(pattern);\n-//        }\n-//        return false;\n-          if (node instanceof ASTSoqlExpression) {\n-            return WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n-          }\n-          return false;\n+        if (node instanceof ASTSoqlExpression) {\n+            boolean temp = WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();\n+            return temp;//WITH_SECURITY_ENFORCED.matcher(((ASTSoqlExpression) node).getQuery()).matches();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be72ec153daa2b8c2e4c3184406812c20ecbaed2"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4904, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}