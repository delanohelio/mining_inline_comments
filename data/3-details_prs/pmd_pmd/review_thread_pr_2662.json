{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTU2Mzc0", "number": 2662, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo0NzoyMVrOETlp5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToyMToxNlrOET_YLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTc1MzMzOnYy", "diffSide": "RIGHT", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo0NzoyMVrOG5Z6QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo0NzoyMVrOG5Z6QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0NjUyOA==", "bodyText": "We seem to visit only one type in this rule, so you can make use of the rulechain: https://pmd.github.io/latest/pmd_userdocs_extending_writing_java_rules.html#economic-traversal-the-rulechain", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462846528", "createdAt": "2020-07-30T08:47:21Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTc2NTc2OnYy", "diffSide": "RIGHT", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1MDozN1rOG5aB8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1MDozN1rOG5aB8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0ODQ5OQ==", "bodyText": "Just use sth. like this:\nfor (int callArgsIndex = 1; callArgsIndex < expr.getNumChildren(); callArgsIndex++) {\n    int callIndex = callArgsIndex - 1;\n    JavaNode node = expr.getChild(callIndex);\n...\nThere is no need to search for children by type if you don't look for a specific type....\n}", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462848499", "createdAt": "2020-07-30T08:50:37Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);\n+    }\n \n-        int first = getBadPrefixOrNull(exp, n);\n-        if (first == -1) {\n-            return data;\n+    private int getCaseChangingMethodCallIndex(ASTPrimaryExpression expr) {\n+        List<JavaNode> exprNodes = expr.findChildrenOfType(JavaNode.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTc3MTEyOnYy", "diffSide": "RIGHT", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1MjoxMFrOG5aFbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1MjoxMFrOG5aFbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0OTM5MQ==", "bodyText": "I think, it would make sense to integrate the null check into the method isNameOfCaseChangingMethod, wdyt?", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462849391", "createdAt": "2020-07-30T08:52:10Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);\n+    }\n \n-        int first = getBadPrefixOrNull(exp, n);\n-        if (first == -1) {\n-            return data;\n+    private int getCaseChangingMethodCallIndex(ASTPrimaryExpression expr) {\n+        List<JavaNode> exprNodes = expr.findChildrenOfType(JavaNode.class);\n+        for (int callArgsIndex = 1; callArgsIndex < exprNodes.size(); callArgsIndex++) {\n+            int callIndex = callArgsIndex - 1;\n+            if (isCaseChangingMethodCall(exprNodes.get(callIndex), exprNodes.get(callArgsIndex))) {\n+                return callIndex;\n+            }\n         }\n+        return -1;\n+    }\n \n-        String second = getBadSuffixOrNull(exp, first + 2);\n-        if (second == null) {\n-            return data;\n-        }\n+    private boolean isCaseChangingMethodCall(JavaNode methodCall, JavaNode methodCallArgs) {\n+        String methodName = getCalledMethodName(methodCall);\n+        int methodArgsCount = getCalledMethodArgsCount(methodCallArgs);\n+        return methodName != null\n+                && isNameOfCaseChangingMethod(methodName) && methodArgsCount == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTc4NTA1OnYy", "diffSide": "RIGHT", "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/UnnecessaryCaseChange.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1NTozM1rOG5aN1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1NTozM1rOG5aN1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1MTU0MQ==", "bodyText": "I don't think, we should report here two violations, we have only one call to equals...", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462851541", "createdAt": "2020-07-30T08:55:33Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/UnnecessaryCaseChange.xml", "diffHunk": "@@ -54,7 +54,7 @@ public class Foo {\n \n     <test-code>\n         <description>failure case with toLowerCase().equals()</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5Mzk2NzgwOnYy", "diffSide": "RIGHT", "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToyMToxN1rOG6B7jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToyNzo0NFrOG6CHQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMjIyMQ==", "bodyText": "Since we don't use rule chain, you need to return super.visit(expr, data) here.... just returning data would skip nested classes etc.", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r463502221", "createdAt": "2020-07-31T09:21:17Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -30,16 +30,18 @@ public Object visit(ASTPrimaryExpression expr, Object data) {\n             if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n                     || isArgumentOfEqualsMethodCall(expr)) {\n                 addViolation(data, expr);\n+                return data;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b205806124e668607fa7e9fe9db2bf901604def9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNTIxOA==", "bodyText": "Ohh, sorry. I thought it would be okay to skip processing nested expressions in case we have already reported a problem here. I'll fix that", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r463505218", "createdAt": "2020-07-31T09:27:44Z", "author": {"login": "Drofff"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -30,16 +30,18 @@ public Object visit(ASTPrimaryExpression expr, Object data) {\n             if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n                     || isArgumentOfEqualsMethodCall(expr)) {\n                 addViolation(data, expr);\n+                return data;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMjIyMQ=="}, "originalCommit": {"oid": "b205806124e668607fa7e9fe9db2bf901604def9"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 266, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}