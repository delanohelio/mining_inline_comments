{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NjEyNjk0", "number": 2968, "title": "[java] NPE in UseCollectionIsEmptyRule with enums", "bodyText": "Describe the PR\nThe UseCollectionIsEmptyRule requires finding the first parent of the class ASTClassOrInterfaceBody when searching for the type of a variable by name. In the case of an enum, the call to fetch the parent returns null, resulting in a NPE. This was fixed by checking for null and finding a parent of type ASTEnumBody instead.\nI also refactored, cleared-up, and formatted a few test cases.\nRelated issues\n\nFixes #2833\n\nReady?\n\n Added unit tests for fixed bug/feature\n Passing all unit tests\n Complete build ./mvnw clean verify passes (checked automatically by travis)\n Added (in-code) documentation (if needed)", "createdAt": "2020-12-12T01:00:35Z", "url": "https://github.com/pmd/pmd/pull/2968", "merged": true, "mergeCommit": {"oid": "175d535e9fe73de8afd40445650dc979a3209b07"}, "closed": true, "closedAt": "2021-01-21T10:50:39Z", "author": {"login": "foxmason"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlRmpfAH2gAyNTM3NjEyNjk0OmNjZTBhMzVjYjEzMmFjM2FiMzA1MGNhZWZmOGE5NGUzODVmYjgxZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdyRmd1gH2gAyNTM3NjEyNjk0OjRiZTI1NjJmMDFmOTBlY2U2YTRkZGFkNjljMTY1YjEwOGIyOWIyYjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8", "author": {"user": {"login": "foxmason", "name": null}}, "url": "https://github.com/pmd/pmd/commit/cce0a35cb132ac3ab3050caeff8a94e385fb81e8", "committedDate": "2020-12-12T00:43:02Z", "message": "[java] NPE in UseCollectionIsEmptyRule with enums #2833"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0OTAwNTYz", "url": "https://github.com/pmd/pmd/pull/2968#pullrequestreview-564900563", "createdAt": "2021-01-10T21:05:47Z", "commit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQyMTowNTo0OFrOIQ7fIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQyMToxMDozNVrOIQ7hQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYyMjc1Mg==", "bodyText": "Is it the only case when classOrEnumBody can be null? Unfortunately I don't know.", "url": "https://github.com/pmd/pmd/pull/2968#discussion_r554622752", "createdAt": "2021-01-10T21:05:48Z", "author": {"login": "KroArtem"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/bestpractices/UseCollectionIsEmptyRule.java", "diffHunk": "@@ -112,11 +113,14 @@ private String getVariableNameBySuffix(ASTPrimaryExpression primaryExpression) {\n     }\n \n     private ASTClassOrInterfaceType getTypeOfVariableByName(String varName, ASTPrimaryExpression expr) {\n-        ASTClassOrInterfaceBody classBody = expr.getFirstParentOfType(ASTClassOrInterfaceBody.class);\n-        List<ASTVariableDeclarator> varDeclarators = classBody.findDescendantsOfType(ASTVariableDeclarator.class);\n+        Node classOrEnumBody = expr.getFirstParentOfType(ASTClassOrInterfaceBody.class);\n+        if (classOrEnumBody == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYyMjg5OQ==", "bodyText": "What's the reason to go one level up in the hierarchy?", "url": "https://github.com/pmd/pmd/pull/2968#discussion_r554622899", "createdAt": "2021-01-10T21:06:43Z", "author": {"login": "KroArtem"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/bestpractices/UseCollectionIsEmptyRule.java", "diffHunk": "@@ -112,11 +113,14 @@ private String getVariableNameBySuffix(ASTPrimaryExpression primaryExpression) {\n     }\n \n     private ASTClassOrInterfaceType getTypeOfVariableByName(String varName, ASTPrimaryExpression expr) {\n-        ASTClassOrInterfaceBody classBody = expr.getFirstParentOfType(ASTClassOrInterfaceBody.class);\n-        List<ASTVariableDeclarator> varDeclarators = classBody.findDescendantsOfType(ASTVariableDeclarator.class);\n+        Node classOrEnumBody = expr.getFirstParentOfType(ASTClassOrInterfaceBody.class);\n+        if (classOrEnumBody == null) {\n+            classOrEnumBody = expr.getFirstParentOfType(ASTEnumBody.class);\n+        }                 \n+        List<ASTVariableDeclarator> varDeclarators = classOrEnumBody.findDescendantsOfType(ASTVariableDeclarator.class);\n         for (ASTVariableDeclarator varDeclarator : varDeclarators) {\n             if (varDeclarator.getName().equals(varName)) {\n-                return varDeclarator.getFirstDescendantOfType(ASTClassOrInterfaceType.class);\n+                return varDeclarator.getParent().getFirstDescendantOfType(ASTClassOrInterfaceType.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYyMzI1Ng==", "bodyText": "Only one field is enough, IMO. Less code in xml is better :)", "url": "https://github.com/pmd/pmd/pull/2968#discussion_r554623256", "createdAt": "2021-01-10T21:10:09Z", "author": {"login": "KroArtem"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/bestpractices/xml/UseCollectionIsEmpty.xml", "diffHunk": "@@ -348,4 +346,63 @@ public class Foo {\n }\n         ]]></code>\n     </test-code>\n+\n+    \n+\t<test-code>\n+        <description>#2833 NPE in UseCollectionIsEmptyRule with enums</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+public enum ComponentSize {\n+\n+    S(\"s\"),\n+    M(\"m\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYyMzI5OQ==", "bodyText": "I suggest removing several fields here too.", "url": "https://github.com/pmd/pmd/pull/2968#discussion_r554623299", "createdAt": "2021-01-10T21:10:35Z", "author": {"login": "KroArtem"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/bestpractices/xml/UseCollectionIsEmpty.xml", "diffHunk": "@@ -348,4 +346,63 @@ public class Foo {\n }\n         ]]></code>\n     </test-code>\n+\n+    \n+\t<test-code>\n+        <description>#2833 NPE in UseCollectionIsEmptyRule with enums</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+public enum ComponentSize {\n+\n+    S(\"s\"),\n+    M(\"m\"),\n+    L(\"l\"),\n+    XL(\"xl\");\n+\n+\n+    private String size;\n+\n+    ComponentSize(String size) {\n+        this.size = size;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return size;\n+    }\n+\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>##2833 NPE in UseCollectionIsEmptyRule with enums (sanity check)</description>\n+        <expected-problems>1</expected-problems>\n+        <expected-linenumbers>12</expected-linenumbers>\n+        <code><![CDATA[\n+public enum ComponentSize {\n+\n+    S(\"s\"),\n+    M(\"m\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cce0a35cb132ac3ab3050caeff8a94e385fb81e8"}, "originalPosition": 129}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4be2562f01f90ece6a4ddad69c165b108b29b2b5", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/4be2562f01f90ece6a4ddad69c165b108b29b2b5", "committedDate": "2021-01-21T10:03:51Z", "message": "Fixups for #2968\n\n- Use better typeres\n- Add test cases for records and local var"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4610, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}