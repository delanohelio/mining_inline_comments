{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTU2Mzc0", "number": 2662, "title": "[java] UnnecessaryCaseChange can not detect the case like: foo.equals(bar.toLowerCase())", "bodyText": "Describe the PR\nA check whether toLowerCase() or toUpperCase() method is called in arguments of an equals method has been added.\nAlso I've refactored some other methods of the class.\n\nRelated issues\n\n\nFixes #2531\n\nReady?\n\n\n Added unit tests for fixed bug/feature\n Passing all unit tests\n Complete build ./mvnw clean verify passes (checked automatically by travis)\n Added (in-code) documentation (if needed)", "createdAt": "2020-07-24T08:39:37Z", "url": "https://github.com/pmd/pmd/pull/2662", "merged": true, "mergeCommit": {"oid": "eca547b5054814933f87f0718e0432bc2e27e5da"}, "closed": true, "closedAt": "2020-08-16T10:02:33Z", "author": {"login": "Drofff"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3_tIhAH2gAyNDU2MTU2Mzc0OmI4ZDg3OGI0MDEyZGUyMjExYzI1M2FmMTg1Mjg0YmEzYWU3OTQzYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_anGYgFqTQ2ODA0OTQ0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8d878b4012de2211c253af185284ba3ae7943a2", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/b8d878b4012de2211c253af185284ba3ae7943a2", "committedDate": "2020-07-24T08:25:14Z", "message": "[java] UnnecessaryCaseChange can not detect the case like: foo.equals(bar.toLowerCase())"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/d69520f68fc68e40dc541604aa301246c8612ca7", "committedDate": "2020-07-24T09:46:56Z", "message": "UnnecessaryCaseChangeRule: NullPointerException in constructor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjA1NzM1", "url": "https://github.com/pmd/pmd/pull/2662#pullrequestreview-458205735", "createdAt": "2020-07-30T08:47:21Z", "commit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo0NzoyMVrOG5Z6QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1NTozM1rOG5aN1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0NjUyOA==", "bodyText": "We seem to visit only one type in this rule, so you can make use of the rulechain: https://pmd.github.io/latest/pmd_userdocs_extending_writing_java_rules.html#economic-traversal-the-rulechain", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462846528", "createdAt": "2020-07-30T08:47:21Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0ODQ5OQ==", "bodyText": "Just use sth. like this:\nfor (int callArgsIndex = 1; callArgsIndex < expr.getNumChildren(); callArgsIndex++) {\n    int callIndex = callArgsIndex - 1;\n    JavaNode node = expr.getChild(callIndex);\n...\nThere is no need to search for children by type if you don't look for a specific type....\n}", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462848499", "createdAt": "2020-07-30T08:50:37Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);\n+    }\n \n-        int first = getBadPrefixOrNull(exp, n);\n-        if (first == -1) {\n-            return data;\n+    private int getCaseChangingMethodCallIndex(ASTPrimaryExpression expr) {\n+        List<JavaNode> exprNodes = expr.findChildrenOfType(JavaNode.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg0OTM5MQ==", "bodyText": "I think, it would make sense to integrate the null check into the method isNameOfCaseChangingMethod, wdyt?", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462849391", "createdAt": "2020-07-30T08:52:10Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -4,83 +4,111 @@\n \n package net.sourceforge.pmd.lang.java.rule.errorprone;\n \n-import net.sourceforge.pmd.lang.ast.Node;\n+import static java.util.Arrays.asList;\n+\n+import java.util.List;\n+\n+import net.sourceforge.pmd.lang.java.ast.ASTArgumentList;\n+import net.sourceforge.pmd.lang.java.ast.ASTArguments;\n import net.sourceforge.pmd.lang.java.ast.ASTName;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryExpression;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimaryPrefix;\n import net.sourceforge.pmd.lang.java.ast.ASTPrimarySuffix;\n+import net.sourceforge.pmd.lang.java.ast.JavaNode;\n import net.sourceforge.pmd.lang.java.rule.AbstractJavaRule;\n \n public class UnnecessaryCaseChangeRule extends AbstractJavaRule {\n \n+    private static final List<String> CASE_CHANGING_METHODS = asList(\"toLowerCase\", \"toUpperCase\");\n+    private static final List<String> EQUALITY_METHODS = asList(\"equals\", \"equalsIgnoreCase\");\n+\n     @Override\n-    public Object visit(ASTPrimaryExpression exp, Object data) {\n-        int n = exp.getNumChildren();\n-        if (n < 4) {\n-            return data;\n+    public Object visit(ASTPrimaryExpression expr, Object data) {\n+        int caseChangingCallIndex = getCaseChangingMethodCallIndex(expr);\n+        if (caseChangingCallIndex != -1) {\n+            int chainedMethodCallIndex = caseChangingCallIndex + 2;\n+            if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n+                    || isArgumentOfEqualsMethodCall(expr)) {\n+                addViolation(data, expr);\n+            }\n         }\n+        return super.visit(expr, data);\n+    }\n \n-        int first = getBadPrefixOrNull(exp, n);\n-        if (first == -1) {\n-            return data;\n+    private int getCaseChangingMethodCallIndex(ASTPrimaryExpression expr) {\n+        List<JavaNode> exprNodes = expr.findChildrenOfType(JavaNode.class);\n+        for (int callArgsIndex = 1; callArgsIndex < exprNodes.size(); callArgsIndex++) {\n+            int callIndex = callArgsIndex - 1;\n+            if (isCaseChangingMethodCall(exprNodes.get(callIndex), exprNodes.get(callArgsIndex))) {\n+                return callIndex;\n+            }\n         }\n+        return -1;\n+    }\n \n-        String second = getBadSuffixOrNull(exp, first + 2);\n-        if (second == null) {\n-            return data;\n-        }\n+    private boolean isCaseChangingMethodCall(JavaNode methodCall, JavaNode methodCallArgs) {\n+        String methodName = getCalledMethodName(methodCall);\n+        int methodArgsCount = getCalledMethodArgsCount(methodCallArgs);\n+        return methodName != null\n+                && isNameOfCaseChangingMethod(methodName) && methodArgsCount == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1MTU0MQ==", "bodyText": "I don't think, we should report here two violations, we have only one call to equals...", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r462851541", "createdAt": "2020-07-30T08:55:33Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/UnnecessaryCaseChange.xml", "diffHunk": "@@ -54,7 +54,7 @@ public class Foo {\n \n     <test-code>\n         <description>failure case with toLowerCase().equals()</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d69520f68fc68e40dc541604aa301246c8612ca7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b205806124e668607fa7e9fe9db2bf901604def9", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/b205806124e668607fa7e9fe9db2bf901604def9", "committedDate": "2020-07-30T10:22:02Z", "message": "UnnecessaryCaseChangeRule: violation reporting fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDM0Nzkz", "url": "https://github.com/pmd/pmd/pull/2662#pullrequestreview-459034793", "createdAt": "2020-07-31T09:21:16Z", "commit": {"oid": "b205806124e668607fa7e9fe9db2bf901604def9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToyMToxN1rOG6B7jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToyMToxN1rOG6B7jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwMjIyMQ==", "bodyText": "Since we don't use rule chain, you need to return super.visit(expr, data) here.... just returning data would skip nested classes etc.", "url": "https://github.com/pmd/pmd/pull/2662#discussion_r463502221", "createdAt": "2020-07-31T09:21:17Z", "author": {"login": "adangel"}, "path": "pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/UnnecessaryCaseChangeRule.java", "diffHunk": "@@ -30,16 +30,18 @@ public Object visit(ASTPrimaryExpression expr, Object data) {\n             if (hasEqualsMethodCallChainedAtPosition(expr, chainedMethodCallIndex)\n                     || isArgumentOfEqualsMethodCall(expr)) {\n                 addViolation(data, expr);\n+                return data;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b205806124e668607fa7e9fe9db2bf901604def9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca547b5054814933f87f0718e0432bc2e27e5da", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/eca547b5054814933f87f0718e0432bc2e27e5da", "committedDate": "2020-08-01T21:54:27Z", "message": "UnnecessaryCaseChangeRule: nested expressions traversing fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDQ5NDQ4", "url": "https://github.com/pmd/pmd/pull/2662#pullrequestreview-468049448", "createdAt": "2020-08-16T09:43:33Z", "commit": {"oid": "eca547b5054814933f87f0718e0432bc2e27e5da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4646, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}