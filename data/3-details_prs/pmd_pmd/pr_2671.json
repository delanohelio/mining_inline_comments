{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3Mjk4MTgz", "number": 2671, "title": "[java] CloseResource false positive when resource included in return value", "bodyText": "Describe the PR\nThe false positive was caused by this line:\n\n  \n    \n      pmd/pmd-java/src/main/java/net/sourceforge/pmd/lang/java/rule/errorprone/CloseResourceRule.java\n    \n    \n         Line 325\n      in\n      fe82f6a\n    \n    \n    \n    \n\n        \n          \n           List<ASTTryStatement> tryblocks = top.findDescendantsOfType(ASTTryStatement.class); \n        \n    \n  \n\n\nBecause in such a case, we stop traversing a tree at lambdas and code like this:\n     InputStream io = ...;\n     return () -> {\n        try {\n            ...\n        } finally {\n            io.close();\n        }\n     };\n\nwon't work. In order to fix the bug top.findDescendantsOfType(ASTTryStatement.class, true); was used. Also I've refactored the rule class.\n\nRelated issues\n\n\nFixes #2470\n\nReady?\n\n\n Added unit tests for fixed bug/feature\n Passing all unit tests\n Complete build ./mvnw clean verify passes (checked automatically by travis)\n Added (in-code) documentation (if needed)", "createdAt": "2020-07-27T17:23:09Z", "url": "https://github.com/pmd/pmd/pull/2671", "merged": true, "mergeCommit": {"oid": "0dbda8e0bea9bcf8acbb40f64edd6e009526cea1"}, "closed": true, "closedAt": "2020-08-21T08:59:38Z", "author": {"login": "Drofff"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5E4LkgH2gAyNDU3Mjk4MTgzOjRiYjM3NTkzNzE0ZmEyYzBlYjdiZDMwNWIzYjgyODgzN2I4ODcwYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA_vvaAH2gAyNDU3Mjk4MTgzOmI3M2IxZTkyZjM5NTE5MTVjZjI1Yjk2NTllNmJhNTFkNGE4MGMxMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bb37593714fa2c0eb7bd305b3b828837b8870b8", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/4bb37593714fa2c0eb7bd305b3b828837b8870b8", "committedDate": "2020-07-27T17:00:45Z", "message": "[java] CloseResource false positive when resource included in return value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa3271978ff1b2c114adcb288bec304d4393df98", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/aa3271978ff1b2c114adcb288bec304d4393df98", "committedDate": "2020-07-27T20:45:02Z", "message": "CloseResource: a method call as an allocation argument bug fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0c43ac799b7e521910a37e715b2b7a42751861e", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/d0c43ac799b7e521910a37e715b2b7a42751861e", "committedDate": "2020-07-27T20:37:11Z", "message": "CloseResource: method call as allocation argument bug fix"}, "afterCommit": {"oid": "aa3271978ff1b2c114adcb288bec304d4393df98", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/aa3271978ff1b2c114adcb288bec304d4393df98", "committedDate": "2020-07-27T20:45:02Z", "message": "CloseResource: a method call as an allocation argument bug fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/58c55d07ed9c9fb73184ac311e99b9cc81928040", "committedDate": "2020-07-28T07:58:45Z", "message": "CloseResource: addCloseResourceViolation fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTgzMTQz", "url": "https://github.com/pmd/pmd/pull/2671#pullrequestreview-458983143", "createdAt": "2020-07-31T07:54:17Z", "commit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1NDoxN1rOG5_YQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1Nzo1MFrOG5_eiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MDQxNg==", "bodyText": "I would argue, we should not report this case: If we know, that the underlying stream is a ByteArrayInputStream, then we can ignore the case: ByteArrayInputStream (as well as ByteArrayOutputStream, StringReader/-Writer) - see the property ALLOWED_RESOURCE_TYPES.\nThe only problematic code here is, that close() is called (so the programmer had the intention to close the stream), but it is not done in a finally block.... and only bos is closed and not ois.\nBut as mentioned, since this is a ByteArrayInputStream/OutputStream, it is not problematic, but bad style...\nMaybe we should give that case a special message? -> \"bos is not closed within a finally block, thus might not be closed at all in case of exceptions\".\nNote: You can also assert the violation message, that is produced by the rule with\n        <expected-messages>\n            <message>Ensure that resources like this Connection object are closed after use</message>\n        </expected-messages>\n\nSee also https://pmd.github.io/latest/pmd_userdocs_extending_testing.html", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463460416", "createdAt": "2020-07-31T07:54:17Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>\n+        <expected-problems>0</expected-problems>\n+        <code><![CDATA[\n+import java.io.*;\n+import java.util.function.Supplier;\n+public class Foo {\n+    public Supplier<Integer> bar() throws IOException {\n+        InputStream inputStream = new FileInputStream(\"/test.txt\");\n+        return () -> {\n+            try {\n+                return inputStream.read();\n+            } finally {\n+                inputStream.close();\n+            }\n+        };\n+    }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>wrapped ByteArrayInputStream false-negative test</description>\n+        <expected-problems>1</expected-problems>\n+        <expected-linenumbers>5</expected-linenumbers>\n+        <code><![CDATA[\n+import java.io.*;\n+public class Foo {\n+    public void bar() {\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream(new byte[10]);\n+        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(bos.toByteArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MjAyNA==", "bodyText": "What happens, if the input stream is used in the lamda, but not closed? Could you add another test case?\nimport java.io.*;\nimport java.util.function.Supplier;\npublic class Foo {\n    public Supplier<Integer> bar() {\n        InputStream inputStream = new FileInputStream(\"/test.txt\");\n        return () -> {\n            try {\n                return inputStream.read();\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n        };\n    }\n}\nHere we should report a violation.", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r463462024", "createdAt": "2020-07-31T07:57:50Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -1292,6 +1292,44 @@ public class CloseResourceNullPointer {\n     public void check(UnknownType param) {\n         InputStream in = param;\n     }\n+}\n+        ]]></code>\n+    </test-code>\n+\n+    <test-code>\n+        <description>#2470 false-positive at lambda returned from method</description>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c55d07ed9c9fb73184ac311e99b9cc81928040"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee", "author": {"user": {"login": "Drofff", "name": "Mykhailo Palahuta"}}, "url": "https://github.com/pmd/pmd/commit/db8b1aebd378fc46979c8225946ab9d0e370a0ee", "committedDate": "2020-08-03T14:14:44Z", "message": "CloseResource: close() should be in finally detection; try-with-resource var wrapping detection; wrapped type resolution fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNzE0NTY4", "url": "https://github.com/pmd/pmd/pull/2671#pullrequestreview-471714568", "createdAt": "2020-08-20T15:11:36Z", "commit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNToxMTozNlrOHEGQgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNToxMTozNlrOHEGQgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1ODg4Mw==", "bodyText": "hm... doubling the violations here is weird. Do we report these cases twice?", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474058883", "createdAt": "2020-08-20T15:11:36Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -543,7 +543,7 @@ public class Bar {\n \n     <test-code>\n         <description>#1375 CloseResource not detected properly - ok</description>\n-        <expected-problems>1</expected-problems>\n+        <expected-problems>2</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODA3Mzkw", "url": "https://github.com/pmd/pmd/pull/2671#pullrequestreview-471807390", "createdAt": "2020-08-20T16:50:50Z", "commit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MDo1MFrOHEK1oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MDo1MFrOHEK1oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMzkyMA==", "bodyText": "Ok, we have the following reported problems:\nn/a:8:\tEnsure that resources like this Connection object are closed after use\nn/a:9:\tEnsure that resources like this Statement object are closed after use\nn/a:13:\t'rs' is not closed within a finally block, thus might not be closed at all in case of exceptions\nso that seems ok.", "url": "https://github.com/pmd/pmd/pull/2671#discussion_r474133920", "createdAt": "2020-08-20T16:50:50Z", "author": {"login": "adangel"}, "path": "pmd-java/src/test/resources/net/sourceforge/pmd/lang/java/rule/errorprone/xml/CloseResource.xml", "diffHunk": "@@ -377,7 +377,7 @@ public class Test {\n \n     <test-code>\n         <description>#947 CloseResource rule fails if field is marked with annotation</description>\n-        <expected-problems>2</expected-problems>\n+        <expected-problems>3</expected-problems>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db8b1aebd378fc46979c8225946ab9d0e370a0ee"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e1370fac7b1babb781a14b3900ce7f43f2c2194", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/9e1370fac7b1babb781a14b3900ce7f43f2c2194", "committedDate": "2020-08-20T17:07:52Z", "message": "[java] CloseResource - avoid duplicated violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61ba8efcc1f056bee8b2774621833b78ed47e8f3", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/61ba8efcc1f056bee8b2774621833b78ed47e8f3", "committedDate": "2020-08-20T17:10:01Z", "message": "[doc] Update release notes, fixes #2470, refs #2671"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e743cc542fb87910accfa3be324481548606ade", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/0e743cc542fb87910accfa3be324481548606ade", "committedDate": "2020-08-20T17:13:14Z", "message": "Merge branch 'master' into pr-2671"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36f61f44aa83eef19443ff20166fa914966da05b", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/36f61f44aa83eef19443ff20166fa914966da05b", "committedDate": "2020-08-21T07:15:30Z", "message": "[java] CloseResource: fix false positive with close on not closeable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b73b1e92f3951915cf25b9659e6ba51d4a80c106", "author": {"user": {"login": "adangel", "name": "Andreas Dangel"}}, "url": "https://github.com/pmd/pmd/commit/b73b1e92f3951915cf25b9659e6ba51d4a80c106", "committedDate": "2020-08-21T07:33:24Z", "message": "[java] CloseResource: add new property \"closeNotInFinally\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4656, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}