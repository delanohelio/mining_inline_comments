{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NjQ5ODAy", "number": 1036, "title": "add assume-role credential provider", "bodyText": "Fixes #817", "createdAt": "2020-08-10T18:03:48Z", "url": "https://github.com/minio/minio-java/pull/1036", "merged": true, "mergeCommit": {"oid": "c94d8d98cbdc7015121a0fd51b80cf9701c92a06"}, "closed": true, "closedAt": "2020-09-03T12:50:58Z", "author": {"login": "balamurugana"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9wdeZABqjM2NDE1NzUxMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFP_LBAFqTQ4MTc5OTg2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d8843eed55606e6e9c06ad1a7de63c3b7329e2e", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/3d8843eed55606e6e9c06ad1a7de63c3b7329e2e", "committedDate": "2020-08-10T18:02:42Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "caec17965b1645faf5bc898f0c73e743271c721f", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/caec17965b1645faf5bc898f0c73e743271c721f", "committedDate": "2020-08-11T06:02:27Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caec17965b1645faf5bc898f0c73e743271c721f", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/caec17965b1645faf5bc898f0c73e743271c721f", "committedDate": "2020-08-11T06:02:27Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "committedDate": "2020-08-11T06:07:37Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/39cc6bbe1f0b6e0333a1a038cb3f8963a87edf76", "committedDate": "2020-08-11T06:07:37Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "9171a8426daf80624f1c452f43880e74146862ab", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/9171a8426daf80624f1c452f43880e74146862ab", "committedDate": "2020-08-15T04:38:38Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9171a8426daf80624f1c452f43880e74146862ab", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/9171a8426daf80624f1c452f43880e74146862ab", "committedDate": "2020-08-15T04:38:38Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "c564b9823164a610b10673b12cfa5ad6af6f71a1", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/c564b9823164a610b10673b12cfa5ad6af6f71a1", "committedDate": "2020-08-17T16:23:20Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c564b9823164a610b10673b12cfa5ad6af6f71a1", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/c564b9823164a610b10673b12cfa5ad6af6f71a1", "committedDate": "2020-08-17T16:23:20Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "f795521eff70c75ac4dd9880b420154c4b45a8c7", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f795521eff70c75ac4dd9880b420154c4b45a8c7", "committedDate": "2020-08-21T10:46:49Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f795521eff70c75ac4dd9880b420154c4b45a8c7", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f795521eff70c75ac4dd9880b420154c4b45a8c7", "committedDate": "2020-08-21T10:46:49Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/19cc439b846bb2610f8f3b775e6381460faca9e5", "committedDate": "2020-08-22T01:50:17Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjMxNzAy", "url": "https://github.com/minio/minio-java/pull/1036#pullrequestreview-478631702", "createdAt": "2020-08-31T13:48:23Z", "commit": {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo0ODoyM1rOHJ5mnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo1NzowN1rOHJ58Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0MzAwNA==", "bodyText": "The fields stsEndpoint, httpClient and credentials seem to be common with WebIdentityClientGrantsProvider. We can consider adding an abstract base class that has a constructor that takes these arguments and call it from the constructors of both WebIdentityClientGrantsProvider and AssumeRoleProvider", "url": "https://github.com/minio/minio-java/pull/1036#discussion_r480143004", "createdAt": "2020-08-31T13:48:23Z", "author": {"login": "anjalshireesh"}, "path": "api/src/main/java/io/minio/credentials/AssumeRoleProvider.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import io.minio.Digest;\n+import io.minio.Signer;\n+import io.minio.Time;\n+import io.minio.Xml;\n+import io.minio.errors.XmlParserException;\n+import java.io.IOException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.ZonedDateTime;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.MediaType;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+import okhttp3.Response;\n+import org.simpleframework.xml.Element;\n+import org.simpleframework.xml.Namespace;\n+import org.simpleframework.xml.Path;\n+import org.simpleframework.xml.Root;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\">AssumeRole\n+ * API</a>.\n+ */\n+public class AssumeRoleProvider implements Provider {\n+  public static final int DEFAULT_DURATION_SECONDS = (int) TimeUnit.HOURS.toSeconds(1);\n+  private final HttpUrl stsEndpoint;\n+  private final String accessKey;\n+  private final String secretKey;\n+  private final String region;\n+  private final OkHttpClient httpClient;\n+  private final String contentSha256;\n+  private final Request request;\n+  private Credentials credentials;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0ODUxOA==", "bodyText": "The request building logic is inside the fetch() method in the WebIdentityClientGrantsProvider class. Can we try to have a consistent pattern in both? I see a small potential for an abstract base class that provides the fetch() logic as well, forcing the concrete sub-classes to build the request, which seems to be the main difference.", "url": "https://github.com/minio/minio-java/pull/1036#discussion_r480148518", "createdAt": "2020-08-31T13:57:07Z", "author": {"login": "anjalshireesh"}, "path": "api/src/main/java/io/minio/credentials/AssumeRoleProvider.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import io.minio.Digest;\n+import io.minio.Signer;\n+import io.minio.Time;\n+import io.minio.Xml;\n+import io.minio.errors.XmlParserException;\n+import java.io.IOException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.ZonedDateTime;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.MediaType;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+import okhttp3.Response;\n+import org.simpleframework.xml.Element;\n+import org.simpleframework.xml.Namespace;\n+import org.simpleframework.xml.Path;\n+import org.simpleframework.xml.Root;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\">AssumeRole\n+ * API</a>.\n+ */\n+public class AssumeRoleProvider implements Provider {\n+  public static final int DEFAULT_DURATION_SECONDS = (int) TimeUnit.HOURS.toSeconds(1);\n+  private final HttpUrl stsEndpoint;\n+  private final String accessKey;\n+  private final String secretKey;\n+  private final String region;\n+  private final OkHttpClient httpClient;\n+  private final String contentSha256;\n+  private final Request request;\n+  private Credentials credentials;\n+\n+  public AssumeRoleProvider(\n+      @Nonnull String stsEndpoint,\n+      @Nonnull String accessKey,\n+      @Nonnull String secretKey,\n+      @Nullable Integer durationSeconds,\n+      @Nullable String policy,\n+      @Nullable String region,\n+      @Nullable String roleArn,\n+      @Nullable String roleSessionName,\n+      @Nullable String externalId,\n+      @Nullable OkHttpClient customHttpClient)\n+      throws NoSuchAlgorithmException {\n+    stsEndpoint = Objects.requireNonNull(stsEndpoint, \"STS endpoint cannot be empty\");\n+    this.stsEndpoint = Objects.requireNonNull(HttpUrl.parse(stsEndpoint), \"Invalid STS endpoint\");\n+    accessKey = Objects.requireNonNull(accessKey, \"Access key must not be null\");\n+    if (accessKey.isEmpty()) {\n+      throw new IllegalArgumentException(\"Access key must not be empty\");\n+    }\n+    this.accessKey = accessKey;\n+    this.secretKey = Objects.requireNonNull(secretKey, \"Secret key must not be null\");\n+    this.region = (region != null) ? region : \"\";\n+    this.httpClient = (customHttpClient != null) ? customHttpClient : new OkHttpClient();\n+\n+    if (externalId != null && (externalId.length() < 2 || externalId.length() > 1224)) {\n+      throw new IllegalArgumentException(\"Length of ExternalId must be in between 2 and 1224\");\n+    }\n+\n+    durationSeconds =\n+        (durationSeconds != null && durationSeconds > DEFAULT_DURATION_SECONDS)\n+            ? durationSeconds\n+            : DEFAULT_DURATION_SECONDS;\n+\n+    HttpUrl.Builder urlBuilder =\n+        this.stsEndpoint\n+            .newBuilder()\n+            .addQueryParameter(\"Action\", \"AssumeRole\")\n+            .addQueryParameter(\"Version\", \"2011-06-15\")\n+            .addQueryParameter(\"DurationSeconds\", String.valueOf(durationSeconds));\n+\n+    if (roleArn != null) {\n+      urlBuilder.addQueryParameter(\"RoleArn\", roleArn);\n+    }\n+\n+    if (roleSessionName != null) {\n+      urlBuilder.addQueryParameter(\"RoleSessionName\", roleSessionName);\n+    }\n+\n+    if (policy != null) {\n+      urlBuilder.addQueryParameter(\"Policy\", policy);\n+    }\n+\n+    if (externalId != null) {\n+      urlBuilder.addQueryParameter(\"ExternalId\", externalId);\n+    }\n+\n+    String data = urlBuilder.build().encodedQuery();\n+    this.contentSha256 = Digest.sha256Hash(data);\n+    this.request =\n+        new Request.Builder()\n+            .url(this.stsEndpoint)\n+            .method(\n+                \"POST\",\n+                RequestBody.create(MediaType.parse(\"application/x-www-form-urlencoded\"), data))\n+            .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5"}, "originalPosition": 122}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19cc439b846bb2610f8f3b775e6381460faca9e5", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/19cc439b846bb2610f8f3b775e6381460faca9e5", "committedDate": "2020-08-22T01:50:17Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "b7dee7f16975c03364ad0aa167e3e442adb88eb8", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/b7dee7f16975c03364ad0aa167e3e442adb88eb8", "committedDate": "2020-09-01T08:15:38Z", "message": "remove unused stsEndpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzk1NjA0", "url": "https://github.com/minio/minio-java/pull/1036#pullrequestreview-480795604", "createdAt": "2020-09-02T13:02:51Z", "commit": {"oid": "d0cd54b79ae831ad33769defc904b86e749c7a84"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0cd54b79ae831ad33769defc904b86e749c7a84", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/d0cd54b79ae831ad33769defc904b86e749c7a84", "committedDate": "2020-09-02T10:24:54Z", "message": "add assume-role base class"}, "afterCommit": {"oid": "3c912ce67705010a182981900434f685e0984d67", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/3c912ce67705010a182981900434f685e0984d67", "committedDate": "2020-09-03T09:10:47Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/6a9a454a639870b694c8c9e42721282dcd7c91e9", "committedDate": "2020-09-03T11:55:16Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c912ce67705010a182981900434f685e0984d67", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/3c912ce67705010a182981900434f685e0984d67", "committedDate": "2020-09-03T09:10:47Z", "message": "add assume-role credential provider\n\nFixes #817"}, "afterCommit": {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/6a9a454a639870b694c8c9e42721282dcd7c91e9", "committedDate": "2020-09-03T11:55:16Z", "message": "add assume-role credential provider\n\nFixes #817"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzk3Nzc2", "url": "https://github.com/minio/minio-java/pull/1036#pullrequestreview-481797776", "createdAt": "2020-09-03T12:41:46Z", "commit": {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzk5ODYy", "url": "https://github.com/minio/minio-java/pull/1036#pullrequestreview-481799862", "createdAt": "2020-09-03T12:44:26Z", "commit": {"oid": "6a9a454a639870b694c8c9e42721282dcd7c91e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1778, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}