{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4MTkyODA0", "number": 1136, "title": "Add S3 API execution trace to MinioException", "bodyText": "This is useful to debug issues further and to find root cause.", "createdAt": "2020-12-12T14:14:56Z", "url": "https://github.com/minio/minio-java/pull/1136", "merged": true, "mergeCommit": {"oid": "87ee0bee415178fd449ebdd652c1771881b65243"}, "closed": true, "closedAt": "2021-01-05T17:22:54Z", "author": {"login": "balamurugana"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm5t10gBqjQxMjI5MTgwMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtOJboAFqTU2MTk3NDY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f32299a60831f44f89dfa1b327ed2976db241893", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f32299a60831f44f89dfa1b327ed2976db241893", "committedDate": "2020-12-12T14:13:07Z", "message": "Add trace on error support\n\nThis feature helps to debug minio-java. It can be enabled by setting\nMINIO_JAVA_TRACE_ON_ERROR environment variable or system property.\nWhen MINIO_JAVA_TRACE_ON_ERROR is found, minio-java traces S3 protocol\nto standard error if any S3 API fails. This is useful to identify\nwhere the failure happened.\n\nExample:\n$ MINIO_JAVA_TRACE_ON_ERROR=1 java -cp minio-<VERSION>-all.jar:. FileUploader"}, "afterCommit": {"oid": "f9223765214c7f6cda2234530348ee8433761719", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f9223765214c7f6cda2234530348ee8433761719", "committedDate": "2020-12-17T01:54:37Z", "message": "Add S3 API execution trace to MinioException.\n\nThis is useful to debug issues further and find root cause."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9223765214c7f6cda2234530348ee8433761719", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f9223765214c7f6cda2234530348ee8433761719", "committedDate": "2020-12-17T01:54:37Z", "message": "Add S3 API execution trace to MinioException.\n\nThis is useful to debug issues further and find root cause."}, "afterCommit": {"oid": "404a91871c198ac5f844b297ec776b98c868955c", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/404a91871c198ac5f844b297ec776b98c868955c", "committedDate": "2020-12-17T02:01:55Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "404a91871c198ac5f844b297ec776b98c868955c", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/404a91871c198ac5f844b297ec776b98c868955c", "committedDate": "2020-12-17T02:01:55Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}, "afterCommit": {"oid": "ca36f63810e07d6ba0cd98a63817cb1e43812e6c", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/ca36f63810e07d6ba0cd98a63817cb1e43812e6c", "committedDate": "2020-12-17T02:38:51Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca36f63810e07d6ba0cd98a63817cb1e43812e6c", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/ca36f63810e07d6ba0cd98a63817cb1e43812e6c", "committedDate": "2020-12-17T02:38:51Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}, "afterCommit": {"oid": "f167ac459a236e529bf11b470c4be390e7661c86", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f167ac459a236e529bf11b470c4be390e7661c86", "committedDate": "2020-12-18T03:07:55Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f167ac459a236e529bf11b470c4be390e7661c86", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/f167ac459a236e529bf11b470c4be390e7661c86", "committedDate": "2020-12-18T03:07:55Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}, "afterCommit": {"oid": "e33cf40ed8efa0ad7c05928c4575c5497b857aca", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/e33cf40ed8efa0ad7c05928c4575c5497b857aca", "committedDate": "2020-12-23T02:08:00Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Njc1MTI2", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-557675126", "createdAt": "2020-12-23T06:54:53Z", "commit": {"oid": "e33cf40ed8efa0ad7c05928c4575c5497b857aca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NDo1NFrOIKWhvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwNjo1NDo1NFrOIKWhvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcyNTc1Ng==", "bodyText": "https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html\naccording to AWS S3 and MinIO the max size is 20 KiB", "url": "https://github.com/minio/minio-java/pull/1136#discussion_r547725756", "createdAt": "2020-12-23T06:54:54Z", "author": {"login": "kannappanr"}, "path": "api/src/main/java/io/minio/errors/BucketPolicyTooLargeException.java", "diffHunk": "@@ -16,23 +16,10 @@\n \n package io.minio.errors;\n \n-/** Thrown to indicate that given bucket name is not valid. */\n+/** Thrown to indicate that received bucket policy is larger than 12KiB size. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e33cf40ed8efa0ad7c05928c4575c5497b857aca"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e33cf40ed8efa0ad7c05928c4575c5497b857aca", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/e33cf40ed8efa0ad7c05928c4575c5497b857aca", "committedDate": "2020-12-23T02:08:00Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}, "afterCommit": {"oid": "92d9cb241f8af0ce8032addd6c8bb97350b300c6", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/92d9cb241f8af0ce8032addd6c8bb97350b300c6", "committedDate": "2020-12-23T07:31:15Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Njk5MzU0", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-557699354", "createdAt": "2020-12-23T07:56:46Z", "commit": {"oid": "92d9cb241f8af0ce8032addd6c8bb97350b300c6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/656f94d90b8ad03861ae9c70552bf5e393193572", "committedDate": "2021-01-03T11:46:41Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92d9cb241f8af0ce8032addd6c8bb97350b300c6", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/92d9cb241f8af0ce8032addd6c8bb97350b300c6", "committedDate": "2020-12-23T07:31:15Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}, "afterCommit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/656f94d90b8ad03861ae9c70552bf5e393193572", "committedDate": "2021-01-03T11:46:41Z", "message": "Add S3 API execution trace to MinioException\n\nThis is useful to debug issues further and to find root cause."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjkzOTQ3", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-560693947", "createdAt": "2021-01-03T12:49:48Z", "commit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNjAwMjUx", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-561600251", "createdAt": "2021-01-05T08:38:00Z", "commit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwODozODowMVrOIOOZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxMjo1OTo1MVrOIOWVMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc4Njg4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final Set<String> TRACE_QUERY_PARAMS = new HashSet<>();\n          \n          \n            \n            \n          \n          \n            \n              static {\n          \n          \n            \n                TRACE_QUERY_PARAMS.add(\"retention\");\n          \n          \n            \n                TRACE_QUERY_PARAMS.add(\"legal-hold\");\n          \n          \n            \n                TRACE_QUERY_PARAMS.add(\"tagging\");\n          \n          \n            \n                TRACE_QUERY_PARAMS.add(UPLOAD_ID);\n          \n          \n            \n              }\n          \n          \n            \n              private static final Set<String> TRACE_QUERY_PARAMS =\n          \n          \n            \n                ImmutableSet.of(\"retention\", \"legal-hold\", \"tagging\", UPLOAD_ID);\n          \n      \n    \n    \n  \n\nwe can use ImmutableSet from guava library for a simpler initialization of the set.", "url": "https://github.com/minio/minio-java/pull/1136#discussion_r551786889", "createdAt": "2021-01-05T08:38:01Z", "author": {"login": "anjalshireesh"}, "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -229,6 +230,15 @@\n     standardHeaders.add(\"range\");\n   }\n \n+  private static final Set<String> TRACE_QUERY_PARAMS = new HashSet<>();\n+\n+  static {\n+    TRACE_QUERY_PARAMS.add(\"retention\");\n+    TRACE_QUERY_PARAMS.add(\"legal-hold\");\n+    TRACE_QUERY_PARAMS.add(\"tagging\");\n+    TRACE_QUERY_PARAMS.add(UPLOAD_ID);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkxNjMyNQ==", "bodyText": "Can be extracted into a method, something like initTraceForRequest(request) or traceRequestInfo(request)", "url": "https://github.com/minio/minio-java/pull/1136#discussion_r551916325", "createdAt": "2021-01-05T12:58:50Z", "author": {"login": "anjalshireesh"}, "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -618,25 +628,28 @@ protected Response execute(\n               request.header(\"x-amz-content-sha256\"));\n     }\n \n-    if (this.traceStream != null) {\n-      this.traceStream.println(\"---------START-HTTP---------\");\n-      String encodedPath = request.url().encodedPath();\n-      String encodedQuery = request.url().encodedQuery();\n-      if (encodedQuery != null) {\n-        encodedPath += \"?\" + encodedQuery;\n-      }\n-      this.traceStream.println(request.method() + \" \" + encodedPath + \" HTTP/1.1\");\n-      this.traceStream.println(\n-          request\n-              .headers()\n-              .toString()\n-              .replaceAll(\"Signature=([0-9a-f]+)\", \"Signature=*REDACTED*\")\n-              .replaceAll(\"Credential=([^/]+)\", \"Credential=*REDACTED*\"));\n-      if (traceRequestBody) {\n-        this.traceStream.println(new String((byte[]) body, StandardCharsets.UTF_8));\n-      }\n+    StringBuilder traceBuilder = new StringBuilder();\n+    traceBuilder.append(\"---------START-HTTP---------\\n\");\n+    String encodedPath = request.url().encodedPath();\n+    String encodedQuery = request.url().encodedQuery();\n+    if (encodedQuery != null) {\n+      encodedPath += \"?\" + encodedQuery;\n+    }\n+    traceBuilder.append(request.method()).append(\" \").append(encodedPath).append(\" HTTP/1.1\\n\");\n+    traceBuilder.append(\n+        request\n+            .headers()\n+            .toString()\n+            .replaceAll(\"Signature=([0-9a-f]+)\", \"Signature=*REDACTED*\")\n+            .replaceAll(\"Credential=([^/]+)\", \"Credential=*REDACTED*\"));\n+    if (traceRequestBody) {\n+      traceBuilder.append(\"\\n\").append(new String((byte[]) body, StandardCharsets.UTF_8));\n     }\n \n+    PrintWriter traceStream = this.traceStream;\n+    if (traceStream != null) traceStream.println(traceBuilder.toString());\n+    traceBuilder.append(\"\\n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTkxNjg1MA==", "bodyText": "Can be extracted into a method, say addResponseInfoToTrace(response) or traceResponseInfo(response)", "url": "https://github.com/minio/minio-java/pull/1136#discussion_r551916850", "createdAt": "2021-01-05T12:59:51Z", "author": {"login": "anjalshireesh"}, "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -645,15 +658,27 @@ protected Response execute(\n     }\n \n     Response response = httpClient.newCall(request).execute();\n-    if (this.traceStream != null) {\n-      this.traceStream.println(\n-          response.protocol().toString().toUpperCase(Locale.US) + \" \" + response.code());\n-      this.traceStream.println(response.headers());\n-    }\n+    String trace =\n+        response.protocol().toString().toUpperCase(Locale.US)\n+            + \" \"\n+            + response.code()\n+            + \"\\n\"\n+            + response.headers();\n+    traceBuilder.append(trace).append(\"\\n\");\n+    if (traceStream != null) traceStream.println(trace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "656f94d90b8ad03861ae9c70552bf5e393193572"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919eda90d9ff1c4b526bd6b615cfd17f33465e2e", "author": {"user": {"login": "balamurugana", "name": "Bala FA"}}, "url": "https://github.com/minio/minio-java/commit/919eda90d9ff1c4b526bd6b615cfd17f33465e2e", "committedDate": "2021-01-05T14:16:36Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTU4OTk1", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-561958995", "createdAt": "2021-01-05T16:53:34Z", "commit": {"oid": "919eda90d9ff1c4b526bd6b615cfd17f33465e2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTc0NjU5", "url": "https://github.com/minio/minio-java/pull/1136#pullrequestreview-561974659", "createdAt": "2021-01-05T17:12:48Z", "commit": {"oid": "919eda90d9ff1c4b526bd6b615cfd17f33465e2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1827, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}