{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMzM1MDI4", "number": 1089, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzo1MDoyOFrOEyr8kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMToxNTo0NlrOEywzyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNTg0Mjc0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzo1MDoyOFrOHpdjDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzo1MDoyOFrOHpdjDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzNzc3NA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513237774", "createdAt": "2020-10-28T07:50:28Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -194,7 +194,7 @@\n   private static final int DEFAULT_EXPIRY_TIME = 7 * 24 * 3600;\n   private static final String DEFAULT_USER_AGENT =\n       \"MinIO (\"\n-          + System.getProperty(\"os.arch\")\n+          + System.getProperty(\"os.name\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "658af0b3e59e7d2c12879e126e5d2394f298ee4a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNTg1NzM0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNzo1NDo1N1rOHpdr0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTozOTowMlrOHphcZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MDAxNw==", "bodyText": "Why do we need this? or what exactly the problem in current approach?", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513240017", "createdAt": "2020-10-28T07:54:57Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -62,14 +70,27 @@ private void setDevelopmentVersion() {\n   private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n     if (classLoader != null) {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n+      boolean minioManifestFound = false;\n+      boolean minioVersionFound = false;\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            if (entry.getKey().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE)\n+                && entry.getValue().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE)) {\n+              minioManifestFound = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "658af0b3e59e7d2c12879e126e5d2394f298ee4a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI1MTQ2OA==", "bodyText": "When minio is included with other libraries - via maven/gradle - this manifest resources will list all the manifests from the classpath - We specifically need the manifest from the minio jar - so we can get the version number correctly.\nAn example is added here https://github.com/vinu/minio-check (using minio with spring boot)\nI added 7.1.4 of minio library, so I was expecting the User-agent to have this version, but it was like this User-Agent: MinIO (x86_64; x86_64) minio-java/1.7.30\nThis is because the current implementation lists all manifests from the classpath, and just takes the Implementation-Version so the version info is overridden by some other manifest.", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513251468", "createdAt": "2020-10-28T08:17:04Z", "author": {"login": "vinu"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -62,14 +70,27 @@ private void setDevelopmentVersion() {\n   private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n     if (classLoader != null) {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n+      boolean minioManifestFound = false;\n+      boolean minioVersionFound = false;\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            if (entry.getKey().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE)\n+                && entry.getValue().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE)) {\n+              minioManifestFound = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MDAxNw=="}, "originalCommit": {"oid": "658af0b3e59e7d2c12879e126e5d2394f298ee4a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI2NDU3Mw==", "bodyText": "\ud83d\udc4d\nSimplify everything like below\ndiff --git a/api/src/main/java/io/minio/MinioProperties.java b/api/src/main/java/io/minio/MinioProperties.java\nindex ad6f4c9b..72bc9e26 100644\n--- a/api/src/main/java/io/minio/MinioProperties.java\n+++ b/api/src/main/java/io/minio/MinioProperties.java\n@@ -20,7 +20,6 @@ import java.io.IOException;\n import java.net.URL;\n import java.util.Enumeration;\n import java.util.concurrent.atomic.AtomicReference;\n-import java.util.jar.Attributes;\n import java.util.jar.Manifest;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n@@ -28,49 +27,52 @@ import java.util.logging.Logger;\n /** Identifies and stores version information of minio-java package at run time. */\n enum MinioProperties {\n   INSTANCE;\n-\n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n-\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n-  public String getVersion() {\n-    String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+  private synchronized void setVersion() {\n+    if (version.get() != null) {\n+      return;\n     }\n-    return result;\n-  }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n       version.set(\"dev\");\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n-      Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n-      while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+    Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n+    while (resources.hasMoreElements()) {\n+      try (InputStream is = resources.nextElement().openStream()) {\n+        Manifest manifest = new Manifest(is);\n+        boolean minioManifestFound = false;\n+        for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+          String key = entry.getKey().toString();\n+          String value = entry.getValue().toString();\n+          if (minioManifestFound && key.equals(\"Implementation-Version\")) {\n+            version.set(value);\n+            return;\n           }\n+\n+          minioManifestFound = value.equals(\"minio\") && key.equals(\"Implementation-Title\");\n         }\n+      } catch (IOException e) {\n+        LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n+        version.set(\"unknown\");\n+        return;\n       }\n     }\n+\n+    version.set(\"dev\");\n+  }\n+\n+  public String getVersion() {\n+    String result = version.get();\n+    if (result != null) {\n+      return result;\n+    }\n+\n+    setVersion();\n+    return version.get();\n   }\n }", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513264573", "createdAt": "2020-10-28T08:40:07Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -62,14 +70,27 @@ private void setDevelopmentVersion() {\n   private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n     if (classLoader != null) {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n+      boolean minioManifestFound = false;\n+      boolean minioVersionFound = false;\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            if (entry.getKey().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE)\n+                && entry.getValue().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE)) {\n+              minioManifestFound = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MDAxNw=="}, "originalCommit": {"oid": "658af0b3e59e7d2c12879e126e5d2394f298ee4a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMTYwNw==", "bodyText": "Please check the latest push, hope that cleans things :)", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513301607", "createdAt": "2020-10-28T09:39:02Z", "author": {"login": "vinu"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -62,14 +70,27 @@ private void setDevelopmentVersion() {\n   private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n     if (classLoader != null) {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n+      boolean minioManifestFound = false;\n+      boolean minioVersionFound = false;\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            if (entry.getKey().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE)\n+                && entry.getValue().toString().equals(META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE)) {\n+              minioManifestFound = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MDAxNw=="}, "originalCommit": {"oid": "658af0b3e59e7d2c12879e126e5d2394f298ee4a"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjI1ODgyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTozOTozMVrOHphdpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTozOTozMVrOHphdpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMTkyNg==", "bodyText": "Use these values directly than having constants.", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513301926", "createdAt": "2020-10-28T09:39:31Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjI2NTQ3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo0MTowMFrOHphhpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo0MTowMFrOHphhpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMjk1MQ==", "bodyText": "Do no-op if version is already set in another thread.\nif (version.get() != null) {\n   return;\n}", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513302951", "createdAt": "2020-10-28T09:41:00Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";\n+\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+  private synchronized void setVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjI3MDY5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo0MjoxM1rOHphk5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo0MjoxM1rOHphk5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwMzc4Mg==", "bodyText": "Set dev as default value i.e. move above this line and remove setting it later.", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513303782", "createdAt": "2020-10-28T09:42:13Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";\n+\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+  private synchronized void setVersion() {\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n       version.set(\"dev\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjI4MzIyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo0NToxNlrOHphsvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDoxMjoxM1rOHpi0Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwNTc5MA==", "bodyText": "This is not going to work. You are resetting the value on every iteration.", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513305790", "createdAt": "2020-10-28T09:45:16Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";\n+\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+  private synchronized void setVersion() {\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n       version.set(\"dev\");\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n+    try {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          boolean minioManifestFound;\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            String key = entry.getKey().toString();\n+            String value = entry.getValue().toString();\n+            minioManifestFound =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMxMzQ3MQ==", "bodyText": "Actually we need only below in the for\nif (entry.getKey().toString().equals(\"Implementation-Title\") && entry.getValue().toString().equals(\"minio\")) {\n  version.set(manifest.getMainAttributes().getValue(\"Implementation-Version\"));\n  return;\n}", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513313471", "createdAt": "2020-10-28T09:56:01Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";\n+\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+  private synchronized void setVersion() {\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n       version.set(\"dev\");\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n+    try {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          boolean minioManifestFound;\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            String key = entry.getKey().toString();\n+            String value = entry.getValue().toString();\n+            minioManifestFound =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwNTc5MA=="}, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyNDA1OQ==", "bodyText": "Got rid of the for, we can directly pull in the values from the attributes and check", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513324059", "createdAt": "2020-10-28T10:12:13Z", "author": {"login": "vinu"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -31,46 +32,57 @@\n \n   private static final Logger LOGGER = Logger.getLogger(MinioProperties.class.getName());\n \n+  // These attributes are checked from the manifests in classpath.\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE = \"Implementation-Title\";\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_VERSION = \"Implementation-Version\";\n+\n+  // this is set from gradle\n+  private static final String META_INF_ATTRIB_IMPLEMENTATION_TITLE_VALUE = \"minio\";\n+\n   private final AtomicReference<String> version = new AtomicReference<>(null);\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n+  private synchronized void setVersion() {\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n       version.set(\"dev\");\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n+    try {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          boolean minioManifestFound;\n+          for (Map.Entry<Object, Object> entry : manifest.getMainAttributes().entrySet()) {\n+            String key = entry.getKey().toString();\n+            String value = entry.getValue().toString();\n+            minioManifestFound =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwNTc5MA=="}, "originalCommit": {"oid": "620252cf5fac24f8422fe2634860e786394f613d"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjYzOTQ0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/minio/MinioProperties.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMToxNTo0NlrOHplIog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMjoyMTozM1rOHpnX1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MjA4Mg==", "bodyText": "Just reduce to if (\"minio\".equals(manifest.getMainAttributes().getValue(\"Implementation-Title\")))", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513362082", "createdAt": "2020-10-28T11:15:46Z", "author": {"login": "balamurugana"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -35,42 +35,39 @@\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n-      version.set(\"dev\");\n+  private synchronized void setVersion() {\n+    if (version.get() != null) {\n+      return;\n+    }\n+    version.set(\"dev\");\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n+    try {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          String implementationTitleValue =\n+              manifest.getMainAttributes().getValue(\"Implementation-Title\");\n+          if (implementationTitleValue != null && implementationTitleValue.equals(\"minio\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2dbee575259a35b5c56c5064394c6c06c280400"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM5ODc0Mw==", "bodyText": "\ud83d\udc4d  fixed", "url": "https://github.com/minio/minio-java/pull/1089#discussion_r513398743", "createdAt": "2020-10-28T12:21:33Z", "author": {"login": "vinu"}, "path": "api/src/main/java/io/minio/MinioProperties.java", "diffHunk": "@@ -35,42 +35,39 @@\n \n   public String getVersion() {\n     String result = version.get();\n-    if (result == null) {\n-      synchronized (INSTANCE) {\n-        if (version.get() == null) {\n-          try {\n-            ClassLoader classLoader = getClass().getClassLoader();\n-            setMinioClientJavaVersion(classLoader);\n-            setDevelopmentVersion();\n-          } catch (IOException e) {\n-            LOGGER.log(Level.SEVERE, \"IOException occured\", e);\n-            version.set(\"unknown\");\n-          }\n-          result = version.get();\n-        }\n-      }\n+    if (result != null) {\n+      return result;\n     }\n-    return result;\n+    setVersion();\n+    return version.get();\n   }\n \n-  private void setDevelopmentVersion() {\n-    if (version.get() == null) {\n-      version.set(\"dev\");\n+  private synchronized void setVersion() {\n+    if (version.get() != null) {\n+      return;\n+    }\n+    version.set(\"dev\");\n+    ClassLoader classLoader = getClass().getClassLoader();\n+    if (classLoader == null) {\n+      return;\n     }\n-  }\n \n-  private void setMinioClientJavaVersion(ClassLoader classLoader) throws IOException {\n-    if (classLoader != null) {\n+    try {\n       Enumeration<URL> resources = classLoader.getResources(\"META-INF/MANIFEST.MF\");\n       while (resources.hasMoreElements()) {\n-        Manifest manifest = new Manifest(resources.nextElement().openStream());\n-        for (Object k : manifest.getMainAttributes().keySet()) {\n-          String versionString = \"Implementation-Version\";\n-          if (k.toString().equals(versionString)) {\n-            version.set(manifest.getMainAttributes().getValue((Attributes.Name) k));\n+        try (InputStream is = resources.nextElement().openStream()) {\n+          Manifest manifest = new Manifest(is);\n+          String implementationTitleValue =\n+              manifest.getMainAttributes().getValue(\"Implementation-Title\");\n+          if (implementationTitleValue != null && implementationTitleValue.equals(\"minio\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MjA4Mg=="}, "originalCommit": {"oid": "d2dbee575259a35b5c56c5064394c6c06c280400"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 628, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}