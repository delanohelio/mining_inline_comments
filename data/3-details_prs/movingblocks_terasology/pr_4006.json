{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NDYwNzY2", "number": 4006, "title": "refactor(BlockItemFactory): remove code dupes; add doc; retain components", "bodyText": "Reduces code duplication in BlockItemFactory and unifies the way block items are created when using BlockItemFactory::newInstance and BlockItemFactory::newBuilder.\nBlock item creation now also takes RetainComponentsComponent into account when copying components from a reference entity or block prefab to the block item.\n\ud83d\udcd8 Also, full addition of JavaDoc for BlockItemFactory.", "createdAt": "2020-05-30T12:38:55Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4006", "merged": true, "mergeCommit": {"oid": "957543938f28d703e3175e0ca6f2c5f64da0dd1d"}, "closed": true, "closedAt": "2020-05-31T09:11:26Z", "author": {"login": "skaldarnar"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmIHnnAH2gAyNDI1NDYwNzY2OmZjNTJjOWNiYWI5ZTA0ODBkODYxZDk4OTk5YzAyNDRkMWM0MjBlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmk5IDgFqTQyMTQ2MzAyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc52c9cbab9e0480d861d98999c0244d1c420e68", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/fc52c9cbab9e0480d861d98999c0244d1c420e68", "committedDate": "2020-05-29T20:02:46Z", "message": "refactor: BlockItemFactory to remove code duplication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d35eac3e6083f28a377523e1344e0d86a812fde7", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/d35eac3e6083f28a377523e1344e0d86a812fde7", "committedDate": "2020-05-29T20:04:27Z", "message": "feat: Keep components listed as _retain components_ when creating a block item"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e96f45cceebab5bde9acdae210e2586f221ffae6", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/e96f45cceebab5bde9acdae210e2586f221ffae6", "committedDate": "2020-05-30T11:26:47Z", "message": "refactor(BlockItemFactory): better names; use RetainComponents"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "667b37351e3ebd5169b91e50acce5120bd6f6560", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/667b37351e3ebd5169b91e50acce5120bd6f6560", "committedDate": "2020-05-30T12:58:53Z", "message": "doc: Update doc for RetainComponentsComponent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729c1ac2821efdb8c44249cfdd9b7aa9f8540430", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/729c1ac2821efdb8c44249cfdd9b7aa9f8540430", "committedDate": "2020-05-30T12:59:31Z", "message": "refactor: use common super type ComponentContainer in BlockItemFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7be96276f45cbc3bad06e1f753dfda39b80ec096", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/7be96276f45cbc3bad06e1f753dfda39b80ec096", "committedDate": "2020-05-30T13:13:26Z", "message": "refactor: make use of `::updateComponent` when adjusting block item components"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c60485959e2452125da833a4c6cdb36e9dd4e3ae", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/c60485959e2452125da833a4c6cdb36e9dd4e3ae", "committedDate": "2020-05-30T14:17:51Z", "message": "doc(BlockItemFactory): doc class and builder methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dda70171a421b58e71f4f766c7c727223234ef75", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/dda70171a421b58e71f4f766c7c727223234ef75", "committedDate": "2020-05-30T14:22:21Z", "message": "doc(BlockItemFactory): doc for `BlockItemFactory::newInstance` methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/b24cdaf9a1a0a579b31e0623a187ab7a8e062b74", "committedDate": "2020-05-30T14:25:05Z", "message": "doc(BlockItemFactory): finalize documentation for class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDM0Mzg5", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#pullrequestreview-421434389", "createdAt": "2020-05-30T18:38:31Z", "commit": {"oid": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxODozODozMVrOGc0vBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxOToxMToyOFrOGc04Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg3NzMxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A factory to create new <emph>block items</emph> for a {@link BlockFamily}.\n          \n          \n            \n             * A factory to create new <em>block items</em> for a {@link BlockFamily}.", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#discussion_r432877319", "createdAt": "2020-05-30T18:38:31Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java", "diffHunk": "@@ -15,68 +15,81 @@\n  */\n package org.terasology.world.block.items;\n \n+import com.google.common.base.Preconditions;\n+import com.google.common.primitives.Ints;\n import org.terasology.entitySystem.Component;\n+import org.terasology.entitySystem.ComponentContainer;\n import org.terasology.entitySystem.entity.EntityBuilder;\n import org.terasology.entitySystem.entity.EntityManager;\n import org.terasology.entitySystem.entity.EntityRef;\n-import org.terasology.entitySystem.prefab.Prefab;\n import org.terasology.logic.common.DisplayNameComponent;\n+import org.terasology.logic.common.RetainComponentsComponent;\n import org.terasology.logic.inventory.ItemComponent;\n import org.terasology.rendering.logic.LightComponent;\n import org.terasology.world.block.family.BlockFamily;\n \n+import java.util.Collections;\n import java.util.Optional;\n+import java.util.Set;\n \n /**\n+ * A factory to create new <emph>block items</emph> for a {@link BlockFamily}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg3OTY1NQ==", "bodyText": "I feel like there should be a shorter form of that conversion. Oh, here we go:\nhttps://guava.dev/releases/snapshot/api/docs/com/google/common/primitives/SignedBytes.html#saturatedCast-long-\nsignedBytes.saturatedCast(quantity)", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#discussion_r432879655", "createdAt": "2020-05-30T19:11:28Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java", "diffHunk": "@@ -85,37 +98,145 @@ public EntityRef newInstance(BlockFamily blockFamily, int quantity) {\n         return builder.build();\n     }\n \n+    /**\n+     * Create a new block item for the given {@link BlockFamily}, with {@code blockEntity} as reference entity to retain\n+     * components from.\n+     * <p>\n+     * The item quantity defaults to 1.\n+     * <p>\n+     * Use {@link #newBuilder(BlockFamily, EntityRef, int)} if you want to modify the block item entity's properties\n+     * before it gets created.\n+     *\n+     * @param blockFamily block family to create the block item builder for\n+     * @param blockEntity reference block entity to retain components from\n+     * @return the block item entity\n+     */\n     public EntityRef newInstance(BlockFamily blockFamily, EntityRef blockEntity) {\n         if (blockFamily == null) {\n             return EntityRef.NULL;\n         }\n \n+        return createBuilder(blockFamily, blockEntity, (byte) 1).build();\n+    }\n+\n+    /**\n+     * Create a new block item builder for the given {@link BlockFamily} and item quantity.\n+     * <p>\n+     * Attempts to resolve the corresponding block prefab to retrieve a list of potential components to add.\n+     * <p>\n+     * Use this method if you want to modify the block item entity's properties before it gets created.\n+     *\n+     * @param blockFamily block family to create the block item builder for\n+     * @param quantity item quantity (see {@link ItemComponent#stackCount}); constrained to [0...128)\n+     * @return a pre-populated entity builder for a block item entity\n+     */\n+    public EntityBuilder newBuilder(BlockFamily blockFamily, int quantity) {\n+        final ComponentContainer components =\n+                blockFamily.getArchetypeBlock().getPrefab()\n+                        .map(p -> ((ComponentContainer) p))\n+                        .orElse(EntityRef.NULL);\n+\n+        return createBuilder(blockFamily, components, (byte) Ints.constrainToRange(quantity, 0, Byte.MAX_VALUE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b24cdaf9a1a0a579b31e0623a187ab7a8e062b74"}, "originalPosition": 160}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5bee8ee6990a3e5aa3a60febb1cb9f8cc02f7b5", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/a5bee8ee6990a3e5aa3a60febb1cb9f8cc02f7b5", "committedDate": "2020-05-30T22:38:08Z", "message": "Update engine/src/main/java/org/terasology/world/block/items/BlockItemFactory.java\n\nCo-authored-by: Kevin Turner <83819+keturn@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b47bc51432c2b548a45b1e99f05b83d9633e436", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/9b47bc51432c2b548a45b1e99f05b83d9633e436", "committedDate": "2020-05-30T22:40:16Z", "message": ". improve conversion to byte by using SignedBytes::saturatedCast"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDYzMDIz", "url": "https://github.com/MovingBlocks/Terasology/pull/4006#pullrequestreview-421463023", "createdAt": "2020-05-31T05:34:11Z", "commit": {"oid": "9b47bc51432c2b548a45b1e99f05b83d9633e436"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1620, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}