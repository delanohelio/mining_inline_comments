{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4OTc3NDY1", "number": 3910, "title": "feat: add retain components component", "bodyText": "Contains\nThis PR adds RetainComponentsComponent which is a component intended to list component classes that are supposed to be retained when placing a block.\nSpecifying a list of components to be retained when placing a block is necessary as on placing a block, EntityAwareWorldProvider::updateBlockEntityComponents removes all components from the entity of the block to be placed that\n\nare not any of NetworkComponent, BlockComponent, and LocationComponent\ndon't have retainUnalteredOnBlockChange metadata\nare not listed in the block prefab\nare not in the set of components to be retained\nThis especially affects components that are added to an entity programmatically, e.g. the ManualLabor:AssemblyTable which receives amongst others an InventoryComponent in Machines:MachineCommonSystem leading to newly placed assembly tables being broken.\n\nThe set of component given to updateBlockEntityComponents was hard-coded to emptySet in EntityAwareWorldProvider::setBlocks until now. With this PR there's now a check for RetainComponentsComponent in the blockEntity in EntityAwareWorldProvider::setBlocks.\nIf it's present, instead of emptySet, the set of components to retain that is stored in the RetainComponentsComponent component are passed.\nHow to test\nBroken state:\nProgrammatically add a component to an entity and observe that it's removed in EntityAwareWorldProvider::updateBlockEntityComponents.\nFixed state:\nBefore adding the new component, create a RetainComponentsComponent with this new component and add it to the entity. Observe that it's not removed anymore. Also observe, that the RetainComponentsComponent is removed.", "createdAt": "2020-04-25T22:08:20Z", "url": "https://github.com/MovingBlocks/Terasology/pull/3910", "merged": true, "mergeCommit": {"oid": "73d83e6be73f74d37044e42e12a0868d66d23ea8"}, "closed": true, "closedAt": "2020-04-27T19:00:04Z", "author": {"login": "jdrueckert"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbNFuBgH2gAyNDA4OTc3NDY1OmZmNzlmNjcxNDljOTIyOGI2OGVjYWNiMGI3NDkyZGNiMjNkNDYwNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbgMHbAH2gAyNDA4OTc3NDY1OjJiYTExMWVhM2NjY2EzMzIyZGU4Yjc3YmE0ZmY0OTVmYzViYTFiZDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff79f67149c9228b68ecacb0b7492dcb23d46065", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ff79f67149c9228b68ecacb0b7492dcb23d46065", "committedDate": "2020-04-25T21:37:03Z", "message": "feat: add `RetainComponentsComponent` component\n\n- adds `retainComponentsComponent` that contains components that are supposed to be retained when placing a block\n- background: on placing a block, `EntityAwareWorldProvider::updateBlockEntityComponents` removes all components from the entity of the block to be placed that\n  - are not any of `NetworkComponent`, `BlockComponent`, and `LocationComponent`\n  - don't have `retainUnalteredOnBlockChange` metadata\n  - are not listed in the block prefab\n  - are not in the set of components to be retained (which was hard-coded to `emptySet` until now)\n- adds a check for `retainComponentsComponent` in `EntityAwareWorldProvider::setBlocks` and if present passes the set of components to retain instead of `emptySet`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a9bd2427f2b0d972c4a3eb6cb2c645270ef16a", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/d7a9bd2427f2b0d972c4a3eb6cb2c645270ef16a", "committedDate": "2020-04-25T21:44:51Z", "message": "chore: update .gitattributes\n\n- add entries for .jpeg, .dylib, .ogg, and .dbg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6879e30c3dc67c91365bb2b8c76aa8272adc802d", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/6879e30c3dc67c91365bb2b8c76aa8272adc802d", "committedDate": "2020-04-25T22:34:29Z", "message": "feat: do it the functional way"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDkzNjQ5", "url": "https://github.com/MovingBlocks/Terasology/pull/3910#pullrequestreview-400493649", "createdAt": "2020-04-26T11:36:45Z", "commit": {"oid": "6879e30c3dc67c91365bb2b8c76aa8272adc802d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMTozNjo0NVrOGMDO2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMTozODo0MlrOGMDQIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTA1MA==", "bodyText": "We're missing a license header here.", "url": "https://github.com/MovingBlocks/Terasology/pull/3910#discussion_r415289050", "createdAt": "2020-04-26T11:36:45Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/logic/common/RetainComponentsComponent.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package org.terasology.logic.common;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6879e30c3dc67c91365bb2b8c76aa8272adc802d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTE2OA==", "bodyText": "Please add Javadoc to explain what this component is intended for. I think you can take parts the PR description for that.", "url": "https://github.com/MovingBlocks/Terasology/pull/3910#discussion_r415289168", "createdAt": "2020-04-26T11:37:30Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/logic/common/RetainComponentsComponent.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package org.terasology.logic.common;\n+\n+import com.google.api.client.util.Sets;\n+import org.terasology.entitySystem.Component;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+public class RetainComponentsComponent implements Component {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6879e30c3dc67c91365bb2b8c76aa8272adc802d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4OTM3OA==", "bodyText": "We should make sure that this works with de-/serialization, e.g., check whether we can specify this also via a prefab...", "url": "https://github.com/MovingBlocks/Terasology/pull/3910#discussion_r415289378", "createdAt": "2020-04-26T11:38:42Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/logic/common/RetainComponentsComponent.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package org.terasology.logic.common;\n+\n+import com.google.api.client.util.Sets;\n+import org.terasology.entitySystem.Component;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+public class RetainComponentsComponent implements Component {\n+    public Set<Class<? extends Component>> components = Sets.newHashSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6879e30c3dc67c91365bb2b8c76aa8272adc802d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f874a1429ba1a5b470283d585fdffbf6dff267", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/93f874a1429ba1a5b470283d585fdffbf6dff267", "committedDate": "2020-04-26T18:34:49Z", "message": "chore: add licensing header and java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0723e7084d196881271ec9befa4ac98e524edb22", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/0723e7084d196881271ec9befa4ac98e524edb22", "committedDate": "2020-04-26T18:39:48Z", "message": "chore: update java docs for `updateBlockEntityComponents`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTM2MjM3", "url": "https://github.com/MovingBlocks/Terasology/pull/3910#pullrequestreview-400536237", "createdAt": "2020-04-26T18:45:04Z", "commit": {"oid": "0723e7084d196881271ec9befa4ac98e524edb22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba111ea3ccca3322de8b77ba4ff495fc5ba1bd1", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/2ba111ea3ccca3322de8b77ba4ff495fc5ba1bd1", "committedDate": "2020-04-26T19:52:14Z", "message": "fix: imports and add `@Replicate`\n\n- without `@Replicate` this doesn't work in multiplayer for joining players, but only for the host"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1485, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}