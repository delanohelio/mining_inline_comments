{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2MDA3MTQ3", "number": 4147, "title": "feat: set limits for maximum memory use.", "bodyText": "We've had some memory leaks where the game seems to take up far more of the system's memory than the amount allowed for Java's maximum heap size.\nThis uses some operating-system-specific functions to set limits on how much memory the process can allocate.\nBecause this is so system-dependent, I'm introducing this as a developer/debugger feature rather than intending it for production use.\n(Players won't want the game taking runaway amounts of memory either, but getting consistent support for this and setting expectations for how it works would be a bigger project. Possibly would want to do it in Launcher, as some of these controls are better set before even launching the process.)\nContains\nLinux support only.\n\nSets RLIMIT_DATA to limit the maximum amount of memory for the process's data segment.\nSets oom_score_adj to give the out-of-memory reaper encouragement to choose this process for termination when the system is out of memory as a whole.\n\nHow to test\nOn Linux:\ncheck /proc/PID/limits\n\ntest default\ntest with low limit, see out-of-memory error\ntest with high limit\n\nOn other platforms:\n\nmake sure game starts as normal, i.e. that the Linux-only code didn't ruin things for everyone else.\n\nOutstanding before merging\n\n Make limits configurable instead of hard-coded\n Blocked by #4146 for the upgrade of JNA Platform", "createdAt": "2020-09-12T19:53:17Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4147", "merged": true, "mergeCommit": {"oid": "a1c3ec2e3683dd7e37690e8c8c44d5da3c6462c4"}, "closed": true, "closedAt": "2021-08-19T21:12:09Z", "author": {"login": "keturn"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH9paigH2gAyNDg2MDA3MTQ3OjZkMTFjYTM2MmJiODNkOTUxZDBiYjEwYjUzMzY2NDQ5NzcyOWM4NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABe2AkrvAH2gAyNDg2MDA3MTQ3OmI5ZGJjMmVkOTg0ZjAxOTEzMjY5NjIxMTI4NDEyYjM0NTM1MTQyMmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d11ca362bb83d951d0bb10b533664497729c874", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/6d11ca362bb83d951d0bb10b533664497729c874", "committedDate": "2020-09-11T23:04:09Z", "message": "chore: upgrade JNA to 4.5.2\n\nThe latest in the 4.x series."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06441b40719af2aa1c369a9e30595d0efab670a", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/d06441b40719af2aa1c369a9e30595d0efab670a", "committedDate": "2020-09-12T19:21:49Z", "message": "feature: limit max data segment size with setrlimit\n\nWIP: Currently hardcoded to 8 GB."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjUzMjQ1", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#pullrequestreview-487253245", "createdAt": "2020-09-12T20:03:00Z", "commit": {"oid": "d06441b40719af2aa1c369a9e30595d0efab670a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQyMDowMzowMFrOHQ3MZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQyMDowNDoyNVrOHQ3MvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ0MzU1Nw==", "bodyText": "There's a new major version of JNA 5.x out since October 2018, but the 4.5 series is sufficient to provide the Resource API and I thought I could get away with doing less testing if I stuck to the same major version.\nManually keeping versions in sync between here and facade's build.gradle is a bother. Perhaps after clearing the jna-in-jopenvr obstacle we can revisit this and see if we can avoid that duplication.", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r487443557", "createdAt": "2020-09-12T20:03:00Z", "author": {"login": "keturn"}, "path": "engine/build.gradle", "diffHunk": "@@ -96,7 +96,7 @@ dependencies {\n     api group: 'org.codehaus.plexus', name: 'plexus-utils', version: '1.5.6'\n \n     // Java magic\n-    implementation group: 'net.java.dev.jna', name: 'jna-platform', version: '4.2.2'\n+    implementation group: 'net.java.dev.jna', name: 'jna-platform', version: '4.5.2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06441b40719af2aa1c369a9e30595d0efab670a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ0MzY0NA==", "bodyText": "Placeholder error handling, do something better here.", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r487443644", "createdAt": "2020-09-12T20:04:25Z", "author": {"login": "keturn"}, "path": "facades/PC/src/main/java/org/terasology/engine/Terasology.java", "diffHunk": "@@ -477,4 +470,26 @@ private static int getLastNumber(String str) {\n         return Integer.parseInt(str.substring(positionOfLastDigit));\n     }\n \n+    private static void setMemoryLimit(long maxMegabytes) {\n+        // Memory-limiting techniques are highly platform-specific.\n+        if (Platform.isLinux()) {\n+            final LibC.Rlimit dataLimit = new LibC.Rlimit();\n+            long maxBytes = maxMegabytes * 1024 * 1024;\n+            dataLimit.rlim_cur = maxBytes;\n+            dataLimit.rlim_max = maxBytes;\n+            // Under Linux \u2265 4.7, we can limit the maximum size of the process's data segment, which includes its\n+            // heap. Note we cannot directly limit its resident set size, see setrlimit(3).\n+            LibC.INSTANCE.setrlimit(LibC.RLIMIT_DATA, dataLimit);\n+        }\n+    }\n+\n+    private static void adjustOutOfMemoryScore(int adjustment) {\n+        Path procFile = Paths.get(\"/proc\", \"self\", \"oom_score_adj\");\n+        try {\n+            Files.write(procFile, String.valueOf(adjustment).getBytes(),\n+                    StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING);\n+        } catch (IOException e) {\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06441b40719af2aa1c369a9e30595d0efab670a"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fcf34d82960467ffa71de5cc1504364bbfe7bfb", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/4fcf34d82960467ffa71de5cc1504364bbfe7bfb", "committedDate": "2021-08-15T23:12:27Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/memory-limit-linux"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a113145981f3b3195fb32be8e8b35d885935674a", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/a113145981f3b3195fb32be8e8b35d885935674a", "committedDate": "2021-08-16T03:36:20Z", "message": "feat(facade): add `--max-data-size` command line option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8089f2ac31aa95d1e8409d523560c63c57a808", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/1a8089f2ac31aa95d1e8409d523560c63c57a808", "committedDate": "2021-08-16T03:37:24Z", "message": "feat(facade): add `--oom-score` command line option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/185a64ea406ae7d5518f65576aa7db0d8ec8362b", "committedDate": "2021-08-16T03:37:52Z", "message": "chore(facade): capitalize for consistency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzMwMzEwNjU1", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#pullrequestreview-730310655", "createdAt": "2021-08-16T04:06:48Z", "commit": {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wOC0xNlQwNDowNjo0OFrOKRTFqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wOC0xNlQwNDowNzoxMVrOKRTF_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTIyNzE3OA==", "bodyText": "FIXME: these are supposed to be test dependencies!", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r689227178", "createdAt": "2021-08-16T04:06:48Z", "author": {"login": "keturn"}, "path": "facades/PC/build.gradle.kts", "diffHunk": "@@ -68,6 +69,16 @@ dependencies {\n \n     // TODO: Consider whether we can move the CR dependency back here from the engine, where it is referenced from the main menu\n     implementation(group = \"org.terasology.crashreporter\", name = \"cr-terasology\", version = \"4.1.0\")\n+\n+    implementation(platform(\"org.junit:junit-bom:5.7.1\")) {\n+        // junit-bom will set version numbers for the other org.junit dependencies.\n+    }\n+    implementation(\"org.junit.jupiter:junit-jupiter-api\")\n+    implementation(\"org.junit.jupiter:junit-jupiter-params\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4OTIyNzI2MA==", "bodyText": "FIXME: docstring", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#discussion_r689227260", "createdAt": "2021-08-16T04:07:11Z", "author": {"login": "keturn"}, "path": "facades/PC/src/main/java/org/terasology/engine/DataSizeConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright 2021 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package org.terasology.engine;\n+\n+import picocli.CommandLine;\n+\n+import java.math.BigDecimal;\n+import java.util.Locale;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class DataSizeConverter implements CommandLine.ITypeConverter<Long> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d647f736f26f5150c085058a988c1b745e441aa", "author": {"user": {"login": "DarkWeird", "name": "Nail Khanipov"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/8d647f736f26f5150c085058a988c1b745e441aa", "committedDate": "2021-08-18T13:51:29Z", "message": "Merge branch 'develop' into feature/memory-limit-linux"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzMyOTAxMDg3", "url": "https://github.com/MovingBlocks/Terasology/pull/4147#pullrequestreview-732901087", "createdAt": "2021-08-18T13:57:51Z", "commit": {"oid": "185a64ea406ae7d5518f65576aa7db0d8ec8362b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9dbc2ed984f01913269621128412b345351422f", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/b9dbc2ed984f01913269621128412b345351422f", "committedDate": "2021-08-19T20:40:22Z", "message": "Merge branch 'develop' into feature/memory-limit-linux"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1443, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}