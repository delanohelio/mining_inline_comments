{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5OTcwMjY0", "number": 4296, "title": "feat(JOML): migrate BlockRegionComponent logic", "bodyText": "Fairly straightforward migration of BlockRegionComponent. along with some thoughts from looking at how the logic works: #4295 . I also need separate PR's in these modules for this API change:\n\n Furnishings\n Health\n IRLCorp\n LightAndShadow\n Machines\n MultiBlock\n Rails\n Smithing\n StructureTemplates\n WoodAndStone\n WorkstationCrafting\n\ngh pr checkout 4296\nfor m in Furnishings Health Smithing WoodAndStone WorkstationCrafting StructureTemplates MultiBlock Machines; do\n    pushd modules/$m\n    git fetch\n    git checkout feature/joml-migrate-blockregion\n    popd\ndone", "createdAt": "2020-12-01T04:40:33Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4296", "merged": true, "mergeCommit": {"oid": "feaca854e704ff49e1265ccb41d2e1ad30201692"}, "closed": true, "closedAt": "2020-12-08T22:34:42Z", "author": {"login": "pollend"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhyXMBgH2gAyNTI5OTcwMjY0OjlhNzlmY2VlYzI1ZGI4YWMwYTkyYjk4NTQ1OTE2YWQxY2E2YzAyMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkR9thAFqTU0NzY4OTcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a79fceec25db8ac0a92b98545916ad1ca6c021a", "author": {"user": {"login": "pollend", "name": "Michael Pollind"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/9a79fceec25db8ac0a92b98545916ad1ca6c021a", "committedDate": "2020-12-01T04:37:19Z", "message": "feat(JOML): migrate blockregion logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1", "author": {"user": {"login": "pollend", "name": "Michael Pollind"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ef84ecc32892433c05e12733e73205e3e8b949d1", "committedDate": "2020-12-02T04:59:54Z", "message": "update getters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e28328f1a53bccab66dae8b04085e772d247c23c", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/e28328f1a53bccab66dae8b04085e772d247c23c", "committedDate": "2020-12-05T22:07:03Z", "message": "remove unused field 'overrideBlockEntities' from BlockRegionComponent (not used in Omega)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab154a2881a13ca47d936ebce8e50db61cbef65b", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ab154a2881a13ca47d936ebce8e50db61cbef65b", "committedDate": "2020-12-05T22:08:02Z", "message": "move JOML conversion outwards"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NjUxNjQ0", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-545651644", "createdAt": "2020-12-05T21:40:25Z", "commit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo0MDoyNVrOIABoYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1OTowMlrOIABzGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5NzYzMg==", "bodyText": "I'd try to push the use of JomlUtils as far outwards as possible and do the computation all in JOML already \ud83e\udd14\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);\n          \n          \n            \n                                Vector3i location = JomlUtil.from(new org.joml.Vector3i(blockRegion.region.center(new Vector3f()), org.joml.RoundingMode.HALF_UP));", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536897632", "createdAt": "2020-12-05T21:40:25Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/entity/BlockEntitySystem.java", "diffHunk": "@@ -102,13 +105,13 @@ public void defaultDropsHandling(CreateBlockDropsEvent event, EntityRef entity,\n                 BlockRegionComponent blockRegion = entity.getComponent(BlockRegionComponent.class);\n                 if (blockComponent.dropBlocksInRegion) {\n                     // loop through all the blocks in this region and drop them\n-                    for (Vector3i location : blockRegion.region) {\n+                    for (Vector3ic location : BlockRegions.iterableInPlace(blockRegion.region)) {\n                         Block blockInWorld = worldProvider.getBlock(location);\n-                        commonDefaultDropsHandling(event, entity, location, blockInWorld.getBlockFamily().getArchetypeBlock());\n+                        commonDefaultDropsHandling(event, entity, JomlUtil.from(location), blockInWorld.getBlockFamily().getArchetypeBlock());\n                     }\n                 } else {\n                     // just drop the ActAsBlock block\n-                    Vector3i location = new Vector3i(blockRegion.region.center(), RoundingMode.HALF_UP);\n+                    Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyNg==", "bodyText": "Does this make sure that the component holds it's own copy of the BlockRegion?", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536899926", "createdAt": "2020-12-05T21:55:54Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/regions/BlockRegionComponent.java", "diffHunk": "@@ -4,20 +4,20 @@\n package org.terasology.world.block.regions;\n \n import org.terasology.entitySystem.Component;\n-import org.terasology.math.Region3i;\n import org.terasology.network.Replicate;\n+import org.terasology.world.block.BlockRegion;\n \n /**\n  */\n public class BlockRegionComponent implements Component {\n     @Replicate\n-    public Region3i region = Region3i.empty();\n+    public BlockRegion region = new BlockRegion();\n     public boolean overrideBlockEntities = true;\n \n     public BlockRegionComponent() {\n     }\n \n-    public BlockRegionComponent(Region3i region) {\n-        this.region = region;\n+    public BlockRegionComponent(BlockRegion region) {\n+        this.region.set(region);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDMxMw==", "bodyText": "This should also work with the in-place variant, shouldn't it? Removing from the map does not store it for later, I'd think ^^\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900313", "createdAt": "2020-12-05T21:58:33Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDM3OA==", "bodyText": "Same there:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900378", "createdAt": "2020-12-05T21:59:02Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n             blockRegionLookup.remove(pos);\n         }\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionDeactivated(BeforeDeactivateComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bcf534f08a80e03f2a9aa4bc84bdc6bc5befbda", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/2bcf534f08a80e03f2a9aa4bc84bdc6bc5befbda", "committedDate": "2020-12-05T22:18:49Z", "message": "add (unrelated) TODO in EntityAwareWorldProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "665880ae5035fadde23d722b78507eafd1325f38", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/665880ae5035fadde23d722b78507eafd1325f38", "committedDate": "2020-12-05T22:43:39Z", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f61dc14df12de2d6fd2b28d9e6fe933dce4e709a", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/f61dc14df12de2d6fd2b28d9e6fe933dce4e709a", "committedDate": "2020-12-05T23:40:55Z", "message": "feat: add BlockRegions.encompassing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "398a90e58fcc514c66b99d1e0928d6792f5ae76c", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/398a90e58fcc514c66b99d1e0928d6792f5ae76c", "committedDate": "2020-12-05T23:41:10Z", "message": "doc: improve docs on BlockRegions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d2ba729bd0eb8554fdd7721c9a4d470548d3f2", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/f4d2ba729bd0eb8554fdd7721c9a4d470548d3f2", "committedDate": "2020-12-05T23:42:07Z", "message": "test: parameterize test for BlockRegions#createFromMinAndMax"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f424810eca8a84fbaa37661d00bb724460a0fe2e", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/f424810eca8a84fbaa37661d00bb724460a0fe2e", "committedDate": "2020-12-06T00:07:07Z", "message": "test: add parameterized tests for BlockRegions#encompassing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b7dfcf95e803d95b7ecda68ba621f3c67f8c810", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/2b7dfcf95e803d95b7ecda68ba621f3c67f8c810", "committedDate": "2020-12-06T12:10:33Z", "message": "test: add test for BlockRegion#center()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc2de1f5c6d10cff9b0f47138e864ac3ccbaa7f", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/9dc2de1f5c6d10cff9b0f47138e864ac3ccbaa7f", "committedDate": "2020-12-06T12:37:00Z", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461", "committedDate": "2020-12-06T12:52:50Z", "message": "test: fix expected center point of empty `new BlockRegion()`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzA1MzI4", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-545705328", "createdAt": "2020-12-06T13:25:09Z", "commit": {"oid": "99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzA1NTA4", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-545705508", "createdAt": "2020-12-06T13:27:14Z", "commit": {"oid": "99c6b80c8f3fd7697cdf40c0eae5e6ed317ee461"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbae62ccb85fecffe21761d53d94486e8c0c398b", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/cbae62ccb85fecffe21761d53d94486e8c0c398b", "committedDate": "2020-12-06T15:06:49Z", "message": "fix: define center() for invalid BlockRegions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzE4ODk0", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-545718894", "createdAt": "2020-12-06T15:41:15Z", "commit": {"oid": "cbae62ccb85fecffe21761d53d94486e8c0c398b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9126f1f6a39c7f95a9cfba16d57b85dcb301d619", "author": {"user": {"login": "skaldarnar", "name": "Tobias Nett"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/9126f1f6a39c7f95a9cfba16d57b85dcb301d619", "committedDate": "2020-12-06T15:56:43Z", "message": "return NaN instead of positive INF for center of invalid region"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af0f5ed977038a7d8924402cd274bc0483fb83e", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/8af0f5ed977038a7d8924402cd274bc0483fb83e", "committedDate": "2020-12-08T21:27:57Z", "message": "Merge branch 'develop' into feature/joml-migrate-BlockRegion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb0cdc78ca6ac639d334f5eae205eb0ed204378", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ccb0cdc78ca6ac639d334f5eae205eb0ed204378", "committedDate": "2020-12-08T22:06:43Z", "message": "feat: use `iterableInPlace` for removing pos\n\nCo-authored-by: Tobias Nett <skaldarnar@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dcc0b9638b966d9febc02c5e67bc9454d6a4573", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/3dcc0b9638b966d9febc02c5e67bc9454d6a4573", "committedDate": "2020-12-08T22:07:00Z", "message": "feat: use `iterableInPlace` for removing pos\n\nCo-authored-by: Tobias Nett <skaldarnar@googlemail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjcyOTAw", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-547672900", "createdAt": "2020-12-08T22:07:10Z", "commit": {"oid": "ccb0cdc78ca6ac639d334f5eae205eb0ed204378"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ec5ab8e98db6388652d370a6de73170179cc64c", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/8ec5ab8e98db6388652d370a6de73170179cc64c", "committedDate": "2020-12-08T22:18:27Z", "message": "fix: use Vector3ic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Njg5NzEx", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#pullrequestreview-547689711", "createdAt": "2020-12-08T22:34:18Z", "commit": {"oid": "8ec5ab8e98db6388652d370a6de73170179cc64c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1350, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}