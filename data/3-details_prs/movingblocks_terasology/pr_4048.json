{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MDQzNjc5", "number": 4048, "title": "feat/nui-extraction branch: Make the game playable again", "bodyText": "Description\nThis pull request depends on and should be integrated into #4017.\nThe code from that branch previously crashed due a type conflict in MouseDevice between the extracted NUI's version of org.terasology.input and the built-in (original) version, as NUI now uses Vector2i from JOML instead of TeraMath (incompatible method definitions).\nI also made some fixes to prevent a crash in NUIManagerInternal due to it querying key bindings that don't exist yet (often when the game is started for the first time).\nIn addition, a serialisation bug relating to the removal of TeraMath serialisers from the codebase has been fixed, by re-adding the serialisers previously removed (as they are no longer in nui-reflect). This fixes the camera behaving incorrectly when a world is loaded for the first time, as well as various other subtle issues I probably overlooked.\nFinally, I've converted the internal browser widgets to use JOML, to be consistent with all of the NUI built-in widgets. I also fixed the engine tests to compile again.\nHow to test\nIn order to test gameplay, you will need to first make some changes to the core modules in the workspace (to get them to compile again). I've tried to patch as many of the omega distribution modules as I can and my code patches for those can all be found in this gist. For the essential core modules though, some pull requests have already been issued which will fix those modules as well.\nThe following modules need to be fixed to test this (as a minimum):\nCore Sample Gameplay\n\nInventory (patch or Terasology/Inventory#23)\nHealth (patch or Terasology/Health#44)\nCoreWorlds (patch or Terasology/CoreWorlds#4)\nCoreRendering (patch or Terasology/CoreRendering#12)\n\nOptionally, you might choose to test with a more complex set of modules (more fixes needed and less tested):\nJosharias Survival\n\nJosharias Survival (patch)\nIRL Corp (patch)\nEventual Skills (patch)\nManual Labor (patch)\nManual Labor Eventual Skills (patch)\nCoreWorlds (patch or Terasology/CoreWorlds#4)\nWorldly Tooltip (patch)\nHunger (patch)\nThirst (patch)\nDurability (patch)\nMachines (patch)\nSubstance Matters (patch)\nHealth (patch or Terasology/Health#44)\nPotential Energy Devices (patch)\nWorkstation (patch)\nIn Game Help (patch)\nBasic Crafting (patch)\nFluid (patch)\nIn Game Help API (patch)\nCoreRendering (patch or Terasology/CoreRendering#12)\nInventory (patch or Terasology/Inventory#23)\nCaves (patch)\nCustom Ore Gen (patch)\n\nGameplay Testing\n\nStart Terasology and create a new World, selecting either the \"Core Gameplay\" (fewer modules) or \"Josharias Survival\" (more modules) template.\nPlay the game as normal. There should not be any additional crashes than were present before.\n\nKnown Issues\n\nThe mouse cursor in the centre of the screen may render slightly incorrectly", "createdAt": "2020-06-13T19:02:53Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4048", "merged": true, "mergeCommit": {"oid": "3771b605cab78567d68593d7f817556f1e72cadc"}, "closed": true, "closedAt": "2020-06-14T00:03:04Z", "author": {"login": "BenjaminAmos"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcq1NA0gH2gAyNDM0MDQzNjc5OmI4Njk4ZjNiZmZlNTViOGExZWM3NzcyZGJhODM4YTVjMDgzMDJjOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcq_ib4AFqTQzMDE3MDc3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8698f3bffe55b8a1ec7772dba838a5c08302c9c", "author": {"user": {"login": "BenjaminAmos", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/b8698f3bffe55b8a1ec7772dba838a5c08302c9c", "committedDate": "2020-06-13T10:50:05Z", "message": "Converted Terasology UI widgets to JOML. Fixed crash on game start.\n\nTemporarily introduced MouseDevice.getMousePosition to fix JOML TeraMath incompatibilities."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTcwNzc4", "url": "https://github.com/MovingBlocks/Terasology/pull/4048#pullrequestreview-430170778", "createdAt": "2020-06-13T21:59:44Z", "commit": {"oid": "b8698f3bffe55b8a1ec7772dba838a5c08302c9c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QyMTo1OTo0NFrOGjZlLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QyMjo0MjowNFrOGjZtwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc3MjQ2MQ==", "bodyText": "Oh, I see. The old getPosition was a TeraMath.Vector2i and this is a joml.Vector2i.\nAnd this method matches both the name and the type of the one in nui-input's MouseDevice. Okay. \ud83d\udc4d", "url": "https://github.com/MovingBlocks/Terasology/pull/4048#discussion_r439772461", "createdAt": "2020-06-13T21:59:44Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/input/lwjgl/LwjglMouseDevice.java", "diffHunk": "@@ -49,6 +50,12 @@ public Vector2i getPosition() {\n         return new Vector2i(Mouse.getX() / this.uiScale, (Display.getHeight() - Mouse.getY()) / this.uiScale);\n     }\n \n+    // TODO: Remove when nui-input is fully integrated\n+    @Override\n+    public org.joml.Vector2i getMousePosition() {\n+        return JomlUtil.from(getPosition());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8698f3bffe55b8a1ec7772dba838a5c08302c9c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc3NDY1Nw==", "bodyText": "I'm worried about this one. If we skip over setting up this up here, when will it get done?\nI'd want to either fix whatever is supposed to set those bindings so it reliably runs before we get here, or move this to a callback or event handler that is called once the bindsManager is all configured.", "url": "https://github.com/MovingBlocks/Terasology/pull/4048#discussion_r439774657", "createdAt": "2020-06-13T22:42:04Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/rendering/nui/internal/NUIManagerInternal.java", "diffHunk": "@@ -145,7 +145,10 @@ public NUIManagerInternal(TerasologyCanvasRenderer renderer, Context context) {\n         TabbingManager.setFocusManager(this);\n \n         // NOTE: Fix for tests\n-        if (bindsManager != null) {\n+        if (bindsManager != null\n+                && bindsManager.getBindsConfig().hasBinds(new SimpleUri(\"engine:tabbingUI\"))\n+                && bindsManager.getBindsConfig().hasBinds(new SimpleUri(\"engine:tabbingModifier\"))\n+                && bindsManager.getBindsConfig().hasBinds(new SimpleUri(\"engine:activate\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8698f3bffe55b8a1ec7772dba838a5c08302c9c"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1469, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}