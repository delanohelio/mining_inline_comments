{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1OTQ3ODM3", "number": 4343, "title": "Fix/transient deps", "bodyText": "This is meant to address the problem described in #4014: unresolved module dependencies when they're not all present as source.\nHow to Test\nSee #4014 for notes on what kind of brokenness we were seeing. The basic test plan is:\n\nStart with nothing in modules/ (neither sources nor jars)\ngroovyw module get JoshariasSurvival without using recurse\nstart a game and make a new JoshariasSurvival world\n\nfrom gradlew game\nfrom the IDE TerasologyPC run config\n\n\n\nYou might also test other modules or game modes with deep dependency trees.\nOutstanding before merging\n\n this branch is based on #4342; merge it or rebase this branch. (The fix doesn't depend on that, but it does speed up testing a bit.)\n does it work? (right now I have it working with JoshariasSurvival and CoreSampleGameplay in modules/, does it work with JS alone and no CSG?)\n why do I have both Workstation-1.1.0.jar and Workstation-1.1.0-SNAPSHOT.jar?\n does it mess up the distribution tasks?\n\nto do later (out of scope for bugfix)\n\nshould we do something similar with the :moduleJars task?\ncan we get rid of RemoteModuleGatherer???", "createdAt": "2020-12-28T06:24:22Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4343", "merged": true, "mergeCommit": {"oid": "8befab34221667074a43a897e88939128a34fff3"}, "closed": true, "closedAt": "2021-01-03T01:34:35Z", "author": {"login": "keturn"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqpQ5UgH2gAyNTQ1OTQ3ODM3OmI4ZDdmMmFhZTgxNjcyM2MyNmM1OTllNTdlYjRjMjBjNDVjNDQzMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdsXSz8AFqTU2MDY2MzY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8d7f2aae816723c26c599e57eb4c20c45c44325", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/b8d7f2aae816723c26c599e57eb4c20c45c44325", "committedDate": "2020-12-28T17:06:37Z", "message": "chore: use short-form copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cfcf10928f3c0e79cb5c1e8fbc78cfe578b79ee", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/5cfcf10928f3c0e79cb5c1e8fbc78cfe578b79ee", "committedDate": "2020-12-28T17:06:37Z", "message": "chore (build): refactor lambda to named function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef739b4c18572fb61e61af6e605289d739f6654d", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ef739b4c18572fb61e61af6e605289d739f6654d", "committedDate": "2020-12-28T17:06:37Z", "message": "fix (build): use gradle to resolve all runtime classpath for facades\n\nThe :moduleClasses task wasn't sufficient to get all the dependencies of those classes on the classpath.\n\nThis replaces it with a gradle Platform which depends on all those module subprojects.\n\nFixes #4014."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a70bdbefdae7ef5ad0e0d47e04ca763c6b482f2", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/2a70bdbefdae7ef5ad0e0d47e04ca763c6b482f2", "committedDate": "2020-12-28T06:15:26Z", "message": "fix (build): use gradle to resolve all runtime classpath for facades\n\nThe :moduleClasses task wasn't sufficient to get all the dependencies of those classes on the classpath.\n\nThis replaces it with a gradle Platform which depends on all those module subprojects.\n\nFixes #4014."}, "afterCommit": {"oid": "ef739b4c18572fb61e61af6e605289d739f6654d", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ef739b4c18572fb61e61af6e605289d739f6654d", "committedDate": "2020-12-28T17:06:37Z", "message": "fix (build): use gradle to resolve all runtime classpath for facades\n\nThe :moduleClasses task wasn't sufficient to get all the dependencies of those classes on the classpath.\n\nThis replaces it with a gradle Platform which depends on all those module subprojects.\n\nFixes #4014."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8214339e905955cba910b1a60027abdd971e4bd", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/e8214339e905955cba910b1a60027abdd971e4bd", "committedDate": "2020-12-28T17:41:25Z", "message": "feat (build): make :modules:clean clean each module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MjYxMzE5", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#pullrequestreview-559261319", "createdAt": "2020-12-28T18:47:24Z", "commit": {"oid": "ef739b4c18572fb61e61af6e605289d739f6654d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f325e70ccde94689336768f683cc996fbe25bb2", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/1f325e70ccde94689336768f683cc996fbe25bb2", "committedDate": "2020-12-28T19:07:52Z", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15b05510567be0359349b730f2b1a3dd522c241", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/c15b05510567be0359349b730f2b1a3dd522c241", "committedDate": "2020-12-29T20:32:18Z", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/1f59aded808e4aedef56a5de5a04734936a771d2", "committedDate": "2021-01-02T20:43:06Z", "message": "Merge remote-tracking branch 'origin/develop' into fix/transient-deps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjU1MjM4", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#pullrequestreview-560655238", "createdAt": "2021-01-02T20:56:29Z", "commit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQyMDo1NjozMFrOINZg9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQyMTowNTowMlrOINZjgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDQzNw==", "bodyText": "Would it be worth adding a quick comment here? I'm not even sure what \"platform\" even means here, although I can figure what the overall meaning is", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920437", "createdAt": "2021-01-02T20:56:30Z", "author": {"login": "Cervator"}, "path": "facades/PC/build.gradle.kts", "diffHunk": "@@ -92,6 +92,8 @@ dependencies {\n \n     // TODO: Consider whether we can move the CR dependency back here from the engine, where it is referenced from the main menu\n     implementation(group = \"org.terasology.crashreporter\", name = \"cr-terasology\", version = \"4.1.0\")\n+\n+    runtimeOnly(platform(project(\":modules\")))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDY3NQ==", "bodyText": "Similarly here I fully expect that this works, but is allowing dependencies not a default state of some sort? That seems odd.", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920675", "createdAt": "2021-01-02T20:59:01Z", "author": {"login": "Cervator"}, "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMDc5Mw==", "bodyText": "I figure this builds the runtime classpath so all the module jars are available to the engine. this can be used to refer to a whole project level in Gradle, so to say?\nThis reminds me of that old idea to make the PC facade have a compile dependency on all the modules, to have them for sure get built when you run the game. Although at the cost of not being able to launch without every single module working, and maybe at a risk to get weird dependencies written into the binaries published to Artifactory.", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550920793", "createdAt": "2021-01-02T21:01:01Z", "author": {"login": "Cervator"}, "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()\n+}\n+\n+dependencies {\n+    // This platform depends on each of its subprojects.\n+    subprojects {\n+        runtime(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkyMTA4OA==", "bodyText": "Again understanding what this does, but cleanPlatform throws me off naming-wise. Is it almost like \"cleanPlatform\" would really be the task name? But since you want :modules:clean to work then the task name just remains \"clean\"\nWould something like cleanAllModules and cleanAllModules.dependsOn(... do the same thing but be clearer in naming?", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#discussion_r550921088", "createdAt": "2021-01-02T21:05:02Z", "author": {"login": "Cervator"}, "path": "modules/build.gradle.kts", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 The Terasology Foundation\n+// SPDX-License-Identifier: Apache-2.0\n+\n+plugins {\n+    `java-platform`\n+}\n+\n+javaPlatform {\n+    allowDependencies()\n+}\n+\n+dependencies {\n+    // This platform depends on each of its subprojects.\n+    subprojects {\n+        runtime(this)\n+    }\n+}\n+\n+// Allows using :modules:clean as a shortcut for running clean in each module.\n+tasks.named(\"clean\").configure {\n+    val cleanPlatform = this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f59aded808e4aedef56a5de5a04734936a771d2"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f383cb13f6c9ecf972c1e3532e24c1aadcb5b08c", "author": {"user": {"login": "keturn", "name": "Kevin Turner"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/f383cb13f6c9ecf972c1e3532e24c1aadcb5b08c", "committedDate": "2021-01-03T00:00:43Z", "message": "chore (build): the dependency on modules is for local dev builds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjYzNjU3", "url": "https://github.com/MovingBlocks/Terasology/pull/4343#pullrequestreview-560663657", "createdAt": "2021-01-03T01:18:16Z", "commit": {"oid": "f383cb13f6c9ecf972c1e3532e24c1aadcb5b08c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1238, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}