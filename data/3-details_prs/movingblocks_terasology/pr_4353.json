{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NjAzNzU5", "number": 4353, "title": "Mark new chunks ready before triggering OnChunkLoaded events.", "bodyText": "Because the OnChunkLoaded event is created in world generation threads, rather than the main thread, it usually executes after processReadyChunk is finished, but occasionally it doesn't. The chunk only becomes readable (i.e. getChunk and getBlock will start working inside its bounds) when chunk.markReady is called, which used to happen at the end of processReadyChunk. This meant that occasionally, the event handler for OnChunkLoaded would not actually be able to read that chunk. This led to issues like that NullPointerException in VoxelWorldSystem and some chunks being invisible, both of which should now be fixed. (A similar issue sometimes still happens sometimes when a world is unloaded: a chunk's OnChunkLoaded event may not run until after the chunk has been unloaded, but that matters less because it's being unloaded anyway.)\nMoving the entirety of processReadyChunk to the main thread would likely make this area less error prone, but I'm a lot less confident that that change wouldn't break anything else. The small change that I have made has the virtue that what happens with the change is pretty much what used to happen already most of the time, so we can be very confident that it makes things more correct.", "createdAt": "2020-12-29T19:18:03Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4353", "merged": true, "mergeCommit": {"oid": "ccb8bae9bf852310738e16684d8ec997385b5832"}, "closed": true, "closedAt": "2020-12-29T20:19:37Z", "author": {"login": "4Denthusiast"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdq_gNHgH2gAyNTQ2NjAzNzU5Ojk4N2VkYTRiNWRiYTI2ZTg1NDE0NmYwZmVkNTlkMDYyZjlhZGM2NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrAbvqgFqTU1OTY4MjcxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "987eda4b5dba26e854146f0fed59d062f9adc665", "author": {"user": {"login": "4Denthusiast", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/987eda4b5dba26e854146f0fed59d062f9adc665", "committedDate": "2020-12-29T19:01:15Z", "message": "Mark new chunks ready before triggering OnChunkLoaded events."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjcxMjAz", "url": "https://github.com/MovingBlocks/Terasology/pull/4353#pullrequestreview-559671203", "createdAt": "2020-12-29T19:29:31Z", "commit": {"oid": "987eda4b5dba26e854146f0fed59d062f9adc665"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxOToyOTozMVrOIMWddg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxOTozODoxMVrOIMWmMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgyMTgxNA==", "bodyText": "You've moved the call to the worldEntity until after markReady, but what of the listener.onChunkReady before it? Should onChunkReady also be called only after the chunk is marked ready?", "url": "https://github.com/MovingBlocks/Terasology/pull/4353#discussion_r549821814", "createdAt": "2020-12-29T19:29:31Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/world/chunks/remoteChunkProvider/RemoteChunkProvider.java", "diffHunk": "@@ -81,12 +81,12 @@ public RemoteChunkProvider(BlockManager blockManager, LocalPlayer localPlayer) {\n                 ))\n                 .addStage(ChunkTaskProvider.create(\"\", chunk -> {\n                     listener.onChunkReady(chunk.getPosition());\n-                    worldEntity.send(new OnChunkLoaded(chunk.getPosition()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987eda4b5dba26e854146f0fed59d062f9adc665"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgyNDA1MQ==", "bodyText": "This one took a little more reading than RemoteChunkProvider because of the number of lines in this function, but I think I believe this. We should mark the chunk as ready before sending any of those events to blocks and entities in the chunk, or the loaded/generated events about the chunk itself.\nThat wouldn't be the case if something operating on that collection of event mappings is a precondition for chunk readiness -- but I don't see any evidence of that here. It just fires off a bunch of events, there are no conditions on any of them being handled any particular way.", "url": "https://github.com/MovingBlocks/Terasology/pull/4353#discussion_r549824051", "createdAt": "2020-12-29T19:38:11Z", "author": {"login": "keturn"}, "path": "engine/src/main/java/org/terasology/world/chunks/localChunkProvider/LocalChunkProvider.java", "diffHunk": "@@ -197,6 +197,7 @@ private void processReadyChunk(final Chunk chunk) {\n             return; // TODO move it in pipeline;\n         }\n         chunkCache.put(chunk.getPosition(), chunk);\n+        chunk.markReady();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987eda4b5dba26e854146f0fed59d062f9adc665"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71dba61f2774e1a59e4cc42c6deba5d6966e517d", "author": {"user": {"login": "4Denthusiast", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/71dba61f2774e1a59e4cc42c6deba5d6966e517d", "committedDate": "2020-12-29T20:02:09Z", "message": "Run ChunkReadyListeners after the chunk is ready too."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjgyNzE1", "url": "https://github.com/MovingBlocks/Terasology/pull/4353#pullrequestreview-559682715", "createdAt": "2020-12-29T20:06:17Z", "commit": {"oid": "71dba61f2774e1a59e4cc42c6deba5d6966e517d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1245, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}