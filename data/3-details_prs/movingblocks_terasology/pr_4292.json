{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTY1MDQx", "number": 4292, "title": "fix: Time out of sync for players in multiplayer", "bodyText": "Contains\nFix proposal for Issue #3670 .\nMost of the code comes from @godfather2 's pull request #3890 , closed on 29 August 2020, which attempted to fix time synchronisation when connecting with another client, and when changing time in Debug mode.\nUsing setWorldTime command on either client should now update time on both clients.\nHow to test\n\nStart a local multiplayer game\nStart up another client\nWait 5 minutes or so before connecting.\n-> The second client should now have its time (almost) synchronized with the first one (see next section).\nChange time on either client, using arrow keys in Debug mode.\n-> Both clients should now have their times updated.\nUse setWorldTime 0.9 on either client.\n-> Time should now be set to 0.9 on both clients.\n\nOutstanding before merging\nAs opposed to the description of the issue, time is already (mostly) synchronized when connecting to a multiplayer game.\nAs explained in PR #3890 , the host's time is sent at the beginning of the connection process, which causes a delay of about 0.03 day (or more, depending on the capability of the computer used) when the new client eventually connects.", "createdAt": "2020-11-30T13:53:30Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4292", "merged": true, "mergeCommit": {"oid": "ecba0ab7df642af73f46fc62d58ee2e298a82d58"}, "closed": true, "closedAt": "2020-12-01T17:54:47Z", "author": {"login": "PaulBeslin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf7SwBAH2gAyNTI5NTY1MDQxOjJjZTE5MjJlNzkwODA0NTFlNDkyN2RmZjc4ZjZiYTVhZGJlNjQ5Yzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh9wMRgFqTU0MjE1NDU0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ce1922e79080451e4927dff78f6ba5adbe649c8", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/2ce1922e79080451e4927dff78f6ba5adbe649c8", "committedDate": "2020-11-25T09:53:46Z", "message": "Adding godfather2's PR for issue 'Time out of sync for players in multiplayer #3890'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9486871f45792e738410d2029edb2b114efcf359", "author": {"user": {"login": "Gwohyanne", "name": "JoanneD"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/9486871f45792e738410d2029edb2b114efcf359", "committedDate": "2020-11-25T10:01:23Z", "message": "Modifications PR r\u00e9fus\u00e9e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdd97e9fab02fb74282fd574698ec551fc15d74d", "author": {"user": {"login": "Gwohyanne", "name": "JoanneD"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/bdd97e9fab02fb74282fd574698ec551fc15d74d", "committedDate": "2020-11-25T10:04:34Z", "message": "Merge branch 'develop' of https://github.com/PaulBeslin/Terasology.git\ninto develop\n\nConflicts:\n\tengine/src/main/java/org/terasology/logic/players/DebugControlSystem.java\n\tengine/src/main/java/org/terasology/logic/time/TimeClientSystem.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0a0f9ecde9e7329aadea7933cee72de20093b2", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/cc0a0f9ecde9e7329aadea7933cee72de20093b2", "committedDate": "2020-11-29T13:36:46Z", "message": "Removed changes in TimeClientSystem, added Javadoc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1930fc8f3d8858dacbafedfbdca9d1f0343beabc", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/1930fc8f3d8858dacbafedfbdca9d1f0343beabc", "committedDate": "2020-11-29T14:11:54Z", "message": "Added Javadoc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9406188fd2d00247f4a17af434f07f6973b5913a", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/9406188fd2d00247f4a17af434f07f6973b5913a", "committedDate": "2020-11-29T14:12:13Z", "message": "Merge branch 'develop' of https://github.com/PaulBeslin/Terasology into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279", "author": {"user": {"login": "jdrueckert", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/c18de1539fae2400227d39ffe07083b29350a279", "committedDate": "2020-11-30T20:48:41Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzE1MzQy", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#pullrequestreview-541315342", "createdAt": "2020-11-30T21:38:14Z", "commit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTozODoxNFrOH8O2ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTo0MDoxMFrOH8O6ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxOTk0Ng==", "bodyText": "Please use the new license header at least in completely new files (ideally update in existing files if not updated yet).\n// Copyright 2020 The Terasology Foundation\n// SPDX-License-Identifier: Apache-2.0", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532919946", "createdAt": "2020-11-30T21:38:14Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/WorldtimeResyncSystem.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDA0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920042", "createdAt": "2020-11-30T21:38:27Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/WorldtimeResyncSystem.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.logic.players;\n+\n+import org.terasology.entitySystem.entity.EntityRef;\n+import org.terasology.entitySystem.event.ReceiveEvent;\n+import org.terasology.entitySystem.systems.BaseComponentSystem;\n+import org.terasology.entitySystem.systems.RegisterMode;\n+import org.terasology.entitySystem.systems.RegisterSystem;\n+import org.terasology.logic.time.WorldtimeResyncEvent;\n+import org.terasology.network.ClientComponent;\n+import org.terasology.registry.In;\n+import org.terasology.world.WorldProvider;\n+\n+@RegisterSystem(RegisterMode.CLIENT)\n+public class WorldtimeResyncSystem extends BaseComponentSystem {\n+\n+    @In\n+    private WorldProvider world;\n+\n+    @ReceiveEvent(components = ClientComponent.class)\n+    public void resyncWorldTime(WorldtimeResyncEvent event, EntityRef entity) {\n+        ClientComponent client = entity.getComponent(ClientComponent.class);\n+        if (client.local) {\n+            world.getTime().setDays(event.days);\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDE3MA==", "bodyText": "see above", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920170", "createdAt": "2020-11-30T21:38:40Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/event/SynchronizeClientTimeSystem.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDI1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920254", "createdAt": "2020-11-30T21:38:48Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/event/SynchronizeClientTimeSystem.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.logic.players.event;\n+\n+import org.terasology.entitySystem.entity.EntityManager;\n+import org.terasology.entitySystem.entity.EntityRef;\n+import org.terasology.entitySystem.event.ReceiveEvent;\n+import org.terasology.entitySystem.systems.BaseComponentSystem;\n+import org.terasology.entitySystem.systems.RegisterMode;\n+import org.terasology.entitySystem.systems.RegisterSystem;\n+import org.terasology.logic.time.WorldtimeResyncEvent;\n+import org.terasology.network.ClientComponent;\n+import org.terasology.registry.In;\n+\n+@RegisterSystem(RegisterMode.AUTHORITY)\n+public class SynchronizeClientTimeSystem extends BaseComponentSystem {\n+\n+    @In\n+    EntityManager entityManager;\n+\n+    @ReceiveEvent\n+    public void findClients(WorldtimeResetEvent event, EntityRef entity) {\n+        if (entityManager.getCountOfEntitiesWith(ClientComponent.class) != 0) {\n+            Iterable<EntityRef> clients = entityManager.getEntitiesWith(ClientComponent.class);\n+            for (EntityRef client : clients) {\n+                client.send(new WorldtimeResyncEvent(event.days));\n+            }\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDY5NA==", "bodyText": "see above", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920694", "createdAt": "2020-11-30T21:39:43Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/event/WorldtimeResetEvent.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDc1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920759", "createdAt": "2020-11-30T21:39:50Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/players/event/WorldtimeResetEvent.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.logic.players.event;\n+\n+import org.terasology.entitySystem.event.Event;\n+import org.terasology.network.ServerEvent;\n+\n+@ServerEvent\n+public class WorldtimeResetEvent implements Event {\n+\n+    public float days;\n+\n+    public WorldtimeResetEvent() {\n+    }\n+\n+    public WorldtimeResetEvent(float days) {\n+        this.days = days;\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDg3OA==", "bodyText": "see above", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920878", "createdAt": "2020-11-30T21:40:02Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/time/WorldtimeResyncEvent.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMDkzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#discussion_r532920932", "createdAt": "2020-11-30T21:40:10Z", "author": {"login": "jdrueckert"}, "path": "engine/src/main/java/org/terasology/logic/time/WorldtimeResyncEvent.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 MovingBlocks\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.terasology.logic.time;\n+\n+import org.terasology.entitySystem.event.Event;\n+import org.terasology.network.OwnerEvent;\n+\n+@OwnerEvent\n+public class WorldtimeResyncEvent implements Event {\n+    public float days;\n+\n+    public WorldtimeResyncEvent() {\n+    }\n+\n+    public WorldtimeResyncEvent(float days) {\n+        this.days = days;\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18de1539fae2400227d39ffe07083b29350a279"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c082735cdacb08f2f31cfe382be392013cee395f", "author": {"user": {"login": "PaulBeslin", "name": null}}, "url": "https://github.com/MovingBlocks/Terasology/commit/c082735cdacb08f2f31cfe382be392013cee395f", "committedDate": "2020-12-01T09:17:59Z", "message": "Apply suggestions from code review\r\n\r\nCorrected end of files.\n\nCo-authored-by: jdrueckert <jd.rueckert@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "149ce10d0a988dc979ca292d5b069082bae12876", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/149ce10d0a988dc979ca292d5b069082bae12876", "committedDate": "2020-12-01T09:41:08Z", "message": "Corrected license headers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fbcc664b87cff5cd4c374cde963ffac24a6ce4e", "author": {"user": null}, "url": "https://github.com/MovingBlocks/Terasology/commit/6fbcc664b87cff5cd4c374cde963ffac24a6ce4e", "committedDate": "2020-12-01T09:43:06Z", "message": "Merge branch 'develop' of https://github.com/PaulBeslin/Terasology into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTU0NTQy", "url": "https://github.com/MovingBlocks/Terasology/pull/4292#pullrequestreview-542154542", "createdAt": "2020-12-01T17:53:35Z", "commit": {"oid": "6fbcc664b87cff5cd4c374cde963ffac24a6ce4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1342, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}