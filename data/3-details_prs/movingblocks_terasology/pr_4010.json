{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjE4MjI1", "number": 4010, "title": "feat: Improve block placement of ceiling-supporting family", "bodyText": "This PR improves the block placement behavior of the CeilingSupportingHorizontalFamily\nPreviously the only way to place blocks upside down, using this block family, was to attach them to a BOTTOM side. This PR makes it possible to achieve the same thing, targeting horizontal sides.\nThis prevents the player from having to build a temporary support structure to simply have a ceiling available, to use for the placement of a new block.\nUpside down block placement, is done if any of these conditions are met:\n\nthe target side is a BOTTOM side\nthe target side is horizontal (FRONT, BACK, LEFT, RIGHT) and the player targeted the upper half of the side when placing the block\n\nTest\nAssign the above-mentioned block family to a furnace by adding the following line to the furnace.block json file:\n\"family\": \"ceilingSupportingHorizontal\",\nAdd furnaces to your inventory using the following command:\ngive furnace 10\nAttach them to different block sides and verify that the placement behaves as described above.", "createdAt": "2020-05-31T14:16:11Z", "url": "https://github.com/MovingBlocks/Terasology/pull/4010", "merged": true, "mergeCommit": {"oid": "c5a2d2d95e5a740ad0c818d6945dadc6b6ff8895"}, "closed": true, "closedAt": "2020-06-01T14:35:13Z", "author": {"login": "kBlaszczyk"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmt_64gH2gAyNDI1NjE4MjI1OmVhNTg4M2Y4MjNlNmVhMmM5NTgzZDFlMTQxMDI1NDFjZGJjMzMyNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnBNeSgFqTQyMTg5NDI0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "author": {"user": {"login": "kBlaszczyk", "name": "Kevin Blaszczyk"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ea5883f823e6ea2c9583d1e14102541cdbc33269", "committedDate": "2020-05-31T16:10:45Z", "message": "Improve block placement of CeilingSupportingHorizontalFamily\n\nPreviously the only way to place blocks upside down, using the\nCeilingSupportingHorizontalFamily, was to attach them to a BOTTOM\nside. This commit makes it possible to achieve the same thing,\ntargeting horizontal sides."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "729265e42169b2be4f34185bbe29380a872b787f", "author": {"user": {"login": "kBlaszczyk", "name": "Kevin Blaszczyk"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/729265e42169b2be4f34185bbe29380a872b787f", "committedDate": "2020-05-31T13:56:59Z", "message": "Improve block placement of CeilingSupportingHorizontalFamily\n\nPreviously the only way to place blocks upside down, using the\nCeilingSupportingHorizontalFamily, was to attach them to a BOTTOM\nside. This commit makes it possible to achieve the same thing,\ntargeting horizontal sides."}, "afterCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269", "author": {"user": {"login": "kBlaszczyk", "name": "Kevin Blaszczyk"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/ea5883f823e6ea2c9583d1e14102541cdbc33269", "committedDate": "2020-05-31T16:10:45Z", "message": "Improve block placement of CeilingSupportingHorizontalFamily\n\nPreviously the only way to place blocks upside down, using the\nCeilingSupportingHorizontalFamily, was to attach them to a BOTTOM\nside. This commit makes it possible to achieve the same thing,\ntargeting horizontal sides."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNzkxNzQw", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#pullrequestreview-421791740", "createdAt": "2020-06-01T12:06:04Z", "commit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMjowNjowNFrOGdIKzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMjoxMToyNVrOGdITPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTcyNw==", "bodyText": "Instead of declaring mainSide and then mutating the value you could do the check first and just do a single-time assignment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (upsideDownPlacement) {\n          \n          \n            \n                        mainSide = Side.BOTTOM;\n          \n          \n            \n                    }\n          \n          \n            \n                    final Side mainSide = upsideDownPlacement ? Side.BOTTOM : Side.TOP;", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433195727", "createdAt": "2020-06-01T12:06:04Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/family/CeilingSupportingHorizontalFamily.java", "diffHunk": "@@ -122,13 +122,16 @@ private Block transformBlock(\n \n     @Override\n     public Block getBlockForPlacement(BlockPlacementData data) {\n-        Side blockDirection = Side.inDirection(-data.viewingDirection.x(), 0, -data.viewingDirection.z());\n+        Side mainSide = Side.TOP;\n \n-        if (data.attachmentSide == Side.BOTTOM) {\n-            return blocks.get(ExtendedSide.getExtendedSideFor(Side.BOTTOM, blockDirection));\n-        } else {\n-            return blocks.get(ExtendedSide.getExtendedSideFor(Side.TOP, blockDirection));\n+        boolean upsideDownPlacement = data.attachmentSide == Side.BOTTOM\n+                || data.attachmentSide != Side.TOP && data.relativeAttachmentPosition.y() > 0.5;\n+        if (upsideDownPlacement) {\n+            mainSide = Side.BOTTOM;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTc0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Side mainSide = Side.TOP;", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433195749", "createdAt": "2020-06-01T12:06:09Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/family/CeilingSupportingHorizontalFamily.java", "diffHunk": "@@ -122,13 +122,16 @@ private Block transformBlock(\n \n     @Override\n     public Block getBlockForPlacement(BlockPlacementData data) {\n-        Side blockDirection = Side.inDirection(-data.viewingDirection.x(), 0, -data.viewingDirection.z());\n+        Side mainSide = Side.TOP;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NjYzMg==", "bodyText": "This assumes a cubic block, right? I'm totally fine with that, but maybe we should mention that in the doc comment?", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433196632", "createdAt": "2020-06-01T12:08:20Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -112,6 +121,28 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         }\n     }\n \n+    /**\n+     * Returns the position at which the block side was hit, relative to the side.\n+     * <p/>\n+     * Example: The front side was hit right in the center.\n+     * The result will be (0.5, 0.5), representing the relative hit position on the side's surface.\n+     * @param hitPosition the hit position\n+     * @param blockPosition the block position relative to its center (block (0, 0, 0) has block position (0.5, 0.5, 0.5))\n+     * @return the 2D hit position relative to the side that was hit\n+     */\n+    private Vector2f getSideHitPosition(Vector3f hitPosition, Vector3f blockPosition) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NzEyNg==", "bodyText": "I'm wondering whether we have convenience for that in TeraMath....", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433197126", "createdAt": "2020-06-01T12:09:39Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -112,6 +121,28 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         }\n     }\n \n+    /**\n+     * Returns the position at which the block side was hit, relative to the side.\n+     * <p/>\n+     * Example: The front side was hit right in the center.\n+     * The result will be (0.5, 0.5), representing the relative hit position on the side's surface.\n+     * @param hitPosition the hit position\n+     * @param blockPosition the block position relative to its center (block (0, 0, 0) has block position (0.5, 0.5, 0.5))\n+     * @return the 2D hit position relative to the side that was hit\n+     */\n+    private Vector2f getSideHitPosition(Vector3f hitPosition, Vector3f blockPosition) {\n+        float epsilon = 0.0001f;\n+        Vector3f relativeHitPosition = new Vector3f(hitPosition).sub(blockPosition);\n+\n+        if (Math.abs(relativeHitPosition.x) > 0.5f - epsilon) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5Nzg4Nw==", "bodyText": "What about moving the null check into getSideHitPosition?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Vector2f relativePlacementPosition;\n          \n          \n            \n                    if (targetPosition != null) {\n          \n          \n            \n                        relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);\n          \n          \n            \n                    } else {\n          \n          \n            \n                        relativePlacementPosition = new Vector2f();\n          \n          \n            \n                    }\n          \n          \n            \n                    Vector2f relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#discussion_r433197887", "createdAt": "2020-06-01T12:11:25Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/items/BlockItemSystem.java", "diffHunk": "@@ -90,8 +91,16 @@ public void onPlaceBlock(ActivateEvent event, EntityRef item) {\n         Vector3i placementPos = new Vector3i(targetBlock);\n         placementPos.add(surfaceSide.getVector3i());\n \n+        Vector3f targetPosition = event.getTargetLocation();\n+        Vector2f relativePlacementPosition;\n+        if (targetPosition != null) {\n+            relativePlacementPosition = getSideHitPosition(event.getHitPosition(), targetPosition);\n+        } else {\n+            relativePlacementPosition = new Vector2f();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea5883f823e6ea2c9583d1e14102541cdbc33269"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74942f08c94ea63a20a124ef5964bacdd3044ba3", "author": {"user": {"login": "kBlaszczyk", "name": "Kevin Blaszczyk"}}, "url": "https://github.com/MovingBlocks/Terasology/commit/74942f08c94ea63a20a124ef5964bacdd3044ba3", "committedDate": "2020-06-01T13:14:34Z", "message": "Refactor the changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxODk0MjQ5", "url": "https://github.com/MovingBlocks/Terasology/pull/4010#pullrequestreview-421894249", "createdAt": "2020-06-01T14:33:45Z", "commit": {"oid": "74942f08c94ea63a20a124ef5964bacdd3044ba3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1632, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}