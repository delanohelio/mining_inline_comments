{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5OTcwMjY0", "number": 4296, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo0MDoyNVrOFBUrqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1OTowMlrOFBU1ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2OTMxNzUyOnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/org/terasology/world/block/entity/BlockEntitySystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo0MDoyNVrOIABoYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo0MDoyNVrOIABoYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5NzYzMg==", "bodyText": "I'd try to push the use of JomlUtils as far outwards as possible and do the computation all in JOML already \ud83e\udd14\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);\n          \n          \n            \n                                Vector3i location = JomlUtil.from(new org.joml.Vector3i(blockRegion.region.center(new Vector3f()), org.joml.RoundingMode.HALF_UP));", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536897632", "createdAt": "2020-12-05T21:40:25Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/entity/BlockEntitySystem.java", "diffHunk": "@@ -102,13 +105,13 @@ public void defaultDropsHandling(CreateBlockDropsEvent event, EntityRef entity,\n                 BlockRegionComponent blockRegion = entity.getComponent(BlockRegionComponent.class);\n                 if (blockComponent.dropBlocksInRegion) {\n                     // loop through all the blocks in this region and drop them\n-                    for (Vector3i location : blockRegion.region) {\n+                    for (Vector3ic location : BlockRegions.iterableInPlace(blockRegion.region)) {\n                         Block blockInWorld = worldProvider.getBlock(location);\n-                        commonDefaultDropsHandling(event, entity, location, blockInWorld.getBlockFamily().getArchetypeBlock());\n+                        commonDefaultDropsHandling(event, entity, JomlUtil.from(location), blockInWorld.getBlockFamily().getArchetypeBlock());\n                     }\n                 } else {\n                     // just drop the ActAsBlock block\n-                    Vector3i location = new Vector3i(blockRegion.region.center(), RoundingMode.HALF_UP);\n+                    Vector3i location = new Vector3i(JomlUtil.from(blockRegion.region.center(new Vector3f())), RoundingMode.HALF_UP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2OTMzODMzOnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/org/terasology/world/block/regions/BlockRegionComponent.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1NTo1NFrOIABxVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1NTo1NFrOIABxVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjg5OTkyNg==", "bodyText": "Does this make sure that the component holds it's own copy of the BlockRegion?", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536899926", "createdAt": "2020-12-05T21:55:54Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/block/regions/BlockRegionComponent.java", "diffHunk": "@@ -4,20 +4,20 @@\n package org.terasology.world.block.regions;\n \n import org.terasology.entitySystem.Component;\n-import org.terasology.math.Region3i;\n import org.terasology.network.Replicate;\n+import org.terasology.world.block.BlockRegion;\n \n /**\n  */\n public class BlockRegionComponent implements Component {\n     @Replicate\n-    public Region3i region = Region3i.empty();\n+    public BlockRegion region = new BlockRegion();\n     public boolean overrideBlockEntities = true;\n \n     public BlockRegionComponent() {\n     }\n \n-    public BlockRegionComponent(Region3i region) {\n-        this.region = region;\n+    public BlockRegionComponent(BlockRegion region) {\n+        this.region.set(region);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2OTM0MTg3OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1ODozM1rOIABy2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1ODozM1rOIABy2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDMxMw==", "bodyText": "This should also work with the in-place variant, shouldn't it? Removing from the map does not store it for later, I'd think ^^\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900313", "createdAt": "2020-12-05T21:58:33Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2OTM0MjQ1OnYy", "diffSide": "RIGHT", "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1OTowMlrOIABzGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQyMTo1OTowMlrOIABzGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkwMDM3OA==", "bodyText": "Same there:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n          \n          \n            \n                    for (org.joml.Vector3i pos : BlockRegions.iterableInPlace(oldRegion)) {", "url": "https://github.com/MovingBlocks/Terasology/pull/4296#discussion_r536900378", "createdAt": "2020-12-05T21:59:02Z", "author": {"login": "skaldarnar"}, "path": "engine/src/main/java/org/terasology/world/internal/EntityAwareWorldProvider.java", "diffHunk": "@@ -474,28 +475,28 @@ public void onDeactivateBlock(BeforeDeactivateComponent event, EntityRef entity)\n     public void onBlockRegionActivated(OnActivatedComponent event, EntityRef entity) {\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionChanged(OnChangedComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {\n             blockRegionLookup.remove(pos);\n         }\n         BlockRegionComponent regionComp = entity.getComponent(BlockRegionComponent.class);\n         blockRegions.put(entity, regionComp.region);\n-        for (Vector3i pos : regionComp.region) {\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(regionComp.region)) {\n             blockRegionLookup.put(pos, entity);\n         }\n     }\n \n     @ReceiveEvent(components = {BlockRegionComponent.class})\n     public void onBlockRegionDeactivated(BeforeDeactivateComponent event, EntityRef entity) {\n-        Region3i oldRegion = blockRegions.get(entity);\n-        for (Vector3i pos : oldRegion) {\n+        BlockRegion oldRegion = blockRegions.get(entity);\n+        for (org.joml.Vector3i pos : BlockRegions.iterable(oldRegion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef84ecc32892433c05e12733e73205e3e8b949d1"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 303, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}