{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDc5Mjg1", "number": 16, "title": "Add foreign keys after loading data, use multi-column hash keys", "bodyText": "This change adds 2 features to TPCC:\n\nDefer the foreign key checks until after the loading is done.\nFor the primary keys involving Warehouse Id and District Id, we  create the hash key with both the warehouse id and district id.\n\nCloses #13 #15", "createdAt": "2020-05-08T23:57:12Z", "url": "https://github.com/yugabyte/tpcc/pull/16", "merged": true, "mergeCommit": {"oid": "17eeb4bde50206f7bc383f8251a5b1d8142d2eef"}, "closed": true, "closedAt": "2020-05-19T22:23:46Z", "author": {"login": "psudheer21"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfaz1agH2gAyNDE1NDc5Mjg1OjBmYmJlZDg0NGM4MjE2NmZmYWUxMTVlZWVjNzRmZjRhMzk3NDc1NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci8EZkgH2gAyNDE1NDc5Mjg1OjVkN2IyMDVjNDAxNWU3ZTM4OTQxMzQ5M2JhZWM4ODZlZjRkMWQ4OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0fbbed844c82166ffae115eeec74ff4a3974754f", "author": {"user": {"login": "psudheer21", "name": "Sudheer Ponnemkunnath Rammohan"}}, "url": "https://github.com/yugabyte/tpcc/commit/0fbbed844c82166ffae115eeec74ff4a3974754f", "committedDate": "2020-05-08T23:51:53Z", "message": "Add Deferred forreign key checks.\n\nReviewers:\nNeha, Karthik"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0", "author": {"user": {"login": "psudheer21", "name": "Sudheer Ponnemkunnath Rammohan"}}, "url": "https://github.com/yugabyte/tpcc/commit/993a1568d02ddd247724e4edc7bea51914dfcae0", "committedDate": "2020-05-08T23:52:37Z", "message": "USing WarehouseId and DistrictId for partitioning.\n\nReviewers:\nNeha, Karthik"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzAyMTU2", "url": "https://github.com/yugabyte/tpcc/pull/16#pullrequestreview-408702156", "createdAt": "2020-05-10T03:57:48Z", "commit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMzo1Nzo0OFrOGTAQqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwNDowMDozNVrOGTARYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDM5Mw==", "bodyText": "Do we need this log line?", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580393", "createdAt": "2020-05-10T03:57:48Z", "author": {"login": "rkarthik007"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -118,10 +126,30 @@ public void load(Connection conn) throws SQLException {\n \n                     // ORDERS\n                     loadOrders(conn, w_id, TPCCConfig.configDistPerWhse, TPCCConfig.configCustPerDist);\n+\n+                    warehouseLatch.countDown();\n                 }\n             };\n             threads.add(t);\n         } // FOR\n+\n+        if (workConf.getDeferConstraintChecks()) {\n+            threads.add(new LoaderThread() {\n+                @Override\n+                public void load(Connection conn) throws SQLException {\n+                    try {\n+                        warehouseLatch.await();\n+                    } catch (InterruptedException ex) {\n+                        ex.printStackTrace();\n+                        throw new RuntimeException(ex);\n+                    }\n+                    long startTime = System.nanoTime();\n+                    EnableForeignKeyConstraints(conn);\n+                    LOG.info(\"The total Time for enabling foreign keys \" + (System.nanoTime() - startTime) / 1000 / 1000 / 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDQyMw==", "bodyText": "Can we add comments on top of these table DDL changes so we know why we do this?", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580423", "createdAt": "2020-05-10T03:58:31Z", "author": {"login": "rkarthik007"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -12,15 +12,15 @@ CREATE TABLE order_line (\n   ol_supply_w_id int NOT NULL,\n   ol_quantity decimal(2,0) NOT NULL,\n   ol_dist_info char(24) NOT NULL,\n-  PRIMARY KEY (ol_w_id,ol_d_id,ol_o_id,ol_number)\n+  PRIMARY KEY ((ol_w_id,ol_d_id) hash,ol_o_id,ol_number)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDQ2NA==", "bodyText": "Comments please.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580464", "createdAt": "2020-05-10T03:58:55Z", "author": {"login": "rkarthik007"}, "path": "src/com/oltpbenchmark/DBWorkload.java", "diffHunk": "@@ -237,6 +237,12 @@ public static void main(String[] args) throws Exception {\n                 // Nothing to do here !\n             }\n \n+            try {\n+              wrkld.setDeferConstraintChecks(xmlConfig.getBoolean(\"deferConstraintChecks\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDU3OQ==", "bodyText": "Can we add a comment block here about the fact that all foreign key constraints are now loaded as deferred constraints?\nAlso, can these be loaded as non-deferred constraints? Would be good to call out those details here. Otherwise, someone looking at the schema file would think there are no FKs.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580579", "createdAt": "2020-05-10T04:00:35Z", "author": {"login": "rkarthik007"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -144,20 +144,3 @@ CREATE TABLE warehouse (\n --add constraints and indexes\n CREATE INDEX idx_customer_name ON customer (c_w_id,c_d_id,c_last,c_first);\n CREATE INDEX idx_order ON oorder (o_w_id,o_d_id,o_c_id,o_id);\n--- tpcc-mysql create two indexes for the foreign key constraints, Is it really necessary?\n--- CREATE INDEX FKEY_STOCK_2 ON STOCK (S_I_ID);\n--- CREATE INDEX FKEY_ORDER_LINE_2 ON ORDER_LINE (OL_SUPPLY_W_ID,OL_I_ID);\n-\n---add 'ON DELETE CASCADE'  to clear table work correctly\n-\n-ALTER TABLE district  ADD CONSTRAINT fkey_district_1 FOREIGN KEY(d_w_id) REFERENCES warehouse(w_id) ON DELETE CASCADE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd6c175a8f57770a9e0be9c204036bfcf0bd83d", "author": {"user": {"login": "psudheer21", "name": "Sudheer Ponnemkunnath Rammohan"}}, "url": "https://github.com/yugabyte/tpcc/commit/4bd6c175a8f57770a9e0be9c204036bfcf0bd83d", "committedDate": "2020-05-11T19:44:08Z", "message": "Added comments for the new features added in TPC-C."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NDczMDY4", "url": "https://github.com/yugabyte/tpcc/pull/16#pullrequestreview-409473068", "createdAt": "2020-05-11T19:40:02Z", "commit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxOTo0MDowMlrOGTqmzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxOTo1MTowOFrOGTq9gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDE5MQ==", "bodyText": "Let's not use the term \"deferred constraints\" since that has a different meaning in postgresql and YSQL. Let's use setForeignKeysAfterLoad instead.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423274191", "createdAt": "2020-05-11T19:40:02Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/DBWorkload.java", "diffHunk": "@@ -237,6 +237,12 @@ public static void main(String[] args) throws Exception {\n                 // Nothing to do here !\n             }\n \n+            try {\n+              wrkld.setDeferConstraintChecks(xmlConfig.getBoolean(\"deferConstraintChecks\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDk4OA==", "bodyText": "We can skip this log since this is not a time consuming operation.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423274988", "createdAt": "2020-05-11T19:41:36Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -67,19 +69,25 @@ public TPCCLoader(TPCCBenchmark benchmark) {\n         }\n     }\n \n+    private boolean deferConstraintChecks;\n     private int numWarehouses = 0;\n     private static final int FIRST_UNPROCESSED_O_ID = 2101;\n \n     @Override\n     public List<LoaderThread> createLoaderThreads() throws SQLException {\n         List<LoaderThread> threads = new ArrayList<LoaderThread>();\n         final CountDownLatch itemLatch = new CountDownLatch(1);\n+        final CountDownLatch warehouseLatch = new CountDownLatch(numWarehouses);\n \n         // ITEM\n         // This will be invoked first and executed in a single thread.\n         threads.add(new LoaderThread() {\n             @Override\n             public void load(Connection conn) throws SQLException {\n+                if (!workConf.getDeferConstraintChecks()) {\n+                    EnableForeignKeyConstraints(conn);\n+                    LOG.info(\"The total Time for enabling foreign keys \" + (System.nanoTime() - startTime) / 1000 / 1000 / 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3Njc4Mg==", "bodyText": "Please also update stock table's PK to be (s_w_id,s_i_id hash)", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423276782", "createdAt": "2020-05-11T19:45:03Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -12,15 +12,15 @@ CREATE TABLE order_line (\n   ol_supply_w_id int NOT NULL,\n   ol_quantity decimal(2,0) NOT NULL,\n   ol_dist_info char(24) NOT NULL,\n-  PRIMARY KEY (ol_w_id,ol_d_id,ol_o_id,ol_number)\n+  PRIMARY KEY ((ol_w_id,ol_d_id) hash,ol_o_id,ol_number)\n );\n \n DROP TABLE IF EXISTS new_order;\n CREATE TABLE new_order (\n   no_w_id int NOT NULL,\n   no_d_id int NOT NULL,\n   no_o_id int NOT NULL,\n-  PRIMARY KEY (no_w_id,no_d_id,no_o_id)\n+  PRIMARY KEY ((no_w_id,no_d_id) hash,no_o_id)\n );\n \n DROP TABLE IF EXISTS stock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NzQyNA==", "bodyText": "nit: Use HASH (uppercase) so it stands out between the column names.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423277424", "createdAt": "2020-05-11T19:46:19Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -12,15 +12,15 @@ CREATE TABLE order_line (\n   ol_supply_w_id int NOT NULL,\n   ol_quantity decimal(2,0) NOT NULL,\n   ol_dist_info char(24) NOT NULL,\n-  PRIMARY KEY (ol_w_id,ol_d_id,ol_o_id,ol_number)\n+  PRIMARY KEY ((ol_w_id,ol_d_id) hash,ol_o_id,ol_number)\n );\n \n DROP TABLE IF EXISTS new_order;\n CREATE TABLE new_order (\n   no_w_id int NOT NULL,\n   no_d_id int NOT NULL,\n   no_o_id int NOT NULL,\n-  PRIMARY KEY (no_w_id,no_d_id,no_o_id)\n+  PRIMARY KEY ((no_w_id,no_d_id) hash,no_o_id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3ODE0NA==", "bodyText": "Please remove this and add a CREATE UNIQUE INDEX statement below using ((o_w_id, o_d_id) HASH, o_c_id, o_id)", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423278144", "createdAt": "2020-05-11T19:47:44Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -56,7 +56,7 @@ CREATE TABLE oorder (\n   o_ol_cnt decimal(2,0) NOT NULL,\n   o_all_local decimal(1,0) NOT NULL,\n   o_entry_d timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-  PRIMARY KEY (o_w_id,o_d_id,o_id),\n+  PRIMARY KEY ((o_w_id,o_d_id) hash,o_id),\n   UNIQUE (o_w_id,o_d_id,o_c_id,o_id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3ODY4OQ==", "bodyText": "We don't need this since it's only 10 districts per warehouse.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423278689", "createdAt": "2020-05-11T19:48:39Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -112,7 +112,7 @@ CREATE TABLE district (\n   d_city varchar(20) NOT NULL,\n   d_state char(2) NOT NULL,\n   d_zip char(9) NOT NULL,\n-  PRIMARY KEY (d_w_id,d_id)\n+  PRIMARY KEY ((d_w_id,d_id) hash)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3OTc3Ng==", "bodyText": "We can remove this index since there is also a unique index on the same set of columns. So, let's just have 1 index on oorder table like this:\nCREATE UNIQUE INDEX idx_order ON oorder ((o_w_id,o_d_id) HASH, o_c_id, o_id DESC);\nNote that change to use DESC for o_id since that helps with the workload queries.", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423279776", "createdAt": "2020-05-11T19:50:44Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -144,20 +144,3 @@ CREATE TABLE warehouse (\n --add constraints and indexes\n CREATE INDEX idx_customer_name ON customer (c_w_id,c_d_id,c_last,c_first);\n CREATE INDEX idx_order ON oorder (o_w_id,o_d_id,o_c_id,o_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4MDAwMg==", "bodyText": "Change this to ((c_w_id, c_d_id) HASH, c_last, c_first)", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423280002", "createdAt": "2020-05-11T19:51:08Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -144,20 +144,3 @@ CREATE TABLE warehouse (\n --add constraints and indexes\n CREATE INDEX idx_customer_name ON customer (c_w_id,c_d_id,c_last,c_first);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c424379c7c252c8617799e39769a83073a919a8", "author": {"user": {"login": "psudheer21", "name": "Sudheer Ponnemkunnath Rammohan"}}, "url": "https://github.com/yugabyte/tpcc/commit/1c424379c7c252c8617799e39769a83073a919a8", "committedDate": "2020-05-13T22:42:45Z", "message": "Addressed Neha's comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODU0MTIx", "url": "https://github.com/yugabyte/tpcc/pull/16#pullrequestreview-414854121", "createdAt": "2020-05-19T21:59:50Z", "commit": {"oid": "1c424379c7c252c8617799e39769a83073a919a8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMTo1OTo1MFrOGX0Kxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMTo1OTo1MFrOGX0Kxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNTE1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            -- The Foreign keys constraints are enabled based on the flag 'deferConstraintChecks'. If this flag\n          \n          \n            \n            -- The Foreign keys constraints are enabled based on the flag 'enableForeignKeysAfterLoad'. If this flag", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r427625158", "createdAt": "2020-05-19T21:59:50Z", "author": {"login": "ndeodhar"}, "path": "src/com/oltpbenchmark/benchmarks/tpcc/ddls/tpcc-postgres-ddl.sql", "diffHunk": "@@ -1,4 +1,7 @@\n -- TODO: c_since ON UPDATE CURRENT_TIMESTAMP,\n+-- The Foreign keys constraints are enabled based on the flag 'deferConstraintChecks'. If this flag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c424379c7c252c8617799e39769a83073a919a8"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d7b205c4015e7e389413493baec886ef4d1d894", "author": {"user": {"login": "psudheer21", "name": "Sudheer Ponnemkunnath Rammohan"}}, "url": "https://github.com/yugabyte/tpcc/commit/5d7b205c4015e7e389413493baec886ef4d1d894", "committedDate": "2020-05-19T22:18:37Z", "message": "Modified comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 461, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}