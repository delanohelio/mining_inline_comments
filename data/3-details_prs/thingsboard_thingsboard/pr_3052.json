{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzA5NTA5", "number": 3052, "title": "Prometheus Metrics", "bodyText": "", "createdAt": "2020-07-06T11:18:51Z", "url": "https://github.com/thingsboard/thingsboard/pull/3052", "merged": true, "mergeCommit": {"oid": "89419c6999cc7b960d6f40fbb6e9b785a81c38dd"}, "closed": true, "closedAt": "2020-07-06T11:47:37Z", "author": {"login": "vzikratyi-tb"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw-BzkAH2gAyNDQ0NzA5NTA5OmM4MzI1NzUxZTQwODY3OGU0ODEyZmNhMmI1M2RhODc1ZDU4NGE2NGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyPbXrAFqTQ0Mjk4ODM4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8325751e408678e4812fca2b53da875d584a64c", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/c8325751e408678e4812fca2b53da875d584a64c", "committedDate": "2020-07-02T12:30:32Z", "message": "Moved resetting ruleEngineStats to Consumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c02e9474d72497b27aed4a508b34542a57c463ef", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/c02e9474d72497b27aed4a508b34542a57c463ef", "committedDate": "2020-07-02T12:53:40Z", "message": "Moved counters to Map in TbCoreConsumerStats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3afd37eddeb70867aabfdc806db06ce8abab3b73", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/3afd37eddeb70867aabfdc806db06ce8abab3b73", "committedDate": "2020-07-02T12:55:33Z", "message": "Added actuator and MetricsService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f11e6c36f9ad1ea3f0cce819d16afc5fbd65b4", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/b2f11e6c36f9ad1ea3f0cce819d16afc5fbd65b4", "committedDate": "2020-07-02T12:56:33Z", "message": "Added metrics to core and rule_engine consumers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eae7182f3bc93e172be2a1542051f69bd0f7f497", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/eae7182f3bc93e172be2a1542051f69bd0f7f497", "committedDate": "2020-07-06T09:57:46Z", "message": "Added license headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95bae2aa929617140e34a90d0bd6fd2057d73980", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/95bae2aa929617140e34a90d0bd6fd2057d73980", "committedDate": "2020-07-06T09:57:49Z", "message": "Replaced summary with counters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e1a0b8574f55b46ed5ca926a02c298de1baea61", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/2e1a0b8574f55b46ed5ca926a02c298de1baea61", "committedDate": "2020-07-06T09:57:52Z", "message": "Removed most setters and getters from TbRuleEngine stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36fe0a473c9d35f7e8246ac3c703a4f3bf37664", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/d36fe0a473c9d35f7e8246ac3c703a4f3bf37664", "committedDate": "2020-07-06T09:57:55Z", "message": "Added stats to Transport consumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "febbfccabbc63f410bcaa6c685d227c997d773a1", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/febbfccabbc63f410bcaa6c685d227c997d773a1", "committedDate": "2020-07-06T09:57:58Z", "message": "Added JsInvoke actuator stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6f2ef2d2fd233529955836b5662576d6af16a27", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/c6f2ef2d2fd233529955836b5662576d6af16a27", "committedDate": "2020-07-06T10:25:36Z", "message": "Added license headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba68c71a2728f7effee0e5a757a57e041e4c3ece", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/ba68c71a2728f7effee0e5a757a57e041e4c3ece", "committedDate": "2020-07-06T10:31:01Z", "message": "Merge remote-tracking branch 'upstream/develop/2.5.3' into feature/metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78a289656fa4f308736cc4501e601b55f4c6d5b7", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/78a289656fa4f308736cc4501e601b55f4c6d5b7", "committedDate": "2020-07-06T11:11:01Z", "message": "Removed MetricsService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9", "author": {"user": {"login": "vzikratyi-tb", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/0a5378c0af548a7984adb0599b9afb65f7695fa9", "committedDate": "2020-07-06T11:17:14Z", "message": "Removed TODOs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTg3ODU2", "url": "https://github.com/thingsboard/thingsboard/pull/3052#pullrequestreview-442987856", "createdAt": "2020-07-06T11:19:49Z", "commit": {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMToxOTo0OVrOGtTNuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMToxOTo0OVrOGtTNuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MzkxMg==", "bodyText": "maybe it's possible to do this somehow better and without passing factory obj?", "url": "https://github.com/thingsboard/thingsboard/pull/3052#discussion_r450153912", "createdAt": "2020-07-06T11:19:49Z", "author": {"login": "vzikratyi-tb"}, "path": "application/src/main/java/org/thingsboard/server/service/queue/TbRuleEngineConsumerStats.java", "diffHunk": "@@ -43,61 +43,72 @@\n     public static final String SUCCESSFUL_ITERATIONS = \"successfulIterations\";\n     public static final String FAILED_ITERATIONS = \"failedIterations\";\n \n-    private final AtomicInteger totalMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger successMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger tmpTimeoutMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger tmpFailedMsgCounter = new AtomicInteger(0);\n+    private final StatsCounter totalMsgCounter;\n+    private final StatsCounter successMsgCounter;\n+    private final StatsCounter tmpTimeoutMsgCounter;\n+    private final StatsCounter tmpFailedMsgCounter;\n \n-    private final AtomicInteger timeoutMsgCounter = new AtomicInteger(0);\n-    private final AtomicInteger failedMsgCounter = new AtomicInteger(0);\n+    private final StatsCounter timeoutMsgCounter;\n+    private final StatsCounter failedMsgCounter;\n \n-    private final AtomicInteger successIterationsCounter = new AtomicInteger(0);\n-    private final AtomicInteger failedIterationsCounter = new AtomicInteger(0);\n+    private final StatsCounter successIterationsCounter;\n+    private final StatsCounter failedIterationsCounter;\n \n-    private final Map<String, AtomicInteger> counters = new HashMap<>();\n+    private final List<StatsCounter> counters = new ArrayList<>();\n     private final ConcurrentMap<UUID, TbTenantRuleEngineStats> tenantStats = new ConcurrentHashMap<>();\n     private final ConcurrentMap<TenantId, RuleEngineException> tenantExceptions = new ConcurrentHashMap<>();\n \n     private final String queueName;\n \n-    public TbRuleEngineConsumerStats(String queueName) {\n+    public TbRuleEngineConsumerStats(String queueName, StatsCounterFactory counterFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTg4Mzg3", "url": "https://github.com/thingsboard/thingsboard/pull/3052#pullrequestreview-442988387", "createdAt": "2020-07-06T11:20:46Z", "commit": {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMToyMDo0NlrOGtTPPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMToyMDo0NlrOGtTPPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1NDMwMw==", "bodyText": "not sure if that's a good idea", "url": "https://github.com/thingsboard/thingsboard/pull/3052#discussion_r450154303", "createdAt": "2020-07-06T11:20:46Z", "author": {"login": "vzikratyi-tb"}, "path": "application/src/main/java/org/thingsboard/server/service/stats/StatsCounterFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.service.stats;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import org.thingsboard.server.service.metrics.StubCounter;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+@Service\n+public class StatsCounterFactory {\n+    private static final String STATS_NAME_TAG = \"statsName\";\n+\n+    private static final Counter STUB_COUNTER = new StubCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a5378c0af548a7984adb0599b9afb65f7695fa9"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3287, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}