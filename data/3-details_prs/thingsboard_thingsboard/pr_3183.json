{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTE5NTg3", "number": 3183, "title": "device assign to tenant feature", "bodyText": "", "createdAt": "2020-07-28T16:27:16Z", "url": "https://github.com/thingsboard/thingsboard/pull/3183", "merged": true, "mergeCommit": {"oid": "fea2f8799ed2a86b062e038c3013aa1ebc3b57b3"}, "closed": true, "closedAt": "2020-08-03T07:16:23Z", "author": {"login": "dmytro-landiak"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Y3cngH2gAyNDU3OTE5NTg3OjU3MTY0NmM0YTk3YmY5NWM5MGYxODVmYzNlYzExZWY0YTQxZWQ2NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6SvF0gH2gAyNDU3OTE5NTg3OmE2YTMzYTI2MzVhYTE4OGZiMzljZjg0YWVjYTVlZTYzNDEzOTk5NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "571646c4a97bf95c90f185fc3ec11ef4a41ed655", "author": {"user": {"login": "dmytro-landiak", "name": "Dima Landiak"}}, "url": "https://github.com/thingsboard/thingsboard/commit/571646c4a97bf95c90f185fc3ec11ef4a41ed655", "committedDate": "2020-07-28T16:18:03Z", "message": "device swap feature init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ec643ba062ea665752f8695aa1e81dfe4b01aa", "author": {"user": {"login": "dmytro-landiak", "name": "Dima Landiak"}}, "url": "https://github.com/thingsboard/thingsboard/commit/87ec643ba062ea665752f8695aa1e81dfe4b01aa", "committedDate": "2020-07-30T15:49:41Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da", "author": {"user": {"login": "dmytro-landiak", "name": "Dima Landiak"}}, "url": "https://github.com/thingsboard/thingsboard/commit/09459c3988cfd2a1e89af10a6d18e3a534d509da", "committedDate": "2020-07-30T16:21:07Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTc5NzY2", "url": "https://github.com/thingsboard/thingsboard/pull/3183#pullrequestreview-458979766", "createdAt": "2020-07-31T07:48:02Z", "commit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODowMlrOG5_N3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODowMlrOG5_N3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1Nzc1OQ==", "bodyText": "Can't swap device that has entity views!", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463457759", "createdAt": "2020-07-31T07:48:02Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTgwMTY2", "url": "https://github.com/thingsboard/thingsboard/pull/3183#pullrequestreview-458980166", "createdAt": "2020-07-31T07:48:44Z", "commit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODo0NFrOG5_PCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODo0NFrOG5_PCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODA1Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458056", "createdAt": "2020-07-31T07:48:44Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTgwODMz", "url": "https://github.com/thingsboard/thingsboard/pull/3183#pullrequestreview-458980833", "createdAt": "2020-07-31T07:49:59Z", "commit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0OTo1OVrOG5_RNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0OTo1OVrOG5_RNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODYxNQ==", "bodyText": "no need to delete audit logs", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458615", "createdAt": "2020-07-31T07:49:59Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");\n+            }\n+        } catch (ExecutionException | InterruptedException e) {\n+            log.error(\"Exception while finding entity views for deviceId [{}]\", device.getId(), e);\n+            throw new RuntimeException(\"Exception while finding entity views for deviceId [\" + device.getId() + \"]\", e);\n+        }\n+\n+        eventService.removeEvents(device.getTenantId(), device.getId());\n+\n+        relationService.removeRelations(device.getTenantId(), device.getId());\n+\n+        // TODO: 30/07/2020 implement for Cassandra\n+        if (sqlDatabaseUsed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTgxNDQ4", "url": "https://github.com/thingsboard/thingsboard/pull/3183#pullrequestreview-458981448", "createdAt": "2020-07-31T07:51:09Z", "commit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1MTowOVrOG5_TKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1MTowOVrOG5_TKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1OTExNA==", "bodyText": "remove events here please.", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463459114", "createdAt": "2020-07-31T07:51:09Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/event/BaseEventService.java", "diffHunk": "@@ -94,6 +95,24 @@ public Event save(Event event) {\n         return eventDao.findLatestEvents(tenantId.getId(), entityId, eventType, limit);\n     }\n \n+    @Override\n+    public void removeEvents(TenantId tenantId, EntityId entityId) {\n+        List<Event> events = new ArrayList<>();\n+        TimePageData<Event> eventPageData;\n+        TimePageLink eventPageLink = new TimePageLink(1000);\n+        do {\n+            eventPageData = findEvents(tenantId, entityId, eventPageLink);\n+            events.addAll(eventPageData.getData());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6a33a2635aa188fb39cf84aeca5ee6341399956", "author": {"user": {"login": "dmytro-landiak", "name": "Dima Landiak"}}, "url": "https://github.com/thingsboard/thingsboard/commit/a6a33a2635aa188fb39cf84aeca5ee6341399956", "committedDate": "2020-07-31T11:43:25Z", "message": "improvements"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3278, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}