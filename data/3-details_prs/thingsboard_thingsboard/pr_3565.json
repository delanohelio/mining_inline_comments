{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNTE5MzMy", "number": 3565, "title": "Fixed issue for last level query in case entities have more relations\u2026", "bodyText": "\u2026 in the hierarchy below requested level", "createdAt": "2020-10-09T11:13:14Z", "url": "https://github.com/thingsboard/thingsboard/pull/3565", "merged": true, "mergeCommit": {"oid": "ba96409e5d2efd2bfa7b9750a2a24ae46854b113"}, "closed": true, "closedAt": "2020-10-12T08:26:38Z", "author": {"login": "volodymyr-babak"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ0QRyAH2gAyNTAwNTE5MzMyOjk0NDJjZGI3ODA1Yjg4YWU3ZjMwN2IxZTRhMzI2NzBiNmQ1N2QwNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ3jG8gH2gAyNTAwNTE5MzMyOjM1ZWIzZWQ0NzE2MjVhZDIzOTY2MzU1YjdlNjE5ZWM3YTg3NDM4YTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9442cdb7805b88ae7f307b1e4a32670b6d57d06f", "author": {"user": {"login": "volodymyr-babak", "name": "VoBa"}}, "url": "https://github.com/thingsboard/thingsboard/commit/9442cdb7805b88ae7f307b1e4a32670b6d57d06f", "committedDate": "2020-10-09T11:12:52Z", "message": "Fixed issue for last level query in case entities have more relations in the hierarchy below requested level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjU3NjU3", "url": "https://github.com/thingsboard/thingsboard/pull/3565#pullrequestreview-505657657", "createdAt": "2020-10-09T13:11:09Z", "commit": {"oid": "9442cdb7805b88ae7f307b1e4a32670b6d57d06f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoxMTowOVrOHfJDyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoxMTowOVrOHfJDyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNjMzMQ==", "bodyText": "Duplicated\nnotExistsPart.append(whereFilter.toString());", "url": "https://github.com/thingsboard/thingsboard/pull/3565#discussion_r502416331", "createdAt": "2020-10-09T13:11:09Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/sql/query/DefaultEntityQueryRepository.java", "diffHunk": "@@ -556,7 +559,9 @@ private String relationQuery(QueryContext ctx, RelationsQueryFilter entityFilter\n                     .append(\" and \")\n                     .append(\"nr.\").append(fromOrTo).append(\"_id\").append(\" = re.\").append(toOrFrom).append(\"_id\")\n                     .append(\" and \")\n-                    .append(\"nr.\").append(fromOrTo).append(\"_type\").append(\" = re.\").append(toOrFrom).append(\"_type\");\n+                    .append(\"nr.\").append(fromOrTo).append(\"_type\").append(\" = re.\").append(toOrFrom).append(\"_type\")\n+                    .append(\" and \")\n+                    .append(whereFilter.toString().replaceAll(\"re\\\\.\", \"nr\\\\.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9442cdb7805b88ae7f307b1e4a32670b6d57d06f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjU4NjY5", "url": "https://github.com/thingsboard/thingsboard/pull/3565#pullrequestreview-505658669", "createdAt": "2020-10-09T13:12:27Z", "commit": {"oid": "9442cdb7805b88ae7f307b1e4a32670b6d57d06f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoxMjoyN1rOHfJGwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoxMjoyN1rOHfJGwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNzA4OQ==", "bodyText": "This should be removed ?\n            if (!StringUtils.isEmpty(entityFilter.getRelationType())) {\n                notExistsPart.append(\" and nr.relation_type = :where_relation_type\");\n            }", "url": "https://github.com/thingsboard/thingsboard/pull/3565#discussion_r502417089", "createdAt": "2020-10-09T13:12:27Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/sql/query/DefaultEntityQueryRepository.java", "diffHunk": "@@ -472,10 +472,13 @@ private String entitySearchQuery(QueryContext ctx, EntitySearchQueryFilter entit\n         if (entityFilter.isFetchLastLevelOnly()) {\n             String fromOrTo = (entityFilter.getDirection().equals(EntitySearchDirection.FROM) ? \"from\" : \"to\");\n             StringBuilder notExistsPart = new StringBuilder();\n-            notExistsPart.append(\" NOT EXISTS (SELECT 1 from relation nr where \")\n+            notExistsPart.append(\" NOT EXISTS (SELECT 1 from relation nr \")\n+                    .append(whereFilter.replaceAll(\"re\\\\.\", \"nr\\\\.\"))\n+                    .append(\" and \")\n                     .append(\"nr.\").append(fromOrTo).append(\"_id\").append(\" = re.\").append(toOrFrom).append(\"_id\")\n                     .append(\" and \")\n                     .append(\"nr.\").append(fromOrTo).append(\"_type\").append(\" = re.\").append(toOrFrom).append(\"_type\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9442cdb7805b88ae7f307b1e4a32670b6d57d06f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35eb3ed471625ad23966355b7e619ec7a87438a0", "author": {"user": {"login": "volodymyr-babak", "name": "VoBa"}}, "url": "https://github.com/thingsboard/thingsboard/commit/35eb3ed471625ad23966355b7e619ec7a87438a0", "committedDate": "2020-10-09T15:03:09Z", "message": "Code review fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3253, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}