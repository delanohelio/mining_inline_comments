{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTQ2OTc5", "number": 3046, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyODoxOVrOEMDdWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyODoxOVrOEMDdWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDc1MDMzOnYy", "diffSide": "RIGHT", "path": "application/src/main/data/upgrade/3.0.1/schema_update_to_uuid.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyODoxOVrOGt8O3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyODoxOVrOGt8O3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNTk1MQ==", "bodyText": "Add one more index", "url": "https://github.com/thingsboard/thingsboard/pull/3046#discussion_r450825951", "createdAt": "2020-07-07T12:28:19Z", "author": {"login": "ashvayka"}, "path": "application/src/main/data/upgrade/3.0.1/schema_update_to_uuid.sql", "diffHunk": "@@ -21,21 +21,806 @@ DECLARE\n BEGIN\n     bytes := uuid_send(uuid);\n     RETURN\n-                (\n-                            (\n-                                            (get_byte(bytes, 0)::bigint << 24) |\n-                                            (get_byte(bytes, 1)::bigint << 16) |\n-                                            (get_byte(bytes, 2)::bigint <<  8) |\n-                                            (get_byte(bytes, 3)::bigint <<  0)\n-                                ) + (\n-                                    ((get_byte(bytes, 4)::bigint << 8 |\n-                                      get_byte(bytes, 5)::bigint)) << 32\n-                                ) + (\n-                                    (((get_byte(bytes, 6)::bigint & 15) << 8 | get_byte(bytes, 7)::bigint) & 4095) << 48\n-                                ) - 122192928000000000\n-                    ) / 10000::double precision\n-        ;\n+            (\n+                        (\n+                                        (get_byte(bytes, 0)::bigint << 24) |\n+                                        (get_byte(bytes, 1)::bigint << 16) |\n+                                        (get_byte(bytes, 2)::bigint << 8) |\n+                                        (get_byte(bytes, 3)::bigint << 0)\n+                            ) + (\n+                                ((get_byte(bytes, 4)::bigint << 8 |\n+                                  get_byte(bytes, 5)::bigint)) << 32\n+                            ) + (\n+                                (((get_byte(bytes, 6)::bigint & 15) << 8 | get_byte(bytes, 7)::bigint) & 4095) << 48\n+                            ) - 122192928000000000\n+                ) / 10000::double precision;\n END\n $$ LANGUAGE plpgsql\n-    IMMUTABLE PARALLEL SAFE\n+    IMMUTABLE\n+    PARALLEL SAFE\n     RETURNS NULL ON NULL INPUT;\n+\n+\n+CREATE OR REPLACE FUNCTION column_type_to_uuid(table_name varchar, column_name varchar) RETURNS VOID\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    execute format('ALTER TABLE %s RENAME COLUMN %s TO old_%s;', table_name, column_name, column_name);\n+    execute format('ALTER TABLE %s ADD COLUMN %s UUID;', table_name, column_name);\n+    execute format('UPDATE %s SET %s = to_uuid(old_%s) WHERE old_%s is not null;', table_name, column_name, column_name, column_name);\n+    execute format('ALTER TABLE %s DROP COLUMN old_%s;', table_name, column_name);\n+END;\n+$$;\n+\n+CREATE OR REPLACE FUNCTION get_column_type(table_name varchar, column_name varchar, OUT data_type varchar) RETURNS varchar\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    execute (format('SELECT data_type from information_schema.columns where table_name = %L and column_name = %L',\n+                    table_name, column_name)) INTO data_type;\n+END;\n+$$;\n+\n+\n+CREATE OR REPLACE PROCEDURE drop_all_idx()\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    DROP INDEX IF EXISTS idx_alarm_originator_alarm_type;\n+    DROP INDEX IF EXISTS idx_event_type_entity_id;\n+    DROP INDEX IF EXISTS idx_relation_to_id;\n+    DROP INDEX IF EXISTS idx_relation_from_id;\n+    DROP INDEX IF EXISTS idx_device_customer_id;\n+    DROP INDEX IF EXISTS idx_device_customer_id_and_type;\n+    DROP INDEX IF EXISTS idx_device_type;\n+    DROP INDEX IF EXISTS idx_asset_customer_id;\n+    DROP INDEX IF EXISTS idx_asset_customer_id_and_type;\n+    DROP INDEX IF EXISTS idx_asset_type;\n+END;\n+$$;\n+\n+CREATE OR REPLACE PROCEDURE create_all_idx()\n+    LANGUAGE plpgsql AS\n+$$\n+BEGIN\n+    CREATE INDEX IF NOT EXISTS idx_alarm_originator_alarm_type ON alarm(originator_id, type, start_ts DESC);\n+    CREATE INDEX IF NOT EXISTS idx_event_type_entity_id ON event(tenant_id, event_type, entity_type, entity_id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ede5894f76cf715dd1156524d27c171118c5cfc"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1367, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}