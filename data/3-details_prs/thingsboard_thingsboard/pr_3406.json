{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MTQ1OTcw", "number": 3406, "title": "[3.2] Improvements/queue reprocessing strategy", "bodyText": "", "createdAt": "2020-09-01T15:03:57Z", "url": "https://github.com/thingsboard/thingsboard/pull/3406", "merged": true, "mergeCommit": {"oid": "827a1e30928fe0496d104ad11a7e754e34ad1609"}, "closed": true, "closedAt": "2020-09-16T09:09:00Z", "author": {"login": "ShvaykaD"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEohEHgH2gAyNDc3MTQ1OTcwOmVmNWMwOTU0NWM4Y2UyZjFjNDhhYmU1NjZjMTRjMzFhYTdiYmM5NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFmR4lgH2gAyNDc3MTQ1OTcwOjdlOTVmMDgxYzJiZmVhNDI1NDYwODc5YWFkMGZmZjcwZTNjODdhNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef5c09545c8ce2f1c48abe566c14c31aa7bbc966", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/ef5c09545c8ce2f1c48abe566c14c31aa7bbc966", "committedDate": "2020-09-01T14:45:15Z", "message": "added ability to use exp-pause-between-retries on queue msgs reprocessing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "258ed349798e63b3f88f8e0c9825d5326c0779da", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/258ed349798e63b3f88f8e0c9825d5326c0779da", "committedDate": "2020-09-01T14:45:16Z", "message": "change the defaults"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTczMTAz", "url": "https://github.com/thingsboard/thingsboard/pull/3406#pullrequestreview-482573103", "createdAt": "2020-09-04T11:25:54Z", "commit": {"oid": "258ed349798e63b3f88f8e0c9825d5326c0779da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMToyNTo1NFrOHNJ9AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMToyNTo1NFrOHNJ9AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU1NjYwOA==", "bodyText": "First, just calculate the value of the \"pause\" variable and then use try{ sleep }catch block to avoid code duplication.", "url": "https://github.com/thingsboard/thingsboard/pull/3406#discussion_r483556608", "createdAt": "2020-09-04T11:25:54Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/queue/processing/TbRuleEngineProcessingStrategyFactory.java", "diffHunk": "@@ -103,10 +116,25 @@ public TbRuleEngineProcessingDecision analyze(TbRuleEngineProcessingResult resul\n                         toReprocess.forEach((id, msg) -> log.trace(\"Going to reprocess [{}]: {}\", id, TbMsg.fromBytes(result.getQueueName(), msg.getValue().getTbMsg().toByteArray(), TbMsgCallback.EMPTY)));\n                     }\n                     if (pauseBetweenRetries > 0) {\n-                        try {\n-                            Thread.sleep(TimeUnit.SECONDS.toMillis(pauseBetweenRetries));\n-                        } catch (InterruptedException e) {\n-                            throw new RuntimeException(e);\n+                        if (expPauseBetweenRetries) {\n+                            long pause;\n+                            if (maxExpDegreeValue > expDegreeStep.get()) {\n+                                pause = new Double(Math.pow(pauseBetweenRetries, expDegreeStep.getAndIncrement())).longValue();\n+                            } else {\n+                                pause = maxExpPauseBetweenRetries;\n+                            }\n+                            try {\n+                                Thread.sleep(TimeUnit.SECONDS.toMillis(\n+                                        pause));\n+                            } catch (InterruptedException e) {\n+                                throw new RuntimeException(e);\n+                            }\n+                        } else {\n+                            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258ed349798e63b3f88f8e0c9825d5326c0779da"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTc1NTk1", "url": "https://github.com/thingsboard/thingsboard/pull/3406#pullrequestreview-482575595", "createdAt": "2020-09-04T11:30:15Z", "commit": {"oid": "258ed349798e63b3f88f8e0c9825d5326c0779da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMTozMDoxNVrOHNKEOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMTozMDoxNVrOHNKEOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU1ODQ1Nw==", "bodyText": "This variable is redundant. You can use expDegreeStep and just compare the maxExpPauseBetweenRetries and new Double(Math.pow(pauseBetweenRetries, expDegreeStep.getAndIncrement())).longValue();", "url": "https://github.com/thingsboard/thingsboard/pull/3406#discussion_r483558457", "createdAt": "2020-09-04T11:30:15Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/queue/processing/TbRuleEngineProcessingStrategyFactory.java", "diffHunk": "@@ -69,6 +76,12 @@ public RetryStrategy(String queueName, boolean retrySuccessful, boolean retryFai\n             this.maxRetries = configuration.getRetries();\n             this.maxAllowedFailurePercentage = configuration.getFailurePercentage();\n             this.pauseBetweenRetries = configuration.getPauseBetweenRetries();\n+            this.expPauseBetweenRetries = configuration.isExpPauseBetweenRetries();\n+            if (this.expPauseBetweenRetries) {\n+                this.expDegreeStep = new AtomicInteger(1);\n+                this.maxExpPauseBetweenRetries = configuration.getMaxExpPauseBetweenRetries();\n+                this.maxExpDegreeValue = Math.log(maxExpPauseBetweenRetries) / Math.log(pauseBetweenRetries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258ed349798e63b3f88f8e0c9825d5326c0779da"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15426d93fa5864a89323e18ecc7c7db436139e9", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/f15426d93fa5864a89323e18ecc7c7db436139e9", "committedDate": "2020-09-04T13:15:46Z", "message": "changed logic to multiplication pause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ceb9d3101488f8ba40f172d86bd2577a5b657aa", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/3ceb9d3101488f8ba40f172d86bd2577a5b657aa", "committedDate": "2020-09-04T13:15:47Z", "message": "clean up code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "801593010dcc64f2dc97ebd1bfd944c989bf431b", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/801593010dcc64f2dc97ebd1bfd944c989bf431b", "committedDate": "2020-09-04T13:15:48Z", "message": "removed unnecessary flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3b7a29d8b6b6f6ddfe21f9afc3c6d82932b4519", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/d3b7a29d8b6b6f6ddfe21f9afc3c6d82932b4519", "committedDate": "2020-09-04T13:49:31Z", "message": "changed env variable name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e95f081c2bfea425460879aad0fff70e3c87a58", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/7e95f081c2bfea425460879aad0fff70e3c87a58", "committedDate": "2020-09-04T14:42:47Z", "message": "changed defaults max-pause-between-retries params"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3271, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}