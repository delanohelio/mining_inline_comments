{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2OTU5ODY0", "number": 3910, "title": "Added ability to return arrays in transformation script node", "bodyText": "If array returns in transformation script node, it will send every element as separated message.", "createdAt": "2020-12-30T14:10:29Z", "url": "https://github.com/thingsboard/thingsboard/pull/3910", "merged": true, "mergeCommit": {"oid": "4aa55bccf84519fd7923ffd38cb5eed8541dda0c"}, "closed": true, "closedAt": "2021-01-06T12:41:02Z", "author": {"login": "zbeacon"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdrP7G7gH2gAyNTQ2OTU5ODY0OmM2YzlkN2EzNDNkZjMxMDNiNDUxZDBlNDMyN2VkZTdhMWUwOTVjNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdte0KIgH2gAyNTQ2OTU5ODY0OjM4ZTEzYmQ5MTZhNGFjYzYzOGQwYzljNGMxMDIyZjk5NzEwMjI2NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6c9d7a343df3103b451d0e4327ede7a1e095c44", "author": {"user": {"login": "zbeacon", "name": "Illia Barkov"}}, "url": "https://github.com/thingsboard/thingsboard/commit/c6c9d7a343df3103b451d0e4327ede7a1e095c44", "committedDate": "2020-12-30T14:09:07Z", "message": "Added ability to return arrays in transformation script node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495520b9e3286bc8183d09e3c4b8ed42dd588326", "author": {"user": {"login": "zbeacon", "name": "Illia Barkov"}}, "url": "https://github.com/thingsboard/thingsboard/commit/495520b9e3286bc8183d09e3c4b8ed42dd588326", "committedDate": "2020-12-30T14:49:43Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9399d4ed402a018caadbb6c4bb8d38ee40a538f", "author": {"user": {"login": "zbeacon", "name": "Illia Barkov"}}, "url": "https://github.com/thingsboard/thingsboard/commit/e9399d4ed402a018caadbb6c4bb8d38ee40a538f", "committedDate": "2020-12-31T10:26:55Z", "message": "Refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyNjAyNjQy", "url": "https://github.com/thingsboard/thingsboard/pull/3910#pullrequestreview-562602642", "createdAt": "2021-01-06T11:20:12Z", "commit": {"oid": "e9399d4ed402a018caadbb6c4bb8d38ee40a538f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxMToyMDoxMlrOIO673Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxMToyMDoxMlrOIO673Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjUxNjU3Mw==", "bodyText": "json.size()", "url": "https://github.com/thingsboard/thingsboard/pull/3910#discussion_r552516573", "createdAt": "2021-01-06T11:20:12Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/script/RuleNodeJsScriptEngine.java", "diffHunk": "@@ -116,14 +118,19 @@ public TbMsg executeUpdate(TbMsg msg) throws ScriptException {\n     }\n \n     @Override\n-    public ListenableFuture<TbMsg> executeUpdateAsync(TbMsg msg) {\n+    public ListenableFuture<List<TbMsg>> executeUpdateAsync(TbMsg msg) {\n         ListenableFuture<JsonNode> result = executeScriptAsync(msg);\n         return Futures.transformAsync(result, json -> {\n-            if (!json.isObject()) {\n+            if (json.isObject()) {\n+                return Futures.immediateFuture(Collections.singletonList(unbindMsg(json, msg)));\n+            } else if (json.isArray()){\n+                List<TbMsg> res = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9399d4ed402a018caadbb6c4bb8d38ee40a538f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f873fdc678d05634e0f4716acc8f21c5c61458a", "author": {"user": {"login": "zbeacon", "name": "Illia Barkov"}}, "url": "https://github.com/thingsboard/thingsboard/commit/7f873fdc678d05634e0f4716acc8f21c5c61458a", "committedDate": "2021-01-06T12:24:03Z", "message": "Improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyNjczMzA0", "url": "https://github.com/thingsboard/thingsboard/pull/3910#pullrequestreview-562673304", "createdAt": "2021-01-06T12:29:55Z", "commit": {"oid": "7f873fdc678d05634e0f4716acc8f21c5c61458a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxMjoyOTo1NVrOIO9oIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQxMjoyOTo1NVrOIO9oIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjU2MDY3Mw==", "bodyText": "ctx.ack", "url": "https://github.com/thingsboard/thingsboard/pull/3910#discussion_r552560673", "createdAt": "2021-01-06T12:29:55Z", "author": {"login": "ashvayka"}, "path": "rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/transform/TbAbstractTransformNode.java", "diffHunk": "@@ -61,7 +62,20 @@ protected void transformSuccess(TbContext ctx, TbMsg msg, TbMsg m) {\n         }\n     }\n \n-    protected abstract ListenableFuture<TbMsg> transform(TbContext ctx, TbMsg msg);\n+    protected void transformSuccess(TbContext ctx, TbMsg msg, List<TbMsg> msgs) {\n+        if (msgs != null && !msgs.isEmpty()) {\n+            if (msgs.size() == 1) {\n+                ctx.tellSuccess(msgs.get(0));\n+            } else {\n+                TbMsgCallbackWrapper wrapper = new MultipleTbMsgsCallbackWrapper(msgs.size(), msg.getCallback());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f873fdc678d05634e0f4716acc8f21c5c61458a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e13bd916a4acc638d0c9c4c1022f9971022655", "author": {"user": {"login": "zbeacon", "name": "Illia Barkov"}}, "url": "https://github.com/thingsboard/thingsboard/commit/38e13bd916a4acc638d0c9c4c1022f9971022655", "committedDate": "2021-01-06T12:37:57Z", "message": "Improvements"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3232, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}