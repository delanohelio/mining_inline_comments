{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMjMzOTYx", "number": 3740, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowNjo0N1rOE56ttw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowOTo1MlrOE56yoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTY2MjYzOnYy", "diffSide": "RIGHT", "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/ProtoTransportPayloadConfiguration.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowNjo0N1rOH0q7sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowNjo0N1rOH0q7sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5MTQxMA==", "bodyText": "throw new RuntimeException(\"Failed to get Message Descriptor due to :\" + e.getMessage()); to be consistent with the getDynamicSchema", "url": "https://github.com/thingsboard/thingsboard/pull/3740#discussion_r524991410", "createdAt": "2020-11-17T09:06:47Z", "author": {"login": "ashvayka"}, "path": "common/data/src/main/java/org/thingsboard/server/common/data/device/profile/ProtoTransportPayloadConfiguration.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/**\n+ * Copyright \u00a9 2016-2020 The Thingsboard Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.thingsboard.server.common.data.device.profile;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.github.os72.protobuf.dynamic.DynamicSchema;\n+import com.github.os72.protobuf.dynamic.EnumDefinition;\n+import com.github.os72.protobuf.dynamic.MessageDefinition;\n+import com.google.protobuf.Descriptors;\n+import com.google.protobuf.DynamicMessage;\n+import com.squareup.wire.schema.Location;\n+import com.squareup.wire.schema.internal.parser.EnumConstantElement;\n+import com.squareup.wire.schema.internal.parser.EnumElement;\n+import com.squareup.wire.schema.internal.parser.FieldElement;\n+import com.squareup.wire.schema.internal.parser.MessageElement;\n+import com.squareup.wire.schema.internal.parser.OneOfElement;\n+import com.squareup.wire.schema.internal.parser.ProtoFileElement;\n+import com.squareup.wire.schema.internal.parser.ProtoParser;\n+import com.squareup.wire.schema.internal.parser.TypeElement;\n+import lombok.Data;\n+import lombok.extern.slf4j.Slf4j;\n+import org.thingsboard.server.common.data.TransportPayloadType;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+@Data\n+public class ProtoTransportPayloadConfiguration implements TransportPayloadTypeConfiguration {\n+\n+    public static final Location LOCATION = new Location(\"\", \"\", -1, -1);\n+    public static final String ATTRIBUTES_PROTO_SCHEMA = \"attributes proto schema\";\n+    public static final String TELEMETRY_PROTO_SCHEMA = \"telemetry proto schema\";\n+\n+    private String deviceTelemetryProtoSchema;\n+    private String deviceAttributesProtoSchema;\n+\n+    @Override\n+    public TransportPayloadType getTransportPayloadType() {\n+        return TransportPayloadType.PROTOBUF;\n+    }\n+\n+    public Descriptors.Descriptor getTelemetryDynamicMessageDescriptor(String deviceTelemetryProtoSchema) {\n+        return getDescriptor(deviceTelemetryProtoSchema, TELEMETRY_PROTO_SCHEMA);\n+    }\n+\n+    public Descriptors.Descriptor getAttributesDynamicMessageDescriptor(String deviceAttributesProtoSchema) {\n+        return getDescriptor(deviceAttributesProtoSchema, ATTRIBUTES_PROTO_SCHEMA);\n+    }\n+\n+    private Descriptors.Descriptor getDescriptor(String protoSchema, String schemaName) {\n+        try {\n+            ProtoFileElement protoFileElement = getTransportProtoSchema(protoSchema);\n+            DynamicSchema dynamicSchema = getDynamicSchema(protoFileElement, schemaName);\n+            String lastMsgName = getMessageTypes(protoFileElement.getTypes()).stream()\n+                    .map(MessageElement::getName).reduce((previous, last) -> last).get();\n+            DynamicMessage.Builder builder = dynamicSchema.newMessageBuilder(lastMsgName);\n+            return builder.getDescriptorForType();\n+        } catch (Exception e) {\n+            log.warn(\"Failed to get Message Descriptor due to {}\", e.getMessage());\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ea4723e2e3f97481d7c8df540ebafe72c22c62b"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTY3NTIxOnYy", "diffSide": "RIGHT", "path": "common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/adaptors/ProtoMqttAdaptor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowOTo1MlrOH0rDTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTowOTo1MlrOH0rDTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5MzM1OA==", "bodyText": "Please add the TODO to improve this in the future releases. We need two types of improvements:\n\nNo need to convert to JSON and back. If we know the structure of the message we can dynamically create our PostTelemetryMsg without JSON\nNeed to support Protobuf for all other methods (and configure the schema somewhere)", "url": "https://github.com/thingsboard/thingsboard/pull/3740#discussion_r524993358", "createdAt": "2020-11-17T09:09:52Z", "author": {"login": "ashvayka"}, "path": "common/transport/mqtt/src/main/java/org/thingsboard/server/transport/mqtt/adaptors/ProtoMqttAdaptor.java", "diffHunk": "@@ -45,20 +50,24 @@\n \n     @Override\n     public TransportProtos.PostTelemetryMsg convertToPostTelemetry(MqttDeviceAwareSessionContext ctx, MqttPublishMessage inbound) throws AdaptorException {\n+        DeviceSessionCtx deviceSessionCtx = (DeviceSessionCtx) ctx;\n         byte[] bytes = toBytes(inbound.payload());\n+        Descriptors.Descriptor telemetryDynamicMsgDescriptor = getDescriptor(deviceSessionCtx.getTelemetryDynamicMsgDescriptor());\n         try {\n-            return ProtoConverter.convertToTelemetryProto(bytes);\n-        } catch (InvalidProtocolBufferException | IllegalArgumentException e) {\n+            return JsonConverter.convertToTelemetryProto(new JsonParser().parse(dynamicMsgToJson(bytes, telemetryDynamicMsgDescriptor)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ea4723e2e3f97481d7c8df540ebafe72c22c62b"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1311, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}