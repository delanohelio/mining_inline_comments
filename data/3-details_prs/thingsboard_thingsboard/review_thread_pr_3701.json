{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MTM5NDI1", "number": 3701, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMzowNVrOFDmP8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzoyOTo0NFrOFD_Few==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MzE2NzIzOnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMzowNVrOIDVEEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMzowNVrOIDVEEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MTc0NQ==", "bodyText": "Cleared before calculation will create blink label text", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540361745", "createdAt": "2020-12-10T17:33:05Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "diffHunk": "@@ -194,23 +221,34 @@ export class TripAnimationComponent implements OnInit, AfterViewInit, OnDestroy\n     }\n   }\n \n-  calcTooltip = (point?: FormattedData): string => {\n-    const data = point ? point : this.activeTrip;\n-    const tooltipPattern: string = this.settings.useTooltipFunction ?\n-      safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n-    const tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n-    this.mainTooltip = this.sanitizer.sanitize(\n-      SecurityContext.HTML, tooltipText);\n-    this.cd.detectChanges();\n-    this.activeTrip = point;\n+  calcTooltip = (points?: FormattedData[], isMainTooltip: boolean = false): string => {\n+    let tooltipText;\n+    if(isMainTooltip) {\n+      this.mainTooltips = []\n+    }\n+    for (let point of points) {\n+      const data = point ? point : this.activeTrip;\n+      const tooltipPattern: string = this.settings.useTooltipFunction ?\n+        safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n+      tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n+      if(isMainTooltip) {\n+        this.mainTooltips.push(this.sanitizer.sanitize(SecurityContext.HTML, tooltipText));\n+      }\n+      this.cd.detectChanges();\n+      this.activeTrip = point;\n+    }\n     return tooltipText;\n   }\n \n-  calcLabel() {\n-    const data = this.activeTrip;\n-    const labelText: string = this.settings.useLabelFunction ?\n-      safeExecute(this.settings.labelFunction, [data, this.historicalData, data.dsIndex]) : this.settings.label;\n-    this.label = (parseWithTranslation.parseTemplate(labelText, data, true));\n+  calcLabel(formattedDataArr: FormattedData[]) {\n+    this.label = '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MzE2ODI0OnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMzoxN1rOIDVEqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMzoxN1rOIDVEqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MTg5OQ==", "bodyText": "Duplicate value", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540361899", "createdAt": "2020-12-10T17:33:17Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "diffHunk": "@@ -194,23 +221,34 @@ export class TripAnimationComponent implements OnInit, AfterViewInit, OnDestroy\n     }\n   }\n \n-  calcTooltip = (point?: FormattedData): string => {\n-    const data = point ? point : this.activeTrip;\n-    const tooltipPattern: string = this.settings.useTooltipFunction ?\n-      safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n-    const tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n-    this.mainTooltip = this.sanitizer.sanitize(\n-      SecurityContext.HTML, tooltipText);\n-    this.cd.detectChanges();\n-    this.activeTrip = point;\n+  calcTooltip = (points?: FormattedData[], isMainTooltip: boolean = false): string => {\n+    let tooltipText;\n+    if(isMainTooltip) {\n+      this.mainTooltips = []\n+    }\n+    for (let point of points) {\n+      const data = point ? point : this.activeTrip;\n+      const tooltipPattern: string = this.settings.useTooltipFunction ?\n+        safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n+      tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n+      if(isMainTooltip) {\n+        this.mainTooltips.push(this.sanitizer.sanitize(SecurityContext.HTML, tooltipText));\n+      }\n+      this.cd.detectChanges();\n+      this.activeTrip = point;\n+    }\n     return tooltipText;\n   }\n \n-  calcLabel() {\n-    const data = this.activeTrip;\n-    const labelText: string = this.settings.useLabelFunction ?\n-      safeExecute(this.settings.labelFunction, [data, this.historicalData, data.dsIndex]) : this.settings.label;\n-    this.label = (parseWithTranslation.parseTemplate(labelText, data, true));\n+  calcLabel(formattedDataArr: FormattedData[]) {\n+    this.label = '';\n+    for (let formattedData of formattedDataArr) {\n+      const data = formattedData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5Njc1MjgwOnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.html", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMToxOTozOFrOID0elQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMToxOTozOFrOID0elQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg3NjQzNw==", "bodyText": "Didn't dynamic style", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540876437", "createdAt": "2020-12-11T11:19:38Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.html", "diffHunk": "@@ -28,8 +28,12 @@\n             </button>\n         </div>\n         <div class=\"trip-animation-tooltip md-whiteframe-z4\" fxLayout=\"column\"\n-            [ngClass]=\"{'trip-animation-tooltip-hidden':!visibleTooltip}\" [innerHTML]=\"mainTooltip\"\n-            [ngStyle]=\"{'background-color': settings.tooltipColor, 'opacity': settings.tooltipOpacity, 'color': settings.tooltipFontColor}\">\n+             [ngClass]=\"{'trip-animation-tooltip-hidden':!visibleTooltip}\"\n+             [ngStyle]=\"{'background-color': settings.tooltipColor, 'opacity': settings.tooltipOpacity, 'color': settings.tooltipFontColor}\">\n+          <div *ngFor=\"let mainTooltip of mainTooltips\"\n+               [innerHTML]=\"mainTooltip\"\n+               [ngStyle]=\"{'padding': '10px 0'}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5Njc5Njg2OnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/lib/maps/leaflet-map.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMTozMjowM1rOID04Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMTozMjowM1rOID04Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg4MzAwMg==", "bodyText": "Need to add after all modification FeatureGroup", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540883002", "createdAt": "2020-12-11T11:32:03Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/lib/maps/leaflet-map.ts", "diffHunk": "@@ -608,26 +608,32 @@ export default abstract class LeafletMap {\n       return polygon;\n     }\n \n-    updatePoints(pointsData: FormattedData[], getTooltip: (point: FormattedData, setTooltip?: boolean) => string) {\n-      if (this.points) {\n+  updatePoints(pointsData: FormattedData[][], getTooltip: (point: FormattedData[], setTooltip?: boolean) => string) {\n+    for(let i = 0; i < pointsData.length; i++) {\n+      let pointsList = pointsData[i];\n+      if(i === 0) {\n+        if (this.points) {\n           this.map.removeLayer(this.points);\n+        }\n+        this.points = new FeatureGroup();\n       }\n-      this.points = new FeatureGroup();\n-      pointsData.filter(pdata => !!this.convertPosition(pdata)).forEach(data => {\n-          const point = L.circleMarker(this.convertPosition(data), {\n-              color: this.options.pointColor,\n-              radius: this.options.pointSize\n-          });\n-          if (!this.options.pointTooltipOnRightPanel) {\n-              point.on('click', () => getTooltip(data));\n-          }\n-          else {\n-              createTooltip(point, this.options, data.$datasource, getTooltip(data, false));\n-          }\n-          this.points.addLayer(point);\n+      pointsList.filter(pdata => !!this.convertPosition(pdata)).forEach(data => {\n+        const point = L.circleMarker(this.convertPosition(data), {\n+          color: this.options.pointColor,\n+          radius: this.options.pointSize\n+        });\n+        if (!this.options.pointTooltipOnRightPanel) {\n+          point.on('click', () => getTooltip([data]));\n+        } else {\n+          createTooltip(point, this.options, data.$datasource, getTooltip([data], false));\n+        }\n+        this.points.addLayer(point);\n       });\n-      this.map.addLayer(this.points);\n+      if(i === 0) {\n+        this.map.addLayer(this.points);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NzA3MjY5OnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjo0Nzo1MVrOID3U7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMjo0Nzo1MVrOID3U7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkyMzExNg==", "bodyText": "Why change the type of a variable?", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540923116", "createdAt": "2020-12-11T12:47:51Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "diffHunk": "@@ -138,34 +141,41 @@ export class TripAnimationComponent implements OnInit, AfterViewInit, OnDestroy\n \n   timeUpdated(time: number) {\n     this.currentTime = time;\n-    const currentPosition = this.interpolatedTimeData\n+    let currentPosition = this.interpolatedTimeData", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NzIyMTQ4OnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzoyNjoxNFrOID4qWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzoyNjoxNFrOID4qWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0NDk4NQ==", "bodyText": "Overwrite variable", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540944985", "createdAt": "2020-12-11T13:26:14Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "diffHunk": "@@ -194,23 +221,34 @@ export class TripAnimationComponent implements OnInit, AfterViewInit, OnDestroy\n     }\n   }\n \n-  calcTooltip = (point?: FormattedData): string => {\n-    const data = point ? point : this.activeTrip;\n-    const tooltipPattern: string = this.settings.useTooltipFunction ?\n-      safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n-    const tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n-    this.mainTooltip = this.sanitizer.sanitize(\n-      SecurityContext.HTML, tooltipText);\n-    this.cd.detectChanges();\n-    this.activeTrip = point;\n+  calcTooltip = (points?: FormattedData[], isMainTooltip: boolean = false): string => {\n+    let tooltipText;\n+    if(isMainTooltip) {\n+      this.mainTooltips = []\n+    }\n+    for (let point of points) {\n+      const data = point ? point : this.activeTrip;\n+      const tooltipPattern: string = this.settings.useTooltipFunction ?\n+        safeExecute(this.settings.tooltipFunction, [data, this.historicalData, point.dsIndex]) : this.settings.tooltipPattern;\n+      tooltipText = parseWithTranslation.parseTemplate(tooltipPattern, data, true);\n+      if(isMainTooltip) {\n+        this.mainTooltips.push(this.sanitizer.sanitize(SecurityContext.HTML, tooltipText));\n+      }\n+      this.cd.detectChanges();\n+      this.activeTrip = point;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NzIzNjQzOnYy", "diffSide": "RIGHT", "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzoyOTo0NFrOID4yoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMzoyOTo0NFrOID4yoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0NzEwNQ==", "bodyText": "Missing _.union call", "url": "https://github.com/thingsboard/thingsboard/pull/3701#discussion_r540947105", "createdAt": "2020-12-11T13:29:44Z", "author": {"login": "vvlladd28"}, "path": "ui-ngx/src/app/modules/home/components/widget/trip-animation/trip-animation.component.ts", "diffHunk": "@@ -138,34 +141,41 @@ export class TripAnimationComponent implements OnInit, AfterViewInit, OnDestroy\n \n   timeUpdated(time: number) {\n     this.currentTime = time;\n-    const currentPosition = this.interpolatedTimeData\n+    let currentPosition = this.interpolatedTimeData\n       .map(dataSource => dataSource[time])\n-      .filter(ds => ds);\n-    if (isUndefined(currentPosition[0])) {\n-      const timePoints = Object.keys(this.interpolatedTimeData[0]).map(item => parseInt(item, 10));\n-      for (let i = 1; i < timePoints.length; i++) {\n-        if (timePoints[i - 1] < time && timePoints[i] > time) {\n-          const beforePosition = this.interpolatedTimeData[0][timePoints[i - 1]];\n-          const afterPosition = this.interpolatedTimeData[0][timePoints[i]];\n-          const ratio = getRatio(timePoints[i - 1], timePoints[i], time);\n-          currentPosition[0] = {\n-            ...beforePosition,\n-            time,\n-            ...interpolateOnLineSegment(beforePosition, afterPosition, this.settings.latKeyName, this.settings.lngKeyName, ratio)\n+    for(let j = 0; j < this.interpolatedTimeData.length; j++) {\n+      if (isUndefined(currentPosition[j])) {\n+        const timePoints = Object.keys(this.interpolatedTimeData[j]).map(item => parseInt(item, 10));\n+        for (let i = 1; i < timePoints.length; i++) {\n+          if (timePoints[i - 1] < time && timePoints[i] > time) {\n+            const beforePosition = this.interpolatedTimeData[j][timePoints[i - 1]];\n+            const afterPosition = this.interpolatedTimeData[j][timePoints[i]];\n+            const ratio = getRatio(timePoints[i - 1], timePoints[i], time);\n+            currentPosition[j] = {\n+              ...beforePosition,\n+              time,\n+              ...interpolateOnLineSegment(beforePosition, afterPosition, this.settings.latKeyName, this.settings.lngKeyName, ratio)\n+            }\n+            break;\n           }\n-          break;\n         }\n       }\n     }\n-    this.calcLabel();\n-    this.calcTooltip(currentPosition.find(position => position.entityName === this.activeTrip.entityName));\n+    for(let j = 0; j < this.interpolatedTimeData.length; j++) {\n+      if (isUndefined(currentPosition[j])) {\n+        currentPosition[j] = this.calculateLastPoints(this.interpolatedTimeData[j], time);\n+      }\n+    }\n+    this.calcLabel(currentPosition);\n+    this.calcTooltip(currentPosition, true);\n     if (this.mapWidget && this.mapWidget.map && this.mapWidget.map.map) {\n-      this.mapWidget.map.updatePolylines(this.interpolatedTimeData.map(ds => _.values(ds)), true, this.activeTrip);\n+      const formattedInterpolatedTimeData = this.interpolatedTimeData.map(ds => _.values(ds));\n+      this.mapWidget.map.updatePolylines(formattedInterpolatedTimeData, true);\n       if (this.settings.showPolygon) {\n         this.mapWidget.map.updatePolygons(this.interpolatedTimeData);\n       }\n       if (this.settings.showPoints) {\n-        this.mapWidget.map.updatePoints(_.values(_.union(this.interpolatedTimeData)[0]), this.calcTooltip);\n+        this.mapWidget.map.updatePoints(formattedInterpolatedTimeData, this.calcTooltip);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "235946691bfcb96fa0c10b689d6fc69b0c61bce5"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1344, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}