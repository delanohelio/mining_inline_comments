{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNTAxOTMz", "number": 3744, "title": "created sendApiFeatureStateEmail", "bodyText": "", "createdAt": "2020-11-17T15:34:49Z", "url": "https://github.com/thingsboard/thingsboard/pull/3744", "merged": true, "mergeCommit": {"oid": "25570041befcf6e5b7525b02f9b3656b915092d5"}, "closed": true, "closedAt": "2020-11-19T13:17:59Z", "author": {"login": "YevhenBondarenko"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddbdhHgFqTUzMjUwMjQ4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdduKnYAH2gAyNTIyNTAxOTMzOjVmN2U1MzM3OTY0YTM2NzViYjFlNGI2YjNhNzU2ZGUwZjU5YjEyYzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTAyNDg2", "url": "https://github.com/thingsboard/thingsboard/pull/3744#pullrequestreview-532502486", "createdAt": "2020-11-17T15:40:43Z", "commit": {"oid": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MDo0M1rOH07c1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MDo0M1rOH07c1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2MjAzNg==", "bodyText": "Please add info about the update to the log.", "url": "https://github.com/thingsboard/thingsboard/pull/3744#discussion_r525262036", "createdAt": "2020-11-17T15:40:43Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/apiusage/DefaultTbApiUsageStateService.java", "diffHunk": "@@ -286,7 +286,26 @@ private void persistAndNotify(TenantApiUsageState state, Map<ApiFeature, ApiUsag\n         List<TsKvEntry> stateTelemetry = new ArrayList<>();\n         result.forEach(((apiFeature, aState) -> stateTelemetry.add(new BasicTsKvEntry(ts, new StringDataEntry(apiFeature.getApiStateKey(), aState.name())))));\n         tsWsService.saveAndNotifyInternal(state.getTenantId(), state.getApiUsageState().getId(), stateTelemetry, VOID_CALLBACK);\n-        //TODO: notify tenant admin via email!\n+\n+        String email = tenantService.findTenantById(state.getTenantId()).getEmail();\n+\n+        if (StringUtils.isNotEmpty(email)) {\n+            result.forEach((apiFeature, stateValue) -> {\n+                ApiUsageRecordKey[] keys = ApiUsageRecordKey.getKeys(apiFeature);\n+                ApiUsageStateMailMessage[] msgs = new ApiUsageStateMailMessage[keys.length];\n+                for (int i = 0; i < keys.length; i++) {\n+                    ApiUsageRecordKey key = keys[i];\n+                    msgs[i] = new ApiUsageStateMailMessage(key, state.getProfileThreshold(key), state.get(key));\n+                }\n+                try {\n+                    mailService.sendApiFeatureStateEmail(apiFeature, stateValue, email, msgs);\n+                } catch (ThingsboardException e) {\n+                    log.warn(\"[{}] Can't send update of the API state to tenant with provided email [{}]\", state.getTenantId(), email, e);\n+                }\n+            });\n+        } else {\n+            log.warn(\"[{}] Can't send update of the API state to tenant with empty email!\", state.getTenantId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTAzMzM0", "url": "https://github.com/thingsboard/thingsboard/pull/3744#pullrequestreview-532503334", "createdAt": "2020-11-17T15:41:30Z", "commit": {"oid": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MTozMFrOH07fJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MTozMFrOH07fJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2MjYyOA==", "bodyText": "Let's move this to a separate thread. This may be very time consuming.", "url": "https://github.com/thingsboard/thingsboard/pull/3744#discussion_r525262628", "createdAt": "2020-11-17T15:41:30Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/apiusage/DefaultTbApiUsageStateService.java", "diffHunk": "@@ -286,7 +286,26 @@ private void persistAndNotify(TenantApiUsageState state, Map<ApiFeature, ApiUsag\n         List<TsKvEntry> stateTelemetry = new ArrayList<>();\n         result.forEach(((apiFeature, aState) -> stateTelemetry.add(new BasicTsKvEntry(ts, new StringDataEntry(apiFeature.getApiStateKey(), aState.name())))));\n         tsWsService.saveAndNotifyInternal(state.getTenantId(), state.getApiUsageState().getId(), stateTelemetry, VOID_CALLBACK);\n-        //TODO: notify tenant admin via email!\n+\n+        String email = tenantService.findTenantById(state.getTenantId()).getEmail();\n+\n+        if (StringUtils.isNotEmpty(email)) {\n+            result.forEach((apiFeature, stateValue) -> {\n+                ApiUsageRecordKey[] keys = ApiUsageRecordKey.getKeys(apiFeature);\n+                ApiUsageStateMailMessage[] msgs = new ApiUsageStateMailMessage[keys.length];\n+                for (int i = 0; i < keys.length; i++) {\n+                    ApiUsageRecordKey key = keys[i];\n+                    msgs[i] = new ApiUsageStateMailMessage(key, state.getProfileThreshold(key), state.get(key));\n+                }\n+                try {\n+                    mailService.sendApiFeatureStateEmail(apiFeature, stateValue, email, msgs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b60f65e0a9449ad8b78306ea3a092f7ccc2eda1b"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7e5337964a3675bb1e4b6b3a756de0f59b12c6", "author": {"user": {"login": "YevhenBondarenko", "name": "Yevhen Bondarenko"}}, "url": "https://github.com/thingsboard/thingsboard/commit/5f7e5337964a3675bb1e4b6b3a756de0f59b12c6", "committedDate": "2020-11-18T13:28:16Z", "message": "Improvements to the templates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3237, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}