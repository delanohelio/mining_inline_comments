{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMTY1NjEw", "number": 3208, "title": "Improvements/activity event reporting and clear alarm node", "bodyText": "", "createdAt": "2020-07-31T13:51:03Z", "url": "https://github.com/thingsboard/thingsboard/pull/3208", "merged": true, "mergeCommit": {"oid": "45e3c2297117ae29f800a4376f49c4a721f1a907"}, "closed": true, "closedAt": "2020-08-03T13:41:34Z", "author": {"login": "ShvaykaD"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6TEe9gH2gAyNDYwMTY1NjEwOjY5ZTJjM2Y4NjJmMmRjOTEyYTgwMTcwZmQzNGI2OWY4MmJjZjY2YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7P-DTAH2gAyNDYwMTY1NjEwOmNjN2MwOWNmZmJkNzU1ZDk2NjY3ZDY1M2I0NTY0MmYxZTRlMmNiMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69e2c3f862f2dc912a80170fd34b69f82bcf66af", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/69e2c3f862f2dc912a80170fd34b69f82bcf66af", "committedDate": "2020-07-31T12:06:47Z", "message": "changed logic to report activity & improvements for clear alarm node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b985a40c006936f7a72d6bfa61bf1b6976584a8", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/0b985a40c006936f7a72d6bfa61bf1b6976584a8", "committedDate": "2020-07-31T13:29:49Z", "message": "added buildAlarmDetails for clearAlarmByAlarmOriginator method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91", "committedDate": "2020-07-31T13:49:24Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODAxNjA2", "url": "https://github.com/thingsboard/thingsboard/pull/3208#pullrequestreview-459801606", "createdAt": "2020-08-03T07:23:29Z", "commit": {"oid": "21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzoyMzoyOVrOG6uyDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzoyMzoyOVrOG6uyDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIzNzA2OQ==", "bodyText": "ctx.logJsEvalResponse() not  ctx.logJsEvalRequest()", "url": "https://github.com/thingsboard/thingsboard/pull/3208#discussion_r464237069", "createdAt": "2020-08-03T07:23:29Z", "author": {"login": "ashvayka"}, "path": "rule-engine/rule-engine-components/src/main/java/org/thingsboard/rule/engine/action/TbClearAlarmNode.java", "diffHunk": "@@ -56,10 +57,38 @@ protected TbClearAlarmNodeConfiguration loadAlarmNodeConfig(TbNodeConfiguration\n     @Override\n     protected ListenableFuture<AlarmResult> processAlarm(TbContext ctx, TbMsg msg) {\n         String alarmType = TbNodeUtils.processPattern(this.config.getAlarmType(), msg.getMetaData());\n-        ListenableFuture<Alarm> latest = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n-        return Futures.transformAsync(latest, a -> {\n-            if (a != null && !a.getStatus().isCleared()) {\n-                return clearAlarm(ctx, msg, a);\n+        if (msg.getOriginator().getEntityType().equals(EntityType.ALARM)) {\n+            return clearAlarmByAlarmOriginator(ctx, msg);\n+        } else {\n+            ListenableFuture<Alarm> latest = ctx.getAlarmService().findLatestByOriginatorAndType(ctx.getTenantId(), msg.getOriginator(), alarmType);\n+            return Futures.transformAsync(latest, a -> {\n+                if (a != null && !a.getStatus().isCleared()) {\n+                    return clearAlarm(ctx, msg, a);\n+                }\n+                return Futures.immediateFuture(new AlarmResult(false, false, false, null));\n+            }, ctx.getDbCallbackExecutor());\n+        }\n+    }\n+\n+    private ListenableFuture<AlarmResult> clearAlarmByAlarmOriginator(TbContext ctx, TbMsg msg) {\n+        ListenableFuture<Alarm> alarmByIdAsync = ctx.getAlarmService().findAlarmByIdAsync(ctx.getTenantId(), new AlarmId(msg.getOriginator().getId()));\n+        return Futures.transformAsync(alarmByIdAsync, alarm -> {\n+            if (alarm != null && !alarm.getStatus().isCleared()) {\n+                ctx.logJsEvalRequest();\n+                ListenableFuture<JsonNode> asyncDetails = buildAlarmDetails(ctx, msg, alarm.getDetails());\n+                return Futures.transformAsync(asyncDetails, details -> {\n+                    ctx.logJsEvalRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ebe5b5e86af866a3628fc7ffd9c6fce4ab4e91"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc44fed70296dc50d7dcb0da4b9ca88983a2b79", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/2dc44fed70296dc50d7dcb0da4b9ca88983a2b79", "committedDate": "2020-08-03T10:54:40Z", "message": "refactoring & added alarmCanBeClearedWithAlarmOriginator test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5878613744ad8c30149fc828f6e27e81dc5ef9d", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/b5878613744ad8c30149fc828f6e27e81dc5ef9d", "committedDate": "2020-08-03T10:57:45Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7c09cffbd755d96667d653b45642f1e4e2cb04", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/cc7c09cffbd755d96667d653b45642f1e4e2cb04", "committedDate": "2020-08-03T11:03:58Z", "message": "Merge branch 'develop/2.5.3' of github.com:thingsboard/thingsboard into improvements/activity-event-reporting-and-clear-alarm-node"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3279, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}