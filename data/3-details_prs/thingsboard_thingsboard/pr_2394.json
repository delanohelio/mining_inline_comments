{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNzQzMDIw", "number": 2394, "title": "bug fixes & improvements / sql-timeseries (#2382)", "bodyText": "fixed the partion date extracting\n\n\nfix imports\n\n\nts-keys dictionary for latest, hsqldb\n\n\nremoved AbstractSimpleSqlTimeseriesDao class & fix beanCreationException in ThingsboardInstallService\n\n\ntimescale-db upgrade added\n\n\nadded postgreSQL upgrade\n\n\nfix logging\n\n\nrefactoring timeseries-dao implementation", "createdAt": "2020-02-06T07:10:00Z", "url": "https://github.com/thingsboard/thingsboard/pull/2394", "merged": true, "mergeCommit": {"oid": "bdee8951c49ca38c9d893873a98f297c1eca81bf"}, "closed": true, "closedAt": "2020-02-07T13:39:06Z", "author": {"login": "ashvayka"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBlUaBgH2gAyMzcxNzQzMDIwOmI0ZTQwNWY2ZDRhZmIwYzE5YzMwZWZjMDM4YTIxZmM3ZmEwYzI0OGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB_fKmAH2gAyMzcxNzQzMDIwOjE4ZTE4MzhiNmViNmIyOTJmYjM3Y2Y4ODZkMjhiOTczMWE5ODFmMzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/b4e405f6d4afb0c19c30efc038a21fc7fa0c248d", "committedDate": "2020-02-06T07:08:47Z", "message": "bug fixes & improvements / sql-timeseries (#2382)\n\n* fixed the partion date extracting\r\n\r\n* fix imports\r\n\r\n* ts-keys dictionary for latest, hsqldb\r\n\r\n* removed AbstractSimpleSqlTimeseriesDao class & fix beanCreationException in ThingsboardInstallService\r\n\r\n* timescale-db upgrade added\r\n\r\n* added postgreSQL upgrade\r\n\r\n* fix logging\r\n\r\n* refactoring timeseries-dao implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjM3MzUz", "url": "https://github.com/thingsboard/thingsboard/pull/2394#pullrequestreview-354237353", "createdAt": "2020-02-06T07:12:49Z", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxMjo0OVrOFmRFvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxMjo0OVrOFmRFvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MDIwNw==", "bodyText": "first_uuid_part", "url": "https://github.com/thingsboard/thingsboard/pull/2394#discussion_r375670207", "createdAt": "2020-02-06T07:12:49Z", "author": {"login": "ashvayka"}, "path": "application/src/main/data/upgrade/2.4.3/schema_update_psql_ts.sql", "diffHunk": "@@ -176,4 +200,52 @@ BEGIN\n END;\n $$ LANGUAGE 'plpgsql';\n \n+-- select insert_into_ts_kv_latest();\n+\n+CREATE OR REPLACE FUNCTION insert_into_ts_kv_latest() RETURNS void AS\n+$$\n+DECLARE\n+    insert_size CONSTANT integer := 10000;\n+    insert_counter       integer DEFAULT 0;\n+    insert_record        RECORD;\n+    insert_cursor CURSOR FOR SELECT CONCAT(first, '-', second, '-1', third, '-', fourth, '-', fifth)::uuid AS entity_id,\n+                                    substrings.key                                                         AS key,\n+                                    substrings.ts                                                          AS ts,\n+                                    substrings.bool_v                                                      AS bool_v,\n+                                    substrings.str_v                                                       AS str_v,\n+                                    substrings.long_v                                                      AS long_v,\n+                                    substrings.dbl_v                                                       AS dbl_v\n+                             FROM (SELECT SUBSTRING(entity_id, 8, 8)  AS first,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjM4MDQx", "url": "https://github.com/thingsboard/thingsboard/pull/2394#pullrequestreview-354238041", "createdAt": "2020-02-06T07:14:46Z", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxNDo0NlrOFmRH5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxNDo0NlrOFmRH5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MDc1Nw==", "bodyText": "wtf is substrings?", "url": "https://github.com/thingsboard/thingsboard/pull/2394#discussion_r375670757", "createdAt": "2020-02-06T07:14:46Z", "author": {"login": "ashvayka"}, "path": "application/src/main/data/upgrade/2.4.3/schema_update_psql_ts.sql", "diffHunk": "@@ -176,4 +200,52 @@ BEGIN\n END;\n $$ LANGUAGE 'plpgsql';\n \n+-- select insert_into_ts_kv_latest();\n+\n+CREATE OR REPLACE FUNCTION insert_into_ts_kv_latest() RETURNS void AS\n+$$\n+DECLARE\n+    insert_size CONSTANT integer := 10000;\n+    insert_counter       integer DEFAULT 0;\n+    insert_record        RECORD;\n+    insert_cursor CURSOR FOR SELECT CONCAT(first, '-', second, '-1', third, '-', fourth, '-', fifth)::uuid AS entity_id,\n+                                    substrings.key                                                         AS key,\n+                                    substrings.ts                                                          AS ts,\n+                                    substrings.bool_v                                                      AS bool_v,\n+                                    substrings.str_v                                                       AS str_v,\n+                                    substrings.long_v                                                      AS long_v,\n+                                    substrings.dbl_v                                                       AS dbl_v\n+                             FROM (SELECT SUBSTRING(entity_id, 8, 8)  AS first,\n+                                          SUBSTRING(entity_id, 4, 4)  AS second,\n+                                          SUBSTRING(entity_id, 1, 3)  AS third,\n+                                          SUBSTRING(entity_id, 16, 4) AS fourth,\n+                                          SUBSTRING(entity_id, 20)    AS fifth,\n+                                          key_id                      AS key,\n+                                          ts,\n+                                          bool_v,\n+                                          str_v,\n+                                          long_v,\n+                                          dbl_v\n+                                   FROM ts_kv_latest_old\n+                                            INNER JOIN ts_kv_dictionary ON (ts_kv_latest_old.key = ts_kv_dictionary.key)) AS substrings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjM5NDY2", "url": "https://github.com/thingsboard/thingsboard/pull/2394#pullrequestreview-354239466", "createdAt": "2020-02-06T07:18:52Z", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxODo1MlrOFmRMgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoxODo1MlrOFmRMgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MTkzOQ==", "bodyText": "Please drop the functions you have just created.", "url": "https://github.com/thingsboard/thingsboard/pull/2394#discussion_r375671939", "createdAt": "2020-02-06T07:18:52Z", "author": {"login": "ashvayka"}, "path": "application/src/main/java/org/thingsboard/server/service/install/PsqlTsDatabaseUpgradeService.java", "diffHunk": "@@ -70,20 +73,22 @@ public void upgradeDatabase(String fromVersion) throws Exception {\n                     log.info(\"Updating timeseries schema ...\");\n                     log.info(\"Load upgrade functions ...\");\n                     loadSql(conn);\n-                    log.info(\"Upgrade functions successfully loaded!\");\n                     boolean versionValid = checkVersion(conn);\n                     if (!versionValid) {\n                         log.info(\"PostgreSQL version should be at least more than 10!\");\n                         log.info(\"Please upgrade your PostgreSQL and restart the script!\");\n                     } else {\n                         log.info(\"PostgreSQL version is valid!\");\n                         log.info(\"Updating schema ...\");\n-                        executeFunction(conn, CREATE_PARTITION_TABLE);\n+                        executeFunction(conn, CREATE_PARTITION_TS_KV_TABLE);\n                         executeFunction(conn, CREATE_PARTITIONS);\n                         executeFunction(conn, CREATE_TS_KV_DICTIONARY_TABLE);\n                         executeFunction(conn, INSERT_INTO_DICTIONARY);\n                         executeFunction(conn, INSERT_INTO_TS_KV);\n-                        dropOldTable(conn, DROP_OLD_TABLE);\n+                        executeFunction(conn, CREATE_NEW_TS_KV_LATEST_TABLE);\n+                        executeFunction(conn, INSERT_INTO_TS_KV_LATEST);\n+                        dropOldTable(conn, DROP_TABLE_TS_KV_OLD);\n+                        dropOldTable(conn, DROP_TABLE_TS_KV_LATEST_OLD);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjQzMDMx", "url": "https://github.com/thingsboard/thingsboard/pull/2394#pullrequestreview-354243031", "createdAt": "2020-02-06T07:28:42Z", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoyODo0MlrOFmRXnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoyODo0MlrOFmRXnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NDc4MA==", "bodyText": "TYPO", "url": "https://github.com/thingsboard/thingsboard/pull/2394#discussion_r375674780", "createdAt": "2020-02-06T07:28:42Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/sqlts/AbstractPsqlHsqlTimeseriesDao.java", "diffHunk": "@@ -76,26 +63,39 @@ protected void destroy() {\n         }\n     }\n \n-    protected ListenableFuture<List<TsKvEntry>> findAllAsync(TenantId tenantId, EntityId entityId, ReadTsKvQuery query) {\n-        if (query.getAggregation() == Aggregation.NONE) {\n-            return findAllAsyncWithLimit(entityId, query);\n-        } else {\n-            long stepTs = query.getStartTs();\n-            List<ListenableFuture<Optional<TsKvEntry>>> futures = new ArrayList<>();\n-            while (stepTs < query.getEndTs()) {\n-                long startTs = stepTs;\n-                long endTs = stepTs + query.getInterval();\n-                long ts = startTs + (endTs - startTs) / 2;\n-                futures.add(findAndAggregateAsync(entityId, query.getKey(), startTs, endTs, ts, query.getAggregation()));\n-                stepTs = endTs;\n-            }\n-            return getTskvEntriesFuture(Futures.allAsList(futures));\n+    protected abstract ListenableFuture<Optional<TsKvEntry>> findAndAggregateAsync(TenantId tenantId, EntityId entityId, String key, long startTs, long endTs, long ts, Aggregation aggregation);\n+\n+    protected void switchAgregation(TenantId tenantId, EntityId entityId, String key, long startTs, long endTs, Aggregation aggregation, List<CompletableFuture<T>> entitiesFutures) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjQ1OTAz", "url": "https://github.com/thingsboard/thingsboard/pull/2394#pullrequestreview-354245903", "createdAt": "2020-02-06T07:36:27Z", "commit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzozNjoyN1rOFmRgpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzozNjoyN1rOFmRgpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NzA5Mg==", "bodyText": "AbstractChunkedAggregationTimeseriesDao", "url": "https://github.com/thingsboard/thingsboard/pull/2394#discussion_r375677092", "createdAt": "2020-02-06T07:36:27Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/sqlts/AbstractPsqlHsqlTimeseriesDao.java", "diffHunk": "@@ -15,43 +15,30 @@\n  */\n package org.thingsboard.server.dao.sqlts;\n \n-import com.google.common.util.concurrent.Futures;\n import com.google.common.util.concurrent.ListenableFuture;\n import com.google.common.util.concurrent.SettableFuture;\n import lombok.extern.slf4j.Slf4j;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.beans.factory.annotation.Value;\n import org.thingsboard.server.common.data.id.EntityId;\n import org.thingsboard.server.common.data.id.TenantId;\n import org.thingsboard.server.common.data.kv.Aggregation;\n-import org.thingsboard.server.common.data.kv.ReadTsKvQuery;\n import org.thingsboard.server.common.data.kv.TsKvEntry;\n import org.thingsboard.server.dao.model.sql.AbstractTsKvEntity;\n import org.thingsboard.server.dao.sql.TbSqlBlockingQueue;\n import org.thingsboard.server.dao.sql.TbSqlBlockingQueueParams;\n \n import javax.annotation.PostConstruct;\n import javax.annotation.PreDestroy;\n-import java.util.ArrayList;\n import java.util.List;\n import java.util.Optional;\n import java.util.concurrent.CompletableFuture;\n import java.util.stream.Collectors;\n \n @Slf4j\n-public abstract class AbstractSimpleSqlTimeseriesDao<T extends AbstractTsKvEntity> extends AbstractSqlTimeseriesDao {\n+public abstract class AbstractPsqlHsqlTimeseriesDao<T extends AbstractTsKvEntity> extends AbstractSqlTimeseriesDao {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e405f6d4afb0c19c30efc038a21fc7fa0c248d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e1838b6eb6b292fb37cf886d28b9731a981f34", "author": {"user": {"login": "ShvaykaD", "name": null}}, "url": "https://github.com/thingsboard/thingsboard/commit/18e1838b6eb6b292fb37cf886d28b9731a981f34", "committedDate": "2020-02-07T13:38:04Z", "message": "refactored sqlUpgradeService implementation (#2395)\n\n* refactored sqlUpgradeService implementation\r\n\r\n* fix typo\r\n\r\n* change string constant name\r\n\r\n* add ability to re-init chunks for upgrade timescale"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3304, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}