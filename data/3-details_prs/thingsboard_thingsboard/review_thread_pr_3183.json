{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTE5NTg3", "number": 3183, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODowMlrOET9oAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1MTowOVrOET9rNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzY4MDY0OnYy", "diffSide": "RIGHT", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODowMlrOG5_N3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODowMlrOG5_N3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1Nzc1OQ==", "bodyText": "Can't swap device that has entity views!", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463457759", "createdAt": "2020-07-31T07:48:02Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzY4MjQwOnYy", "diffSide": "RIGHT", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODo0NFrOG5_PCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0ODo0NFrOG5_PCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODA1Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458056", "createdAt": "2020-07-31T07:48:44Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzY4NTkyOnYy", "diffSide": "RIGHT", "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0OTo1OVrOG5_RNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo0OTo1OVrOG5_RNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODYxNQ==", "bodyText": "no need to delete audit logs", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463458615", "createdAt": "2020-07-31T07:49:59Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/device/DeviceServiceImpl.java", "diffHunk": "@@ -317,6 +335,36 @@ public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {\n                 }, MoreExecutors.directExecutor());\n     }\n \n+    @Transactional\n+    @CacheEvict(cacheNames = DEVICE_CACHE, key = \"{#device.tenantId, #device.name}\")\n+    @Override\n+    public Device swapDevice(TenantId tenantId, Device device) {\n+        log.trace(\"Executing swapDevice [{}]\", device);\n+\n+        try {\n+            List<EntityView> entityViews = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(device.getTenantId(), device.getId()).get();\n+            if (!CollectionUtils.isEmpty(entityViews)) {\n+                throw new DataValidationException(\"Can't swap device that is assigned to entity views!\");\n+            }\n+        } catch (ExecutionException | InterruptedException e) {\n+            log.error(\"Exception while finding entity views for deviceId [{}]\", device.getId(), e);\n+            throw new RuntimeException(\"Exception while finding entity views for deviceId [\" + device.getId() + \"]\", e);\n+        }\n+\n+        eventService.removeEvents(device.getTenantId(), device.getId());\n+\n+        relationService.removeRelations(device.getTenantId(), device.getId());\n+\n+        // TODO: 30/07/2020 implement for Cassandra\n+        if (sqlDatabaseUsed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzY4ODg0OnYy", "diffSide": "RIGHT", "path": "dao/src/main/java/org/thingsboard/server/dao/event/BaseEventService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1MTowOVrOG5_TKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzo1MTowOVrOG5_TKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1OTExNA==", "bodyText": "remove events here please.", "url": "https://github.com/thingsboard/thingsboard/pull/3183#discussion_r463459114", "createdAt": "2020-07-31T07:51:09Z", "author": {"login": "ashvayka"}, "path": "dao/src/main/java/org/thingsboard/server/dao/event/BaseEventService.java", "diffHunk": "@@ -94,6 +95,24 @@ public Event save(Event event) {\n         return eventDao.findLatestEvents(tenantId.getId(), entityId, eventType, limit);\n     }\n \n+    @Override\n+    public void removeEvents(TenantId tenantId, EntityId entityId) {\n+        List<Event> events = new ArrayList<>();\n+        TimePageData<Event> eventPageData;\n+        TimePageLink eventPageLink = new TimePageLink(1000);\n+        do {\n+            eventPageData = findEvents(tenantId, entityId, eventPageLink);\n+            events.addAll(eventPageData.getData());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09459c3988cfd2a1e89af10a6d18e3a534d509da"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1355, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}