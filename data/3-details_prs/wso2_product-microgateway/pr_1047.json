{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNzUwMTAz", "number": 1047, "title": "Change ballerina base dist and docker image", "bodyText": "Purpose\n\n\nRemove unused artifacts\nOS independent runtime distribution is no longer needed. Therefore removed it from the source.\nChange wum tool download\nwum tool is always downloaded when ant plugin is used to download wum tool. This is now done with download plugin to make use of m2 cache\nDownload b7a from dist\nmaven ballerina distribution artifacts doesn't contain b7a docker, k8s libs. Therefore we need to download the b7a dist from website.\nUpdate base image\nUsed a lightweight alpine based image to reduce the image size.\n\nIssues\n\nTask\nAutomation tests\n\nUnit tests added: No\nIntegration tests added: No\n\nTested environments\n\nMacOS\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-02-27T10:12:27Z", "url": "https://github.com/wso2/product-microgateway/pull/1047", "merged": true, "mergeCommit": {"oid": "83c00e5918b1143bbe92c821d4f2ed22f09cbf30"}, "closed": true, "closedAt": "2020-02-27T16:32:50Z", "author": {"login": "praminda"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIYjKIABqjMwNzcyMjc4NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcId9t0ABqjMwNzg1MzA5OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52a36d224fd5342a93f0e6dfaecce823ce676d5d", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/52a36d224fd5342a93f0e6dfaecce823ce676d5d", "committedDate": "2020-02-27T10:11:43Z", "message": "docker: Update base image\n\n1. Ballerina jdk requires a glib based base image. However default\nalpine image is built with musl not glibc. This causes mgw startup\nissues when http2 features are enabled. To resolve this we used a\nglib based alpine image 'alpine-glibc'. This image is shared in\nhttps://github.com/Docker-Hub-frolvlad/docker-alpine-glibc\n\n2. COPY command creates an unwanted layer in the docker image.\nTherefore we now use wget to pull the realeased runtime dist from\ngithub. This will increase both efficiency and portability of the\nDockerfile"}, "afterCommit": {"oid": "34f0cb6ac3e21caf6b522170082422febd9d82ca", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/34f0cb6ac3e21caf6b522170082422febd9d82ca", "committedDate": "2020-02-27T10:13:25Z", "message": "docker: Update base image\n\n1. Ballerina jdk requires a glib based base image. However default\nalpine image is built with musl not glibc. This causes mgw startup\nissues when http2 features are enabled. To resolve this we used a\nglib based alpine image 'alpine-glibc'. This image is shared in\nhttps://github.com/Docker-Hub-frolvlad/docker-alpine-glibc\n\n2. COPY command creates an unwanted layer in the docker image.\nTherefore we now use wget to pull the realeased runtime dist from\ngithub. This will increase both efficiency and portability of the\nDockerfile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzIzNTQ5", "url": "https://github.com/wso2/product-microgateway/pull/1047#pullrequestreview-365723549", "createdAt": "2020-02-27T14:27:06Z", "commit": {"oid": "34f0cb6ac3e21caf6b522170082422febd9d82ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDoyNzowNlrOFvUSsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDoyNzowNlrOFvUSsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE1OTg1OQ==", "bodyText": "Is this key has a expiry time", "url": "https://github.com/wso2/product-microgateway/pull/1047#discussion_r385159859", "createdAt": "2020-02-27T14:27:06Z", "author": {"login": "Rajith90"}, "path": "docker/Dockerfile", "diffHunk": "@@ -41,47 +41,78 @@ ARG MOTD='printf \"\\n\\\n  This Docker container comprises of a WSO2 product, running with its latest GA release \\n\\\n  which is under the Apache License, Version 2.0. \\n\\\n  Read more about Apache License, Version 2.0 here @ http://www.apache.org/licenses/LICENSE-2.0.\\n\"'\n-ENV ENV=${USER_HOME}\"/.bashrc\"\n-\n-# create the non-root user and group and set MOTD login message\n-RUN \\\n-    groupadd -r -g ${USER_GROUP_ID} ${USER_GROUP} \\\n-    && useradd -m -r -u ${USER_ID} -d ${USER_HOME} -g ${USER_GROUP} ${USER} \\\n-    && echo ${MOTD} > \"${ENV}\"\n-\n-# To avoid warning message due to APIIUtils\n-ENV DEBCONF_NOWARNINGS yes\n-\n+ENV ENV=${USER_HOME}\"/.ashrc\"\n+\n+# GLIB based alpine image (alpine-glib) source is generously borrowed\n+# From https://github.com/Docker-Hub-frolvlad/docker-alpine-glibc\n+# Here we install GNU libc (aka glibc) and set C.UTF-8 locale as default.\n+RUN ALPINE_GLIBC_BASE_URL=\"https://github.com/sgerrand/alpine-pkg-glibc/releases/download\" && \\\n+    ALPINE_GLIBC_PACKAGE_VERSION=\"2.30-r0\" && \\\n+    ALPINE_GLIBC_BASE_PACKAGE_FILENAME=\"glibc-$ALPINE_GLIBC_PACKAGE_VERSION.apk\" && \\\n+    ALPINE_GLIBC_BIN_PACKAGE_FILENAME=\"glibc-bin-$ALPINE_GLIBC_PACKAGE_VERSION.apk\" && \\\n+    ALPINE_GLIBC_I18N_PACKAGE_FILENAME=\"glibc-i18n-$ALPINE_GLIBC_PACKAGE_VERSION.apk\" && \\\n+    apk add --no-cache --virtual=.build-dependencies wget ca-certificates && \\\n+    echo \\\n+        \"-----BEGIN PUBLIC KEY-----\\\n+        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApZ2u1KJKUu/fW4A25y9m\\\n+        y70AGEa/J3Wi5ibNVGNn1gT1r0VfgeWd0pUybS4UmcHdiNzxJPgoWQhV2SSW1JYu\\\n+        tOqKZF5QSN6X937PTUpNBjUvLtTQ1ve1fp39uf/lEXPpFpOPL88LKnDBgbh7wkCp\\\n+        m2KzLVGChf83MS0ShL6G9EQIAUxLm99VpgRjwqTQ/KfzGtpke1wqws4au0Ab4qPY\\\n+        KXvMLSPLUp7cfulWvhmZSegr5AdhNw5KNizPqCJT8ZrGvgHypXyiFvvAH5YRtSsc\\\n+        Zvo9GI2e2MaZyo9/lvb+LbLEJZKEQckqRj4P26gmASrZEPStwc+yqy1ShHLA0j6m\\\n+        1QIDAQAB\\\n+        -----END PUBLIC KEY-----\" | sed 's/   */\\n/g' > \"/etc/apk/keys/sgerrand.rsa.pub\" && \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f0cb6ac3e21caf6b522170082422febd9d82ca"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzkzMjQ1", "url": "https://github.com/wso2/product-microgateway/pull/1047#pullrequestreview-365793245", "createdAt": "2020-02-27T16:14:09Z", "commit": {"oid": "c9670d89eeadeab34355421c0de512b48e5f31a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5987365f3788dbe05c7c3f3e45dee1362db1b58", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/d5987365f3788dbe05c7c3f3e45dee1362db1b58", "committedDate": "2020-02-27T16:31:17Z", "message": "mvn: Remove unused artifacts\n\nplatform independent runtime artifact is no longer needed.\nAlso ballerina runtime generation is not required since we don't\ncreate a distribution containing ballerina runtime now. Everthing\nis packed into the final jar produced by ballerina build."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f219bc8d428da8cf702431a40a539eaf62cc7a14", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/f219bc8d428da8cf702431a40a539eaf62cc7a14", "committedDate": "2020-02-27T16:31:17Z", "message": "mvn: Change wum tool download\n\nant plugin based method always downloads the update.zip file which\nis inefficient. With download plugin update.zip will be cached in\nlocal m2 repo and will be reused."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f78321a3f37faa030408cd7e1772755e5e65965", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/2f78321a3f37faa030408cd7e1772755e5e65965", "committedDate": "2020-02-27T16:31:17Z", "message": "mvn: Download b7a from dist\n\nNew ballerina distributions with docker and k8s dependencies should\nbe downloaded from product-dist. Maven artifacts doesn't contain\nabove mentioned artifacts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4cea92857a8882a8d4bcc748ffcedbef63205cd", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/b4cea92857a8882a8d4bcc748ffcedbef63205cd", "committedDate": "2020-02-27T16:31:49Z", "message": "docker: Update base image\n\n1. Ballerina jdk requires a glib based base image. However default\nalpine image is built with musl not glibc. This causes mgw startup\nissues when http2 features are enabled. To resolve this we used a\nglib based alpine image 'alpine-glibc'. This image is shared in\nhttps://github.com/Docker-Hub-frolvlad/docker-alpine-glibc\n\n2. COPY command creates an unwanted layer in the docker image.\nTherefore we now use wget to pull the realeased runtime dist from\ngithub. This will increase both efficiency and portability of the\nDockerfile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9670d89eeadeab34355421c0de512b48e5f31a3", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/c9670d89eeadeab34355421c0de512b48e5f31a3", "committedDate": "2020-02-27T15:42:34Z", "message": "docker: Update pub cert for glib"}, "afterCommit": {"oid": "b4cea92857a8882a8d4bcc748ffcedbef63205cd", "author": {"user": {"login": "praminda", "name": "Praminda"}}, "url": "https://github.com/wso2/product-microgateway/commit/b4cea92857a8882a8d4bcc748ffcedbef63205cd", "committedDate": "2020-02-27T16:31:49Z", "message": "docker: Update base image\n\n1. Ballerina jdk requires a glib based base image. However default\nalpine image is built with musl not glibc. This causes mgw startup\nissues when http2 features are enabled. To resolve this we used a\nglib based alpine image 'alpine-glibc'. This image is shared in\nhttps://github.com/Docker-Hub-frolvlad/docker-alpine-glibc\n\n2. COPY command creates an unwanted layer in the docker image.\nTherefore we now use wget to pull the realeased runtime dist from\ngithub. This will increase both efficiency and portability of the\nDockerfile"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1172, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}