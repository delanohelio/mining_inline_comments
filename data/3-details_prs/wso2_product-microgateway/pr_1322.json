{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjUwNzUy", "number": 1322, "title": "Fix #1321 - Multiple jwt issuer subscription validation issue", "bodyText": "Purpose\nThere can be inconsistencies when validating subscriptions when multiple jwt issuers are configured.\nIssues\n\nFixes #1321\nAutomation tests\n\nUnit tests added: Yes/No\nIntegration tests added: Yes/No\n\nTested environments\n\nNot Tested\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-07-13T13:19:07Z", "url": "https://github.com/wso2/product-microgateway/pull/1322", "merged": true, "mergeCommit": {"oid": "743a367c6fab66195be0d7a6908dca1e1b6a49ab"}, "closed": true, "closedAt": "2020-07-14T10:33:30Z", "author": {"login": "Rajith90"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0hS1ZgH2gAyNDQ4MjUwNzUyOjljNmM5MDhkN2UwYTJhZWVkNmIwMmJlNDQzOTRhMDRlYzVmYTNmZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0ziVIAH2gAyNDQ4MjUwNzUyOmY4NzEwZmI4NzI1MTdiMmJjYzhjMjdiOWJlM2ViMGE2YjhhY2RhY2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "author": {"user": {"login": "Rajith90", "name": "Rajith Roshan"}}, "url": "https://github.com/wso2/product-microgateway/commit/9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "committedDate": "2020-07-13T13:17:35Z", "message": "Fix #1321 - Multiple jwt issuer subscription validation issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjU5OTMz", "url": "https://github.com/wso2/product-microgateway/pull/1322#pullrequestreview-447259933", "createdAt": "2020-07-13T13:40:15Z", "commit": {"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0MDoxNVrOGwpBFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo1MDoyNlrOGwpdTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1Njg1NQ==", "bodyText": "We can just return true here, right?", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453656855", "createdAt": "2020-07-13T13:40:15Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal", "diffHunk": "@@ -181,7 +178,7 @@ public function handleSubscribedAPIs(string apiKeyToken, jwt:JwtPayload payload,\n                     + authenticationContext.subscriberTenantDomain);\n                 }\n                 invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-                return true;\n+                isAllowed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1OTIxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    printDebug(JWT_UTIL, \"jwt found from the jwt cache\");\n          \n          \n            \n                    printDebug(JWT_UTIL, \"jwt found from the api key cache\");", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453659211", "createdAt": "2020-07-13T13:43:39Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal", "diffHunk": "@@ -197,25 +194,44 @@ public function handleSubscribedAPIs(string apiKeyToken, jwt:JwtPayload payload,\n         + authenticationContext.subscriberTenantDomain);\n     }\n     invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-    return false;\n+    return isAllowed;\n }\n \n-public function getDecodedJWTPayload(string jwtToken) returns @tainted (jwt:JwtPayload | error) {\n-    //decode jwt\n-    var cachedJwt = trap <jwt:InboundJwtCacheEntry>jwtCache.get(jwtToken);\n+public function getDecodedJWTPayloadOfAPIKey(string jwtToken) returns @tainted (jwt:JwtPayload | error) {\n+    var cachedJwt = trap <jwt:InboundJwtCacheEntry>apiKeyCache.get(jwtToken);\n     if (cachedJwt is jwt:InboundJwtCacheEntry) {\n         printDebug(JWT_UTIL, \"jwt found from the jwt cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NDA3OA==", "bodyText": "validateSubscription is false by default right? If so, why do we need to add it here?", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453664078", "createdAt": "2020-07-13T13:50:26Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "tests/src/test/resources/confs/default-test-config.conf", "diffHunk": "@@ -5,6 +5,7 @@\n \n [[jwtTokenConfig]]\n   issuer=\"https://localhost:9443/oauth2/token\"\n+  validateSubscription = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8710fb872517b2bcc8c27b9be3eb0a6b8acdace", "author": {"user": {"login": "Rajith90", "name": "Rajith Roshan"}}, "url": "https://github.com/wso2/product-microgateway/commit/f8710fb872517b2bcc8c27b9be3eb0a6b8acdace", "committedDate": "2020-07-14T10:32:48Z", "message": "Update components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal\n\nCo-authored-by: Amali Matharaarachchi <amalim@wso2.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1121, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}