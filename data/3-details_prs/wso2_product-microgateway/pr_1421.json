{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMDU1NjQw", "number": 1421, "title": "Add caching capability for JWT Token validation.", "bodyText": "Purpose\nThis PR will add a caching mechanism to the JWT token validation flow.\nIssues\n\nFixes #\nAutomation tests\n\nUnit tests added: Yes/No\nIntegration tests added: Yes/No\n\nTested environments\n\nNot Tested\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-09-25T13:00:44Z", "url": "https://github.com/wso2/product-microgateway/pull/1421", "merged": true, "mergeCommit": {"oid": "333a9e09f75a1b0da0d924aae60d13ab0256c934"}, "closed": true, "closedAt": "2020-09-28T10:34:42Z", "author": {"login": "ShalkiWenushika"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMVRSegH2gAyNDkzMDU1NjQwOmZhYjViN2FiZjI4MjVmMjQxZjcwOTExZjcwMzA4NzQyNWI1MjlhNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNRHRngFqTQ5NzM4NjY0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fab5b7abf2825f241f70911f703087425b529a44", "author": {"user": {"login": "ShalkiWenushika", "name": "Shalki Wenushika"}}, "url": "https://github.com/wso2/product-microgateway/commit/fab5b7abf2825f241f70911f703087425b529a44", "committedDate": "2020-09-25T12:51:13Z", "message": "Add token caching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "author": {"user": {"login": "ShalkiWenushika", "name": "Shalki Wenushika"}}, "url": "https://github.com/wso2/product-microgateway/commit/542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "committedDate": "2020-09-25T12:54:14Z", "message": "Correct formatting issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTM3OTc5", "url": "https://github.com/wso2/product-microgateway/pull/1421#pullrequestreview-496537979", "createdAt": "2020-09-25T15:42:51Z", "commit": {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNTo0Mjo1MVrOHYI7cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNTo0Mjo1MVrOHYI7cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA3NDE2MQ==", "bodyText": "Lets read this from environment variable, so we can run perf without code changes for cache enable and disable cases", "url": "https://github.com/wso2/product-microgateway/pull/1421#discussion_r495074161", "createdAt": "2020-09-25T15:42:51Z", "author": {"login": "Rajith90"}, "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -33,14 +33,43 @@\n import java.util.Base64;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n import com.nimbusds.jose.JOSEException;\n import com.nimbusds.jose.JWSHeader;\n import com.nimbusds.jwt.JWTClaimsSet;\n import com.nimbusds.jwt.JWTParser;\n import com.nimbusds.jwt.SignedJWT;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n \n public class JWTValidator{\n     private static RSAPublicKey publicKey = readPublicKey();\n+    private static JWSVerifier jwsVerifier = new RSASSAVerifier(publicKey);\n+    private static boolean enableCache = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTM4NzE1", "url": "https://github.com/wso2/product-microgateway/pull/1421#pullrequestreview-496538715", "createdAt": "2020-09-25T15:43:51Z", "commit": {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNTo0Mzo1MVrOHYI9mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNTo0Mzo1MVrOHYI9mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA3NDcxNA==", "bodyText": "Lets remove the logs(sout), in order to run the perf tests. Check other places as well", "url": "https://github.com/wso2/product-microgateway/pull/1421#discussion_r495074714", "createdAt": "2020-09-25T15:43:51Z", "author": {"login": "Rajith90"}, "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -81,11 +110,38 @@ public static boolean validateSignature(String jwtToken, String signature){\n         JWTClaimsSet payload = null;\n         SignedJWT parsedJWTToken;\n         boolean isVerified = false;\n-        try{\n-            parsedJWTToken = (SignedJWT) JWTParser.parse(jwtToken);\n-            isVerified = verifyTokenSignature(parsedJWTToken);\n-        }catch (ParseException e) {\n-            System.out.println(\"Invalid JWT token. Failed to decode the token.\");\n+        try {\n+            if (enableCache) {\n+                if(GatewayApiKeyCache.get(signature) != JWTConstants.UNAVAILABLE){\n+                    System.out.println(\"Api Key retrieved from the Api Key cache.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5088d76a9b98edc9402375345efb70c881c43556", "author": {"user": {"login": "ShalkiWenushika", "name": "Shalki Wenushika"}}, "url": "https://github.com/wso2/product-microgateway/commit/5088d76a9b98edc9402375345efb70c881c43556", "committedDate": "2020-09-28T05:57:52Z", "message": "Add changes to read a variable from environment variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MjA2MTcx", "url": "https://github.com/wso2/product-microgateway/pull/1421#pullrequestreview-497206171", "createdAt": "2020-09-28T06:01:40Z", "commit": {"oid": "5088d76a9b98edc9402375345efb70c881c43556"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Mzg2NjQ4", "url": "https://github.com/wso2/product-microgateway/pull/1421#pullrequestreview-497386648", "createdAt": "2020-09-28T10:34:35Z", "commit": {"oid": "5088d76a9b98edc9402375345efb70c881c43556"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 968, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}