{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDY1MzY3", "number": 966, "title": "Create docker base image for microgateway runtime", "bodyText": "Purpose\nCreate the docker image for the microgateway runtime.\nChange the gateway script such that the config file could be overwritten by providing a command-line argument.\nIssues\nFixes #842\nAutomation tests\n\nUnit tests added: No\nIntegration tests added: No\n\nTested environments\nMacOS Mojave\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-02-03T18:45:29Z", "url": "https://github.com/wso2/product-microgateway/pull/966", "merged": true, "mergeCommit": {"oid": "72f748c54341916fd05b9f5ebf1ebb03250f2171"}, "closed": true, "closedAt": "2020-02-10T17:44:27Z", "author": {"login": "VirajSalaka"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-qoaJgH2gAyMzcwNDY1MzY3OmUxZjRhMTY4NzkwMzUzM2VjY2E3Yzc1OTJhZjI1ZjhiNmM3N2JjZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDAzqWgFqTM1NjEzNTA1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1f4a1687903533ecca7c7592af25f8b6c77bcf6", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/e1f4a1687903533ecca7c7592af25f8b6c77bcf6", "committedDate": "2020-01-28T05:38:23Z", "message": "Basic image is created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd358ab80e3d384adf83efd8174179679e2249e", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/8bd358ab80e3d384adf83efd8174179679e2249e", "committedDate": "2020-01-29T09:43:42Z", "message": "apim 2.6 configs and JAVA_OPTS gc variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b47d94cf8b9c7e6f960f23a702fb10bcb1779eaa", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/b47d94cf8b9c7e6f960f23a702fb10bcb1779eaa", "committedDate": "2020-02-03T18:26:09Z", "message": "complete docker image and provide CMD from gateway executable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2296833a8a90ea334fdcd778336a9f1e09572454", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/2296833a8a90ea334fdcd778336a9f1e09572454", "committedDate": "2020-02-03T18:27:14Z", "message": "change gateway executable such that the config file parameter can be overwritten"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/086db46dc4825052197c82a17ebeed1ebe3cd31a", "committedDate": "2020-02-03T18:44:19Z", "message": "remove unnecessary statements from dockerfile:"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTA3NzIy", "url": "https://github.com/wso2/product-microgateway/pull/966#pullrequestreview-353507722", "createdAt": "2020-02-05T07:24:35Z", "commit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzoyNDozNVrOFlt4Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzoyNDozNVrOFlt4Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzI2Nw==", "bodyText": "Why do we need 0.14 which is AM 260 rest version? Even if we need to use compatibility version then this has to be 0.15 IMO", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375093267", "createdAt": "2020-02-05T07:24:35Z", "author": {"login": "praminda"}, "path": "distribution/resources/cli-conf/toolkit-config.toml", "diffHunk": "@@ -3,7 +3,7 @@ httpRequestTimeout = 1000000\n \n [token]\n baseURL = \"\"\n-restVersion = \"v1.0\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTA3Nzc0", "url": "https://github.com/wso2/product-microgateway/pull/966#pullrequestreview-353507774", "createdAt": "2020-02-05T07:24:42Z", "commit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzoyNDo0M1rOFlt4Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNzoyNDo0M1rOFlt4Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzMwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{/if}}\n          \n          \n            \n            {{/if}}", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375093306", "createdAt": "2020-02-05T07:24:43Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/resources/templates/dockerConfig.mustache", "diffHunk": "@@ -11,6 +11,7 @@\n     debugPort:\"{{containerConfig.docker.dockerConfig.debugPort}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.push}},\n     push:{{containerConfig.docker.dockerConfig.push}}{{/if}}{{#if containerConfig.docker.dockerConfig.username}},\n     username:\"{{containerConfig.docker.dockerConfig.username}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.password}},\n-    password:\"{{containerConfig.docker.dockerConfig.password}}\"{{/if}}\n+    password:\"{{containerConfig.docker.dockerConfig.password}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.cmd}},\n+    cmd: \"{{containerConfig.docker.dockerConfig.cmd}}\"{{/if}}\n }\n {{/if}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjA0OTE3", "url": "https://github.com/wso2/product-microgateway/pull/966#pullrequestreview-354204917", "createdAt": "2020-02-06T05:16:29Z", "commit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNToxNjozMFrOFmPgFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNToxNjozMFrOFmPgFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NDE4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            restVersion = \"v0.14\"\n          \n          \n            \n            restVersion = \"v1.0\"", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375644181", "createdAt": "2020-02-06T05:16:30Z", "author": {"login": "Rajith90"}, "path": "distribution/resources/cli-conf/toolkit-config.toml", "diffHunk": "@@ -3,7 +3,7 @@ httpRequestTimeout = 1000000\n \n [token]\n baseURL = \"\"\n-restVersion = \"v1.0\"\n+restVersion = \"v0.14\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Njk3MjA3", "url": "https://github.com/wso2/product-microgateway/pull/966#pullrequestreview-355697207", "createdAt": "2020-02-10T05:26:50Z", "commit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNToyNjo1MFrOFnah8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNTo1OTozMlrOFna45A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3MzQ1Ng==", "bodyText": "Shall we move this docker related logic to separate method", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376873456", "createdAt": "2020-02-10T05:26:50Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/cmd/BuildCmd.java", "diffHunk": "@@ -220,8 +220,7 @@ private void init(String projectName, String configPath, String deploymentConfig\n                 copyFile.setIsBallerinaConf(\"true\");\n                 copyFile.setSource(CmdUtils.getResourceFolderLocation() + File.separator + CliConstants.GW_DIST_CONF\n                         + File.separator + CliConstants.MICRO_GW_CONF_FILE);\n-                copyFile.setTarget(File.separator + CliConstants.WSO2 + File.separator + CliConstants.MGW", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTUwMA==", "bodyText": "Remove this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              echo \"JAVA_HOME...\"", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376875500", "createdAt": "2020-02-10T05:38:32Z", "author": {"login": "praminda"}, "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -45,11 +45,13 @@ PRGDIR=`dirname \"$PRG\"`\n \n # set BALLERINA_HOME\n GW_HOME=`cd \"$PRGDIR/..\" ; pwd`\n-export JAVA_HOME=$GW_HOME'/lib/jdk8u202-b08-jre'\n export MGW_VERSION=\"3.1.0\"\n \n JAVA_PATH=$GW_HOME/lib/jdk8u202-b08-jre\n-if [ -d \"$JAVA_PATH\" ]; then\n+if [ -d \"$JAVA_HOME\" ]; then\n+  echo \"JAVA_HOME is externally set: $JAVA_HOME\"\n+else\n+  echo \"JAVA_HOME...\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTY1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              echo $JAVA_HOME", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376875659", "createdAt": "2020-02-10T05:39:27Z", "author": {"login": "praminda"}, "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -85,8 +87,8 @@ fi\n \n # For Migwn, ensure paths are in UNIX format before anything is touched\n if $mingw ; then\n-  [ -n \"$JAVA_HOME\" ] &&\n-    JAVA_HOME=\"`(cd \"$JAVA_HOME\"; pwd)`\"\n+  echo $JAVA_HOME", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjA0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Error: Microgateway is supported only on JDK 1.8\"\n          \n          \n            \n                echo \"Error: Microgateway is supported only on Java 1.8\"", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876040", "createdAt": "2020-02-10T05:41:29Z", "author": {"login": "praminda"}, "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -102,6 +104,12 @@ if [ -z \"$JAVACMD\" ] ; then\n     fi\n fi\n \n+JDK_18=`$JAVACMD -version 2>&1 | grep \"1.8.\"`\n+if [ \"$JDK_18\" = \"\" ]; then\n+    echo \"Error: Microgateway is supported only on JDK 1.8\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjM1MQ==", "bodyText": "As per the discussion we had regarding docker config loading, we don't need this change anymore", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876351", "createdAt": "2020-02-10T05:42:58Z", "author": {"login": "praminda"}, "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -167,7 +175,7 @@ java_cmd_gateway () {\n     $JAVA_OPTS \\\n     -Dmgw-runtime.home=${GW_HOME} \\\n     -Dballerina.home=${GW_HOME} \\\n-    -jar $args --api.usage.data.path=$GW_HOME/api-usage-data --b7a.http.accesslog.path=$GW_HOME/logs/access_logs --b7a.config.file=$GW_HOME/conf/micro-gw.conf 2>&1 | tee -a $GW_HOME/logs/microgateway.log\n+    -jar ${args[0]} --api.usage.data.path=$GW_HOME/api-usage-data --b7a.http.accesslog.path=$GW_HOME/logs/access_logs --b7a.config.file=$GW_HOME/conf/micro-gw.conf ${args[@]:1}  2>&1 | tee -a $GW_HOME/logs/microgateway.log", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjgzOQ==", "bodyText": "Suggested change", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876839", "createdAt": "2020-02-10T05:45:36Z", "author": {"login": "praminda"}, "path": "docker/Dockerfile", "diffHunk": "@@ -1,3 +1,4 @@\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NzI2Mg==", "bodyText": "Use specific version of the image", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376877262", "createdAt": "2020-02-10T05:48:00Z", "author": {"login": "praminda"}, "path": "docker/Dockerfile", "diffHunk": "@@ -17,33 +18,70 @@\n FROM openjdk:jre-alpine", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3OTMzMg==", "bodyText": "Use ${USER}", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376879332", "createdAt": "2020-02-10T05:59:32Z", "author": {"login": "praminda"}, "path": "docker/Dockerfile", "diffHunk": "@@ -17,33 +18,70 @@\n FROM openjdk:jre-alpine\n LABEL maintainer=\"dev@wso2.org\"\n \n-# Ballerina runtime distribution filename.\n+# Microgateway runtime distribution filename.\n ARG MGW_DIST\n+ARG USER=ballerina\n+ARG USER_ID=802\n+ARG USER_GROUP=ballerina\n+ARG USER_GROUP_ID=802\n+ARG USER_HOME=/home/${USER}\n+\n+# build arguments for WSO2 product installation\n+ARG MGW_SERVER_NAME=wso2am-micro-gw-linux\n+ARG MGW_SERVER_VERSION=3.1.0-SNAPSHOT\n+ARG MGW_SERVER=${MGW_SERVER_NAME}-${MGW_SERVER_VERSION}\n+ARG MGW_SERVER_HOME=${USER_HOME}/${MGW_SERVER}\n+ARG MGW_RUNTIME_HOME=${USER_HOME}/wso2\n+ARG INTERNAL_JRE=jdk8u202-b08-jre\n+\n+# build argument for MOTD\n+ARG MOTD='printf \"\\n\\\n+ Welcome to WSO2 Docker Resources \\n\\\n+ --------------------------------- \\n\\\n+ This Docker container comprises of a WSO2 product, running with its latest GA release \\n\\\n+ which is under the Apache License, Version 2.0. \\n\\\n+ Read more about Apache License, Version 2.0 here @ http://www.apache.org/licenses/LICENSE-2.0.\\n\"'\n+ENV ENV=${USER_HOME}\"/.ashrc\"\n+\n+# create the non-root user and group and set MOTD login message\n+RUN \\\n+    addgroup -S -g ${USER_GROUP_ID} ${USER_GROUP} \\\n+    && adduser -S -u ${USER_ID} -h ${USER_HOME} -G ${USER_GROUP} ${USER} \\\n+    && echo ${MOTD} > \"${ENV}\"\n \n-# Add Ballerina runtime.\n-COPY ${MGW_DIST} /root/\n-\n-# Create folders, unzip distribution, create users, & set permissions.\n-RUN mkdir -p /wso2/files \\\n-    && addgroup wso2 \\\n-    && adduser -S -s /bin/bash -g 'wso2' -G wso2 -D wso2 \\\n-    && apk add --update --no-cache bash \\\n-    && unzip /root/${MGW_DIST} -d /wso2/ > /dev/null 2>&1 \\\n-    && mv /wso2/wso2* /wso2/mgw \\\n-    && mkdir -p /wso2/mgw/runtime \\\n-    && unzip /wso2/mgw/runtime.zip -d wso2/mgw/runtime \\\n-    && rm -rf /wso2/mgw/runtime.zip \\\n-    && cp /wso2/mgw/lib/gateway/*.jar /wso2/mgw/runtime/bre/lib/ \\\n-    && chown -R wso2:wso2 /wso2 \\\n-    && rm -rf /root/${MGW_DIST} > /dev/null 2>&1 \\\n+RUN \\\n+    apk add --update --no-cache \\\n+        bash \\\n+        libxml2-utils \\\n+        netcat-openbsd \\\n     && rm -rf /var/cache/apk/*\n \n-ENV BALLERINA_HOME /wso2/mgw/runtime\n-ENV PATH $BALLERINA_HOME/bin:$PATH\n+COPY  runtime/ /root/\n+# Create folders, unzip distribution\n+RUN \\\n+    unzip /root/${MGW_SERVER}.zip -d /home/ballerina/ >/dev/null 2>&1 \\\n+    && rm -rf /home/ballerina/${MGW_SERVER}/lib/${INTERNAL_JRE} \\\n+    && mkdir -p /home/ballerina/conf \\\n+    && mv /home/ballerina/${MGW_SERVER} ${MGW_RUNTIME_HOME} \\\n+    && cp ${MGW_RUNTIME_HOME}/conf/micro-gw.conf ${USER_HOME}/conf/micro-gw.conf \\\n+    && chown ${USER}:${USER_GROUP} -R ${USER_HOME}  \\\n+    && rm -rf /root/${MGW_SERVER}.zip > /dev/null 2>&1\n+\n+ENV BALLERINA_HOME ${MGW_RUNTIME_HOME}/runtime\n+ENV GW_HOME ${MGW_RUNTIME_HOME}\n+ENV PATH $GW_HOME/bin:$PATH\n+\n+WORKDIR /home/ballerina\n+\n+USER ballerina", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe1f68c2c9d1d39e961d2664256249498d69c5aa", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/fe1f68c2c9d1d39e961d2664256249498d69c5aa", "committedDate": "2020-02-10T17:22:00Z", "message": "fix commented issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTM1MDU3", "url": "https://github.com/wso2/product-microgateway/pull/966#pullrequestreview-356135057", "createdAt": "2020-02-10T17:44:17Z", "commit": {"oid": "fe1f68c2c9d1d39e961d2664256249498d69c5aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1136, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}