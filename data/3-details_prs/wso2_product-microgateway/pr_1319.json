{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NDQ0Mjg0", "number": 1319, "title": "Support analytics versioning.", "bodyText": "Purpose\nThis PR adds support for using multiple analytics versions. (3.0.0, 3.1.0, 3.2.0)\nIssues\n\nFixes #1325\nAutomation tests\n\nUnit tests added: Yes/No\nIntegration tests added: Yes/No\n\nTested environments\n\nNot Tested\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-07-10T13:34:53Z", "url": "https://github.com/wso2/product-microgateway/pull/1319", "merged": true, "mergeCommit": {"oid": "ea53ed9e4468346eae8cf8089e92aa925a489010"}, "closed": true, "closedAt": "2020-07-15T12:57:44Z", "author": {"login": "menakaj"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0KKoAAFqTQ0Njg2NTI1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1KNA4AFqTQ0ODkyNTA5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODY1MjUy", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-446865252", "createdAt": "2020-07-12T10:20:48Z", "commit": {"oid": "7dd4965de40af88524f47f5f579bffb01e67d27b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMDoyMDo0OFrOGwTFGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMDoyMDo0OFrOGwTFGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5NzQzMw==", "bodyText": "Lets not make this exact match. Starting from 3.2.0 version should be the condition", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r453297433", "createdAt": "2020-07-12T10:20:48Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/analytics/faults_util.bal", "diffHunk": "@@ -21,19 +21,30 @@ public function getFaultMetaData(FaultDTO dto) returns string {\n     return dto.metaClientType;\n }\n \n-public function getFaultPayloadData(FaultDTO dto) returns string {\n-    return dto.consumerKey + OBJ + dto.apiName + OBJ + dto.apiVersion + OBJ + dto.apiContext + OBJ +\n+public function getFaultPayloadData(FaultDTO dto, string amAnalyticsVersion) returns string {\n+    printDebug(KEY_ANALYTICS_FILTER, \"Generating fault data payload for \" + amAnalyticsVersion);\n+    string payloadData = dto.consumerKey + OBJ + dto.apiName + OBJ + dto.apiVersion + OBJ + dto.apiContext + OBJ +\n     dto.resourcePath + OBJ + dto.method + OBJ + dto.apiCreator + OBJ + dto.userName + OBJ + dto.userTenantDomain + OBJ +\n     dto.apiCreatorTenantDomain + OBJ + dto.hostName + OBJ + dto.applicationId + OBJ +\n-    dto.applicationName + OBJ + dto.protocol + OBJ + dto.errorCode.toString() + OBJ + dto.errorMessage + OBJ + dto.faultTime.toString();\n+    dto.applicationName + OBJ + dto.protocol + OBJ + dto.errorCode.toString() + OBJ + dto.errorMessage + OBJ +\n+    dto.faultTime.toString();\n+\n+    if (amAnalyticsVersion == \"3.1.0\") {\n+        payloadData = payloadData + OBJ + dto.properties;\n+    }\n+    if (amAnalyticsVersion == \"3.2.0\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd4965de40af88524f47f5f579bffb01e67d27b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODY1MjY5", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-446865269", "createdAt": "2020-07-12T10:21:03Z", "commit": {"oid": "7dd4965de40af88524f47f5f579bffb01e67d27b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMDoyMTowM1rOGwTFMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMDoyMTowM1rOGwTFMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI5NzQ1Nw==", "bodyText": "Lets not make this exact match. Upto 3.1.0 should be the condition", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r453297457", "createdAt": "2020-07-12T10:21:03Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/analytics/faults_util.bal", "diffHunk": "@@ -21,19 +21,30 @@ public function getFaultMetaData(FaultDTO dto) returns string {\n     return dto.metaClientType;\n }\n \n-public function getFaultPayloadData(FaultDTO dto) returns string {\n-    return dto.consumerKey + OBJ + dto.apiName + OBJ + dto.apiVersion + OBJ + dto.apiContext + OBJ +\n+public function getFaultPayloadData(FaultDTO dto, string amAnalyticsVersion) returns string {\n+    printDebug(KEY_ANALYTICS_FILTER, \"Generating fault data payload for \" + amAnalyticsVersion);\n+    string payloadData = dto.consumerKey + OBJ + dto.apiName + OBJ + dto.apiVersion + OBJ + dto.apiContext + OBJ +\n     dto.resourcePath + OBJ + dto.method + OBJ + dto.apiCreator + OBJ + dto.userName + OBJ + dto.userTenantDomain + OBJ +\n     dto.apiCreatorTenantDomain + OBJ + dto.hostName + OBJ + dto.applicationId + OBJ +\n-    dto.applicationName + OBJ + dto.protocol + OBJ + dto.errorCode.toString() + OBJ + dto.errorMessage + OBJ + dto.faultTime.toString();\n+    dto.applicationName + OBJ + dto.protocol + OBJ + dto.errorCode.toString() + OBJ + dto.errorMessage + OBJ +\n+    dto.faultTime.toString();\n+\n+    if (amAnalyticsVersion == \"3.1.0\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd4965de40af88524f47f5f579bffb01e67d27b"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d8a4d24556088e88f2851ea3f864e0dabc2bde3", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/4d8a4d24556088e88f2851ea3f864e0dabc2bde3", "committedDate": "2020-07-14T09:40:44Z", "message": "Re order the payload parameters of 3.2.0 stream."}, "afterCommit": {"oid": "6c76ca0323eb40c6f928bfb095e380b824ce81bd", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/6c76ca0323eb40c6f928bfb095e380b824ce81bd", "committedDate": "2020-07-14T10:01:52Z", "message": "Re order the payload parameters of 3.2.0 stream."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzUyNzQ1", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448752745", "createdAt": "2020-07-15T08:48:07Z", "commit": {"oid": "6c76ca0323eb40c6f928bfb095e380b824ce81bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODo0ODowN1rOGx0fwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODo0ODowN1rOGx0fwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg5MzUwNA==", "bodyText": "Populate from invocation context", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454893504", "createdAt": "2020-07-15T08:48:07Z", "author": {"login": "menakaj"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/analytics_dtos.bal", "diffHunk": "@@ -51,6 +51,7 @@ public type RequestResponseExecutionDTO record {\n     string label = \"\";\n     string correlationId = \"\";\n     boolean cacheHit = false;\n+    string properties = \"null\"; //New 3.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c76ca0323eb40c6f928bfb095e380b824ce81bd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzU1NjYx", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448755661", "createdAt": "2020-07-15T08:51:59Z", "commit": {"oid": "6c76ca0323eb40c6f928bfb095e380b824ce81bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODo1MTo1OVrOGx0o0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODo1MTo1OVrOGx0o0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg5NTgyNw==", "bodyText": "Use 3.2.0 as default, max version", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454895827", "createdAt": "2020-07-15T08:51:59Z", "author": {"login": "menakaj"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/utils.bal", "diffHunk": "@@ -1114,3 +1114,30 @@ public function buildBasicAuthHeader(string username, string password) returns s\n \n     return BASIC_PREFIX_WITH_SPACE + headerValue;\n }\n+\n+# Get the supported analytics stream version for the configured value.\n+#\n+# + return - Returns the supported analytics version.\n+# True if the version1 is greater than version2, false otherwise.\n+public function getAnalyticsVertion() returns string {\n+    string amAnalyticsVersion = getConfigValue(OLD_FILE_UPLOAD_ANALYTICS, APIM_ANALYTICS_VERSION, DEFAULT_AM_ANALYTICS_VERSION);\n+    string analyticsVersion = replaceAll(amAnalyticsVersion, \"\\\\.\", \"\");\n+    string supportedVersion = DEFAULT_AM_ANALYTICS_VERSION;\n+    // 3.0.0 or 3.1.0 case use the 3.0.0 stream.\n+    if (amAnalyticsVersion == DEFAULT_AM_ANALYTICS_VERSION || amAnalyticsVersion == \"3.1.0\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c76ca0323eb40c6f928bfb095e380b824ce81bd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODQ2NDQ3", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448846447", "createdAt": "2020-07-15T10:59:31Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMDo1OTozMVrOGx5BZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMDo1OTozMVrOGx5BZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk2NzY1NQ==", "bodyText": "Do we need !== or !=", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454967655", "createdAt": "2020-07-15T10:59:31Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/analytics/faults_util.bal", "diffHunk": "@@ -21,19 +21,34 @@ public function getFaultMetaData(FaultDTO dto) returns string {\n     return dto.metaClientType;\n }\n \n-public function getFaultPayloadData(FaultDTO dto) returns string {\n+public function getFaultPayloadData(FaultDTO dto, string amAnalyticsVersion) returns string {\n+    printDebug(KEY_ANALYTICS_FILTER, \"Generating fault data payload for \" + amAnalyticsVersion);\n+    string resourceTemplate = OBJ;\n+    string applicationOwner = OBJ;\n+    string properties = \"\";\n+    // If am analytics version is 3.2.0, append api resource template and application owner\n+    if (amAnalyticsVersion == DEFAULT_AM_ANALYTICS_VERSION) {\n+        resourceTemplate = resourceTemplate + dto.apiResourceTemplate + OBJ;\n+        applicationOwner = applicationOwner + dto.applicationOwner + OBJ;\n+    }\n+    // If analytics version is 3.1.0, append properties.\n+    if (amAnalyticsVersion !== DEFAULT_AM_ANALYTICS_VERSION_300) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODQ3NDI3", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448847427", "createdAt": "2020-07-15T11:00:59Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMTowMFrOGx5ETQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMTowMFrOGx5ETQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk2ODM5Nw==", "bodyText": "Lets remove empty line", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454968397", "createdAt": "2020-07-15T11:01:00Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/analytics/responsetime_util.bal", "diffHunk": "@@ -149,29 +153,59 @@ public function generateRequestResponseExecutionDataEvent(http:Response response\n         requestResponseExecutionDTO.apiResourceTemplate = httpResourceConfig.path;\n     }\n     //request method\n-    requestResponseExecutionDTO.apiMethod = <string>context.attributes[API_METHOD_PROPERTY];\n-    int initTime = <int>context.attributes[REQUEST_TIME];\n-    int timeRequestOut = <int>invocationContext.attributes[TS_REQUEST_OUT];\n-    int timeResponseIn = <int>invocationContext.attributes[TS_RESPONSE_IN];\n-    requestResponseExecutionDTO.serviceTime = timeRequestOut - initTime;\n-    requestResponseExecutionDTO.backendTime = timeResponseIn - timeRequestOut;\n-    requestResponseExecutionDTO.responseTime = timeResponseIn - initTime;\n+    if (context.attributes[API_METHOD_PROPERTY] is string) {\n+        requestResponseExecutionDTO.apiMethod = <string>context.attributes[API_METHOD_PROPERTY];\n+    }\n+    \n+    if (context.attributes[REQUEST_TIME] is int && invocationContext.attributes[TS_RESPONSE_IN] is int && invocationContext.attributes[TS_REQUEST_OUT] is int) {\n+        int initTime = <int>context.attributes[REQUEST_TIME];\n+        int timeRequestOut = <int>invocationContext.attributes[TS_REQUEST_OUT];\n+        int timeResponseIn = <int>invocationContext.attributes[TS_RESPONSE_IN];\n+        requestResponseExecutionDTO.serviceTime = timeRequestOut - initTime;\n+        requestResponseExecutionDTO.backendTime = timeResponseIn - timeRequestOut;\n+        requestResponseExecutionDTO.responseTime = timeResponseIn - initTime;\n+    }\n+    \n     //dummy values for protocol and destination for now\n-    requestResponseExecutionDTO.protocol = <string>context.attributes[PROTOCOL_PROPERTY];\n-    requestResponseExecutionDTO.destination = <string>invocationContext.attributes[DESTINATION];\n+    if (context.attributes[PROTOCOL_PROPERTY] is string) {\n+        requestResponseExecutionDTO.protocol = <string>context.attributes[PROTOCOL_PROPERTY];\n+    }\n+    if (invocationContext.attributes[DESTINATION] is string) {\n+        requestResponseExecutionDTO.destination = <string>invocationContext.attributes[DESTINATION];\n+    }\n \n     //Set data which were set to context in the Request path\n-    requestResponseExecutionDTO.applicationOwner = <string>context.attributes[APPLICATION_OWNER_PROPERTY];\n-    requestResponseExecutionDTO.apiCreatorTenantDomain = <string>context.attributes[API_CREATOR_TENANT_DOMAIN_PROPERTY];\n-    requestResponseExecutionDTO.apiTier = <string>context.attributes[API_TIER_PROPERTY];\n-    requestResponseExecutionDTO.throttledOut = <boolean>context.attributes[CONTINUE_ON_TROTTLE_PROPERTY];\n-    requestResponseExecutionDTO.userAgent = <string>context.attributes[USER_AGENT_PROPERTY];\n-    requestResponseExecutionDTO.userIp = <string>context.attributes[USER_IP_PROPERTY];\n-    requestResponseExecutionDTO.requestTimestamp = <int>context.attributes[REQUEST_TIME_PROPERTY];\n+    if (context.attributes[APPLICATION_OWNER_PROPERTY] is string) {\n+        requestResponseExecutionDTO.applicationOwner = <string>context.attributes[APPLICATION_OWNER_PROPERTY];\n+    }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODQ3NDk1", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448847495", "createdAt": "2020-07-15T11:01:08Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMTowOFrOGx5Ejg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMTowOFrOGx5Ejg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk2ODQ2Mg==", "bodyText": "Lets remove empty line", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454968462", "createdAt": "2020-07-15T11:01:08Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/analytics/responsetime_util.bal", "diffHunk": "@@ -149,29 +153,59 @@ public function generateRequestResponseExecutionDataEvent(http:Response response\n         requestResponseExecutionDTO.apiResourceTemplate = httpResourceConfig.path;\n     }\n     //request method\n-    requestResponseExecutionDTO.apiMethod = <string>context.attributes[API_METHOD_PROPERTY];\n-    int initTime = <int>context.attributes[REQUEST_TIME];\n-    int timeRequestOut = <int>invocationContext.attributes[TS_REQUEST_OUT];\n-    int timeResponseIn = <int>invocationContext.attributes[TS_RESPONSE_IN];\n-    requestResponseExecutionDTO.serviceTime = timeRequestOut - initTime;\n-    requestResponseExecutionDTO.backendTime = timeResponseIn - timeRequestOut;\n-    requestResponseExecutionDTO.responseTime = timeResponseIn - initTime;\n+    if (context.attributes[API_METHOD_PROPERTY] is string) {\n+        requestResponseExecutionDTO.apiMethod = <string>context.attributes[API_METHOD_PROPERTY];\n+    }\n+    \n+    if (context.attributes[REQUEST_TIME] is int && invocationContext.attributes[TS_RESPONSE_IN] is int && invocationContext.attributes[TS_REQUEST_OUT] is int) {\n+        int initTime = <int>context.attributes[REQUEST_TIME];\n+        int timeRequestOut = <int>invocationContext.attributes[TS_REQUEST_OUT];\n+        int timeResponseIn = <int>invocationContext.attributes[TS_RESPONSE_IN];\n+        requestResponseExecutionDTO.serviceTime = timeRequestOut - initTime;\n+        requestResponseExecutionDTO.backendTime = timeResponseIn - timeRequestOut;\n+        requestResponseExecutionDTO.responseTime = timeResponseIn - initTime;\n+    }\n+    \n     //dummy values for protocol and destination for now\n-    requestResponseExecutionDTO.protocol = <string>context.attributes[PROTOCOL_PROPERTY];\n-    requestResponseExecutionDTO.destination = <string>invocationContext.attributes[DESTINATION];\n+    if (context.attributes[PROTOCOL_PROPERTY] is string) {\n+        requestResponseExecutionDTO.protocol = <string>context.attributes[PROTOCOL_PROPERTY];\n+    }\n+    if (invocationContext.attributes[DESTINATION] is string) {\n+        requestResponseExecutionDTO.destination = <string>invocationContext.attributes[DESTINATION];\n+    }\n \n     //Set data which were set to context in the Request path\n-    requestResponseExecutionDTO.applicationOwner = <string>context.attributes[APPLICATION_OWNER_PROPERTY];\n-    requestResponseExecutionDTO.apiCreatorTenantDomain = <string>context.attributes[API_CREATOR_TENANT_DOMAIN_PROPERTY];\n-    requestResponseExecutionDTO.apiTier = <string>context.attributes[API_TIER_PROPERTY];\n-    requestResponseExecutionDTO.throttledOut = <boolean>context.attributes[CONTINUE_ON_TROTTLE_PROPERTY];\n-    requestResponseExecutionDTO.userAgent = <string>context.attributes[USER_AGENT_PROPERTY];\n-    requestResponseExecutionDTO.userIp = <string>context.attributes[USER_IP_PROPERTY];\n-    requestResponseExecutionDTO.requestTimestamp = <int>context.attributes[REQUEST_TIME_PROPERTY];\n+    if (context.attributes[APPLICATION_OWNER_PROPERTY] is string) {\n+        requestResponseExecutionDTO.applicationOwner = <string>context.attributes[APPLICATION_OWNER_PROPERTY];\n+    }\n+    \n+    if (context.attributes[API_CREATOR_TENANT_DOMAIN_PROPERTY] is string) {\n+        requestResponseExecutionDTO.apiCreatorTenantDomain = <string>context.attributes[API_CREATOR_TENANT_DOMAIN_PROPERTY];\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODQ4MjA4", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448848208", "createdAt": "2020-07-15T11:02:13Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMjoxM1rOGx5GuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowMjoxM1rOGx5GuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk2OTAxNw==", "bodyText": "Shall we use some name like \"ADDITIONAL_ANALYTICS_PROPS\"", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454969017", "createdAt": "2020-07-15T11:02:13Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/constants/constants.bal", "diffHunk": "@@ -122,6 +122,7 @@ public const string USER_IP_PROPERTY = \"userIp\";\n public const string REQUEST_TIME_PROPERTY = \"requestTimestamp\";\n public const string GATEWAY_TYPE_PROPERTY = \"gatewayType\";\n public const string GATEWAY_TYPE = \"MICRO\";\n+public const string ADDITIONAL_PROPS = \"ADDITIONAL_PROPS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODQ5OTY0", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448849964", "createdAt": "2020-07-15T11:05:02Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNTowMlrOGx5MNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNTowMlrOGx5MNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3MDQyMg==", "bodyText": "Let's not call getAnalyticsVertion() method for each request . Save it in a global variable during startup and reuse it", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454970422", "createdAt": "2020-07-15T11:05:02Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/filters/analytics_request_filter.bal", "diffHunk": "@@ -20,19 +20,23 @@ import ballerina/runtime;\n public type AnalyticsRequestFilter object {\n \n     public function filterRequest(http:Caller caller, http:Request request, http:FilterContext context) returns boolean {\n+        string amAnalyticsVersion = getAnalyticsVertion();\n+        printDebug(KEY_ANALYTICS_FILTER, \"Analytics Version \" + amAnalyticsVersion);\n         if (context.attributes.hasKey(SKIP_ALL_FILTERS) && <boolean>context.attributes[SKIP_ALL_FILTERS]) {\n             printDebug(KEY_ANALYTICS_FILTER, \"Skip all filter annotation set in the service. Skip the filter\");\n             return true;\n         }\n         //Filter only if analytics is enabled.\n         if (isAnalyticsEnabled || isGrpcAnalyticsEnabled) {\n             context.attributes[PROTOCOL_PROPERTY] = caller.protocol;\n-            doFilterRequest(request, context);\n+            doFilterRequest(request, context, amAnalyticsVersion);\n         }\n         return true;\n     }\n \n     public function filterResponse(http:Response response, http:FilterContext context) returns boolean {\n+        string amAnalyticsVersion = getAnalyticsVertion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODUwMzk2", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448850396", "createdAt": "2020-07-15T11:05:44Z", "commit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNTo0NFrOGx5NrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNTo0NFrOGx5NrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3MDc5Nw==", "bodyText": "Let's not call getAnalyticsVertion() method for each request . Save it in a global variable during startup and reuse it", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454970797", "createdAt": "2020-07-15T11:05:44Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/filters/analytics_request_filter.bal", "diffHunk": "@@ -20,19 +20,23 @@ import ballerina/runtime;\n public type AnalyticsRequestFilter object {\n \n     public function filterRequest(http:Caller caller, http:Request request, http:FilterContext context) returns boolean {\n+        string amAnalyticsVersion = getAnalyticsVertion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e75f7250069ff2c58351c09277ece331ac9425"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODUxNDQ5", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448851449", "createdAt": "2020-07-15T11:07:25Z", "commit": {"oid": "57aeb746a4a51ed215a0f91e28f04bedbb8444c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNzoyNVrOGx5Q2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMTowNzoyNVrOGx5Q2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3MTYxMQ==", "bodyText": "Lets use this as stream version, because in APIm analytics 3.3.0 also might have the 3.2.0 streams if there are no changes", "url": "https://github.com/wso2/product-microgateway/pull/1319#discussion_r454971611", "createdAt": "2020-07-15T11:07:25Z", "author": {"login": "Rajith90"}, "path": "distribution/resources/conf/default-micro-gw.conf.template", "diffHunk": "@@ -165,6 +165,8 @@\n \n # Analytics configurations\n [analytics]\n+  # The configured API Manager analytics version\n+  version = \"3.2.0\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57aeb746a4a51ed215a0f91e28f04bedbb8444c9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08182f520b6c38b245db5e60439c8abf3cc7fb81", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/08182f520b6c38b245db5e60439c8abf3cc7fb81", "committedDate": "2020-07-15T12:02:07Z", "message": "Set username after subs validation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7bf79491729e87bfcfec7e661bca13e2b86599", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/4a7bf79491729e87bfcfec7e661bca13e2b86599", "committedDate": "2020-07-15T12:02:07Z", "message": "Analytics filter update.\n\n* Make analytics version configurable\n* Add new fields to DTOs.\n* Set publishing streams\n* Add default configurations to the template file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3c24730dc58c0203a931c7a89c734f3b5487c53", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/e3c24730dc58c0203a931c7a89c734f3b5487c53", "committedDate": "2020-07-15T12:02:07Z", "message": "Fix analytics version selection."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01d3a98bfaef06cc15a4dfaf6348ad27371b46e2", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/01d3a98bfaef06cc15a4dfaf6348ad27371b46e2", "committedDate": "2020-07-15T12:02:07Z", "message": "Fix method comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c06cf100b1c6e185a259a57139cc2d4c17441fdb", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/c06cf100b1c6e185a259a57139cc2d4c17441fdb", "committedDate": "2020-07-15T12:02:07Z", "message": "Re order the payload parameters of 3.2.0 stream."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00de86987d48b9223c155219c64912e443c04dae", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/00de86987d48b9223c155219c64912e443c04dae", "committedDate": "2020-07-15T12:02:07Z", "message": "Fix code review suggestions.\n\n* Support 3.2.0 as the default analytics version.\n* Read the properties from the invocation context.\n* Restructure the payload to match the stream definition."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aff1143416300215b7d1e5665b73488c9b46f69", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/2aff1143416300215b7d1e5665b73488c9b46f69", "committedDate": "2020-07-15T12:02:08Z", "message": "Set default version to 3.2.0 in config template."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b694c6960318d34763d343da195320faf623a55f", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/b694c6960318d34763d343da195320faf623a55f", "committedDate": "2020-07-15T12:02:08Z", "message": "Fix review comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a03c53386a8beb1ebcdf616f1c690082e61e0f4", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/7a03c53386a8beb1ebcdf616f1c690082e61e0f4", "committedDate": "2020-07-15T12:01:36Z", "message": "Fix review comments."}, "afterCommit": {"oid": "b694c6960318d34763d343da195320faf623a55f", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/b694c6960318d34763d343da195320faf623a55f", "committedDate": "2020-07-15T12:02:08Z", "message": "Fix review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c690770f6f86c3a209ac3bb9cc5d76a85640091", "author": {"user": {"login": "menakaj", "name": "Menaka Jayawardena"}}, "url": "https://github.com/wso2/product-microgateway/commit/4c690770f6f86c3a209ac3bb9cc5d76a85640091", "committedDate": "2020-07-15T12:06:08Z", "message": "Reword the config element."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTI1MDk0", "url": "https://github.com/wso2/product-microgateway/pull/1319#pullrequestreview-448925094", "createdAt": "2020-07-15T12:57:20Z", "commit": {"oid": "4c690770f6f86c3a209ac3bb9cc5d76a85640091"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1119, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}