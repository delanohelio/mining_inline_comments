{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNzQwNDEw", "number": 970, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjoxNTozNlrODeV10A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjo0NFrODecoxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTQxNzEyOnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/model/rest/ext/ExtendedAPI.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjoxNTozNlrOFnbFSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMToxNDoxMVrOFniUSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MjUwNA==", "bodyText": "Rename variable\nSuggestion: extensionSecurity", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r376882504", "createdAt": "2020-02-10T06:15:36Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/model/rest/ext/ExtendedAPI.java", "diffHunk": "@@ -30,6 +32,8 @@\n     private String mgwApiSecurity = null;\n     //Scopes\n     private String mgwApiScope = null;\n+    //support apim application level security\n+    private List<String> apiSecurityByExtension = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwMTAzMw==", "bodyText": "Renamed to applicationSecurity c023aba", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377001033", "createdAt": "2020-02-10T11:14:11Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/model/rest/ext/ExtendedAPI.java", "diffHunk": "@@ -30,6 +32,8 @@\n     private String mgwApiSecurity = null;\n     //Scopes\n     private String mgwApiScope = null;\n+    //support apim application level security\n+    private List<String> apiSecurityByExtension = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4MjUwNA=="}, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTQyODg0OnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjoyNDozM1rOFnbMPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMToxNDo0MlrOFniVEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NDI4NQ==", "bodyText": "openAPI.getExtensions() Keep this in a variable and refer it.", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r376884285", "createdAt": "2020-02-10T06:24:33Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -702,11 +718,25 @@ private static void validateSingleResourceInterceptors(Operation operation, Stri\n      */\n     private static void setMgwAPISecurityAndScopes(ExtendedAPI api, OpenAPI openAPI) {\n         String[] securitySchemasAndScopes = generateMgwSecuritySchemasAndScopes(openAPI.getSecurity());\n+        if (openAPI.getExtensions() != null && !openAPI.getExtensions().isEmpty() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwMTIzNQ==", "bodyText": "Fixed. Thanks c023aba", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377001235", "createdAt": "2020-02-10T11:14:42Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -702,11 +718,25 @@ private static void validateSingleResourceInterceptors(Operation operation, Stri\n      */\n     private static void setMgwAPISecurityAndScopes(ExtendedAPI api, OpenAPI openAPI) {\n         String[] securitySchemasAndScopes = generateMgwSecuritySchemasAndScopes(openAPI.getSecurity());\n+        if (openAPI.getExtensions() != null && !openAPI.getExtensions().isEmpty() &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NDI4NQ=="}, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTQyOTE5OnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjoyNDo0NlrOFnbMcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjoyNDo0NlrOFnbMcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NDMzOQ==", "bodyText": "Use two statements to casting and calling the method", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r376884339", "createdAt": "2020-02-10T06:24:46Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -702,11 +718,25 @@ private static void validateSingleResourceInterceptors(Operation operation, Stri\n      */\n     private static void setMgwAPISecurityAndScopes(ExtendedAPI api, OpenAPI openAPI) {\n         String[] securitySchemasAndScopes = generateMgwSecuritySchemasAndScopes(openAPI.getSecurity());\n+        if (openAPI.getExtensions() != null && !openAPI.getExtensions().isEmpty() &&\n+                openAPI.getExtensions().containsKey(OpenAPIConstants.APPLICATION_SECURITY)) {\n+            logger.debug(OpenAPIConstants.APPLICATION_SECURITY + \" extension found in the API Definition\");\n+            try {\n+                api.setAPISecurityByExtension((List<String>) ((Map<String, Object>) openAPI.getExtensions()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTQzNzU5OnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNjozMDozNlrOFnbRSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMToxNTowOFrOFniVxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NTU3Nw==", "bodyText": "setAuthProviders()???", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r376885577", "createdAt": "2020-02-10T06:30:36Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -964,26 +997,38 @@ private static boolean isResourceEpUnavailable(Operation operation) {\n         return false;\n     }\n \n-    public static List<String> getAuthProviders(String schemas) {\n+    public static List<String> getAuthProviders(String schemas, List<String> apiSecurityByExtension) {\n         List<String> authProviders = new ArrayList<>();\n-        boolean basic = false;\n-        boolean oauth2 = false;\n-        if (schemas != null) {\n-            String[] schemasArray = schemas.trim().split(\"\\\\s*,\\\\s*\");\n-            for (String s : schemasArray) {\n-                if (s.equalsIgnoreCase(APISecurity.basic.name())) {\n-                    authProviders.add(APISecurity.basic.name());\n-                } else if (s.equalsIgnoreCase(APISecurity.apikey.name())) {\n-                    authProviders.add(APISecurity.apikey.name());\n-                } else if (s.equalsIgnoreCase(APISecurity.oauth2.name())) {\n-                    authProviders.add(APISecurity.oauth2.name());\n-                    authProviders.add(APISecurity.jwt.name());\n+        // Support api manager application level security\n+        if (apiSecurityByExtension != null && !apiSecurityByExtension.isEmpty()) {\n+            for (String securityType : apiSecurityByExtension) {\n+                if (OpenAPIConstants.APPLICATION_LEVEL_SECURITY.containsKey(securityType)) {\n+                    setDefaultSecurityScheme(\n+                            OpenAPIConstants.APPLICATION_LEVEL_SECURITY.get(securityType), authProviders);\n                 }\n             }\n+        } else if (schemas != null) {\n+            String[] schemasArray = schemas.trim().split(\"\\\\s*,\\\\s*\");\n+            for (String securityType : schemasArray) {\n+                setDefaultSecurityScheme(securityType, authProviders);\n+            }\n         }\n+\n         if (authProviders.isEmpty()) {\n-            authProviders.add(APISecurity.oauth2.name());\n-            authProviders.add(APISecurity.jwt.name());\n+            authProviders.add(OpenAPIConstants.APISecurity.oauth2.name());\n+            authProviders.add(OpenAPIConstants.APISecurity.jwt.name());\n+        }\n+        return authProviders;\n+    }\n+\n+    private static List<String> setDefaultSecurityScheme(String securityType, List<String> authProviders) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwMTQxMw==", "bodyText": "Fixed in c023aba", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377001413", "createdAt": "2020-02-10T11:15:08Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -964,26 +997,38 @@ private static boolean isResourceEpUnavailable(Operation operation) {\n         return false;\n     }\n \n-    public static List<String> getAuthProviders(String schemas) {\n+    public static List<String> getAuthProviders(String schemas, List<String> apiSecurityByExtension) {\n         List<String> authProviders = new ArrayList<>();\n-        boolean basic = false;\n-        boolean oauth2 = false;\n-        if (schemas != null) {\n-            String[] schemasArray = schemas.trim().split(\"\\\\s*,\\\\s*\");\n-            for (String s : schemasArray) {\n-                if (s.equalsIgnoreCase(APISecurity.basic.name())) {\n-                    authProviders.add(APISecurity.basic.name());\n-                } else if (s.equalsIgnoreCase(APISecurity.apikey.name())) {\n-                    authProviders.add(APISecurity.apikey.name());\n-                } else if (s.equalsIgnoreCase(APISecurity.oauth2.name())) {\n-                    authProviders.add(APISecurity.oauth2.name());\n-                    authProviders.add(APISecurity.jwt.name());\n+        // Support api manager application level security\n+        if (apiSecurityByExtension != null && !apiSecurityByExtension.isEmpty()) {\n+            for (String securityType : apiSecurityByExtension) {\n+                if (OpenAPIConstants.APPLICATION_LEVEL_SECURITY.containsKey(securityType)) {\n+                    setDefaultSecurityScheme(\n+                            OpenAPIConstants.APPLICATION_LEVEL_SECURITY.get(securityType), authProviders);\n                 }\n             }\n+        } else if (schemas != null) {\n+            String[] schemasArray = schemas.trim().split(\"\\\\s*,\\\\s*\");\n+            for (String securityType : schemasArray) {\n+                setDefaultSecurityScheme(securityType, authProviders);\n+            }\n         }\n+\n         if (authProviders.isEmpty()) {\n-            authProviders.add(APISecurity.oauth2.name());\n-            authProviders.add(APISecurity.jwt.name());\n+            authProviders.add(OpenAPIConstants.APISecurity.oauth2.name());\n+            authProviders.add(OpenAPIConstants.APISecurity.jwt.name());\n+        }\n+        return authProviders;\n+    }\n+\n+    private static List<String> setDefaultSecurityScheme(String securityType, List<String> authProviders) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4NTU3Nw=="}, "originalCommit": {"oid": "51254307142291402cd5da3bbd547f5f0bb5eb60"}, "originalPosition": 192}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjUyOTg4OnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjoyOFrOFnlfPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjoyOFrOFnlfPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA1Mjk4OQ==", "bodyText": "Can't we directly use the extension here rather than assigning it to a object and then passing it to objectmapper", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377052989", "createdAt": "2020-02-10T13:12:28Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -702,11 +722,26 @@ private static void validateSingleResourceInterceptors(Operation operation, Stri\n      */\n     private static void setMgwAPISecurityAndScopes(ExtendedAPI api, OpenAPI openAPI) {\n         String[] securitySchemasAndScopes = generateMgwSecuritySchemasAndScopes(openAPI.getSecurity());\n+        Map<String, Object> apiDefExtensions = openAPI.getExtensions();\n+        if (apiDefExtensions != null && apiDefExtensions.containsKey(OpenAPIConstants.APPLICATION_SECURITY)) {\n+            logger.debug(OpenAPIConstants.APPLICATION_SECURITY + \" extension found in the API\");\n+            try {\n+                Object appSecurityExtension = apiDefExtensions.get(OpenAPIConstants.APPLICATION_SECURITY);\n+                ApplicationSecurity appSecurity =\n+                        new ObjectMapper().convertValue(appSecurityExtension, ApplicationSecurity.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d736d83d1bca86bab5650370015aa5026f62cc28"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjUzMDIxOnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjozNVrOFnlffA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjozNVrOFnlffA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA1MzA1Mg==", "bodyText": "Can't we directly use the extension here rather than assigning it to a object and then passing it to objectmapper", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377053052", "createdAt": "2020-02-10T13:12:35Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -255,12 +250,37 @@ public static ExtendedAPI generateAPIFromOpenAPIDef(OpenAPI openAPI, String open\n         api.setId(apiId);\n         api.setName(openAPI.getInfo().getTitle());\n         api.setVersion(openAPI.getInfo().getVersion());\n-        api.setTransport(Arrays.asList(\"http\", \"https\"));\n+        api.setTransport(getTransport(openAPI));\n         //open API content should be set in json in order to validation filter to work.\n         api.setApiDefinition(openAPIContent);\n         return api;\n     }\n \n+    private static List<String> getTransport(OpenAPI openAPI) {\n+        List<String> transports = new ArrayList<>();\n+        Map<String, Object> apiDefExtensions = openAPI.getExtensions();\n+        if (apiDefExtensions.containsKey(OpenAPIConstants.TRANSPORT_SECURITY)) {\n+            logger.debug(OpenAPIConstants.TRANSPORT_SECURITY + \" extension found in the API Definition\");\n+            try {\n+                Object transportSecurityExtension = apiDefExtensions.get(OpenAPIConstants.TRANSPORT_SECURITY);\n+                TransportSecurity transportSecurity =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d736d83d1bca86bab5650370015aa5026f62cc28"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjUzMDYyOnYy", "diffSide": "RIGHT", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjo0NFrOFnlfww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzoxMjo0NFrOFnlfww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA1MzEyMw==", "bodyText": "Can't we directly use the extension here rather than assigning it to a object and then passing it to objectmapper", "url": "https://github.com/wso2/product-microgateway/pull/970#discussion_r377053123", "createdAt": "2020-02-10T13:12:44Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/utils/OpenAPICodegenUtils.java", "diffHunk": "@@ -776,9 +811,20 @@ private static void setMgwAPISecurityAndScopes(ExtendedAPI api, OpenAPI openAPI)\n         return new String[]{securitySchemas, scopes};\n     }\n \n-    public static List<String> getMgwResourceSecurity(Operation operation) {\n+    public static List<String> getMgwResourceSecurity(Operation operation, ApplicationSecurity appSecurity) {\n+        Map<String, Object> operationExtensions = operation.getExtensions();\n+        //override api level application security extension by operation level extension\n+        if (operationExtensions != null && operationExtensions.containsKey(OpenAPIConstants.APPLICATION_SECURITY)) {\n+            try {\n+                Object appSecurityExtension = operationExtensions.get(OpenAPIConstants.APPLICATION_SECURITY);\n+                appSecurity = new ObjectMapper().convertValue(appSecurityExtension, ApplicationSecurity.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d736d83d1bca86bab5650370015aa5026f62cc28"}, "originalPosition": 128}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1273, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}