{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MjAyNDQ0", "number": 1345, "title": "Refactor Backend JWT generation and Implement default claim retriever Implementation", "bodyText": "Purpose\nRefactor the code for backend jwt generation and add the default claim retriever Implementation\nIssues\n\nFixes #1196\nAutomation tests\n\nUnit tests added: No\nIntegration tests added: No\n\nTested environments\n\nMacOS Mojave\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-07-21T07:02:23Z", "url": "https://github.com/wso2/product-microgateway/pull/1345", "merged": true, "mergeCommit": {"oid": "c62cad45b6a693c2a43f312bb4c1180558432394"}, "closed": true, "closedAt": "2020-08-04T10:21:12Z", "author": {"login": "VirajSalaka"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3Wxw3gFqTQ1MzEwNTYyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7j8jhAFqTQ2MDY4NDUwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMTA1NjI1", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-453105625", "createdAt": "2020-07-22T08:31:00Z", "commit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODozMTowMVrOG1YTyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODo0MzoxNVrOG1YxFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYyNTk5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |};\n          \n          \n            \n            |};", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r458625992", "createdAt": "2020-07-22T08:31:01Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/config_dtos/jwt_generator_config.bal", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+public type JWTGeneratorConfigDTO record {|\n+    boolean jwtGeneratorEnabled = getConfigBooleanValue(JWT_GENERATOR_ID,\n+                                                        JWT_GENERATOR_ENABLED,\n+                                                        DEFAULT_JWT_GENERATOR_ENABLED);\n+    string dialectURI = getConfigValue(JWT_GENERATOR_ID,\n+                                        JWT_GENERATOR_DIALECT,\n+                                        DEFAULT_JWT_GENERATOR_DIALECT);\n+    string signingAlgorithm = getConfigValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_SIGN_ALGO,\n+                                            DEFAULT_JWT_GENERATOR_SIGN_ALGO);\n+    string certificateAlias = getConfigValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_CERTIFICATE_ALIAS,\n+                                                DEFAULT_JWT_GENERATOR_CERTIFICATE_ALIAS);\n+    string privateKeyAlias = getConfigValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_PRIVATE_KEY_ALIAS,\n+                                            DEFAULT_JWT_GENERATOR_PRIVATE_KEY_ALIAS);\n+    int tokenExpiry = getConfigIntValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_TOKEN_EXPIRY,\n+                                            DEFAULT_JWT_GENERATOR_TOKEN_EXPIRY);\n+    any[] restrictedClaims = getConfigArrayValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_RESTRICTED_CLAIMS);\n+    string issuer = getConfigValue(JWT_GENERATOR_ID,\n+                                        JWT_GENERATOR_TOKEN_ISSUER,\n+                                        DEFAULT_JWT_GENERATOR_TOKEN_ISSUER);\n+    any[] tokenAudience = getConfigArrayValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_TOKEN_AUDIENCE);\n+    string generatorImpl = getConfigValue(JWT_GENERATOR_ID, \n+                                            JWT_GENERATOR_IMPLEMENTATION,\n+                                            DEFAULT_JWT_GENERATOR_IMPLEMENTATION);                                            \n+    JWTGeneratorConfig_jwtGeneratorCaching jwtGeneratorCaching = {};\n+    JWTGeneratorConfig_claimRetrieval claimRetrieval = {};\n+|};\n+\n+//todo: Check if it is required declare new default constants specifically for jwt generator cache\n+public type JWTGeneratorConfig_jwtGeneratorCaching record {|\n+    boolean tokenCacheEnable = getConfigBooleanValue(JWT_GENERATOR_CACHING_ID,\n+                                                    JWT_GENERATOR_TOKEN_CACHE_ENABLED,\n+                                                    DEFAULT_JWT_GENERATOR_TOKEN_CACHE_ENABLED);\n+    int tokenCacheExpiryTime = getConfigIntValue(JWT_GENERATOR_CACHING_ID,\n+                                                JWT_GENERATOR_TOKEN_CACHE_EXPIRY,\n+                                                DEFAULT_TOKEN_CACHE_EXPIRY);   \n+    int tokenCacheCapacity = getConfigIntValue(JWT_GENERATOR_CACHING_ID,\n+                                                JWT_GENERATOR_TOKEN_CACHE_CAPACITY,\n+                                                DEFAULT_TOKEN_CACHE_CAPACITY);\n+    float tokenCacheEvictionFactor = getConfigFloatValue(JWT_GENERATOR_CACHING_ID,\n+                                                JWT_GENERATOR_TOKEN_CACHE_EVICTION_FACTOR,\n+                                                DEFAULT_TOKEN_CACHE_EVICTION_FACTOR);                                                                                         \n+|};\n+\n+public type JWTGeneratorConfig_claimRetrieval record {|\n+    //todo: decide if we are going to keep an empty string instead\n+    string retrieverImpl = getConfigValue(JWT_GENERATOR_CLAIM_RETRIEVAL_INSTANCE_ID,\n+                                            JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION,\n+                                            DEFAULT_JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION);\n+    map<any> configuration = getConfigMapValue(JWT_GENERATOR_CLAIM_RETRIEVAL_CONFIGURATION);                                        \n+|};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYyNjExNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            };\n          \n          \n            \n            };", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r458626114", "createdAt": "2020-07-22T08:31:12Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/config_dtos/listener_config.bal", "diffHunk": "@@ -0,0 +1,27 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+public type ListenerConfigDTO record {\n+    string keyStorePath = getConfigValue(LISTENER_CONF_INSTANCE_ID,\n+                                        KEY_STORE_PATH,\n+                                        DEFAULT_KEY_STORE_PATH);\n+    string keyStorePassword = getConfigValue(LISTENER_CONF_INSTANCE_ID,\n+                                            KEY_STORE_PASSWORD,\n+                                            DEFAULT_KEY_STORE_PASSWORD);\n+    string trustStorePath = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PATH, DEFAULT_TRUST_STORE_PATH);\n+    string trustStorePassword = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PASSWORD,\n+                                                DEFAULT_TRUST_STORE_PASSWORD);                                        \n+};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzMDA3OA==", "bodyText": "Since you only want to decode the jwt here(not checking in the jwt issuer's cache), use the following method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        (jwt:JwtPayload | error) cachedPayload = getDecodedJWTPayload(cachedToken, tokenContextDTO.issuer);\n          \n          \n            \n                        (jwt:JwtPayload | error) cachedPayload = decodeJWTPayload(cachedToken);", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r458630078", "createdAt": "2020-07-22T08:37:46Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/jwt_gen_util.bal", "diffHunk": "@@ -217,3 +191,89 @@ public function loadJWTGeneratorImpl() returns boolean {\n     }\n     return false;\n }\n+\n+# Refactoring method for setting JWT header\n+#\n+# + tokenContextDTO - BackendJWTGenUserContextDTO record which contains payload, issuer and whether claim retrieval enabled.\n+# + apiDetails - extracted api details for the current api\n+# + req - The `Request` instance.\n+# + cacheKey - key for the jwt generator cache\n+# + enabledCaching - jwt generator caching enabled\n+# + return - Returns `true` if the token generation and setting the header completed successfully\n+public function setJWTHeader(BackendJWTGenUserContextDTO tokenContextDTO,\n+                            map<string> apiDetails,\n+                            http:Request req,\n+                            string cacheKey,\n+                            boolean enabledCaching) returns @tainted boolean {\n+\n+    (handle|error) generatedToken;\n+    jwt:JwtPayload? payload = tokenContextDTO.payload;\n+    if (payload is jwt:JwtPayload) {\n+        if (isSelfContainedToken(payload)) {\n+            generatedToken = generateJWTToken(payload, apiDetails);\n+            return setGeneratedTokenAsHeader(req, cacheKey, enabledCaching, generatedToken);\n+        }\n+    }\n+    ClaimsMapDTO claimsMapDTO = createMapFromRetrievedUserClaimsListDTO(tokenContextDTO);\n+    generatedToken = generateJWTTokenFromUserClaimsMap(claimsMapDTO, apiDetails);\n+    if (generatedToken is error) {\n+        printError(KEY_JWT_AUTH_PROVIDER, \"Token not generated due to error\", generatedToken);\n+        return false;\n+    }\n+    return setGeneratedTokenAsHeader(req, cacheKey, enabledCaching, generatedToken);\n+}\n+\n+# Set the BackendJWT header after checking in the cache.\n+# The JWT token is picked from cache if it is available in the cache and the time duration between current time\n+# and the cached token's expiry time is less than the skew time.\n+# If the token is not picked from the cache, then it will be generated.\n+#\n+# + req - HTTP Request\n+# + cacheKey - Cache key used for jwt generator cache\n+# + enabledCaching - True if caching is enabled for backend JWT generation\n+# + tokenContextDTO - User Context which is used to populate the information required for jwtGenerator Implementation\n+# + apiDetails - API related information which is used to populate the information required for jwtGenerator Implementation\n+# + return - Returns `true` if adding the JWT token to the request is successful.\n+function setJWTTokenWithCacheCheck(http:Request req,\n+                                    string cacheKey,\n+                                    int skewTime,\n+                                    boolean enabledCaching,\n+                                    BackendJWTGenUserContextDTO tokenContextDTO,\n+                                    map<string> apiDetails)\n+                                    returns @tainted boolean {\n+    boolean status = false;\n+    if (enabledCaching) {\n+        var cachedToken = jwtGeneratorCache.get(cacheKey);\n+        printDebug(KEY_JWT_AUTH_PROVIDER, \"Key: \" + cacheKey);\n+        if (cachedToken is string) {\n+            printDebug(KEY_JWT_AUTH_PROVIDER, \"Found in jwt generator cache\");\n+            printDebug(KEY_JWT_AUTH_PROVIDER, \"Token: \" + cachedToken);\n+            (jwt:JwtPayload | error) cachedPayload = getDecodedJWTPayload(cachedToken, tokenContextDTO.issuer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7"}, "originalPosition": 258}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzMzQ5Mg==", "bodyText": "this payload should be retrieved from \"invocationContext[PRINCIPAL][ISSUER_CLAIMS]\" to support claim mapping. Change in the line 231. See issue - #1342 (comment)", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r458633492", "createdAt": "2020-07-22T08:43:15Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/jwt_auth_handler.bal", "diffHunk": "@@ -237,46 +233,15 @@ public function generateAndSetBackendJwtHeader(string credential,\n                 printDebug(KEY_JWT_AUTH_PROVIDER, \"decoded token credential\");\n                 // get the subscribedAPI details\n                 map<string> apiDetails = getAPIDetails(payload, apiName, apiVersion);\n-                // checking if cache is enabled\n-                if (enabledCaching) {\n-                    var cachedToken = jwtGeneratorCache.get(cacheKey);\n-                    printDebug(KEY_JWT_AUTH_PROVIDER, \"Key: \" + cacheKey);\n-                    if (cachedToken is string) {\n-                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Found in jwt generator cache\");\n-                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Token: \" + cachedToken);\n-                        (jwt:JwtPayload | error) cachedPayload = getDecodedJWTPayload(cachedToken, issuer);\n-                        if (cachedPayload is jwt:JwtPayload) {\n-                            int currentTime = getCurrentTime();\n-                            int? cachedTokenExpiry = cachedPayload?.exp;\n-                            if (cachedTokenExpiry is int) {\n-                                cachedTokenExpiry = cachedTokenExpiry * 1000;\n-                                int difference = (cachedTokenExpiry - currentTime);\n-                                if (difference < skewTime) {\n-                                    printDebug(KEY_JWT_AUTH_PROVIDER, \"JWT regenerated because of the skew time\");\n-                                    status = setJWTHeader(<@untainted>payload, req, cacheKey, enabledCaching, apiDetails,\n-                                                            remoteUserClaimRetrievalEnabled);\n-                                } else {\n-                                    req.setHeader(jwtheaderName, cachedToken);\n-                                    status = true;\n-                                }\n-                            } else {\n-                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Failed to read exp from cached token\");\n-                                return false;\n-                            }\n-                        }\n-                    } else {\n-                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Could not find in the jwt generator cache\");\n-                        status = setJWTHeader(<@untainted>payload, req, cacheKey, enabledCaching, apiDetails,\n-                                            remoteUserClaimRetrievalEnabled);\n-                    }\n-                } else {\n-                    printDebug(KEY_JWT_AUTH_PROVIDER, \"JWT generator caching is disabled\");\n-                    status = setJWTHeader(<@untainted>payload, req, cacheKey, enabledCaching, apiDetails,\n-                                            remoteUserClaimRetrievalEnabled);\n-                }\n+                BackendJWTGenUserContextDTO tokenContextDTO = {\n+                    issuer : issuer,\n+                    remoteUserClaimRetrievalEnabled : remoteUserClaimRetrievalEnabled,\n+                    payload : payload", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4c9f3782abb2fe60146d06a13a209ce47a4ded", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/0b4c9f3782abb2fe60146d06a13a209ce47a4ded", "committedDate": "2020-07-23T07:55:15Z", "message": "Refactor Jwt Generator Implementation and add DefaultClaimRetriever"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34b46f7441d183eabb7fde0a04874bf40f7e6bc7", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/34b46f7441d183eabb7fde0a04874bf40f7e6bc7", "committedDate": "2020-07-20T10:46:27Z", "message": "bug fix: if the retrieved claimList is null, the method returns a null pointer error"}, "afterCommit": {"oid": "0b4c9f3782abb2fe60146d06a13a209ce47a4ded", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/0b4c9f3782abb2fe60146d06a13a209ce47a4ded", "committedDate": "2020-07-23T07:55:15Z", "message": "Refactor Jwt Generator Implementation and add DefaultClaimRetriever"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d3390b8bd65340b573c6263aceaf58a1e74c43", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/03d3390b8bd65340b573c6263aceaf58a1e74c43", "committedDate": "2020-07-23T10:18:19Z", "message": "Update components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/config_dtos/jwt_generator_config.bal\n\nCo-authored-by: Amali Matharaarachchi <amalim@wso2.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7104fcc6aca2aad8fd6605c9cb23877acadd9116", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/7104fcc6aca2aad8fd6605c9cb23877acadd9116", "committedDate": "2020-07-23T10:18:31Z", "message": "Update components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/config_dtos/listener_config.bal\n\nCo-authored-by: Amali Matharaarachchi <amalim@wso2.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad27aa0601bdd2f86b6c61f2db983dfb7c0893f9", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/ad27aa0601bdd2f86b6c61f2db983dfb7c0893f9", "committedDate": "2020-07-23T19:22:43Z", "message": "change jwt scenario's backend jwt generation to take claims from Principal to solve the issue of claim mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a5389a1f5741d1e841e5c51f5c32b8cef4b19a", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/c1a5389a1f5741d1e841e5c51f5c32b8cef4b19a", "committedDate": "2020-07-23T19:23:14Z", "message": "Merge branch 'backend-jwt-refactor' of https://github.com/VirajSalaka/product-microgateway into backend-jwt-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4bf52cdc8b6b35253c98ff7e12b4cea6d37d058", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/b4bf52cdc8b6b35253c98ff7e12b4cea6d37d058", "committedDate": "2020-07-26T12:34:25Z", "message": "code review notes added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7240f2c2a2c85d85d83ed3bd29169d6d28ad72aa", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/7240f2c2a2c85d85d83ed3bd29169d6d28ad72aa", "committedDate": "2020-07-26T20:58:38Z", "message": "Add a new cache to hold the expiry time of the generated tokens"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cff53e2f64a348347aaa877d1abc7e7c20bfd9d8", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/cff53e2f64a348347aaa877d1abc7e7c20bfd9d8", "committedDate": "2020-07-28T04:47:45Z", "message": "add modified claims from principal for the self contained access token based approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5640b0d52a8c8e392ead6de2039efa12938436d8", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/5640b0d52a8c8e392ead6de2039efa12938436d8", "committedDate": "2020-07-30T04:47:55Z", "message": "add subscriberTenantDomain to the generated JWT and add jackson libraries to gateway module"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbc97d209e00de08c35b31cc06a60e40c358b0f2", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/bbc97d209e00de08c35b31cc06a60e40c358b0f2", "committedDate": "2020-07-30T04:46:08Z", "message": "add subscriberTenantDomain to the generated JWT and add jackson libraries to gateway module"}, "afterCommit": {"oid": "5640b0d52a8c8e392ead6de2039efa12938436d8", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/5640b0d52a8c8e392ead6de2039efa12938436d8", "committedDate": "2020-07-30T04:47:55Z", "message": "add subscriberTenantDomain to the generated JWT and add jackson libraries to gateway module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab84e3a9350b36c2babbd3071ff8b1e12be52d51", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/ab84e3a9350b36c2babbd3071ff8b1e12be52d51", "committedDate": "2020-07-30T05:12:59Z", "message": "Merge branch 'master' into backend-jwt-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "816f9f29a825e6681c6bd8f3ef56df522071f0e6", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/816f9f29a825e6681c6bd8f3ef56df522071f0e6", "committedDate": "2020-07-30T19:20:55Z", "message": "bug fix: fix the issue where jwtcache is not used to check the backend jwt claim"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4Nzg5MzI0", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-458789324", "createdAt": "2020-07-30T22:06:58Z", "commit": {"oid": "816f9f29a825e6681c6bd8f3ef56df522071f0e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowNjo1OFrOG51fZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowNjo1OFrOG51fZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5ODQwNQ==", "bodyText": "Remove the issuer ballerina doc parameter. This gives a warning when building the mgw project.", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r463298405", "createdAt": "2020-07-30T22:06:58Z", "author": {"login": "menakaj"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/jwt_auth_handler.bal", "diffHunk": "@@ -117,12 +114,16 @@ public type JWTAuthHandler object {\n \n # Check whether backendJwt claim is in the payload and set the header if avaialable.\n #\n+# + jwtValidatorConfig - jwtValidatorConfig to access the jwtCache object\n # + credential - Credential\n # + req - The `Request` instance.\n # + issuer - The jwt issuer who issued the token and comes in the iss claim.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "816f9f29a825e6681c6bd8f3ef56df522071f0e6"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTE5MjY1", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-458919265", "createdAt": "2020-07-31T05:10:38Z", "commit": {"oid": "816f9f29a825e6681c6bd8f3ef56df522071f0e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNToxMDozOFrOG58LVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNToxMDozOFrOG58LVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNzk1Ng==", "bodyText": "Use the principal instead. Otherwise, if the cache is disabled, these all locations will decode the JWT repeatedly.", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r463407956", "createdAt": "2020-07-31T05:10:38Z", "author": {"login": "VirajSalaka"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/jwt_auth_handler.bal", "diffHunk": "@@ -113,12 +114,16 @@ public type JWTAuthHandler object {\n \n # Check whether backendJwt claim is in the payload and set the header if avaialable.\n #\n+# + jwtValidatorConfig - jwtValidatorConfig to access the jwtCache object\n # + credential - Credential\n # + req - The `Request` instance.\n # + issuer - The jwt issuer who issued the token and comes in the iss claim.\n # + return - Returns boolean based on backend jwt setting.\n-public function setBackendJwtHeader(string credential, http:Request req, string? issuer) returns @tainted boolean {\n-    (jwt:JwtPayload | error) payload = getDecodedJWTPayload(credential, issuer);\n+public function setBackendJwtHeader(jwt:JwtValidatorConfig jwtValidatorConfig,\n+                                    string credential,\n+                                    http:Request req)\n+                                    returns @tainted boolean {\n+    (jwt:JwtPayload | error) payload = getDecodedJWTPayload(jwtValidatorConfig, credential);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "816f9f29a825e6681c6bd8f3ef56df522071f0e6"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82656bc69e7458b3840371dc935efe13a031c924", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/82656bc69e7458b3840371dc935efe13a031c924", "committedDate": "2020-07-31T05:20:08Z", "message": "Revert \"bug fix: fix the issue where jwtcache is not used to check the backend jwt claim\"\n\nThis reverts commit 816f9f29a825e6681c6bd8f3ef56df522071f0e6."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07f4cea95eef0b1a7edceb32af927a6dcc74ade7", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/07f4cea95eef0b1a7edceb32af927a6dcc74ade7", "committedDate": "2020-07-31T09:02:57Z", "message": "merge 3.1.0 jwt token path and 3.2.0 token path, use principal rather than using payload. The reason is if we are to support disable caching, then the decodeJWT method will be called repeatedly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDMwMzQ1", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-459030345", "createdAt": "2020-07-31T09:13:53Z", "commit": {"oid": "07f4cea95eef0b1a7edceb32af927a6dcc74ade7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToxMzo1M1rOG6BtVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOToxMzo1M1rOG6BtVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5ODU4Mg==", "bodyText": "Is there a usage of the authContext in this method? We can remove it.", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r463498582", "createdAt": "2020-07-31T09:13:53Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/jwt_gen_util.bal", "diffHunk": "@@ -295,14 +285,47 @@ function getGeneratedTokenExpTimeFromCache(string cacheKey, string jwtToken) ret\n     }\n }\n \n-# To update the custom claims of jwt payload with principal's custom claims. This is required to pass the mapped claims.\n-# + payload - JWT Payload\n-# + return - modified payload with principal's claims\n-function updateCustomClaimsUsingPrincipal(jwt:JwtPayload payload) returns jwt:JwtPayload {\n-    runtime:Principal? principal = runtime:getInvocationContext()?.principal;\n-    if (principal is runtime:Principal) {\n-            map<any>? principalClaims = principal?.claims;\n-            payload.customClaims = <(map<json>)> principalClaims;\n+# Generate the backend JWT token and set to the header of the outgoing request.\n+#\n+# + credential - Credential\n+# + authContext - Authentication Context\n+# + req - The `Request` instance.\n+# + enabledJWTGenerator - state of jwt generator\n+# + classLoaded - whether the class is loaded successfully\n+# + enabledCaching - jwt generator caching enabled\n+# + skewTime - skew time to backend\n+# + issuer - The jwt issuer who issued the token and comes in the iss claim.\n+# + remoteUserClaimRetrievalEnabled - true if remoteUserClaimRetrieval is enabled\n+# + isJWT - `true` if the user is authenticated using jwt token\n+# + return - Returns `true` if the token generation and setting the header completed successfully\n+# or the `AuthenticationError` in case of an error.\n+public function generateAndSetBackendJwtHeader(string credential,\n+                                                http:Request req,\n+                                                AuthenticationContext authContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07f4cea95eef0b1a7edceb32af927a6dcc74ade7"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDQyMDA4", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-459042008", "createdAt": "2020-07-31T09:33:37Z", "commit": {"oid": "07f4cea95eef0b1a7edceb32af927a6dcc74ade7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTozMzozN1rOG6CSRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTozMzozN1rOG6CSRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwODAzOA==", "bodyText": "I suppose we can remove this now.", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r463508038", "createdAt": "2020-07-31T09:33:37Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/jwt_auth_handler.bal", "diffHunk": "@@ -80,22 +79,27 @@ public type JWTAuthHandler object {\n     # + return - Returns `true` if authenticated successfully. Else, returns `false`\n     # or the `AuthenticationError` in case of an error.\n     public function process(http:Request req) returns @tainted boolean | http:AuthenticationError {\n-        string authHeader = runtime:getInvocationContext().attributes[AUTH_HEADER].toString();\n+        runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n+        string authHeader = invocationContext.attributes[AUTH_HEADER].toString();\n         string headerValue = req.getHeader(authHeader);\n         string credential = headerValue.substring(6, headerValue.length()).trim();\n         var authenticationResult = self.jwtAuthProvider.authenticate(credential);\n         if (authenticationResult is boolean) {\n             string issuer = self.jwtAuthProvider.jwtValidatorConfig?.issuer ?: DEFAULT_JWT_ISSUER;\n             boolean backendJWTfromClaim = setBackendJwtHeader(credential, req, issuer);\n             if (!backendJWTfromClaim) {\n-                boolean generationStatus = generateAndSetBackendJwtHeaderJWT(credential,\n+                AuthenticationContext authContext =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07f4cea95eef0b1a7edceb32af927a6dcc74ade7"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDQ0NzEx", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-459044711", "createdAt": "2020-07-31T09:38:20Z", "commit": {"oid": "337f92d8f381cc6a994235a0a15b8671a492c263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTozODoyMFrOG6Ca5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTozODoyMFrOG6Ca5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUxMDI0Ng==", "bodyText": "Shall we use TODO(gitusername) format?", "url": "https://github.com/wso2/product-microgateway/pull/1345#discussion_r463510246", "createdAt": "2020-07-31T09:38:20Z", "author": {"login": "AmaliMatharaarachchi"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/config_dtos/jwt_generator_config.bal", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+public type JWTGeneratorConfigDTO record {|\n+    boolean jwtGeneratorEnabled = getConfigBooleanValue(JWT_GENERATOR_ID,\n+                                                        JWT_GENERATOR_ENABLED,\n+                                                        DEFAULT_JWT_GENERATOR_ENABLED);\n+    string dialectURI = getConfigValue(JWT_GENERATOR_ID,\n+                                        JWT_GENERATOR_DIALECT,\n+                                        DEFAULT_JWT_GENERATOR_DIALECT);\n+    string signingAlgorithm = getConfigValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_SIGN_ALGO,\n+                                            DEFAULT_JWT_GENERATOR_SIGN_ALGO);\n+    string certificateAlias = getConfigValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_CERTIFICATE_ALIAS,\n+                                                DEFAULT_JWT_GENERATOR_CERTIFICATE_ALIAS);\n+    string privateKeyAlias = getConfigValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_PRIVATE_KEY_ALIAS,\n+                                            DEFAULT_JWT_GENERATOR_PRIVATE_KEY_ALIAS);\n+    int tokenExpiry = getConfigIntValue(JWT_GENERATOR_ID,\n+                                            JWT_GENERATOR_TOKEN_EXPIRY,\n+                                            DEFAULT_JWT_GENERATOR_TOKEN_EXPIRY);\n+    any[] restrictedClaims = getConfigArrayValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_RESTRICTED_CLAIMS);\n+    string issuer = getConfigValue(JWT_GENERATOR_ID,\n+                                        JWT_GENERATOR_TOKEN_ISSUER,\n+                                        DEFAULT_JWT_GENERATOR_TOKEN_ISSUER);\n+    any[] tokenAudience = getConfigArrayValue(JWT_GENERATOR_ID,\n+                                                JWT_GENERATOR_TOKEN_AUDIENCE);\n+    string generatorImpl = getConfigValue(JWT_GENERATOR_ID, \n+                                            JWT_GENERATOR_IMPLEMENTATION,\n+                                            DEFAULT_JWT_GENERATOR_IMPLEMENTATION);                                            \n+    JWTGeneratorConfig_jwtGeneratorCaching jwtGeneratorCaching = {};\n+    JWTGeneratorConfig_claimRetrieval claimRetrieval = {};\n+|};\n+\n+//todo: Check if it is required declare new default constants specifically for jwt generator cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "337f92d8f381cc6a994235a0a15b8671a492c263"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "329d4c14a5d2534e9cea2bcf9179b32f1a670797", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/329d4c14a5d2534e9cea2bcf9179b32f1a670797", "committedDate": "2020-07-31T09:53:59Z", "message": "refactor : remove unused variable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "337f92d8f381cc6a994235a0a15b8671a492c263", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/337f92d8f381cc6a994235a0a15b8671a492c263", "committedDate": "2020-07-31T09:29:34Z", "message": "refactor : remove unused variable"}, "afterCommit": {"oid": "329d4c14a5d2534e9cea2bcf9179b32f1a670797", "author": {"user": {"login": "VirajSalaka", "name": "Viraj Salaka"}}, "url": "https://github.com/wso2/product-microgateway/commit/329d4c14a5d2534e9cea2bcf9179b32f1a670797", "committedDate": "2020-07-31T09:53:59Z", "message": "refactor : remove unused variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDgwMzEx", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-459080311", "createdAt": "2020-07-31T10:39:19Z", "commit": {"oid": "329d4c14a5d2534e9cea2bcf9179b32f1a670797"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjg0NTAw", "url": "https://github.com/wso2/product-microgateway/pull/1345#pullrequestreview-460684500", "createdAt": "2020-08-04T10:20:26Z", "commit": {"oid": "329d4c14a5d2534e9cea2bcf9179b32f1a670797"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 935, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}