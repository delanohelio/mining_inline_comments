{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNjI1NDQ4", "number": 1249, "title": "Fix #988 - Support mutual SSL in API level ", "bodyText": "Purpose\nSupport mutual SSL in API level\nIssues\nFixes #988\nFixes #1269\nIf there is an LB between the client and the gateway, LB sets the client's certificate in a header. Then the Microgateway will check whether the mutual SSL handshake is passed. After that, Microgateway will check whether the request has the certificate header.\n\n\nIf it has the certificate header, then it validates that header certificate with the mutual SSL certificate configured for the API validated in the trustStore.\n\n\nIf it does not have the certificate header, the certificate used for the handshake is validated with the mutual SSL certificate configured for the API with the certificate alias.\n\n\nAutomation tests\n\nUnit tests added: Yes/No\nIntegration tests added: Yes/No\n\nTested environments\n\nNot Tested\n\nMaintainers: Check before merge\n\n Assigned 'Type' label\n Assigned the project\n Validated respective github issues\n Assigned milestone to the github issue(s)", "createdAt": "2020-05-25T08:46:25Z", "url": "https://github.com/wso2/product-microgateway/pull/1249", "merged": true, "mergeCommit": {"oid": "659487df9b1891a9f08e7dacaf7b5fa1de2d97f7"}, "closed": true, "closedAt": "2020-06-09T11:17:33Z", "author": {"login": "tharmini"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjgTVrgH2gAyNDIyNjI1NDQ4OmQwYzI3MjBkNjZlOGRkYzI5ODJhM2Y1NmU5ZGI5MzcwNjVkNjAyOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpia10AFqTQyNzAwMTA2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0c2720d66e8ddc2982a3f56e9db937065d6029b", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/d0c2720d66e8ddc2982a3f56e9db937065d6029b", "committedDate": "2020-05-21T16:31:31Z", "message": "add functionality to validate Mutual SSL certificate as a Header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae2b097dd120b1e91013275d25ba114e5e8afb9b", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/ae2b097dd120b1e91013275d25ba114e5e8afb9b", "committedDate": "2020-05-22T08:42:21Z", "message": "validate the certificate alias per api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e59034f0a006d0dd43f9c699995e720f523a2f5", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/8e59034f0a006d0dd43f9c699995e720f523a2f5", "committedDate": "2020-05-25T07:57:23Z", "message": "insert cache for store mutual ssl certificate information\n\nreformat code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/db09070ea5379e7fdbca059c8c0360ae4a8f8d74", "committedDate": "2020-05-27T10:47:07Z", "message": "resolve comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f75a2e58395b5f51821c6c5b9665fbe05c40a3e", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/0f75a2e58395b5f51821c6c5b9665fbe05c40a3e", "committedDate": "2020-05-27T10:43:13Z", "message": "resolve comments"}, "afterCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/db09070ea5379e7fdbca059c8c0360ae4a8f8d74", "committedDate": "2020-05-27T10:47:07Z", "message": "resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNjcwMjU4", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-420670258", "createdAt": "2020-05-29T05:55:44Z", "commit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNTo1NTo0NFrOGcPrfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNjowMTozM1rOGcPyEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MDIwNw==", "bodyText": "Suggested change", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432270207", "createdAt": "2020-05-29T05:55:44Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/api_gateway_cache.bal", "diffHunk": "@@ -27,6 +27,8 @@ cache:Cache gatewayKeyValidationCache = new (cacheExpiryTime, cacheSize, evictio\n cache:Cache invalidTokenCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n cache:Cache jwtCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n cache:Cache introspectCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n+cache:Cache mutualSslCertificateCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MDMyOQ==", "bodyText": "Suggested change", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432270329", "createdAt": "2020-05-29T05:56:05Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/api_gateway_cache.bal", "diffHunk": "@@ -27,6 +27,8 @@ cache:Cache gatewayKeyValidationCache = new (cacheExpiryTime, cacheSize, evictio\n cache:Cache invalidTokenCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n cache:Cache jwtCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n cache:Cache introspectCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n+cache:Cache mutualSslCertificateCache = new (cacheExpiryTime, cacheSize, evictionFactor);\n+\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTI2Mw==", "bodyText": "License header is missing", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271263", "createdAt": "2020-05-29T05:59:34Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/native/mutualSSL.bal", "diffHunk": "@@ -0,0 +1,47 @@\n+import ballerinax/java;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTU5OQ==", "bodyText": "License header?", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271599", "createdAt": "2020-05-29T06:00:40Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/LoadKeyStore.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.wso2.micro.gateway.core.mutualssl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTY2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Used to get the keystore path\n          \n          \n            \n                 * Used to get the keystore path.", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271666", "createdAt": "2020-05-29T06:00:50Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/LoadKeyStore.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.core.Constants;\n+\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.CertificateException;\n+\n+/**\n+ * This class is for load the keystore.\n+ */\n+public class LoadKeyStore {\n+    public static KeyStore trustStore;\n+    public static FileInputStream localTrustStoreStream;\n+    private static final Logger log = LoggerFactory.getLogger(\"ballerina\");\n+\n+    public static void loadKeyStore(String trustStorePath, String trustStorePassword) {\n+        try {\n+            localTrustStoreStream = new FileInputStream(getKeyStorePath(trustStorePath));\n+            trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            trustStore.load(localTrustStoreStream, trustStorePassword.toCharArray());\n+\n+        } catch (NoSuchAlgorithmException | IOException | KeyStoreException | CertificateException e) {\n+            String msg = \"Error while loading the trustore\";\n+            log.error(msg, e);\n+        }\n+    }\n+\n+    /**\n+     * Used to get the keystore path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTcxOA==", "bodyText": "License header?", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271718", "createdAt": "2020-05-29T06:01:00Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/MutualsslWithLoadBalancerHeader.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package org.wso2.micro.gateway.core.mutualssl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTgxNQ==", "bodyText": "Incomplete javadoc", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271815", "createdAt": "2020-05-29T06:01:25Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/MutualsslWithLoadBalancerHeader.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.net.URLDecoder;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.cert.CertificateFactory;\n+\n+import javax.security.cert.CertificateEncodingException;\n+import javax.security.cert.CertificateException;\n+import javax.security.cert.X509Certificate;\n+\n+import static org.wso2.micro.gateway.core.Constants.BEGIN_CERTIFICATE_STRING;\n+import static org.wso2.micro.gateway.core.Constants.END_CERTIFICATE_STRING;\n+\n+/**\n+ * This class is responsible for get the alias from the certificate  in mutual SSL handshake\n+ * when the header send by the load balancer.\n+ */\n+public class MutualsslWithLoadBalancerHeader {\n+\n+    public static String getAliasAFromHeaderCert(String base64EncodedCertificate) throws  KeyStoreException,\n+            java.security.cert.CertificateException, CertificateException {\n+        base64EncodedCertificate = URLDecoder.decode(base64EncodedCertificate).\n+                replaceAll(BEGIN_CERTIFICATE_STRING, \"\")\n+                .replaceAll(END_CERTIFICATE_STRING, \"\");\n+        byte[] bytes = Base64.decodeBase64(base64EncodedCertificate);\n+        InputStream inputStream = new ByteArrayInputStream(bytes);\n+        X509Certificate x509Certificate = X509Certificate.getInstance(inputStream);\n+        if (getAliasFromTrustStore(x509Certificate, LoadKeyStore.trustStore) != null) {\n+            return getAliasFromTrustStore(x509Certificate, LoadKeyStore.trustStore);\n+        } else {\n+            return \"\";\n+        }\n+    }\n+\n+    /**\n+     *  Used to get the certificate alias for a certificate exist in the trustore.\n+     *\n+     * @param certificate", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MTg4OA==", "bodyText": "License header?", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r432271888", "createdAt": "2020-05-29T06:01:33Z", "author": {"login": "praminda"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/MutualsslWithoutLoadBalancerHeader.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.wso2.micro.gateway.core.mutualssl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09070ea5379e7fdbca059c8c0360ae4a8f8d74"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69251634f63116c274a2c5445d865fdb9771dbf0", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/69251634f63116c274a2c5445d865fdb9771dbf0", "committedDate": "2020-05-29T16:57:46Z", "message": "change if condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "443391f76e25ffff200e45b148469b095bda878d", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/443391f76e25ffff200e45b148469b095bda878d", "committedDate": "2020-06-01T03:35:04Z", "message": "add license file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c98509790bfde4580cc093971f908f402b8e9020", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/c98509790bfde4580cc093971f908f402b8e9020", "committedDate": "2020-06-03T07:41:28Z", "message": "resolve comments from claim mapping\n# Conflicts:\n#\tcomponents/micro-gateway-core/src/main/ballerina/src/gateway/api_gateway_cache.bal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/3ab4771e0fa401eea8989320a8ee68bd88c2b5b9", "committedDate": "2020-06-03T09:56:13Z", "message": "uncomment test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDAzNDc4", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426403478", "createdAt": "2020-06-08T16:19:07Z", "commit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoxOTowN1rOGgmDGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoxOTowN1rOGgmDGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMTAwMg==", "bodyText": "variable name aliasAFromHeaderCert , shouldn't it be aliasFromHeaderCert", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r436831002", "createdAt": "2020-06-08T16:19:07Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/mutualSSL_handler.bal", "diffHunk": "@@ -39,30 +56,107 @@ public type MutualSSLHandler object {\n     public function process(http:Request req) returns boolean | http:AuthenticationError {\n         string|error mutualSSLVerifyClient = getMutualSSL();\n         if (mutualSSLVerifyClient is string && stringutils:equalsIgnoreCase(MANDATORY, mutualSSLVerifyClient) \n-                && req.mutualSslHandshake[STATUS] != PASSED ) {\n+                && req.mutualSslHandshake[STATUS] != PASSED) {\n             if (req.mutualSslHandshake[STATUS] == FAILED) {\n                 printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: FAILED\");\n             }\n             // provided more generic error code to avoid security issues.\n             setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS); \n             return prepareAuthenticationError(\"Failed to authenticate with MutualSSL handler\");            \n         }\n-\n         if (req.mutualSslHandshake[STATUS] == PASSED) {\n-            printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: PASSED\");\n             runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-            doMTSLFilterRequest(req, invocationContext); \n+            if (mutualSSLVerifyClient is string && stringutils:equalsIgnoreCase(MANDATORY, mutualSSLVerifyClient)) {\n+                string apiVersion = invocationContext.attributes[API_VERSION_PROPERTY].toString();\n+                string apiName = invocationContext.attributes[API_NAME].toString();\n+                if (self.headerName != \"\" &&  req.hasHeader(self.headerName)) {\n+                    if (!self.isClientCertificateValidationEnabled) {\n+                        string headerValue = req.getHeader(self.headerName);\n+                        if (headerValue != \"\") {\n+                            var cacheKey = headerValue + apiName + apiVersion;\n+                            var isExistCertCache = self.gatewayCache.retrieveFromMutualSslCertificateCache(cacheKey);\n+                            if (isExistCertCache is boolean) {\n+                                if (!isExistCertCache) {\n+                                    printDebug(KEY_AUTHN_FILTER,\"Mutual SSL authentication failure. \" +\n+                                    \"API is not associated with the certificate\");\n+                                    setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS);\n+                                    return false;\n+                                } else {\n+                                    printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: PASSED\");\n+                                    doMTSLFilterRequest(req, invocationContext);\n+                                    return true;\n+                                }\n+                            } else {\n+                                handle|error aliasAFromHeaderCert = getAliasAFromHeaderCert(headerValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDA3MDI3", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426407027", "createdAt": "2020-06-08T16:23:29Z", "commit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoyMzoyOVrOGgmONA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoyMzoyOVrOGgmONA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzg0NA==", "bodyText": "Why do we expect cert to be always present in the cache. If it is not in the cache shouldn't we go and check the cert in the trust store", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r436833844", "createdAt": "2020-06-08T16:23:29Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/mutualSSL_handler.bal", "diffHunk": "@@ -39,30 +56,107 @@ public type MutualSSLHandler object {\n     public function process(http:Request req) returns boolean | http:AuthenticationError {\n         string|error mutualSSLVerifyClient = getMutualSSL();\n         if (mutualSSLVerifyClient is string && stringutils:equalsIgnoreCase(MANDATORY, mutualSSLVerifyClient) \n-                && req.mutualSslHandshake[STATUS] != PASSED ) {\n+                && req.mutualSslHandshake[STATUS] != PASSED) {\n             if (req.mutualSslHandshake[STATUS] == FAILED) {\n                 printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: FAILED\");\n             }\n             // provided more generic error code to avoid security issues.\n             setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS); \n             return prepareAuthenticationError(\"Failed to authenticate with MutualSSL handler\");            \n         }\n-\n         if (req.mutualSslHandshake[STATUS] == PASSED) {\n-            printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: PASSED\");\n             runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n-            doMTSLFilterRequest(req, invocationContext); \n+            if (mutualSSLVerifyClient is string && stringutils:equalsIgnoreCase(MANDATORY, mutualSSLVerifyClient)) {\n+                string apiVersion = invocationContext.attributes[API_VERSION_PROPERTY].toString();\n+                string apiName = invocationContext.attributes[API_NAME].toString();\n+                if (self.headerName != \"\" &&  req.hasHeader(self.headerName)) {\n+                    if (!self.isClientCertificateValidationEnabled) {\n+                        string headerValue = req.getHeader(self.headerName);\n+                        if (headerValue != \"\") {\n+                            var cacheKey = headerValue + apiName + apiVersion;\n+                            var isExistCertCache = self.gatewayCache.retrieveFromMutualSslCertificateCache(cacheKey);\n+                            if (isExistCertCache is boolean) {\n+                                if (!isExistCertCache) {\n+                                    printDebug(KEY_AUTHN_FILTER,\"Mutual SSL authentication failure. \" +\n+                                    \"API is not associated with the certificate\");\n+                                    setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS);\n+                                    return false;\n+                                } else {\n+                                    printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: PASSED\");\n+                                    doMTSLFilterRequest(req, invocationContext);\n+                                    return true;\n+                                }\n+                            } else {\n+                                handle|error aliasAFromHeaderCert = getAliasAFromHeaderCert(headerValue);\n+                                if (aliasAFromHeaderCert is error) {\n+                                    setErrorMessageToInvocationContext(API_AUTH_GENERAL_ERROR);\n+                                    return prepareAuthenticationError(\"Unclassified Authentication Failure\");\n+                                }\n+                                if (aliasAFromHeaderCert is handle) {\n+                                    boolean isExistAlias = isExistApiAlias(apiVersion, apiName, aliasAFromHeaderCert.toString(),\n+                                    self.apiCertificateList);\n+                                    if (!isExistAlias || aliasAFromHeaderCert.toString() == \"\") {\n+                                        printDebug(KEY_AUTHN_FILTER, \"Mutual SSL authentication failure. API is not associated \" +\n+                                        \"with the certificate\");\n+                                        self.gatewayCache.addMutualSslCertificateCache(cacheKey, false);\n+                                        setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS);\n+                                        return false;\n+                                    } else {\n+                                        printDebug(KEY_AUTHN_FILTER, \"MutualSSL handshake status: PASSED\");\n+                                        doMTSLFilterRequest(req, invocationContext);\n+                                        self.gatewayCache.addMutualSslCertificateCache(cacheKey, true);\n+                                        return true;\n+                                    }\n+                                }\n+\n+                            }\n+                        } else {\n+                            printDebug(KEY_AUTHN_FILTER, \"Header has empty value sent by the payload\");\n+                            setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS);\n+                            return false;\n+                        }\n+                    }\n+                }\n+                string? cert = req.mutualSslHandshake[\"base64EncodedCert\"];\n+                var cacheKey = cert.toString() + apiName + apiVersion;\n+                var isExistCertCache = self.gatewayCache.retrieveFromMutualSslCertificateCache(cacheKey);\n+                if (isExistCertCache is boolean) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDExMjAx", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426411201", "createdAt": "2020-06-08T16:28:34Z", "commit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoyODozNFrOGgmaug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoyODozNFrOGgmaug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNzA1MA==", "bodyText": "Do we need two classes. Can't we use the same MutualsslWithLoadBalancerHeader. It has the same method. We can have a common class name and use it", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r436837050", "createdAt": "2020-06-08T16:28:34Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/MutualsslWithoutLoadBalancerHeader.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import java.io.ByteArrayInputStream;\n+import java.security.KeyStoreException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.util.Base64;\n+\n+/**\n+ * This class is for getting the certificate alias for a certificate to validate against per API.\n+ */\n+public class MutualsslWithoutLoadBalancerHeader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDI3MDky", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426427092", "createdAt": "2020-06-08T16:48:51Z", "commit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0ODo1MVrOGgnK3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0ODo1MVrOGgnK3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0OTM3NQ==", "bodyText": "Isn't these values are used below", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r436849375", "createdAt": "2020-06-08T16:48:51Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/utils.bal", "diffHunk": "@@ -905,8 +912,6 @@ function readMultipleJWTIssuers() {\n     if (jwtIssuers is map<anydata>[] && jwtIssuers.length() > 0) {\n         initiateJwtMap();\n         printDebug(KEY_UTILS, \"Found new multiple JWT issuer configs\");\n-        string trustStorePath = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PATH, DEFAULT_TRUST_STORE_PATH);\n-        string trustStorePassword = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PASSWORD, DEFAULT_TRUST_STORE_PASSWORD);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ab4771e0fa401eea8989320a8ee68bd88c2b5b9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTU2Nzcy", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426956772", "createdAt": "2020-06-09T09:26:08Z", "commit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyNjowOFrOGhA2Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyNjowOFrOGhA2Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3MDA4Nw==", "bodyText": "Lets not use static imports", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r437270087", "createdAt": "2020-06-09T09:26:08Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/CheckMutualSSLCertificate.java", "diffHunk": "@@ -0,0 +1,86 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.net.URLDecoder;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.cert.CertificateFactory;\n+\n+import javax.security.cert.CertificateEncodingException;\n+import javax.security.cert.CertificateException;\n+import javax.security.cert.X509Certificate;\n+\n+import static org.wso2.micro.gateway.core.Constants.BEGIN_CERTIFICATE_STRING;\n+import static org.wso2.micro.gateway.core.Constants.END_CERTIFICATE_STRING;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTU4Mjgz", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426958283", "createdAt": "2020-06-09T09:27:54Z", "commit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyNzo1NFrOGhA63w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyNzo1NFrOGhA63w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3MTI2Mw==", "bodyText": "lets rename the method to getAliasFromHeaderCert removing the A", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r437271263", "createdAt": "2020-06-09T09:27:54Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/CheckMutualSSLCertificate.java", "diffHunk": "@@ -0,0 +1,86 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.net.URLDecoder;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.cert.CertificateFactory;\n+\n+import javax.security.cert.CertificateEncodingException;\n+import javax.security.cert.CertificateException;\n+import javax.security.cert.X509Certificate;\n+\n+import static org.wso2.micro.gateway.core.Constants.BEGIN_CERTIFICATE_STRING;\n+import static org.wso2.micro.gateway.core.Constants.END_CERTIFICATE_STRING;\n+\n+/**\n+ * This class is responsible for get the alias from the certificate  in mutual SSL handshake,\n+ * when the header send by the load balancer.\n+ */\n+public class CheckMutualSSLCertificate {\n+\n+    public static String getAliasAFromHeaderCert(String base64EncodedCertificate) throws  KeyStoreException,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTU5MjYx", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426959261", "createdAt": "2020-06-09T09:29:05Z", "commit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyOTowNVrOGhA9xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToyOTowNVrOGhA9xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI3MjAwNA==", "bodyText": "Lets rename this class as CertificateUtils", "url": "https://github.com/wso2/product-microgateway/pull/1249#discussion_r437272004", "createdAt": "2020-06-09T09:29:05Z", "author": {"login": "Rajith90"}, "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mutualssl/CheckMutualSSLCertificate.java", "diffHunk": "@@ -0,0 +1,86 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.core.mutualssl;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.net.URLDecoder;\n+import java.security.KeyStore;\n+import java.security.KeyStoreException;\n+import java.security.cert.CertificateFactory;\n+\n+import javax.security.cert.CertificateEncodingException;\n+import javax.security.cert.CertificateException;\n+import javax.security.cert.X509Certificate;\n+\n+import static org.wso2.micro.gateway.core.Constants.BEGIN_CERTIFICATE_STRING;\n+import static org.wso2.micro.gateway.core.Constants.END_CERTIFICATE_STRING;\n+\n+/**\n+ * This class is responsible for get the alias from the certificate  in mutual SSL handshake,\n+ * when the header send by the load balancer.\n+ */\n+public class CheckMutualSSLCertificate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f71c30df16196575b651a9b6460a12c8dd70160"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f76eb63a4778fcbeefc03572ef61e2deb87e8644", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/f76eb63a4778fcbeefc03572ef61e2deb87e8644", "committedDate": "2020-06-09T09:51:40Z", "message": "add comments"}, "afterCommit": {"oid": "6b68f7a0b891c8837ca2c035869e5e12c9db5b7b", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/6b68f7a0b891c8837ca2c035869e5e12c9db5b7b", "committedDate": "2020-06-09T09:54:55Z", "message": "combine two classes into one and resolve comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTgxNzIx", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-426981721", "createdAt": "2020-06-09T09:57:02Z", "commit": {"oid": "6b68f7a0b891c8837ca2c035869e5e12c9db5b7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "876e92cb8766631990833a65af02ad811815ff24", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/876e92cb8766631990833a65af02ad811815ff24", "committedDate": "2020-06-09T10:21:21Z", "message": "combine two classes into one and resolve comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ef71a3b89834a019ea28ed0bc7257158b362b3c", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/5ef71a3b89834a019ea28ed0bc7257158b362b3c", "committedDate": "2020-06-09T10:20:30Z", "message": "resolve comments"}, "afterCommit": {"oid": "876e92cb8766631990833a65af02ad811815ff24", "author": {"user": {"login": "tharmini", "name": "Tharmini Thalayasingam"}}, "url": "https://github.com/wso2/product-microgateway/commit/876e92cb8766631990833a65af02ad811815ff24", "committedDate": "2020-06-09T10:21:21Z", "message": "combine two classes into one and resolve comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDAxMDY4", "url": "https://github.com/wso2/product-microgateway/pull/1249#pullrequestreview-427001068", "createdAt": "2020-06-09T10:23:04Z", "commit": {"oid": "876e92cb8766631990833a65af02ad811815ff24"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1096, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}