{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMTI0NzUz", "number": 927, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMzozNToyOVrOEEIPQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMzozNjoxM1rOEEIPrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNzY0NzM3OnYy", "diffSide": "LEFT", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMzozNToyOVrOGhjsog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNzowOTowOVrOGh-iiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MTA1OA==", "bodyText": "I'm not sure I understand this removal -- we still will make a single WriteCredentials call, which may contain multiple credentials", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/927#discussion_r437841058", "createdAt": "2020-06-10T03:35:29Z", "author": {"login": "jbzdarkid"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "diffHunk": "@@ -93,37 +91,26 @@ public static MsalCppOAuth2TokenCache create(@NonNull final Context context) {\n     }\n \n     /**\n-     * @param accountRecord : AccountRecord associated with the input credentials.\n+     * @param accountRecord : AccountRecord associated with the input credentials, can be null.\n      * @param credentials   : list of Credential which can include AccessTokenRecord, IdTokenRecord and RefreshTokenRecord.\n-     *                      Note : Both IdTokenRecord and RefreshTokenRecord need to be non null. AccessTokenRecord can be optional.\n      * @throws ClientException : If the supplied Account or Credential are null or schema invalid.\n      */\n-    public synchronized void saveCredentials(@NonNull final AccountRecord accountRecord,\n+    public synchronized void saveCredentials(@Nullable final AccountRecord accountRecord,\n                                              @NonNull final Credential... credentials) throws ClientException {\n         if (credentials == null || credentials.length == 0) {\n             throw new ClientException(\"Credential array passed in is null or empty\");\n         }\n \n-        AccessTokenRecord accessTokenRecord = null;\n-        IdTokenRecord idTokenRecord = null;\n         RefreshTokenRecord refreshTokenRecord = null;\n \n         for (final Credential credential : credentials) {\n-            if (credential instanceof AccessTokenRecord) {\n-                accessTokenRecord = (AccessTokenRecord) credential;\n-            } else if (credential instanceof IdTokenRecord) {\n-                idTokenRecord = (IdTokenRecord) credential;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8119aa16a639cc7c88b2592ab132b2c23348cf50"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4MDg0Mw==", "bodyText": "We are saving all the credentials, see line 115. I removed explicit validation to check that both IdToken and RefreshToken needs to be present.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/927#discussion_r438280843", "createdAt": "2020-06-10T17:09:09Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "diffHunk": "@@ -93,37 +91,26 @@ public static MsalCppOAuth2TokenCache create(@NonNull final Context context) {\n     }\n \n     /**\n-     * @param accountRecord : AccountRecord associated with the input credentials.\n+     * @param accountRecord : AccountRecord associated with the input credentials, can be null.\n      * @param credentials   : list of Credential which can include AccessTokenRecord, IdTokenRecord and RefreshTokenRecord.\n-     *                      Note : Both IdTokenRecord and RefreshTokenRecord need to be non null. AccessTokenRecord can be optional.\n      * @throws ClientException : If the supplied Account or Credential are null or schema invalid.\n      */\n-    public synchronized void saveCredentials(@NonNull final AccountRecord accountRecord,\n+    public synchronized void saveCredentials(@Nullable final AccountRecord accountRecord,\n                                              @NonNull final Credential... credentials) throws ClientException {\n         if (credentials == null || credentials.length == 0) {\n             throw new ClientException(\"Credential array passed in is null or empty\");\n         }\n \n-        AccessTokenRecord accessTokenRecord = null;\n-        IdTokenRecord idTokenRecord = null;\n         RefreshTokenRecord refreshTokenRecord = null;\n \n         for (final Credential credential : credentials) {\n-            if (credential instanceof AccessTokenRecord) {\n-                accessTokenRecord = (AccessTokenRecord) credential;\n-            } else if (credential instanceof IdTokenRecord) {\n-                idTokenRecord = (IdTokenRecord) credential;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MTA1OA=="}, "originalCommit": {"oid": "8119aa16a639cc7c88b2592ab132b2c23348cf50"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNzY0ODQ1OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMzozNjoxM1rOGhjtOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNzoxNjowOVrOGh-yfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MTIxMQ==", "bodyText": "Just for my own edification, can you add a comment here?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (accountRecord != null && refreshTokenRecord != null) {\n          \n          \n            \n                        removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n          \n          \n            \n                    }\n          \n          \n            \n                    if (accountRecord != null && refreshTokenRecord != null) {\n          \n          \n            \n                        // This will not be true when we are called from MSAL C++, as the account will always be null.\n          \n          \n            \n                        removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nFeel free to reword.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/927#discussion_r437841211", "createdAt": "2020-06-10T03:36:13Z", "author": {"login": "jbzdarkid"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "diffHunk": "@@ -93,37 +91,26 @@ public static MsalCppOAuth2TokenCache create(@NonNull final Context context) {\n     }\n \n     /**\n-     * @param accountRecord : AccountRecord associated with the input credentials.\n+     * @param accountRecord : AccountRecord associated with the input credentials, can be null.\n      * @param credentials   : list of Credential which can include AccessTokenRecord, IdTokenRecord and RefreshTokenRecord.\n-     *                      Note : Both IdTokenRecord and RefreshTokenRecord need to be non null. AccessTokenRecord can be optional.\n      * @throws ClientException : If the supplied Account or Credential are null or schema invalid.\n      */\n-    public synchronized void saveCredentials(@NonNull final AccountRecord accountRecord,\n+    public synchronized void saveCredentials(@Nullable final AccountRecord accountRecord,\n                                              @NonNull final Credential... credentials) throws ClientException {\n         if (credentials == null || credentials.length == 0) {\n             throw new ClientException(\"Credential array passed in is null or empty\");\n         }\n \n-        AccessTokenRecord accessTokenRecord = null;\n-        IdTokenRecord idTokenRecord = null;\n         RefreshTokenRecord refreshTokenRecord = null;\n \n         for (final Credential credential : credentials) {\n-            if (credential instanceof AccessTokenRecord) {\n-                accessTokenRecord = (AccessTokenRecord) credential;\n-            } else if (credential instanceof IdTokenRecord) {\n-                idTokenRecord = (IdTokenRecord) credential;\n-            } else if (credential instanceof RefreshTokenRecord) {\n+            if (credential instanceof RefreshTokenRecord) {\n                 refreshTokenRecord = (RefreshTokenRecord) credential;\n             }\n         }\n-\n-        validateNonNull(accountRecord, \"AccountRecord\");\n-        validateNonNull(refreshTokenRecord, \"RefreshTokenRecord\");\n-        validateNonNull(idTokenRecord, \"IdTokenRecord\");\n-        validateCacheArtifacts(accountRecord, accessTokenRecord, refreshTokenRecord, idTokenRecord);\n-\n-        removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n+        if (accountRecord != null && refreshTokenRecord != null) {\n+            removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8119aa16a639cc7c88b2592ab132b2c23348cf50"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4NDkyNQ==", "bodyText": "the account will not be null, if it already exists, added a comment describing the behavior. Let me know what you think here , we can remove this if x-plat wants to handle this too", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/927#discussion_r438284925", "createdAt": "2020-06-10T17:16:09Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalCppOAuth2TokenCache.java", "diffHunk": "@@ -93,37 +91,26 @@ public static MsalCppOAuth2TokenCache create(@NonNull final Context context) {\n     }\n \n     /**\n-     * @param accountRecord : AccountRecord associated with the input credentials.\n+     * @param accountRecord : AccountRecord associated with the input credentials, can be null.\n      * @param credentials   : list of Credential which can include AccessTokenRecord, IdTokenRecord and RefreshTokenRecord.\n-     *                      Note : Both IdTokenRecord and RefreshTokenRecord need to be non null. AccessTokenRecord can be optional.\n      * @throws ClientException : If the supplied Account or Credential are null or schema invalid.\n      */\n-    public synchronized void saveCredentials(@NonNull final AccountRecord accountRecord,\n+    public synchronized void saveCredentials(@Nullable final AccountRecord accountRecord,\n                                              @NonNull final Credential... credentials) throws ClientException {\n         if (credentials == null || credentials.length == 0) {\n             throw new ClientException(\"Credential array passed in is null or empty\");\n         }\n \n-        AccessTokenRecord accessTokenRecord = null;\n-        IdTokenRecord idTokenRecord = null;\n         RefreshTokenRecord refreshTokenRecord = null;\n \n         for (final Credential credential : credentials) {\n-            if (credential instanceof AccessTokenRecord) {\n-                accessTokenRecord = (AccessTokenRecord) credential;\n-            } else if (credential instanceof IdTokenRecord) {\n-                idTokenRecord = (IdTokenRecord) credential;\n-            } else if (credential instanceof RefreshTokenRecord) {\n+            if (credential instanceof RefreshTokenRecord) {\n                 refreshTokenRecord = (RefreshTokenRecord) credential;\n             }\n         }\n-\n-        validateNonNull(accountRecord, \"AccountRecord\");\n-        validateNonNull(refreshTokenRecord, \"RefreshTokenRecord\");\n-        validateNonNull(idTokenRecord, \"IdTokenRecord\");\n-        validateCacheArtifacts(accountRecord, accessTokenRecord, refreshTokenRecord, idTokenRecord);\n-\n-        removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n+        if (accountRecord != null && refreshTokenRecord != null) {\n+            removeRefreshTokenIfNeeded(accountRecord, refreshTokenRecord);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0MTIxMQ=="}, "originalCommit": {"oid": "8119aa16a639cc7c88b2592ab132b2c23348cf50"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2383, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}