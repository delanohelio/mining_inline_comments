{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MDYyMjEx", "number": 891, "title": "Changes to exchange broker request/results as gzip compressed byte array to reduce pay load size", "bodyText": "Related to this issue Teams is facing : #883\n\nCompressing broker request and response payloads using gzip to minimize the buffer size of the Android Binder\nMade changes to hello for back compat between features w.r.t to interaction between old/new broker vs old/new MSAL.  As a part of this , we are sending the negotiatedBrokerProtocol which we receive after hello handshake when making a broker request.", "createdAt": "2020-04-16T01:06:34Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891", "merged": true, "mergeCommit": {"oid": "ec41d5cb2c8eefda8d32713725d4660124a61049"}, "closed": true, "closedAt": "2020-04-22T23:34:59Z", "author": {"login": "kreedula"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXshLQAH2gAyNDA0MDYyMjExOjllN2IyMTIzZWI3NWI1ZmQ1YzNkYjhlYzFmM2U5YzdmNTlkMjI5NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaQbo5gFqTM5ODY0NzA2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e7b2123eb75b5fd5c3db8ec1f3e9c7f59d22954", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9e7b2123eb75b5fd5c3db8ec1f3e9c7f59d22954", "committedDate": "2020-04-14T23:58:24Z", "message": "Sending broker request as compressed byte array to reduce pay load size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "441d0fb422b597f2000179a31c2abe2f5c68c169", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/441d0fb422b597f2000179a31c2abe2f5c68c169", "committedDate": "2020-04-15T01:04:38Z", "message": "More chnages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66dbf76fba178293454328cafe84d7102f4d4bb1", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/66dbf76fba178293454328cafe84d7102f4d4bb1", "committedDate": "2020-04-15T05:52:45Z", "message": "Common Version update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af98fdcf95968ed05ccb8e2092497a5317bbaebe", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/af98fdcf95968ed05ccb8e2092497a5317bbaebe", "committedDate": "2020-04-15T22:34:52Z", "message": "Broker Account changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "558281c98cb7d94ea6a4831d1f4a6ca5cbc7ec09", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/558281c98cb7d94ea6a4831d1f4a6ca5cbc7ec09", "committedDate": "2020-04-15T22:35:16Z", "message": "Version update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d85fcb27dddca4464d9493660e492a8672c1fa", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/35d85fcb27dddca4464d9493660e492a8672c1fa", "committedDate": "2020-04-16T00:45:45Z", "message": "Reverting RC version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7c26a4215ca60a41c1301192aa93d60e8ea06788", "committedDate": "2020-04-16T01:05:35Z", "message": "Minor updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzMyMTA0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-394332104", "createdAt": "2020-04-16T06:29:34Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjoyOTozNFrOGGWZwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjoyOTozNFrOGGWZwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMTY4MQ==", "bodyText": "nit: run the stylize tool. here and everywhere.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409311681", "createdAt": "2020-04-16T06:29:34Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);\n+            } catch (IOException e) {\n+                Logger.error(TAG, \" Failed to compress account list to bytes, sending as jsonString\", e);\n+                resultBundle.putString(BROKER_ACCOUNTS, jsonString);\n+            }\n+\n         }\n \n         return resultBundle;\n     }\n \n     public List<ICacheRecord> getAccountsFromResultBundle(@NonNull final Bundle bundle) throws BaseException {\n-        final String accountJson = bundle.getString(BROKER_ACCOUNTS);\n+\n+        String accountJson;\n+        if(bundle.containsKey(BROKER_ACCOUNTS_COMPRESSED)){\n+            try {\n+                accountJson = GzipUtil.decompressBytesToString(\n+                        bundle.getByteArray(BROKER_ACCOUNTS_COMPRESSED)\n+                );\n+            } catch (IOException e) {\n+                Logger.error(TAG, \" Failed to decompress account list to bytes\", e);\n+                throw  new BaseException(ErrorStrings.UNKNOWN_ERROR, \" Failed to decompress account list to bytes\");\n+            }\n+        }else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzMzMjE2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-394333216", "createdAt": "2020-04-16T06:31:59Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjozMTo1OVrOGGWdcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjozMTo1OVrOGGWdcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjYyNQ==", "bodyText": "How would this work with older MSAL? Do we need a version check to determine if we should compress?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409312625", "createdAt": "2020-04-16T06:31:59Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzMzNDQw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-394333440", "createdAt": "2020-04-16T06:32:27Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ0MTM0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-395144134", "createdAt": "2020-04-17T03:52:36Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjozNlrOGG_Cpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjozNlrOGG_Cpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzUxMA==", "bodyText": "compressed bytes size?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409977510", "createdAt": "2020-04-17T03:52:36Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -196,6 +189,54 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n \n     }\n \n+    public Bundle bundleFromBrokerResult(final BrokerResult brokerResult){\n+        final Bundle resultBundle = new Bundle();\n+        final String brokerResultString = sRequestAdapterGsonInstance.toJson(\n+                brokerResult,\n+                BrokerResult.class\n+        );\n+        try {\n+            byte[] compressedBytes = compressString(brokerResultString);\n+            Logger.info(TAG, \"Broker Result, raw payload size:\"\n+                    + brokerResultString.getBytes().length + \" ,compressed bytes \" + compressedBytes.length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ0NzQ0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-395144744", "createdAt": "2020-04-17T03:54:43Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1NDo0M1rOGG_E3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1NDo0M1rOGG_E3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODA3OA==", "bodyText": "Let's do two logs here: one for error to indicate that compression failed, and then a second as warn to re-iterate that and indicate that we are going to be sending jsonString", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409978078", "createdAt": "2020-04-17T03:54:43Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -196,6 +189,54 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n \n     }\n \n+    public Bundle bundleFromBrokerResult(final BrokerResult brokerResult){\n+        final Bundle resultBundle = new Bundle();\n+        final String brokerResultString = sRequestAdapterGsonInstance.toJson(\n+                brokerResult,\n+                BrokerResult.class\n+        );\n+        try {\n+            byte[] compressedBytes = compressString(brokerResultString);\n+            Logger.info(TAG, \"Broker Result, raw payload size:\"\n+                    + brokerResultString.getBytes().length + \" ,compressed bytes \" + compressedBytes.length\n+            );\n+            resultBundle.putByteArray(\n+                    AuthenticationConstants.Broker.BROKER_RESULT_V2_COMPRESSED,\n+                    compressedBytes\n+            );\n+        }catch (IOException e){\n+            Logger.error(TAG, \"Failed to compress Broker Result, sending as jsonString \", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ1NjUz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-395145653", "createdAt": "2020-04-17T03:58:13Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODoxM1rOGG_IFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODoxM1rOGG_IFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODkwMA==", "bodyText": "Can inputString be null? If yes, then we should do a null-check, otherwise add non-null annotation.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409978900", "createdAt": "2020-04-17T03:58:13Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ1ODEx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-395145811", "createdAt": "2020-04-17T03:58:47Z", "commit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODo0N1rOGG_IuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODo0N1rOGG_IuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3OTA2NQ==", "bodyText": "Can someone pass null array here?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409979065", "createdAt": "2020-04-17T03:58:47Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {\n+        byte[] bytes = inputString.getBytes(\"UTF-8\");\n+        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+        GZIPOutputStream gzipOutputStream = new GZIPOutputStream(byteArrayOutputStream);\n+        gzipOutputStream.write(bytes, 0, bytes.length);\n+        gzipOutputStream.flush();\n+        gzipOutputStream.close();\n+        byte[] result = byteArrayOutputStream.toByteArray();\n+        byteArrayOutputStream.close();\n+        return result;\n+    }\n+\n+    /**\n+     * Util method which converts the gzip compressed bytes to  String.\n+     */\n+    public static String decompressBytesToString(final byte[] compressedBytes) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db228c93b333637d7019e4669c6c3f1e801a2c98", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/db228c93b333637d7019e4669c6c3f1e801a2c98", "committedDate": "2020-04-20T23:39:58Z", "message": "Merge branch 'dev' into kreedula/compress-request-data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b19efd1418ec12e5e9adad0d81ee712f016700f", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6b19efd1418ec12e5e9adad0d81ee712f016700f", "committedDate": "2020-04-22T01:57:16Z", "message": "Changes to add negotiated protocol version to all calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9696933cfead8f755fa3aecc9b6454a6ddf821bd", "committedDate": "2020-04-22T02:01:57Z", "message": "Addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Nzk5ODM5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-397799839", "createdAt": "2020-04-22T02:28:36Z", "commit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyODozNlrOGJgfaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyODozNlrOGJgfaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjY5OQ==", "bodyText": "needs formatting", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412622699", "createdAt": "2020-04-22T02:28:36Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -178,10 +183,15 @@ public BrokerInteractiveTokenCommandParameters brokerInteractiveParametersFromAc\n \n         final Intent intent = callingActivity.getIntent();\n \n-        final BrokerRequest brokerRequest = sRequestAdapterGsonInstance.fromJson(\n-                intent.getStringExtra(AuthenticationConstants.Broker.BROKER_REQUEST_V2),\n-                BrokerRequest.class\n-        );\n+        final BrokerRequest brokerRequest = brokerRequestFromBundle(intent.getExtras());\n+\n+        if (brokerRequest == null) {\n+            Logger.error(TAG, \"Broker Result is null, returning empty parameters, \" +\n+                            \"validation is expected to fail\",\n+                    null)\n+            ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODAwMDE1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-397800015", "createdAt": "2020-04-22T02:29:11Z", "commit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyOToxMVrOGJggQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyOToxMVrOGJggQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjkxNA==", "bodyText": "needs formatting", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412622914", "createdAt": "2020-04-22T02:29:11Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -262,10 +274,16 @@ public BrokerSilentTokenCommandParameters brokerSilentParametersFromBundle(\n \n         Logger.info(TAG, \"Constructing BrokerAcquireTokenSilentOperationParameters from result bundle\");\n \n-        final BrokerRequest brokerRequest = sRequestAdapterGsonInstance.fromJson(\n-                bundle.getString(AuthenticationConstants.Broker.BROKER_REQUEST_V2),\n-                BrokerRequest.class\n-        );\n+        final BrokerRequest brokerRequest = brokerRequestFromBundle(bundle);\n+\n+        if (brokerRequest == null) {\n+            Logger.error(TAG, \"Broker Result is null, returning empty parameters, \" +\n+                            \"validation is expected to fail\",\n+                    null)\n+            ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODAyMTcx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-397802171", "createdAt": "2020-04-22T02:36:04Z", "commit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjozNjowNFrOGJgpGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjozNjowNFrOGJgpGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyNTE3Nw==", "bodyText": "I see almost same code below in getRequestBundleForAcquireTokenSilent. I think we can move this logic to its own method.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412625177", "createdAt": "2020-04-22T02:36:04Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -362,17 +412,78 @@ public Bundle getRequestBundleForHello(@NonNull final CommandParameters paramete\n         return requestBundle;\n     }\n \n-    public Bundle getRequestBundleForAcquireTokenSilent(final SilentTokenCommandParameters parameters) {\n+    public Bundle getRequestBundleForAcquireTokenInteractive(@NonNull final InteractiveTokenCommandParameters parameters,\n+                                                             @Nullable final String negotiatedBrokerProtocolVersion) {\n+        final BrokerRequest brokerRequest = brokerRequestFromAcquireTokenParameters(parameters);\n+        final Bundle requestBundle = new Bundle();\n+\n+        if (BrokerProtocolVersionUtil.canCompressBrokerPayloads(negotiatedBrokerProtocolVersion)) {\n+            try {\n+                final String jsonRequestString = sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class);\n+                byte[] compressedBytes = compressString(jsonRequestString);\n+                Logger.info(TAG, \"Broker Request, raw payload size:\"\n+                        + jsonRequestString.getBytes().length + \" ,compressed bytes size: \" + compressedBytes.length\n+                );\n+                requestBundle.putByteArray(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2_COMPRESSED,\n+                        compressedBytes\n+                );\n+\n+            } catch (IOException e) {\n+                Logger.error(TAG, \"Compression to bytes failed, sending broker request as String\", e);\n+                requestBundle.putString(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                        sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+                );\n+            }\n+        } else {\n+            Logger.info(TAG, \"Broker protocol version: \" + negotiatedBrokerProtocolVersion +\n+                    \" lower than compression changes, sending as string\"\n+            );\n+            requestBundle.putString(\n+                    AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                    sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+            );\n+        }\n+        return requestBundle;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 174}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODA2MTYy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-397806162", "createdAt": "2020-04-22T02:49:39Z", "commit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ba307d2e21dec24a677bdc2a04db7ef91608d5", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c8ba307d2e21dec24a677bdc2a04db7ef91608d5", "committedDate": "2020-04-22T02:53:35Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fe36d414f1a2d6b61a157ae754d0ba1503123af", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9fe36d414f1a2d6b61a157ae754d0ba1503123af", "committedDate": "2020-04-22T02:54:59Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b2458980a052a3486ce764830aed3400f77989f8", "committedDate": "2020-04-22T22:39:33Z", "message": "Merge branch 'dev' into kreedula/compress-request-data"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjQ1MDU5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-398645059", "createdAt": "2020-04-22T22:52:04Z", "commit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjQ3MDY0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#pullrequestreview-398647064", "createdAt": "2020-04-22T22:56:47Z", "commit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjo1Njo0N1rOGKPNww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjo1Njo0N1rOGKPNww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM4ODIyNw==", "bodyText": "nit: nullOrEmpty?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r413388227", "createdAt": "2020-04-22T22:56:47Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/BrokerProtocolVersionUtil.java", "diffHunk": "@@ -0,0 +1,47 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import android.text.TextUtils;\n+\n+import androidx.annotation.Nullable;\n+\n+/**\n+ * Class to provide util methods to compare different features with respect to Broker Protocol version.\n+ */\n+public class BrokerProtocolVersionUtil {\n+\n+    public static final String BROKER_PROTOCOL_COMPRESSION_CHANGES_MINIMUM_VERSION = \"5.0\";\n+\n+    public static boolean canCompressBrokerPayloads(@Nullable String negotiatedBrokerProtocol) {\n+        if (TextUtils.isEmpty(negotiatedBrokerProtocol)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1631, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}