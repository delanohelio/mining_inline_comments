{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NTQ1ODc1", "number": 1140, "title": "Hardcode Teams Agent clientID/scope for FoCi call", "bodyText": "This is a short term fix - to make sure that Teams agent is not getting a \"preauthorization error\"\nMore details, long term fix, repro steps are here.", "createdAt": "2020-11-27T11:02:21Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140", "merged": true, "mergeCommit": {"oid": "efa2e97be8d4dfca49043cd7853beaff67fa3c19"}, "closed": true, "closedAt": "2020-12-01T12:44:55Z", "author": {"login": "rpdome"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdglUjegH2gAyNTI4NTQ1ODc1OjFmMDFkODdhMzViYjRjZTkzMzFmZTA4MjdmZDQ2ZTgzZDNlYjk2NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh5JRRgH2gAyNTI4NTQ1ODc1OjZiNmY2ZGVmNDFkYzY4MmMzY2U3M2I2NmVjMDNmOTFkZDA0NTA2MGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "committedDate": "2020-11-27T10:51:45Z", "message": "Hardcode Teams Agent clientID/scope for Foci call"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38fbbb402949e62f67dd1c5f37dc8fa60589ef6c", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/38fbbb402949e62f67dd1c5f37dc8fa60589ef6c", "committedDate": "2020-11-30T14:48:54Z", "message": "bump"}, "afterCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1f01d87a35bb4ce9331fe0827fd46e83d3eb965d", "committedDate": "2020-11-27T10:51:45Z", "message": "Hardcode Teams Agent clientID/scope for Foci call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTgzMDA1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#pullrequestreview-541183005", "createdAt": "2020-11-30T18:31:54Z", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMTo1NFrOH8IP1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMTo1NFrOH8IP1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMTczMg==", "bodyText": "2-way linking to an ADO issue?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532811732", "createdAt": "2020-11-30T18:31:54Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTgzNzQw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#pullrequestreview-541183740", "createdAt": "2020-11-30T18:32:53Z", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMjo1M1rOH8ISCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMjo1M1rOH8ISCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjI5OQ==", "bodyText": "Can we add a constant for this?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812299", "createdAt": "2020-11-30T18:32:53Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTgzODM3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#pullrequestreview-541183837", "createdAt": "2020-11-30T18:33:00Z", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMzowMFrOH8ISTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMzowMFrOH8ISTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjM2Ng==", "bodyText": "And for this?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812366", "createdAt": "2020-11-30T18:33:00Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n+            scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTg4MDIy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#pullrequestreview-541188022", "createdAt": "2020-11-30T18:38:43Z", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozODo0M1rOH8IfBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozODo0M1rOH8IfBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNTYyMw==", "bodyText": "Do we want a log statement here?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532815623", "createdAt": "2020-11-30T18:38:43Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTg4MjAz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#pullrequestreview-541188203", "createdAt": "2020-11-30T18:38:57Z", "commit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6f6def41dc682c3ce73b66ec03f91dd045060a", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6b6f6def41dc682c3ce73b66ec03f91dd045060a", "committedDate": "2020-12-01T12:31:27Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1448, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}