{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MzY4NzI3", "number": 785, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToxMDo1NVrODY-Tvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMTo1MDo1OFrODY-eHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTEzMjc4OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToxMDo1NVrOFfIxJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDoyMzoyMVrOFgp0HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5MzgzMA==", "bodyText": "ErrorStrings.NO_TOKENS_FOUND is another case for UiRequiredException", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r368193830", "createdAt": "2020-01-18T01:10:55Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        // Default to ClientException if null\n+        if(baseException == null){\n+            Logger.warn(TAG, \" Exception type is unknown : \" + exceptionType\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        baseException.setCliTelemErrorCode(brokerResult.getCliTelemErrorCode());\n+        baseException.setCliTelemSubErrorCode(brokerResult.getCliTelemSubErrorCode());\n+        baseException.setCorrelationId(brokerResult.getCorrelationId());\n+        baseException.setSpeRing(brokerResult.getSpeRing());\n+        baseException.setRefreshTokenAge(brokerResult.getRefreshTokenAge());\n+\n+        return baseException;\n+    }\n+\n+\n+    /**\n+     * Method to get the right base exception based on error codes.\n+     * Note : In newer versions of Broker, exception type will be sent and is used to determine the right exception.\n+     *\n+     * This method is to support legacy broker versions (3.1.8 or below)\n+     * @return BaseException\n+     */\n+    private BaseException getBaseExceptionFromErrorCodes(@NonNull final BrokerResult brokerResult){\n         final String errorCode = brokerResult.getErrorCode();\n+        final BaseException baseException;\n \n         if (AuthenticationConstants.OAuth2ErrorCode.INTERACTION_REQUIRED.equalsIgnoreCase(errorCode) ||\n-                AuthenticationConstants.OAuth2ErrorCode.INVALID_GRANT.equalsIgnoreCase(errorCode)) {\n+                AuthenticationConstants.OAuth2ErrorCode.INVALID_GRANT.equalsIgnoreCase(errorCode) ||\n+                ErrorStrings.INVALID_BROKER_REFRESH_TOKEN.equalsIgnoreCase(errorCode)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4MzgzNw==", "bodyText": "Thanks for pointing out.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369783837", "createdAt": "2020-01-22T20:23:21Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        // Default to ClientException if null\n+        if(baseException == null){\n+            Logger.warn(TAG, \" Exception type is unknown : \" + exceptionType\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        baseException.setCliTelemErrorCode(brokerResult.getCliTelemErrorCode());\n+        baseException.setCliTelemSubErrorCode(brokerResult.getCliTelemSubErrorCode());\n+        baseException.setCorrelationId(brokerResult.getCorrelationId());\n+        baseException.setSpeRing(brokerResult.getSpeRing());\n+        baseException.setRefreshTokenAge(brokerResult.getRefreshTokenAge());\n+\n+        return baseException;\n+    }\n+\n+\n+    /**\n+     * Method to get the right base exception based on error codes.\n+     * Note : In newer versions of Broker, exception type will be sent and is used to determine the right exception.\n+     *\n+     * This method is to support legacy broker versions (3.1.8 or below)\n+     * @return BaseException\n+     */\n+    private BaseException getBaseExceptionFromErrorCodes(@NonNull final BrokerResult brokerResult){\n         final String errorCode = brokerResult.getErrorCode();\n+        final BaseException baseException;\n \n         if (AuthenticationConstants.OAuth2ErrorCode.INTERACTION_REQUIRED.equalsIgnoreCase(errorCode) ||\n-                AuthenticationConstants.OAuth2ErrorCode.INVALID_GRANT.equalsIgnoreCase(errorCode)) {\n+                AuthenticationConstants.OAuth2ErrorCode.INVALID_GRANT.equalsIgnoreCase(errorCode) ||\n+                ErrorStrings.INVALID_BROKER_REFRESH_TOKEN.equalsIgnoreCase(errorCode)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5MzgzMA=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTEzMzkzOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToxMjowMlrOFfIx0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDoyMzowMlrOFgpzmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NDAwMQ==", "bodyText": "might be better to use else if here and below", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r368194001", "createdAt": "2020-01-18T01:12:02Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4MzcwNA==", "bodyText": "Done", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369783704", "createdAt": "2020-01-22T20:23:02Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NDAwMQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTE0Mzk4OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToyMzoyOFrOFfI3bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToyMzoyOFrOFfI3bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTQzOQ==", "bodyText": "May be we can move log statement outside the if blocks, and call it only once as follows:\nLogger.warn(TAG, \"Received a \" + exceptionType +  \" from Broker : \" + brokerResult.getErrorCode() );", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r368195439", "createdAt": "2020-01-18T01:23:28Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTE0NTczOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMToyNTo1OVrOFfI4fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMDoyNzo1MlrOFhLn2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTcxMQ==", "bodyText": "How do we know that it is ACQUIRE_TOKEN_OPERATION_NAME?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r368195711", "createdAt": "2020-01-18T01:25:59Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4NDM5MA==", "bodyText": "Good point, I introduced a new operation to indicate that it'a broker request", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369784390", "createdAt": "2020-01-22T20:24:34Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTcxMQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg5NjExNg==", "bodyText": "What about silent?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369896116", "createdAt": "2020-01-23T01:41:41Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTcxMQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg5NjI3MA==", "bodyText": "ACQUIRE_TOKEN_SILENT_OPERATION_NAME ?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369896270", "createdAt": "2020-01-23T01:42:20Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTcxMQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMzNzc1NA==", "bodyText": "I have introduced a new operation name BROKER_TOKEN_REQUEST_OPERATION_NAME which is passed here, since the basic MSAL argument validation is successful and is sent to broker, here if an argument exception is thrown it would be of broker. For now I added a generic operation name here, if need specific things in the future it can be added as needed", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r370337754", "createdAt": "2020-01-23T20:27:52Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -182,12 +183,112 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n             return new BaseException(ErrorStrings.UNKNOWN_ERROR, \"Broker Result not returned from Broker\");\n         }\n \n-        BaseException baseException;\n+        final String exceptionType = brokerResult.getExceptionType();\n \n+        if(!TextUtils.isEmpty(exceptionType)){\n+            return getBaseExceptionFromExceptionType(exceptionType, brokerResult);\n+        }else {\n+            // This code is here for legacy purposes where old versions of broker (3.1.8 or below)\n+            // wouldn't return exception type in the result.\n+            Logger.info(TAG, \"Exception type is not returned from the broker, \" +\n+                    \"using error codes to transform to the right exception\");\n+            return getBaseExceptionFromErrorCodes(brokerResult);\n+        }\n+\n+    }\n+\n+    private BaseException getBaseExceptionFromExceptionType(@NonNull final String exceptionType,\n+                                                            @NonNull final BrokerResult brokerResult){\n+        BaseException baseException = null;\n+\n+        if(exceptionType.equalsIgnoreCase(UiRequiredException.sName)){\n+            Logger.warn(TAG, \"Received a UIRequired exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UiRequiredException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ServiceException.sName)){\n+            Logger.warn(TAG, \"Received a Service exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getServiceException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(IntuneAppProtectionPolicyRequiredException.sName)){\n+            Logger.warn(TAG,\n+                    \"Received a IntuneAppProtectionPolicyRequiredException exception from Broker: \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = getIntuneProtectionRequiredException(brokerResult);\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(UserCancelException.sName)){\n+            Logger.warn(TAG, \"Received a User cancelled exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new UserCancelException();\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ClientException.sName)){\n+            Logger.warn(TAG, \"Received a ClientException exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ClientException(\n+                    brokerResult.getErrorCode(),\n+                    brokerResult.getErrorMessage()\n+            );\n+        }\n+\n+        if(exceptionType.equalsIgnoreCase(ArgumentException.sName)){\n+            Logger.warn(TAG, \"Received a Argument exception from Broker : \"\n+                    + brokerResult.getErrorCode()\n+            );\n+            baseException = new ArgumentException(\n+                    ArgumentException.ACQUIRE_TOKEN_OPERATION_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTcxMQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTE1OTMyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/exception/ArgumentException.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwMTo1MDo1OFrOFfJATQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMDoyNTo1OFrOFgp4ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NzcwOQ==", "bodyText": "return ArgumentException.class.getName();?\nHere and everywhere.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r368197709", "createdAt": "2020-01-18T01:50:58Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/exception/ArgumentException.java", "diffHunk": "@@ -60,4 +62,9 @@ public String getArgumentName() {\n         return mArgumentName;\n     }\n \n+    @Override\n+    public String getExceptionName(){\n+        return sName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4NDk3MA==", "bodyText": "I'm using sName to compare , so that in future if the value of sName is changed , the logic would work as expected", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/785#discussion_r369784970", "createdAt": "2020-01-22T20:25:58Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/exception/ArgumentException.java", "diffHunk": "@@ -60,4 +62,9 @@ public String getArgumentName() {\n         return mArgumentName;\n     }\n \n+    @Override\n+    public String getExceptionName(){\n+        return sName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NzcwOQ=="}, "originalCommit": {"oid": "c4026f0dc374329278b75d73473a03bdab86c496"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2438, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}