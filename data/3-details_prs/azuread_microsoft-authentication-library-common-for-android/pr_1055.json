{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMzUwODA3", "number": 1055, "title": "Fix a potential issue with command dispatcher.", "bodyText": "", "createdAt": "2020-09-25T20:19:46Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055", "merged": true, "mergeCommit": {"oid": "76e23f14f52ed377457f415e762055589c0495a1"}, "closed": true, "closedAt": "2020-09-26T06:07:37Z", "author": {"login": "AdamBJohnsonx"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMcxybgFqTQ5Njg3Nzc4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMi7JPAH2gAyNDkzMzUwODA3OmQzM2FmNzFkYThmZjBiZDUxNWZjMWVlYTdiZjk2ZDY4OTYyOTQ5MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODc3Nzg5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#pullrequestreview-496877789", "createdAt": "2020-09-25T21:36:02Z", "commit": {"oid": "213855be64fce88ab7f09d920a34dbeb8cd93967"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMTozNjowM1rOHYTqSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMTozNjowM1rOHYTqSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI0OTk5Mw==", "bodyText": "May I ask what you meant by 'mutated' here? In what (hypothetical) scenario this might happen?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#discussion_r495249993", "createdAt": "2020-09-25T21:36:03Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -110,48 +115,68 @@ public static void submitSilent(@SuppressWarnings(WarningType.rawtype_warning) @\n             return;\n         }\n \n+        final ResultFuture<CommandResult> finalFuture = future;\n+\n         sSilentExecutor.execute(new Runnable() {\n             @Override\n             public void run() {\n-                final String correlationId = initializeDiagnosticContext(command.getParameters().getCorrelationId());\n-\n-                // set correlation id on parameters as it may not already be set\n-                command.getParameters().setCorrelationId(correlationId);\n-\n-                EstsTelemetry.getInstance().initTelemetryForCommand(command);\n+                try {\n+                    final String correlationId = initializeDiagnosticContext(command.getParameters().getCorrelationId());\n \n-                EstsTelemetry.getInstance().emitApiId(command.getPublicApiId());\n+                    // set correlation id on parameters as it may not already be set\n+                    command.getParameters().setCorrelationId(correlationId);\n \n-                CommandResult commandResult = null;\n+                    EstsTelemetry.getInstance().initTelemetryForCommand(command);\n \n-                //Log operation parameters\n-                if (command.getParameters() instanceof SilentTokenCommandParameters) {\n-                    logSilentRequestParams(methodName, (SilentTokenCommandParameters) command.getParameters());\n-                    EstsTelemetry.getInstance().emitForceRefresh(((SilentTokenCommandParameters) command.getParameters()).isForceRefresh());\n-                }\n+                    EstsTelemetry.getInstance().emitApiId(command.getPublicApiId());\n \n-                //Check cache to see if the same command completed in the last 30 seconds\n-                commandResult = sCommandResultCache.get(command);\n+                    CommandResult commandResult = null;\n \n-                //If nothing in cache, execute the command and cache the result\n-                if (commandResult == null) {\n-                    commandResult = executeCommand(command);\n-                    cacheCommandResult(command, commandResult);\n-                } else {\n-                    Logger.info(\n-                            TAG + methodName,\n-                            \"Silent command result returned from cache.\"\n-                    );\n-                }\n+                    //Log operation parameters\n+                    if (command.getParameters() instanceof SilentTokenCommandParameters) {\n+                        logSilentRequestParams(methodName, (SilentTokenCommandParameters) command.getParameters());\n+                        EstsTelemetry.getInstance().emitForceRefresh(((SilentTokenCommandParameters) command.getParameters()).isForceRefresh());\n+                    }\n \n-                // set correlation id on Local Authentication Result\n-                setCorrelationIdOnResult(commandResult, correlationId);\n+                    //Check cache to see if the same command completed in the last 30 seconds\n+                    commandResult = sCommandResultCache.get(command);\n+\n+                    //If nothing in cache, execute the command and cache the result\n+                    if (commandResult == null) {\n+                        commandResult = executeCommand(command);\n+                        cacheCommandResult(command, commandResult);\n+                    } else {\n+                        Logger.info(\n+                                TAG + methodName,\n+                                \"Silent command result returned from cache.\"\n+                        );\n+                    }\n \n-                Telemetry.getInstance().flush(correlationId);\n-                EstsTelemetry.getInstance().flush(command, commandResult);\n+                    // set correlation id on Local Authentication Result\n+                    setCorrelationIdOnResult(commandResult, correlationId);\n \n-                //Return the result via the callback\n-                sExecutingCommandMap.remove(command).setResult(commandResult);\n+                    Telemetry.getInstance().flush(correlationId);\n+                    EstsTelemetry.getInstance().flush(command, commandResult);\n+                    finalFuture.setResult(commandResult);\n+                    //Return the result via the callback\n+                } catch (Throwable t) {\n+                    finalFuture.setException(new ExecutionException(t));\n+                } finally {\n+                    final ResultFuture mapFuture = sExecutingCommandMap.remove(command);\n+                    if (mapFuture == null) {\n+                        // If this has happened, the command that we started with has mutated.  We will", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "213855be64fce88ab7f09d920a34dbeb8cd93967"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODgzMzkx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#pullrequestreview-496883391", "createdAt": "2020-09-25T21:50:01Z", "commit": {"oid": "213855be64fce88ab7f09d920a34dbeb8cd93967"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "365670a1a7d3289841bfb143ca1da3a9f931a7c5", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/365670a1a7d3289841bfb143ca1da3a9f931a7c5", "committedDate": "2020-09-26T00:33:43Z", "message": "Fix the code for unstable keys."}, "afterCommit": {"oid": "892db3e5b54642945af6c1456c3e81a1a84c5373", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/892db3e5b54642945af6c1456c3e81a1a84c5373", "committedDate": "2020-09-26T00:40:26Z", "message": "Fix the code for unstable keys."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTI0OTk1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#pullrequestreview-496924995", "createdAt": "2020-09-26T00:52:03Z", "commit": {"oid": "1954af37c469f25f6d410101126778770624d06e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMDo1MjowM1rOHYZ2RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMDo1MjowM1rOHYZ2RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTM1MTM2NA==", "bodyText": "Can we javadoc why this function is required? Otherwise not apparent to those who didn't debug this \ud83d\ude04", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#discussion_r495351364", "createdAt": "2020-09-26T00:52:03Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -74,12 +78,31 @@\n     private static final Object sLock = new Object();\n     private static InteractiveTokenCommand sCommand = null;\n     private static final CommandResultCache sCommandResultCache = new CommandResultCache();\n+\n+    private static final Object mapAccessLock = new Object();\n+    @GuardedBy(\"mapAccessLock\")\n     // Suppressing rawtype warnings due to the generic type BaseCommand\n     @SuppressWarnings(WarningType.rawtype_warning)\n-    private static final ConcurrentMap<BaseCommand, ResultFuture<CommandResult>> sExecutingCommandMap = new ConcurrentHashMap<>();\n+    private static ConcurrentMap<BaseCommand, ResultFuture<CommandResult>> sExecutingCommandMap = new ConcurrentHashMap<>();\n+\n+    /**\n+     * MUST be executed under the mapAccessLock;\n+     * @param command\n+     */\n+    // Suppressing rawtype warnings due to the generic type BaseCommand\n+    @SuppressWarnings(WarningType.rawtype_warning)\n+    private static void cleanMap(BaseCommand command) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1954af37c469f25f6d410101126778770624d06e"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTI2MTI2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#pullrequestreview-496926126", "createdAt": "2020-09-26T01:02:12Z", "commit": {"oid": "773d0454ab950504b5a7998608eeb03f0bbc03e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1094edc51bb3b2ae702343102a2e1b06489c0e5", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/e1094edc51bb3b2ae702343102a2e1b06489c0e5", "committedDate": "2020-09-26T04:42:43Z", "message": "Become less dependent on the execution map\n\nIt is possible that the command objects are being mutated\nunderneath our execution.  If that is happening, it will\ncause three issues:\n * Null pointer exceptions when map.remove is run.\n * Command futures will never complete.\n * The execution map will fill unboundedly.\n\nIn order to fix this, insure that the resultFuture is\ncompleted in every case.  In addition, save the identity\nof the command that initiated the call, and if removal fails,\nindicating that the command has been mutated and its hash has\naltered, scan the map for a command with the same identity\nand remove it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b5f39714f0983b8b0a9af9cb3fd50d457b4610", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/07b5f39714f0983b8b0a9af9cb3fd50d457b4610", "committedDate": "2020-09-26T04:42:43Z", "message": "Stubbing out instrumented test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e145a11a718f970361eda3078ad67944a5668836", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/e145a11a718f970361eda3078ad67944a5668836", "committedDate": "2020-09-26T04:42:43Z", "message": "Parameterize the test command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c24f36760b5677059fe19752d93da8b5cc7b8fd3", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c24f36760b5677059fe19752d93da8b5cc7b8fd3", "committedDate": "2020-09-26T04:42:43Z", "message": "Adding test stubs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "674fee7de768331efe2abc292a71046db07182b9", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/674fee7de768331efe2abc292a71046db07182b9", "committedDate": "2020-09-26T04:42:43Z", "message": "One fix that I recall, some test descriptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5369e713c63007c8fc2a16090f9b7df9bb8f9b39", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5369e713c63007c8fc2a16090f9b7df9bb8f9b39", "committedDate": "2020-09-26T04:42:43Z", "message": "Add a value to testcommand."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b52ede41dc338c885a48d1fad8f7726d98a44a24", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b52ede41dc338c885a48d1fad8f7726d98a44a24", "committedDate": "2020-09-26T04:42:43Z", "message": "Latched command for stalling execution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a926f566c93799ef6e5ecad02e97f65c6e84c557", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a926f566c93799ef6e5ecad02e97f65c6e84c557", "committedDate": "2020-09-26T04:42:43Z", "message": "Minor formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d26372702bc7037c3c5781a39a50b525e4e5edf3", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d26372702bc7037c3c5781a39a50b525e4e5edf3", "committedDate": "2020-09-26T04:42:43Z", "message": "Fix the code for unstable keys."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "225d4994468eef4c4f4a309b9fdfa497af60c9bd", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/225d4994468eef4c4f4a309b9fdfa497af60c9bd", "committedDate": "2020-09-26T04:42:44Z", "message": "Change to foreach loop style."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f3658aea49a7e3994060d38af59cd641d082ca", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/29f3658aea49a7e3994060d38af59cd641d082ca", "committedDate": "2020-09-26T04:42:44Z", "message": "Add a better comment explaining cleanMap.."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf01f4eba7e03be0a42049ffed3e1c948ffac0c", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9cf01f4eba7e03be0a42049ffed3e1c948ffac0c", "committedDate": "2020-09-26T04:42:44Z", "message": "Add TODO with link to work item."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a820328848bf2b7a413ad9d772949f82208485d", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6a820328848bf2b7a413ad9d772949f82208485d", "committedDate": "2020-09-26T04:42:44Z", "message": "Access the map size for the test method under the map lock."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb7a701310603e9ce7c882906be9c32ef5ea2ec", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/feb7a701310603e9ce7c882906be9c32ef5ea2ec", "committedDate": "2020-09-26T04:42:44Z", "message": "Add a new type of future to indicate whether a task has been compltely retired."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43bc2da12bd63112b46f4909f2b049ffa2346257", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/43bc2da12bd63112b46f4909f2b049ffa2346257", "committedDate": "2020-09-26T04:42:44Z", "message": "Add the FinalizableResultFuture class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ca14fbc3acec8cae53966268a6aff7e4a9fe51c", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/0ca14fbc3acec8cae53966268a6aff7e4a9fe51c", "committedDate": "2020-09-26T04:42:44Z", "message": "Fix deadlock due to careless synchronization."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cc242705e3292ac5fc5c44759959aaf0efdef45", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/3cc242705e3292ac5fc5c44759959aaf0efdef45", "committedDate": "2020-09-26T03:47:07Z", "message": "Fix deadlock due to careless synchronization."}, "afterCommit": {"oid": "0ca14fbc3acec8cae53966268a6aff7e4a9fe51c", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/0ca14fbc3acec8cae53966268a6aff7e4a9fe51c", "committedDate": "2020-09-26T04:42:44Z", "message": "Fix deadlock due to careless synchronization."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTQwMjAx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#pullrequestreview-496940201", "createdAt": "2020-09-26T04:45:24Z", "commit": {"oid": "0ca14fbc3acec8cae53966268a6aff7e4a9fe51c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDo0NToyNFrOHYdtMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNDo0NToyNFrOHYdtMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQxNDU3OQ==", "bodyText": "Suggested change", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1055#discussion_r495414579", "createdAt": "2020-09-26T04:45:24Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -129,4 +129,5 @@ public synchronized void whenComplete(@NonNull final BiConsumer<T, Throwable> co\n \n         mConsumers.add(consumerToAdd);\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ca14fbc3acec8cae53966268a6aff7e4a9fe51c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d33af71da8ff0bd515fc1eea7bf96d6896294901", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d33af71da8ff0bd515fc1eea7bf96d6896294901", "committedDate": "2020-09-26T04:45:42Z", "message": "Update common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java\r\n\r\nDelete blank line."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1596, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}