{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwOTg5OTky", "number": 1098, "title": "Clean up tokens after writing the new one, to avoid having cache momentarily empty of RTs", "bodyText": "Because shared preferences is not atomic like a database, there is a moment between cleaning up old RTs and writing new ones where the cache may contain no RTs for a given account. If, for whatever reason, the app were to crash or otherwise stop execution in this state, getAccounts() would return \"no accounts\" for subsequent calls, as the RT is required to acquire tokens for a user.\nThis change reorders the writing and deletion of credentials such that new credentials are written before the old ones are cleaned up. In the event that multiple RTs exist on disk, they will be removed from the cache upon next call to save()", "createdAt": "2020-10-27T19:08:37Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098", "merged": true, "mergeCommit": {"oid": "aa76068307fe334aac558600a581ac0435a5f35c"}, "closed": true, "closedAt": "2020-10-27T22:10:33Z", "author": {"login": "iambmelt"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWttdWgH2gAyNTEwOTg5OTkyOjFkMWJkOTg0ZTgzNTVmYTI2OTJlYWM4NDE0ZTAxYzVmMzFlZWZiZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWwcDLgFqTUxODE4ODkwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1d1bd984e8355fa2692eac8414e01c5f31eefbdd", "committedDate": "2020-10-27T18:58:57Z", "message": "WIP -- Clean up tokens after writing the new one, to avoid having\ncache momentarily empty of RTs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUwNDkz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518050493", "createdAt": "2020-10-27T19:09:09Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTowOVrOHpMZvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTowOVrOHpMZvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Njg2Mg==", "bodyText": "Remove before merging", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512956862", "createdAt": "2020-10-27T19:09:09Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -312,12 +312,16 @@ public ICacheRecord save(@NonNull final GenericOAuth2Strategy oAuth2Strategy,\n         );\n \n         // remove old refresh token if it's MRRT or FRT\n-        removeRefreshTokenIfNeeded(accountToSave, refreshTokenToSave);\n+        // removeRefreshTokenIfNeeded(accountToSave, refreshTokenToSave);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUwNjMw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518050630", "createdAt": "2020-10-27T19:09:20Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOToyMFrOHpMaMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOToyMFrOHpMaMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Njk3Ng==", "bodyText": "Update this comment", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512956976", "createdAt": "2020-10-27T19:09:20Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -312,12 +312,16 @@ public ICacheRecord save(@NonNull final GenericOAuth2Strategy oAuth2Strategy,\n         );\n \n         // remove old refresh token if it's MRRT or FRT\n-        removeRefreshTokenIfNeeded(accountToSave, refreshTokenToSave);\n+        // removeRefreshTokenIfNeeded(accountToSave, refreshTokenToSave);\n \n         // Save the Account and Credentials...\n         saveAccounts(accountToSave);\n         saveCredentialsInternal(accessTokenToSave, refreshTokenToSave, idTokenToSave);\n \n+        // Add a new method, where we delete all of the refresh tokens in the cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUwOTAw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518050900", "createdAt": "2020-10-27T19:09:42Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTo0MlrOHpMbDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTo0MlrOHpMbDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1NzE5Ng==", "bodyText": "Rename this param", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512957196", "createdAt": "2020-10-27T19:09:42Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -327,6 +331,129 @@ public ICacheRecord save(@NonNull final GenericOAuth2Strategy oAuth2Strategy,\n         return result;\n     }\n \n+    private void removeAllRefreshTokensExcept(@NonNull final AccountRecord accountRecord,\n+                                              @NonNull final RefreshTokenRecord refreshTokenRecord) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUwOTcw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518050970", "createdAt": "2020-10-27T19:09:47Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTo0OFrOHpMbYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowOTo0OFrOHpMbYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1NzI4Mg==", "bodyText": "Add javadoc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512957282", "createdAt": "2020-10-27T19:09:48Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -327,6 +331,129 @@ public ICacheRecord save(@NonNull final GenericOAuth2Strategy oAuth2Strategy,\n         return result;\n     }\n \n+    private void removeAllRefreshTokensExcept(@NonNull final AccountRecord accountRecord,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUxMzM4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518051338", "createdAt": "2020-10-27T19:10:18Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToxMDoxOFrOHpMcoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToxMDoxOFrOHpMcoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1NzYwMA==", "bodyText": "Add a comment", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512957600", "createdAt": "2020-10-27T19:10:18Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -327,6 +331,129 @@ public ICacheRecord save(@NonNull final GenericOAuth2Strategy oAuth2Strategy,\n         return result;\n     }\n \n+    private void removeAllRefreshTokensExcept(@NonNull final AccountRecord accountRecord,\n+                                              @NonNull final RefreshTokenRecord refreshTokenRecord) {\n+        // Delete all of the refresh tokens associated with this account, except for the provided one\n+        final String methodName = \":removeAllRefreshTokensExcept\";\n+        final boolean isFamilyRefreshToken = !StringExtensions.isNullOrBlank(\n+                refreshTokenRecord.getFamilyId()\n+        );\n+\n+        Logger.info(\n+                TAG + methodName,\n+                \"isFamilyRefreshToken? [\" + isFamilyRefreshToken + \"]\"\n+        );\n+\n+        final boolean isMultiResourceCapable = MicrosoftAccount.AUTHORITY_TYPE_V1_V2.equals(\n+                accountRecord.getAuthorityType()\n+        );\n+\n+        Logger.info(\n+                TAG + methodName,\n+                \"isMultiResourceCapable? [\" + isMultiResourceCapable + \"]\"\n+        );\n+\n+        if (isFamilyRefreshToken || isMultiResourceCapable) {\n+            final String environment = accountRecord.getEnvironment();\n+            final String clientId = refreshTokenRecord.getClientId();\n+\n+            final int refreshTokensRemoved = removeRefreshTokensForAccountExcept(\n+                    accountRecord,\n+                    isFamilyRefreshToken,\n+                    environment,\n+                    clientId,\n+                    refreshTokenRecord\n+            );\n+\n+            Logger.info(\n+                    TAG + methodName,\n+                    \"Refresh tokens removed: [\" + refreshTokensRemoved + \"]\"\n+            );\n+\n+            if (refreshTokensRemoved > 1) {\n+                Logger.warn(\n+                        TAG + methodName,\n+                        \"Multiple refresh tokens found for Account.\"\n+                );\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all of the local refresh tokens on disk for the associated account, except for the\n+     * refresh token provided.\n+     *\n+     * @param accountRecord                    The {@link AccountRecord} for whome tokens should be deleted.\n+     * @param isFamilyRefreshToken             Indicates whether or not the tokens targeted for deletion should\n+     *                                         scope across all client_ids or not.\n+     * @param environment                      The cloud for which tokens should be deleted.\n+     * @param clientId                         The client_id for which tokens should be deleted, if not FRT.\n+     * @param deletionExemptRefreshTokenRecord The refresh token we want to exempt from deletion.\n+     * @return The number of tokens we removed from the cache.\n+     */\n+    private int removeRefreshTokensForAccountExcept(@NonNull final AccountRecord accountRecord,\n+                                                    final boolean isFamilyRefreshToken,\n+                                                    @NonNull final String environment,\n+                                                    @Nullable final String clientId,\n+                                                    @NonNull final RefreshTokenRecord deletionExemptRefreshTokenRecord) {\n+        return removeCredentialsOfTypeForAccountExcept(\n+                environment,\n+                isFamilyRefreshToken\n+                        // Delete all RTs, irrespective of client_id\n+                        // (so long as it is not the exempted record)\n+                        ? null\n+                        : clientId,\n+                CredentialType.RefreshToken,\n+                accountRecord,\n+                true,\n+                deletionExemptRefreshTokenRecord\n+        );\n+    }\n+\n+    /**\n+     * Removes Credentials of the supplied type for the supplied Account; skipping any record\n+     * specified as exempt.\n+     *\n+     * @param environment          Entity which issued the token represented as a host.\n+     * @param clientId             The clientId of the target app.\n+     * @param credentialType       The type of Credential to remove.\n+     * @param targetAccount        The target Account whose Credentials should be removed.\n+     * @param realmAgnostic        True if the specified action should be completed irrespective of realm.\n+     * @param deletionExemptRecord A record which explicitly must not be removed.\n+     * @return The number of Credentials removed.\n+     */\n+    private int removeCredentialsOfTypeForAccountExcept(@NonNull final String environment,\n+                                                        @Nullable final String clientId,\n+                                                        @NonNull final CredentialType credentialType,\n+                                                        @NonNull final AccountRecord targetAccount,\n+                                                        final boolean realmAgnostic,\n+                                                        @NonNull final Credential deletionExemptRecord) {\n+        int credentialsRemoved = 0;\n+\n+        // Query it for Credentials matching the supplied targetAccount\n+        final List<Credential> credentialsToRemove =\n+                mAccountCredentialCache.getCredentialsFilteredBy(\n+                        targetAccount.getHomeAccountId(),\n+                        environment,\n+                        credentialType,\n+                        clientId,\n+                        realmAgnostic\n+                                ? null // wildcard (*) realm\n+                                : targetAccount.getRealm(),\n+                        null, // wildcard (*) target,\n+                        null\n+                );\n+\n+        for (final Credential credentialToRemove : credentialsToRemove) {\n+            if (!deletionExemptRecord.equals(credentialToRemove)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDUxNDU3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518051457", "createdAt": "2020-10-27T19:10:27Z", "commit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToxMDoyOFrOHpMdBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToxMDoyOFrOHpMdBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1NzcwMA==", "bodyText": "Update this also...", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#discussion_r512957700", "createdAt": "2020-10-27T19:10:28Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -1689,6 +1816,7 @@ public void setSingleSignOnState(final GenericAccount account,\n         );\n \n         if (isFamilyRefreshToken || isMultiResourceCapable) {\n+            // TODO Consider updating this method for Teams' fix", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1bd984e8355fa2692eac8414e01c5f31eefbdd"}, "originalPosition": 152}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b1279d0cb5e49e58cb53b73f6093049acc0896", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/03b1279d0cb5e49e58cb53b73f6093049acc0896", "committedDate": "2020-10-27T19:11:48Z", "message": "Update comment for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cdc9364ec4c04281f6b12f1e854edd1e4e10c52", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/5cdc9364ec4c04281f6b12f1e854edd1e4e10c52", "committedDate": "2020-10-27T19:13:03Z", "message": "Rename param for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905e9b3dbc1ed1d138d5a3a60a6768b8df3d44be", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/905e9b3dbc1ed1d138d5a3a60a6768b8df3d44be", "committedDate": "2020-10-27T19:15:04Z", "message": "Adds javadoc to new method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "904d7ccedcabc99cb5c4d0002ded3e385d80a322", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/904d7ccedcabc99cb5c4d0002ded3e385d80a322", "committedDate": "2020-10-27T19:18:59Z", "message": "Adding code comments for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de0042f4d1576af829dd6ec1cc377d36d117be5d", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/de0042f4d1576af829dd6ec1cc377d36d117be5d", "committedDate": "2020-10-27T19:22:43Z", "message": "Apply same saving logic to TSL paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTU2NjY2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518156666", "createdAt": "2020-10-27T21:15:03Z", "commit": {"oid": "de0042f4d1576af829dd6ec1cc377d36d117be5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTg4OTA5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1098#pullrequestreview-518188909", "createdAt": "2020-10-27T22:09:39Z", "commit": {"oid": "de0042f4d1576af829dd6ec1cc377d36d117be5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1401, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}