{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4OTA2MDM0", "number": 940, "title": "Changes to delete RT's if we get an invalid_grant with bad token while renewing tokens", "bodyText": "", "createdAt": "2020-06-24T01:26:00Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940", "merged": true, "mergeCommit": {"oid": "bc4e13c0848f7439336518688398256c22bda9c8"}, "closed": true, "closedAt": "2020-06-24T02:08:07Z", "author": {"login": "kreedula"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuPtfqAH2gAyNDM4OTA2MDM0OmNiMzljMzYyMDc0MzRmMzJmOTQ3ZmZiZTk3ZjI5OGRmNDQ3ZDJjNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuQJOEgFqTQzNjI3MTk0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/cb39c36207434f32f947ffbe97f298df447d2c5f", "committedDate": "2020-06-24T01:24:52Z", "message": "Changes to delete RT's if we get an invalid_grant with bad token while renewing tokens"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjYzNzMy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#pullrequestreview-436263732", "createdAt": "2020-06-24T01:27:43Z", "commit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyNzo0NFrOGn_2kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyNzo0NFrOGn_2kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzgwOA==", "bodyText": "Can we log the contents of the sub_error?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593808", "createdAt": "2020-06-24T01:27:44Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjYzODE1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#pullrequestreview-436263815", "createdAt": "2020-06-24T01:28:01Z", "commit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODowMVrOGn_21A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODowMVrOGn_21A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Mzg3Ng==", "bodyText": "Nit formatter", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593876", "createdAt": "2020-06-24T01:28:01Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/0bfabcf155df5d1b1941a4df584b9eaa51d817eb", "committedDate": "2020-06-24T01:39:53Z", "message": "Addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjY5MDA4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#pullrequestreview-436269008", "createdAt": "2020-06-24T01:45:22Z", "commit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo0NToyMlrOGoAITg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo0NToyMlrOGoAITg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA==", "bodyText": "Can we add one more else case here where if the request isn't successful, but also doesn't contain an error response, we log a warning message?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444598350", "createdAt": "2020-06-24T01:45:22Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ec04006ed19e433aad9c8b992b32c317395b55", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b1ec04006ed19e433aad9c8b992b32c317395b55", "committedDate": "2020-06-24T01:50:45Z", "message": "Addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjcwNzE4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#pullrequestreview-436270718", "createdAt": "2020-06-24T01:51:05Z", "commit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNlrOGoANpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNlrOGoANpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5OTcxOA==", "bodyText": "Let's also check the return value here, should be  boolean if this removal was successful", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444599718", "createdAt": "2020-06-24T01:51:06Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0bcd0c033aea8052f4fbff89934b3fc9007cfdd", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f0bcd0c033aea8052f4fbff89934b3fc9007cfdd", "committedDate": "2020-06-24T01:53:26Z", "message": "Addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjcxOTQ3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#pullrequestreview-436271947", "createdAt": "2020-06-24T01:55:09Z", "commit": {"oid": "f0bcd0c033aea8052f4fbff89934b3fc9007cfdd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1670, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}