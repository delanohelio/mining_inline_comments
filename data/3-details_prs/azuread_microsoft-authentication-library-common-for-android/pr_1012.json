{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODc5MDgy", "number": 1012, "title": "An approach to triggering fewer duplicate command errors", "bodyText": "Redux of #1010 with suggestions from @AdamBJohnsonx\nRelated:\n#905\nAdd observers to Commands, once those commands finish notify the observers.", "createdAt": "2020-08-25T02:08:22Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012", "merged": true, "mergeCommit": {"oid": "3a2f4867ff85f9061033f37353e7c11d252d941a"}, "closed": true, "closedAt": "2020-08-25T19:39:08Z", "author": {"login": "iambmelt"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCKCzoAH2gAyNDcyODc5MDgyOmYyZmNiODQzZTI2ZTdjZjhmZGYzYzMxMDQ0NjI1NmNkYWQ2ODVmYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCbk6FAFqTQ3NDc0ODM4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2fcb843e26e7cf8fdf3c310446256cdad685fb2", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f2fcb843e26e7cf8fdf3c310446256cdad685fb2", "committedDate": "2020-08-24T22:07:12Z", "message": "Adds license to file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d59840edf769ab247252fdfc592dcb2f66581eb6", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d59840edf769ab247252fdfc592dcb2f66581eb6", "committedDate": "2020-08-24T22:09:38Z", "message": "Add final + nullability annots to existing impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c3c46739202a019d89a9e66ef0941709a1fbcf0", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1c3c46739202a019d89a9e66ef0941709a1fbcf0", "committedDate": "2020-08-24T22:14:13Z", "message": "Adds a BiConsumer interface with license infor + javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20a0728b634cc605781de9516ec2fb6a9e547c24", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/20a0728b634cc605781de9516ec2fb6a9e547c24", "committedDate": "2020-08-25T01:25:56Z", "message": "ResultFuture impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "683b65a8f2922b69fcaa471a98eb42235aa3ca96", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/683b65a8f2922b69fcaa471a98eb42235aa3ca96", "committedDate": "2020-08-25T01:34:56Z", "message": "Rename method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b814f9995c4edd5edf8b66ab101f49837f11374f", "committedDate": "2020-08-25T02:06:55Z", "message": "Integrates into CommandDispatcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjMyNDAz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474632403", "createdAt": "2020-08-25T16:05:49Z", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowNTo0OVrOHGfMMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowNTo0OVrOHGfMMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDUyOA==", "bodyText": "nah.  You can return.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476564528", "createdAt": "2020-08-25T16:05:49Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }\n+\n+    public synchronized void whenComplete(@NonNull final BiConsumer<T, Throwable> consumerToAdd) {\n+        if (isDone()) {\n+            consumerToAdd.accept(mResult, mException);\n+        }\n+\n+        // TODO Should we still add the consumer even if the ResultFuture isDone() == true?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjM1Mzk1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474635395", "createdAt": "2020-08-25T16:08:55Z", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowODo1NlrOHGfU1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowODo1NlrOHGfU1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2Njc0MA==", "bodyText": "Remove commented out code", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476566740", "createdAt": "2020-08-25T16:08:56Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -73,7 +77,8 @@\n     private static final Object sLock = new Object();\n     private static InteractiveTokenCommand sCommand = null;\n     private static final CommandResultCache sCommandResultCache = new CommandResultCache();\n-    private static final Set<BaseCommand> sExecutingCommands = Collections.synchronizedSet(new HashSet<BaseCommand>());\n+    //private static final Set<BaseCommand> sExecutingCommands = Collections.synchronizedSet(new HashSet<BaseCommand>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjM2MDY2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474636066", "createdAt": "2020-08-25T16:09:43Z", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowOTo0M1rOHGfW0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowOTo0M1rOHGfW0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzI1MA==", "bodyText": "Add javadoc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476567250", "createdAt": "2020-08-25T16:09:43Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }\n+\n+    public synchronized void whenComplete(@NonNull final BiConsumer<T, Throwable> consumerToAdd) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjM2MTQ5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474636149", "createdAt": "2020-08-25T16:09:48Z", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowOTo0OFrOHGfXEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowOTo0OFrOHGfXEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NzMxMw==", "bodyText": "Add javadoc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476567313", "createdAt": "2020-08-25T16:09:48Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40c7fbca336602ea74b7fa06af766c94fb39fc4b", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/40c7fbca336602ea74b7fa06af766c94fb39fc4b", "committedDate": "2020-08-25T16:13:26Z", "message": "Resolving TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fdb1526d5b9562fe6e332faf13e7d41a1813ace", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6fdb1526d5b9562fe6e332faf13e7d41a1813ace", "committedDate": "2020-08-25T16:15:05Z", "message": "Removing commented out code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d0cfe608fbadb0ae79bde44e49e467f0dc2c371", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/1d0cfe608fbadb0ae79bde44e49e467f0dc2c371", "committedDate": "2020-08-25T16:19:34Z", "message": "Adds javadoc to ResultFuture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjMyNzg4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474632788", "createdAt": "2020-08-25T16:06:14Z", "commit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowNjoxNVrOHGfNUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjozNDowNFrOHGgVdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDgxNg==", "bodyText": "At this point, you could drop all references in this list.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476564816", "createdAt": "2020-08-25T16:06:15Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n         if (mCountDownLatch.await(l, timeUnit)) {\n+            if (null != mException) {\n+                throw new RuntimeException(mException);\n+            }\n+\n             return mResult;\n         } else {\n-            throw new TimeoutException();\n+            throw new TimeoutException(\n+                    \"Timed out waiting for: \"\n+                            + l // duration\n+                            + timeUnit.name() // units\n+            );\n         }\n+    }\n+\n+    public synchronized void setException(@NonNull final Exception exception) {\n+        mException = exception;\n+        mCountDownLatch.countDown();\n \n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(mResult, exception);\n+        }\n     }\n \n-    public void setResult(T result) {\n+    public synchronized void setResult(@Nullable final T result) {\n         mResult = result;\n         mCountDownLatch.countDown();\n+\n+        for (final BiConsumer<T, Throwable> consumer : mConsumers) {\n+            consumer.accept(result, mException);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2OTEzMg==", "bodyText": "I was looking at this, I thought Future threw ExecutionExcepttion as well.  If it does, that's a better throw than runtime below.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476569132", "createdAt": "2020-08-25T16:12:41Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/ResultFuture.java", "diffHunk": "@@ -28,21 +59,55 @@ public boolean isDone() {\n     @Override\n     public T get() throws InterruptedException {\n         mCountDownLatch.await();\n+\n+        if (null != mException) {\n+            throw new RuntimeException(mException);\n+        }\n+\n         return mResult;\n     }\n \n     @Override\n-    public T get(long l, TimeUnit timeUnit) throws InterruptedException, TimeoutException {\n+    public T get(final long l, @NonNull final TimeUnit timeUnit) throws InterruptedException, TimeoutException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3MzI3MA==", "bodyText": "OK, this is your tricky synchronization part using concurrentMap.  You don't want to risk overwriting a concurrent writer without synchronizing this entire method.  So you make the result future and it's empty.  You then putIfAbsent into the sExecutingCommandMap.  If it returns null, then it did not populate the map and you add your listener to the future that you created since it was added to the map.  If it returns non-null, then you lost the race and you need add a listener to that future and return, since the command is already running.\nYou mainly run the get first because a get in the map is far cheaper than a putIfAbsent.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476573270", "createdAt": "2020-08-25T16:19:01Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +92,16 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            sExecutingCommandMap.put(command, resultFuture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTgyMw==", "bodyText": "Well, do we?  Long term, it's a better way of communicating error states.  The contract here is that either you have a result or you have a throwable.  Mostly, the code for these looks like if (t == null) { error handling; return; } result handling;", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476575823", "createdAt": "2020-08-25T16:22:45Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -139,14 +144,24 @@ public void run() {\n                 Telemetry.getInstance().flush(correlationId);\n                 EstsTelemetry.getInstance().flush(command, commandResult);\n \n-                sExecutingCommands.remove(command);\n-\n                 //Return the result via the callback\n-                returnCommandResult(command, commandResult, handler);\n+                sExecutingCommandMap.remove(command).setResult(commandResult);\n             }\n         });\n     }\n \n+    private static BiConsumer<CommandResult, Throwable> getCommandResultConsumer(\n+            @NonNull final BaseCommand command,\n+            @NonNull final Handler handler) {\n+        return new BiConsumer<CommandResult, Throwable>() {\n+            @Override\n+            public void accept(CommandResult result, Throwable throwable) {\n+                // We can ignore the second (exception) param, not used.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzI4NA==", "bodyText": "Hm.  OK, so we might want to pass in this executor to whenComplete.  As you may notice, in the event of a complete request, we're going to run the call back on whatever the current thread is running on.  If that's OK, it's more straightforward.  But if we want our callback to run on the silentExecutor thread in the event that the result is already completed by the time we attempt to run it, we probably want to pass this executor into whenComplete to use in the event we hit that case.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476583284", "createdAt": "2020-08-25T16:34:04Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +92,16 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            sExecutingCommandMap.put(command, resultFuture);\n         }\n \n         sSilentExecutor.execute(new Runnable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b814f9995c4edd5edf8b66ab101f49837f11374f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47d8fa9856e1f784755abe10c2a61311ed78712d", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/47d8fa9856e1f784755abe10c2a61311ed78712d", "committedDate": "2020-08-25T16:43:45Z", "message": "Clear consumers list after setting result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae08476ddf46ae797c5adfd62f1632a4190014a", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fae08476ddf46ae797c5adfd62f1632a4190014a", "committedDate": "2020-08-25T17:14:17Z", "message": "Convert RuntimeException to ExecutionException (Requires MSAL changes)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98528c6c95c4eefe9d806b5f465bc8965b7f4fcb", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/98528c6c95c4eefe9d806b5f465bc8965b7f4fcb", "committedDate": "2020-08-25T17:46:41Z", "message": "Fix for potential threading issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "906d601b4ea55041efd1f6eae8799f0790ed537d", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/906d601b4ea55041efd1f6eae8799f0790ed537d", "committedDate": "2020-08-25T17:48:38Z", "message": "Fix spelling in comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b908342ba087ef5bccca5e7eb486ea49093da911", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b908342ba087ef5bccca5e7eb486ea49093da911", "committedDate": "2020-08-25T18:12:45Z", "message": "Remove duplicative put call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzM4OTI2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474738926", "createdAt": "2020-08-25T18:19:25Z", "commit": {"oid": "906d601b4ea55041efd1f6eae8799f0790ed537d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODoxOToyNVrOHGkTDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODoxOToyNVrOHGkTDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0ODIwNg==", "bodyText": "Don't think you need this.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#discussion_r476648206", "createdAt": "2020-08-25T18:19:25Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/CommandDispatcher.java", "diffHunk": "@@ -87,15 +91,26 @@ public static void submitSilent(@NonNull final BaseCommand command) {\n                 \"Beginning execution of silent command.\"\n         );\n \n-        if (sExecutingCommands.contains(command)) {\n-            new Handler(Looper.getMainLooper()).post(new Runnable() {\n-                @Override\n-                public void run() {\n-                    command.getCallback().onError(new ClientException(ClientException.DUPLICATE_COMMAND, \"The same command was already received and is being processed.\"));\n-                }\n-            });\n-        } else if (command.isEligibleForCaching()) {\n-            sExecutingCommands.add(command);\n+        final Handler handler = new Handler(Looper.getMainLooper());\n+        ResultFuture<CommandResult> future = sExecutingCommandMap.get(command);\n+\n+        if (null != future) {\n+            future.whenComplete(getCommandResultConsumer(command, handler));\n+            return;\n+        } else {\n+            final ResultFuture<CommandResult> resultFuture = new ResultFuture<>();\n+            final ResultFuture<CommandResult> putValue = sExecutingCommandMap.putIfAbsent(command, resultFuture);\n+\n+            if (null == putValue) {\n+                // our value was inserted.\n+                resultFuture.whenComplete(getCommandResultConsumer(command, handler));\n+            } else {\n+                // Our value was not inserted, grab the one that was and hang a new listener off it\n+                putValue.whenComplete(getCommandResultConsumer(command, handler));\n+                return;\n+            }\n+\n+            sExecutingCommandMap.put(command, resultFuture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906d601b4ea55041efd1f6eae8799f0790ed537d"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7495fa9c7dd03ba71a2244340a7b3b9d82617a35", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7495fa9c7dd03ba71a2244340a7b3b9d82617a35", "committedDate": "2020-08-25T18:19:27Z", "message": "Inverting conditional (compacting)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ed0a71841cdf4095b7fac398dda2330df16da7", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/91ed0a71841cdf4095b7fac398dda2330df16da7", "committedDate": "2020-08-25T18:26:42Z", "message": "Return the throwable to the callback, if nonnull"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzQ4Mzg0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1012#pullrequestreview-474748384", "createdAt": "2020-08-25T18:32:50Z", "commit": {"oid": "91ed0a71841cdf4095b7fac398dda2330df16da7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1541, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}