{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MDYyMjEx", "number": 891, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjoyOTozNFrODyWzwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjo1Njo0N1rOD1AjGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTI5MDg5OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjoyOTozNFrOGGWZwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjoyOTozNFrOGGWZwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMTY4MQ==", "bodyText": "nit: run the stylize tool. here and everywhere.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409311681", "createdAt": "2020-04-16T06:29:34Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);\n+            } catch (IOException e) {\n+                Logger.error(TAG, \" Failed to compress account list to bytes, sending as jsonString\", e);\n+                resultBundle.putString(BROKER_ACCOUNTS, jsonString);\n+            }\n+\n         }\n \n         return resultBundle;\n     }\n \n     public List<ICacheRecord> getAccountsFromResultBundle(@NonNull final Bundle bundle) throws BaseException {\n-        final String accountJson = bundle.getString(BROKER_ACCOUNTS);\n+\n+        String accountJson;\n+        if(bundle.containsKey(BROKER_ACCOUNTS_COMPRESSED)){\n+            try {\n+                accountJson = GzipUtil.decompressBytesToString(\n+                        bundle.getByteArray(BROKER_ACCOUNTS_COMPRESSED)\n+                );\n+            } catch (IOException e) {\n+                Logger.error(TAG, \" Failed to decompress account list to bytes\", e);\n+                throw  new BaseException(ErrorStrings.UNKNOWN_ERROR, \" Failed to decompress account list to bytes\");\n+            }\n+        }else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTI5NzAyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNjozMTo1OVrOGGWdcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoxMjoxMFrOGJgKVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjYyNQ==", "bodyText": "How would this work with older MSAL? Do we need a version check to determine if we should compress?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409312625", "createdAt": "2020-04-16T06:31:59Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMDMwMA==", "bodyText": "Yup, thanks for pointing out. I was planning to  address issue tomm  using our hello handshake, didn\u2019t get time to look into. For now I got the test build to Teams  with these changes to test if it fixes the issue with new MSAL and new broker", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409320300", "createdAt": "2020-04-16T06:50:17Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjYyNQ=="}, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNzMwMQ==", "bodyText": "implemented here : 6b19efd", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412617301", "createdAt": "2020-04-22T02:12:10Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -451,14 +492,38 @@ public Bundle bundleFromAccounts(@NonNull final List<ICacheRecord> cacheRecords)\n         final Bundle resultBundle = new Bundle();\n \n         if (cacheRecords != null) {\n-            resultBundle.putString(BROKER_ACCOUNTS, JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords));\n+            final String jsonString = JsonExtensions.getJsonStringFromICacheRecordList(cacheRecords);\n+            try {\n+                byte[] bytes = GzipUtil.compressString(jsonString);\n+                Logger.info(TAG, \"Get accounts, raw payload size :\"\n+                        + jsonString.getBytes().length + \" compressed size \" + bytes.length\n+                );\n+                resultBundle.putByteArray(BROKER_ACCOUNTS_COMPRESSED, bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjYyNQ=="}, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 143}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4NTM1OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjozNlrOGG_Cpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjozNlrOGG_Cpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzUxMA==", "bodyText": "compressed bytes size?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409977510", "createdAt": "2020-04-17T03:52:36Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -196,6 +189,54 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n \n     }\n \n+    public Bundle bundleFromBrokerResult(final BrokerResult brokerResult){\n+        final Bundle resultBundle = new Bundle();\n+        final String brokerResultString = sRequestAdapterGsonInstance.toJson(\n+                brokerResult,\n+                BrokerResult.class\n+        );\n+        try {\n+            byte[] compressedBytes = compressString(brokerResultString);\n+            Logger.info(TAG, \"Broker Result, raw payload size:\"\n+                    + brokerResultString.getBytes().length + \" ,compressed bytes \" + compressedBytes.length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4OTI4OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1NDo0M1rOGG_E3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoxMzozM1rOGJgL0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODA3OA==", "bodyText": "Let's do two logs here: one for error to indicate that compression failed, and then a second as warn to re-iterate that and indicate that we are going to be sending jsonString", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409978078", "createdAt": "2020-04-17T03:54:43Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -196,6 +189,54 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n \n     }\n \n+    public Bundle bundleFromBrokerResult(final BrokerResult brokerResult){\n+        final Bundle resultBundle = new Bundle();\n+        final String brokerResultString = sRequestAdapterGsonInstance.toJson(\n+                brokerResult,\n+                BrokerResult.class\n+        );\n+        try {\n+            byte[] compressedBytes = compressString(brokerResultString);\n+            Logger.info(TAG, \"Broker Result, raw payload size:\"\n+                    + brokerResultString.getBytes().length + \" ,compressed bytes \" + compressedBytes.length\n+            );\n+            resultBundle.putByteArray(\n+                    AuthenticationConstants.Broker.BROKER_RESULT_V2_COMPRESSED,\n+                    compressedBytes\n+            );\n+        }catch (IOException e){\n+            Logger.error(TAG, \"Failed to compress Broker Result, sending as jsonString \", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNzY4MA==", "bodyText": "I don't see the necessity to add two logs here , given we can convey the message using one and theoretically we should never hit this", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412617680", "createdAt": "2020-04-22T02:13:33Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/result/MsalBrokerResultAdapter.java", "diffHunk": "@@ -196,6 +189,54 @@ public BaseException getBaseExceptionFromBundle(@NonNull final Bundle resultBund\n \n     }\n \n+    public Bundle bundleFromBrokerResult(final BrokerResult brokerResult){\n+        final Bundle resultBundle = new Bundle();\n+        final String brokerResultString = sRequestAdapterGsonInstance.toJson(\n+                brokerResult,\n+                BrokerResult.class\n+        );\n+        try {\n+            byte[] compressedBytes = compressString(brokerResultString);\n+            Logger.info(TAG, \"Broker Result, raw payload size:\"\n+                    + brokerResultString.getBytes().length + \" ,compressed bytes \" + compressedBytes.length\n+            );\n+            resultBundle.putByteArray(\n+                    AuthenticationConstants.Broker.BROKER_RESULT_V2_COMPRESSED,\n+                    compressedBytes\n+            );\n+        }catch (IOException e){\n+            Logger.error(TAG, \"Failed to compress Broker Result, sending as jsonString \", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODA3OA=="}, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ5NDc0OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODoxM1rOGG_IFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoxMzo1N1rOGJgMSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODkwMA==", "bodyText": "Can inputString be null? If yes, then we should do a null-check, otherwise add non-null annotation.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409978900", "createdAt": "2020-04-17T03:58:13Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNzgwMA==", "bodyText": "Added @NonNull", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412617800", "createdAt": "2020-04-22T02:13:57Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3ODkwMA=="}, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ5NTg3OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1ODo0N1rOGG_IuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoxNDoyMVrOGJgMzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3OTA2NQ==", "bodyText": "Can someone pass null array here?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r409979065", "createdAt": "2020-04-17T03:58:47Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {\n+        byte[] bytes = inputString.getBytes(\"UTF-8\");\n+        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+        GZIPOutputStream gzipOutputStream = new GZIPOutputStream(byteArrayOutputStream);\n+        gzipOutputStream.write(bytes, 0, bytes.length);\n+        gzipOutputStream.flush();\n+        gzipOutputStream.close();\n+        byte[] result = byteArrayOutputStream.toByteArray();\n+        byteArrayOutputStream.close();\n+        return result;\n+    }\n+\n+    /**\n+     * Util method which converts the gzip compressed bytes to  String.\n+     */\n+    public static String decompressBytesToString(final byte[] compressedBytes) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNzkzNA==", "bodyText": "Added @NonNull", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412617934", "createdAt": "2020-04-22T02:14:21Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/GzipUtil.java", "diffHunk": "@@ -0,0 +1,70 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.zip.GZIPInputStream;\n+import java.util.zip.GZIPOutputStream;\n+\n+public class GzipUtil {\n+\n+    /**\n+     * Util method which compress the input String to bytes using gzip compression.\n+     */\n+    public static byte[] compressString(final String inputString) throws IOException {\n+        byte[] bytes = inputString.getBytes(\"UTF-8\");\n+        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+        GZIPOutputStream gzipOutputStream = new GZIPOutputStream(byteArrayOutputStream);\n+        gzipOutputStream.write(bytes, 0, bytes.length);\n+        gzipOutputStream.flush();\n+        gzipOutputStream.close();\n+        byte[] result = byteArrayOutputStream.toByteArray();\n+        byteArrayOutputStream.close();\n+        return result;\n+    }\n+\n+    /**\n+     * Util method which converts the gzip compressed bytes to  String.\n+     */\n+    public static String decompressBytesToString(final byte[] compressedBytes) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3OTA2NQ=="}, "originalCommit": {"oid": "7c26a4215ca60a41c1301192aa93d60e8ea06788"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NDA0OTU3OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyODozNlrOGJgfaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyODozNlrOGJgfaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjY5OQ==", "bodyText": "needs formatting", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412622699", "createdAt": "2020-04-22T02:28:36Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -178,10 +183,15 @@ public BrokerInteractiveTokenCommandParameters brokerInteractiveParametersFromAc\n \n         final Intent intent = callingActivity.getIntent();\n \n-        final BrokerRequest brokerRequest = sRequestAdapterGsonInstance.fromJson(\n-                intent.getStringExtra(AuthenticationConstants.Broker.BROKER_REQUEST_V2),\n-                BrokerRequest.class\n-        );\n+        final BrokerRequest brokerRequest = brokerRequestFromBundle(intent.getExtras());\n+\n+        if (brokerRequest == null) {\n+            Logger.error(TAG, \"Broker Result is null, returning empty parameters, \" +\n+                            \"validation is expected to fail\",\n+                    null)\n+            ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NDA1MTExOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyOToxMVrOGJggQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjoyOToxMVrOGJggQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjkxNA==", "bodyText": "needs formatting", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412622914", "createdAt": "2020-04-22T02:29:11Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -262,10 +274,16 @@ public BrokerSilentTokenCommandParameters brokerSilentParametersFromBundle(\n \n         Logger.info(TAG, \"Constructing BrokerAcquireTokenSilentOperationParameters from result bundle\");\n \n-        final BrokerRequest brokerRequest = sRequestAdapterGsonInstance.fromJson(\n-                bundle.getString(AuthenticationConstants.Broker.BROKER_REQUEST_V2),\n-                BrokerRequest.class\n-        );\n+        final BrokerRequest brokerRequest = brokerRequestFromBundle(bundle);\n+\n+        if (brokerRequest == null) {\n+            Logger.error(TAG, \"Broker Result is null, returning empty parameters, \" +\n+                            \"validation is expected to fail\",\n+                    null)\n+            ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NDA2NzQwOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjozNjowNFrOGJgpGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjo1Njo0NVrOGJhC-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyNTE3Nw==", "bodyText": "I see almost same code below in getRequestBundleForAcquireTokenSilent. I think we can move this logic to its own method.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412625177", "createdAt": "2020-04-22T02:36:04Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -362,17 +412,78 @@ public Bundle getRequestBundleForHello(@NonNull final CommandParameters paramete\n         return requestBundle;\n     }\n \n-    public Bundle getRequestBundleForAcquireTokenSilent(final SilentTokenCommandParameters parameters) {\n+    public Bundle getRequestBundleForAcquireTokenInteractive(@NonNull final InteractiveTokenCommandParameters parameters,\n+                                                             @Nullable final String negotiatedBrokerProtocolVersion) {\n+        final BrokerRequest brokerRequest = brokerRequestFromAcquireTokenParameters(parameters);\n+        final Bundle requestBundle = new Bundle();\n+\n+        if (BrokerProtocolVersionUtil.canCompressBrokerPayloads(negotiatedBrokerProtocolVersion)) {\n+            try {\n+                final String jsonRequestString = sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class);\n+                byte[] compressedBytes = compressString(jsonRequestString);\n+                Logger.info(TAG, \"Broker Request, raw payload size:\"\n+                        + jsonRequestString.getBytes().length + \" ,compressed bytes size: \" + compressedBytes.length\n+                );\n+                requestBundle.putByteArray(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2_COMPRESSED,\n+                        compressedBytes\n+                );\n+\n+            } catch (IOException e) {\n+                Logger.error(TAG, \"Compression to bytes failed, sending broker request as String\", e);\n+                requestBundle.putString(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                        sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+                );\n+            }\n+        } else {\n+            Logger.info(TAG, \"Broker protocol version: \" + negotiatedBrokerProtocolVersion +\n+                    \" lower than compression changes, sending as string\"\n+            );\n+            requestBundle.putString(\n+                    AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                    sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+            );\n+        }\n+        return requestBundle;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzMTgwMA==", "bodyText": "thanks for spotting, addressed via c8ba307", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r412631800", "createdAt": "2020-04-22T02:56:45Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/request/MsalBrokerRequestAdapter.java", "diffHunk": "@@ -362,17 +412,78 @@ public Bundle getRequestBundleForHello(@NonNull final CommandParameters paramete\n         return requestBundle;\n     }\n \n-    public Bundle getRequestBundleForAcquireTokenSilent(final SilentTokenCommandParameters parameters) {\n+    public Bundle getRequestBundleForAcquireTokenInteractive(@NonNull final InteractiveTokenCommandParameters parameters,\n+                                                             @Nullable final String negotiatedBrokerProtocolVersion) {\n+        final BrokerRequest brokerRequest = brokerRequestFromAcquireTokenParameters(parameters);\n+        final Bundle requestBundle = new Bundle();\n+\n+        if (BrokerProtocolVersionUtil.canCompressBrokerPayloads(negotiatedBrokerProtocolVersion)) {\n+            try {\n+                final String jsonRequestString = sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class);\n+                byte[] compressedBytes = compressString(jsonRequestString);\n+                Logger.info(TAG, \"Broker Request, raw payload size:\"\n+                        + jsonRequestString.getBytes().length + \" ,compressed bytes size: \" + compressedBytes.length\n+                );\n+                requestBundle.putByteArray(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2_COMPRESSED,\n+                        compressedBytes\n+                );\n+\n+            } catch (IOException e) {\n+                Logger.error(TAG, \"Compression to bytes failed, sending broker request as String\", e);\n+                requestBundle.putString(\n+                        AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                        sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+                );\n+            }\n+        } else {\n+            Logger.info(TAG, \"Broker protocol version: \" + negotiatedBrokerProtocolVersion +\n+                    \" lower than compression changes, sending as string\"\n+            );\n+            requestBundle.putString(\n+                    AuthenticationConstants.Broker.BROKER_REQUEST_V2,\n+                    sRequestAdapterGsonInstance.toJson(brokerRequest, BrokerRequest.class)\n+            );\n+        }\n+        return requestBundle;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyNTE3Nw=="}, "originalCommit": {"oid": "9696933cfead8f755fa3aecc9b6454a6ddf821bd"}, "originalPosition": 174}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTEwMTA0OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/util/BrokerProtocolVersionUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjo1Njo0N1rOGKPNww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMzozNDo0NVrOGKQI1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM4ODIyNw==", "bodyText": "nit: nullOrEmpty?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r413388227", "createdAt": "2020-04-22T22:56:47Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/BrokerProtocolVersionUtil.java", "diffHunk": "@@ -0,0 +1,47 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import android.text.TextUtils;\n+\n+import androidx.annotation.Nullable;\n+\n+/**\n+ * Class to provide util methods to compare different features with respect to Broker Protocol version.\n+ */\n+public class BrokerProtocolVersionUtil {\n+\n+    public static final String BROKER_PROTOCOL_COMPRESSION_CHANGES_MINIMUM_VERSION = \"5.0\";\n+\n+    public static boolean canCompressBrokerPayloads(@Nullable String negotiatedBrokerProtocol) {\n+        if (TextUtils.isEmpty(negotiatedBrokerProtocol)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQwMzM0OA==", "bodyText": "TextUtils.isEmpty infact does check for null and empty", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/891#discussion_r413403348", "createdAt": "2020-04-22T23:34:45Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/util/BrokerProtocolVersionUtil.java", "diffHunk": "@@ -0,0 +1,47 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+\n+package com.microsoft.identity.common.internal.util;\n+\n+import android.text.TextUtils;\n+\n+import androidx.annotation.Nullable;\n+\n+/**\n+ * Class to provide util methods to compare different features with respect to Broker Protocol version.\n+ */\n+public class BrokerProtocolVersionUtil {\n+\n+    public static final String BROKER_PROTOCOL_COMPRESSION_CHANGES_MINIMUM_VERSION = \"5.0\";\n+\n+    public static boolean canCompressBrokerPayloads(@Nullable String negotiatedBrokerProtocol) {\n+        if (TextUtils.isEmpty(negotiatedBrokerProtocol)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM4ODIyNw=="}, "originalCommit": {"oid": "b2458980a052a3486ce764830aed3400f77989f8"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2342, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}