{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4OTA2MDM0", "number": 940, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyNzo0NFrOEIL78A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNlrOEIMK7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDE5NjMyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyNzo0NFrOGn_2kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo0MDozN1rOGoAC6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzgwOA==", "bodyText": "Can we log the contents of the sub_error?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593808", "createdAt": "2020-06-24T01:27:44Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Njk2OQ==", "bodyText": "logging both error and suberror now", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444596969", "createdAt": "2020-06-24T01:40:37Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5MzgwOA=="}, "originalCommit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDE5NjcyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODowMVrOGn_21A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODowMVrOGn_21A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5Mzg3Ng==", "bodyText": "Nit formatter", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444593876", "createdAt": "2020-06-24T01:28:01Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,16 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        }else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb39c36207434f32f947ffbe97f298df447d2c5f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDIyNTYyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo0NToyMlrOGoAITg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNVrOGoANoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA==", "bodyText": "Can we add one more else case here where if the request isn't successful, but also doesn't contain an error response, we log a warning message?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444598350", "createdAt": "2020-06-24T01:45:22Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODU2OA==", "bodyText": "(Obviously, this condition shouldn't ever happen)", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444598568", "createdAt": "2020-06-24T01:46:11Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA=="}, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5OTcxMg==", "bodyText": "yep, should never happen, but no harm adding", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444599712", "createdAt": "2020-06-24T01:51:05Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());\n+                }\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5ODM1MA=="}, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDIzNDY5OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNlrOGoANpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMTo1MTowNlrOGoANpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5OTcxOA==", "bodyText": "Let's also check the return value here, should be  boolean if this removal was successful", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/940#discussion_r444599718", "createdAt": "2020-06-24T01:51:06Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -300,6 +302,17 @@ protected void renewAccessToken(@NonNull final SilentTokenCommandParameters para\n \n             // Set the AuthenticationResult on the final result object\n             acquireTokenSilentResult.setLocalAuthenticationResult(authenticationResult);\n+        } else {\n+            if (tokenResult.getErrorResponse() != null) {\n+                final String errorCode = tokenResult.getErrorResponse().getError();\n+                final String subErrorCode = tokenResult.getErrorResponse().getSubError();\n+                Logger.info(TAG, \"Error: \" + errorCode + \" Suberror: \" + subErrorCode);\n+\n+                if (errorCode.equals(INVALID_GRANT) && subErrorCode.equals(BAD_TOKEN)) {\n+                    Logger.info(TAG, \"Refresh token is invalid, deleting from cache\");\n+                    tokenCache.removeCredential(cacheRecord.getRefreshToken());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfabcf155df5d1b1941a4df584b9eaa51d817eb"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2400, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}