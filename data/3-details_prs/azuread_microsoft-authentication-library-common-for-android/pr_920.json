{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MTM2ODE1", "number": 920, "title": "Changes to look for foci RT and use it for FOCI clients for local msal silent requests", "bodyText": "work item : https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1008396", "createdAt": "2020-06-01T18:13:52Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920", "merged": true, "mergeCommit": {"oid": "5b8224feaf59b0443b7d7d85cb8b84e2d96d8ef3"}, "closed": true, "closedAt": "2020-06-03T21:51:00Z", "author": {"login": "kreedula"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl0gYpgH2gAyNDI2MTM2ODE1OjdhMTI2NTk2MmI1YmZiNmZlN2RkN2RkMjdkYmZkZWZmZjdmZDI0OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnwXT5AH2gAyNDI2MTM2ODE1OmE2Njc0ZjFjNjk0OGZlNGI1YzkzYmIzNDFlZjBiMWFlMTRhYTliMmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a1265962b5bfb6fe7dd7dd27dbfdefff7fd249f", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7a1265962b5bfb6fe7dd7dd27dbfdefff7fd249f", "committedDate": "2020-05-28T21:11:43Z", "message": "Changes to look for foci RT's for local msal silent authentication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/38521d4fa15e7f1dd3d04cb97c8388903184384d", "committedDate": "2020-05-29T01:35:58Z", "message": "Fix pmd"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDg3MDEy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-422087012", "createdAt": "2020-06-01T18:38:26Z", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozODoyNlrOGdVqUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozODoyNlrOGdVqUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNjc4Nw==", "bodyText": "Can I get you to add two tests to the MsalOAuth2TokenCacheTest for this? 1 to test successful retrieval and another to test null when no matches", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433416787", "createdAt": "2020-06-01T18:38:26Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDg3MzY1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-422087365", "createdAt": "2020-06-01T18:38:58Z", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDk1MDUz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-422095053", "createdAt": "2020-06-01T18:50:05Z", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODo1MDowNlrOGdWC5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODo1MDowNlrOGdWC5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzA3Nw==", "bodyText": "API breaking change FYI\nWould it be better to make an additive change here?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433423077", "createdAt": "2020-06-01T18:50:06Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account\n      * @return true if the given client id can use the cached foci token. False, otherwise.\n      * @throws ClientException\n      * @throws IOException\n      */\n-    public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDk1NjA5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-422095609", "createdAt": "2020-06-01T18:50:56Z", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODo1MDo1N1rOGdWEmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODo1MDo1N1rOGdWEmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyMzUxNA==", "bodyText": "Same here it looks like.... another API breaking change I think?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433423514", "createdAt": "2020-06-01T18:50:57Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -617,14 +619,14 @@ public static MicrosoftStsTokenRequest createTokenRequest(@NonNull final String\n         return tokenRequest;\n     }\n \n-    public static MicrosoftStsAuthorizationRequest createAuthRequest(@NonNull final MicrosoftStsOAuth2Strategy strategy,\n-                                                                     @NonNull final ICacheRecord cacheRecord,\n+    private static MicrosoftStsAuthorizationRequest createAuthRequest(@NonNull final MicrosoftStsOAuth2Strategy strategy,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfab0f7f965c5a515532cca5c351991cff3ea392", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/bfab0f7f965c5a515532cca5c351991cff3ea392", "committedDate": "2020-06-02T18:21:53Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f32ac487d6c5e7a404e749c0b565a49b4292bfb1", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f32ac487d6c5e7a404e749c0b565a49b4292bfb1", "committedDate": "2020-06-02T19:29:28Z", "message": "Added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDcxOTYx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-422071961", "createdAt": "2020-06-01T18:15:56Z", "commit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODoxNTo1NlrOGdU8Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOTozOToyMlrOGeBS2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTAxNQ==", "bodyText": "nano-nit: it's odd that these lines moved.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433405015", "createdAt": "2020-06-01T18:15:56Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -60,6 +57,9 @@\n import java.util.List;\n import java.util.Set;\n \n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNzc1OQ==", "bodyText": "nit: spacing after Load.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433407759", "createdAt": "2020-06-01T18:21:13Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEyMg==", "bodyText": "Why the ':' on refreshTokenRecord but nothing else?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433408122", "createdAt": "2020-06-01T18:21:55Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw==", "bodyText": "Question: I've seen this pattern in the code, and I was wondering why we're not relying on the logger to yank the method out of the call stack from where the log line occurs.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433409657", "createdAt": "2020-06-01T18:24:51Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account\n      * @return true if the given client id can use the cached foci token. False, otherwise.\n      * @throws ClientException\n      * @throws IOException\n      */\n-    public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,\n+                                                        @NonNull final IAccountRecord accountRecord)\n             throws ClientException, IOException {\n         final String methodName = \":tryFociTokenWithGivenClientId\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMzUzOQ==", "bodyText": "The enclosing method is already Very Long(tm) - should this be a separate method?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433413539", "createdAt": "2020-06-01T18:32:11Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())\n+                    .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+            if (refreshTokenRecord != null) {\n+                try {\n+                    TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                            parameters.getOAuth2TokenCache(),\n+                            parameters.getClientId(),\n+                            parameters.getRedirectUri(),\n+                            refreshTokenRecord,\n+                            parameters.getAccount()\n+                    );\n+\n+                    // Try to look for account again in the cache\n+                    targetAccount = parameters\n+                            .getOAuth2TokenCache()\n+                            .getAccountByLocalAccountId(\n+                                    null,\n+                                    clientId,\n+                                    localAccountId\n+                            );\n+                } catch (IOException e) {\n+                    Logger.warn(TAG,\n+                            \"Error while attempting to validate client: \"\n+                                    + clientId + \" is part of family \" + e.getMessage()\n+                    );\n+                }\n+            } else {\n+                Logger.info(TAG, \"No Foci tokens found for homeAccountId \" + homeAccountId);\n+            }\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNDk3Mg==", "bodyText": "The indentation here is almost deceptive.  Maybe a local reference to the token cache would help.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433414972", "createdAt": "2020-06-01T18:34:52Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNzM3NA==", "bodyText": "we didn't rewrite the clientId reference.  Why get it again?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r433417374", "createdAt": "2020-06-01T18:39:37Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +527,41 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            // check for FOCI tokens, if available make a request to service to see if the client id is FOCI and save the tokens\n+            final RefreshTokenRecord refreshTokenRecord = ((MsalOAuth2TokenCache) parameters\n+                    .getOAuth2TokenCache())\n+                    .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+            if (refreshTokenRecord != null) {\n+                try {\n+                    TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                            parameters.getOAuth2TokenCache(),\n+                            parameters.getClientId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEzMTY3Mg==", "bodyText": "When does this return something that's not a RefreshTokenRecord?  If I go look at the code, it only sets credential being returned if it is instanceof RefreshTokenRecord, I think.  It's a private method - should we change the signature?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434131672", "createdAt": "2020-06-02T19:39:22Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,27 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load  FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {\n+        final List<AccountRecord> accountRecords = mAccountCredentialCache.getAccounts();\n+\n+        for (AccountRecord accountRecord : accountRecords) {\n+            if (accountRecord.getHomeAccountId().equals(homeAccountId)) {\n+                final Credential rt = getFamilyRefreshTokenForAccount(accountRecord);\n+\n+                if (rt instanceof RefreshTokenRecord) {\n+                    return (RefreshTokenRecord) rt;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f32ac487d6c5e7a404e749c0b565a49b4292bfb1"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff3f7e02530a7052cbd302dc428616fff91c435", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fff3f7e02530a7052cbd302dc428616fff91c435", "committedDate": "2020-06-03T19:58:49Z", "message": "Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "author": {"user": {"login": "kreedula", "name": "Krishna Eedula"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2851b245067b3adaeed8dc0e99f8ce8ea158ea66", "committedDate": "2020-06-03T20:10:34Z", "message": "Merge branch 'dev' into kreedula/msal-foci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/72f6a15d7557006bcbc3f72d8daf18e7d7b9c195", "committedDate": "2020-06-03T20:26:48Z", "message": "Minor typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTA1MzYw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-423905360", "createdAt": "2020-06-03T20:29:19Z", "commit": {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODk0NTg4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-423894588", "createdAt": "2020-06-03T20:13:35Z", "commit": {"oid": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDoxMzozNVrOGert3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMDo1MzoxNVrOGes84g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgyNjcxNg==", "bodyText": "nit: space after cast.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434826716", "createdAt": "2020-06-03T20:13:35Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -525,6 +528,13 @@ protected AccountRecord getCachedAccountRecord(\n                     );\n         }\n \n+        if (null == targetAccount && parameters.getOAuth2TokenCache() instanceof MsalOAuth2TokenCache) {\n+            targetAccount = getAccountWithFRTIfAvailable(\n+                    parameters,\n+                    (MsalOAuth2TokenCache)parameters.getOAuth2TokenCache()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzMDcyMg==", "bodyText": "Cool.  I actually tried writing a few things to change the logging stack, but it gets to be a really big change quickly.  I'm curious why we don't use one of the more standard logging frameworks like, say, slf4j, maybe it's binary size?\nAnyway, why I'm concerned a little, from https://developer.android.com/reference/android/util/Log.html :\nthat when you're building the string to pass into Log.d, the compiler uses a StringBuilder and at least three allocations occur: the StringBuilder itself, the buffer, and the String object. Realistically, there is also another buffer allocation and copy, and even more pressure on the gc. That means that if your log message is filtered out, you might be doing significant work and incurring significant overhead.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434830722", "createdAt": "2020-06-03T20:21:24Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -127,25 +128,26 @@\n      *\n      * @param clientId    String of the given client id.\n      * @param redirectUri redirect url string of the given client id.\n-     * @param cacheRecord Foci cache record.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord : refresh token record of FOCI account\n      * @return true if the given client id can use the cached foci token. False, otherwise.\n      * @throws ClientException\n      * @throws IOException\n      */\n-    public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,\n+                                                        @NonNull final IAccountRecord accountRecord)\n             throws ClientException, IOException {\n         final String methodName = \":tryFociTokenWithGivenClientId\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwOTY1Nw=="}, "originalCommit": {"oid": "38521d4fa15e7f1dd3d04cb97c8388903184384d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzMzQwMw==", "bodyText": "nit: inline?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434833403", "createdAt": "2020-06-03T20:26:27Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -672,6 +672,23 @@ private Credential getFamilyRefreshTokenForAccount(@NonNull final AccountRecord\n         return result;\n     }\n \n+    /**\n+     * Load FRTs from the cache for an account matching the homeAccountId\n+     * @param homeAccountId : homeAccountId for which FRT is sought\n+     * @return an FRT if available else null.\n+     */\n+    @Nullable\n+    public RefreshTokenRecord getFamilyRefreshTokenForHomeAccountId(@NonNull final String homeAccountId) {\n+        final List<AccountRecord> accountRecords = mAccountCredentialCache.getAccounts();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2851b245067b3adaeed8dc0e99f8ce8ea158ea66"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgzODc5OA==", "bodyText": "Random comment: I kinda want to write StringUtil.defaultIfEmpty(String a, String b) -> isEmpty(a) ? b : a;", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434838798", "createdAt": "2020-06-03T20:37:31Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -135,17 +139,40 @@\n     public static boolean tryFociTokenWithGivenClientId(@NonNull final BrokerOAuth2TokenCache brokerOAuth2TokenCache,\n                                                         @NonNull final String clientId,\n                                                         @NonNull final String redirectUri,\n-                                                        @NonNull final ICacheRecord cacheRecord)\n+                                                        @NonNull final ICacheRecord cacheRecord) throws IOException, ClientException {\n+        return tryFociTokenWithGivenClientId(\n+                brokerOAuth2TokenCache,\n+                clientId, redirectUri,\n+                cacheRecord.getRefreshToken(),\n+                cacheRecord.getAccount()\n+        );\n+    }\n+\n+    /**\n+     * Testing whether the given client ID can use the cached foci to refresh token.\n+     *\n+     * @param clientId    String of the given client id.\n+     * @param redirectUri redirect url string of the given client id.\n+     * @param accountRecord account record of request\n+     * @param refreshTokenRecord refresh token record of FOCI account\n+     * @return true if the given client id can use the cached foci token. False, otherwise.\n+     * @throws ClientException\n+     * @throws IOException\n+     */\n+    public static boolean tryFociTokenWithGivenClientId(@NonNull final OAuth2TokenCache brokerOAuth2TokenCache,\n+                                                        @NonNull final String clientId,\n+                                                        @NonNull final String redirectUri,\n+                                                        @NonNull final RefreshTokenRecord refreshTokenRecord,\n+                                                        @NonNull final IAccountRecord accountRecord)\n             throws ClientException, IOException {\n         final String methodName = \":tryFociTokenWithGivenClientId\";\n         final MicrosoftStsOAuth2Configuration config = new MicrosoftStsOAuth2Configuration();\n \n         //Get authority url\n         final Uri.Builder requestUrlBuilder = new Uri.Builder();\n-        final String tenantId = cacheRecord.getAccount().getRealm();\n         requestUrlBuilder.scheme(\"https\")\n-                .authority(cacheRecord.getRefreshToken().getEnvironment())\n-                .appendPath(StringUtil.isEmpty(tenantId) ? ALL_ACCOUNTS_TENANT_ID : tenantId);\n+                .authority(refreshTokenRecord.getEnvironment())\n+                .appendPath(StringUtil.isEmpty(accountRecord.getRealm()) ? ALL_ACCOUNTS_TENANT_ID : accountRecord.getRealm());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg0Njk0Ng==", "bodyText": "OK, we have the token then we make this call.  We stuff it into the datastore as a side effect, then go back to the datastore to pull it out again.  There's probably a reason we don't just return it... but anyway, this method returns a boolean value that we're not checking.  Should we check it?  Should we return the token instead?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#discussion_r434846946", "createdAt": "2020-06-03T20:53:15Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/controllers/BaseController.java", "diffHunk": "@@ -552,6 +562,48 @@ protected AccountRecord getCachedAccountRecord(\n         return targetAccount;\n     }\n \n+    @Nullable\n+    private AccountRecord getAccountWithFRTIfAvailable(@NonNull final SilentTokenCommandParameters parameters,\n+                                                       @NonNull final MsalOAuth2TokenCache msalOAuth2TokenCache){\n+\n+        final String homeAccountId = parameters.getAccount().getHomeAccountId();\n+        final String clientId = parameters.getClientId();\n+\n+        // check for FOCI tokens for the homeAccountId\n+        final RefreshTokenRecord refreshTokenRecord = msalOAuth2TokenCache\n+                .getFamilyRefreshTokenForHomeAccountId(homeAccountId);\n+\n+        if (refreshTokenRecord != null) {\n+            try {\n+                // foci token is available, make a request to service to see if the client id is FOCI and save the tokens\n+                TokenCacheItemMigrationAdapter.tryFociTokenWithGivenClientId(\n+                        parameters.getOAuth2TokenCache(),\n+                        clientId,\n+                        parameters.getRedirectUri(),\n+                        refreshTokenRecord,\n+                        parameters.getAccount()\n+                );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTI2Mjcy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/920#pullrequestreview-423926272", "createdAt": "2020-06-03T20:55:21Z", "commit": {"oid": "72f6a15d7557006bcbc3f72d8daf18e7d7b9c195"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8f4d0ed5b84c37dd34def53aeada19dce3418c0", "author": {"user": null}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b8f4d0ed5b84c37dd34def53aeada19dce3418c0", "committedDate": "2020-06-03T21:18:10Z", "message": "Minor changes to address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6674f1c6948fe4b5c93bb341ef0b1ae14aa9b2c", "author": {"user": {"login": "kreedula", "name": "Krishna Eedula"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a6674f1c6948fe4b5c93bb341ef0b1ae14aa9b2c", "committedDate": "2020-06-03T21:30:02Z", "message": "Merge branch 'dev' into kreedula/msal-foci"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1647, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}