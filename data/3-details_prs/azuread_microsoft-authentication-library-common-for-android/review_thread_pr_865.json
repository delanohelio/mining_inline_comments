{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMzY4MzA0", "number": 865, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxOTozMVrODp4tgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODo0ODozOFrODp-rZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjQ3MzYyOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxOTozMVrOF5Vm9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0MjowNVrOF5ZANw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzE5MA==", "bodyText": "Looks we already had the constant defined using the forward link instead of the query string and were using it to launch CP. So server change was not a must but good to have.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395667190", "createdAt": "2020-03-20T14:19:31Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java", "diffHunk": "@@ -1016,14 +1021,14 @@ private AuthenticationConstants() {\n         public static final String BROWSER_EXT_INSTALL_PREFIX = \"msauth://\";\n \n         /**\n-         * Prefix in the redirect to open external browser to finish the CA auth.\n+         * A query param indicating that this is an intune device CA link.\n          */\n-        public static final String BROWSER_DEVICE_CA_URL = \"browser://go.microsoft.com/fwlink/?LinkId=396941\";\n+        public static final String BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER = \"&ismdmurl=1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMjgwNw==", "bodyText": "Given that the link defined by Intune could be changed on the server side at any point in time, if we are going to ship this, I think having a 'contract' (i.e. the server side explicitly sends us a signal) is a must.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395722807", "createdAt": "2020-03-20T15:42:05Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationConstants.java", "diffHunk": "@@ -1016,14 +1021,14 @@ private AuthenticationConstants() {\n         public static final String BROWSER_EXT_INSTALL_PREFIX = \"msauth://\";\n \n         /**\n-         * Prefix in the redirect to open external browser to finish the CA auth.\n+         * A query param indicating that this is an intune device CA link.\n          */\n-        public static final String BROWSER_DEVICE_CA_URL = \"browser://go.microsoft.com/fwlink/?LinkId=396941\";\n+        public static final String BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER = \"&ismdmurl=1\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzE5MA=="}, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjQ4NzE0OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/azureactivedirectory/AzureActiveDirectoryAuthorizationResultFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoyMjo1MVrOF5Vvng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0OTo0M1rOF5ZT5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2OTQwNg==", "bodyText": "Why are we passing the same parameter twice?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395669406", "createdAt": "2020-03-20T14:22:51Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/azureactivedirectory/AzureActiveDirectoryAuthorizationResultFactory.java", "diffHunk": "@@ -103,11 +103,21 @@ public AzureActiveDirectoryAuthorizationResult createAuthorizationResult(final i\n                 break;\n \n             case AuthenticationConstants.UIResponse.BROWSER_CODE_DEVICE_REGISTER:\n-                Logger.verbose(TAG, \"Device needs to have broker installed, we expect the apps to call us\"\n-                        + \"back when the broker is installed\");\n+                Logger.info(TAG, \"Device Registration needed, need to start WPJ\");\n                 result = createAuthorizationResultWithErrorResponse(AuthorizationStatus.FAIL,\n-                        MicrosoftAuthorizationErrorResponse.AUTHORIZATION_FAILED,\n-                        MicrosoftAuthorizationErrorResponse.BROKER_NEEDS_TO_BE_INSTALLED);\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_REGISTRATION_NEEDED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyNzg0Ng==", "bodyText": "The pattern I'm seeing is that the error code itself (MicrosoftAuthorizationErrorResponse.XXXX) can also be used as a error message.\nWe could also have separate values for this one.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395727846", "createdAt": "2020-03-20T15:49:43Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/azureactivedirectory/AzureActiveDirectoryAuthorizationResultFactory.java", "diffHunk": "@@ -103,11 +103,21 @@ public AzureActiveDirectoryAuthorizationResult createAuthorizationResult(final i\n                 break;\n \n             case AuthenticationConstants.UIResponse.BROWSER_CODE_DEVICE_REGISTER:\n-                Logger.verbose(TAG, \"Device needs to have broker installed, we expect the apps to call us\"\n-                        + \"back when the broker is installed\");\n+                Logger.info(TAG, \"Device Registration needed, need to start WPJ\");\n                 result = createAuthorizationResultWithErrorResponse(AuthorizationStatus.FAIL,\n-                        MicrosoftAuthorizationErrorResponse.AUTHORIZATION_FAILED,\n-                        MicrosoftAuthorizationErrorResponse.BROKER_NEEDS_TO_BE_INSTALLED);\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_REGISTRATION_NEEDED,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2OTQwNg=="}, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjUxODI2OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/azureactivedirectory/AzureActiveDirectoryAuthorizationResultFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMDoyNVrOF5WDyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMDoyNVrOF5WDyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NDU2OA==", "bodyText": "Same here", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395674568", "createdAt": "2020-03-20T14:30:25Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/azureactivedirectory/AzureActiveDirectoryAuthorizationResultFactory.java", "diffHunk": "@@ -103,11 +103,21 @@ public AzureActiveDirectoryAuthorizationResult createAuthorizationResult(final i\n                 break;\n \n             case AuthenticationConstants.UIResponse.BROWSER_CODE_DEVICE_REGISTER:\n-                Logger.verbose(TAG, \"Device needs to have broker installed, we expect the apps to call us\"\n-                        + \"back when the broker is installed\");\n+                Logger.info(TAG, \"Device Registration needed, need to start WPJ\");\n                 result = createAuthorizationResultWithErrorResponse(AuthorizationStatus.FAIL,\n-                        MicrosoftAuthorizationErrorResponse.AUTHORIZATION_FAILED,\n-                        MicrosoftAuthorizationErrorResponse.BROKER_NEEDS_TO_BE_INSTALLED);\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_REGISTRATION_NEEDED,\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_REGISTRATION_NEEDED);\n+                // Set username returned from the service\n+                result.getAuthorizationErrorResponse().setUserName(data.getStringExtra(\n+                        AuthenticationConstants.Broker.INSTALL_UPN_KEY)\n+                );\n+                break;\n+\n+            case AuthenticationConstants.UIResponse.BROWSER_CODE_MDM:\n+                Logger.info(TAG, \"MDM required. Launching Intune MDM link on browser.\");\n+                result = createAuthorizationResultWithErrorResponse(AuthorizationStatus.FAIL,\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_NEEDS_TO_BE_MANAGED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjUxOTE1OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsAuthorizationResultFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMDozN1rOF5WEXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMDozN1rOF5WEXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NDcxOQ==", "bodyText": "And here", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395674719", "createdAt": "2020-03-20T14:30:37Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/providers/microsoft/microsoftsts/MicrosoftStsAuthorizationResultFactory.java", "diffHunk": "@@ -123,7 +123,12 @@ public MicrosoftStsAuthorizationResult createAuthorizationResult(final int resul\n                         );\n                 break;\n \n-\n+            case AuthenticationConstants.UIResponse.BROWSER_CODE_MDM:\n+                Logger.info(TAG, \"MDM required. Launching Intune MDM link on browser.\");\n+                result = createAuthorizationResultWithErrorResponse(AuthorizationStatus.FAIL,\n+                        MicrosoftAuthorizationErrorResponse.DEVICE_NEEDS_TO_BE_MANAGED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjUzNDExOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozNDoyMFrOF5WOHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjoyNjozM1rOF6Nf2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NzIxMw==", "bodyText": "Why do we need this. Shouldn't the server already be rejecting it?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395677213", "createdAt": "2020-03-20T14:34:20Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {\n-            // TODO: This flow should really check if the Microsoft Intune or the Company Portal apps are installed,\n-            // which is the correct client app to launch depending on the enrollment, and launch that app, to permanently skip the browser.\n-            // Also it must handle 3rd party MDMs as appropriate, which will depend on the browser flow determining the authority.\n-            Logger.info(TAG + methodName, \"It is a device CA request on IPPhone. Company Portal is installed.\");\n-            try {\n-                Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n-                final Intent intent = new Intent();\n-                intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n-                        AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n-                getActivity().startActivity(intent);\n-            } catch (final SecurityException ex) {\n-                Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n-                openLinkInBrowser(url);\n+\n+        view.stopLoading();\n+\n+        if (url.contains(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER)) {\n+            Logger.info(TAG + methodName, \"This is a device CA request.\");\n+            final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n+            final Context applicationContext = getActivity().getApplicationContext();\n+\n+            // If CP is installed, redirect to CP.\n+            if (!getActivity().getPackageName().equalsIgnoreCase(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME) &&\n+                    packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)) {\n+                try {\n+                    Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n+                    final Intent intent = new Intent();\n+                    intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n+                            AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n+                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n+                    getActivity().startActivity(intent);\n+\n+                    getCompletionCallback().onChallengeResponseReceived(AuthenticationConstants.UIResponse.BROWSER_CODE_MDM, new Intent());\n+                    return true;\n+                } catch (final Exception ex) {\n+                    Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n+                }\n             }\n-        } else {\n-            openLinkInBrowser(url);\n+\n+            // Otherwise, strip out BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER and launch in Browser.\n+            openLinkInBrowser(url.replace(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER, \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyODk3Nw==", "bodyText": "This is what I and Carlos originally agreed on. Although I agree with you that if we make the query string parameter unique enough, we might not have to do this.\nI've forwarded him this PR and will let him chime in.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395728977", "createdAt": "2020-03-20T15:51:27Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {\n-            // TODO: This flow should really check if the Microsoft Intune or the Company Portal apps are installed,\n-            // which is the correct client app to launch depending on the enrollment, and launch that app, to permanently skip the browser.\n-            // Also it must handle 3rd party MDMs as appropriate, which will depend on the browser flow determining the authority.\n-            Logger.info(TAG + methodName, \"It is a device CA request on IPPhone. Company Portal is installed.\");\n-            try {\n-                Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n-                final Intent intent = new Intent();\n-                intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n-                        AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n-                getActivity().startActivity(intent);\n-            } catch (final SecurityException ex) {\n-                Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n-                openLinkInBrowser(url);\n+\n+        view.stopLoading();\n+\n+        if (url.contains(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER)) {\n+            Logger.info(TAG + methodName, \"This is a device CA request.\");\n+            final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n+            final Context applicationContext = getActivity().getApplicationContext();\n+\n+            // If CP is installed, redirect to CP.\n+            if (!getActivity().getPackageName().equalsIgnoreCase(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME) &&\n+                    packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)) {\n+                try {\n+                    Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n+                    final Intent intent = new Intent();\n+                    intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n+                            AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n+                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n+                    getActivity().startActivity(intent);\n+\n+                    getCompletionCallback().onChallengeResponseReceived(AuthenticationConstants.UIResponse.BROWSER_CODE_MDM, new Intent());\n+                    return true;\n+                } catch (final Exception ex) {\n+                    Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n+                }\n             }\n-        } else {\n-            openLinkInBrowser(url);\n+\n+            // Otherwise, strip out BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER and launch in Browser.\n+            openLinkInBrowser(url.replace(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER, \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NzIxMw=="}, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3ODAzMQ==", "bodyText": "Yes I would be curious to understand why server can't reject it .", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395878031", "createdAt": "2020-03-20T20:36:55Z", "author": {"login": "Om83"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {\n-            // TODO: This flow should really check if the Microsoft Intune or the Company Portal apps are installed,\n-            // which is the correct client app to launch depending on the enrollment, and launch that app, to permanently skip the browser.\n-            // Also it must handle 3rd party MDMs as appropriate, which will depend on the browser flow determining the authority.\n-            Logger.info(TAG + methodName, \"It is a device CA request on IPPhone. Company Portal is installed.\");\n-            try {\n-                Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n-                final Intent intent = new Intent();\n-                intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n-                        AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n-                getActivity().startActivity(intent);\n-            } catch (final SecurityException ex) {\n-                Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n-                openLinkInBrowser(url);\n+\n+        view.stopLoading();\n+\n+        if (url.contains(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER)) {\n+            Logger.info(TAG + methodName, \"This is a device CA request.\");\n+            final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n+            final Context applicationContext = getActivity().getApplicationContext();\n+\n+            // If CP is installed, redirect to CP.\n+            if (!getActivity().getPackageName().equalsIgnoreCase(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME) &&\n+                    packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)) {\n+                try {\n+                    Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n+                    final Intent intent = new Intent();\n+                    intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n+                            AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n+                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n+                    getActivity().startActivity(intent);\n+\n+                    getCompletionCallback().onChallengeResponseReceived(AuthenticationConstants.UIResponse.BROWSER_CODE_MDM, new Intent());\n+                    return true;\n+                } catch (final Exception ex) {\n+                    Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n+                }\n             }\n-        } else {\n-            openLinkInBrowser(url);\n+\n+            // Otherwise, strip out BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER and launch in Browser.\n+            openLinkInBrowser(url.replace(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER, \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NzIxMw=="}, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4Mjg3NQ==", "bodyText": "Intune confirmed they'll reject it. I'll remove this logic.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r396582875", "createdAt": "2020-03-23T16:26:33Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {\n-            // TODO: This flow should really check if the Microsoft Intune or the Company Portal apps are installed,\n-            // which is the correct client app to launch depending on the enrollment, and launch that app, to permanently skip the browser.\n-            // Also it must handle 3rd party MDMs as appropriate, which will depend on the browser flow determining the authority.\n-            Logger.info(TAG + methodName, \"It is a device CA request on IPPhone. Company Portal is installed.\");\n-            try {\n-                Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n-                final Intent intent = new Intent();\n-                intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n-                        AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n-                getActivity().startActivity(intent);\n-            } catch (final SecurityException ex) {\n-                Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n-                openLinkInBrowser(url);\n+\n+        view.stopLoading();\n+\n+        if (url.contains(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER)) {\n+            Logger.info(TAG + methodName, \"This is a device CA request.\");\n+            final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n+            final Context applicationContext = getActivity().getApplicationContext();\n+\n+            // If CP is installed, redirect to CP.\n+            if (!getActivity().getPackageName().equalsIgnoreCase(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME) &&\n+                    packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)) {\n+                try {\n+                    Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n+                    final Intent intent = new Intent();\n+                    intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n+                            AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n+                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n+                    getActivity().startActivity(intent);\n+\n+                    getCompletionCallback().onChallengeResponseReceived(AuthenticationConstants.UIResponse.BROWSER_CODE_MDM, new Intent());\n+                    return true;\n+                } catch (final Exception ex) {\n+                    Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n+                }\n             }\n-        } else {\n-            openLinkInBrowser(url);\n+\n+            // Otherwise, strip out BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER and launch in Browser.\n+            openLinkInBrowser(url.replace(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL_QUERY_STRING_PARAMETER, \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NzIxMw=="}, "originalCommit": {"oid": "e73a8f7e85671655dd870a1497505fc551bb0729"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzQ0NTgyOnYy", "diffSide": "LEFT", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODo0Njo0NlrOF5fdCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMDowMjowNlrOF5hmPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA==", "bodyText": "Why is this check removed ? I see a TODO, but did we test this ?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395828490", "createdAt": "2020-03-20T18:46:46Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgzNjMyMQ==", "bodyText": "Once we get a clear signal from the server side, we can remove this app-specific workaround.\nI've tested this by adding ismdmurl=1 at the end of the url and set COMPANY_PORTAL_APP_PACKAGE_NAME to CP package in debug mode, CP is launched.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395836321", "createdAt": "2020-03-20T19:02:11Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA=="}, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg0MjQ3Ng==", "bodyText": "(if we use brokertestapp, then an exception will be thrown as it wouldn't be able to find SplashActivity. In that case we'll proceed to the next step - launching browser and returning AuthenticationConstants.UIResponse.BROWSER_CODE_MDM.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395842476", "createdAt": "2020-03-20T19:15:27Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA=="}, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1OTczMg==", "bodyText": "okay makes sense, probably this check is the reason, we always end up in Playstore even if CP is installed", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395859732", "createdAt": "2020-03-20T19:53:43Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA=="}, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2MjIwOQ==", "bodyText": "I guess this check was probably added because playstore is not available on ipphone devices.\nOtherwise the user can redirect to the app through playstore. (one more click -but it's not blocking).", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395862209", "createdAt": "2020-03-20T19:58:58Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA=="}, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2MzYxMw==", "bodyText": "Yup, never made sense to me,  as why not directly go to CP in regular case also, i.e. why a specific app check. anyways this should fix", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395863613", "createdAt": "2020-03-20T20:02:06Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyODQ5MA=="}, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzQ1MTI3OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODo0ODozOFrOF5fgqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODo0ODozOFrOF5fgqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyOTQxNw==", "bodyText": "nit : most of the lines in this method are very long, way beyond 100 chars, see if you can format to improve readability", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/865#discussion_r395829417", "createdAt": "2020-03-20T18:48:38Z", "author": {"login": "kreedula"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/ui/webview/AzureActiveDirectoryWebViewClient.java", "diffHunk": "@@ -214,35 +214,40 @@ protected boolean processRedirectUrl(@NonNull final WebView view, @NonNull final\n \n     private boolean processWebsiteRequest(@NonNull final WebView view, @NonNull final String url) {\n         final String methodName = \"#processWebsiteRequest\";\n-        final PackageHelper packageHelper = new PackageHelper(getActivity().getPackageManager());\n-        final Context applicationContext = getActivity().getApplicationContext();\n-        if (url.startsWith(AuthenticationConstants.Broker.BROWSER_DEVICE_CA_URL)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME)\n-                && packageHelper.isPackageInstalledAndEnabled(applicationContext, AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME)\n-                && AuthenticationConstants.Broker.IPPHONE_APP_SIGNATURE.equals(\n-                packageHelper.getCurrentSignatureForPackage(AuthenticationConstants.Broker.IPPHONE_APP_PACKAGE_NAME))) {\n-            // TODO: This flow should really check if the Microsoft Intune or the Company Portal apps are installed,\n-            // which is the correct client app to launch depending on the enrollment, and launch that app, to permanently skip the browser.\n-            // Also it must handle 3rd party MDMs as appropriate, which will depend on the browser flow determining the authority.\n-            Logger.info(TAG + methodName, \"It is a device CA request on IPPhone. Company Portal is installed.\");\n-            try {\n-                Logger.verbose(TAG + methodName, \"Sending intent to launch the CompanyPortal.\");\n-                final Intent intent = new Intent();\n-                intent.setComponent(new ComponentName(AuthenticationConstants.Broker.COMPANY_PORTAL_APP_PACKAGE_NAME,\n-                        AuthenticationConstants.Broker.COMPANY_PORTAL_APP_LAUNCH_ACTIVITY_NAME));\n-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n-                getActivity().startActivity(intent);\n-            } catch (final SecurityException ex) {\n-                Logger.warn(TAG + methodName, \"Failed to launch Company Portal, falling back to browser.\");\n-                openLinkInBrowser(url);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e62d9cb40acbeb2523977148e4cf966dc3e9ddec"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2313, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}