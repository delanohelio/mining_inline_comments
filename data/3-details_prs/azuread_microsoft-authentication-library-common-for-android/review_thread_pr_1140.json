{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NTQ1ODc1", "number": 1140, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMTo1NFrOE-yRgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozODo0M1rOE-ybbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjcwODUxOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMTo1NFrOH8IP1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMTo1NFrOH8IP1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMTczMg==", "bodyText": "2-way linking to an ADO issue?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532811732", "createdAt": "2020-11-30T18:31:54Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjcxMjE1OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMjo1M1rOH8ISCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjoyNDoyNVrOH8qRPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjI5OQ==", "bodyText": "Can we add a constant for this?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812299", "createdAt": "2020-11-30T18:32:53Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2OTE1MQ==", "bodyText": "This is temporary and should be removed in the next release. (once we verify that using MSGraph user.read doesn't break anything) - because of that I prefer putting all of them in one place.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r533369151", "createdAt": "2020-12-01T12:24:25Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjI5OQ=="}, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjcxMjYxOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozMzowMFrOH8ISTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjoyNDoyOFrOH8qRaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjM2Ng==", "bodyText": "And for this?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532812366", "createdAt": "2020-11-30T18:33:00Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n+            scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2OTE5Mg==", "bodyText": "same as above.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r533369192", "createdAt": "2020-12-01T12:24:28Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {\n+            scopes = \"https://devicemgmt.teams.microsoft.com/.default \" + BaseController.getDelimitedDefaultScopeString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMjM2Ng=="}, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjczMzg5OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozODo0M1rOH8IfBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozODo0M1rOH8IfBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNTYyMw==", "bodyText": "Do we want a log statement here?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1140#discussion_r532815623", "createdAt": "2020-11-30T18:38:43Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -185,7 +185,18 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+\n+        final String scopes;\n+        // Hardcoding Teams Agent's client ID with the scope it's pre-authorized for.\n+        // This is because if only the default scope is passed, eSTS will set the resource ID (on its side)\n+        // based on the RT (Which the given clientId might not be pre-authorized for).\n+        // TODO: make pre-authorization of MSGraph User.read (and the default scopes) a requirement\n+        //       for every FoCI apps (and hardcode it here).\n+        if (TextUtils.equals(clientId, \"87749df4-7ccf-48f8-aa87-704bad0e0e16\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f01d87a35bb4ce9331fe0827fd46e83d3eb965d"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2106, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}