{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjQ5MzQy", "number": 1045, "title": "Add support for encryption/decryption of data using AndroidKeystore", "bodyText": "By request of @AdamBJohnsonx\nThis PR is work-in-progress", "createdAt": "2020-09-22T02:08:13Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045", "merged": true, "mergeCommit": {"oid": "dd8b3e4bf402aeb9baada763f3e8348c0e08eeb0"}, "closed": true, "closedAt": "2020-09-23T01:09:04Z", "author": {"login": "iambmelt"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLNf39gH2gAyNDkwNjQ5MzQyOmU5M2YyYzA3OTNjNmEwMGZkYmVhMzQ2YzFhOGNiMDk4MTk2MTY0OWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLhf17gFqTQ5MzkzMzI0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e93f2c0793c6a00fdbea346c1a8cb0981961649a", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/e93f2c0793c6a00fdbea346c1a8cb0981961649a", "committedDate": "2020-09-22T01:13:59Z", "message": "Stubbing out ciphers, adding support for RSA paddings (encryption)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be", "committedDate": "2020-09-22T02:06:46Z", "message": "WIP - Encryption/decryption support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDg5MDgy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493089082", "createdAt": "2020-09-22T02:10:24Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxMDoyNFrOHVoLQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxMDoyNFrOHVoLQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ0MDM4Ng==", "bodyText": "Javadoc", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492440386", "createdAt": "2020-09-22T02:10:24Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -113,6 +113,42 @@ public String toString() {\n         }\n     }\n \n+    enum Cipher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDg5NTk1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493089595", "createdAt": "2020-09-22T02:12:45Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxMjo0NVrOHVoM9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxMjo0NVrOHVoM9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ0MDgyMg==", "bodyText": "Probably shouldn't even bother to support this", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492440822", "createdAt": "2020-09-22T02:12:45Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -113,6 +113,42 @@ public String toString() {\n         }\n     }\n \n+    enum Cipher {\n+\n+        @RequiresApi(Build.VERSION_CODES.JELLY_BEAN_MR2)\n+        RSA_ECB_PKCS1_PADDING(\"RSA/ECB/PKCS1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA1AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-1AndMGF1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA_224AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-224AndMGF1Padding\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDkwOTc4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493090978", "createdAt": "2020-09-22T02:18:47Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxODo0N1rOHVoRgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMjoxODo0N1rOHVoRgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ0MTk4Nw==", "bodyText": "const", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492441987", "createdAt": "2020-09-22T02:18:47Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +617,42 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        try {\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+            final RSAPublicKey publicKey = (RSAPublicKey) privateKeyEntry.getCertificate().getPublicKey();\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(\n+                    cipher.toString(),\n+                    \"AndroidOpenSSL\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA2MTk4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493106198", "createdAt": "2020-09-22T03:26:25Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjoyNVrOHVpGmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjoyNVrOHVpGmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTU3Ng==", "bodyText": "Use interface", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492455576", "createdAt": "2020-09-22T03:26:25Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +617,42 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        try {\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+            final RSAPublicKey publicKey = (RSAPublicKey) privateKeyEntry.getCertificate().getPublicKey();\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(\n+                    cipher.toString(),\n+                    \"AndroidOpenSSL\"\n+            );\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA2MjE4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493106218", "createdAt": "2020-09-22T03:26:32Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjozMlrOHVpGqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjozMlrOHVpGqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTU5NQ==", "bodyText": "Use interface", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492455595", "createdAt": "2020-09-22T03:26:32Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +617,42 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        try {\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+            final RSAPublicKey publicKey = (RSAPublicKey) privateKeyEntry.getCertificate().getPublicKey();\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(\n+                    cipher.toString(),\n+                    \"AndroidOpenSSL\"\n+            );\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            final CipherOutputStream cipherOutputStream = new CipherOutputStream(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA2MjY0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493106264", "createdAt": "2020-09-22T03:26:42Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjo0MlrOHVpG0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjo0MlrOHVpG0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTYzMw==", "bodyText": "Multi-catch block", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492455633", "createdAt": "2020-09-22T03:26:42Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +617,42 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        try {\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+            final RSAPublicKey publicKey = (RSAPublicKey) privateKeyEntry.getCertificate().getPublicKey();\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(\n+                    cipher.toString(),\n+                    \"AndroidOpenSSL\"\n+            );\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            final CipherOutputStream cipherOutputStream = new CipherOutputStream(\n+                    outputStream,\n+                    input\n+            );\n+            cipherOutputStream.write(plaintext.getBytes(\"UTF-8\"));\n+            cipherOutputStream.close();\n+\n+            byte[] encryptedBase64Data = outputStream.toByteArray();\n+            return Base64.encodeToString(encryptedBase64Data, Base64.DEFAULT);\n+        } catch (Exception e) {\n+            // TODO Cleanup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA2Mjg2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493106286", "createdAt": "2020-09-22T03:26:49Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjo0OVrOHVpG8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyNjo0OVrOHVpG8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTY2Ng==", "bodyText": "throw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492455666", "createdAt": "2020-09-22T03:26:49Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +617,42 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        try {\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+            final RSAPublicKey publicKey = (RSAPublicKey) privateKeyEntry.getCertificate().getPublicKey();\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(\n+                    cipher.toString(),\n+                    \"AndroidOpenSSL\"\n+            );\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            final CipherOutputStream cipherOutputStream = new CipherOutputStream(\n+                    outputStream,\n+                    input\n+            );\n+            cipherOutputStream.write(plaintext.getBytes(\"UTF-8\"));\n+            cipherOutputStream.close();\n+\n+            byte[] encryptedBase64Data = outputStream.toByteArray();\n+            return Base64.encodeToString(encryptedBase64Data, Base64.DEFAULT);\n+        } catch (Exception e) {\n+            // TODO Cleanup\n+        }\n+\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA2NTU0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493106554", "createdAt": "2020-09-22T03:28:07Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyODowN1rOHVpH4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzoyODowN1rOHVpH4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1NTkwNA==", "bodyText": "Remove (deprecated)", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492455904", "createdAt": "2020-09-22T03:28:07Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -113,6 +113,42 @@ public String toString() {\n         }\n     }\n \n+    enum Cipher {\n+\n+        @RequiresApi(Build.VERSION_CODES.JELLY_BEAN_MR2)\n+        RSA_ECB_PKCS1_PADDING(\"RSA/ECB/PKCS1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA1AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-1AndMGF1Padding\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTA4NzQ4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493108748", "createdAt": "2020-09-22T03:38:25Z", "commit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzozODoyNVrOHVpPRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMzozODoyNVrOHVpPRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ1Nzc5Nw==", "bodyText": "\"No padding\" not going to be supported (too insecure, ind-cpa)", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r492457797", "createdAt": "2020-09-22T03:38:25Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -113,6 +113,42 @@ public String toString() {\n         }\n     }\n \n+    enum Cipher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa3c8ca495b1c84ce1d9bc838dccdb64b417be"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc1a53404ca026cffdfd299c602be0d7e9bbce6", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/3bc1a53404ca026cffdfd299c602be0d7e9bbce6", "committedDate": "2020-09-22T04:04:16Z", "message": "Use interface, not concrete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52021d251def0ddbb8826f578d2351f8a73fcb46", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/52021d251def0ddbb8826f578d2351f8a73fcb46", "committedDate": "2020-09-22T04:15:49Z", "message": "Some cleanup around exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1df1e69ac7718eef2b32bb06812d33f42da07b5", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/e1df1e69ac7718eef2b32bb06812d33f42da07b5", "committedDate": "2020-09-22T18:18:17Z", "message": "Merge branch 'dev' into iambmelt/oneauth-pop-extensions-3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ca3dd33865acb27168239c5882f1758cdfa10b", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a0ca3dd33865acb27168239c5882f1758cdfa10b", "committedDate": "2020-09-22T19:03:03Z", "message": "Adding constants for various keystore related errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5a828ae61c0d8dec598c4bf6ca4b3b457c3851", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/ff5a828ae61c0d8dec598c4bf6ca4b3b457c3851", "committedDate": "2020-09-22T19:06:00Z", "message": "Merge branch 'iambmelt/oneauth-pop-extensions-3' of https://github.com/AzureAD/microsoft-authentication-library-common-for-android into iambmelt/oneauth-pop-extensions-3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6240d5cb8f5030f3bd997241f4a2daae90757fd", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c6240d5cb8f5030f3bd997241f4a2daae90757fd", "committedDate": "2020-09-22T19:24:52Z", "message": "Adding javadoc for Cipher, removing ciphers we'll likely never use"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38eafc64420f395ee431c917c737d18bc0279c6e", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/38eafc64420f395ee431c917c737d18bc0279c6e", "committedDate": "2020-09-22T20:15:59Z", "message": "decrypt impl. some code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd11c7f1db7fd7234ac4cadf24e39459787d0517", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/fd11c7f1db7fd7234ac4cadf24e39459787d0517", "committedDate": "2020-09-22T20:17:50Z", "message": "Bugfix for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942d42f096b83398cd29234f46877b987be10aed", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/942d42f096b83398cd29234f46877b987be10aed", "committedDate": "2020-09-22T20:21:57Z", "message": "Removing unused variable (resolve PMD)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODIzMzM0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493823334", "createdAt": "2020-09-22T20:31:44Z", "commit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDozMTo0NVrOHWLQ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDozMTo0NVrOHWLQ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAxNTI3OA==", "bodyText": "Do we not have a Base64Stream running around somewhere?  https://developer.android.com/reference/android/util/Base64InputStream", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493015278", "createdAt": "2020-09-22T20:31:45Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +625,162 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        final String methodName = \":encrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a ref to our public key\n+            final PublicKey publicKey = privateKeyEntry.getCertificate().getPublicKey();\n+\n+            // Init our Cipher\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(cipher.toString());\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+\n+            // Declare an OutputStream to hold our encrypted data\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+\n+            // Wrap it in our CipherOutputStream, write the contents...\n+            final OutputStream cipherOutputStream = new CipherOutputStream(outputStream, input);\n+            cipherOutputStream.write(plaintext.getBytes(ENCODING_UTF8));\n+            cipherOutputStream.close();\n+\n+            // Flatten our OutputStream to an array\n+            byte[] encryptedBase64Data = outputStream.toByteArray();\n+\n+            // Base64 encode to stringify\n+            return Base64.encodeToString(encryptedBase64Data, Base64.DEFAULT);\n+        } catch (final InvalidKeyException e) {\n+            errCode = INVALID_KEY;\n+            exception = e;\n+        } catch (final UnrecoverableEntryException e) {\n+            errCode = INVALID_PROTECTION_PARAMS;\n+            exception = e;\n+        } catch (final NoSuchAlgorithmException e) {\n+            errCode = NO_SUCH_ALGORITHM;\n+            exception = e;\n+        } catch (final KeyStoreException e) {\n+            errCode = KEYSTORE_NOT_INITIALIZED;\n+            exception = e;\n+        } catch (final NoSuchPaddingException e) {\n+            errCode = NO_SUCH_PADDING;\n+            exception = e;\n+        } catch (final UnsupportedEncodingException e) {\n+            errCode = UNSUPPORTED_ENCODING;\n+            exception = e;\n+        } catch (final IOException e) {\n+            errCode = IO_ERROR;\n+            exception = e;\n+        }\n+\n+        final ClientException clientException = new ClientException(\n+                errCode,\n+                exception.getMessage(),\n+                exception\n+        );\n+\n+        Logger.error(\n+                TAG + methodName,\n+                errCode,\n+                exception\n+        );\n+\n+        throw clientException;\n+    }\n+\n+    @Override\n+    public String decrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String ciphertext) throws ClientException {\n+        final String methodName = \":decrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a reference to our private key (will not be loaded into app process)\n+            final PrivateKey privateKey = privateKeyEntry.getPrivateKey();\n+\n+            // Init our cipher instance, don't use a named provider as there seems to be a mix of\n+            // BoringSSL & AndroidOpenSSL\n+            // https://issuetracker.google.com/issues/37091211\n+            final javax.crypto.Cipher outputCipher = javax.crypto.Cipher.getInstance(cipher.toString());\n+            outputCipher.init(javax.crypto.Cipher.DECRYPT_MODE, privateKey);\n+\n+            // Put our ciphertext into an InputStream\n+            final CipherInputStream cipherInputStream = new CipherInputStream(\n+                    new ByteArrayInputStream(\n+                            Base64.decode(\n+                                    ciphertext,\n+                                    Base64.DEFAULT\n+                            )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODI2NjEz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493826613", "createdAt": "2020-09-22T20:36:30Z", "commit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDozNjozMFrOHWLbAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDozNjozMFrOHWLbAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAxNzg1OA==", "bodyText": "This is a lot of copying.  Why not jut put it in a InputStreamReader: https://docs.oracle.com/javase/8/docs/api/java/io/InputStreamReader.html ?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493017858", "createdAt": "2020-09-22T20:36:30Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +625,162 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        final String methodName = \":encrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a ref to our public key\n+            final PublicKey publicKey = privateKeyEntry.getCertificate().getPublicKey();\n+\n+            // Init our Cipher\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(cipher.toString());\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+\n+            // Declare an OutputStream to hold our encrypted data\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+\n+            // Wrap it in our CipherOutputStream, write the contents...\n+            final OutputStream cipherOutputStream = new CipherOutputStream(outputStream, input);\n+            cipherOutputStream.write(plaintext.getBytes(ENCODING_UTF8));\n+            cipherOutputStream.close();\n+\n+            // Flatten our OutputStream to an array\n+            byte[] encryptedBase64Data = outputStream.toByteArray();\n+\n+            // Base64 encode to stringify\n+            return Base64.encodeToString(encryptedBase64Data, Base64.DEFAULT);\n+        } catch (final InvalidKeyException e) {\n+            errCode = INVALID_KEY;\n+            exception = e;\n+        } catch (final UnrecoverableEntryException e) {\n+            errCode = INVALID_PROTECTION_PARAMS;\n+            exception = e;\n+        } catch (final NoSuchAlgorithmException e) {\n+            errCode = NO_SUCH_ALGORITHM;\n+            exception = e;\n+        } catch (final KeyStoreException e) {\n+            errCode = KEYSTORE_NOT_INITIALIZED;\n+            exception = e;\n+        } catch (final NoSuchPaddingException e) {\n+            errCode = NO_SUCH_PADDING;\n+            exception = e;\n+        } catch (final UnsupportedEncodingException e) {\n+            errCode = UNSUPPORTED_ENCODING;\n+            exception = e;\n+        } catch (final IOException e) {\n+            errCode = IO_ERROR;\n+            exception = e;\n+        }\n+\n+        final ClientException clientException = new ClientException(\n+                errCode,\n+                exception.getMessage(),\n+                exception\n+        );\n+\n+        Logger.error(\n+                TAG + methodName,\n+                errCode,\n+                exception\n+        );\n+\n+        throw clientException;\n+    }\n+\n+    @Override\n+    public String decrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String ciphertext) throws ClientException {\n+        final String methodName = \":decrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a reference to our private key (will not be loaded into app process)\n+            final PrivateKey privateKey = privateKeyEntry.getPrivateKey();\n+\n+            // Init our cipher instance, don't use a named provider as there seems to be a mix of\n+            // BoringSSL & AndroidOpenSSL\n+            // https://issuetracker.google.com/issues/37091211\n+            final javax.crypto.Cipher outputCipher = javax.crypto.Cipher.getInstance(cipher.toString());\n+            outputCipher.init(javax.crypto.Cipher.DECRYPT_MODE, privateKey);\n+\n+            // Put our ciphertext into an InputStream\n+            final CipherInputStream cipherInputStream = new CipherInputStream(\n+                    new ByteArrayInputStream(\n+                            Base64.decode(\n+                                    ciphertext,\n+                                    Base64.DEFAULT\n+                            )\n+                    ),\n+                    outputCipher // Our decryption cipher\n+            );\n+\n+            // Declare a List for dynamic sizing\n+            final List<Byte> values = new ArrayList<>();\n+\n+            // Iterate over bytes, adding them to our List\n+            int nextByte;\n+            while ((nextByte = cipherInputStream.read()) != -1) {\n+                values.add((byte) nextByte);\n+            }\n+\n+            final byte[] bytes = new byte[values.size()];\n+\n+            for (int ii = 0; ii < bytes.length; ii++) {\n+                bytes[ii] = values.get(ii);\n+            }\n+\n+            return new String(bytes, 0, bytes.length, ENCODING_SCHEME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "originalPosition": 163}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODMzNzc1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493833775", "createdAt": "2020-09-22T20:46:57Z", "commit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo0Njo1N1rOHWLxWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo0Njo1N1rOHWLxWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyMzU3OA==", "bodyText": "Not going to support this cipher, as it requires use of deprecated sha-1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493023578", "createdAt": "2020-09-22T20:46:57Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/IDevicePopManager.java", "diffHunk": "@@ -113,6 +113,39 @@ public String toString() {\n         }\n     }\n \n+    /**\n+     * Ciphers supported by our underlying keystore. Asymmetric ciphers shown only.\n+     */\n+    enum Cipher {\n+\n+        @RequiresApi(Build.VERSION_CODES.JELLY_BEAN_MR2)\n+        RSA_ECB_PKCS1_PADDING(\"RSA/ECB/PKCS1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA_256AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-256AndMGF1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA_384AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-384AndMGF1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPWithSHA_512AndMGF1Padding(\"RSA/ECB/OAEPWithSHA-512AndMGF1Padding\"),\n+\n+        @RequiresApi(Build.VERSION_CODES.M)\n+        RSA_ECB_OAEPPadding(\"RSA/ECB/OAEPPadding\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d245c0d66ea3dda285fbeec2d03fc859c3e904b2", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d245c0d66ea3dda285fbeec2d03fc859c3e904b2", "committedDate": "2020-09-22T20:47:51Z", "message": "Adding tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODM2MTIz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493836123", "createdAt": "2020-09-22T20:50:16Z", "commit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo1MDoxNlrOHWL4ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo1MDoxNlrOHWL4ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNTM4Ng==", "bodyText": "Similar to my other comments, you may be able to use a Base64OutputStream here.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493025386", "createdAt": "2020-09-22T20:50:16Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +625,162 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        final String methodName = \":encrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a ref to our public key\n+            final PublicKey publicKey = privateKeyEntry.getCertificate().getPublicKey();\n+\n+            // Init our Cipher\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(cipher.toString());\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+\n+            // Declare an OutputStream to hold our encrypted data\n+            final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+\n+            // Wrap it in our CipherOutputStream, write the contents...\n+            final OutputStream cipherOutputStream = new CipherOutputStream(outputStream, input);\n+            cipherOutputStream.write(plaintext.getBytes(ENCODING_UTF8));\n+            cipherOutputStream.close();\n+\n+            // Flatten our OutputStream to an array\n+            byte[] encryptedBase64Data = outputStream.toByteArray();\n+\n+            // Base64 encode to stringify\n+            return Base64.encodeToString(encryptedBase64Data, Base64.DEFAULT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "942d42f096b83398cd29234f46877b987be10aed"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78cd460afdc6f9b4a64848d25463a47591a094c7", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/78cd460afdc6f9b4a64848d25463a47591a094c7", "committedDate": "2020-09-22T20:51:13Z", "message": "Remove unsupported ciphers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84e685554367f6eaaa4d4afccb70e478a944bc0e", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/84e685554367f6eaaa4d4afccb70e478a944bc0e", "committedDate": "2020-09-22T21:27:41Z", "message": "Minor refactor; defer to streams for b64, copy logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02668e90e3683ef1ab9c0ee843f7a1457a2e0c8b", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/02668e90e3683ef1ab9c0ee843f7a1457a2e0c8b", "committedDate": "2020-09-22T22:00:22Z", "message": "CR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODc4MDYw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493878060", "createdAt": "2020-09-22T22:02:35Z", "commit": {"oid": "02668e90e3683ef1ab9c0ee843f7a1457a2e0c8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjowMjozNVrOHWN8Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjowMjozNVrOHWN8Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1OTEwNw==", "bodyText": "Remove this test", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493059107", "createdAt": "2020-09-22T22:02:35Z", "author": {"login": "iambmelt"}, "path": "common/src/androidTest/java/com/microsoft/identity/common/internal/platform/DevicePoPManagerTests.java", "diffHunk": "@@ -366,4 +367,19 @@ public void testAsymmetricKeyHasPublicKeyJwk() throws ClientException {\n         Assert.assertNotNull(n);\n         Assert.assertFalse(n.getAsString().isEmpty());\n     }\n+\n+    @Test\n+    public void testCanEncryptDataPkcs1() throws ClientException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02668e90e3683ef1ab9c0ee843f7a1457a2e0c8b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c2cca65ad65a13ac08017c422345a5147e6598", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c5c2cca65ad65a13ac08017c422345a5147e6598", "committedDate": "2020-09-22T22:04:54Z", "message": "Merge branch 'dev' into iambmelt/oneauth-pop-extensions-3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/76f3122d48004af2fede7113def1337011a6d7f5", "committedDate": "2020-09-22T22:06:18Z", "message": "Removing duplicated test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODk2NTM0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493896534", "createdAt": "2020-09-22T22:44:24Z", "commit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjo0NDoyNFrOHWO4_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjo0NDoyNFrOHWO4_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3NDY4Nw==", "bodyText": "Close in a finally block to avoid any potential resource leaks.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493074687", "createdAt": "2020-09-22T22:44:24Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/platform/DevicePopManager.java", "diffHunk": "@@ -615,6 +626,163 @@ public boolean verify(@NonNull final SigningAlgorithm alg,\n         return false;\n     }\n \n+    @Override\n+    public String encrypt(@NonNull final Cipher cipher,\n+                          @NonNull final String plaintext) throws ClientException {\n+        final String methodName = \":encrypt\";\n+        final String errCode;\n+        final Exception exception;\n+\n+        try {\n+            // Load our key material\n+            final KeyStore.PrivateKeyEntry privateKeyEntry = (KeyStore.PrivateKeyEntry)\n+                    mKeyStore.getEntry(mKeyAlias, null);\n+\n+            // Get a ref to our public key\n+            final PublicKey publicKey = privateKeyEntry.getCertificate().getPublicKey();\n+\n+            // Init our Cipher\n+            final javax.crypto.Cipher input = javax.crypto.Cipher.getInstance(cipher.toString());\n+            input.init(javax.crypto.Cipher.ENCRYPT_MODE, publicKey);\n+\n+            // Declare an OutputStream to hold our encrypted data\n+            final ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n+\n+            // Create a B64Stream to encode our incoming data, and write it to our ByteArrayStream\n+            final Base64OutputStream base64OutputStream = new Base64OutputStream(\n+                    byteArrayOutputStream,\n+                    Base64.DEFAULT\n+            );\n+\n+            // Wrap it in our CipherOutputStream, write the contents...\n+            final OutputStream cipherOutputStream = new CipherOutputStream(base64OutputStream, input);\n+            cipherOutputStream.write(plaintext.getBytes(ENCODING_UTF8));\n+            cipherOutputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODk3OTY2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493897966", "createdAt": "2020-09-22T22:48:04Z", "commit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjo0ODowNFrOHWO9wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjo0ODowNFrOHWO9wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3NTkwNQ==", "bodyText": "For grins, here, maybe make sure that !DATA_TO_ENCRYPT.equals(cipherText)", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#discussion_r493075905", "createdAt": "2020-09-22T22:48:04Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/androidTest/java/com/microsoft/identity/common/internal/platform/DevicePoPManagerEncryptionTests.java", "diffHunk": "@@ -0,0 +1,101 @@\n+//  Copyright (c) Microsoft Corporation.\n+//  All rights reserved.\n+//\n+//  This code is licensed under the MIT License.\n+//\n+//  Permission is hereby granted, free of charge, to any person obtaining a copy\n+//  of this software and associated documentation files(the \"Software\"), to deal\n+//  in the Software without restriction, including without limitation the rights\n+//  to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+//  copies of the Software, and to permit persons to whom the Software is\n+//  furnished to do so, subject to the following conditions :\n+//\n+//  The above copyright notice and this permission notice shall be included in\n+//  all copies or substantial portions of the Software.\n+//\n+//  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+//  THE SOFTWARE.\n+package com.microsoft.identity.common.internal.platform;\n+\n+import android.os.Build;\n+\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.microsoft.identity.common.exception.ClientException;\n+\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+\n+import java.io.IOException;\n+import java.security.KeyStoreException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.CertificateException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.microsoft.identity.common.internal.platform.IDevicePopManager.Cipher.RSA_ECB_OAEPWithSHA_256AndMGF1Padding;\n+import static com.microsoft.identity.common.internal.platform.IDevicePopManager.Cipher.RSA_ECB_OAEPWithSHA_384AndMGF1Padding;\n+import static com.microsoft.identity.common.internal.platform.IDevicePopManager.Cipher.RSA_ECB_OAEPWithSHA_512AndMGF1Padding;\n+import static com.microsoft.identity.common.internal.platform.IDevicePopManager.Cipher.RSA_ECB_PKCS1_PADDING;\n+\n+// Note: Test cannot use robolectric due to the following open issue\n+// https://github.com/robolectric/robolectric/issues/1518\n+@RunWith(Parameterized.class)\n+public class DevicePoPManagerEncryptionTests {\n+\n+    private static final String DATA_TO_ENCRYPT = \"The quick brown fox jumped over the lazy dog.\";\n+\n+    private final IDevicePopManager devicePopManager;\n+    private final IDevicePopManager.Cipher cipher;\n+\n+    @Parameterized.Parameters\n+    public static Iterable<IDevicePopManager.Cipher> testParams() {\n+        final List<IDevicePopManager.Cipher> ciphers = new ArrayList<>();\n+\n+        // Only execute these tests at appropriate API levels...\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            ciphers.add(RSA_ECB_PKCS1_PADDING);\n+        }\n+\n+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\n+            ciphers.add(RSA_ECB_OAEPWithSHA_256AndMGF1Padding);\n+            ciphers.add(RSA_ECB_OAEPWithSHA_384AndMGF1Padding);\n+            ciphers.add(RSA_ECB_OAEPWithSHA_512AndMGF1Padding);\n+        }\n+\n+        return ciphers;\n+    }\n+\n+    public DevicePoPManagerEncryptionTests(final IDevicePopManager.Cipher cipher)\n+            throws CertificateException, NoSuchAlgorithmException, KeyStoreException, IOException {\n+        devicePopManager = new DevicePopManager();\n+        this.cipher = cipher;\n+    }\n+\n+    @Before\n+    public void setUp() throws ClientException {\n+        devicePopManager.generateAsymmetricKey(ApplicationProvider.getApplicationContext());\n+    }\n+\n+    @After\n+    public void tearDown() {\n+        devicePopManager.clearAsymmetricKey();\n+    }\n+\n+    @Test\n+    public void testEncryption() throws ClientException {\n+        final String cipherText = devicePopManager.encrypt(cipher, DATA_TO_ENCRYPT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODk4NDAw", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493898400", "createdAt": "2020-09-22T22:49:15Z", "commit": {"oid": "76f3122d48004af2fede7113def1337011a6d7f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7aff83fe5996f26db6e0af75a48bbf2e2183cb", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/da7aff83fe5996f26db6e0af75a48bbf2e2183cb", "committedDate": "2020-09-22T23:26:14Z", "message": "Finally block to close resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ec108d2f1cec690343eee0713c55b9a4afe2a9d", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/4ec108d2f1cec690343eee0713c55b9a4afe2a9d", "committedDate": "2020-09-22T23:28:22Z", "message": "Add assertion: orig != ciphertext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "789c0b1ff0e1d6b4a06e56f05c1892bf0e39f450", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/789c0b1ff0e1d6b4a06e56f05c1892bf0e39f450", "committedDate": "2020-09-22T23:41:24Z", "message": "Pulling functionality up to AsymmetricKey, AsymmetricRsaKey interfaces.\nImplements encrypt/decrypt for AndroidKeystoreAsymmetricRsaKey."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTMzMjQ3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1045#pullrequestreview-493933247", "createdAt": "2020-09-23T00:32:03Z", "commit": {"oid": "789c0b1ff0e1d6b4a06e56f05c1892bf0e39f450"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1583, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}