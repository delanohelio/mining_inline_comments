{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NjczNjcx", "number": 1018, "title": "Place cap on the number failed request data in Last Request Telemetry at any given time", "bodyText": "Address: https://identitydivision.visualstudio.com/Engineering/_workitems/edit/1081276\nI've put a cap of 100 -- we could go much higher but I've seen that we are generally able to send data relevant to about 50-60 failed requests in a given header (due to header length constraints). So let's say we accumulate 100 items, then we send about 60 of those in the next network request, and we send the remaining 40 in the following one. So this way in the cases where we do accumulate too much telemetry, then we are able to send the most recent and most relevant telemetry in 2 network requests.\nIMO, if we keep more than 100, let's say 200, then all of that may take 4 network requests to reach the server. At that point, the telemetry is probably not that relevant because it is old, and also most likely a developer doing debugging won't look 4 requests back to get all the telemetry. Also generally speaking, most devices that run into accumulating too much telemetry without actually sending it are the devices that keep getting the same error over and over again such as a device network not available error. So there isn't usually a need to know what the remaining errors in the past may have been.\nSo I think a cap of 100 seems most reasonable.", "createdAt": "2020-08-28T22:56:23Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018", "merged": true, "mergeCommit": {"oid": "14a1e36e16c9ee8101ba98edaa8769e5a0e70f71"}, "closed": true, "closedAt": "2020-09-02T22:56:25Z", "author": {"login": "shahzaibj"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDc_kXgH2gAyNDc1NjczNjcxOjZkMzNhMmQ2OTg5MDhkOTc3Zjk2NDQ0MzRmYjkzYTBiYzUxYmFmYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFDxCYAFqTQ4MTM1ODM2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d33a2d698908d977f9644434fb93a0bc51bafad", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/6d33a2d698908d977f9644434fb93a0bc51bafad", "committedDate": "2020-08-28T22:45:47Z", "message": "Put a cap on failed requests saved to cache in last request telemetry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc4bc60c0bf9d67628b3d673517030218bd6650", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2dc4bc60c0bf9d67628b3d673517030218bd6650", "committedDate": "2020-08-28T22:46:18Z", "message": "Add unit test for last request telemetry cap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f1ea0056fe685c82db853ef728ce2681f6da2a50", "committedDate": "2020-08-28T22:46:36Z", "message": "Merge branch 'dev' into shahzaibj/ests-telemetry-size-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963e9b79f53b11b84ca8a12af387bf6c8d666f44", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/963e9b79f53b11b84ca8a12af387bf6c8d666f44", "committedDate": "2020-08-28T23:35:46Z", "message": "Catch OOM while restoring last request telemetry from shared pref"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDY4NjI4", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#pullrequestreview-478068628", "createdAt": "2020-08-28T23:17:22Z", "commit": {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMzoxNzoyMlrOHJWsig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMzozMzoxNlrOHJW4Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MTA4Mg==", "bodyText": "Package-private, right?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479571082", "createdAt": "2020-08-28T23:17:22Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -47,7 +50,7 @@\n     }\n \n     List<FailedRequest> getFailedRequests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3MjkwMA==", "bodyText": "This doesn't take a safe-copy, right?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479572900", "createdAt": "2020-08-28T23:27:10Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -47,7 +50,7 @@\n     }\n \n     List<FailedRequest> getFailedRequests() {\n-        return failedRequests;\n+        return Collections.unmodifiableList(failedRequests);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NDA4Mw==", "bodyText": "I'm not sure at all that this is what we want to do.  subList returns a view on the original list.  So, as I read it, over time you'll end up with an ever expanding chain of references to new sublists (see SubList.subList).\nhttps://cs.android.com/android/platform/superproject/+/master:libcore/ojluni/src/main/java/java/util/ArrayList.java;drc=6bd07db6e4f0806b658fc44bfee5dbef2c409540;l=1007\nIf we're only doing 100 of these, it might be better to just declare your own array and use it like a circular buffer, even though it means you'll have more complex code when somebody requests a view.  I see that this object gets recycled a lot, too.  So this is only a concern for a lot of request failures when this isn't being persisted.\nTo note: this has been fixed in OpenJDK: http://hg.openjdk.java.net/jdk9/jdk9/jdk/rev/d7a4b04e3fc9", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479574083", "createdAt": "2020-08-28T23:33:16Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/LastRequestTelemetry.java", "diffHunk": "@@ -76,10 +79,22 @@ void resetSilentSuccessCount() {\n \n \n     void appendFailedRequest(final String apiId, final String correlationId, final String error) {\n-        failedRequests.add(new FailedRequest(apiId, correlationId, error));\n+        appendFailedRequest(new FailedRequest(apiId, correlationId, error));\n     }\n \n     void appendFailedRequest(final FailedRequest failedRequest) {\n+        // this should usually not be greater than - at most should be equal to the cap\n+        // because the only we to add to this list is via this append method.\n+        // The only time this could be greater than the cap is for some existing devices that may\n+        // have caught themselves in a bad state after accumulating too much telemetry in\n+        // Shared Preferences. (of course prior to the cap being put in place).\n+        // So will just take the last (most recent) 100 items here to get those out of the bad state,\n+        // and also to avoid having too much telemetry in the cache going forward.\n+        if (failedRequests.size() >= FAILED_REQUEST_CAP) {\n+            final int beginIndex = failedRequests.size() - FAILED_REQUEST_CAP + 1;\n+            final int endIndex = failedRequests.size();\n+            failedRequests = failedRequests.subList(beginIndex, endIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1ea0056fe685c82db853ef728ce2681f6da2a50"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e243e0f75a7d427e781d36a7687773162dd1da", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89e243e0f75a7d427e781d36a7687773162dd1da", "committedDate": "2020-08-29T00:03:37Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d71f93b10e05f31e6d3768f07117004b30837621", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d71f93b10e05f31e6d3768f07117004b30837621", "committedDate": "2020-08-29T00:06:32Z", "message": "Improve javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDc4ODYx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#pullrequestreview-478078861", "createdAt": "2020-08-29T00:14:51Z", "commit": {"oid": "d71f93b10e05f31e6d3768f07117004b30837621"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQwMDoxNDo1MVrOHJXVBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQwMDoxNDo1MVrOHJXVBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTQ0NA==", "bodyText": "There's not really any recovery from OOM.", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#discussion_r479581444", "createdAt": "2020-08-29T00:14:51Z", "author": {"login": "AdamBJohnsonx"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/eststelemetry/SharedPreferencesLastRequestTelemetryCache.java", "diffHunk": "@@ -66,28 +66,35 @@ ISharedPreferencesFileManager getSharedPreferencesFileManager() {\n     public synchronized RequestTelemetry getRequestTelemetryFromCache() {\n         final String methodName = \":getRequestTelemetryFromCache\";\n \n-        final String cacheValue = mSharedPreferencesFileManager.getString(LAST_TELEMETRY_OBJECT_CACHE_KEY);\n+        try {\n+            final String cacheValue = mSharedPreferencesFileManager.getString(LAST_TELEMETRY_OBJECT_CACHE_KEY);\n \n-        if (cacheValue == null) {\n-            Logger.info(TAG + methodName, \"There is no last request telemetry saved in \" +\n-                    \"the cache. Returning NULL\");\n+            if (cacheValue == null) {\n+                Logger.info(TAG + methodName, \"There is no last request telemetry saved in \" +\n+                        \"the cache. Returning NULL\");\n \n-            return null;\n-        }\n+                return null;\n+            }\n \n-        try {\n-            LastRequestTelemetry lastRequestTelemetry = mGson.fromJson(cacheValue, LastRequestTelemetry.class);\n+            final LastRequestTelemetry lastRequestTelemetry = mGson.fromJson(cacheValue, LastRequestTelemetry.class);\n \n             if (lastRequestTelemetry == null) {\n                 Logger.warn(TAG + methodName,\n                         \"Last Request Telemetry deserialization failed\");\n             }\n \n             return lastRequestTelemetry;\n-        } catch (JsonSyntaxException e) {\n+        } catch (final JsonSyntaxException e) {\n             Logger.error(TAG + methodName,\n                     \"Last Request Telemetry deserialization failed\", e);\n             return null;\n+        } catch (final OutOfMemoryError e) {\n+            Logger.error(TAG + methodName,\n+                    \"Encountered OOM while restoring last request telemetry from \" +\n+                            \"Shared Preferences. Clearing telemetry cache to recover and returning \" +\n+                            \"null.\", e);\n+            mSharedPreferencesFileManager.clear();\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d71f93b10e05f31e6d3768f07117004b30837621"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46c0d6c54c207dc047a73565127230dbde4aee1", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/f46c0d6c54c207dc047a73565127230dbde4aee1", "committedDate": "2020-09-02T22:02:35Z", "message": "Merge branch 'dev' into shahzaibj/ests-telemetry-size-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d235941d4ed4ffd451cb3e40197f10f30fa652", "author": {"user": {"login": "shahzaibj", "name": "Shahzaib"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/57d235941d4ed4ffd451cb3e40197f10f30fa652", "committedDate": "2020-09-02T22:25:49Z", "message": "Address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMzU4MzY3", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1018#pullrequestreview-481358367", "createdAt": "2020-09-02T22:30:08Z", "commit": {"oid": "57d235941d4ed4ffd451cb3e40197f10f30fa652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1553, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}