{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzA5Mzkz", "number": 794, "title": "Resolves #793 - Fix for Token Caching", "bodyText": "See #793\nRelated:\nAzureAD/microsoft-authentication-library-for-android#904\nThis makes the following changes:\n\nWrite tokens to cache using IdP responses (do not inject default scopes)\nExclude default scopes from intersect criteria", "createdAt": "2020-01-29T00:02:32Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794", "merged": true, "mergeCommit": {"oid": "c1695dd8b29931efa96161e8937eadbf072ef067"}, "closed": true, "closedAt": "2020-02-06T18:56:17Z", "author": {"login": "iambmelt"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-5cDkAH2gAyMzY4MzA5MzkzOmQ4ZGEwNGIwMmIxNTNkN2ZmMWU3OGQxODM5YTQ5ZDRmZmU5MWExOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBuvyPAH2gAyMzY4MzA5MzkzOjJkOWM1MDNiNzg3ZTAyZGVmMzY2NGY4ZTU4M2FiODM0YzE4ZTdiYTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8da04b02b153d7ff1e78d1839a49d4ffe91a197", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d8da04b02b153d7ff1e78d1839a49d4ffe91a197", "committedDate": "2020-01-28T22:53:28Z", "message": "Re: #793\n\nDo not artificially inject default scopes in cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dbb34b2ce4266fab60433c3f140148f53b6d28e", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7dbb34b2ce4266fab60433c3f140148f53b6d28e", "committedDate": "2020-01-28T23:09:39Z", "message": "Removing no longer needed comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89fefb9222e410aba77afe85d574a9119025e135", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/89fefb9222e410aba77afe85d574a9119025e135", "committedDate": "2020-01-28T23:59:44Z", "message": "RE: #793 - Omit DEFAULT_SCOPES from token lookup, only udont inject defaults to cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44b3452a130e64f26fbc5071f41249e77a84c1a8", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/44b3452a130e64f26fbc5071f41249e77a84c1a8", "committedDate": "2020-01-29T00:38:50Z", "message": "Minor formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a81894613239fe6334dcab21b0cffa438588d9", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/40a81894613239fe6334dcab21b0cffa438588d9", "committedDate": "2020-01-29T00:53:07Z", "message": "Update for behavior doc'd in RFC-6749"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/a85a0ea57678202caa705568ee5eaae6da69e6dd", "committedDate": "2020-02-05T23:20:20Z", "message": "Merge branch 'dev' into iambmelt/793"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTIxOTcx", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#pullrequestreview-354121971", "createdAt": "2020-02-05T23:52:54Z", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMzo1Mjo1NVrOFmLM6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMzo1Mjo1NVrOFmLM6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3MzczOQ==", "bodyText": "nit: should we even expose this boolean? (as we always use 'true' as its value)", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r375573739", "createdAt": "2020-02-05T23:52:55Z", "author": {"login": "rpdome"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/AbstractAccountCredentialCache.java", "diffHunk": "@@ -210,13 +212,16 @@\n     /**\n      * Examines the intersections of the provided targets (scopes).\n      *\n-     * @param targetToMatch    The target value[s] our cache-query is looking for.\n-     * @param credentialTarget The target against which our sought value will be compared.\n+     * @param targetToMatch     The target value[s] our cache-query is looking for.\n+     * @param credentialTarget  The target against which our sought value will be compared.\n+     * @param omitDefaultScopes True if MSAL's default scopes should be considered in this lookup.\n+     *                          False otherwise.\n      * @return True, if the credentialTarget contains all of the targets (scopes) declared by\n      * targetToMatch. False otherwise.\n      */\n     static boolean targetsIntersect(@NonNull final String targetToMatch,\n-                                    @NonNull final String credentialTarget) {\n+                                    @NonNull final String credentialTarget,\n+                                    boolean omitDefaultScopes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTMzODQ0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#pullrequestreview-354133844", "createdAt": "2020-02-06T00:28:02Z", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTkyMjIz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#pullrequestreview-354192223", "createdAt": "2020-02-06T04:17:12Z", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNDoxNzoxMlrOFmO2EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNDoxNzoxMlrOFmO2EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzMzQyNQ==", "bodyText": "I think it would be better to use a StringBuilder here as the size of the scope set isn't known and could be big", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#discussion_r375633425", "createdAt": "2020-02-06T04:17:12Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MicrosoftStsAccountCredentialAdapter.java", "diffHunk": "@@ -129,18 +130,27 @@ private String getCredentialType(@NonNull final String tokenType) {\n      * @param responseScope The response scope to parse.\n      * @return The target containing default scopes.\n      */\n-    private String getTarget(@NonNull final String responseScope) {\n-        if (responseScope.contains(AuthenticationConstants.OAuth2Scopes.OPEN_ID_SCOPE)) {\n-            if (responseScope.contains(AuthenticationConstants.OAuth2Scopes.OFFLINE_ACCESS_SCOPE)) {\n-                return responseScope;\n-            } else {\n-                return responseScope + \" \" + AuthenticationConstants.OAuth2Scopes.OFFLINE_ACCESS_SCOPE;\n+    private String getTarget(@NonNull final String requestScope,\n+                             @NonNull final String responseScope) {\n+        String scopesToCache = \"\";\n+\n+        if (TextUtils.isEmpty(responseScope)) {\n+            // The response scopes were empty -- per https://tools.ietf.org/html/rfc6749#section-3.3\n+            // we are going to fall back to a the request scopes minus any default scopes....\n+            final String[] requestScopes = requestScope.split(\"\\\\s+\");\n+            final Set<String> requestScopeSet = new HashSet<>(Arrays.asList(requestScopes));\n+            requestScopeSet.removeAll(DEFAULT_SCOPES);\n+\n+            for (final String scope : requestScopeSet) {\n+                scopesToCache += scope + \" \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTkyODY5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#pullrequestreview-354192869", "createdAt": "2020-02-06T04:20:26Z", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjM2MjIy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/794#pullrequestreview-354636222", "createdAt": "2020-02-06T17:28:42Z", "commit": {"oid": "a85a0ea57678202caa705568ee5eaae6da69e6dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9c503b787e02def3664f8e583ab834c18e7ba3", "author": {"user": {"login": "iambmelt", "name": "Brian Melton-Grace"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/2d9c503b787e02def3664f8e583ab834c18e7ba3", "committedDate": "2020-02-06T18:07:50Z", "message": "Merge branch 'dev' into iambmelt/793"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1723, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}