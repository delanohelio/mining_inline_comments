{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMzcwNTc3", "number": 1130, "title": "(Make changes to) persist refresh token in joined flow.", "bodyText": "related PR: AzureAD/ad-accounts-for-android#1430", "createdAt": "2020-11-16T05:39:08Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130", "merged": true, "mergeCommit": {"oid": "9b188f1d356cb7159c16cea5b0d18ddf546fa94e"}, "closed": true, "closedAt": "2020-11-23T09:44:18Z", "author": {"login": "rpdome"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddAu4pgBqjM5OTkwMjcyNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfOnnpABqjQwMjU5MDk2MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62251b32608d7da2148c649ecb436179735dcb7f", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/62251b32608d7da2148c649ecb436179735dcb7f", "committedDate": "2020-11-16T06:10:45Z", "message": "update test case"}, "afterCommit": {"oid": "096e692924364aba2a587fdb9b27cb6df6b3dcb7", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/096e692924364aba2a587fdb9b27cb6df6b3dcb7", "committedDate": "2020-11-16T08:32:05Z", "message": "persist rt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjkxMDY2", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-533691066", "createdAt": "2020-11-18T17:24:55Z", "commit": {"oid": "f9c375c8b77ffba24e6dfc1c653a6150a5193cca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzoyNDo1NlrOH148bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzoyNDo1NlrOH148bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTU0OA==", "bodyText": "Why changing this?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r526269548", "createdAt": "2020-11-18T17:24:56Z", "author": {"login": "shahzaibj"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/migration/TokenCacheItemMigrationAdapter.java", "diffHunk": "@@ -184,7 +185,7 @@ public static boolean tryFociTokenWithGivenClientId(@SuppressWarnings(WarningTyp\n         final MicrosoftStsOAuth2Strategy strategy = new MicrosoftStsOAuth2Strategy(config, strategyParameters);\n \n         final String refreshToken = refreshTokenRecord.getSecret();\n-        final String scopes = BaseController.getDelimitedDefaultScopeString();\n+        final String scopes = AuthenticationConstants.OAuth2Scopes.OPEN_ID_SCOPE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9c375c8b77ffba24e6dfc1c653a6150a5193cca"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDM1NTM0", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535035534", "createdAt": "2020-11-20T02:50:32Z", "commit": {"oid": "678e290b0bff407b7f2ef8766b0e59520091d1cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjo1MDozMlrOH27g3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjo1MDozMlrOH27g3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MDIyMw==", "bodyText": "I would prefer to see new API + tests added for this, rather than have to increment the major version of common to change this API", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527360223", "createdAt": "2020-11-20T02:50:32Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -180,6 +181,7 @@ public BrokerOAuth2TokenCache(@NonNull Context context,\n     public ICacheRecord save(@NonNull AccountRecord accountRecord,\n                              @NonNull IdTokenRecord idTokenRecord,\n                              @NonNull AccessTokenRecord accessTokenRecord,\n+                             @NonNull RefreshTokenRecord refreshTokenRecord,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e290b0bff407b7f2ef8766b0e59520091d1cd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDM1NjUz", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535035653", "createdAt": "2020-11-20T02:50:55Z", "commit": {"oid": "678e290b0bff407b7f2ef8766b0e59520091d1cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjo1MDo1NVrOH27hOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjo1MDo1NVrOH27hOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2MDMxNA==", "bodyText": "Same here -- this would be a major version break. Let's add new API + tests", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527360314", "createdAt": "2020-11-20T02:50:55Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -243,13 +247,15 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n             @NonNull final AccountRecord accountRecord,\n             @NonNull final IdTokenRecord idTokenRecord,\n             @NonNull final AccessTokenRecord accessTokenRecord,\n+            @NonNull final RefreshTokenRecord refreshTokenRecord,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e290b0bff407b7f2ef8766b0e59520091d1cd"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDM3NDE5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535037419", "createdAt": "2020-11-20T02:56:35Z", "commit": {"oid": "678e290b0bff407b7f2ef8766b0e59520091d1cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "757d62234d9aa478c2ed256e5d92c3db6185e1a6", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/757d62234d9aa478c2ed256e5d92c3db6185e1a6", "committedDate": "2020-11-20T05:36:52Z", "message": "swap"}, "afterCommit": {"oid": "b501200e04c41f52c47e1ad813aaf53adb3595a3", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/b501200e04c41f52c47e1ad813aaf53adb3595a3", "committedDate": "2020-11-20T05:35:14Z", "message": "update test cases / resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjQxNDk1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535641495", "createdAt": "2020-11-20T17:40:02Z", "commit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo0MDowMlrOH3Z98A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzo0MDowMlrOH3Z98A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1OTE4NA==", "bodyText": "@rpdome Can we make the RT @Nullable in this API and have the older API call this one? At a glance, it looks like that would allow for removal of some duplicated code", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527859184", "createdAt": "2020-11-20T17:40:02Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/MsalOAuth2TokenCache.java", "diffHunk": "@@ -219,6 +220,65 @@ ICacheRecord save(@NonNull AccountRecord accountRecord,\n         return result;\n     }\n \n+    /**\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     * @see OAuth2TokenCache#save(AccountRecord, IdTokenRecord)\n+     */\n+    ICacheRecord save(final @NonNull AccountRecord accountRecord,\n+                      final @NonNull IdTokenRecord idTokenRecord,\n+                      final @NonNull AccessTokenRecord accessTokenRecord,\n+                      final @NonNull RefreshTokenRecord refreshTokenRecord) throws ClientException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Njk4NzMy", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535698732", "createdAt": "2020-11-20T18:58:00Z", "commit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo1ODowMVrOH3dEpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo1ODowMVrOH3dEpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMDA1NQ==", "bodyText": "Not immediately clear to me why this result needs to be casted, doesn't this API always return this type?", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527910055", "createdAt": "2020-11-20T18:58:01Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -253,26 +330,51 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n                     familyId\n             );\n \n-            final String clientId = cacheRecord.getAccessToken().getClientId();\n-            final String target = cacheRecord.getAccessToken().getTarget();\n-            final String environment = cacheRecord.getAccessToken().getEnvironment();\n+            return loadAggregatedAccountData(authScheme, cacheRecord);\n+        }\n+    }\n \n-            // Now get the cache we just saved to....\n-            final MsalOAuth2TokenCache cache = getTokenCacheForClient(\n-                    clientId,\n-                    environment,\n-                    mCallingProcessUid\n+    public synchronized List<ICacheRecord> saveAndLoadAggregatedAccountData(\n+            final @NonNull AccountRecord accountRecord,\n+            final @NonNull IdTokenRecord idTokenRecord,\n+            final @NonNull AccessTokenRecord accessTokenRecord,\n+            final @NonNull RefreshTokenRecord refreshTokenRecord,\n+            final @Nullable String familyId,\n+            final @NonNull AbstractAuthenticationScheme authScheme) throws ClientException {\n+        synchronized (this) {\n+            final ICacheRecord cacheRecord = save(\n+                    accountRecord,\n+                    idTokenRecord,\n+                    accessTokenRecord,\n+                    refreshTokenRecord,\n+                    familyId\n             );\n \n-            return (List<ICacheRecord>) cache.loadWithAggregatedAccountData(\n-                    clientId,\n-                    target,\n-                    cacheRecord.getAccount(),\n-                    authScheme\n-            );\n+            return loadAggregatedAccountData(authScheme, cacheRecord);\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private List<ICacheRecord> loadAggregatedAccountData(final @NonNull AbstractAuthenticationScheme authScheme,\n+                                                         final @NonNull ICacheRecord cacheRecord) {\n+        final String clientId = cacheRecord.getAccessToken().getClientId();\n+        final String target = cacheRecord.getAccessToken().getTarget();\n+        final String environment = cacheRecord.getAccessToken().getEnvironment();\n+\n+        final MsalOAuth2TokenCache cache = getTokenCacheForClient(\n+                clientId,\n+                environment,\n+                mCallingProcessUid\n+        );\n+\n+        return (List<ICacheRecord>) cache.loadWithAggregatedAccountData(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "originalPosition": 161}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Njk4OTE1", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535698915", "createdAt": "2020-11-20T18:58:16Z", "commit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo1ODoxN1rOH3dFKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODo1ODoxN1rOH3dFKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMDE4NQ==", "bodyText": "Nit: params final", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#discussion_r527910185", "createdAt": "2020-11-20T18:58:17Z", "author": {"login": "iambmelt"}, "path": "common/src/main/java/com/microsoft/identity/common/internal/cache/BrokerOAuth2TokenCache.java", "diffHunk": "@@ -238,7 +240,82 @@ public ICacheRecord save(@NonNull AccountRecord accountRecord,\n         return result;\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n+    /**\n+     * Broker-only API to persist WPJ's Accounts & their associated credentials.\n+     *\n+     * @param accountRecord      The {@link AccountRecord} to store.\n+     * @param idTokenRecord      The {@link IdTokenRecord} to store.\n+     * @param accessTokenRecord  The {@link AccessTokenRecord} to store.\n+     * @param refreshTokenRecord The {@link RefreshTokenRecord} to store.\n+     * @param familyId           The family_id or null, if not applicable.\n+     * @return The {@link ICacheRecord} result of this save action.\n+     * @throws ClientException If the supplied Accounts or Credentials are schema invalid.\n+     */\n+    public ICacheRecord save(@NonNull AccountRecord accountRecord,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1Njk5MzY5", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1130#pullrequestreview-535699369", "createdAt": "2020-11-20T18:58:53Z", "commit": {"oid": "3d7223d0671df07b35fce79b86475c51dde949bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "303733bea169b5fc290848ec736bbe26608e2340", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/303733bea169b5fc290848ec736bbe26608e2340", "committedDate": "2020-11-23T05:50:41Z", "message": "(Make changes to) persist refresh token in joined flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c89acb3dc25b69c7cd316dd21468c98db360fd56", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/c89acb3dc25b69c7cd316dd21468c98db360fd56", "committedDate": "2020-11-23T05:48:21Z", "message": "Address comments"}, "afterCommit": {"oid": "303733bea169b5fc290848ec736bbe26608e2340", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/303733bea169b5fc290848ec736bbe26608e2340", "committedDate": "2020-11-23T05:50:41Z", "message": "(Make changes to) persist refresh token in joined flow"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1429, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}