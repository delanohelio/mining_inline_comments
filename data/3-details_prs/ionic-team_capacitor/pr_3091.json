{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMTI2Njc2", "number": 3091, "title": "feat(cli): Allow to use capacitor commands in custom platforms", "bodyText": "This is a POC\nIt allows to have custom platforms in Capacitor\nExample platform https://github.com/jcesarmobile/test-platform\nSteps to test:\n\nInstall custom platform: npm install https://github.com/jcesarmobile/test-platform\nRun capacitor CLI commands by passing the platform name:  examples npx cap add @jcesarmobile/test-platform, npx cap copy @jcesarmobile/test-platform, npx cap update @jcesarmobile/test-platform, npx cap sync @jcesarmobile/test-platform, npx cap open @jcesarmobile/test-platform.\n\nCustom platforms need 4 scripts in scripts section of package.json (not all mandatory if the platform don't need them, but will show an error)\n\"scripts\": {\n    \"capacitor:add\": \"script to run on npx cap add\",\n    \"capacitor:copy\": \"script to run on npx cap copy\",\n    \"capacitor:update\": \"script to run on npx cap  update\",\n    \"capacitor:open\": \"script to run on npx cap  open\"\n  }\n\nsync runs copy + update\nAt first I also did a npx cap add customPlatorm command that just ran npm install on the custom platform (could be http url, npm package, local folder, etc. whatever npm install supports), but then thought it might not be a good idea as it install the package and might install the wrong thing if the user type it wrong, so I think it's better not to wrap it and just tell the user to use npm install", "createdAt": "2020-06-11T14:41:22Z", "url": "https://github.com/ionic-team/capacitor/pull/3091", "merged": true, "mergeCommit": {"oid": "6aedfde8f07136afbb9288a6f0b7a97c3a0b58ee"}, "closed": true, "closedAt": "2020-07-01T20:27:44Z", "author": {"login": "jcesarmobile"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqPFHgAH2gAyNDMzMTI2Njc2OjA5ZTVjNTQzMjFkNmY2OGRlYWJiMDQ4MTYyN2M1OWQ3NDY5YWM2NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwuC5vgH2gAyNDMzMTI2Njc2OjFhZGU4ZWQ2M2ZhZTBmMGIxMTM2YzFmMTlkNTFmNTM2ZDM0NGM4ZTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09e5c54321d6f68deabb0481627c59d7469ac672", "author": {"user": {"login": "jcesarmobile", "name": "jcesarmobile"}}, "url": "https://github.com/ionic-team/capacitor/commit/09e5c54321d6f68deabb0481627c59d7469ac672", "committedDate": "2020-06-11T14:25:04Z", "message": "feat(cli): Allow to use capacitor commands in custom platforms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODYyMTU5", "url": "https://github.com/ionic-team/capacitor/pull/3091#pullrequestreview-431862159", "createdAt": "2020-06-16T20:22:31Z", "commit": {"oid": "09e5c54321d6f68deabb0481627c59d7469ac672"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDoyMjozMlrOGkrxHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDoyMzo0OVrOGkrzhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTAwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run copy`);\n          \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:copy`);", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119007", "createdAt": "2020-06-16T20:22:32Z", "author": {"login": "imhoffd"}, "path": "cli/src/tasks/copy.ts", "diffHunk": "@@ -10,15 +10,25 @@ import { getCordovaPlugins, handleCordovaPluginsJS, writeCordovaAndroidManifest\n import chalk from 'chalk';\n \n export async function copyCommand(config: Config, selectedPlatformName: string) {\n-  const platforms = config.selectPlatforms(selectedPlatformName);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to copy yet. Create one with \\`capacitor create\\`.`);\n-    return;\n-  }\n-  try {\n-    await allSerial(platforms.map(platformName => () => copy(config, platformName)));\n-  } catch (e) {\n-    logError(e);\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run copy`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09e5c54321d6f68deabb0481627c59d7469ac672"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTExMw==", "bodyText": "We should probably not do this. sync = copy + update, so we should just run npm run capacitor:copy followed by npm run capacitor:sync. What do you think?", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119113", "createdAt": "2020-06-16T20:22:46Z", "author": {"login": "imhoffd"}, "path": "cli/src/tasks/sync.ts", "diffHunk": "@@ -1,28 +1,38 @@\n import { Config } from '../config';\n import { copy } from './copy';\n import { update, updateChecks } from './update';\n-import { check, checkPackage, checkWebDir, log, logError, logFatal, logInfo } from '../common';\n+import { check, checkPackage, checkWebDir, hasYarn, log, logError, logFatal, logInfo, resolveNode, runCommand } from '../common';\n \n import { allSerial } from '../util/promise';\n \n /**\n  * Sync is a copy and an update in one.\n  */\n-export async function syncCommand(config: Config, selectedPlatform: string, deployment: boolean) {\n-  const then = +new Date;\n-  const platforms = config.selectPlatforms(selectedPlatform);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to sync yet. Create one with \"capacitor create\".`);\n-    return;\n-  }\n-  try {\n-    await check(config, [checkPackage, checkWebDir, ...updateChecks(config, platforms)]);\n-    await allSerial(platforms.map(platformName => () => sync(config, platformName, deployment)));\n-    const now = +new Date;\n-    const diff = (now - then) / 1000;\n-    log(`Sync finished in ${diff}s`);\n-  } catch (e) \u00a0{\n-    logFatal(e);\n+export async function syncCommand(config: Config, selectedPlatformName: string, deployment: boolean) {\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run sync`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09e5c54321d6f68deabb0481627c59d7469ac672"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTYyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run update`);\n          \n          \n            \n                  const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:update`);", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r441119621", "createdAt": "2020-06-16T20:23:49Z", "author": {"login": "imhoffd"}, "path": "cli/src/tasks/update.ts", "diffHunk": "@@ -2,29 +2,39 @@ import { Config } from '../config';\n import { updateAndroid } from '../android/update';\n import { updateIOS, updateIOSChecks } from '../ios/update';\n import { allSerial } from '../util/promise';\n-import { CheckFunction, check, checkPackage, log, logError, logFatal, logInfo, runTask } from '../common';\n+import { CheckFunction, check, checkPackage, hasYarn, log, logError, logFatal, logInfo, resolveNode, runCommand, runTask } from '../common';\n \n import chalk from 'chalk';\n \n export async function updateCommand(config: Config, selectedPlatformName: string, deployment: boolean) {\n-  const then = +new Date;\n-  const platforms = config.selectPlatforms(selectedPlatformName);\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to update yet. Create one with \"capacitor create\".`);\n-    return;\n-  }\n-  try {\n-    await check(\n-      config,\n-      [checkPackage, ...updateChecks(config, platforms)]\n-    );\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolveNode(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run update`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09e5c54321d6f68deabb0481627c59d7469ac672"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3b03baff44c90e186d2f18fbd333ef83957e911", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/e3b03baff44c90e186d2f18fbd333ef83957e911", "committedDate": "2020-06-23T20:50:33Z", "message": "Merge branch 'master' into custom-platforms-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338c9d71c9a2347fd92a416cc5fa011f619ac952", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/338c9d71c9a2347fd92a416cc5fa011f619ac952", "committedDate": "2020-06-23T20:52:34Z", "message": "Update cli/src/tasks/update.ts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1435c88e13e9176e2c4dba7eb5f95d4f15243e01", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/1435c88e13e9176e2c4dba7eb5f95d4f15243e01", "committedDate": "2020-06-23T20:52:40Z", "message": "Update cli/src/tasks/copy.ts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "386709d8c30d9a5c3c23b74641bdb1b0d08b5653", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/386709d8c30d9a5c3c23b74641bdb1b0d08b5653", "committedDate": "2020-06-23T20:58:16Z", "message": "copy + update for sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c9fe0a5e7a777f8dd23a5199d9352b42efdc9fd", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/2c9fe0a5e7a777f8dd23a5199d9352b42efdc9fd", "committedDate": "2020-06-23T21:03:32Z", "message": "lint fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a3328b877d63356d636cfe3d257e8670b796fd7", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/8a3328b877d63356d636cfe3d257e8670b796fd7", "committedDate": "2020-06-23T21:09:39Z", "message": "get add working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c841145815d3d04580b2f95fb6d7c63016bf084a", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/c841145815d3d04580b2f95fb6d7c63016bf084a", "committedDate": "2020-06-23T21:19:36Z", "message": "implement platform resolution\n\nref: https://github.com/ionic-team/capacitor/pull/3091#issuecomment-644997288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1b38e8d2a4ed39708c8a8ff0d408cfcb1ef30d", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/4b1b38e8d2a4ed39708c8a8ff0d408cfcb1ef30d", "committedDate": "2020-06-26T18:21:12Z", "message": "Merge branch 'master' into custom-platforms-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5089ebacf37d0c132e4aa6f6253177e2cf81d2fc", "author": {"user": {"login": "IT-MikeS", "name": "Mike Summerfeldt"}}, "url": "https://github.com/ionic-team/capacitor/commit/5089ebacf37d0c132e4aa6f6253177e2cf81d2fc", "committedDate": "2020-06-26T19:13:07Z", "message": "fix: support console output for platform hooks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fb7bca3aad0536a3f6245e172f6af70c0aeaf91", "author": {"user": {"login": "IT-MikeS", "name": "Mike Summerfeldt"}}, "url": "https://github.com/ionic-team/capacitor/commit/6fb7bca3aad0536a3f6245e172f6af70c0aeaf91", "committedDate": "2020-06-26T19:36:37Z", "message": "fix: create runPlatformHook func"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de53ac870fef34449aace48529b7ee425781fdc1", "author": {"user": {"login": "IT-MikeS", "name": "Mike Summerfeldt"}}, "url": "https://github.com/ionic-team/capacitor/commit/de53ac870fef34449aace48529b7ee425781fdc1", "committedDate": "2020-06-26T19:39:39Z", "message": "fix: missed comment removal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04065b53c3d2f724658653d309600306bc649154", "author": {"user": {"login": "IT-MikeS", "name": "Mike Summerfeldt"}}, "url": "https://github.com/ionic-team/capacitor/commit/04065b53c3d2f724658653d309600306bc649154", "committedDate": "2020-06-26T19:42:58Z", "message": "chore: import reshuffle to alpha sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8349ad768b5b578394bcb682a28e5682a9e574dd", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/8349ad768b5b578394bcb682a28e5682a9e574dd", "committedDate": "2020-06-26T23:41:45Z", "message": "Merge pull request #1 from IT-MikeS/custom-platforms-poc\n\nfix: support console output for platform hooks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565b218dce0ea89885be37e156a7cdf34f13d08e", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/565b218dce0ea89885be37e156a7cdf34f13d08e", "committedDate": "2020-06-29T17:16:06Z", "message": "open command for custom platforms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzU0Mzcx", "url": "https://github.com/ionic-team/capacitor/pull/3091#pullrequestreview-439354371", "createdAt": "2020-06-29T17:27:18Z", "commit": {"oid": "565b218dce0ea89885be37e156a7cdf34f13d08e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoyNzoxOFrOGqa6qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoyNzoxOFrOGqa6qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNDM3Ng==", "bodyText": "Shouldn't this be runPlatformHook instead?", "url": "https://github.com/ionic-team/capacitor/pull/3091#discussion_r447134376", "createdAt": "2020-06-29T17:27:18Z", "author": {"login": "IT-MikeS"}, "path": "cli/src/tasks/open.ts", "diffHunk": "@@ -1,26 +1,35 @@\n import { Config } from '../config';\n-import { logFatal, logInfo, runTask } from '../common';\n+import { hasYarn, log, logError, logFatal, logInfo, resolvePlatform, runCommand, runTask } from '../common';\n import { openAndroid } from '../android/open';\n import { openElectron } from '../electron/open';\n import { openIOS } from '../ios/open';\n \n-export async function openCommand(config: Config, selectedPlatform: string) {\n-  const platforms = config.selectPlatforms(selectedPlatform);\n-  let platformName: string;\n-  if (platforms.length === 0) {\n-    logInfo(`There are no platforms to open yet. Create one with \"capacitor add\".`);\n-    return;\n-  } else if (platforms.length === 1) {\n-    platformName = platforms[0];\n+export async function openCommand(config: Config, selectedPlatformName: string) {\n+  if (selectedPlatformName && !config.isValidPlatform(selectedPlatformName)) {\n+    const platformFolder = resolvePlatform(config, selectedPlatformName);\n+    if (platformFolder) {\n+      const result = await runCommand(`cd \"${platformFolder}\" && ${await hasYarn(config) ? 'yarn' : 'npm'} run capacitor:open`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565b218dce0ea89885be37e156a7cdf34f13d08e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf44a6711b0ec16929b912b6a2c5a137e2b2025", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/5bf44a6711b0ec16929b912b6a2c5a137e2b2025", "committedDate": "2020-06-29T17:44:16Z", "message": "use runPlatformHook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0400160bbef76d4993ac3c9b466d554520038bd3", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/0400160bbef76d4993ac3c9b466d554520038bd3", "committedDate": "2020-06-29T17:45:16Z", "message": "oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cacf5af8ec78ae09ddf322afe61490eba34dfe11", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/cacf5af8ec78ae09ddf322afe61490eba34dfe11", "committedDate": "2020-06-29T18:25:32Z", "message": "Merge branch 'master' into custom-platforms-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ade8ed63fae0f0b1136c1f19d51f536d344c8e7", "author": {"user": {"login": "jcesarmobile", "name": "jcesarmobile"}}, "url": "https://github.com/ionic-team/capacitor/commit/1ade8ed63fae0f0b1136c1f19d51f536d344c8e7", "committedDate": "2020-07-01T17:53:15Z", "message": "Merge branch 'master' into custom-platforms-poc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1189, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}