{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODA4MzY3", "number": 3787, "title": "refactor(Android): deprecate savedLastCall on Plugin class to use Bridge instead, simplify permission result flow", "bodyText": "This PR deprecates the saving of PluginCalls on the Plugin object and instead centralizes the behavior using the savedCalls map on the Bridge. Both fields remain functional while deprecated.\nChanges:\n- Plugins overriding onRequestPermissionsResult should use getPermissionCall() to access the saved call and release the call when the permission response has been handled. savedLastCall is no longer used in conjunction with the new @CapacitorPlugin annotation and permissions updates.\n\nPlugins overriding onRequestPermissionsResult will have the saved call passed in from the Bridge to use.\nCalls in conjunction with permissions are saved in a queue now on the Bridge, which respects the order in which requests were received to the plugin and responds in the appropriate order. Previous savedLastCall had potential to be overwritten.\nhandleOnActivityResult contains a new parameter lastPluginCall to reference the bridge pluginCallForLastActivity instead of it being saved to the plugin savedLastCall", "createdAt": "2020-11-10T22:43:43Z", "url": "https://github.com/ionic-team/capacitor/pull/3787", "merged": true, "mergeCommit": {"oid": "e1b1cfe4c76e35c1e5ffe56bf18c5ebd53d6a263"}, "closed": true, "closedAt": "2020-11-24T18:22:10Z", "author": {"login": "carlpoole"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbRPKIAH2gAyNTE4ODA4MzY3Ojk5MzNmNDVhOTIwN2Y0MDgxMDY3ZWQyYTc1NmIxZmIxMTQ0YTc4ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdftNK2AH2gAyNTE4ODA4MzY3OjRmMDg0MTRmMDgxNjg4YmEyMzNiY2RjMzEyMDE4YWJlNGNlM2IwMGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9933f45a9207f4081067ed2a756b1fb1144a7886", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/9933f45a9207f4081067ed2a756b1fb1144a7886", "committedDate": "2020-11-10T22:38:08Z", "message": "Deprecated savedLastCall in lieu of using the bridge to store plugin calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5562082303c6579fa33173556faaa9095eed9f4d", "author": {"user": {"login": "jcesarmobile", "name": "jcesarmobile"}}, "url": "https://github.com/ionic-team/capacitor/commit/5562082303c6579fa33173556faaa9095eed9f4d", "committedDate": "2020-11-13T18:15:18Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5edabace2274d38215b46c0da8b8c4149a61b79", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/b5edabace2274d38215b46c0da8b8c4149a61b79", "committedDate": "2020-11-20T16:50:11Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96448d93a5f59bfd52d65b64a4aa9f665bf5012d", "author": {"user": {"login": "jcesarmobile", "name": "jcesarmobile"}}, "url": "https://github.com/ionic-team/capacitor/commit/96448d93a5f59bfd52d65b64a4aa9f665bf5012d", "committedDate": "2020-11-20T17:33:14Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjU0OTQz", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-535654943", "createdAt": "2020-11-20T17:55:44Z", "commit": {"oid": "96448d93a5f59bfd52d65b64a4aa9f665bf5012d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjY2NjY4", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-535666668", "createdAt": "2020-11-20T18:09:34Z", "commit": {"oid": "96448d93a5f59bfd52d65b64a4aa9f665bf5012d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODowOTozNFrOH3bh1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxODowOTozNFrOH3bh1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4NDc1Ng==", "bodyText": "Do you think this still promotes an undesirable workflow where plugin devs are using a single variable to store multiple call IDs? I am almost of the opinion the plugin dev should be fully responsible for managing their call IDs. What do you think?", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r527884756", "createdAt": "2020-11-20T18:09:34Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Plugin.java", "diffHunk": "@@ -46,10 +46,24 @@\n     // Reference to the PluginHandle wrapper for this Plugin\n     protected PluginHandle handle;\n \n-    // A way for plugins to quickly save a call that they will\n-    // need to reference between activity/permissions starts/requests\n+    /**\n+     * A way for plugins to quickly save a call that they will need to reference\n+     * between activity/permissions starts/requests\n+     *\n+     * @deprecated use {@link #savedLastCallId} instead in conjunction with bridge methods\n+     * {@link com.getcapacitor.Bridge#saveCall(PluginCall)},\n+     * {@link com.getcapacitor.Bridge#getSavedCall(String)} and\n+     * {@link com.getcapacitor.Bridge#releaseCall(PluginCall)}\n+     */\n+    @Deprecated\n     protected PluginCall savedLastCall;\n \n+    /**\n+     * The call ID of a saved plugin call on the Bridge. This can be used to persist a call\n+     * between activity lifecycle changes or permission requests.\n+     */\n+    protected String savedLastCallId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96448d93a5f59bfd52d65b64a4aa9f665bf5012d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453255a4ed1bb1175f34ad47f9bf5ad0d0f75697", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/453255a4ed1bb1175f34ad47f9bf5ad0d0f75697", "committedDate": "2020-11-20T20:02:53Z", "message": "Further deprecation, permission specific call saving"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c83564b623929d0cdc10d0f1d4c80c2b73891178", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/c83564b623929d0cdc10d0f1d4c80c2b73891178", "committedDate": "2020-11-20T20:03:23Z", "message": "Merge branch 'saved-calls' of github.com:ionic-team/capacitor into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14a57bcad031f4b3f2c54cd65256424980adbaf", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/e14a57bcad031f4b3f2c54cd65256424980adbaf", "committedDate": "2020-11-20T20:21:44Z", "message": "Updated comments. Ensures deprecated method still works if plugin not updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "043cced700b7d5b46bac5c7cc389f4670c0c6275", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/043cced700b7d5b46bac5c7cc389f4670c0c6275", "committedDate": "2020-11-20T20:28:07Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ccbb61a50d12e5f0437c1d160c16bc5002edcd5", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/1ccbb61a50d12e5f0437c1d160c16bc5002edcd5", "committedDate": "2020-11-20T20:50:56Z", "message": "pass pluginCallForLastActivity to handleOnActivityResult instead of setting on the plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4cc0d056d170dab63f64edef85aaaf404792466", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/c4cc0d056d170dab63f64edef85aaaf404792466", "committedDate": "2020-11-20T21:11:10Z", "message": "Remove release call, just poll the saved call in the new get method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODA0Nzgw", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-535804780", "createdAt": "2020-11-20T21:58:34Z", "commit": {"oid": "c4cc0d056d170dab63f64edef85aaaf404792466"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMTo1ODozNFrOH3iI1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMTo1ODozNFrOH3iI1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5MzA0NQ==", "bodyText": "We should document that this dequeues the call ID now. Since this is no longer idempotent, a rename may be warranted as well.", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r527993045", "createdAt": "2020-11-20T21:58:34Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Plugin.java", "diffHunk": "@@ -184,7 +184,7 @@ public PluginCall getSavedCall() {\n      * @return The saved plugin call\n      */\n     protected PluginCall getPermissionCall() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4cc0d056d170dab63f64edef85aaaf404792466"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdea1b0d83e0597649ab2b55e4e25743c91a7ea6", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/cdea1b0d83e0597649ab2b55e4e25743c91a7ea6", "committedDate": "2020-11-21T23:44:43Z", "message": "moved lots of permission helper code to the bridge, simplifying override requirements for plugins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzI0NTI5", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-536724529", "createdAt": "2020-11-23T18:06:22Z", "commit": {"oid": "cdea1b0d83e0597649ab2b55e4e25743c91a7ea6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODowNjoyMlrOH4ZcpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODoxMTo1MlrOH4Zofw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5OTIzNg==", "bodyText": "I don't think this is accurate any longer", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r528899236", "createdAt": "2020-11-23T18:06:22Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -713,13 +758,136 @@ public void onRequestPermissionsResult(int requestCode, String[] permissions, in\n         }\n \n         if (plugin.getPluginAnnotation() != null) {\n-            plugin.getInstance().onRequestPermissionsResult(requestCode, permissions, grantResults);\n+            // Handle for @CapacitorPlugin permissions\n+            PluginCall savedPermissionCall = getPermissionCall(plugin.getId());\n+            if (savedPermissionCall != null) {\n+                if (validatePermissions(plugin.getInstance(), savedPermissionCall, permissions, grantResults)) {\n+                    // handle request permissions call\n+                    if (savedPermissionCall.getMethodName().equals(\"requestPermissions\")) {\n+                        savedPermissionCall.resolve(getPermissionStates(plugin.getInstance()));\n+                    } else {\n+                        // handle permission requests by other methods on the plugin\n+                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, requestCode, permissions, grantResults);\n+\n+                        if (!savedPermissionCall.isReleased()) {\n+                            savedPermissionCall.release(this);\n+                        }\n+                    }\n+                }\n+            }\n         } else {\n             // Call deprecated method if using deprecated NativePlugin annotation\n             plugin.getInstance().handleRequestPermissionsResult(requestCode, permissions, grantResults);\n         }\n     }\n \n+    /**\n+     * Saves permission states and rejects if permissions were not correctly defined in\n+     * the AndroidManifest.xml file.\n+     *\n+     * Plugins overriding {@link #onRequestPermissionsResult(int, String[], int[])} should call\n+     * this method to save permission states correctly.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdea1b0d83e0597649ab2b55e4e25743c91a7ea6"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMDE4Ng==", "bodyText": "Does this need to be public?", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r528900186", "createdAt": "2020-11-23T18:08:11Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -614,6 +627,38 @@ public void releaseCall(PluginCall call) {\n         this.savedCalls.remove(call.getCallbackId());\n     }\n \n+    /**\n+     * Removes the earliest saved call prior to a permissions request for a given plugin and\n+     * returns it.\n+     *\n+     * @return The saved plugin call\n+     */\n+    protected PluginCall getPermissionCall(String pluginId) {\n+        LinkedList<String> permissionCallIds = this.savedPermissionCallIds.get(pluginId);\n+        String savedCallId = null;\n+        if (permissionCallIds != null) {\n+            savedCallId = permissionCallIds.poll();\n+        }\n+\n+        return getSavedCall(savedCallId);\n+    }\n+\n+    /**\n+     * Save a call to be retrieved after requesting permissions. Calls are saved in order.\n+     *\n+     * @param call The plugin call to save.\n+     */\n+    public void savePermissionCall(PluginCall call) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdea1b0d83e0597649ab2b55e4e25743c91a7ea6"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMjI3MQ==", "bodyText": "We should make this protected. If the API needs to be exposed to the plugin developer, we can make a helper in the Plugin class that just does this.bridge.getPermissionStates(this) (so the usage would be this.getPermissionStates(), much cleaner).", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r528902271", "createdAt": "2020-11-23T18:11:52Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -713,13 +758,136 @@ public void onRequestPermissionsResult(int requestCode, String[] permissions, in\n         }\n \n         if (plugin.getPluginAnnotation() != null) {\n-            plugin.getInstance().onRequestPermissionsResult(requestCode, permissions, grantResults);\n+            // Handle for @CapacitorPlugin permissions\n+            PluginCall savedPermissionCall = getPermissionCall(plugin.getId());\n+            if (savedPermissionCall != null) {\n+                if (validatePermissions(plugin.getInstance(), savedPermissionCall, permissions, grantResults)) {\n+                    // handle request permissions call\n+                    if (savedPermissionCall.getMethodName().equals(\"requestPermissions\")) {\n+                        savedPermissionCall.resolve(getPermissionStates(plugin.getInstance()));\n+                    } else {\n+                        // handle permission requests by other methods on the plugin\n+                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, requestCode, permissions, grantResults);\n+\n+                        if (!savedPermissionCall.isReleased()) {\n+                            savedPermissionCall.release(this);\n+                        }\n+                    }\n+                }\n+            }\n         } else {\n             // Call deprecated method if using deprecated NativePlugin annotation\n             plugin.getInstance().handleRequestPermissionsResult(requestCode, permissions, grantResults);\n         }\n     }\n \n+    /**\n+     * Saves permission states and rejects if permissions were not correctly defined in\n+     * the AndroidManifest.xml file.\n+     *\n+     * Plugins overriding {@link #onRequestPermissionsResult(int, String[], int[])} should call\n+     * this method to save permission states correctly.\n+     *\n+     * @param plugin\n+     * @param savedCall\n+     * @param permissions\n+     * @param grantResults\n+     * @return true if permissions were saved and defined correctly, false if not\n+     */\n+    protected boolean validatePermissions(Plugin plugin, PluginCall savedCall, String[] permissions, int[] grantResults) {\n+        SharedPreferences prefs = getContext().getSharedPreferences(PERMISSION_PREFS_NAME, Activity.MODE_PRIVATE);\n+\n+        if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {\n+            // Permission granted. If previously denied, remove cached state\n+            for (String permission : permissions) {\n+                String state = prefs.getString(permission, null);\n+\n+                if (state != null) {\n+                    SharedPreferences.Editor editor = prefs.edit();\n+                    editor.remove(permission);\n+                    editor.apply();\n+                }\n+            }\n+        } else {\n+            for (String permission : permissions) {\n+                SharedPreferences.Editor editor = prefs.edit();\n+\n+                if (ActivityCompat.shouldShowRequestPermissionRationale(getActivity(), permission)) {\n+                    // Permission denied, can prompt again with rationale\n+                    editor.putString(permission, \"prompt-with-rationale\");\n+                } else {\n+                    // Permission denied permanently, store this state for future reference\n+                    editor.putString(permission, \"denied\");\n+                }\n+\n+                editor.apply();\n+            }\n+        }\n+\n+        if (!plugin.hasDefinedPermissions(permissions)) {\n+            StringBuilder builder = new StringBuilder();\n+            builder.append(\"Missing the following permissions in AndroidManifest.xml:\\n\");\n+            String[] missing = PermissionHelper.getUndefinedPermissions(getContext(), permissions);\n+            for (String perm : missing) {\n+                builder.append(perm + \"\\n\");\n+            }\n+            savedCall.reject(builder.toString());\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+\n+    /**\n+     * Helper to check all permissions and see the current states of each permission.\n+     *\n+     * @since 3.0.0\n+     * @return A mapping of permissions to the associated granted status.\n+     */\n+    public JSObject getPermissionStates(Plugin plugin) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdea1b0d83e0597649ab2b55e4e25743c91a7ea6"}, "originalPosition": 187}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec0d4e45c7a8225de7a7b4010e1eaf7436d6343b", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/ec0d4e45c7a8225de7a7b4010e1eaf7436d6343b", "committedDate": "2020-11-23T19:38:29Z", "message": "Reduced visibility of bridge methods, refactored helpers on Plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abce56a4f308c8c548349a83b26e10a68f1a1b1c", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/abce56a4f308c8c548349a83b26e10a68f1a1b1c", "committedDate": "2020-11-23T19:39:27Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6309e414d175bbbedb87c7148c2f7c2f6bd06b", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/9e6309e414d175bbbedb87c7148c2f7c2f6bd06b", "committedDate": "2020-11-23T19:45:15Z", "message": "comment cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzkyMjg4", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-536792288", "createdAt": "2020-11-23T19:45:01Z", "commit": {"oid": "abce56a4f308c8c548349a83b26e10a68f1a1b1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOTo0NTowMVrOH4cx3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOTo0NTowMVrOH4cx3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk1MzgyMQ==", "bodyText": "This may need to be documented for plugin devs", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r528953821", "createdAt": "2020-11-23T19:45:01Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Plugin.java", "diffHunk": "@@ -255,105 +267,87 @@ public boolean hasRequiredPermissions() {\n     }\n \n     /**\n-     * Exported plugin call for checking the granted status for each permission\n-     * declared on the plugin. This plugin call responds with a mapping of permissions to\n-     * the associated granted status.\n+     * Helper to make requesting individual permissions easy\n      *\n      * @since 3.0.0\n+     * @param call the plugin call\n+     * @param permission the permission to request\n+     * @param requestCode the requestCode to use to associate the result with the plugin\n      */\n-    @PluginMethod\n-    public void checkPermissions(PluginCall pluginCall) {\n-        JSObject permissionsResult = getPermissionStates();\n-        pluginCall.resolve(permissionsResult);\n+    public void requestPermission(PluginCall call, String permission, int requestCode) {\n+        requestPermissions(call, new String[] { permission }, requestCode);\n     }\n \n     /**\n-     * Helper to check all permissions and see the current states of each permission.\n+     * Helper to make requesting permissions\n      *\n      * @since 3.0.0\n-     * @return A mapping of permissions to the associated granted status.\n+     * @param call the plugin call\n+     * @param permissions the set of permissions to request\n+     * @param requestCode the requestCode to use to associate the result with the plugin\n      */\n-    public JSObject getPermissionStates() {\n-        JSObject permissionsResults = new JSObject();\n-        CapacitorPlugin annotation = handle.getPluginAnnotation();\n-        for (Permission perm : annotation.permissions()) {\n-            // If a permission is defined with no permission constants, return \"granted\" for it.\n-            // Otherwise, get its true state.\n-            if (perm.strings().length == 0 || (perm.strings().length == 1 && perm.strings()[0].isEmpty())) {\n-                String key = perm.alias();\n-                if (!key.isEmpty()) {\n-                    String existingResult = permissionsResults.getString(key);\n-\n-                    // auto set permission state to granted if the alias is empty.\n-                    if (existingResult == null) {\n-                        permissionsResults.put(key, \"granted\");\n-                    }\n-                }\n-            } else {\n-                for (String permString : perm.strings()) {\n-                    String key = perm.alias().isEmpty() ? permString : perm.alias();\n-                    String permissionStatus = hasPermission(permString) ? \"granted\" : \"prompt\";\n-\n-                    // Check if there is a cached permission state for the \"Never ask again\" state\n-                    if (permissionStatus.equals(\"prompt\")) {\n-                        SharedPreferences prefs = getContext().getSharedPreferences(PERMISSION_PREFS, Activity.MODE_PRIVATE);\n-                        String state = prefs.getString(permString, null);\n-\n-                        if (state != null) {\n-                            permissionStatus = state;\n-                        }\n-                    }\n-\n-                    String existingResult = permissionsResults.getString(key);\n+    public void requestPermissions(PluginCall call, String[] permissions, int requestCode) {\n+        bridge.savePermissionCall(call);\n+        ActivityCompat.requestPermissions(getActivity(), permissions, requestCode);\n+    }\n \n-                    // multiple permissions with the same alias must all be true, otherwise all false.\n-                    if (existingResult == null || existingResult.equals(\"granted\")) {\n-                        permissionsResults.put(key, permissionStatus);\n-                    }\n-                }\n+    /**\n+     * Request all of the specified permissions in the CapacitorPlugin annotation (if any)\n+     *\n+     * @since 3.0.0\n+     * @param call the plugin call\n+     */\n+    public void requestAllPermissions(PluginCall call) {\n+        CapacitorPlugin annotation = handle.getPluginAnnotation();\n+        if (annotation != null) {\n+            HashSet<String> perms = new HashSet<>();\n+            for (Permission perm : annotation.permissions()) {\n+                perms.addAll(Arrays.asList(perm.strings()));\n             }\n-        }\n \n-        return permissionsResults;\n+            bridge.savePermissionCall(call);\n+            ActivityCompat.requestPermissions(getActivity(), perms.toArray(new String[0]), annotation.permissionRequestCode());\n+        }\n     }\n \n     /**\n      * Helper to make requesting permissions easy\n+     * @deprecated use {@link #requestPermissions(PluginCall)} in conjunction with @CapacitorPlugin\n+     *\n      * @param permissions the set of permissions to request\n      * @param requestCode the requestCode to use to associate the result with the plugin\n      */\n+    @Deprecated\n     public void pluginRequestPermissions(String[] permissions, int requestCode) {\n         ActivityCompat.requestPermissions(getActivity(), permissions, requestCode);\n     }\n \n     /**\n      * Request all of the specified permissions in the CapacitorPlugin annotation (if any)\n+     * @deprecated use {@link #requestAllPermissions(PluginCall)} in conjunction with @CapacitorPlugin\n      */\n+    @Deprecated\n     public void pluginRequestAllPermissions() {\n-        CapacitorPlugin annotation = handle.getPluginAnnotation();\n-        if (annotation == null) {\n-            NativePlugin legacyAnnotation = handle.getLegacyPluginAnnotation();\n-            ActivityCompat.requestPermissions(getActivity(), legacyAnnotation.permissions(), legacyAnnotation.permissionRequestCode());\n-            return;\n-        }\n-\n-        HashSet<String> perms = new HashSet<>();\n-        for (Permission perm : annotation.permissions()) {\n-            perms.addAll(Arrays.asList(perm.strings()));\n-        }\n-\n-        ActivityCompat.requestPermissions(getActivity(), perms.toArray(new String[0]), annotation.permissionRequestCode());\n+        NativePlugin legacyAnnotation = handle.getLegacyPluginAnnotation();\n+        ActivityCompat.requestPermissions(getActivity(), legacyAnnotation.permissions(), legacyAnnotation.permissionRequestCode());\n     }\n \n     /**\n      * Helper to make requesting individual permissions easy\n+     * @deprecated use {@link #requestPermission(PluginCall, String, int)} in conjunction with @CapacitorPlugin\n+     *\n      * @param permission the permission to request\n      * @param requestCode the requestCode to use to associate the result with the plugin\n      */\n+    @Deprecated\n     public void pluginRequestPermission(String permission, int requestCode) {\n         ActivityCompat.requestPermissions(getActivity(), new String[] { permission }, requestCode);\n     }\n \n+    public JSObject getPermissionStates() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abce56a4f308c8c548349a83b26e10a68f1a1b1c"}, "originalPosition": 211}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52a1163f0e9bf116322bc0501d10c96ecffd774", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/f52a1163f0e9bf116322bc0501d10c96ecffd774", "committedDate": "2020-11-23T19:51:18Z", "message": "missed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODAxNDIw", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-536801420", "createdAt": "2020-11-23T19:58:35Z", "commit": {"oid": "f52a1163f0e9bf116322bc0501d10c96ecffd774"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOTo1ODozNVrOH4dOng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOTo1ODozNVrOH4dOng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk2MTE4Mg==", "bodyText": "Is this intended for plugins devs to use?", "url": "https://github.com/ionic-team/capacitor/pull/3787#discussion_r528961182", "createdAt": "2020-11-23T19:58:35Z", "author": {"login": "imhoffd"}, "path": "android/capacitor/src/main/java/com/getcapacitor/Plugin.java", "diffHunk": "@@ -255,105 +267,93 @@ public boolean hasRequiredPermissions() {\n     }\n \n     /**\n-     * Exported plugin call for checking the granted status for each permission\n-     * declared on the plugin. This plugin call responds with a mapping of permissions to\n-     * the associated granted status.\n+     * Helper for requesting a specific permission\n      *\n      * @since 3.0.0\n+     * @param call the plugin call\n+     * @param permission the permission to request\n+     * @param requestCode the requestCode to use to associate the result with the plugin\n      */\n-    @PluginMethod\n-    public void checkPermissions(PluginCall pluginCall) {\n-        JSObject permissionsResult = getPermissionStates();\n-        pluginCall.resolve(permissionsResult);\n+    public void requestPermission(PluginCall call, String permission, int requestCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f52a1163f0e9bf116322bc0501d10c96ecffd774"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODE2MjI3", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-536816227", "createdAt": "2020-11-23T20:21:11Z", "commit": {"oid": "f52a1163f0e9bf116322bc0501d10c96ecffd774"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzAyOTQ1", "url": "https://github.com/ionic-team/capacitor/pull/3787#pullrequestreview-537702945", "createdAt": "2020-11-24T16:39:25Z", "commit": {"oid": "f52a1163f0e9bf116322bc0501d10c96ecffd774"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ba65401fc10fa9b79941227e54ac86c74f128f3", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/4ba65401fc10fa9b79941227e54ac86c74f128f3", "committedDate": "2020-11-24T16:44:20Z", "message": "Merge branch 'main' into saved-calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f08414f081688ba233bcdc312018abe4ce3b00b", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/4f08414f081688ba233bcdc312018abe4ce3b00b", "committedDate": "2020-11-24T17:29:00Z", "message": "Merge branch 'main' into saved-calls"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1101, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}