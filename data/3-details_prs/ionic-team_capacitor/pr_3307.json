{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MTkxMjgw", "number": 3307, "title": "fix(android): LocalNotification `on` not working properly", "bodyText": "I've read the contributing docs and I hope I'm doing this properly, please feel free to educate me on how to best approach this.\nI needed to use the cron-like on notifications on a project of mine to make daily notifications happen at a certain time (like every day at 8:30 am) and noticed the Android implementation didn't work properly. On iOS, it all appears to be handled by DateComponents, but on Android it's got a more complex custom implementation.\nIt's a bit hard to find documentation, but after examining the native code, it appears that the on style notifications are supposed to let you:\n\npass a minute and have a notification repeat each hour (passing 15 would trigger every hour at :15)\npass an hour and a minute and have a notification repeat each day (passing 14 and 30 would result in a notification at 2:30pm each day, exactly my use case and what led me to investigate this)\npass a day, hour, and minute and have a notification repeat for example on the 5th of every month at 8:30am.\npass a month, day, hour, and minute and have a notification repeat each year for example on May 1st at 3pm.\n\nI could be wrong in my understanding, of course.\nOn the iOS side, Apple's documentation for DateComponents isn't very clear, tbh.\nGoogling turned up some problems people were having (link, link), and I ran into my own issues as well. When trying to have a notification fire on the hour, it sometimes fired not on the hour, and if I passed hour and minute, I would sometimes get a notification that triggered at the next whole hour instead of the next day, and when I passed hour and omitted minute, I ended up with a notification that repeated ad infinitum as soon as I dismissed it, etc.\nThe\u00a0existing logic appeared to be incomplete. It calculates the next time the notification should fire by first taking the current moment, setting the provided hour, minute etc, seeing if the resulting trigger time is in the past, and then bumping it by a certain amount. But it was only comparing to see if one unit was less than another (i.e. if hour < hour or if minute < minute), and sometimes it bumped by the wrong amount. Now it compares the timestamp of the two dates and explicitly remembers how much each iteration of the notification should be advanced by, according to the largest unit specified.\nI've fixed it for my use case, i.e. I can pass hour and minute, and if device time is 2:15pm and I schedule it for 2:30pm, it goes off 15 min later, and if device time is 2:30 pm and I schedule it for 2:15pm, it schedules for the next day at 2:15pm. I left a logging statement commented out in the code for now that helped me test it and verify it's working - I expect to remove it before merge. The logic should be sound for the longer-repeating cases as well, though I haven't tested those on-device yet (I can certainly do that if I'm going about this right).\nPlease let me know how to proceed next, I am very impressed with this platform and am excited to be building my app on it, and if I can also contribute something back, so much the better. Thanks!", "createdAt": "2020-07-21T06:46:27Z", "url": "https://github.com/ionic-team/capacitor/pull/3307", "merged": true, "mergeCommit": {"oid": "15af432094bb83fb78919db134a2cb0d8eda305d"}, "closed": true, "closedAt": "2020-07-24T18:21:26Z", "author": {"login": "kheftel"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3iTHTABqjM1Nzc3NDM1NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4IICwAH2gAyNDU0MTkxMjgwOjkzMWJlMzIxMDlkZDMwNWZhYTNkNDgwMjE0ODFjZWMxNWIzNzFhYTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e855035199629a7e3042c407740ae0714a42a94d", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/e855035199629a7e3042c407740ae0714a42a94d", "committedDate": "2020-07-22T20:33:41Z", "message": "fix: bugfix after testing more repeating notifs"}, "afterCommit": {"oid": "74213c05c4eb0705ea57b1895c48ca4b18eb034b", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/74213c05c4eb0705ea57b1895c48ca4b18eb034b", "committedDate": "2020-07-22T22:02:41Z", "message": "fix: bugfix after testing more repeating notifs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74213c05c4eb0705ea57b1895c48ca4b18eb034b", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/74213c05c4eb0705ea57b1895c48ca4b18eb034b", "committedDate": "2020-07-22T22:02:41Z", "message": "fix: bugfix after testing more repeating notifs"}, "afterCommit": {"oid": "2c9b5e1bcbc9f444797544b5751d851d547646ad", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/2c9b5e1bcbc9f444797544b5751d851d547646ad", "committedDate": "2020-07-20T17:19:55Z", "message": "fix(cli): avoid npm gitignore rename on new plugins (#3292)\n\nCo-authored-by: jcesarmobile <jcesarmobile@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff244b3a76711f197ae390a049a0288c07bb51b", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/9ff244b3a76711f197ae390a049a0288c07bb51b", "committedDate": "2020-07-22T23:07:16Z", "message": "fix(android): LocalNotification `on` not working properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc58d9c75f9f6fbf2da4b05f9a2fe151972afec", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/5fc58d9c75f9f6fbf2da4b05f9a2fe151972afec", "committedDate": "2020-07-23T20:43:46Z", "message": "Removed logging and commented out method after testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb4f89b289e22398d76c9b8ca8c4ea306dc280a4", "author": {"user": {"login": "carlpoole", "name": "Carl Poole"}}, "url": "https://github.com/ionic-team/capacitor/commit/bb4f89b289e22398d76c9b8ca8c4ea306dc280a4", "committedDate": "2020-07-23T20:53:43Z", "message": "Changed these logs to debug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTY0MDQ0", "url": "https://github.com/ionic-team/capacitor/pull/3307#pullrequestreview-454964044", "createdAt": "2020-07-24T15:06:01Z", "commit": {"oid": "bb4f89b289e22398d76c9b8ca8c4ea306dc280a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNTowNjowMVrOG2y_hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNTowNjowMVrOG2y_hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDExMTc0OQ==", "bodyText": "I don't think it's related to your change, but I've noticed that on Android, when using on, the notification is fired at the same second it was scheduled, while on iOS it's fired on second 0.\nExample, I want to fire a notification at 19:10\nOn iOS it fires at 19:10:00\nOn Android it fires at 19:10:XY, where XY can be any second based on the second it was scheduled, so can be any value from 00 to 59, there could be almost 1 minute of difference.\nI think it makes more sense iOS behavior, if you set it to \"minute 10\" it should fire at exact 10 minute and 0 seconds, not to an unpredictable second.\nI've accomplished that by adding this line\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \n          \n          \n            \n                next.set(Calendar.SECOND, 0);\n          \n      \n    \n    \n  \n\nIf you think it makes sense, accept the suggestion by using the \"commit suggestion\" button.", "url": "https://github.com/ionic-team/capacitor/pull/3307#discussion_r460111749", "createdAt": "2020-07-24T15:06:01Z", "author": {"login": "jcesarmobile"}, "path": "android/capacitor/src/main/java/com/getcapacitor/plugin/notification/DateMatch.java", "diffHunk": "@@ -92,46 +92,47 @@ public long nextTrigger(Date date) {\n    * Postpone trigger if first schedule matches the past\n    */\n   private long postponeTriggerIfNeeded(Calendar current, Calendar next) {\n-    int currentYear = current.get(Calendar.YEAR);\n-    if (matchesUnit(Calendar.YEAR, current, next)) {\n-      next.set(Calendar.YEAR, currentYear + 1);\n-      this.unit = Calendar.YEAR;\n-    } else if (matchesUnit(Calendar.MONTH, current, next)) {\n-      next.set(Calendar.YEAR, currentYear + 1);\n-      this.unit = Calendar.MONTH;\n-    } else if (matchesUnit(Calendar.DAY_OF_MONTH, current, next)) {\n-      next.set(Calendar.MONTH, current.get(Calendar.MONTH) + 1);\n-      this.unit = Calendar.DAY_OF_MONTH;\n-    } else if (matchesUnit(Calendar.HOUR_OF_DAY, current, next)) {\n-      next.set(Calendar.DAY_OF_MONTH, current.get(Calendar.DAY_OF_MONTH) + 1);\n-      this.unit = Calendar.DAY_OF_MONTH;\n-    } else if (matchesUnit(Calendar.MINUTE, current, next)) {\n-      next.set(Calendar.HOUR_OF_DAY, current.get(Calendar.HOUR_OF_DAY) + 1);\n-      this.unit = Calendar.MINUTE;\n+    if (next.getTimeInMillis() <= current.getTimeInMillis() && unit != -1) {\n+      Integer incrementUnit = -1;\n+      if (unit == Calendar.YEAR || unit == Calendar.MONTH) {\n+        incrementUnit = Calendar.YEAR;\n+      } else if (unit == Calendar.DAY_OF_MONTH) {\n+        incrementUnit = Calendar.MONTH;\n+      } else if (unit == Calendar.HOUR_OF_DAY) {\n+        incrementUnit = Calendar.DAY_OF_MONTH;\n+      } else if (unit == Calendar.MINUTE) {\n+        incrementUnit = Calendar.HOUR_OF_DAY;\n+      }\n+\n+      if (incrementUnit != -1) {\n+        next.set(incrementUnit, next.get(incrementUnit) + 1);\n+      }\n     }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb4f89b289e22398d76c9b8ca8c4ea306dc280a4"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTY1Mzkx", "url": "https://github.com/ionic-team/capacitor/pull/3307#pullrequestreview-454965391", "createdAt": "2020-07-24T15:07:44Z", "commit": {"oid": "bb4f89b289e22398d76c9b8ca8c4ea306dc280a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "243c69f3a90581c34fc19a30cf638be6307c053d", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/243c69f3a90581c34fc19a30cf638be6307c053d", "committedDate": "2020-07-24T17:52:01Z", "message": "Update android/capacitor/src/main/java/com/getcapacitor/plugin/notification/DateMatch.java\n\nCo-authored-by: jcesarmobile <jcesarmobile@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MDgxNjI2", "url": "https://github.com/ionic-team/capacitor/pull/3307#pullrequestreview-455081626", "createdAt": "2020-07-24T17:57:41Z", "commit": {"oid": "243c69f3a90581c34fc19a30cf638be6307c053d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac48412f0e29280e0ce210fad6d2398071f84bb8", "author": {"user": {"login": "kheftel", "name": null}}, "url": "https://github.com/ionic-team/capacitor/commit/ac48412f0e29280e0ce210fad6d2398071f84bb8", "committedDate": "2020-07-24T17:58:50Z", "message": "fix: zero calendar millisecond and second in DateMatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "931be32109dd305faa3d48021481cec15b371aa7", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/931be32109dd305faa3d48021481cec15b371aa7", "committedDate": "2020-07-24T18:13:52Z", "message": "Merge branch '2.x' into android-localnotif-on-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1129, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}