{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMjc1MDg5", "number": 3533, "title": "refactor(cli): config refactor", "bodyText": "Config class replaced with a function that returns a readonly object\ndeleted unused properties\nresolveNode now just uses require.resolve with most statements changed to resolve to root of packages using each package's package.json", "createdAt": "2020-09-10T01:56:10Z", "url": "https://github.com/ionic-team/capacitor/pull/3533", "merged": true, "mergeCommit": {"oid": "c8a0595e0f36bae69f0471be481c858266e6768b"}, "closed": true, "closedAt": "2020-09-22T16:20:41Z", "author": {"login": "imhoffd"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHUQD8gH2gAyNDgzMjc1MDg5OjhjM2QzZTA5NjVlN2Q4NGVlMTgyOTMzOGMxODBhODAxMjMzZTQzZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLW--dAFqTQ5MzM5NjQ4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c3d3e0965e7d84ee1829338c180a801233e43ff", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/8c3d3e0965e7d84ee1829338c180a801233e43ff", "committedDate": "2020-09-09T22:50:21Z", "message": "strip params from check functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2762d7fb5303665f1799e83b6cc8eee04839bfec", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/2762d7fb5303665f1799e83b6cc8eee04839bfec", "committedDate": "2020-09-09T23:19:29Z", "message": "resolveNode doesn't need config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1510d5397d59810d67564688565b906801decf", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/ca1510d5397d59810d67564688565b906801decf", "committedDate": "2020-09-10T00:32:43Z", "message": "remove public config methods and unused properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "172f594ad35af59716ffaede3991323527596abe", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/172f594ad35af59716ffaede3991323527596abe", "committedDate": "2020-09-10T01:26:59Z", "message": "config refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5381669fcec5ab87cc3106f6f8b125fa9c73919e", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/5381669fcec5ab87cc3106f6f8b125fa9c73919e", "committedDate": "2020-09-10T01:41:23Z", "message": "readonly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8665579235e43bd4ba0cacaf8a58fc3d140fe1fd", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/8665579235e43bd4ba0cacaf8a58fc3d140fe1fd", "committedDate": "2020-09-10T01:52:17Z", "message": "bug fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2c4f92a58850736d4c74ddfe789da02ce805fb6", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/b2c4f92a58850736d4c74ddfe789da02ce805fb6", "committedDate": "2020-09-10T02:11:27Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b0f13af57b7ddd9d5347cf46edd88bd29525b4f", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/5b0f13af57b7ddd9d5347cf46edd88bd29525b4f", "committedDate": "2020-09-10T16:10:54Z", "message": "be more clear about resolving package.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff836cba2144c86864e01e8ee87b36771653ea4b", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/ff836cba2144c86864e01e8ee87b36771653ea4b", "committedDate": "2020-09-14T22:07:18Z", "message": "Merge branch 'main' into config-refactor\n\nConflicts:\n\tcli/src/android/add.ts\n\tcli/src/android/common.ts\n\tcli/src/android/doctor.ts\n\tcli/src/android/open.ts\n\tcli/src/android/update.ts\n\tcli/src/common.ts\n\tcli/src/config.ts\n\tcli/src/cordova.ts\n\tcli/src/index.ts\n\tcli/src/ios/add.ts\n\tcli/src/ios/common.ts\n\tcli/src/ios/doctor.ts\n\tcli/src/ios/open.ts\n\tcli/src/ios/update.ts\n\tcli/src/plugin.ts\n\tcli/src/tasks/add.ts\n\tcli/src/tasks/copy.ts\n\tcli/src/tasks/create.ts\n\tcli/src/tasks/doctor.ts\n\tcli/src/tasks/init.ts\n\tcli/src/tasks/list.ts\n\tcli/src/tasks/new-plugin.ts\n\tcli/src/tasks/open.ts\n\tcli/src/tasks/serve.ts\n\tcli/src/tasks/sync.ts\n\tcli/src/tasks/update.ts\n\tcli/src/web/copy.ts\n\tcli/test/util.ts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ee8be99c0d0e2bb19030da505b438573f79fd9", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/a9ee8be99c0d0e2bb19030da505b438573f79fd9", "committedDate": "2020-09-16T00:14:51Z", "message": "Merge branch 'main' into config-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16ce02cae9808249907030745c9aefc740db34ec", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/16ce02cae9808249907030745c9aefc740db34ec", "committedDate": "2020-09-17T21:46:06Z", "message": "Merge branch 'main' into config-refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzY4MTEw", "url": "https://github.com/ionic-team/capacitor/pull/3533#pullrequestreview-491368110", "createdAt": "2020-09-18T11:11:30Z", "commit": {"oid": "16ce02cae9808249907030745c9aefc740db34ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMToxMTozMFrOHUIn9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMToxMTozMFrOHUIn9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3NDg2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                cordovaSwiftVersion: '5.0',\n          \n          \n            \n                cordovaSwiftVersion: '5.1',\n          \n      \n    \n    \n  \n\nWe updated the Capacitor version to 5.1, so this one should be probably updated too", "url": "https://github.com/ionic-team/capacitor/pull/3533#discussion_r490874868", "createdAt": "2020-09-18T11:11:30Z", "author": {"login": "jcesarmobile"}, "path": "cli/src/config.ts", "diffHunk": "@@ -1,354 +1,156 @@\n-/* eslint-disable */\n-import { accessSync, readFileSync } from 'fs';\n-import { basename, join, resolve } from 'path';\n-import prompts from 'prompts';\n-\n-import c from './colors';\n-import { logFatal, readJSON } from './common';\n-import { CliConfig, ExternalConfig, OS, PackageJson } from './definitions';\n+import { readJSON } from 'fs-extra';\n+import { dirname, join, resolve } from 'path';\n+\n+import type {\n+  Config,\n+  ExternalConfig,\n+  CLIConfig,\n+  AndroidConfig,\n+  IOSConfig,\n+  PackageJson,\n+} from './definitions';\n+import { OS } from './definitions';\n+\n+export const EXTERNAL_CONFIG_FILE = 'capacitor.config.json';\n+\n+export async function loadConfig(): Promise<Config> {\n+  const appRootDir = process.cwd();\n+  const cliRootDir = dirname(__dirname);\n+  const extConfig = await loadExternalConfig(\n+    resolve(appRootDir, EXTERNAL_CONFIG_FILE),\n+  );\n+\n+  const appId = extConfig.appId ?? '';\n+  const appName = extConfig.appName ?? '';\n+  const webDir = extConfig.webDir ?? 'www';\n+  const cli = await loadCLIConfig(cliRootDir);\n+\n+  return {\n+    windows: {\n+      androidStudioPath:\n+        'C:\\\\Program Files\\\\Android\\\\Android Studio\\\\bin\\\\studio64.exe',\n+    },\n+    linux: {\n+      androidStudioPath: '/usr/local/android-studio/bin/studio.sh',\n+    },\n+    android: await loadAndroidConfig(appRootDir, cli.assetsDir),\n+    ios: await loadIOSConfig(appRootDir, cli.assetsDir),\n+    web: {\n+      name: 'web',\n+    },\n+    cli,\n+    app: {\n+      rootDir: appRootDir,\n+      appId,\n+      appName,\n+      webDir,\n+      webDirAbs: resolve(appRootDir, webDir),\n+      package: (await readPackageJSON(resolve(appRootDir, 'package.json'))) ?? {\n+        name: appName,\n+        version: '1.0.0',\n+      },\n+      extConfigName: EXTERNAL_CONFIG_FILE,\n+      extConfigFilePath: resolve(appRootDir, EXTERNAL_CONFIG_FILE),\n+      extConfig,\n+      bundledWebRuntime: extConfig.bundledWebRuntime ?? false,\n+    },\n+  };\n+}\n \n-let Package: PackageJson;\n-let ExtConfig: ExternalConfig;\n+async function loadCLIConfig(rootDir: string): Promise<CLIConfig> {\n+  const assetsName = 'assets';\n \n-export class Config implements CliConfig {\n-  windows = {\n-    androidStudioPath:\n-      'C:\\\\Program Files\\\\Android\\\\Android Studio\\\\bin\\\\studio64.exe',\n+  return {\n+    rootDir,\n+    assetsName,\n+    assetsDir: join(rootDir, assetsName),\n+    package: await readJSON(resolve(rootDir, 'package.json')),\n+    os: determineOS(process.platform),\n   };\n+}\n \n-  linux = {\n-    androidStudioPath: '/usr/local/android-studio/bin/studio.sh',\n-  };\n+async function loadAndroidConfig(\n+  rootDir: string,\n+  assetDir: string,\n+): Promise<AndroidConfig> {\n+  const name = 'android';\n+  const platformDir = resolve(rootDir, name);\n+  const webDir = 'app/src/main/assets/public';\n+  const resDir = 'app/src/main/res';\n+\n+  const templateName = 'android-template';\n+  const pluginsFolderName = 'capacitor-cordova-android-plugins';\n \n-  android = {\n-    name: 'android',\n+  return {\n+    name,\n     minVersion: '21',\n-    platformDir: '',\n-    webDir: 'app/src/main/assets/public',\n-    webDirAbs: '',\n-    resDir: 'app/src/main/res',\n-    resDirAbs: '',\n+    platformDir,\n+    webDir,\n+    webDirAbs: resolve(platformDir, webDir),\n+    resDir,\n+    resDirAbs: resolve(platformDir, resDir),\n     assets: {\n-      templateName: 'android-template',\n-      pluginsFolderName: 'capacitor-cordova-android-plugins',\n-      templateDir: '',\n-      pluginsDir: '',\n+      templateName,\n+      pluginsFolderName,\n+      templateDir: resolve(assetDir, templateName),\n+      pluginsDir: resolve(assetDir, pluginsFolderName),\n     },\n   };\n+}\n \n-  ios = {\n-    name: 'ios',\n+async function loadIOSConfig(\n+  rootDir: string,\n+  assetDir: string,\n+): Promise<IOSConfig> {\n+  const name = 'ios';\n+  const platformDir = resolve(rootDir, name);\n+  const webDir = 'public';\n+  const nativeProjectName = 'App';\n+  const templateName = 'ios-template';\n+  const pluginsFolderName = 'capacitor-cordova-ios-plugins';\n+\n+  return {\n+    name,\n     minVersion: '11.0',\n     cordovaSwiftVersion: '5.0',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16ce02cae9808249907030745c9aefc740db34ec"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "151a41f3b06e32c969fe5f54b48426f2432edad9", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/151a41f3b06e32c969fe5f54b48426f2432edad9", "committedDate": "2020-09-18T16:40:29Z", "message": "Update cli/src/config.ts\n\nCo-authored-by: jcesarmobile <jcesarmobile@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be4e89d5a07bb530de54878a893ffaf403d73636", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/be4e89d5a07bb530de54878a893ffaf403d73636", "committedDate": "2020-09-18T17:25:08Z", "message": "show plugin config last when adding it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf2ac8f3e6b48cb6682e4770860a45e4478c089", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/8cf2ac8f3e6b48cb6682e4770860a45e4478c089", "committedDate": "2020-09-18T17:27:57Z", "message": "Merge branch 'main' into config-refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTQzNjc1", "url": "https://github.com/ionic-team/capacitor/pull/3533#pullrequestreview-492543675", "createdAt": "2020-09-21T12:26:27Z", "commit": {"oid": "8cf2ac8f3e6b48cb6682e4770860a45e4478c089"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyNjoyN1rOHVNc7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyNjoyN1rOHVNc7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjU0Mw==", "bodyText": "It's still showing the plugins first because on first execution oldConfig is empty and just adds the plugin entry to it\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  ...oldConfig,\n          \n          \n            \n                  ...extConfig,\n          \n          \n            \n                  ...extConfig,\n          \n          \n            \n                  ...oldConfig,", "url": "https://github.com/ionic-team/capacitor/pull/3533#discussion_r492002543", "createdAt": "2020-09-21T12:26:27Z", "author": {"login": "jcesarmobile"}, "path": "cli/src/common.ts", "diffHunk": "@@ -222,47 +206,28 @@ export function buildXmlElement(configElement: any, rootName: string): string {\n   return builder.buildObject(configElement);\n }\n \n-/**\n- * Check for or create our main configuration file.\n- * @param config\n- */\n-export async function getOrCreateConfig(\n+export async function mergeConfig(\n   config: Config,\n-): Promise<string | undefined> {\n-  const configPath = join(config.app.rootDir, config.app.extConfigName);\n-  if (await existsAsync(configPath)) {\n-    return configPath;\n-  }\n+  extConfig: ExternalConfig,\n+): Promise<void> {\n+  const oldConfig = { ...config.app.extConfig };\n \n-  await writePrettyJSON(config.app.extConfigFilePath, {\n-    appId: config.app.appId,\n-    appName: config.app.appName,\n-    bundledWebRuntime: config.app.bundledWebRuntime,\n-    webDir: basename(resolve(config.app.rootDir, config.app.webDir)),\n-    plugins: {\n+  if (!oldConfig.plugins) {\n+    oldConfig.plugins = {\n       SplashScreen: {\n         launchShowDuration: 0,\n       },\n-    },\n-  });\n-\n-  // Store our newly created or found external config as the default\n-  config.loadExternalConfig();\n-}\n-\n-export async function mergeConfig(\n-  config: Config,\n-  settings: any,\n-): Promise<void> {\n-  const configPath = join(config.app.rootDir, config.app.extConfigName);\n-\n-  await writePrettyJSON(config.app.extConfigFilePath, {\n-    ...config.app.extConfig,\n-    ...settings,\n-  });\n+    };\n+  }\n \n-  // Store our newly created or found external config as the default\n-  config.loadExternalConfig();\n+  await writeJSON(\n+    config.app.extConfigFilePath,\n+    {\n+      ...oldConfig,\n+      ...extConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf2ac8f3e6b48cb6682e4770860a45e4478c089"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74b85beb2c1d207cf6e784aa56cdf7f82ed7e85a", "author": {"user": {"login": "imhoffd", "name": "Dan Imhoff"}}, "url": "https://github.com/ionic-team/capacitor/commit/74b85beb2c1d207cf6e784aa56cdf7f82ed7e85a", "committedDate": "2020-09-21T18:34:30Z", "message": "write plugin last (attempt 2 \ud83d\ude02)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzk2NDg3", "url": "https://github.com/ionic-team/capacitor/pull/3533#pullrequestreview-493396487", "createdAt": "2020-09-22T12:17:06Z", "commit": {"oid": "74b85beb2c1d207cf6e784aa56cdf7f82ed7e85a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1174, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}