{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDM4NDM5", "number": 3748, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoyNzoyN1rOEzbaSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMDozMTo0MlrOE37sAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzYxOTMxOnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoyNzoyN1rOHqpMFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoyNzoyN1rOHqpMFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3NzA3Nw==", "bodyText": "Now there's a magic number if ever I saw one!\nFor the sake of others who may have to maintain this code in the future, any chance you could put that number in a named constant and document how you came up with it?", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514477077", "createdAt": "2020-10-29T18:27:27Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzYyOTA1OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoyOTo1OFrOHqpSSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjoxMTowMlrOHrWEsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3ODY2Nw==", "bodyText": "JSON.stringify can throw TypeError, be sure to catch it.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514478667", "createdAt": "2020-10-29T18:29:58Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxMjQ2NQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r515212465", "createdAt": "2020-10-30T16:11:02Z", "author": {"login": "adamdbradley"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3ODY2Nw=="}, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzYzOTU4OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozMjo0MVrOHqpYzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozMjo0MVrOHqpYzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MDMzNQ==", "bodyText": "logToNative is declared as an optional function, so it can't be any other type. Using optional chaining is simpler, cleaner, and faster at runtime:\n        if (instance.DEBUG && pluginId !== 'Console') {\n          instance.logToNative?.(callData);\n        }", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514480335", "createdAt": "2020-10-29T18:32:41Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzY0OTk1OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODozNToxMVrOHqpe9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjoxNToxNVrOHrWOJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MTkwOQ==", "bodyText": "Since this is TypeScript, it would be nicer to use an enum for the level instead of a raw string. Or even better, create logger.warn, logger.error functions that set the level. That is a much more natural (and familiar) syntax.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514481909", "createdAt": "2020-10-29T18:35:11Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxNDg4Nw==", "bodyText": "Good call. And the best part is that after I just made this update, it found what would have been a runtime error \ud83d\ude03", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r515214887", "createdAt": "2020-10-30T16:15:15Z", "author": {"login": "adamdbradley"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MTkwOQ=="}, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzY5NjI5OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo0ODo1N1rOHqp8jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjoyMTo0MlrOHrWdWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTQ4Ng==", "bodyText": "logFromNative is declared as an optional function, so it can't be any other type. Using optional chaining is simpler, cleaner, and faster at runtime:\n        if (instance.DEBUG && result.pluginId !== 'Console') {\n          instance.logFromNative?.(result);\n        }", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514489486", "createdAt": "2020-10-29T18:48:57Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);\n+      }\n+    } catch (e) {\n+      logger('error', e);\n+    }\n+\n+    return null;\n+  };\n+\n+  /**\n+   * Process a response from the native layer.\n+   */\n+  instance.fromNative = (result: PluginResult) => {\n+    if (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxODc3OQ==", "bodyText": "Not sure why they were optional since we always set them. I'll just make the update so they're no optional, thanks", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r515218779", "createdAt": "2020-10-30T16:21:42Z", "author": {"login": "adamdbradley"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);\n+      }\n+    } catch (e) {\n+      logger('error', e);\n+    }\n+\n+    return null;\n+  };\n+\n+  /**\n+   * Process a response from the native layer.\n+   */\n+  instance.fromNative = (result: PluginResult) => {\n+    if (", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4OTQ4Ng=="}, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzcwNTI2OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1MToyNVrOHqqCKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjoyOToxNlrOHrWvTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MDkyMg==", "bodyText": "I'm assuming storedCall.callback is typed as an optional function, so this would suffice:\nif (storedCall.callback) {", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514490922", "createdAt": "2020-10-29T18:51:25Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);\n+      }\n+    } catch (e) {\n+      logger('error', e);\n+    }\n+\n+    return null;\n+  };\n+\n+  /**\n+   * Process a response from the native layer.\n+   */\n+  instance.fromNative = (result: PluginResult) => {\n+    if (\n+      instance.DEBUG &&\n+      result.pluginId !== 'Console' &&\n+      typeof instance.logFromNative === 'function'\n+    ) {\n+      instance.logFromNative(result);\n+    }\n+\n+    // get the stored call, if it exists\n+    try {\n+      const storedCall = callbacks.get(result.callbackId);\n+\n+      if (storedCall) {\n+        // looks like we've got a stored call\n+\n+        if (result.error) {\n+          // ensure stacktraces by copying error properties to an Error\n+          result.error = Object.keys(result.error).reduce((err, key) => {\n+            err[key] = (result.error as any)[key];\n+            return err;\n+          }, new instance.Exception('') as any);\n+        }\n+\n+        if (typeof storedCall.callback === 'function') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMzM3Mg==", "bodyText": "fine to double check, who knows what the runtime provided us", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r515223372", "createdAt": "2020-10-30T16:29:16Z", "author": {"login": "adamdbradley"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);\n+      }\n+    } catch (e) {\n+      logger('error', e);\n+    }\n+\n+    return null;\n+  };\n+\n+  /**\n+   * Process a response from the native layer.\n+   */\n+  instance.fromNative = (result: PluginResult) => {\n+    if (\n+      instance.DEBUG &&\n+      result.pluginId !== 'Console' &&\n+      typeof instance.logFromNative === 'function'\n+    ) {\n+      instance.logFromNative(result);\n+    }\n+\n+    // get the stored call, if it exists\n+    try {\n+      const storedCall = callbacks.get(result.callbackId);\n+\n+      if (storedCall) {\n+        // looks like we've got a stored call\n+\n+        if (result.error) {\n+          // ensure stacktraces by copying error properties to an Error\n+          result.error = Object.keys(result.error).reduce((err, key) => {\n+            err[key] = (result.error as any)[key];\n+            return err;\n+          }, new instance.Exception('') as any);\n+        }\n+\n+        if (typeof storedCall.callback === 'function') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MDkyMg=="}, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzcwNjI4OnYy", "diffSide": "RIGHT", "path": "core/src/bridge.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1MTo0MVrOHqqCyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1MTo0MVrOHqqCyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MTA4MA==", "bodyText": "Same here as above.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514491080", "createdAt": "2020-10-29T18:51:41Z", "author": {"login": "aparajita"}, "path": "core/src/bridge.ts", "diffHunk": "@@ -0,0 +1,184 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+  PluginResult,\n+  StoredCallback,\n+} from './definitions';\n+import { initLogger } from './logger';\n+\n+export const initBridge = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+): void => {\n+  // keep a collection of callbacks for native response data\n+  const callbacks = new Map<string, StoredCallback>();\n+\n+  // Counter of callback ids, randomized to avoid\n+  // any issues during reloads if a call comes back with\n+  // an existing callback id from an old session\n+  let callbackIdCount = Math.floor(Math.random() * 134217728);\n+\n+  let postToNative: (data: CallData) => void | null = null;\n+\n+  // create the postToNative() fn if needed\n+  if (gbl.androidBridge) {\n+    // android platform\n+    postToNative = (data: any) => {\n+      gbl.androidBridge.postMessage(JSON.stringify(data));\n+    };\n+    state.isNative = true;\n+    state.platform = 'android';\n+  } else if (\n+    gbl.webkit &&\n+    gbl.webkit.messageHandlers &&\n+    gbl.webkit.messageHandlers.bridge\n+  ) {\n+    // ios platform\n+    postToNative = (data: any) => {\n+      data.type = 'message';\n+      gbl.webkit.messageHandlers.bridge.postMessage(data);\n+    };\n+    state.isNative = true;\n+    state.platform = 'ios';\n+  }\n+\n+  const logger = initLogger(gbl, instance, state, postToNative);\n+\n+  /**\n+   * Send a plugin method call to the native layer\n+   */\n+  instance.toNative = (\n+    pluginId: string,\n+    methodName: string,\n+    options: any,\n+    storedCallback: StoredCallback,\n+  ) => {\n+    try {\n+      if (typeof postToNative === 'function') {\n+        let callbackId = '-1';\n+\n+        if (\n+          storedCallback &&\n+          (typeof storedCallback.callback === 'function' ||\n+            typeof storedCallback.resolve === 'function')\n+        ) {\n+          // store the call for later lookup\n+          callbackId = String(++callbackIdCount);\n+          callbacks.set(callbackId, storedCallback);\n+        }\n+\n+        const callData: CallData = {\n+          callbackId: callbackId,\n+          pluginId: pluginId,\n+          methodName: methodName,\n+          options: options || {},\n+        };\n+\n+        if (\n+          instance.DEBUG &&\n+          pluginId !== 'Console' &&\n+          typeof instance.logToNative === 'function'\n+        ) {\n+          instance.logToNative(callData);\n+        }\n+\n+        // post the call data to native\n+        postToNative(callData);\n+\n+        return callbackId;\n+      } else {\n+        logger('warn', `implementation unavailable for: ${pluginId}`);\n+      }\n+    } catch (e) {\n+      logger('error', e);\n+    }\n+\n+    return null;\n+  };\n+\n+  /**\n+   * Process a response from the native layer.\n+   */\n+  instance.fromNative = (result: PluginResult) => {\n+    if (\n+      instance.DEBUG &&\n+      result.pluginId !== 'Console' &&\n+      typeof instance.logFromNative === 'function'\n+    ) {\n+      instance.logFromNative(result);\n+    }\n+\n+    // get the stored call, if it exists\n+    try {\n+      const storedCall = callbacks.get(result.callbackId);\n+\n+      if (storedCall) {\n+        // looks like we've got a stored call\n+\n+        if (result.error) {\n+          // ensure stacktraces by copying error properties to an Error\n+          result.error = Object.keys(result.error).reduce((err, key) => {\n+            err[key] = (result.error as any)[key];\n+            return err;\n+          }, new instance.Exception('') as any);\n+        }\n+\n+        if (typeof storedCall.callback === 'function') {\n+          // callback\n+          if (result.success) {\n+            storedCall.callback(result.data);\n+          } else {\n+            storedCall.callback(null, result.error);\n+          }\n+        } else if (typeof storedCall.resolve === 'function') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzcyMTI5OnYy", "diffSide": "RIGHT", "path": "core/src/definitions.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1NTowNVrOHqqLuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjozMDozN1rOHrWypg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MzM3MQ==", "bodyText": "Is this in fact any or is it actually strictly a function or an object? If that is the case it could be typed as such.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514493371", "createdAt": "2020-10-29T18:55:05Z", "author": {"login": "aparajita"}, "path": "core/src/definitions.ts", "diffHunk": "@@ -101,40 +86,235 @@ declare const CapacitorException: {\n };\n \n export interface Capacitor {\n+  /**\n+   * Utility function to convert a file path into\n+   * a useful src depending on the value and environment.\n+   */\n+  convertFileSrc: (filePath: string) => string;\n+\n+  /**\n+   * The Exception class used when generating plugin Exceptions\n+   * from bridge calls.\n+   */\n   Exception: typeof CapacitorException;\n-  isNative?: boolean;\n-  platform?: string;\n+\n+  /**\n+   * Boolean if the platform is native or not. `android` and `ios`\n+   * would return `true`, otherwise `false`.\n+   */\n+  isNativePlatform: () => boolean;\n+\n+  /**\n+   * Used to check if a platform is registered and available.\n+   */\n   isPluginAvailable: (name: string) => boolean;\n-  convertFileSrc: (filePath: string) => string;\n+\n+  /**\n+   * Gets the name of the platform, such as `android`, `ios`, or `web`.\n+   */\n   getPlatform: () => string;\n-  toNative?: (\n-    pluginId: string,\n-    methodName: string,\n-    options: any,\n-    storedCallback?: StoredCallback,\n-  ) => void;\n-  fromNative?: (result: PluginResult) => void;\n-  withPlugin?: (pluginId: string, fn: (...args: any[]) => any) => void;\n+\n+  /**\n+   * Sends data over the bridge to the native layer.\n+   * Returns the Callback Id.\n+   */\n   nativeCallback?: (\n     pluginId: string,\n     methodName: string,\n     options?: any,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNDIzMA==", "bodyText": "yeah not sure what each plugin will use as its options here", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r515224230", "createdAt": "2020-10-30T16:30:37Z", "author": {"login": "adamdbradley"}, "path": "core/src/definitions.ts", "diffHunk": "@@ -101,40 +86,235 @@ declare const CapacitorException: {\n };\n \n export interface Capacitor {\n+  /**\n+   * Utility function to convert a file path into\n+   * a useful src depending on the value and environment.\n+   */\n+  convertFileSrc: (filePath: string) => string;\n+\n+  /**\n+   * The Exception class used when generating plugin Exceptions\n+   * from bridge calls.\n+   */\n   Exception: typeof CapacitorException;\n-  isNative?: boolean;\n-  platform?: string;\n+\n+  /**\n+   * Boolean if the platform is native or not. `android` and `ios`\n+   * would return `true`, otherwise `false`.\n+   */\n+  isNativePlatform: () => boolean;\n+\n+  /**\n+   * Used to check if a platform is registered and available.\n+   */\n   isPluginAvailable: (name: string) => boolean;\n-  convertFileSrc: (filePath: string) => string;\n+\n+  /**\n+   * Gets the name of the platform, such as `android`, `ios`, or `web`.\n+   */\n   getPlatform: () => string;\n-  toNative?: (\n-    pluginId: string,\n-    methodName: string,\n-    options: any,\n-    storedCallback?: StoredCallback,\n-  ) => void;\n-  fromNative?: (result: PluginResult) => void;\n-  withPlugin?: (pluginId: string, fn: (...args: any[]) => any) => void;\n+\n+  /**\n+   * Sends data over the bridge to the native layer.\n+   * Returns the Callback Id.\n+   */\n   nativeCallback?: (\n     pluginId: string,\n     methodName: string,\n     options?: any,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MzM3MQ=="}, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzczNzI4OnYy", "diffSide": "RIGHT", "path": "core/src/logger.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1ODoxMVrOHqqUmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODo1ODoxMVrOHqqUmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5NTY0Mg==", "bodyText": "What does \"Advance\" mean here?", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514495642", "createdAt": "2020-10-29T18:58:11Z", "author": {"login": "aparajita"}, "path": "core/src/logger.ts", "diffHunk": "@@ -0,0 +1,196 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+} from './definitions';\n+\n+export const initLogger = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+  postToNative: (data: any) => void | null,\n+) => {\n+  // patch window.console on iOS and store original console fns\n+  const isIos = state.platform === 'ios';\n+  const orgConsole = (isIos ? {} : gbl.console) as any;\n+\n+  const useFallbackLogging =\n+    !!gbl.console && Object.keys(gbl.console).length === 0;\n+  if (useFallbackLogging && gbl.console) {\n+    gbl.console.warn('Advance console logging disabled.');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzc1NDg2OnYy", "diffSide": "RIGHT", "path": "core/src/logger.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTowMjozNlrOHqqfMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTowMjozNlrOHqqfMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5ODM1Mg==", "bodyText": "Shouldn't this logging only be done if instance.DEBUG? There's a few reasons why:\n\n\nWe really don't want to see this info most of the time. If we are doing our own logging, the spam from native calls obscures our own logs.\n\n\nThere is a very real cost at runtime. You have to go through the JS<->Native bridge code, then the bridge has to parse the call and execute a dynamic dispatch.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514498352", "createdAt": "2020-10-29T19:02:36Z", "author": {"login": "aparajita"}, "path": "core/src/logger.ts", "diffHunk": "@@ -0,0 +1,196 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+} from './definitions';\n+\n+export const initLogger = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+  postToNative: (data: any) => void | null,\n+) => {\n+  // patch window.console on iOS and store original console fns\n+  const isIos = state.platform === 'ios';\n+  const orgConsole = (isIos ? {} : gbl.console) as any;\n+\n+  const useFallbackLogging =\n+    !!gbl.console && Object.keys(gbl.console).length === 0;\n+  if (useFallbackLogging && gbl.console) {\n+    gbl.console.warn('Advance console logging disabled.');\n+  }\n+\n+  // list log functions bridged to native log\n+  const bridgedLevels: { [key: string]: boolean } = {\n+    debug: true,\n+    error: true,\n+    info: true,\n+    log: true,\n+    trace: true,\n+    warn: true,\n+  };\n+\n+  if (isIos && gbl.console) {\n+    Object.keys(gbl.console).forEach(level => {\n+      if (typeof gbl.console[level] === 'function') {\n+        // loop through all the console functions and keep references to the original\n+        orgConsole[level] = gbl.console[level];\n+        gbl.console[level] = function capacitorConsole() {\n+          let msgs: any[] = Array.prototype.slice.call(arguments);\n+\n+          // console log to browser\n+          orgConsole[level].apply(gbl.console, msgs);\n+\n+          if (bridgedLevels[level]) {\n+            // send log to native to print\n+            try {\n+              // convert all args to strings\n+              msgs = msgs.map(arg => {\n+                if (typeof arg === 'object') {\n+                  try {\n+                    arg = JSON.stringify(arg);\n+                  } catch (e) {}\n+                }\n+                // convert to string\n+                return String(arg);\n+              });\n+              instance.toNative('Console', 'log', {\n+                level: level,\n+                message: msgs.join(' '),\n+              });\n+            } catch (e) {\n+              // error converting/posting console messages\n+              orgConsole.error.apply(gbl.console, e);\n+            }\n+          }\n+        };\n+      }\n+    });\n+  }\n+\n+  instance.logJs = (message, level) => {\n+    switch (level) {\n+      case 'error':\n+        gbl.console.error(message);\n+        break;\n+      case 'warn':\n+        gbl.console.warn(message);\n+        break;\n+      case 'info':\n+        gbl.console.info(message);\n+        break;\n+      default:\n+        gbl.console.log(message);\n+    }\n+  };\n+\n+  instance.handleError = (e: Error) => gbl.console.error(e);\n+\n+  instance.handleWindowError = (msg, url, lineNo, columnNo, error) => {\n+    const str = msg.toLowerCase();\n+    const substring = 'script error';\n+\n+    if (str.indexOf(substring) > -1) {\n+      // Some IE issue?\n+    } else {\n+      const errObj = {\n+        type: 'js.error',\n+        error: {\n+          message: msg,\n+          url: url,\n+          line: lineNo,\n+          col: columnNo,\n+          errorObject: JSON.stringify(error),\n+        },\n+      };\n+\n+      if (error !== null) {\n+        instance.handleError(error);\n+      }\n+\n+      if (postToNative) {\n+        postToNative(errObj);\n+      }\n+    }\n+\n+    return false;\n+  };\n+\n+  if (instance.DEBUG) {\n+    window.onerror = instance.handleWindowError;\n+  }\n+\n+  instance.logToNative = (call: CallData) => {\n+    if (!useFallbackLogging) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzc1NjYwOnYy", "diffSide": "RIGHT", "path": "core/src/logger.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTowMzoxMFrOHqqgYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTowMzoxMFrOHqqgYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5ODY1Ng==", "bodyText": "Same comments here as for logToNative.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r514498656", "createdAt": "2020-10-29T19:03:10Z", "author": {"login": "aparajita"}, "path": "core/src/logger.ts", "diffHunk": "@@ -0,0 +1,196 @@\n+import type {\n+  CallData,\n+  CapacitorInstance,\n+  GlobalInstance,\n+  InternalState,\n+} from './definitions';\n+\n+export const initLogger = (\n+  gbl: GlobalInstance,\n+  instance: CapacitorInstance,\n+  state: InternalState,\n+  postToNative: (data: any) => void | null,\n+) => {\n+  // patch window.console on iOS and store original console fns\n+  const isIos = state.platform === 'ios';\n+  const orgConsole = (isIos ? {} : gbl.console) as any;\n+\n+  const useFallbackLogging =\n+    !!gbl.console && Object.keys(gbl.console).length === 0;\n+  if (useFallbackLogging && gbl.console) {\n+    gbl.console.warn('Advance console logging disabled.');\n+  }\n+\n+  // list log functions bridged to native log\n+  const bridgedLevels: { [key: string]: boolean } = {\n+    debug: true,\n+    error: true,\n+    info: true,\n+    log: true,\n+    trace: true,\n+    warn: true,\n+  };\n+\n+  if (isIos && gbl.console) {\n+    Object.keys(gbl.console).forEach(level => {\n+      if (typeof gbl.console[level] === 'function') {\n+        // loop through all the console functions and keep references to the original\n+        orgConsole[level] = gbl.console[level];\n+        gbl.console[level] = function capacitorConsole() {\n+          let msgs: any[] = Array.prototype.slice.call(arguments);\n+\n+          // console log to browser\n+          orgConsole[level].apply(gbl.console, msgs);\n+\n+          if (bridgedLevels[level]) {\n+            // send log to native to print\n+            try {\n+              // convert all args to strings\n+              msgs = msgs.map(arg => {\n+                if (typeof arg === 'object') {\n+                  try {\n+                    arg = JSON.stringify(arg);\n+                  } catch (e) {}\n+                }\n+                // convert to string\n+                return String(arg);\n+              });\n+              instance.toNative('Console', 'log', {\n+                level: level,\n+                message: msgs.join(' '),\n+              });\n+            } catch (e) {\n+              // error converting/posting console messages\n+              orgConsole.error.apply(gbl.console, e);\n+            }\n+          }\n+        };\n+      }\n+    });\n+  }\n+\n+  instance.logJs = (message, level) => {\n+    switch (level) {\n+      case 'error':\n+        gbl.console.error(message);\n+        break;\n+      case 'warn':\n+        gbl.console.warn(message);\n+        break;\n+      case 'info':\n+        gbl.console.info(message);\n+        break;\n+      default:\n+        gbl.console.log(message);\n+    }\n+  };\n+\n+  instance.handleError = (e: Error) => gbl.console.error(e);\n+\n+  instance.handleWindowError = (msg, url, lineNo, columnNo, error) => {\n+    const str = msg.toLowerCase();\n+    const substring = 'script error';\n+\n+    if (str.indexOf(substring) > -1) {\n+      // Some IE issue?\n+    } else {\n+      const errObj = {\n+        type: 'js.error',\n+        error: {\n+          message: msg,\n+          url: url,\n+          line: lineNo,\n+          col: columnNo,\n+          errorObject: JSON.stringify(error),\n+        },\n+      };\n+\n+      if (error !== null) {\n+        instance.handleError(error);\n+      }\n+\n+      if (postToNative) {\n+        postToNative(errObj);\n+      }\n+    }\n+\n+    return false;\n+  };\n+\n+  if (instance.DEBUG) {\n+    window.onerror = instance.handleWindowError;\n+  }\n+\n+  instance.logToNative = (call: CallData) => {\n+    if (!useFallbackLogging) {\n+      orgConsole.groupCollapsed(\n+        '%cnative %c' +\n+          call.pluginId +\n+          '.' +\n+          call.methodName +\n+          ' (#' +\n+          call.callbackId +\n+          ')',\n+        'font-weight: lighter; color: gray',\n+        'font-weight: bold; color: #000',\n+      );\n+      orgConsole.dir(call);\n+      orgConsole.groupEnd();\n+    } else {\n+      gbl.console.log('LOG TO NATIVE: ', call);\n+      if (state.platform === 'ios') {\n+        try {\n+          instance.toNative('Console', 'log', {\n+            message: JSON.stringify(call),\n+          });\n+        } catch (e) {\n+          gbl.console.log('Error converting/posting console messages');\n+        }\n+      }\n+    }\n+  };\n+\n+  instance.logFromNative = result => {\n+    if (!useFallbackLogging) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339010e21b77bf105060e728e95a5e6a11db705"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2OTcwMzQwOnYy", "diffSide": "RIGHT", "path": "core/package.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNToxN1rOHxZL2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMDoyOTo0OFrOHxdKhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NDkwNQ==", "bodyText": "We can take this opportunity to switch to types (the documented way) vs typings.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              \"typings\": \"types/index.d.ts\",\n          \n          \n            \n              \"types\": \"types/index.d.ts\",", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521554905", "createdAt": "2020-11-11T18:25:17Z", "author": {"login": "imhoffd"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"\n   },\n   \"main\": \"dist/index.js\",\n-  \"module\": \"dist/esm/index.js\",\n+  \"typings\": \"types/index.d.ts\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYyMDEwMw==", "bodyText": "yup makes sense", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521620103", "createdAt": "2020-11-11T20:29:48Z", "author": {"login": "adamdbradley"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"\n   },\n   \"main\": \"dist/index.js\",\n-  \"module\": \"dist/esm/index.js\",\n+  \"typings\": \"types/index.d.ts\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NDkwNQ=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2OTcwOTg4OnYy", "diffSide": "RIGHT", "path": "core/package.json", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNzowNVrOHxZPsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzo1OTo1OVrOHxi9oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTg5MQ==", "bodyText": "We're using colons in other places. I don't care which we use, but we should be consistent\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"test.watch\": \"jest --watchAll\",\n          \n          \n            \n                \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"\n          \n          \n            \n                \"test:watch\": \"jest --watchAll\",\n          \n          \n            \n                \"test:treeshaking\": \"node src/tests/build-treeshaking.js\"", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521555891", "createdAt": "2020-11-11T18:27:05Z", "author": {"login": "imhoffd"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYwNzQwOA==", "bodyText": "Dots are easier to type. No shift key required.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521607408", "createdAt": "2020-11-11T20:04:37Z", "author": {"login": "aparajita"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTg5MQ=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYxOTY2NA==", "bodyText": "Yeah, I'd agree with @aparajita and like using . cuz it's easier to type", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521619664", "createdAt": "2020-11-11T20:29:00Z", "author": {"login": "adamdbradley"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTg5MQ=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzMzYzNg==", "bodyText": "It's also more idiomatic for JS/TS. Not sure how using colons in script names became a thing.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521633636", "createdAt": "2020-11-11T20:56:27Z", "author": {"login": "aparajita"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTg5MQ=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxNTEwNQ==", "bodyText": "Then it needs to change everywhere else.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521715105", "createdAt": "2020-11-11T23:59:59Z", "author": {"login": "imhoffd"}, "path": "core/package.json", "diffHunk": "@@ -7,36 +7,33 @@\n   \"license\": \"MIT\",\n   \"files\": [\n     \"dist/\",\n-    \"cordova.js\",\n-    \"native-bridge.js\"\n+    \"types/\",\n+    \"cordova.js\"\n   ],\n   \"scripts\": {\n-    \"docs\": \"./node_modules/.bin/typedoc --exclude **/__test__/*.ts --json dist/docs.json --mode modules src/core-plugin-definitions.ts && node scripts/docs.js\",\n-    \"build\": \"npm run clean && npm run transpile && npm run rollup && npm run minify\",\n+    \"build\": \"npm run clean && npm run transpile && npm run rollup\",\n     \"clean\": \"rimraf dist\",\n-    \"minify\": \"terser --mangle --compress --source-map \\\"content='dist/capacitor.js.map',url='capacitor.js.map'\\\" --comments '/^/*!/' --output dist/capacitor.js dist/capacitor.js\",\n     \"prepublishOnly\": \"npm run build\",\n     \"rollup\": \"rollup --config rollup.config.js\",\n     \"transpile\": \"tsc\",\n-    \"test\": \"jest\"\n+    \"test\": \"jest\",\n+    \"test.watch\": \"jest --watchAll\",\n+    \"test.treeshaking\": \"node src/tests/build-treeshaking.js\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTg5MQ=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2OTcxMjU2OnYy", "diffSide": "LEFT", "path": "package.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNzo1NlrOHxZRYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMDoyOToyOVrOHxdJ2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NjMyMg==", "bodyText": "What's the reason for removing this? If it's annoying while working in PRs, you can do git commit -n for \"no verify\"", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521556322", "createdAt": "2020-11-11T18:27:56Z", "author": {"login": "imhoffd"}, "path": "package.json", "diffHunk": "@@ -9,11 +9,6 @@\n     \"swiftlint\": \"node-swiftlint\",\n     \"postinstall\": \"lerna bootstrap\"\n   },\n-  \"husky\": {\n-    \"hooks\": {\n-      \"pre-commit\": \"npm run lint\"\n-    }\n-  },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYxOTkzMA==", "bodyText": "sorry, forgot to put it back. Didn't remove on purpose", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521619930", "createdAt": "2020-11-11T20:29:29Z", "author": {"login": "adamdbradley"}, "path": "package.json", "diffHunk": "@@ -9,11 +9,6 @@\n     \"swiftlint\": \"node-swiftlint\",\n     \"postinstall\": \"lerna bootstrap\"\n   },\n-  \"husky\": {\n-    \"hooks\": {\n-      \"pre-commit\": \"npm run lint\"\n-    }\n-  },", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NjMyMg=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2OTcxODgyOnYy", "diffSide": "RIGHT", "path": "core/src/tests/fixtures/network-plugin/index.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyOTo0OVrOHxZVWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMDozNDoxMlrOHxdTMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NzMzNw==", "bodyText": "This may need updating", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521557337", "createdAt": "2020-11-11T18:29:49Z", "author": {"login": "imhoffd"}, "path": "core/src/tests/fixtures/network-plugin/index.ts", "diffHunk": "@@ -0,0 +1,11 @@\n+import { registerPlugin, NativePlugin } from '../../../index';\n+\n+import type { NetworkPlugin } from './definitions';\n+\n+const Network = registerPlugin<NetworkPlugin>('Network', {\n+  android: NativePlugin,\n+  ios: NativePlugin,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYyMjMyMA==", "bodyText": "Good catch. Those files were left over and no longer being used. Removing...", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521622320", "createdAt": "2020-11-11T20:34:12Z", "author": {"login": "adamdbradley"}, "path": "core/src/tests/fixtures/network-plugin/index.ts", "diffHunk": "@@ -0,0 +1,11 @@\n+import { registerPlugin, NativePlugin } from '../../../index';\n+\n+import type { NetworkPlugin } from './definitions';\n+\n+const Network = registerPlugin<NetworkPlugin>('Network', {\n+  android: NativePlugin,\n+  ios: NativePlugin,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NzMzNw=="}, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDAwMDkxOnYy", "diffSide": "RIGHT", "path": "core/src/global.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo1MzoyNlrOHxcCKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo1MzoyNlrOHxcCKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYwMTU3Nw==", "bodyText": "I don't think we can deprecate this because this is how app developers would import their own in-app plugins.\njava:\n@CapacitorPlugin(name = \"CoolThing\")\npublic class ...\njs:\nimport { Plugins } from '@capacitor/core';\nconst { CoolThing } = Plugins;", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521601577", "createdAt": "2020-11-11T19:53:26Z", "author": {"login": "imhoffd"}, "path": "core/src/global.ts", "diffHunk": "@@ -1,25 +1,38 @@\n-import type { Capacitor as _Capacitor } from './definitions';\n-import { CapacitorWeb } from './web-runtime';\n+import { legacyRegisterWebPlugin } from './legacy/legacy-web-plugin-merge';\n+import { initCapacitorGlobal } from './runtime';\n+import type { WebPlugin } from './web-plugin';\n \n-// Create our default Capacitor instance, which will be\n-// overridden on native platforms\n-const Capacitor = ((globalThis: any): _Capacitor => {\n-  // Create a new CapacitorWeb instance if one doesn't already exist on globalThis\n-  // Ensure the global is assigned the same Capacitor instance,\n-  // then export Capacitor so it can be imported in other modules\n-  return (globalThis.Capacitor = globalThis.Capacitor || new CapacitorWeb());\n-})(\n-  // figure out the current globalThis, such as \"window\", \"self\" or \"global\"\n-  // ensure errors are not thrown in an node SSR environment or web worker\n-  typeof self !== 'undefined'\n+export const Capacitor = /*#__PURE__*/ initCapacitorGlobal(\n+  (typeof globalThis !== 'undefined'\n+    ? globalThis\n+    : typeof self !== 'undefined'\n     ? self\n     : typeof window !== 'undefined'\n     ? window\n     : typeof global !== 'undefined'\n     ? global\n-    : {},\n+    : {}) as any,\n );\n \n-const Plugins = Capacitor.Plugins;\n+export const registerPlugin = Capacitor.registerPlugin;\n \n-export { Capacitor, Plugins };\n+/**\n+ * @deprecated Provided for backwards compatibility for Capacitor v2 plugins.\n+ * Capacitor v3 plugins should import the plugin directly. This \"Plugins\"\n+ * export is deprecated in v3, and will be removed in v4.\n+ */\n+export const Plugins = Capacitor.Plugins;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4d7644846e8807eaa0b284db3d1032681be3ce"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDg1MDU3OnYy", "diffSide": "RIGHT", "path": "core/src/legacy/legacy-handlers.ts", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMDozMTo0MlrOHxkE4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQxNjo1MToxOVrOHzMMTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzM0Nw==", "bodyText": "Is this a typo? I'm pretty sure this line does nothing.", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r521733347", "createdAt": "2020-11-12T00:31:42Z", "author": {"login": "imhoffd"}, "path": "core/src/legacy/legacy-handlers.ts", "diffHunk": "@@ -0,0 +1,43 @@\n+import type {\n+  CapacitorInstance,\n+  WindowCapacitor,\n+} from '../definitions-internal';\n+import { noop } from '../util';\n+\n+export const initLegacyHandlers = (\n+  win: WindowCapacitor,\n+  cap: CapacitorInstance,\n+): void => {\n+  // define cordova if it's not there already\n+  win.cordova = win.cordova || {};\n+\n+  const doc = win.document;\n+  const nav = win.navigator;\n+\n+  if (nav) {\n+    nav.app = nav.app || {};\n+    nav.app.exitApp = () => {\n+      cap.nativeCallback('App', 'exitApp', {});\n+    };\n+  }\n+\n+  if (doc) {\n+    const docAddEventListener = doc.addEventListener;\n+    doc.addEventListener = (...args: any[]) => {\n+      const eventName = args[0];\n+      const handler = args[1];\n+      if (eventName === 'deviceready' && handler) {\n+        Promise.resolve(handler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f80fb0324c1c339c1d132c5f8f6cdb3a83e625"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQzOTE4MQ==", "bodyText": "yup, fixed thanks da7b796", "url": "https://github.com/ionic-team/capacitor/pull/3748#discussion_r523439181", "createdAt": "2020-11-14T16:51:19Z", "author": {"login": "adamdbradley"}, "path": "core/src/legacy/legacy-handlers.ts", "diffHunk": "@@ -0,0 +1,43 @@\n+import type {\n+  CapacitorInstance,\n+  WindowCapacitor,\n+} from '../definitions-internal';\n+import { noop } from '../util';\n+\n+export const initLegacyHandlers = (\n+  win: WindowCapacitor,\n+  cap: CapacitorInstance,\n+): void => {\n+  // define cordova if it's not there already\n+  win.cordova = win.cordova || {};\n+\n+  const doc = win.document;\n+  const nav = win.navigator;\n+\n+  if (nav) {\n+    nav.app = nav.app || {};\n+    nav.app.exitApp = () => {\n+      cap.nativeCallback('App', 'exitApp', {});\n+    };\n+  }\n+\n+  if (doc) {\n+    const docAddEventListener = doc.addEventListener;\n+    doc.addEventListener = (...args: any[]) => {\n+      const eventName = args[0];\n+      const handler = args[1];\n+      if (eventName === 'deviceready' && handler) {\n+        Promise.resolve(handler);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzM0Nw=="}, "originalCommit": {"oid": "b7f80fb0324c1c339c1d132c5f8f6cdb3a83e625"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3436, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}