{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODU4MzAw", "number": 1708, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMDo1OTo0MlrOFN4Dtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1Nzo0MlrOFORK-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMDk0MjYzOnYy", "diffSide": "RIGHT", "path": "k-distribution/src/main/scripts/bin/kx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMDo1OTo0MlrOISVGaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1NjowMVrOIS7hUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA5MDk4Nw==", "bodyText": "This is something which I don't understand.\nWhy is this call needed?", "url": "https://github.com/kframework/k/pull/1708#discussion_r556090987", "createdAt": "2021-01-12T20:59:42Z", "author": {"login": "radumereuta"}, "path": "k-distribution/src/main/scripts/bin/kx", "diffHunk": "@@ -449,12 +463,13 @@ else\n       unescaped=$(</dev/stdin)\n       stdinText=$(awk 'BEGIN {for(n=0;n<256;n++)ord[sprintf(\"%c\",n)]=n} {text = text $0 ORS} END {split(text, chars, \"\"); for (i=1; i<=length(text); i++) { if (chars[i] == \"\\\"\") { printf(\"%s\", \"\\\\\\\"\") } else if (chars[i] == \"\\\\\") { printf(\"%s\", \"\\\\\\\\\") } else if (chars[i] == \"\\n\") { printf(\"%s\", \"\\\\n\") } else if (chars[i] == \"\\t\") { printf(\"%s\", \"\\\\t\") } else if (chars[i] == \"\\r\") { printf(\"%s\", \"\\\\r\") } else if (chars[i] == \"\\f\") { printf(\"%s\", \"\\\\f\") } else if (ord[chars[i]] >= 32 && ord[chars[i]] < 127) { printf(\"%s\", chars[i]) } else { printf(\"\\\\x%02x\", ord[chars[i]]) } } }' <<< \"$unescaped\")\n     fi\n-    stdinFile=\"$(mktemp tmp.stdin.XXXXXXXXXX)\"\n+    stdinFile=\"$(mktemp ${tempDir}/tmp.stdin.XXXXXXXXXX)\"\n     tempFiles+=(\"$stdinFile\")\n     printf '\\dv{SortString{}}(\\\"%s\\\")\\n' \"$stdinText\" > \"$stdinFile\"\n-    configVars=\"$configVars -c STDIN $stdinFile String korefile\"\n+    configVars=\"$configVars -c STDIN $(basename $stdinFile) String korefile\"\n   fi\n-  execute llvm-krun $configVars -d \"$kompiledDir\" $flags --dry-run -o \"$input_file\"\n+  # llvm-krun creates temp files in the cwd so execute it in $tempDir instead\n+  (cd $tempDir; execute llvm-krun $configVars -d \"../$kompiledDir\" $flags --dry-run -o \"$(basename $input_file)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcyMDQ2Nw==", "bodyText": "Uh, it creates the initial configuration that gets passed to the interpreter? It's a very important step.", "url": "https://github.com/kframework/k/pull/1708#discussion_r556720467", "createdAt": "2021-01-13T17:56:01Z", "author": {"login": "dwightguth"}, "path": "k-distribution/src/main/scripts/bin/kx", "diffHunk": "@@ -449,12 +463,13 @@ else\n       unescaped=$(</dev/stdin)\n       stdinText=$(awk 'BEGIN {for(n=0;n<256;n++)ord[sprintf(\"%c\",n)]=n} {text = text $0 ORS} END {split(text, chars, \"\"); for (i=1; i<=length(text); i++) { if (chars[i] == \"\\\"\") { printf(\"%s\", \"\\\\\\\"\") } else if (chars[i] == \"\\\\\") { printf(\"%s\", \"\\\\\\\\\") } else if (chars[i] == \"\\n\") { printf(\"%s\", \"\\\\n\") } else if (chars[i] == \"\\t\") { printf(\"%s\", \"\\\\t\") } else if (chars[i] == \"\\r\") { printf(\"%s\", \"\\\\r\") } else if (chars[i] == \"\\f\") { printf(\"%s\", \"\\\\f\") } else if (ord[chars[i]] >= 32 && ord[chars[i]] < 127) { printf(\"%s\", chars[i]) } else { printf(\"\\\\x%02x\", ord[chars[i]]) } } }' <<< \"$unescaped\")\n     fi\n-    stdinFile=\"$(mktemp tmp.stdin.XXXXXXXXXX)\"\n+    stdinFile=\"$(mktemp ${tempDir}/tmp.stdin.XXXXXXXXXX)\"\n     tempFiles+=(\"$stdinFile\")\n     printf '\\dv{SortString{}}(\\\"%s\\\")\\n' \"$stdinText\" > \"$stdinFile\"\n-    configVars=\"$configVars -c STDIN $stdinFile String korefile\"\n+    configVars=\"$configVars -c STDIN $(basename $stdinFile) String korefile\"\n   fi\n-  execute llvm-krun $configVars -d \"$kompiledDir\" $flags --dry-run -o \"$input_file\"\n+  # llvm-krun creates temp files in the cwd so execute it in $tempDir instead\n+  (cd $tempDir; execute llvm-krun $configVars -d \"../$kompiledDir\" $flags --dry-run -o \"$(basename $input_file)\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjA5MDk4Nw=="}, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNTAzMDkzOnYy", "diffSide": "RIGHT", "path": "k-distribution/src/main/scripts/bin/kx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1MTo1NVrOIS7WKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1MTo1NVrOIS7WKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcxNzYwOA==", "bodyText": "let's not use find for this. Find is recursive and likely to take longer when you can probably just use a glob.", "url": "https://github.com/kframework/k/pull/1708#discussion_r556717608", "createdAt": "2021-01-13T17:51:55Z", "author": {"login": "dwightguth"}, "path": "k-distribution/src/main/scripts/bin/kx", "diffHunk": "@@ -403,36 +407,46 @@ if [ \"$outputFile\" = \"-\" ]; then\n   outputFile=/dev/stdout\n fi\n \n+# verify and parse config variables/cmd line parameters\n if $term; then\n   if [ -z \"${parser_PGM+unset}\" ]; then\n     execute kast -d \"$dir\" -m \"$mainModuleName\" \"$config_var_PGM\" -o kore > \"$input_file\"\n   else\n     execute $parser_PGM \"$config_var_PGM\" > \"$input_file\"\n   fi\n else\n+  for configVar in `find $kompiledDir -type f -name 'sort_*' | sed 's|.*sort_\\(.*\\).txt|\\1|'`; do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNTAzMjg3OnYy", "diffSide": "RIGHT", "path": "k-distribution/src/main/scripts/bin/kx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1MjoyMlrOIS7XcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1MjoyMlrOIS7XcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcxNzkzNg==", "bodyText": "let's copy over the logic from my PR rather than this warning.", "url": "https://github.com/kframework/k/pull/1708#discussion_r556717936", "createdAt": "2021-01-13T17:52:22Z", "author": {"login": "dwightguth"}, "path": "k-distribution/src/main/scripts/bin/kx", "diffHunk": "@@ -403,36 +407,46 @@ if [ \"$outputFile\" = \"-\" ]; then\n   outputFile=/dev/stdout\n fi\n \n+# verify and parse config variables/cmd line parameters\n if $term; then\n   if [ -z \"${parser_PGM+unset}\" ]; then\n     execute kast -d \"$dir\" -m \"$mainModuleName\" \"$config_var_PGM\" -o kore > \"$input_file\"\n   else\n     execute $parser_PGM \"$config_var_PGM\" > \"$input_file\"\n   fi\n else\n+  for configVar in `find $kompiledDir -type f -name 'sort_*' | sed 's|.*sort_\\(.*\\).txt|\\1|'`; do\n+    if [[ $configVar != \"IO\" && $configVar != \"STDIN\" && ! \"${params[@]}\" =~ \"$configVar\" ]]; then\n+      error \"Configuration variable missing: \\$$configVar. Use -c$configVar=<Value> in the command line to set.\"\n+    fi\n+  done\n   for name in \"${params[@]}\"; do\n     parser_name=\"parser_$name\"\n     config_name=\"config_var_$name\"\n-    tempFile=\"$(mktemp tmp.in.\"$name\".XXXXXXXXXX)\"\n+    tempFile=\"$(mktemp ${tempDir}/tmp.in.\"$name\".XXXXXXXXXX)\"\n     tempFiles+=(\"$tempFile\")\n-    sortName=`cat \"$kompiledDir\"/sort_\"$name\".txt`\n-    if [ -z \"${!parser_name+unset}\" ]; then\n-      if [ -f \"$kompiledDir/parser_$name\" ]; then\n-        parser=(\"$kompiledDir/parser_$name\")\n-      elif [ \"$name\" = \"PGM\" ]; then\n-        if $hasArgv; then\n-          parser=(kast -d \"$dir\" -o kore)\n+    if [ -f $kompiledDir\"/sort_\"$name\".txt\" ]; then\n+      sortName=`cat \"$kompiledDir\"/sort_\"$name\".txt`\n+      if [ -z \"${!parser_name+unset}\" ]; then\n+        if [ -f \"$kompiledDir/parser_$name\" ]; then\n+          parser=(\"$kompiledDir/parser_$name\")\n+        elif [ \"$name\" = \"PGM\" ]; then\n+          if $hasArgv; then\n+            parser=(kast -d \"$dir\" -o kore)\n+          else\n+            parser=(kast -d \"$dir\" -m \"$mainModuleName\" -o kore)\n+          fi\n         else\n           parser=(kast -d \"$dir\" -m \"$mainModuleName\" -o kore)\n         fi\n       else\n-        parser=(kast -d \"$dir\" -m \"$mainModuleName\" -o kore)\n+        parser=(\"${!parser_name}\")\n       fi\n+      execute \"${parser[@]}\" \"${!config_name}\" > \"$tempFile\"\n+      configVars=\"$configVars -c $name $(basename $tempFile) $sortName korefile\"\n     else\n-      parser=(\"${!parser_name}\")\n+      warning \"Command line variable $name not found in the configuration. Ignoring.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNTA1NTc0OnYy", "diffSide": "RIGHT", "path": "kernel/src/main/java/org/kframework/krun/KRun.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1NzoyM1rOIS7kzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1NzoyM1rOIS7kzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcyMTM1OQ==", "bodyText": "please don't remove braces like this. I know it's not strictly necessary since there's only one statement inside the braces, but it's still bad code style.", "url": "https://github.com/kframework/k/pull/1708#discussion_r556721359", "createdAt": "2021-01-13T17:57:23Z", "author": {"login": "dwightguth"}, "path": "kernel/src/main/java/org/kframework/krun/KRun.java", "diffHunk": "@@ -152,17 +153,22 @@ public static Rule parsePattern(FileUtil files, KExceptionManager kem, String pa\n \n     private K parseConfigVars(KRunOptions options, CompiledDefinition compiledDef) {\n         HashMap<KToken, K> output = new HashMap<>();\n+        scala.collection.Set<KToken> expectedConfigVars = new ConfigurationInfoFromModule(compiledDef.kompiledDefinition.mainModule()).configVars();\n         for (Map.Entry<String, Pair<String, String>> entry\n                 : options.configurationCreation.configVars(compiledDef.getParsedDefinition().mainModule().name(), files).entrySet()) {\n             String name = entry.getKey();\n-            String value = entry.getValue().getLeft();\n-            String parser = entry.getValue().getRight();\n             String configVarName = \"$\" + name;\n-            Sort sort = compiledDef.configurationVariableDefaultSorts.getOrDefault(configVarName, compiledDef.programStartSymbol);\n-            K configVar = externalParse(parser, value, sort, Source.apply(\"<command line: -c\" + name + \">\"), compiledDef);\n-            output.put(KToken(configVarName, Sorts.KConfigVar()), configVar);\n+            if (!expectedConfigVars.contains(KToken(configVarName, Sorts.KConfigVar())) && !name.equals(\"$STDIN\") && !name.equals(\"$IO\")) {\n+                kem.registerCompilerWarning(ExceptionType.INVALID_CONFIG_VAR, \"Command line variable \" + name + \" not found in the configuration. Ignoring.\");\n+            } else {\n+                String value = entry.getValue().getLeft();\n+                String parser = entry.getValue().getRight();\n+                Sort sort = compiledDef.configurationVariableDefaultSorts.getOrDefault(configVarName, compiledDef.programStartSymbol);\n+                K configVar = externalParse(parser, value, sort, Source.apply(\"<command line: -c\" + name + \">\"), compiledDef);\n+                output.put(KToken(configVarName, Sorts.KConfigVar()), configVar);\n+            }\n         }\n-        if (compiledDef.kompiledDefinition.mainModule().allSorts().contains(Sorts.String())) {\n+        if (compiledDef.kompiledDefinition.mainModule().allSorts().contains(Sorts.String()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwNTA1NzIyOnYy", "diffSide": "RIGHT", "path": "kernel/src/main/java/org/kframework/krun/KRun.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1Nzo0MlrOIS7lwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNzo1Nzo0MlrOIS7lwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjcyMTYwMQ==", "bodyText": "same with these", "url": "https://github.com/kframework/k/pull/1708#discussion_r556721601", "createdAt": "2021-01-13T17:57:42Z", "author": {"login": "dwightguth"}, "path": "kernel/src/main/java/org/kframework/krun/KRun.java", "diffHunk": "@@ -171,32 +177,12 @@ private K parseConfigVars(KRunOptions options, CompiledDefinition compiledDef) {\n                 output.put(KToken(\"$STDIN\", Sorts.KConfigVar()), KToken(StringUtil.enquoteKString(stdin), Sorts.String()));\n                 output.put(KToken(\"$IO\", Sorts.KConfigVar()), KToken(\"\\\"off\\\"\", Sorts.String()));\n             }\n-        }\n-        if (options.global.debug()) {\n-            // on the critical path, so don't perform this check because it's slow unless we're debugging.\n-            checkConfigVars(output.keySet(), compiledDef);\n-        }\n+        for (KToken defConfigVar : mutable(expectedConfigVars))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e99eb017e58d3764d305b4933c201dfe0e789c5b"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2879, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}