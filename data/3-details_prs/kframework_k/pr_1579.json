{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTQ4MTA0", "number": 1579, "title": "Check that constructors of builtin sorts are not declared", "bodyText": "Fixes: #1568", "createdAt": "2020-10-01T21:09:32Z", "url": "https://github.com/kframework/k/pull/1579", "merged": true, "mergeCommit": {"oid": "d8a6e5ca6a2bf093b7a13736b2e11e2cfc030ad8"}, "closed": true, "closedAt": "2020-12-08T19:49:42Z", "author": {"login": "dwightguth"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbkGpbABqjM5ODU1NTY3NDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkN5KtgH2gAyNDk2NTQ4MTA0OmQ3ZTQ2NGJkMmNkNGMyNzQ3MTBkYzg0YjI3YThkNGE0YjM3OWJjMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d52a18fde6227b90dd1a5522aebf1c8e5c38c531", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/d52a18fde6227b90dd1a5522aebf1c8e5c38c531", "committedDate": "2020-11-11T19:24:50Z", "message": "fix macro case"}, "afterCommit": {"oid": "f47badf598158abe9c288bb0f356a65c281fae79", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/f47badf598158abe9c288bb0f356a65c281fae79", "committedDate": "2020-11-11T20:36:44Z", "message": "allow bracket productions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abbd81b05c5cd6e940300d591f3f7e35e5045b71", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/abbd81b05c5cd6e940300d591f3f7e35e5045b71", "committedDate": "2020-11-11T20:49:15Z", "message": "fix whitespace"}, "afterCommit": {"oid": "a959bb4be0c62eadb39a468e0ad041339ec3f026", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/a959bb4be0c62eadb39a468e0ad041339ec3f026", "committedDate": "2020-11-16T19:57:35Z", "message": "fix whitespace"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af5a4f0f7d1ceaecf5ccc727c881da5929b27b0c", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/af5a4f0f7d1ceaecf5ccc727c881da5929b27b0c", "committedDate": "2020-11-18T19:11:43Z", "message": "fix test"}, "afterCommit": {"oid": "0018e098774d62418af9b176d0fb26add8d39176", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/0018e098774d62418af9b176d0fb26add8d39176", "committedDate": "2020-12-01T20:32:04Z", "message": "delete irredeemably ill-formed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d075f2d7a405937ec19237392f15509e5235301f", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/d075f2d7a405937ec19237392f15509e5235301f", "committedDate": "2020-12-03T20:35:47Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452f38330c9722ccc8547923bb9ea8dc6da14cb1", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/452f38330c9722ccc8547923bb9ea8dc6da14cb1", "committedDate": "2020-12-03T20:35:47Z", "message": "add check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e582ed3aac668d7cbb5bf8c67ad036165b4a77cb", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/e582ed3aac668d7cbb5bf8c67ad036165b4a77cb", "committedDate": "2020-12-03T20:35:47Z", "message": "fix bugs in tests/equiv"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "574b48454c9638f53dc02663bc02412680831ddb", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/574b48454c9638f53dc02663bc02412680831ddb", "committedDate": "2020-12-03T20:35:47Z", "message": "add bug fix for issue with cell collection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b59847b993d4ead8f7a8d507c68eb21aa80762e7", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/b59847b993d4ead8f7a8d507c68eb21aa80762e7", "committedDate": "2020-12-03T20:35:47Z", "message": "fix macro case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05a84b292c0a6c2f37c8be6d6fa66d5663fbe897", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/05a84b292c0a6c2f37c8be6d6fa66d5663fbe897", "committedDate": "2020-12-03T20:35:47Z", "message": "allow bracket productions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6b162af8c8ea0ba8eba68bf1d7b09b880d4fdad", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/b6b162af8c8ea0ba8eba68bf1d7b09b880d4fdad", "committedDate": "2020-12-03T20:35:47Z", "message": "fix whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dd95495a13fdd7d76ac0272424561e50cd72099", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/6dd95495a13fdd7d76ac0272424561e50cd72099", "committedDate": "2020-12-03T20:35:47Z", "message": "remove stale ill formed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393171da60ea5d8f1cda7a6fee7ffa2136947fe1", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/393171da60ea5d8f1cda7a6fee7ffa2136947fe1", "committedDate": "2020-12-03T20:35:47Z", "message": "add missing function attribute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b4364dbfde29305f11c5afdd3e8f61b1578421a", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/8b4364dbfde29305f11c5afdd3e8f61b1578421a", "committedDate": "2020-12-03T20:35:47Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3fd462a5ff0b61a1ff4e7c899bc82755fc0df16", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/a3fd462a5ff0b61a1ff4e7c899bc82755fc0df16", "committedDate": "2020-12-03T20:35:47Z", "message": "delete irredeemably ill-formed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5766744c68b05c635af5e6d33f0d9bc893bf358e", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/5766744c68b05c635af5e6d33f0d9bc893bf358e", "committedDate": "2020-12-03T20:37:12Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0018e098774d62418af9b176d0fb26add8d39176", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/0018e098774d62418af9b176d0fb26add8d39176", "committedDate": "2020-12-01T20:32:04Z", "message": "delete irredeemably ill-formed test"}, "afterCommit": {"oid": "5766744c68b05c635af5e6d33f0d9bc893bf358e", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/5766744c68b05c635af5e6d33f0d9bc893bf358e", "committedDate": "2020-12-03T20:37:12Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245a0b7603c30b60d6eb514e256cce7e88ccdefe", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/245a0b7603c30b60d6eb514e256cce7e88ccdefe", "committedDate": "2020-12-04T20:16:56Z", "message": "exclude kvar on java backend from check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a29106f653f8813076c769bed584199707d03b3", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/0a29106f653f8813076c769bed584199707d03b3", "committedDate": "2020-12-07T18:24:05Z", "message": "Merge branch 'master' into hook"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjI3NjQ0", "url": "https://github.com/kframework/k/pull/1579#pullrequestreview-546627644", "createdAt": "2020-12-07T23:29:47Z", "commit": {"oid": "0a29106f653f8813076c769bed584199707d03b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoyOTo0N1rOIA_sBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoyOTo0N1rOIA_sBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxNDM3Mw==", "bodyText": "Can we instead have a pass which runs before this and does:\n\nThe same check, and if it passes adds the constructor attribute if it determines that the production is an attribute.\nThen this check is changed to loop over all productions with constructor attribute and make sure none of them are targeting builtin sorts.\n\nThis has the benefit of (i) clearly defining what we call a \"constructor\", and (ii) adding the attribute to productions in case it's useful to the other various tools/backends.", "url": "https://github.com/kframework/k/pull/1579#discussion_r537914373", "createdAt": "2020-12-07T23:29:47Z", "author": {"login": "ehildenb"}, "path": "kernel/src/main/java/org/kframework/compile/checks/CheckAtt.java", "diffHunk": "@@ -3,28 +3,57 @@\n \n import org.kframework.attributes.Att;\n import org.kframework.attributes.HasLocation;\n+import org.kframework.builtin.Sorts;\n+import org.kframework.compile.ExpandMacros;\n import org.kframework.definition.Module;\n+import org.kframework.definition.Production;\n import org.kframework.definition.Rule;\n import org.kframework.definition.Sentence;\n+import org.kframework.kore.KLabel;\n import org.kframework.utils.errorsystem.KEMException;\n \n import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static org.kframework.Collections.*;\n \n /**\n  * Created by dwightguth on 1/25/16.\n  */\n public class CheckAtt {\n+    private final Set<KLabel> macros;\n     private final Set<KEMException> errors;\n     private final Module m;\n+    private final boolean isSymbolicKast;\n \n-    public CheckAtt(Set<KEMException> errors, Module m) {\n+    public CheckAtt(Set<KEMException> errors, Module m, boolean isSymbolicKast) {\n         this.errors = errors;\n         this.m = m;\n+        this.isSymbolicKast = isSymbolicKast;\n+        this.macros = stream(m.rulesFor()).filter(e -> stream(e._2()).filter(r -> ExpandMacros.isMacro(r)).findAny().isPresent()).map(e -> e._1()).collect(Collectors.toSet());\n     }\n \n     public void check(Sentence sentence) {\n         if (sentence instanceof Rule) {\n             check(((Rule) sentence).att(), sentence);\n+        } else if (sentence instanceof Production) {\n+            check((Production) sentence);\n+        }\n+    }\n+\n+    private void check(Production prod) {\n+        if (!prod.sort().equals(Sorts.KItem())) {\n+            Att sortAtt =  m.sortAttributesFor().getOrElse(prod.sort().head(), () -> Att.empty());\n+            if (sortAtt.contains(Att.HOOK()) && !sortAtt.get(Att.HOOK()).equals(\"ARRAY.Array\") && !(sortAtt.get(Att.HOOK()).equals(\"KVAR.KVar\") && isSymbolicKast)) {\n+                if (!prod.att().contains(Att.FUNCTION()) && !prod.att().contains(Att.BRACKET()) &&\n+                    !prod.att().contains(\"token\") && !(prod.klabel().isDefined() && macros.contains(prod.klabel().get()))) {\n+                    if (!(prod.sort().equals(Sorts.K()) && ((prod.klabel().isDefined() && (prod.klabel().get().name().equals(\"#EmptyK\") || prod.klabel().get().name().equals(\"#KSequence\"))) || prod.isSubsort()))) {\n+                        if (!(sortAtt.contains(\"cellCollection\") && prod.isSubsort())) {\n+                            errors.add(KEMException.compilerError(\"Cannot add new constructors to hooked sort \" + prod.sort(), prod));\n+                        }\n+                    }\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a29106f653f8813076c769bed584199707d03b3"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDc1NzE4", "url": "https://github.com/kframework/k/pull/1579#pullrequestreview-547475718", "createdAt": "2020-12-08T17:43:44Z", "commit": {"oid": "0a29106f653f8813076c769bed584199707d03b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7e464bd2cd4c274710dc84b27a8d4a4b379bc18", "author": {"user": {"login": "rv-jenkins", "name": null}}, "url": "https://github.com/kframework/k/commit/d7e464bd2cd4c274710dc84b27a8d4a4b379bc18", "committedDate": "2020-12-08T17:49:43Z", "message": "Merge branch 'master' into hook"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2222, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}