{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MDg0NzEw", "number": 1287, "title": "Changes to K frontend to support new C++ unparsing", "bodyText": "This is not ready to be merged yet, but feel free to review it as a companion to kframework/llvm-backend#334.", "createdAt": "2020-05-14T15:49:10Z", "url": "https://github.com/kframework/k/pull/1287", "merged": true, "mergeCommit": {"oid": "b0845f74ce2ce57c17b3fd374108e95d1448e603"}, "closed": true, "closedAt": "2020-05-22T11:00:59Z", "author": {"login": "dwightguth"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchS2e3gFqTQxMjEyNTAwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjk5c7AH2gAyNDE4MDg0NzEwOmE0YzgxZDliOTk3NTdlOTEyMzIwNzQzMDRhMjM4Nzg0MTdmOGNkNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTI1MDA2", "url": "https://github.com/kframework/k/pull/1287#pullrequestreview-412125006", "createdAt": "2020-05-14T19:37:22Z", "commit": {"oid": "7bb81ce3852919f4cdc64224c8ef055ee55bdd7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTozNzoyMlrOGVrXpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTozNzoyMlrOGVrXpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4Mzg0NQ==", "bodyText": "Why is this for loop inside the above one? It does not seem to depend on sort, which, I guess, would mean that genSubsortAxiom below generates multiple identical axioms (assuming that the bracketProductionsFor can have more than one entry).", "url": "https://github.com/kframework/k/pull/1287#discussion_r425383845", "createdAt": "2020-05-14T19:37:22Z", "author": {"login": "virgil-serbanuta"}, "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -198,6 +197,26 @@ public String convert(boolean heatCoolEq, StringBuilder sb) {\n         }\n         translateSymbols(attributes, functionRules, impurities, overloads, sb);\n \n+        // print syntax definition\n+        int length = sb.length();\n+        for (Tuple2<Sort, scala.collection.immutable.List<Production>> sort : iterable(module.bracketProductionsFor())) {\n+            for (Production prod : iterable(sort._2())) {\n+                translateSymbol(attributes, functionRules, impurities, overloads, prod.att().get(\"bracketLabel\", KLabel.class), prod, sb);\n+            }\n+            for (Production prod : iterable(module.sortedProductions())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb81ce3852919f4cdc64224c8ef055ee55bdd7b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTQwMjc3", "url": "https://github.com/kframework/k/pull/1287#pullrequestreview-412140277", "createdAt": "2020-05-14T19:59:35Z", "commit": {"oid": "7bb81ce3852919f4cdc64224c8ef055ee55bdd7b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTo1OTozNVrOGVsGeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTo1OTozNVrOGVsGeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5NTgzMg==", "bodyText": "It would be nice if these new attributes would be documented somewhere.", "url": "https://github.com/kframework/k/pull/1287#discussion_r425395832", "createdAt": "2020-05-14T19:59:35Z", "author": {"login": "virgil-serbanuta"}, "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -1452,17 +1404,62 @@ private Att addKoreAttributes(Production prod, SetMultimap<KLabel, Rule> functio\n         String format = att.getOptional(\"format\").orElse(Formatter.defaultFormat(prod.items().size()));\n         int nt = 1;\n         boolean hasFormat = true;\n+        int terminals = 0;\n         for (int i = 0; i < prod.items().size(); i++) {\n           if (prod.items().apply(i) instanceof NonTerminal) {\n             format = format.replaceAll(\"%\" + (i+1) + \"(?![0-9])\", \"%\" + (nt++));\n           } else if (prod.items().apply(i) instanceof Terminal) {\n             format = format.replaceAll(\"%\" + (i+1) + \"(?![0-9])\", \"%c\" + ((Terminal)prod.items().apply(i)).value().replace(\"\\\\\", \"\\\\\\\\\").replace(\"$\", \"\\\\$\") + \"%r\");\n+            terminals++;\n           } else {\n             hasFormat = false;\n           }\n         }\n         if (hasFormat) {\n           att = att.add(\"format\", format);\n+          if (att.contains(\"color\")) {\n+            boolean escape = false;\n+            StringBuilder colors = new StringBuilder();\n+            String conn = \"\";\n+            for (int i = 0; i < format.length(); i++) {\n+              if (escape && format.charAt(i) == 'c') {\n+                colors.append(conn).append(att.get(\"color\"));\n+                conn = \",\";\n+              }\n+              if (format.charAt(i) == '%') {\n+                escape = true;\n+              } else {\n+                escape = false;\n+              }\n+            }\n+            att = att.add(\"colors\", colors.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb81ce3852919f4cdc64224c8ef055ee55bdd7b"}, "originalPosition": 257}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66fede522a2ee4f7c1955b24530a22fcb5ba55f9", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/66fede522a2ee4f7c1955b24530a22fcb5ba55f9", "committedDate": "2020-05-15T19:03:56Z", "message": "remove old unparsing data in text files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed17c609d4f7aff050d16e9fb5c586e87334657b", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/ed17c609d4f7aff050d16e9fb5c586e87334657b", "committedDate": "2020-05-15T19:03:56Z", "message": "refactor out Att.BRACKET() value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58baa0c15ae7fd8826d29211fbf8c8975fdf26b", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/a58baa0c15ae7fd8826d29211fbf8c8975fdf26b", "committedDate": "2020-05-15T19:03:56Z", "message": "code to annotate bracket productions with what their klabel would have\nbeen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "429c4488e8a333b64466fba4f7836ee5fc82ffad", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/429c4488e8a333b64466fba4f7836ee5fc82ffad", "committedDate": "2020-05-15T19:03:56Z", "message": "delete dead code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565a54f2add8df0352919f9a0dc3fb0525a514c9", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/565a54f2add8df0352919f9a0dc3fb0525a514c9", "committedDate": "2020-05-15T19:03:56Z", "message": "refactor out translateSymbol method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184033879c07b3a2c6df436551ca3423330ce4b9", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/184033879c07b3a2c6df436551ca3423330ce4b9", "committedDate": "2020-05-15T19:03:56Z", "message": "print attribute of type KList as kore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b267134a21517e2e206d9246def5da1fa3c407ab", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/b267134a21517e2e206d9246def5da1fa3c407ab", "committedDate": "2020-05-15T19:03:56Z", "message": "add attributes for formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c90879443af0847d4bfc5f377cd6a5276ab37c", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/88c90879443af0847d4bfc5f377cd6a5276ab37c", "committedDate": "2020-05-15T19:03:56Z", "message": "emit only syntax definition plus brackets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33aa3087ee3bad02df2a2ddffe9c78b020b19b0e", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/33aa3087ee3bad02df2a2ddffe9c78b020b19b0e", "committedDate": "2020-05-15T19:03:56Z", "message": "fix bug from review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30faa4cf3eec04504c2873fe8d463e41f0619074", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/30faa4cf3eec04504c2873fe8d463e41f0619074", "committedDate": "2020-05-15T19:04:43Z", "message": "update llvm backend submodule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3eecef13168b368ed109970cdbe16f57e9d099fa", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/3eecef13168b368ed109970cdbe16f57e9d099fa", "committedDate": "2020-05-14T20:03:17Z", "message": "fix bug from review comment"}, "afterCommit": {"oid": "30faa4cf3eec04504c2873fe8d463e41f0619074", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/30faa4cf3eec04504c2873fe8d463e41f0619074", "committedDate": "2020-05-15T19:04:43Z", "message": "update llvm backend submodule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eed3187c9e1357798eae5588ea4f19f37ab70378", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/eed3187c9e1357798eae5588ea4f19f37ab70378", "committedDate": "2020-05-15T19:48:28Z", "message": "fix bug involving colors attribute"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDgwNzUw", "url": "https://github.com/kframework/k/pull/1287#pullrequestreview-413480750", "createdAt": "2020-05-18T10:49:56Z", "commit": {"oid": "eed3187c9e1357798eae5588ea4f19f37ab70378"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo0OTo1NlrOGWxydQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo0OTo1NlrOGWxydQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNzU4OQ==", "bodyText": "I don't see this used anywhere. It's just incremented in the below loop, but then the value doesn't seem to be used.", "url": "https://github.com/kframework/k/pull/1287#discussion_r426537589", "createdAt": "2020-05-18T10:49:56Z", "author": {"login": "ehildenb"}, "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -1416,17 +1370,62 @@ private Att addKoreAttributes(Production prod, SetMultimap<KLabel, Rule> functio\n         String format = att.getOptional(\"format\").orElse(Formatter.defaultFormat(prod.items().size()));\n         int nt = 1;\n         boolean hasFormat = true;\n+        int terminals = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed3187c9e1357798eae5588ea4f19f37ab70378"}, "originalPosition": 231}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDgxNDk2", "url": "https://github.com/kframework/k/pull/1287#pullrequestreview-413481496", "createdAt": "2020-05-18T10:51:09Z", "commit": {"oid": "eed3187c9e1357798eae5588ea4f19f37ab70378"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo1MTowOVrOGWx06g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMDo1MTowOVrOGWx06g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzODIxOA==", "bodyText": "So now instead of writing separate files with the unparsing information, we're adding attributes to the generated Kore file?\nI like the approach more, just want to make sure I understand.", "url": "https://github.com/kframework/k/pull/1287#discussion_r426538218", "createdAt": "2020-05-18T10:51:09Z", "author": {"login": "ehildenb"}, "path": "kernel/src/main/java/org/kframework/backend/kore/ModuleToKORE.java", "diffHunk": "@@ -356,87 +361,34 @@ private void translateSymbols(Map<String, Boolean> attributes, SetMultimap<KLabe\n             if (impurities.contains(prod.klabel().get())) {\n                 impureFunctions.add(prod.klabel().get().name());\n             }\n-            sb.append(\"  \");\n-            if (isFunction(prod) && prod.att().contains(Att.HOOK()) && isRealHook(prod.att())) {\n-                sb.append(\"hooked-\");\n-            }\n-            sb.append(\"symbol \");\n-            convert(prod.klabel().get(), prod.params(), sb);\n-            String conn;\n-            sb.append(\"(\");\n-            conn = \"\";\n-            for (NonTerminal nt : iterable(prod.nonterminals())) {\n-                Sort sort = nt.sort();\n-                sb.append(conn);\n-                convert(sort, prod, sb);\n-                conn = \", \";\n-            }\n-            sb.append(\") : \");\n-            convert(prod.sort(), prod, sb);\n-            sb.append(\" \");\n-            Att koreAtt = addKoreAttributes(prod, functionRules, impurities, overloads);\n-            convert(attributes, koreAtt, sb, null, null);\n-            writeUnparsingDataForSymbol(prod, koreAtt);\n-            sb.append(\"\\n\");\n+            translateSymbol(attributes, functionRules, impurities, overloads, prod.klabel().get(), prod, sb);\n         }\n     }\n \n-    private void writeUnparsingDataForSymbol(Production prod, Att koreAtt) {\n-        if (koreAtt.contains(\"format\")) {\n-            formats.append(\"Lbl\");\n-            convert(prod.klabel().get().name(), formats);\n-            formats.append('\\n');\n-            formats.append(koreAtt.get(\"format\"));\n-            formats.append('\\n');\n-        }\n-        if (koreAtt.contains(\"color\")) {\n-            colors.append(\"Lbl\");\n-            convert(prod.klabel().get().name(), colors);\n-            colors.append('\\n');\n-            for (int i = 0; i < prod.items().size(); i++) {\n-                if (prod.items().apply(i) instanceof Terminal) {\n-                    colors.append(koreAtt.get(\"color\"));\n-                    colors.append('\\n');\n-                }\n-            }\n-            if (koreAtt.contains(\"format\")) {\n-              String format = koreAtt.get(\"format\");\n-              boolean escape = false;\n-              for (int i = 0; i < format.length(); i++) {\n-                if (escape && format.charAt(i) == 'c') {\n-                  colors.append(koreAtt.get(\"color\"));\n-                  colors.append('\\n');\n-                }\n-                if (format.charAt(i) == '%') {\n-                  escape = true;\n-                } else {\n-                  escape = false;\n-                }\n-              }\n-            }\n-            colors.append('\\n');\n-        } else if (koreAtt.contains(\"colors\")) {\n-            String[] data = koreAtt.get(\"colors\").split(\",\");\n-            colors.append(\"Lbl\");\n-            convert(prod.klabel().get().name(), colors);\n-            colors.append('\\n');\n-            for (int i = 0; i < data.length; i++) {\n-                colors.append(data[i].trim());\n-                colors.append('\\n');\n-            }\n-            colors.append('\\n');\n-        }\n-        if (koreAtt.contains(\"assoc\")) {\n-            assocs.append(\"Lbl\");\n-            convert(prod.klabel().get().name(), assocs);\n-            assocs.append('\\n');\n+    private void translateSymbol(Map<String, Boolean> attributes, SetMultimap<KLabel, Rule> functionRules, Set<KLabel> impurities, Set<Production> overloads, KLabel label, Production prod, StringBuilder sb) {\n+        sb.append(\"  \");\n+        if (isFunction(prod) && prod.att().contains(Att.HOOK()) && isRealHook(prod.att())) {\n+            sb.append(\"hooked-\");\n         }\n-        if (koreAtt.contains(\"comm\")) {\n-            comms.append(\"Lbl\");\n-            convert(prod.klabel().get().name(), comms);\n-            comms.append('\\n');\n+        sb.append(\"symbol \");\n+        convert(label, prod.params(), sb);\n+        String conn;\n+        sb.append(\"(\");\n+        conn = \"\";\n+        for (NonTerminal nt : iterable(prod.nonterminals())) {\n+            Sort sort = nt.sort();\n+            sb.append(conn);\n+            convert(sort, prod, sb);\n+            conn = \", \";\n         }\n+        sb.append(\") : \");\n+        convert(prod.sort(), prod, sb);\n+        sb.append(\" \");\n+        Att koreAtt = addKoreAttributes(prod, functionRules, impurities, overloads);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eed3187c9e1357798eae5588ea4f19f37ab70378"}, "originalPosition": 204}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2ea3ef953228240c7e8155c539e74425d0f697", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/9d2ea3ef953228240c7e8155c539e74425d0f697", "committedDate": "2020-05-18T17:25:22Z", "message": "fix whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9db0b494bbee12cdf6b68ffa7eee10ddd2171e9", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/a9db0b494bbee12cdf6b68ffa7eee10ddd2171e9", "committedDate": "2020-05-18T17:25:51Z", "message": "Merge branch 'master' into bracket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10e637b9bef004c5047e911d868e2a7baed90526", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/10e637b9bef004c5047e911d868e2a7baed90526", "committedDate": "2020-05-20T14:16:36Z", "message": "delete unused variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79b0fa255e2974368180cca745369ccd00bd157f", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/79b0fa255e2974368180cca745369ccd00bd157f", "committedDate": "2020-05-20T14:16:42Z", "message": "Merge branch 'master' into bracket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841867634b04ebf7bd8e2372c5f2e49a9320d209", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/841867634b04ebf7bd8e2372c5f2e49a9320d209", "committedDate": "2020-05-20T18:16:42Z", "message": "Merge branch 'master' into bracket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5dd7b37740e113686578017383258516ccd8a54", "author": {"user": {"login": "dwightguth", "name": "Dwight Guth"}}, "url": "https://github.com/kframework/k/commit/e5dd7b37740e113686578017383258516ccd8a54", "committedDate": "2020-05-20T18:16:57Z", "message": "update llvm backend submodule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTE5MTkx", "url": "https://github.com/kframework/k/pull/1287#pullrequestreview-416519191", "createdAt": "2020-05-21T21:52:38Z", "commit": {"oid": "e5dd7b37740e113686578017383258516ccd8a54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4c81d9b99757e91232074304a23878417f8cd63", "author": {"user": {"login": "ehildenb", "name": "Everett Hildenbrandt"}}, "url": "https://github.com/kframework/k/commit/a4c81d9b99757e91232074304a23878417f8cd63", "committedDate": "2020-05-21T21:52:46Z", "message": "Merge branch 'master' into bracket"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2372, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}