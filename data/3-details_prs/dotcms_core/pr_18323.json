{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1ODI1ODEy", "number": 18323, "title": "#18233 integrating app into the translate actionlet", "bodyText": "Integrating the translation actionlet with the apps\nCreated tests for the secret getter, the translation functionality is already tested in GoogleTranslationServiceTest.", "createdAt": "2020-04-20T05:03:43Z", "url": "https://github.com/dotCMS/core/pull/18323", "merged": true, "mergeCommit": {"oid": "8004bdd846f992fda392e136ed653984cf7a170d"}, "closed": true, "closedAt": "2020-08-14T20:57:25Z", "author": {"login": "jdotcms"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZX3fcgH2gAyNDA1ODI1ODEyOmJiOTgwYmY4NjM1ZWRiZTgxN2IzNDY2YWUzZGQxMGY2ZjExNmRhYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-7JiOAFqTQ2Nzg3NDEyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb980bf8635edbe817b3466ae3dd10f6f116dabb", "author": {"user": {"login": "jdotcms", "name": "Jonathan"}}, "url": "https://github.com/dotCMS/core/commit/bb980bf8635edbe817b3466ae3dd10f6f116dabb", "committedDate": "2020-04-20T05:02:37Z", "message": "#18233 integrating app into the translate actionlet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTEwMTcy", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-396510172", "createdAt": "2020-04-20T14:31:30Z", "commit": {"oid": "bb980bf8635edbe817b3466ae3dd10f6f116dabb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozMTozMFrOGIXe3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozMTozMFrOGIXe3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyNjUyNA==", "bodyText": "I think we are missing some test here", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r411426524", "createdAt": "2020-04-20T14:31:30Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -121,7 +135,47 @@ public void setServiceParameters(List<ServiceParameter> params) {\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey();\n+    }\n+\n+\n+    private String getFallbackApiKey () {\n+\n+        final String appsTranslationKey    = Config.getStringProperty(\"apps_translation_key\", \"app-translation\");\n+        final String appsTranslationApiKey = Config.getStringProperty(\"apps_translation_apikey\", \"apiKey\");\n+\n+        Optional<AppSecrets> appSecretsOpt = Optional.empty();\n+        try {\n+            appSecretsOpt = APILocator.getAppsAPI().getSecrets\n+                    (appsTranslationKey, true, this.resolveHost(), APILocator.systemUser());\n+        } catch (DotDataException | DotSecurityException e) {\n+            Logger.error(this, e.getMessage());\n+        }\n+\n+        if (appSecretsOpt.isPresent()) {\n+\n+            final Secret secret = appSecretsOpt.get().getSecrets().get(appsTranslationApiKey);\n+            if (null != secret) {\n+                return secret.getString();\n+            }\n+        }\n+\n+        return Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", StringPool.BLANK);\n+    }\n+\n+    private Host resolveHost () {\n+\n+        Host  host = null;\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        if (null != request) {\n+            host = Try.of(()->WebAPILocator.getHostWebAPI().getCurrentHostNoThrow(request)).getOrNull();\n+        }\n+\n+        if (null == host) {\n+            host = Try.of(() -> APILocator.getHostAPI().findDefaultHost(APILocator.systemUser(), false)).getOrNull();\n+        }\n+\n+        return null == host? APILocator.systemHost(): host;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb980bf8635edbe817b3466ae3dd10f6f116dabb"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b85b4153a6e59710e24901250520302fd9fb3192", "author": {"user": {"login": "jdotcms", "name": "Jonathan"}}, "url": "https://github.com/dotCMS/core/commit/b85b4153a6e59710e24901250520302fd9fb3192", "committedDate": "2020-04-20T15:53:13Z", "message": "#18233 now the host is being taking from the content host"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjE0NDk4", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-396614498", "createdAt": "2020-04-20T16:25:08Z", "commit": {"oid": "b85b4153a6e59710e24901250520302fd9fb3192"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDYwMjY0", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-397460264", "createdAt": "2020-04-21T16:03:56Z", "commit": {"oid": "b85b4153a6e59710e24901250520302fd9fb3192"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjowNDowMFrOGJMqgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjowNDowMFrOGJMqgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5Nzg1Nw==", "bodyText": "This logic should be tested", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r412297857", "createdAt": "2020-04-21T16:04:00Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -113,15 +127,60 @@ public String translateString(String toTranslate, Language from, Language to) th\n     }\n \n     @Override\n-    public void setServiceParameters(List<ServiceParameter> params) {\n+    public void setServiceParameters(final List<ServiceParameter> params, final Optional<String> hostOpt) {\n         this.params = params;\n         Map<String, ServiceParameter> paramsMap = params.stream().collect(\n             Collectors.toMap(ServiceParameter::getKey, Function.identity()));\n         String apiKeyValue = paramsMap.get(\"apiKey\").getValue();\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey(hostOpt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b85b4153a6e59710e24901250520302fd9fb3192"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce16e31c73aeaa532615eb7dda140b35a9fae6a", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/cce16e31c73aeaa532615eb7dda140b35a9fae6a", "committedDate": "2020-08-10T18:14:58Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18233-translate-service-app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04710ad1cd423879894e28f6cfd4cb04edc05c2e", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/04710ad1cd423879894e28f6cfd4cb04edc05c2e", "committedDate": "2020-08-11T17:33:46Z", "message": "#18233 add googleTranslate config yaml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a51fa151517be1016e9b4f8d87af7a7e8fd332f", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/6a51fa151517be1016e9b4f8d87af7a7e8fd332f", "committedDate": "2020-08-11T17:34:52Z", "message": "#18233 refactor translate service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d613f337b1f2ebaf2f4f681bfd4e0f7b208eb4c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/7d613f337b1f2ebaf2f4f681bfd4e0f7b208eb4c", "committedDate": "2020-08-11T18:51:10Z", "message": "#18233 feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2a79d130167756d98bbacd1e9cf0a9c8e75288", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/9c2a79d130167756d98bbacd1e9cf0a9c8e75288", "committedDate": "2020-08-11T21:54:58Z", "message": "#18233 check if appSecrets is present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81a817c6426153e914eb75195a6d380fce83dae", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e81a817c6426153e914eb75195a6d380fce83dae", "committedDate": "2020-08-11T21:55:34Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18233-translate-service-app"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8", "committedDate": "2020-08-11T21:56:57Z", "message": "#18233 tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDAwMDg5", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-466000089", "createdAt": "2020-08-12T14:57:17Z", "commit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1NzoxN1rOG_lNIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1NzoxN1rOG_lNIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzA0MA==", "bodyText": "Tests need doc", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r469323040", "createdAt": "2020-08-12T14:57:17Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDU4MTg2", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-466058186", "createdAt": "2020-08-12T15:59:30Z", "commit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a80776ada647b8bdb65d622ea36ef5fef69b194", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/9a80776ada647b8bdb65d622ea36ef5fef69b194", "committedDate": "2020-08-12T16:43:14Z", "message": "#18233 doc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6571cd9d51f731fc0f6786ae1a1dc49606fb309", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e6571cd9d51f731fc0f6786ae1a1dc49606fb309", "committedDate": "2020-08-12T16:43:59Z", "message": "#18233 doc tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDk1MDQy", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-466095042", "createdAt": "2020-08-12T16:47:08Z", "commit": {"oid": "e6571cd9d51f731fc0f6786ae1a1dc49606fb309"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38fe83ebe9c8e955c6a3a70194377c686e380f6", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e38fe83ebe9c8e955c6a3a70194377c686e380f6", "committedDate": "2020-08-13T15:22:45Z", "message": "#18233 rename yaml file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/b49bd0207c8eadb02ba8160904ed90d89ffafc3f", "committedDate": "2020-08-14T20:56:18Z", "message": "master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODc0MTI4", "url": "https://github.com/dotCMS/core/pull/18323#pullrequestreview-467874128", "createdAt": "2020-08-14T21:04:12Z", "commit": {"oid": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTowNDoxMlrOHBDRkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTowNDoxMlrOHBDRkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2NDI3NQ==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r470864275", "createdAt": "2020-08-14T21:04:12Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {\n+\n+    private static User admin;\n+    private static GoogleTranslationService translationService;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1001, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}