{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTg2MzY4", "number": 19628, "title": "#19489 #19458 Unique fields and tag fields are mapped as keywords", "bodyText": "With these changes, unique text fields are mapped in ES as keywords.\nOn the other hand, lucene queries used to validate fields uniqueness use _dotraw fields except for unique numbers (integer and float fields), as numeric datatypes behave like keywords in searches.", "createdAt": "2020-11-25T17:07:52Z", "url": "https://github.com/dotCMS/core/pull/19628", "merged": true, "mergeCommit": {"oid": "9e92ae9dc1f7a66d1bcdc710895164da9af0164c"}, "closed": true, "closedAt": "2020-12-02T20:35:44Z", "author": {"login": "nollymar"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgBfrVgH2gAyNTI3NTg2MzY4OmI1MGY5ZDIwY2U5MTk1YTQ1YmIwMWEwMzgzZGI0YTAyYzI5NGU5M2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiSZ1PAH2gAyNTI3NTg2MzY4OmViYTVlOTUzY2QyZjE1ZWUxYWMzOWM4YjZmZTBhMDJlZjBjYmE3YzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b50f9d20ce9195a45bb01a0383db4a02c294e93e", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/b50f9d20ce9195a45bb01a0383db4a02c294e93e", "committedDate": "2020-11-25T17:07:19Z", "message": "#19489 #19458 Unique fields and tag fields are mapped as keywords"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b83f95d1d90d38738463948c30756dab45ff3eaa", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/b83f95d1d90d38738463948c30756dab45ff3eaa", "committedDate": "2020-11-25T22:49:28Z", "message": "#19536 Using _dotraw to validate unique and key fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b50f420e9f90193022098cf6eca86d99262c2af8", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/b50f420e9f90193022098cf6eca86d99262c2af8", "committedDate": "2020-11-30T21:02:41Z", "message": "#19489 #19536 #19458 Fixing ITs and including new test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/c1a4682463a8ab30d8b4b79f11dbaafd0dbad987", "committedDate": "2020-11-30T21:47:50Z", "message": "#19489 #19458 New test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTcxODc5", "url": "https://github.com/dotCMS/core/pull/19628#pullrequestreview-541971879", "createdAt": "2020-12-01T14:46:42Z", "commit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzMxMDA4", "url": "https://github.com/dotCMS/core/pull/19628#pullrequestreview-541331008", "createdAt": "2020-11-30T22:02:35Z", "commit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMjozNVrOH8PnzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMzoyOVrOH8PpVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng==", "bodyText": "So this maps a tag field as keyword, but isn't there another part to this?  When putting a content tag field into ES, don't we have to put the tags in as an array of Strings?", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932556", "createdAt": "2020-11-30T22:02:35Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -361,20 +363,31 @@ private void addMappingForFieldIfNeeded(\n                 .of(DataTypes.BOOL, \"boolean\", DataTypes.FLOAT, \"double\", DataTypes.INTEGER,\n                         \"long\");\n         String mappingForField = null;\n-        if (field instanceof DateField || field instanceof DateTimeField\n-                || field instanceof TimeField) {\n-            mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n-            mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n-        } else if (field instanceof TextField || field instanceof TextAreaField\n-                || field instanceof WysiwygField || field instanceof RadioField\n-                || field instanceof SelectField) {\n-            if (dataTypesMap.containsKey(field.dataType())) {\n-                mappingForField = String.format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\", dataTypesMap.get(field.dataType()));\n-            } else if (!matchesExclusions(fieldVariableName)){\n-                mappingForField = \"{\\n\"\n-                        + \"\\\"type\\\":\\\"text\\\",\\n\"\n-                        + \"\\\"analyzer\\\":\\\"my_analyzer\\\"\"\n-                        + \"\\n}\";\n+\n+        if (!matchesExclusions(fieldVariableName)) {\n+            if (field instanceof DateField || field instanceof DateTimeField\n+                    || field instanceof TimeField) {\n+                mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n+                mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n+            } else if (field instanceof TextField || field instanceof TextAreaField\n+                    || field instanceof WysiwygField || field instanceof RadioField\n+                    || field instanceof SelectField || field instanceof MultiSelectField\n+                    || field instanceof TagField) {\n+\n+                if (dataTypesMap.containsKey(field.dataType())) {\n+                    mappingForField = String\n+                            .format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\",\n+                                    dataTypesMap.get(field.dataType()));\n+                } else {\n+                    if (field.unique() || field instanceof TagField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ==", "bodyText": "What if the unique field has a quote \" in its value?", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932949", "createdAt": "2020-11-30T22:03:29Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -6311,9 +6313,18 @@ else if(field.getFieldType().equals(Field.FieldType.DATE_TIME.toString())){\n \n                     buffy.append(\" +languageId:\" + contentlet.getLanguageId());\n \n-                    buffy.append(\" +\" + contentlet.getContentType().variable() + StringPool.PERIOD + field\n-                            .getVelocityVarName() + StringPool.COLON);\n-                    buffy.append(getFieldValue(contentlet, new LegacyFieldTransformer(field).from()));\n+                    buffy.append(\" +\" + contentlet.getContentType().variable()).append(StringPool.PERIOD)\n+                            .append(field.getVelocityVarName());\n+\n+                    if (isDataTypeNumber){\n+                        buffy.append(StringPool.COLON).append(\"\\\"\").append(getFieldValue(contentlet,\n+                                new LegacyFieldTransformer(field).from())).append(\"\\\"\");\n+                    }else{\n+                        buffy.append(\"_dotraw\").append(StringPool.COLON).append(\"\\\"\")\n+                                .append(getFieldValue(contentlet,\n+                                        new LegacyFieldTransformer(field).from()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDY0OTA3", "url": "https://github.com/dotCMS/core/pull/19628#pullrequestreview-542064907", "createdAt": "2020-12-01T16:15:21Z", "commit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e347ee2a00cb09a8d025a3a836fed96bac084373", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/e347ee2a00cb09a8d025a3a836fed96bac084373", "committedDate": "2020-12-02T01:40:25Z", "message": "#19489 Uniqueness validation should consider special characters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70d481733271db9ef3cbeac98d6f32acb8252c87", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/70d481733271db9ef3cbeac98d6f32acb8252c87", "committedDate": "2020-12-02T01:41:59Z", "message": "#19536 Uniqueness validation should consider special characters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5adda2ac87b58f3ba06961cdca086bd9aaf54f50", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/5adda2ac87b58f3ba06961cdca086bd9aaf54f50", "committedDate": "2020-12-02T16:57:30Z", "message": "Merge branch 'master' of https://github.com/dotCMS/core into fix-for-issues-19489-19536-19458"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eba5e953cd2f15ee1ac39c8b6fe0a02ef0cba7c5", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/eba5e953cd2f15ee1ac39c8b6fe0a02ef0cba7c5", "committedDate": "2020-12-02T17:57:10Z", "message": "#19536 Fixing failing tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1672, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}