{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNjEzMzAz", "number": 18638, "title": "Apps key regenerte", "bodyText": "This comes to solves two apps tickets:\n#18381 & #17938\nIt adds the ability to re-generate the company key. Update pp endpoints. And regenerate the keystore.\nAlso, it adds a cluster salt to be used as the key store password.\nThere's a counterpart for this PR on enterprise with the logic that loads and writes the cluster-slat", "createdAt": "2020-06-10T17:57:39Z", "url": "https://github.com/dotCMS/core/pull/18638", "merged": true, "mergeCommit": {"oid": "e2be86596c45006c9d76b41d875bcc590bcdf8d1"}, "closed": true, "closedAt": "2020-06-18T23:06:35Z", "author": {"login": "fabrizzio-dotCMS"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcafU3vAH2gAyNDMyNjEzMzAzOjc5ZmU1Yjk3MzcyZTE5OTg3NzFkNzVhOGI5OTYwZmQ0MDU2Y2M4YTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsmyjzAFqTQzMzcwNDYyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79fe5b97372e1998771d75a8b9960fd4056cc8a4", "author": {"user": {"login": "alfredo-dotcms", "name": null}}, "url": "https://github.com/dotCMS/core/commit/79fe5b97372e1998771d75a8b9960fd4056cc8a4", "committedDate": "2020-04-23T16:17:58Z", "message": "issue-18249-Refactor-Dot-Field-Variables core#18249 (#18290)\n\n* core#18249\r\n\r\n* Added missing languages\r\n\r\n* add hidden title label\r\n\r\n* custom label added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98e9bdb8269c3f230ec0cb75f24991b096d5057b", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/98e9bdb8269c3f230ec0cb75f24991b096d5057b", "committedDate": "2020-04-27T15:15:35Z", "message": "Merge branch 'master' of https://github.com/dotCMS/core into apps-feature-branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44fda47a71168a2a60fdf3ead1a2fa6557a63344", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/44fda47a71168a2a60fdf3ead1a2fa6557a63344", "committedDate": "2020-04-27T18:24:21Z", "message": "Issue 18218 warnings (#18360)\n\n* #18218 apps secret  warning checks\r\n\r\n* #18218 lang keys\r\n\r\n* #18218  warnings fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e511817f36777295385ded5df9eb3134fa47257", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/1e511817f36777295385ded5df9eb3134fa47257", "committedDate": "2020-04-27T22:44:49Z", "message": "  #18373 apps resilience when a site is deleted (#18365)\n\n* apps resilience when a site is deleted\r\n\r\n* # apps delete secrets for site\r\n\r\n* apps site delete resilience\r\n\r\n* # apps site delete resilience"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97acae1b22c048f3575b9fe21119244bb1f67996", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/97acae1b22c048f3575b9fe21119244bb1f67996", "committedDate": "2020-04-28T15:51:11Z", "message": "Merge branch 'master' of https://github.com/dotCMS/core into apps-feature-branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd31431c73ef647b622fe149d7784041d1b2ddd6", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/cd31431c73ef647b622fe149d7784041d1b2ddd6", "committedDate": "2020-04-28T15:51:39Z", "message": "Merge branch 'apps-feature-branch' of https://github.com/dotCMS/core into apps-feature-branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f812d12b4c56f6490539582f8f8e30f5fe83fbd", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/2f812d12b4c56f6490539582f8f8e30f5fe83fbd", "committedDate": "2020-04-28T23:32:40Z", "message": "#18218 fixes for apps  warnings (#18386)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "643b70f3e106d6984376d262f9154d76b6f80eb1", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/643b70f3e106d6984376d262f9154d76b6f80eb1", "committedDate": "2020-04-30T18:40:10Z", "message": "Merge branch 'master' of https://github.com/dotCMS/core into apps-feature-branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b654b9e09020d9ee09cfe86814f2bf32e619bd43", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/b654b9e09020d9ee09cfe86814f2bf32e619bd43", "committedDate": "2020-05-05T23:12:25Z", "message": "#17938 + #18381"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27de53f61c6b1ebb67f75a859ad34e27799f0c35", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/27de53f61c6b1ebb67f75a859ad34e27799f0c35", "committedDate": "2020-05-07T14:53:08Z", "message": "#17938  #18381 wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7efc997e154531b9afbb729021ea6921301be949", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/7efc997e154531b9afbb729021ea6921301be949", "committedDate": "2020-06-09T17:36:57Z", "message": "#18381 merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89fe9f9c4de724eb2132afa8504e9febf5c044ca", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/89fe9f9c4de724eb2132afa8504e9febf5c044ca", "committedDate": "2020-06-10T14:05:25Z", "message": "#18381  #17938"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6bd9c5bc5623f8f876b86485230d937eaf6ea45", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/d6bd9c5bc5623f8f876b86485230d937eaf6ea45", "committedDate": "2020-06-10T17:39:25Z", "message": "#18381 #17938"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42d8ca627a1384c6b744a1472dbb7b8e72f6aa57", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/42d8ca627a1384c6b744a1472dbb7b8e72f6aa57", "committedDate": "2020-06-10T21:22:17Z", "message": "Updating commit reference for src/main/enterprise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42f9689c1c0105451f593b12dba810c6da41a579", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/42f9689c1c0105451f593b12dba810c6da41a579", "committedDate": "2020-06-10T23:00:19Z", "message": "#18381 #17938  testing cluster id gen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327d6a99502d0187e13bf9532628c94d18fb8c94", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/327d6a99502d0187e13bf9532628c94d18fb8c94", "committedDate": "2020-06-11T15:50:21Z", "message": "#18638 reverting a bad file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1173a235b140bd1af9f80fbad7d78ce3113e73b0", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/1173a235b140bd1af9f80fbad7d78ce3113e73b0", "committedDate": "2020-06-12T21:42:55Z", "message": "Merge branch 'master' into apps-key-regenerte"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/7fcdc9ffad9770592a46f7e86cf04d661aa6de36", "committedDate": "2020-06-12T23:31:21Z", "message": "#18638 adding test to key reset + feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODMzNjcx", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430833671", "createdAt": "2020-06-15T17:05:53Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzowNTo1M1rOGj7EWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzowNTo1M1rOGj7EWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMTExNA==", "bodyText": "we should validate the column actually exists after the upgrade", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440321114", "createdAt": "2020-06-15T17:05:53Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05350AddDotSaltClusterColumnTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.Logger;\n+import java.sql.SQLException;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05350AddDotSaltClusterColumnTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private void dropColumn() throws SQLException {\n+        try {\n+            final String dropColumnSQL = \"ALTER TABLE dot_cluster DROP COLUMN cluster_salt\";\n+            final DotConnect dotConnect = new DotConnect();\n+            dotConnect.executeStatement(dropColumnSQL);\n+        } catch (Exception e) {\n+            Logger.info(Task05350AddDotSaltClusterColumnTest.class, () -> \"Failed removing cluster_salt column. Maybe it didn't exist?\");\n+        }\n+    }\n+\n+    @Test\n+    public void test_upgradeTask_success() throws SQLException, DotDataException {\n+        dropColumn();\n+        final Task05350AddDotSaltClusterColumn task = new Task05350AddDotSaltClusterColumn();\n+        assertTrue(task.forceRun());//True because the column does not exists\n+        task.executeUpgrade();\n+        assertFalse(task.forceRun());//False because the column exists", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODM0OTcy", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430834972", "createdAt": "2020-06-15T17:07:44Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzowNzo0NVrOGj7IQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzowNzo0NVrOGj7IQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMjExMg==", "bodyText": "Use the companyAPI object you just created", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440322112", "createdAt": "2020-06-15T17:07:45Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rest/CMSConfigResource.java", "diffHunk": "@@ -497,4 +500,30 @@ public Response deleteEndpoint ( @Context HttpServletRequest request,\n         return responseResource.response( responseMessage.toString() );\n     }\n \n+    @POST\n+    @Path (\"/regenerateKey\")\n+    @Produces (MediaType.APPLICATION_JSON)\n+    @Consumes (MediaType.APPLICATION_FORM_URLENCODED)\n+    public Response regenerateKey ( @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response) throws JSONException, IOException {\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();\n+            final CompanyAPI companyAPI = APILocator.getCompanyAPI();\n+            final Company defaultCompany = companyAPI.getDefaultCompany();\n+            final Company updatedCompany = APILocator.getCompanyAPI().regenerateKey(defaultCompany, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODM4NTQ4", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430838548", "createdAt": "2020-06-15T17:12:50Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODQ4MzA1", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430848305", "createdAt": "2020-06-15T17:26:21Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoyNjoyMVrOGj7wKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoyNjoyMVrOGj7wKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMzMjMyOQ==", "bodyText": "I think the user has a method called isAdmin, which is the same\nuser.isAdmin()", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440332329", "createdAt": "2020-06-15T17:26:21Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/company/CompanyAPIFactory.java", "diffHunk": "@@ -155,5 +167,35 @@ public void updateDefaultUserSettings(String languageId, String timeZoneId,\n                     skinId, dottedSkins, roundedSkins,\n                     resolution);\n         }\n+\n+        @Override\n+        @WrapInTransaction\n+        public Company regenerateKey(final Company company, final User user)\n+                throws DotDataException, DotSecurityException {\n+            try {\n+                if (!APILocator.getRoleAPI()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODQ5OTc3", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430849977", "createdAt": "2020-06-15T17:28:31Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoyODozMVrOGj71GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoyODozMVrOGj71GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMzMzU5Mw==", "bodyText": "good", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440333593", "createdAt": "2020-06-15T17:28:31Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/company/CompanyAPIFactory.java", "diffHunk": "@@ -155,5 +167,35 @@ public void updateDefaultUserSettings(String languageId, String timeZoneId,\n                     skinId, dottedSkins, roundedSkins,\n                     resolution);\n         }\n+\n+        @Override\n+        @WrapInTransaction\n+        public Company regenerateKey(final Company company, final User user)\n+                throws DotDataException, DotSecurityException {\n+            try {\n+                if (!APILocator.getRoleAPI()\n+                        .doesUserHaveRole(user, APILocator.getRoleAPI().loadCMSAdminRole())) {\n+                    throw new DotSecurityException(String.format(\n+                            \"User `%s` does not have permission to regenerate company Key operation.\",\n+                            user.getUserId()));\n+                }\n+                final String originalKey = company.getKey();\n+                final String newKey = Base64.objectToString(Encryptor.generateKey());\n+                company.setKey(newKey);\n+                company.setModified(true);\n+                CompanyManagerUtil.updateCompany(company);\n+                final Key originalKeyObj = (Key) Base64.stringToObject(originalKey);\n+                final Key newKeyObj = (Key) Base64.stringToObject(newKey);\n+                HibernateUtil.addCommitListener(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODY4Mzc5", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430868379", "createdAt": "2020-06-15T17:54:54Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NDo1NFrOGj8ssQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NDo1NFrOGj8ssQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0NzgyNQ==", "bodyText": "good", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440347825", "createdAt": "2020-06-15T17:54:54Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05350AddDotSaltClusterColumn.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.common.db.DotDatabaseMetaData;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.startup.StartupTask;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.liferay.util.Base64;\n+import com.liferay.util.Encryptor;\n+import com.liferay.util.EncryptorException;\n+import io.vavr.control.Try;\n+import java.sql.SQLException;\n+\n+public class Task05350AddDotSaltClusterColumn implements StartupTask {\n+\n+    private static final String SELECT = \"SELECT cluster_id FROM dot_cluster\";\n+    private static final String UPDATE = \"UPDATE dot_cluster SET cluster_salt = ? WHERE cluster_id = ? \";\n+\n+    private static final String POSTGRES_SQL_ADD_DOT_CLUSTER_SALT_COLUMN = \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\";\n+    private static final String MSSQL_ADD_DOT_CLUSTER_SALT_COLUMN = \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\";\n+    private static final String MYSQL_ADD_DOT_CLUSTER_SALT_COLUMN = \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\";\n+    private static final String ORACLE_ADD_DOT_CLUSTER_SALT_COLUMN = \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\";\n+\n+    @Override\n+    public boolean forceRun() {\n+        try {\n+            return !new DotDatabaseMetaData().getColumnNames(DbConnectionFactory.getConnection(), \"dot_cluster\").contains(\"cluster_salt\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODcwMTQw", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-430870140", "createdAt": "2020-06-15T17:57:19Z", "commit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NzoxOVrOGj8yKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NzoxOVrOGj8yKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0OTIyNg==", "bodyText": "user.isAdmin", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r440349226", "createdAt": "2020-06-15T17:57:19Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -3,7 +3,10 @@\n <% request.setAttribute(\"requiredPortletAccess\", PortletID.CONFIGURATION.toString()); %>\n <%@ include file=\"/html/common/uservalidation.jsp\"%>\n \n-<%@page import=\"com.dotmarketing.business.APILocator\"%>\n+<%@page import=\"com.dotcms.rest.api.v1.system.ConfigurationHelper\"%>\n+<%\n+boolean hasAdminRole = com.dotmarketing.business.APILocator.getRoleAPI().doesUserHaveRole(user,com.dotmarketing.business.APILocator.getRoleAPI().loadCMSAdminRole());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fcdc9ffad9770592a46f7e86cf04d661aa6de36"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ba296e2f54287c091f6f07d66336370b0ac4453", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/9ba296e2f54287c091f6f07d66336370b0ac4453", "committedDate": "2020-06-15T22:45:32Z", "message": "#18381 merge + feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3aa2e62e33d27109493ba4d434799116d55e8f0", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/c3aa2e62e33d27109493ba4d434799116d55e8f0", "committedDate": "2020-06-15T23:40:04Z", "message": "Remove commits from enterprise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6263f66fd9467b9b26983f48844c3824d80c50ec", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/6263f66fd9467b9b26983f48844c3824d80c50ec", "committedDate": "2020-06-16T04:11:47Z", "message": "#18638  ignore enterprise stuff added from core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050a780b7961ca1c9f9274e2caf01ece12bb8e92", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/050a780b7961ca1c9f9274e2caf01ece12bb8e92", "committedDate": "2020-06-16T16:21:50Z", "message": "#18381  small improvement on the test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzM4MTI4", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-431738128", "createdAt": "2020-06-16T17:33:25Z", "commit": {"oid": "050a780b7961ca1c9f9274e2caf01ece12bb8e92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjcxMTg2", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-432671186", "createdAt": "2020-06-17T18:36:31Z", "commit": {"oid": "050a780b7961ca1c9f9274e2caf01ece12bb8e92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f68b10deadb6cb6a84dba386edd4b2c744676ead", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/f68b10deadb6cb6a84dba386edd4b2c744676ead", "committedDate": "2020-06-18T20:47:56Z", "message": "#17938 sha256 was incorrect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/078baf5b98c5c22e48f68ecccc48a8f468335d98", "committedDate": "2020-06-18T23:03:02Z", "message": "#18381 solving  merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTMz", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704533", "createdAt": "2020-06-18T23:10:06Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowN1rOGmDABA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowN1rOGmDABA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODIyOA==", "bodyText": "Codacy found an issue: Avoid having style information in JSP files.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548228", "createdAt": "2020-06-18T23:10:07Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">\n+          <tr>\n+\t\t\t<td style=\"width:50%;text-align: right\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTM5", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704539", "createdAt": "2020-06-18T23:10:08Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowOFrOGmDACA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowOFrOGmDACA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODIzMg==", "bodyText": "Codacy found an issue: Do not use an attribute called class.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548232", "createdAt": "2020-06-18T23:10:08Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">\n+          <tr>\n+\t\t\t<td style=\"width:50%;text-align: right\">\n+\t\t\t\t<button id=\"cancelButton\" dojoType=\"dijit.form.Button\" class=\"dijitButton\" data-dojo-props=\"onClick: regenerateKeyProxyCancel\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTQ0", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704544", "createdAt": "2020-06-18T23:10:09Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowOVrOGmDADA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDowOVrOGmDADA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODIzNg==", "bodyText": "Codacy found an issue: Do not use an attribute called class.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548236", "createdAt": "2020-06-18T23:10:09Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTUw", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704550", "createdAt": "2020-06-18T23:10:10Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxMFrOGmDAEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxMFrOGmDAEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI0Mw==", "bodyText": "Codacy found an issue: The String literal \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\" appears 4 times in this file; the first occurrence is on line 22", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548243", "createdAt": "2020-06-18T23:10:10Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/startup/runonce/Task05350AddDotSaltClusterColumn.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.common.db.DotDatabaseMetaData;\n+import com.dotmarketing.db.DbConnectionFactory;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.startup.StartupTask;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.liferay.util.Base64;\n+import com.liferay.util.Encryptor;\n+import com.liferay.util.EncryptorException;\n+import io.vavr.control.Try;\n+import java.sql.SQLException;\n+\n+public class Task05350AddDotSaltClusterColumn implements StartupTask {\n+\n+    private static final String SELECT = \"SELECT cluster_id FROM dot_cluster\";\n+    private static final String UPDATE = \"UPDATE dot_cluster SET cluster_salt = ? WHERE cluster_id = ? \";\n+\n+    private static final String POSTGRES_SQL_ADD_DOT_CLUSTER_SALT_COLUMN = \" ALTER TABLE dot_cluster ADD cluster_salt VARCHAR(256)\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTU1", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704555", "createdAt": "2020-06-18T23:10:11Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxMVrOGmDAFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxMVrOGmDAFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI0Ng==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548246", "createdAt": "2020-06-18T23:10:11Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05350AddDotSaltClusterColumnTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.Logger;\n+import java.sql.SQLException;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05350AddDotSaltClusterColumnTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTY3", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704567", "createdAt": "2020-06-18T23:10:12Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxM1rOGmDAKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxM1rOGmDAKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI2Ng==", "bodyText": "Codacy found an issue: Classes implementing Serializable should set a serialVersionUID", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548266", "createdAt": "2020-06-18T23:10:13Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/system/event/local/type/security/CompanyKeyResetEvent.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.dotcms.system.event.local.type.security;\n+\n+import java.io.Serializable;\n+import java.security.Key;\n+\n+\n+/**\n+ * This event is used to broadcast the info related with ResetKey event\n+ */\n+public class CompanyKeyResetEvent implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTcz", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704573", "createdAt": "2020-06-18T23:10:14Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNFrOGmDALg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNFrOGmDALg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI3MA==", "bodyText": "Codacy found an issue: Do not use an attribute called class.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548270", "createdAt": "2020-06-18T23:10:14Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTc2", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704576", "createdAt": "2020-06-18T23:10:15Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNVrOGmDAMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNVrOGmDAMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI3Mg==", "bodyText": "Codacy found an issue: Avoid having style information in JSP files.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548272", "createdAt": "2020-06-18T23:10:15Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTgy", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704582", "createdAt": "2020-06-18T23:10:16Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNlrOGmDANQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxNlrOGmDANQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI3Nw==", "bodyText": "Codacy found an issue: A class which only has private constructors should be final", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548277", "createdAt": "2020-06-18T23:10:16Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsKeyDefaultProvider.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.dotcms.security.apps;\n+\n+import com.dotcms.auth.providers.jwt.factories.SigningKeyFactory;\n+import com.dotmarketing.business.APILocator;\n+import java.security.Key;\n+\n+public class AppsKeyDefaultProvider implements SigningKeyFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTg2", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704586", "createdAt": "2020-06-18T23:10:17Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxN1rOGmDAOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxN1rOGmDAOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI4MQ==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548281", "createdAt": "2020-06-18T23:10:17Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/listener/SecurityKeyResetTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package com.dotcms.publishing.listener;\n+\n+import static com.dotcms.publisher.business.PublisherTestUtil.createEndpoint;\n+import static com.dotcms.publisher.business.PublisherTestUtil.createEnvironment;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.company.CompanyAPI;\n+import com.dotcms.company.CompanyAPIFactory;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.endpoint.bean.PublishingEndPoint;\n+import com.dotcms.publisher.endpoint.business.PublishingEndPointAPI;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.Encryptor;\n+import java.security.Key;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class SecurityKeyResetTest extends IntegrationTestBase {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTky", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704592", "createdAt": "2020-06-18T23:10:18Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxOFrOGmDAPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxOFrOGmDAPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI4NQ==", "bodyText": "Codacy found an issue: Avoid having style information in JSP files.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548285", "createdAt": "2020-06-18T23:10:18Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">\n+          <tr>\n+\t\t\t<td style=\"width:50%;text-align: right\">\n+\t\t\t\t<button id=\"cancelButton\" dojoType=\"dijit.form.Button\" class=\"dijitButton\" data-dojo-props=\"onClick: regenerateKeyProxyCancel\">\n+\t\t\t\t\t<%= UtilMethods.escapeSingleQuotes(LanguageUtil.get(pageContext, \"cancel\")) %>\n+\t\t\t\t</button>\n+\t\t\t</td>\n+\t\t\t<td style=\"width:50%;text-align: left\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 172}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NTk5", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704599", "createdAt": "2020-06-18T23:10:19Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxOVrOGmDAQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoxOVrOGmDAQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI5MQ==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548291", "createdAt": "2020-06-18T23:10:19Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/publishing/listener/SecurityKeyResetTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package com.dotcms.publishing.listener;\n+\n+import static com.dotcms.publisher.business.PublisherTestUtil.createEndpoint;\n+import static com.dotcms.publisher.business.PublisherTestUtil.createEnvironment;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.company.CompanyAPI;\n+import com.dotcms.company.CompanyAPIFactory;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.publisher.endpoint.bean.PublishingEndPoint;\n+import com.dotcms.publisher.endpoint.business.PublishingEndPointAPI;\n+import com.dotcms.publisher.environment.bean.Environment;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.business.APILocator;\n+import com.liferay.portal.model.Company;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.Encryptor;\n+import java.security.Key;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class SecurityKeyResetTest extends IntegrationTestBase {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+    }\n+\n+    /**\n+     * Given scenario: This basically tests that after a key reset the push publish endpoint are\n+     * still usable for decrypting important stuff using the new key; Expected: The endpoints that\n+     * were using the key that got re-generated remain usable.\n+     */\n+    @Test\n+    public void Test_Push_Publish_Endpoints_Have_Valid_Keys_After_Key_Reset_Expect_Success() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NjA5", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704609", "createdAt": "2020-06-18T23:10:19Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMFrOGmDASQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMFrOGmDASQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODI5Nw==", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548297", "createdAt": "2020-06-18T23:10:20Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/startup/runonce/Task05350AddDotSaltClusterColumnTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.dotmarketing.startup.runonce;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.common.db.DotConnect;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.util.Logger;\n+import java.sql.SQLException;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class Task05350AddDotSaltClusterColumnTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    private void dropColumn(final DotConnect dotConnect) throws SQLException {\n+        try {\n+            final String dropColumnSQL = \"ALTER TABLE dot_cluster DROP COLUMN cluster_salt\";\n+            dotConnect.executeStatement(dropColumnSQL);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NjE1", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704615", "createdAt": "2020-06-18T23:10:21Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMVrOGmDAUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMVrOGmDAUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODMwNQ==", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548305", "createdAt": "2020-06-18T23:10:21Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publishing/listener/PushPublishKeyResetEventListener.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.dotcms.publishing.listener;\n+\n+import com.dotcms.publisher.endpoint.bean.PublishingEndPoint;\n+import com.dotcms.publisher.endpoint.business.PublishingEndPointAPI;\n+import com.dotcms.system.event.local.model.EventSubscriber;\n+import com.dotcms.system.event.local.type.security.CompanyKeyResetEvent;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotRuntimeException;\n+import com.dotmarketing.util.Logger;\n+import com.liferay.util.Encryptor;\n+import java.security.Key;\n+import java.util.List;\n+\n+/**\n+ * Once registered this listener takes care or recreating the Push-Publish Auth-Keys\n+ * First decrypting the old content using the original Key then re-inserting it using the new Key.\n+ */\n+public final class PushPublishKeyResetEventListener implements EventSubscriber<CompanyKeyResetEvent> {\n+\n+    private final PublishingEndPointAPI publishingEndPointAPI;\n+\n+    private PushPublishKeyResetEventListener(final PublishingEndPointAPI publishingEndPointAPI) {\n+        this.publishingEndPointAPI = publishingEndPointAPI;\n+    }\n+\n+    private PushPublishKeyResetEventListener() {\n+       this(APILocator.getPublisherEndPointAPI());\n+    }\n+\n+    @Override\n+    public void notify(final CompanyKeyResetEvent event) {\n+        try {\n+            final Key originalKey = event.getOriginalKey();\n+            final Key newKey = event.getResetKey();\n+            final List<PublishingEndPoint> allEndPoints = publishingEndPointAPI.getAllEndPoints();\n+            for (final PublishingEndPoint publishingEndPoint : allEndPoints) {\n+                try {\n+                    final StringBuilder originalAuthKey = publishingEndPoint.getAuthKey();\n+                    final String authKey = Encryptor.decrypt(originalKey, originalAuthKey.toString());\n+                    final String encryptedKey = Encryptor.encrypt(newKey,authKey);\n+                    publishingEndPoint.setAuthKey(new StringBuilder(encryptedKey));\n+                } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzA0NjIw", "url": "https://github.com/dotCMS/core/pull/18638#pullrequestreview-433704620", "createdAt": "2020-06-18T23:10:22Z", "commit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMlrOGmDAVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMzoxMDoyMlrOGmDAVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0ODMxMQ==", "bodyText": "Codacy found an issue: Do not use an attribute called class.", "url": "https://github.com/dotCMS/core/pull/18638#discussion_r442548311", "createdAt": "2020-06-18T23:10:22Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/cmsconfig/company.jsp", "diffHunk": "@@ -276,3 +320,28 @@\n         <%= LanguageUtil.get(pageContext, \"save\") %>\n     </button>\n </div>\n+\n+<div id=\"regenerateKeyDialog\" dojoType=\"dijit.Dialog\" style=\"display:none;width:500px;vertical-align: middle; \" draggable=\"true\" title=\"<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-prompt\") %>\" >\n+\n+\t<span class=\"ui-confirmdialog-message\" >\n+\t\t<%= LanguageUtil.get(pageContext, \"key-digest-regenerate-warning\") %>\n+\t</span>\n+\n+    <div>\n+        <table class=\"sTypeTable\" style=\"width:90%; border-collapse: separate; border-spacing: 10px 15px;margin-bottom:10px;\">\n+          <tr>\n+\t\t\t<td style=\"width:50%;text-align: right\">\n+\t\t\t\t<button id=\"cancelButton\" dojoType=\"dijit.form.Button\" class=\"dijitButton\" data-dojo-props=\"onClick: regenerateKeyProxyCancel\">\n+\t\t\t\t\t<%= UtilMethods.escapeSingleQuotes(LanguageUtil.get(pageContext, \"cancel\")) %>\n+\t\t\t\t</button>\n+\t\t\t</td>\n+\t\t\t<td style=\"width:50%;text-align: left\">\n+\t\t\t\t<button id=\"okButton\" dojoType=\"dijit.form.Button\" class=\"dijitButton\" data-dojo-props=\"onClick: regenerateKeyProxyOk\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "078baf5b98c5c22e48f68ecccc48a8f468335d98"}, "originalPosition": 173}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 925, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}