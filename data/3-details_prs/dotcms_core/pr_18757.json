{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4NzM3Njg4", "number": 18757, "title": "#18303 refactoring to take the app key straight from the file name", "bodyText": "This comes to fulfill #18303\nThe idea is removing the key field from the yml file and use instead of it the file name (as the app-key)", "createdAt": "2020-06-23T18:12:54Z", "url": "https://github.com/dotCMS/core/pull/18757", "merged": true, "mergeCommit": {"oid": "d82179f04f2ed168ebf4fbd4bce3f826609b5841"}, "closed": true, "closedAt": "2020-06-24T21:05:41Z", "author": {"login": "fabrizzio-dotCMS"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuJfdDAH2gAyNDM4NzM3Njg4OmJhNWNkMmJhMDkxNzFhMWEzZjNiNjVhMzFiOTNjZTRmMjc4ZmMyNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcugtK_AFqTQzNzAxMDYyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ba5cd2ba09171a1a3f3b65a31b93ce4f278fc25c", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/ba5cd2ba09171a1a3f3b65a31b93ce4f278fc25c", "committedDate": "2020-06-23T18:10:06Z", "message": "#18303 refactoring to take the app key straight from the file name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b60752eeb8766e1e8a022e7b0f7aa9e071ec1e53", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/b60752eeb8766e1e8a022e7b0f7aa9e071ec1e53", "committedDate": "2020-06-23T20:48:59Z", "message": "#18303 refactoring to eliminate redundancy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c1fbed96521fe63ddf3e3d587c5726c6c1b34a8", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/9c1fbed96521fe63ddf3e3d587c5726c6c1b34a8", "committedDate": "2020-06-23T21:03:20Z", "message": "#18303 codacy feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e849ebb60937ccafece0e29133d6700623ed576", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/1e849ebb60937ccafece0e29133d6700623ed576", "committedDate": "2020-06-23T21:07:29Z", "message": "Merge branch 'master' into issue-18303-apps-file-name-as-key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTY3Nzcx", "url": "https://github.com/dotCMS/core/pull/18757#pullrequestreview-436167771", "createdAt": "2020-06-23T21:22:03Z", "commit": {"oid": "1e849ebb60937ccafece0e29133d6700623ed576"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NzQ0MTQ3", "url": "https://github.com/dotCMS/core/pull/18757#pullrequestreview-436744147", "createdAt": "2020-06-24T15:09:56Z", "commit": {"oid": "1e849ebb60937ccafece0e29133d6700623ed576"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c762fbd587c192e3d01401ce2ac51d580391c9f", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/2c762fbd587c192e3d01401ce2ac51d580391c9f", "committedDate": "2020-06-24T15:27:42Z", "message": "Merge branch 'master' into issue-18303-apps-file-name-as-key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3056d5f0a58b627bb92546fd49c824b357a3d449", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/3056d5f0a58b627bb92546fd49c824b357a3d449", "committedDate": "2020-06-24T17:25:19Z", "message": "#18303 fixing postmans after  app-key refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODgwNDEx", "url": "https://github.com/dotCMS/core/pull/18757#pullrequestreview-436880411", "createdAt": "2020-06-24T17:57:52Z", "commit": {"oid": "3056d5f0a58b627bb92546fd49c824b357a3d449"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "471cd14d4cc246f6e4b0e47b522d3c86fbedd567", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/471cd14d4cc246f6e4b0e47b522d3c86fbedd567", "committedDate": "2020-06-24T21:04:03Z", "message": "#18303 merge with master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDEwNjIw", "url": "https://github.com/dotCMS/core/pull/18757#pullrequestreview-437010620", "createdAt": "2020-06-24T21:12:53Z", "commit": {"oid": "471cd14d4cc246f6e4b0e47b522d3c86fbedd567"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMToxMjo1M1rOGojU3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMToxMjo1M1rOGojU3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3NTAwNg==", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/18757#discussion_r445175006", "createdAt": "2020-06-24T21:12:53Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -389,51 +388,78 @@ private void deleteSecrets(final String key, final String siteIdentifier, final\n         }\n \n         final String appKeyLC = key.toLowerCase();\n-        final AppDescriptorMeta appDescriptorMeta = getAppDescriptorMap()\n+        final AppDescriptor appDescriptorMeta = getAppDescriptorMap()\n                 .get(appKeyLC);\n         return null == appDescriptorMeta ? Optional.empty()\n-                : Optional.of(appDescriptorMeta.getAppDescriptor());\n+                : Optional.of(appDescriptorMeta);\n     }\n \n     @Override\n-    public AppDescriptor createAppDescriptor(final InputStream inputStream,\n-            final User user) throws IOException, DotDataException, AlreadyExistException, DotSecurityException {\n+    public AppDescriptor createAppDescriptor(final File file,\n+            final User user) throws DotDataException, AlreadyExistException, DotSecurityException {\n         if (userDoesNotHaveAccess(user)) {\n             throw new DotSecurityException(String.format(\n-                    \"Invalid attempt to create an App descriptor performed by user with id `%s`.\",\n+                    \"Invalid attempt to create an app descriptor performed by user with id `%s`.\",\n                     user.getUserId()));\n         }\n-\n         final String ymlFilesPath = getServiceDescriptorDirectory();\n         final File basePath = new File(ymlFilesPath);\n         if (!basePath.exists()) {\n-            basePath.mkdir();\n-        }\n-        Logger.debug(AppsAPIImpl.class,\n-                () -> \" ymlFiles are set under:  \" + ymlFilesPath);\n-\n-        // Now validate the incoming file.. see if we're rewriting an existing file or attempting to re-use an already in use service-key.\n-        final AppDescriptor serviceDescriptor = ymlMapper\n-                .readValue(inputStream, AppDescriptor.class);\n+            basePath.mkdirs();\n+        }\n+        Logger.debug(AppsAPIImpl.class, () -> \" ymlFiles are set under:  \" + ymlFilesPath);\n+\n+            final AppSchema appSchema = readAppFile(file);\n+            // Now validate the incoming file.. see if we're rewriting an existing file or attempting to re-use an already in use service-key.\n+            if (validateServiceDescriptor(appSchema)) {\n+                final File incomingFile = new File(basePath, file.getName());\n+                if (incomingFile.exists()) {\n+                    throw new AlreadyExistException(\n+                            String.format(\n+                                    \"Invalid attempt to override an existing file named '%s'.\",\n+                                    incomingFile.getName()));\n+                }\n \n-        if (validateServiceDescriptor(serviceDescriptor)\n-                && validateAppDescriptorUniqueName(serviceDescriptor)) {\n+                writeAppFile(incomingFile, appSchema);\n \n-            final String serviceKey = serviceDescriptor.getKey();\n-            final File incomingFile = new File(basePath, String.format(\"%s.yml\", serviceKey));\n-            if (incomingFile.exists()) {\n-                throw new AlreadyExistException(\n-                        String.format(\"Invalid attempt to override an existing file named '%s'.\",\n-                                incomingFile.getName()));\n+                invalidateCache();\n             }\n+            return new AppDescriptorImpl(file.getName(), appSchema);\n \n-            ymlMapper.writeValue(incomingFile, serviceDescriptor);\n+    }\n \n-            invalidateCache();\n+    /**\n+     * There's a version of the method readValue on the ymlMapper which takes a file and internally creates directly a FileInputStream\n+     * According to https://dzone.com/articles/fileinputstream-fileoutputstream-considered-harmful\n+     * that's very harmful\n+     * @param file\n+     * @return\n+     * @throws DotDataException\n+     */\n+    private AppSchema readAppFile(final File file) throws DotDataException {\n+        try (InputStream inputStream = Files.newInputStream(Paths.get(file.getPath()))) {\n+            return ymlMapper.readValue(inputStream, AppSchema.class);\n+        }catch (Exception e){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "471cd14d4cc246f6e4b0e47b522d3c86fbedd567"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 772, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}