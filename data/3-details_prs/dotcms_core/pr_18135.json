{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3ODY0MDY3", "number": 18135, "title": "Issue 17514 18015 url map fixes", "bodyText": "We fixed two issues here:\n#17514 -> URLMaps on the root (/{urlTitle}) didn't work properly\n#18015 -> URLMaps with \"/\" in the variables used in the url map pattern having didn't work.", "createdAt": "2020-03-13T16:18:01Z", "url": "https://github.com/dotCMS/core/pull/18135", "merged": true, "mergeCommit": {"oid": "5456f2c49c240c09892c89faf1a4ae016a291adc"}, "closed": true, "closedAt": "2020-03-13T19:57:55Z", "author": {"login": "jgambarios"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM-4cEAH2gAyMzg3ODY0MDY3OjJmYzZjNmZlZmNhOWVmZmEyMTZjYzhhZjFmNDJkODU4YzQyMGZhZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNVyoAAFqTM3NDU2OTM0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fc6c6fefca9effa216cc8af1f42d858c420fae2", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/2fc6c6fefca9effa216cc8af1f42d858c420fae2", "committedDate": "2020-03-12T17:08:56Z", "message": "#17514 #18015"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0cec7b5285dbee09a2ca00ba9791b28b8cec479", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/b0cec7b5285dbee09a2ca00ba9791b28b8cec479", "committedDate": "2020-03-12T17:59:36Z", "message": "#17514 #18015"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce9917656059ea661330380e0e2a9b506eca0390", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/ce9917656059ea661330380e0e2a9b506eca0390", "committedDate": "2020-03-12T18:32:10Z", "message": "#17514 #18015"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/4153d8096b574376d86e922639b47ddce6d9cd5c", "committedDate": "2020-03-12T20:56:30Z", "message": "#17514 #18015"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM2Njgy", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374436682", "createdAt": "2020-03-13T16:22:13Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjoxM1rOF2KFSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjoxM1rOF2KFSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMjYxNg==", "bodyText": "this would be handle by a Set and contains method", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392332616", "createdAt": "2020-03-13T16:22:13Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESUtils.java", "diffHunk": "@@ -26,4 +26,29 @@ public static String sha256(final String fieldName, final Object fieldValue,\n \t\t\t\t+ (fieldValue == null ? \"\" : fieldValue.toString()) + \"_\"\n \t\t\t\t+ languageId, Charset.forName(\"UTF-8\")).toString();\n \t}\n+\n+\t/**\n+\t * Returns a String where those characters that QueryParser expects to be escaped are escaped by\n+\t * a preceding <code>\\</code> excluding the \"/\", we found some cases where we don't want to\n+\t * scape it.\n+\t * This method is a copy of the {@link QueryParser#escape(String)} where we remove the\n+\t * scape for slashes \"/\" and we included the scape for white spaces \" \"\n+\t */\n+\tpublic static String escapeExcludingSlashIncludingSpace(String s) {\n+\t\tStringBuilder sb = new StringBuilder();\n+\t\tfor (int i = 0; i < s.length(); i++) {\n+\t\t\tchar c = s.charAt(i);\n+\t\t\t// These characters are part of the query syntax and must be escaped\n+\t\t\tif (c == '\\\\' || c == '+' || c == '-' || c == '!' || c == '(' || c == ')' || c == ':'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM2Nzg3", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374436787", "createdAt": "2020-03-13T16:22:21Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjoyMlrOF2KFoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjoyMlrOF2KFoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMjcwNA==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392332704", "createdAt": "2020-03-13T16:22:22Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESUtils.java", "diffHunk": "@@ -26,4 +26,29 @@ public static String sha256(final String fieldName, final Object fieldValue,\n \t\t\t\t+ (fieldValue == null ? \"\" : fieldValue.toString()) + \"_\"\n \t\t\t\t+ languageId, Charset.forName(\"UTF-8\")).toString();\n \t}\n+\n+\t/**\n+\t * Returns a String where those characters that QueryParser expects to be escaped are escaped by\n+\t * a preceding <code>\\</code> excluding the \"/\", we found some cases where we don't want to\n+\t * scape it.\n+\t * This method is a copy of the {@link QueryParser#escape(String)} where we remove the\n+\t * scape for slashes \"/\" and we included the scape for white spaces \" \"\n+\t */\n+\tpublic static String escapeExcludingSlashIncludingSpace(String s) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM2OTg5", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374436989", "createdAt": "2020-03-13T16:22:38Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjozOFrOF2KGMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMjozOFrOF2KGMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMjg1MA==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392332850", "createdAt": "2020-03-13T16:22:38Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESUtils.java", "diffHunk": "@@ -26,4 +26,29 @@ public static String sha256(final String fieldName, final Object fieldValue,\n \t\t\t\t+ (fieldValue == null ? \"\" : fieldValue.toString()) + \"_\"\n \t\t\t\t+ languageId, Charset.forName(\"UTF-8\")).toString();\n \t}\n+\n+\t/**\n+\t * Returns a String where those characters that QueryParser expects to be escaped are escaped by\n+\t * a preceding <code>\\</code> excluding the \"/\", we found some cases where we don't want to\n+\t * scape it.\n+\t * This method is a copy of the {@link QueryParser#escape(String)} where we remove the\n+\t * scape for slashes \"/\" and we included the scape for white spaces \" \"\n+\t */\n+\tpublic static String escapeExcludingSlashIncludingSpace(String s) {\n+\t\tStringBuilder sb = new StringBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM3OTc5", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374437979", "createdAt": "2020-03-13T16:23:55Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMzo1NVrOF2KI-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyMzo1NVrOF2KI-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzMzU2MA==", "bodyText": "add doc", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392333560", "createdAt": "2020-03-13T16:23:55Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPI.java", "diffHunk": "@@ -20,5 +20,7 @@\n     Optional<URLMapInfo> processURLMap(final UrlMapContext context)\n             throws DotSecurityException, DotDataException;\n \n-    public boolean isUrlPattern(final UrlMapContext urlMapContext) throws DotDataException;\n-}\n+    boolean isUrlPattern(final UrlMapContext urlMapContext)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM4ODAy", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374438802", "createdAt": "2020-03-13T16:25:02Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNTowMlrOF2KLbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNTowMlrOF2KLbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNDE4OQ==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392334189", "createdAt": "2020-03-13T16:25:02Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -58,63 +57,65 @@\n      * @return\n      * @throws DotDataException\n      */\n-    public boolean isUrlPattern(final UrlMapContext urlMapContext) throws DotDataException {\n+    public boolean isUrlPattern(final UrlMapContext urlMapContext)\n+            throws DotDataException, DotSecurityException {\n         return matchingUrlPattern(urlMapContext.getUri()) && getContentlet(urlMapContext) != null;\n     }\n \n     public Optional<URLMapInfo> processURLMap(final UrlMapContext context)\n             throws DotSecurityException, DotDataException {\n \n-        if (this.matchingUrlPattern(context.getUri())) {\n-            final Matches matches = this.findPatternChange(context.getUri());\n-\n-            final Structure structure = CacheLocator.getContentTypeCache()\n-                    .getStructureByInode(matches.getPatternChange().getStructureInode());\n-\n-            final Field hostField = this.findHostField(structure);\n-\n-            final Contentlet contentlet = this.getContentlet(matches, structure, hostField, context);\n-\n-            if (contentlet == null) {\n-                return Optional.empty();\n-            }\n-\n-            final Identifier pageUriIdentifier = this.getDetailtPageUri(structure);\n-\n-            return Optional.of(new URLMapInfo(contentlet, pageUriIdentifier, context.getUri()));\n-        } else {\n+        final Contentlet contentlet = getContentlet(context);\n+        if (contentlet == null) {\n             return Optional.empty();\n         }\n+\n+        final Structure structure = CacheLocator.getContentTypeCache()\n+                .getStructureByInode(contentlet.getStructureInode());\n+        final Identifier pageUriIdentifier = this.getDetailtPageUri(structure);\n+\n+        return Optional.of(new URLMapInfo(contentlet, pageUriIdentifier, context.getUri()));\n     }\n \n     /**\n-     * Return the {@link Contentlet} the match the {@link UrlMapContext#getUri()} value,\n-     * if not exists any {@link com.dotcms.contenttype.model.type.UrlMapable} matching with the URI\n-     * then a {@link DotRuntimeException} is thrown\n+     * Return the {@link Contentlet} the match the {@link UrlMapContext#getUri()} value, if not\n+     * exists any {@link com.dotcms.contenttype.model.type.UrlMapable} matching with the URI then a\n+     * {@link DotRuntimeException} is thrown\n      *\n      * @param urlMapContext\n      * @return\n      */\n-    private Contentlet getContentlet(final UrlMapContext urlMapContext){\n-        final Matches matches = this.findPatternChange(urlMapContext.getUri());\n-        final Structure structure = CacheLocator.getContentTypeCache()\n-                .getStructureByInode(matches.getPatternChange().getStructureInode());\n+    private Contentlet getContentlet(final UrlMapContext urlMapContext) throws DotSecurityException {\n \n-        final Field hostField = this.findHostField(structure);\n+        Contentlet matchingContentlet = null;\n \n         try {\n-            return this.getContentlet(matches, structure, hostField, urlMapContext);\n-        } catch (DotDataException | DotSecurityException e){\n-            return null;\n-        }\n-    }\n+            // We could have multiple matches as multiple content types could have the same\n+            // URLMap pattern and we need to evaluate all until we find content match.\n+            final List<Matches> matchesFound = this.findMatch(urlMapContext.getUri());\n+            if (!matchesFound.isEmpty()) {\n+\n+                for (Matches matches : matchesFound) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM5MzI1", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374439325", "createdAt": "2020-03-13T16:25:46Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNTo0NlrOF2KNAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNTo0NlrOF2KNAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNDU5NQ==", "bodyText": "if do not need mod, use Collections.empyList()", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392334595", "createdAt": "2020-03-13T16:25:46Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -139,44 +140,64 @@ private Identifier getDetailtPageUri(final Structure structure) {\n         }\n     }\n \n-    private boolean containsRegEx(final String uri) {\n-        final String mastRegEx = this.getURLMasterPattern().orElse(null);\n+    /**\n+     * Return all the matches related to a given URI, multiple content types could use the URLMap\n+     * pattern and on those cases we need to evaluate all the matches.\n+     *\n+     * @param uri URI to evaluate for matches\n+     * @return List of found matches\n+     * @throws DotDataException\n+     */\n+    private List<Matches> findMatch(final String uri) throws DotDataException {\n \n-        if (mastRegEx == null) {\n-            return false;\n+        // We want to avoid unnecessary lookups for vanity urls when browsing in the backend\n+        for (final String backendFilter : CMSUrlUtil.BACKEND_FILTERED_LIST_ARRAY) {\n+            if (uri.startsWith(backendFilter)) {\n+                return new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 155}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM5NTE0", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374439514", "createdAt": "2020-03-13T16:26:01Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNjowMVrOF2KNtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNjowMVrOF2KNtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNDc3Mg==", "bodyText": "set final", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392334772", "createdAt": "2020-03-13T16:26:01Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -139,44 +140,64 @@ private Identifier getDetailtPageUri(final Structure structure) {\n         }\n     }\n \n-    private boolean containsRegEx(final String uri) {\n-        final String mastRegEx = this.getURLMasterPattern().orElse(null);\n+    /**\n+     * Return all the matches related to a given URI, multiple content types could use the URLMap\n+     * pattern and on those cases we need to evaluate all the matches.\n+     *\n+     * @param uri URI to evaluate for matches\n+     * @return List of found matches\n+     * @throws DotDataException\n+     */\n+    private List<Matches> findMatch(final String uri) throws DotDataException {\n \n-        if (mastRegEx == null) {\n-            return false;\n+        // We want to avoid unnecessary lookups for vanity urls when browsing in the backend\n+        for (final String backendFilter : CMSUrlUtil.BACKEND_FILTERED_LIST_ARRAY) {\n+            if (uri.startsWith(backendFilter)) {\n+                return new ArrayList<>();\n+            }\n         }\n \n-        final String url = !uri.endsWith(StringPool.FORWARD_SLASH) ? uri + StringPool.FORWARD_SLASH : uri;\n-        return RegEX.contains(url, mastRegEx);\n-    }\n-\n-    private static Optional<String> getURLMasterPattern() {\n-        try {\n-            final String mastRegEx = CacheLocator.getContentTypeCache().getURLMasterPattern();\n-\n-            return Optional.ofNullable(mastRegEx);\n-        } catch (DotCacheException e) {\n-            throw new DotRuntimeException(e);\n+        if (this.shouldLoadPatterns()) {\n+            this.loadPatterns();\n         }\n-    }\n \n-    private Matches findPatternChange(final String uri) {\n-        final String url = !uri.endsWith(StringPool.FORWARD_SLASH) ? uri + StringPool.FORWARD_SLASH : uri;\n+        List<Matches> foundMatches = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 177}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDM5Nzkw", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374439790", "createdAt": "2020-03-13T16:26:22Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNjoyM1rOF2KOkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjoyNjoyM1rOF2KOkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNDk5Mg==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392334992", "createdAt": "2020-03-13T16:26:23Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -139,44 +140,64 @@ private Identifier getDetailtPageUri(final Structure structure) {\n         }\n     }\n \n-    private boolean containsRegEx(final String uri) {\n-        final String mastRegEx = this.getURLMasterPattern().orElse(null);\n+    /**\n+     * Return all the matches related to a given URI, multiple content types could use the URLMap\n+     * pattern and on those cases we need to evaluate all the matches.\n+     *\n+     * @param uri URI to evaluate for matches\n+     * @return List of found matches\n+     * @throws DotDataException\n+     */\n+    private List<Matches> findMatch(final String uri) throws DotDataException {\n \n-        if (mastRegEx == null) {\n-            return false;\n+        // We want to avoid unnecessary lookups for vanity urls when browsing in the backend\n+        for (final String backendFilter : CMSUrlUtil.BACKEND_FILTERED_LIST_ARRAY) {\n+            if (uri.startsWith(backendFilter)) {\n+                return new ArrayList<>();\n+            }\n         }\n \n-        final String url = !uri.endsWith(StringPool.FORWARD_SLASH) ? uri + StringPool.FORWARD_SLASH : uri;\n-        return RegEX.contains(url, mastRegEx);\n-    }\n-\n-    private static Optional<String> getURLMasterPattern() {\n-        try {\n-            final String mastRegEx = CacheLocator.getContentTypeCache().getURLMasterPattern();\n-\n-            return Optional.ofNullable(mastRegEx);\n-        } catch (DotCacheException e) {\n-            throw new DotRuntimeException(e);\n+        if (this.shouldLoadPatterns()) {\n+            this.loadPatterns();\n         }\n-    }\n \n-    private Matches findPatternChange(final String uri) {\n-        final String url = !uri.endsWith(StringPool.FORWARD_SLASH) ? uri + StringPool.FORWARD_SLASH : uri;\n+        List<Matches> foundMatches = new ArrayList<>();\n+\n+        final String url =\n+                !uri.endsWith(StringPool.FORWARD_SLASH) ? uri + StringPool.FORWARD_SLASH : uri;\n \n         for (final ContentTypeURLPattern contentTypeURLPattern : this.patternsCache) {\n \n-            final List<RegExMatch> matches = RegEX.findForUrlMap(url, contentTypeURLPattern.getRegEx());\n+            final List<RegExMatch> matches = RegEX\n+                    .findForUrlMap(url, contentTypeURLPattern.getRegEx());\n             if (matches != null && !matches.isEmpty()) {\n-                return new Matches(contentTypeURLPattern, matches);\n+\n+                /*\n+                We need to make sure we have an exact match, we could have regex too generic, like\n+                a regex in the root: \"/{urlTitle}\" resulting in a regex like \"/(.+)/\" which basically\n+                will match any url.\n+                 */\n+                for (RegExMatch regExMatch : matches) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 195}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDQyNjQ0", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374442644", "createdAt": "2020-03-13T16:30:20Z", "commit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjozMDoyMVrOF2KXbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjozMDoyMVrOF2KXbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMzNzI2MA==", "bodyText": "consider a set to avoid log(N) time", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392337260", "createdAt": "2020-03-13T16:30:21Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/filters/CMSUrlUtil.java", "diffHunk": "@@ -47,7 +48,7 @@\n \tprivate static final String NOT_FOUND = \"NOTFOUND\";\n \tprivate static final String UNABLE_TO_FIND = \"Unable to find \";\n \n-\tprivate static final String [] VANITY_FILTERED_LIST_ARRAY =\n+\tpublic static final String [] BACKEND_FILTERED_LIST_ARRAY =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4153d8096b574376d86e922639b47ddce6d9cd5c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b29bc7a9b2d48b9772db137b230715bda82939a", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/7b29bc7a9b2d48b9772db137b230715bda82939a", "committedDate": "2020-03-13T17:07:19Z", "message": "#17514 #18015 Applying feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3b11fce49790b7f7bdaa14b60b1424a9d296e47", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/d3b11fce49790b7f7bdaa14b60b1424a9d296e47", "committedDate": "2020-03-13T17:42:01Z", "message": "#17514 #18015 Applying feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76056f9051b7eb16deccc856a999091b65eb59ab", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/76056f9051b7eb16deccc856a999091b65eb59ab", "committedDate": "2020-03-13T17:44:14Z", "message": "#17514 #18015 Applying feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "018cd22e3960381c5b4161cf0f2d46ba2d8f4df7", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/018cd22e3960381c5b4161cf0f2d46ba2d8f4df7", "committedDate": "2020-03-13T18:17:13Z", "message": "#17514 #18015 Applying more feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTE4ODUw", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374518850", "createdAt": "2020-03-13T18:20:22Z", "commit": {"oid": "018cd22e3960381c5b4161cf0f2d46ba2d8f4df7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTIxODI0", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374521824", "createdAt": "2020-03-13T18:24:57Z", "commit": {"oid": "018cd22e3960381c5b4161cf0f2d46ba2d8f4df7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODoyNDo1N1rOF2OH-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODoyNDo1N1rOF2OH-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5ODg0MQ==", "bodyText": "Issue found: Avoid variables with short names like c", "url": "https://github.com/dotCMS/core/pull/18135#discussion_r392398841", "createdAt": "2020-03-13T18:24:57Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESUtils.java", "diffHunk": "@@ -26,4 +40,26 @@ public static String sha256(final String fieldName, final Object fieldValue,\n \t\t\t\t+ (fieldValue == null ? \"\" : fieldValue.toString()) + \"_\"\n \t\t\t\t+ languageId, Charset.forName(\"UTF-8\")).toString();\n \t}\n+\n+\t/**\n+\t * Returns a String where those characters that QueryParser expects to be escaped are escaped by\n+\t * a preceding <code>\\</code> excluding the \"/\", we found some cases where we don't want to\n+\t * scape it.\n+\t * This method is a copy of the {@link QueryParser#escape(String)} where we remove the\n+\t * scape for slashes \"/\" and we included the scape for white spaces \" \"\n+\t */\n+\tpublic static String escapeExcludingSlashIncludingSpace(final String toEscape) {\n+\n+\t\tfinal StringBuilder escapedString = new StringBuilder();\n+\t\tfor (int i = 0; i < toEscape.length(); i++) {\n+\t\t\tfinal char c = toEscape.charAt(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "018cd22e3960381c5b4161cf0f2d46ba2d8f4df7"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTY5MzQy", "url": "https://github.com/dotCMS/core/pull/18135#pullrequestreview-374569342", "createdAt": "2020-03-13T19:50:24Z", "commit": {"oid": "018cd22e3960381c5b4161cf0f2d46ba2d8f4df7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1181, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}