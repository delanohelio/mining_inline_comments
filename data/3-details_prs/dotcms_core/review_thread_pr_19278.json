{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4ODMyNTc3", "number": 19278, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODoxOTo1MVrOEkqudA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoxMzozMlrOEmL3fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2ODg0MjEyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODoxOTo1MVrOHTvlUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODoxOTo1MVrOHTvlUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2NDU5Mg==", "bodyText": "I think this code should be part of a more generic Serializer - DotContentletTransformer- any content can have a key/value field, not just Pages", "url": "https://github.com/dotCMS/core/pull/19278#discussion_r490464592", "createdAt": "2020-09-17T18:19:51Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "diffHunk": "@@ -54,14 +60,42 @@ public void serialize(final PageView pageView, final JsonGenerator jsonGenerator\n \n         if (null != pageView.getUrlContent()) {\n \n-            final DotContentletTransformer transformer = new DotTransformerBuilder().defaultOptions().content(pageView.getUrlContent()).build();\n-            final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n-            pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+            this.createObjectMapUrlContent(pageView.getUrlContent(), pageViewMap);\n         }\n \n         return pageViewMap;\n     }\n \n+    protected void createObjectMapUrlContent(final Contentlet urlContent, final Map<String, Object> pageViewMap) {\n+\n+        final DotContentletTransformer transformer   = new DotTransformerBuilder().defaultOptions().content(urlContent).build();\n+        final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n+        this.createObjectMapKeyValue(urlContent, urlContent.getContentType(), urlContentletMap);\n+\n+        pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+    }\n+\n+    /**\n+     * Get all key value fields into the contentlet (if any) and put as an object into the contentMap (returns it)\n+     * @param contentlet    {@link Contentlet}\n+     * @param contentType   {@link ContentType}\n+     * @param contentletMap {@link Map}\n+     * @return Map\n+     */\n+    protected Map<String, Object> createObjectMapKeyValue(final Contentlet contentlet, final ContentType contentType, final Map<String, Object> contentletMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71afdfe42f323f3b2009e859088d9b9a72a70f0a"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDc1Nzc1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoxMzozMlrOHWEXIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoxMzozMlrOHWEXIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwMjE3Ng==", "bodyText": "I don't think the strategy should be applied directly it must be applied from within the transformer.\nLet's say you do\nnew DotTransformerBuilder().defaultOptions() \nthe code that instructs the transformer to apply this strategy must be part of the options provided to the transformer. You should never apply a strategy outside of the transformer", "url": "https://github.com/dotCMS/core/pull/19278#discussion_r492902176", "createdAt": "2020-09-22T17:13:32Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/PageViewSerializer.java", "diffHunk": "@@ -54,14 +63,36 @@ public void serialize(final PageView pageView, final JsonGenerator jsonGenerator\n \n         if (null != pageView.getUrlContent()) {\n \n-            final DotContentletTransformer transformer = new DotTransformerBuilder().defaultOptions().content(pageView.getUrlContent()).build();\n-            final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n-            pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+            this.createObjectMapUrlContent(pageView.getUrlContent(), pageViewMap);\n         }\n \n         return pageViewMap;\n     }\n \n+    protected void createObjectMapUrlContent(final Contentlet urlContent, final Map<String, Object> pageViewMap) {\n+\n+        final DotContentletTransformer transformer   = new DotTransformerBuilder().defaultOptions().content(urlContent).build();\n+        final Map<String, Object>   urlContentletMap = transformer.toMaps().stream().findFirst().orElse(Collections.EMPTY_MAP);\n+        this.createObjectMapKeyValue(urlContent, urlContentletMap);\n+\n+        pageViewMap.put(\"urlContentMap\", urlContentletMap);\n+    }\n+\n+    /**\n+     * Get all key value fields into the contentlet (if any) and put as an object into the contentMap (returns it)\n+     * @param contentlet    {@link Contentlet}\n+     * @param contentType   {@link ContentType}\n+     * @param contentletMap {@link Map}\n+     * @return Map\n+     */\n+    protected Map<String, Object> createObjectMapKeyValue(final Contentlet contentlet,\n+                                                          final Map<String, Object> contentletMap) {\n+\n+        new KeyValueViewStrategy(null).apply(contentlet, contentletMap, null, null);\n+        return contentletMap;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25c36ccdc7f59a6d01f9c82a9030ba77cb362233"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1881, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}