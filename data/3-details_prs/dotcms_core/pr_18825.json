{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNjg3OTEw", "number": 18825, "title": "Issue 18744 global urlmaps", "bodyText": "This pull request re-enables the old behavior of \"global urlmap\".  If a contentlet is on the system host, and the site being visited has the detail page (based on the path of the selected detail page) then we use that detail page to serve the url map.  Otherwise, the urlmap is not available on that host.", "createdAt": "2020-07-02T18:50:36Z", "url": "https://github.com/dotCMS/core/pull/18825", "merged": true, "mergeCommit": {"oid": "edb4740abf76b21537658edd32e1cb3ebb811d8c"}, "closed": true, "closedAt": "2020-07-07T14:51:31Z", "author": {"login": "wezell"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsljs7AH2gAyNDQzNjg3OTEwOmVjYTU0MGJiMGNiOWFiMGU2NjBmNTViYTlkZmQ1MTdhM2JkMDI0ZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyZPROAFqTQ0MzQ1MzEzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eca540bb0cb9ab0e660f55ba9dfd517a3bd024ee", "author": {"user": {"login": "fmontes", "name": "Freddy Montes"}}, "url": "https://github.com/dotCMS/core/commit/eca540bb0cb9ab0e660f55ba9dfd517a3bd024ee", "committedDate": "2020-06-18T21:44:14Z", "message": "Update dotcmsReleaseVersion and coreWebReleasion version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6fd2dd2719a54fd3e87a1d024249f46348ab3f8", "author": {"user": {"login": "fmontes", "name": "Freddy Montes"}}, "url": "https://github.com/dotCMS/core/commit/b6fd2dd2719a54fd3e87a1d024249f46348ab3f8", "committedDate": "2020-06-18T21:46:13Z", "message": "update release version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "039c6f05ab759ca542743d77cb9cb9412263295a", "author": {"user": {"login": "fmontes", "name": "Freddy Montes"}}, "url": "https://github.com/dotCMS/core/commit/039c6f05ab759ca542743d77cb9cb9412263295a", "committedDate": "2020-06-19T14:54:04Z", "message": "Update dotcms-webcomponents version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "293b443dc467e8b9b2b2deb5dbde474ebb2024ab", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/293b443dc467e8b9b2b2deb5dbde474ebb2024ab", "committedDate": "2020-06-19T15:21:06Z", "message": "Merge remote-tracking branch 'origin/release-5.3.3'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90d2504509bfe608d5a1e152f069b4bdce5c135e", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/90d2504509bfe608d5a1e152f069b4bdce5c135e", "committedDate": "2020-06-22T13:18:20Z", "message": "Merge branch 'master' of https://github.com/dotCMS/core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5ce7a444491e0ecc07287db51f27e68ba9417f", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/2f5ce7a444491e0ecc07287db51f27e68ba9417f", "committedDate": "2020-06-22T15:42:31Z", "message": "#18744 initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f86218dd7e32df7214b0055e22a51c4daecf75c", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/1f86218dd7e32df7214b0055e22a51c4daecf75c", "committedDate": "2020-06-22T16:18:49Z", "message": "#18744 global urlmaps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec1138a766579bb78d4b4c39a65b914f8883d8c", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/0ec1138a766579bb78d4b4c39a65b914f8883d8c", "committedDate": "2020-06-30T15:56:53Z", "message": "erge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b53d82930ba3ee645a8d605f81863c162328d1d6", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/b53d82930ba3ee645a8d605f81863c162328d1d6", "committedDate": "2020-06-30T22:12:38Z", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56181a8999a04c8424de2294940aedb49e294aa0", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/56181a8999a04c8424de2294940aedb49e294aa0", "committedDate": "2020-06-30T22:16:16Z", "message": "#18744 updating to master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbdb412b0eb9fbdc1fa20eea55306a78f3826bd6", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/bbdb412b0eb9fbdc1fa20eea55306a78f3826bd6", "committedDate": "2020-06-30T23:42:32Z", "message": "#18744 global urlmap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a6abb1efe6fe3711c6a771fc34a4507acdb24c4", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/9a6abb1efe6fe3711c6a771fc34a4507acdb24c4", "committedDate": "2020-07-01T17:36:12Z", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdf09c871d72b785c326d3b5e372504c8f144c00", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/bdf09c871d72b785c326d3b5e372504c8f144c00", "committedDate": "2020-07-01T17:43:39Z", "message": "Merge remote-tracking branch 'origin/master' into issue-18744-global-urlmaps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e656f3ade3817fd66ba647f1ce48b76cf37a89de", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/e656f3ade3817fd66ba647f1ce48b76cf37a89de", "committedDate": "2020-07-02T17:56:09Z", "message": "#18744 tests for global urlmaps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMDU2MzI3", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442056327", "createdAt": "2020-07-02T22:41:31Z", "commit": {"oid": "e656f3ade3817fd66ba647f1ce48b76cf37a89de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/cb28cf1f33e644dbd646ced5d2cc8659554dbe1c", "committedDate": "2020-07-03T11:41:29Z", "message": "#18744 fixing broken tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTMx", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359931", "createdAt": "2020-07-03T11:50:53Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1M1rOGst6wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1M1rOGst6wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg0OQ==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542849", "createdAt": "2020-07-03T11:50:53Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        Optional<URLMapInfo> urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        URLMapInfo urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());\n+        assertEquals(pageOnHost1.getURI(), urlMapInfo.getIdentifier().getURI());\n+        \n+\n+        // WORKS :  trying where contentlet on the system host and request is on host2, which also has a detail page in the right place\n+        context = getUrlMapContext(systemUser, host2,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());\n+        assertEquals(pageOnHost2.getURI(), urlMapInfo.getIdentifier().getURI());\n+        \n+        \n+        \n+        // FAIL : trying where contentlet on the system host and request is on host3, which does not have a detail page\n+        context = getUrlMapContext(systemUser, host3,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        assert(!urlMapInfoOptional.isPresent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTQ1", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359945", "createdAt": "2020-07-03T11:50:54Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NFrOGst6zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NFrOGst6zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg2MQ==", "bodyText": "Codacy found an issue: StringBuffer (or StringBuilder).append is called consecutively without reusing the target variable.", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542861", "createdAt": "2020-07-03T11:50:54Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")\n+            .append(\" +(conhost:\")\n+                .append(context.getHost().getIdentifier())\n+                .append(\" OR conhost:\")\n+                .append(Host.SYSTEM_HOST)\n+            .append(\")\");\n+        \n+\n+        if (context.getMode().showLive) {\n+            query.append(\" +live:true \");\n         } else {\n-            query.append(\"+live:true \");\n+            query.append(\" +working:true \");\n         }\n \n-        if (null != hostField && context.getHost() != null) {\n-            query.append(this.getHostFilter(context.getHost()));\n-        }\n+\n \n         query.append(\" \");\n-        query.append(this.buildFields(structure, matches))\n-             .append(\" +languageId:\").append(context.getLanguageId());\n+        query.append(this.buildFields(structure, matches));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 266}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTUz", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359953", "createdAt": "2020-07-03T11:50:55Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NVrOGst60Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NVrOGst60Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg2NQ==", "bodyText": "Codacy found an issue: StringBuffer (or StringBuilder).append is called 2 consecutive times with literals. Use a single append with a single combined String.", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542865", "createdAt": "2020-07-03T11:50:55Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 243}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTYy", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359962", "createdAt": "2020-07-03T11:50:56Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NlrOGst62g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1NlrOGst62g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg3NA==", "bodyText": "Codacy found an issue: The String literal \"my-detail\" appears 4 times in this file; the first occurrence is on line 118", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542874", "createdAt": "2020-07-03T11:50:56Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTcy", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359972", "createdAt": "2020-07-03T11:50:57Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1N1rOGst64g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1N1rOGst64g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg4Mg==", "bodyText": "Codacy found an issue: The String literal \"folder\" appears 4 times in this file; the first occurrence is on line 110", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542882", "createdAt": "2020-07-03T11:50:57Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTc5", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359979", "createdAt": "2020-07-03T11:50:58Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OFrOGst66A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OFrOGst66A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg4OA==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542888", "createdAt": "2020-07-03T11:50:58Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU5OTkw", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442359990", "createdAt": "2020-07-03T11:50:59Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OVrOGst68w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OVrOGst68w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg5OQ==", "bodyText": "Codacy found an issue: Avoid appending characters as strings in StringBuffer.append.", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542899", "createdAt": "2020-07-03T11:50:59Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -268,34 +256,40 @@ private void checkContentPermission(final UrlMapContext context, final Contentle\n                 contentlet, PermissionLevel.READ.getType(), context.getUser(), context.getMode().respectAnonPerms);\n \n         if (!havePermission) {\n-            throw new DotSecurityException(String.format(\"User dont have permission in content: %s\", contentlet.getName()));\n+            throw new DotSecurityException(String.format(\"User does not have permission in content: %s\", contentlet.getName()));\n         }\n     }\n \n     private String buildContentQuery(\n             final Matches matches,\n-            final Structure structure,\n-            final Field hostField,\n+            final ContentType structure,\n             final UrlMapContext context) {\n \n         final StringBuilder query = new StringBuilder();\n \n-        query.append(\"+structureName:\").append(structure.getVelocityVarName())\n-             .append(\" +deleted:false \");\n-\n-        if (context.getMode() == PageMode.PREVIEW_MODE || context.getMode() == PageMode.EDIT_MODE) {\n-            query.append(\"+working:true \");\n+        query.append(\"+contentType:\")\n+            .append(structure.variable())\n+            .append(\" +deleted:false \")\n+            .append(\" +(conhost:\")\n+                .append(context.getHost().getIdentifier())\n+                .append(\" OR conhost:\")\n+                .append(Host.SYSTEM_HOST)\n+            .append(\")\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 248}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzYwMDAz", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442360003", "createdAt": "2020-07-03T11:50:59Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OVrOGst6-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MDo1OVrOGst6-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MjkwNQ==", "bodyText": "Codacy found an issue: The String literal \"urlTitle\" appears 18 times in this file; the first occurrence is on line 148", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542905", "createdAt": "2020-07-03T11:50:59Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzYwMDEw", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-442360010", "createdAt": "2020-07-03T11:51:00Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MTowMFrOGst7Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MTowMFrOGst7Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MjkxNA==", "bodyText": "Codacy found an issue: The String literal \"title\" appears 14 times in this file; the first occurrence is on line 153", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r449542914", "createdAt": "2020-07-03T11:51:00Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/cms/urlmap/URLMapAPIImplTest.java", "diffHunk": "@@ -90,6 +91,133 @@ public void prepareTest() {\n         urlMapAPI = new URLMapAPIImpl();\n     }\n \n+    /**\n+     * UrlMapped Content that lives on the system host should be available on every host where the map\n+     * detail page exists (by path). If content does not live on the system host, it should only be\n+     * available on the host it is currently one\n+     * \n+     * @throws Exception\n+     */\n+\n+\n+    @Test\n+    public void systemHost_UrlMaps_Should_Work_Across_Hosts() throws Exception {\n+\n+        final Host host1 = new SiteDataGen().nextPersisted();\n+        final Host host2 = new SiteDataGen().nextPersisted();\n+        final Host host3 = new SiteDataGen().nextPersisted();\n+        \n+        final Folder folder1 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host1).nextPersisted();\n+        final Folder folder2 = new FolderDataGen().name(\"folder\").title(\"folder\").site(host2).nextPersisted();\n+\n+\n+\n+        final Template template1 = new TemplateDataGen().site(host1).nextPersisted();\n+        final Template template2 = new TemplateDataGen().site(host2).nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost1 = new HTMLPageDataGen(folder1, template1).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final HTMLPageAsset pageOnHost2 = new HTMLPageDataGen(folder2, template2).pageURL(\"my-detail\")\n+                        .title(\"my-detail\").nextPersisted();\n+\n+        final String urlPattern = \"/\" + UUIDGenerator.shorty() + \"/{urlTitle}\";\n+        \n+        // set the detail page to page on host1\n+        final ContentType contentType1 = getNewsLikeContentType(\"News\" + System.currentTimeMillis(),\n+                        APILocator.systemHost(), pageOnHost1.getIdentifier(), urlPattern);\n+\n+\n+        final Contentlet newsOnSystemHost = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(),\n+                        APILocator.systemHost(), null, UUIDGenerator.generateUuid());\n+\n+\n+        final Contentlet newsOnHost1 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host1,\n+                        null, UUIDGenerator.generateUuid());\n+\n+        final Contentlet newsOnHost2 = TestDataUtils.getNewsContent(true,\n+                        APILocator.getLanguageAPI().getDefaultLanguage().getId(), contentType1.id(), host2,\n+                        null, UUIDGenerator.generateUuid());\n+\n+\n+        \n+        // WORKS : trying where contentlet on the system host and request is on host1 \n+        UrlMapContext context = getUrlMapContext(systemUser, host1,\n+                        urlPattern.replace(\"{urlTitle}\", newsOnSystemHost.getStringProperty(\"urlTitle\")));\n+\n+        Optional<URLMapInfo> urlMapInfoOptional = urlMapAPI.processURLMap(context);\n+        URLMapInfo urlMapInfo = urlMapInfoOptional.get();\n+\n+        assertEquals(newsOnSystemHost.getStringProperty(\"title\"), urlMapInfo.getContentlet().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjEyNTUy", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-443212552", "createdAt": "2020-07-06T16:05:39Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjowNTozOVrOGtduEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjowNTozOVrOGtduEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjAzMw==", "bodyText": "why do you remove the 'volatile'?", "url": "https://github.com/dotCMS/core/pull/18825#discussion_r450326033", "createdAt": "2020-07-06T16:05:39Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -44,12 +40,11 @@\n  */\n public class URLMapAPIImpl implements URLMapAPI {\n \n-    private volatile Collection<ContentTypeURLPattern> patternsCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDUzMTMy", "url": "https://github.com/dotCMS/core/pull/18825#pullrequestreview-443453132", "createdAt": "2020-07-06T22:46:36Z", "commit": {"oid": "cb28cf1f33e644dbd646ced5d2cc8659554dbe1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 783, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}