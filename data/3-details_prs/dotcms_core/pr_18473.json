{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODE0NzE0", "number": 18473, "title": "Issue 18356 whats changed", "bodyText": "This comes to solve #18356\nThis code depends on other PR for the enterprise module dotCMS/enterprise#726\nBasically I'm updating the diff tool to use the new HTMLPageAssetRenderedBuilder\nThe old method doesn't do what it is expected to. Therefore I am deprecating it.", "createdAt": "2020-05-12T15:50:38Z", "url": "https://github.com/dotCMS/core/pull/18473", "merged": true, "mergeCommit": {"oid": "a8bf013a2eaa93ef30be11f469a9f8cbfd909523"}, "closed": true, "closedAt": "2020-05-13T18:46:12Z", "author": {"login": "fabrizzio-dotCMS"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgQ_WUAH2gAyNDE2ODE0NzE0OjJkMGRhOTM0YzBmNWEzOTRjMGUxZWMwZTVjNDkyYjliYjljNDU1MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg9FBOgFqTQxMTE4NTI4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d0da934c0f5a394c0e1ec0e5c492b9bb9c45506", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/2d0da934c0f5a394c0e1ec0e5c492b9bb9c45506", "committedDate": "2020-05-11T14:59:20Z", "message": "#18356 whats changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/c3750272d57d9cd26c6af473c21b48fd431a54bd", "committedDate": "2020-05-12T15:29:27Z", "message": "#18356  adding a diff tool test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTk3ODM0", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410197834", "createdAt": "2020-05-12T16:07:16Z", "commit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNjowNzoxNlrOGUOFKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNjowNzoxNlrOGUOFKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTQwMg==", "bodyText": "Expected Result looks incomplete", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r423855402", "createdAt": "2020-05-12T16:07:16Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,272 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+        contentletAPI = APILocator.getContentletAPI();\n+        final LanguageAPI languageAPI = APILocator.getLanguageAPI();\n+        multiTreeAPI = APILocator.getMultiTreeAPI();\n+        systemUser = APILocator.systemUser();\n+        site = new SiteDataGen().nextPersisted();\n+        defaultLang = languageAPI.getDefaultLanguage();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(systemUser);\n+        final ContentType contentGenericType = contentTypeAPI.find(\"webPageContent\");\n+        contentGenericId = contentGenericType.id();\n+\n+        final String nameTitle = \"anyTestContainer\" + System.currentTimeMillis();\n+        uuid = UUIDGenerator.generateUuid();\n+        container = new ContainerDataGen()\n+                .withContentType(contentGenericType, \"$!{body}\")\n+                .friendlyName(nameTitle)\n+                .title(nameTitle)\n+                .nextPersisted();\n+\n+        PublishFactory.publishAsset(container, systemUser, false, false);\n+        template = new TemplateDataGen().withContainer(container.getIdentifier(), uuid)\n+                .nextPersisted();\n+\n+        folder = new FolderDataGen().site(site).nextPersisted();\n+\n+        PublishFactory.publishAsset(template, systemUser, false, false);\n+    }\n+\n+    /**\n+     * Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjYwNjA2", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410260606", "createdAt": "2020-05-12T17:21:40Z", "commit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzoyMTo0MFrOGUREzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzoyMTo0MFrOGUREzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNDQ2Mg==", "bodyText": "remove comment", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r423904462", "createdAt": "2020-05-12T17:21:40Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/main/webapp/html/portlet/ext/htmlpages/view_live_working_diff.jsp", "diffHunk": "@@ -8,17 +8,17 @@\n     String id = request.getParameter(\"id\");\n     long lang = Long.parseLong(request.getParameter(\"pageLang\"));\n     User user = APILocator.getUserAPI().getSystemUser();\n-    String contentId = request.getParameter(\"contentId\");\n-    IHTMLPage p = null;\n+    //String contentId = request.getParameter(\"contentId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjYwNzQz", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410260743", "createdAt": "2020-05-12T17:21:50Z", "commit": {"oid": "c3750272d57d9cd26c6af473c21b48fd431a54bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a8e74ea794bf4efb423d4ef7e0ad5168c2ec9c", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/34a8e74ea794bf4efb423d4ef7e0ad5168c2ec9c", "committedDate": "2020-05-12T17:38:34Z", "message": "#18356 improve javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce1d90744a8cc00cf4c728c98681df4605ac0a73", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/ce1d90744a8cc00cf4c728c98681df4605ac0a73", "committedDate": "2020-05-12T17:44:58Z", "message": "#18356 feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc13aca3811836abe30f29c75eb810f7557eb466", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/fc13aca3811836abe30f29c75eb810f7557eb466", "committedDate": "2020-05-12T18:02:03Z", "message": "#18356 feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjk2NjA0", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410296604", "createdAt": "2020-05-12T18:07:29Z", "commit": {"oid": "fc13aca3811836abe30f29c75eb810f7557eb466"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDcxNjAw", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410471600", "createdAt": "2020-05-12T22:38:19Z", "commit": {"oid": "fc13aca3811836abe30f29c75eb810f7557eb466"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTYzNTI2", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-410963526", "createdAt": "2020-05-13T14:09:25Z", "commit": {"oid": "fc13aca3811836abe30f29c75eb810f7557eb466"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/056bd139924fd2514d1b0cf4e49d86f97e1f8a56", "committedDate": "2020-05-13T15:49:03Z", "message": "#18356 test must use HTMLDiffUtilProxy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgxNzY3", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411081767", "createdAt": "2020-05-13T16:09:32Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozMlrOGU5DEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozMlrOGU5DEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTM3OQ==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r424559379", "createdAt": "2020-05-13T16:09:32Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,273 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+        contentletAPI = APILocator.getContentletAPI();\n+        final LanguageAPI languageAPI = APILocator.getLanguageAPI();\n+        multiTreeAPI = APILocator.getMultiTreeAPI();\n+        systemUser = APILocator.systemUser();\n+        site = new SiteDataGen().nextPersisted();\n+        defaultLang = languageAPI.getDefaultLanguage();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(systemUser);\n+        final ContentType contentGenericType = contentTypeAPI.find(\"webPageContent\");\n+        contentGenericId = contentGenericType.id();\n+\n+        final String nameTitle = \"anyTestContainer\" + System.currentTimeMillis();\n+        uuid = UUIDGenerator.generateUuid();\n+        container = new ContainerDataGen()\n+                .withContentType(contentGenericType, \"$!{body}\")\n+                .friendlyName(nameTitle)\n+                .title(nameTitle)\n+                .nextPersisted();\n+\n+        PublishFactory.publishAsset(container, systemUser, false, false);\n+        template = new TemplateDataGen().withContainer(container.getIdentifier(), uuid)\n+                .nextPersisted();\n+\n+        folder = new FolderDataGen().site(site).nextPersisted();\n+\n+        PublishFactory.publishAsset(template, systemUser, false, false);\n+    }\n+\n+    /**\n+     * Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy and modify the list of items. The new items must replace the old ones.\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_With_Changes_Expect_Difference() throws Exception {\n+\n+        final String pageName = \"seekers-expect-difference-page\";\n+\n+        final Set<String> seekers = ImmutableSet.of(\"Skywarp\", \"Starscream\", \"Thundercracker\");\n+\n+        final Set<String> coneheads = ImmutableSet.of(\"Thrust\", \"Ramjet\", \"Dirge\");\n+\n+        final Contentlet contentlet = new ContentletDataGen(contentGenericId)\n+                .languageId(defaultLang.getId())\n+                .folder(folder)\n+                .host(site)\n+                .setProperty(\"title\", \"seekers\")\n+                .setProperty(\"body\", String.join(\",\", seekers))\n+                .nextPersisted();\n+\n+        contentlet.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        contentlet.setIndexPolicyDependencies(IndexPolicy.WAIT_FOR);\n+        contentlet.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        contentletAPI.publish(contentlet, systemUser, false);\n+\n+        final HTMLPageAsset pageLive = new HTMLPageDataGen(folder, template).languageId(defaultLang.getId())\n+                .pageURL(pageName)\n+                .friendlyName(pageName)\n+                .title(pageName).nextPersisted();\n+\n+        final MultiTree multiTreeV1 = new MultiTree(pageLive.getIdentifier(),\n+                container.getIdentifier(), contentlet.getIdentifier(),\n+                getDotParserContainerUUID(uuid), 0);\n+        multiTreeAPI.saveMultiTree(multiTreeV1);\n+        HTMLPageDataGen.publish(pageLive);\n+\n+        final Contentlet workingPage = contentletAPI\n+                .checkout(pageLive.getInode(), systemUser, false);\n+        final Contentlet checkedOut = contentletAPI\n+                .checkout(contentlet.getInode(), systemUser, false);\n+        checkedOut.setProperty(\"body\", String.join(\",\", coneheads));\n+        contentletAPI.checkin(checkedOut, systemUser, false);\n+        contentletAPI.checkin(workingPage, systemUser, false);\n+\n+        final HttpServletRequest request = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final HttpSession session = mock(HttpSession.class);\n+\n+        when(request.getRequestURI()).thenReturn(\"/\"+pageName);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(false)).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER_ID))\n+                .thenReturn(systemUser.getUserId());\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER)).thenReturn(systemUser);\n+        when(session.getAttribute(WebKeys.CMS_USER)).thenReturn(systemUser);\n+\n+        when(request.getParameter(\"host_id\")).thenReturn(site.getIdentifier());\n+        when(request.getAttribute(WebKeys.CURRENT_HOST)).thenReturn(site);\n+        when(session.getAttribute(WebKeys.HTMLPAGE_LANGUAGE)).thenReturn(defaultLang.getId()+\"\");\n+        when(session.getAttribute(WebKeys.PAGE_MODE_SESSION)).thenReturn(PageMode.PREVIEW_MODE);\n+\n+        // Collection to store attributes keys/values\n+        final Map<String, Object> attributes = new ConcurrentHashMap<>();\n+\n+        // Mock setAttribute\n+        Mockito.doAnswer((Answer<Void>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            final Object value = invocation.getArgumentAt(1, Object.class);\n+            attributes.put(key, value);\n+            return null;\n+        }).when(request).setAttribute(Mockito.anyString(), Mockito.anyObject());\n+\n+        // Mock getAttribute\n+        Mockito.doAnswer((Answer<Object>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            return attributes.get(key);\n+        }).when(request).getAttribute(Mockito.anyString());\n+\n+        final String diff = new HTMLDiffUtilProxy().htmlDiffPage(pageLive, systemUser, request, response);\n+        Assert.assertNotEquals(NOTHING_CHANGED,diff);\n+        final Document document = Jsoup.parse(diff);\n+        final Elements removedElements = document.select(\"span.diff-html-removed\");\n+        for (final Element removedElement : removedElements) {\n+           Assert.assertTrue(seekers.contains(removedElement.text()));\n+        }\n+\n+        final Elements addedElements = document.select(\"span.diff-html-added\");\n+        for (final Element addedElement : addedElements) {\n+            Assert.assertTrue(coneheads.contains(addedElement.text()));\n+        }\n+    }\n+\n+\n+    /**\n+     *Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy od the page but this one isn't modified. So whn compared\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_No_Changes_Expect_Nothing_Changed_Message() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "originalPosition": 202}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgxNzc5", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411081779", "createdAt": "2020-05-13T16:09:33Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozM1rOGU5DHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozM1rOGU5DHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTM5MQ==", "bodyText": "Issue found: Do not add empty strings", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r424559391", "createdAt": "2020-05-13T16:09:33Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,273 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+        contentletAPI = APILocator.getContentletAPI();\n+        final LanguageAPI languageAPI = APILocator.getLanguageAPI();\n+        multiTreeAPI = APILocator.getMultiTreeAPI();\n+        systemUser = APILocator.systemUser();\n+        site = new SiteDataGen().nextPersisted();\n+        defaultLang = languageAPI.getDefaultLanguage();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(systemUser);\n+        final ContentType contentGenericType = contentTypeAPI.find(\"webPageContent\");\n+        contentGenericId = contentGenericType.id();\n+\n+        final String nameTitle = \"anyTestContainer\" + System.currentTimeMillis();\n+        uuid = UUIDGenerator.generateUuid();\n+        container = new ContainerDataGen()\n+                .withContentType(contentGenericType, \"$!{body}\")\n+                .friendlyName(nameTitle)\n+                .title(nameTitle)\n+                .nextPersisted();\n+\n+        PublishFactory.publishAsset(container, systemUser, false, false);\n+        template = new TemplateDataGen().withContainer(container.getIdentifier(), uuid)\n+                .nextPersisted();\n+\n+        folder = new FolderDataGen().site(site).nextPersisted();\n+\n+        PublishFactory.publishAsset(template, systemUser, false, false);\n+    }\n+\n+    /**\n+     * Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy and modify the list of items. The new items must replace the old ones.\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_With_Changes_Expect_Difference() throws Exception {\n+\n+        final String pageName = \"seekers-expect-difference-page\";\n+\n+        final Set<String> seekers = ImmutableSet.of(\"Skywarp\", \"Starscream\", \"Thundercracker\");\n+\n+        final Set<String> coneheads = ImmutableSet.of(\"Thrust\", \"Ramjet\", \"Dirge\");\n+\n+        final Contentlet contentlet = new ContentletDataGen(contentGenericId)\n+                .languageId(defaultLang.getId())\n+                .folder(folder)\n+                .host(site)\n+                .setProperty(\"title\", \"seekers\")\n+                .setProperty(\"body\", String.join(\",\", seekers))\n+                .nextPersisted();\n+\n+        contentlet.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        contentlet.setIndexPolicyDependencies(IndexPolicy.WAIT_FOR);\n+        contentlet.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        contentletAPI.publish(contentlet, systemUser, false);\n+\n+        final HTMLPageAsset pageLive = new HTMLPageDataGen(folder, template).languageId(defaultLang.getId())\n+                .pageURL(pageName)\n+                .friendlyName(pageName)\n+                .title(pageName).nextPersisted();\n+\n+        final MultiTree multiTreeV1 = new MultiTree(pageLive.getIdentifier(),\n+                container.getIdentifier(), contentlet.getIdentifier(),\n+                getDotParserContainerUUID(uuid), 0);\n+        multiTreeAPI.saveMultiTree(multiTreeV1);\n+        HTMLPageDataGen.publish(pageLive);\n+\n+        final Contentlet workingPage = contentletAPI\n+                .checkout(pageLive.getInode(), systemUser, false);\n+        final Contentlet checkedOut = contentletAPI\n+                .checkout(contentlet.getInode(), systemUser, false);\n+        checkedOut.setProperty(\"body\", String.join(\",\", coneheads));\n+        contentletAPI.checkin(checkedOut, systemUser, false);\n+        contentletAPI.checkin(workingPage, systemUser, false);\n+\n+        final HttpServletRequest request = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final HttpSession session = mock(HttpSession.class);\n+\n+        when(request.getRequestURI()).thenReturn(\"/\"+pageName);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(false)).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER_ID))\n+                .thenReturn(systemUser.getUserId());\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER)).thenReturn(systemUser);\n+        when(session.getAttribute(WebKeys.CMS_USER)).thenReturn(systemUser);\n+\n+        when(request.getParameter(\"host_id\")).thenReturn(site.getIdentifier());\n+        when(request.getAttribute(WebKeys.CURRENT_HOST)).thenReturn(site);\n+        when(session.getAttribute(WebKeys.HTMLPAGE_LANGUAGE)).thenReturn(defaultLang.getId()+\"\");\n+        when(session.getAttribute(WebKeys.PAGE_MODE_SESSION)).thenReturn(PageMode.PREVIEW_MODE);\n+\n+        // Collection to store attributes keys/values\n+        final Map<String, Object> attributes = new ConcurrentHashMap<>();\n+\n+        // Mock setAttribute\n+        Mockito.doAnswer((Answer<Void>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            final Object value = invocation.getArgumentAt(1, Object.class);\n+            attributes.put(key, value);\n+            return null;\n+        }).when(request).setAttribute(Mockito.anyString(), Mockito.anyObject());\n+\n+        // Mock getAttribute\n+        Mockito.doAnswer((Answer<Object>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            return attributes.get(key);\n+        }).when(request).getAttribute(Mockito.anyString());\n+\n+        final String diff = new HTMLDiffUtilProxy().htmlDiffPage(pageLive, systemUser, request, response);\n+        Assert.assertNotEquals(NOTHING_CHANGED,diff);\n+        final Document document = Jsoup.parse(diff);\n+        final Elements removedElements = document.select(\"span.diff-html-removed\");\n+        for (final Element removedElement : removedElements) {\n+           Assert.assertTrue(seekers.contains(removedElement.text()));\n+        }\n+\n+        final Elements addedElements = document.select(\"span.diff-html-added\");\n+        for (final Element addedElement : addedElements) {\n+            Assert.assertTrue(coneheads.contains(addedElement.text()));\n+        }\n+    }\n+\n+\n+    /**\n+     *Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy od the page but this one isn't modified. So whn compared\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_No_Changes_Expect_Nothing_Changed_Message() throws Exception {\n+\n+        final String pageName = \"seekers-expect-No-difference-page\";\n+\n+        final Contentlet contentlet = new ContentletDataGen(contentGenericId)\n+                .languageId(defaultLang.getId())\n+                .folder(folder)\n+                .host(site)\n+                .setProperty(\"title\", \"seekers\")\n+                .setProperty(\"body\", \"Skywarp, Starscream, Thundercracker\")\n+                .nextPersisted();\n+\n+        contentlet.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        contentlet.setIndexPolicyDependencies(IndexPolicy.WAIT_FOR);\n+        contentlet.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        contentletAPI.publish(contentlet, systemUser, false);\n+\n+       final HTMLPageAsset pageLive = new HTMLPageDataGen(folder, template).languageId(defaultLang.getId())\n+                .pageURL(pageName)\n+                .friendlyName(pageName)\n+                .title(pageName).nextPersisted();\n+\n+        final MultiTree multiTreeV1 = new MultiTree(pageLive.getIdentifier(),\n+                container.getIdentifier(), contentlet.getIdentifier(),\n+                getDotParserContainerUUID(uuid), 0);\n+        multiTreeAPI.saveMultiTree(multiTreeV1);\n+        HTMLPageDataGen.publish(pageLive);\n+\n+        //Force a working copy identical to the original\n+        final Contentlet workingPage = contentletAPI.checkout(pageLive.getInode(), systemUser, false);\n+        contentletAPI.checkin(workingPage, systemUser, false);\n+\n+        final HttpServletRequest request = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final HttpSession session = mock(HttpSession.class);\n+\n+        when(request.getRequestURI()).thenReturn(\"/\"+pageName);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(false)).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER_ID))\n+                .thenReturn(systemUser.getUserId());\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER)).thenReturn(systemUser);\n+        when(session.getAttribute(com.dotmarketing.util.WebKeys.CMS_USER)).thenReturn(systemUser);\n+\n+        when(request.getParameter(\"host_id\")).thenReturn(site.getIdentifier());\n+        when(request.getAttribute(WebKeys.CURRENT_HOST)).thenReturn(site);\n+        when(session.getAttribute(WebKeys.HTMLPAGE_LANGUAGE)).thenReturn(defaultLang.getId()+\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "originalPosition": 249}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgxNzky", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411081792", "createdAt": "2020-05-13T16:09:34Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNFrOGU5DKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNFrOGU5DKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTQwMw==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r424559403", "createdAt": "2020-05-13T16:09:34Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,273 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+        contentletAPI = APILocator.getContentletAPI();\n+        final LanguageAPI languageAPI = APILocator.getLanguageAPI();\n+        multiTreeAPI = APILocator.getMultiTreeAPI();\n+        systemUser = APILocator.systemUser();\n+        site = new SiteDataGen().nextPersisted();\n+        defaultLang = languageAPI.getDefaultLanguage();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(systemUser);\n+        final ContentType contentGenericType = contentTypeAPI.find(\"webPageContent\");\n+        contentGenericId = contentGenericType.id();\n+\n+        final String nameTitle = \"anyTestContainer\" + System.currentTimeMillis();\n+        uuid = UUIDGenerator.generateUuid();\n+        container = new ContainerDataGen()\n+                .withContentType(contentGenericType, \"$!{body}\")\n+                .friendlyName(nameTitle)\n+                .title(nameTitle)\n+                .nextPersisted();\n+\n+        PublishFactory.publishAsset(container, systemUser, false, false);\n+        template = new TemplateDataGen().withContainer(container.getIdentifier(), uuid)\n+                .nextPersisted();\n+\n+        folder = new FolderDataGen().site(site).nextPersisted();\n+\n+        PublishFactory.publishAsset(template, systemUser, false, false);\n+    }\n+\n+    /**\n+     * Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy and modify the list of items. The new items must replace the old ones.\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_With_Changes_Expect_Difference() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgxODA2", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411081806", "createdAt": "2020-05-13T16:09:35Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNVrOGU5DMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNVrOGU5DMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTQxMQ==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r424559411", "createdAt": "2020-05-13T16:09:35Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,273 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgxODIz", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411081823", "createdAt": "2020-05-13T16:09:36Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNlrOGU5DRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTozNlrOGU5DRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTQyOA==", "bodyText": "Issue found: Unnecessary use of fully qualified name 'com.dotmarketing.util.WebKeys.CMS_USER' due to existing import 'com.dotmarketing.util.WebKeys'", "url": "https://github.com/dotCMS/core/pull/18473#discussion_r424559428", "createdAt": "2020-05-13T16:09:36Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/HTMLDiffUtilTest.java", "diffHunk": "@@ -0,0 +1,273 @@\n+package com.dotcms.enterprise;\n+\n+import static com.dotcms.rendering.velocity.directive.ParseContainer.getDotParserContainerUUID;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import com.dotcms.IntegrationTestBase;\n+import com.dotcms.LicenseTestUtil;\n+import com.dotcms.contenttype.business.ContentTypeAPI;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.ContainerDataGen;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.FolderDataGen;\n+import com.dotcms.datagen.HTMLPageDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TemplateDataGen;\n+import com.dotcms.repackage.org.jsoup.Jsoup;\n+import com.dotcms.repackage.org.jsoup.nodes.Document;\n+import com.dotcms.repackage.org.jsoup.nodes.Element;\n+import com.dotcms.repackage.org.jsoup.select.Elements;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.MultiTree;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.factories.MultiTreeAPI;\n+import com.dotmarketing.factories.PublishFactory;\n+import com.dotmarketing.portlets.containers.model.Container;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.UUIDGenerator;\n+import com.dotmarketing.util.WebKeys;\n+import com.google.common.collect.ImmutableSet;\n+import com.liferay.portal.model.User;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Answer;\n+\n+public class HTMLDiffUtilTest extends IntegrationTestBase {\n+\n+    private static ContentletAPI contentletAPI;\n+    private static MultiTreeAPI multiTreeAPI;\n+    private static String contentGenericId;\n+    private static Host site;\n+    private static Template template;\n+    private static Folder folder;\n+    private static User systemUser;\n+    private static Container container;\n+    private static Language defaultLang;\n+    private static String uuid;\n+\n+    private static final String NOTHING_CHANGED = \"Nothing Changed\";\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+\n+        IntegrationTestInitService.getInstance().init();\n+        LicenseTestUtil.getLicense();\n+        contentletAPI = APILocator.getContentletAPI();\n+        final LanguageAPI languageAPI = APILocator.getLanguageAPI();\n+        multiTreeAPI = APILocator.getMultiTreeAPI();\n+        systemUser = APILocator.systemUser();\n+        site = new SiteDataGen().nextPersisted();\n+        defaultLang = languageAPI.getDefaultLanguage();\n+        final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(systemUser);\n+        final ContentType contentGenericType = contentTypeAPI.find(\"webPageContent\");\n+        contentGenericId = contentGenericType.id();\n+\n+        final String nameTitle = \"anyTestContainer\" + System.currentTimeMillis();\n+        uuid = UUIDGenerator.generateUuid();\n+        container = new ContainerDataGen()\n+                .withContentType(contentGenericType, \"$!{body}\")\n+                .friendlyName(nameTitle)\n+                .title(nameTitle)\n+                .nextPersisted();\n+\n+        PublishFactory.publishAsset(container, systemUser, false, false);\n+        template = new TemplateDataGen().withContainer(container.getIdentifier(), uuid)\n+                .nextPersisted();\n+\n+        folder = new FolderDataGen().site(site).nextPersisted();\n+\n+        PublishFactory.publishAsset(template, systemUser, false, false);\n+    }\n+\n+    /**\n+     * Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy and modify the list of items. The new items must replace the old ones.\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_With_Changes_Expect_Difference() throws Exception {\n+\n+        final String pageName = \"seekers-expect-difference-page\";\n+\n+        final Set<String> seekers = ImmutableSet.of(\"Skywarp\", \"Starscream\", \"Thundercracker\");\n+\n+        final Set<String> coneheads = ImmutableSet.of(\"Thrust\", \"Ramjet\", \"Dirge\");\n+\n+        final Contentlet contentlet = new ContentletDataGen(contentGenericId)\n+                .languageId(defaultLang.getId())\n+                .folder(folder)\n+                .host(site)\n+                .setProperty(\"title\", \"seekers\")\n+                .setProperty(\"body\", String.join(\",\", seekers))\n+                .nextPersisted();\n+\n+        contentlet.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        contentlet.setIndexPolicyDependencies(IndexPolicy.WAIT_FOR);\n+        contentlet.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        contentletAPI.publish(contentlet, systemUser, false);\n+\n+        final HTMLPageAsset pageLive = new HTMLPageDataGen(folder, template).languageId(defaultLang.getId())\n+                .pageURL(pageName)\n+                .friendlyName(pageName)\n+                .title(pageName).nextPersisted();\n+\n+        final MultiTree multiTreeV1 = new MultiTree(pageLive.getIdentifier(),\n+                container.getIdentifier(), contentlet.getIdentifier(),\n+                getDotParserContainerUUID(uuid), 0);\n+        multiTreeAPI.saveMultiTree(multiTreeV1);\n+        HTMLPageDataGen.publish(pageLive);\n+\n+        final Contentlet workingPage = contentletAPI\n+                .checkout(pageLive.getInode(), systemUser, false);\n+        final Contentlet checkedOut = contentletAPI\n+                .checkout(contentlet.getInode(), systemUser, false);\n+        checkedOut.setProperty(\"body\", String.join(\",\", coneheads));\n+        contentletAPI.checkin(checkedOut, systemUser, false);\n+        contentletAPI.checkin(workingPage, systemUser, false);\n+\n+        final HttpServletRequest request = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final HttpSession session = mock(HttpSession.class);\n+\n+        when(request.getRequestURI()).thenReturn(\"/\"+pageName);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(false)).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER_ID))\n+                .thenReturn(systemUser.getUserId());\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER)).thenReturn(systemUser);\n+        when(session.getAttribute(WebKeys.CMS_USER)).thenReturn(systemUser);\n+\n+        when(request.getParameter(\"host_id\")).thenReturn(site.getIdentifier());\n+        when(request.getAttribute(WebKeys.CURRENT_HOST)).thenReturn(site);\n+        when(session.getAttribute(WebKeys.HTMLPAGE_LANGUAGE)).thenReturn(defaultLang.getId()+\"\");\n+        when(session.getAttribute(WebKeys.PAGE_MODE_SESSION)).thenReturn(PageMode.PREVIEW_MODE);\n+\n+        // Collection to store attributes keys/values\n+        final Map<String, Object> attributes = new ConcurrentHashMap<>();\n+\n+        // Mock setAttribute\n+        Mockito.doAnswer((Answer<Void>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            final Object value = invocation.getArgumentAt(1, Object.class);\n+            attributes.put(key, value);\n+            return null;\n+        }).when(request).setAttribute(Mockito.anyString(), Mockito.anyObject());\n+\n+        // Mock getAttribute\n+        Mockito.doAnswer((Answer<Object>) invocation -> {\n+            final String key = invocation.getArgumentAt(0, String.class);\n+            return attributes.get(key);\n+        }).when(request).getAttribute(Mockito.anyString());\n+\n+        final String diff = new HTMLDiffUtilProxy().htmlDiffPage(pageLive, systemUser, request, response);\n+        Assert.assertNotEquals(NOTHING_CHANGED,diff);\n+        final Document document = Jsoup.parse(diff);\n+        final Elements removedElements = document.select(\"span.diff-html-removed\");\n+        for (final Element removedElement : removedElements) {\n+           Assert.assertTrue(seekers.contains(removedElement.text()));\n+        }\n+\n+        final Elements addedElements = document.select(\"span.diff-html-added\");\n+        for (final Element addedElement : addedElements) {\n+            Assert.assertTrue(coneheads.contains(addedElement.text()));\n+        }\n+    }\n+\n+\n+    /**\n+     *Given scenario: We have a page created out of a layout and a container. The Container holds a List of items.\n+     * Expected Result:  We create a working copy od the page but this one isn't modified. So whn compared\n+     * @throws Exception\n+     */\n+    @Test\n+    public void Test_Page_No_Changes_Expect_Nothing_Changed_Message() throws Exception {\n+\n+        final String pageName = \"seekers-expect-No-difference-page\";\n+\n+        final Contentlet contentlet = new ContentletDataGen(contentGenericId)\n+                .languageId(defaultLang.getId())\n+                .folder(folder)\n+                .host(site)\n+                .setProperty(\"title\", \"seekers\")\n+                .setProperty(\"body\", \"Skywarp, Starscream, Thundercracker\")\n+                .nextPersisted();\n+\n+        contentlet.setIndexPolicy(IndexPolicy.WAIT_FOR);\n+        contentlet.setIndexPolicyDependencies(IndexPolicy.WAIT_FOR);\n+        contentlet.setBoolProperty(Contentlet.IS_TEST_MODE, true);\n+        contentletAPI.publish(contentlet, systemUser, false);\n+\n+       final HTMLPageAsset pageLive = new HTMLPageDataGen(folder, template).languageId(defaultLang.getId())\n+                .pageURL(pageName)\n+                .friendlyName(pageName)\n+                .title(pageName).nextPersisted();\n+\n+        final MultiTree multiTreeV1 = new MultiTree(pageLive.getIdentifier(),\n+                container.getIdentifier(), contentlet.getIdentifier(),\n+                getDotParserContainerUUID(uuid), 0);\n+        multiTreeAPI.saveMultiTree(multiTreeV1);\n+        HTMLPageDataGen.publish(pageLive);\n+\n+        //Force a working copy identical to the original\n+        final Contentlet workingPage = contentletAPI.checkout(pageLive.getInode(), systemUser, false);\n+        contentletAPI.checkin(workingPage, systemUser, false);\n+\n+        final HttpServletRequest request = mock(HttpServletRequest.class);\n+        final HttpServletResponse response = mock(HttpServletResponse.class);\n+        final HttpSession session = mock(HttpSession.class);\n+\n+        when(request.getRequestURI()).thenReturn(\"/\"+pageName);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(false)).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER_ID))\n+                .thenReturn(systemUser.getUserId());\n+        when(request.getAttribute(com.liferay.portal.util.WebKeys.USER)).thenReturn(systemUser);\n+        when(session.getAttribute(com.dotmarketing.util.WebKeys.CMS_USER)).thenReturn(systemUser);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "originalPosition": 245}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTg1Mjg0", "url": "https://github.com/dotCMS/core/pull/18473#pullrequestreview-411185284", "createdAt": "2020-05-13T18:21:21Z", "commit": {"oid": "056bd139924fd2514d1b0cf4e49d86f97e1f8a56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1098, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}