{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3Mjg2MTQ0", "number": 18247, "title": "Issue 18245 monitor resource", "bodyText": "Changed count(contentlet) to count(dot_cluster) and optimized the query for postgres", "createdAt": "2020-04-01T23:50:17Z", "url": "https://github.com/dotCMS/core/pull/18247", "merged": true, "mergeCommit": {"oid": "af3ffe20f9269b4d76b03e212f6edb50f43a05a4"}, "closed": true, "closedAt": "2020-04-14T22:25:05Z", "author": {"login": "wezell"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTgmJGAH2gAyMzk3Mjg2MTQ0OjlhODNlZmU0M2E1YjNjOGE5NzgzNTg5OTY3NmRjMmI0YzAzNzU5Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTukXkAFqTM4NjU3NTg2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a83efe43a5b3c8a97835899676dc2b4c0375969", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/9a83efe43a5b3c8a97835899676dc2b4c0375969", "committedDate": "2020-04-01T23:49:16Z", "message": "#18245 make monitor query lighter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/cb55653f54650bf09e71591bffe14db1bf20d566", "committedDate": "2020-04-01T23:49:56Z", "message": "#18245 make monitor query lighter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDc1NTM5", "url": "https://github.com/dotCMS/core/pull/18247#pullrequestreview-386475539", "createdAt": "2020-04-02T14:21:42Z", "commit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMTo0MlrOF_tm1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjozN1rOF_tpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA==", "bodyText": "why is not it  just do 'SELECT 1 FROM dot_cluster LIMIT 1'?, really we don't need to count, also we can do it for every data base.", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402351828", "createdAt": "2020-04-02T14:21:42Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjUyMg==", "bodyText": "I think is good idea so some test here, we can test this method\n\n  \n    \n      core/dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java\n    \n    \n         Line 87\n      in\n      cb55653\n    \n    \n    \n    \n\n        \n          \n           MonitorStats getMonitorStats() throws Throwable{", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402352522", "createdAt": "2020-04-02T14:22:37Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;\n+                        }\n+                        else {\n+                            return  dc.setSQL(\"SELECT count(*) as count from dot_cluster\").getInt(\"count\")>0;\n+                        }\n                     }\n                     finally{\n                         DbConnectionFactory.closeSilently();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDg4MDY4", "url": "https://github.com/dotCMS/core/pull/18247#pullrequestreview-386488068", "createdAt": "2020-04-02T14:34:04Z", "commit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTYzMjAy", "url": "https://github.com/dotCMS/core/pull/18247#pullrequestreview-386563202", "createdAt": "2020-04-02T15:52:09Z", "commit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTc1ODY5", "url": "https://github.com/dotCMS/core/pull/18247#pullrequestreview-386575869", "createdAt": "2020-04-02T16:06:00Z", "commit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1246, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}