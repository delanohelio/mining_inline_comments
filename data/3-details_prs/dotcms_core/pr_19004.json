{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NzQxMDQw", "number": 19004, "title": "Issue 18236 secret export", "bodyText": "This PR is intended to introduce the necessary logic to accomplish a secrets import/export", "createdAt": "2020-07-29T22:18:30Z", "url": "https://github.com/dotCMS/core/pull/19004", "merged": true, "mergeCommit": {"oid": "48008b0fe065bf6a45d96a8ae58a54a63c58772b"}, "closed": true, "closedAt": "2020-09-02T16:40:18Z", "author": {"login": "fabrizzio-dotCMS"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5yDbnAH2gAyNDU4NzQxMDQwOjYwOGQxMTk2MTY0YTI3ZjYzMWQzNzExYjlkNmE4MjZjZDQ0ZDc5ZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE-iThgFqTQ4MDk5MjE5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "608d1196164a27f631d3711b9d6a826cd44d79f0", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/608d1196164a27f631d3711b9d6a826cd44d79f0", "committedDate": "2020-07-29T21:38:46Z", "message": "#18236 save point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "742fc97aeff49cd4c8a3a7d0da5ed928cb35effb", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/742fc97aeff49cd4c8a3a7d0da5ed928cb35effb", "committedDate": "2020-07-29T22:01:12Z", "message": "Merge branch 'master' into issue-18236-secret-export"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a55086a313641d2a8091dd3fc6c80b73a18161b3", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/a55086a313641d2a8091dd3fc6c80b73a18161b3", "committedDate": "2020-07-31T19:02:00Z", "message": "#18236  export test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/cacef0f9a52bc860b17027634f09580dfa8531f1", "committedDate": "2020-07-31T20:23:17Z", "message": "#18236  feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzcwMTc4", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462770178", "createdAt": "2020-08-06T18:23:14Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyMzoxNFrOG8_MTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyMzoxNFrOG8_MTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzA4NQ==", "bodyText": "Add some log here", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466603085", "createdAt": "2020-08-06T18:23:14Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzcwOTUy", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462770952", "createdAt": "2020-08-06T18:24:22Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNDoyMlrOG8_OxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNDoyMlrOG8_OxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwMzcxNw==", "bodyText": "I am wondering if it is save to delete a file that is gonna be read", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466603717", "createdAt": "2020-08-06T18:24:22Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){\n+           throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = form.getPassword();\n+        final Key key = AppsUtil.generateKey(password);\n+        final File file = appsAPI\n+                .exportSecrets(key, form.isExportAll(), form.getAppKeysBySite(), user);\n+        try {\n+            return  Files.newInputStream(file.toPath());\n+        } finally {\n+            file.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzcxMzgy", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462771382", "createdAt": "2020-08-06T18:24:59Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNDo1OVrOG8_QKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNDo1OVrOG8_QKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNDA3Mw==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466604073", "createdAt": "2020-08-06T18:24:59Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsHelper.java", "diffHunk": "@@ -700,4 +707,72 @@ private boolean isAllFilledWithAsters(final char [] chars){\n          return true;\n     }\n \n+    /**\n+     * Secrets export\n+     * @param form\n+     * @param user\n+     * @return\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     * @throws DotDataException\n+     */\n+    InputStream exportSecrets(final ExportSecretForm form, final User user)\n+            throws DotSecurityException, IOException, DotDataException {\n+\n+        if(isNotSet(form.getPassword())){\n+           throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = form.getPassword();\n+        final Key key = AppsUtil.generateKey(password);\n+        final File file = appsAPI\n+                .exportSecrets(key, form.isExportAll(), form.getAppKeysBySite(), user);\n+        try {\n+            return  Files.newInputStream(file.toPath());\n+        } finally {\n+            file.delete();\n+        }\n+    }\n+\n+    /**\n+     * Secrets import\n+     * @param multipart\n+     * @param user\n+     * @throws IOException\n+     * @throws DotDataException\n+     * @throws JSONException\n+     * @throws DotSecurityException\n+     * @throws EncryptorException\n+     * @throws ClassNotFoundException\n+     */\n+    void importSecrets(final FormDataMultiPart multipart, final User user)\n+            throws IOException, DotDataException, JSONException, DotSecurityException, EncryptorException, ClassNotFoundException {\n+        final MultiPartUtils multiPartUtils = new MultiPartUtils();\n+        final List<File> files = multiPartUtils.getBinariesFromMultipart(multipart);\n+        if(!UtilMethods.isSet(files)){\n+            throw new DotDataException(\"Unable to extract any files from multi-part request.\");\n+        }\n+\n+        final Map<String, Object> bodyMapFromMultipart = multiPartUtils\n+                .getBodyMapFromMultipart(multipart);\n+        final Object object = bodyMapFromMultipart.get(\"password\");\n+\n+        if(null == object){\n+            throw new DotDataException(\"Unable to locate password param.\");\n+        }\n+        final String password = object.toString();\n+        final Key key = AppsUtil.generateKey(password);\n+        final Map<String, List<AppSecrets>> importedSecretsBySiteId = appsAPI\n+                .importSecrets(files.get(0).toPath(), key, user);\n+        for (Entry<String, List<AppSecrets>> entry : importedSecretsBySiteId.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzczMTk0", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462773194", "createdAt": "2020-08-06T18:27:33Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNzozNFrOG8_Vng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNzozNFrOG8_Vng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTQ3MA==", "bodyText": "I think you do not need to handle the exception, Jersey will do for you", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466605470", "createdAt": "2020-08-06T18:27:34Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();\n+            //no need to close i'll get closed upon writing the response\n+            final InputStream stream = helper.exportSecrets(exportSecretForm, user);\n+            return Response.ok(stream, MediaType.APPLICATION_OCTET_STREAM)\n+                    .header(\"content-disposition\", \"attachment; filename=appSecrets.export\")\n+                    .build(); // 200\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzczMzA0", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462773304", "createdAt": "2020-08-06T18:27:42Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNzo0MlrOG8_V5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyNzo0MlrOG8_V5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTU0Mw==", "bodyText": "Add some log here", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466605543", "createdAt": "2020-08-06T18:27:42Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc0MjA5", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462774209", "createdAt": "2020-08-06T18:28:59Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyOTowMFrOG8_YjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyOTowMFrOG8_YjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjIyMQ==", "bodyText": "Add some log\nCheck if permission are needed\nException block is not needed", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606221", "createdAt": "2020-08-06T18:29:00Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/apps/AppsResource.java", "diffHunk": "@@ -433,4 +434,79 @@ public final Response deleteApp(\n         }\n     }\n \n+    /**\n+     * Secrets export\n+     * @param request\n+     * @param response\n+     * @param exportSecretForm\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/export\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response exportSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final ExportSecretForm exportSecretForm\n+    ) {\n+        exportSecretForm.checkValid();\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();\n+            //no need to close i'll get closed upon writing the response\n+            final InputStream stream = helper.exportSecrets(exportSecretForm, user);\n+            return Response.ok(stream, MediaType.APPLICATION_OCTET_STREAM)\n+                    .header(\"content-disposition\", \"attachment; filename=appSecrets.export\")\n+                    .build(); // 200\n+        } catch (Exception e) {\n+            //By doing this mapping here. The resource becomes integration test friendly.\n+            Logger.error(this.getClass(),\"Exception exporting secrets.\", e);\n+            return ResponseUtil.mapExceptionResponse(e);\n+        }\n+    }\n+\n+    /**\n+     * Secrets import\n+     * @param request\n+     * @param response\n+     * @param form\n+     * @return\n+     */\n+    @POST\n+    @Path(\"/import\")\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @Consumes(MediaType.MULTIPART_FORM_DATA)\n+    public final Response importSecrets(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            final FormDataMultiPart form\n+    ) {\n+        try {\n+            final InitDataObject initData =\n+                    new WebResource.InitBuilder(webResource)\n+                            .requiredBackendUser(true)\n+                            .requiredFrontendUser(false)\n+                            .requestAndResponse(request, response)\n+                            .rejectWhenNoUser(true)\n+                            .init();\n+            final User user = initData.getUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc0ODIw", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462774820", "createdAt": "2020-08-06T18:29:52Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyOTo1MlrOG8_amQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyOTo1MlrOG8_amQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjc0NQ==", "bodyText": "Doc", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606745", "createdAt": "2020-08-06T18:29:52Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPI.java", "diffHunk": "@@ -198,6 +201,35 @@ void removeSecretsForSite(Host host, User user)\n     void resetSecrets(User user)\n                     throws DotDataException, IOException;\n \n+    /**\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc0ODg0", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462774884", "createdAt": "2020-08-06T18:29:59Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMDowMFrOG8_ayg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMDowMFrOG8_ayg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjc5NA==", "bodyText": "Doc", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466606794", "createdAt": "2020-08-06T18:30:00Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPI.java", "diffHunk": "@@ -198,6 +201,35 @@ void removeSecretsForSite(Host host, User user)\n     void resetSecrets(User user)\n                     throws DotDataException, IOException;\n \n+    /**\n+     *\n+     * @param key\n+     * @param exportAll\n+     * @param appKeysBySite\n+     * @param user\n+     * @return\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     * @throws IOException\n+     */\n+    File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> appKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException;\n+\n+    /**\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc1NjA3", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462775607", "createdAt": "2020-08-06T18:31:04Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMTowNFrOG8_dDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMTowNFrOG8_dDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzM3NQ==", "bodyText": "I think you can use user.isAdmin, it is pretty much the same", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466607375", "createdAt": "2020-08-06T18:31:04Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc2MTI1", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462776125", "createdAt": "2020-08-06T18:31:52Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMTo1MlrOG8_esA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMTo1MlrOG8_esA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNzc5Mg==", "bodyText": "final AppsSecretsImportExport exportedSecrets =\nexportAll?collectSecretsForExport(appKeysByHost(), user): collectSecretsForExport(paramAppKeysBySite, user);", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466607792", "createdAt": "2020-08-06T18:31:52Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc3NDk0", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462777494", "createdAt": "2020-08-06T18:33:53Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMzo1M1rOG8_imA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozMzo1M1rOG8_imA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODc5Mg==", "bodyText": "just in case check NPE", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466608792", "createdAt": "2020-08-06T18:33:53Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc3NzU0", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462777754", "createdAt": "2020-08-06T18:34:15Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNDoxNVrOG8_jaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNDoxNVrOG8_jaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTAwMA==", "bodyText": "Doc", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609000", "createdAt": "2020-08-06T18:34:15Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();\n+        }\n+    }\n+\n+    /**\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc4Njk5", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462778699", "createdAt": "2020-08-06T18:35:37Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNTozN1rOG8_mWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNTozN1rOG8_mWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTc1Mg==", "bodyText": "Add doc", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609752", "createdAt": "2020-08-06T18:35:37Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsAPIImpl.java", "diffHunk": "@@ -1005,4 +1009,146 @@ public void resetSecrets(final User user)\n        appsCache.clearCache();\n     }\n \n+    /**\n+     *\n+     * @param key\n+     * @param paramAppKeysBySite\n+     * @return\n+     */\n+    public File exportSecrets(final Key key, final boolean exportAll,\n+            final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException, IOException {\n+\n+        if(!userAPI.isCMSAdmin(user)){\n+            throw new DotSecurityException(\"Only Admins are allowed to perform an export operation.\");\n+        }\n+\n+        final AppsSecretsImportExport exportedSecrets;\n+        if (exportAll) {\n+            exportedSecrets = collectSecretsForExport(appKeysByHost(), user);\n+        } else {\n+            exportedSecrets = collectSecretsForExport(paramAppKeysBySite, user);\n+        }\n+\n+        final File tempFile = File.createTempFile(\"secretsExport\", \".tmp\");\n+        try {\n+            writeObject(exportedSecrets, tempFile.toPath());\n+            final byte[] bytes = Files.readAllBytes(tempFile.toPath());\n+            try {\n+                final File file = File.createTempFile(\"secrets\", \".export\");\n+                final byte[] encrypted = AppsUtil.encrypt(key, bytes);\n+                try (OutputStream outputStream = Files.newOutputStream(file.toPath())) {\n+                    outputStream.write(encrypted);\n+                    return file;\n+                }\n+            } catch (EncryptorException e) {\n+                throw new DotDataException(e);\n+            }\n+        } finally {\n+            tempFile.delete();\n+        }\n+    }\n+\n+    /**\n+     *\n+     * @param paramAppKeysBySite\n+     * @param user\n+     * @return\n+     * @throws DotDataException\n+     * @throws DotSecurityException\n+     */\n+    private AppsSecretsImportExport collectSecretsForExport(final Map<String, Set<String>> paramAppKeysBySite, final User user)\n+            throws DotDataException, DotSecurityException {\n+        final Map<String, List<AppSecrets>> exportedSecrets = new HashMap<>();\n+        final Map<String, Set<String>> keysByHost = appKeysByHost();\n+        keysByHost.forEach((siteId, appKeys) -> {\n+            try {\n+                final Host site = hostAPI.find(siteId, user, false);\n+                if (null != site) {\n+\n+                    final Set<String> appKeysBySiteId = paramAppKeysBySite.get(siteId);\n+                    if (isSet(appKeysBySiteId)) {\n+                        for (final String appKey : appKeysBySiteId) {\n+                            final Optional<AppSecrets> optional = getSecrets(appKey, site, user);\n+                            if (optional.isPresent()) {\n+                                final AppSecrets appSecrets = optional.get();\n+                                exportedSecrets\n+                                        .computeIfAbsent(siteId, list -> new LinkedList<>())\n+                                        .add(appSecrets);\n+                            }\n+                        }\n+                    }\n+                } else {\n+                    Logger.warn(AppsAPIImpl.class,\n+                            String.format(\"Unable to find site `%s` \", siteId));\n+                }\n+            } catch (DotDataException | DotSecurityException e) {\n+                Logger.warn(AppsAPIImpl.class, \"An exception occurred collecting the secrets for export\", e);\n+            }\n+        });\n+        return new AppsSecretsImportExport(\n+                exportedSecrets);\n+    }\n+\n+    /**\n+     *\n+     * @param bean\n+     * @param file\n+     * @throws IOException\n+     */\n+    private void writeObject(final AppsSecretsImportExport bean, final Path file)\n+            throws IOException {\n+        try (OutputStream outputStream = Files.newOutputStream(file)) {\n+            try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream)) {\n+                objectOutputStream.writeObject(bean);\n+            }\n+        }\n+    }\n+\n+    /**\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzc4OTcy", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-462778972", "createdAt": "2020-08-06T18:36:01Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNjowMVrOG8_nHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODozNjowMVrOG8_nHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwOTk1MQ==", "bodyText": "Doc", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r466609951", "createdAt": "2020-08-06T18:36:01Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/security/apps/AppsSecretsImportExport.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.dotcms.security.apps;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class AppsSecretsImportExport implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjczNjg2", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-474673686", "createdAt": "2020-08-25T16:55:38Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjo1NTozOFrOHGhJkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjo1NTozOFrOHGhJkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5NjYyNA==", "bodyText": "Please add a description field on each postman test to know the scenario each test is considering", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r476596624", "createdAt": "2020-08-25T16:55:38Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/curl-test/Apps Resource Test.postman_collection.json", "diffHunk": "@@ -808,6 +808,162 @@\n \t\t\t],\n \t\t\t\"protocolProfileBehavior\": {}\n \t\t},\n+\t\t{\n+\t\t\t\"name\": \"import-export\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Njc2NTAy", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-474676502", "createdAt": "2020-08-25T16:59:13Z", "commit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjo1OToxM1rOHGhSDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjo1OToxM1rOHGhSDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5ODc5Ng==", "bodyText": "what is this test for?", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r476598796", "createdAt": "2020-08-25T16:59:13Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/security/apps/AppsUtilTest.java", "diffHunk": "@@ -162,4 +162,13 @@ public void Test_Encrypt_Decrypt_Text_No_Middle_String() throws EncryptorExcepti\n         Assert.assertEquals(input, new String(decrypted));\n     }\n \n+     @Test\n+     public void Test_Key_Padding(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cacef0f9a52bc860b17027634f09580dfa8531f1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c2e80931c437e858b1eea8f2dd2db9a8700872", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/b5c2e80931c437e858b1eea8f2dd2db9a8700872", "committedDate": "2020-08-31T17:32:41Z", "message": "Merge branch 'master' into issue-18236-secret-export"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30fd3c57ce88d8943629256516174a141b837c27", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/30fd3c57ce88d8943629256516174a141b837c27", "committedDate": "2020-09-01T23:02:42Z", "message": "#18236  feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d53faecf8c76f2db52b2511a987a9d4074ea93", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/33d53faecf8c76f2db52b2511a987a9d4074ea93", "committedDate": "2020-09-02T01:54:21Z", "message": "#18236  feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e8194cda1c1f270183678bff40baad3cb16488", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/45e8194cda1c1f270183678bff40baad3cb16488", "committedDate": "2020-09-02T02:03:42Z", "message": "#18236  feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761fef99daa11c9d988ad437c6a8def585179a84", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/761fef99daa11c9d988ad437c6a8def585179a84", "committedDate": "2020-09-02T03:48:16Z", "message": "#18236  feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNDY0NjI4", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-480464628", "createdAt": "2020-09-02T03:54:03Z", "commit": {"oid": "761fef99daa11c9d988ad437c6a8def585179a84"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMzo1NDowM1rOHLUZpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMzo1NDowM1rOHLUZpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzMDYzMA==", "bodyText": "Codacy found an issue: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/19004#discussion_r481630630", "createdAt": "2020-09-02T03:54:03Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/apps/AppsResourceTest.java", "diffHunk": "@@ -1245,6 +1274,69 @@ public void Test_Pagination_And_Sort_Then_Request_Filter_Expect_Empty_Results()\n \n     }\n \n+    /**\n+     * Given Scenario: We create secrets then export that particular one then the generated file is used as the input for the import method.\n+     * Expected Results: The secrets are imported correctly and replace the same old exiting secrets. No additional secrets are created.\n+     * @throws IOException\n+     */\n+     @Test\n+     public void Test_Export_Import() throws IOException {\n+         final AppDescriptorDataGen dataGen = new AppDescriptorDataGen()\n+                 .stringParam(\"param1\", false,  true)\n+                 .stringParam(\"param2\", false,  true)\n+                 .withName(\"import-export-test\")\n+                 .withDescription(\"import-export-test\")\n+                 //We're indicating that extra params are allowed to test required params are still required.\n+                 .withExtraParameters(true);\n+         final String key = dataGen.getKey();\n+         final HttpServletRequest request = mock(HttpServletRequest.class);\n+         final HttpServletResponse response = mock(HttpServletResponse.class);\n+\n+         when(request.getRequestURI()).thenReturn(\"/baseURL\");\n+         final String fileName = dataGen.getFileName();\n+         final File file = dataGen.nextPersistedDescriptor();\n+         try(InputStream inputStream = Files.newInputStream(file.toPath())){\n+             final FormDataMultiPart formDataMultiPart = createFormDataMultiPart(fileName, inputStream);\n+             final Response appResponseOk = appsResource.createApp(request, response,formDataMultiPart);\n+             Assert.assertNotNull(appResponseOk);\n+             Assert.assertEquals(HttpStatus.SC_OK, appResponseOk.getStatus());\n+\n+             final Response availableAppsResponse = appsResource\n+                     .listAvailableApps(request, response, null);\n+             Assert.assertEquals(HttpStatus.SC_OK, availableAppsResponse.getStatus());\n+             final ResponseEntityView responseEntityView1 = (ResponseEntityView) availableAppsResponse\n+                     .getEntity();\n+             final List<AppView> integrationViewList = (List<AppView>) responseEntityView1\n+                     .getEntity();\n+             assertFalse(integrationViewList.isEmpty());\n+\n+             final Host site = new SiteDataGen().nextPersisted();\n+\n+             final String siteId = site.getIdentifier();\n+             final Map<String, Input> inputParamMap = ImmutableMap.of(\n+              \"param1\", newInputParam(\"value\".toCharArray()),\n+              \"param2\", newInputParam(\"value\".toCharArray())\n+             );\n+             final SecretForm secretForm1 = new SecretForm(inputParamMap);\n+             final Response createSecretResponse1 = appsResource.createAppSecrets(request, response, key, siteId, secretForm1);\n+             Assert.assertEquals(HttpStatus.SC_OK, createSecretResponse1.getStatus());\n+\n+             final String password = \"123456789\";\n+             ExportSecretForm form = new ExportSecretForm(password,false, ImmutableMap.of(siteId, ImmutableSet.of(key)));\n+             final OutboundJaxrsResponse exportResponse = (OutboundJaxrsResponse)appsResource.exportSecrets(request, response, form);\n+             final String json = String.format(\"{ password: \\\"%s\\\" }\",password);\n+             final InputStream entity = (InputStream) exportResponse.getEntity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761fef99daa11c9d988ad437c6a8def585179a84"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTcyMjk2", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-480972296", "createdAt": "2020-09-02T16:00:55Z", "commit": {"oid": "761fef99daa11c9d988ad437c6a8def585179a84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTkyMTk2", "url": "https://github.com/dotCMS/core/pull/19004#pullrequestreview-480992196", "createdAt": "2020-09-02T16:24:31Z", "commit": {"oid": "761fef99daa11c9d988ad437c6a8def585179a84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 689, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}