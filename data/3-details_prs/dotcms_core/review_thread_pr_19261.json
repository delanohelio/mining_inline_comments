{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1NTQyMDUy", "number": 19261, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyMzo1NlrOEjMUhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyOTowNFrOEjMgOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzM3NDc3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyMzo1NlrOHRaVzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTo0MzoyNVrOHRbTYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTQwNg==", "bodyText": "We don't need the sync block here, I don't think.", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488019406", "createdAt": "2020-09-14T15:23:56Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -243,10 +242,32 @@ public void remove(final String group, final String key) {\n \t\t\n \t}\n \n+\t/**\n+\t * Calculates the thread allocation % for a given queue size.\n+\t * Then determines if that allocation % exceeds or not a tolerance.\n+\t * @return\n+\t */\n+\tboolean isAllocationWithinTolerance() {\n+\t\tfinal int size = asyncTaskQueue.size();\n+\t\tfinal float allocation = (float) size / (float) asyncTaskQueueSize;\n+\t\tLogger.debug(H22Cache.class,\n+\t\t\t\t() -> \" size is \" + size + \", allocation is \" + allocation + \", tolerance is :\"\n+\t\t\t\t\t\t+ threadAllocationTolerance);\n+\t\treturn allocation < threadAllocationTolerance;\n+\t}\n \n-    void removeAsync(final Fqn fqn) {\n-\n+    /**\n+     * returns true if async set to true and the task queue is < than a given tolerance % full.\n+     *\n+     * @return\n+     */\n+    boolean shouldAsync() {\n+       synchronized (H22Cache.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzNTE2OA==", "bodyText": "ok. removed", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488035168", "createdAt": "2020-09-14T15:43:25Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -243,10 +242,32 @@ public void remove(final String group, final String key) {\n \t\t\n \t}\n \n+\t/**\n+\t * Calculates the thread allocation % for a given queue size.\n+\t * Then determines if that allocation % exceeds or not a tolerance.\n+\t * @return\n+\t */\n+\tboolean isAllocationWithinTolerance() {\n+\t\tfinal int size = asyncTaskQueue.size();\n+\t\tfinal float allocation = (float) size / (float) asyncTaskQueueSize;\n+\t\tLogger.debug(H22Cache.class,\n+\t\t\t\t() -> \" size is \" + size + \", allocation is \" + allocation + \", tolerance is :\"\n+\t\t\t\t\t\t+ threadAllocationTolerance);\n+\t\treturn allocation < threadAllocationTolerance;\n+\t}\n \n-    void removeAsync(final Fqn fqn) {\n-\n+    /**\n+     * returns true if async set to true and the task queue is < than a given tolerance % full.\n+     *\n+     * @return\n+     */\n+    boolean shouldAsync() {\n+       synchronized (H22Cache.class) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTQwNg=="}, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzQwNDc1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyOTowNFrOHRao2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNzowNDoxMFrOHRemtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyNDI4MQ==", "bodyText": "slight optimization - should the initial thread pool be fixed at a smaller number, say 5?", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488024281", "createdAt": "2020-09-14T15:29:04Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -47,12 +44,14 @@\n \n     private static final long serialVersionUID = 1L;\n     final int numberOfAsyncThreads=Config.getIntProperty(\"cache_h22_async_threads\", 10);\n-    \n+    final int asyncTaskQueueSize = Config.getIntProperty(\"cache_h22_async_task_queue\", 10000);\n+\tfinal float threadAllocationTolerance = Config.getFloatProperty(\"cache_h22_async_tolerance\",0.98F);\n     final boolean shouldAsync=Config.getBooleanProperty(\"cache_h22_async\", true);\n \n \n     final ThreadFactory namedThreadFactory =  new ThreadFactoryBuilder().setNameFormat(\"H22-ASYNC-COMMIT-%d\").build();\n-    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(10000),namedThreadFactory);\n+    final private LinkedBlockingQueue<Runnable> asyncTaskQueue = new LinkedBlockingQueue<>();\n+    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, asyncTaskQueue ,namedThreadFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzODY5Ng==", "bodyText": "let me play with that  value a little bit see how it behaves", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488038696", "createdAt": "2020-09-14T15:48:16Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -47,12 +44,14 @@\n \n     private static final long serialVersionUID = 1L;\n     final int numberOfAsyncThreads=Config.getIntProperty(\"cache_h22_async_threads\", 10);\n-    \n+    final int asyncTaskQueueSize = Config.getIntProperty(\"cache_h22_async_task_queue\", 10000);\n+\tfinal float threadAllocationTolerance = Config.getFloatProperty(\"cache_h22_async_tolerance\",0.98F);\n     final boolean shouldAsync=Config.getBooleanProperty(\"cache_h22_async\", true);\n \n \n     final ThreadFactory namedThreadFactory =  new ThreadFactoryBuilder().setNameFormat(\"H22-ASYNC-COMMIT-%d\").build();\n-    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(10000),namedThreadFactory);\n+    final private LinkedBlockingQueue<Runnable> asyncTaskQueue = new LinkedBlockingQueue<>();\n+    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, asyncTaskQueue ,namedThreadFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyNDI4MQ=="}, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA4OTI3MQ==", "bodyText": "looks lie we can totally afford to lower that value. I don't see that much gain in those 5 threads in terms of the number of sync calls performed", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488089271", "createdAt": "2020-09-14T17:04:10Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -47,12 +44,14 @@\n \n     private static final long serialVersionUID = 1L;\n     final int numberOfAsyncThreads=Config.getIntProperty(\"cache_h22_async_threads\", 10);\n-    \n+    final int asyncTaskQueueSize = Config.getIntProperty(\"cache_h22_async_task_queue\", 10000);\n+\tfinal float threadAllocationTolerance = Config.getFloatProperty(\"cache_h22_async_tolerance\",0.98F);\n     final boolean shouldAsync=Config.getBooleanProperty(\"cache_h22_async\", true);\n \n \n     final ThreadFactory namedThreadFactory =  new ThreadFactoryBuilder().setNameFormat(\"H22-ASYNC-COMMIT-%d\").build();\n-    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(10000),namedThreadFactory);\n+    final private LinkedBlockingQueue<Runnable> asyncTaskQueue = new LinkedBlockingQueue<>();\n+    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, asyncTaskQueue ,namedThreadFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyNDI4MQ=="}, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1867, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}