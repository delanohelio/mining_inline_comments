{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODI2MTk0", "number": 19425, "title": "Issue 19379 show cache sizes", "bodyText": "", "createdAt": "2020-10-09T21:20:39Z", "url": "https://github.com/dotCMS/core/pull/19425", "merged": true, "mergeCommit": {"oid": "ad1408ca303e3f0addb09cb1909e092705761cda"}, "closed": true, "closedAt": "2020-10-26T18:38:56Z", "author": {"login": "wezell"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPpXHFgH2gAyNTAwODI2MTk0OmY1MmM3ZjU0MmExNGZhYmVkYjk5YzYwMmU2NGViNDk4MTJmNWVjOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWW3QTAFqTUxNjk1MDkwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f52c7f542a14fabedb99c602e64eb49812f5ec9d", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/f52c7f542a14fabedb99c602e64eb49812f5ec9d", "committedDate": "2020-10-05T19:57:27Z", "message": "#19379 show rough region sizing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ee263250acbd5b3fc94d04dd0e67ed366f7120", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/56ee263250acbd5b3fc94d04dd0e67ed366f7120", "committedDate": "2020-10-07T16:58:58Z", "message": "#19379 trying unsafe first, falling back to serializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77858513871178e766c1a2fd880e02d22b242153", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/77858513871178e766c1a2fd880e02d22b242153", "committedDate": "2020-10-07T16:59:29Z", "message": "#19379 commented out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ed119a88ae7f2da422ece85d867636a37b78e3b", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/7ed119a88ae7f2da422ece85d867636a37b78e3b", "committedDate": "2020-10-07T23:04:05Z", "message": "#19379 with small test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ed5e9e7a806807f00fd8d0756258b58695f5286", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/0ed5e9e7a806807f00fd8d0756258b58695f5286", "committedDate": "2020-10-07T23:06:47Z", "message": "#19379 tests optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2676808a21f5642ebbef204e5ed51b31b4af1698", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/2676808a21f5642ebbef204e5ed51b31b4af1698", "committedDate": "2020-10-07T23:10:56Z", "message": "#19379 tests optional"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzEyMjM2", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-506712236", "createdAt": "2020-10-12T15:18:50Z", "commit": {"oid": "2676808a21f5642ebbef204e5ed51b31b4af1698"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODg4Mzc0", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-507888374", "createdAt": "2020-10-13T23:04:37Z", "commit": {"oid": "2676808a21f5642ebbef204e5ed51b31b4af1698"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d366de5273b870297aa090034b22796bf87d6a2", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/7d366de5273b870297aa090034b22796bf87d6a2", "committedDate": "2020-10-26T13:27:09Z", "message": "Merge remote-tracking branch 'origin/master' into issue-19379-show-cache-sizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22536eba00d5cb138f2335516af3ae87aa99f743", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/22536eba00d5cb138f2335516af3ae87aa99f743", "committedDate": "2020-10-26T14:04:28Z", "message": "#19379 catching the error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd39bb67b49e1d58d531efbacea849b1c799416f", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/dd39bb67b49e1d58d531efbacea849b1c799416f", "committedDate": "2020-10-26T14:21:46Z", "message": "#19379 minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/4db5eca96565f1e816270dc4d0be802b80429ac3", "committedDate": "2020-10-26T16:12:53Z", "message": "#19379 removing unneeded methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNTYx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950561", "createdAt": "2020-10-26T16:21:27Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyN1rOHoXjUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyN1rOHoXjUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDk2Mg==", "bodyText": "Codacy found an issue: Avoid using implementation types like 'HashMap'; use the interface instead", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512090962", "createdAt": "2020-10-26T16:21:27Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"restriction\")\n+    public int sizeof(Class<?> cls) {\n+\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        if (cls.isArray()) {\n+            throw new IllegalArgumentException();\n+        }\n+\n+        if (cls.isPrimitive()) {\n+            return primsize(cls);\n+        }\n+\n+        int lastOffset = Integer.MIN_VALUE;\n+        Class<?> lastClass = null;\n+\n+        for (Field f : getAllNonStaticFields(cls)) {\n+            if (Modifier.isStatic(f.getModifiers())) {\n+                continue;\n+            }\n+\n+            int offset = (int) UnsafeAccess.UNSAFE.objectFieldOffset(f);\n+            if (offset > lastOffset) {\n+                lastOffset = offset;\n+                lastClass = f.getClass();\n+            }\n+        }\n+        if (lastOffset > 0) {\n+            return modulo8(lastOffset + primsize(lastClass));\n+        }\n+\n+        return 16;\n+    }\n+\n+    private Field[] getAllNonStaticFields(Class<?> cls) {\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        List<Field> fieldList = new ArrayList<Field>();\n+        while (cls != Object.class) {\n+            for (Field f : cls.getDeclaredFields()) {\n+                if (!Modifier.isStatic(f.getModifiers())) {\n+                    fieldList.add(f);\n+                }\n+            }\n+            cls = cls.getSuperclass();\n+        }\n+        Field[] fs = new Field[fieldList.size()];\n+        fieldList.toArray(fs);\n+        return fs;\n+    }\n+\n+    private boolean isCalculated(HashMap<Object, Object> calculated, Object test) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 235}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNTcz", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950573", "createdAt": "2020-10-26T16:21:28Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyOFrOHoXjWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyOFrOHoXjWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDk2OQ==", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512090969", "createdAt": "2020-10-26T16:21:28Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNTg4", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950588", "createdAt": "2020-10-26T16:21:29Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyOVrOHoXjYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMToyOVrOHoXjYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDk3Ng==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512090976", "createdAt": "2020-10-26T16:21:29Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/caffine/CaffineCache.java", "diffHunk": "@@ -170,19 +173,23 @@ public CacheProviderStats getStats() {\n \n         Set<String> currentGroups = new HashSet<>();\n         currentGroups.addAll(getGroups());\n-        Cache<String, Object> defaultCache = getCache(DEFAULT_CACHE);\n         NumberFormat nf = DecimalFormat.getInstance();\n         DecimalFormat pf = new DecimalFormat(\"##.##%\");\n+        \n+        CacheSizingUtil sizer = new CacheSizingUtil();\n+        \n+        \n+        \n         for (String group : currentGroups) {\n-            CacheStats stats = new CacheStats();\n+            final CacheStats stats = new CacheStats();\n \n-            Cache<String, Object> foundCache = getCache(group);\n+            final Cache<String, Object> foundCache = getCache(group);\n \n \n-            boolean isDefault = (Config.getIntProperty(\"cache.\" + group + \".size\", -1) == -1);\n+            final boolean isDefault = (Config.getIntProperty(\"cache.\" + group + \".size\", -1) == -1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjAx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950601", "createdAt": "2020-10-26T16:21:30Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMFrOHoXjaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMFrOHoXjaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDk4Nw==", "bodyText": "Codacy found an issue: This final field could be made static", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512090987", "createdAt": "2020-10-26T16:21:30Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjEw", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950610", "createdAt": "2020-10-26T16:21:31Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMVrOHoXjdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMVrOHoXjdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MDk5Ng==", "bodyText": "Codacy found an issue: Substitute calls to size() == 0 (or size() != 0, size() > 0, size() < 1) with calls to isEmpty()", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512090996", "createdAt": "2020-10-26T16:21:31Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjMx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950631", "createdAt": "2020-10-26T16:21:32Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMlrOHoXjfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozMlrOHoXjfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTAwNw==", "bodyText": "Codacy found an issue: Avoid reassigning parameters such as 'cls'", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091007", "createdAt": "2020-10-26T16:21:32Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"restriction\")\n+    public int sizeof(Class<?> cls) {\n+\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        if (cls.isArray()) {\n+            throw new IllegalArgumentException();\n+        }\n+\n+        if (cls.isPrimitive()) {\n+            return primsize(cls);\n+        }\n+\n+        int lastOffset = Integer.MIN_VALUE;\n+        Class<?> lastClass = null;\n+\n+        for (Field f : getAllNonStaticFields(cls)) {\n+            if (Modifier.isStatic(f.getModifiers())) {\n+                continue;\n+            }\n+\n+            int offset = (int) UnsafeAccess.UNSAFE.objectFieldOffset(f);\n+            if (offset > lastOffset) {\n+                lastOffset = offset;\n+                lastClass = f.getClass();\n+            }\n+        }\n+        if (lastOffset > 0) {\n+            return modulo8(lastOffset + primsize(lastClass));\n+        }\n+\n+        return 16;\n+    }\n+\n+    private Field[] getAllNonStaticFields(Class<?> cls) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 216}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjM5", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950639", "createdAt": "2020-10-26T16:21:33Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozM1rOHoXjgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozM1rOHoXjgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTAxMQ==", "bodyText": "Codacy found an issue: Avoid variables with short names like fs", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091011", "createdAt": "2020-10-26T16:21:33Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"restriction\")\n+    public int sizeof(Class<?> cls) {\n+\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        if (cls.isArray()) {\n+            throw new IllegalArgumentException();\n+        }\n+\n+        if (cls.isPrimitive()) {\n+            return primsize(cls);\n+        }\n+\n+        int lastOffset = Integer.MIN_VALUE;\n+        Class<?> lastClass = null;\n+\n+        for (Field f : getAllNonStaticFields(cls)) {\n+            if (Modifier.isStatic(f.getModifiers())) {\n+                continue;\n+            }\n+\n+            int offset = (int) UnsafeAccess.UNSAFE.objectFieldOffset(f);\n+            if (offset > lastOffset) {\n+                lastOffset = offset;\n+                lastClass = f.getClass();\n+            }\n+        }\n+        if (lastOffset > 0) {\n+            return modulo8(lastOffset + primsize(lastClass));\n+        }\n+\n+        return 16;\n+    }\n+\n+    private Field[] getAllNonStaticFields(Class<?> cls) {\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        List<Field> fieldList = new ArrayList<Field>();\n+        while (cls != Object.class) {\n+            for (Field f : cls.getDeclaredFields()) {\n+                if (!Modifier.isStatic(f.getModifiers())) {\n+                    fieldList.add(f);\n+                }\n+            }\n+            cls = cls.getSuperclass();\n+        }\n+        Field[] fs = new Field[fieldList.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 230}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjU3", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950657", "createdAt": "2020-10-26T16:21:34Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNFrOHoXjkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNFrOHoXjkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTAyNA==", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091024", "createdAt": "2020-10-26T16:21:34Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);\n+        \n+        \n+    }\n+    \n+    @Test\n+    public void test_sizeof_null_works() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjgw", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950680", "createdAt": "2020-10-26T16:21:35Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNVrOHoXjng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNVrOHoXjng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTAzOA==", "bodyText": "Codacy found an issue: Classes implementing Serializable should set a serialVersionUID", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091038", "createdAt": "2020-10-26T16:21:35Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/factories/PersonalizedContentlet.java", "diffHunk": "@@ -9,7 +10,7 @@\n  * @see com.google.common.collect.Table\n  * @author jsanca\n  */\n-public class PersonalizedContentlet {\n+public class PersonalizedContentlet implements Serializable{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNjkz", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950693", "createdAt": "2020-10-26T16:21:36Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNlrOHoXjqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozNlrOHoXjqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTA1MQ==", "bodyText": "Codacy found an issue: A catch statement should never catch throwable since it includes errors.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091051", "createdAt": "2020-10-26T16:21:36Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 175}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzA1", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950705", "createdAt": "2020-10-26T16:21:37Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozN1rOHoXjuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozN1rOHoXjuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTA2NA==", "bodyText": "Codacy found an issue: Use equals() to compare object references.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091064", "createdAt": "2020-10-26T16:21:37Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"restriction\")\n+    public int sizeof(Class<?> cls) {\n+\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        if (cls.isArray()) {\n+            throw new IllegalArgumentException();\n+        }\n+\n+        if (cls.isPrimitive()) {\n+            return primsize(cls);\n+        }\n+\n+        int lastOffset = Integer.MIN_VALUE;\n+        Class<?> lastClass = null;\n+\n+        for (Field f : getAllNonStaticFields(cls)) {\n+            if (Modifier.isStatic(f.getModifiers())) {\n+                continue;\n+            }\n+\n+            int offset = (int) UnsafeAccess.UNSAFE.objectFieldOffset(f);\n+            if (offset > lastOffset) {\n+                lastOffset = offset;\n+                lastClass = f.getClass();\n+            }\n+        }\n+        if (lastOffset > 0) {\n+            return modulo8(lastOffset + primsize(lastClass));\n+        }\n+\n+        return 16;\n+    }\n+\n+    private Field[] getAllNonStaticFields(Class<?> cls) {\n+        if (cls == null) {\n+            throw new NullPointerException();\n+        }\n+\n+        List<Field> fieldList = new ArrayList<Field>();\n+        while (cls != Object.class) {\n+            for (Field f : cls.getDeclaredFields()) {\n+                if (!Modifier.isStatic(f.getModifiers())) {\n+                    fieldList.add(f);\n+                }\n+            }\n+            cls = cls.getSuperclass();\n+        }\n+        Field[] fs = new Field[fieldList.size()];\n+        fieldList.toArray(fs);\n+        return fs;\n+    }\n+\n+    private boolean isCalculated(HashMap<Object, Object> calculated, Object test) {\n+        Object that = calculated.get(test);\n+        return that != null && that == test;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 237}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzIw", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950720", "createdAt": "2020-10-26T16:21:38Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozOFrOHoXjxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozOFrOHoXjxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTA3OQ==", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091079", "createdAt": "2020-10-26T16:21:38Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);\n+        \n+        \n+    }\n+    \n+    @Test\n+    public void test_sizeof_null_works() {\n+\n+        long cacheSize = cacheSizer.sizeOf(null);\n+        assert(cacheSize==0);\n+\n+        \n+    }\n+    \n+    \n+    @Test\n+    public void test_sizeof_optional_works() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzMx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950731", "createdAt": "2020-10-26T16:21:39Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozOVrOHoXjzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTozOVrOHoXjzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTA4Nw==", "bodyText": "Codacy found an issue: Avoid throwing null pointer exceptions.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091087", "createdAt": "2020-10-26T16:21:39Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzM4", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950738", "createdAt": "2020-10-26T16:21:40Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MFrOHoXj1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MFrOHoXj1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTA5Mw==", "bodyText": "Codacy found an issue: This final field could be made static", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091093", "createdAt": "2020-10-26T16:21:40Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzYw", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950760", "createdAt": "2020-10-26T16:21:40Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MFrOHoXj4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MFrOHoXj4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTEwNg==", "bodyText": "Codacy found an issue: Classes implementing Serializable should set a serialVersionUID", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091106", "createdAt": "2020-10-26T16:21:40Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/structure/business/FieldAPIImpl.java", "diffHunk": "@@ -24,7 +25,7 @@\n  *             interact with Content Type fields.\n  */\n @Deprecated\n-public class FieldAPIImpl implements FieldAPI {\n+public class FieldAPIImpl implements FieldAPI, Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzc1", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950775", "createdAt": "2020-10-26T16:21:41Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MVrOHoXj7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MVrOHoXj7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTExOQ==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091119", "createdAt": "2020-10-26T16:21:41Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwNzg5", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950789", "createdAt": "2020-10-26T16:21:42Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MlrOHoXj-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0MlrOHoXj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTEyOA==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091128", "createdAt": "2020-10-26T16:21:42Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);\n+        \n+        \n+    }\n+    \n+    @Test\n+    public void test_sizeof_null_works() {\n+\n+        long cacheSize = cacheSizer.sizeOf(null);\n+        assert(cacheSize==0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODA2", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950806", "createdAt": "2020-10-26T16:21:43Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0M1rOHoXkCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0M1rOHoXkCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTE0NA==", "bodyText": "Codacy found an issue: Avoid throwing raw exception types.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091144", "createdAt": "2020-10-26T16:21:43Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();\n+            calculated.put(obj, obj);\n+            Class<?> cls = obj.getClass();\n+            if (cls.isArray()) {\n+                int arraysize = UnsafeAccess.UNSAFE.arrayBaseOffset(cls)\n+                                + UnsafeAccess.UNSAFE.arrayIndexScale(cls) * Array.getLength(obj);\n+                if (!cls.getComponentType().isPrimitive()) {\n+                    Object[] arr = (Object[]) obj;\n+                    for (Object comp : arr) {\n+                        if (comp != null && !isCalculated(calculated, comp) && depth < maxRecusionDepth) {\n+                            arraysize += retainedSize(comp, calculated, depth + 1);\n+                        }\n+                    }\n+                }\n+                return arraysize;\n+            } else {\n+                int objectsize = sizeof(cls);\n+                for (Field f : getAllNonStaticFields(obj.getClass())) {\n+                    Class<?> fcls = f.getType();\n+                    if (fcls.isPrimitive())\n+                        continue;\n+                    f.setAccessible(true);\n+                    ref = f.get(obj);\n+                    if (ref != null && !isCalculated(calculated, ref) && depth < maxRecusionDepth) {\n+                        calculated.put(ref, ref);\n+                        int referentSize = retainedSize(ref, calculated, depth + 1);\n+                        objectsize += referentSize;\n+                    }\n+                }\n+                return objectsize;\n+            }\n+        } catch (Throwable e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 176}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODIx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950821", "createdAt": "2020-10-26T16:21:44Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NFrOHoXkGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NFrOHoXkGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTE2MA==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091160", "createdAt": "2020-10-26T16:21:44Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);\n+        \n+        \n+    }\n+    \n+    @Test\n+    public void test_sizeof_null_works() {\n+\n+        long cacheSize = cacheSizer.sizeOf(null);\n+        assert(cacheSize==0);\n+\n+        \n+    }\n+    \n+    \n+    @Test\n+    public void test_sizeof_optional_works() {\n+\n+        \n+        \n+        \n+        long cacheSize = cacheSizer.sizeOf(Optional.fromNullable(null));\n+        assert(cacheSize==16);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODI5", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950829", "createdAt": "2020-10-26T16:21:45Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NVrOHoXkIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NVrOHoXkIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTE3MQ==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091171", "createdAt": "2020-10-26T16:21:45Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODQx", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950841", "createdAt": "2020-10-26T16:21:46Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NlrOHoXkKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0NlrOHoXkKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTE3OQ==", "bodyText": "Codacy found an issue: JUnit tests should include assert() or fail()", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091179", "createdAt": "2020-10-26T16:21:46Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODY2", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950866", "createdAt": "2020-10-26T16:21:47Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0N1rOHoXkOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0N1rOHoXkOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTE5Mg==", "bodyText": "Codacy found an issue: A catch statement should never catch throwable since it includes errors.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091192", "createdAt": "2020-10-26T16:21:47Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODgw", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950880", "createdAt": "2020-10-26T16:21:48Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0OFrOHoXkRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0OFrOHoXkRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTIwNQ==", "bodyText": "Codacy found an issue: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091205", "createdAt": "2020-10-26T16:21:48Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/business/cache/provider/CacheSizingUtilTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import org.junit.Test;\n+import com.dotcms.repackage.com.google.common.base.Optional;\n+import com.dotmarketing.portlets.contentlet.business.Contentlet;\n+\n+public class CacheSizingUtilTest {\n+\n+    \n+    final String fourLetters = \"CRAP\";\n+\n+    \n+    CacheSizingUtil cacheSizer = new CacheSizingUtil();\n+    \n+    @Test\n+    public void test_sizeof_works() {\n+       \n+        final Contentlet con = new Contentlet();\n+        \n+        long contentletSize = cacheSizer.sizeOf(con);\n+        assert(contentletSize>0);\n+        \n+        \n+\n+        \n+        long fourLettersSize = cacheSizer.sizeOf(fourLetters);\n+        assert(fourLettersSize==48);\n+        \n+        \n+    }\n+    \n+    @Test\n+    public void test_sizeof_null_works() {\n+\n+        long cacheSize = cacheSizer.sizeOf(null);\n+        assert(cacheSize==0);\n+\n+        \n+    }\n+    \n+    \n+    @Test\n+    public void test_sizeof_optional_works() {\n+\n+        \n+        \n+        \n+        long cacheSize = cacheSizer.sizeOf(Optional.fromNullable(null));\n+        assert(cacheSize==16);\n+        \n+        cacheSize = cacheSizer.sizeOf(Optional.of(fourLetters));\n+        assert(cacheSize==64);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwODg4", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950888", "createdAt": "2020-10-26T16:21:49Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0OVrOHoXkTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo0OVrOHoXkTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTIxMw==", "bodyText": "Codacy found an issue: This statement should have braces", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091213", "createdAt": "2020-10-26T16:21:49Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;\n+    \n+    public String averageSizePretty(final Map<String, Object> cacheMap) {\n+\n+        return UtilMethods.prettyByteify(averageSize(cacheMap));\n+\n+    }\n+\n+    /**\n+     * Takes a map and pulls random values from it to calculate an average object size\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long averageSize(final Map<String, Object> cacheMap) {\n+\n+        if (cacheMap.size() == 0) {\n+            return 0;\n+        }\n+\n+        long totalSize = 0;\n+\n+        final int numberToSample = Math.min(cacheMap.size(), standardSampleSize);\n+\n+\n+        for (int i = 0; i < numberToSample; i++) {\n+            List<String> keysAsArray = new ArrayList<String>(cacheMap.keySet());\n+            Random r = new Random();\n+            Object object = cacheMap.get(keysAsArray.get(r.nextInt(keysAsArray.size())));\n+            if (object instanceof Optional && ((Optional) object).isPresent()) {\n+                object = ((Optional) object).get();\n+            }\n+            if (object instanceof Optional && !((Optional) object).isPresent()) {\n+                return 0;\n+            }\n+            totalSize += sizeOf(object);\n+        }\n+        return totalSize / numberToSample;\n+\n+    }\n+\n+    /**\n+     * Tries to use the Unsafe class to calculate an objects size. If this does not work, it will fall\n+     * back on the serialzied size (which less than accurate).\n+     * \n+     * @param cacheMap\n+     * @return\n+     */\n+    public long sizeOf(Object object) {\n+        long retainedSize = 0;\n+        try {\n+            retainedSize = retainedSize(object);\n+        } catch (Throwable t) {\n+            Logger.infoEvery(this.getClass(),\n+                            \"Unable to use the Unsafe.class to size cache objects, falling back to serialization:\"\n+                                            + t.getMessage(),\n+                            60000);\n+        }\n+\n+        return retainedSize > 0 ? retainedSize : sizeOfSerialized(object);\n+\n+    }\n+\n+\n+    final ByteArrayOutputStream byteOutputStream = new ByteArrayOutputStream();\n+\n+    /**\n+     * Serializes an object to attempt to find an object's size\n+     * \n+     * @param object\n+     * @return\n+     */\n+    long sizeOfSerialized(Object object) {\n+\n+        if (object == null) {\n+            return 0;\n+        }\n+\n+        if (!(object instanceof Serializable)) {\n+            Logger.warn(this.getClass(), object.getClass() + \" not serializable: \" + object);\n+            return -1;\n+        }\n+\n+        if (object instanceof String) {\n+            return ((String) object).length() * 8;\n+\n+        }\n+\n+        byteOutputStream.reset();\n+        try (ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteOutputStream)) {\n+            objectOutputStream.writeObject(object);\n+            objectOutputStream.close();\n+\n+            return byteOutputStream.toByteArray().length;\n+        } catch (Exception e) {\n+            Logger.warnAndDebug(this.getClass(), \"failed writing:\" + object.getClass() + \" : \" + e.getMessage(), e);\n+            return 0;\n+        }\n+\n+    }\n+\n+\n+\n+\n+    public int retainedSize(Object obj) {\n+        return retainedSize(obj, new HashMap<>(), 0);\n+    }\n+\n+\n+\n+\n+    @SuppressWarnings(\"restriction\")\n+    private int retainedSize(Object obj, HashMap<Object, Object> calculated, final int depth) {\n+        Object ref = null;\n+        try {\n+            if (obj == null)\n+                throw new NullPointerException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTUwOTAz", "url": "https://github.com/dotCMS/core/pull/19425#pullrequestreview-516950903", "createdAt": "2020-10-26T16:21:50Z", "commit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo1MFrOHoXkYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoyMTo1MFrOHoXkYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTIzMw==", "bodyText": "Codacy found an issue: This final field could be made static", "url": "https://github.com/dotCMS/core/pull/19425#discussion_r512091233", "createdAt": "2020-10-26T16:21:50Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/CacheSizingUtil.java", "diffHunk": "@@ -0,0 +1,276 @@\n+package com.dotmarketing.business.cache.provider;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectOutputStream;\n+import java.io.Serializable;\n+import java.lang.reflect.Array;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Random;\n+import com.dotmarketing.util.Config;\n+import com.dotmarketing.util.Logger;\n+import com.dotmarketing.util.UtilMethods;\n+import com.github.benmanes.caffeine.base.UnsafeAccess;\n+\n+\n+public class CacheSizingUtil {\n+\n+\n+    final int standardSampleSize = Config.getIntProperty(\"CACHE_SIZER_SAMPLE_SIZE\", 20);\n+    \n+    final int maxRecusionDepth = 10;\n+    \n+    final boolean useCompressedOops = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5eca96565f1e816270dc4d0be802b80429ac3"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1722, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}