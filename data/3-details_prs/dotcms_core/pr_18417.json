{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExOTYyNDc1", "number": 18417, "title": "#18407 this fix allows you to save not only file asset on the edit co\u2026", "bodyText": "this fix allows you to save not only file asset on the edit contentlet but also, dotAsset and any contentlet with binary field", "createdAt": "2020-05-01T03:45:57Z", "url": "https://github.com/dotCMS/core/pull/18417", "merged": true, "mergeCommit": {"oid": "ee2a854626de8d9614c4b4f1f804578a376f75f9"}, "closed": true, "closedAt": "2020-05-01T20:11:56Z", "author": {"login": "jdotcms"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcc5WkUAH2gAyNDExOTYyNDc1OjdhMTdhZmUyNDBiZmVkZDIyM2IyNGUwNDAxMTI4MzdhOWE0YmQyM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdF6iagFqTQwNDMxOTQ4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a17afe240bfedd223b24e040112837a9a4bd23a", "author": {"user": {"login": "jdotcms", "name": "Jonathan"}}, "url": "https://github.com/dotCMS/core/commit/7a17afe240bfedd223b24e040112837a9a4bd23a", "committedDate": "2020-05-01T03:45:12Z", "message": "#18407 this fix allows you to save not only file asset on the edit contentlet but also, dotAsset and any contentlet with binary field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d", "author": {"user": {"login": "jdotcms", "name": "Jonathan"}}, "url": "https://github.com/dotCMS/core/commit/e84cfc02794e577d5fe82766389e0cd66863859d", "committedDate": "2020-05-01T03:47:06Z", "message": "#18407 organize import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MTkzOTI3", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404193927", "createdAt": "2020-05-01T14:37:34Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNDozNzozNFrOGPLc9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNDozNzozNFrOGPLc9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2OTQ2MQ==", "bodyText": "should this logic get into a API?", "url": "https://github.com/dotCMS/core/pull/18417#discussion_r418569461", "createdAt": "2020-05-01T14:37:34Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/ajax/FileAssetAjax.java", "diffHunk": "@@ -56,41 +58,50 @@ public FileAssetAjax() {\n \t}\r\n \r\n \r\n-\tpublic void saveFileText(String contentletInode, String newText, String binField) throws PortalException, SystemException,\r\n-\tDotDataException, DotSecurityException, IOException {\r\n-\t\tWebContext ctx = WebContextFactory.get();\r\n-\t\tHttpServletRequest req = ctx.getHttpServletRequest();\r\n-\t\tUser user = userAPI.getLoggedInUser(req);\r\n-\t\tboolean respectFrontendRoles = userAPI.isLoggedToFrontend(req);\r\n-\t\tContentlet cont  = APILocator.getContentletAPI().find(contentletInode, user, respectFrontendRoles);\r\n-\t\tFileAsset fa = APILocator.getFileAssetAPI().fromContentlet(cont);\r\n+\tpublic void saveFileText(final String contentletInode, final String newText, final String binField)\r\n+\t\t\tthrows PortalException, SystemException, DotDataException, DotSecurityException, IOException {\r\n+\r\n+\t\tfinal WebContext webContext        = WebContextFactory.get();\r\n+\t\tfinal HttpServletRequest request   = webContext.getHttpServletRequest();\r\n+\t\tfinal User user \t\t\t       = userAPI.getLoggedInUser(request);\r\n+\t\tfinal boolean respectFrontendRoles = userAPI.isLoggedToFrontend(request);\r\n+\t\tfinal Contentlet contentlet        = APILocator.getContentletAPI().find(contentletInode, user, respectFrontendRoles);\r\n+\t\tString incomingFileName            = null;\r\n+\t\tString binaryFieldName             = binField;\r\n+\r\n+\t\tif (contentlet.isFileAsset()) {\r\n+\r\n+\t\t\tfinal FileAsset fileAsset = APILocator.getFileAssetAPI().fromContentlet(contentlet);\r\n+\t\t\tincomingFileName = fileAsset.getFileAsset().getName();\r\n+\t\t\tbinaryFieldName  = FileAssetAPI.BINARY_FIELD;\r\n+\t\t} else if (contentlet.isDotAsset()) {\r\n+\r\n+\t\t\tincomingFileName = contentlet.getBinary(DotAssetContentType.ASSET_FIELD_VAR).getName();\r\n+\t\t\tbinaryFieldName  = DotAssetContentType.ASSET_FIELD_VAR;\r\n+\t\t} else {\r\n+\r\n+\t\t\tincomingFileName = contentlet.getBinary(binField).getName();\r\n+\t\t}\r\n \r\n-\t\tjava.io.File tempDir =  new java.io.File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() + java.io.File.separator + contentletInode.charAt(0)\r\n-\t\t\t\t\t+ java.io.File.separator + contentletInode.charAt(1) + java.io.File.separator + contentletInode\r\n-\t\t\t\t\t+ java.io.File.separator + APILocator.getFileAssetAPI().BINARY_FIELD);\r\n+\t\tfinal File tempDir =  new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() + File.separator + contentletInode.charAt(0)\r\n+\t\t\t\t+ File.separator + contentletInode.charAt(1) + File.separator + contentletInode\r\n+\t\t\t\t+ File.separator + binaryFieldName);\r\n \r\n-\t\tif(!tempDir.exists())\r\n+\t\tif(!tempDir.exists()) {\r\n \t\t\ttempDir.mkdirs();\r\n+\t\t}\r\n \r\n-\t\tjava.io.File fileData = new java.io.File(tempDir.getAbsoluteFile() + java.io.File.separator + WebKeys.TEMP_FILE_PREFIX + fa.getFileAsset().getName());\r\n+\t\tfinal File fileData = new File(tempDir.getAbsoluteFile() + File.separator + WebKeys.TEMP_FILE_PREFIX + incomingFileName);\r\n \r\n \t\tfileData.deleteOnExit();\r\n-\t\tOutputStream os = null;\r\n-\t\ttry {\r\n-\t\t\tos = Files.newOutputStream(fileData.toPath());\r\n+\r\n+\t\ttry (OutputStream os = Files.newOutputStream(fileData.toPath())) {\r\n+\r\n \t\t\tos.write(newText.getBytes());\r\n \t\t} catch(Exception e) {\r\n-\t\t\tLogger.error(getClass(), \"Error writing to file\", e);\r\n-\t\t}finally {\r\n-\t\t\tif (os != null){\r\n-\t\t\t\tos.close();\r\n-\t\t\t}\r\n \r\n+\t\t\tLogger.error(getClass(), \"Error writing to file\", e);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjA5MTcx", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404209171", "createdAt": "2020-05-01T15:04:09Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDowOVrOGPMLGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDowOVrOGPMLGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTI3Mg==", "bodyText": "I think we should support all binary fields - even if you just have a generic content that has a binary field with text", "url": "https://github.com/dotCMS/core/pull/18417#discussion_r418581272", "createdAt": "2020-05-01T15:04:09Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/ajax/FileAssetAjax.java", "diffHunk": "@@ -56,41 +58,50 @@ public FileAssetAjax() {\n \t}\r\n \r\n \r\n-\tpublic void saveFileText(String contentletInode, String newText, String binField) throws PortalException, SystemException,\r\n-\tDotDataException, DotSecurityException, IOException {\r\n-\t\tWebContext ctx = WebContextFactory.get();\r\n-\t\tHttpServletRequest req = ctx.getHttpServletRequest();\r\n-\t\tUser user = userAPI.getLoggedInUser(req);\r\n-\t\tboolean respectFrontendRoles = userAPI.isLoggedToFrontend(req);\r\n-\t\tContentlet cont  = APILocator.getContentletAPI().find(contentletInode, user, respectFrontendRoles);\r\n-\t\tFileAsset fa = APILocator.getFileAssetAPI().fromContentlet(cont);\r\n+\tpublic void saveFileText(final String contentletInode, final String newText, final String binField)\r\n+\t\t\tthrows PortalException, SystemException, DotDataException, DotSecurityException, IOException {\r\n+\r\n+\t\tfinal WebContext webContext        = WebContextFactory.get();\r\n+\t\tfinal HttpServletRequest request   = webContext.getHttpServletRequest();\r\n+\t\tfinal User user \t\t\t       = userAPI.getLoggedInUser(request);\r\n+\t\tfinal boolean respectFrontendRoles = userAPI.isLoggedToFrontend(request);\r\n+\t\tfinal Contentlet contentlet        = APILocator.getContentletAPI().find(contentletInode, user, respectFrontendRoles);\r\n+\t\tString incomingFileName            = null;\r\n+\t\tString binaryFieldName             = binField;\r\n+\r\n+\t\tif (contentlet.isFileAsset()) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjM2MjY5", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404236269", "createdAt": "2020-05-01T15:52:03Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjU0Mjkz", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404254293", "createdAt": "2020-05-01T16:24:07Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjU0MzQx", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404254341", "createdAt": "2020-05-01T16:24:13Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzE5NDgy", "url": "https://github.com/dotCMS/core/pull/18417#pullrequestreview-404319482", "createdAt": "2020-05-01T18:23:21Z", "commit": {"oid": "e84cfc02794e577d5fe82766389e0cd66863859d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1054, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}