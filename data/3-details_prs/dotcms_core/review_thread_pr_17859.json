{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MjQzNjY1", "number": 17859, "reviewThreads": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo0NzozN1rODY5EkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OToxMVrODZnngQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDI3NDcyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityAdminMode.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo0NzozN1rOFfAhHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowMjozN1rOFfFLlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1ODY1Mw==", "bodyText": "Shouldn't we keep the former constructor for backward compatibility and deprecate it if necessary?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368058653", "createdAt": "2020-01-17T17:47:37Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityAdminMode.java", "diffHunk": "@@ -13,9 +14,9 @@\n  */\n public class VelocityAdminMode extends VelocityLiveMode {\n \n-    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final String uri,\n+    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final IHTMLPage htmlPage,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTc2OA==", "bodyText": "agree", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368071768", "createdAt": "2020-01-17T18:20:46Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityAdminMode.java", "diffHunk": "@@ -13,9 +14,9 @@\n  */\n public class VelocityAdminMode extends VelocityLiveMode {\n \n-    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final String uri,\n+    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final IHTMLPage htmlPage,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1ODY1Mw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3Njk1Nw==", "bodyText": "100% agreed. Specially true if a Hotfix Plugin needs to be created for Support.", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368076957", "createdAt": "2020-01-17T18:33:31Z", "author": {"login": "jcastro-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityAdminMode.java", "diffHunk": "@@ -13,9 +14,9 @@\n  */\n public class VelocityAdminMode extends VelocityLiveMode {\n \n-    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final String uri,\n+    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final IHTMLPage htmlPage,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1ODY1Mw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTA2MA==", "bodyText": "done ec40455", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135060", "createdAt": "2020-01-17T21:02:37Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityAdminMode.java", "diffHunk": "@@ -13,9 +14,9 @@\n  */\n public class VelocityAdminMode extends VelocityLiveMode {\n \n-    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final String uri,\n+    public VelocityAdminMode(final HttpServletRequest request, final HttpServletResponse response, final IHTMLPage htmlPage,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1ODY1Mw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDI3ODAxOnYy", "diffSide": "LEFT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityEditMode.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo0ODo1OFrOFfAjKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowMjo0NFrOFfFLvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTE3Nw==", "bodyText": "same here", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368059177", "createdAt": "2020-01-17T17:48:58Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityEditMode.java", "diffHunk": "@@ -23,46 +23,28 @@\n \n public class VelocityEditMode extends VelocityModeHandler {\n \n-    protected final HttpServletRequest request;\n-    protected final HttpServletResponse response;\n-    private static final PageMode mode = PageMode.EDIT_MODE;\n-    protected final String uri;\n-    private final Host host;\n     private final User user;\n     private final static String REORDER_MENU_URL=\"/c/portal/layout?p_l_id={0}&p_p_id=site-browser&p_p_action=1&p_p_state=maximized&_site_browser_struts_action=%2Fext%2Ffolders%2Forder_menu\";\n-    \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response, String uri, Host host) {\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTkwNA==", "bodyText": "agree again", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368071904", "createdAt": "2020-01-17T18:21:06Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityEditMode.java", "diffHunk": "@@ -23,46 +23,28 @@\n \n public class VelocityEditMode extends VelocityModeHandler {\n \n-    protected final HttpServletRequest request;\n-    protected final HttpServletResponse response;\n-    private static final PageMode mode = PageMode.EDIT_MODE;\n-    protected final String uri;\n-    private final Host host;\n     private final User user;\n     private final static String REORDER_MENU_URL=\"/c/portal/layout?p_l_id={0}&p_p_id=site-browser&p_p_action=1&p_p_state=maximized&_site_browser_struts_action=%2Fext%2Ffolders%2Forder_menu\";\n-    \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response, String uri, Host host) {\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTE3Nw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTEwMw==", "bodyText": "done ec40455#diff-faba8e2cc585b6538a2c9ac382e5dfa6R30", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135103", "createdAt": "2020-01-17T21:02:44Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityEditMode.java", "diffHunk": "@@ -23,46 +23,28 @@\n \n public class VelocityEditMode extends VelocityModeHandler {\n \n-    protected final HttpServletRequest request;\n-    protected final HttpServletResponse response;\n-    private static final PageMode mode = PageMode.EDIT_MODE;\n-    protected final String uri;\n-    private final Host host;\n     private final User user;\n     private final static String REORDER_MENU_URL=\"/c/portal/layout?p_l_id={0}&p_p_id=site-browser&p_p_action=1&p_p_state=maximized&_site_browser_struts_action=%2Fext%2Ffolders%2Forder_menu\";\n-    \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response, String uri, Host host) {\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityEditMode(HttpServletRequest request, HttpServletResponse response) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTE3Nw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDI3ODkxOnYy", "diffSide": "LEFT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo0OToyNFrOFfAjvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowMzozM1rOFfFNCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTMyNg==", "bodyText": "same here", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368059326", "createdAt": "2020-01-17T17:49:24Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -35,29 +35,16 @@\n import java.util.Optional;\n \n public class VelocityLiveMode extends VelocityModeHandler {\n-\n-\n-\n-    private final HttpServletRequest request;\n-    private final HttpServletResponse response;\n-    private static final PageMode mode = PageMode.LIVE;\n-    private final String uri;\n-    private final Host host;\n-\n-\n-\n-    public VelocityLiveMode(HttpServletRequest request, HttpServletResponse response, String uri, Host host) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTQzNA==", "bodyText": "done ec40455#diff-b418f48462e78c28b7053d80f7bc6ed5R40", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135434", "createdAt": "2020-01-17T21:03:33Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -35,29 +35,16 @@\n import java.util.Optional;\n \n public class VelocityLiveMode extends VelocityModeHandler {\n-\n-\n-\n-    private final HttpServletRequest request;\n-    private final HttpServletResponse response;\n-    private static final PageMode mode = PageMode.LIVE;\n-    private final String uri;\n-    private final Host host;\n-\n-\n-\n-    public VelocityLiveMode(HttpServletRequest request, HttpServletResponse response, String uri, Host host) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTMyNg=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMwODQzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityModeHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowMToxMVrOFfA13g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowMToxMVrOFfA13g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2Mzk2Ng==", "bodyText": "is it worth to add a Log.debug here? warning?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368063966", "createdAt": "2020-01-17T18:01:11Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityModeHandler.java", "diffHunk": "@@ -67,13 +88,35 @@ public final String eval() {\n             throw new DotRuntimeException(e);\n         }\n     }\n-    \n-    public static final VelocityModeHandler modeHandler(PageMode mode, HttpServletRequest request, HttpServletResponse response, String uri, Host host) {\n-        return pageModeVelocityMap.get(mode).apply(request, response, uri, host);\n+\n+    public static final VelocityModeHandler modeHandler(final PageMode mode, final HttpServletRequest request, final HttpServletResponse response, final String uri, final Host host) {\n+        // Find the current language\n+        final long langId = WebAPILocator.getLanguageWebAPI().getLanguage(request).getId();\n+\n+        try {\n+            // now we check identifier cache first (which DOES NOT have a 404 cache )\n+            final Identifier id = APILocator.getIdentifierAPI().find(host, uri);\n+\n+            final IHTMLPage htmlPage = APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, langId, mode.showLive,\n+                    APILocator.systemUser(), mode.respectAnonPerms);\n+\n+            return pageModeVelocityMap.get(mode).apply(request, response, htmlPage, host);\n+        } catch (DotDataException | DotSecurityException e) {\n+            throw new DotRuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMxMDQwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityNavigateEditMode.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowMTo1MlrOFfA3AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowMzo1MlrOFfFNcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NDI1Nw==", "bodyText": "The constructor signature changed here too", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368064257", "createdAt": "2020-01-17T18:01:52Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityNavigateEditMode.java", "diffHunk": "@@ -42,20 +40,17 @@\n                 \"window.top.document.dispatchEvent(customEvent);\" +\n             \"</script>\";\n \n-    public VelocityNavigateEditMode(final HttpServletRequest request,\n-                                    final HttpServletResponse response,\n-                                    final String uri,\n-                                    final Host host) {\n-        super();\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityNavigateEditMode(HttpServletRequest request, HttpServletResponse response) {\n-        this(request, response, request.getRequestURI(), hostWebAPI.getCurrentHostNoThrow(request));\n+    public VelocityNavigateEditMode(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NDQyMw==", "bodyText": "yeah you have to try to keep the backwards compatibility, since dotcms is a framework", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368074423", "createdAt": "2020-01-17T18:27:25Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityNavigateEditMode.java", "diffHunk": "@@ -42,20 +40,17 @@\n                 \"window.top.document.dispatchEvent(customEvent);\" +\n             \"</script>\";\n \n-    public VelocityNavigateEditMode(final HttpServletRequest request,\n-                                    final HttpServletResponse response,\n-                                    final String uri,\n-                                    final Host host) {\n-        super();\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityNavigateEditMode(HttpServletRequest request, HttpServletResponse response) {\n-        this(request, response, request.getRequestURI(), hostWebAPI.getCurrentHostNoThrow(request));\n+    public VelocityNavigateEditMode(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NDI1Nw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTUzOA==", "bodyText": "done ec40455#diff-8aaa91d048a2b9c6c8fac2ca7dc1c044R60", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135538", "createdAt": "2020-01-17T21:03:52Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityNavigateEditMode.java", "diffHunk": "@@ -42,20 +40,17 @@\n                 \"window.top.document.dispatchEvent(customEvent);\" +\n             \"</script>\";\n \n-    public VelocityNavigateEditMode(final HttpServletRequest request,\n-                                    final HttpServletResponse response,\n-                                    final String uri,\n-                                    final Host host) {\n-        super();\n-        this.request = request;\n-        this.response = response;\n-        this.uri = uri;\n-        this.host = host;\n-        this.user = WebAPILocator.getUserWebAPI().getUser(request);\n-    }\n \n-    public VelocityNavigateEditMode(HttpServletRequest request, HttpServletResponse response) {\n-        this(request, response, request.getRequestURI(), hostWebAPI.getCurrentHostNoThrow(request));\n+    public VelocityNavigateEditMode(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NDI1Nw=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMxNDM4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/filters/CMSUrlUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowMzoyNFrOFfA5dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowNDoxNlrOFfFN6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NDg4Ng==", "bodyText": "is it worth to add a Log.debug ? or warning?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368064886", "createdAt": "2020-01-17T18:03:24Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/filters/CMSUrlUtil.java", "diffHunk": "@@ -530,4 +532,14 @@ public String getQueryStringFromUri(final String uri) {\n \t\t\t\turi.substring(indexOf+1):\n \t\t\t\tnull;\n \t}\n+\n+\tpublic static String getCurrentURI(final HttpServletRequest request)  {\n+\t\ttry {\n+\t\t\treturn URLDecoder.decode((request.getAttribute(Constants.CMS_FILTER_URI_OVERRIDE) != null)\n+\t\t\t\t\t? (String) request.getAttribute(Constants.CMS_FILTER_URI_OVERRIDE)\n+\t\t\t\t\t: request.getRequestURI(), \"UTF-8\");\n+\t\t} catch (UnsupportedEncodingException e) {\n+\t\t\tthrow new DotRuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTY1OA==", "bodyText": "done c99f44a#diff-b01fee3e8841e6997654dbe68e5baf2dR542", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135658", "createdAt": "2020-01-17T21:04:16Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/filters/CMSUrlUtil.java", "diffHunk": "@@ -530,4 +532,14 @@ public String getQueryStringFromUri(final String uri) {\n \t\t\t\turi.substring(indexOf+1):\n \t\t\t\tnull;\n \t}\n+\n+\tpublic static String getCurrentURI(final HttpServletRequest request)  {\n+\t\ttry {\n+\t\t\treturn URLDecoder.decode((request.getAttribute(Constants.CMS_FILTER_URI_OVERRIDE) != null)\n+\t\t\t\t\t? (String) request.getAttribute(Constants.CMS_FILTER_URI_OVERRIDE)\n+\t\t\t\t\t: request.getRequestURI(), \"UTF-8\");\n+\t\t} catch (UnsupportedEncodingException e) {\n+\t\t\tthrow new DotRuntimeException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NDg4Ng=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMxNTY4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowMzo1NFrOFfA6Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMTowNDozNFrOFfFOVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTA5NA==", "bodyText": "Log.debug or warning?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368065094", "createdAt": "2020-01-17T18:03:54Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -232,35 +245,43 @@ public String getPageHtml(\n                 throws DotSecurityException, DotDataException {\n \n         final Host host = this.hostWebAPI.getCurrentHost(request, context.getUser());\n-        final IHTMLPage page = getHtmlPageAsset(context, host, request).getHTMLPage();\n+        final HTMLPageUrl htmlPageUrl = getHtmlPageAsset(context, host, request);\n+        final IHTMLPage page = htmlPageUrl.getHTMLPage();\n \n         return new HTMLPageAssetRenderedBuilder()\n                 .setHtmlPageAsset(page)\n                 .setUser(context.getUser())\n                 .setRequest(request)\n                 .setResponse(response)\n                 .setSite(host)\n-                .getPageHTML();\n+                .setURLMapper(htmlPageUrl.pageUrlMapper)\n+                .setLive(htmlPageUrl.hasLive())\n+                .getPageHTML(context.getPageMode());\n     }\n \n-    private HTMLPageUrl getHtmlPageAsset(\n-            final PageContext context,\n-            final Host host,\n-            final HttpServletRequest request)\n-                throws DotDataException, DotSecurityException {\n+    private HTMLPageUrl getHtmlPageAsset(final PageContext context, final Host host, final HttpServletRequest request)\n+            throws DotDataException, DotSecurityException {\n \n         HTMLPageUrl htmlPageUrl = null;\n-        IHTMLPage htmlPageAsset = findPageByContext(host, context);\n+        for (final SearchPageFunction pageSearcher : pageSearchers) {\n+            final Optional<HTMLPageUrl> optional = pageSearcher.search(context, host, request);\n \n-        if (htmlPageAsset == null){\n-            htmlPageUrl   = findByURLMap(context, host, request);\n-            htmlPageAsset = getPageByUri(context.getPageMode(), host, htmlPageUrl.getPageUrl());\n-        } else {\n-            htmlPageUrl   = new HTMLPageUrl(htmlPageAsset);\n+            if (optional.isPresent()) {\n+                htmlPageUrl = optional.get();\n+                break;\n+            }\n+        }\n+\n+        if(htmlPageUrl == null ){\n+            throw new HTMLPageAssetNotFoundException(context.getPageUri());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDY1Nw==", "bodyText": "+1", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368080657", "createdAt": "2020-01-17T18:42:48Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -232,35 +245,43 @@ public String getPageHtml(\n                 throws DotSecurityException, DotDataException {\n \n         final Host host = this.hostWebAPI.getCurrentHost(request, context.getUser());\n-        final IHTMLPage page = getHtmlPageAsset(context, host, request).getHTMLPage();\n+        final HTMLPageUrl htmlPageUrl = getHtmlPageAsset(context, host, request);\n+        final IHTMLPage page = htmlPageUrl.getHTMLPage();\n \n         return new HTMLPageAssetRenderedBuilder()\n                 .setHtmlPageAsset(page)\n                 .setUser(context.getUser())\n                 .setRequest(request)\n                 .setResponse(response)\n                 .setSite(host)\n-                .getPageHTML();\n+                .setURLMapper(htmlPageUrl.pageUrlMapper)\n+                .setLive(htmlPageUrl.hasLive())\n+                .getPageHTML(context.getPageMode());\n     }\n \n-    private HTMLPageUrl getHtmlPageAsset(\n-            final PageContext context,\n-            final Host host,\n-            final HttpServletRequest request)\n-                throws DotDataException, DotSecurityException {\n+    private HTMLPageUrl getHtmlPageAsset(final PageContext context, final Host host, final HttpServletRequest request)\n+            throws DotDataException, DotSecurityException {\n \n         HTMLPageUrl htmlPageUrl = null;\n-        IHTMLPage htmlPageAsset = findPageByContext(host, context);\n+        for (final SearchPageFunction pageSearcher : pageSearchers) {\n+            final Optional<HTMLPageUrl> optional = pageSearcher.search(context, host, request);\n \n-        if (htmlPageAsset == null){\n-            htmlPageUrl   = findByURLMap(context, host, request);\n-            htmlPageAsset = getPageByUri(context.getPageMode(), host, htmlPageUrl.getPageUrl());\n-        } else {\n-            htmlPageUrl   = new HTMLPageUrl(htmlPageAsset);\n+            if (optional.isPresent()) {\n+                htmlPageUrl = optional.get();\n+                break;\n+            }\n+        }\n+\n+        if(htmlPageUrl == null ){\n+            throw new HTMLPageAssetNotFoundException(context.getPageUri());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTA5NA=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzNTc2NQ==", "bodyText": "really here the exception is thrown", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368135765", "createdAt": "2020-01-17T21:04:34Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -232,35 +245,43 @@ public String getPageHtml(\n                 throws DotSecurityException, DotDataException {\n \n         final Host host = this.hostWebAPI.getCurrentHost(request, context.getUser());\n-        final IHTMLPage page = getHtmlPageAsset(context, host, request).getHTMLPage();\n+        final HTMLPageUrl htmlPageUrl = getHtmlPageAsset(context, host, request);\n+        final IHTMLPage page = htmlPageUrl.getHTMLPage();\n \n         return new HTMLPageAssetRenderedBuilder()\n                 .setHtmlPageAsset(page)\n                 .setUser(context.getUser())\n                 .setRequest(request)\n                 .setResponse(response)\n                 .setSite(host)\n-                .getPageHTML();\n+                .setURLMapper(htmlPageUrl.pageUrlMapper)\n+                .setLive(htmlPageUrl.hasLive())\n+                .getPageHTML(context.getPageMode());\n     }\n \n-    private HTMLPageUrl getHtmlPageAsset(\n-            final PageContext context,\n-            final Host host,\n-            final HttpServletRequest request)\n-                throws DotDataException, DotSecurityException {\n+    private HTMLPageUrl getHtmlPageAsset(final PageContext context, final Host host, final HttpServletRequest request)\n+            throws DotDataException, DotSecurityException {\n \n         HTMLPageUrl htmlPageUrl = null;\n-        IHTMLPage htmlPageAsset = findPageByContext(host, context);\n+        for (final SearchPageFunction pageSearcher : pageSearchers) {\n+            final Optional<HTMLPageUrl> optional = pageSearcher.search(context, host, request);\n \n-        if (htmlPageAsset == null){\n-            htmlPageUrl   = findByURLMap(context, host, request);\n-            htmlPageAsset = getPageByUri(context.getPageMode(), host, htmlPageUrl.getPageUrl());\n-        } else {\n-            htmlPageUrl   = new HTMLPageUrl(htmlPageAsset);\n+            if (optional.isPresent()) {\n+                htmlPageUrl = optional.get();\n+                break;\n+            }\n+        }\n+\n+        if(htmlPageUrl == null ){\n+            throw new HTMLPageAssetNotFoundException(context.getPageUri());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTA5NA=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMxODMxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowNToxMFrOFfA8Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToxNToyMlrOFfFcXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTU1MQ==", "bodyText": "The constructor signature was modified here too", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368065551", "createdAt": "2020-01-17T18:05:10Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +367,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final Host host, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = this.getCurrentLanguage(request);\n+\n+        return APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n     public class HTMLPageUrl {\n-        private String pageUrl;\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        public HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MjgxMA==", "bodyText": "agree", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368082810", "createdAt": "2020-01-17T18:48:18Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +367,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final Host host, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = this.getCurrentLanguage(request);\n+\n+        return APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n     public class HTMLPageUrl {\n-        private String pageUrl;\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        public HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTU1MQ=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzOTM1Ng==", "bodyText": "this a internal class, however I am going to change the method scope to private", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368139356", "createdAt": "2020-01-17T21:15:22Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +367,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final Host host, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = this.getCurrentLanguage(request);\n+\n+        return APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n     public class HTMLPageUrl {\n-        private String pageUrl;\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        public HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NTU1MQ=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 210}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMyMzg1OnYy", "diffSide": "LEFT", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/filters/URLMapFilter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODowNzoyN1rOFfA_eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozOTo0MFrOFfHCcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NjQyNA==", "bodyText": "As these changes are made for a minor release, shouldn't this class be deprecated instead of deleted ?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368066424", "createdAt": "2020-01-17T18:07:27Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/filters/URLMapFilter.java", "diffHunk": "@@ -1,156 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzkwNA==", "bodyText": "I agree, is @wezell aware about this change?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368077904", "createdAt": "2020-01-17T18:35:54Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/filters/URLMapFilter.java", "diffHunk": "@@ -1,156 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NjQyNA=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzOTYyMA==", "bodyText": "this is a filter so I don't know if this is needly", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368139620", "createdAt": "2020-01-17T21:16:13Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/filters/URLMapFilter.java", "diffHunk": "@@ -1,156 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NjQyNA=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NTQ4OQ==", "bodyText": "@nollymar we are moving away from the idea of major and minor releases - I think it is ok to delete.", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368165489", "createdAt": "2020-01-17T22:39:40Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/filters/URLMapFilter.java", "diffHunk": "@@ -1,156 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NjQyNA=="}, "originalCommit": {"oid": "b94e4277fac4d115ca9b3bad653f778f2af92507"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDM4OTg0OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityServlet.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozMzo0MlrOFfBo2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToxNzozOFrOFfFfHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzAxNw==", "bodyText": "this is not bad, but if you have the request you can use more straight-forward solution", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368077017", "createdAt": "2020-01-17T18:33:42Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityServlet.java", "diffHunk": "@@ -62,10 +64,19 @@ protected final void service(HttpServletRequest req, HttpServletResponse respons\n                 return;\n             }\n \n-            request.setRequestUri(uri);\n             final PageMode mode = PageMode.getWithNavigateMode(request);\n             try {\n-                VelocityModeHandler.modeHandler(mode, request, response).serve();\n+                final String pageHtml = APILocator.getHTMLPageAssetRenderedAPI().getPageHtml(\n+                        PageContextBuilder.builder()\n+                                .setPageUri(uri)\n+                                .setPageMode(mode)\n+                                .setUser(APILocator.getLoginServiceAPI().getLoggedInUser())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MDA2Mg==", "bodyText": "done 2e79300", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368140062", "createdAt": "2020-01-17T21:17:38Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityServlet.java", "diffHunk": "@@ -62,10 +64,19 @@ protected final void service(HttpServletRequest req, HttpServletResponse respons\n                 return;\n             }\n \n-            request.setRequestUri(uri);\n             final PageMode mode = PageMode.getWithNavigateMode(request);\n             try {\n-                VelocityModeHandler.modeHandler(mode, request, response).serve();\n+                final String pageHtml = APILocator.getHTMLPageAssetRenderedAPI().getPageHtml(\n+                        PageContextBuilder.builder()\n+                                .setPageUri(uri)\n+                                .setPageMode(mode)\n+                                .setUser(APILocator.getLoginServiceAPI().getLoggedInUser())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzAxNw=="}, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDQwMjAzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozODoxOVrOFfBwPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToxODowNVrOFfFfzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3ODkxMQ==", "bodyText": "Add doc", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368078911", "createdAt": "2020-01-17T18:38:19Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -48,6 +50,18 @@\n     private final URLMapAPIImpl urlMapAPIImpl;\n     private final LanguageWebAPI languageWebAPI;\n \n+    @FunctionalInterface", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MDIzOA==", "bodyText": "done 2e79300", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368140238", "createdAt": "2020-01-17T21:18:05Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -48,6 +50,18 @@\n     private final URLMapAPIImpl urlMapAPIImpl;\n     private final LanguageWebAPI languageWebAPI;\n \n+    @FunctionalInterface", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3ODkxMQ=="}, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDQwOTU1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODo0MTozM1rOFfB1Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToxODozOVrOFfFgmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDEzNA==", "bodyText": "if you are not planning to expose this, you can set to private and static to get init just once", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368080134", "createdAt": "2020-01-17T18:41:33Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -48,6 +50,18 @@\n     private final URLMapAPIImpl urlMapAPIImpl;\n     private final LanguageWebAPI languageWebAPI;\n \n+    @FunctionalInterface\n+    private interface SearchPageFunction {\n+        Optional<HTMLPageUrl> search(final PageContext context,\n+                             final Host host,\n+                             final HttpServletRequest request) throws DotDataException, DotSecurityException;\n+    }\n+\n+    final List<SearchPageFunction> pageSearchers = list(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEzMDE1Mg==", "bodyText": "I have to do several change to change it to static, I'll send it in another PR", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368130152", "createdAt": "2020-01-17T20:48:41Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -48,6 +50,18 @@\n     private final URLMapAPIImpl urlMapAPIImpl;\n     private final LanguageWebAPI languageWebAPI;\n \n+    @FunctionalInterface\n+    private interface SearchPageFunction {\n+        Optional<HTMLPageUrl> search(final PageContext context,\n+                             final Host host,\n+                             final HttpServletRequest request) throws DotDataException, DotSecurityException;\n+    }\n+\n+    final List<SearchPageFunction> pageSearchers = list(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDEzNA=="}, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MDQ0Mg==", "bodyText": "just private for now\nd8d0ac8#diff-051d49b06feb0c7462b349b6b61988a8R58", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368140442", "createdAt": "2020-01-17T21:18:39Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -48,6 +50,18 @@\n     private final URLMapAPIImpl urlMapAPIImpl;\n     private final LanguageWebAPI languageWebAPI;\n \n+    @FunctionalInterface\n+    private interface SearchPageFunction {\n+        Optional<HTMLPageUrl> search(final PageContext context,\n+                             final Host host,\n+                             final HttpServletRequest request) throws DotDataException, DotSecurityException;\n+    }\n+\n+    final List<SearchPageFunction> pageSearchers = list(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MDEzNA=="}, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDQyMzg3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODo0NzozN1rOFfB-VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMToxODo1OFrOFfFhAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MjUxNw==", "bodyText": "what happen if the request is null?", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368082517", "createdAt": "2020-01-17T18:47:37Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +367,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final Host host, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0MDU0Nw==", "bodyText": "done: d8d0ac8#diff-051d49b06feb0c7462b349b6b61988a8R378", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368140547", "createdAt": "2020-01-17T21:18:58Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +367,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final Host host, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MjUxNw=="}, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 191}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDQyOTkyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/HTMLPageAssetRenderedBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODo1MDowN1rOFfCCYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODo1MDowN1rOFfCCYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4MzU1Mw==", "bodyText": "In general this Builder IMO looks such as API or Service, it very smart to be just a builder to create a bean. It is always confusing", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r368083553", "createdAt": "2020-01-17T18:50:07Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/page/HTMLPageAssetRenderedBuilder.java", "diffHunk": "@@ -186,16 +186,21 @@ public PageView build(final boolean rendered, final PageMode mode) throws DotDat\n         return Optional.ofNullable(contentlet);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a32aa20439c5d3d69ed96b02e7da57654c6e0094"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDg3MDQzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1NTowNVrOFf86gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo0MDoxNlrOFgIF-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0ODE5Mw==", "bodyText": "I would always use boolean here", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369048193", "createdAt": "2020-01-21T14:55:05Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -98,15 +96,9 @@ public final void serve(final OutputStream out) throws DotDataException, IOExcep\n \n \n             User user = getUser();\n-\n+            final String uri = CMSUrlUtil.getCurrentURI(request);\n             Logger.debug(this.getClass(), \"Page Permissions for URI=\" + uri);\n \n-\n-\n-            IHTMLPage htmlPage = APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, langId, mode.showLive,\n-                    APILocator.systemUser(), mode.respectAnonPerms);\n-\n-\n             // Verify and handle the case for unauthorized access of this contentlet\n             Boolean unauthorized = CMSUrlUtil.getInstance().isUnauthorizedAndHandleError(htmlPage, uri, user, request, response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMTM1NA==", "bodyText": "done 0f3d1a9#diff-b418f48462e78c28b7053d80f7bc6ed5R103", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369231354", "createdAt": "2020-01-21T20:40:16Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -98,15 +96,9 @@ public final void serve(final OutputStream out) throws DotDataException, IOExcep\n \n \n             User user = getUser();\n-\n+            final String uri = CMSUrlUtil.getCurrentURI(request);\n             Logger.debug(this.getClass(), \"Page Permissions for URI=\" + uri);\n \n-\n-\n-            IHTMLPage htmlPage = APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, langId, mode.showLive,\n-                    APILocator.systemUser(), mode.respectAnonPerms);\n-\n-\n             // Verify and handle the case for unauthorized access of this contentlet\n             Boolean unauthorized = CMSUrlUtil.getInstance().isUnauthorizedAndHandleError(htmlPage, uri, user, request, response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0ODE5Mw=="}, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDkwMDA0OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMjozNFrOFf9M_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo0MDozN1rOFgIGdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjkyNA==", "bodyText": "use boolean  primitive", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369052924", "createdAt": "2020-01-21T15:02:34Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +373,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = request != null ? this.getCurrentLanguage(request) : this.languageAPI.getDefaultLanguage();\n+\n+        return this.htmlPageAssetAPI.findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n-    public class HTMLPageUrl {\n-        private String pageUrl;\n+    public static class HTMLPageUrl {\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        private HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 216}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA2NjMyMw==", "bodyText": "here compare with null value\n\n  \n    \n      core/dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java\n    \n    \n         Line 407\n      in\n      2ae94ad\n    \n    \n    \n    \n\n        \n          \n           return hasLive == null ? this.htmlPage.hasLiveVersion() : this.hasLive;", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369066323", "createdAt": "2020-01-21T15:24:40Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +373,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = request != null ? this.getCurrentLanguage(request) : this.languageAPI.getDefaultLanguage();\n+\n+        return this.htmlPageAssetAPI.findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n-    public class HTMLPageUrl {\n-        private String pageUrl;\n+    public static class HTMLPageUrl {\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        private HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjkyNA=="}, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 216}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMTQ3OA==", "bodyText": "done 0f3d1a9#diff-051d49b06feb0c7462b349b6b61988a8R372", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369231478", "createdAt": "2020-01-21T20:40:37Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,25 +373,33 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final String id)\n+            throws DotDataException, DotSecurityException {\n+\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        final Language language = request != null ? this.getCurrentLanguage(request) : this.languageAPI.getDefaultLanguage();\n+\n+        return this.htmlPageAssetAPI.findByIdLanguageFallback(id, language.getId(), mode.showLive, userAPI.getSystemUser(),\n+                mode.respectAnonPerms);\n+    }\n+\n     private Language getCurrentLanguage(final HttpServletRequest request) {\n         return request != null ? this.languageWebAPI.getLanguage(request) : this.languageAPI.getDefaultLanguage();\n     }\n \n-    public class HTMLPageUrl {\n-        private String pageUrl;\n+    public static class HTMLPageUrl {\n         private String pageUrlMapper;\n         private HTMLPageAsset htmlPage;\n         private Boolean hasLive = null;\n \n-        public HTMLPageUrl(final String pageUrl, final String pageUrlMapper, final Boolean hasLive) {\n-            this.pageUrl = pageUrl;\n+        private HTMLPageUrl(final HTMLPageAsset htmlPage, final String pageUrlMapper, final Boolean hasLive) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjkyNA=="}, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 216}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDkyNzM0OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNToxMDowNFrOFf9eFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDo0MToyMFrOFgIHyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1NzMwMg==", "bodyText": "Would a ternary-like operator be cleaner here?  Something like:\nfinal HTMLPageUrl htmlPageUrl = findPageByContext(host, context)\n   .orElse(findByURLMap(context, host, request))\n   .orElse(null);", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369057302", "createdAt": "2020-01-21T15:10:04Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -232,34 +249,44 @@ public String getPageHtml(\n                 throws DotSecurityException, DotDataException {\n \n         final Host host = this.hostWebAPI.getCurrentHost(request, context.getUser());\n-        final IHTMLPage page = getHtmlPageAsset(context, host, request).getHTMLPage();\n+        final HTMLPageUrl htmlPageUrl = getHtmlPageAsset(context, host, request);\n+        final IHTMLPage page = htmlPageUrl.getHTMLPage();\n \n         return new HTMLPageAssetRenderedBuilder()\n                 .setHtmlPageAsset(page)\n                 .setUser(context.getUser())\n                 .setRequest(request)\n                 .setResponse(response)\n                 .setSite(host)\n-                .getPageHTML();\n+                .setURLMapper(htmlPageUrl.pageUrlMapper)\n+                .setLive(htmlPageUrl.hasLive())\n+                .getPageHTML(context.getPageMode());\n     }\n \n-    private HTMLPageUrl getHtmlPageAsset(\n-            final PageContext context,\n-            final Host host,\n-            final HttpServletRequest request)\n-                throws DotDataException, DotSecurityException {\n+    private HTMLPageUrl getHtmlPageAsset(final PageContext context, final Host host, final HttpServletRequest request)\n+            throws DotDataException, DotSecurityException {\n \n         HTMLPageUrl htmlPageUrl = null;\n-        IHTMLPage htmlPageAsset = findPageByContext(host, context);\n+        for (final SearchPageFunction pageSearcher : pageSearchers) {\n+            final Optional<HTMLPageUrl> optional = pageSearcher.search(context, host, request);\n \n-        if (htmlPageAsset == null){\n-            htmlPageUrl   = findByURLMap(context, host, request);\n-            htmlPageAsset = getPageByUri(context.getPageMode(), host, htmlPageUrl.getPageUrl());\n-        } else {\n-            htmlPageUrl   = new HTMLPageUrl(htmlPageAsset);\n+            if (optional.isPresent()) {\n+                htmlPageUrl = optional.get();\n+                break;\n+            }\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMTgxNw==", "bodyText": "done 0f3d1a9#diff-051d49b06feb0c7462b349b6b61988a8R251", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369231817", "createdAt": "2020-01-21T20:41:20Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -232,34 +249,44 @@ public String getPageHtml(\n                 throws DotSecurityException, DotDataException {\n \n         final Host host = this.hostWebAPI.getCurrentHost(request, context.getUser());\n-        final IHTMLPage page = getHtmlPageAsset(context, host, request).getHTMLPage();\n+        final HTMLPageUrl htmlPageUrl = getHtmlPageAsset(context, host, request);\n+        final IHTMLPage page = htmlPageUrl.getHTMLPage();\n \n         return new HTMLPageAssetRenderedBuilder()\n                 .setHtmlPageAsset(page)\n                 .setUser(context.getUser())\n                 .setRequest(request)\n                 .setResponse(response)\n                 .setSite(host)\n-                .getPageHTML();\n+                .setURLMapper(htmlPageUrl.pageUrlMapper)\n+                .setLive(htmlPageUrl.hasLive())\n+                .getPageHTML(context.getPageMode());\n     }\n \n-    private HTMLPageUrl getHtmlPageAsset(\n-            final PageContext context,\n-            final Host host,\n-            final HttpServletRequest request)\n-                throws DotDataException, DotSecurityException {\n+    private HTMLPageUrl getHtmlPageAsset(final PageContext context, final Host host, final HttpServletRequest request)\n+            throws DotDataException, DotSecurityException {\n \n         HTMLPageUrl htmlPageUrl = null;\n-        IHTMLPage htmlPageAsset = findPageByContext(host, context);\n+        for (final SearchPageFunction pageSearcher : pageSearchers) {\n+            final Optional<HTMLPageUrl> optional = pageSearcher.search(context, host, request);\n \n-        if (htmlPageAsset == null){\n-            htmlPageUrl   = findByURLMap(context, host, request);\n-            htmlPageAsset = getPageByUri(context.getPageMode(), host, htmlPageUrl.getPageUrl());\n-        } else {\n-            htmlPageUrl   = new HTMLPageUrl(htmlPageAsset);\n+            if (optional.isPresent()) {\n+                htmlPageUrl = optional.get();\n+                break;\n+            }\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1NzMwMg=="}, "originalCommit": {"oid": "2ae94ad84aa7b886e7c8522711f8555b4f6f0d10"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5OTQ3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1MVrOFgG-tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1MVrOFgG-tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzEwOA==", "bodyText": "Issue found: Avoid throwing raw exception types.", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213108", "createdAt": "2020-01-21T19:58:51Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "diffHunk": "@@ -0,0 +1,239 @@\n+package com.dotcms.rendering.velocity.servlet;\n+\n+import com.dotcms.api.web.HttpServletRequestThreadLocal;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.FiltersUtil;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Clickstream;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.filters.VanityURLFilter;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.WebKeys;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletOutputStream;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.dotcms.datagen.TestDataUtils.getNewsLikeContentType;\n+\n+import static org.mockito.Mockito.*;\n+\n+public class VelocityServletIntegrationTest {\n+\n+    public static final String TEST_PATTERN = \"/testpattern\";\n+    private HttpServletRequest request;\n+    private HttpServletResponse response;\n+    private Host host;\n+    private ServletOutputStream servletOutputStream;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Before\n+    public void init() {\n+        host = new SiteDataGen().nextPersisted();\n+\n+        final Map<String, Object> attributes = new HashMap<>();\n+\n+        request = mock(HttpServletRequest.class);\n+        // Mock setAttribute\n+        doAnswer(new Answer<Void>() {\n+            @Override\n+            public Void answer(final InvocationOnMock invocation) throws Throwable {\n+                final String key = invocation.getArgumentAt(0, String.class);\n+                final Object value = invocation.getArgumentAt(1, Object.class);\n+                attributes.put(key, value);\n+                return null;\n+            }\n+        }).when(request).setAttribute(anyString(), anyObject());\n+\n+        // Mock getAttribute\n+        doAnswer(new Answer<Object>() {\n+            @Override\n+            public Object answer(final InvocationOnMock invocation) throws Throwable {\n+                final String key = invocation.getArgumentAt(0, String.class);\n+                return attributes.get(key);\n+            }\n+        }).when(request).getAttribute(anyString());\n+\n+        HttpServletRequestThreadLocal.INSTANCE.setRequest(request);\n+        when(request.getParameter(\"host_id\")).thenReturn(host.getIdentifier());\n+\n+        final HttpSession session = mock(HttpSession.class);\n+        when(session.getAttribute(WebKeys.PAGE_MODE_SESSION)).thenReturn(PageMode.LIVE);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        final Clickstream clickstream = mock(Clickstream.class);\n+        when(session.getAttribute(\"clickstream\")).thenReturn(clickstream);\n+\n+        response = mock(HttpServletResponse.class);\n+        servletOutputStream = mock(ServletOutputStream.class);\n+        try {\n+            when(response.getOutputStream()).thenReturn(servletOutputStream);\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5OTY1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1M1rOFgG-yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1M1rOFgG-yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzEzMA==", "bodyText": "Issue found: Avoid unused imports such as 'org.mockito.Mockito'", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213130", "createdAt": "2020-01-21T19:58:53Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "diffHunk": "@@ -0,0 +1,239 @@\n+package com.dotcms.rendering.velocity.servlet;\n+\n+import com.dotcms.api.web.HttpServletRequestThreadLocal;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.FiltersUtil;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Clickstream;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.filters.VanityURLFilter;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.WebKeys;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletOutputStream;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.dotcms.datagen.TestDataUtils.getNewsLikeContentType;\n+\n+import static org.mockito.Mockito.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5OTgwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1NVrOFgG-3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1NVrOFgG-3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzE0OA==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213148", "createdAt": "2020-01-21T19:58:55Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "diffHunk": "@@ -0,0 +1,239 @@\n+package com.dotcms.rendering.velocity.servlet;\n+\n+import com.dotcms.api.web.HttpServletRequestThreadLocal;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.FiltersUtil;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Clickstream;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.filters.VanityURLFilter;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.WebKeys;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletOutputStream;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.dotcms.datagen.TestDataUtils.getNewsLikeContentType;\n+\n+import static org.mockito.Mockito.*;\n+\n+public class VelocityServletIntegrationTest {\n+\n+    public static final String TEST_PATTERN = \"/testpattern\";\n+    private HttpServletRequest request;\n+    private HttpServletResponse response;\n+    private Host host;\n+    private ServletOutputStream servletOutputStream;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5OTkwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1NlrOFgG-6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1NlrOFgG-6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzE2Mw==", "bodyText": "Issue found: Local variable 'unauthorized' could be declared final", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213163", "createdAt": "2020-01-21T19:58:56Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -98,17 +96,11 @@ public final void serve(final OutputStream out) throws DotDataException, IOExcep\n \n \n             User user = getUser();\n-\n+            final String uri = CMSUrlUtil.getCurrentURI(request);\n             Logger.debug(this.getClass(), \"Page Permissions for URI=\" + uri);\n \n-\n-\n-            IHTMLPage htmlPage = APILocator.getHTMLPageAssetAPI().findByIdLanguageFallback(id, langId, mode.showLive,\n-                    APILocator.systemUser(), mode.respectAnonPerms);\n-\n-\n             // Verify and handle the case for unauthorized access of this contentlet\n-            Boolean unauthorized = CMSUrlUtil.getInstance().isUnauthorizedAndHandleError(htmlPage, uri, user, request, response);\n+            boolean unauthorized = CMSUrlUtil.getInstance().isUnauthorizedAndHandleError(htmlPage, uri, user, request, response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTg5OTk1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1OFrOFgG-9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1OFrOFgG-9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzE3Mw==", "bodyText": "Issue found: Avoid variables with short names like id", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213173", "createdAt": "2020-01-21T19:58:58Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityLiveMode.java", "diffHunk": "@@ -74,7 +72,7 @@ public final void serve(final OutputStream out) throws DotDataException, IOExcep\n \n \n             // now we check identifier cache first (which DOES NOT have a 404 cache )\n-            Identifier id = APILocator.getIdentifierAPI().find(host, uri);\n+            final Identifier id = APILocator.getIdentifierAPI().find(this.htmlPage.getIdentifier());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDAzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1OVrOFgG_AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1ODo1OVrOFgG_AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzE4NQ==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.datagen'", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213185", "createdAt": "2020-01-21T19:58:59Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "diffHunk": "@@ -0,0 +1,239 @@\n+package com.dotcms.rendering.velocity.servlet;\n+\n+import com.dotcms.api.web.HttpServletRequestThreadLocal;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDEzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowMVrOFgG_EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowMVrOFgG_EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzIwMA==", "bodyText": "Issue found: Avoid appending characters as strings in StringBuffer.append.", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213200", "createdAt": "2020-01-21T19:59:01Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -280,6 +279,7 @@ private String buildContentQuery(\n             query.append(this.getHostFilter(context.getHost()));\n         }\n \n+        query.append(\" \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDQ5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowNlrOFgG_RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowNlrOFgG_RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzI1Mg==", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Mockito.mock' due to existing static import 'org.mockito.Mockito.*'", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213252", "createdAt": "2020-01-21T19:59:06Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/servlet/VelocityServletIntegrationTest.java", "diffHunk": "@@ -0,0 +1,239 @@\n+package com.dotcms.rendering.velocity.servlet;\n+\n+import com.dotcms.api.web.HttpServletRequestThreadLocal;\n+import com.dotcms.contenttype.model.type.ContentType;\n+import com.dotcms.datagen.*;\n+import com.dotcms.util.FiltersUtil;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Clickstream;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.filters.VanityURLFilter;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.folders.model.Folder;\n+import com.dotmarketing.portlets.htmlpageasset.model.HTMLPageAsset;\n+import com.dotmarketing.portlets.languagesmanager.model.Language;\n+import com.dotmarketing.portlets.templates.model.Template;\n+import com.dotmarketing.util.PageMode;\n+import com.dotmarketing.util.WebKeys;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletOutputStream;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.servlet.http.HttpSession;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.dotcms.datagen.TestDataUtils.getNewsLikeContentType;\n+\n+import static org.mockito.Mockito.*;\n+\n+public class VelocityServletIntegrationTest {\n+\n+    public static final String TEST_PATTERN = \"/testpattern\";\n+    private HttpServletRequest request;\n+    private HttpServletResponse response;\n+    private Host host;\n+    private ServletOutputStream servletOutputStream;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    @Before\n+    public void init() {\n+        host = new SiteDataGen().nextPersisted();\n+\n+        final Map<String, Object> attributes = new HashMap<>();\n+\n+        request = mock(HttpServletRequest.class);\n+        // Mock setAttribute\n+        doAnswer(new Answer<Void>() {\n+            @Override\n+            public Void answer(final InvocationOnMock invocation) throws Throwable {\n+                final String key = invocation.getArgumentAt(0, String.class);\n+                final Object value = invocation.getArgumentAt(1, Object.class);\n+                attributes.put(key, value);\n+                return null;\n+            }\n+        }).when(request).setAttribute(anyString(), anyObject());\n+\n+        // Mock getAttribute\n+        doAnswer(new Answer<Object>() {\n+            @Override\n+            public Object answer(final InvocationOnMock invocation) throws Throwable {\n+                final String key = invocation.getArgumentAt(0, String.class);\n+                return attributes.get(key);\n+            }\n+        }).when(request).getAttribute(anyString());\n+\n+        HttpServletRequestThreadLocal.INSTANCE.setRequest(request);\n+        when(request.getParameter(\"host_id\")).thenReturn(host.getIdentifier());\n+\n+        final HttpSession session = mock(HttpSession.class);\n+        when(session.getAttribute(WebKeys.PAGE_MODE_SESSION)).thenReturn(PageMode.LIVE);\n+        when(request.getSession()).thenReturn(session);\n+        when(request.getSession(true)).thenReturn(session);\n+        final Clickstream clickstream = mock(Clickstream.class);\n+        when(session.getAttribute(\"clickstream\")).thenReturn(clickstream);\n+\n+        response = mock(HttpServletResponse.class);\n+        servletOutputStream = mock(ServletOutputStream.class);\n+        try {\n+            when(response.getOutputStream()).thenReturn(servletOutputStream);\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    /**\n+     * Method to test: {@link VelocityServlet#service(HttpServletRequest, HttpServletResponse)}\n+     * when: There is exists a Content Type Url Map and is request\n+     * Should: return 200 Http code\n+     *\n+     * @throws ServletException\n+     * @throws IOException\n+     */\n+    @Test\n+    public void whenRequestURLMap() throws ServletException, IOException {\n+\n+        final VelocityServlet velocityServlet = new VelocityServlet();\n+\n+        final String newsPatternPrefix =\n+                TEST_PATTERN + System.currentTimeMillis() + \"/\";\n+        final Contentlet contentlet = createURLMapperContentType(newsPatternPrefix, host);\n+        ContentletDataGen.publish(contentlet);\n+\n+        final String contentletURLMap = newsPatternPrefix + contentlet.getStringProperty(\"urlTitle\");\n+\n+        when(request.getRequestURI()).thenReturn(contentletURLMap);\n+\n+        velocityServlet.service(request, response);\n+\n+        verify(servletOutputStream).write(\"\".getBytes());\n+        verify(response, never()).sendError(HttpServletResponse.SC_NOT_FOUND);\n+    }\n+\n+    /**\n+     * Method to test: {@link VelocityServlet#service(HttpServletRequest, HttpServletResponse)}\n+     * when: There is exists a Content Type Url Map and is request\n+     * Should: return 200 Http code\n+     *\n+     * @throws ServletException\n+     * @throws IOException\n+     */\n+    @Test\n+    public void whenRequestVanityURL() throws ServletException, IOException, DotDataException, DotSecurityException {\n+\n+        final VelocityServlet velocityServlet = new VelocityServlet();\n+\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final HTMLPageAsset htmlPageAsset = new HTMLPageDataGen(host, template).nextPersisted();\n+        ContentletDataGen.publish(htmlPageAsset);\n+\n+        when(request.getRequestURI()).thenReturn(\"/vanityURL\");\n+\n+        final String VANITY_URI = \"/vanityURL\";\n+        createAndPublishVanityURL(htmlPageAsset.getPageUrl(), VANITY_URI);\n+\n+        when(request.getRequestURI()).thenReturn(VANITY_URI);\n+        final FilterChain chain = mock(FilterChain.class);\n+\n+        final VanityURLFilter vanityURLFilter = new VanityURLFilter();\n+        vanityURLFilter.doFilter(request, response, chain);\n+\n+        velocityServlet.service(request, response);\n+\n+        verify(servletOutputStream).write(\"\".getBytes());\n+        verify(response, never()).sendError(HttpServletResponse.SC_NOT_FOUND);\n+    }\n+\n+    private void createAndPublishVanityURL(final String forwardURL, final String VANITY_URI)\n+            throws DotDataException, DotSecurityException {\n+        final Language defaultLanguage = APILocator.getLanguageAPI().getDefaultLanguage();\n+        final Contentlet vanityUrl = FiltersUtil.getInstance().createVanityUrl(\"test\", host.getIdentifier(), VANITY_URI,\n+                forwardURL, 200, 0, defaultLanguage.getId());\n+\n+        FiltersUtil.getInstance().publishVanityUrl(vanityUrl);\n+    }\n+\n+    /**\n+     * Method to test: {@link VelocityServlet#service(HttpServletRequest, HttpServletResponse)}\n+     * when: There is exists a VanityURL that forward to a URL Map\n+     * Should: return 200 Http code\n+     *\n+     * @throws ServletException\n+     * @throws IOException\n+     */\n+    @Test\n+    public void whenRequestURLMapAndVanityURLTogether() throws ServletException, IOException, DotSecurityException, DotDataException {\n+\n+        final VelocityServlet velocityServlet = new VelocityServlet();\n+\n+        final String newsPatternPrefix =\n+                TEST_PATTERN + System.currentTimeMillis() + \"/\";\n+        final Contentlet contentlet = createURLMapperContentType(newsPatternPrefix, host);\n+        ContentletDataGen.publish(contentlet);\n+\n+        when(request.getRequestURI()).thenReturn(\"/vanityURL/\" + contentlet.getStringProperty(\"urlTitle\"));\n+\n+        final String VANITY_URI = \"/vanityURL/([a-zA-Z0-9-_]+)\";\n+        final String FORWARD_URL = newsPatternPrefix + \"$1\";\n+\n+        createAndPublishVanityURL(FORWARD_URL, VANITY_URI);\n+\n+        when(request.getRequestURI()).thenReturn(\"/vanityURL/\" + contentlet.getStringProperty(\"urlTitle\"));\n+        final FilterChain chain = Mockito.mock(FilterChain.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 199}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDU5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowN1rOFgG_VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowN1rOFgG_VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzI2OA==", "bodyText": "Issue found: Avoid variables with short names like id", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213268", "createdAt": "2020-01-21T19:59:07Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/htmlpageasset/business/render/HTMLPageAssetRenderedAPIImpl.java", "diffHunk": "@@ -342,50 +351,53 @@ private IHTMLPage getPageByUri(final PageMode mode, final Host host, final Strin\n         return htmlPage;\n     }\n \n+    private IHTMLPage getPageById(final PageMode mode, final String id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 170}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDY2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapInfo.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowOFrOFgG_XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowOFrOFgG_XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzI3Nw==", "bodyText": "Issue found: Parameter 'urlMapped' is not assigned and could be declared final", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213277", "createdAt": "2020-01-21T19:59:08Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapInfo.java", "diffHunk": "@@ -9,10 +9,12 @@\n public class URLMapInfo {\n     final Contentlet contentlet;\n     final Identifier identifier;\n+    final String urlMapped;\n \n-    URLMapInfo(final Contentlet contentlet, final Identifier identifier) {\n+    URLMapInfo(final Contentlet contentlet, final Identifier identifier, String urlMapped) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDcxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityModeHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowOVrOFgG_Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OTowOVrOFgG_Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzI4Ng==", "bodyText": "Issue found: Avoid variables with short names like id", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213286", "createdAt": "2020-01-21T19:59:09Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/servlet/VelocityModeHandler.java", "diffHunk": "@@ -64,16 +102,42 @@ public final String eval() {\n             serve(out);\n             return new String(out.toByteArray());\n         } catch (DotDataException | IOException | DotSecurityException e) {\n+            Logger.debug(VelocityModeHandler.class, e.getMessage(), e);\n             throw new DotRuntimeException(e);\n         }\n     }\n-    \n-    public static final VelocityModeHandler modeHandler(PageMode mode, HttpServletRequest request, HttpServletResponse response, String uri, Host host) {\n-        return pageModeVelocityMap.get(mode).apply(request, response, uri, host);\n+\n+    public static final VelocityModeHandler modeHandler(final PageMode mode, final HttpServletRequest request, final HttpServletResponse response, final String uri, final Host host) {\n+        // Find the current language\n+        final IHTMLPage htmlPage= getHtmlPageFromURI(mode, request, uri, host);\n+        return pageModeVelocityMap.get(mode).apply(request, response, htmlPage, host);\n     }\n-    \n-    public static final VelocityModeHandler modeHandler(PageMode mode, HttpServletRequest request, HttpServletResponse response) {\n-        return pageModeVelocityMap.get(mode).apply(request, response, request.getRequestURI(), hostWebAPI.getCurrentHostNoThrow(request));\n+\n+    protected static IHTMLPage getHtmlPageFromURI(final PageMode mode, final HttpServletRequest request, final  String uri, final Host host) {\n+        final long langId = WebAPILocator.getLanguageWebAPI().getLanguage(request).getId();\n+\n+        try {\n+            // now we check identifier cache first (which DOES NOT have a 404 cache )\n+            final Identifier id = APILocator.getIdentifierAPI().find(host, uri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MTkwMDgxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OToxMVrOFgG_cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTo1OToxMVrOFgG_cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIxMzI5Nw==", "bodyText": "Issue found: StringBuffer (or StringBuilder).append is called consecutively without reusing the target variable.", "url": "https://github.com/dotCMS/core/pull/17859#discussion_r369213297", "createdAt": "2020-01-21T19:59:11Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/cms/urlmap/URLMapAPIImpl.java", "diffHunk": "@@ -280,6 +279,7 @@ private String buildContentQuery(\n             query.append(this.getHostFilter(context.getHost()));\n         }\n \n+        query.append(\" \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e073515120a35fb459d5df3b2a212340faab59d"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2495, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}