{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1NTQyMDUy", "number": 19261, "title": "#19006 cache eviction is perfrmed asynchrously when threadpool is und\u2026", "bodyText": "comes to solve a problem where the Thread pool would go exhausted from a massive cache eviction.\nBasically, this will look at a property that indicates whether or not the number of queued tasks is exceeded.", "createdAt": "2020-09-11T23:02:34Z", "url": "https://github.com/dotCMS/core/pull/19261", "merged": true, "mergeCommit": {"oid": "181f4ca9b166711dd4d9cdb488066444fec2de90"}, "closed": true, "closedAt": "2020-09-14T20:25:12Z", "author": {"login": "fabrizzio-dotCMS"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH9h7DAH2gAyNDg1NTQyMDUyOmIxNWI4MjVhYzNhMzQ1NDAzOThlNzMzYzQxODkxY2NmZmQ1NzM0YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI5KBhAFqTQ4ODExMzcyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/b15b825ac3a34540398e733c41891ccffd5734b4", "committedDate": "2020-09-11T22:55:58Z", "message": "#19006 cache eviction is perfrmed asynchrously when threadpool is under certain %"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODI0NzMx", "url": "https://github.com/dotCMS/core/pull/19261#pullrequestreview-487824731", "createdAt": "2020-09-14T14:24:58Z", "commit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODg2MDkz", "url": "https://github.com/dotCMS/core/pull/19261#pullrequestreview-487886093", "createdAt": "2020-09-14T15:23:56Z", "commit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyMzo1NlrOHRaVzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyOTowNFrOHRao2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTQwNg==", "bodyText": "We don't need the sync block here, I don't think.", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488019406", "createdAt": "2020-09-14T15:23:56Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -243,10 +242,32 @@ public void remove(final String group, final String key) {\n \t\t\n \t}\n \n+\t/**\n+\t * Calculates the thread allocation % for a given queue size.\n+\t * Then determines if that allocation % exceeds or not a tolerance.\n+\t * @return\n+\t */\n+\tboolean isAllocationWithinTolerance() {\n+\t\tfinal int size = asyncTaskQueue.size();\n+\t\tfinal float allocation = (float) size / (float) asyncTaskQueueSize;\n+\t\tLogger.debug(H22Cache.class,\n+\t\t\t\t() -> \" size is \" + size + \", allocation is \" + allocation + \", tolerance is :\"\n+\t\t\t\t\t\t+ threadAllocationTolerance);\n+\t\treturn allocation < threadAllocationTolerance;\n+\t}\n \n-    void removeAsync(final Fqn fqn) {\n-\n+    /**\n+     * returns true if async set to true and the task queue is < than a given tolerance % full.\n+     *\n+     * @return\n+     */\n+    boolean shouldAsync() {\n+       synchronized (H22Cache.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyNDI4MQ==", "bodyText": "slight optimization - should the initial thread pool be fixed at a smaller number, say 5?", "url": "https://github.com/dotCMS/core/pull/19261#discussion_r488024281", "createdAt": "2020-09-14T15:29:04Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/cache/provider/h22/H22Cache.java", "diffHunk": "@@ -47,12 +44,14 @@\n \n     private static final long serialVersionUID = 1L;\n     final int numberOfAsyncThreads=Config.getIntProperty(\"cache_h22_async_threads\", 10);\n-    \n+    final int asyncTaskQueueSize = Config.getIntProperty(\"cache_h22_async_task_queue\", 10000);\n+\tfinal float threadAllocationTolerance = Config.getFloatProperty(\"cache_h22_async_tolerance\",0.98F);\n     final boolean shouldAsync=Config.getBooleanProperty(\"cache_h22_async\", true);\n \n \n     final ThreadFactory namedThreadFactory =  new ThreadFactoryBuilder().setNameFormat(\"H22-ASYNC-COMMIT-%d\").build();\n-    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, new LinkedBlockingQueue<Runnable>(10000),namedThreadFactory);\n+    final private LinkedBlockingQueue<Runnable> asyncTaskQueue = new LinkedBlockingQueue<>();\n+    final private ExecutorService executorService = new ThreadPoolExecutor(numberOfAsyncThreads, numberOfAsyncThreads, 10, TimeUnit.SECONDS, asyncTaskQueue ,namedThreadFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15b825ac3a34540398e733c41891ccffd5734b4"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b703598a94e6c3c5b0d31afca457ddc89bacc4", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/c6b703598a94e6c3c5b0d31afca457ddc89bacc4", "committedDate": "2020-09-14T15:36:30Z", "message": "#19006 isAllocationWithinTolerance shouldn't be syynnchronized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b320479aa786fc69ddb0e91c26769906afd1462a", "author": {"user": {"login": "fabrizzio-dotCMS", "name": "Fabrizzio Araya"}}, "url": "https://github.com/dotCMS/core/commit/b320479aa786fc69ddb0e91c26769906afd1462a", "committedDate": "2020-09-14T17:38:12Z", "message": "#19006 slight optimization lowering number of threads to 5"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MTEzMjk5", "url": "https://github.com/dotCMS/core/pull/19261#pullrequestreview-488113299", "createdAt": "2020-09-14T20:23:32Z", "commit": {"oid": "b320479aa786fc69ddb0e91c26769906afd1462a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MTEzNzI3", "url": "https://github.com/dotCMS/core/pull/19261#pullrequestreview-488113727", "createdAt": "2020-09-14T20:24:10Z", "commit": {"oid": "b320479aa786fc69ddb0e91c26769906afd1462a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1857, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}