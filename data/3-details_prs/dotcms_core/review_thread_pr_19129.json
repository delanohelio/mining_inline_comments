{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzA5ODM5", "number": 19129, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1MDowMlrOEaFoHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNDo0MzozOFrOEa_rVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NzkwNjIyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotmarketing/util/Config.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1MDowMlrOHDS0VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODozNDo1NlrOHDUUqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjA4NA==", "bodyText": "why the synchronized ?", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r473216084", "createdAt": "2020-08-19T17:50:02Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/util/Config.java", "diffHunk": "@@ -300,17 +300,13 @@ private static void _refreshProperties () {\n \n \n \tprivate final static String ENV_PREFIX=\"DOT_\";\n-\t\n-    private static void readEnvironmentVariables() {\n-        \n-        \n-        System.getenv().entrySet().stream().filter(e->e.getKey().startsWith(ENV_PREFIX)).forEach(e->\n-            props.addProperty(e.getKey(), e.getValue())\n-        );\n-        \n \n-\n-    }\n+\tprivate static void readEnvironmentVariables() {\n+\t\tsynchronized (Config.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MDc0NQ==", "bodyText": "The other read methods above this one are synchronized (The ones that read from the properties files). I was able to corroborate that the properties are loaded repeated times during the start-up.  from static context and from the MainServlet initialize. I think there's no harm in making that piece synchronized especially when this can be called from different contexts.", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r473240745", "createdAt": "2020-08-19T18:34:56Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/main/java/com/dotmarketing/util/Config.java", "diffHunk": "@@ -300,17 +300,13 @@ private static void _refreshProperties () {\n \n \n \tprivate final static String ENV_PREFIX=\"DOT_\";\n-\t\n-    private static void readEnvironmentVariables() {\n-        \n-        \n-        System.getenv().entrySet().stream().filter(e->e.getKey().startsWith(ENV_PREFIX)).forEach(e->\n-            props.addProperty(e.getKey(), e.getValue())\n-        );\n-        \n \n-\n-    }\n+\tprivate static void readEnvironmentVariables() {\n+\t\tsynchronized (Config.class) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjA4NA=="}, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NzQxNjgwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNDo0MzozMVrOHEwBog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowOTowMlrOHF0elw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzIwMg==", "bodyText": "Doc Test. E.g:\n    /**\n     * Method to rest: {@link GraphqlAPI#getSchema()}\n     * Given scenario: A bad relationship field which returns null when trying to get the\n     * {@link com.dotmarketing.portlets.structure.model.Relationship} out of it.\n     * Expected result: The schema should be able to generate but without that field present\n     */", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r474743202", "createdAt": "2020-08-21T14:43:31Z", "author": {"login": "erickgonzalez"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test\n+    public void Test_Multiple_Calls_To_AddProperty_On_The_Same_Key() {\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        assertEquals (\"anyValue\",Config.props.getProperty(\"anyKey\"));\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values1 = Arrays.asList(\"anyValue\", \"anyValue\");\n+\n+        final Object property1 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals1 = values1.equals(property1);\n+        assertTrue(equals1);\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values2 = Arrays.asList(\"anyValue\", \"anyValue\", \"anyValue\");\n+        final Object property2 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals2 = values2.equals(property2);\n+        assertTrue(equals2);\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2NDcyNw==", "bodyText": "done", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r475864727", "createdAt": "2020-08-24T20:09:02Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test\n+    public void Test_Multiple_Calls_To_AddProperty_On_The_Same_Key() {\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        assertEquals (\"anyValue\",Config.props.getProperty(\"anyKey\"));\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values1 = Arrays.asList(\"anyValue\", \"anyValue\");\n+\n+        final Object property1 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals1 = values1.equals(property1);\n+        assertTrue(equals1);\n+\n+        Config.props.addProperty(\"anyKey\",\"anyValue\");\n+        final List<String> values2 = Arrays.asList(\"anyValue\", \"anyValue\", \"anyValue\");\n+        final Object property2 = Config.props.getProperty(\"anyKey\");\n+        final boolean equals2 = values2.equals(property2);\n+        assertTrue(equals2);\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzIwMg=="}, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NzQxNzE5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNDo0MzozOFrOHEwB3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMDowODo1M1rOHF0eXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzI2MA==", "bodyText": "Doc Test. E.g:\n    /**\n     * Method to rest: {@link GraphqlAPI#getSchema()}\n     * Given scenario: A bad relationship field which returns null when trying to get the\n     * {@link com.dotmarketing.portlets.structure.model.Relationship} out of it.\n     * Expected result: The schema should be able to generate but without that field present\n     */", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r474743260", "createdAt": "2020-08-21T14:43:38Z", "author": {"login": "erickgonzalez"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2NDY3MA==", "bodyText": "done", "url": "https://github.com/dotCMS/core/pull/19129#discussion_r475864670", "createdAt": "2020-08-24T20:08:53Z", "author": {"login": "fabrizzio-dotCMS"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/util/ConfigTest.java", "diffHunk": "@@ -48,54 +54,92 @@ private static void setTestEnvVariables() {\n         System.getenv().put(DOT_TESTING_STRING_WITH_SPACES, \"VALUE1 VALUE2\");\n         System.getenv().put(DOT_TESTING_STRING, \"VALUE_ABC\");\n         System.getenv().put(UNABLE_TO_READ_VAR, \"NOPE\");\n+        //This forces a re-load.\n+        Config.props = null;\n+        Config.initializeConfig();\n     }\n-    \n-    \n-    \n+\n+\n+\n     @Test\n     public void testing_string_with_comma() {\n \n         String value = Config.getStringProperty(\"TESTING_STRING_WITH_COMMA\");\n         assert(value.equals(Config.getStringProperty(\"testing.String.with_comma\")));\n \n-        \n+\n     }\n-    \n-    \n-    \n+\n+    /**\n+     * Small test to demo that the internal method addProperty generates an array list\n+     * There's a huge difference between addProperty and setProperty\n+     */\n+    @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0MzI2MA=="}, "originalCommit": {"oid": "1b4bbc8f08c3f0986e6b56fb2adebde67a1f5007"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1993, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}