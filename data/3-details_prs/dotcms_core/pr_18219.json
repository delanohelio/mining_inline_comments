{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDg1OTE4", "number": 18219, "title": "#18182 missing remove attribute when encapsulating method", "bodyText": "", "createdAt": "2020-03-31T17:34:32Z", "url": "https://github.com/dotCMS/core/pull/18219", "merged": true, "mergeCommit": {"oid": "a51af2d6a61f4b545d8aea64989609110e4f4d62"}, "closed": true, "closedAt": "2020-04-07T16:27:56Z", "author": {"login": "erickgonzalez"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTGmANgH2gAyMzk2NDg1OTE4OjA5NDAwM2NkNWI0MDMyMGM5MzEzNjQ3MGEwMGQyZDlmOTNiYzc4ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVHV9ogFqTM4ODY4ODM3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/094003cd5b40320c93136470a00d2d9f93bc78fb", "committedDate": "2020-03-31T17:31:35Z", "message": "#18182 missing remove attribute when encapsulating method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTYzNDg4", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-384963488", "createdAt": "2020-03-31T17:43:56Z", "commit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzo0Mzo1NlrOF-hE7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzo0Mzo1NlrOF-hE7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA5Nzk2NA==", "bodyText": "should this change have a postman test or at least a unit/integration test?", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r401097964", "createdAt": "2020-03-31T17:43:56Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/user/UserResource.java", "diffHunk": "@@ -403,7 +403,7 @@ private void updateLoginAsSessionInfo(final HttpServletRequest request, final Ho\n \t\tfinal String userToImpersonate = (UtilMethods.isSet(loginAsUserId) ? loginAsUserId : principalUserId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTY3NjY2", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-384967666", "createdAt": "2020-03-31T17:49:31Z", "commit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTk3NTUz", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-384997553", "createdAt": "2020-03-31T18:30:37Z", "commit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODozMDozOFrOF-izcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODozMDozOFrOF-izcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyNjI1OQ==", "bodyText": "Move this code to the revertLoginAsSessionInfo method in order to encapsulate the session revert process", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r401126259", "createdAt": "2020-03-31T18:30:38Z", "author": {"login": "jcastro-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/user/UserResource.java", "diffHunk": "@@ -498,6 +498,7 @@ public final Response logoutAs(@Context final HttpServletRequest httpServletRequ\n \t\t\tfinal Map<String, Object> sessionData = this.helper.doLogoutAs(principalUserId, currentLoginAsUser, serverName);\n \t\t\trevertLoginAsSessionInfo(httpServletRequest, Host.class.cast(sessionData.get(com.dotmarketing.util.WebKeys\n \t\t\t\t\t.CURRENT_HOST)), principalUserId);\n+\t\t\thttpServletRequest.getSession().removeAttribute(WebKeys.PRINCIPAL_USER_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "094003cd5b40320c93136470a00d2d9f93bc78fb"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5ad7929b1b5d191772b869a46ed49940a62a8ca", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e5ad7929b1b5d191772b869a46ed49940a62a8ca", "committedDate": "2020-03-31T20:08:39Z", "message": "#18182 move remove attribute to revertLogin method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NjQ4MzQ1", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-385648345", "createdAt": "2020-04-01T14:36:21Z", "commit": {"oid": "e5ad7929b1b5d191772b869a46ed49940a62a8ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fb732755b08c3486a7813c6230347ed1d19a16", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/74fb732755b08c3486a7813c6230347ed1d19a16", "committedDate": "2020-04-01T16:13:58Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18182"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1135f9cc2f343bc388e68f623e38215715cc5a", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/4b1135f9cc2f343bc388e68f623e38215715cc5a", "committedDate": "2020-04-01T16:15:27Z", "message": "#18182 IT for loginAs and logoutAs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "880440f434e495b9b62cb2875fb711f8b0b96c85", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/880440f434e495b9b62cb2875fb711f8b0b96c85", "committedDate": "2020-04-02T20:47:27Z", "message": "#18182 fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "203348ad05b8c4b9428e1b2c97765ff9bc302de0", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/203348ad05b8c4b9428e1b2c97765ff9bc302de0", "committedDate": "2020-04-02T22:11:05Z", "message": "empty space"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e300ca9a5b9c1f5f35e05cf3d1516c912ecef3", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/d2e300ca9a5b9c1f5f35e05cf3d1516c912ecef3", "committedDate": "2020-04-03T16:50:34Z", "message": "logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be36fec458167f0589481f749183d8a8c1aece9", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/3be36fec458167f0589481f749183d8a8c1aece9", "committedDate": "2020-04-03T18:04:58Z", "message": "logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ad2debc91ace384c276d5270aaf2469e758507c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/5ad2debc91ace384c276d5270aaf2469e758507c", "committedDate": "2020-04-06T17:12:47Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18182"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85507440c45aaac6a970a25ba9198ab59187f92d", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/85507440c45aaac6a970a25ba9198ab59187f92d", "committedDate": "2020-04-06T17:13:43Z", "message": "logs and add variables to session"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff271f03407565ea808c255731b9f18f0f5977bd", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/ff271f03407565ea808c255731b9f18f0f5977bd", "committedDate": "2020-04-06T18:16:26Z", "message": "logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c49be144a12d159ae4fa2701e78bc5309f1531", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/d2c49be144a12d159ae4fa2701e78bc5309f1531", "committedDate": "2020-04-06T19:56:39Z", "message": "check permissions over host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f6cca599c37b2c3b5807a80b2b07eeea8c7d68f", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/4f6cca599c37b2c3b5807a80b2b07eeea8c7d68f", "committedDate": "2020-04-06T21:08:54Z", "message": "create host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "615a097ce01ca6dd6d4a36f221f7cda09205d37a", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/615a097ce01ca6dd6d4a36f221f7cda09205d37a", "committedDate": "2020-04-06T22:01:27Z", "message": "change order tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/a6c969841233724d36d17b267bbb18e1d888bfcd", "committedDate": "2020-04-06T23:25:49Z", "message": "revert logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njg4MzUx", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-388688351", "createdAt": "2020-04-06T23:31:45Z", "commit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0NlrOGBtpBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0NlrOGBtpBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0OTU0MQ==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r404449541", "createdAt": "2020-04-06T23:31:46Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/user/UserResourceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.user;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class UserResourceIntegrationTest {\n+\n+    static HttpServletResponse response;\n+    static HttpServletRequest request;\n+    static UserResource resource;\n+    static User user;\n+    static Host host;\n+    static User adminUser;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njg4MzU4", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-388688358", "createdAt": "2020-04-06T23:31:46Z", "commit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0N1rOGBtpDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0N1rOGBtpDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0OTU1MA==", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r404449550", "createdAt": "2020-04-06T23:31:47Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/user/UserResourceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.user;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class UserResourceIntegrationTest {\n+\n+    static HttpServletResponse response;\n+    static HttpServletRequest request;\n+    static UserResource resource;\n+    static User user;\n+    static Host host;\n+    static User adminUser;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+\n+        resource = new UserResource();\n+        adminUser = TestUserUtils.getAdminUser();\n+        host = new SiteDataGen().nextPersisted();\n+        user = TestUserUtils.getChrisPublisherUser(host);\n+        response = new MockHttpResponse();\n+\n+        //Check if role has any layout, if is empty add one\n+        if(APILocator.getLayoutAPI().loadLayoutsForUser(user).isEmpty()) {\n+            APILocator.getRoleAPI()\n+                    .addLayoutToRole(APILocator.getLayoutAPI().findAllLayouts().get(0),\n+                            APILocator.getRoleAPI().getUserRole(user));\n+        }\n+        //Add permissions to the host\n+        final Permission readPermissionsPermission = new Permission( host.getPermissionId(),\n+                APILocator.getRoleAPI().getUserRole(user).getId(), PermissionAPI.PERMISSION_READ, true );\n+        APILocator.getPermissionAPI().save(readPermissionsPermission,host,adminUser,false);\n+\n+    }\n+\n+    private static HttpServletRequest mockRequest() {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        request.setHeader(\"Authorization\",\n+                \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        request.getSession().setAttribute(com.dotmarketing.util.WebKeys.CURRENT_HOST,host);\n+        request.getSession().setAttribute(com.dotmarketing.util.WebKeys.CMS_SELECTED_HOST_ID,host);\n+\n+        return request;\n+    }\n+\n+    private void loginAs() throws Exception {\n+        final LoginAsForm loginAsForm = new LoginAsForm.Builder().userId(user.getUserId()).build();\n+        request = mockRequest();\n+        final Response resourceResponse = resource.loginAs(request,response,loginAsForm);\n+        assertNotNull(resourceResponse);\n+        assertEquals(Status.OK.getStatusCode(),resourceResponse.getStatus());\n+        assertEquals(user.getUserId(),request.getSession().getAttribute(WebKeys.USER_ID));\n+        assertNull(request.getSession().getAttribute(WebKeys.USER));\n+        assertEquals(adminUser.getUserId(),request.getSession().getAttribute(WebKeys.PRINCIPAL_USER_ID));\n+    }\n+\n+    @Test\n+    public void test_loginAs_success() throws Exception{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njg4MzY5", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-388688369", "createdAt": "2020-04-06T23:31:48Z", "commit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0OFrOGBtpFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0OFrOGBtpFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0OTU1Nw==", "bodyText": "Issue found: Avoid unused imports such as 'org.junit.Assert'", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r404449557", "createdAt": "2020-04-06T23:31:48Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/user/UserResourceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.user;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import static org.junit.Assert.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njg4Mzc4", "url": "https://github.com/dotCMS/core/pull/18219#pullrequestreview-388688378", "createdAt": "2020-04-06T23:31:49Z", "commit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0OVrOGBtpHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzozMTo0OVrOGBtpHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0OTU2NQ==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18219#discussion_r404449565", "createdAt": "2020-04-06T23:31:49Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/api/v1/user/UserResourceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.dotcms.rest.api.v1.user;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.mock.request.MockAttributeRequest;\n+import com.dotcms.mock.request.MockHeaderRequest;\n+import com.dotcms.mock.request.MockHttpRequest;\n+import com.dotcms.mock.request.MockSessionRequest;\n+import com.dotcms.mock.response.MockHttpResponse;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.liferay.portal.model.User;\n+import com.liferay.portal.util.WebKeys;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.Response.Status;\n+import org.glassfish.jersey.internal.util.Base64;\n+import static org.junit.Assert.*;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class UserResourceIntegrationTest {\n+\n+    static HttpServletResponse response;\n+    static HttpServletRequest request;\n+    static UserResource resource;\n+    static User user;\n+    static Host host;\n+    static User adminUser;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        // Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+\n+        resource = new UserResource();\n+        adminUser = TestUserUtils.getAdminUser();\n+        host = new SiteDataGen().nextPersisted();\n+        user = TestUserUtils.getChrisPublisherUser(host);\n+        response = new MockHttpResponse();\n+\n+        //Check if role has any layout, if is empty add one\n+        if(APILocator.getLayoutAPI().loadLayoutsForUser(user).isEmpty()) {\n+            APILocator.getRoleAPI()\n+                    .addLayoutToRole(APILocator.getLayoutAPI().findAllLayouts().get(0),\n+                            APILocator.getRoleAPI().getUserRole(user));\n+        }\n+        //Add permissions to the host\n+        final Permission readPermissionsPermission = new Permission( host.getPermissionId(),\n+                APILocator.getRoleAPI().getUserRole(user).getId(), PermissionAPI.PERMISSION_READ, true );\n+        APILocator.getPermissionAPI().save(readPermissionsPermission,host,adminUser,false);\n+\n+    }\n+\n+    private static HttpServletRequest mockRequest() {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        request.setHeader(\"Authorization\",\n+                \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        request.getSession().setAttribute(com.dotmarketing.util.WebKeys.CURRENT_HOST,host);\n+        request.getSession().setAttribute(com.dotmarketing.util.WebKeys.CMS_SELECTED_HOST_ID,host);\n+\n+        return request;\n+    }\n+\n+    private void loginAs() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6c969841233724d36d17b267bbb18e1d888bfcd"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1228, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}