{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNjI1MzUz", "number": 19326, "title": "Issue 8538 19267 v2", "bodyText": "CategoryAjax: parents were not set when editing a category\nCategoryAPI: when editing category check permissions over itself\nPermissionAPI: new method to check permissions over a specific object type and asset.\nTests for everything.", "createdAt": "2020-09-24T18:27:22Z", "url": "https://github.com/dotCMS/core/pull/19326", "merged": true, "mergeCommit": {"oid": "8ea0dcb2878d81862ab3bdd084d0a20a65496064"}, "closed": true, "closedAt": "2020-09-25T17:03:41Z", "author": {"login": "erickgonzalez"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMDJcAgH2gAyNDkyNjI1MzUzOmUwMDdmNmE1ZDkwMzkzNmI0YjlmYjdhMGQ2NDhkODdkMjI2ZmM1MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMYkFsAH2gAyNDkyNjI1MzUzOmYwNjk3YjJmZDg2MTIyZGU2NmQ3ZWZkMmZhN2Q0NTEwNTU1Nzg5MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e007f6a5d903936b4b9fb7a0d648d87d226fc503", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e007f6a5d903936b4b9fb7a0d648d87d226fc503", "committedDate": "2020-09-24T15:44:21Z", "message": "#8538 #19267 set parents when editing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1480653e7313b03b2ab49f9beae5a0349295fbb4", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/1480653e7313b03b2ab49f9beae5a0349295fbb4", "committedDate": "2020-09-24T16:14:08Z", "message": "#8538 #19267 fix permissions when add/edit category"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c89c516e9c36e62c569340103ba6d131323385c8", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/c89c516e9c36e62c569340103ba6d131323385c8", "committedDate": "2020-09-24T16:22:43Z", "message": "#8538 #19267 doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34cc85c0e81f0718c96dd45b9b695ec1c46baad", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/c34cc85c0e81f0718c96dd45b9b695ec1c46baad", "committedDate": "2020-09-24T18:24:05Z", "message": "#8538 #19267 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/97cd7ea03d7a3978f3f4f24817e9d98fa0987357", "committedDate": "2020-09-25T15:04:17Z", "message": "Merge branch 'release-5.3.9' of github.com:dotCMS/core into issue-8538-19267-v2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYxNDY3", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496561467", "createdAt": "2020-09-25T16:13:08Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYyMTU4", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496562158", "createdAt": "2020-09-25T16:14:05Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDowNVrOHYKEdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDowNVrOHYKEdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5Mjg1Mw==", "bodyText": "rename to role", "url": "https://github.com/dotCMS/core/pull/19326#discussion_r495092853", "createdAt": "2020-09-25T16:14:05Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -1415,24 +1415,35 @@ private boolean isHost(final Permissionable permissionable) {\n \r\n \t@Override\r\n     public boolean doesUserHavePermissions(PermissionableType permType, int permissionType, User user) throws DotDataException {\r\n-    \tif(user==null) return false;\r\n+    \treturn doesUserHavePermissions(null,permType,permissionType,user);\r\n+    }\r\n+\r\n+\t@Override\r\n+\tpublic boolean doesUserHavePermissions(final String assetId, final PermissionableType permType, final int permissionType, final User user) throws DotDataException {\r\n+\t\tif(user==null) return false;\r\n \r\n-    \tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r\n+\t\tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r\n \r\n-    \tBoolean hasPerm = false;\r\n-    \tRoleAPI roleAPI = APILocator.getRoleAPI();\r\n-\t\tList<com.dotmarketing.business.Role> roles = roleAPI.loadRolesForUser(user.getUserId(), false);\r\n-\t\tfor(com.dotmarketing.business.Role r : roles) {\r\n+\t\tBoolean hasPerm = false;\r\n+\t\tfinal RoleAPI roleAPI = APILocator.getRoleAPI();\r\n+\t\tfinal List<com.dotmarketing.business.Role> roles = roleAPI.loadRolesForUser(user.getUserId(), false);\r\n+\t\tfor(final com.dotmarketing.business.Role r : roles) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYyMjU3", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496562257", "createdAt": "2020-09-25T16:14:14Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDoxNFrOHYKEuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDoxNFrOHYKEuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MjkyMA==", "bodyText": "use curly brackets", "url": "https://github.com/dotCMS/core/pull/19326#discussion_r495092920", "createdAt": "2020-09-25T16:14:14Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -1415,24 +1415,35 @@ private boolean isHost(final Permissionable permissionable) {\n \r\n \t@Override\r\n     public boolean doesUserHavePermissions(PermissionableType permType, int permissionType, User user) throws DotDataException {\r\n-    \tif(user==null) return false;\r\n+    \treturn doesUserHavePermissions(null,permType,permissionType,user);\r\n+    }\r\n+\r\n+\t@Override\r\n+\tpublic boolean doesUserHavePermissions(final String assetId, final PermissionableType permType, final int permissionType, final User user) throws DotDataException {\r\n+\t\tif(user==null) return false;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYyMzYz", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496562363", "createdAt": "2020-09-25T16:14:24Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDoyNVrOHYKFDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDoyNVrOHYKFDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MzAwNQ==", "bodyText": "use curly brackets", "url": "https://github.com/dotCMS/core/pull/19326#discussion_r495093005", "createdAt": "2020-09-25T16:14:25Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -1415,24 +1415,35 @@ private boolean isHost(final Permissionable permissionable) {\n \r\n \t@Override\r\n     public boolean doesUserHavePermissions(PermissionableType permType, int permissionType, User user) throws DotDataException {\r\n-    \tif(user==null) return false;\r\n+    \treturn doesUserHavePermissions(null,permType,permissionType,user);\r\n+    }\r\n+\r\n+\t@Override\r\n+\tpublic boolean doesUserHavePermissions(final String assetId, final PermissionableType permType, final int permissionType, final User user) throws DotDataException {\r\n+\t\tif(user==null) return false;\r\n \r\n-    \tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r\n+\t\tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYyNTU2", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496562556", "createdAt": "2020-09-25T16:14:39Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDo0MFrOHYKFoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxNDo0MFrOHYKFoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MzE1Mw==", "bodyText": "rename to permission", "url": "https://github.com/dotCMS/core/pull/19326#discussion_r495093153", "createdAt": "2020-09-25T16:14:40Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -1415,24 +1415,35 @@ private boolean isHost(final Permissionable permissionable) {\n \r\n \t@Override\r\n     public boolean doesUserHavePermissions(PermissionableType permType, int permissionType, User user) throws DotDataException {\r\n-    \tif(user==null) return false;\r\n+    \treturn doesUserHavePermissions(null,permType,permissionType,user);\r\n+    }\r\n+\r\n+\t@Override\r\n+\tpublic boolean doesUserHavePermissions(final String assetId, final PermissionableType permType, final int permissionType, final User user) throws DotDataException {\r\n+\t\tif(user==null) return false;\r\n \r\n-    \tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r\n+\t\tif(APILocator.getUserAPI().isCMSAdmin(user)) return true;\r\n \r\n-    \tBoolean hasPerm = false;\r\n-    \tRoleAPI roleAPI = APILocator.getRoleAPI();\r\n-\t\tList<com.dotmarketing.business.Role> roles = roleAPI.loadRolesForUser(user.getUserId(), false);\r\n-\t\tfor(com.dotmarketing.business.Role r : roles) {\r\n+\t\tBoolean hasPerm = false;\r\n+\t\tfinal RoleAPI roleAPI = APILocator.getRoleAPI();\r\n+\t\tfinal List<com.dotmarketing.business.Role> roles = roleAPI.loadRolesForUser(user.getUserId(), false);\r\n+\t\tfor(final com.dotmarketing.business.Role r : roles) {\r\n \t\t\tList<Permission> perms = APILocator.getPermissionAPI().getPermissionsByRole(r, false);\r\n-\t\t\tfor (Permission p : perms) {\r\n+\t\t\tif(UtilMethods.isSet(assetId)) {\r\n+\t\t\t\tperms = perms.stream()\r\n+\t\t\t\t\t\t.filter(permission -> permission.getInode().equalsIgnoreCase(assetId))\r\n+\t\t\t\t\t\t.collect(\r\n+\t\t\t\t\t\t\t\tCollectors.toList());\r\n+\t\t\t}\r\n+\t\t\tfor (final Permission p : perms) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTYzODIx", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496563821", "createdAt": "2020-09-25T16:16:25Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTY3MTM1", "url": "https://github.com/dotCMS/core/pull/19326#pullrequestreview-496567135", "createdAt": "2020-09-25T16:21:01Z", "commit": {"oid": "97cd7ea03d7a3978f3f4f24817e9d98fa0987357"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0697b2fd86122de66d7efd2fa7d451055578932", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/f0697b2fd86122de66d7efd2fa7d451055578932", "committedDate": "2020-09-25T16:41:28Z", "message": "#8538 #19267 feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 636, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}