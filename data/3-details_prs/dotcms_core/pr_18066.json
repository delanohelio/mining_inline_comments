{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTYyNjU4", "number": 18066, "title": "Fixing rule permission bug", "bodyText": "Fixing: #17901 (comment)\n\nUsing the host object allow to check the permission correctly\n\nhttps://github.com/dotCMS/core/compare/issue-17901-Unable-to-create-rules?expand=1#diff-8861622cb5192fca78268f8d23179f81R89\n\nNot catch the DotSecurityException to let the DotSecurityExceptionMapper  catch it, and response with the right format, this avoid a blank page when the user does not have permission\n\nhttps://github.com/dotCMS/core/compare/issue-17901-Unable-to-create-rules?expand=1#diff-8861622cb5192fca78268f8d23179f81L231", "createdAt": "2020-02-28T19:43:05Z", "url": "https://github.com/dotCMS/core/pull/18066", "merged": true, "mergeCommit": {"oid": "b892cdcfcf0d0152cc37f19ac57439b6dd1e5e4b"}, "closed": true, "closedAt": "2020-02-28T22:45:52Z", "author": {"login": "freddyucv"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI0xBUgH2gAyMzgxNTYyNjU4OjRkNTg1M2NjY2NmZWEwZjExM2RiYmNjNWM5Zjk4NTc5MDg1YzY4ZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcI2tl-gFqTM2NjY5MzE0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d5853ccccfea0f113dbbcc5c9f98579085c68dc", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/4d5853ccccfea0f113dbbcc5c9f98579085c68dc", "committedDate": "2020-02-28T19:06:05Z", "message": "Fixing rule permission bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjY3MzIz", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366667323", "createdAt": "2020-02-28T20:31:08Z", "commit": {"oid": "4d5853ccccfea0f113dbbcc5c9f98579085c68dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjcxNzIw", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366671720", "createdAt": "2020-02-28T20:39:46Z", "commit": {"oid": "4d5853ccccfea0f113dbbcc5c9f98579085c68dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44413a3a9ead5814a6a5c5f384aafe58a99b5050", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/44413a3a9ead5814a6a5c5f384aafe58a99b5050", "committedDate": "2020-02-28T20:40:46Z", "message": "#17901 testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/0548ce1d1025ffc9fd82e5a2480544fbb14e1985", "committedDate": "2020-02-28T20:52:13Z", "message": "#17901 refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjgyOTQz", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366682943", "createdAt": "2020-02-28T21:01:52Z", "commit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1MlrOFwCtaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1MlrOFwCtaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM2MQ==", "bodyText": "Issue found: Avoid reassigning parameters such as 'siteId'", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920361", "createdAt": "2020-02-28T21:01:52Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -77,11 +79,15 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     @Path(\"/rules\")\n     @NoCache\n     @Produces({MediaType.APPLICATION_JSON, \"application/javascript\"})\n-    public Map<String, RestRule> list(@Context HttpServletRequest request, @Context final HttpServletResponse response, @PathParam(\"siteId\") String siteId) {\n+    public Map<String, RestRule> list(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjgyOTU4", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366682958", "createdAt": "2020-02-28T21:01:54Z", "commit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1NFrOFwCtdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1NFrOFwCtdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM3Mw==", "bodyText": "Issue found: The String literal \"siteId\" appears 5 times in this file; the first occurrence is on line 85", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920373", "createdAt": "2020-02-28T21:01:54Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/sites/ruleengine/rules/RuleResource.java", "diffHunk": "@@ -77,11 +79,15 @@ protected RuleResource(ApiProvider apiProvider, WebResource webResource) {\n     @Path(\"/rules\")\n     @NoCache\n     @Produces({MediaType.APPLICATION_JSON, \"application/javascript\"})\n-    public Map<String, RestRule> list(@Context HttpServletRequest request, @Context final HttpServletResponse response, @PathParam(\"siteId\") String siteId) {\n+    public Map<String, RestRule> list(\n+            @Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"siteId\") String siteId) throws DotSecurityException, DotDataException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjgyOTY5", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366682969", "createdAt": "2020-02-28T21:01:55Z", "commit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1NVrOFwCthA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMTowMTo1NVrOFwCthA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMDM4OA==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385920388", "createdAt": "2020-02-28T21:01:55Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -7,10 +7,7 @@\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n import com.dotmarketing.beans.Permission;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.CacheLocator;\n-import com.dotmarketing.business.PermissionAPI;\n-import com.dotmarketing.business.Role;\n+import com.dotmarketing.business.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjkzMTQ0", "url": "https://github.com/dotCMS/core/pull/18066#pullrequestreview-366693144", "createdAt": "2020-02-28T21:22:08Z", "commit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMToyMjowOVrOFwDL3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMToyMjowOVrOFwDL3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyODE1OA==", "bodyText": "let's add a finally to remove created stuff", "url": "https://github.com/dotCMS/core/pull/18066#discussion_r385928158", "createdAt": "2020-02-28T21:22:09Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -52,6 +51,74 @@ public static void prepare() throws Exception {\n         rulesAPI   = APILocator.getRulesAPI();\n     }\n \n+    /**\n+     * Method to Test: {@link RulesAPIImpl#getAllRulesByParent(Ruleable, User, boolean)}\n+     * When: User with permission try to get all the rules from host\n+     * Should: Return all the rules from the host\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldGetRules() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule1 = new RuleDataGen().host(host).nextPersisted();\n+        final Rule rule2 = new RuleDataGen().host(host).nextPersisted();\n+\n+        final Host anotherHost = new SiteDataGen().nextPersisted();\n+        final Rule rule3 = new RuleDataGen().host(anotherHost).nextPersisted();\n+\n+        this.addPermission(role, host, false);\n+        final List<Rule> rules = rulesAPI.getAllRulesByParent(host, user, false);\n+\n+        assertEquals(2, rules.size());\n+\n+        final List<String> rulesId = rules.stream().map(rule -> rule.getId()).collect(Collectors.toList());\n+        assertTrue(rulesId.contains(rule1.getId()));\n+        assertTrue(rulesId.contains(rule2.getId()));\n+        assertFalse(rulesId.contains(rule3.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0548ce1d1025ffc9fd82e5a2480544fbb14e1985"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1131, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}