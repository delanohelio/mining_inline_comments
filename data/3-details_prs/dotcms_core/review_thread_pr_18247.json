{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3Mjg2MTQ0", "number": 18247, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMTo0MlrODt-ebA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjozN1rODt-gEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM2MTA4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMTo0MlrOF_tm1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODowNjowNlrOGEvdfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA==", "bodyText": "why is not it  just do 'SELECT 1 FROM dot_cluster LIMIT 1'?, really we don't need to count, also we can do it for every data base.", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402351828", "createdAt": "2020-04-02T14:21:42Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1NDk1Nw==", "bodyText": "It is as lightweight as we can make it while trying to avoid a full table scan in postgres.  The switch to using the dot_cluster table means that at most there will be 1 record in any dotCMS db which should be good enough for most other dbs.", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402354957", "createdAt": "2020-04-02T14:25:50Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDU1NQ==", "bodyText": "do you think this improvement applies for others DBs as well?", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402394555", "createdAt": "2020-04-02T15:15:28Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzOTEwMA==", "bodyText": "\"The switch to using the dot_cluster table means that at most there will be 1 record in any dotCMS db\", that is why I said that really we don't need to count", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r403039100", "createdAt": "2020-04-03T14:19:37Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyNTA4NA==", "bodyText": "A count is going to obviously be performant in a table with 1 record.  I think it is ok as is.", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r407625084", "createdAt": "2020-04-13T18:06:06Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTgyOA=="}, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM2NTI5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjozN1rOF_tpig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjozN1rOF_tpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjUyMg==", "bodyText": "I think is good idea so some test here, we can test this method\n\n  \n    \n      core/dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java\n    \n    \n         Line 87\n      in\n      cb55653\n    \n    \n    \n    \n\n        \n          \n           MonitorStats getMonitorStats() throws Throwable{", "url": "https://github.com/dotCMS/core/pull/18247#discussion_r402352522", "createdAt": "2020-04-02T14:22:37Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rest/api/v1/system/monitor/MonitorHelper.java", "diffHunk": "@@ -117,9 +117,12 @@ private boolean isDBHealthy(final long timeOut) throws Throwable {\n                 .get(this.failFastBooleanPolicy(timeOut, () -> {\n                     try{\n                         final DotConnect dc = new DotConnect();\n-                        dc.setSQL(\"select count(*) as count from contentlet\");\n-                        final List<Map<String,String>> results = dc.loadResults();\n-                        return Long.parseLong(results.get(0).get(\"count\")) > 0;\n+                        if(DbConnectionFactory.isPostgres()) {\n+                            return dc.setSQL(\"SELECT count(*) as count FROM (SELECT 1 FROM dot_cluster LIMIT 1) AS t\").getInt(\"count\")>0;\n+                        }\n+                        else {\n+                            return  dc.setSQL(\"SELECT count(*) as count from dot_cluster\").getInt(\"count\")>0;\n+                        }\n                     }\n                     finally{\n                         DbConnectionFactory.closeSilently();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb55653f54650bf09e71591bffe14db1bf20d566"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2435, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}