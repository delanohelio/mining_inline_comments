{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjEyNDg4", "number": 18300, "title": "#18292 Fix: error when try to submit a form", "bodyText": "the Actionlet to save and save draft a Contentlet were hard coding the respectFrontendRoles parameter.\nhttps://github.com/dotCMS/core/compare/issue-18292-When-try-to-submit-a-form-get-permission-error?expand=1#diff-013f41c9cebd179a7239798b2e45fb94R120\nAlso I did a refactoring in 'checkin' method permission checking\n6ec5646#diff-0e42bc8d57cb229663e56b48259b767dL4393", "createdAt": "2020-04-09T19:49:53Z", "url": "https://github.com/dotCMS/core/pull/18300", "merged": true, "mergeCommit": {"oid": "494914b12b21b3f38e5ef650ea413b8932ba1082"}, "closed": true, "closedAt": "2020-04-17T22:51:10Z", "author": {"login": "freddyucv"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWB5H_gH2gAyNDAxNjEyNDg4OjQ4ZGU5NGJhMmNkYjg3NGEzYjFlNDhmYjZkOTljNzJhMGJiN2EyNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYoij4gFqTM5NTc5NDkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249", "committedDate": "2020-04-09T19:44:43Z", "message": "#18292 Fix: error when try to submit a form"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTA3Mjkw", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-391107290", "createdAt": "2020-04-09T20:25:27Z", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyNToyN1rOGDoKOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyNToyN1rOGDoKOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1Njg5MQ==", "bodyText": "I think there are more places to change on the saveDraft, where the respect front end roles is being hardcored", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r406456891", "createdAt": "2020-04-09T20:25:27Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -7835,7 +7833,7 @@ public Contentlet saveDraft(final Contentlet contentlet,\n             throws IllegalArgumentException,DotDataException,DotSecurityException, DotContentletStateException, DotContentletValidationException {\n \n         if (!InodeUtils.isSet(contentlet.getInode())) {\n-            return checkin(contentlet, contentletRelationships, cats, permissions, user, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTA3OTIy", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-391107922", "createdAt": "2020-04-09T20:26:30Z", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyNjozMFrOGDoMPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyNjozMFrOGDoMPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NzQwNQ==", "bodyText": "I think SaveContentlet needs the same", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r406457405", "createdAt": "2020-04-09T20:26:30Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentAsDraftActionlet.java", "diffHunk": "@@ -29,16 +31,27 @@\n public class SaveContentAsDraftActionlet extends WorkFlowActionlet {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTY5ODkz", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-391169893", "createdAt": "2020-04-09T22:20:55Z", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjoyMDo1NVrOGDrX1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjoyMDo1NVrOGDrX1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUwOTUyNg==", "bodyText": "I think this constructor doesn't need to be public", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r406509526", "createdAt": "2020-04-09T22:20:55Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentAsDraftActionlet.java", "diffHunk": "@@ -29,16 +31,27 @@\n public class SaveContentAsDraftActionlet extends WorkFlowActionlet {\n \n \tprivate final ContentletAPI   contentletAPI;\n-\tprivate final RelationshipAPI relationshipAPI;\n \tprivate final CategoryAPI     categoryAPI;\n \tprivate final PermissionAPI   permissionAPI;\n \n \tpublic SaveContentAsDraftActionlet() {\n+\t\tthis(\n+\t\t\tAPILocator.getContentletAPI(),\n+\t\t\tAPILocator.getCategoryAPI(),\n+\t\t\tAPILocator.getPermissionAPI()\n+\t\t);\n+\t}\n+\n+\t@VisibleForTesting\n+\tpublic SaveContentAsDraftActionlet(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTcwNDcy", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-391170472", "createdAt": "2020-04-09T22:22:22Z", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjoyMjoyMlrOGDrZrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjoyMjoyMlrOGDrZrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUwOTk5OQ==", "bodyText": "remove this commented line", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r406509999", "createdAt": "2020-04-09T22:22:22Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentAsDraftActionletTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.categories.business.CategoryAPI;\n+import com.dotmarketing.portlets.categories.model.Category;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.structure.model.ContentletRelationships;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.mockito.Mockito.*;\n+\n+@RunWith(DataProviderRunner.class)\n+public class SaveContentAsDraftActionletTest {\n+\n+    private SaveContentAsDraftActionlet saveContentAsDraftActionlet;\n+    private ContentletAPI contentletAPI;\n+    private CategoryAPI categoryAPI;\n+    private PermissionAPI permissionAPI;\n+\n+    @Before\n+    public void init(){\n+        contentletAPI = mock(ContentletAPI.class);\n+        categoryAPI = mock(CategoryAPI.class);\n+        permissionAPI = mock(PermissionAPI.class);\n+\n+        saveContentAsDraftActionlet = new SaveContentAsDraftActionlet(contentletAPI, categoryAPI, permissionAPI);\n+    }\n+\n+    private static class TestCase {\n+        final private boolean respectFrontendRoles;\n+\n+        private TestCase(boolean respectFrontendRoles) {\n+            this.respectFrontendRoles = respectFrontendRoles;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] respectFrontendRolesValues() {\n+        return new TestCase[]{new TestCase(true), new TestCase(false)};\n+    }\n+\n+    /**\n+     * When: {@link WorkflowProcessor#getContentletDependencies()} is not null\n+     * Should: call {@link ContentletAPI#saveDraft(Contentlet, Map, List, List, User, boolean)} with the right parameters\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    @UseDataProvider(\"respectFrontendRolesValues\")\n+    public void shouldCallSaveDraftWithTheRightParameters(final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowProcessor processor = mock(WorkflowProcessor.class);\n+        final Map<String, WorkflowActionClassParameter> params = map();\n+\n+        final Contentlet contentlet = mock(Contentlet.class);\n+        final User user  = mock(User.class);\n+\n+        when(processor.getUser()).thenReturn(user);\n+        when(processor.getContentlet()).thenReturn(contentlet);\n+\n+        List<Category> categories = mock(List.class);\n+\n+        final List<Permission> permissions = mock(List.class);\n+        when(this.permissionAPI.getPermissions(contentlet, false, true)).thenReturn(permissions);\n+\n+        final ContentletDependencies contentletDependencies = mock(ContentletDependencies.class);\n+        when(processor.getContentletDependencies()).thenReturn(contentletDependencies);\n+\n+        final Contentlet contentletNew = mock(Contentlet.class);\n+        when(contentletDependencies.getCategories()).thenReturn(categories);\n+\n+        when(processor.getContentletDependencies().isRespectAnonymousPermissions()).thenReturn(testCase.respectFrontendRoles);\n+\n+        when(this.contentletAPI.saveDraft(\n+                contentlet, (ContentletRelationships) null, categories, permissions, user, testCase.respectFrontendRoles))\n+                .thenReturn(contentletNew);\n+\n+        saveContentAsDraftActionlet.executeAction(processor, params);\n+\n+        //verify(processor, times(1)).setContentlet(contentletNew);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzI2MDM2", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-392326036", "createdAt": "2020-04-13T18:10:10Z", "commit": {"oid": "48de94ba2cdb874a3b1e48fb6d99c72a0bb7a249"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa3444ac01b694697c3580a424d7e3566aabc35", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/1aa3444ac01b694697c3580a424d7e3566aabc35", "committedDate": "2020-04-13T20:08:12Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec56462ac0e4aa37aba4848e2acd55943dfea20", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/6ec56462ac0e4aa37aba4848e2acd55943dfea20", "committedDate": "2020-04-15T14:25:07Z", "message": "refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODY3MTg0", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-393867184", "createdAt": "2020-04-15T15:06:44Z", "commit": {"oid": "6ec56462ac0e4aa37aba4848e2acd55943dfea20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTAyNjg2", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-393902686", "createdAt": "2020-04-15T15:44:37Z", "commit": {"oid": "6ec56462ac0e4aa37aba4848e2acd55943dfea20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a55c5cbe5fda751ac68a5ab2e141ef85498022c", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/5a55c5cbe5fda751ac68a5ab2e141ef85498022c", "committedDate": "2020-04-15T16:02:54Z", "message": "refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbf178ca1ddda41914c6094aff0842a6491dc75c", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/bbf178ca1ddda41914c6094aff0842a6491dc75c", "committedDate": "2020-04-15T20:22:13Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad480cb6770029865e6ece0d4ab74470a08384b5", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/ad480cb6770029865e6ece0d4ab74470a08384b5", "committedDate": "2020-04-16T15:15:49Z", "message": "#18300 testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "408a922f3c11bf07b47c07cbd96e678467fcfbef", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/408a922f3c11bf07b47c07cbd96e678467fcfbef", "committedDate": "2020-04-16T17:42:40Z", "message": "#18292 testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a959e06e9aec0dd4f08d061c17e373c9b9aab905", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/a959e06e9aec0dd4f08d061c17e373c9b9aab905", "committedDate": "2020-04-16T19:01:50Z", "message": "#18292 testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905288f487833e18bfca9394a8bc2c32d98dd3bb", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/905288f487833e18bfca9394a8bc2c32d98dd3bb", "committedDate": "2020-04-16T20:25:20Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c684c988033d0a0eedf5d94acc7df6dde5508816", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/c684c988033d0a0eedf5d94acc7df6dde5508816", "committedDate": "2020-04-16T21:50:31Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b659bb20216e24d87807351b41481805392a361a", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/b659bb20216e24d87807351b41481805392a361a", "committedDate": "2020-04-16T22:39:58Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d6aeec97c63e9699d66a5c806a9f2c3359cbbc", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/03d6aeec97c63e9699d66a5c806a9f2c3359cbbc", "committedDate": "2020-04-17T13:48:58Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86ba376e84ff3b9de4f9b33cba8296f22db645c", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/a86ba376e84ff3b9de4f9b33cba8296f22db645c", "committedDate": "2020-04-17T17:47:49Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe932565ee8beb1bddb018dfc607d9dd5ecf4fab", "author": {"user": {"login": "freddyucv", "name": "Freddy Rodriguez"}}, "url": "https://github.com/dotCMS/core/commit/fe932565ee8beb1bddb018dfc607d9dd5ecf4fab", "committedDate": "2020-04-17T21:22:48Z", "message": "Merge remote-tracking branch 'origin/master' into issue-18292-When-try-to-submit-a-form-get-permission-error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9", "author": {"user": {"login": "freddyucv", "name": "Freddy Rodriguez"}}, "url": "https://github.com/dotCMS/core/commit/c31a385f03597c5ec2bc9d6416418c3a61c1e6f9", "committedDate": "2020-04-17T21:39:50Z", "message": "#18292 Testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0Nzc3", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794777", "createdAt": "2020-04-17T21:53:57Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1Mzo1OFrOGHeNng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1Mzo1OFrOGHeNng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODIyMg==", "bodyText": "Issue found: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488222", "createdAt": "2020-04-17T21:53:58Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -83,48 +188,96 @@ private static ContentType createTestType(final ContentTypeAPI contentTypeAPI)\n     @AfterClass\n     public static void cleanup()\n             throws DotDataException, DotSecurityException {\n+        for (final ContentType contentType : contentTypes) {\n+            if (null != contentType) {\n \n-        if (null != customContentType) {\n-\n-            final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n-            contentTypeAPI.delete(customContentType);\n+                final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+                contentTypeAPI.delete(contentType);\n+            }\n         }\n \n         cleanupDebug(SaveContentActionletTest.class);\n     } // cleanup\n \n+    /**\n+     * Method to test: {@link WorkflowAPI#fireContentWorkflow(Contentlet, ContentletDependencies)}\n+     * Given Scenario: Try to Save and publish a {@link Contentlet} with different users, when the ContentType does not\n+     * have a 'Site or folder' field\n+     * Expected Result: The follow are the expected result according to the user\n+     * - If the user is system should save and publish the contentlet\n+     * - If the user have {@link PermissionLevel#CAN_ADD_CHILDREN} over the ContentType\n+     * - If the user doesn't have any permission should throw a DotSecurityException when try to save it\n+     * - If the user just has {@link PermissionLevel#CAN_ADD_CHILDREN} over the save {@link ContentType} then should throw a DotSecurityException when try to save it\n+     */\n     @Test\n-    public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurityException, DotDataException {\n+    @UseDataProvider(\"usersAndContentTypeWithoutHostField\")\n+    public void test_Publish_With_Save_Contentlet (final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowAPI workflowAPI = APILocator.getWorkflowAPI();\n \n-        final Contentlet contentlet = new Contentlet();\n-        contentlet.setContentType(customContentType);\n-        contentlet.setProperty(\"title\", \"Test\");\n-        contentlet.setProperty(\"txt\", \"Test\");\n-        contentlet.setProperty(\"tag\", \"test\");\n+        final Contentlet contentlet = new ContentletDataGen(testCase.contentType.id())\n+            .setProperty(\"title\", \"Test\")\n+            .setProperty(\"txt\", \"Test\")\n+            .setProperty(\"tag\", \"test\")\n+            .next();\n \n-        final Contentlet contentletSaved =\n-                workflowAPI.fireContentWorkflow(contentlet,\n-                    new ContentletDependencies.Builder()\n-                        .modUser(APILocator.systemUser())\n-                        .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n-                        .build());\n+        Contentlet contentletSaved = null;\n \n-        Assert.assertNotNull(contentletSaved);\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"title\"));\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"txt\"));\n+        try {\n+            contentletSaved =\n+                    workflowAPI.fireContentWorkflow(contentlet,\n+                            new ContentletDependencies.Builder()\n+                                    .modUser(testCase.user)\n+                                    .respectAnonymousPermissions(testCase.respectFrontendRoles)\n+                                    .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n+                                    .build());\n \n-        final List<TagInode> tagInodes = APILocator.getTagAPI().getTagInodesByInode(contentletSaved.getInode());\n-        Assert.assertNotNull(tagInodes);\n-        Assert.assertFalse(tagInodes.isEmpty());\n+            checkContentSaved(contentletSaved);\n+\n+            Assert.assertTrue(\n+                    testCase.hasContentTypeAddChildrenPermission &&\n+                            testCase.hasSaveActionPermission ||\n+                            (testCase.respectFrontendRoles && this.haveFrontendPermission(testCase.contentType))\n+            );\n+        } catch(Exception e) {\n+            if (ExceptionUtil.causedBy(e, DotSecurityException.class)) {\n+                try {\n+                    Assert.assertTrue(\n+                            !testCase.hasContentTypeAddChildrenPermission ||\n+                                    !testCase.hasSaveActionPermission ||\n+                                    (systemUser.isFrontendUser() && !testCase.respectFrontendRoles)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 273}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0Nzkx", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794791", "createdAt": "2020-04-17T21:53:59Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1Mzo1OVrOGHeNpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1Mzo1OVrOGHeNpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODIyOQ==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488229", "createdAt": "2020-04-17T21:53:59Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.jetbrains.annotations.NotNull;\n import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.*;\n \n+import static com.dotcms.util.CollectionsUtils.list;\n+import static com.dotcms.util.CollectionsUtils.set;\n+\n+@RunWith(DataProviderRunner.class)\n public class SaveContentActionletTest extends BaseWorkflowIntegrationTest {\n \n-    private static WorkflowAPI workflowAPI = null;\n-    private static ContentTypeAPI contentTypeAPI = null;\n-    private static ContentType customContentType = null;\n-    private static final int LIMIT = 20;\n+    private static User systemUser = APILocator.systemUser();\n+    private static List<ContentType> contentTypes = new ArrayList<>();\n+\n+    private static class TestCase {\n+        private final boolean respectFrontendRoles;\n+        private final User user;\n+        private final boolean hasSaveActionPermission;\n+        private final boolean hasContentTypeAddChildrenPermission;\n+        private final ContentType contentType;\n+\n+        private TestCase(\n+                final boolean respectFrontendRoles,\n+                final User user,\n+                final ContentType contentType,\n+                final boolean hasSaveActionPermission,\n+                final boolean hasContentTypeAddChildrenPermission) {\n+            this.respectFrontendRoles = respectFrontendRoles;\n+            this.user = user;\n+            this.hasSaveActionPermission = hasSaveActionPermission;\n+            this.hasContentTypeAddChildrenPermission = hasContentTypeAddChildrenPermission;\n+            this.contentType = contentType;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] usersAndContentTypeWithoutHostField() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODAx", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794801", "createdAt": "2020-04-17T21:54:00Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMFrOGHeNrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMFrOGHeNrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODIzNg==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.util.CollectionsUtils.list'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488236", "createdAt": "2020-04-17T21:54:00Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.jetbrains.annotations.NotNull;\n import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.*;\n \n+import static com.dotcms.util.CollectionsUtils.list;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODA3", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794807", "createdAt": "2020-04-17T21:54:01Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMVrOGHeNsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMVrOGHeNsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI0Mg==", "bodyText": "Issue found: Avoid unused imports such as 'com.github.rjeschke.txtmark.Run'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488242", "createdAt": "2020-04-17T21:54:01Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODE2", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794816", "createdAt": "2020-04-17T21:54:02Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMlrOGHeNtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowMlrOGHeNtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI0Nw==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.portlets.workflows.business.WorkFlowFactory'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488247", "createdAt": "2020-04-17T21:54:02Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODIy", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794822", "createdAt": "2020-04-17T21:54:03Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowM1rOGHeNvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowM1rOGHeNvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI1Mg==", "bodyText": "Issue found: The String literal \"Test\" appears 6 times in this file; the first occurrence is on line 235", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488252", "createdAt": "2020-04-17T21:54:03Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -83,48 +188,96 @@ private static ContentType createTestType(final ContentTypeAPI contentTypeAPI)\n     @AfterClass\n     public static void cleanup()\n             throws DotDataException, DotSecurityException {\n+        for (final ContentType contentType : contentTypes) {\n+            if (null != contentType) {\n \n-        if (null != customContentType) {\n-\n-            final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n-            contentTypeAPI.delete(customContentType);\n+                final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+                contentTypeAPI.delete(contentType);\n+            }\n         }\n \n         cleanupDebug(SaveContentActionletTest.class);\n     } // cleanup\n \n+    /**\n+     * Method to test: {@link WorkflowAPI#fireContentWorkflow(Contentlet, ContentletDependencies)}\n+     * Given Scenario: Try to Save and publish a {@link Contentlet} with different users, when the ContentType does not\n+     * have a 'Site or folder' field\n+     * Expected Result: The follow are the expected result according to the user\n+     * - If the user is system should save and publish the contentlet\n+     * - If the user have {@link PermissionLevel#CAN_ADD_CHILDREN} over the ContentType\n+     * - If the user doesn't have any permission should throw a DotSecurityException when try to save it\n+     * - If the user just has {@link PermissionLevel#CAN_ADD_CHILDREN} over the save {@link ContentType} then should throw a DotSecurityException when try to save it\n+     */\n     @Test\n-    public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurityException, DotDataException {\n+    @UseDataProvider(\"usersAndContentTypeWithoutHostField\")\n+    public void test_Publish_With_Save_Contentlet (final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowAPI workflowAPI = APILocator.getWorkflowAPI();\n \n-        final Contentlet contentlet = new Contentlet();\n-        contentlet.setContentType(customContentType);\n-        contentlet.setProperty(\"title\", \"Test\");\n-        contentlet.setProperty(\"txt\", \"Test\");\n-        contentlet.setProperty(\"tag\", \"test\");\n+        final Contentlet contentlet = new ContentletDataGen(testCase.contentType.id())\n+            .setProperty(\"title\", \"Test\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 232}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODMy", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794832", "createdAt": "2020-04-17T21:54:04Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNFrOGHeNww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNFrOGHeNww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI1OQ==", "bodyText": "Issue found: Avoid throwing raw exception types.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488259", "createdAt": "2020-04-17T21:54:04Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -133,4 +286,78 @@ public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurit\n         Assert.assertTrue(contentletPublished.isLive());\n     }\n \n+    private void checkContentSaved(final Contentlet contentletSaved) throws DotDataException {\n+        Assert.assertNotNull(contentletSaved);\n+        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"title\"));\n+        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"txt\"));\n+\n+        final List<TagInode> tagInodes = APILocator.getTagAPI().getTagInodesByInode(contentletSaved.getInode());\n+        Assert.assertNotNull(tagInodes);\n+        Assert.assertFalse(tagInodes.isEmpty());\n+\n+        contentletSaved.setTags();\n+    }\n+\n+    @NotNull\n+    private static void addPermissionToAddChildren(final Role role, final ContentType contentType) throws DotDataException {\n+\n+        final Permission contentTypePermission = getPermission(role, contentType, PermissionLevel.WRITE.getType());\n+\n+        try {\n+\n+            APILocator.getPermissionAPI().save(contentTypePermission, contentType, systemUser, false);\n+\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @NotNull\n+    private static void addPermissionToActions(final Role role) throws DotDataException {\n+        final WorkflowAction saveAction = FactoryLocator.getWorkFlowFactory().findAction(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID);\n+        final WorkflowAction publishAction = FactoryLocator.getWorkFlowFactory().findAction(SystemWorkflowConstants.WORKFLOW_PUBLISH_ACTION_ID);\n+\n+        final Permission publishPermission = getPermission(role, publishAction, PermissionLevel.USE.getType());\n+        final Permission savePermission = getPermission(role, saveAction, PermissionLevel.USE.getType());\n+\n+        try {\n+             APILocator.getPermissionAPI().save(savePermission, saveAction, systemUser, false);\n+            APILocator.getPermissionAPI().save(publishPermission, publishAction, systemUser, false);\n+\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private static WorkflowAction getSaveActionFromSystemSchema(final String actionName){\n+\n+        try {\n+            final WorkflowScheme systemWorkflowScheme = APILocator.getWorkflowAPI().findSystemWorkflowScheme();\n+            final List<WorkflowAction> actions = APILocator.getWorkflowAPI().findActions(systemWorkflowScheme, systemUser);\n+\n+            for (final WorkflowAction workflowAction : actions) {\n+                if (workflowAction.getName().equals(actionName)) {\n+                    return workflowAction;\n+                }\n+            }\n+\n+        } catch (DotDataException | DotSecurityException e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 371}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODM1", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794835", "createdAt": "2020-04-17T21:54:05Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNVrOGHeNyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNVrOGHeNyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI2NQ==", "bodyText": "Issue found: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488265", "createdAt": "2020-04-17T21:54:05Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -83,48 +188,96 @@ private static ContentType createTestType(final ContentTypeAPI contentTypeAPI)\n     @AfterClass\n     public static void cleanup()\n             throws DotDataException, DotSecurityException {\n+        for (final ContentType contentType : contentTypes) {\n+            if (null != contentType) {\n \n-        if (null != customContentType) {\n-\n-            final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n-            contentTypeAPI.delete(customContentType);\n+                final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+                contentTypeAPI.delete(contentType);\n+            }\n         }\n \n         cleanupDebug(SaveContentActionletTest.class);\n     } // cleanup\n \n+    /**\n+     * Method to test: {@link WorkflowAPI#fireContentWorkflow(Contentlet, ContentletDependencies)}\n+     * Given Scenario: Try to Save and publish a {@link Contentlet} with different users, when the ContentType does not\n+     * have a 'Site or folder' field\n+     * Expected Result: The follow are the expected result according to the user\n+     * - If the user is system should save and publish the contentlet\n+     * - If the user have {@link PermissionLevel#CAN_ADD_CHILDREN} over the ContentType\n+     * - If the user doesn't have any permission should throw a DotSecurityException when try to save it\n+     * - If the user just has {@link PermissionLevel#CAN_ADD_CHILDREN} over the save {@link ContentType} then should throw a DotSecurityException when try to save it\n+     */\n     @Test\n-    public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurityException, DotDataException {\n+    @UseDataProvider(\"usersAndContentTypeWithoutHostField\")\n+    public void test_Publish_With_Save_Contentlet (final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowAPI workflowAPI = APILocator.getWorkflowAPI();\n \n-        final Contentlet contentlet = new Contentlet();\n-        contentlet.setContentType(customContentType);\n-        contentlet.setProperty(\"title\", \"Test\");\n-        contentlet.setProperty(\"txt\", \"Test\");\n-        contentlet.setProperty(\"tag\", \"test\");\n+        final Contentlet contentlet = new ContentletDataGen(testCase.contentType.id())\n+            .setProperty(\"title\", \"Test\")\n+            .setProperty(\"txt\", \"Test\")\n+            .setProperty(\"tag\", \"test\")\n+            .next();\n \n-        final Contentlet contentletSaved =\n-                workflowAPI.fireContentWorkflow(contentlet,\n-                    new ContentletDependencies.Builder()\n-                        .modUser(APILocator.systemUser())\n-                        .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n-                        .build());\n+        Contentlet contentletSaved = null;\n \n-        Assert.assertNotNull(contentletSaved);\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"title\"));\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"txt\"));\n+        try {\n+            contentletSaved =\n+                    workflowAPI.fireContentWorkflow(contentlet,\n+                            new ContentletDependencies.Builder()\n+                                    .modUser(testCase.user)\n+                                    .respectAnonymousPermissions(testCase.respectFrontendRoles)\n+                                    .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n+                                    .build());\n \n-        final List<TagInode> tagInodes = APILocator.getTagAPI().getTagInodesByInode(contentletSaved.getInode());\n-        Assert.assertNotNull(tagInodes);\n-        Assert.assertFalse(tagInodes.isEmpty());\n+            checkContentSaved(contentletSaved);\n+\n+            Assert.assertTrue(\n+                    testCase.hasContentTypeAddChildrenPermission &&\n+                            testCase.hasSaveActionPermission ||\n+                            (testCase.respectFrontendRoles && this.haveFrontendPermission(testCase.contentType))\n+            );\n+        } catch(Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 267}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODQz", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794843", "createdAt": "2020-04-17T21:54:06Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNlrOGHeNyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowNlrOGHeNyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI2Nw==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.business'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488267", "createdAt": "2020-04-17T21:54:06Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODU5", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794859", "createdAt": "2020-04-17T21:54:07Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowN1rOGHeN3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowN1rOGHeN3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI4NA==", "bodyText": "Issue found: Local variable 'categories' could be declared final", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488284", "createdAt": "2020-04-17T21:54:07Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentAsDraftActionletTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.categories.business.CategoryAPI;\n+import com.dotmarketing.portlets.categories.model.Category;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.structure.model.ContentletRelationships;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.mockito.Mockito.*;\n+\n+@RunWith(DataProviderRunner.class)\n+public class SaveContentAsDraftActionletTest {\n+\n+    private SaveContentAsDraftActionlet saveContentAsDraftActionlet;\n+    private ContentletAPI contentletAPI;\n+    private CategoryAPI categoryAPI;\n+    private PermissionAPI permissionAPI;\n+\n+    @Before\n+    public void init(){\n+        contentletAPI = mock(ContentletAPI.class);\n+        categoryAPI = mock(CategoryAPI.class);\n+        permissionAPI = mock(PermissionAPI.class);\n+\n+        saveContentAsDraftActionlet = new SaveContentAsDraftActionlet(contentletAPI, categoryAPI, permissionAPI);\n+    }\n+\n+    private static class TestCase {\n+        final private boolean respectFrontendRoles;\n+\n+        private TestCase(final boolean respectFrontendRoles) {\n+            this.respectFrontendRoles = respectFrontendRoles;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] respectFrontendRolesValues() {\n+        return new TestCase[]{new TestCase(true), new TestCase(false)};\n+    }\n+\n+    /**\n+     * When: {@link WorkflowProcessor#getContentletDependencies()} is not null\n+     * Should: call {@link ContentletAPI#saveDraft(Contentlet, Map, List, List, User, boolean)} with the right parameters\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    @UseDataProvider(\"respectFrontendRolesValues\")\n+    public void shouldCallSaveDraftWithTheRightParameters(final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowProcessor processor = mock(WorkflowProcessor.class);\n+        final Map<String, WorkflowActionClassParameter> params = map();\n+\n+        final Contentlet contentlet = mock(Contentlet.class);\n+        final User user  = mock(User.class);\n+\n+        when(processor.getUser()).thenReturn(user);\n+        when(processor.getContentlet()).thenReturn(contentlet);\n+\n+        final List<Category> categories = mock(List.class);\n+\n+        final List<Permission> permissions = mock(List.class);\n+        when(this.permissionAPI.getPermissions(contentlet, false, true)).thenReturn(permissions);\n+\n+        final ContentletDependencies contentletDependencies = mock(ContentletDependencies.class);\n+        when(processor.getContentletDependencies()).thenReturn(contentletDependencies);\n+\n+        final Contentlet contentletNew = mock(Contentlet.class);\n+        when(contentletDependencies.getCategories()).thenReturn(categories);\n+\n+        when(processor.getContentletDependencies().isRespectAnonymousPermissions()).thenReturn(testCase.respectFrontendRoles);\n+\n+        when(this.contentletAPI.saveDraft(\n+                contentlet, (ContentletRelationships) null, categories, permissions, user, testCase.respectFrontendRoles))\n+                .thenReturn(contentletNew);\n+\n+        saveContentAsDraftActionlet.executeAction(processor, params);\n+\n+        verify(processor, times(1)).setContentlet(contentletNew);\n+        verify(this.contentletAPI, times(1)).saveDraft(\n+                contentlet, (ContentletRelationships) null, categories, permissions, user, testCase.respectFrontendRoles\n+        );\n+\n+        verify(this.categoryAPI, never()).getParents(contentlet, user, false);\n+    }\n+\n+    /**\n+     * When: {@link WorkflowProcessor#getContentletDependencies()} is null\n+     * Should: call {@link ContentletAPI#saveDraft(Contentlet, Map, List, List, User, boolean)} with the right parameters\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    @UseDataProvider(\"respectFrontendRolesValues\")\n+    public void shouldCallSaveDraftWithTheRightParametersWhenContentletDependenciesIsNull(final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowProcessor processor = mock(WorkflowProcessor.class);\n+        final Map<String, WorkflowActionClassParameter> params = map();\n+\n+        final Contentlet contentlet = mock(Contentlet.class);\n+        final User user  = mock(User.class);\n+\n+        when(processor.getUser()).thenReturn(user);\n+        when(processor.getContentlet()).thenReturn(contentlet);\n+\n+        List<Category> categories = mock(List.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODcx", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794871", "createdAt": "2020-04-17T21:54:08Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowOFrOGHeN5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowOFrOGHeN5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODI5NA==", "bodyText": "Issue found: Avoid unused private methods such as 'getSaveActionFromSystemSchema(String)'.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488294", "createdAt": "2020-04-17T21:54:08Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -133,4 +286,78 @@ public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurit\n         Assert.assertTrue(contentletPublished.isLive());\n     }\n \n+    private void checkContentSaved(final Contentlet contentletSaved) throws DotDataException {\n+        Assert.assertNotNull(contentletSaved);\n+        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"title\"));\n+        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"txt\"));\n+\n+        final List<TagInode> tagInodes = APILocator.getTagAPI().getTagInodesByInode(contentletSaved.getInode());\n+        Assert.assertNotNull(tagInodes);\n+        Assert.assertFalse(tagInodes.isEmpty());\n+\n+        contentletSaved.setTags();\n+    }\n+\n+    @NotNull\n+    private static void addPermissionToAddChildren(final Role role, final ContentType contentType) throws DotDataException {\n+\n+        final Permission contentTypePermission = getPermission(role, contentType, PermissionLevel.WRITE.getType());\n+\n+        try {\n+\n+            APILocator.getPermissionAPI().save(contentTypePermission, contentType, systemUser, false);\n+\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @NotNull\n+    private static void addPermissionToActions(final Role role) throws DotDataException {\n+        final WorkflowAction saveAction = FactoryLocator.getWorkFlowFactory().findAction(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID);\n+        final WorkflowAction publishAction = FactoryLocator.getWorkFlowFactory().findAction(SystemWorkflowConstants.WORKFLOW_PUBLISH_ACTION_ID);\n+\n+        final Permission publishPermission = getPermission(role, publishAction, PermissionLevel.USE.getType());\n+        final Permission savePermission = getPermission(role, saveAction, PermissionLevel.USE.getType());\n+\n+        try {\n+             APILocator.getPermissionAPI().save(savePermission, saveAction, systemUser, false);\n+            APILocator.getPermissionAPI().save(publishPermission, publishAction, systemUser, false);\n+\n+        } catch (DotDataException | DotSecurityException e){\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private static WorkflowAction getSaveActionFromSystemSchema(final String actionName){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 358}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODgw", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794880", "createdAt": "2020-04-17T21:54:09Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowOVrOGHeN9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDowOVrOGHeN9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODMwOA==", "bodyText": "Issue found: Avoid unused imports such as 'org.mockito.Mockito'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488308", "createdAt": "2020-04-17T21:54:09Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentAsDraftActionletTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+package com.dotmarketing.portlets.workflows.actionlet;\n+\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.categories.business.CategoryAPI;\n+import com.dotmarketing.portlets.categories.model.Category;\n+import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n+import com.dotmarketing.portlets.structure.model.ContentletRelationships;\n+import com.dotmarketing.portlets.workflows.model.WorkflowActionClassParameter;\n+import com.dotmarketing.portlets.workflows.model.WorkflowProcessor;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.dotcms.util.CollectionsUtils.map;\n+import static org.mockito.Mockito.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODg0", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794884", "createdAt": "2020-04-17T21:54:10Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMFrOGHeN_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMFrOGHeN_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODMxNg==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.util.CollectionsUtils.set'", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488316", "createdAt": "2020-04-17T21:54:10Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.jetbrains.annotations.NotNull;\n import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.*;\n \n+import static com.dotcms.util.CollectionsUtils.list;\n+import static com.dotcms.util.CollectionsUtils.set;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODg5", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794889", "createdAt": "2020-04-17T21:54:11Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMVrOGHeOAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMVrOGHeOAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODMyMA==", "bodyText": "Issue found: Avoid unused local variables such as 'userWithPermission'.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488320", "createdAt": "2020-04-17T21:54:11Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.jetbrains.annotations.NotNull;\n import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.*;\n \n+import static com.dotcms.util.CollectionsUtils.list;\n+import static com.dotcms.util.CollectionsUtils.set;\n+\n+@RunWith(DataProviderRunner.class)\n public class SaveContentActionletTest extends BaseWorkflowIntegrationTest {\n \n-    private static WorkflowAPI workflowAPI = null;\n-    private static ContentTypeAPI contentTypeAPI = null;\n-    private static ContentType customContentType = null;\n-    private static final int LIMIT = 20;\n+    private static User systemUser = APILocator.systemUser();\n+    private static List<ContentType> contentTypes = new ArrayList<>();\n+\n+    private static class TestCase {\n+        private final boolean respectFrontendRoles;\n+        private final User user;\n+        private final boolean hasSaveActionPermission;\n+        private final boolean hasContentTypeAddChildrenPermission;\n+        private final ContentType contentType;\n+\n+        private TestCase(\n+                final boolean respectFrontendRoles,\n+                final User user,\n+                final ContentType contentType,\n+                final boolean hasSaveActionPermission,\n+                final boolean hasContentTypeAddChildrenPermission) {\n+            this.respectFrontendRoles = respectFrontendRoles;\n+            this.user = user;\n+            this.hasSaveActionPermission = hasSaveActionPermission;\n+            this.hasContentTypeAddChildrenPermission = hasContentTypeAddChildrenPermission;\n+            this.contentType = contentType;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] usersAndContentTypeWithoutHostField() throws Exception {\n+        // creates the type to trigger the scheme\n+        final ContentType contentType = createTestType();\n+        contentTypes.add(contentType);\n+\n+        final User userWithPermission = createUserWithPermission(contentType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0ODk2", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794896", "createdAt": "2020-04-17T21:54:12Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMlrOGHeOBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxMlrOGHeOBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODMyNQ==", "bodyText": "Issue found: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488325", "createdAt": "2020-04-17T21:54:12Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -83,48 +188,96 @@ private static ContentType createTestType(final ContentTypeAPI contentTypeAPI)\n     @AfterClass\n     public static void cleanup()\n             throws DotDataException, DotSecurityException {\n+        for (final ContentType contentType : contentTypes) {\n+            if (null != contentType) {\n \n-        if (null != customContentType) {\n-\n-            final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n-            contentTypeAPI.delete(customContentType);\n+                final ContentTypeAPI contentTypeAPI = APILocator.getContentTypeAPI(APILocator.systemUser());\n+                contentTypeAPI.delete(contentType);\n+            }\n         }\n \n         cleanupDebug(SaveContentActionletTest.class);\n     } // cleanup\n \n+    /**\n+     * Method to test: {@link WorkflowAPI#fireContentWorkflow(Contentlet, ContentletDependencies)}\n+     * Given Scenario: Try to Save and publish a {@link Contentlet} with different users, when the ContentType does not\n+     * have a 'Site or folder' field\n+     * Expected Result: The follow are the expected result according to the user\n+     * - If the user is system should save and publish the contentlet\n+     * - If the user have {@link PermissionLevel#CAN_ADD_CHILDREN} over the ContentType\n+     * - If the user doesn't have any permission should throw a DotSecurityException when try to save it\n+     * - If the user just has {@link PermissionLevel#CAN_ADD_CHILDREN} over the save {@link ContentType} then should throw a DotSecurityException when try to save it\n+     */\n     @Test\n-    public void test_Publish_With_Save_Contentlet_Actionlet_Tag () throws DotSecurityException, DotDataException {\n+    @UseDataProvider(\"usersAndContentTypeWithoutHostField\")\n+    public void test_Publish_With_Save_Contentlet (final TestCase testCase) throws DotSecurityException, DotDataException {\n+        final WorkflowAPI workflowAPI = APILocator.getWorkflowAPI();\n \n-        final Contentlet contentlet = new Contentlet();\n-        contentlet.setContentType(customContentType);\n-        contentlet.setProperty(\"title\", \"Test\");\n-        contentlet.setProperty(\"txt\", \"Test\");\n-        contentlet.setProperty(\"tag\", \"test\");\n+        final Contentlet contentlet = new ContentletDataGen(testCase.contentType.id())\n+            .setProperty(\"title\", \"Test\")\n+            .setProperty(\"txt\", \"Test\")\n+            .setProperty(\"tag\", \"test\")\n+            .next();\n \n-        final Contentlet contentletSaved =\n-                workflowAPI.fireContentWorkflow(contentlet,\n-                    new ContentletDependencies.Builder()\n-                        .modUser(APILocator.systemUser())\n-                        .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n-                        .build());\n+        Contentlet contentletSaved = null;\n \n-        Assert.assertNotNull(contentletSaved);\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"title\"));\n-        Assert.assertEquals(\"Test\", contentletSaved.getStringProperty(\"txt\"));\n+        try {\n+            contentletSaved =\n+                    workflowAPI.fireContentWorkflow(contentlet,\n+                            new ContentletDependencies.Builder()\n+                                    .modUser(testCase.user)\n+                                    .respectAnonymousPermissions(testCase.respectFrontendRoles)\n+                                    .workflowActionId(SystemWorkflowConstants.WORKFLOW_SAVE_ACTION_ID)\n+                                    .build());\n \n-        final List<TagInode> tagInodes = APILocator.getTagAPI().getTagInodesByInode(contentletSaved.getInode());\n-        Assert.assertNotNull(tagInodes);\n-        Assert.assertFalse(tagInodes.isEmpty());\n+            checkContentSaved(contentletSaved);\n+\n+            Assert.assertTrue(\n+                    testCase.hasContentTypeAddChildrenPermission &&\n+                            testCase.hasSaveActionPermission ||\n+                            (testCase.respectFrontendRoles && this.haveFrontendPermission(testCase.contentType))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 265}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzk0OTA0", "url": "https://github.com/dotCMS/core/pull/18300#pullrequestreview-395794904", "createdAt": "2020-04-17T21:54:13Z", "commit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxM1rOGHeODA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTo1NDoxM1rOGHeODA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODMzMg==", "bodyText": "Issue found: Avoid declaring a variable if it is unreferenced before a possible exit point.", "url": "https://github.com/dotCMS/core/pull/18300#discussion_r410488332", "createdAt": "2020-04-17T21:54:13Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/workflows/actionlet/SaveContentActionletTest.java", "diffHunk": "@@ -6,57 +6,155 @@\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.transform.contenttype.StructureTransformer;\n+import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.exception.ExceptionUtil;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.*;\n import com.dotmarketing.exception.DotDataException;\n import com.dotmarketing.exception.DotSecurityException;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n import com.dotmarketing.portlets.contentlet.model.ContentletDependencies;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n import com.dotmarketing.portlets.workflows.business.BaseWorkflowIntegrationTest;\n import com.dotmarketing.portlets.workflows.business.SystemWorkflowConstants;\n+import com.dotmarketing.portlets.workflows.business.WorkFlowFactory;\n import com.dotmarketing.portlets.workflows.business.WorkflowAPI;\n+import com.dotmarketing.portlets.workflows.model.WorkflowAction;\n import com.dotmarketing.portlets.workflows.model.WorkflowScheme;\n import com.dotmarketing.tag.model.TagInode;\n+import com.github.rjeschke.txtmark.Run;\n+import com.liferay.portal.model.User;\n+import com.tngtech.java.junit.dataprovider.DataProvider;\n+import com.tngtech.java.junit.dataprovider.DataProviderRunner;\n+import com.tngtech.java.junit.dataprovider.UseDataProvider;\n+import org.jetbrains.annotations.NotNull;\n import org.junit.AfterClass;\n import org.junit.Assert;\n import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n \n-import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.*;\n \n+import static com.dotcms.util.CollectionsUtils.list;\n+import static com.dotcms.util.CollectionsUtils.set;\n+\n+@RunWith(DataProviderRunner.class)\n public class SaveContentActionletTest extends BaseWorkflowIntegrationTest {\n \n-    private static WorkflowAPI workflowAPI = null;\n-    private static ContentTypeAPI contentTypeAPI = null;\n-    private static ContentType customContentType = null;\n-    private static final int LIMIT = 20;\n+    private static User systemUser = APILocator.systemUser();\n+    private static List<ContentType> contentTypes = new ArrayList<>();\n+\n+    private static class TestCase {\n+        private final boolean respectFrontendRoles;\n+        private final User user;\n+        private final boolean hasSaveActionPermission;\n+        private final boolean hasContentTypeAddChildrenPermission;\n+        private final ContentType contentType;\n+\n+        private TestCase(\n+                final boolean respectFrontendRoles,\n+                final User user,\n+                final ContentType contentType,\n+                final boolean hasSaveActionPermission,\n+                final boolean hasContentTypeAddChildrenPermission) {\n+            this.respectFrontendRoles = respectFrontendRoles;\n+            this.user = user;\n+            this.hasSaveActionPermission = hasSaveActionPermission;\n+            this.hasContentTypeAddChildrenPermission = hasContentTypeAddChildrenPermission;\n+            this.contentType = contentType;\n+        }\n+    }\n+\n+    @DataProvider\n+    public static Object[] usersAndContentTypeWithoutHostField() throws Exception {\n+        // creates the type to trigger the scheme\n+        final ContentType contentType = createTestType();\n+        contentTypes.add(contentType);\n+\n+        final User userWithPermission = createUserWithPermission(contentType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31a385f03597c5ec2bc9d6416418c3a61c1e6f9"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 972, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}