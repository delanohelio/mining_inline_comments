{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMzY4NDY0", "number": 19342, "title": "#19321 moving bundler to Resource, adding methods to BundleAPI", "bodyText": "", "createdAt": "2020-09-25T21:01:07Z", "url": "https://github.com/dotCMS/core/pull/19342", "merged": true, "mergeCommit": {"oid": "03abdcc0a8507ceeb21578b5760b108b4fa26aaf"}, "closed": true, "closedAt": "2020-10-09T15:37:35Z", "author": {"login": "wezell"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMcGHggH2gAyNDkzMzY4NDY0OmYwYWVkMzQ2N2I0NmVkNGI5NWQ5NmJlMTlhMTFhMTdkZWE1ZmM4MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQpEC6gFqTUwNTIwMTA5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0aed3467b46ed4b95d96be19a11a17dea5fc822", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/f0aed3467b46ed4b95d96be19a11a17dea5fc822", "committedDate": "2020-09-25T20:48:21Z", "message": "#19321 moving bundler to Resource, adding methods to BundleAPI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7548ec00613c194b2141ae2805352b51862967b6", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/7548ec00613c194b2141ae2805352b51862967b6", "committedDate": "2020-09-28T11:53:08Z", "message": "#19321 javadoc and convenience method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77be04b2248e909d9b59ab3b17e61c70d41942e0", "author": {"user": {"login": "wezell", "name": "Will Ezell"}}, "url": "https://github.com/dotCMS/core/commit/77be04b2248e909d9b59ab3b17e61c70d41942e0", "committedDate": "2020-09-28T15:20:00Z", "message": "#19321 removing unneeded class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzgyMTQ4", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-497782148", "createdAt": "2020-09-28T18:16:07Z", "commit": {"oid": "77be04b2248e909d9b59ab3b17e61c70d41942e0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4fb64e4ff65ff56b543c27ff451b5bc2f2f001f", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/a4fb64e4ff65ff56b543c27ff451b5bc2f2f001f", "committedDate": "2020-10-01T00:06:19Z", "message": "#19321 validations, small refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c04ec830a1b04e0940924ed9f6103b90d11e492c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/c04ec830a1b04e0940924ed9f6103b90d11e492c", "committedDate": "2020-10-01T00:06:53Z", "message": "#19321 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e492bd49d610c385b17532569abc98f3bc95de4a", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/e492bd49d610c385b17532569abc98f3bc95de4a", "committedDate": "2020-10-01T14:42:49Z", "message": "#19321 add class to mainsuite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9da1e35d3fadfcaa9feb30c1e9d9018b1125c6e9", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/9da1e35d3fadfcaa9feb30c1e9d9018b1125c6e9", "committedDate": "2020-10-01T14:46:28Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-19321"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f36638f61c85843e6246fd2828b1c696e1866fee", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/f36638f61c85843e6246fd2828b1c696e1866fee", "committedDate": "2020-10-01T16:50:36Z", "message": "#19321 improve message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "515fe10613951f2c71bcac69bb8c32e8a82e1280", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/515fe10613951f2c71bcac69bb8c32e8a82e1280", "committedDate": "2020-10-01T17:10:37Z", "message": "#19321 more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ae08d9818f9778ba7b10cc2f798a1933959aec", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/88ae08d9818f9778ba7b10cc2f798a1933959aec", "committedDate": "2020-10-02T14:47:45Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-19321"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d1224fa93410a6b4d6a0f81e56164dea39a10aa", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/3d1224fa93410a6b4d6a0f81e56164dea39a10aa", "committedDate": "2020-10-02T20:27:20Z", "message": "#19321 use asyncresponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/086545d55e6acdd8b1a50f396781eddcf14e519c", "committedDate": "2020-10-02T20:47:02Z", "message": "#19321 update tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTUyNTg1", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503152585", "createdAt": "2020-10-06T16:32:00Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozMjowMFrOHdQR0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozMjowMFrOHdQR0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzNzQ1OQ==", "bodyText": "Log here", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500437459", "createdAt": "2020-10-06T16:32:00Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/bundle/business/BundleAPIImpl.java", "diffHunk": "@@ -391,4 +395,42 @@ public void deleteAssetFromBundle(String assetId, String bundleId)\n \n \t}\n \n+\t/**\n+\t * This takes a Bundle, generates the folder/file structure and returns the resulting directory\n+\t * as a File handle. It will not delete the bundle directory if it already existed.\n+\t * @param bundle - Bundle to generate\n+\t * @return\n+\t */\n+    @CloseDBIfOpened\n+    private File generateBundleDirectory(final Bundle bundle) {\n+\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig(bundle);\n+        pushPublisherConfig.setPublishers(Arrays.asList(GenerateBundlePublisher.class));\n+        try {\n+            APILocator.getPublisherAPI().publish(pushPublisherConfig);\n+        }\n+        catch(Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU4MTY2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503158166", "createdAt": "2020-10-06T16:38:45Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozODo0NVrOHdQi5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozODo0NVrOHdQi5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0MTgyOA==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500441828", "createdAt": "2020-10-06T16:38:45Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,44 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+\n+\n+        List<File> files = FileUtil.listFilesRecursively(directory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU4MzQy", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503158342", "createdAt": "2020-10-06T16:38:57Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozODo1N1rOHdQjVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozODo1N1rOHdQjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0MTk0MQ==", "bodyText": "set to final rename to file", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500441941", "createdAt": "2020-10-06T16:38:57Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,44 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+\n+\n+        List<File> files = FileUtil.listFilesRecursively(directory);\n+\n+        Logger.info(PushUtils.class, \"Compressing \" + files.size() + \" to \" + tempFile.getAbsoluteFile());\n+        // Create the output stream for the output file\n+\n+        // try-with-resources handles close of streams\n+        try (OutputStream fos = Files.newOutputStream(tempFile.toPath());\n+                        // Wrap the output file stream in streams that will tar and gzip everything\n+                        TarArchiveOutputStream taos = new TarArchiveOutputStream(\n+                                        new GZIPOutputStream(new BufferedOutputStream(fos)))) {\n+\n+            taos.setBigNumberMode(TarArchiveOutputStream.BIGNUMBER_STAR);\n+            // TAR originally didn't support long file names, so enable the support for it\n+            taos.setLongFileMode(TarArchiveOutputStream.LONGFILE_GNU);\n+\n+            // Get to putting all the files in the compressed output file\n+            for (File f : files) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU4ODc3", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503158877", "createdAt": "2020-10-06T16:39:33Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozOTozNFrOHdQk6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozOTozNFrOHdQk6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0MjM0NA==", "bodyText": "rename to fileOutputStream", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500442344", "createdAt": "2020-10-06T16:39:34Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,44 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+\n+\n+        List<File> files = FileUtil.listFilesRecursively(directory);\n+\n+        Logger.info(PushUtils.class, \"Compressing \" + files.size() + \" to \" + tempFile.getAbsoluteFile());\n+        // Create the output stream for the output file\n+\n+        // try-with-resources handles close of streams\n+        try (OutputStream fos = Files.newOutputStream(tempFile.toPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU5MTA1", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503159105", "createdAt": "2020-10-06T16:39:48Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozOTo0OFrOHdQlng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjozOTo0OFrOHdQlng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0MjUyNg==", "bodyText": "Rename to tarArchiveOutputStream", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500442526", "createdAt": "2020-10-06T16:39:48Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,44 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+\n+\n+        List<File> files = FileUtil.listFilesRecursively(directory);\n+\n+        Logger.info(PushUtils.class, \"Compressing \" + files.size() + \" to \" + tempFile.getAbsoluteFile());\n+        // Create the output stream for the output file\n+\n+        // try-with-resources handles close of streams\n+        try (OutputStream fos = Files.newOutputStream(tempFile.toPath());\n+                        // Wrap the output file stream in streams that will tar and gzip everything\n+                        TarArchiveOutputStream taos = new TarArchiveOutputStream(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU5Mzkw", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503159390", "createdAt": "2020-10-06T16:40:08Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo0MDowOFrOHdQmiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo0MDowOFrOHdQmiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0Mjc2MQ==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500442761", "createdAt": "2020-10-06T16:40:08Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publishing/GenerateBundlePublisher.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.dotcms.publishing;\n+\n+import java.io.File;\n+import com.dotcms.publisher.pusher.PushPublisher;\n+import com.dotmarketing.util.Logger;\n+\n+/**\n+ * This GenerateBundlePublisher uses the same config/bundlers as the PushPublisher - the only\n+ * difference is that once this publisher has built the bundle it does not do anything with it. The\n+ * GenerateBundlePublisher is meant to be used to build the bundle when a user selects to download a\n+ * bundle\n+ * \n+ * @author will\n+ *\n+ */\n+public class GenerateBundlePublisher extends PushPublisher {\n+\n+    @Override\n+    public PublisherConfig process(PublishStatus status) throws DotPublishingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTYyNDU5", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503162459", "createdAt": "2020-10-06T16:43:58Z", "commit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo0Mzo1OFrOHdQwDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo0Mzo1OFrOHdQwDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NTE5OQ==", "bodyText": "set to final", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500445199", "createdAt": "2020-10-06T16:43:58Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/BundleResource.java", "diffHunk": "@@ -625,6 +638,144 @@ public Response deleteAllSuccess(@Context final HttpServletRequest request,\n                 \"Removing bundles in a separated process, the result of the operation will be notified\")).build();\n     } // deleteAllSuccess.\n \n+\n+    @Path(\"/_download/{bundleId}\")\n+    @GET\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response downloadBundle(@Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"bundleId\") final String bundleId) {\n+\n+        final InitDataObject initData =\n+                new WebResource.InitBuilder(webResource)\n+                        .requiredBackendUser(true)\n+                        .requestAndResponse(request, response)\n+                        .rejectWhenNoUser(true)\n+                        .requiredPortlet(\"publishing-queue\")\n+                        .init();\n+        try {\n+            final Bundle bundle = APILocator.getBundleAPI().getBundleById(bundleId);\n+            if (!UtilMethods.isSet(bundle)) {\n+                throw new DoesNotExistException(\"Bundle with ID: \" + bundleId + \" not found\");\n+            }\n+            final File bundleFile = new File(\n+                    ConfigUtils.getBundlePath() + File.separator + bundle.getId() + \".tar.gz\");\n+            if (!bundleFile.exists()) {\n+                throw new DoesNotExistException(\n+                        \"The bundle has not been generated for the provided bundle ID: \"\n+                                + bundleId);\n+            }\n+            final String bundleName = bundle.getName().replaceAll(\"[^\\\\w.-]\", \"_\");\n+            response.setHeader( \"Content-Disposition\", \"attachment; filename=\" +bundleName  +\"-\"+ bundle.getId() + \".tar.gz\" );\n+            return Response.ok(bundleFile, \"application/x-tgz\").build();\n+        }catch (DoesNotExistException e){\n+            Logger.error(this,e.getMessage());\n+            return ExceptionMapperUtil.createResponse(\"\",e.getMessage(),Response.Status.NOT_FOUND);\n+        }catch (Exception e){\n+            Logger.error(this,e.getMessage());\n+            return ExceptionMapperUtil.createResponse(\"\",e.getMessage(),Response.Status.INTERNAL_SERVER_ERROR);\n+        }\n+    }\n+    \n+    @Path(\"/_generate\")\n+    @POST\n+    @JSONP\n+    @NoCache\n+    @Consumes(MediaType.APPLICATION_JSON)\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final void generateBundle(@Context final HttpServletRequest request,\n+                                       @Context final HttpServletResponse response,\n+                                        @Suspended final AsyncResponse asyncResponse,\n+                                       final GenerateBundleForm form) {\n+\n+\n+        final InitDataObject initData =\n+                new WebResource.InitBuilder(webResource)\n+                        .requiredBackendUser(true)\n+                        .requestAndResponse(request, response)\n+                        .rejectWhenNoUser(true)\n+                        .requiredPortlet(\"publishing-queue\")\n+                        .init();\n+        final User user = initData.getUser();\n+        try {\n+            final Bundle bundle = APILocator.getBundleAPI().getBundleById(form.bundleId);\n+            if (!UtilMethods.isSet(bundle)) {\n+                throw new DoesNotExistException(\"Bundle with ID: \" + form.bundleId + \" not found\");\n+            }\n+            \n+            //set Filter to the bundle\n+            final FilterDescriptor filter = APILocator.getPublisherAPI().getFilterDescriptorByKey(form.filterKey);\n+            bundle.setFilterKey(filter.getKey());\n+            bundle.setOwner(user.getUserId());\n+            //set ForcePush value of the filter to the bundle\n+            bundle.setForcePush(\n+                    (boolean) filter.getFilters().getOrDefault(FilterDescriptor.FORCE_PUSH_KEY,false));\n+            bundle.setOperation(form.operation.ordinal());\n+            //Update Bundle\n+            APILocator.getBundleAPI().updateBundle(bundle);\n+\n+            //Generate the bundle file for this given operation\n+\n+            final BundleGenerator generator = new BundleGenerator(bundle, user,asyncResponse);\n+\n+            final DotSubmitter submitter =\n+                    DotConcurrentFactory.getInstance().getSubmitter(\"generateBundle\",\n+                            new DotConcurrentFactory.SubmitterConfigBuilder().poolSize(2)\n+                                    .maxPoolSize(4).queueCapacity(500).build()\n+                    );\n+            submitter.submit(generator);\n+            final String bundleName = bundle.getName().replaceAll(\"[^\\\\w.-]\", \"_\");\n+            response.setContentType( \"application/x-tgz\" );\n+            response.setHeader( \"Content-Disposition\", \"attachment; filename=\" + bundleName  +\"-\"+ bundle.getId() + \".tar.gz\" );\n+        }catch (DoesNotExistException e){\n+            Logger.error(this,e.getMessage());\n+            asyncResponse.resume(ExceptionMapperUtil.createResponse(\"\",e.getMessage(),Response.Status.NOT_FOUND));\n+        }catch (Exception e){\n+            Logger.error(this,e.getMessage());\n+            asyncResponse.resume(ExceptionMapperUtil.createResponse(\"\",e.getMessage(),Response.Status.INTERNAL_SERVER_ERROR));\n+        }\n+        \n+\n+    } // uploadBundleSync.\n+    \n+    \n+    class BundleGenerator implements Runnable {\n+\n+\n+        public BundleGenerator(final Bundle bundle,  final User user, final AsyncResponse asyncResponse) {\n+            super();\n+            this.bundle = bundle;\n+            this.user = user;\n+            this.asyncResponse = asyncResponse;\n+            \n+        }\n+\n+        File bundleFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086545d55e6acdd8b1a50f396781eddcf14e519c"}, "originalPosition": 177}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54fd4f86a95815444d6d6d117288667b0b8f69e8", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/54fd4f86a95815444d6d6d117288667b0b8f69e8", "committedDate": "2020-10-06T20:44:35Z", "message": "#19321 feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13481e2fcc6855e661eb20765214fada149b382", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/c13481e2fcc6855e661eb20765214fada149b382", "committedDate": "2020-10-06T20:44:47Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-19321"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzg2MTE3", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503386117", "createdAt": "2020-10-06T21:52:50Z", "commit": {"oid": "c13481e2fcc6855e661eb20765214fada149b382"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMTo1Mjo1MFrOHdbQ7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMTo1Mjo1MFrOHdbQ7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYxNzQ1NQ==", "bodyText": "This comment needs to be updated because the response code is 200", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500617455", "createdAt": "2020-10-06T21:52:50Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/BundleResourceTest.java", "diffHunk": "@@ -88,7 +109,118 @@ private void publish(FileInputStream createCOntentFileInputStream) throws DotPub\n         final FormDataMultiPart multipart = mock(FormDataMultiPart.class);\n         when(multipart.getBodyParts()).thenReturn(list(bodyPart));\n \n-        final BundleResource bundleResource = new BundleResource();\n         bundleResource.uploadBundleSync(request, response, multipart);\n     }\n+\n+    private static void createFilter(){\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true);\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,true,\"Reviewer,dotcms.org.2789\");\n+\n+        APILocator.getPublisherAPI().addFilterDescriptor(filterDescriptor);\n+    }\n+\n+    private String insertPublishingBundle(final String userId, final Date publishDate)\n+            throws DotDataException {\n+        final String uuid = UUIDGenerator.generateUuid();\n+        final Bundle bundle = new Bundle();\n+        bundle.setId(uuid);\n+        bundle.setName(\"testBundle\"+System.currentTimeMillis());\n+        bundle.setForcePush(false);\n+        bundle.setOwner(userId);\n+        bundle.setPublishDate(publishDate);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+\n+        return uuid;\n+    }\n+\n+    /**\n+     * BasicAuth\n+     */\n+    private HttpServletRequest getHttpRequest() {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        request.setHeader(\"Authorization\",\n+                \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        return request;\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#generateBundle(HttpServletRequest, HttpServletResponse, AsyncResponse, GenerateBundleForm)}\n+     * When: Create a bundle and generate the tar.gz file of the given bundle.\n+     * Should: Generate the bundle without issues, 200.\n+     */\n+    @Test\n+    public void test_generateBundle_success() throws DotDataException, IOException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Create a Filter since it's needed to generate the bundle\n+        createFilter();\n+\n+        //Create GenerateBundleForm\n+        final GenerateBundleForm bundleForm = new GenerateBundleForm.Builder().bundleId(bundleId).build();\n+\n+        //Call generate endpoint\n+        final AsyncResponse asyncResponse = new MockAsyncResponse((arg) -> {\n+\n+            final Response generateBundleResponse = (Response)arg;\n+            assertEquals(Status.OK.getStatusCode(), generateBundleResponse.getStatus());\n+            return true;\n+        }, arg -> {\n+            fail(\"Error generating bundle\");\n+            return true;\n+        });\n+\n+        bundleResource.generateBundle(getHttpRequest(),response,asyncResponse,bundleForm);\n+        PublisherAPIImpl.class.cast(APILocator.getPublisherAPI()).getFilterDescriptorMap().clear();\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#downloadBundle(HttpServletRequest, HttpServletResponse, String)}\n+     * When: Create a bundle and try to download it, but since the tar.gz has not been generated should fail.\n+     * Should: return 404 since the file has not been generated\n+     */\n+    @Test\n+    public void test_downloadBundle_fileNotGenerated_return404() throws DotDataException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Call download endpoint\n+        final Response responseResource = bundleResource.downloadBundle(getHttpRequest(),response,bundleId);\n+\n+        Assert.assertEquals(Status.NOT_FOUND.getStatusCode(),responseResource.getStatus());\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#downloadBundle(HttpServletRequest, HttpServletResponse, String)}\n+     * When: Create a bundle and try to download it, but since the tar.gz has not been generated should fail.\n+     * Should: return 404 since the file has not been generated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c13481e2fcc6855e661eb20765214fada149b382"}, "originalPosition": 172}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzkwNTU2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503390556", "createdAt": "2020-10-06T22:01:11Z", "commit": {"oid": "c13481e2fcc6855e661eb20765214fada149b382"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMjowMToxMVrOHdbe9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMjowMToxMVrOHdbe9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYyMTA0NQ==", "bodyText": "what would happen if this response is sent considering that the endpoint is tagged with @Produces(MediaType.APPLICATION_OCTET_STREAM) ?", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r500621045", "createdAt": "2020-10-06T22:01:11Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/rest/BundleResource.java", "diffHunk": "@@ -625,6 +636,144 @@ public Response deleteAllSuccess(@Context final HttpServletRequest request,\n                 \"Removing bundles in a separated process, the result of the operation will be notified\")).build();\n     } // deleteAllSuccess.\n \n+\n+    @Path(\"/_download/{bundleId}\")\n+    @GET\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response downloadBundle(@Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"bundleId\") final String bundleId) {\n+\n+        final InitDataObject initData =\n+                new WebResource.InitBuilder(webResource)\n+                        .requiredBackendUser(true)\n+                        .requestAndResponse(request, response)\n+                        .rejectWhenNoUser(true)\n+                        .requiredPortlet(\"publishing-queue\")\n+                        .init();\n+        try {\n+            final Bundle bundle = APILocator.getBundleAPI().getBundleById(bundleId);\n+            if (!UtilMethods.isSet(bundle)) {\n+                throw new DoesNotExistException(\"Bundle with ID: \" + bundleId + \" not found\");\n+            }\n+            final File bundleFile = new File(\n+                    ConfigUtils.getBundlePath() + File.separator + bundle.getId() + \".tar.gz\");\n+            if (!bundleFile.exists()) {\n+                throw new DoesNotExistException(\n+                        \"The bundle has not been generated for the provided bundle ID: \"\n+                                + bundleId);\n+            }\n+            final String bundleName = bundle.getName().replaceAll(\"[^\\\\w.-]\", \"_\");\n+            response.setHeader( \"Content-Disposition\", \"attachment; filename=\" +bundleName  +\"-\"+ bundle.getId() + \".tar.gz\" );\n+            return Response.ok(bundleFile, \"application/x-tgz\").build();\n+        }catch (DoesNotExistException e){\n+            Logger.error(this,e.getMessage());\n+            return ExceptionMapperUtil.createResponse(\"\",e.getMessage(),Response.Status.NOT_FOUND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c13481e2fcc6855e661eb20765214fada149b382"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ef4561f89bf9fd0f31f05d65ee257dfd1a52a7a", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/3ef4561f89bf9fd0f31f05d65ee257dfd1a52a7a", "committedDate": "2020-10-07T14:51:55Z", "message": "#19321 feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTcwNjE3", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-503970617", "createdAt": "2020-10-07T14:55:28Z", "commit": {"oid": "3ef4561f89bf9fd0f31f05d65ee257dfd1a52a7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTU2ODU2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-504956856", "createdAt": "2020-10-08T16:24:13Z", "commit": {"oid": "3ef4561f89bf9fd0f31f05d65ee257dfd1a52a7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1", "committedDate": "2020-10-08T22:03:35Z", "message": "Merge branch 'master' into issue-19321"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAwOTcy", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505200972", "createdAt": "2020-10-08T22:10:17Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoxOFrOHeyIJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoxOFrOHeyIJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDYxMw==", "bodyText": "Codacy found an issue: Avoid reassigning parameters such as 'config'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040613", "createdAt": "2020-10-08T22:10:18Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publishing/PublisherAPIImpl.java", "diffHunk": "@@ -34,14 +33,14 @@\n \n \n     @Override\n-    public PublishStatus publish ( PublisherConfig config ) throws DotPublishingException {\n+    final public PublishStatus publish ( PublisherConfig config ) throws DotPublishingException {\n \n         return publish( config, new PublishStatus() );\n     }\n \n     @CloseDBIfOpened\n     @Override\n-    public PublishStatus publish ( PublisherConfig config, PublishStatus status ) throws DotPublishingException {\n+    final public PublishStatus publish ( PublisherConfig config, PublishStatus status ) throws DotPublishingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAwOTgy", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505200982", "createdAt": "2020-10-08T22:10:19Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoxOVrOHeyIKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoxOVrOHeyIKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDYxOQ==", "bodyText": "Codacy found an issue: Avoid unused local variables such as 'initData'.", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040619", "createdAt": "2020-10-08T22:10:19Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/BundleResource.java", "diffHunk": "@@ -625,6 +629,144 @@ public Response deleteAllSuccess(@Context final HttpServletRequest request,\n                 \"Removing bundles in a separated process, the result of the operation will be notified\")).build();\n     } // deleteAllSuccess.\n \n+\n+    @Path(\"/_download/{bundleId}\")\n+    @GET\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response downloadBundle(@Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"bundleId\") final String bundleId) {\n+\n+        final InitDataObject initData =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAwOTg4", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505200988", "createdAt": "2020-10-08T22:10:20Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMFrOHeyIMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMFrOHeyIMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDYyNQ==", "bodyText": "Codacy found an issue: Avoid declaring a variable if it is unreferenced before a possible exit point.", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040625", "createdAt": "2020-10-08T22:10:20Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/BundleResource.java", "diffHunk": "@@ -625,6 +629,144 @@ public Response deleteAllSuccess(@Context final HttpServletRequest request,\n                 \"Removing bundles in a separated process, the result of the operation will be notified\")).build();\n     } // deleteAllSuccess.\n \n+\n+    @Path(\"/_download/{bundleId}\")\n+    @GET\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response downloadBundle(@Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"bundleId\") final String bundleId) {\n+\n+        final InitDataObject initData =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDAz", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201003", "createdAt": "2020-10-08T22:10:21Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMVrOHeyIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMVrOHeyIPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDYzNw==", "bodyText": "Codacy found an issue: Avoid using redundant field initializer for 'filterKey'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040637", "createdAt": "2020-10-08T22:10:21Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/GenerateBundleForm.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.rest;\n+\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+/**\n+ * Stolen from @author jsanca\n+ */\n+@JsonDeserialize(builder = GenerateBundleForm.Builder.class)\n+public class GenerateBundleForm {\n+\n+    public final String bundleId;\n+    public PushPublisherConfig.Operation operation;\n+    public final String filterKey;\n+\n+    private GenerateBundleForm(final Builder builder) {\n+\n+        this.bundleId = builder.bundleId;\n+        this.operation = builder.operation == PushPublisherConfig.Operation.PUBLISH.ordinal() ? PushPublisherConfig.Operation.PUBLISH : PushPublisherConfig.Operation.UNPUBLISH;\n+        this.filterKey = builder.filterKey;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+        return \"{bundleId=\" + bundleId + \", operation=\" + operation + \", filter=\" + filterKey + \"}\";\n+    }\n+\n+\n+    public static final class Builder {\n+\n+        private @JsonProperty String bundleId = null;\n+        private @JsonProperty String filterKey = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDE2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201016", "createdAt": "2020-10-08T22:10:22Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMlrOHeyIRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyMlrOHeyIRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY0NQ==", "bodyText": "Codacy found an issue: Avoid catching generic exceptions such as NullPointerException, RuntimeException, Exception in try-catch block", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040645", "createdAt": "2020-10-08T22:10:22Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/bundle/business/BundleAPIImpl.java", "diffHunk": "@@ -391,4 +395,44 @@ public void deleteAssetFromBundle(String assetId, String bundleId)\n \n \t}\n \n+\t/**\n+\t * This takes a Bundle, generates the folder/file structure and returns the resulting directory\n+\t * as a File handle. It will not delete the bundle directory if it already existed.\n+\t * @param bundle - Bundle to generate\n+\t * @return\n+\t */\n+    @CloseDBIfOpened\n+    private File generateBundleDirectory(final Bundle bundle) {\n+\n+        final PushPublisherConfig pushPublisherConfig = new PushPublisherConfig(bundle);\n+        pushPublisherConfig.setPublishers(Arrays.asList(GenerateBundlePublisher.class));\n+        try {\n+            APILocator.getPublisherAPI().publish(pushPublisherConfig);\n+        }\n+        catch(final Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDIw", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201020", "createdAt": "2020-10-08T22:10:23Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyM1rOHeyITQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyM1rOHeyITQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY1Mw==", "bodyText": "Codacy found an issue: Field operation has the same name as a method", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040653", "createdAt": "2020-10-08T22:10:23Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/GenerateBundleForm.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.rest;\n+\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+/**\n+ * Stolen from @author jsanca\n+ */\n+@JsonDeserialize(builder = GenerateBundleForm.Builder.class)\n+public class GenerateBundleForm {\n+\n+    public final String bundleId;\n+    public PushPublisherConfig.Operation operation;\n+    public final String filterKey;\n+\n+    private GenerateBundleForm(final Builder builder) {\n+\n+        this.bundleId = builder.bundleId;\n+        this.operation = builder.operation == PushPublisherConfig.Operation.PUBLISH.ordinal() ? PushPublisherConfig.Operation.PUBLISH : PushPublisherConfig.Operation.UNPUBLISH;\n+        this.filterKey = builder.filterKey;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+        return \"{bundleId=\" + bundleId + \", operation=\" + operation + \", filter=\" + filterKey + \"}\";\n+    }\n+\n+\n+    public static final class Builder {\n+\n+        private @JsonProperty String bundleId = null;\n+        private @JsonProperty String filterKey = null;\n+        private @JsonProperty int operation = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDI2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201026", "createdAt": "2020-10-08T22:10:24Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNFrOHeyIVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNFrOHeyIVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY2MA==", "bodyText": "Codacy found an issue: Unnecessary modifier 'public' on method 'generateTarGzipBundleFile': the method is declared in an interface type", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040660", "createdAt": "2020-10-08T22:10:24Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/bundle/business/BundleAPI.java", "diffHunk": "@@ -168,4 +168,10 @@\n \t */\n \tpublic void deleteAssetFromBundle(String assetId, String bundleId) throws DotDataException;\n \n+    /**\n+     * This takes a bundle and generates the tar.gzipped output file.  The resulting file will be placed under\n+     * the ConfigUtils.getBundlePath() + \"/\" + bundleId + \".tar.gz\"\n+     */\n+    public File generateTarGzipBundleFile(Bundle bundle);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDMw", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201030", "createdAt": "2020-10-08T22:10:25Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNVrOHeyIVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNVrOHeyIVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY2Mg==", "bodyText": "Codacy found an issue: The String literal \".tar.gz\" appears 5 times in this file; the first occurrence is on line 664", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040662", "createdAt": "2020-10-08T22:10:25Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/BundleResource.java", "diffHunk": "@@ -625,6 +629,144 @@ public Response deleteAllSuccess(@Context final HttpServletRequest request,\n                 \"Removing bundles in a separated process, the result of the operation will be notified\")).build();\n     } // deleteAllSuccess.\n \n+\n+    @Path(\"/_download/{bundleId}\")\n+    @GET\n+    @JSONP\n+    @NoCache\n+    @Produces(MediaType.APPLICATION_OCTET_STREAM)\n+    public final Response downloadBundle(@Context final HttpServletRequest request,\n+            @Context final HttpServletResponse response,\n+            @PathParam(\"bundleId\") final String bundleId) {\n+\n+        final InitDataObject initData =\n+                new WebResource.InitBuilder(webResource)\n+                        .requiredBackendUser(true)\n+                        .requestAndResponse(request, response)\n+                        .rejectWhenNoUser(true)\n+                        .requiredPortlet(\"publishing-queue\")\n+                        .init();\n+        try {\n+            final Bundle bundle = APILocator.getBundleAPI().getBundleById(bundleId);\n+            if (!UtilMethods.isSet(bundle)) {\n+                throw new DoesNotExistException(\"Bundle with ID: \" + bundleId + \" not found\");\n+            }\n+            final File bundleFile = new File(\n+                    ConfigUtils.getBundlePath() + File.separator + bundle.getId() + \".tar.gz\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDMz", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201033", "createdAt": "2020-10-08T22:10:26Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNlrOHeyIWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyNlrOHeyIWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY2Ng==", "bodyText": "Codacy found an issue: Avoid using redundant field initializer for 'bundleId'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040666", "createdAt": "2020-10-08T22:10:26Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/GenerateBundleForm.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.rest;\n+\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+/**\n+ * Stolen from @author jsanca\n+ */\n+@JsonDeserialize(builder = GenerateBundleForm.Builder.class)\n+public class GenerateBundleForm {\n+\n+    public final String bundleId;\n+    public PushPublisherConfig.Operation operation;\n+    public final String filterKey;\n+\n+    private GenerateBundleForm(final Builder builder) {\n+\n+        this.bundleId = builder.bundleId;\n+        this.operation = builder.operation == PushPublisherConfig.Operation.PUBLISH.ordinal() ? PushPublisherConfig.Operation.PUBLISH : PushPublisherConfig.Operation.UNPUBLISH;\n+        this.filterKey = builder.filterKey;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+        return \"{bundleId=\" + bundleId + \", operation=\" + operation + \", filter=\" + filterKey + \"}\";\n+    }\n+\n+\n+    public static final class Builder {\n+\n+        private @JsonProperty String bundleId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDQz", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201043", "createdAt": "2020-10-08T22:10:27Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyN1rOHeyIYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyN1rOHeyIYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY3Mg==", "bodyText": "Codacy found an issue: Field bundleId has the same name as a method", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040672", "createdAt": "2020-10-08T22:10:27Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/GenerateBundleForm.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.rest;\n+\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+/**\n+ * Stolen from @author jsanca\n+ */\n+@JsonDeserialize(builder = GenerateBundleForm.Builder.class)\n+public class GenerateBundleForm {\n+\n+    public final String bundleId;\n+    public PushPublisherConfig.Operation operation;\n+    public final String filterKey;\n+\n+    private GenerateBundleForm(final Builder builder) {\n+\n+        this.bundleId = builder.bundleId;\n+        this.operation = builder.operation == PushPublisherConfig.Operation.PUBLISH.ordinal() ? PushPublisherConfig.Operation.PUBLISH : PushPublisherConfig.Operation.UNPUBLISH;\n+        this.filterKey = builder.filterKey;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+        return \"{bundleId=\" + bundleId + \", operation=\" + operation + \", filter=\" + filterKey + \"}\";\n+    }\n+\n+\n+    public static final class Builder {\n+\n+        private @JsonProperty String bundleId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDU3", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201057", "createdAt": "2020-10-08T22:10:28Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyOFrOHeyIag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyOFrOHeyIag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY4Mg==", "bodyText": "Codacy found an issue: Unnecessary modifier 'final' on resource specification 'tarArchiveOutputStream': resource specifications are implicitly final", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040682", "createdAt": "2020-10-08T22:10:28Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,42 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+        final List<File> files = FileUtil.listFilesRecursively(directory);\n+\n+        Logger.info(PushUtils.class, \"Compressing \" + files.size() + \" to \" + tempFile.getAbsoluteFile());\n+        // Create the output stream for the output file\n+\n+        // try-with-resources handles close of streams\n+        try (final OutputStream fileOutputStream = Files.newOutputStream(tempFile.toPath());\n+                        // Wrap the output file stream in streams that will tar and gzip everything\n+                        final TarArchiveOutputStream tarArchiveOutputStream = new TarArchiveOutputStream(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDY3", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201067", "createdAt": "2020-10-08T22:10:29Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyOVrOHeyIcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDoyOVrOHeyIcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY5MA==", "bodyText": "Codacy found an issue: Unnecessary modifier 'final' on resource specification 'fileOutputStream': resource specifications are implicitly final", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040690", "createdAt": "2020-10-08T22:10:29Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushUtils.java", "diffHunk": "@@ -50,7 +55,42 @@ public static File compressFiles(Collection<File> files, File output, String bun\n \t\treturn output;\n \t}\n \t\n-\t\n+\n+\t/**\n+\t * Tar and GZIPs a directory on the asset path\n+\t * @param directory\n+\t * @return\n+\t * @throws IOException\n+\t */\n+    public static File tarGzipDirectory(final File directory) throws IOException {\n+        if (directory == null || !directory.exists() || !directory.isDirectory()) {\n+            throw new DotRuntimeException(\"Unable to compress directory:\" + directory);\n+        }\n+        final String tempFileId = directory.getName() + UUIDGenerator.shorty();\n+        final File tempFile = new File(APILocator.getFileAssetAPI().getRealAssetPathTmpBinary() +File.separator + tempFileId + \".tar.gz\");\n+        final List<File> files = FileUtil.listFilesRecursively(directory);\n+\n+        Logger.info(PushUtils.class, \"Compressing \" + files.size() + \" to \" + tempFile.getAbsoluteFile());\n+        // Create the output stream for the output file\n+\n+        // try-with-resources handles close of streams\n+        try (final OutputStream fileOutputStream = Files.newOutputStream(tempFile.toPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDcy", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201072", "createdAt": "2020-10-08T22:10:30Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMFrOHeyIdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMFrOHeyIdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY5NA==", "bodyText": "Codacy found an issue: Overridable method 'setDownloading' called during object construction", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040694", "createdAt": "2020-10-08T22:10:30Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/pusher/PushPublisherConfig.java", "diffHunk": "@@ -42,6 +50,44 @@ public PushPublisherConfig() {\n \t\tsuper();\n \t}\n \n+    /**\n+     * Convenience constructor for generating a PP config from a bundle\n+     * \n+     * @param bundle\n+     */\n+    public PushPublisherConfig(final Bundle bundle) {\n+        super();\n+\n+        final PublisherAPI publisherAPI = PublisherAPI.getInstance();\n+\n+        final List<PublishQueueElement> tempBundleContents =\n+                        Try.of(() -> publisherAPI.getQueueElementsByBundleId(bundle.getId()))\n+                                        .onFailure(e -> Logger.warnAndDebug(PushPublisherConfig.class, e))\n+                                        .getOrElse(ImmutableList.of());\n+        final List<PublishQueueElement> assetsToPublish = new ArrayList<PublishQueueElement>();\n+        assetsToPublish.addAll(tempBundleContents);\n+\n+\n+        this.setDownloading(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDgy", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201082", "createdAt": "2020-10-08T22:10:31Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMVrOHeyIeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMVrOHeyIeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDY5OA==", "bodyText": "Codacy found an issue: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.*'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040698", "createdAt": "2020-10-08T22:10:31Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/BundleResourceTest.java", "diffHunk": "@@ -88,7 +109,118 @@ private void publish(FileInputStream createCOntentFileInputStream) throws DotPub\n         final FormDataMultiPart multipart = mock(FormDataMultiPart.class);\n         when(multipart.getBodyParts()).thenReturn(list(bodyPart));\n \n-        final BundleResource bundleResource = new BundleResource();\n         bundleResource.uploadBundleSync(request, response, multipart);\n     }\n+\n+    private static void createFilter(){\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true);\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,true,\"Reviewer,dotcms.org.2789\");\n+\n+        APILocator.getPublisherAPI().addFilterDescriptor(filterDescriptor);\n+    }\n+\n+    private String insertPublishingBundle(final String userId, final Date publishDate)\n+            throws DotDataException {\n+        final String uuid = UUIDGenerator.generateUuid();\n+        final Bundle bundle = new Bundle();\n+        bundle.setId(uuid);\n+        bundle.setName(\"testBundle\"+System.currentTimeMillis());\n+        bundle.setForcePush(false);\n+        bundle.setOwner(userId);\n+        bundle.setPublishDate(publishDate);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+\n+        return uuid;\n+    }\n+\n+    /**\n+     * BasicAuth\n+     */\n+    private HttpServletRequest getHttpRequest() {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        request.setHeader(\"Authorization\",\n+                \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        return request;\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#generateBundle(HttpServletRequest, HttpServletResponse, AsyncResponse, GenerateBundleForm)}\n+     * When: Create a bundle and generate the tar.gz file of the given bundle.\n+     * Should: Generate the bundle without issues, 200.\n+     */\n+    @Test\n+    public void test_generateBundle_success() throws DotDataException, IOException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Create a Filter since it's needed to generate the bundle\n+        createFilter();\n+\n+        //Create GenerateBundleForm\n+        final GenerateBundleForm bundleForm = new GenerateBundleForm.Builder().bundleId(bundleId).build();\n+\n+        //Call generate endpoint\n+        final AsyncResponse asyncResponse = new MockAsyncResponse((arg) -> {\n+\n+            final Response generateBundleResponse = (Response)arg;\n+            assertEquals(Status.OK.getStatusCode(), generateBundleResponse.getStatus());\n+            return true;\n+        }, arg -> {\n+            fail(\"Error generating bundle\");\n+            return true;\n+        });\n+\n+        bundleResource.generateBundle(getHttpRequest(),response,asyncResponse,bundleForm);\n+        PublisherAPIImpl.class.cast(APILocator.getPublisherAPI()).getFilterDescriptorMap().clear();\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#downloadBundle(HttpServletRequest, HttpServletResponse, String)}\n+     * When: Create a bundle and try to download it, but since the tar.gz has not been generated should fail.\n+     * Should: return 404 since the file has not been generated\n+     */\n+    @Test\n+    public void test_downloadBundle_fileNotGenerated_return404() throws DotDataException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Call download endpoint\n+        final Response responseResource = bundleResource.downloadBundle(getHttpRequest(),response,bundleId);\n+\n+        Assert.assertEquals(Status.NOT_FOUND.getStatusCode(),responseResource.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDg2", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201086", "createdAt": "2020-10-08T22:10:32Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMlrOHeyIfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozMlrOHeyIfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDcwMg==", "bodyText": "Codacy found an issue: Avoid using redundant field initializer for 'operation'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040702", "createdAt": "2020-10-08T22:10:32Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rest/GenerateBundleForm.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.dotcms.rest;\n+\n+import com.dotcms.publisher.pusher.PushPublisherConfig;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+/**\n+ * Stolen from @author jsanca\n+ */\n+@JsonDeserialize(builder = GenerateBundleForm.Builder.class)\n+public class GenerateBundleForm {\n+\n+    public final String bundleId;\n+    public PushPublisherConfig.Operation operation;\n+    public final String filterKey;\n+\n+    private GenerateBundleForm(final Builder builder) {\n+\n+        this.bundleId = builder.bundleId;\n+        this.operation = builder.operation == PushPublisherConfig.Operation.PUBLISH.ordinal() ? PushPublisherConfig.Operation.PUBLISH : PushPublisherConfig.Operation.UNPUBLISH;\n+        this.filterKey = builder.filterKey;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+        return \"{bundleId=\" + bundleId + \", operation=\" + operation + \", filter=\" + filterKey + \"}\";\n+    }\n+\n+\n+    public static final class Builder {\n+\n+        private @JsonProperty String bundleId = null;\n+        private @JsonProperty String filterKey = null;\n+        private @JsonProperty int operation = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjAxMDk1", "url": "https://github.com/dotCMS/core/pull/19342#pullrequestreview-505201095", "createdAt": "2020-10-08T22:10:33Z", "commit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozM1rOHeyIgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjoxMDozM1rOHeyIgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDcwNw==", "bodyText": "Codacy found an issue: Unnecessary use of fully qualified name 'Assert.assertEquals' due to existing static import 'org.junit.Assert.*'", "url": "https://github.com/dotCMS/core/pull/19342#discussion_r502040707", "createdAt": "2020-10-08T22:10:33Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rest/BundleResourceTest.java", "diffHunk": "@@ -88,7 +109,118 @@ private void publish(FileInputStream createCOntentFileInputStream) throws DotPub\n         final FormDataMultiPart multipart = mock(FormDataMultiPart.class);\n         when(multipart.getBodyParts()).thenReturn(list(bodyPart));\n \n-        final BundleResource bundleResource = new BundleResource();\n         bundleResource.uploadBundleSync(request, response, multipart);\n     }\n+\n+    private static void createFilter(){\n+        final Map<String,Object> filtersMap =\n+                ImmutableMap.of(\"dependencies\",true,\"relationships\",true);\n+        final FilterDescriptor filterDescriptor =\n+                new FilterDescriptor(\"filterTestAPI.yml\",\"Filter Test Title\",filtersMap,true,\"Reviewer,dotcms.org.2789\");\n+\n+        APILocator.getPublisherAPI().addFilterDescriptor(filterDescriptor);\n+    }\n+\n+    private String insertPublishingBundle(final String userId, final Date publishDate)\n+            throws DotDataException {\n+        final String uuid = UUIDGenerator.generateUuid();\n+        final Bundle bundle = new Bundle();\n+        bundle.setId(uuid);\n+        bundle.setName(\"testBundle\"+System.currentTimeMillis());\n+        bundle.setForcePush(false);\n+        bundle.setOwner(userId);\n+        bundle.setPublishDate(publishDate);\n+        APILocator.getBundleAPI().saveBundle(bundle);\n+\n+        return uuid;\n+    }\n+\n+    /**\n+     * BasicAuth\n+     */\n+    private HttpServletRequest getHttpRequest() {\n+        final MockHeaderRequest request = new MockHeaderRequest(\n+                new MockSessionRequest(\n+                        new MockAttributeRequest(new MockHttpRequest(\"localhost\", \"/\").request())\n+                                .request())\n+                        .request());\n+\n+        request.setHeader(\"Authorization\",\n+                \"Basic \" + new String(Base64.encode(\"admin@dotcms.com:admin\".getBytes())));\n+\n+        return request;\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#generateBundle(HttpServletRequest, HttpServletResponse, AsyncResponse, GenerateBundleForm)}\n+     * When: Create a bundle and generate the tar.gz file of the given bundle.\n+     * Should: Generate the bundle without issues, 200.\n+     */\n+    @Test\n+    public void test_generateBundle_success() throws DotDataException, IOException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Create a Filter since it's needed to generate the bundle\n+        createFilter();\n+\n+        //Create GenerateBundleForm\n+        final GenerateBundleForm bundleForm = new GenerateBundleForm.Builder().bundleId(bundleId).build();\n+\n+        //Call generate endpoint\n+        final AsyncResponse asyncResponse = new MockAsyncResponse((arg) -> {\n+\n+            final Response generateBundleResponse = (Response)arg;\n+            assertEquals(Status.OK.getStatusCode(), generateBundleResponse.getStatus());\n+            return true;\n+        }, arg -> {\n+            fail(\"Error generating bundle\");\n+            return true;\n+        });\n+\n+        bundleResource.generateBundle(getHttpRequest(),response,asyncResponse,bundleForm);\n+        PublisherAPIImpl.class.cast(APILocator.getPublisherAPI()).getFilterDescriptorMap().clear();\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#downloadBundle(HttpServletRequest, HttpServletResponse, String)}\n+     * When: Create a bundle and try to download it, but since the tar.gz has not been generated should fail.\n+     * Should: return 404 since the file has not been generated\n+     */\n+    @Test\n+    public void test_downloadBundle_fileNotGenerated_return404() throws DotDataException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Call download endpoint\n+        final Response responseResource = bundleResource.downloadBundle(getHttpRequest(),response,bundleId);\n+\n+        Assert.assertEquals(Status.NOT_FOUND.getStatusCode(),responseResource.getStatus());\n+    }\n+\n+    /**\n+     * Method to Test: {@link BundleResource#downloadBundle(HttpServletRequest, HttpServletResponse, String)}\n+     * When: Create a bundle and try to download it, since the tar.gz has been generated should succeed.\n+     * Should: return 200 since the file has been generated\n+     */\n+    @Test\n+    public void test_downloadBundle_success() throws DotDataException {\n+        //Create new bundle\n+        final String bundleId = insertPublishingBundle(adminUser.getUserId(),new Date());\n+\n+        //Create a Filter since it's needed to generate the bundle\n+        createFilter();\n+\n+        //Generate bundle file\n+        final Bundle bundle = APILocator.getBundleAPI().getBundleById(bundleId);\n+        bundle.setOperation(PushPublisherConfig.Operation.PUBLISH.ordinal());\n+        APILocator.getBundleAPI().generateTarGzipBundleFile(bundle);\n+\n+        PublisherAPIImpl.class.cast(APILocator.getPublisherAPI()).getFilterDescriptorMap().clear();\n+\n+        //Call download endpoint\n+        final Response responseResource = bundleResource.downloadBundle(getHttpRequest(),response,bundleId);\n+\n+        Assert.assertEquals(Status.OK.getStatusCode(),responseResource.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff995509dbfe43fcf05ead2cd8aec339c4e9ce1"}, "originalPosition": 192}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 645, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}