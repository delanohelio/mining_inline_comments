{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Mjg4ODAz", "number": 18322, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyMzozNlrODzwRQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToxOVrOD0j_tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTk0ODE3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyMzozNlrOGIXGdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyMzozNlrOGIXGdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMDI3OQ==", "bodyText": "maybe it should go into a private method", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411420279", "createdAt": "2020-04-20T14:23:36Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,24 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n             .findFolderByPath(path, host, systemUserParam, true)\n                 : APILocator.getFolderAPI()\n                     .findSystemFolder();\n-        if (folder == null || !UtilMethods.isSet(folder.getIdentifier())) {\n+\n+        if (originalFolder == null || !UtilMethods.isSet(originalFolder.getIdentifier())) {\n             return null;\n         }\n+\n+        // make a defensive copy to avoid mutating cached version\n+        Folder folder = new Folder();\n+        try {\n+            BeanUtils.copyProperties(folder, originalFolder);\n+        } catch (IllegalAccessException | InvocationTargetException e) {\n+            folder = originalFolder;\n+            Logger.warnAndDebug(NavTool.class,\"Defensive copy failed. Using original object\", e);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTk1NDkzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyNTowMVrOGIXKpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNTo1NDozOFrOGIbhtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMTM0OA==", "bodyText": "I think we should check also the return value of the getNav method", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411421348", "createdAt": "2020-04-20T14:25:01Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -441,4 +449,36 @@ public void testNavTool_rootLevel_returnItemsOnlyForSite() throws Exception\n \n     }\n \n+    /**\n+     * Method to test: NavTool.getNav\n+     * Given scenario: get navigation for system folder (\"/\")\n+     * Expected result: getting the navigation should not change system folder's hostId\n+     * @throws Exception exception\n+     */\n+\n+    @Test\n+    public void testNavTool_getNav_SystemFolder_ShouldNotChangeSystemFolderHostId() throws Exception\n+    {\n+        //Get SystemFolder\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        //Create new Host\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        //Create contentlets on one host\n+        final File file = File.createTempFile(\"fileTestEngTrue\", \".txt\");\n+        FileUtil.write(file, \"helloworld\");\n+        final Contentlet fileAssetOneHost = new FileAssetDataGen(systemFolder, file)\n+                .host(host).setProperty(FileAssetAPI.SHOW_ON_MENU, \"true\").nextPersisted();\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Contentlet pageAssetOneHost = new HTMLPageDataGen(systemFolder, template)\n+                .showOnMenu(true).host(host).nextPersisted();\n+        ContentletDataGen.publish(pageAssetOneHost);\n+        ContentletDataGen.publish(fileAssetOneHost);\n+\n+        new NavTool().getNav(host, systemFolder.getPath());\n+        systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assertEquals(Host.SYSTEM_HOST, systemFolder.getHostId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Mjc4OQ==", "bodyText": "It's covered in a different test", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411492789", "createdAt": "2020-04-20T15:54:38Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -441,4 +449,36 @@ public void testNavTool_rootLevel_returnItemsOnlyForSite() throws Exception\n \n     }\n \n+    /**\n+     * Method to test: NavTool.getNav\n+     * Given scenario: get navigation for system folder (\"/\")\n+     * Expected result: getting the navigation should not change system folder's hostId\n+     * @throws Exception exception\n+     */\n+\n+    @Test\n+    public void testNavTool_getNav_SystemFolder_ShouldNotChangeSystemFolderHostId() throws Exception\n+    {\n+        //Get SystemFolder\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        //Create new Host\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        //Create contentlets on one host\n+        final File file = File.createTempFile(\"fileTestEngTrue\", \".txt\");\n+        FileUtil.write(file, \"helloworld\");\n+        final Contentlet fileAssetOneHost = new FileAssetDataGen(systemFolder, file)\n+                .host(host).setProperty(FileAssetAPI.SHOW_ON_MENU, \"true\").nextPersisted();\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Contentlet pageAssetOneHost = new HTMLPageDataGen(systemFolder, template)\n+                .showOnMenu(true).host(host).nextPersisted();\n+        ContentletDataGen.publish(pageAssetOneHost);\n+        ContentletDataGen.publish(fileAssetOneHost);\n+\n+        new NavTool().getNav(host, systemFolder.getPath());\n+        systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assertEquals(Host.SYSTEM_HOST, systemFolder.getHostId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMTM0OA=="}, "originalCommit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NjQ3OTgzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyN1rOGIcHhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyN1rOGIcHhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ2OQ==", "bodyText": "Issue found: Local variable 'modifiedSystemFolder' could be declared final", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502469", "createdAt": "2020-04-20T16:06:27Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -204,8 +205,15 @@ public void testRootLevelNavigation_WhenOneFileAssetIsShownOnMenu() throws Excep\n                     .getNav(site, systemFolder.getPath(), 1, user);\n             assertNotNull(navResult);\n \n+            /* method below `findShowOnMenuUnderFolder` expects a mutated version of SYSTEM_FOLDER with the hostId altered.\n+               So let's create a defensive copy of the SYSTEM_FOLDER, modify it and pass it to the method.\n+            */\n+            Folder modifiedSystemFolder = new Folder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NjQ3OTk2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyOFrOGIcHlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyOFrOGIcHlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ4Nw==", "bodyText": "Issue found: Position literals first in String comparisons", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502487", "createdAt": "2020-04-20T16:06:28Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,17 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NDQyMjkyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToxOVrOGJjpTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToxOVrOGJjpTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3NDM4MQ==", "bodyText": "Very good", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r412674381", "createdAt": "2020-04-22T05:11:19Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -215,6 +221,22 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n         }\n     }\n \n+    /**\n+     * Makes a defensive copy of the given folder to avoid mutating cached version\n+     * @param originalFolder folder to make the defensive copy from\n+     * @return defensive copy\n+     */\n+    private Folder getDefensiveCopyOfFolder(Folder originalFolder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2223, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}