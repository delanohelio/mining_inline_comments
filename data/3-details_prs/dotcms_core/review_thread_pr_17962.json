{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTA1ODEx", "number": 17962, "reviewThreads": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxMDoxMFrODf8Osg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoyMzoxNlrODh9DSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODE5MjUwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/tika/TikaUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxMDoxMFrOFp7yIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxMDoxMFrOFp7yIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxNTQyNg==", "bodyText": "You can use Logger.warnAndDebug method instead", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r379515426", "createdAt": "2020-02-14T16:10:10Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/tika/TikaUtils.java", "diffHunk": "@@ -199,6 +329,60 @@ public boolean generateMetaData(Contentlet contentlet, boolean force)\n         return false;\n     }\n \n+    /**\n+     * Similar as {@link #getMetaDataMap(String, File, boolean)} but includes the metadata fields to filter from the tika collection\n+     * and the max length of the binary file to parse.\n+     * Also, it is not storing anything on the file system as the reference method {@link #getMetaDataMap(String, File, boolean)}\n+     * This one does everything on memory, means forceMemory is always true and the file system cache has to be performed on upper layers\n+     */\n+    private Map<String, Object> getForcedMetaDataMap(final File binFile,\n+                                               final Set<String> metadataFields,\n+                                               final int maxLength) {\n+\n+        if (!osgiInitialized) {\n+            Logger.error(this.getClass(),\n+                    \"Unable to get file Meta Data, OSGI Framework not initialized\");\n+            return Collections.emptyMap();\n+        }\n+\n+        final Map<String, Object> metaMap = new TreeMap<>();\n+        this.tikaService.setMaxStringLength(maxLength);\n+\n+        try (InputStream stream = Files.newInputStream(binFile.toPath())) {\n+            // no worry about the limit and less time to process.\n+            final String content = this.tikaService.parseToString(stream);\n+\n+            //Creating the meta data map to use by our content\n+            metaMap.putAll(this.buildMetaDataMap());\n+            metaMap.put(FileAssetAPI.CONTENT_FIELD, content);\n+        } catch (IOException ioExc) {\n+            if (this.isZeroByteFileException(ioExc.getCause())) {\n+                logWarning(binFile, ioExc.getCause());\n+            } else {\n+                final String errorMessage = String\n+                        .format(\"Error Reading Tika parsed Stream for file [%s] [%s] \",\n+                                binFile.getAbsolutePath(),\n+                                UtilMethods.isSet(ioExc.getMessage()) ? ioExc.getMessage()\n+                                        : ioExc.getCause().getMessage());\n+                Logger.warn(this.getClass(), errorMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37a34d10c3b118bdad6a21261fb186e1ef3b2bf"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODIxMDcwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxNTo1M1rOFp799w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyMDowOVrOFtuiaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxODQ1NQ==", "bodyText": "does this test fail with an empty starter? why don't you use new SiteDataGen().nextPersisted(); to get a new host?", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r379518455", "createdAt": "2020-02-14T16:15:53Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37a34d10c3b118bdad6a21261fb186e1ef3b2bf"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MjcxMw==", "bodyText": "It is working fine", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r383492713", "createdAt": "2020-02-24T20:20:09Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxODQ1NQ=="}, "originalCommit": {"oid": "c37a34d10c3b118bdad6a21261fb186e1ef3b2bf"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODIxNDIwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxNjo1OFrOFp8ALQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxNjo1OFrOFp8ALQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxOTAyMQ==", "bodyText": "I'm not sure this test runs with an empty starter/empty DB", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r379519021", "createdAt": "2020-02-14T16:16:58Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37a34d10c3b118bdad6a21261fb186e1ef3b2bf"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODIxNTIwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxNzoxNFrOFp8Azg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoxNzoxNFrOFp8Azg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxOTE4Mg==", "bodyText": "same here", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r379519182", "createdAt": "2020-02-14T16:17:14Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37a34d10c3b118bdad6a21261fb186e1ef3b2bf"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NDgxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozMlrOFrvLaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozMlrOFrvLaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjA1OQ==", "bodyText": "Issue found: Ensure that resources like this OutputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406059", "createdAt": "2020-02-19T16:52:32Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NDkzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozM1rOFrvLfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozM1rOFrvLfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjA3OA==", "bodyText": "Issue found: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406078", "createdAt": "2020-02-19T16:52:33Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"bzip2\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"ebzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.BZIP2);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.BZIP2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTAyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozNVrOFrvLig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozNVrOFrvLig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjA5MA==", "bodyText": "Issue found: The String literal \"The file recovery should be the file saved\" appears 5 times in this file; the first occurrence is on line 37", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406090", "createdAt": "2020-02-19T16:52:35Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTA4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozNlrOFrvLlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozNlrOFrvLlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjEwMw==", "bodyText": "Issue found: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406103", "createdAt": "2020-02-19T16:52:36Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTE3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozN1rOFrvLqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozN1rOFrvLqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjEyMA==", "bodyText": "Issue found: Substitute calls to size() == 0 (or size() != 0, size() > 0, size() < 1) with calls to isEmpty()", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406120", "createdAt": "2020-02-19T16:52:37Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -464,203 +546,217 @@ protected void loadPermissions(final Contentlet con, final Map<String,Object> m)\n \n \tpublic static final FastDateFormat timeFormat = FastDateFormat.getInstance(\"HH:mm:ss\");\n \n-\tprotected void loadFields(Contentlet con, Map<String, Object> m) throws DotDataException {\n+\tprotected void loadFields(final Contentlet contentlet, final Map<String, Object> contentletMap) throws DotDataException {\n \n \t\t// https://github.com/dotCMS/dotCMS/issues/6152\n-\t\tDecimalFormatSymbols otherSymbols = new DecimalFormatSymbols();\n+\t\tfinal DecimalFormatSymbols otherSymbols = new DecimalFormatSymbols();\n \t\totherSymbols.setDecimalSeparator('.');\n \n-\t\tDecimalFormat numFormatter = new DecimalFormat(\"0000000000000000000.000000000000000000\", otherSymbols);\n-\n-\t\tFieldAPI fAPI=APILocator.getFieldAPI();\n-\t\tfinal List<Field> fields = new ArrayList<>(\n-\t\t\t\tFieldsCache.getFieldsByStructureInode(con.getStructureInode()));\n-\n-\t\tStructure st=con.getStructure();\n+\t\tfinal DecimalFormat numFormatter = new DecimalFormat(\"0000000000000000000.000000000000000000\", otherSymbols);\n+\t\tfinal FieldAPI fieldAPI   = APILocator.getFieldAPI();\n+\t\tfinal List<Field> fields  = new ArrayList<>(\n+\t\t\t\tFieldsCache.getFieldsByStructureInode(contentlet.getStructureInode()));\n+\t\tfinal Structure structure = contentlet.getStructure();\n \t\tStringBuilder keyNameBuilder;\n \t\tString keyName;\n \t\tString keyNameText;\n-\n \t\tfinal TikaUtils tikaUtils = new TikaUtils();\n \n-\t\tfor (Field f : fields) {\n+\t\tfor (final Field field : fields) {\n \n-\t\t\tkeyNameBuilder = new StringBuilder(st.getVelocityVarName()).append(\".\")\n-\t\t\t\t\t.append(f.getVelocityVarName());\n+\t\t\tkeyNameBuilder = new StringBuilder(structure.getVelocityVarName()).append(\".\")\n+\t\t\t\t\t.append(field.getVelocityVarName());\n \t\t\tkeyName        = keyNameBuilder.toString();\n \t\t\tkeyNameText    = keyNameBuilder.append(TEXT).toString();\n-\t\t\tif (f.getFieldType().equals(Field.FieldType.BINARY.toString())\n-\t\t\t\t\t|| f.getFieldContentlet() != null && (f.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SYSTEM_FIELD) && !f.getFieldType().equals(Field.FieldType.TAG.toString()))) {\n+\t\t\tif (field.getFieldType().equals(Field.FieldType.BINARY.toString()) // todo: remove this since we are going to index the binary fields\n+\t\t\t\t\t|| field.getFieldContentlet() != null && (field.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SYSTEM_FIELD)\n+\t\t\t\t\t&& !field.getFieldType().equals(Field.FieldType.TAG.toString()))) {\n+\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tif(!f.isIndexed()){\n+\n+\t\t\tif(!field.isIndexed()) {\n+\n \t\t\t\tcontinue;\n \t\t\t}\n+\n \t\t\ttry {\n-\t\t\t\tif(fAPI.isElementConstant(f)){\n-\t\t\t\t\tm.put(keyName, (f.getValues() == null ? \"\":f.getValues()));\n+\t\t\t\tif(fieldAPI.isElementConstant(field)){\n+\t\t\t\t\tcontentletMap.put(keyName, (field.getValues() == null ? \"\":field.getValues()));\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n \n-\t\t\t\tObject valueObj = con.get(f.getVelocityVarName());\n+\t\t\t\tObject valueObj = contentlet.get(field.getVelocityVarName());\n \n-\t\t\t\tif (f.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SECTION_DIVIDER)) {\n+\t\t\t\tif (field.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SECTION_DIVIDER)) {\n \t\t\t\t\tvalueObj = \"\";\n \t\t\t\t}\n \n-\t\t\t\tif (!UtilMethods.isSet(valueObj) && !f.getFieldType()\n+\t\t\t\tif (!UtilMethods.isSet(valueObj) && !field.getFieldType()\n \t\t\t\t\t\t.equals(Field.FieldType.TAG.toString())) {\n-\t\t\t\t\tm.put(keyName, null);\n+\t\t\t\t\tcontentletMap.put(keyName, null);\n \t\t\t\t}\n-\t\t\t\telse if(f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_TIME)) {\n+\t\t\t\telse if(field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_TIME)) {\n \t\t\t\t\ttry{\n \t\t\t\t\t\tString timeStr=timeFormat.format(valueObj);\n-\t\t\t\t\t\tm.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n-\t\t\t\t\t\tm.put(keyNameText, timeStr);\n+\t\t\t\t\t\tcontentletMap.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, timeStr);\n \t\t\t\t\t}\n \t\t\t\t\tcatch(Exception e){\n-\t\t\t\t\t\tm.put(keyName, null);\n-\t\t\t\t\t\tm.put(keyNameText, null);\n+\t\t\t\t\t\tcontentletMap.put(keyName, null);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, null);\n \t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t\telse if (f.getFieldType().equals(ESMappingConstants.FIELD_ELASTIC_TYPE_DATE)) {\n+\t\t\t\telse if (field.getFieldType().equals(ESMappingConstants.FIELD_ELASTIC_TYPE_DATE)) {\n \t\t\t\t\ttry {\n \t\t\t\t\t\tString dateString = dateFormat.format(valueObj);\n-\t\t\t\t\t\tm.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n-\t\t\t\t\t\tm.put(keyNameText, dateString);\n+\t\t\t\t\t\tcontentletMap.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, dateString);\n \t\t\t\t\t}\n \t\t\t\t\tcatch(Exception ex) {\n-\t\t\t\t\t\tm.put(keyName, null);\n-\t\t\t\t\t\tm.put(keyNameText, null);\n+\t\t\t\t\t\tcontentletMap.put(keyName, null);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, null);\n \t\t\t\t\t}\n-\t\t\t\t} else if(f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_DATE_TIME)) {\n+\t\t\t\t} else if(field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_DATE_TIME)) {\n \t\t\t\t\ttry {\n \t\t\t\t\t\tString datetimeString = datetimeFormat.format(valueObj);\n-\t\t\t\t\t\tm.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n-\t\t\t\t\t\tm.put(keyNameText, datetimeString);\n+\t\t\t\t\t\tcontentletMap.put(keyName, elasticSearchDateTimeFormat.format(valueObj));\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, datetimeString);\n \t\t\t\t\t}\n \t\t\t\t\tcatch(Exception ex) {\n-\t\t\t\t\t\tm.put(keyName, null);\n-\t\t\t\t\t\tm.put(keyNameText, null);\n+\t\t\t\t\t\tcontentletMap.put(keyName, null);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, null);\n \t\t\t\t\t}\n-\t\t\t\t} else if (f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_CATEGORY)) {\n+\t\t\t\t} else if (field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_CATEGORY)) {\n \t\t\t\t\t// moved the logic to loadCategories\n-\t\t\t\t} else if (f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_RELATIONSHIP)) {\n+\t\t\t\t} else if (field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_RELATIONSHIP)) {\n                     // loadRelationshipFields processes relationship fields\n                     continue;\n-                } else if (f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_CHECKBOX) || f\n+                } else if (field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_CHECKBOX) || field\n \t\t\t\t\t\t.getFieldType().equals(ESMappingConstants.FIELD_TYPE_MULTI_SELECT)) {\n-\t\t\t\t\tif (f.getFieldContentlet().startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_BOOLEAN)) {\n-\t\t\t\t\t\tm.put(keyName, valueObj);\n-\t\t\t\t\t\tm.put(keyNameText, valueObj.toString());\n+\t\t\t\t\tif (field.getFieldContentlet().startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_BOOLEAN)) {\n+\t\t\t\t\t\tcontentletMap.put(keyName, valueObj);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, valueObj.toString());\n \t\t\t\t\t} else {\n-\t\t\t\t\t\tm.put(keyName,\n+\t\t\t\t\t\tcontentletMap.put(keyName,\n \t\t\t\t\t\t\t\tUtilMethods.listToString(valueObj.toString()));\n \t\t\t\t\t}\n-\t\t\t\t} else if (f.getFieldType().equals(ESMappingConstants.FIELD_TYPE_KEY_VALUE)){\n+\t\t\t\t} else if (field.getFieldType().equals(ESMappingConstants.FIELD_TYPE_KEY_VALUE)){\n \t\t\t\t\tfinal boolean fileMetadata =\n-\t\t\t\t\t\t\tf.getVelocityVarName().equals(FileAssetAPI.META_DATA_FIELD)\n-\t\t\t\t\t\t\t\t\t&& st.getStructureType() == Structure.STRUCTURE_TYPE_FILEASSET;\n+\t\t\t\t\t\t\tfield.getVelocityVarName().equals(FileAssetAPI.META_DATA_FIELD)\n+\t\t\t\t\t\t\t\t\t&& structure.getStructureType() == Structure.STRUCTURE_TYPE_FILEASSET;\n \t\t\t\t\tif(LicenseUtil.getLevel()>= LicenseLevel.STANDARD.level) {\n \n-\t\t\t\t\t\tMap<String,Object> keyValueMap = KeyValueFieldUtil.JSONValueToHashMap((String)valueObj);\n-\n-\t\t\t\t\t\tSet<String> allowedFields = new HashSet<>();\n-\t\t\t\t\t\tif(fileMetadata) {\n-\t\t\t\t\t\t\t// http://jira.dotmarketing.net/browse/DOTCMS-7243\n-\t\t\t\t\t\t\tList<FieldVariable> fieldVariables=APILocator.getFieldAPI().getFieldVariablesForField(\n-\t\t\t\t\t\t\t\t\tf.getInode(), APILocator.getUserAPI().getSystemUser(), false);\n-\t\t\t\t\t\t\tfor(FieldVariable fv : fieldVariables) {\n-\t\t\t\t\t\t\t\tif(fv.getKey().equals(ESMappingConstants.DOT_INDEX_PATTERN)) {\n-\t\t\t\t\t\t\t\t\tString[] names=fv.getValue().split(\",\");\n-\t\t\t\t\t\t\t\t\tallowedFields=new HashSet<>();\n-\t\t\t\t\t\t\t\t\tfor(String n : names)\n-\t\t\t\t\t\t\t\t\t\tallowedFields.add(n.trim().toLowerCase());\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\tallowedFields\n-\t\t\t\t\t\t\t\t\t.addAll(tikaUtils.getConfiguredMetadataFields());\n-\n-\t\t\t\t\t\t\ttikaUtils.filterMetadataFields(keyValueMap, allowedFields);\n-\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tfinal String keyValuePrefix = fileMetadata ?\n-\t\t\t\t\t\t\t\tFileAssetAPI.META_DATA_FIELD.toLowerCase() : keyName;\n-\t\t\t\t\t\tkeyValueMap.forEach((k, v) -> m\n-\t\t\t\t\t\t\t\t.put(keyValuePrefix + StringPool.PERIOD + k, v));\n+\t\t\t\t\t\tthis.loadKeyValueField(contentletMap, keyName, tikaUtils, field, (String) valueObj, fileMetadata);\n \t\t\t\t\t}\n-\t\t\t\t} else if(f.getFieldType().equals(Field.FieldType.TAG.toString())) {\n-\n-\t\t\t\t\tStringBuilder personaTags = new StringBuilder();\n-\t\t\t\t\tList<Tag> tagList = APILocator.getTagAPI().getTagsByInode(con.getInode());\n-\t\t\t\t\tif(tagList ==null || tagList.size()==0) continue;\n+\t\t\t\t} else if(field.getFieldType().equals(Field.FieldType.TAG.toString())) {\n \n-\t\t\t\t\tfinal String tagDelimit = Config.getStringProperty(\"ES_TAG_DELIMITER_PATTERN\", \",,\");\n+\t\t\t\t\tif (this.loadTagsField(contentlet, contentletMap, structure, keyName)) {\n \n-\n-\t\t\t\t\tfor ( Tag t : tagList ) {\n-\t\t\t\t\t\tif(t.getTagName() ==null) continue;\n-\t\t\t\t\t\tString myTag = t.getTagName().trim();\n-\t\t\t\t\t\tif ( t.isPersona() ) {\n-\t\t\t\t\t\t\tpersonaTags.append(myTag).append(' ');\n-\t\t\t\t\t\t}\n+\t\t\t\t\t\tcontinue;\n \t\t\t\t\t}\n-\n-\t\t\t\t\tfinal List<String> tagsNames = tagList.stream().map(Tag::getTagName).collect(\n-\t\t\t\t\t\t\tCollectors.toList());\n-\n-\t\t\t\t\tm.put(keyName, tagsNames);\n-\t\t\t\t\tm.put(ESMappingConstants.TAGS, tagsNames);\n-\n-\t\t\t\t\tif ( Structure.STRUCTURE_TYPE_PERSONA != con.getStructure().getStructureType() ) {\n-\t\t\t\t\t\tfinal List<String> personaTagsNames = tagList.stream()\n-\t\t\t\t\t\t\t\t.filter(Tag::isPersona)\n-\t\t\t\t\t\t\t\t.map(Tag::getTagName)\n-\t\t\t\t\t\t\t\t.collect(Collectors.toList());\n-\n-\t\t\t\t\t\tm.put(st.getVelocityVarName() + \".\"\n-\t\t\t\t\t\t\t\t+ ESMappingConstants.PERSONAS, personaTagsNames);\n-\t\t\t\t\t\tm.put(ESMappingConstants.PERSONAS, personaTagsNames);\n-\t\t\t\t\t}\n-\n-\t\t\t\t} else if(f.getFieldType().equals(CUSTOM_FIELD.legacyValue())\n-\t\t\t\t\t\t&& f.getVelocityVarName().equals(PERSONA_KEY_TAG_FIELD_VAR)) {\n-\t\t\t\t\tm.put(PERSONA_KEY_TAG,valueObj.toString());\n-\t\t\t\t\tm.put(keyName, valueObj.toString());\n+\t\t\t\t} else if(field.getFieldType().equals(CUSTOM_FIELD.legacyValue())\n+\t\t\t\t\t\t&& field.getVelocityVarName().equals(PERSONA_KEY_TAG_FIELD_VAR)) {\n+\t\t\t\t\tcontentletMap.put(PERSONA_KEY_TAG,valueObj.toString());\n+\t\t\t\t\tcontentletMap.put(keyName, valueObj.toString());\n \t\t\t\t} else {\n-\t\t\t\t\tif (f.getFieldContentlet()\n+\t\t\t\t\tif (field.getFieldContentlet()\n \t\t\t\t\t\t\t.startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_BOOLEAN)) {\n-\t\t\t\t\t\tm.put(keyName, valueObj);\n-\t\t\t\t\t\tm.put(keyNameText,valueObj.toString());\n-\t\t\t\t\t} else if (f.getFieldContentlet()\n-\t\t\t\t\t\t\t.startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_FLOAT) || f\n+\t\t\t\t\t\tcontentletMap.put(keyName, valueObj);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText,valueObj.toString());\n+\t\t\t\t\t} else if (field.getFieldContentlet()\n+\t\t\t\t\t\t\t.startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_FLOAT) || field\n \t\t\t\t\t\t\t.getFieldContentlet()\n \t\t\t\t\t\t\t.startsWith(ESMappingConstants.FIELD_ELASTIC_TYPE_INTEGER)) {\n-\t\t\t\t\t\tm.put(keyName, valueObj);\n-\t\t\t\t\t\tm.put(keyNameText, numFormatter.format(valueObj));\n+\t\t\t\t\t\tcontentletMap.put(keyName, valueObj);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, numFormatter.format(valueObj));\n \t\t\t\t\t} else {\n-\t\t\t\t\t\tm.put(keyName, valueObj);\n-\t\t\t\t\t\tm.put(keyNameText, valueObj.toString());\n+\t\t\t\t\t\tcontentletMap.put(keyName, valueObj);\n+\t\t\t\t\t\tcontentletMap.put(keyNameText, valueObj.toString());\n \t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\t// Store sha256 hash for unique fields in the index\n-\t\t\t\tif (f.isUnique() && m.containsKey(keyName)) {\n-\t\t\t\t\tfinal Object uniqueValue = m.get(keyName);\n-\t\t\t\t\tm.put(keyName + ESUtils.SHA_256,\n-\t\t\t\t\t\t\tESUtils.sha256(keyName, uniqueValue, con.getLanguageId()));\n+\t\t\t\tif (field.isUnique() && contentletMap.containsKey(keyName)) {\n+\t\t\t\t\tfinal Object uniqueValue = contentletMap.get(keyName);\n+\t\t\t\t\tcontentletMap.put(keyName + ESUtils.SHA_256,\n+\t\t\t\t\t\t\tESUtils.sha256(keyName, uniqueValue, contentlet.getLanguageId()));\n \t\t\t\t}\n-\n \t\t\t} catch (Exception e) {\n-\t\t\t\tLogger.warn(ESMappingAPIImpl.class, \"Error indexing field: \" + f.getFieldName()\n-\t\t\t\t\t\t+ \" of contentlet: \" + con.getInode(), e);\n+\t\t\t\tLogger.warn(ESMappingAPIImpl.class, \"Error indexing field: \" + field.getFieldName()\n+\t\t\t\t\t\t+ \" of contentlet: \" + contentlet.getInode(), e);\n \t\t\t\tthrow new DotDataException(e.getMessage(),e);\n \t\t\t}\n \t\t}\n \t}\n \n+\tprivate boolean loadTagsField(final Contentlet contentlet,\n+\t\t\t\t\t\t\t\t  final Map<String, Object> contentletMap,\n+\t\t\t\t\t\t\t\t  final Structure structure,\n+\t\t\t\t\t\t\t\t  final String keyName) throws DotDataException {\n+\n+\t\tfinal List<Tag> tagList = APILocator.getTagAPI().getTagsByInode(contentlet.getInode());\n+\t\tif(tagList ==null || tagList.size()==0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 527}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTI2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/tika/TikaUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozOFrOFrvLuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MjozOFrOFrvLuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjEzNg==", "bodyText": "Issue found: Avoid unused local variables such as 'errorMessage'.", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406136", "createdAt": "2020-02-19T16:52:38Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/tika/TikaUtils.java", "diffHunk": "@@ -199,6 +321,59 @@ public boolean generateMetaData(Contentlet contentlet, boolean force)\n         return false;\n     }\n \n+    /**\n+     * Similar as {@link #getMetaDataMap(String, File, boolean)} but includes the metadata fields to filter from the tika collection\n+     * and the max length of the binary file to parse.\n+     * Also, it is not storing anything on the file system as the reference method {@link #getMetaDataMap(String, File, boolean)}\n+     * This one does everything on memory, means forceMemory is always true and the file system cache has to be performed on upper layers\n+     */\n+    private Map<String, Object> getForcedMetaDataMap(final File binFile,\n+                                               final Set<String> metadataFields,\n+                                               final int maxLength) {\n+\n+        if (!osgiInitialized) {\n+            Logger.error(this.getClass(),\n+                    \"Unable to get file Meta Data, OSGI Framework not initialized\");\n+            return Collections.emptyMap();\n+        }\n+\n+        final Map<String, Object> metaMap = new TreeMap<>();\n+        this.tikaService.setMaxStringLength(maxLength);\n+\n+        try (InputStream stream = Files.newInputStream(binFile.toPath())) {\n+            // no worry about the limit and less time to process.\n+            final String content = this.tikaService.parseToString(stream);\n+\n+            //Creating the meta data map to use by our content\n+            metaMap.putAll(this.buildMetaDataMap());\n+            metaMap.put(FileAssetAPI.CONTENT_FIELD, content);\n+        } catch (IOException ioExc) {\n+            if (this.isZeroByteFileException(ioExc.getCause())) {\n+                logWarning(binFile, ioExc.getCause());\n+            } else {\n+                final String errorMessage = String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 190}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTM4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MFrOFrvLyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MFrOFrvLyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjE1NQ==", "bodyText": "Issue found: The String literal \"title\" appears 6 times in this file; the first occurrence is on line 164", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406155", "createdAt": "2020-02-19T16:52:40Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();\n+\n+        ContentType contentType = ContentTypeBuilder.builder(BaseContentType.CONTENT.immutableClass())\n+                .description(\"Test ContentType Binary Fields\")\n+                .host(host.getIdentifier())\n+                .name(\"Test ContentType Binary Fields\")\n+                .owner(\"owner\")\n+                .variable(varname)\n+                .build();\n+\n+        contentType = contentTypeAPI.save(contentType);\n+\n+        Field textField = ImmutableTextField.builder()\n+                .name(\"Title\")\n+                .variable(\"title\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 140}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTUwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MVrOFrvL2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MVrOFrvL2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjE3MA==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.contenttype.model.type.ImmutableSimpleContentType'", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406170", "createdAt": "2020-02-19T16:52:41Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -14,13 +14,21 @@\n import com.dotcms.contenttype.business.ContentTypeAPI;\n import com.dotcms.contenttype.business.FieldAPI;\n import com.dotcms.contenttype.model.field.CategoryField;\n+import com.dotcms.contenttype.model.field.DataTypes;\n import com.dotcms.contenttype.model.field.Field;\n import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.ImmutableBinaryField;\n+import com.dotcms.contenttype.model.field.ImmutableTextField;\n import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.model.type.FileAssetContentType;\n+import com.dotcms.contenttype.model.type.ImmutableFileAssetContentType;\n+import com.dotcms.contenttype.model.type.ImmutableSimpleContentType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTU2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MlrOFrvL5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0MlrOFrvL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjE4Mg==", "bodyText": "Issue found: Avoid variables with short names like in", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406182", "createdAt": "2020-02-19T16:52:42Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTYxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0M1rOFrvL8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0M1rOFrvL8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjE5NA==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotcms.contenttype.model.type.FileAssetContentType'", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406194", "createdAt": "2020-02-19T16:52:43Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -14,13 +14,21 @@\n import com.dotcms.contenttype.business.ContentTypeAPI;\n import com.dotcms.contenttype.business.FieldAPI;\n import com.dotcms.contenttype.model.field.CategoryField;\n+import com.dotcms.contenttype.model.field.DataTypes;\n import com.dotcms.contenttype.model.field.Field;\n import com.dotcms.contenttype.model.field.FieldBuilder;\n+import com.dotcms.contenttype.model.field.ImmutableBinaryField;\n+import com.dotcms.contenttype.model.field.ImmutableTextField;\n import com.dotcms.contenttype.model.field.RelationshipField;\n+import com.dotcms.contenttype.model.type.BaseContentType;\n import com.dotcms.contenttype.model.type.ContentType;\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n+import com.dotcms.contenttype.model.type.FileAssetContentType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTczOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0NVrOFrvMBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0NVrOFrvMBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjIxNQ==", "bodyText": "Issue found: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406215", "createdAt": "2020-02-19T16:52:45Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTgwOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0NlrOFrvMFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0NlrOFrvMFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjIyOQ==", "bodyText": "Issue found: Ensure that resources like this OutputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406229", "createdAt": "2020-02-19T16:52:46Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"bzip2\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"ebzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.BZIP2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTgzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0N1rOFrvMGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0N1rOFrvMGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjIzMw==", "bodyText": "Issue found: Avoid variables with short names like in", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406233", "createdAt": "2020-02-19T16:52:47Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTkxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0OFrOFrvMJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0OFrOFrvMJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjI0Nw==", "bodyText": "Issue found: Unnecessary use of fully qualified name 'Assert.assertTrue' due to existing static import 'org.junit.Assert.assertTrue'", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406247", "createdAt": "2020-02-19T16:52:48Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();\n+\n+        ContentType contentType = ContentTypeBuilder.builder(BaseContentType.CONTENT.immutableClass())\n+                .description(\"Test ContentType Binary Fields\")\n+                .host(host.getIdentifier())\n+                .name(\"Test ContentType Binary Fields\")\n+                .owner(\"owner\")\n+                .variable(varname)\n+                .build();\n+\n+        contentType = contentTypeAPI.save(contentType);\n+\n+        Field textField = ImmutableTextField.builder()\n+                .name(\"Title\")\n+                .variable(\"title\")\n+                .contentTypeId(contentType.id())\n+                .dataType(DataTypes.TEXT)\n+                .build();\n+\n+        textField = fieldAPI.save(textField, user);\n+\n+        //Creating First Binary Field.\n+        Field binaryField1 = ImmutableBinaryField.builder()\n+                .name(\"Binary 1\")\n+                .variable(\"binary1\")\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField1 = fieldAPI.save(binaryField1, user);\n+\n+        //Creating Second Binary Field.\n+        Field binaryField2 = ImmutableBinaryField.builder()\n+                .name(\"Binary 2\")\n+                .variable(\"binary2\")\n+                .indexed(true)\n+                .searchable(true)\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField2 = fieldAPI.save(binaryField2, user);\n+\n+        final Contentlet contentlet = new Contentlet();\n+        contentlet.setContentType(contentType);\n+        contentlet.setProperty(\"title\", \"binary1\");\n+\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File binary1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(binary1, anyContent);\n+        final File binary2 = new File(ESMappingAPITest.class.getClassLoader().getResource(\"images/test.jpg\").getFile());\n+\n+        Assert.assertTrue(binary2.exists());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 177}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NTk1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0OVrOFrvMMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo0OVrOFrvMMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjI1OA==", "bodyText": "Issue found: Avoid unused imports such as 'com.dotmarketing.util.Config'", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406258", "createdAt": "2020-02-19T16:52:49Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -33,21 +41,31 @@\n import com.dotmarketing.portlets.categories.model.Category;\n import com.dotmarketing.portlets.contentlet.business.ContentletAPI;\n import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.dotmarketing.portlets.contentlet.model.IndexPolicy;\n+import com.dotmarketing.portlets.fileassets.business.FileAsset;\n+import com.dotmarketing.portlets.fileassets.business.FileAssetAPI;\n import com.dotmarketing.portlets.folders.business.FolderAPI;\n+import com.dotmarketing.portlets.folders.model.Folder;\n import com.dotmarketing.portlets.languagesmanager.business.LanguageAPI;\n import com.dotmarketing.portlets.languagesmanager.model.Language;\n import com.dotmarketing.portlets.structure.model.Relationship;\n+import com.dotmarketing.util.Config;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjAyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1MFrOFrvMPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1MFrOFrvMPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjI3MQ==", "bodyText": "Issue found: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406271", "createdAt": "2020-02-19T16:52:50Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjExOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1MlrOFrvMTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1MlrOFrvMTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjI4NQ==", "bodyText": "Issue found: Ensure that resources like this OutputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406285", "createdAt": "2020-02-19T16:52:52Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjIxOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1M1rOFrvMXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1M1rOFrvMXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjMwMA==", "bodyText": "Issue found: Ensure that resources like this InputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406300", "createdAt": "2020-02-19T16:52:53Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"bzip2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjI5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NFrOFrvMag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NFrOFrvMag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjMxNA==", "bodyText": "Issue found: Ensure that resources like this OutputStream object are closed after use", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406314", "createdAt": "2020-02-19T16:52:54Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjM4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NVrOFrvMdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NVrOFrvMdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjMyNw==", "bodyText": "Issue found: Avoid variables with short names like in", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406327", "createdAt": "2020-02-19T16:52:55Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"bzip2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjQ2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NlrOFrvMhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1NlrOFrvMhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjM0MA==", "bodyText": "Issue found: Avoid variables with short names like in", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406340", "createdAt": "2020-02-19T16:52:56Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjU2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1OFrOFrvMmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDozMTo1MVrOFtu2zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjM2MA==", "bodyText": "Issue found: In J2EE, getClassLoader() might not work as expected.  Use Thread.currentThread().getContextClassLoader() instead.", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406360", "createdAt": "2020-02-19T16:52:58Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();\n+\n+        ContentType contentType = ContentTypeBuilder.builder(BaseContentType.CONTENT.immutableClass())\n+                .description(\"Test ContentType Binary Fields\")\n+                .host(host.getIdentifier())\n+                .name(\"Test ContentType Binary Fields\")\n+                .owner(\"owner\")\n+                .variable(varname)\n+                .build();\n+\n+        contentType = contentTypeAPI.save(contentType);\n+\n+        Field textField = ImmutableTextField.builder()\n+                .name(\"Title\")\n+                .variable(\"title\")\n+                .contentTypeId(contentType.id())\n+                .dataType(DataTypes.TEXT)\n+                .build();\n+\n+        textField = fieldAPI.save(textField, user);\n+\n+        //Creating First Binary Field.\n+        Field binaryField1 = ImmutableBinaryField.builder()\n+                .name(\"Binary 1\")\n+                .variable(\"binary1\")\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField1 = fieldAPI.save(binaryField1, user);\n+\n+        //Creating Second Binary Field.\n+        Field binaryField2 = ImmutableBinaryField.builder()\n+                .name(\"Binary 2\")\n+                .variable(\"binary2\")\n+                .indexed(true)\n+                .searchable(true)\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField2 = fieldAPI.save(binaryField2, user);\n+\n+        final Contentlet contentlet = new Contentlet();\n+        contentlet.setContentType(contentType);\n+        contentlet.setProperty(\"title\", \"binary1\");\n+\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File binary1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(binary1, anyContent);\n+        final File binary2 = new File(ESMappingAPITest.class.getClassLoader().getResource(\"images/test.jpg\").getFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NzkzMw==", "bodyText": "Done", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r383497933", "createdAt": "2020-02-24T20:31:51Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();\n+\n+        ContentType contentType = ContentTypeBuilder.builder(BaseContentType.CONTENT.immutableClass())\n+                .description(\"Test ContentType Binary Fields\")\n+                .host(host.getIdentifier())\n+                .name(\"Test ContentType Binary Fields\")\n+                .owner(\"owner\")\n+                .variable(varname)\n+                .build();\n+\n+        contentType = contentTypeAPI.save(contentType);\n+\n+        Field textField = ImmutableTextField.builder()\n+                .name(\"Title\")\n+                .variable(\"title\")\n+                .contentTypeId(contentType.id())\n+                .dataType(DataTypes.TEXT)\n+                .build();\n+\n+        textField = fieldAPI.save(textField, user);\n+\n+        //Creating First Binary Field.\n+        Field binaryField1 = ImmutableBinaryField.builder()\n+                .name(\"Binary 1\")\n+                .variable(\"binary1\")\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField1 = fieldAPI.save(binaryField1, user);\n+\n+        //Creating Second Binary Field.\n+        Field binaryField2 = ImmutableBinaryField.builder()\n+                .name(\"Binary 2\")\n+                .variable(\"binary2\")\n+                .indexed(true)\n+                .searchable(true)\n+                .contentTypeId(contentType.id())\n+                .build();\n+\n+        binaryField2 = fieldAPI.save(binaryField2, user);\n+\n+        final Contentlet contentlet = new Contentlet();\n+        contentlet.setContentType(contentType);\n+        contentlet.setProperty(\"title\", \"binary1\");\n+\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File binary1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(binary1, anyContent);\n+        final File binary2 = new File(ESMappingAPITest.class.getClassLoader().getResource(\"images/test.jpg\").getFile());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjM2MA=="}, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 175}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjY1OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1OVrOFrvMpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1Mjo1OVrOFrvMpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjM3NQ==", "bodyText": "Issue found: Avoid variables with short names like in", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406375", "createdAt": "2020-02-19T16:52:59Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"gzip\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"egzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.GZIP);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"bzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"bzip2\");\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file, \"bzip2\");\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_bzip2_enum_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"ebzip2\");\n+        final OutputStream out = FileUtil.createOutputStream(file.toPath(), FileUtil.StreamCompressorType.BZIP2);\n+\n+        final String  string = \"testcompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file.toPath(), FileUtil.StreamCompressorType.BZIP2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2NjczOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MzowMFrOFrvMuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MzowMFrOFrvMuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjM5Mg==", "bodyText": "Issue found: The String literal \"testcompress\" appears 4 times in this file; the first occurrence is on line 46", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406392", "createdAt": "2020-02-19T16:53:00Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/test/java/com/liferay/util/FileUtilTest.java", "diffHunk": "@@ -2,19 +2,118 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n import java.nio.file.Files;\n import java.util.Calendar;\n import java.util.Date;\n import java.util.List;\n \n+import com.dotcms.util.CloseUtils;\n+import org.junit.Assert;\n import org.junit.Test;\n \n import com.google.common.collect.ImmutableList;\n import static org.junit.Assert.assertEquals;\n \n public class FileUtilTest {\n \n-  @Test\n+    @Test\n+    public void test_uncompress_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"nocompre_\");\n+        final OutputStream out = FileUtil.createOutputStream(file);\n+\n+        final String  string = \"testuncompress\";\n+        final byte [] bytes  = string.getBytes();\n+        out.write(bytes);\n+        CloseUtils.closeQuietly(out);\n+\n+        final InputStream in   = FileUtil.createInputStream(file);\n+        final byte [] buff     = new byte[bytes.length];\n+        in.read(buff);\n+        CloseUtils.closeQuietly(in);\n+\n+        Assert.assertEquals(\"The file recovery should be the file saved\", new String(buff), string);\n+    }\n+\n+    @Test\n+    public void test_compress_gzip_outputstream()  throws Exception {\n+\n+        final File file = com.dotmarketing.util.FileUtil.createTemporalFile(\"gzip\");\n+        final OutputStream out = FileUtil.createOutputStream(file, \"gzip\");\n+\n+        final String  string = \"testcompress\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MDc2Njc2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MzowMlrOFrvMwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo1MzowMlrOFrvMwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwNjQwMQ==", "bodyText": "Issue found: Useless parentheses.", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r381406401", "createdAt": "2020-02-19T16:53:02Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -464,203 +546,217 @@ protected void loadPermissions(final Contentlet con, final Map<String,Object> m)\n \n \tpublic static final FastDateFormat timeFormat = FastDateFormat.getInstance(\"HH:mm:ss\");\n \n-\tprotected void loadFields(Contentlet con, Map<String, Object> m) throws DotDataException {\n+\tprotected void loadFields(final Contentlet contentlet, final Map<String, Object> contentletMap) throws DotDataException {\n \n \t\t// https://github.com/dotCMS/dotCMS/issues/6152\n-\t\tDecimalFormatSymbols otherSymbols = new DecimalFormatSymbols();\n+\t\tfinal DecimalFormatSymbols otherSymbols = new DecimalFormatSymbols();\n \t\totherSymbols.setDecimalSeparator('.');\n \n-\t\tDecimalFormat numFormatter = new DecimalFormat(\"0000000000000000000.000000000000000000\", otherSymbols);\n-\n-\t\tFieldAPI fAPI=APILocator.getFieldAPI();\n-\t\tfinal List<Field> fields = new ArrayList<>(\n-\t\t\t\tFieldsCache.getFieldsByStructureInode(con.getStructureInode()));\n-\n-\t\tStructure st=con.getStructure();\n+\t\tfinal DecimalFormat numFormatter = new DecimalFormat(\"0000000000000000000.000000000000000000\", otherSymbols);\n+\t\tfinal FieldAPI fieldAPI   = APILocator.getFieldAPI();\n+\t\tfinal List<Field> fields  = new ArrayList<>(\n+\t\t\t\tFieldsCache.getFieldsByStructureInode(contentlet.getStructureInode()));\n+\t\tfinal Structure structure = contentlet.getStructure();\n \t\tStringBuilder keyNameBuilder;\n \t\tString keyName;\n \t\tString keyNameText;\n-\n \t\tfinal TikaUtils tikaUtils = new TikaUtils();\n \n-\t\tfor (Field f : fields) {\n+\t\tfor (final Field field : fields) {\n \n-\t\t\tkeyNameBuilder = new StringBuilder(st.getVelocityVarName()).append(\".\")\n-\t\t\t\t\t.append(f.getVelocityVarName());\n+\t\t\tkeyNameBuilder = new StringBuilder(structure.getVelocityVarName()).append(\".\")\n+\t\t\t\t\t.append(field.getVelocityVarName());\n \t\t\tkeyName        = keyNameBuilder.toString();\n \t\t\tkeyNameText    = keyNameBuilder.append(TEXT).toString();\n-\t\t\tif (f.getFieldType().equals(Field.FieldType.BINARY.toString())\n-\t\t\t\t\t|| f.getFieldContentlet() != null && (f.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SYSTEM_FIELD) && !f.getFieldType().equals(Field.FieldType.TAG.toString()))) {\n+\t\t\tif (field.getFieldType().equals(Field.FieldType.BINARY.toString()) // todo: remove this since we are going to index the binary fields\n+\t\t\t\t\t|| field.getFieldContentlet() != null && (field.getFieldContentlet().startsWith(ESMappingConstants.FIELD_TYPE_SYSTEM_FIELD)\n+\t\t\t\t\t&& !field.getFieldType().equals(Field.FieldType.TAG.toString()))) {\n+\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tif(!f.isIndexed()){\n+\n+\t\t\tif(!field.isIndexed()) {\n+\n \t\t\t\tcontinue;\n \t\t\t}\n+\n \t\t\ttry {\n-\t\t\t\tif(fAPI.isElementConstant(f)){\n-\t\t\t\t\tm.put(keyName, (f.getValues() == null ? \"\":f.getValues()));\n+\t\t\t\tif(fieldAPI.isElementConstant(field)){\n+\t\t\t\t\tcontentletMap.put(keyName, (field.getValues() == null ? \"\":field.getValues()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 306}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2OTI5ODY3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoyMzoxNlrOFs-m4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyMzozMlrOFtuoNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNzQyNg==", "bodyText": "Just as suggestion: use more explicit variable names since a dotcms \"variable\" can belong to different type of things, so only varname can be confusing for referencing. Suggestion: testContentTypeVarName", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r382707426", "createdAt": "2020-02-21T17:23:16Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NDE5Ng==", "bodyText": "Done", "url": "https://github.com/dotCMS/core/pull/17962#discussion_r383494196", "createdAt": "2020-02-24T20:23:32Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -75,11 +97,126 @@ public static void prepare() throws Exception {\n         contentTypeAPI = APILocator.getContentTypeAPI(user);\n         contentletAPI = APILocator.getContentletAPI();\n         fieldAPI = APILocator.getContentTypeFieldAPI();\n+        folderAPI = APILocator.getFolderAPI();\n         languageAPI = APILocator.getLanguageAPI();\n         language = languageAPI.getDefaultLanguage();\n         relationshipAPI = APILocator.getRelationshipAPI();\n     }\n \n+    @Test\n+    public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String rootFolderName = String.format(\"lolFolder-%d\", System.currentTimeMillis());\n+        final Folder root1 = folderAPI.createFolders(rootFolderName, host, user, false);\n+        final FileAsset fileAsset = new FileAsset();\n+        final ImmutableFileAssetContentType.Builder builder = ImmutableFileAssetContentType.builder();\n+        builder.name(\"Test\").variable(\"testfa\");\n+        final ContentType fileAssetContentType = contentTypeAPI.find(\"FileAsset\");\n+        final String fileName1 = TEMP_FILE + System.currentTimeMillis();\n+        final File tempFile1 = File.createTempFile(fileName1, TXT);\n+        final String anyContent = \"LOL!\";\n+        FileUtil.write(tempFile1, anyContent);\n+        final String fileNameField1 = fileName1 + DOT_TXT;\n+        final String title1 = \"Contentlet-1\";\n+\n+        fileAsset.setContentType(fileAssetContentType);\n+        fileAsset.setFolder(root1.getInode());\n+        fileAsset.setBinary(FileAssetAPI.BINARY_FIELD, tempFile1);\n+        fileAsset.setStringProperty(FileAssetAPI.HOST_FOLDER_FIELD, root1.getInode());\n+        fileAsset.setStringProperty(FileAssetAPI.TITLE_FIELD, title1);\n+        fileAsset.setStringProperty(FileAssetAPI.FILE_NAME_FIELD, fileNameField1);\n+        fileAsset.setIndexPolicy(IndexPolicy.FORCE);\n+\n+        // Create a piece of content for the default host\n+        final Map<String,Object>  contentletMap = esMappingAPI.toMap(APILocator.getContentletAPI().checkin(fileAsset, user, false));\n+\n+        assertNotNull(contentletMap);\n+        assertEquals(fileNameField1.toLowerCase(), contentletMap.get(\"fileasset.filename\"));\n+        assertEquals(\"fileasset\", contentletMap.get(\"structurename\"));\n+        assertEquals(\"text/plain; charset=iso-8859-1\", contentletMap.get(\"metadata.contenttype\"));\n+        assertEquals(\"4\", contentletMap.get(\"metadata.filesize\"));\n+        assertTrue( contentletMap.get(\"metadata.content\").toString().contains(\"lol!\"));\n+\n+    }\n+\n+    @Test\n+    public void test_toMap_binary_field_shouldSuccess() throws Exception {\n+\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+        final FieldAPI         fieldAPI        = APILocator.getContentTypeFieldAPI();\n+        final Host host = APILocator.getHostAPI().findDefaultHost(user, false);\n+        final String varname = \"testcontenttypetwobinaryfields\" + System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNzQyNg=="}, "originalCommit": {"oid": "98e1fdb8b053c8982cdd52fd7bc3bd25be63c058"}, "originalPosition": 126}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2540, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}