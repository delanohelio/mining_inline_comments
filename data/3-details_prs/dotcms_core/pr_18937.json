{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NjY0MTYw", "number": 18937, "title": "Issue 18553", "bodyText": "Add Growl Notifications to PP. We have 2 types of Notifications:\n\nSucces = Lasts 5 seconds.\nFailure = Until the user dismisses it and includes a link to the Publishing Queue Portlet. This notification will pop up until the number of tries is reached (3 by default).\n\nIf the bundle has a name set it will show it, If not it will show the title and the type of the first items that are in the bundle.", "createdAt": "2020-07-21T18:08:32Z", "url": "https://github.com/dotCMS/core/pull/18937", "merged": true, "mergeCommit": {"oid": "f90eea6fce816d1e5ed99380ce7cabeb1ae3d6bd"}, "closed": true, "closedAt": "2020-07-22T18:08:58Z", "author": {"login": "erickgonzalez"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc058ZRAH2gAyNDU0NjY0MTYwOjAzMmUzNGNmNTdhNTI1OTU2N2UyZWIzMjg5ZGE1ZjY2MGJlNGM2Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3e1dwAFqTQ1MzU2MjkwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "032e34cf57a5259567e2eb3289da5f660be4c628", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/032e34cf57a5259567e2eb3289da5f660be4c628", "committedDate": "2020-07-14T18:00:42Z", "message": "#18553 comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bc62ea156cf4d023650b07c9d24cc9f661acc28", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/6bc62ea156cf4d023650b07c9d24cc9f661acc28", "committedDate": "2020-07-14T18:01:18Z", "message": "#18553 add new severity SUCCESS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa9604c343e0c1a0422db93635effd8b37a94989", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/aa9604c343e0c1a0422db93635effd8b37a94989", "committedDate": "2020-07-14T18:02:06Z", "message": "#18553 growl notifications to PP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c99ef45346e9c307cac6a165cdd8a20331c4e051", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/c99ef45346e9c307cac6a165cdd8a20331c4e051", "committedDate": "2020-07-15T21:08:25Z", "message": "#18553 change life success to 5 sec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f53766a23a40335518b29f8dfe61bb368160543b", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/f53766a23a40335518b29f8dfe61bb368160543b", "committedDate": "2020-07-15T21:09:17Z", "message": "#18553 link when failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ddfd4f5189cc563368e3e174b9ec7610a2f2bbe", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/6ddfd4f5189cc563368e3e174b9ec7610a2f2bbe", "committedDate": "2020-07-17T16:11:22Z", "message": "#18553 remove log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/166df6f57a44bba210126c30304c33d4b9e7a134", "committedDate": "2020-07-21T17:01:14Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18553"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzEyMTAy", "url": "https://github.com/dotCMS/core/pull/18937#pullrequestreview-452712102", "createdAt": "2020-07-21T18:14:02Z", "commit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxNDowMlrOG1EH8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxNDowMlrOG1EH8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5NTI4Mg==", "bodyText": "I would extract to a private method sendNotification", "url": "https://github.com/dotCMS/core/pull/18937#discussion_r458295282", "createdAt": "2020-07-21T18:14:02Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/business/PublisherQueueJob.java", "diffHunk": "@@ -355,6 +381,46 @@ private void updateBundleStatus(final PublishAuditStatus bundleAudit,\n \t\t\t}\n \t\t}\n \t\tLogger.info(this, \"===========================================================\");\n+\n+\t\t//Growl Notifications\n+\t\tif(UtilMethods.isSet(notificationMessage)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzE0MzAw", "url": "https://github.com/dotCMS/core/pull/18937#pullrequestreview-452714300", "createdAt": "2020-07-21T18:17:03Z", "commit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxNzowNFrOG1EOsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxNzowNFrOG1EOsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5NzAwOQ==", "bodyText": "All these arguments could become an object called NotificationParams and use a builder pattern.\nE.g.\nnew NotificationParamsBuilder().withMessage(\"\").withMessageArgument(\"\").withNotificationLife(\"\").withSeverity(SUCCESS)\nand then call the .build() when passing it to the private method sendNotification(builder.build())", "url": "https://github.com/dotCMS/core/pull/18937#discussion_r458297009", "createdAt": "2020-07-21T18:17:04Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/business/PublisherQueueJob.java", "diffHunk": "@@ -292,10 +303,19 @@ private void updateAuditStatus(final List<Map<String, Object>> bundlesInQueue) t\n \t@NotNull\n \tprivate void updateBundleStatus(final PublishAuditStatus bundleAudit,\n \t\t\t\t\t\t\t\t\tfinal Map<String, Map<String, EndpointDetail>> endpointTrackingMap,\n-\t\t\t\t\t\t\t\t\tfinal GroupPushStats groupPushStats, final List<Map<String, Object>> bundlesInQueue) throws DotDataException, DotPublisherException {\n+\t\t\t\t\t\t\t\t\tfinal GroupPushStats groupPushStats, final List<Map<String, Object>> bundlesInQueue)\n+\t\t\tthrows DotDataException, DotPublisherException, DotSecurityException, LanguageException {\n \t\tStatus bundleStatus;\n \t\tfinal PublishAuditHistory localHistory = bundleAudit.getStatusPojo();\n \t\tfinal String auditedBundleId = bundleAudit.getBundleId();\n+\t\t//Info need to generate Growl Notification\n+\t\tfinal Bundle bundle = APILocator.getBundleAPI().getBundleById(auditedBundleId);\n+\t\tfinal boolean isBundleNameGenerated = bundle.getName().startsWith(\"bundle-\");\n+\t\tString notificationMessage = \"\";\n+\t\tString notificationMessageArgument = \"\";\n+\t\tlong notificationLife = 5000;\n+\t\tMessageSeverity notificationSeverity = MessageSeverity.SUCCESS;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzE2MTU2", "url": "https://github.com/dotCMS/core/pull/18937#pullrequestreview-452716156", "createdAt": "2020-07-21T18:18:51Z", "commit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxODo1MVrOG1ETUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODoxODo1MVrOG1ETUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI5ODE5NQ==", "bodyText": "not sure if this should be configurable in order to get more detail if wanted", "url": "https://github.com/dotCMS/core/pull/18937#discussion_r458298195", "createdAt": "2020-07-21T18:18:51Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/business/PublisherQueueJob.java", "diffHunk": "@@ -355,6 +381,46 @@ private void updateBundleStatus(final PublishAuditStatus bundleAudit,\n \t\t\t}\n \t\t}\n \t\tLogger.info(this, \"===========================================================\");\n+\n+\t\t//Growl Notifications\n+\t\tif(UtilMethods.isSet(notificationMessage)){\n+\t\t\tfinal SystemMessageBuilder message = new SystemMessageBuilder()\n+\t\t\t\t\t.setMessage(LanguageUtil.format(\n+\t\t\t\t\t\t\tAPILocator.getUserAPI().loadUserById(bundle.getOwner()).getLocale(),\n+\t\t\t\t\t\t\tnotificationMessage,\n+\t\t\t\t\t\t\tnotificationMessageArgument))\n+\t\t\t\t\t.setSeverity(notificationSeverity)\n+\t\t\t\t\t.setType(MessageType.SIMPLE_MESSAGE)\n+\t\t\t\t\t.setLife(notificationLife);\n+\n+\t\t\tSystemMessageEventUtil.getInstance().pushMessage(message.create(), ImmutableList.of(bundle.getOwner()));\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Utility method to generate the bundle title for the notification, checks the amount of assets and\n+\t * only shows the assetType and assetTitle of the first three items, if there are more the amount of\n+\t * remain assets is shown.\n+\t *\n+\t * @param bundleAssets assets that were added manually to the bundle\n+\t * @return a string that will be the argument for the notification\n+\t */\n+\tprivate String generateBundleTitle(final Map<String,String> bundleAssets)\n+\t\t\tthrows LanguageException {\n+\t\tint count = 0;\n+\t\tString bundleTitle = \"\";\n+\t\tfor(final String id : bundleAssets.keySet()){\n+\t\t\tif(count < 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzE2Mjg3", "url": "https://github.com/dotCMS/core/pull/18937#pullrequestreview-452716287", "createdAt": "2020-07-21T18:19:02Z", "commit": {"oid": "166df6f57a44bba210126c30304c33d4b9e7a134"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199c541e6a9a2ddbbfaaa046e1d36e1ef9ae1ab7", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/199c541e6a9a2ddbbfaaa046e1d36e1ef9ae1ab7", "committedDate": "2020-07-22T18:03:03Z", "message": "#18553 refactor PP Notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTYyOTA4", "url": "https://github.com/dotCMS/core/pull/18937#pullrequestreview-453562908", "createdAt": "2020-07-22T18:07:29Z", "commit": {"oid": "199c541e6a9a2ddbbfaaa046e1d36e1ef9ae1ab7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 829, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}