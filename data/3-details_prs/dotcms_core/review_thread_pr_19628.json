{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTg2MzY4", "number": 19628, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMjozNVrOE-2_7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMzoyOVrOE-3A2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MzQ4MjY5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMjozNVrOH8PnzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNjo0Mjo0MFrOH8142g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng==", "bodyText": "So this maps a tag field as keyword, but isn't there another part to this?  When putting a content tag field into ES, don't we have to put the tags in as an array of Strings?", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932556", "createdAt": "2020-11-30T22:02:35Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -361,20 +363,31 @@ private void addMappingForFieldIfNeeded(\n                 .of(DataTypes.BOOL, \"boolean\", DataTypes.FLOAT, \"double\", DataTypes.INTEGER,\n                         \"long\");\n         String mappingForField = null;\n-        if (field instanceof DateField || field instanceof DateTimeField\n-                || field instanceof TimeField) {\n-            mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n-            mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n-        } else if (field instanceof TextField || field instanceof TextAreaField\n-                || field instanceof WysiwygField || field instanceof RadioField\n-                || field instanceof SelectField) {\n-            if (dataTypesMap.containsKey(field.dataType())) {\n-                mappingForField = String.format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\", dataTypesMap.get(field.dataType()));\n-            } else if (!matchesExclusions(fieldVariableName)){\n-                mappingForField = \"{\\n\"\n-                        + \"\\\"type\\\":\\\"text\\\",\\n\"\n-                        + \"\\\"analyzer\\\":\\\"my_analyzer\\\"\"\n-                        + \"\\n}\";\n+\n+        if (!matchesExclusions(fieldVariableName)) {\n+            if (field instanceof DateField || field instanceof DateTimeField\n+                    || field instanceof TimeField) {\n+                mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n+                mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n+            } else if (field instanceof TextField || field instanceof TextAreaField\n+                    || field instanceof WysiwygField || field instanceof RadioField\n+                    || field instanceof SelectField || field instanceof MultiSelectField\n+                    || field instanceof TagField) {\n+\n+                if (dataTypesMap.containsKey(field.dataType())) {\n+                    mappingForField = String\n+                            .format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\",\n+                                    dataTypesMap.get(field.dataType()));\n+                } else {\n+                    if (field.unique() || field instanceof TagField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ5MTAzNg==", "bodyText": "@wezell it's already implemented here: https://github.com/dotCMS/core/blob/master/dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java#L703-L708 . But I'll confirm with Kibana \ud83d\udc4d", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533491036", "createdAt": "2020-12-01T15:15:17Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -361,20 +363,31 @@ private void addMappingForFieldIfNeeded(\n                 .of(DataTypes.BOOL, \"boolean\", DataTypes.FLOAT, \"double\", DataTypes.INTEGER,\n                         \"long\");\n         String mappingForField = null;\n-        if (field instanceof DateField || field instanceof DateTimeField\n-                || field instanceof TimeField) {\n-            mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n-            mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n-        } else if (field instanceof TextField || field instanceof TextAreaField\n-                || field instanceof WysiwygField || field instanceof RadioField\n-                || field instanceof SelectField) {\n-            if (dataTypesMap.containsKey(field.dataType())) {\n-                mappingForField = String.format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\", dataTypesMap.get(field.dataType()));\n-            } else if (!matchesExclusions(fieldVariableName)){\n-                mappingForField = \"{\\n\"\n-                        + \"\\\"type\\\":\\\"text\\\",\\n\"\n-                        + \"\\\"analyzer\\\":\\\"my_analyzer\\\"\"\n-                        + \"\\n}\";\n+\n+        if (!matchesExclusions(fieldVariableName)) {\n+            if (field instanceof DateField || field instanceof DateTimeField\n+                    || field instanceof TimeField) {\n+                mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n+                mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n+            } else if (field instanceof TextField || field instanceof TextAreaField\n+                    || field instanceof WysiwygField || field instanceof RadioField\n+                    || field instanceof SelectField || field instanceof MultiSelectField\n+                    || field instanceof TagField) {\n+\n+                if (dataTypesMap.containsKey(field.dataType())) {\n+                    mappingForField = String\n+                            .format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\",\n+                                    dataTypesMap.get(field.dataType()));\n+                } else {\n+                    if (field.unique() || field instanceof TagField) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng=="}, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1OTUxNA==", "bodyText": "I have confirmed. No additional change is needed", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533559514", "createdAt": "2020-12-01T16:42:40Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/util/ESMappingUtilHelper.java", "diffHunk": "@@ -361,20 +363,31 @@ private void addMappingForFieldIfNeeded(\n                 .of(DataTypes.BOOL, \"boolean\", DataTypes.FLOAT, \"double\", DataTypes.INTEGER,\n                         \"long\");\n         String mappingForField = null;\n-        if (field instanceof DateField || field instanceof DateTimeField\n-                || field instanceof TimeField) {\n-            mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n-            mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n-        } else if (field instanceof TextField || field instanceof TextAreaField\n-                || field instanceof WysiwygField || field instanceof RadioField\n-                || field instanceof SelectField) {\n-            if (dataTypesMap.containsKey(field.dataType())) {\n-                mappingForField = String.format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\", dataTypesMap.get(field.dataType()));\n-            } else if (!matchesExclusions(fieldVariableName)){\n-                mappingForField = \"{\\n\"\n-                        + \"\\\"type\\\":\\\"text\\\",\\n\"\n-                        + \"\\\"analyzer\\\":\\\"my_analyzer\\\"\"\n-                        + \"\\n}\";\n+\n+        if (!matchesExclusions(fieldVariableName)) {\n+            if (field instanceof DateField || field instanceof DateTimeField\n+                    || field instanceof TimeField) {\n+                mappingForField = \"{\\n\\\"type\\\":\\\"date\\\",\\n\";\n+                mappingForField += \"\\\"format\\\": \\\"yyyy-MM-dd't'HH:mm:ss||MMM d, yyyy h:mm:ss a||yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis\\\"\\n}\";\n+            } else if (field instanceof TextField || field instanceof TextAreaField\n+                    || field instanceof WysiwygField || field instanceof RadioField\n+                    || field instanceof SelectField || field instanceof MultiSelectField\n+                    || field instanceof TagField) {\n+\n+                if (dataTypesMap.containsKey(field.dataType())) {\n+                    mappingForField = String\n+                            .format(\"{\\n\\\"type\\\":\\\"%s\\\"\\n}\",\n+                                    dataTypesMap.get(field.dataType()));\n+                } else {\n+                    if (field.unique() || field instanceof TagField) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjU1Ng=="}, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MzQ4NTA3OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjowMzoyOVrOH8PpVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMTo0NToyMlrOH9HDLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ==", "bodyText": "What if the unique field has a quote \" in its value?", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r532932949", "createdAt": "2020-11-30T22:03:29Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -6311,9 +6313,18 @@ else if(field.getFieldType().equals(Field.FieldType.DATE_TIME.toString())){\n \n                     buffy.append(\" +languageId:\" + contentlet.getLanguageId());\n \n-                    buffy.append(\" +\" + contentlet.getContentType().variable() + StringPool.PERIOD + field\n-                            .getVelocityVarName() + StringPool.COLON);\n-                    buffy.append(getFieldValue(contentlet, new LegacyFieldTransformer(field).from()));\n+                    buffy.append(\" +\" + contentlet.getContentType().variable()).append(StringPool.PERIOD)\n+                            .append(field.getVelocityVarName());\n+\n+                    if (isDataTypeNumber){\n+                        buffy.append(StringPool.COLON).append(\"\\\"\").append(getFieldValue(contentlet,\n+                                new LegacyFieldTransformer(field).from())).append(\"\\\"\");\n+                    }else{\n+                        buffy.append(\"_dotraw\").append(StringPool.COLON).append(\"\\\"\")\n+                                .append(getFieldValue(contentlet,\n+                                        new LegacyFieldTransformer(field).from()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ5MTI4NA==", "bodyText": "I'll do some tests", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533491284", "createdAt": "2020-12-01T15:15:35Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -6311,9 +6313,18 @@ else if(field.getFieldType().equals(Field.FieldType.DATE_TIME.toString())){\n \n                     buffy.append(\" +languageId:\" + contentlet.getLanguageId());\n \n-                    buffy.append(\" +\" + contentlet.getContentType().variable() + StringPool.PERIOD + field\n-                            .getVelocityVarName() + StringPool.COLON);\n-                    buffy.append(getFieldValue(contentlet, new LegacyFieldTransformer(field).from()));\n+                    buffy.append(\" +\" + contentlet.getContentType().variable()).append(StringPool.PERIOD)\n+                            .append(field.getVelocityVarName());\n+\n+                    if (isDataTypeNumber){\n+                        buffy.append(StringPool.COLON).append(\"\\\"\").append(getFieldValue(contentlet,\n+                                new LegacyFieldTransformer(field).from())).append(\"\\\"\");\n+                    }else{\n+                        buffy.append(\"_dotraw\").append(StringPool.COLON).append(\"\\\"\")\n+                                .append(getFieldValue(contentlet,\n+                                        new LegacyFieldTransformer(field).from()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ=="}, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg0MDY4Ng==", "bodyText": "@wezell I have fixed it. I modified the logic to use the _sha256 field to make the validation more accurate and consider special characters.\nBesides, _sha256 are now mapped as keyword", "url": "https://github.com/dotCMS/core/pull/19628#discussion_r533840686", "createdAt": "2020-12-02T01:45:22Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "diffHunk": "@@ -6311,9 +6313,18 @@ else if(field.getFieldType().equals(Field.FieldType.DATE_TIME.toString())){\n \n                     buffy.append(\" +languageId:\" + contentlet.getLanguageId());\n \n-                    buffy.append(\" +\" + contentlet.getContentType().variable() + StringPool.PERIOD + field\n-                            .getVelocityVarName() + StringPool.COLON);\n-                    buffy.append(getFieldValue(contentlet, new LegacyFieldTransformer(field).from()));\n+                    buffy.append(\" +\" + contentlet.getContentType().variable()).append(StringPool.PERIOD)\n+                            .append(field.getVelocityVarName());\n+\n+                    if (isDataTypeNumber){\n+                        buffy.append(StringPool.COLON).append(\"\\\"\").append(getFieldValue(contentlet,\n+                                new LegacyFieldTransformer(field).from())).append(\"\\\"\");\n+                    }else{\n+                        buffy.append(\"_dotraw\").append(StringPool.COLON).append(\"\\\"\")\n+                                .append(getFieldValue(contentlet,\n+                                        new LegacyFieldTransformer(field).from()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkzMjk0OQ=="}, "originalCommit": {"oid": "c1a4682463a8ab30d8b4b79f11dbaafd0dbad987"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1712, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}