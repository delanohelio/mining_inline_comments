{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1ODI1ODEy", "number": 18323, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozMTozMFrODzwg9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTowNDoxMlrOEYndKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTk4ODM4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozMTozMFrOGIXe3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozMTozMFrOGIXe3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyNjUyNA==", "bodyText": "I think we are missing some test here", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r411426524", "createdAt": "2020-04-20T14:31:30Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -121,7 +135,47 @@ public void setServiceParameters(List<ServiceParameter> params) {\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey();\n+    }\n+\n+\n+    private String getFallbackApiKey () {\n+\n+        final String appsTranslationKey    = Config.getStringProperty(\"apps_translation_key\", \"app-translation\");\n+        final String appsTranslationApiKey = Config.getStringProperty(\"apps_translation_apikey\", \"apiKey\");\n+\n+        Optional<AppSecrets> appSecretsOpt = Optional.empty();\n+        try {\n+            appSecretsOpt = APILocator.getAppsAPI().getSecrets\n+                    (appsTranslationKey, true, this.resolveHost(), APILocator.systemUser());\n+        } catch (DotDataException | DotSecurityException e) {\n+            Logger.error(this, e.getMessage());\n+        }\n+\n+        if (appSecretsOpt.isPresent()) {\n+\n+            final Secret secret = appSecretsOpt.get().getSecrets().get(appsTranslationApiKey);\n+            if (null != secret) {\n+                return secret.getString();\n+            }\n+        }\n+\n+        return Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", StringPool.BLANK);\n+    }\n+\n+    private Host resolveHost () {\n+\n+        Host  host = null;\n+        final HttpServletRequest request = HttpServletRequestThreadLocal.INSTANCE.getRequest();\n+        if (null != request) {\n+            host = Try.of(()->WebAPILocator.getHostWebAPI().getCurrentHostNoThrow(request)).getOrNull();\n+        }\n+\n+        if (null == host) {\n+            host = Try.of(() -> APILocator.getHostAPI().findDefaultHost(APILocator.systemUser(), false)).getOrNull();\n+        }\n+\n+        return null == host? APILocator.systemHost(): host;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb980bf8635edbe817b3466ae3dd10f6f116dabb"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MTgyMjQ4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjowNDowMFrOGJMqgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjowNDowMFrOGJMqgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5Nzg1Nw==", "bodyText": "This logic should be tested", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r412297857", "createdAt": "2020-04-21T16:04:00Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/translate/GoogleTranslationService.java", "diffHunk": "@@ -113,15 +127,60 @@ public String translateString(String toTranslate, Language from, Language to) th\n     }\n \n     @Override\n-    public void setServiceParameters(List<ServiceParameter> params) {\n+    public void setServiceParameters(final List<ServiceParameter> params, final Optional<String> hostOpt) {\n         this.params = params;\n         Map<String, ServiceParameter> paramsMap = params.stream().collect(\n             Collectors.toMap(ServiceParameter::getKey, Function.identity()));\n         String apiKeyValue = paramsMap.get(\"apiKey\").getValue();\n \n         this.apiKey = !Strings.isNullOrEmpty(apiKeyValue)\n             ?apiKeyValue\n-            :Config.getStringProperty(\"GOOGLE_TRANSLATE_SERVICE_API_KEY\", \"\");\n+            :this.getFallbackApiKey(hostOpt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b85b4153a6e59710e24901250520302fd9fb3192"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjUwNDY5OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1NzoxN1rOG_lNIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjo0MzoyOFrOG_psdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzA0MA==", "bodyText": "Tests need doc", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r469323040", "createdAt": "2020-08-12T14:57:17Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NjU5OQ==", "bodyText": "done", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r469396599", "createdAt": "2020-08-12T16:43:28Z", "author": {"login": "erickgonzalez"}, "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzA0MA=="}, "originalCommit": {"oid": "a8da6e525fbad3844bf9c07a1108e4bd3b63c3a8"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MjQ3NzIzOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTowNDoxMlrOHBDRkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMTowNDoxMlrOHBDRkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2NDI3NQ==", "bodyText": "Codacy found an issue: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/18323#discussion_r470864275", "createdAt": "2020-08-14T21:04:12Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/translate/GoogleTranslationServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.dotcms.translate;\n+\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.TestDataUtils;\n+import com.dotcms.datagen.TestUserUtils;\n+import com.dotcms.security.apps.AppSecrets;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.contentlet.model.Contentlet;\n+import com.liferay.portal.model.User;\n+import com.liferay.util.StringPool;\n+import com.dotmarketing.util.Config;\n+import java.util.Collections;\n+import java.util.List;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class GoogleTranslationServiceIntegrationTest {\n+\n+    private static User admin;\n+    private static GoogleTranslationService translationService;\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49bd0207c8eadb02ba8160904ed90d89ffafc3f"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2226, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}