{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzcwNzM1", "number": 18674, "title": "#18673 : Adding validation to the objects that have a high chance of \u2026", "bodyText": "\u2026causing NPEs because of incorrect/unexpected content information during the reindex. Improving error logging. These errors are very likely because the customer who experienced them comes from a very old version of dotCMS.", "createdAt": "2020-06-16T17:44:14Z", "url": "https://github.com/dotCMS/core/pull/18674", "merged": true, "mergeCommit": {"oid": "f78a343eb74df29f2264242a42fa0b6a085fef23"}, "closed": true, "closedAt": "2020-07-09T16:15:28Z", "author": {"login": "jcastro-dotcms"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr462DgH2gAyNDM1MzcwNzM1OmQwOTUxNmQwNzJlZTI1MWNlNTM4MzZlYjI4Mzg4NDcwYmQwYjQ2YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy_pI7gFqTQ0NTA2ODIyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d09516d072ee251ce53836eb28388470bd0b46b1", "author": {"user": {"login": "jcastro-dotcms", "name": "Jose Castro"}}, "url": "https://github.com/dotCMS/core/commit/d09516d072ee251ce53836eb28388470bd0b46b1", "committedDate": "2020-06-16T17:43:47Z", "message": "#18673 : Adding validation to the objects that have a high chance of causing NPEs because of incorrect/unexpected content information during the reindex. Improving error logging. These errors are very likely because the customer who experienced them comes from a very old version of dotCMS."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzUxNzQ4", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-431751748", "createdAt": "2020-06-16T17:51:21Z", "commit": {"oid": "d09516d072ee251ce53836eb28388470bd0b46b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo1MToyMVrOGkmoUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo1MToyMVrOGkmoUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNDgzNQ==", "bodyText": "DotDataException", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r441034835", "createdAt": "2020-06-16T17:51:21Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESMappingAPIImpl.java", "diffHunk": "@@ -189,10 +189,36 @@ public String toJson(final Contentlet contentlet) throws DotMappingException {\n             loadRelationshipFields(contentlet, contentletMap, sw);\n \n \t\t\tfinal Identifier contentIdentifier = APILocator.getIdentifierAPI().find(contentlet);\n+            if (null == contentIdentifier || !UtilMethods.isSet(contentIdentifier.getId())) {\n+                final String errorMsg = String.format(\"Identifier '%s' was not found via API.\", contentlet\n+                        .getIdentifier());\n+                throw new Exception(errorMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09516d072ee251ce53836eb28388470bd0b46b1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b", "author": {"user": {"login": "jcastro-dotcms", "name": "Jose Castro"}}, "url": "https://github.com/dotCMS/core/commit/a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b", "committedDate": "2020-06-16T17:57:00Z", "message": "#18673 : Adding code review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzU3MzAx", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-431757301", "createdAt": "2020-06-16T17:58:29Z", "commit": {"oid": "a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDM3ODY2", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-435037866", "createdAt": "2020-06-22T15:29:13Z", "commit": {"oid": "a0e3b4909a339d7226fbb6d5c9fe7fcca9ad1b3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9938bcfcc5e8f4b36ae0bdeece14f617bbb49262", "author": {"user": {"login": "freddyucv", "name": "Freddy Rodriguez"}}, "url": "https://github.com/dotCMS/core/commit/9938bcfcc5e8f4b36ae0bdeece14f617bbb49262", "committedDate": "2020-07-07T21:30:37Z", "message": "#18673 testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "107fdac2966377d5256dc1df93f980bee747a3b3", "author": {"user": {"login": "freddyucv", "name": "Freddy Rodriguez"}}, "url": "https://github.com/dotCMS/core/commit/107fdac2966377d5256dc1df93f980bee747a3b3", "committedDate": "2020-07-07T21:34:05Z", "message": "#18673 merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a", "author": {"user": {"login": "freddyucv", "name": "Freddy Rodriguez"}}, "url": "https://github.com/dotCMS/core/commit/9d2526a38591cb54642add73c8a84c65e659e82a", "committedDate": "2020-07-08T18:05:02Z", "message": "#18673 Testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDE0MzQ2", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-445014346", "createdAt": "2020-07-08T18:12:02Z", "commit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODoxMjowMlrOGuzwaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODoxMjowMlrOGuzwaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNTY1Nw==", "bodyText": "Codacy found an issue: Avoid unused local variables such as 'versionInfo'.", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r451735657", "createdAt": "2020-07-08T18:12:02Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -143,6 +145,106 @@ public void test_toMap_fileasset_txt_shouldSuccess() throws Exception {\n \n     }\n \n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid host\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidHostId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setHost(\"not_exist_host\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid folder\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidFolderId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setFolder(\"not_exist_folder\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has a invalid content type\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasInvalidContentTypeId(){\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        contentlet.setContentTypeId(\"not_exist_content_type\");\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has not {@link com.dotmarketing.beans.Identifier}\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasNotIdentifier() {\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).next();\n+\n+        esMappingAPI.toMap(contentlet);\n+    }\n+\n+    /**\n+     * Method to Test: {@link ESMappingAPIImpl#toMap(Contentlet)}\n+     * When: The contentlet has not {@link ContentletVersionInfo}\n+     * Should: Throw a {@link DotDataException}\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test(expected = DotMappingException.class)\n+    public void whenContentletHasNotContentletVersionInfo() throws DotDataException {\n+        final ESMappingAPIImpl esMappingAPI    = new ESMappingAPIImpl();\n+\n+        final ContentType contentType = new ContentTypeDataGen().nextPersisted();\n+        final Contentlet contentlet = new ContentletDataGen(contentType.id()).nextPersisted();\n+\n+        final ContentletVersionInfo versionInfo = APILocator.getVersionableAPI()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a"}, "originalPosition": 145}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDE0MzY4", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-445014368", "createdAt": "2020-07-08T18:12:04Z", "commit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODoxMjowNFrOGuzweg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODoxMjowNFrOGuzweg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNTY3NA==", "bodyText": "Codacy found an issue: Avoid unused imports such as 'com.dotmarketing.business'", "url": "https://github.com/dotCMS/core/pull/18674#discussion_r451735674", "createdAt": "2020-07-08T18:12:04Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/content/elasticsearch/business/ESMappingAPITest.java", "diffHunk": "@@ -26,24 +27,24 @@\n import com.dotcms.contenttype.model.type.ContentTypeBuilder;\n import com.dotcms.contenttype.model.type.ImmutableFileAssetContentType;\n import com.dotcms.contenttype.model.type.SimpleContentType;\n-import com.dotcms.contenttype.util.KeyValueFieldUtil;\n+\n import com.dotcms.datagen.ContentTypeDataGen;\n import com.dotcms.datagen.ContentletDataGen;\n+import com.dotcms.contenttype.util.KeyValueFieldUtil;\n import com.dotcms.datagen.FieldDataGen;\n import com.dotcms.datagen.FileAssetDataGen;\n import com.dotcms.datagen.SiteDataGen;\n import com.dotcms.util.CollectionsUtils;\n import com.dotcms.util.IntegrationTestInitService;\n import com.dotmarketing.beans.Host;\n-import com.dotmarketing.business.APILocator;\n-import com.dotmarketing.business.RelationshipAPI;\n-import com.dotmarketing.business.UserAPI;\n+import com.dotmarketing.business.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDY4MjI2", "url": "https://github.com/dotCMS/core/pull/18674#pullrequestreview-445068226", "createdAt": "2020-07-08T19:31:15Z", "commit": {"oid": "9d2526a38591cb54642add73c8a84c65e659e82a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 942, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}