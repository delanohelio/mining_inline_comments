{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDU1MjQz", "number": 18139, "title": "#18086 show pre-execute code regardless the mode", "bodyText": "The pre-execute code of a widget should always execute regardless of the PageMode.", "createdAt": "2020-03-13T23:20:27Z", "url": "https://github.com/dotCMS/core/pull/18139", "merged": true, "mergeCommit": {"oid": "a68d4b6d96b3d04d3b3e47bff00305486bba4dfa"}, "closed": true, "closedAt": "2020-03-17T19:00:49Z", "author": {"login": "erickgonzalez"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNYxyYAH2gAyMzg4MDU1MjQzOmIwYTQ4YTEwMTk0NGNiYjk0YmJhMmViY2ZhOGM3MGE3MTljOGViNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOlN8CAFqTM3NjE5NTc5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0a48a101944cbb94bba2ebcfa8c70a719c8eb5c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/b0a48a101944cbb94bba2ebcfa8c70a719c8eb5c", "committedDate": "2020-03-13T23:19:12Z", "message": "#18086 show pre-execute code regardless the mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb562bce96475ac90608d502880149995391672c", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/cb562bce96475ac90608d502880149995391672c", "committedDate": "2020-03-16T21:56:18Z", "message": "#18086 add the page info and pre-execute code regardless the pagemode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d", "author": {"user": {"login": "erickgonzalez", "name": null}}, "url": "https://github.com/dotCMS/core/commit/abccab01613ea4669e7646a7aa8d01cf6041ec8d", "committedDate": "2020-03-16T21:57:24Z", "message": "#18086 IT for every pagemode: edit, preview, live"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjIwMTc4", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-375620178", "createdAt": "2020-03-16T22:20:33Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjI0Njk1", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-375624695", "createdAt": "2020-03-16T22:26:59Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjI1MDYx", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-375625061", "createdAt": "2020-03-16T22:27:50Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1MFrOF3H0cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1MFrOF3H0cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDExNQ==", "bodyText": "Issue found: StringBuffer (or StringBuilder).append is called consecutively without reusing the target variable.", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344115", "createdAt": "2020-03-16T22:27:50Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/services/PageLoader.java", "diffHunk": "@@ -197,6 +186,15 @@ public InputStream buildStream(IHTMLPage htmlPage, PageMode mode, final String f\n \n     }\n \n+    private void addWidgetPreExecuteCodeAndPageInfo(final HTMLPageAsset htmlPage, final PageMode mode,\n+            final StringBuilder stringBuilder, final User user) throws DotSecurityException, DotDataException {\n+        final PageRenderUtil pce = new PageRenderUtil(htmlPage, user, mode);\n+        // Add the pre-execute code of a widget to the page\n+        stringBuilder.append(pce.getWidgetPreExecute());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjI1MDY3", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-375625067", "createdAt": "2020-03-16T22:27:52Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1MlrOF3H0gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1MlrOF3H0gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDEyOQ==", "bodyText": "Issue found: Local variable 'contentType' could be declared final", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344129", "createdAt": "2020-03-16T22:27:52Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/services/HTMLPageAssetRenderedTest.java", "diffHunk": "@@ -1298,6 +1300,72 @@ public void shouldRenderUsingOtherSiteContainerAndNotAdvanceTemplate() throws Ex\n         Assert.assertTrue(html.contains(\"content2content1\"));\n     }\n \n+    //Data Provider for the Widget Pre-execute code test\n+    @DataProvider\n+    public static Object[] dataProviderWidgetPreExecuteCode() {\n+        return new Object[] {\n+                new WidgetPreExecuteCodeTestCase(PageMode.EDIT_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.PREVIEW_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.LIVE),\n+        };\n+    }\n+\n+    private static class WidgetPreExecuteCodeTestCase {\n+        final PageMode pageMode;\n+\n+        public WidgetPreExecuteCodeTestCase(final PageMode pageMode) {\n+            this.pageMode = pageMode;\n+        }\n+    }\n+\n+    @Test\n+    @UseDataProvider(\"dataProviderWidgetPreExecuteCode\")\n+    public void test_WidgetPreExecuteCodeShowRegardlessPageMode(final WidgetPreExecuteCodeTestCase testCase) throws Exception {\n+\n+        //Update the Preexecute Field to have some code in it\n+        final String preExcuteCode = \"PreExecute Code Displayed\";\n+        ContentType contentType = TestDataUtils.getWidgetLikeContentType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjI1MDc1", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-375625075", "createdAt": "2020-03-16T22:27:53Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1M1rOF3H0iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyNzo1M1rOF3H0iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0NDEzNw==", "bodyText": "Issue found: Local variable 'multiTree' could be declared final", "url": "https://github.com/dotCMS/core/pull/18139#discussion_r393344137", "createdAt": "2020-03-16T22:27:53Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/services/HTMLPageAssetRenderedTest.java", "diffHunk": "@@ -1298,6 +1300,72 @@ public void shouldRenderUsingOtherSiteContainerAndNotAdvanceTemplate() throws Ex\n         Assert.assertTrue(html.contains(\"content2content1\"));\n     }\n \n+    //Data Provider for the Widget Pre-execute code test\n+    @DataProvider\n+    public static Object[] dataProviderWidgetPreExecuteCode() {\n+        return new Object[] {\n+                new WidgetPreExecuteCodeTestCase(PageMode.EDIT_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.PREVIEW_MODE),\n+                new WidgetPreExecuteCodeTestCase(PageMode.LIVE),\n+        };\n+    }\n+\n+    private static class WidgetPreExecuteCodeTestCase {\n+        final PageMode pageMode;\n+\n+        public WidgetPreExecuteCodeTestCase(final PageMode pageMode) {\n+            this.pageMode = pageMode;\n+        }\n+    }\n+\n+    @Test\n+    @UseDataProvider(\"dataProviderWidgetPreExecuteCode\")\n+    public void test_WidgetPreExecuteCodeShowRegardlessPageMode(final WidgetPreExecuteCodeTestCase testCase) throws Exception {\n+\n+        //Update the Preexecute Field to have some code in it\n+        final String preExcuteCode = \"PreExecute Code Displayed\";\n+        ContentType contentType = TestDataUtils.getWidgetLikeContentType();\n+        final Field preExecuteField = APILocator.getContentTypeFieldAPI().byContentTypeIdAndVar(contentType.id(),WidgetContentType.WIDGET_PRE_EXECUTE_FIELD_VAR);\n+        APILocator.getContentTypeFieldAPI()\n+                .save(FieldBuilder.builder(preExecuteField).values(preExcuteCode).build(), systemUser);\n+        // Assert that the widget has set the pre-execute field\n+        Assert.assertTrue(APILocator.getContentTypeFieldAPI()\n+                .byContentTypeIdAndVar(contentType.id(),WidgetContentType.WIDGET_PRE_EXECUTE_FIELD_VAR)\n+                .values().equals(preExcuteCode));\n+\n+        //Create Contentlet\n+        final Contentlet widgetContentlet = TestDataUtils.getWidgetContent(true,1,contentType.id());\n+        addAnonymousPermissions(widgetContentlet);\n+\n+        //Create Container, Template and Page\n+        final Container container = createContainer();\n+        final Template template = createTemplate(container);\n+\n+        final String pageName = \"testPage-\"+System.currentTimeMillis();\n+        final HTMLPageAsset page = createHtmlPageAsset(template, pageName, 1);\n+\n+        //Add contentlet to the page\n+        MultiTree multiTree = new MultiTree(page.getIdentifier(), container.getIdentifier(),widgetContentlet.getIdentifier() ,UUID,0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTk1Nzk3", "url": "https://github.com/dotCMS/core/pull/18139#pullrequestreview-376195797", "createdAt": "2020-03-17T16:22:44Z", "commit": {"oid": "abccab01613ea4669e7646a7aa8d01cf6041ec8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1186, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}