{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Mjg4ODAz", "number": 18322, "title": "Issue 18210", "bodyText": "The code in NavTool.getNavmethod was modifying the cache-stored copy of the SYSTEM_FOLDER, by replacing the hostId from SYSTEM_HOST to whatever the passed in for the method is. This was generating an issue in the validation when creating htmlpages. Now a defensive copy is made to avoid mutating the cache-stored copy.", "createdAt": "2020-04-17T18:53:44Z", "url": "https://github.com/dotCMS/core/pull/18322", "merged": true, "mergeCommit": {"oid": "073e231f650b05e38be6b031f234a8fc93e7f9da"}, "closed": true, "closedAt": "2020-04-24T14:38:54Z", "author": {"login": "dsilvam"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX_wmxgH2gAyNDA1Mjg4ODAzOmNhNjIzYTNjNDM4OTkwNWUwMzIxMWIwMzlhZjM1NDg1MTgxNWY0ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaBMpfAFqTM5Nzg0Nzk2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ca623a3c4389905e03211b039af354851815f4e2", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/ca623a3c4389905e03211b039af354851815f4e2", "committedDate": "2020-04-15T22:23:27Z", "message": "#18210 fix page path validation so it takes correct host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bed4a9722a707d34bf48dc0a8d1ab1c77c92f5b", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/9bed4a9722a707d34bf48dc0a8d1ab1c77c92f5b", "committedDate": "2020-04-16T23:54:51Z", "message": "#18210 avoid mutating system_folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f9e990c4eacdc0adb9799ec18defb1e6cfc347", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/78f9e990c4eacdc0adb9799ec18defb1e6cfc347", "committedDate": "2020-04-17T18:45:07Z", "message": "#18210 integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3289a85844ebb849ebe40585ddf63605589bbad", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/b3289a85844ebb849ebe40585ddf63605589bbad", "committedDate": "2020-04-17T18:45:22Z", "message": "Merge branch 'master' of github.com:dotCMS/core into issue-18210"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68", "committedDate": "2020-04-17T22:16:57Z", "message": "#18210 fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTAyNjg0", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396502684", "createdAt": "2020-04-20T14:23:36Z", "commit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyMzozNlrOGIXGdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoyNTowMVrOGIXKpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMDI3OQ==", "bodyText": "maybe it should go into a private method", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411420279", "createdAt": "2020-04-20T14:23:36Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,24 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n             .findFolderByPath(path, host, systemUserParam, true)\n                 : APILocator.getFolderAPI()\n                     .findSystemFolder();\n-        if (folder == null || !UtilMethods.isSet(folder.getIdentifier())) {\n+\n+        if (originalFolder == null || !UtilMethods.isSet(originalFolder.getIdentifier())) {\n             return null;\n         }\n+\n+        // make a defensive copy to avoid mutating cached version\n+        Folder folder = new Folder();\n+        try {\n+            BeanUtils.copyProperties(folder, originalFolder);\n+        } catch (IllegalAccessException | InvocationTargetException e) {\n+            folder = originalFolder;\n+            Logger.warnAndDebug(NavTool.class,\"Defensive copy failed. Using original object\", e);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyMTM0OA==", "bodyText": "I think we should check also the return value of the getNav method", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411421348", "createdAt": "2020-04-20T14:25:01Z", "author": {"login": "freddyucv"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -441,4 +449,36 @@ public void testNavTool_rootLevel_returnItemsOnlyForSite() throws Exception\n \n     }\n \n+    /**\n+     * Method to test: NavTool.getNav\n+     * Given scenario: get navigation for system folder (\"/\")\n+     * Expected result: getting the navigation should not change system folder's hostId\n+     * @throws Exception exception\n+     */\n+\n+    @Test\n+    public void testNavTool_getNav_SystemFolder_ShouldNotChangeSystemFolderHostId() throws Exception\n+    {\n+        //Get SystemFolder\n+        Folder systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+\n+        //Create new Host\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        //Create contentlets on one host\n+        final File file = File.createTempFile(\"fileTestEngTrue\", \".txt\");\n+        FileUtil.write(file, \"helloworld\");\n+        final Contentlet fileAssetOneHost = new FileAssetDataGen(systemFolder, file)\n+                .host(host).setProperty(FileAssetAPI.SHOW_ON_MENU, \"true\").nextPersisted();\n+        final Template template = new TemplateDataGen().nextPersisted();\n+        final Contentlet pageAssetOneHost = new HTMLPageDataGen(systemFolder, template)\n+                .showOnMenu(true).host(host).nextPersisted();\n+        ContentletDataGen.publish(pageAssetOneHost);\n+        ContentletDataGen.publish(fileAssetOneHost);\n+\n+        new NavTool().getNav(host, systemFolder.getPath());\n+        systemFolder = APILocator.getFolderAPI().findSystemFolder();\n+        assertEquals(Host.SYSTEM_HOST, systemFolder.getHostId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTY0MzQ1", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396564345", "createdAt": "2020-04-20T15:29:10Z", "commit": {"oid": "b1cf491a4dcbd8e7d7f7a8d9a7f72820e1de7d68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313", "committedDate": "2020-04-20T15:55:05Z", "message": "#18210 extract to method - code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTg5OTk3", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396589997", "createdAt": "2020-04-20T15:56:58Z", "commit": {"oid": "285fb52e74ed0855eb1b469a7ce8a4b0e2bd1313"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c", "author": {"user": {"login": "dsilvam", "name": "Daniel Silva"}}, "url": "https://github.com/dotCMS/core/commit/979cb4e304e0022f3bb301548303939c54257d5c", "committedDate": "2020-04-20T15:58:08Z", "message": "#18210 extract to method - code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTk4Nzc1", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396598775", "createdAt": "2020-04-20T16:06:26Z", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyN1rOGIcHhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyN1rOGIcHhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ2OQ==", "bodyText": "Issue found: Local variable 'modifiedSystemFolder' could be declared final", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502469", "createdAt": "2020-04-20T16:06:27Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/rendering/velocity/viewtools/navigation/NavToolTest.java", "diffHunk": "@@ -204,8 +205,15 @@ public void testRootLevelNavigation_WhenOneFileAssetIsShownOnMenu() throws Excep\n                     .getNav(site, systemFolder.getPath(), 1, user);\n             assertNotNull(navResult);\n \n+            /* method below `findShowOnMenuUnderFolder` expects a mutated version of SYSTEM_FOLDER with the hostId altered.\n+               So let's create a defensive copy of the SYSTEM_FOLDER, modify it and pass it to the method.\n+            */\n+            Folder modifiedSystemFolder = new Folder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTk4Nzk4", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396598798", "createdAt": "2020-04-20T16:06:28Z", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyOFrOGIcHlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjowNjoyOFrOGIcHlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwMjQ4Nw==", "bodyText": "Issue found: Position literals first in String comparisons", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r411502487", "createdAt": "2020-04-20T16:06:28Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -77,13 +79,17 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n             path = path.substring(0, path.lastIndexOf(\"/\"));\n         }\n \n-        Folder folder = !path.equals(\"/\") ? APILocator.getFolderAPI()\n+        final Folder originalFolder = !path.equals(\"/\") ? APILocator.getFolderAPI()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjEzMTkw", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-396613190", "createdAt": "2020-04-20T16:23:39Z", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODQ3Nzk3", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-397847797", "createdAt": "2020-04-22T05:11:19Z", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToxOVrOGJjpTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNToxMToxOVrOGJjpTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3NDM4MQ==", "bodyText": "Very good", "url": "https://github.com/dotCMS/core/pull/18322#discussion_r412674381", "createdAt": "2020-04-22T05:11:19Z", "author": {"login": "jdotcms"}, "path": "dotCMS/src/main/java/com/dotcms/rendering/velocity/viewtools/navigation/NavTool.java", "diffHunk": "@@ -215,6 +221,22 @@ protected NavResultHydrated getNav(Host host, String path, long languageId, User\n         }\n     }\n \n+    /**\n+     * Makes a defensive copy of the given folder to avoid mutating cached version\n+     * @param originalFolder folder to make the defensive copy from\n+     * @return defensive copy\n+     */\n+    private Folder getDefensiveCopyOfFolder(Folder originalFolder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODQ3OTY5", "url": "https://github.com/dotCMS/core/pull/18322#pullrequestreview-397847969", "createdAt": "2020-04-22T05:11:50Z", "commit": {"oid": "979cb4e304e0022f3bb301548303939c54257d5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 998, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}