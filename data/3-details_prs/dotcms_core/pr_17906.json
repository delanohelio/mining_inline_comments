{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTUyMzQ3", "number": 17906, "title": "Unable to create rules", "bodyText": "The method Rule. getParentPermissionable return a Contentlet instance who represent a Host (when the Rule's parent is a Host)\nhttps://github.com/dotCMS/core/blob/master/dotCMS/src/main/java/com/dotmarketing/portlets/rules/model/Rule.java#L238\nWhen a rule is going to be created the parent permission are checking here:\nhttps://github.com/dotCMS/enterprise-2.x/blob/master/src/main/java/com/dotcms/enterprise/rules/RulesAPIImpl.java#L557\nThe permission checking is different if the permissionable is a Host\nhttps://github.com/dotCMS/core/blob/master/dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java#L1277\nWhen a Contentlet instance who represent a Host was pass to the isHost method as permissionable, it was returning false\nhttps://github.com/dotCMS/core/compare/issue-17901-Unable-to-create-rules?expand=1#diff-89f38de07f469db99ca81817b7938ca5R1409\nThat is why the x did not process correctly and the method  'doesUserHavePermissions' allways was returning false for any not admin user.", "createdAt": "2020-01-24T18:04:11Z", "url": "https://github.com/dotCMS/core/pull/17906", "merged": true, "mergeCommit": {"oid": "0f0fc83d81e6e84c07ac4db3dcec574e2aa3ebc0"}, "closed": true, "closedAt": "2020-01-28T15:43:07Z", "author": {"login": "freddyucv"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9iq1UAH2gAyMzY2OTUyMzQ3OjA2NzA2NmNhOGM2YjJmMGI3NWUyNDMzYjM4MWVlMjdhODU0ZGQ3ZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9kR0IgFqTM0ODE4MTQxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "067066ca8c6b2f0b75e2433b381ee27a854dd7fc", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/067066ca8c6b2f0b75e2433b381ee27a854dd7fc", "committedDate": "2020-01-24T17:47:52Z", "message": "#17901 isHost method should return true for a Contentelet Objesct instance who represent a Host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7bff616de46bb60b222be89e66941d0a83f1218", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/d7bff616de46bb60b222be89e66941d0a83f1218", "committedDate": "2020-01-24T18:03:07Z", "message": "#17901 testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTMxOTAx", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348131901", "createdAt": "2020-01-24T18:11:28Z", "commit": {"oid": "d7bff616de46bb60b222be89e66941d0a83f1218"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMToyOFrOFhmAwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODoxMToyOFrOFhmAwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MDExMw==", "bodyText": "I think we should use the contentlet.isHost() method here rather than recreating it", "url": "https://github.com/dotCMS/core/pull/17906#discussion_r370770113", "createdAt": "2020-01-24T18:11:28Z", "author": {"login": "wezell"}, "path": "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPIImpl.java", "diffHunk": "@@ -1406,6 +1406,7 @@ private boolean isFolder(final Permissionable permissionable) {\n \tprivate boolean isHost(final Permissionable permissionable) {\r\n \r\n \t\treturn permissionable instanceof Host ||\r\n+\t\t\t\t(permissionable instanceof Contentlet && Host.class.getSimpleName().equals(((Contentlet) permissionable).getContentType().name())) ||\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7bff616de46bb60b222be89e66941d0a83f1218"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTM0MDI3", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348134027", "createdAt": "2020-01-24T18:15:18Z", "commit": {"oid": "d7bff616de46bb60b222be89e66941d0a83f1218"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTM2Njc4", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348136678", "createdAt": "2020-01-24T18:20:13Z", "commit": {"oid": "d7bff616de46bb60b222be89e66941d0a83f1218"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40", "author": {"user": null}, "url": "https://github.com/dotCMS/core/commit/0eabafde4729f91ac99fece796c7d50cbaba5f40", "committedDate": "2020-01-24T19:31:29Z", "message": "#17906 using content.isHost in PermissionBitAPIImpl.isHost method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTgxMzkw", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348181390", "createdAt": "2020-01-24T19:40:18Z", "commit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoxOFrOFhoZfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoxOFrOFhoZfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIxNQ==", "bodyText": "Issue found: Avoid empty catch blocks", "url": "https://github.com/dotCMS/core/pull/17906#discussion_r370809215", "createdAt": "2020-01-24T19:40:18Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package com.dotcms.enterprise.rules;\n+\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.rules.RuleDataGen;\n+import com.dotmarketing.portlets.rules.model.Rule;\n+import com.liferay.portal.model.User;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Integration test of {@link RulesAPIImpl}\n+ */\n+public class RulesAPIImplIntegrationTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {\n+        //Setting web app environment\n+        IntegrationTestInitService.getInstance().init();\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRule(Rule, User, boolean)}\n+     * When: A not admin user with right permission try to save a new rule\n+     * Should: Save the new rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldSaveNewRule() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).next();\n+\n+        this.addPermission(role, host, true);\n+        APILocator.getRulesAPI().saveRule(rule, user, false);\n+\n+        final List<Rule> rules = APILocator.getRulesAPI().getAllRulesByParent(host, APILocator.systemUser(), true);\n+        assertEquals(1, rules.size());\n+    }\n+\n+    /**\n+     * Method to Test: {@link RulesAPIImpl#saveRule(Rule, User, boolean)}\n+     * When: A not admin user without permission try to save a new rule\n+     * Should: Not save the new rule\n+     *\n+     * @throws DotSecurityException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void shouldNotSaveNewRule() throws DotSecurityException, DotDataException {\n+        final Role role = new RoleDataGen().nextPersisted();\n+        final User user = new UserDataGen().roles(role).nextPersisted();\n+        final Host host = new SiteDataGen().nextPersisted();\n+        final Rule rule = new RuleDataGen().host(host).next();\n+\n+        this.addPermission(role, host, false);\n+\n+        try {\n+            APILocator.getRulesAPI().saveRule(rule, user, false);\n+            throw new AssertionError(\"DotSecurityException expected\");\n+        } catch(DotSecurityException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTgxMzk4", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348181398", "createdAt": "2020-01-24T19:40:19Z", "commit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoyMFrOFhoZjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoyMFrOFhoZjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTIzMA==", "bodyText": "Issue found: A method/constructor should not explicitly throw java.lang.Exception", "url": "https://github.com/dotCMS/core/pull/17906#discussion_r370809230", "createdAt": "2020-01-24T19:40:20Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotcms/enterprise/rules/RulesAPIImplIntegrationTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package com.dotcms.enterprise.rules;\n+\n+import com.dotcms.datagen.RoleDataGen;\n+import com.dotcms.datagen.SiteDataGen;\n+import com.dotcms.datagen.UserDataGen;\n+import com.dotcms.util.IntegrationTestInitService;\n+import com.dotmarketing.beans.Host;\n+import com.dotmarketing.beans.Permission;\n+import com.dotmarketing.business.APILocator;\n+import com.dotmarketing.business.PermissionAPI;\n+import com.dotmarketing.business.Role;\n+import com.dotmarketing.exception.DotDataException;\n+import com.dotmarketing.exception.DotSecurityException;\n+import com.dotmarketing.portlets.rules.RuleDataGen;\n+import com.dotmarketing.portlets.rules.model.Rule;\n+import com.liferay.portal.model.User;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Integration test of {@link RulesAPIImpl}\n+ */\n+public class RulesAPIImplIntegrationTest {\n+\n+    @BeforeClass\n+    public static void prepare() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTgxNDEx", "url": "https://github.com/dotCMS/core/pull/17906#pullrequestreview-348181411", "createdAt": "2020-01-24T19:40:21Z", "commit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoyMVrOFhoZmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOTo0MDoyMVrOFhoZmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwOTI0MQ==", "bodyText": "Issue found: Field host has the same name as a method", "url": "https://github.com/dotCMS/core/pull/17906#discussion_r370809241", "createdAt": "2020-01-24T19:40:21Z", "author": {"login": "dev-dotcms"}, "path": "dotCMS/src/integration-test/java/com/dotmarketing/portlets/rules/RuleDataGen.java", "diffHunk": "@@ -30,6 +30,7 @@\n \n     private Rule.FireOn fireOn = Rule.FireOn.EVERY_PAGE;\n     private String name = \"defaultName\";\n+    private Host host;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eabafde4729f91ac99fece796c7d50cbaba5f40"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1334, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}