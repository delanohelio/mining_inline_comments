{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NjgzMjc3", "number": 19633, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyODoyMFrOE-wrWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMjozNlrOE-wyog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjQ0Njk2OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/util/DependencyManagerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzoyODoyMFrOH8FxbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTozMzo0OFrOH8Ot7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3MTE4MA==", "bodyText": "why is this line commented?", "url": "https://github.com/dotCMS/core/pull/19633#discussion_r532771180", "createdAt": "2020-11-30T17:28:20Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/util/DependencyManagerTest.java", "diffHunk": "@@ -266,19 +284,156 @@ public void test_Content_Type_with_detail_Page()\n         DependencyManager dependencyManager = new DependencyManager(DependencyManagerTest.user, config);\n         dependencyManager.setDependencies();\n \n-        assertEquals(2, dependencyManager.getContentTypes().size());\n+        assertEquals(4, dependencyManager.getContentTypes().size());\n         assertTrue(dependencyManager.getContentTypes().contains(contentType.id()));\n         assertTrue(dependencyManager.getContentTypes().contains(contentlet.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(theme.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(htmlPageAsset.getContentType().id()));\n \n-        assertEquals(2, dependencyManager.getContents().size());\n+//        assertEquals(3, dependencyManager.getContents().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e514e1833e85bdf70e25c9c4262ede98eb06243d"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNzc0MA==", "bodyText": "Commented out to avoid test failure. New issue was created to uncomment this when @freddyucv comes back.", "url": "https://github.com/dotCMS/core/pull/19633#discussion_r532917740", "createdAt": "2020-11-30T21:33:48Z", "author": {"login": "dsilvam"}, "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/util/DependencyManagerTest.java", "diffHunk": "@@ -266,19 +284,156 @@ public void test_Content_Type_with_detail_Page()\n         DependencyManager dependencyManager = new DependencyManager(DependencyManagerTest.user, config);\n         dependencyManager.setDependencies();\n \n-        assertEquals(2, dependencyManager.getContentTypes().size());\n+        assertEquals(4, dependencyManager.getContentTypes().size());\n         assertTrue(dependencyManager.getContentTypes().contains(contentType.id()));\n         assertTrue(dependencyManager.getContentTypes().contains(contentlet.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(theme.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(htmlPageAsset.getContentType().id()));\n \n-        assertEquals(2, dependencyManager.getContents().size());\n+//        assertEquals(3, dependencyManager.getContents().size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3MTE4MA=="}, "originalCommit": {"oid": "e514e1833e85bdf70e25c9c4262ede98eb06243d"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjQ1NzM4OnYy", "diffSide": "RIGHT", "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/util/DependencyManagerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMDozNFrOH8F3sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMDozNFrOH8F3sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3Mjc4NQ==", "bodyText": "same here", "url": "https://github.com/dotCMS/core/pull/19633#discussion_r532772785", "createdAt": "2020-11-30T17:30:34Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/integration-test/java/com/dotcms/publisher/util/DependencyManagerTest.java", "diffHunk": "@@ -266,19 +284,156 @@ public void test_Content_Type_with_detail_Page()\n         DependencyManager dependencyManager = new DependencyManager(DependencyManagerTest.user, config);\n         dependencyManager.setDependencies();\n \n-        assertEquals(2, dependencyManager.getContentTypes().size());\n+        assertEquals(4, dependencyManager.getContentTypes().size());\n         assertTrue(dependencyManager.getContentTypes().contains(contentType.id()));\n         assertTrue(dependencyManager.getContentTypes().contains(contentlet.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(theme.getContentType().id()));\n+        assertTrue(dependencyManager.getContentTypes().contains(htmlPageAsset.getContentType().id()));\n \n-        assertEquals(2, dependencyManager.getContents().size());\n+//        assertEquals(3, dependencyManager.getContents().size());\n         assertTrue(dependencyManager.getContents().contains(htmlPageAsset.getIdentifier()));\n         assertTrue(dependencyManager.getContents().contains(contentlet.getIdentifier()));\n+        assertTrue(dependencyManager.getContents().contains(theme.getIdentifier()));\n \n         assertEquals(1, dependencyManager.getTemplates().size());\n         assertTrue(dependencyManager.getTemplates().contains(template.getIdentifier()));\n \n-        assertEquals(1, dependencyManager.getContainers().size());\n+        assertEquals(2, dependencyManager.getContainers().size());\n         assertTrue(dependencyManager.getContainers().contains(container.getIdentifier()));\n+        assertTrue(dependencyManager.getContainers().contains(container_2.getIdentifier()));\n+\n+        assertEquals(3, dependencyManager.getFolders().size());\n+        assertTrue(dependencyManager.getFolders().contains(theme.getFolder()));\n+    }\n+\n+    /**\n+     * <b>Method to test:</b> {@link DependencyManager#setDependencies()} <p>\n+     * <b>Given Scenario:</b> A {@link ContentType} with a page as detail page that not exist<p>\n+     * <b>ExpectedResult:</b> Should not throw any exception\n+     * @throws DotSecurityException\n+     * @throws DotBundleException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_Content_Type_with_not_exists_detail_Page()\n+            throws DotSecurityException, DotBundleException, DotDataException {\n+\n+        final PushPublisherConfig config = new PushPublisherConfig();\n+        final User systemUser = APILocator.systemUser();\n+        final Host host = new SiteDataGen().nextPersisted();\n+\n+        final String baseUrl = String.format(\"/test%s\", System.currentTimeMillis());\n+\n+        final ContentType contentType = new ContentTypeDataGen().user(systemUser)\n+                .host(host)\n+                .detailPage(\"not_exists\")\n+                .urlMapPattern(String.format(\"%s/{text}\", baseUrl))\n+                .nextPersisted();\n+\n+        //Creates a bundle with just the child\n+        createBundle(config, contentType);\n+\n+        DependencyManager dependencyManager = new DependencyManager(DependencyManagerTest.user, config);\n+        dependencyManager.setDependencies();\n+\n+        assertEquals(1, dependencyManager.getContentTypes().size());\n+        assertTrue(dependencyManager.getContentTypes().contains(contentType.id()));\n+\n+//        assertEquals(0, dependencyManager.getContents().size());\n+\n+        assertEquals(0, dependencyManager.getTemplates().size());\n+\n+        assertEquals(0, dependencyManager.getContainers().size());\n+    }\n+\n+    /**\n+     * <b>Method to test:</b> {@link DependencyManager#setDependencies()} <p>\n+     * <b>Given Scenario:</b> A {@link ContentType} with a page as detail page that not exist<p>\n+     * <b>ExpectedResult:</b> Should not throw any exception\n+     * @throws DotSecurityException\n+     * @throws DotBundleException\n+     * @throws DotDataException\n+     */\n+    @Test\n+    public void test_Sending_Page_as_dependencies_with_PUSH_PUBLISHING_PUSH_ALL_FOLDER_PAGES()\n+            throws DotSecurityException, DotBundleException, DotDataException {\n+\n+        Config.setProperty(\"PUSH_PUBLISHING_PUSH_ALL_FOLDER_PAGES\", true);\n+\n+        try {\n+            final PushPublisherConfig config = new PushPublisherConfig();\n+\n+            final Host host = new SiteDataGen().nextPersisted();\n+            final ContentType contentTypeForContent = new ContentTypeDataGen().nextPersisted();\n+\n+            final Container container = new ContainerDataGen()\n+                    .withContentType(contentTypeForContent, \"Testing\")\n+                    .nextPersisted();\n+\n+            final Container container_2 = new ContainerDataGen()\n+                    .nextPersisted();\n+\n+            final TemplateLayout templateLayout = new TemplateLayoutDataGen()\n+                    .withContainer(container, ContainerUUID.UUID_START_VALUE)\n+                    .withContainer(container_2, ContainerUUID.UUID_START_VALUE)\n+                    .next();\n+\n+            final Folder folderTheme = new FolderDataGen().nextPersisted();\n+            final Contentlet theme_1 = new ThemeDataGen()\n+                    .site(host)\n+                    .themesFolder(folderTheme)\n+                    .nextPersisted();\n+\n+            final Template template_1 = new TemplateDataGen()\n+                    .drawedBody(templateLayout)\n+                    .host(host)\n+                    .theme(theme_1)\n+                    .nextPersisted();\n+\n+            final Folder pages_folder = new FolderDataGen().nextPersisted();\n+            final HTMLPageAsset htmlPageAsset_1 = new HTMLPageDataGen(host, template_1)\n+                    .folder(pages_folder)\n+                    .nextPersisted();\n+\n+            final Contentlet theme_2 = new ThemeDataGen()\n+                    .site(host)\n+                    .themesFolder(folderTheme)\n+                    .nextPersisted();\n+\n+            final Template template_2 = new TemplateDataGen()\n+                    .drawedBody(templateLayout)\n+                    .host(host)\n+                    .theme(theme_2)\n+                    .nextPersisted();\n+\n+            final HTMLPageAsset htmlPageAsset_2 = new HTMLPageDataGen(host, template_2)\n+                    .folder(pages_folder)\n+                    .nextPersisted();\n+\n+            createBundle(config, htmlPageAsset_1);\n+\n+            DependencyManager dependencyManager = new DependencyManager(DependencyManagerTest.user, config);\n+            dependencyManager.setDependencies();\n+\n+//            assertEquals(4, dependencyManager.getContents().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e514e1833e85bdf70e25c9c4262ede98eb06243d"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjQ2NTYyOnYy", "diffSide": "RIGHT", "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMjozNlrOH8F81Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzozMjozNlrOH8F81Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3NDEwMQ==", "bodyText": "The DotSecurityException and the DotDataException can be wrapped in the same catch", "url": "https://github.com/dotCMS/core/pull/19633#discussion_r532774101", "createdAt": "2020-11-30T17:32:36Z", "author": {"login": "nollymar"}, "path": "dotCMS/src/main/java/com/dotcms/publisher/util/DependencyManager.java", "diffHunk": "@@ -858,79 +873,96 @@ private void setHTMLPagesDependencies(final Set<String> idsToWork,final Publishe\n \tprivate void setTemplateDependencies(final PublisherFilter publisherFilter)  {\n \t\ttry {\n \t\t\tfinal List<Container> containerList = new ArrayList<>();\n-\t\t\tfinal FolderAPI folderAPI = APILocator.getFolderAPI();\n \n \t\t\tfor (final String id : templatesSet) {\n-\t\t\t\tfinal Template workingTemplate = APILocator.getTemplateAPI().findWorkingTemplate(id, user, false);\n-\t\t\t\tfinal Template liveTemplate = APILocator.getTemplateAPI().findLiveTemplate(id, user, false);\n+\t\t\t\tsetTemplateDependencies(publisherFilter, containerList, id);\n+\t\t\t}\n \n-\t\t\t\t// Host dependency\n-\t\t\t\tif (!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.SITE.getType())) {\n-\t\t\t\t\tfinal Host host = APILocator.getHostAPI()\n-\t\t\t\t\t\t\t.find(APILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n-\t\t\t\t\t\t\t\t\tuser, false);\n-\t\t\t\t\thosts.addOrClean(\n-\t\t\t\t\t\t\tAPILocator.getTemplateAPI().getTemplateHost(workingTemplate).getIdentifier(),\n-\t\t\t\t\t\t\thost.getModDate());\n-\t\t\t\t}\n+\t\t} catch (DotSecurityException e) {\n \n-\t\t\t\tcontainerList.clear();\n-\t\t\t\t// Container dependencies\n-\t\t\t\tif (!publisherFilter.doesExcludeDependencyClassesContainsType(PusheableAsset.CONTAINER.getType())) {\n-\t\t\t\t\tcontainerList.addAll(APILocator.getTemplateAPI()\n-\t\t\t\t\t\t\t.getContainersInTemplate(workingTemplate, user, false));\n+\t\t\tLogger.error(this, e.getMessage(),e);\n+\t\t} catch (DotDataException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e514e1833e85bdf70e25c9c4262ede98eb06243d"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1715, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}