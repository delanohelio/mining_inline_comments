{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NjQ0NjMz", "number": 214, "title": "fix: KarafGenerator update", "bodyText": "Created Karaf Quickstart\nFixed problems with FileSet assembly config to include complete directories\nUpgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nn.b. CompleteK8sITCase will fail due to an invalid assertion. In the past filesets entries were copied (in all cases) to the target directory under a subdirectory named like the source parent directory, which is wrong.)\nThe failing line should be replaced\n\nFrom:\n\nassertThat(imageFiles, hasItem(\"/deployments/jkube-includes/will-be-included-if-no-assemblies-defined.txt\"));\n\n\nTo:\n\n    assertThat(imageFiles, hasItem(\"/deployments/will-be-included-if-no-assemblies-defined.txt\"));\n\nI'll update integration-tests once this PR gets merged.\nRelates to: #183 #188 #94", "createdAt": "2020-05-28T17:59:21Z", "url": "https://github.com/eclipse/jkube/pull/214", "merged": true, "mergeCommit": {"oid": "11be2905ca87644aa0b19535eb81cc1c4a3b0ccb"}, "closed": true, "closedAt": "2020-06-01T10:59:55Z", "author": {"login": "manusa"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclxxOsABqjMzODM5OTUxMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcm7lRjgBqjMzOTE5NzIwMjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a9b47e2e87e6ae8d3626cbb90d67b1ad31d455f", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/9a9b47e2e87e6ae8d3626cbb90d67b1ad31d455f", "committedDate": "2020-05-28T17:57:56Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "32b4d63b07ac4f097b2628081692753c84d1e846", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/32b4d63b07ac4f097b2628081692753c84d1e846", "committedDate": "2020-05-28T18:00:05Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32b4d63b07ac4f097b2628081692753c84d1e846", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/32b4d63b07ac4f097b2628081692753c84d1e846", "committedDate": "2020-05-28T18:00:05Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "3658bef654971edabf49d7d42df6e9fb60502655", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/3658bef654971edabf49d7d42df6e9fb60502655", "committedDate": "2020-05-28T18:06:06Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3658bef654971edabf49d7d42df6e9fb60502655", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/3658bef654971edabf49d7d42df6e9fb60502655", "committedDate": "2020-05-28T18:06:06Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "06c1531d28e8429506ac6b1a9935704bbf90fb03", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/06c1531d28e8429506ac6b1a9935704bbf90fb03", "committedDate": "2020-05-29T10:35:59Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06c1531d28e8429506ac6b1a9935704bbf90fb03", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/06c1531d28e8429506ac6b1a9935704bbf90fb03", "committedDate": "2020-05-29T10:35:59Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "c841b46b4138adfa9011722e93000e6d67ae9b16", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/c841b46b4138adfa9011722e93000e6d67ae9b16", "committedDate": "2020-05-29T11:56:35Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c841b46b4138adfa9011722e93000e6d67ae9b16", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/c841b46b4138adfa9011722e93000e6d67ae9b16", "committedDate": "2020-05-29T11:56:35Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "cf6a11647852922c1c0a2d611f1b290c8d65da24", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/cf6a11647852922c1c0a2d611f1b290c8d65da24", "committedDate": "2020-05-29T13:04:52Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjExMDI3", "url": "https://github.com/eclipse/jkube/pull/214#pullrequestreview-421611027", "createdAt": "2020-06-01T06:03:52Z", "commit": {"oid": "cf6a11647852922c1c0a2d611f1b290c8d65da24"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNjowMzo1M1rOGc_pNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNjowMzo1M1rOGc_pNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA1NjA1Mw==", "bodyText": "outputSourceDir seems unused. Umm, maybe you forgot to assertions for it? If not, could you please remove it?", "url": "https://github.com/eclipse/jkube/pull/214#discussion_r433056053", "createdAt": "2020-06-01T06:03:53Z", "author": {"login": "rohanKanojia"}, "path": "jkube-kit/common/src/test/java/org/eclipse/jkube/kit/common/archive/AssemblyFileSetUtilsProcessAssemblyFileSetTest.java", "diffHunk": "@@ -0,0 +1,343 @@\n+/**\n+ * Copyright (c) 2019 Red Hat, Inc.\n+ * This program and the accompanying materials are made\n+ * available under the terms of the Eclipse Public License 2.0\n+ * which is available at:\n+ *\n+ *     https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *   Red Hat, Inc. - initial API and implementation\n+ */\n+package org.eclipse.jkube.kit.common.archive;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jkube.kit.common.AssemblyConfiguration;\n+import org.eclipse.jkube.kit.common.AssemblyFileSet;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import static org.eclipse.jkube.kit.common.archive.AssemblyFileSetUtils.resolveSourceDirectory;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.arrayContainingInAnyOrder;\n+import static org.hamcrest.Matchers.arrayWithSize;\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.emptyArray;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.startsWith;\n+\n+public class AssemblyFileSetUtilsProcessAssemblyFileSetTest {\n+\n+  @Rule\n+  public TemporaryFolder temp = new TemporaryFolder();\n+\n+  private File baseDirectory;\n+  private File sourceDirectory;\n+  private File outputDirectory;\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    baseDirectory = temp.newFolder(\"base\");\n+    sourceDirectory = new File(baseDirectory, \"source-directory\");\n+    final List<File> sourceSubdirectories = Stream.of(\"one\", \"two\", \"three\")\n+        .map(s -> new File(sourceDirectory, s)).collect(Collectors.toList());\n+    for (File directory : Stream.concat(Stream.of(baseDirectory, sourceDirectory), sourceSubdirectories.stream()).collect(Collectors.toList())) {\n+      FileUtils.forceMkdir(directory);\n+      populateSampleFiles(directory);\n+    }\n+    outputDirectory = temp.newFolder(\"output\");\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    outputDirectory = null;\n+    sourceDirectory = null;\n+    baseDirectory = null;\n+  }\n+\n+  private static void populateSampleFiles(File baseDirectory) throws IOException {\n+    for (String fileName : new String[]{\"1.txt\", \"3.other\", \"37\"}) {\n+      assertThat(new File(baseDirectory, fileName).createNewFile(), equalTo(true));\n+    }\n+  }\n+\n+  @Test\n+  public void resolveSourceDirectoryIsAbsoluteShouldReturnAbsolute() throws Exception {\n+    // Given\n+    final File directory = temp.newFolder(\"absolute-path-out-of-base\");\n+    final AssemblyFileSet afs = AssemblyFileSet.builder().directory(directory).build();\n+    // When\n+    final File result = resolveSourceDirectory(baseDirectory, afs);\n+    // Then\n+    assertThat(result, equalTo(directory));\n+    final Path relativeToBase = baseDirectory.toPath().relativize(result.toPath());\n+    assertThat(relativeToBase.toString(), startsWith(\"..\"));\n+  }\n+\n+  @Test\n+  public void resolveSourceDirectoryIsRelativeShouldReturnRelative() {\n+    // Given\n+    final File relativeDirectory = new File(\"source-directory\");\n+    final AssemblyFileSet afs = AssemblyFileSet.builder().directory(relativeDirectory).build();\n+    // When\n+    final File result = resolveSourceDirectory(baseDirectory, afs);\n+    // Then\n+    assertThat(result, equalTo(new File(baseDirectory, \"source-directory\")));\n+    final Path relativeToBase = baseDirectory.toPath().relativize(result.toPath());\n+    assertThat(relativeToBase.toString(), equalTo(\"source-directory\"));\n+  }\n+\n+  @Test\n+  public void assemblyFileSetHasNoDirectoryShouldThrowException() {\n+    // Given\n+    final AssemblyFileSet afs = AssemblyFileSet.builder().build();\n+    final AssemblyConfiguration ac = AssemblyConfiguration.builder()\n+        .name(\"deployments\")\n+        .build();\n+    // When\n+    final Exception result = Assert.assertThrows(NullPointerException.class, () ->\n+      AssemblyFileSetUtils.processAssemblyFileSet(baseDirectory, outputDirectory, afs, ac)\n+    );\n+    // Then\n+    assertThat(result.getMessage(), equalTo(\"Assembly FileSet directory is required\"));\n+  }\n+\n+  @Test\n+  public void assemblyConfigurationHasNoNameShouldThrowException() {\n+    // Given\n+    final AssemblyFileSet afs = AssemblyFileSet.builder()\n+        .directory(sourceDirectory)\n+        .build();\n+    final AssemblyConfiguration ac = AssemblyConfiguration.builder().build();\n+    // When\n+    final Exception result = Assert.assertThrows(NullPointerException.class, () ->\n+        AssemblyFileSetUtils.processAssemblyFileSet(baseDirectory, outputDirectory, afs, ac)\n+    );\n+    // Then\n+    assertThat(result.getMessage(), equalTo(\"Assembly Configuration name is required\"));\n+  }\n+\n+  /**\n+   * Has AssemblyFileSet#directory and AssemblyConfiguration#name options.\n+   *\n+   * Should copy contents of AssemblyFileSet#directory to the outputDirectory in a subdirectory named as the AssemblyConfiguration#name.\n+   */\n+  @Test\n+  public void minimumRequiredFields() throws Exception {\n+    // Given\n+    final AssemblyFileSet afs = AssemblyFileSet.builder()\n+        .directory(sourceDirectory)\n+        .build();\n+    final AssemblyConfiguration ac = AssemblyConfiguration.builder()\n+        .name(\"deployments\")\n+        .build();\n+    // When\n+    final Map<File, String> permissions = AssemblyFileSetUtils.processAssemblyFileSet(baseDirectory, outputDirectory, afs, ac);\n+    // Then\n+    assertThat(permissions.entrySet(), hasSize(4));\n+    final File deployments = new File(outputDirectory, \"deployments\");\n+    assertThat(deployments.exists(), equalTo(true));\n+    assertThat(deployments.listFiles(), arrayWithSize(1));\n+    final File outputSourceDir = Objects.requireNonNull(deployments.listFiles())[0];\n+    assertThat(outputSourceDir.getName(), equalTo(\"source-directory\"));\n+    assertThat(outputSourceDir.exists(), equalTo(true));\n+    assertThat(outputSourceDir.listFiles(), arrayWithSize(6));\n+    assertThat(outputSourceDir.list(), arrayContainingInAnyOrder(\"one\", \"two\", \"three\", \"1.txt\", \"3.other\", \"37\"));\n+  }\n+\n+  /**\n+   * Has AssemblyFileSet#directory and AssemblyConfiguration#name options.\n+   *\n+   * Source directory doesn't exist\n+   *\n+   * Should do nothing.\n+   */\n+  @Test\n+  public void sourceDoesNotExist() throws Exception {\n+    // Given\n+    final AssemblyFileSet afs = AssemblyFileSet.builder()\n+        .directory(new File(sourceDirectory, \"non-existent\"))\n+        .build();\n+    final AssemblyConfiguration ac = AssemblyConfiguration.builder()\n+        .name(\"deployments\")\n+        .build();\n+    // When\n+    final Map<File, String> permissions = AssemblyFileSetUtils.processAssemblyFileSet(baseDirectory, outputDirectory, afs, ac);\n+    // Then\n+    assertThat(permissions.entrySet(), empty());\n+    final File deployments = new File(outputDirectory, \"deployments\");\n+    assertThat(deployments.exists(), equalTo(false));\n+  }\n+\n+  /**\n+   * Has AssemblyFileSet with directory and outputDirectory relative path resolving to self.\n+   * Has AssemblyConfiguration name.\n+   *\n+   * Should copy contents of AssemblyFileSet#directory to the outputDirectory .\n+   */\n+  @Test\n+  public void fileSetDirectoryAndOutputDirectoryResolvingToSelf() throws Exception {\n+    // Given\n+    final AssemblyFileSet afs = AssemblyFileSet.builder()\n+        .directory(sourceDirectory)\n+        .outputDirectory(new File(\".\"))\n+        .build();\n+    final AssemblyConfiguration ac = AssemblyConfiguration.builder()\n+        .name(\"deployments\")\n+        .build();\n+    // When\n+    final Map<File, String> permissions = AssemblyFileSetUtils.processAssemblyFileSet(baseDirectory, outputDirectory, afs, ac);\n+    // Then\n+    assertThat(permissions.entrySet(), hasSize(4));\n+    final File deployments = new File(outputDirectory, \"deployments\");\n+    assertThat(deployments.exists(), equalTo(true));\n+    assertThat(deployments.listFiles(), arrayWithSize(6));\n+    assertThat(deployments.list(), arrayContainingInAnyOrder(\"one\", \"two\", \"three\", \"1.txt\", \"3.other\", \"37\"));\n+    final File outputSourceDir = Objects.requireNonNull(deployments.listFiles())[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf6a11647852922c1c0a2d611f1b290c8d65da24"}, "originalPosition": 213}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf6a11647852922c1c0a2d611f1b290c8d65da24", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/cf6a11647852922c1c0a2d611f1b290c8d65da24", "committedDate": "2020-05-29T13:04:52Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "cac22c75030491a55e1577e9a4dbd9276136a9fa", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/cac22c75030491a55e1577e9a4dbd9276136a9fa", "committedDate": "2020-06-01T06:18:42Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a5ae1e1bf03b046fa6048c8165f0a2cd0b4af17", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/1a5ae1e1bf03b046fa6048c8165f0a2cd0b4af17", "committedDate": "2020-06-01T08:00:09Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cac22c75030491a55e1577e9a4dbd9276136a9fa", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/cac22c75030491a55e1577e9a4dbd9276136a9fa", "committedDate": "2020-06-01T06:18:42Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}, "afterCommit": {"oid": "1a5ae1e1bf03b046fa6048c8165f0a2cd0b4af17", "author": {"user": {"login": "manusa", "name": "Marc Nuri"}}, "url": "https://github.com/eclipse/jkube/commit/1a5ae1e1bf03b046fa6048c8165f0a2cd0b4af17", "committedDate": "2020-06-01T08:00:09Z", "message": "fix: KarafGenerator update\n\n- Created Karaf Quickstart\n- Fixed problems with FileSet assembly config to include complete directories\n- Upgraded images to use quay.io/jkube/jkube-karaf-binary-s2i\n\nSigned-off-by: Marc Nuri <marc@marcnuri.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 268, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}