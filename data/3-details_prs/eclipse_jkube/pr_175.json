{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyOTE2NTg4", "number": 175, "title": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM", "bodyText": "Fix #174\nPorted PR fabric8io/docker-maven-plugin#1299", "createdAt": "2020-05-04T12:18:22Z", "url": "https://github.com/eclipse/jkube/pull/175", "merged": true, "mergeCommit": {"oid": "72188e156fdf213bf627e7e735dc831cd2f6d030"}, "closed": true, "closedAt": "2020-10-30T13:48:37Z", "author": {"login": "rohanKanojia"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfO8GXgFqTQwODEzMzQ0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXmvCmAFqTUyMDY2MzA5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MTMzNDQy", "url": "https://github.com/eclipse/jkube/pull/175#pullrequestreview-408133442", "createdAt": "2020-05-08T09:59:59Z", "commit": {"oid": "cfaaeb402c45c9855f2b2f0d35f344519dffa3f6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMDowMDowMFrOGSgUew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMDowMDowMFrOGSgUew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1NzA4Mw==", "bodyText": "this if condition feels redundant.", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r422057083", "createdAt": "2020-05-08T10:00:00Z", "author": {"login": "dev-gaur"}, "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java", "diffHunk": "@@ -56,23 +56,40 @@ private DockerFileUtil() {}\n      */\n     public static List<String> extractBaseImages(File dockerFile, Properties properties) throws IOException {\n         List<String[]> fromLines = extractLines(dockerFile, \"FROM\", properties);\n+        Map<String, String> args = extractArgs(extractLines(dockerFile, \"ARG\", properties));\n         Set<String> result = new LinkedHashSet<>();\n         Set<String> fromAlias = new HashSet<>();\n         for (String[] fromLine :  fromLines) {\n             if (fromLine.length > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfaaeb402c45c9855f2b2f0d35f344519dffa3f6"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98a6e3769a317b089a74deb3ea4ed11906f12952", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/98a6e3769a317b089a74deb3ea4ed11906f12952", "committedDate": "2020-05-26T07:26:59Z", "message": "Merge branch 'master' into pr/issue174"}, "afterCommit": {"oid": "724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "committedDate": "2020-09-11T16:17:18Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\n port of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "committedDate": "2020-09-11T16:17:18Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\n port of fabric8io/docker-maven-plugin#1299"}, "afterCommit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/1c945891e034f995cc11345179cd4643e6eab1ac", "committedDate": "2020-10-27T18:29:19Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzg2NzE1", "url": "https://github.com/eclipse/jkube/pull/175#pullrequestreview-520386715", "createdAt": "2020-10-30T05:34:19Z", "commit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNTozNDoxOVrOHrB0mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNTozNDoxOVrOHrB0mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MDY2NQ==", "bodyText": "This Regex is dangerous, and reported as a bug https://sonarcloud.io/project/issues?id=jkubeio_jkube&open=AXVraCJxz5kaBwk-uluS&pullRequest=175&resolved=false&types=BUG", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r514880665", "createdAt": "2020-10-30T05:34:19Z", "author": {"login": "manusa"}, "path": "jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java", "diffHunk": "@@ -209,4 +273,36 @@ private static File getHomeDir() {\n         return new File(homeDir);\n     }\n \n+    private static void updateMapWithArgValue(Map<String, String> result, Map<String, String> args, String argString) {\n+        if (argString.contains(\"=\") || argString.contains(\":\")) {\n+            String[] argStringParts = argString.split(\"[=:]\");\n+            String argStringValue = argString.substring(argStringParts[0].length() + 1);\n+            if (argStringValue.startsWith(\"\\\"\") || argStringValue.startsWith(\"'\")) {\n+                // Replaces surrounding quotes\n+                argStringValue = argStringValue.replaceAll(\"^\\\"|\\\"|'|'$\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzg2OTU1", "url": "https://github.com/eclipse/jkube/pull/175#pullrequestreview-520386955", "createdAt": "2020-10-30T05:35:13Z", "commit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNTozNToxNFrOHrB1jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNTozNToxNFrOHrB1jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MDkxMA==", "bodyText": "Declare the pattern as a constant, it's thread-safe. This way you're compiling the pattern  for every method call.", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r514880910", "createdAt": "2020-10-30T05:35:14Z", "author": {"login": "manusa"}, "path": "jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java", "diffHunk": "@@ -130,6 +146,54 @@ private static Reader getFileReaderFromDir(File file) {\n         }\n     }\n \n+    /**\n+     * Helper method for extractArgs(exposed for test)\n+     *\n+     * @param argLines list of string arrays containing lines with words\n+     * @param argsFromBuildConfig Docker build args from Build Configuration\n+     * @return map of parsed arguments\n+     */\n+    protected static Map<String, String> extractArgsFromLines(List<String[]> argLines, Map<String, String> argsFromBuildConfig) {\n+        Map<String, String> result = new HashMap<>();\n+        for (String[] argLine : argLines) {\n+            if (argLine.length > 1) {\n+                updateMapWithArgValue(result, argsFromBuildConfig, argLine[1]);\n+            }\n+        }\n+        return result;\n+    }\n+\n+    private static String resolveImageTagFromArgs(String imageTagString, Map<String, String> args) {\n+        if (imageTagString.startsWith(\"$\")) { // FROM $IMAGE\n+            String resolvedVal = resolveArgValueFromStrContainingArgKey(imageTagString, args);\n+            if (resolvedVal != null) {\n+                return resolvedVal;\n+            }\n+        } else { // FROM image:$TAG_ARG\n+            String[] imageTagArr = imageTagString.split(\":\");\n+            if (imageTagArr.length > 1) {\n+                String tag = resolveArgValueFromStrContainingArgKey(imageTagArr[1], args);\n+                if (tag != null) {\n+                    return imageTagArr[0] + \":\" + tag;\n+                }\n+            }\n+        }\n+        return imageTagString;\n+    }\n+\n+    static String resolveArgValueFromStrContainingArgKey(String argString, Map<String, String> args) {\n+        Pattern argPattern = Pattern.compile(ARG_PATTERN_REGEX);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac"}, "originalPosition": 108}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/1c945891e034f995cc11345179cd4643e6eab1ac", "committedDate": "2020-10-27T18:29:19Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}, "afterCommit": {"oid": "98e914841b8a967eeaaa58cbed6c96581af2f55f", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/98e914841b8a967eeaaa58cbed6c96581af2f55f", "committedDate": "2020-10-30T11:02:15Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98e914841b8a967eeaaa58cbed6c96581af2f55f", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/98e914841b8a967eeaaa58cbed6c96581af2f55f", "committedDate": "2020-10-30T11:02:15Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}, "afterCommit": {"oid": "7355a25858f3aae89a8b1413351b30ae9e8df66e", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/7355a25858f3aae89a8b1413351b30ae9e8df66e", "committedDate": "2020-10-30T11:04:40Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7355a25858f3aae89a8b1413351b30ae9e8df66e", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/7355a25858f3aae89a8b1413351b30ae9e8df66e", "committedDate": "2020-10-30T11:04:40Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}, "afterCommit": {"oid": "50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "committedDate": "2020-10-30T11:11:28Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b693e6dd78b2c6d57db44557d5d1e48165148a4", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/2b693e6dd78b2c6d57db44557d5d1e48165148a4", "committedDate": "2020-10-30T13:02:04Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "committedDate": "2020-10-30T11:11:28Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}, "afterCommit": {"oid": "2b693e6dd78b2c6d57db44557d5d1e48165148a4", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/2b693e6dd78b2c6d57db44557d5d1e48165148a4", "committedDate": "2020-10-30T13:02:04Z", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjYzMDkx", "url": "https://github.com/eclipse/jkube/pull/175#pullrequestreview-520663091", "createdAt": "2020-10-30T13:25:16Z", "commit": {"oid": "2b693e6dd78b2c6d57db44557d5d1e48165148a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 263, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}