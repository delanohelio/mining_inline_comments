{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjc4Njg3", "number": 271, "title": "Fix #246: Dockerfile custom interpolation is broken", "bodyText": "Description\n\nFix #246\nType of change\n\n\n Bug fix (non-breaking change which fixes an issue)\n Feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to change\n Chore (non-breaking change which doesn't affect codebase;\ntest, version modification, documentation, etc.)\n\nChecklist\n\n I have read the contributing guidelines\n I signed-off my commit with a user that has signed the Eclipse Contributor Agreement\n I Added CHANGELOG entry\n I have implemented unit tests to cover my changes\n I have updated the documentation accordingly\n No new bugs, code smells, etc. in SonarCloud report\n I tested my code in Kubernetes\n I tested my code in OpenShift", "createdAt": "2020-07-01T12:51:38Z", "url": "https://github.com/eclipse/jkube/pull/271", "merged": true, "mergeCommit": {"oid": "3673b6d0bb362f12712c849bbca0f24ec717647e"}, "closed": true, "closedAt": "2020-07-08T11:42:10Z", "author": {"login": "rohanKanojia"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxN9w6ABqjM1MDk4NDUyNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy45e9AFqTQ0NDY1OTk0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a82c40b4b38a11c2bf507140d3c85c387e23042", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/3a82c40b4b38a11c2bf507140d3c85c387e23042", "committedDate": "2020-07-01T12:50:30Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}, "afterCommit": {"oid": "41ffcb39f1238b82b630cd559d066f937846859e", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/41ffcb39f1238b82b630cd559d066f937846859e", "committedDate": "2020-07-03T07:04:22Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41ffcb39f1238b82b630cd559d066f937846859e", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/41ffcb39f1238b82b630cd559d066f937846859e", "committedDate": "2020-07-03T07:04:22Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}, "afterCommit": {"oid": "fb35e862a199039147960e8797f4fdb6e40527af", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/fb35e862a199039147960e8797f4fdb6e40527af", "committedDate": "2020-07-03T14:14:56Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb35e862a199039147960e8797f4fdb6e40527af", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/fb35e862a199039147960e8797f4fdb6e40527af", "committedDate": "2020-07-03T14:14:56Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}, "afterCommit": {"oid": "e6e7d05d177636e11d51405535c841424f239af8", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/e6e7d05d177636e11d51405535c841424f239af8", "committedDate": "2020-07-07T11:21:52Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6e7d05d177636e11d51405535c841424f239af8", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/e6e7d05d177636e11d51405535c841424f239af8", "committedDate": "2020-07-07T11:21:52Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}, "afterCommit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "committedDate": "2020-07-07T11:35:46Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODExOTE1", "url": "https://github.com/eclipse/jkube/pull/271#pullrequestreview-443811915", "createdAt": "2020-07-07T11:45:53Z", "commit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0NTo1M1rOGt63Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0NTo1M1rOGt63Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwMzQ5NA==", "bodyText": "No longer used, since we have `public static String interpolate(File dockerFile, Properties properties, String filter) throws IOException {, please remove (test too)", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450803494", "createdAt": "2020-07-07T11:45:53Z", "author": {"login": "manusa"}, "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java", "diffHunk": "@@ -103,15 +102,36 @@ private DockerFileUtil() {}\n      *\n      * @param dockerFile docker file to interpolate.\n      * @param properties properties to interpolate in the provided dockerFile.\n+     * @param filter filter for parsing properties from Dockerfile\n+     * @return The interpolated contents of the file.\n+     * @throws IOException if there's a problem while performin IO operations.\n+     */\n+    public static String interpolate(File dockerFile, Properties properties, String filter) throws IOException {\n+        StringBuilder ret = new StringBuilder();\n+        try (BufferedReader reader = new BufferedReader(new FileReader(dockerFile))) {\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties, filter)).append(System.lineSeparator());\n+            }\n+        }\n+        return ret.toString();\n+    }\n+\n+     /**\n+     * Interpolate a docker file with the given properties and filter\n+     *\n+     * @param dockerFile docker file to interpolate.\n+     * @param properties properties to interpolate in the provided dockerFile.\n+      * @param customInterpolationParams additional delimiters for interpolation\n      * @return The interpolated contents of the file.\n      * @throws IOException if there's a problem while performin IO operations.\n      */\n-    public static String interpolate(File dockerFile, Properties properties) throws IOException {\n+    public static String interpolate(File dockerFile, Properties properties, Map<String, String> customInterpolationParams) throws IOException {\n         StringBuilder ret = new StringBuilder();\n         try (BufferedReader reader = new BufferedReader(new FileReader(dockerFile))) {\n             String line;\n             while ((line = reader.readLine()) != null) {\n-                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties)).append(System.lineSeparator());\n+                ret.append(JKubeDockerfileInterpolator.interpolate(line, properties, customInterpolationParams)).append(System.lineSeparator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODEyMzAy", "url": "https://github.com/eclipse/jkube/pull/271#pullrequestreview-443812302", "createdAt": "2020-07-07T11:46:28Z", "commit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0NjoyOVrOGt64aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0NjoyOVrOGt64aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwMzgxOQ==", "bodyText": "Unused code, please remove", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450803819", "createdAt": "2020-07-07T11:46:29Z", "author": {"login": "manusa"}, "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/JKubeDockerfileInterpolator.java", "diffHunk": "@@ -13,37 +13,197 @@\n  */\n package org.eclipse.jkube.kit.build.service.docker.helper;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n \n public class JKubeDockerfileInterpolator {\n-    private static Map<String, String> delimiters;\n-    static {\n-        delimiters = new HashMap<>();\n-        delimiters.put(\"@\", \"@\");\n-        delimiters.put(\"${\", \"}\");\n-    }\n \n     private JKubeDockerfileInterpolator() { }\n \n-    public static String interpolate(String line, Properties properties) {\n+    public static String interpolate(String line, Map<String, String> context, String filter) {\n+        return interpolate(line, context, getExpressionMarkersFromFilter(filter));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODEzNzc1", "url": "https://github.com/eclipse/jkube/pull/271#pullrequestreview-443813775", "createdAt": "2020-07-07T11:48:45Z", "commit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0ODo0NVrOGt68vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo0ODo0NVrOGt68vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwNDkyNA==", "bodyText": "Unused code, please remove.\nIf you created either of these unused methods to comply with tests, just update the tests to provide the necessary input parameters for the functions.", "url": "https://github.com/eclipse/jkube/pull/271#discussion_r450804924", "createdAt": "2020-07-07T11:48:45Z", "author": {"login": "manusa"}, "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/JKubeDockerfileInterpolator.java", "diffHunk": "@@ -13,37 +13,197 @@\n  */\n package org.eclipse.jkube.kit.build.service.docker.helper;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n \n public class JKubeDockerfileInterpolator {\n-    private static Map<String, String> delimiters;\n-    static {\n-        delimiters = new HashMap<>();\n-        delimiters.put(\"@\", \"@\");\n-        delimiters.put(\"${\", \"}\");\n-    }\n \n     private JKubeDockerfileInterpolator() { }\n \n-    public static String interpolate(String line, Properties properties) {\n+    public static String interpolate(String line, Map<String, String> context, String filter) {\n+        return interpolate(line, context, getExpressionMarkersFromFilter(filter));\n+    }\n+\n+    public static String interpolate(String line, Properties properties, String filter) {\n+        return interpolate(line, properties, getExpressionMarkersFromFilter(filter));\n+    }\n+\n+    /**\n+     * Replace properties in a string\n+     *\n+     * @param line              string provided with parameters\n+     * @param context           properties provided as hashmap\n+     * @param expressionMarkers additional markers to use for parameterized expressions\n+     * @return string with properties parameters replaced\n+     */\n+    public static String interpolate(String line, Map<String, String> context, Map<String, String> expressionMarkers) {\n+        Properties p = new Properties();\n+        context.forEach(p::put);\n+        return checkForPropertiesInLine(line, p, expressionMarkers, null);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4133324a729441e318aa576812aef23009aeb2ac", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/4133324a729441e318aa576812aef23009aeb2ac", "committedDate": "2020-07-07T13:34:12Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/dfc1f7fc75fd2a47149c83180f23fea6b4f9dfd5", "committedDate": "2020-07-07T11:35:46Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}, "afterCommit": {"oid": "4133324a729441e318aa576812aef23009aeb2ac", "author": {"user": {"login": "rohanKanojia", "name": "Rohan Kumar "}}, "url": "https://github.com/eclipse/jkube/commit/4133324a729441e318aa576812aef23009aeb2ac", "committedDate": "2020-07-07T13:34:12Z", "message": "Fix #246: Dockerfile custom interpolation is broken"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjU5OTQ2", "url": "https://github.com/eclipse/jkube/pull/271#pullrequestreview-444659946", "createdAt": "2020-07-08T11:39:46Z", "commit": {"oid": "4133324a729441e318aa576812aef23009aeb2ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 284, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}