{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzODExNTU4", "number": 12002, "title": "[BEAM-9872] Moved Spark validates tests to shared file", "bodyText": "R: @ibzib @robertwb\nMoved Spark Python validates tests to shared file to support all versions of Python.\n(Only tested build with py37 locally. There also may be duplicate code that can be removed.)\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-12T17:49:30Z", "url": "https://github.com/apache/beam/pull/12002", "merged": true, "mergeCommit": {"oid": "858f0b9b0e55f3ea66429dc36721d9f3ab17f084"}, "closed": true, "closedAt": "2020-06-23T23:57:39Z", "author": {"login": "annaqin418"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqpAgrAFqTQzMDAyMzczNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuLmbuABqjM0NzQ3MDU5NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDIzNzM3", "url": "https://github.com/apache/beam/pull/12002#pullrequestreview-430023737", "createdAt": "2020-06-12T20:37:34Z", "commit": {"oid": "a81f3daac9a6eb4371eeac8f75ea6f3c36af9cb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMDozNzozNFrOGjQ_Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMDozNzozNFrOGjQ_Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMTY1OA==", "bodyText": "You'll need to change environment_type and environment_config according to the value of workerType.", "url": "https://github.com/apache/beam/pull/12002#discussion_r439631658", "createdAt": "2020-06-12T20:37:34Z", "author": {"login": "ibzib"}, "path": "sdks/python/test-suites/portable/common.gradle", "diffHunk": "@@ -99,34 +101,110 @@ task flinkTriggerTranscript() {\n   }\n }\n \n+\n+task createProcessWorker {\n+  dependsOn ':sdks:python:container:build'\n+  dependsOn 'setupVirtualenv'\n+  def sdkWorkerFile = file(\"${buildDir}/sdk_worker.sh\")\n+  def osType = 'linux'\n+  if (Os.isFamily(Os.FAMILY_MAC))\n+    osType = 'darwin'\n+  def workerScript = \"${project(\":sdks:python:container:\").buildDir.absolutePath}/target/launcher/${osType}_amd64/boot\"\n+  def sdkWorkerFileCode = \"sh -c \\\"pip=`which pip` . ${envdir}/bin/activate && ${workerScript} \\$* \\\"\"\n+  outputs.file sdkWorkerFile\n+  doLast {\n+    sdkWorkerFile.write sdkWorkerFileCode\n+    exec {\n+      commandLine('sh', '-c', \". ${envdir}/bin/activate && cd ${pythonRootDir} && pip install -e .[test]\")\n+    }\n+    exec {\n+      commandLine('chmod', '+x', sdkWorkerFile)\n+    }\n+  }\n+}\n+\n+def sparkCompatibilityMatrix = {\n+  def config = it ? it as CompatibilityMatrixConfig : new CompatibilityMatrixConfig()\n+  def workerType = config.workerType.name()\n+  def streaming = config.streaming\n+  // def environment_config = config.workerType == CompatibilityMatrixConfig.SDK_WORKER_TYPE.PROCESS ? \"--environment_config='{\\\"command\\\": \\\"${buildDir.absolutePath}/sdk_worker.sh\\\"}'\" : \"\"\n+  def name = \"sparkCompatibilityMatrix${streaming ? 'Streaming' : 'Batch'}${config.preOptimize ? 'PreOptimize' : ''}${workerType}\"\n+  def extra_experiments = []\n+  if (config.preOptimize)\n+    extra_experiments.add('pre_optimize=all')\n+  tasks.create(name: name) {\n+    dependsOn 'createProcessWorker'\n+    dependsOn 'setupVirtualenv'\n+    dependsOn ':runners:spark:job-server:shadowJar'\n+    doLast {\n+      def environment_config = \"'{\\\"command\\\": \\\"${buildDir.absolutePath}/sdk_worker.sh\\\"}'\"\n+      def argMap = [\n+              \"environment_type\"    : \"PROCESS\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81f3daac9a6eb4371eeac8f75ea6f3c36af9cb1"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODQyOTcx", "url": "https://github.com/apache/beam/pull/12002#pullrequestreview-430842971", "createdAt": "2020-06-15T17:19:02Z", "commit": {"oid": "575fc087ebd9bfac9adad3af7567ea0d8f8a7182"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxOTowMlrOGj7gFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxOTowMlrOGj7gFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyODIxMw==", "bodyText": "This isn't used anywhere.", "url": "https://github.com/apache/beam/pull/12002#discussion_r440328213", "createdAt": "2020-06-15T17:19:02Z", "author": {"login": "ibzib"}, "path": "sdks/python/test-suites/portable/common.gradle", "diffHunk": "@@ -99,34 +101,108 @@ task flinkTriggerTranscript() {\n   }\n }\n \n+\n+task createProcessWorker {\n+  dependsOn ':sdks:python:container:build'\n+  dependsOn 'setupVirtualenv'\n+  def sdkWorkerFile = file(\"${buildDir}/sdk_worker.sh\")\n+  def osType = 'linux'\n+  if (Os.isFamily(Os.FAMILY_MAC))\n+    osType = 'darwin'\n+  def workerScript = \"${project(\":sdks:python:container:\").buildDir.absolutePath}/target/launcher/${osType}_amd64/boot\"\n+  def sdkWorkerFileCode = \"sh -c \\\"pip=`which pip` . ${envdir}/bin/activate && ${workerScript} \\$* \\\"\"\n+  outputs.file sdkWorkerFile\n+  doLast {\n+    sdkWorkerFile.write sdkWorkerFileCode\n+    exec {\n+      commandLine('sh', '-c', \". ${envdir}/bin/activate && cd ${pythonRootDir} && pip install -e .[test]\")\n+    }\n+    exec {\n+      commandLine('chmod', '+x', sdkWorkerFile)\n+    }\n+  }\n+}\n+\n+def sparkCompatibilityMatrix = {\n+  def config = it ? it as CompatibilityMatrixConfig : new CompatibilityMatrixConfig()\n+  def workerType = config.workerType.name()\n+  def streaming = config.streaming\n+  def environment_config = config.workerType == CompatibilityMatrixConfig.SDK_WORKER_TYPE.PROCESS ? \"--environment_config='{\\\"command\\\": \\\"${buildDir.absolutePath}/sdk_worker.sh\\\"}'\" : \"\"\n+  def name = \"sparkCompatibilityMatrix${streaming ? 'Streaming' : 'Batch'}${config.preOptimize ? 'PreOptimize' : ''}${workerType}\"\n+  def extra_experiments = []", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "575fc087ebd9bfac9adad3af7567ea0d8f8a7182"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDQzMTA1", "url": "https://github.com/apache/beam/pull/12002#pullrequestreview-431043105", "createdAt": "2020-06-15T22:45:13Z", "commit": {"oid": "191ce730dd9f57432b347c3e89bd874137ecc8d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5978837d589d661c02af299095058db9444e3fa3", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/5978837d589d661c02af299095058db9444e3fa3", "committedDate": "2020-06-23T20:33:12Z", "message": "[BEAM-9872] Moved Spark validates tests to shared file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841b32cc82bca110593f70eff79a9267d5938e89", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/841b32cc82bca110593f70eff79a9267d5938e89", "committedDate": "2020-06-23T20:34:22Z", "message": "combine python versions in wrapper task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6447ab8f04d01f0edf60b90e279906bd4a79f213", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/6447ab8f04d01f0edf60b90e279906bd4a79f213", "committedDate": "2020-06-23T20:35:08Z", "message": "spark test only python 3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277d9666e78cba3747a65ab12c43204e7616c4bb", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/277d9666e78cba3747a65ab12c43204e7616c4bb", "committedDate": "2020-06-23T20:35:15Z", "message": "changed env type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d98ad47583a901f61b7788c845b06cc1aa66b8", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/d8d98ad47583a901f61b7788c845b06cc1aa66b8", "committedDate": "2020-06-23T20:35:15Z", "message": "changed env config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "074615b0f764b6065f41f797ccf39ef89b308697", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/074615b0f764b6065f41f797ccf39ef89b308697", "committedDate": "2020-06-23T20:35:15Z", "message": "changed environment_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85d2e8f1f5fc99dfabcf51b7ce7d84789ecb737e", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/85d2e8f1f5fc99dfabcf51b7ce7d84789ecb737e", "committedDate": "2020-06-23T20:35:15Z", "message": "wrapper task in beam/build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bbb3a80477f81674fb74205ee82e31d1f785af5", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/6bbb3a80477f81674fb74205ee82e31d1f785af5", "committedDate": "2020-06-23T20:35:15Z", "message": "update groovy file to run wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33036db8df803a9501cff5b84820039fda4f7062", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/33036db8df803a9501cff5b84820039fda4f7062", "committedDate": "2020-06-23T19:03:46Z", "message": "merging"}, "afterCommit": {"oid": "6bbb3a80477f81674fb74205ee82e31d1f785af5", "author": {"user": {"login": "annaqin418", "name": null}}, "url": "https://github.com/apache/beam/commit/6bbb3a80477f81674fb74205ee82e31d1f785af5", "committedDate": "2020-06-23T20:35:15Z", "message": "update groovy file to run wrapper"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3419, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}