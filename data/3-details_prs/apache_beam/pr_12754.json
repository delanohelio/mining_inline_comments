{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3Mjk3NDY5", "number": 12754, "title": "[BEAM-10791] Identify and log additional information needed to debug \u2026", "bodyText": "\u2026streaming insert requests for Python SDK\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-01T19:52:03Z", "url": "https://github.com/apache/beam/pull/12754", "merged": true, "mergeCommit": {"oid": "4635afbf686b216983d1c0552b33cd435f922812"}, "closed": true, "closedAt": "2020-09-09T06:44:32Z", "author": {"login": "ihji"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEsaFngH2gAyNDc3Mjk3NDY5OmIxNjc0MmIzZWE3ODMzNGRjMjFiMzNmZjM1MWQxNDE5ZTFlZTQ2NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG-DpsgFqTQ4NDQ4ODY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b16742b3ea78334dc21b33ff351d1419e1ee466e", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/b16742b3ea78334dc21b33ff351d1419e1ee466e", "committedDate": "2020-09-01T19:17:15Z", "message": "[BEAM-10791] Identify and log additional information needed to debug streaming insert requests for Python SDK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf173793b574b2affc68937af48df3fbe7252b9", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/2cf173793b574b2affc68937af48df3fbe7252b9", "committedDate": "2020-09-03T01:38:24Z", "message": "share histogram in a single process"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33c9e34b16c626928faf560d56856d609a8a4eec", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/33c9e34b16c626928faf560d56856d609a8a4eec", "committedDate": "2020-09-03T08:29:19Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfe61fdfd434bf869eb7c5172946ab5bd4b96f9b", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/cfe61fdfd434bf869eb7c5172946ab5bd4b96f9b", "committedDate": "2020-09-03T09:14:24Z", "message": "add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/e521d101130af1be236827136c24d3ad15f889fd", "committedDate": "2020-09-03T09:42:17Z", "message": "safer locking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTk1MTUw", "url": "https://github.com/apache/beam/pull/12754#pullrequestreview-481995150", "createdAt": "2020-09-03T16:09:54Z", "commit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjowOTo1NFrOHMtyoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjo1NDozNVrOHMvfIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5NTIwMQ==", "bodyText": "Help me understand a bit here. Am I correct about this:\n\nThere are multiple threads\nBut due to Global Interpreter Lock, only one thread runs at a time\nBut threads can possibly block in these sections, get preempted and another thread will start running\nso we need the locking to ensure only one thread is running in this block at a time.\n\nIn addition\n\nMultiple python processes also execute, and there are multiple python SDK harnesses running in order to get more parallelism (they don't have the same type of threading concurrency issues, but may communicate with the multiprocessing module).\nThough this is not why the lock is introduced", "url": "https://github.com/apache/beam/pull/12754#discussion_r483095201", "createdAt": "2020-09-03T16:09:54Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)\n+    if BigQueryWriteFn.LATENCY_LOGGING_LOCK.acquire(False):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5Njc1NA==", "bodyText": "acquire with the false parameter can skip this section entirely, if another thread has the lock. So if that happens we won't record current_millis into the histogram", "url": "https://github.com/apache/beam/pull/12754#discussion_r483096754", "createdAt": "2020-09-03T16:12:13Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)\n+    if BigQueryWriteFn.LATENCY_LOGGING_LOCK.acquire(False):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMDQzMQ==", "bodyText": "Are we sure finishBundle is called frequently enough? I.e. are there bundles which process for a long time? Are we sure this code will get invoked when there are failures to write to BQ?", "url": "https://github.com/apache/beam/pull/12754#discussion_r483100431", "createdAt": "2020-09-03T16:18:04Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMjYyNQ==", "bodyText": "\" Note that the total count and each percentile value may not be correlated each other\"\nI don't fully grasp the meaning. Would you please rephrase? :)", "url": "https://github.com/apache/beam/pull/12754#discussion_r483102625", "createdAt": "2020-09-03T16:21:23Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)\n+    if BigQueryWriteFn.LATENCY_LOGGING_LOCK.acquire(False):\n+      try:\n+        if (BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.total_count() > 0 and\n+            (current_millis -\n+             BigQueryWriteFn.LATENCY_LOGGING_LAST_REPORTED_MILLIS) >\n+            self._latency_logging_frequency * 1000):\n+          self._log_percentiles()\n+          BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.clear()\n+          BigQueryWriteFn.LATENCY_LOGGING_LAST_REPORTED_MILLIS = current_millis\n+      finally:\n+        BigQueryWriteFn.LATENCY_LOGGING_LOCK.release()\n     return self._flush_all_batches()\n \n+  @classmethod\n+  def _log_percentiles(cls):\n+    # Note that the total count and each percentile value may not be correlated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNzEyOQ==", "bodyText": "add units to variable name\ni.e.\n_latency_logging_frequency_msec", "url": "https://github.com/apache/beam/pull/12754#discussion_r483107129", "createdAt": "2020-09-03T16:28:28Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1096,6 +1106,7 @@ def __init__(\n     self.failed_rows_metric = Metrics.distribution(\n         self.__class__, \"rows_failed_per_batch\")\n     self.bigquery_wrapper = None\n+    self._latency_logging_frequency = latency_logging_frequency or 180", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwODg3Nw==", "bodyText": "add units, _secs, _msecs, etc.", "url": "https://github.com/apache/beam/pull/12754#discussion_r483108877", "createdAt": "2020-09-03T16:31:20Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/options/pipeline_options.py", "diffHunk": "@@ -675,6 +675,27 @@ def validate(self, validator):\n     return errors\n \n \n+class BigQueryOptions(PipelineOptions):\n+  \"\"\"BigQueryIO configuration options.\"\"\"\n+  @classmethod\n+  def _add_argparse_args(cls, parser):\n+    parser.add_argument(\n+        '--latency_logging_frequency',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExMjE5Ng==", "bodyText": "This shouldn't be in an else block, Please always record the latency. Place large values it in a bucket representing -INF and +INF boundaries, as we discussed in the java PR", "url": "https://github.com/apache/beam/pull/12754#discussion_r483112196", "createdAt": "2020-09-03T16:36:33Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/utils/histogram.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import math\n+import threading\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Histogram(object):\n+  \"\"\"A histogram that supports estimated percentile with linear interpolation.\n+\n+  This class is considered experimental and may break or receive backwards-\n+  incompatible changes in future versions of the Apache Beam SDK.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._lock = threading.Lock()\n+    self._bucket_type = bucket_type\n+    self._buckets = {}\n+    self._num_records = 0\n+    self._num_top_records = 0\n+    self._num_bot_records = 0\n+\n+  def clear(self):\n+    with self._lock:\n+      self._buckets = {}\n+      self._num_records = 0\n+      self._num_top_records = 0\n+      self._num_bot_records = 0\n+\n+  def record(self, *args):\n+    for arg in args:\n+      self._record(arg)\n+\n+  def _record(self, value):\n+    range_from = self._bucket_type.range_from()\n+    range_to = self._bucket_type.range_to()\n+    with self._lock:\n+      if value >= range_to:\n+        _LOGGER.warning('record is out of upper bound %s: %s', range_to, value)\n+        self._num_top_records += 1\n+      elif value < range_from:\n+        _LOGGER.warning(\n+            'record is out of lower bound %s: %s', range_from, value)\n+        self._num_bot_records += 1\n+      else:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNDE0MA==", "bodyText": "This doesn't seem like an Error. Instead of Raising a RuntimeError, consider returning an empty/unpopulated result", "url": "https://github.com/apache/beam/pull/12754#discussion_r483114140", "createdAt": "2020-09-03T16:39:41Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/utils/histogram.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import math\n+import threading\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Histogram(object):\n+  \"\"\"A histogram that supports estimated percentile with linear interpolation.\n+\n+  This class is considered experimental and may break or receive backwards-\n+  incompatible changes in future versions of the Apache Beam SDK.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._lock = threading.Lock()\n+    self._bucket_type = bucket_type\n+    self._buckets = {}\n+    self._num_records = 0\n+    self._num_top_records = 0\n+    self._num_bot_records = 0\n+\n+  def clear(self):\n+    with self._lock:\n+      self._buckets = {}\n+      self._num_records = 0\n+      self._num_top_records = 0\n+      self._num_bot_records = 0\n+\n+  def record(self, *args):\n+    for arg in args:\n+      self._record(arg)\n+\n+  def _record(self, value):\n+    range_from = self._bucket_type.range_from()\n+    range_to = self._bucket_type.range_to()\n+    with self._lock:\n+      if value >= range_to:\n+        _LOGGER.warning('record is out of upper bound %s: %s', range_to, value)\n+        self._num_top_records += 1\n+      elif value < range_from:\n+        _LOGGER.warning(\n+            'record is out of lower bound %s: %s', range_from, value)\n+        self._num_bot_records += 1\n+      else:\n+        index = self._bucket_type.bucket_index(value)\n+        self._buckets[index] = self._buckets.get(index, 0) + 1\n+        self._num_records += 1\n+\n+  def total_count(self):\n+    return self._num_records + self._num_top_records + self._num_bot_records\n+\n+  def p99(self):\n+    return self.get_linear_interpolation(0.99)\n+\n+  def p90(self):\n+    return self.get_linear_interpolation(0.90)\n+\n+  def p50(self):\n+    return self.get_linear_interpolation(0.50)\n+\n+  def get_linear_interpolation(self, percentile):\n+    \"\"\"Calculate percentile estimation based on linear interpolation.\n+\n+    It first finds the bucket which includes the target percentile and\n+    projects the estimated point in the bucket by assuming all the elements\n+    in the bucket are uniformly distributed.\n+    \"\"\"\n+    with self._lock:\n+      total_num_records = self.total_count()\n+      if total_num_records == 0:\n+        raise RuntimeError('histogram has no record.')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNTIxMQ==", "bodyText": "Rather than stating inf or -inf, state that the percentile is at least as large as the smallest/largest bucket. Which is a more meaningful message to a user reading it", "url": "https://github.com/apache/beam/pull/12754#discussion_r483115211", "createdAt": "2020-09-03T16:41:22Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/utils/histogram.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import math\n+import threading\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Histogram(object):\n+  \"\"\"A histogram that supports estimated percentile with linear interpolation.\n+\n+  This class is considered experimental and may break or receive backwards-\n+  incompatible changes in future versions of the Apache Beam SDK.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._lock = threading.Lock()\n+    self._bucket_type = bucket_type\n+    self._buckets = {}\n+    self._num_records = 0\n+    self._num_top_records = 0\n+    self._num_bot_records = 0\n+\n+  def clear(self):\n+    with self._lock:\n+      self._buckets = {}\n+      self._num_records = 0\n+      self._num_top_records = 0\n+      self._num_bot_records = 0\n+\n+  def record(self, *args):\n+    for arg in args:\n+      self._record(arg)\n+\n+  def _record(self, value):\n+    range_from = self._bucket_type.range_from()\n+    range_to = self._bucket_type.range_to()\n+    with self._lock:\n+      if value >= range_to:\n+        _LOGGER.warning('record is out of upper bound %s: %s', range_to, value)\n+        self._num_top_records += 1\n+      elif value < range_from:\n+        _LOGGER.warning(\n+            'record is out of lower bound %s: %s', range_from, value)\n+        self._num_bot_records += 1\n+      else:\n+        index = self._bucket_type.bucket_index(value)\n+        self._buckets[index] = self._buckets.get(index, 0) + 1\n+        self._num_records += 1\n+\n+  def total_count(self):\n+    return self._num_records + self._num_top_records + self._num_bot_records\n+\n+  def p99(self):\n+    return self.get_linear_interpolation(0.99)\n+\n+  def p90(self):\n+    return self.get_linear_interpolation(0.90)\n+\n+  def p50(self):\n+    return self.get_linear_interpolation(0.50)\n+\n+  def get_linear_interpolation(self, percentile):\n+    \"\"\"Calculate percentile estimation based on linear interpolation.\n+\n+    It first finds the bucket which includes the target percentile and\n+    projects the estimated point in the bucket by assuming all the elements\n+    in the bucket are uniformly distributed.\n+    \"\"\"\n+    with self._lock:\n+      total_num_records = self.total_count()\n+      if total_num_records == 0:\n+        raise RuntimeError('histogram has no record.')\n+\n+      index = 0\n+      record_sum = self._num_bot_records\n+      if record_sum / total_num_records >= percentile:\n+        return float('-inf')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNTQ1Mw==", "bodyText": "indent this line by 4", "url": "https://github.com/apache/beam/pull/12754#discussion_r483115453", "createdAt": "2020-09-03T16:41:44Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/utils/histogram.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import math\n+import threading\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Histogram(object):\n+  \"\"\"A histogram that supports estimated percentile with linear interpolation.\n+\n+  This class is considered experimental and may break or receive backwards-\n+  incompatible changes in future versions of the Apache Beam SDK.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._lock = threading.Lock()\n+    self._bucket_type = bucket_type\n+    self._buckets = {}\n+    self._num_records = 0\n+    self._num_top_records = 0\n+    self._num_bot_records = 0\n+\n+  def clear(self):\n+    with self._lock:\n+      self._buckets = {}\n+      self._num_records = 0\n+      self._num_top_records = 0\n+      self._num_bot_records = 0\n+\n+  def record(self, *args):\n+    for arg in args:\n+      self._record(arg)\n+\n+  def _record(self, value):\n+    range_from = self._bucket_type.range_from()\n+    range_to = self._bucket_type.range_to()\n+    with self._lock:\n+      if value >= range_to:\n+        _LOGGER.warning('record is out of upper bound %s: %s', range_to, value)\n+        self._num_top_records += 1\n+      elif value < range_from:\n+        _LOGGER.warning(\n+            'record is out of lower bound %s: %s', range_from, value)\n+        self._num_bot_records += 1\n+      else:\n+        index = self._bucket_type.bucket_index(value)\n+        self._buckets[index] = self._buckets.get(index, 0) + 1\n+        self._num_records += 1\n+\n+  def total_count(self):\n+    return self._num_records + self._num_top_records + self._num_bot_records\n+\n+  def p99(self):\n+    return self.get_linear_interpolation(0.99)\n+\n+  def p90(self):\n+    return self.get_linear_interpolation(0.90)\n+\n+  def p50(self):\n+    return self.get_linear_interpolation(0.50)\n+\n+  def get_linear_interpolation(self, percentile):\n+    \"\"\"Calculate percentile estimation based on linear interpolation.\n+\n+    It first finds the bucket which includes the target percentile and\n+    projects the estimated point in the bucket by assuming all the elements\n+    in the bucket are uniformly distributed.\n+    \"\"\"\n+    with self._lock:\n+      total_num_records = self.total_count()\n+      if total_num_records == 0:\n+        raise RuntimeError('histogram has no record.')\n+\n+      index = 0\n+      record_sum = self._num_bot_records\n+      if record_sum / total_num_records >= percentile:\n+        return float('-inf')\n+      while index < self._bucket_type.num_buckets():\n+        record_sum += self._buckets.get(index, 0)\n+        if record_sum / total_num_records >= percentile:\n+          break\n+        index += 1\n+      if index == self._bucket_type.num_buckets():\n+        return float('inf')\n+\n+      frac_percentile = percentile - (\n+          record_sum - self._buckets[index]) / total_num_records\n+      bucket_percentile = self._buckets[index] / total_num_records\n+    frac_bucket_size = frac_percentile * self._bucket_type.bucket_size(\n+        index) / bucket_percentile\n+    return self._bucket_type.range_from(\n+    ) + self._bucket_type.accumulated_bucket_size(index) + frac_bucket_size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNzg0Mw==", "bodyText": "Add a pydoc for the percentile parameter. Stating that it should be in the range (0, 1)", "url": "https://github.com/apache/beam/pull/12754#discussion_r483117843", "createdAt": "2020-09-03T16:45:40Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/utils/histogram.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import math\n+import threading\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Histogram(object):\n+  \"\"\"A histogram that supports estimated percentile with linear interpolation.\n+\n+  This class is considered experimental and may break or receive backwards-\n+  incompatible changes in future versions of the Apache Beam SDK.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._lock = threading.Lock()\n+    self._bucket_type = bucket_type\n+    self._buckets = {}\n+    self._num_records = 0\n+    self._num_top_records = 0\n+    self._num_bot_records = 0\n+\n+  def clear(self):\n+    with self._lock:\n+      self._buckets = {}\n+      self._num_records = 0\n+      self._num_top_records = 0\n+      self._num_bot_records = 0\n+\n+  def record(self, *args):\n+    for arg in args:\n+      self._record(arg)\n+\n+  def _record(self, value):\n+    range_from = self._bucket_type.range_from()\n+    range_to = self._bucket_type.range_to()\n+    with self._lock:\n+      if value >= range_to:\n+        _LOGGER.warning('record is out of upper bound %s: %s', range_to, value)\n+        self._num_top_records += 1\n+      elif value < range_from:\n+        _LOGGER.warning(\n+            'record is out of lower bound %s: %s', range_from, value)\n+        self._num_bot_records += 1\n+      else:\n+        index = self._bucket_type.bucket_index(value)\n+        self._buckets[index] = self._buckets.get(index, 0) + 1\n+        self._num_records += 1\n+\n+  def total_count(self):\n+    return self._num_records + self._num_top_records + self._num_bot_records\n+\n+  def p99(self):\n+    return self.get_linear_interpolation(0.99)\n+\n+  def p90(self):\n+    return self.get_linear_interpolation(0.90)\n+\n+  def p50(self):\n+    return self.get_linear_interpolation(0.50)\n+\n+  def get_linear_interpolation(self, percentile):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExOTgxNg==", "bodyText": "Seems like since you don't use the same lock to write here, as you do to record into the histogram. That there can be threads which write to this as you are printing it. Changing the values in the histogram as you are logging.\nYou could fix this by having one call inside the LATENCY_LOGGING_HISTOGRAM which requires the histogram's internal lock returns all the variables you re logging", "url": "https://github.com/apache/beam/pull/12754#discussion_r483119816", "createdAt": "2020-09-03T16:49:16Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)\n+    if BigQueryWriteFn.LATENCY_LOGGING_LOCK.acquire(False):\n+      try:\n+        if (BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.total_count() > 0 and\n+            (current_millis -\n+             BigQueryWriteFn.LATENCY_LOGGING_LAST_REPORTED_MILLIS) >\n+            self._latency_logging_frequency * 1000):\n+          self._log_percentiles()\n+          BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.clear()\n+          BigQueryWriteFn.LATENCY_LOGGING_LAST_REPORTED_MILLIS = current_millis\n+      finally:\n+        BigQueryWriteFn.LATENCY_LOGGING_LOCK.release()\n     return self._flush_all_batches()\n \n+  @classmethod\n+  def _log_percentiles(cls):\n+    # Note that the total count and each percentile value may not be correlated\n+    # each other. Histogram releases lock between each percentile calculation\n+    # so additional latencies could be added anytime.\n+    # pylint: disable=round-builtin\n+    _LOGGER.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEyMjk3Nw==", "bodyText": "I noticed that you have three calls to time.time(). This is an expensive system call. Is there any way to eliminate this additional usage here? I.e. You could just update the current_millis, in other places where you call time.time().\nThough since this is in finish_bundle, maybe this is fine\nThough see other comment, not sure its wise to do this in finish_bundle. We still need to be careful that we don't starve out the logging. The solution to that may be to log in both finish bundle (always). and after each request (if we have exceeded the logging interval)\n@chamikaramj WDYT?", "url": "https://github.com/apache/beam/pull/12754#discussion_r483122977", "createdAt": "2020-09-03T16:54:35Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDM1MDgz", "url": "https://github.com/apache/beam/pull/12754#pullrequestreview-482035083", "createdAt": "2020-09-03T17:00:33Z", "commit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzowMDozNFrOHMvtAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzowMDozNFrOHMvtAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEyNjUzMQ==", "bodyText": "Is there a reason why you clear? I think we need to have a good sample of elements over a period of time to a decent latency breakdown. This seems like it will be cleared quite frequently.\nIn the metric case we will just pass it all to stackdriver, and it can basically get these latencies over a sliding window. I.e. at each minute show the 50, 95, 99th percentile latencies for the last 10 minute window.\nIn the logging case, we would like to have something similar. I'm not saying you need to make such a complex calculation to move things in and out of the window.\nThough, maybe this is perfectly fine, for 180 seconds we can probably record a decent number of requests.", "url": "https://github.com/apache/beam/pull/12754#discussion_r483126531", "createdAt": "2020-09-03T17:00:34Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1198,8 +1209,34 @@ def process(self, element, *schema_side_inputs):\n       return self._flush_all_batches()\n \n   def finish_bundle(self):\n+    current_millis = int(time.time() * 1000)\n+    if BigQueryWriteFn.LATENCY_LOGGING_LOCK.acquire(False):\n+      try:\n+        if (BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.total_count() > 0 and\n+            (current_millis -\n+             BigQueryWriteFn.LATENCY_LOGGING_LAST_REPORTED_MILLIS) >\n+            self._latency_logging_frequency * 1000):\n+          self._log_percentiles()\n+          BigQueryWriteFn.LATENCY_LOGGING_HISTOGRAM.clear()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e521d101130af1be236827136c24d3ad15f889fd"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f08762f0c0ed6d4cc6f6306dc4bc997561a22b3c", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/f08762f0c0ed6d4cc6f6306dc4bc997561a22b3c", "committedDate": "2020-09-04T00:14:11Z", "message": "addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccd5d6bb6d0b50f107071b25d0467390e53615f9", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/ccd5d6bb6d0b50f107071b25d0467390e53615f9", "committedDate": "2020-09-04T01:10:07Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3613ac51c6954b40318e28973d35fff43124853e", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/3613ac51c6954b40318e28973d35fff43124853e", "committedDate": "2020-09-04T08:01:45Z", "message": "get atomic percentile loggings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50009a8488e9b190bf05c79d3f4926187353be78", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/50009a8488e9b190bf05c79d3f4926187353be78", "committedDate": "2020-09-04T08:32:28Z", "message": "add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDg4NjU2", "url": "https://github.com/apache/beam/pull/12754#pullrequestreview-484488656", "createdAt": "2020-09-08T20:58:53Z", "commit": {"oid": "50009a8488e9b190bf05c79d3f4926187353be78"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4611, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}