{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDc2NTMy", "number": 12637, "title": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering.", "bodyText": "R: @robertwb\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n \n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-19T21:49:26Z", "url": "https://github.com/apache/beam/pull/12637", "merged": true, "mergeCommit": {"oid": "233ddc174b4d4e8b576cdde4b7dd859ea884dad2"}, "closed": true, "closedAt": "2020-09-22T22:06:14Z", "author": {"login": "ibzib"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA0RYYgFqTQ3MTg2NDY0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLdoCjgH2gAyNDcwNDc2NTMyOmE0ZWE2OGNlZDNkZWI0YTZlNWFlNzQ1ZGVkZjhhYzY1NzQwZjc5YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODY0NjQy", "url": "https://github.com/apache/beam/pull/12637#pullrequestreview-471864642", "createdAt": "2020-08-20T18:11:11Z", "commit": {"oid": "98dffcf4ded012d765b606ab5d9a90861583f19e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoxMToxMVrOHENiuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoxMToxMVrOHENiuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3ODIzMw==", "bodyText": "I don't think this change updates the test to test the correct expectations since we should be testing that multiple messages are received in order over the channel.\nI believe send doesn't have the correct semantics since we want to have a persistent stream for the life of this test and to control when it gets closed after sending for a specific instruction,transform pair is done.", "url": "https://github.com/apache/beam/pull/12637#discussion_r474178233", "createdAt": "2020-08-20T18:11:11Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/worker/data_plane_test.py", "diffHunk": "@@ -99,35 +100,33 @@ def send(instruction_id, transform_id, data):\n \n     # Single write.\n     send('0', transform_1, b'abc')\n-    self.assertEqual(\n+    hc.assert_that(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98dffcf4ded012d765b606ab5d9a90861583f19e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/97d548ef23a89c892f3809a7ff9473704179b8ce", "committedDate": "2020-09-18T21:40:13Z", "message": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98dffcf4ded012d765b606ab5d9a90861583f19e", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/98dffcf4ded012d765b606ab5d9a90861583f19e", "committedDate": "2020-08-19T21:48:02Z", "message": "[BEAM-10768] Don't assert the order in which elements are received."}, "afterCommit": {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/97d548ef23a89c892f3809a7ff9473704179b8ce", "committedDate": "2020-09-18T21:40:13Z", "message": "[BEAM-10768] Sleep in time-based flush test to ensure correct ordering."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTk3Mjk4", "url": "https://github.com/apache/beam/pull/12637#pullrequestreview-492997298", "createdAt": "2020-09-21T21:35:20Z", "commit": {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTozNToyMFrOHVjPww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTozNToyMFrOHVjPww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1OTYxOQ==", "bodyText": "Why do we need to wait for the flush, shouldn't the earlier stream21.write(b'def') provide the correct ordering?", "url": "https://github.com/apache/beam/pull/12637#discussion_r492359619", "createdAt": "2020-09-21T21:35:20Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/worker/data_plane_test.py", "diffHunk": "@@ -108,16 +106,28 @@ def send(instruction_id, transform_id, data):\n         ])\n \n     # Multiple interleaved writes to multiple instructions.\n-    send('1', transform_1, b'abc')\n-    send('2', transform_1, b'def')\n+    stream11 = from_channel.output_stream('1', transform_1)\n+    stream11.write(b'abc')\n+    stream21 = from_channel.output_stream('2', transform_1)\n+    stream21.write(b'def')\n+    if not time_based_flush:\n+      stream11.close()\n     self.assertEqual(\n         list(\n             itertools.islice(to_channel.input_elements('1', [transform_1]), 1)),\n         [\n             beam_fn_api_pb2.Elements.Data(\n                 instruction_id='1', transform_id=transform_1, data=b'abc')\n         ])\n-    send('2', transform_2, b'ghi')\n+    if time_based_flush:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTg0NTA1", "url": "https://github.com/apache/beam/pull/12637#pullrequestreview-493584505", "createdAt": "2020-09-22T15:25:16Z", "commit": {"oid": "97d548ef23a89c892f3809a7ff9473704179b8ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4ea68ced3deb4a6e5ae745dedf8ac65740f79ab", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/a4ea68ced3deb4a6e5ae745dedf8ac65740f79ab", "committedDate": "2020-09-22T20:01:23Z", "message": "Add comment explaining flush callbacks."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4816, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}