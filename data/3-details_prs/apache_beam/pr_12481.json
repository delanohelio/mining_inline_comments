{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTMzODY3", "number": 12481, "title": "[BEAM-10571] Use schemas in ExternalConfigurationPayload", "bodyText": "16bc9bb: The bulk of the change. Changes external_transform.proto to encode a Schema and a Row, and modifies Java's ExpansionService, and Python's SchemaBasedPayloadBuilders, to use the new representation.\n5ff29d8: Changes related to KafkaIO. Since KV is not supported in schemas, KafkaIO configuration types are changed to use Map<String, String> instead of List<KV<String, String>>. Also updates references to external_transform.proto in KafkaIOExternalTest.\n0ef3701: Updates references to external_transform.proto in PubsubIOExternalTest.\nb8936db: Updates references to external_transform.proto in XVR test fixtures (Java and Python).\n\nSome notes about the implementation:\n\nSince KV is not supported by Rows, I've updated the tests that used them in this context to use a Map instead. In many unit tests this is not a true replacement, but I think it's valid since the only application that currently requires KV is encoding a Map as a List.\nFor users of Python's SchemaBasedPayloadBuilder and implementors of Java's ExternalTransformBuilder the change should be transparent (with the exception that they can no longer use KV).\nFor ExternalTransformBuilder implementations it is now possible to register a Schema for ConfigT and we will use that to populate an instance rather than the existing setter approach.\nDue to BEAM-10632 I've temporarily added a testCompile dependency on checker framework to :sdks:java:expansion-service so that I can still test the schema inference capability.\n\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-06T16:30:44Z", "url": "https://github.com/apache/beam/pull/12481", "merged": true, "mergeCommit": {"oid": "ef533ee9ff2511d37563e01f0430de0ec1e61004"}, "closed": true, "closedAt": "2020-08-11T22:08:33Z", "author": {"login": "TheNeuralBit"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8TsjgAFqTQ2Mjc0OTI0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc96C0TABqjM2NDQxOTY5MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzQ5MjQ4", "url": "https://github.com/apache/beam/pull/12481#pullrequestreview-462749248", "createdAt": "2020-08-06T17:53:37Z", "commit": {"oid": "b8936db44dff1e889365fd3c676160af24f91f2f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzo1MzozN1rOG8-MOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzo1Mzo1OVrOG8-M_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4NjY4Mw==", "bodyText": "So this is a design decision?\nthis configRow is a Row with a String field and the payload is already a string/byte array. At least in this case it seems that without a scheme that payload can still be constructed back to a Row.\nThe schema looks right in general when payload is not a string/byte array", "url": "https://github.com/apache/beam/pull/12481#discussion_r466586683", "createdAt": "2020-08-06T17:53:37Z", "author": {"login": "amaliujia"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/ValidateRunnerXlangTest.java", "diffHunk": "@@ -222,14 +228,21 @@ public void partitionTest() {\n   }\n \n   private byte[] toStringPayloadBytes(String data) throws IOException {\n+    Row configRow =\n+        Row.withSchema(Schema.of(Field.of(\"data\", FieldType.STRING)))\n+            .withFieldValue(\"data\", data)\n+            .build();\n+\n+    ByteString.Output outputStream = ByteString.newOutput();\n+    try {\n+      RowCoder.of(configRow.getSchema()).encode(configRow, outputStream);\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n     ExternalTransforms.ExternalConfigurationPayload payload =\n         ExternalTransforms.ExternalConfigurationPayload.newBuilder()\n-            .putConfiguration(\n-                \"data\",\n-                ExternalTransforms.ConfigValue.newBuilder()\n-                    .addCoderUrn(\"beam:coder:string_utf8:v1\")\n-                    .setPayload(ByteString.copyFrom(encodeString(data)))\n-                    .build())\n+            .setSchema(SchemaTranslation.schemaToProto(configRow.getSchema(), false))\n+            .setPayload(outputStream.toByteString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8936db44dff1e889365fd3c676160af24f91f2f"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU4Njg3Nw==", "bodyText": "Split this comment to multiple lines?", "url": "https://github.com/apache/beam/pull/12481#discussion_r466586877", "createdAt": "2020-08-06T17:53:59Z", "author": {"login": "amaliujia"}, "path": "sdks/java/expansion-service/build.gradle", "diffHunk": "@@ -44,6 +44,8 @@ dependencies {\n   compile library.java.slf4j_api\n   runtimeOnly library.java.slf4j_jdk14\n   testCompile library.java.junit\n+  // TODO(BEAM-10632): Remove this. Currently Schema inference (used in ExpansionServiceTest) hits an NPE when checker is enabled, and checkerframework is not in the classpath.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8936db44dff1e889365fd3c676160af24f91f2f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjk4MDAz", "url": "https://github.com/apache/beam/pull/12481#pullrequestreview-463698003", "createdAt": "2020-08-08T00:25:40Z", "commit": {"oid": "bee80c8d67734e21f83d46ca01819e482ca8e6cf"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODU2MTAx", "url": "https://github.com/apache/beam/pull/12481#pullrequestreview-463856101", "createdAt": "2020-08-09T08:55:38Z", "commit": {"oid": "bee80c8d67734e21f83d46ca01819e482ca8e6cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwODo1NTozOFrOG95ZrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwODo1NTozOFrOG95ZrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU1Njc4MQ==", "bodyText": "Comment should be updated (no byte arrays anymore).", "url": "https://github.com/apache/beam/pull/12481#discussion_r467556781", "createdAt": "2020-08-09T08:55:38Z", "author": {"login": "mxm"}, "path": "sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/KafkaIO.java", "diffHunk": "@@ -1452,12 +1446,12 @@ public void populateDisplayData(DisplayData.Builder builder) {\n       public static class Configuration {\n \n         // All byte arrays are UTF-8 encoded strings\n-        private Iterable<KV<String, String>> producerConfig;\n+        private Map<String, String> producerConfig;\n         private String topic;\n         private String keySerializer;\n         private String valueSerializer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bee80c8d67734e21f83d46ca01819e482ca8e6cf"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8cc5690169d4556b61998d9e8b9e058a6bfdbed", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/f8cc5690169d4556b61998d9e8b9e058a6bfdbed", "committedDate": "2020-08-11T17:05:01Z", "message": "Update external_transforms.proto to use schemas, implement in Python and Java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3508bde0ed8aeb962ed7c904df14c28401f0e8", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/ad3508bde0ed8aeb962ed7c904df14c28401f0e8", "committedDate": "2020-08-11T17:07:13Z", "message": "Use map in xlang KafkaIO, Update KafkaIOExternalTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea938aa821e8a151bb78812a810e4e02ce1b2bd4", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/ea938aa821e8a151bb78812a810e4e02ce1b2bd4", "committedDate": "2020-08-11T17:07:17Z", "message": "Update PubsubIOExternalTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd42df4cdb5d9943b2fa624d32b9eca81b63e5cd", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/cd42df4cdb5d9943b2fa624d32b9eca81b63e5cd", "committedDate": "2020-08-11T17:07:17Z", "message": "Update XVR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e190d6ecba7e0f5a77e44290dec8d00f59d239", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/f4e190d6ecba7e0f5a77e44290dec8d00f59d239", "committedDate": "2020-08-11T17:07:17Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e911490463e19084d0d065dc51b975a5643a1f63", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/e911490463e19084d0d065dc51b975a5643a1f63", "committedDate": "2020-08-11T17:07:17Z", "message": "spotbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbab9e26abf05852932b0021d352829f543ebeb4", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/bbab9e26abf05852932b0021d352829f543ebeb4", "committedDate": "2020-08-11T17:08:56Z", "message": "Remove byte array comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bee80c8d67734e21f83d46ca01819e482ca8e6cf", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/bee80c8d67734e21f83d46ca01819e482ca8e6cf", "committedDate": "2020-08-07T22:06:03Z", "message": "spotbugs"}, "afterCommit": {"oid": "bbab9e26abf05852932b0021d352829f543ebeb4", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/bbab9e26abf05852932b0021d352829f543ebeb4", "committedDate": "2020-08-11T17:08:56Z", "message": "Remove byte array comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3761, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}