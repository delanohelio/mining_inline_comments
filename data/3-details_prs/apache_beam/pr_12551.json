{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTM0MDk5", "number": 12551, "title": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp", "bodyText": "This seems to fix the issue in my pipeline. Not sure if this is the best solution, yet. This PR is for discussion.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-12T18:24:34Z", "url": "https://github.com/apache/beam/pull/12551", "merged": true, "mergeCommit": {"oid": "b5846c62c024c0a553b9762c00f0c2ca0dc77179"}, "closed": true, "closedAt": "2020-08-14T17:02:58Z", "author": {"login": "je-ik"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-bYOYgFqTQ2NjUyOTI3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-24NDgBqjM2NTY4Mjg0NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTI5Mjcx", "url": "https://github.com/apache/beam/pull/12551#pullrequestreview-466529271", "createdAt": "2020-08-13T07:59:50Z", "commit": {"oid": "72c260af8fff12208308a4e124a35300ab250889"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo1OTo1MlrOHAAWzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwODowMTo1N1rOHAAbQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2Nzg4NA==", "bodyText": "This is very expensive in terms of memory.", "url": "https://github.com/apache/beam/pull/12551#discussion_r469767884", "createdAt": "2020-08-13T07:59:52Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -1226,7 +1230,7 @@ public TimerInternals timerInternals() {\n      * fire time of the timer. Used for calculating the output watermark hold. This avoids fetching\n      * timer data from the state backend which is expensive if done for each timer.\n      */\n-    private final PriorityQueue<Long> outputTimestampQueue;\n+    private final SortedMap<Long, Set<String>> outputTimestamps = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c260af8fff12208308a4e124a35300ab250889"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2OTAyNQ==", "bodyText": "IMHO there is no need to store the timer id here.", "url": "https://github.com/apache/beam/pull/12551#discussion_r469769025", "createdAt": "2020-08-13T08:01:57Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -1277,7 +1280,13 @@ private void onNewEventTimer(TimerData newTimer) {\n           \"Timer with id %s is not an event time timer!\",\n           newTimer.getTimerId());\n       if (timerUsesOutputTimestamp(newTimer)) {\n-        outputTimestampQueue.add(newTimer.getOutputTimestamp().getMillis());\n+        outputTimestamps.compute(\n+            newTimer.getOutputTimestamp().getMillis(),\n+            (k, v) -> {\n+              Set<String> timerIds = v == null ? new HashSet<>() : v;\n+              timerIds.add(getContextTimerId(newTimer.getTimerId(), newTimer.getNamespace()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c260af8fff12208308a4e124a35300ab250889"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72c260af8fff12208308a4e124a35300ab250889", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/72c260af8fff12208308a4e124a35300ab250889", "committedDate": "2020-08-12T18:23:03Z", "message": "{BEAM-10691] keep track of timers creating watermark hold"}, "afterCommit": {"oid": "8ea092afefe8e3602d73c591e92a7ff5250684f5", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/8ea092afefe8e3602d73c591e92a7ff5250684f5", "committedDate": "2020-08-13T11:35:23Z", "message": "[BEAM-10691] add failing precondition check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ea092afefe8e3602d73c591e92a7ff5250684f5", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/8ea092afefe8e3602d73c591e92a7ff5250684f5", "committedDate": "2020-08-13T11:35:23Z", "message": "[BEAM-10691] add failing precondition check"}, "afterCommit": {"oid": "fe75b7e01d55a0c24486b032330d26d66b57f9c2", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/fe75b7e01d55a0c24486b032330d26d66b57f9c2", "committedDate": "2020-08-14T12:50:51Z", "message": "[BEAM-10691] change PriorityQueue to TreeMultiset for keeping track of timer output timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe75b7e01d55a0c24486b032330d26d66b57f9c2", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/fe75b7e01d55a0c24486b032330d26d66b57f9c2", "committedDate": "2020-08-14T12:50:51Z", "message": "[BEAM-10691] change PriorityQueue to TreeMultiset for keeping track of timer output timestamps"}, "afterCommit": {"oid": "d00291a6949b2b5afdbc0e08e58f12f507c1f656", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/d00291a6949b2b5afdbc0e08e58f12f507c1f656", "committedDate": "2020-08-14T13:11:03Z", "message": "[BEAM-10691] change PriorityQueue to TreeMultiset for keeping track of timer output timestamps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTc0NTIx", "url": "https://github.com/apache/beam/pull/12551#pullrequestreview-467574521", "createdAt": "2020-08-14T13:29:24Z", "commit": {"oid": "d00291a6949b2b5afdbc0e08e58f12f507c1f656"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoyOToyNFrOHA0mAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMzoyOToyNFrOHA0mAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYyMzc0NA==", "bodyText": "We could also consider making this even more efficient by using a TreeMap<Long, Integer> where the key is the output timestamp and the value the number of timers which have set it, similar to how it's done in FlinkStateInternals for the watermark holds.\nFurther, we could remove outputTimestamps entirely and simply use stateInternals.addWatermarkHoldUsage(output_timestamp) and stateInternals.removeWatermarkHoldUsage(output_timestamp).", "url": "https://github.com/apache/beam/pull/12551#discussion_r470623744", "createdAt": "2020-08-14T13:29:24Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -1226,7 +1227,7 @@ public TimerInternals timerInternals() {\n      * fire time of the timer. Used for calculating the output watermark hold. This avoids fetching\n      * timer data from the state backend which is expensive if done for each timer.\n      */\n-    private final PriorityQueue<Long> outputTimestampQueue;\n+    private final TreeMultiset<Long> outputTimestamps = TreeMultiset.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d00291a6949b2b5afdbc0e08e58f12f507c1f656"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f61157e84c72822803fafd88798e3294383862d", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/2f61157e84c72822803fafd88798e3294383862d", "committedDate": "2020-08-14T13:52:43Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}, "afterCommit": {"oid": "ec03667b087b27ba5be21e94a0b5e11ddfbac0c5", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/ec03667b087b27ba5be21e94a0b5e11ddfbac0c5", "committedDate": "2020-08-14T13:57:10Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjEyMDI4", "url": "https://github.com/apache/beam/pull/12551#pullrequestreview-467612028", "createdAt": "2020-08-14T14:18:06Z", "commit": {"oid": "ec03667b087b27ba5be21e94a0b5e11ddfbac0c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec03667b087b27ba5be21e94a0b5e11ddfbac0c5", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/ec03667b087b27ba5be21e94a0b5e11ddfbac0c5", "committedDate": "2020-08-14T13:57:10Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}, "afterCommit": {"oid": "b6d338852b46f9d34cbc202f3df59341f0474f00", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/b6d338852b46f9d34cbc202f3df59341f0474f00", "committedDate": "2020-08-14T14:20:29Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6d338852b46f9d34cbc202f3df59341f0474f00", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/b6d338852b46f9d34cbc202f3df59341f0474f00", "committedDate": "2020-08-14T14:20:29Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}, "afterCommit": {"oid": "cbc3031a7c9293729f8487082ba15ca994c7f70e", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/cbc3031a7c9293729f8487082ba15ca994c7f70e", "committedDate": "2020-08-14T15:53:15Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55874cc74a17dda87de5b2ffdb1253c759de888b", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/55874cc74a17dda87de5b2ffdb1253c759de888b", "committedDate": "2020-08-14T16:05:24Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbc3031a7c9293729f8487082ba15ca994c7f70e", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/cbc3031a7c9293729f8487082ba15ca994c7f70e", "committedDate": "2020-08-14T15:53:15Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}, "afterCommit": {"oid": "55874cc74a17dda87de5b2ffdb1253c759de888b", "author": {"user": {"login": "je-ik", "name": "Jan Lukavsk\u00fd"}}, "url": "https://github.com/apache/beam/commit/55874cc74a17dda87de5b2ffdb1253c759de888b", "committedDate": "2020-08-14T16:05:24Z", "message": "[BEAM-10691] Use FlinkStateInternals#addWatermarkHoldUsage for timer output timestamp"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3476, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}