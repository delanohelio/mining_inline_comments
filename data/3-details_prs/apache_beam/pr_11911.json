{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDE3NDc5", "number": 11911, "title": "[BEAM-10186] Sends an empty response to the runner instead of failing", "bodyText": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle.\nThis is needed to prevent runner from waiting unnecessarily and timing out for progress and split requests that are received by the SDK before receiving the corresponding ProcessBundleRequest.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-03T19:49:07Z", "url": "https://github.com/apache/beam/pull/11911", "merged": true, "mergeCommit": {"oid": "f772aafa43e12a38996dacc752305f551c34c1c4"}, "closed": true, "closedAt": "2020-06-24T22:24:34Z", "author": {"login": "chamikaramj"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqbzijAFqTQyOTQ2NTczMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcugZcSgFqTQzNjk5NzMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDY1NzMw", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-429465730", "createdAt": "2020-06-12T05:14:38Z", "commit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNToxNDozOFrOGi3SKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNToxNDozOFrOGi3SKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA==", "bodyText": "Do we only care about IllegalStateException  here? It seems like other exceptions might also be thrown.", "url": "https://github.com/apache/beam/pull/11911#discussion_r439210538", "createdAt": "2020-06-12T05:14:38Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzIyNTgx", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-433722581", "createdAt": "2020-06-19T00:04:24Z", "commit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMDowNDoyNFrOGmD8KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMDowNDoyNFrOGmD8KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MzYyNA==", "bodyText": "Instead of adding this try catch, we should update the handler to not throw the exception in the first place.\nHere: \n  \n    \n      beam/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java\n    \n    \n         Line 378\n      in\n      bca893e\n    \n    \n    \n    \n\n        \n          \n           public BeamFnApi.InstructionResponse.Builder trySplit(BeamFnApi.InstructionRequest request) { \n        \n    \n  \n\n\nHere: \n  \n    \n      beam/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java\n    \n    \n         Line 344\n      in\n      bca893e\n    \n    \n    \n    \n\n        \n          \n           if (bundleProcessor == null) { \n        \n    \n  \n\n\nWe should add a simple unit test that covers this as well.", "url": "https://github.com/apache/beam/pull/11911#discussion_r442563624", "createdAt": "2020-06-19T00:04:24Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1", "committedDate": "2020-06-03T19:44:29Z", "message": "Send an error to the runner for certain split and progress request failures"}, "afterCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/c14f537e1997a3978dae8ffd80589f5e80a56c3b", "committedDate": "2020-06-20T01:54:10Z", "message": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjAxNTA3", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-436201507", "createdAt": "2020-06-23T22:24:00Z", "commit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNDowMVrOGn8rew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNDowNFrOGn8rlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTgxOQ==", "bodyText": "validate the contents of the response", "url": "https://github.com/apache/beam/pull/11911#discussion_r444541819", "createdAt": "2020-06-23T22:24:01Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTg0NQ==", "bodyText": "validate the contents of the response", "url": "https://github.com/apache/beam/pull/11911#discussion_r444541845", "createdAt": "2020-06-23T22:24:04Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(\n+        BeamFnApi.InstructionRequest.newBuilder()\n+            .setInstructionId(\"999L\")\n+            .setProcessBundleSplit(\n+                BeamFnApi.ProcessBundleSplitRequest.newBuilder().setInstructionId(\"unknown-id\"))\n+            .build());\n+  }\n+\n+  @Test\n+  public void testProgressBeforeBundleDoesNotFail() throws Exception {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.progress(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjAyODIw", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-436202820", "createdAt": "2020-06-23T22:27:00Z", "commit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNzowMFrOGn8vhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNzowMFrOGn8vhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0Mjg1Mw==", "bodyText": "nit, you could remove the level of nesting by using a guard statement (here and below):\nif (bundleProcessor == null) {\n  return BeamFnApi.InstructionResponse.newBuilder().setProcessBundleProgress(BeamFnApi.ProcessBundleProgressResponse.getDefaultInstance());\n}", "url": "https://github.com/apache/beam/pull/11911#discussion_r444542853", "createdAt": "2020-06-23T22:27:00Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -341,53 +341,52 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       throws Exception {\n     BundleProcessor bundleProcessor =\n         bundleProcessorCache.find(request.getProcessBundleProgress().getInstructionId());\n-    if (bundleProcessor == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b288f26a0d46b573ad4cf2bc01c617c9b0725f25", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/b288f26a0d46b573ad4cf2bc01c617c9b0725f25", "committedDate": "2020-06-24T20:33:03Z", "message": "Address reviewer comments"}, "afterCommit": {"oid": "8608f113c0858f332bed87efb0efddc7405fb28f", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/8608f113c0858f332bed87efb0efddc7405fb28f", "committedDate": "2020-06-24T20:36:51Z", "message": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05a43bda07a5106e246c98a51768e60e6db1c7a", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/d05a43bda07a5106e246c98a51768e60e6db1c7a", "committedDate": "2020-06-24T20:38:27Z", "message": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8608f113c0858f332bed87efb0efddc7405fb28f", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/8608f113c0858f332bed87efb0efddc7405fb28f", "committedDate": "2020-06-24T20:36:51Z", "message": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle."}, "afterCommit": {"oid": "d05a43bda07a5106e246c98a51768e60e6db1c7a", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/d05a43bda07a5106e246c98a51768e60e6db1c7a", "committedDate": "2020-06-24T20:38:27Z", "message": "Sends an empty response to the runner instead of failing for split/progress requests received before the bundle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTg1ODQ3", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-436985847", "createdAt": "2020-06-24T20:33:47Z", "commit": {"oid": "b288f26a0d46b573ad4cf2bc01c617c9b0725f25"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozMzo0N1rOGoiHvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozNjowN1rOGoiMig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NTI2MA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445155260", "createdAt": "2020-06-24T20:33:47Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -341,53 +341,52 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       throws Exception {\n     BundleProcessor bundleProcessor =\n         bundleProcessorCache.find(request.getProcessBundleProgress().getInstructionId());\n-    if (bundleProcessor == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0Mjg1Mw=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NjE4MQ==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445156181", "createdAt": "2020-06-24T20:35:34Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(\n+        BeamFnApi.InstructionRequest.newBuilder()\n+            .setInstructionId(\"999L\")\n+            .setProcessBundleSplit(\n+                BeamFnApi.ProcessBundleSplitRequest.newBuilder().setInstructionId(\"unknown-id\"))\n+            .build());\n+  }\n+\n+  @Test\n+  public void testProgressBeforeBundleDoesNotFail() throws Exception {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.progress(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTg0NQ=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NjQ5MA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445156490", "createdAt": "2020-06-24T20:36:07Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTgxOQ=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTk3MzE3", "url": "https://github.com/apache/beam/pull/11911#pullrequestreview-436997317", "createdAt": "2020-06-24T20:51:21Z", "commit": {"oid": "d05a43bda07a5106e246c98a51768e60e6db1c7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3967, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}