{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMzg1NTE5", "number": 10576, "title": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using beam_fn_api experiment.", "bodyText": "Note that this does not yet cover everything needed for progress reporting or dynamic work rebalancing.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-14T00:19:28Z", "url": "https://github.com/apache/beam/pull/10576", "merged": true, "mergeCommit": {"oid": "c1d054faf043677d8700de9ed6eada03cccf55e8"}, "closed": true, "closedAt": "2020-02-13T21:02:25Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6GYAHgBqjI5NDUzMjUwMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD-i7NgH2gAyMzYyMzg1NTE5Ojc3OWI2ZGQxYjk3OGFjNzk2NzE0NmExNzdhOTYzYzc1M2IwMWEwM2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cbbd4bdf62d2336d764c927eafb35a688b0b218", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/2cbbd4bdf62d2336d764c927eafb35a688b0b218", "committedDate": "2020-01-14T01:05:41Z", "message": "fixup! Address output coder."}, "afterCommit": {"oid": "3fb6c3fd824f1bfd269eaf82104402203fa6f7db", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/3fb6c3fd824f1bfd269eaf82104402203fa6f7db", "committedDate": "2020-01-14T01:07:59Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fb6c3fd824f1bfd269eaf82104402203fa6f7db", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/3fb6c3fd824f1bfd269eaf82104402203fa6f7db", "committedDate": "2020-01-14T01:07:59Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines."}, "afterCommit": {"oid": "10a38048d070cb708ed5f8cdd088b895c846e199", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/10a38048d070cb708ed5f8cdd088b895c846e199", "committedDate": "2020-01-14T20:49:32Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTc4NDAy", "url": "https://github.com/apache/beam/pull/10576#pullrequestreview-342978402", "createdAt": "2020-01-15T04:01:52Z", "commit": {"oid": "10a38048d070cb708ed5f8cdd088b895c846e199"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzU4NDQ3", "url": "https://github.com/apache/beam/pull/10576#pullrequestreview-343758447", "createdAt": "2020-01-16T09:02:19Z", "commit": {"oid": "10a38048d070cb708ed5f8cdd088b895c846e199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTowMjoyMFrOFeSOBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTowMjoyMFrOFeSOBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMwMDEwMw==", "bodyText": "Does that mean we can remove \n  \n    \n      beam/runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java\n    \n    \n         Line 154\n      in\n      e1852ca\n    \n    \n    \n    \n\n        \n          \n           pipeline.replaceAll(ImmutableList.of(JavaReadViaImpulse.boundedOverride())); \n        \n    \n  \n\n ?", "url": "https://github.com/apache/beam/pull/10576#discussion_r367300103", "createdAt": "2020-01-16T09:02:20Z", "author": {"login": "mxm"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/Read.java", "diffHunk": "@@ -94,6 +106,20 @@ private Bounded(@Nullable String name, BoundedSource<T> source) {\n     public final PCollection<T> expand(PBegin input) {\n       source.validate();\n \n+      if (ExperimentalOptions.hasExperiment(input.getPipeline().getOptions(), \"beam_fn_api\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10a38048d070cb708ed5f8cdd088b895c846e199"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10a38048d070cb708ed5f8cdd088b895c846e199", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/10a38048d070cb708ed5f8cdd088b895c846e199", "committedDate": "2020-01-14T20:49:32Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines."}, "afterCommit": {"oid": "b447fb27bbdfac7095907d9ed73f9f91ef867ea9", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/b447fb27bbdfac7095907d9ed73f9f91ef867ea9", "committedDate": "2020-02-10T23:10:52Z", "message": "fixup! Fix TextIOReadTest and ensure that reading BoundedSource is done."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de85805abf53907d600a44d0988e77264aace07d", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/de85805abf53907d600a44d0988e77264aace07d", "committedDate": "2020-02-10T23:13:27Z", "message": "fixup! Fix test name."}, "afterCommit": {"oid": "bad710bf28f76c0ee809dcfedb2f8d2f81b22e65", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/bad710bf28f76c0ee809dcfedb2f8d2f81b22e65", "committedDate": "2020-02-10T23:38:30Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines.\n\nRemote JavaReadViaImpulse and make \"beam_fn_api\" use SplittableDoFn by default."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2732d9c89c42259472aebdee1b99498caf02a498", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/2732d9c89c42259472aebdee1b99498caf02a498", "committedDate": "2020-02-11T00:48:57Z", "message": "fixup! Ensure that the expansion service always runs using the \"beam_fn_api\" experiment."}, "afterCommit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/970e914fa1ca509e8104c9922d389915d0d488be", "committedDate": "2020-02-11T00:49:48Z", "message": "fixup! Ensure that the expansion service always runs using the \"beam_fn_api\" experiment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTI4ODYy", "url": "https://github.com/apache/beam/pull/10576#pullrequestreview-356928862", "createdAt": "2020-02-11T19:23:32Z", "commit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxOToyMzozM1rOFoV-yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxOToyMzozM1rOFoV-yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg0NzQ5OQ==", "bodyText": "Just to make sure I'm understanding correctly: This transform was only used for portable pipelines, right? So it isn't needed anymore now that we execute bounded reads by wrapping them in an SDF?", "url": "https://github.com/apache/beam/pull/10576#discussion_r377847499", "createdAt": "2020-02-11T19:23:33Z", "author": {"login": "youngoli"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/JavaReadViaImpulse.java", "diffHunk": "@@ -1,176 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTgzNjc1", "url": "https://github.com/apache/beam/pull/10576#pullrequestreview-356983675", "createdAt": "2020-02-11T20:49:45Z", "commit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMDo0OTo0NVrOFoYkzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMDo0OTo0NVrOFoYkzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4OTk5OQ==", "bodyText": "\ud83d\udc4f", "url": "https://github.com/apache/beam/pull/10576#discussion_r377889999", "createdAt": "2020-02-11T20:49:45Z", "author": {"login": "iemejia"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/Read.java", "diffHunk": "@@ -177,4 +205,128 @@ public void populateDisplayData(DisplayData.Builder builder) {\n           .include(\"source\", source);\n     }\n   }\n+\n+  /**\n+   * A splittable {@link DoFn} which executes a {@link BoundedSource}.\n+   *\n+   * <p>We model the element as the original source and the restriction as the sub-source. This\n+   * allows us to split the sub-source over and over yet still receive \"source\" objects as inputs.\n+   */\n+  static class BoundedSourceAsSDFWrapperFn<T> extends DoFn<BoundedSource<T>, T> {\n+    private static final long DEFAULT_DESIRED_BUNDLE_SIZE_BYTES = 64 * (1 << 20);\n+\n+    @GetInitialRestriction\n+    public BoundedSource<T> initialRestriction(@Element BoundedSource<T> element) {\n+      return element;\n+    }\n+\n+    @GetSize\n+    public double getSize(\n+        @Restriction BoundedSource<T> restriction, PipelineOptions pipelineOptions)\n+        throws Exception {\n+      return restriction.getEstimatedSizeBytes(pipelineOptions);\n+    }\n+\n+    @SplitRestriction\n+    public void splitRestriction(\n+        @Restriction BoundedSource<T> restriction,\n+        OutputReceiver<BoundedSource<T>> receiver,\n+        PipelineOptions pipelineOptions)\n+        throws Exception {\n+      for (BoundedSource<T> split :\n+          restriction.split(DEFAULT_DESIRED_BUNDLE_SIZE_BYTES, pipelineOptions)) {\n+        receiver.output(split);\n+      }\n+    }\n+\n+    @NewTracker\n+    public RestrictionTracker<BoundedSource<T>, Object[]> restrictionTracker(\n+        @Restriction BoundedSource<T> restriction, PipelineOptions pipelineOptions) {\n+      return new BoundedSourceAsSDFRestrictionTracker<>(restriction, pipelineOptions);\n+    }\n+\n+    @ProcessElement\n+    public void processElement(\n+        RestrictionTracker<BoundedSource<T>, Object[]> tracker, OutputReceiver<T> receiver)\n+        throws IOException {\n+      Object[] out = new Object[1];\n+      while (tracker.tryClaim(out)) {\n+        receiver.output((T) out[0]);\n+      }\n+    }\n+\n+    @GetRestrictionCoder\n+    public Coder<BoundedSource<T>> restrictionCoder() {\n+      return SerializableCoder.of(new TypeDescriptor<BoundedSource<T>>() {});\n+    }\n+\n+    /**\n+     * A fake restriction tracker which adapts to the {@link BoundedSource} API. The restriction\n+     * object is used to advance the underlying source and to \"return\" the current element.\n+     */\n+    private static class BoundedSourceAsSDFRestrictionTracker<T>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "028c0c98e749fb761ec30357eb4aac5158975d15", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/028c0c98e749fb761ec30357eb4aac5158975d15", "committedDate": "2020-02-12T17:15:54Z", "message": "[BEAM-5605] Convert all BoundedSources to SplittableDoFns when using portable pipelines.\n\nRemote JavaReadViaImpulse and make \"beam_fn_api\" use SplittableDoFn by default."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2539269f3cbd859ba745bff5b0ce117e6feda279", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/2539269f3cbd859ba745bff5b0ce117e6feda279", "committedDate": "2020-02-12T17:15:54Z", "message": "fixup! Ensure that the expansion service always runs using the \"beam_fn_api\" experiment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08972ff93d0e7eb1d2f3e46b02ae1049b56ac8b2", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/08972ff93d0e7eb1d2f3e46b02ae1049b56ac8b2", "committedDate": "2020-02-12T17:15:54Z", "message": "fixup! Fix Dataflow translation tests now that BoundedSources are treated as SplittableDoFns"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "970e914fa1ca509e8104c9922d389915d0d488be", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/970e914fa1ca509e8104c9922d389915d0d488be", "committedDate": "2020-02-11T00:49:48Z", "message": "fixup! Ensure that the expansion service always runs using the \"beam_fn_api\" experiment."}, "afterCommit": {"oid": "08972ff93d0e7eb1d2f3e46b02ae1049b56ac8b2", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/08972ff93d0e7eb1d2f3e46b02ae1049b56ac8b2", "committedDate": "2020-02-12T17:15:54Z", "message": "fixup! Fix Dataflow translation tests now that BoundedSources are treated as SplittableDoFns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "779b6dd1b978ac7967146a177a963c753b01a03c", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/779b6dd1b978ac7967146a177a963c753b01a03c", "committedDate": "2020-02-13T17:40:07Z", "message": "fixup! Skip testing portable SDF version on Dataflow till it us supported."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3779, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}