{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MDc0NDY0", "number": 10701, "title": "[BEAM-9188] CassandraIO split performance improvement - cache size of the table", "bodyText": "Splitting CassandraIO source into multiple sources works fast as it uses one connection pool to Cassandra cluster but after that dataflow.worker.WorkerCustomSources is calling CassandraSource.getEstimatedSizeBytes for each source which setups and tears down connection to Cassandra cluster to calculate same size of table. This optimization introduces caching of size internally just to avoid additional queries.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-28T15:24:37Z", "url": "https://github.com/apache/beam/pull/10701", "merged": true, "mergeCommit": {"oid": "94ca187f293735bc96e1ccb75cd2d009ba66521d"}, "closed": true, "closedAt": "2020-01-31T22:36:58Z", "author": {"login": "stankiewicz"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-y8xcAH2gAyMzY4MDc0NDY0OmYxOWI4Y2IzNDU1MTQ2YThjMWI0NDgyOWNhYjhkMGEwYzVkYjNiZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_rSFrAH2gAyMzY4MDc0NDY0OjQ3ODUwMzE5Zjc5OGE2NTMzZjk0MDI0MjBhOGFlMjQ0MjQyMTgxNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f19b8cb3455146a8c1b44829cab8d0a0c5db3bd7", "author": {"user": {"login": "stankiewicz", "name": "Rados\u0142aw Stankiewicz"}}, "url": "https://github.com/apache/beam/commit/f19b8cb3455146a8c1b44829cab8d0a0c5db3bd7", "committedDate": "2020-01-28T15:19:52Z", "message": "[BEAM-9188] CassandraIO split performance improvement - cache size of table\n\nSplitting CassandraIO source into multiple sources works fast as it uses one connection pool to Cassandra cluster but after that dataflow.worker.WorkerCustomSources is calling CassandraSource.getEstimatedSizeBytes for each source which setups and tears down connection to Cassandra cluster to calculate same size of table."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49", "author": {"user": {"login": "stankiewicz", "name": "Rados\u0142aw Stankiewicz"}}, "url": "https://github.com/apache/beam/commit/eaf347cd6e2ff0e1f0e870fb95f6323405f12e49", "committedDate": "2020-01-28T20:54:13Z", "message": "spotless fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzQ3MTYx", "url": "https://github.com/apache/beam/pull/10701#pullrequestreview-349747161", "createdAt": "2020-01-28T22:22:25Z", "commit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjoyMjoyNVrOFi2tAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjoyNjowMlrOFi2ymA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA5MjE2Mg==", "bodyText": "Can we also cache the size here in case getEstimateSizeBytes is called more than once?", "url": "https://github.com/apache/beam/pull/10701#discussion_r372092162", "createdAt": "2020-01-28T22:22:25Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -508,26 +518,30 @@ private static long getNumSplits(\n \n     @Override\n     public long getEstimatedSizeBytes(PipelineOptions pipelineOptions) {\n-      try (Cluster cluster =\n-          getCluster(\n-              spec.hosts(),\n-              spec.port(),\n-              spec.username(),\n-              spec.password(),\n-              spec.localDc(),\n-              spec.consistencyLevel())) {\n-        if (isMurmur3Partitioner(cluster)) {\n-          try {\n-            List<TokenRange> tokenRanges =\n-                getTokenRanges(cluster, spec.keyspace().get(), spec.table().get());\n-            return getEstimatedSizeBytesFromTokenRanges(tokenRanges);\n-          } catch (Exception e) {\n-            LOG.warn(\"Can't estimate the size\", e);\n+      if (estimatedSize != null) {\n+        return estimatedSize;\n+      } else {\n+        try (Cluster cluster =\n+            getCluster(\n+                spec.hosts(),\n+                spec.port(),\n+                spec.username(),\n+                spec.password(),\n+                spec.localDc(),\n+                spec.consistencyLevel())) {\n+          if (isMurmur3Partitioner(cluster)) {\n+            try {\n+              List<TokenRange> tokenRanges =\n+                  getTokenRanges(cluster, spec.keyspace().get(), spec.table().get());\n+              return getEstimatedSizeBytesFromTokenRanges(tokenRanges);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA5MzU5Mg==", "bodyText": "Could you please add some comments about this field? Like, why and when the size is cached.", "url": "https://github.com/apache/beam/pull/10701#discussion_r372093592", "createdAt": "2020-01-28T22:26:02Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -375,9 +375,15 @@ private CassandraIO() {}\n   static class CassandraSource<T> extends BoundedSource<T> {\n     final Read<T> spec;\n     final List<String> splitQueries;\n+    final Long estimatedSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzY1MDEx", "url": "https://github.com/apache/beam/pull/10701#pullrequestreview-349765011", "createdAt": "2020-01-28T22:59:23Z", "commit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjo1OToyNFrOFi3k7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjo1OToyNFrOFi3k7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwNjQ3OQ==", "bodyText": "Just want to make sure that I understand how Cassandra does initial split. Lets say that we are going to split A into A_1 and A_2, so we expect that : size of (A) == size of (A_1) == size of(A_2) because they share the same spec. Is that correct?", "url": "https://github.com/apache/beam/pull/10701#discussion_r372106479", "createdAt": "2020-01-28T22:59:24Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -450,6 +456,10 @@ private static String buildQuery(Read spec) {\n               .map(ColumnMetadata::getName)\n               .collect(Collectors.joining(\",\"));\n \n+      List<TokenRange> tokenRanges =\n+          getTokenRanges(cluster, spec.keyspace().get(), spec.table().get());\n+      final long estimatedSize = getEstimatedSizeBytesFromTokenRanges(tokenRanges);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf347cd6e2ff0e1f0e870fb95f6323405f12e49"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fe2cec8cb6592bfd4a46517a080638776a8ccef", "author": {"user": {"login": "stankiewicz", "name": "Rados\u0142aw Stankiewicz"}}, "url": "https://github.com/apache/beam/commit/9fe2cec8cb6592bfd4a46517a080638776a8ccef", "committedDate": "2020-01-29T10:50:13Z", "message": "comments and tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDIwNTkw", "url": "https://github.com/apache/beam/pull/10701#pullrequestreview-350020590", "createdAt": "2020-01-29T10:58:53Z", "commit": {"oid": "9fe2cec8cb6592bfd4a46517a080638776a8ccef"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47850319f798a6533f9402420a8ae24424218160", "author": {"user": {"login": "stankiewicz", "name": "Rados\u0142aw Stankiewicz"}}, "url": "https://github.com/apache/beam/commit/47850319f798a6533f9402420a8ae24424218160", "committedDate": "2020-01-31T08:57:50Z", "message": "spottless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3617, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}