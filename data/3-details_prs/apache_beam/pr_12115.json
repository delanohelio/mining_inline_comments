{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMDIwMzgy", "number": 12115, "title": "[BEAM-7672] dynamically setup acceptable wheel specs according to installed python version", "bodyText": "Construct the accepted wheel based on the installed Python version.\nThis PR is the follow-up of #11970\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-28T08:07:56Z", "url": "https://github.com/apache/beam/pull/12115", "merged": true, "mergeCommit": {"oid": "064207392427d3c6215b12d23b03e7958581c6a0"}, "closed": true, "closedAt": "2020-07-17T22:29:35Z", "author": {"login": "lazylynx"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvnuUogH2gAyNDQxMDIwMzgyOjE3NzQ0NWYwMTY5Njk0OTYyMjMyNDM0NzE4ZThmZmNmNTI0MDkxMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc17lOyAFqTQ1MDk4NzE2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "177445f0169694962232434718e8ffcf52409100", "author": {"user": {"login": "lazylynx", "name": "yoshiki.obata"}}, "url": "https://github.com/apache/beam/commit/177445f0169694962232434718e8ffcf52409100", "committedDate": "2020-06-28T07:57:25Z", "message": "[BEAM-7672] dynamically setup acceptable wheel specs according to installed python version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjI4NzI1", "url": "https://github.com/apache/beam/pull/12115#pullrequestreview-441228725", "createdAt": "2020-07-01T22:11:12Z", "commit": {"oid": "177445f0169694962232434718e8ffcf52409100"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoxMToxMlrOGr29qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoxMToxNVrOGr29uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MjQ3NQ==", "bodyText": "How about we say \"Cannot get parse Python version from ...\" and append the output?", "url": "https://github.com/apache/beam/pull/12115#discussion_r448642475", "createdAt": "2020-07-01T22:11:12Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/container/boot.go", "diffHunk": "@@ -170,6 +176,28 @@ func main() {\n \tlog.Fatalf(\"Python exited: %v\", execx.Execute(\"python\", args...))\n }\n \n+// setup wheel specs according to installed python version\n+func setupAcceptableWheelSpecs() error {\n+\tcmd := exec.Command(\"python\", \"-V\")\n+\tstdoutStderr, err := cmd.CombinedOutput()\n+\tif err != nil {\n+\t\treturn err\n+\t}\n+\tre := regexp.MustCompile(`Python (\\d)\\.(\\d).*`)\n+\tpyVersions := re.FindStringSubmatch(string(stdoutStderr[:]))\n+\tif len(pyVersions) != 3 {\n+\t\treturn fmt.Errorf(\"cannot get python version with expected format\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177445f0169694962232434718e8ffcf52409100"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MjQ4OA==", "bodyText": "I think we should not fail but leave acceptableWhlSpecs as empty in this case.", "url": "https://github.com/apache/beam/pull/12115#discussion_r448642488", "createdAt": "2020-07-01T22:11:15Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/container/boot.go", "diffHunk": "@@ -127,6 +129,10 @@ func main() {\n \t// Guard from concurrent artifact retrieval and installation,\n \t// when called by child processes in a worker pool.\n \n+\tif err := setupAcceptableWheelSpecs(); err != nil {\n+\t\tlog.Fatalf(\"Failed to setup acceptable wheel specs: %v\", err)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177445f0169694962232434718e8ffcf52409100"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03296b30f337f3c6278d1cef45f3188dce77183e", "author": {"user": {"login": "lazylynx", "name": "yoshiki.obata"}}, "url": "https://github.com/apache/beam/commit/03296b30f337f3c6278d1cef45f3188dce77183e", "committedDate": "2020-07-02T15:59:43Z", "message": "fixup: update error message when parse failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a265776d190db6990603bd9ddc4f2376f67b3f", "author": {"user": {"login": "lazylynx", "name": "yoshiki.obata"}}, "url": "https://github.com/apache/beam/commit/31a265776d190db6990603bd9ddc4f2376f67b3f", "committedDate": "2020-07-02T16:00:25Z", "message": "fixup: not to abort when wheel spec setup failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzE3ODMy", "url": "https://github.com/apache/beam/pull/12115#pullrequestreview-445317832", "createdAt": "2020-07-09T06:19:45Z", "commit": {"oid": "31a265776d190db6990603bd9ddc4f2376f67b3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoxOTo0NVrOGvDK0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoxOTo0NVrOGvDK0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4ODE3Ng==", "bodyText": "Sorry for a slow response. It seems that 3.8 wheels don't follow this pattern, just noticing this while prepring 2.23.0 release. 3.8 wheels look as follows:\napache_beam-2.23.0-cp38-cp38-manylinux1_x86_64.whl\nNot sure why the pattern has changed.", "url": "https://github.com/apache/beam/pull/12115#discussion_r451988176", "createdAt": "2020-07-09T06:19:45Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/container/boot.go", "diffHunk": "@@ -170,6 +176,28 @@ func main() {\n \tlog.Fatalf(\"Python exited: %v\", execx.Execute(\"python\", args...))\n }\n \n+// setup wheel specs according to installed python version\n+func setupAcceptableWheelSpecs() error {\n+\tcmd := exec.Command(\"python\", \"-V\")\n+\tstdoutStderr, err := cmd.CombinedOutput()\n+\tif err != nil {\n+\t\treturn err\n+\t}\n+\tre := regexp.MustCompile(`Python (\\d)\\.(\\d).*`)\n+\tpyVersions := re.FindStringSubmatch(string(stdoutStderr[:]))\n+\tif len(pyVersions) != 3 {\n+\t\treturn fmt.Errorf(\"cannot get parse Python version from %s\", stdoutStderr)\n+\t}\n+\tpyVersion := fmt.Sprintf(\"%s%s\", pyVersions[1], pyVersions[2])\n+\tif pyVersion == \"27\" {\n+\t\tacceptableWhlSpecs = append(acceptableWhlSpecs, \"cp27-cp27mu-manylinux1_x86_64.whl\")\n+\t} else {\n+\t\twheelName := fmt.Sprintf(\"cp%s-cp%sm-manylinux1_x86_64.whl\", pyVersion, pyVersion)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31a265776d190db6990603bd9ddc4f2376f67b3f"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86456be0beae4ea7dcc889cf374f8623ad9ce506", "author": {"user": {"login": "lazylynx", "name": "yoshiki.obata"}}, "url": "https://github.com/apache/beam/commit/86456be0beae4ea7dcc889cf374f8623ad9ce506", "committedDate": "2020-07-09T16:10:32Z", "message": "fixup: not to use m flag at wheel name with python 3.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTE1NzQy", "url": "https://github.com/apache/beam/pull/12115#pullrequestreview-445915742", "createdAt": "2020-07-09T19:42:30Z", "commit": {"oid": "86456be0beae4ea7dcc889cf374f8623ad9ce506"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxOTo0MjozMFrOGvfRWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxOTo0MjozMFrOGvfRWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ0ODYwMg==", "bodyText": "Can we move this into the switch as well?  Thank you!", "url": "https://github.com/apache/beam/pull/12115#discussion_r452448602", "createdAt": "2020-07-09T19:42:30Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/container/boot.go", "diffHunk": "@@ -170,6 +176,34 @@ func main() {\n \tlog.Fatalf(\"Python exited: %v\", execx.Execute(\"python\", args...))\n }\n \n+// setup wheel specs according to installed python version\n+func setupAcceptableWheelSpecs() error {\n+\tcmd := exec.Command(\"python\", \"-V\")\n+\tstdoutStderr, err := cmd.CombinedOutput()\n+\tif err != nil {\n+\t\treturn err\n+\t}\n+\tre := regexp.MustCompile(`Python (\\d)\\.(\\d).*`)\n+\tpyVersions := re.FindStringSubmatch(string(stdoutStderr[:]))\n+\tif len(pyVersions) != 3 {\n+\t\treturn fmt.Errorf(\"cannot get parse Python version from %s\", stdoutStderr)\n+\t}\n+\tpyVersion := fmt.Sprintf(\"%s%s\", pyVersions[1], pyVersions[2])\n+\tif pyVersion == \"27\" {\n+\t\tacceptableWhlSpecs = append(acceptableWhlSpecs, \"cp27-cp27mu-manylinux1_x86_64.whl\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86456be0beae4ea7dcc889cf374f8623ad9ce506"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a03ebd61c6ede8b886dcd3be0d4c5da21874d151", "author": {"user": {"login": "lazylynx", "name": "yoshiki.obata"}}, "url": "https://github.com/apache/beam/commit/a03ebd61c6ede8b886dcd3be0d4c5da21874d151", "committedDate": "2020-07-10T13:33:51Z", "message": "fixup: simplified wheel name setting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODYwMzMw", "url": "https://github.com/apache/beam/pull/12115#pullrequestreview-450860330", "createdAt": "2020-07-17T18:08:02Z", "commit": {"oid": "a03ebd61c6ede8b886dcd3be0d4c5da21874d151"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwOTg3MTY1", "url": "https://github.com/apache/beam/pull/12115#pullrequestreview-450987165", "createdAt": "2020-07-17T22:29:08Z", "commit": {"oid": "a03ebd61c6ede8b886dcd3be0d4c5da21874d151"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3197, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}