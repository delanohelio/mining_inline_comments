{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDY4MTQz", "number": 12635, "title": "[BEAM-9919] Isolating xlang transforms by namespace", "bodyText": "All components of the xlang transform that aren't uniquely identified by topological ordering are now isolated into their respective namespaces.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n \n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-19T21:29:13Z", "url": "https://github.com/apache/beam/pull/12635", "merged": true, "mergeCommit": {"oid": "5f6cf0b431acb02adafcaa9dfd3bdabd073c8fe5"}, "closed": true, "closedAt": "2020-08-19T23:37:54Z", "author": {"login": "pskevin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAjwc1AH2gAyNDcwNDY4MTQzOjk2MjBkNjI1MGM1ZDdmOWUyMDU5OWFmOWExYmZmNGRhN2RjMTQyZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAkVVLgFqTQ3MTAzMzgyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9620d6250c5d7f9e20599af9a1bff4da7dc142ee", "author": {"user": {"login": "pskevin", "name": "Kevin Sijo Puthusseri"}}, "url": "https://github.com/apache/beam/commit/9620d6250c5d7f9e20599af9a1bff4da7dc142ee", "committedDate": "2020-08-19T22:56:50Z", "message": "[BEAM-9919] xlang transforms wrapped with namespaces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "451d63df37b32725ebf5907ab358abbe6ac0fd4a", "author": {"user": {"login": "pskevin", "name": "Kevin Sijo Puthusseri"}}, "url": "https://github.com/apache/beam/commit/451d63df37b32725ebf5907ab358abbe6ac0fd4a", "committedDate": "2020-08-19T22:57:50Z", "message": "Merge branch 'BEAM-9919-isolating-xlang-by-namespace' of https://github.com/pskevin/beam into BEAM-9919-isolating-xlang-by-namespace"}, "afterCommit": {"oid": "9620d6250c5d7f9e20599af9a1bff4da7dc142ee", "author": {"user": {"login": "pskevin", "name": "Kevin Sijo Puthusseri"}}, "url": "https://github.com/apache/beam/commit/9620d6250c5d7f9e20599af9a1bff4da7dc142ee", "committedDate": "2020-08-19T22:56:50Z", "message": "[BEAM-9919] xlang transforms wrapped with namespaces"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDIxNDc2", "url": "https://github.com/apache/beam/pull/12635#pullrequestreview-471021476", "createdAt": "2020-08-19T23:02:32Z", "commit": {"oid": "f7d3945a25c93893ccf8bf5f4dab40eda3e395a2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMzowMjozMlrOHDe19g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMzoxMjozNlrOHDfR7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQxMzExMA==", "bodyText": "Slices are always passed by reference, so this is overwriting the coder lists in the extracted coder. You would need to create a n new slice, and append values to that and  then overwrite the existing one in coder.\nupdatedComponentCoderIDs := append(nil, coder.ComponentCoderIds...)\nThat should create a new slice with the same elements.", "url": "https://github.com/apache/beam/pull/12635#discussion_r473413110", "createdAt": "2020-08-19T23:02:32Z", "author": {"login": "lostluck"}, "path": "sdks/go/pkg/beam/core/runtime/xlangx/namespace.go", "diffHunk": "@@ -0,0 +1,136 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for Additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package xlangx\n+\n+import (\n+\t\"fmt\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+)\n+\n+func AddCoderID(c *pipepb.Components, idMap map[string]string, cid string, newID func(string) string) string {\n+\tif _, exists := idMap[cid]; exists {\n+\t\treturn idMap[cid]\n+\t}\n+\n+\tcoder, exists := c.Coders[cid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing coder id: %v not in %v\", cid, c.Coders))\n+\t}\n+\n+\t// Updating ComponentCoderIDs of Coder\n+\tif coder.GetComponentCoderIds() != nil {\n+\t\tupdatedComponentCoderIDs := coder.ComponentCoderIds // Pass by value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7d3945a25c93893ccf8bf5f4dab40eda3e395a2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQxNjU5Mg==", "bodyText": "Should this assignment be outside the loop?\nThis is saying after each element in coder.ComponentCoderIds, reset the ComponentCoderIds to this new updated version.", "url": "https://github.com/apache/beam/pull/12635#discussion_r473416592", "createdAt": "2020-08-19T23:07:19Z", "author": {"login": "lostluck"}, "path": "sdks/go/pkg/beam/core/runtime/xlangx/namespace.go", "diffHunk": "@@ -0,0 +1,136 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for Additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package xlangx\n+\n+import (\n+\t\"fmt\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+)\n+\n+func AddCoderID(c *pipepb.Components, idMap map[string]string, cid string, newID func(string) string) string {\n+\tif _, exists := idMap[cid]; exists {\n+\t\treturn idMap[cid]\n+\t}\n+\n+\tcoder, exists := c.Coders[cid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing coder id: %v not in %v\", cid, c.Coders))\n+\t}\n+\n+\t// Updating ComponentCoderIDs of Coder\n+\tif coder.GetComponentCoderIds() != nil {\n+\t\tupdatedComponentCoderIDs := coder.ComponentCoderIds // Pass by value\n+\t\tfor i, ccid := range coder.ComponentCoderIds {\n+\t\t\tupdatedComponentCoderIDs[i] = AddCoderID(c, idMap, ccid, newID)\n+\t\t\tcoder.ComponentCoderIds = updatedComponentCoderIDs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9620d6250c5d7f9e20599af9a1bff4da7dc142ee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQxODU4OA==", "bodyText": "leftover Debug printout", "url": "https://github.com/apache/beam/pull/12635#discussion_r473418588", "createdAt": "2020-08-19T23:10:07Z", "author": {"login": "lostluck"}, "path": "sdks/go/pkg/beam/core/runtime/xlangx/namespace.go", "diffHunk": "@@ -0,0 +1,136 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for Additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package xlangx\n+\n+import (\n+\t\"fmt\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+)\n+\n+func AddCoderID(c *pipepb.Components, idMap map[string]string, cid string, newID func(string) string) string {\n+\tif _, exists := idMap[cid]; exists {\n+\t\treturn idMap[cid]\n+\t}\n+\n+\tcoder, exists := c.Coders[cid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing coder id: %v not in %v\", cid, c.Coders))\n+\t}\n+\n+\t// Updating ComponentCoderIDs of Coder\n+\tif coder.GetComponentCoderIds() != nil {\n+\t\tupdatedComponentCoderIDs := coder.ComponentCoderIds // Pass by value\n+\t\tfor i, ccid := range coder.ComponentCoderIds {\n+\t\t\tupdatedComponentCoderIDs[i] = AddCoderID(c, idMap, ccid, newID)\n+\t\t\tcoder.ComponentCoderIds = updatedComponentCoderIDs\n+\t\t}\n+\t}\n+\n+\tidMap[cid] = newID(cid)\n+\n+\t// Updating Coders map\n+\tc.Coders[idMap[cid]] = coder\n+\tdelete(c.Coders, cid)\n+\n+\treturn idMap[cid]\n+}\n+\n+func AddWindowingStrategyID(c *pipepb.Components, idMap map[string]string, wid string, newID func(string) string) string {\n+\tif _, exists := idMap[wid]; exists {\n+\t\treturn idMap[wid]\n+\t}\n+\n+\twindowingStrategy, exists := c.WindowingStrategies[wid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing windowing strategy id: %v not in %v\", wid, c.WindowingStrategies))\n+\t}\n+\n+\t// Updating WindowCoderID of WindowingStrategy\n+\tif windowingStrategy.WindowCoderId != \"\" {\n+\t\twindowingStrategy.WindowCoderId = AddCoderID(c, idMap, windowingStrategy.WindowCoderId, newID)\n+\t}\n+\n+\t// Updating EnvironmentId of WindowingStrategy\n+\tif windowingStrategy.EnvironmentId != \"\" {\n+\t\twindowingStrategy.EnvironmentId = AddEnvironmentID(c, idMap, windowingStrategy.EnvironmentId, newID)\n+\t}\n+\n+\tidMap[wid] = newID(wid)\n+\n+\t// Updating WindowingStrategies map\n+\tc.WindowingStrategies[idMap[wid]] = windowingStrategy\n+\tdelete(c.WindowingStrategies, wid)\n+\n+\treturn idMap[wid]\n+}\n+\n+func AddEnvironmentID(c *pipepb.Components, idMap map[string]string, eid string, newID func(string) string) string {\n+\tif _, exists := idMap[eid]; exists {\n+\t\treturn idMap[eid]\n+\t}\n+\n+\tenvironment, exists := c.Environments[eid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing windowing strategy id: %v not in %v\", eid, c.Environments))\n+\t}\n+\n+\tidMap[eid] = newID(eid)\n+\n+\t// Updating Environments map\n+\tc.Environments[idMap[eid]] = environment\n+\tdelete(c.Environments, eid)\n+\n+\treturn idMap[eid]\n+}\n+\n+func AddNamespace(t *pipepb.PTransform, c *pipepb.Components, namespace string) {\n+\tnewID := func(id string) string {\n+\t\treturn fmt.Sprintf(\"%v@%v\", id, namespace)\n+\t}\n+\n+\tidMap := make(map[string]string)\n+\n+\tupdateCoderID := func(cid string) string {\n+\t\treturn AddCoderID(c, idMap, cid, newID)\n+\t}\n+\n+\tupdateWindowingStrategyID := func(wid string) string {\n+\t\treturn AddWindowingStrategyID(c, idMap, wid, newID)\n+\t}\n+\n+\tupdateEnvironmentID := func(eid string) string {\n+\t\treturn AddEnvironmentID(c, idMap, eid, newID)\n+\t}\n+\n+\t// Update Environment ID of PTransform\n+\tif t.EnvironmentId != \"\" {\n+\t\tt.EnvironmentId = updateEnvironmentID(t.EnvironmentId)\n+\t}\n+\tfmt.Println(t)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9620d6250c5d7f9e20599af9a1bff4da7dc142ee"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQyMDI2OQ==", "bodyText": "Remove these helpers, and call the functions directly in the loop below please. They're only used once each, and you do not modify any of their parameters, making the closures less useful, and harder to read.", "url": "https://github.com/apache/beam/pull/12635#discussion_r473420269", "createdAt": "2020-08-19T23:12:36Z", "author": {"login": "lostluck"}, "path": "sdks/go/pkg/beam/core/runtime/xlangx/namespace.go", "diffHunk": "@@ -0,0 +1,136 @@\n+// Licensed to the Apache Software Foundation (ASF) under one or more\n+// contributor license agreements.  See the NOTICE file distributed with\n+// this work for Additional information regarding copyright ownership.\n+// The ASF licenses this file to You under the Apache License, Version 2.0\n+// (the \"License\"); you may not use this file except in compliance with\n+// the License.  You may obtain a copy of the License at\n+//\n+//    http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package xlangx\n+\n+import (\n+\t\"fmt\"\n+\n+\t\"github.com/apache/beam/sdks/go/pkg/beam/internal/errors\"\n+\tpipepb \"github.com/apache/beam/sdks/go/pkg/beam/model/pipeline_v1\"\n+)\n+\n+func AddCoderID(c *pipepb.Components, idMap map[string]string, cid string, newID func(string) string) string {\n+\tif _, exists := idMap[cid]; exists {\n+\t\treturn idMap[cid]\n+\t}\n+\n+\tcoder, exists := c.Coders[cid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing coder id: %v not in %v\", cid, c.Coders))\n+\t}\n+\n+\t// Updating ComponentCoderIDs of Coder\n+\tif coder.GetComponentCoderIds() != nil {\n+\t\tupdatedComponentCoderIDs := coder.ComponentCoderIds // Pass by value\n+\t\tfor i, ccid := range coder.ComponentCoderIds {\n+\t\t\tupdatedComponentCoderIDs[i] = AddCoderID(c, idMap, ccid, newID)\n+\t\t\tcoder.ComponentCoderIds = updatedComponentCoderIDs\n+\t\t}\n+\t}\n+\n+\tidMap[cid] = newID(cid)\n+\n+\t// Updating Coders map\n+\tc.Coders[idMap[cid]] = coder\n+\tdelete(c.Coders, cid)\n+\n+\treturn idMap[cid]\n+}\n+\n+func AddWindowingStrategyID(c *pipepb.Components, idMap map[string]string, wid string, newID func(string) string) string {\n+\tif _, exists := idMap[wid]; exists {\n+\t\treturn idMap[wid]\n+\t}\n+\n+\twindowingStrategy, exists := c.WindowingStrategies[wid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing windowing strategy id: %v not in %v\", wid, c.WindowingStrategies))\n+\t}\n+\n+\t// Updating WindowCoderID of WindowingStrategy\n+\tif windowingStrategy.WindowCoderId != \"\" {\n+\t\twindowingStrategy.WindowCoderId = AddCoderID(c, idMap, windowingStrategy.WindowCoderId, newID)\n+\t}\n+\n+\t// Updating EnvironmentId of WindowingStrategy\n+\tif windowingStrategy.EnvironmentId != \"\" {\n+\t\twindowingStrategy.EnvironmentId = AddEnvironmentID(c, idMap, windowingStrategy.EnvironmentId, newID)\n+\t}\n+\n+\tidMap[wid] = newID(wid)\n+\n+\t// Updating WindowingStrategies map\n+\tc.WindowingStrategies[idMap[wid]] = windowingStrategy\n+\tdelete(c.WindowingStrategies, wid)\n+\n+\treturn idMap[wid]\n+}\n+\n+func AddEnvironmentID(c *pipepb.Components, idMap map[string]string, eid string, newID func(string) string) string {\n+\tif _, exists := idMap[eid]; exists {\n+\t\treturn idMap[eid]\n+\t}\n+\n+\tenvironment, exists := c.Environments[eid]\n+\tif !exists {\n+\t\tpanic(errors.Errorf(\"attempted to add namespace to missing windowing strategy id: %v not in %v\", eid, c.Environments))\n+\t}\n+\n+\tidMap[eid] = newID(eid)\n+\n+\t// Updating Environments map\n+\tc.Environments[idMap[eid]] = environment\n+\tdelete(c.Environments, eid)\n+\n+\treturn idMap[eid]\n+}\n+\n+func AddNamespace(t *pipepb.PTransform, c *pipepb.Components, namespace string) {\n+\tnewID := func(id string) string {\n+\t\treturn fmt.Sprintf(\"%v@%v\", id, namespace)\n+\t}\n+\n+\tidMap := make(map[string]string)\n+\n+\tupdateCoderID := func(cid string) string {\n+\t\treturn AddCoderID(c, idMap, cid, newID)\n+\t}\n+\n+\tupdateWindowingStrategyID := func(wid string) string {\n+\t\treturn AddWindowingStrategyID(c, idMap, wid, newID)\n+\t}\n+\n+\tupdateEnvironmentID := func(eid string) string {\n+\t\treturn AddEnvironmentID(c, idMap, eid, newID)\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9620d6250c5d7f9e20599af9a1bff4da7dc142ee"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63f9808215161a3b9636556a72fec2ecaf2332a8", "author": {"user": {"login": "pskevin", "name": "Kevin Sijo Puthusseri"}}, "url": "https://github.com/apache/beam/commit/63f9808215161a3b9636556a72fec2ecaf2332a8", "committedDate": "2020-08-19T23:34:51Z", "message": "[BEAM-9919] cleaning namespace.go"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDMzODI2", "url": "https://github.com/apache/beam/pull/12635#pullrequestreview-471033826", "createdAt": "2020-08-19T23:37:07Z", "commit": {"oid": "63f9808215161a3b9636556a72fec2ecaf2332a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4811, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}