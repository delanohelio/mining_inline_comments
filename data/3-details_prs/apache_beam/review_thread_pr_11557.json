{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjQ5NzEw", "number": 11557, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozNTo0N1rOD4Ek5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMToxMTo1N1rOD7Z_SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTIxODMxOnYy", "diffSide": "RIGHT", "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/DefaultArtifactResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozNTo0N1rOGOsO_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzozOToyOVrOGO98_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA1Nzk4Mg==", "bodyText": "Is the resolution order documented somewhere?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418057982", "createdAt": "2020-04-30T14:35:47Z", "author": {"login": "mxm"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/DefaultArtifactResolver.java", "diffHunk": "@@ -62,6 +63,24 @@ public void register(ResolutionFn fn) {\n     fns.add(fn);\n   }\n \n+  @Override\n+  public List<RunnerApi.ArtifactInformation> resolveArtifacts(\n+      List<RunnerApi.ArtifactInformation> artifacts) {\n+    for (ResolutionFn fn : Lists.reverse(fns)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODI4Ng==", "bodyText": "Yes, this is documented in the class's docstring.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418348286", "createdAt": "2020-04-30T23:39:29Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/DefaultArtifactResolver.java", "diffHunk": "@@ -62,6 +63,24 @@ public void register(ResolutionFn fn) {\n     fns.add(fn);\n   }\n \n+  @Override\n+  public List<RunnerApi.ArtifactInformation> resolveArtifacts(\n+      List<RunnerApi.ArtifactInformation> artifacts) {\n+    for (ResolutionFn fn : Lists.reverse(fns)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA1Nzk4Mg=="}, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTIzNTYxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/utils/subprocess_server.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozOToyMFrOGOsZyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzo0MDo1OFrOGO9-lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MDc0NQ==", "bodyText": "Was this necessary to transfer the artifacts?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418060745", "createdAt": "2020-04-30T14:39:20Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/utils/subprocess_server.py", "diffHunk": "@@ -98,7 +98,9 @@ def log_stdout():\n         t.daemon = True\n         t.start()\n         wait_secs = .1\n-        channel = grpc.insecure_channel(endpoint)\n+        channel_options = [(\"grpc.max_receive_message_length\", -1),\n+                           (\"grpc.max_send_message_length\", -1)]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODY5NQ==", "bodyText": "Yep, the default block size (4MB) produced messages just over the default grpc limits (4MB). I figured setting these here was safer, as the message size is chosen by the other side. We have similar settings elsewhere (e.g. on the data channel).", "url": "https://github.com/apache/beam/pull/11557#discussion_r418348695", "createdAt": "2020-04-30T23:40:58Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/subprocess_server.py", "diffHunk": "@@ -98,7 +98,9 @@ def log_stdout():\n         t.daemon = True\n         t.start()\n         wait_secs = .1\n-        channel = grpc.insecure_channel(endpoint)\n+        channel_options = [(\"grpc.max_receive_message_length\", -1),\n+                           (\"grpc.max_send_message_length\", -1)]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MDc0NQ=="}, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTM3NTIxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/external.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToxMDozMVrOGOtz4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzo0NToxN1rOGO-DYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MzgwOA==", "bodyText": "Please remove or replace with logging", "url": "https://github.com/apache/beam/pull/11557#discussion_r418083808", "createdAt": "2020-04-30T15:10:31Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -317,13 +317,17 @@ def expand(self, pvalueish):\n         transform=transform_proto)\n \n     with self._service() as service:\n+      print(type(service))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0OTkyMQ==", "bodyText": "Oops. Removed.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418349921", "createdAt": "2020-04-30T23:45:17Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -317,13 +317,17 @@ def expand(self, pvalueish):\n         transform=transform_proto)\n \n     with self._service() as service:\n+      print(type(service))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MzgwOA=="}, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTM5ODUzOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/pipeline.py", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToxNjowMVrOGOuCyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjowNjo1NlrOGPN6vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4NzYyNQ==", "bodyText": "Should this be prefixed by something pipeline-specific?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418087625", "createdAt": "2020-04-30T15:16:01Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -211,6 +211,8 @@ def __init__(self, runner=None, options=None, argv=None):\n         experiments.append('beam_fn_api')\n         self._options.view_as(DebugOptions).experiments = experiments\n \n+    self.local_tempdir = tempfile.mkdtemp(prefix='beam-pipeline-temp')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0OTQ1Nw==", "bodyText": "Did you have something in mind? I don't think there's a good name here we can use. The system will of course ensure this directory is unique per pipeline.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418349457", "createdAt": "2020-04-30T23:43:48Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -211,6 +211,8 @@ def __init__(self, runner=None, options=None, argv=None):\n         experiments.append('beam_fn_api')\n         self._options.view_as(DebugOptions).experiments = experiments\n \n+    self.local_tempdir = tempfile.mkdtemp(prefix='beam-pipeline-temp')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4NzYyNQ=="}, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwOTg1NA==", "bodyText": "That's fine then, wasn't sure whether this is a unique directory.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418609854", "createdAt": "2020-05-01T16:06:56Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -211,6 +211,8 @@ def __init__(self, runner=None, options=None, argv=None):\n         experiments.append('beam_fn_api')\n         self._options.view_as(DebugOptions).experiments = experiments\n \n+    self.local_tempdir = tempfile.mkdtemp(prefix='beam-pipeline-temp')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4NzYyNQ=="}, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzIwMDIzOnYy", "diffSide": "RIGHT", "path": "sdks/java/expansion-service/src/main/java/org/apache/beam/sdk/expansion/service/ExpansionService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToyMjoxNlrOGO_lwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMzozNDoxOVrOGPBOww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3NTEwNg==", "bodyText": "This assumes that the set of classpath resources required to execute Java SDK harness and execute the cross-langauge Java step to be the same as the set of classpath resources specified when starting up the expansion service, right ?\nI'm wondering if we can always rely on this. At least we should document this so that users are aware how to stage additional resources if needed.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418375106", "createdAt": "2020-05-01T01:22:16Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/expansion-service/src/main/java/org/apache/beam/sdk/expansion/service/ExpansionService.java", "diffHunk": "@@ -317,6 +321,14 @@ default InputT createInput(Pipeline p, Map<String, PCollection<?>> inputs) {\n     Pipeline pipeline = Pipeline.create();\n     ExperimentalOptions.addExperiment(\n         pipeline.getOptions().as(ExperimentalOptions.class), \"beam_fn_api\");\n+    List<String> classpathResources =\n+        detectClassPathResourcesToStage(Environments.class.getClassLoader(), pipeline.getOptions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwMTk4Nw==", "bodyText": "Correct. This is a reasonable default (and the provider of an expansion service can always arrange that it is so), but we'll probably eventually want a way to customize this.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418401987", "createdAt": "2020-05-01T03:34:19Z", "author": {"login": "robertwb"}, "path": "sdks/java/expansion-service/src/main/java/org/apache/beam/sdk/expansion/service/ExpansionService.java", "diffHunk": "@@ -317,6 +321,14 @@ default InputT createInput(Pipeline p, Map<String, PCollection<?>> inputs) {\n     Pipeline pipeline = Pipeline.create();\n     ExperimentalOptions.addExperiment(\n         pipeline.getOptions().as(ExperimentalOptions.class), \"beam_fn_api\");\n+    List<String> classpathResources =\n+        detectClassPathResourcesToStage(Environments.class.getClassLoader(), pipeline.getOptions());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3NTEwNg=="}, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzIxMTk1OnYy", "diffSide": "LEFT", "path": "sdks/python/apache_beam/transforms/sql_test.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToyOTo1NVrOGO_sjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMzo1NDo1NFrOGPBdVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3Njg0NQ==", "bodyText": "Can we update 'validate_runner_xlang_test.py' for Spark and Flink as well or do we need additional changes before that.\njar_packages cannot be completely removed yet since Dataflow needs it.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418376845", "createdAt": "2020-05-01T01:29:55Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/transforms/sql_test.py", "diffHunk": "@@ -66,20 +66,8 @@ class SqlTransformTest(unittest.TestCase):\n         --tests apache_beam.transforms.sql_test \\\\\n         --test-pipeline-options=\"--runner=FlinkRunner\"\n   \"\"\"\n-  @staticmethod\n-  def make_test_pipeline():\n-    path_to_jar = subprocess_server.JavaJarServer.path_to_beam_jar(\n-        \":sdks:java:extensions:sql:expansion-service:shadowJar\")\n-    test_pipeline = TestPipeline()\n-    # TODO(BEAM-9238): Remove this when it's no longer needed for artifact\n-    # staging.\n-    test_pipeline.get_pipeline_options().view_as(DebugOptions).experiments = [\n-        'jar_packages=' + path_to_jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNTcxNg==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418405716", "createdAt": "2020-05-01T03:54:54Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/sql_test.py", "diffHunk": "@@ -66,20 +66,8 @@ class SqlTransformTest(unittest.TestCase):\n         --tests apache_beam.transforms.sql_test \\\\\n         --test-pipeline-options=\"--runner=FlinkRunner\"\n   \"\"\"\n-  @staticmethod\n-  def make_test_pipeline():\n-    path_to_jar = subprocess_server.JavaJarServer.path_to_beam_jar(\n-        \":sdks:java:extensions:sql:expansion-service:shadowJar\")\n-    test_pipeline = TestPipeline()\n-    # TODO(BEAM-9238): Remove this when it's no longer needed for artifact\n-    # staging.\n-    test_pipeline.get_pipeline_options().view_as(DebugOptions).experiments = [\n-        'jar_packages=' + path_to_jar", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3Njg0NQ=="}, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjE4Mzc3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/external.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMToxMTo1N1rOGTtjmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMToxMTo1N1rOGTtjmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjUyMA==", "bodyText": "This import is guarded and optional. So if the guard fails, this always fails.", "url": "https://github.com/apache/beam/pull/11557#discussion_r423322520", "createdAt": "2020-05-11T21:11:57Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -443,6 +470,18 @@ def _normalize(coder_proto):\n         environment_id=self._expanded_transform.environment_id)\n \n \n+class ExpansionAndArtifactRetrievalStub(\n+    beam_expansion_api_pb2_grpc.ExpansionServiceStub):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de83a82c1d22a8eda9f214a6d57e9d69215979de"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1185, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}