{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODQyODk4", "number": 12067, "title": "[BEAM-10308] Make component ID assignments consistent across PipelineContext instances", "bodyText": "This PR creates a global cache for component ID assignments made in PipelineContext instances. See BEAM-10308 and BEAM-10143 for motivation.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-23T21:55:35Z", "url": "https://github.com/apache/beam/pull/12067", "merged": true, "mergeCommit": {"oid": "31aa8c0b2194c409f27cebab83cf2241f4e44eea"}, "closed": true, "closedAt": "2020-07-07T22:32:45Z", "author": {"login": "TheNeuralBit"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuMK3wAH2gAyNDM4ODQyODk4OjE0MmJjMjk5MDA0YjE3OTAwYmI4ZjM2OTllZDgxNjA3MGM3NDg5Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwzIzKgH2gAyNDM4ODQyODk4OjhhYmJmMGNkZjFkNDczODg1N2VjMzJmYzU4OGMyMWFkZGU4YjEyZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "142bc299004b17900bb8f3699ed816070c7489b9", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/142bc299004b17900bb8f3699ed816070c7489b9", "committedDate": "2020-06-23T21:17:20Z", "message": "Add failing test of ref assignment consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35237ae6d14a49b7305297cfa56cdb31e7299abd", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/35237ae6d14a49b7305297cfa56cdb31e7299abd", "committedDate": "2020-06-23T21:45:56Z", "message": "Extract out unique ref assignment, scope it globally"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efcdbc694cbe0a6bab182c2c6180b92817eb0636", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/efcdbc694cbe0a6bab182c2c6180b92817eb0636", "committedDate": "2020-06-24T15:23:55Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0724933eda23e0ee2982b6065078b6a850e0a3da", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/0724933eda23e0ee2982b6065078b6a850e0a3da", "committedDate": "2020-06-24T18:24:25Z", "message": "yapf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQ2Njc4", "url": "https://github.com/apache/beam/pull/12067#pullrequestreview-438646678", "createdAt": "2020-06-26T23:41:21Z", "commit": {"oid": "5cf25e6a82c9cbd5002a2846e3345b84f91d8abd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0MToyMVrOGpxUzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0MToyMVrOGpxUzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1Mjk0Mg==", "bodyText": "Partitioning the cached ID assignments by id(pipeline) is a sub-par and dangerous solution because id is only guaranteed to be unique among objects that have non-overlapping lifetimes. If we go with something like this approach, we need to at least tie these instances' lifetimes to the lifetime of the pipeline.", "url": "https://github.com/apache/beam/pull/12067#discussion_r446452942", "createdAt": "2020-06-26T23:41:21Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/runners/pipeline_context.py", "diffHunk": "@@ -49,6 +50,52 @@\n   from apache_beam.coders.coder_impl import IterableStateWriter\n \n \n+class _UniqueRefAssigner(object):\n+  \"\"\"Utility for assigning unique refs to proto messages for use in components.\n+\n+  Instances of _UniqueRefAssigner are global (scoped by the base string). That\n+  way once a unique ref is assigned it will be used consistently across\n+  PipelineContext instances.\n+  \"\"\"\n+  _INSTANCES = {}  # type: Dict[Tuple[Pipeline, str], _UniqueRefAssigner]\n+\n+  def __init__(self, base):\n+    self._base = base\n+    self._counter = 0\n+    self._obj_to_id = {}  # type: Dict[Any, str]\n+\n+  def get_or_assign(self, obj=None, label=None):\n+    # type: (Optional[Any], Optional[str]) -> str\n+\n+    \"\"\"Retrieve the unique ref for the given object.\n+\n+    Generates and assigns a unique ref if one hasn't been assigned yet. label\n+    will be incorporated into the unique ref when assigning a new unique ref,\n+    otherwise it is ignored.\"\"\"\n+    if obj not in self._obj_to_id:\n+      self._obj_to_id[obj] = self._unique_ref(obj, label)\n+\n+    return self._obj_to_id[obj]\n+\n+  def _unique_ref(self, obj=None, label=None):\n+    self._counter += 1\n+    return \"%s_%s_%d\" % (self._base, label or type(obj).__name__, self._counter)\n+\n+  @classmethod\n+  def get_instance(cls, pipeline, base):\n+    # type: (Optional[Pipeline], str) -> _UniqueRefAssigner\n+\n+    \"\"\"Return the _UniqueRefAssigner with the given base string.\n+\n+    Creates a new instance if one doesn't already exist for this base string.\"\"\"\n+    key = (id(pipeline), base)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf25e6a82c9cbd5002a2846e3345b84f91d8abd"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdbbe5b2710d2204e230806cf1ef2c8a5b4e4cea", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/fdbbe5b2710d2204e230806cf1ef2c8a5b4e4cea", "committedDate": "2020-06-29T23:08:00Z", "message": "Store component id assignments on pipeline object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "600dd85b20d65c37d3fe546bac365a161dfe4f1e", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/600dd85b20d65c37d3fe546bac365a161dfe4f1e", "committedDate": "2020-06-29T23:08:13Z", "message": "Add test for BEAM-10143"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5cf25e6a82c9cbd5002a2846e3345b84f91d8abd", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/5cf25e6a82c9cbd5002a2846e3345b84f91d8abd", "committedDate": "2020-06-26T23:28:20Z", "message": "Add test for BEAM-10143"}, "afterCommit": {"oid": "600dd85b20d65c37d3fe546bac365a161dfe4f1e", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/600dd85b20d65c37d3fe546bac365a161dfe4f1e", "committedDate": "2020-06-29T23:08:13Z", "message": "Add test for BEAM-10143"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07fac9a52af0b49be4a0ca8f15192b4f25786961", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/07fac9a52af0b49be4a0ca8f15192b4f25786961", "committedDate": "2020-06-29T23:36:59Z", "message": "yapf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725299b98088771e486053c540cec085cc2b487b", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/725299b98088771e486053c540cec085cc2b487b", "committedDate": "2020-06-30T00:08:54Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/cd9a47ad634abf222bbf272d31c94a27cf9070d5", "committedDate": "2020-06-30T18:53:00Z", "message": "Revert change that removes _obj_to_id. It breaks ExpansionServicer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjMzMTg5", "url": "https://github.com/apache/beam/pull/12067#pullrequestreview-441233189", "createdAt": "2020-07-01T22:22:03Z", "commit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyMjowM1rOGr3MCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyODoyMVrOGr3UlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjE1Mw==", "bodyText": "There's not actually a circular dependency of classes. You could move this class in here and that would be fine.", "url": "https://github.com/apache/beam/pull/12067#discussion_r448646153", "createdAt": "2020-07-01T22:22:03Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -221,6 +221,14 @@ def __init__(self, runner=None, options=None, argv=None):\n     # then the transform will have to be cloned with a new label.\n     self.applied_labels = set()  # type: Set[str]\n \n+    # Create a context for assigning IDs to components. Ensures that any\n+    # components that receive an ID during pipeline construction (for example in\n+    # ExternalTransform), will receive the same component ID when generating the\n+    # full pipeline proto.\n+    from apache_beam.runners import pipeline_context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0Nzk5OQ==", "bodyText": "There's a lot of overlap between the purpose of this and the purpose of the PipelineContext but I can see how they are different. I see that the pipeline only takes the context at to_runner_api time, and the context has tweaks like use_fake_coders and default_environment. So when using xlang expansion you can keep just the ids and throw away the contents that will be generated according to these tweaks later.", "url": "https://github.com/apache/beam/pull/12067#discussion_r448647999", "createdAt": "2020-07-01T22:27:17Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/runners/pipeline_context.py", "diffHunk": "@@ -49,6 +50,32 @@\n   from apache_beam.coders.coder_impl import IterableStateWriter\n \n \n+class ComponentIdContext(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0ODM0MQ==", "bodyText": "Based on this use, maybe _component_id_context isn't private at all? And maybe it is a component_id_map or some such. It isn't \"context\" in the sense that it isn't \"the stuff surrounding the thing you are interested in\".", "url": "https://github.com/apache/beam/pull/12067#discussion_r448648341", "createdAt": "2020-07-01T22:28:21Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -286,7 +286,8 @@ def expand(self, pvalueish):\n     pipeline = (\n         next(iter(self._inputs.values())).pipeline\n         if self._inputs else pvalueish.pipeline)\n-    context = pipeline_context.PipelineContext()\n+    context = pipeline_context.PipelineContext(\n+        component_id_context=pipeline._component_id_context)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8abbf0cdf1d4738857ec32fc588c21adde8b12f2", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/8abbf0cdf1d4738857ec32fc588c21adde8b12f2", "committedDate": "2020-07-01T23:49:13Z", "message": "address review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3749, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}