{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzg3MDI4", "number": 12106, "title": "[BEAM-9792] Fixing the IOException handling in InsertAll for BigQuery", "bodyText": "Change the IOException handling in InsertAll to prevent retrying forever for all IOException.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-26T21:06:37Z", "url": "https://github.com/apache/beam/pull/12106", "merged": true, "mergeCommit": {"oid": "5e0e798ddd827fd212ac89b8c6f6f2cf9e4b29a5"}, "closed": true, "closedAt": "2020-08-04T19:40:34Z", "author": {"login": "danielxjd"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvHmtEAH2gAyNDQwNzg3MDI4OmM4ZmE1ZGM2NjU4NTIzZjM5ZWJhMTkyZmU5MjQxYjdhZTQ4ODQ4Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5xU2KgH2gAyNDQwNzg3MDI4OjQxYmUwM2M2NTQzYzk5MDczMTZhYTQwM2Q5N2VhZWY5YmE1ZjM5YTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8fa5dc6658523f39eba192fe9241b7ae48848c9", "author": {"user": {"login": "xiajiadai", "name": null}}, "url": "https://github.com/apache/beam/commit/c8fa5dc6658523f39eba192fe9241b7ae48848c9", "committedDate": "2020-06-26T18:32:08Z", "message": "fixing the IOException handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aecad3541380ab44a39b6c67dc3bbc290be7330e", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/aecad3541380ab44a39b6c67dc3bbc290be7330e", "committedDate": "2020-06-26T20:51:34Z", "message": "change getErrorInfo into seperate method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba2dcb341b58cefbf8bc30000c03ff0e578e21a", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/5ba2dcb341b58cefbf8bc30000c03ff0e578e21a", "committedDate": "2020-06-26T21:04:38Z", "message": "delete unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47c6feeaf2d4288727a860eeac60ad992a722720", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/47c6feeaf2d4288727a860eeac60ad992a722720", "committedDate": "2020-06-26T21:23:17Z", "message": "delete empty line in import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7da0400465dc359799bb81eb6055eb8e25c86d28", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/7da0400465dc359799bb81eb6055eb8e25c86d28", "committedDate": "2020-06-26T22:22:08Z", "message": "spotless change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd3777e9f7cad4b8b6b6dfe1e35e266113ed3b62", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/dd3777e9f7cad4b8b6b6dfe1e35e266113ed3b62", "committedDate": "2020-06-27T00:46:51Z", "message": "naming change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1", "committedDate": "2020-06-27T04:53:30Z", "message": "change to vendored gauva class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjkzOTU1", "url": "https://github.com/apache/beam/pull/12106#pullrequestreview-444293955", "createdAt": "2020-07-07T22:29:16Z", "commit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjoyOToxNlrOGuR1hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMzoxMjoyM1rOGuStKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTkwOA==", "bodyText": "I would move this to a String constant. Also probably add a reference to here: https://cloud.google.com/bigquery/docs/error-messages", "url": "https://github.com/apache/beam/pull/12106#discussion_r451179908", "createdAt": "2020-07-07T22:29:16Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -793,6 +795,14 @@ public void deleteDataset(String projectId, String datasetId)\n                               String.format(\n                                   \"BigQuery insertAll error, retrying: %s\",\n                                   ApiErrorExtractor.INSTANCE.getErrorMessage(e)));\n+                          GoogleJsonError.ErrorInfo errorInfo = getErrorInfo(e);\n+                          if (errorInfo == null) {\n+                            return insert.execute().getInsertErrors();\n+                          }\n+                          if (!ApiErrorExtractor.INSTANCE.rateLimited(e)\n+                              && !errorInfo.getReason().equals(\"quotaExceeded\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4ODg5NQ==", "bodyText": "Why are we performing an extra retry here ?", "url": "https://github.com/apache/beam/pull/12106#discussion_r451188895", "createdAt": "2020-07-07T22:55:44Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -793,6 +795,14 @@ public void deleteDataset(String projectId, String datasetId)\n                               String.format(\n                                   \"BigQuery insertAll error, retrying: %s\",\n                                   ApiErrorExtractor.INSTANCE.getErrorMessage(e)));\n+                          GoogleJsonError.ErrorInfo errorInfo = getErrorInfo(e);\n+                          if (errorInfo == null) {\n+                            return insert.execute().getInsertErrors();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4ODk4NA==", "bodyText": "Ditto regarding the extra retry.", "url": "https://github.com/apache/beam/pull/12106#discussion_r451188984", "createdAt": "2020-07-07T22:56:02Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -793,6 +795,14 @@ public void deleteDataset(String projectId, String datasetId)\n                               String.format(\n                                   \"BigQuery insertAll error, retrying: %s\",\n                                   ApiErrorExtractor.INSTANCE.getErrorMessage(e)));\n+                          GoogleJsonError.ErrorInfo errorInfo = getErrorInfo(e);\n+                          if (errorInfo == null) {\n+                            return insert.execute().getInsertErrors();\n+                          }\n+                          if (!ApiErrorExtractor.INSTANCE.rateLimited(e)\n+                              && !errorInfo.getReason().equals(\"quotaExceeded\")) {\n+                            return insert.execute().getInsertErrors();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE5MzY4Nw==", "bodyText": "How do these exceptions extend both GoogleJsonResponseException and IOException ?", "url": "https://github.com/apache/beam/pull/12106#discussion_r451193687", "createdAt": "2020-07-07T23:10:54Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -893,6 +903,20 @@ public void deleteDataset(String projectId, String datasetId)\n           ignoreInsertIds);\n     }\n \n+    private GoogleJsonError.ErrorInfo getErrorInfo(IOException e) {\n+      GoogleJsonResponseException jsonCause = null;\n+      Throwable eCause = e;\n+      if (eCause instanceof GoogleJsonResponseException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE5NDE1NA==", "bodyText": "Please add a unit test for this method.", "url": "https://github.com/apache/beam/pull/12106#discussion_r451194154", "createdAt": "2020-07-07T23:12:23Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -893,6 +903,20 @@ public void deleteDataset(String projectId, String datasetId)\n           ignoreInsertIds);\n     }\n \n+    private GoogleJsonError.ErrorInfo getErrorInfo(IOException e) {\n+      GoogleJsonResponseException jsonCause = null;\n+      Throwable eCause = e;\n+      if (eCause instanceof GoogleJsonResponseException) {\n+        jsonCause = (GoogleJsonResponseException) eCause;\n+      } else {\n+        return null;\n+      }\n+      GoogleJsonError jsonError = jsonCause.getDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2763c45ebe6cff4a1e0a63d512fdc67f34f4dc1"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae8915aff7cc5c38276ed0b216d6579157c7d44", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/5ae8915aff7cc5c38276ed0b216d6579157c7d44", "committedDate": "2020-07-08T01:59:35Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498ed60a8becb2696c0e5ecbf1bc7b0e64fc4dd2", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/498ed60a8becb2696c0e5ecbf1bc7b0e64fc4dd2", "committedDate": "2020-07-08T02:03:49Z", "message": "remove redundent code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzY2MzE4", "url": "https://github.com/apache/beam/pull/12106#pullrequestreview-444366318", "createdAt": "2020-07-08T02:14:09Z", "commit": {"oid": "498ed60a8becb2696c0e5ecbf1bc7b0e64fc4dd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNDowOVrOGuVqng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNDowOVrOGuVqng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0MjY1NA==", "bodyText": "We can further simplify :)\nprotected GoogleJsonError.ErrorInfo getErrorInfo(IOException e) {\nif (!(e instanceof GoogleJsonResponseException)) {\nreturn null;\n}\nGoogleJsonError jsonError = ((GoogleJsonResponseException) e).getDetails();\n...", "url": "https://github.com/apache/beam/pull/12106#discussion_r451242654", "createdAt": "2020-07-08T02:14:09Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -893,6 +906,19 @@ public void deleteDataset(String projectId, String datasetId)\n           ignoreInsertIds);\n     }\n \n+    protected GoogleJsonError.ErrorInfo getErrorInfo(IOException e) {\n+      GoogleJsonResponseException jsonCause = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498ed60a8becb2696c0e5ecbf1bc7b0e64fc4dd2"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e05dce11dc8fff906b72cf471d7d05539027332e", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/e05dce11dc8fff906b72cf471d7d05539027332e", "committedDate": "2020-07-08T02:20:08Z", "message": "further simplifies getErrorInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02dd0b741ccc998ecc8629a974a904785762407b", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/02dd0b741ccc998ecc8629a974a904785762407b", "committedDate": "2020-07-08T02:23:44Z", "message": "spotless fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "010b40be9cd28a0a3672f025ef8cdf18a700e39e", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/010b40be9cd28a0a3672f025ef8cdf18a700e39e", "committedDate": "2020-07-08T04:43:35Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b264be76cbb820e53b7a132d2d6a4004155e2c9", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/5b264be76cbb820e53b7a132d2d6a4004155e2c9", "committedDate": "2020-07-08T04:45:23Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ea500690d3a7a434ee607cc7937fc11eebf054", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/a0ea500690d3a7a434ee607cc7937fc11eebf054", "committedDate": "2020-07-23T19:13:40Z", "message": "Merge branch 'master' into BEAM-9792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f26008b1cd599f6d2d99070ddc9bee10396181c", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/3f26008b1cd599f6d2d99070ddc9bee10396181c", "committedDate": "2020-07-23T19:26:16Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/1a43bb917f259d5d8cf8ee2051eb05c87a308edd", "committedDate": "2020-07-23T19:28:09Z", "message": "Merge branch 'BEAM-9792' of https://github.com/danielxjd/beam into BEAM-9792"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDIxNjc1", "url": "https://github.com/apache/beam/pull/12106#pullrequestreview-456021675", "createdAt": "2020-07-27T18:14:19Z", "commit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODoxNDoxOVrOG3t-BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODo1MToxNFrOG3vOkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3ODAyMQ==", "bodyText": "Please create and link a jira ticket for this TODO.", "url": "https://github.com/apache/beam/pull/12106#discussion_r461078021", "createdAt": "2020-07-27T18:14:19Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -805,6 +810,19 @@ public void deleteDataset(String projectId, String datasetId)\n                         try {\n                           return insert.execute().getInsertErrors();\n                         } catch (IOException e) {\n+                          GoogleJsonError.ErrorInfo errorInfo = getErrorInfo(e);\n+                          if (errorInfo == null) {\n+                            throw e;\n+                          }\n+                          /**\n+                           * TODO:Check for quotaExceededError The check will be replaced by", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjM0NA==", "bodyText": "This will silently ignore the exception. Please check whether the expected exception is actually thrown like: https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImplTest.java#L316", "url": "https://github.com/apache/beam/pull/12106#discussion_r461096344", "createdAt": "2020-07-27T18:47:02Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImplTest.java", "diffHunk": "@@ -687,22 +689,26 @@ public void testInsertOtherRetry() throws Throwable {\n \n     DatasetServiceImpl dataService =\n         new DatasetServiceImpl(bigquery, PipelineOptionsFactory.create());\n-    dataService.insertAll(\n-        ref,\n-        rows,\n-        null,\n-        BackOffAdapter.toGcpBackOff(TEST_BACKOFF.backoff()),\n-        new MockSleeper(),\n-        InsertRetryPolicy.alwaysRetry(),\n-        null,\n-        null,\n-        false,\n-        false,\n-        false);\n-    verify(response, times(2)).getStatusCode();\n-    verify(response, times(2)).getContent();\n-    verify(response, times(2)).getContentType();\n-    expectedLogs.verifyInfo(\"BigQuery insertAll error, retrying:\");\n+    try {\n+      dataService.insertAll(\n+          ref,\n+          rows,\n+          null,\n+          BackOffAdapter.toGcpBackOff(TEST_BACKOFF.backoff()),\n+          new MockSleeper(),\n+          InsertRetryPolicy.alwaysRetry(),\n+          null,\n+          null,\n+          false,\n+          false,\n+          false);\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5Njk0OA==", "bodyText": "Please modify the comment accordingly.", "url": "https://github.com/apache/beam/pull/12106#discussion_r461096948", "createdAt": "2020-07-27T18:48:13Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImplTest.java", "diffHunk": "@@ -670,7 +672,7 @@ public void testInsertFailsGracefully() throws Exception {\n    * non-quota-exceeded attempts.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NzI3NA==", "bodyText": "Please modify the method name accordingly.", "url": "https://github.com/apache/beam/pull/12106#discussion_r461097274", "createdAt": "2020-07-27T18:48:48Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImplTest.java", "diffHunk": "@@ -670,7 +672,7 @@ public void testInsertFailsGracefully() throws Exception {\n    * non-quota-exceeded attempts.\n    */\n   @Test\n-  public void testInsertOtherRetry() throws Throwable {\n+  public void testInsertOtherRetry() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5ODY0MA==", "bodyText": "What happens if getErrors returns two or more elements?", "url": "https://github.com/apache/beam/pull/12106#discussion_r461098640", "createdAt": "2020-07-27T18:51:14Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -909,6 +927,15 @@ public void deleteDataset(String projectId, String datasetId)\n           ignoreInsertIds);\n     }\n \n+    protected GoogleJsonError.ErrorInfo getErrorInfo(IOException e) {\n+      if (!(e instanceof GoogleJsonResponseException)) {\n+        return null;\n+      }\n+      GoogleJsonError jsonError = ((GoogleJsonResponseException) e).getDetails();\n+      GoogleJsonError.ErrorInfo errorInfo = Iterables.getFirst(jsonError.getErrors(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a43bb917f259d5d8cf8ee2051eb05c87a308edd"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2498143bafee2f8860a72fb9efb08e8d783f61bb", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/2498143bafee2f8860a72fb9efb08e8d783f61bb", "committedDate": "2020-07-27T21:58:28Z", "message": "change test names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4840dbd17a56b1281ec1b6675665c490173045c8", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/4840dbd17a56b1281ec1b6675665c490173045c8", "committedDate": "2020-07-27T22:03:21Z", "message": "Merge branch 'master' into BEAM-9792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3818b42e2d8b1da1440949d1d6fd5d58a44c3e65", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/3818b42e2d8b1da1440949d1d6fd5d58a44c3e65", "committedDate": "2020-07-27T22:29:46Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166ebe034a902b5e2aa3a19512e3f6bbaf7563ef", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/166ebe034a902b5e2aa3a19512e3f6bbaf7563ef", "committedDate": "2020-07-27T22:30:29Z", "message": "Merge branch 'BEAM-9792' of https://github.com/danielxjd/beam into BEAM-9792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2881829a4b82f87e7427eaab4b4946f470877842", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/2881829a4b82f87e7427eaab4b4946f470877842", "committedDate": "2020-07-27T22:37:40Z", "message": "style change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7e6469094e9cdffc6a6dc19ca3206780d8e3dfe", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/d7e6469094e9cdffc6a6dc19ca3206780d8e3dfe", "committedDate": "2020-07-27T22:39:14Z", "message": "add failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3ODIxOTkx", "url": "https://github.com/apache/beam/pull/12106#pullrequestreview-457821991", "createdAt": "2020-07-29T19:26:01Z", "commit": {"oid": "d7e6469094e9cdffc6a6dc19ca3206780d8e3dfe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOToyNjowMlrOG5G3cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOToyNjowMlrOG5G3cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzNDUxMw==", "bodyText": "I think it looks better to use thrown.expect and thrown.expectMessage instead of assertTrue with instanceof.", "url": "https://github.com/apache/beam/pull/12106#discussion_r462534513", "createdAt": "2020-07-29T19:26:02Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImplTest.java", "diffHunk": "@@ -733,26 +734,29 @@ public void testInsertOtherRetry() throws Throwable {\n     when(response.getContent())\n         .thenReturn(toStream(errorWithReasonAndStatus(\"actually forbidden\", 403)))\n         .thenReturn(toStream(new TableDataInsertAllResponse()));\n-\n-    DatasetServiceImpl dataService =\n-        new DatasetServiceImpl(bigquery, PipelineOptionsFactory.create());\n-    dataService.insertAll(\n-        ref,\n-        rows,\n-        null,\n-        BackOffAdapter.toGcpBackOff(TEST_BACKOFF.backoff()),\n-        TEST_BACKOFF,\n-        new MockSleeper(),\n-        InsertRetryPolicy.alwaysRetry(),\n-        null,\n-        null,\n-        false,\n-        false,\n-        false);\n-    verify(response, times(2)).getStatusCode();\n-    verify(response, times(2)).getContent();\n-    verify(response, times(2)).getContentType();\n-    expectedLogs.verifyInfo(\"BigQuery insertAll error, retrying:\");\n+    try {\n+      DatasetServiceImpl dataService =\n+          new DatasetServiceImpl(bigquery, PipelineOptionsFactory.create());\n+      dataService.insertAll(\n+          ref,\n+          rows,\n+          null,\n+          BackOffAdapter.toGcpBackOff(TEST_BACKOFF.backoff()),\n+          TEST_BACKOFF,\n+          new MockSleeper(),\n+          InsertRetryPolicy.alwaysRetry(),\n+          null,\n+          null,\n+          false,\n+          false,\n+          false);\n+      fail();\n+    } catch (RuntimeException e) {\n+      assertTrue(e instanceof RuntimeException);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e6469094e9cdffc6a6dc19ca3206780d8e3dfe"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a64c492891b3f40d836b2a7acc2a45e291dd3e7b", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/a64c492891b3f40d836b2a7acc2a45e291dd3e7b", "committedDate": "2020-07-29T20:33:43Z", "message": "change exception handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3ODgzMzI1", "url": "https://github.com/apache/beam/pull/12106#pullrequestreview-457883325", "createdAt": "2020-07-29T20:45:13Z", "commit": {"oid": "a64c492891b3f40d836b2a7acc2a45e291dd3e7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0NToxM1rOG5Jfbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0NToxM1rOG5Jfbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NzUxOA==", "bodyText": "TODO(BEAM-10584): Check for QUOTA_EXCEEDED error will be replaced by", "url": "https://github.com/apache/beam/pull/12106#discussion_r462577518", "createdAt": "2020-07-29T20:45:13Z", "author": {"login": "ihji"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryServicesImpl.java", "diffHunk": "@@ -806,6 +811,19 @@ public void deleteDataset(String projectId, String datasetId)\n                         try {\n                           return insert.execute().getInsertErrors();\n                         } catch (IOException e) {\n+                          GoogleJsonError.ErrorInfo errorInfo = getErrorInfo(e);\n+                          if (errorInfo == null) {\n+                            throw e;\n+                          }\n+                          /**\n+                           * TODO:Check for quotaExceededError The check will be replaced by", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a64c492891b3f40d836b2a7acc2a45e291dd3e7b"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41be03c6543c9907316aa403d97eaef9ba5f39a0", "author": {"user": {"login": "danielxjd", "name": "Jiadai Xia"}}, "url": "https://github.com/apache/beam/commit/41be03c6543c9907316aa403d97eaef9ba5f39a0", "committedDate": "2020-07-29T20:47:53Z", "message": "add jira issue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3170, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}