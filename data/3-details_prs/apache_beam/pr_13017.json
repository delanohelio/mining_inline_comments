{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MjA0NjA5", "number": 13017, "title": "[BEAM-11018] Use metric for Python BigQuery streaming insert API late\u2026", "bodyText": "\u2026ncy logging\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-06T01:18:44Z", "url": "https://github.com/apache/beam/pull/13017", "merged": true, "mergeCommit": {"oid": "c56e9878c83fd1331da55de2219dfc818a397af6"}, "closed": true, "closedAt": "2020-10-21T07:12:35Z", "author": {"login": "ihji"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPvNsuABqjM4NDMxOTU4NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUikECgH2gAyNDk4MjA0NjA5OmNkMTM5NDUyOWFjOWFhMTQwZjBlNTgzNDNkOGU5YmVmYzM3MjE1NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "764196c3a8017c11191c9056d857774b1252af24", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/764196c3a8017c11191c9056d857774b1252af24", "committedDate": "2020-10-06T01:18:01Z", "message": "[BEAM-11018] Use metric for Python BigQuery streaming insert API latency logging"}, "afterCommit": {"oid": "486f4d36997b6b94187fdcd099aa4ef85f891867", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/486f4d36997b6b94187fdcd099aa4ef85f891867", "committedDate": "2020-10-06T02:46:16Z", "message": "[BEAM-11018] Use metric for Python BigQuery streaming insert API latency logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/6bc49b12c24ca0f0676860fa4b72ed04d90c87a2", "committedDate": "2020-10-06T08:49:00Z", "message": "[BEAM-11018] Use metric for Python BigQuery streaming insert API latency logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "486f4d36997b6b94187fdcd099aa4ef85f891867", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/486f4d36997b6b94187fdcd099aa4ef85f891867", "committedDate": "2020-10-06T02:46:16Z", "message": "[BEAM-11018] Use metric for Python BigQuery streaming insert API latency logging"}, "afterCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/6bc49b12c24ca0f0676860fa4b72ed04d90c87a2", "committedDate": "2020-10-06T08:49:00Z", "message": "[BEAM-11018] Use metric for Python BigQuery streaming insert API latency logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDAwODI1", "url": "https://github.com/apache/beam/pull/13017#pullrequestreview-503400825", "createdAt": "2020-10-06T22:22:13Z", "commit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMjoyMjoxM1rOHdb-3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMToxODo1OVrOHeKzBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYyOTIxNA==", "bodyText": "Can this be obtained without plumbing to the ctor. I.e. as a pipeline option accessed directly, or constant in this file?", "url": "https://github.com/apache/beam/pull/13017#discussion_r500629214", "createdAt": "2020-10-06T22:22:13Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1102,7 +1096,7 @@ def __init__(\n       retry_strategy=None,\n       additional_bq_parameters=None,\n       ignore_insert_ids=False,\n-      latency_logging_frequency_sec=None):\n+      streaming_api_logging_frequency_sec=None):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MDY2OA==", "bodyText": "Might be good to ensure this isn't called. Can we throw not implemented?\nOr if that breaks other code, at least comment why this isn't populated yet.", "url": "https://github.com/apache/beam/pull/13017#discussion_r501390668", "createdAt": "2020-10-08T00:55:27Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/cells.py", "diffHunk": "@@ -238,6 +250,57 @@ def to_runner_api_monitoring_info(self, name, transform_id):\n         ptransform=transform_id)\n \n \n+class HistogramCell(MetricCell):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  Tracks the current value and delta for a histogram metric.\n+\n+  Each cell tracks the state of a metric independently per context per bundle.\n+  Therefore, each metric has a different cell in each bundle, that is later\n+  aggregated.\n+\n+  This class is thread safe since underlying histogram object is thread safe.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._bucket_type = bucket_type\n+    self.data = HistogramAggregator(bucket_type).identity_element()\n+\n+  def reset(self):\n+    self.data = HistogramAggregator(self._bucket_type).identity_element()\n+\n+  def combine(self, other):\n+    # type: (HistogramCell) -> HistogramCell\n+    result = HistogramCell(self._bucket_type)\n+    result.data = self.data.combine(other.data)\n+    return result\n+\n+  def update(self, value):\n+    self.data.histogram.record(value)\n+\n+  def get_cumulative(self):\n+    # type: () -> HistogramData\n+    return self.data.get_cumulative()\n+\n+  def to_runner_api_monitoring_info(self, name, transform_id):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MTY3Nw==", "bodyText": "Is this class necessary? It seems like it completely defers to HistogramCell, regardless of bucket_type or any parameters. Can it be removed. Do any of the other Cell classes have a Factory like this? I didn't notice this elsewhere.", "url": "https://github.com/apache/beam/pull/13017#discussion_r501391677", "createdAt": "2020-10-08T00:59:39Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/cells.py", "diffHunk": "@@ -238,6 +250,57 @@ def to_runner_api_monitoring_info(self, name, transform_id):\n         ptransform=transform_id)\n \n \n+class HistogramCell(MetricCell):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  Tracks the current value and delta for a histogram metric.\n+\n+  Each cell tracks the state of a metric independently per context per bundle.\n+  Therefore, each metric has a different cell in each bundle, that is later\n+  aggregated.\n+\n+  This class is thread safe since underlying histogram object is thread safe.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._bucket_type = bucket_type\n+    self.data = HistogramAggregator(bucket_type).identity_element()\n+\n+  def reset(self):\n+    self.data = HistogramAggregator(self._bucket_type).identity_element()\n+\n+  def combine(self, other):\n+    # type: (HistogramCell) -> HistogramCell\n+    result = HistogramCell(self._bucket_type)\n+    result.data = self.data.combine(other.data)\n+    return result\n+\n+  def update(self, value):\n+    self.data.histogram.record(value)\n+\n+  def get_cumulative(self):\n+    # type: () -> HistogramData\n+    return self.data.get_cumulative()\n+\n+  def to_runner_api_monitoring_info(self, name, transform_id):\n+    return None\n+\n+\n+class HistogramCellFactory(MetricCellFactory):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MjE3NA==", "bodyText": "Additionally, its not clear to me that MetricCellFactory is necessary", "url": "https://github.com/apache/beam/pull/13017#discussion_r501392174", "createdAt": "2020-10-08T01:01:42Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/cells.py", "diffHunk": "@@ -238,6 +250,57 @@ def to_runner_api_monitoring_info(self, name, transform_id):\n         ptransform=transform_id)\n \n \n+class HistogramCell(MetricCell):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  Tracks the current value and delta for a histogram metric.\n+\n+  Each cell tracks the state of a metric independently per context per bundle.\n+  Therefore, each metric has a different cell in each bundle, that is later\n+  aggregated.\n+\n+  This class is thread safe since underlying histogram object is thread safe.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._bucket_type = bucket_type\n+    self.data = HistogramAggregator(bucket_type).identity_element()\n+\n+  def reset(self):\n+    self.data = HistogramAggregator(self._bucket_type).identity_element()\n+\n+  def combine(self, other):\n+    # type: (HistogramCell) -> HistogramCell\n+    result = HistogramCell(self._bucket_type)\n+    result.data = self.data.combine(other.data)\n+    return result\n+\n+  def update(self, value):\n+    self.data.histogram.record(value)\n+\n+  def get_cumulative(self):\n+    # type: () -> HistogramData\n+    return self.data.get_cumulative()\n+\n+  def to_runner_api_monitoring_info(self, name, transform_id):\n+    return None\n+\n+\n+class HistogramCellFactory(MetricCellFactory):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5MTY3Nw=="}, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NTgzNQ==", "bodyText": "Can you test that this class works if you change the current metric environment. We should make sure that all instances of the metic on all MetricEnvironments will be logged. AS the DelegatingMetric's value changes based on the MetricEnvironment it is set in. I suspect what you are doing works fine, as long as long as you keep a separate timer for each MetricEnvironment. I.e. imagine two transforms with a metirc in two separate MetricEnvironments. If they are sharing the same time in the same MetricLogger, it may log for one metric environment, but not the other one, when it tries to log.\nNote:\n\nEvery time a new bundle is processed, a new MetricEnvironment is created, which will clear the metrics.\nSeparate transforms, or code running in separate threads will store metrics in separate MetricEnvironments\nDelegatingMetrics always use the current MetricEnvironment to store a metric, or get a metric value (This is a thread local variable which is reset when a new bundle is processed, new transform is executing, etc.).", "url": "https://github.com/apache/beam/pull/13017#discussion_r501395835", "createdAt": "2020-10-08T01:17:17Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -293,3 +339,49 @@ def with_steps(self, steps):\n \n     self._steps.update(steps)\n     return self\n+\n+\n+class MetricLogger(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NjIzMQ==", "bodyText": "We should make this clear that this isn't fully supported as a user metric type in the SDK, or in any Runners. We may need to relocate this class from Metrics.histogram to somewhere else i.e. InternalMetrics.histogram\n@pabloem any ideas what we ought to do here? This metric isn't fully implement but the API allows us to log the metric locally.", "url": "https://github.com/apache/beam/pull/13017#discussion_r501396231", "createdAt": "2020-10-08T01:18:59Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -271,6 +276,11 @@ def __init__(self, client=None):\n     # randomized prefix for row IDs.\n     self._row_id_prefix = '' if client else uuid.uuid4()\n     self._temporary_table_suffix = uuid.uuid4().hex\n+    self._latency_histogram_metric = Metrics.histogram(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODU5OTEw", "url": "https://github.com/apache/beam/pull/13017#pullrequestreview-507859910", "createdAt": "2020-10-13T22:01:46Z", "commit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowMTo0NlrOHg7DHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowMTo0NlrOHg7DHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MzkzMw==", "bodyText": "Please move histogram related code into a new 'internal' file\nsdks/python/apache_beam/internal/metrics/metric.py\nPlease move DelegatingHistogram to the new file\nadd a Metric class to the new file, and put the histogram definition there.\nIt can share the infrastructure and call things in this file.", "url": "https://github.com/apache/beam/pull/13017#discussion_r504283933", "createdAt": "2020-10-13T22:01:46Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -139,6 +169,22 @@ def __init__(self, metric_name):\n       super(Metrics.DelegatingGauge, self).__init__(metric_name)\n       self.set = MetricUpdater(cells.GaugeCell, metric_name)  # type: ignore[assignment]\n \n+  class DelegatingHistogram(Histogram):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce5d5a46a4bcb0d484e2322dc6e42a0cd8495992", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/ce5d5a46a4bcb0d484e2322dc6e42a0cd8495992", "committedDate": "2020-10-14T22:13:54Z", "message": "move histogram to internal.metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1666ddee71cb8eac81902175edb07607358700d8", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/1666ddee71cb8eac81902175edb07607358700d8", "committedDate": "2020-10-14T22:42:51Z", "message": "add missing __init__.py"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da9852f5aa799b39a27860ef30f14592d90f4f6", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/2da9852f5aa799b39a27860ef30f14592d90f4f6", "committedDate": "2020-10-15T02:39:48Z", "message": "fix error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b165a8cce07fe74e04866dfc3b7da66e116b5bac", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/b165a8cce07fe74e04866dfc3b7da66e116b5bac", "committedDate": "2020-10-15T19:51:35Z", "message": "fix docstring error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2847795bfd534cb3d612551642c63b90677221a", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/d2847795bfd534cb3d612551642c63b90677221a", "committedDate": "2020-10-15T22:21:15Z", "message": "fix test error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTQ5NDI1", "url": "https://github.com/apache/beam/pull/13017#pullrequestreview-511949425", "createdAt": "2020-10-19T16:33:21Z", "commit": {"oid": "d2847795bfd534cb3d612551642c63b90677221a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozMzoyMVrOHkXTVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNTozMVrOHkXYuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MjU2NQ==", "bodyText": "*modified outside the HistogramCell...", "url": "https://github.com/apache/beam/pull/13017#discussion_r507892565", "createdAt": "2020-10-19T16:33:21Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/internal/metrics/cells.py", "diffHunk": "@@ -0,0 +1,190 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+This file contains internal metric cell classes. A metric cell is used to\n+accumulate in-memory changes to a metric. It represents a specific metric\n+in a single context.\n+\n+For internal use only. No backwards compatibility guarantees.\n+\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from builtins import object\n+from typing import TYPE_CHECKING\n+from typing import Optional\n+\n+from apache_beam.metrics.cells import MetricAggregator\n+from apache_beam.metrics.cells import MetricCell\n+from apache_beam.metrics.cells import MetricCellFactory\n+from apache_beam.utils.histogram import Histogram\n+\n+if TYPE_CHECKING:\n+  from apache_beam.utils.histogram import BucketType\n+\n+\n+class HistogramCell(MetricCell):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  Tracks the current value and delta for a histogram metric.\n+\n+  Each cell tracks the state of a metric independently per context per bundle.\n+  Therefore, each metric has a different cell in each bundle, that is later\n+  aggregated.\n+\n+  This class is thread safe since underlying histogram object is thread safe.\n+  \"\"\"\n+  def __init__(self, bucket_type):\n+    self._bucket_type = bucket_type\n+    self.data = HistogramAggregator(bucket_type).identity_element()\n+\n+  def reset(self):\n+    self.data = HistogramAggregator(self._bucket_type).identity_element()\n+\n+  def combine(self, other):\n+    # type: (HistogramCell) -> HistogramCell\n+    result = HistogramCell(self._bucket_type)\n+    result.data = self.data.combine(other.data)\n+    return result\n+\n+  def update(self, value):\n+    self.data.histogram.record(value)\n+\n+  def get_cumulative(self):\n+    # type: () -> HistogramData\n+    return self.data.get_cumulative()\n+\n+  def to_runner_api_monitoring_info(self, name, transform_id):\n+    # Histogram metric is currently worker-local and internal\n+    # use only. This method should be implemented when runners\n+    # support Histogram metric reporting.\n+    return None\n+\n+\n+class HistogramCellFactory(MetricCellFactory):\n+  def __init__(self, bucket_type):\n+    self._bucket_type = bucket_type\n+\n+  def __call__(self):\n+    return HistogramCell(self._bucket_type)\n+\n+  def __eq__(self, other):\n+    if not isinstance(other, HistogramCellFactory):\n+      return False\n+    return self._bucket_type == other._bucket_type\n+\n+  def __hash__(self):\n+    return hash(self._bucket_type)\n+\n+\n+class HistogramResult(object):\n+  def __init__(self, data):\n+    # type: (HistogramData) -> None\n+    self.data = data\n+\n+  def __eq__(self, other):\n+    if isinstance(other, HistogramResult):\n+      return self.data == other.data\n+    else:\n+      return False\n+\n+  def __hash__(self):\n+    return hash(self.data)\n+\n+  def __ne__(self, other):\n+    # TODO(BEAM-5949): Needed for Python 2 compatibility.\n+    return not self == other\n+\n+  def __repr__(self):\n+    return '<HistogramResult({})>'.format(\n+        self.data.histogram.get_percentile_info())\n+\n+  @property\n+  def p99(self):\n+    return self.data.histogram.p99()\n+\n+  @property\n+  def p95(self):\n+    return self.data.histogram.p95()\n+\n+  @property\n+  def p90(self):\n+    return self.data.histogram.p90()\n+\n+\n+class HistogramData(object):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  The data structure that holds data about a histogram metric.\n+\n+  This object is not thread safe, so it's not supposed to be modified\n+  by other than the HistogramCell that contains it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2847795bfd534cb3d612551642c63b90677221a"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5Mzk0NA==", "bodyText": "Do you know the behaviour here of your change? Like I said, it looks like you will only be logging the state of a metric in the current MetricContainer. Rather then all of the metrics in separate MetricContainers aggregated together into a single value.\nIs there a guarantee that you will log once for every metric container? (I don;'t think so because of the timing logic)", "url": "https://github.com/apache/beam/pull/13017#discussion_r507893944", "createdAt": "2020-10-19T16:35:31Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -293,3 +339,49 @@ def with_steps(self, steps):\n \n     self._steps.update(steps)\n     return self\n+\n+\n+class MetricLogger(object):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NTgzNQ=="}, "originalCommit": {"oid": "6bc49b12c24ca0f0676860fa4b72ed04d90c87a2"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTM2MDk4", "url": "https://github.com/apache/beam/pull/13017#pullrequestreview-513136098", "createdAt": "2020-10-20T21:10:00Z", "commit": {"oid": "d2847795bfd534cb3d612551642c63b90677221a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMToxMDowMFrOHlRNzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMToxMDowMFrOHlRNzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg0MTQyMg==", "bodyText": "So justt o confirm, every time the metric is updated, regardless of which environment is set. Thee same cell will be obtained and updated here. Which aggregates everything in the process together.", "url": "https://github.com/apache/beam/pull/13017#discussion_r508841422", "createdAt": "2020-10-20T21:10:00Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/internal/metrics/metric.py", "diffHunk": "@@ -0,0 +1,138 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+Metrics API classes for internal use only.\n+\n+Users should use apache_beam.metrics.metric package instead.\n+\n+For internal use only. No backwards compatibility guarantees.\n+\"\"\"\n+# pytype: skip-file\n+# mypy: disallow-untyped-defs\n+\n+from __future__ import absolute_import\n+\n+import datetime\n+import logging\n+import threading\n+import time\n+from builtins import object\n+from typing import TYPE_CHECKING\n+from typing import Dict\n+from typing import Optional\n+from typing import Type\n+from typing import Union\n+\n+from apache_beam.internal.metrics.cells import HistogramCellFactory\n+from apache_beam.metrics.execution import MetricUpdater\n+from apache_beam.metrics.metric import Metrics as UserMetrics\n+from apache_beam.metrics.metricbase import Histogram\n+from apache_beam.metrics.metricbase import MetricName\n+\n+if TYPE_CHECKING:\n+  from apache_beam.metrics.cells import MetricCell\n+  from apache_beam.metrics.cells import MetricCellFactory\n+  from apache_beam.utils.histogram import BucketType\n+\n+__all__ = ['Metrics']\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+class Metrics(object):\n+  @staticmethod\n+  def histogram(namespace, name, bucket_type, logger=None):\n+    # type: (Union[Type, str], str, BucketType, Optional[MetricLogger]) -> Metrics.DelegatingHistogram\n+\n+    \"\"\"Obtains or creates a Histogram metric.\n+\n+    Args:\n+      namespace: A class or string that gives the namespace to a metric\n+      name: A string that gives a unique name to a metric\n+      bucket_type: A type of bucket used in a histogram. A subclass of\n+        apache_beam.utils.histogram.BucketType\n+      logger: MetricLogger for logging locally aggregated metric\n+\n+    Returns:\n+      A Histogram object.\n+    \"\"\"\n+    namespace = UserMetrics.get_namespace(namespace)\n+    return Metrics.DelegatingHistogram(\n+        MetricName(namespace, name), bucket_type, logger)\n+\n+  class DelegatingHistogram(Histogram):\n+    \"\"\"Metrics Histogram that Delegates functionality to MetricsEnvironment.\"\"\"\n+    def __init__(self, metric_name, bucket_type, logger):\n+      # type: (MetricName, BucketType, Optional[MetricLogger]) -> None\n+      super(Metrics.DelegatingHistogram, self).__init__(metric_name)\n+      self.metric_name = metric_name\n+      self.cell_type = HistogramCellFactory(bucket_type)\n+      self.logger = logger\n+      self.updater = MetricUpdater(self.cell_type, self.metric_name)\n+\n+    def update(self, value):\n+      # type: (object) -> None\n+      self.updater(value)\n+      if self.logger:\n+        self.logger.update(self.cell_type, self.metric_name, value)\n+\n+\n+class MetricLogger(object):\n+  \"\"\"Simple object to locally aggregate and log metrics.\n+\n+  This class is experimental. No backwards-compatibility guarantees.\n+  \"\"\"\n+  def __init__(self):\n+    # type: () -> None\n+    self._metric = dict()  # type: Dict[MetricName, MetricCell]\n+    self._lock = threading.Lock()\n+    self._last_logging_millis = int(time.time() * 1000)\n+    self.minimum_logging_frequency_msec = 180000\n+\n+  def update(self, cell_type, metric_name, value):\n+    # type: (Union[Type[MetricCell], MetricCellFactory], MetricName, object) -> None\n+    cell = self._get_metric_cell(cell_type, metric_name)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2847795bfd534cb3d612551642c63b90677221a"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1394529ac9aa140f0e58343d8e9befc3721572", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/cd1394529ac9aa140f0e58343d8e9befc3721572", "committedDate": "2020-10-21T00:51:53Z", "message": "modify the comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2291, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}