{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMDc0ODky", "number": 12782, "title": "[BEAM-10950] Overriding Dataflow Native BQSource.", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-08T14:14:36Z", "url": "https://github.com/apache/beam/pull/12782", "merged": true, "mergeCommit": {"oid": "c0bde2b99a5f62a220bdbf97b1df24ce6990783e"}, "closed": true, "closedAt": "2020-09-23T23:29:02Z", "author": {"login": "pabloem"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG4RF4AH2gAyNDgyMDc0ODkyOjZkYTBiNDZkMGQ5NjEwYzIwMjJlYWJkZThjZjQ0YWQwODQ1MmRiMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL0CUgAFqTQ5NTA4MjgwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6da0b46d0d9610c2022eabde8cf44ad08452db07", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/6da0b46d0d9610c2022eabde8cf44ad08452db07", "committedDate": "2020-09-08T14:14:08Z", "message": "Overriding Dataflow Native BQSource."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47dc3e5b16c9a8f6f703d93501d1656dbb351916", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/47dc3e5b16c9a8f6f703d93501d1656dbb351916", "committedDate": "2020-09-09T14:20:43Z", "message": "Fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/85313410da8eb7d03faa6a4b65961a4529f6f737", "committedDate": "2020-09-09T23:39:54Z", "message": "Tryin to fix to_runner_proto transform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTg0Nzgz", "url": "https://github.com/apache/beam/pull/12782#pullrequestreview-488984783", "createdAt": "2020-09-15T19:07:05Z", "commit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTowNzowNVrOHSQPig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxOTowODowOVrOHSQRvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMjUzOA==", "bodyText": "How many of these tests fail if we don't force the native source?", "url": "https://github.com/apache/beam/pull/12782#discussion_r488902538", "createdAt": "2020-09-15T19:07:05Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_test.py", "diffHunk": "@@ -168,7 +168,8 @@ def test_invalid_json_neg_inf(self):\n @unittest.skipIf(HttpError is None, 'GCP dependencies are not installed')\n class TestBigQuerySource(unittest.TestCase):\n   def test_display_data_item_on_validate_true(self):\n-    source = beam.io.BigQuerySource('dataset.table', validate=True)\n+    source = beam.io.BigQuerySource(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzEwMQ==", "bodyText": "Could you file a JIRA to update these to not depend on the deprecated source?", "url": "https://github.com/apache/beam/pull/12782#discussion_r488903101", "createdAt": "2020-09-15T19:08:09Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools_test.py", "diffHunk": "@@ -451,7 +451,9 @@ def test_read_from_table(self):\n     client.jobs.GetQueryResults.return_value = bigquery.GetQueryResultsResponse(\n         jobComplete=True, rows=table_rows, schema=schema)\n     actual_rows = []\n-    with beam.io.BigQuerySource('dataset.table').reader(client) as reader:\n+    with beam.io.BigQuerySource(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aa0a4dc3516941d905e72adf40e512df01e9004", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/6aa0a4dc3516941d905e72adf40e512df01e9004", "committedDate": "2020-09-21T20:22:48Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a2e5e8584dc168246012edfeed3032681fa53df", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/1a2e5e8584dc168246012edfeed3032681fa53df", "committedDate": "2020-09-21T21:10:30Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a", "committedDate": "2020-09-22T19:19:42Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTA1MzEz", "url": "https://github.com/apache/beam/pull/12782#pullrequestreview-494905313", "createdAt": "2020-09-23T17:51:02Z", "commit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzo1MTowMlrOHW55zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDoxMDowNFrOHW_KQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc3OTQwNQ==", "bodyText": "Does this update the sink as well ? If so please update the CL description accordingly.", "url": "https://github.com/apache/beam/pull/12782#discussion_r493779405", "createdAt": "2020-09-23T17:51:02Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_pipeline.py", "diffHunk": "@@ -91,24 +91,16 @@ def run_bq_pipeline(argv=None):\n         use_standard_sql=known_args.use_standard_sql,\n         use_json_exports=known_args.use_json_exports,\n         kms_key=kms_key)\n-  if known_args.native:\n-    _ = data | 'write' >> beam.io.Write(\n-        beam.io.BigQuerySink(\n-            known_args.output,\n-            schema=table_schema,\n-            create_disposition=beam.io.BigQueryDisposition.CREATE_IF_NEEDED,\n-            write_disposition=beam.io.BigQueryDisposition.WRITE_EMPTY,\n-            kms_key=kms_key))\n-  else:\n-    temp_file_format = (\n-        'NEWLINE_DELIMITED_JSON' if known_args.use_json_exports else 'AVRO')\n-    _ = data | 'write' >> beam.io.WriteToBigQuery(\n-        known_args.output,\n-        schema=table_schema,\n-        create_disposition=beam.io.BigQueryDisposition.CREATE_IF_NEEDED,\n-        write_disposition=beam.io.BigQueryDisposition.WRITE_EMPTY,\n-        temp_file_format=temp_file_format,\n-        kms_key=kms_key)\n+\n+  temp_file_format = (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MjQyNg==", "bodyText": "I assume we have the same test coverage for the new source ?", "url": "https://github.com/apache/beam/pull/12782#discussion_r493862426", "createdAt": "2020-09-23T20:04:20Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_test.py", "diffHunk": "@@ -168,7 +168,8 @@ def test_invalid_json_neg_inf(self):\n @unittest.skipIf(HttpError is None, 'GCP dependencies are not installed')\n class TestBigQuerySource(unittest.TestCase):\n   def test_display_data_item_on_validate_true(self):\n-    source = beam.io.BigQuerySource('dataset.table', validate=True)\n+    source = beam.io.BigQuerySource(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMjUzOA=="}, "originalCommit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MzAzNA==", "bodyText": "+1. Any reason why we can use the new source here today ?", "url": "https://github.com/apache/beam/pull/12782#discussion_r493863034", "createdAt": "2020-09-23T20:05:24Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools_test.py", "diffHunk": "@@ -451,7 +451,9 @@ def test_read_from_table(self):\n     client.jobs.GetQueryResults.return_value = bigquery.GetQueryResultsResponse(\n         jobComplete=True, rows=table_rows, schema=schema)\n     actual_rows = []\n-    with beam.io.BigQuerySource('dataset.table').reader(client) as reader:\n+    with beam.io.BigQuerySource(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzEwMQ=="}, "originalCommit": {"oid": "85313410da8eb7d03faa6a4b65961a4529f6f737"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MzQ0NQ==", "bodyText": "This looks pretty awkward but I get the idea. Please add a comment here explaining this.", "url": "https://github.com/apache/beam/pull/12782#discussion_r493863445", "createdAt": "2020-09-23T20:06:16Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/iobase.py", "diffHunk": "@@ -890,6 +890,8 @@ def get_desired_chunk_size(total_size):\n   def expand(self, pbegin):\n     if isinstance(self.source, BoundedSource):\n       return pbegin | _SDFBoundedSourceWrapper(self.source)\n+    elif isinstance(self.source, ptransform.PTransform):\n+      return pbegin.pipeline | self.source", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2NDU1OA==", "bodyText": "Is there any value in maintaining these tests that explicitly check whether a non-default behavior fails for Runner v2 ?", "url": "https://github.com/apache/beam/pull/12782#discussion_r493864558", "createdAt": "2020-09-23T20:08:18Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -269,7 +260,9 @@ def test_biqquery_read_fn_api_fail(self):\n           'apache_beam.io.gcp.bigquery.ReadFromBigQuery.*'):\n         with Pipeline(remote_runner,\n                       PipelineOptions(self.default_properties)) as p:\n-          _ = p | beam.io.Read(beam.io.BigQuerySource('some.table'))\n+          _ = p | beam.io.Read(\n+              beam.io.BigQuerySource(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2NTUzNg==", "bodyText": "I assume the state is following.\n(1) We have full test coverage for the new source (which is the default)\n(2) We have additional tests that check old native source which can be just removed whenever we discontinue support for that source.", "url": "https://github.com/apache/beam/pull/12782#discussion_r493865536", "createdAt": "2020-09-23T20:10:04Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -323,7 +316,9 @@ def test_no_group_by_key_directly_after_bigquery(self):\n                          options=PipelineOptions(self.default_properties)) as p:\n         # pylint: disable=expression-not-assigned\n         p | beam.io.Read(\n-            beam.io.BigQuerySource('dataset.faketable')) | beam.GroupByKey()\n+            beam.io.BigQuerySource(\n+                'dataset.faketable',\n+                use_dataflow_native_source=True)) | beam.GroupByKey()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08bb0a36d7cc9a44ab1d67aeead23372e2bd4f6a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0d1ddae47920cacca6481313e1abfbb44c5f36d", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/c0d1ddae47920cacca6481313e1abfbb44c5f36d", "committedDate": "2020-09-23T22:00:57Z", "message": "adding comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDgyODAz", "url": "https://github.com/apache/beam/pull/12782#pullrequestreview-495082803", "createdAt": "2020-09-23T22:08:00Z", "commit": {"oid": "c0d1ddae47920cacca6481313e1abfbb44c5f36d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4686, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}