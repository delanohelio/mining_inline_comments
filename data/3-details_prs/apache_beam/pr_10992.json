{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDcyMTk1", "number": 10992, "title": "[BEAM-2939] Provide user facing API for reporting the watermark in SplittableDoFns.", "bodyText": "See this doc and blog for some context about SplittableDoFns.\nTo support watermark reporting within the Java SDK for SplittableDoFns, we need a way to have SDF authors to report watermark estimates over the element and restriction pair that they are processing.\nFor UnboundedSources, it was found to be a pain point to ask each SDF author to write their own watermark estimation which typically prevented re-use. Therefore we would like to have a \"library\" of watermark estimators that help SDF authors perform this estimation similar to how there is a \"library\" of restrictions and restriction trackers that SDF authors can use. For SDF authors where the existing library doesn't work, they can add additional ones that observe timestamps of elements or choose to directly report the watermark through a \"ManualWatermarkEstimator\" parameter that can be supplied to @ProcessElement methods.\nThe public facing portion of the DoFn changes adds three new annotations for new DoFn style methods:GetInitialWatermarkEstimatorState: Returns the initial watermark state, similar to GetInitialRestrictionGetWatermarkEstimatorStateCoder: Returns a coder compatible with watermark state type, similar to GetRestrictionCoder for restrictions returned by GetInitialRestriction.NewWatermarkEstimator: Returns a watermark estimator that either the framework invokes allowing it to observe the timestamps of output records or a manual watermark estimator that can be explicitly\u00a0invoked to update the watermark.\nThis PR contains the public facing additions to the core Java API.\nThis mirrors a bunch of work that was done by Boyuan within the Pyhon SDK [pr/9794, pr/10375] but in the style of new DoFn parameter/method invocation we have in the Java SDK.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-27T21:04:02Z", "url": "https://github.com/apache/beam/pull/10992", "merged": true, "mergeCommit": {"oid": "feefaca793d8358d5386d0725863c03e4e37b5b1"}, "closed": true, "closedAt": "2020-03-13T17:16:36Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIh3xuABqjMwNzk1MDAwMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNSZgfgFqTM3NDM2Mjg2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2eeda20a485197e1fcbdc1c04a0d553def4a8bc6", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/2eeda20a485197e1fcbdc1c04a0d553def4a8bc6", "committedDate": "2020-02-27T21:00:30Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "fc3a17a26e8222d4054dede44c9b73d40eeee1f1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/fc3a17a26e8222d4054dede44c9b73d40eeee1f1", "committedDate": "2020-02-27T21:04:58Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc3a17a26e8222d4054dede44c9b73d40eeee1f1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/fc3a17a26e8222d4054dede44c9b73d40eeee1f1", "committedDate": "2020-02-27T21:04:58Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "f96ecbeb5f6d1ff2c7824318468d14acfa09613e", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f96ecbeb5f6d1ff2c7824318468d14acfa09613e", "committedDate": "2020-02-27T21:47:28Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f96ecbeb5f6d1ff2c7824318468d14acfa09613e", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f96ecbeb5f6d1ff2c7824318468d14acfa09613e", "committedDate": "2020-02-27T21:47:28Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "f8ac3c10ef128d2f1fd186f801820c31f520ae59", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f8ac3c10ef128d2f1fd186f801820c31f520ae59", "committedDate": "2020-02-27T21:52:42Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8ac3c10ef128d2f1fd186f801820c31f520ae59", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f8ac3c10ef128d2f1fd186f801820c31f520ae59", "committedDate": "2020-02-27T21:52:42Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "36fc1949e88a843efb6dc41a1bf8fcd82bdccfec", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/36fc1949e88a843efb6dc41a1bf8fcd82bdccfec", "committedDate": "2020-02-27T22:11:35Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36fc1949e88a843efb6dc41a1bf8fcd82bdccfec", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/36fc1949e88a843efb6dc41a1bf8fcd82bdccfec", "committedDate": "2020-02-27T22:11:35Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "36a24e0799f51b7a57e890a2458ae98446a7a5ed", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/36a24e0799f51b7a57e890a2458ae98446a7a5ed", "committedDate": "2020-02-27T22:13:04Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36a24e0799f51b7a57e890a2458ae98446a7a5ed", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/36a24e0799f51b7a57e890a2458ae98446a7a5ed", "committedDate": "2020-02-27T22:13:04Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "18560537b5a48f0cddf566af1592bef504436ce1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/18560537b5a48f0cddf566af1592bef504436ce1", "committedDate": "2020-02-27T22:40:50Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18560537b5a48f0cddf566af1592bef504436ce1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/18560537b5a48f0cddf566af1592bef504436ce1", "committedDate": "2020-02-27T22:40:50Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "90f9e64922e450fed0631dc86db5b51b683cc4ac", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/90f9e64922e450fed0631dc86db5b51b683cc4ac", "committedDate": "2020-02-27T22:42:31Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90f9e64922e450fed0631dc86db5b51b683cc4ac", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/90f9e64922e450fed0631dc86db5b51b683cc4ac", "committedDate": "2020-02-27T22:42:31Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "fb42666a4e1aec0413f161c742d8f010ef9fe9f2", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/fb42666a4e1aec0413f161c742d8f010ef9fe9f2", "committedDate": "2020-02-27T22:52:12Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb42666a4e1aec0413f161c742d8f010ef9fe9f2", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/fb42666a4e1aec0413f161c742d8f010ef9fe9f2", "committedDate": "2020-02-27T22:52:12Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}, "afterCommit": {"oid": "5a180277f14bea5a7daaa37600a4f3dad4098d26", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/5a180277f14bea5a7daaa37600a4f3dad4098d26", "committedDate": "2020-03-10T22:17:07Z", "message": "[BEAM-2939] Add support for reporting the watermark in SplittableDoFns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feea2ba610aa35344d30bae23a76d18e7b6afe93", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/feea2ba610aa35344d30bae23a76d18e7b6afe93", "committedDate": "2020-03-13T03:17:38Z", "message": "[BEAM-2939] Implement interfaces and concrete watermark estimators\n\nPlumb watermark estimator, watermark estimator state, and watermark estimator state coder methods through ByteBuddy DoFnInvoker adding method definitions to DoFnSignature and appropriate validation.\n\nThis does not update any of the existing Splittable Dofns to use these watermark estimators or any existing Splittable DoFn \"runners\" (beyond adding throws unsupported operations exception). This is marked as work under BEAM-9430."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e028e0e992c99bb12f31a672e8f8f2929a336f6d", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/e028e0e992c99bb12f31a672e8f8f2929a336f6d", "committedDate": "2020-03-13T00:18:25Z", "message": "Add a bunch of tests."}, "afterCommit": {"oid": "feea2ba610aa35344d30bae23a76d18e7b6afe93", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/feea2ba610aa35344d30bae23a76d18e7b6afe93", "committedDate": "2020-03-13T03:17:38Z", "message": "[BEAM-2939] Implement interfaces and concrete watermark estimators\n\nPlumb watermark estimator, watermark estimator state, and watermark estimator state coder methods through ByteBuddy DoFnInvoker adding method definitions to DoFnSignature and appropriate validation.\n\nThis does not update any of the existing Splittable Dofns to use these watermark estimators or any existing Splittable DoFn \"runners\" (beyond adding throws unsupported operations exception). This is marked as work under BEAM-9430."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzYyODYy", "url": "https://github.com/apache/beam/pull/10992#pullrequestreview-374362862", "createdAt": "2020-03-13T14:51:16Z", "commit": {"oid": "feea2ba610aa35344d30bae23a76d18e7b6afe93"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDo1MToxN1rOF2GoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNDo1MToxN1rOF2GoFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3NTk4OA==", "bodyText": "Note that this terminology deviates from the current getCheckpointMark(). I like it though.", "url": "https://github.com/apache/beam/pull/10992#discussion_r392275988", "createdAt": "2020-03-13T14:51:17Z", "author": {"login": "mxm"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -1070,6 +1091,120 @@ public Duration getAllowedTimestampSkew() {\n   @Experimental(Kind.SPLITTABLE_DO_FN)\n   public @interface NewTracker {}\n \n+  /**\n+   * Annotation for the method that maps an element and restriction to initial watermark estimator\n+   * state for a <a href=\"https://s.apache.org/splittable-do-fn\">splittable</a> {@link DoFn}.\n+   *\n+   * <p>Signature: {@code WatermarkEstimatorStateT getInitialWatermarkState(<arguments>);}\n+   *\n+   * <p>This method must satisfy the following constraints:\n+   *\n+   * <ul>\n+   *   <li>The return type {@code WatermarkEstimatorStateT} defines the watermark state type used\n+   *       within this splittable DoFn. All other methods that use a {@link\n+   *       WatermarkEstimatorState @WatermarkEstimatorState} parameter must use the same type that\n+   *       is used here. It is suggested to use as narrow of a return type definition as possible\n+   *       (for example prefer to use a square type over a shape type as a square is a type of a\n+   *       shape).\n+   *   <li>If one of its arguments is tagged with the {@link Element} annotation, then it will be\n+   *       passed the current element being processed; the argument must be of type {@code InputT}.\n+   *       Note that automatic conversion of {@link Row}s and {@link FieldAccess} parameters are\n+   *       currently unsupported.\n+   *   <li>If one of its arguments is tagged with the {@link Restriction} annotation, then it will\n+   *       be passed the current restriction being processed; the argument must be of type {@code\n+   *       RestrictionT}.\n+   *   <li>If one of its arguments is tagged with the {@link Timestamp} annotation, then it will be\n+   *       passed the timestamp of the current element being processed; the argument must be of type\n+   *       {@link Instant}.\n+   *   <li>If one of its arguments is a subtype of {@link BoundedWindow}, then it will be passed the\n+   *       window of the current element. When applied by {@link ParDo} the subtype of {@link\n+   *       BoundedWindow} must match the type of windows on the input {@link PCollection}. If the\n+   *       window is not accessed a runner may perform additional optimizations.\n+   *   <li>If one of its arguments is of type {@link PaneInfo}, then it will be passed information\n+   *       about the current triggering pane.\n+   *   <li>If one of the parameters is of type {@link PipelineOptions}, then it will be passed the\n+   *       options for the current pipeline.\n+   * </ul>\n+   */\n+  @Documented\n+  @Retention(RetentionPolicy.RUNTIME)\n+  @Target(ElementType.METHOD)\n+  @Experimental(Kind.SPLITTABLE_DO_FN)\n+  public @interface GetInitialWatermarkEstimatorState {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feea2ba610aa35344d30bae23a76d18e7b6afe93"}, "originalPosition": 116}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2981, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}