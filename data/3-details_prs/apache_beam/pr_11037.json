{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjgzNjkz", "number": 11037, "title": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism", "bodyText": "The implemented solution consists in an extension of the FileSystem classes for S3, that allows filtering of the matched objects. The filter consists in a mod hash function of the filename.\nThis mechanism is exploited by a parallel partitioned read of the files in the bucket, realised in the AvroIO and FileIO classes by means of the new hint . withHintPartitionInto(int)\nThe net effect is that a controlled number of tasks is spawn to different executors, each having a different partition number; each executor reads the entire list of files in the bucket, but matches only those files whose modhash matches the partition number.\nIn this way, all the executors in the cluster read in parallel.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-04T01:13:00Z", "url": "https://github.com/apache/beam/pull/11037", "merged": true, "mergeCommit": {"oid": "5e6ba4f10320559ff17c6279fdfec81cf603b005"}, "closed": true, "closedAt": "2020-04-07T06:59:39Z", "author": {"login": "ecapoccia"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU0chVgFqTM4Nzg5MDY0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVNvZvAFqTM4ODgzMjc5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODkwNjQx", "url": "https://github.com/apache/beam/pull/11037#pullrequestreview-387890641", "createdAt": "2020-04-06T01:30:47Z", "commit": {"oid": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMTozMDo0N1rOGBFV0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMTozMDo0N1rOGBFV0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc4OTI2NQ==", "bodyText": "I believe we should do the same thing in the streaming and batch portable pipeline translators as well.", "url": "https://github.com/apache/beam/pull/11037#discussion_r403789265", "createdAt": "2020-04-06T01:30:47Z", "author": {"login": "lukecwik"}, "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/translation/TransformTranslator.java", "diffHunk": "@@ -695,8 +695,10 @@ public void evaluate(Reshuffle<K, V> transform, EvaluationContext context) {\n         final WindowedValue.WindowedValueCoder<KV<K, V>> wvCoder =\n             WindowedValue.FullWindowedValueCoder.of(coder, windowFn.windowCoder());\n \n+        int numPartitions =\n+            Math.max(context.getSparkContext().defaultParallelism(), inRDD.getNumPartitions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MjAyMDM2", "url": "https://github.com/apache/beam/pull/11037#pullrequestreview-388202036", "createdAt": "2020-04-06T12:31:26Z", "commit": {"oid": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjozMToyNlrOGBVdlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjozMToyNlrOGBVdlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1MzM5Ng==", "bodyText": "Can you please let this method how it was before and better, and do int numPartitions = Math.max(rdd.context().defaultParallelism(), rdd.getNumPartitions()); inside of it. That way you don't need to replicate the change in the different translators..", "url": "https://github.com/apache/beam/pull/11037#discussion_r404053396", "createdAt": "2020-04-06T12:31:26Z", "author": {"login": "iemejia"}, "path": "runners/spark/src/main/java/org/apache/beam/runners/spark/translation/GroupCombineFunctions.java", "diffHunk": "@@ -184,11 +184,11 @@\n \n   /** An implementation of {@link Reshuffle} for the Spark runner. */\n   public static <T> JavaRDD<WindowedValue<T>> reshuffle(\n-      JavaRDD<WindowedValue<T>> rdd, WindowedValueCoder<T> wvCoder) {\n+      JavaRDD<WindowedValue<T>> rdd, WindowedValueCoder<T> wvCoder, int numPartitions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0d2620749518eaa08ffcb046ea9bf31bed55ff7"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ad6bc7113db8287765b8c4fafaa5ea900d286a", "author": {"user": {"login": "ecapoccia", "name": "Emiliano Capoccia"}}, "url": "https://github.com/apache/beam/commit/62ad6bc7113db8287765b8c4fafaa5ea900d286a", "committedDate": "2020-04-06T22:56:12Z", "message": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b37c5d661899f61187f829c0c03b2316dfe81afa", "author": {"user": {"login": "ecapoccia", "name": "Emiliano Capoccia"}}, "url": "https://github.com/apache/beam/commit/b37c5d661899f61187f829c0c03b2316dfe81afa", "committedDate": "2020-04-06T22:43:34Z", "message": "[BEAM-9434] - merge master into branch"}, "afterCommit": {"oid": "62ad6bc7113db8287765b8c4fafaa5ea900d286a", "author": {"user": {"login": "ecapoccia", "name": "Emiliano Capoccia"}}, "url": "https://github.com/apache/beam/commit/62ad6bc7113db8287765b8c4fafaa5ea900d286a", "committedDate": "2020-04-06T22:56:12Z", "message": "[BEAM-9434] Improve Spark runner reshuffle translation to maximize parallelism"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODMyNzky", "url": "https://github.com/apache/beam/pull/11037#pullrequestreview-388832792", "createdAt": "2020-04-07T06:59:02Z", "commit": {"oid": "62ad6bc7113db8287765b8c4fafaa5ea900d286a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2996, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}