{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NTg1Njk2", "number": 10847, "title": "[BEAM-9228] Support further partition for FnApi ListBuffer", "bodyText": "A ListBuffer is partitioned when len(input) >= number of workers. This prevents parallelism for some transforms, like SDF. The PR supports further partitioning of the ListBuffer when len(input) < number of workers.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-12T23:09:21Z", "url": "https://github.com/apache/beam/pull/10847", "merged": true, "mergeCommit": {"oid": "9fa98cee389c1c93f9495f83e3f9e790bfaccdf2"}, "closed": true, "closedAt": "2020-02-25T00:28:51Z", "author": {"login": "Hannah-Jiang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDz-t3gBqjMwMzM0NjM3MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHmrwIAFqTM2Mzc4ODM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa970b7d8a281346285eaa49d9ddad2ef0e085d3", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/aa970b7d8a281346285eaa49d9ddad2ef0e085d3", "committedDate": "2020-02-13T05:02:36Z", "message": "remove input_coder=coder"}, "afterCommit": {"oid": "5d10ae7044c5df896eb0916cdb724d8f28053a37", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/5d10ae7044c5df896eb0916cdb724d8f28053a37", "committedDate": "2020-02-13T05:20:46Z", "message": "[BEAM-9228] support futher partition for _ListBuffer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/f8a12543649cfa982ff95317a8cf3a6a1c8c5b44", "committedDate": "2020-02-13T05:36:39Z", "message": "[BEAM-9228] support futher partition for _ListBuffer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d10ae7044c5df896eb0916cdb724d8f28053a37", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/5d10ae7044c5df896eb0916cdb724d8f28053a37", "committedDate": "2020-02-13T05:20:46Z", "message": "[BEAM-9228] support futher partition for _ListBuffer"}, "afterCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/f8a12543649cfa982ff95317a8cf3a6a1c8c5b44", "committedDate": "2020-02-13T05:36:39Z", "message": "[BEAM-9228] support futher partition for _ListBuffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDQ4MTg5", "url": "https://github.com/apache/beam/pull/10847#pullrequestreview-358448189", "createdAt": "2020-02-13T18:24:03Z", "commit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoyNDowM1rOFpepRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODozNjoyNFrOFpfDGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzODAyMg==", "bodyText": "You can replace this for loop with self._grouped_output = [output_stream.get() for output_stream in output_stream_list] and omit the assignment above. Similarly, above, you can write output_stream_list = [create_OutputStream() for _ in range(n)].", "url": "https://github.com/apache/beam/pull/10847#discussion_r379038022", "createdAt": "2020-02-13T18:24:03Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -285,11 +285,50 @@ def partition(self, n):\n     pass\n \n \n-class _ListBuffer(List[bytes]):\n+class _ListBuffer():\n   \"\"\"Used to support parititioning of a list.\"\"\"\n+  def __init__(self, input_coder):\n+    self._input_coder = input_coder\n+    self._inputs = []\n+    self._grouped_output = None\n+    self.cleared = False\n+\n+  def append(self, element):\n+    if self._grouped_output:\n+      raise RuntimeError('ListBuffer append after read.')\n+    self._inputs.append(element)\n+\n   def partition(self, n):\n     # type: (int) -> List[List[bytes]]\n-    return [self[k::n] for k in range(n)]\n+    if len(self._inputs) >= n or len(self._inputs) == 0:\n+      return [self._inputs[k::n] for k in range(n)]\n+    else:\n+      if not self._grouped_output:\n+        self._grouped_output = [[] for _ in range(n)]\n+        coder_impl = self._input_coder.get_impl()\n+        decoded_input = []\n+        output_stream_list = []\n+        for _ in range(n):\n+          output_stream_list.append(create_OutputStream())\n+        for input in self._inputs:\n+          input_stream = create_InputStream(input)\n+          while input_stream.size() > 0:\n+            decoded_value = coder_impl.decode_from_stream(input_stream, True)\n+            decoded_input.append(decoded_value)\n+        for idx, v in enumerate(decoded_input):\n+          coder_impl.encode_to_stream(v, output_stream_list[idx % n], True)\n+        for ix, output_stream in enumerate(output_stream_list):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzOTA2MA==", "bodyText": "Rather than creating an in-memory list of all decoded inputs, just append decoded_value to one of the output streams here (incrementing a counter to round-robin).", "url": "https://github.com/apache/beam/pull/10847#discussion_r379039060", "createdAt": "2020-02-13T18:26:02Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -285,11 +285,50 @@ def partition(self, n):\n     pass\n \n \n-class _ListBuffer(List[bytes]):\n+class _ListBuffer():\n   \"\"\"Used to support parititioning of a list.\"\"\"\n+  def __init__(self, input_coder):\n+    self._input_coder = input_coder\n+    self._inputs = []\n+    self._grouped_output = None\n+    self.cleared = False\n+\n+  def append(self, element):\n+    if self._grouped_output:\n+      raise RuntimeError('ListBuffer append after read.')\n+    self._inputs.append(element)\n+\n   def partition(self, n):\n     # type: (int) -> List[List[bytes]]\n-    return [self[k::n] for k in range(n)]\n+    if len(self._inputs) >= n or len(self._inputs) == 0:\n+      return [self._inputs[k::n] for k in range(n)]\n+    else:\n+      if not self._grouped_output:\n+        self._grouped_output = [[] for _ in range(n)]\n+        coder_impl = self._input_coder.get_impl()\n+        decoded_input = []\n+        output_stream_list = []\n+        for _ in range(n):\n+          output_stream_list.append(create_OutputStream())\n+        for input in self._inputs:\n+          input_stream = create_InputStream(input)\n+          while input_stream.size() > 0:\n+            decoded_value = coder_impl.decode_from_stream(input_stream, True)\n+            decoded_input.append(decoded_value)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzOTQ4Mg==", "bodyText": "Can you simply return iter(self._inputs)?", "url": "https://github.com/apache/beam/pull/10847#discussion_r379039482", "createdAt": "2020-02-13T18:26:50Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -285,11 +285,50 @@ def partition(self, n):\n     pass\n \n \n-class _ListBuffer(List[bytes]):\n+class _ListBuffer():\n   \"\"\"Used to support parititioning of a list.\"\"\"\n+  def __init__(self, input_coder):\n+    self._input_coder = input_coder\n+    self._inputs = []\n+    self._grouped_output = None\n+    self.cleared = False\n+\n+  def append(self, element):\n+    if self._grouped_output:\n+      raise RuntimeError('ListBuffer append after read.')\n+    self._inputs.append(element)\n+\n   def partition(self, n):\n     # type: (int) -> List[List[bytes]]\n-    return [self[k::n] for k in range(n)]\n+    if len(self._inputs) >= n or len(self._inputs) == 0:\n+      return [self._inputs[k::n] for k in range(n)]\n+    else:\n+      if not self._grouped_output:\n+        self._grouped_output = [[] for _ in range(n)]\n+        coder_impl = self._input_coder.get_impl()\n+        decoded_input = []\n+        output_stream_list = []\n+        for _ in range(n):\n+          output_stream_list.append(create_OutputStream())\n+        for input in self._inputs:\n+          input_stream = create_InputStream(input)\n+          while input_stream.size() > 0:\n+            decoded_value = coder_impl.decode_from_stream(input_stream, True)\n+            decoded_input.append(decoded_value)\n+        for idx, v in enumerate(decoded_input):\n+          coder_impl.encode_to_stream(v, output_stream_list[idx % n], True)\n+        for ix, output_stream in enumerate(output_stream_list):\n+          self._grouped_output[ix] = [output_stream.get()]\n+        decoded_input = None\n+      return self._grouped_output\n+\n+  def __iter__(self):\n+    return itertools.chain(*self.partition(1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDgzMA==", "bodyText": "How is a None input coder safe?", "url": "https://github.com/apache/beam/pull/10847#discussion_r379040830", "createdAt": "2020-02-13T18:29:10Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -683,7 +723,7 @@ def _run_bundle_multiple_times_for_testing(\n         worker_handler.state.checkpoint()\n         testing_bundle_manager = ParallelBundleManager(\n             worker_handler_list,\n-            lambda pcoll_id: _ListBuffer(),\n+            lambda pcoll_id, transform_id: _ListBuffer(input_coder=None),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MjU5Ng==", "bodyText": "This is redundant with get_input_coder_impl_callable--either only take the coder-giving one (and call get_impl yourself) or let _ListBuffer take a coder_impl in its construction (which may simplify things elsewhere).", "url": "https://github.com/apache/beam/pull/10847#discussion_r379042596", "createdAt": "2020-02-13T18:32:33Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -728,28 +769,33 @@ def _collect_written_timers_and_add_to_deferred_inputs(\n         for windowed_key_timer in timers_by_key_and_window.values():\n           windowed_timer_coder_impl.encode_to_stream(\n               windowed_key_timer, out, True)\n-        deferred_inputs[transform_id] = _ListBuffer([out.get()])\n-        written_timers[:] = []\n+        deferred_inputs[transform_id] = _ListBuffer(input_coder=coder)\n+        deferred_inputs[transform_id].append(out.get())\n+        written_timers.clear()\n \n   def _add_residuals_and_channel_splits_to_deferred_inputs(\n       self,\n       splits,  # type: List[beam_fn_api_pb2.ProcessBundleSplitResponse]\n-      get_input_coder_callable,\n+      get_input_coder_impl_callable,\n       input_for_callable,\n       last_sent,\n-      deferred_inputs  # type: DefaultDict[str, PartitionableBuffer]\n+      deferred_inputs,  # type: DefaultDict[str, PartitionableBuffer]\n+      get_input_coder_callable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MzY0Nw==", "bodyText": "Do we have to worry about using safe coders here?", "url": "https://github.com/apache/beam/pull/10847#discussion_r379043647", "createdAt": "2020-02-13T18:34:32Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -907,6 +961,12 @@ def get_buffer(buffer_id):\n       if kind in ('materialize', 'timers'):\n         # If `buffer_id` is not a key in `pcoll_buffers`, it will be added by\n         # the `defaultdict`.\n+        if buffer_id not in pcoll_buffers:\n+          coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+              process_bundle_descriptor.transforms[transform_id].spec.payload\n+          ).coder_id\n+          coder = context.coders[coder_id]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 197}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0NDAwNQ==", "bodyText": "safe_coders?", "url": "https://github.com/apache/beam/pull/10847#discussion_r379044005", "createdAt": "2020-02-13T18:35:14Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -937,6 +997,12 @@ def get_input_coder_impl(transform_id):\n               process_bundle_descriptor.transforms[transform_id].spec.payload).\n                       coder_id]].get_impl()\n \n+    def get_input_coder(transform_id):\n+      coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+          process_bundle_descriptor.transforms[transform_id].spec.payload\n+      ).coder_id\n+      return context.coders[coder_id]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0NDYzMw==", "bodyText": "This pattern is repeated a lot, factor out into a method?", "url": "https://github.com/apache/beam/pull/10847#discussion_r379044633", "createdAt": "2020-02-13T18:36:24Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -973,28 +1039,38 @@ def input_for(transform_id, input_id):\n     last_sent = data_input\n \n     while True:\n-      deferred_inputs = collections.defaultdict(\n-          _ListBuffer)  # type: DefaultDict[str, PartitionableBuffer]\n+      deferred_inputs = {}\n \n       self._collect_written_timers_and_add_to_deferred_inputs(\n           context, pipeline_components, stage, get_buffer, deferred_inputs)\n \n       # Queue any process-initiated delayed bundle applications.\n       for delayed_application in last_result.process_bundle.residual_roots:\n-        deferred_inputs[input_for(\n+        name = input_for(\n             delayed_application.application.transform_id,\n-            delayed_application.application.input_id)].append(\n-                delayed_application.application.element)\n-\n+            delayed_application.application.input_id)\n+        if name not in deferred_inputs:\n+          input_pcoll = process_bundle_descriptor.transforms[\n+            delayed_application.application.transform_id].inputs[delayed_application.application.input_id]\n+          coder = context.coders[safe_coders[\n+            pipeline_components.pcollections[input_pcoll].coder_id]]\n+          deferred_inputs[name] = _ListBuffer(input_coder=coder)\n+        deferred_inputs[name].append(delayed_application.application.element)\n       # Queue any runner-initiated delayed bundle applications.\n       self._add_residuals_and_channel_splits_to_deferred_inputs(\n-          splits, get_input_coder_impl, input_for, last_sent, deferred_inputs)\n+          splits, get_input_coder_impl, input_for, last_sent, deferred_inputs,\n+          get_input_coder)\n \n       if deferred_inputs:\n         # The worker will be waiting on these inputs as well.\n         for other_input in data_input:\n           if other_input not in deferred_inputs:\n-            deferred_inputs[other_input] = _ListBuffer([])\n+            outputs = process_bundle_descriptor.transforms[", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a12543649cfa982ff95317a8cf3a6a1c8c5b44"}, "originalPosition": 253}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/4060cbb00e5564b2ac9fe8f8018085f498d2dbe7", "committedDate": "2020-02-15T00:54:00Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d491dd2743eb3ec89e19f7c7ea7fc464c4a0649e", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/d491dd2743eb3ec89e19f7c7ea7fc464c4a0649e", "committedDate": "2020-02-14T18:20:39Z", "message": "fix1 & comment out sdf tests"}, "afterCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/4060cbb00e5564b2ac9fe8f8018085f498d2dbe7", "committedDate": "2020-02-15T00:54:00Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjkwMjU3", "url": "https://github.com/apache/beam/pull/10847#pullrequestreview-359290257", "createdAt": "2020-02-15T00:59:14Z", "commit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDo1OToxNFrOFqHS5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQwMDo1OToxNFrOFqHS5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwNDAzNw==", "bodyText": "coder_id can be retrieved from transform payload most cases, except one following case. It returns '' coder_id.\nThis cause test_checkpoint_sdf test fails. How do we need to handle this case? Other SDF tests should be fixed now.\nspec {\n  urn: \"beam:transform:sdf_process_sized_element_and_restrictions:v1\"\n  payload: \"\\n\\215\\014\\n beam:dofn:pickled_python_info:v1\\032\\350\\013eNp9ldt31FQUxnNmBihpKSCorRdE8TLVOlBaLkXFy0AFI0NNEaJSYiY50wQyyXzJCVKcEVAzxfv9vf0XXcu1fPDBfc5MVy9QXmbNuezz/fa39zm5Wyy7XhCGFVv+6rabcEdwWyy2uA5t41oYO15/hVklTdPkfxRyFE2UrCGaOBtlTZ7QAXNeA9tcp+W4Prfr3GlWROJEaSNOmmnFjROun4lnIh3bc+zoYKBs6RRt283Yy0Ju29hpDfQmnCCioW7toGEriV2ephh8GHEji1wRxHTmUNlnKrwae/ySRNyVY9jE7rJRNDRjm1EyJqszC1qn2C4sayvaddYp3Rqn/4V2aYUlp9rF5WKbtUuNwgpj2n1tubSiMa1d8tgJrVPCnitau3iZZjxtTsOemsG62Fu29pGgmyUJj4Sd8FQkgcLBY9Y2WkmFkwjss3ZK15JF2w2doIn91nYaO60Wjzw8rhaDiPJp0iF4QuDJsrI55WEDI8oCHvYWR5XeOh2b/HVv8ARPqX0itnkzEHjaKva48IzAs0ou9RqV1iIO+IMXNFYd1kolprMhNswG2FABz1m712RsN84iQYcezPH8mMALJg65tl3PglDIuuirBdL9wUcW2zbXSGXhZ53Eaep4ceweXurg5bK1f1M2VOqbgUfKr/ha2S9Ze9c31+zqYvmRous0VyN0jOV4tYPXyv5OX1ceBlEgAifcULNxn3qI2qVA7VKgdpmrDgltmXmszVYKVPTXa4bWReUB6n4NUhy2BmnpYqORcmE60QLHkS4m/BF/tIuj/gF/3Pi7WtAYJsfI1SkTx7ZwdbxW6+B4TeCEiZPWsCxl/372qz29gbRIpLokJU5GnKdqOd7wD1sjazBrtJf6R7zZxVv+iAJe78HpLt4m0mnjH0X6jiR918R7W5BOS9IqkZ4xcbbX8q2QGnCmDyhvXtFgBLi9XViQcO8T3Lkx6Yl/egnnSWvG+Je0CvhAahkmPtxCa0ZqXSCtmomL1p5NRUiD2xyzG2QLJDvQu+wk/BEJm72LJbfO5bi0SvExUcwa/6mML0uKKyasLShmJcUnRPGpic/UpbNtL6bNuFqzdqlhGsYicpo8pcn5eVzLBGwTn1PXO+qBaslrYAce6tYhGq5vWLlSfqDjx+Bm9Rzewx5Al9MAvJ84o8QZJV6tDgitrY3KxBuU+II1KtFagXsj5J696aKn8HMEyhvJjes5bqx/NMJedBb14jeHo3nhGlPmRdK82ERrC/Oa0jyQeYmJ1DpIh04frfOTE8ecqfqkNzVVn6jzqSMnjx6ZPO5OT7j82AREjszEzRxfmLiVY7GD2xT/pYm2f7Xmk70d1cPqA2X7QSRSfPUwn2RinshaIX3G7qiQ8xflV+KcCrmrZoKolQl1Uop76ssWZ2Jt6mvlSZwEC0GEb5bwrcpgw1tE+xRDxeP0GDkiJm/zJXRNLNVq87i/hO9MfE8N8YOJH6khfurg5wf4f/HV5l+X8JuJ39P6PP7o4M8apf1X5X8g4Xjr0\\001:\\037ref_Coder_FastPrimitivesCoder_4\"\n}\ninputs {\n  key: \"0\"\n  value: \"ref_PCollection_PCollection_3_split\"\n}\noutputs {\n  key: \"None\"\n  value: \"ref_PCollection_PCollection_4\"\n}\nunique_name: \"SDF/Process\"\nenvironment_id: \"ref_Environment_default_environment_1\"", "url": "https://github.com/apache/beam/pull/10847#discussion_r379704037", "createdAt": "2020-02-15T00:59:14Z", "author": {"login": "Hannah-Jiang"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -932,10 +998,14 @@ def get_buffer(buffer_id):\n       return pcoll_buffers[buffer_id]\n \n     def get_input_coder_impl(transform_id):\n-      return context.coders[\n-          safe_coders[beam_fn_api_pb2.RemoteGrpcPort.FromString(\n-              process_bundle_descriptor.transforms[transform_id].spec.payload).\n-                      coder_id]].get_impl()\n+      coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+          process_bundle_descriptor.transforms[transform_id].spec.payload).\\\n+        coder_id\n+      assert coder_id is not None and coder_id != ''", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "originalPosition": 242}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzcyMjE0", "url": "https://github.com/apache/beam/pull/10847#pullrequestreview-360772214", "createdAt": "2020-02-19T00:37:46Z", "commit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDozNzo0NlrOFrXazA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDo0NTo1N1rOFrXjfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNjc4MA==", "bodyText": "I meant you could put this instead of the loop at line 324.", "url": "https://github.com/apache/beam/pull/10847#discussion_r381016780", "createdAt": "2020-02-19T00:37:46Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -287,43 +287,48 @@ def partition(self, n):\n \n class _ListBuffer():\n   \"\"\"Used to support parititioning of a list.\"\"\"\n-  def __init__(self, input_coder):\n-    self._input_coder = input_coder\n+  def __init__(self, coder_impl):\n+    self._coder_impl = coder_impl\n     self._inputs = []\n     self._grouped_output = None\n     self.cleared = False\n \n   def append(self, element):\n+    if self.cleared:\n+      raise RuntimeError('Trying to append to a cleared ListBuffer.')\n     if self._grouped_output:\n       raise RuntimeError('ListBuffer append after read.')\n     self._inputs.append(element)\n \n   def partition(self, n):\n     # type: (int) -> List[List[bytes]]\n+    if self.cleared:\n+      raise RuntimeError('Trying to partition a cleared ListBuffer.')\n     if len(self._inputs) >= n or len(self._inputs) == 0:\n       return [self._inputs[k::n] for k in range(n)]\n     else:\n       if not self._grouped_output:\n-        self._grouped_output = [[] for _ in range(n)]\n-        coder_impl = self._input_coder.get_impl()\n-        decoded_input = []\n-        output_stream_list = []\n-        for _ in range(n):\n-          output_stream_list.append(create_OutputStream())\n+        output_stream_list = [create_OutputStream() for _ in range(n)]\n+        self._grouped_output = [output_stream.get() for output_stream", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNzg5NQ==", "bodyText": "You can now revert the changes up at the top of the loop.", "url": "https://github.com/apache/beam/pull/10847#discussion_r381017895", "createdAt": "2020-02-19T00:41:50Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -769,7 +774,7 @@ def _collect_written_timers_and_add_to_deferred_inputs(\n         for windowed_key_timer in timers_by_key_and_window.values():\n           windowed_timer_coder_impl.encode_to_stream(\n               windowed_key_timer, out, True)\n-        deferred_inputs[transform_id] = _ListBuffer(input_coder=coder)\n+        deferred_inputs[transform_id] = _ListBuffer(coder_impl=coder.get_impl())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxODQ3MQ==", "bodyText": "Lint: don't use backslashes for continuation. (These days you can just run yapf to format your code, see https://cwiki.apache.org/confluence/display/BEAM/Python+Tips.)", "url": "https://github.com/apache/beam/pull/10847#discussion_r381018471", "createdAt": "2020-02-19T00:44:00Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -932,10 +998,14 @@ def get_buffer(buffer_id):\n       return pcoll_buffers[buffer_id]\n \n     def get_input_coder_impl(transform_id):\n-      return context.coders[\n-          safe_coders[beam_fn_api_pb2.RemoteGrpcPort.FromString(\n-              process_bundle_descriptor.transforms[transform_id].spec.payload).\n-                      coder_id]].get_impl()\n+      coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+          process_bundle_descriptor.transforms[transform_id].spec.payload).\\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "originalPosition": 240}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxOTAwNg==", "bodyText": "OK, in the SDF case we can get the coder of the preceding transform (the one that produces its input ref_PCollection_PCollection_3_split) which should always be a RemoteGrpcPort.", "url": "https://github.com/apache/beam/pull/10847#discussion_r381019006", "createdAt": "2020-02-19T00:45:57Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -932,10 +998,14 @@ def get_buffer(buffer_id):\n       return pcoll_buffers[buffer_id]\n \n     def get_input_coder_impl(transform_id):\n-      return context.coders[\n-          safe_coders[beam_fn_api_pb2.RemoteGrpcPort.FromString(\n-              process_bundle_descriptor.transforms[transform_id].spec.payload).\n-                      coder_id]].get_impl()\n+      coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+          process_bundle_descriptor.transforms[transform_id].spec.payload).\\\n+        coder_id\n+      assert coder_id is not None and coder_id != ''", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTcwNDAzNw=="}, "originalCommit": {"oid": "4060cbb00e5564b2ac9fe8f8018085f498d2dbe7"}, "originalPosition": 242}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d9e38e74b1c32313d905cd86c66b0e1fc0f6bfb", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/9d9e38e74b1c32313d905cd86c66b0e1fc0f6bfb", "committedDate": "2020-02-20T17:52:45Z", "message": "fixup"}, "afterCommit": {"oid": "2bebee2c4109da99c92af331518684f840091ae2", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/2bebee2c4109da99c92af331518684f840091ae2", "committedDate": "2020-02-20T19:05:28Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b0ee79d492aeeac5c786391e9c7fd81dd6c9806", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/8b0ee79d492aeeac5c786391e9c7fd81dd6c9806", "committedDate": "2020-02-20T20:51:20Z", "message": "fixup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bebee2c4109da99c92af331518684f840091ae2", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/2bebee2c4109da99c92af331518684f840091ae2", "committedDate": "2020-02-20T19:05:28Z", "message": "fixup"}, "afterCommit": {"oid": "8b0ee79d492aeeac5c786391e9c7fd81dd6c9806", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/8b0ee79d492aeeac5c786391e9c7fd81dd6c9806", "committedDate": "2020-02-20T20:51:20Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzg4Mzc3", "url": "https://github.com/apache/beam/pull/10847#pullrequestreview-363788377", "createdAt": "2020-02-25T00:05:28Z", "commit": {"oid": "8b0ee79d492aeeac5c786391e9c7fd81dd6c9806"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMDowNToyOFrOFt0TZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMDowNzoxOVrOFt0VoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NzE3Mg==", "bodyText": "An alternative would be safe_coders.get(coder_id, coder_id) which means look up the key (first argument) and if it doesn't exist return the second argument. This would eliminate some of the repetition of logic between the lines as well.", "url": "https://github.com/apache/beam/pull/10847#discussion_r383587172", "createdAt": "2020-02-25T00:05:28Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -932,10 +994,14 @@ def get_buffer(buffer_id):\n       return pcoll_buffers[buffer_id]\n \n     def get_input_coder_impl(transform_id):\n-      return context.coders[\n-          safe_coders[beam_fn_api_pb2.RemoteGrpcPort.FromString(\n-              process_bundle_descriptor.transforms[transform_id].spec.payload).\n-                      coder_id]].get_impl()\n+      coder_id = beam_fn_api_pb2.RemoteGrpcPort.FromString(\n+          process_bundle_descriptor.transforms[transform_id].spec.payload\n+      ).coder_id\n+      assert coder_id\n+      if coder_id in safe_coders:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b0ee79d492aeeac5c786391e9c7fd81dd6c9806"}, "originalPosition": 234}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4Nzc0NA==", "bodyText": "Is there any loss of coverage in removing these tests? I can see how perhaps they're too strict.", "url": "https://github.com/apache/beam/pull/10847#discussion_r383587744", "createdAt": "2020-02-25T00:07:19Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -1603,23 +1603,6 @@ def restriction_size(self, element, restriction):\n     return restriction.size()\n \n \n-class FnApiRunnerSplitTestWithMultiWorkers(FnApiRunnerSplitTest):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b0ee79d492aeeac5c786391e9c7fd81dd6c9806"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3101, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}