{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1OTcwODcx", "number": 11271, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMjo0MToyMVrODs7JpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjoxNzozMFrODtWgeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDMzMDYxOnYy", "diffSide": "RIGHT", "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PTransformTranslation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMjo0MToyMVrOF-DPPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoyMTozM1rOF-ssMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwOTA4NA==", "bodyText": "Please add to the checkState in the static initialization block to make sure this value doesn't deviate from the string constant here.\nNote, we do it this way so the Java compiler can treat the value as a string constant.", "url": "https://github.com/apache/beam/pull/11271#discussion_r400609084", "createdAt": "2020-03-31T02:41:21Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PTransformTranslation.java", "diffHunk": "@@ -101,6 +101,8 @@\n       \"beam:transform:combine_per_key_merge_accumulators:v1\";\n   public static final String COMBINE_PER_KEY_EXTRACT_OUTPUTS_TRANSFORM_URN =\n       \"beam:transform:combine_per_key_extract_outputs:v1\";\n+  public static final String COMBINE_PER_KEY_CONVERT_TO_ACCUMULATORS_TRANSFORM_URN =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODI0MA==", "bodyText": "Done!", "url": "https://github.com/apache/beam/pull/11271#discussion_r401288240", "createdAt": "2020-04-01T00:21:33Z", "author": {"login": "acrites"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PTransformTranslation.java", "diffHunk": "@@ -101,6 +101,8 @@\n       \"beam:transform:combine_per_key_merge_accumulators:v1\";\n   public static final String COMBINE_PER_KEY_EXTRACT_OUTPUTS_TRANSFORM_URN =\n       \"beam:transform:combine_per_key_extract_outputs:v1\";\n+  public static final String COMBINE_PER_KEY_CONVERT_TO_ACCUMULATORS_TRANSFORM_URN =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwOTA4NA=="}, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDM0MDA2OnYy", "diffSide": "RIGHT", "path": "sdks/go/pkg/beam/core/runtime/exec/combine.go", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMjo0NzozN1rOF-DVRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoyMjo0N1rOF-stig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMDYyOA==", "bodyText": "Please add a test like Combine/LiftedCombine: \n  \n    \n      beam/sdks/go/pkg/beam/core/runtime/exec/combine_test.go\n    \n    \n         Line 84\n      in\n      c8e200b\n    \n    \n    \n    \n\n        \n          \n           func TestLiftedCombine(t *testing.T) {", "url": "https://github.com/apache/beam/pull/11271#discussion_r400610628", "createdAt": "2020-03-31T02:47:37Z", "author": {"login": "lukecwik"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine.go", "diffHunk": "@@ -499,3 +499,30 @@ func (n *ExtractOutput) ProcessElement(ctx context.Context, value *FullValue, va\n \t}\n \treturn n.Out.ProcessElement(n.Combine.ctx, &FullValue{Windows: value.Windows, Elm: value.Elm, Elm2: out, Timestamp: value.Timestamp})\n }\n+\n+// ConvertToAccumulators is an executor for converting an input value to an accumulator value.\n+type ConvertToAccumulators struct {\n+\t*Combine\n+}\n+\n+func (n *ConvertToAccumulators) String() string {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4ODU4Ng==", "bodyText": "Talked with Robert and we came up with TestConvertToAccumulators.", "url": "https://github.com/apache/beam/pull/11271#discussion_r401288586", "createdAt": "2020-04-01T00:22:47Z", "author": {"login": "acrites"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine.go", "diffHunk": "@@ -499,3 +499,30 @@ func (n *ExtractOutput) ProcessElement(ctx context.Context, value *FullValue, va\n \t}\n \treturn n.Out.ProcessElement(n.Combine.ctx, &FullValue{Windows: value.Windows, Elm: value.Elm, Elm2: out, Timestamp: value.Timestamp})\n }\n+\n+// ConvertToAccumulators is an executor for converting an input value to an accumulator value.\n+type ConvertToAccumulators struct {\n+\t*Combine\n+}\n+\n+func (n *ConvertToAccumulators) String() string {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMDYyOA=="}, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODgxMjc0OnYy", "diffSide": "RIGHT", "path": "sdks/go/pkg/beam/core/runtime/exec/combine_test.go", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjoxNzozMFrOF-ugnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODozMzozMVrOF_NdoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxODA0NA==", "bodyText": "This will validate that you get the right output but doesn't actually ensure that convertToAccumulators didn't do any combining.\nIt might be worthwhile to just test the convertToAccumulators step without any of the other steps alongside it.", "url": "https://github.com/apache/beam/pull/11271#discussion_r401318044", "createdAt": "2020-04-01T02:17:30Z", "author": {"login": "lukecwik"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine_test.go", "diffHunk": "@@ -113,6 +113,40 @@ func TestLiftedCombine(t *testing.T) {\n \n }\n \n+// TestConvertToaccumulators verifies that if we just do ConvertToAccumulators instead\n+// of LiftedCombine before the GBK we still get the right answer.\n+func TestConvertToAccumulators(t *testing.T) {\n+\twithCoder := func(t *testing.T, suffix string, key interface{}, keyCoder *coder.Coder) {\n+\t\tfor _, test := range tests {\n+\t\t\tt.Run(fnName(test.Fn)+\"_\"+suffix, func(t *testing.T) {\n+\t\t\t\tedge := getCombineEdge(t, test.Fn, reflectx.Int, test.AccumCoder)\n+\n+\t\t\t\tout := &CaptureNode{UID: 1}\n+\t\t\t\textract := &ExtractOutput{Combine: &Combine{UID: 2, Fn: edge.CombineFn, Out: out}}\n+\t\t\t\tmerge := &MergeAccumulators{Combine: &Combine{UID: 3, Fn: edge.CombineFn, Out: extract}}\n+\t\t\t\tgbk := &simpleGBK{UID: 4, KeyCoder: keyCoder, Out: merge}\n+\t\t\t\tconvertToAccumulators := &ConvertToAccumulators{Combine: &Combine{UID: 5, Fn: edge.CombineFn, Out: gbk}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyNTE4NA==", "bodyText": "Good point. Updated the test.", "url": "https://github.com/apache/beam/pull/11271#discussion_r401825184", "createdAt": "2020-04-01T18:33:31Z", "author": {"login": "acrites"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine_test.go", "diffHunk": "@@ -113,6 +113,40 @@ func TestLiftedCombine(t *testing.T) {\n \n }\n \n+// TestConvertToaccumulators verifies that if we just do ConvertToAccumulators instead\n+// of LiftedCombine before the GBK we still get the right answer.\n+func TestConvertToAccumulators(t *testing.T) {\n+\twithCoder := func(t *testing.T, suffix string, key interface{}, keyCoder *coder.Coder) {\n+\t\tfor _, test := range tests {\n+\t\t\tt.Run(fnName(test.Fn)+\"_\"+suffix, func(t *testing.T) {\n+\t\t\t\tedge := getCombineEdge(t, test.Fn, reflectx.Int, test.AccumCoder)\n+\n+\t\t\t\tout := &CaptureNode{UID: 1}\n+\t\t\t\textract := &ExtractOutput{Combine: &Combine{UID: 2, Fn: edge.CombineFn, Out: out}}\n+\t\t\t\tmerge := &MergeAccumulators{Combine: &Combine{UID: 3, Fn: edge.CombineFn, Out: extract}}\n+\t\t\t\tgbk := &simpleGBK{UID: 4, KeyCoder: keyCoder, Out: merge}\n+\t\t\t\tconvertToAccumulators := &ConvertToAccumulators{Combine: &Combine{UID: 5, Fn: edge.CombineFn, Out: gbk}}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxODA0NA=="}, "originalCommit": {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1580, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}