{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjc0MDI5", "number": 10535, "title": "[BEAM-5605] Add support for executing pair with restriction, split restriction, split and size restriction, process element and restriction and process sized element and restriction within the Java SDK harness.", "bodyText": "I removed the SplittableProcessElementsRunner and call the DoFnInvoker directly. I left the SplittableElementsInvoker as is since it is used by non portable SplittableDoFns.\nI plan to have a follow-up change that removes the \"context\" object as it is no longer necessary.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-08T21:59:01Z", "url": "https://github.com/apache/beam/pull/10535", "merged": true, "mergeCommit": {"oid": "217afd56f9e79436c7c2b670f7d2bf013a46a41f"}, "closed": true, "closedAt": "2020-01-10T19:07:54Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4cpjYgH2gAyMzYwNjc0MDI5Ojc3MzhhODdmZjAyOTdhYjA1MWY3ZDRhY2MxM2NlYjRkOTA3Yjc3Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5DTlRgFqTM0MTM1OTg1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7738a87ff0297ab051f7d4acc13ceb4d907b77f8", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/7738a87ff0297ab051f7d4acc13ceb4d907b77f8", "committedDate": "2020-01-08T21:57:25Z", "message": "[BEAM-5605] Add support for executing pair with restriction, split restriction, split and size restriction, process element and restriction and process sized element and restriction within the Java SDK harness.\n\nI removed the SplittableProcessElementsRunner and call the DoFnInvoker directly.\nI plan to have a follow-up change that removes the \"context\" object as it is no longer necessary."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwODk3NDY3", "url": "https://github.com/apache/beam/pull/10535#pullrequestreview-340897467", "createdAt": "2020-01-10T00:31:35Z", "commit": {"oid": "7738a87ff0297ab051f7d4acc13ceb4d907b77f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDozMTozNVrOFcHYLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwMDozMTozNVrOFcHYLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTAyNTMyNg==", "bodyText": "Shouldn't this method also produce sizes, like the output method above?", "url": "https://github.com/apache/beam/pull/10535#discussion_r365025326", "createdAt": "2020-01-10T00:31:35Z", "author": {"login": "youngoli"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -162,9 +475,127 @@ public void output(OutputT output, Instant timestamp, BoundedWindow window) {\n             outputTo(consumers, WindowedValue.of(output, timestamp, window, PaneInfo.NO_FIRING));\n           }\n         };\n+    switch (context.pTransform.getSpec().getUrn()) {\n+      case PTransformTranslation.SPLITTABLE_SPLIT_RESTRICTION_URN:\n+        this.outputSplitRestrictionReceiver =\n+            new OutputReceiver<RestrictionT>() {\n+\n+              @Override\n+              public void output(RestrictionT output) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        currentElement.withValue(KV.of(currentElement.getValue(), output)));\n+              }\n+\n+              @Override\n+              public void outputWithTimestamp(RestrictionT output, Instant timestamp) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        WindowedValue.of(\n+                            KV.of(currentElement.getValue(), output),\n+                            timestamp,\n+                            currentWindow,\n+                            currentElement.getPane()));\n+              }\n+            };\n+        break;\n+      case PTransformTranslation.SPLITTABLE_SPLIT_AND_SIZE_RESTRICTIONS_URN:\n+        this.outputSplitRestrictionReceiver =\n+            new OutputReceiver<RestrictionT>() {\n+\n+              @Override\n+              public void output(RestrictionT output) {\n+                RestrictionTracker<RestrictionT, PositionT> outputTracker =\n+                    doFnInvoker.invokeNewTracker(output);\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        currentElement.withValue(\n+                            KV.of(\n+                                KV.of(currentElement.getValue(), output),\n+                                outputTracker instanceof HasSize\n+                                    ? ((HasSize) outputTracker).getSize()\n+                                    : 1.0)));\n+              }\n+\n+              @Override\n+              public void outputWithTimestamp(RestrictionT output, Instant timestamp) {\n+                outputTo(\n+                    mainOutputConsumers,\n+                    (WindowedValue<OutputT>)\n+                        WindowedValue.of(\n+                            KV.of(currentElement.getValue(), output),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7738a87ff0297ab051f7d4acc13ceb4d907b77f8"}, "originalPosition": 486}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4283e094957406ce13526965b92546db3279be3", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f4283e094957406ce13526965b92546db3279be3", "committedDate": "2020-01-10T17:37:23Z", "message": "fixup!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzU5ODU5", "url": "https://github.com/apache/beam/pull/10535#pullrequestreview-341359859", "createdAt": "2020-01-10T18:59:43Z", "commit": {"oid": "f4283e094957406ce13526965b92546db3279be3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3678, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}