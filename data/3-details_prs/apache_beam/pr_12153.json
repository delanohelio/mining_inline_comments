{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyODU5MjE2", "number": 12153, "title": "[BEAM-9953] [ZetaSQL] Implement CREATE FUNCTION and scalar UDF.", "bodyText": "Scalar UDFs are implemented by simply replacing each function invocation with its corresponding RexNode.\nR: @amaliujia\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-01T18:05:46Z", "url": "https://github.com/apache/beam/pull/12153", "merged": true, "mergeCommit": {"oid": "a5c32f32453d45771242f16bea142044ef71ab94"}, "closed": true, "closedAt": "2020-07-01T23:15:05Z", "author": {"login": "ibzib"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwuihLgH2gAyNDQyODU5MjE2OjVlZjk4ODAwMTUyYmU2ODIxN2RkZWFlMzI2MGE2Yzg4ZGE2OGIxMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcww_aMgH2gAyNDQyODU5MjE2OmZlNGQ3MTJmYjFkNTVlYjUyMWY5MDdjZDkyMjhmMDRjZGUyNDU2NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ef98800152be68217ddeae3260a6c88da68b133", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/5ef98800152be68217ddeae3260a6c88da68b133", "committedDate": "2020-07-01T18:27:47Z", "message": "[BEAM-9953] [ZetaSQL] Implement CREATE FUNCTION and scalar UDF."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/52237a292ff1a3b001667976f8073744f0124cd3", "committedDate": "2020-07-01T18:00:49Z", "message": "[BEAM-9953] [ZetaSQL] Implement CREATE FUNCTION and scalar UDF."}, "afterCommit": {"oid": "5ef98800152be68217ddeae3260a6c88da68b133", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/5ef98800152be68217ddeae3260a6c88da68b133", "committedDate": "2020-07-01T18:27:47Z", "message": "[BEAM-9953] [ZetaSQL] Implement CREATE FUNCTION and scalar UDF."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDk5Njk4", "url": "https://github.com/apache/beam/pull/12153#pullrequestreview-441099698", "createdAt": "2020-07-01T18:21:11Z", "commit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyMToxMlrOGrwscA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNzozOFrOGrxMlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzOTc2MA==", "bodyText": "I wasn't aware that this addFunction can throw an exception. Any example that could fail this line? E.g. adding a function with duplicated name?", "url": "https://github.com/apache/beam/pull/12153#discussion_r448539760", "createdAt": "2020-07-01T18:21:12Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/SqlAnalyzer.java", "diffHunk": "@@ -107,6 +128,43 @@ ResolvedStatement analyze(String sql) {\n     return Analyzer.analyzeStatement(sql, options, catalog);\n   }\n \n+  /**\n+   * Accepts the ParseResumeLocation for the current position in the SQL string. Advances the\n+   * ParseResumeLocation to the start of the next statement. Adds user-defined functions to the\n+   * catalog for use in following statements. Returns the resolved AST.\n+   */\n+  ResolvedStatement analyzeNextStatement(\n+      ParseResumeLocation parseResumeLocation, AnalyzerOptions options, SimpleCatalog catalog) {\n+    ResolvedStatement resolvedStatement =\n+        Analyzer.analyzeNextStatement(parseResumeLocation, options, catalog);\n+    if (resolvedStatement.nodeKind() == RESOLVED_CREATE_FUNCTION_STMT) {\n+      ResolvedCreateFunctionStmt createFunctionStmt =\n+          (ResolvedCreateFunctionStmt) resolvedStatement;\n+      Function userFunction =\n+          new Function(\n+              createFunctionStmt.getNamePath(),\n+              USER_DEFINED_FUNCTIONS,\n+              // TODO(BEAM-9954) handle aggregate functions\n+              // TODO(BEAM-9969) handle table functions\n+              Mode.SCALAR,\n+              com.google.common.collect.ImmutableList.of(createFunctionStmt.getSignature()));\n+      try {\n+        catalog.addFunction(userFunction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MDIyMw==", "bodyText": "Why add a ParseException? Seems to me that throw IllegalArgumentException e directly will give clear cause?", "url": "https://github.com/apache/beam/pull/12153#discussion_r448540223", "createdAt": "2020-07-01T18:22:01Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/SqlAnalyzer.java", "diffHunk": "@@ -107,6 +128,43 @@ ResolvedStatement analyze(String sql) {\n     return Analyzer.analyzeStatement(sql, options, catalog);\n   }\n \n+  /**\n+   * Accepts the ParseResumeLocation for the current position in the SQL string. Advances the\n+   * ParseResumeLocation to the start of the next statement. Adds user-defined functions to the\n+   * catalog for use in following statements. Returns the resolved AST.\n+   */\n+  ResolvedStatement analyzeNextStatement(\n+      ParseResumeLocation parseResumeLocation, AnalyzerOptions options, SimpleCatalog catalog) {\n+    ResolvedStatement resolvedStatement =\n+        Analyzer.analyzeNextStatement(parseResumeLocation, options, catalog);\n+    if (resolvedStatement.nodeKind() == RESOLVED_CREATE_FUNCTION_STMT) {\n+      ResolvedCreateFunctionStmt createFunctionStmt =\n+          (ResolvedCreateFunctionStmt) resolvedStatement;\n+      Function userFunction =\n+          new Function(\n+              createFunctionStmt.getNamePath(),\n+              USER_DEFINED_FUNCTIONS,\n+              // TODO(BEAM-9954) handle aggregate functions\n+              // TODO(BEAM-9969) handle table functions\n+              Mode.SCALAR,\n+              com.google.common.collect.ImmutableList.of(createFunctionStmt.getSignature()));\n+      try {\n+        catalog.addFunction(userFunction);\n+      } catch (IllegalArgumentException e) {\n+        throw new ParseException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MDcxNA==", "bodyText": "line 159 and line 161 are duplicates and they can be put at the end of this function.", "url": "https://github.com/apache/beam/pull/12153#discussion_r448540714", "createdAt": "2020-07-01T18:23:01Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/SqlAnalyzer.java", "diffHunk": "@@ -107,6 +128,43 @@ ResolvedStatement analyze(String sql) {\n     return Analyzer.analyzeStatement(sql, options, catalog);\n   }\n \n+  /**\n+   * Accepts the ParseResumeLocation for the current position in the SQL string. Advances the\n+   * ParseResumeLocation to the start of the next statement. Adds user-defined functions to the\n+   * catalog for use in following statements. Returns the resolved AST.\n+   */\n+  ResolvedStatement analyzeNextStatement(\n+      ParseResumeLocation parseResumeLocation, AnalyzerOptions options, SimpleCatalog catalog) {\n+    ResolvedStatement resolvedStatement =\n+        Analyzer.analyzeNextStatement(parseResumeLocation, options, catalog);\n+    if (resolvedStatement.nodeKind() == RESOLVED_CREATE_FUNCTION_STMT) {\n+      ResolvedCreateFunctionStmt createFunctionStmt =\n+          (ResolvedCreateFunctionStmt) resolvedStatement;\n+      Function userFunction =\n+          new Function(\n+              createFunctionStmt.getNamePath(),\n+              USER_DEFINED_FUNCTIONS,\n+              // TODO(BEAM-9954) handle aggregate functions\n+              // TODO(BEAM-9969) handle table functions\n+              Mode.SCALAR,\n+              com.google.common.collect.ImmutableList.of(createFunctionStmt.getSignature()));\n+      try {\n+        catalog.addFunction(userFunction);\n+      } catch (IllegalArgumentException e) {\n+        throw new ParseException(\n+            String.format(\n+                \"Failed to define function %s\", String.join(\".\", createFunctionStmt.getNamePath())),\n+            e);\n+      }\n+      return resolvedStatement;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTQzMg==", "bodyText": "Any link to what this bug is (or log a JIRA to describe what has failed?)", "url": "https://github.com/apache/beam/pull/12153#discussion_r448541432", "createdAt": "2020-07-01T18:24:25Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/test/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSQLDialectSpecTest.java", "diffHunk": "@@ -2841,6 +2842,129 @@ public void testSelectNullExceptAll() {\n     pipeline.run().waitUntilFinish(Duration.standardMinutes(PIPELINE_EXECUTION_WAITTIME_MINUTES));\n   }\n \n+  @Test\n+  public void testMultipleSelectStatementsThrowsException() {\n+    String sql = \"SELECT 1; SELECT 2;\";\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    thrown.expect(UnsupportedOperationException.class);\n+    thrown.expectMessage(\n+        \"Statement list must end in a SELECT statement, and cannot contain more than one SELECT statement.\");\n+    zetaSQLQueryPlanner.convertToBeamRel(sql);\n+  }\n+\n+  @Test\n+  public void testAlreadyDefinedUDFThrowsException() {\n+    String sql = \"CREATE FUNCTION foo() AS (0); CREATE FUNCTION foo() AS (1); SELECT foo();\";\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    thrown.expect(ParseException.class);\n+    thrown.expectMessage(\"Failed to define function foo\");\n+    zetaSQLQueryPlanner.convertToBeamRel(sql);\n+  }\n+\n+  @Test\n+  public void testCreateFunctionNoSelectThrowsException() {\n+    String sql = \"CREATE FUNCTION plusOne(x INT64) AS (x + 1);\";\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    thrown.expect(UnsupportedOperationException.class);\n+    thrown.expectMessage(\"Statement list must end in a SELECT statement, not CreateFunctionStmt\");\n+    zetaSQLQueryPlanner.convertToBeamRel(sql);\n+  }\n+\n+  @Test\n+  public void testNullaryUdf() {\n+    String sql = \"CREATE FUNCTION zero() AS (0); SELECT zero();\";\n+\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    BeamRelNode beamRelNode = zetaSQLQueryPlanner.convertToBeamRel(sql);\n+    PCollection<Row> stream = BeamSqlRelUtils.toPCollection(pipeline, beamRelNode);\n+\n+    PAssert.that(stream)\n+        .containsInAnyOrder(\n+            Row.withSchema(Schema.builder().addInt64Field(\"x\").build()).addValue(0L).build());\n+    pipeline.run().waitUntilFinish(Duration.standardMinutes(PIPELINE_EXECUTION_WAITTIME_MINUTES));\n+  }\n+\n+  @Test\n+  public void testQualifiedNameUdfUnqualifiedCall() {\n+    String sql = \"CREATE FUNCTION foo.bar.baz() AS (\\\"uwu\\\"); SELECT baz();\";\n+\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    BeamRelNode beamRelNode = zetaSQLQueryPlanner.convertToBeamRel(sql);\n+    PCollection<Row> stream = BeamSqlRelUtils.toPCollection(pipeline, beamRelNode);\n+\n+    PAssert.that(stream)\n+        .containsInAnyOrder(\n+            Row.withSchema(Schema.builder().addStringField(\"x\").build()).addValue(\"uwu\").build());\n+    pipeline.run().waitUntilFinish(Duration.standardMinutes(PIPELINE_EXECUTION_WAITTIME_MINUTES));\n+  }\n+\n+  @Test\n+  @Ignore(\"Qualified paths can't be resolved due to a bug in ZetaSQL.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MzI2NQ==", "bodyText": "Can you clarify what is \"full function name\"?", "url": "https://github.com/apache/beam/pull/12153#discussion_r448543265", "createdAt": "2020-07-01T18:28:15Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSQLPlannerImpl.java", "diffHunk": "@@ -130,30 +135,57 @@ public RelRoot rel(SqlNode sqlNode) throws RelConversionException {\n   }\n \n   public RelRoot rel(String sql, QueryParameters params) {\n-    this.cluster = RelOptCluster.create(planner, new RexBuilder(typeFactory));\n-    this.expressionConverter = new ExpressionConverter(cluster, params);\n+    RelOptCluster cluster = RelOptCluster.create(planner, new RexBuilder(typeFactory));\n \n     QueryTrait trait = new QueryTrait();\n \n-    // Set up table providers that need to be pre-registered\n-    // TODO(https://issues.apache.org/jira/browse/BEAM-8817): share this logic between dialects\n-    List<List<String>> tables = Analyzer.extractTableNamesFromStatement(sql);\n-    TableResolution.registerTables(this.defaultSchemaPlus, tables);\n-\n-    ResolvedStatement statement =\n+    SqlAnalyzer analyzer =\n         SqlAnalyzer.getBuilder()\n             .withQueryParams(params)\n             .withQueryTrait(trait)\n             .withCalciteContext(config.getContext())\n             .withTopLevelSchema(defaultSchemaPlus)\n             .withTypeFactory((JavaTypeFactory) cluster.getTypeFactory())\n-            .analyze(sql);\n+            .build();\n+\n+    AnalyzerOptions options = SqlAnalyzer.initAnalyzerOptions(params);\n+\n+    // Set up table providers that need to be pre-registered\n+    List<List<String>> tables = analyzer.extractTableNames(sql, options);\n+    TableResolution.registerTables(this.defaultSchemaPlus, tables);\n+    SimpleCatalog catalog =\n+        analyzer.createPopulatedCatalog(defaultSchemaPlus.getName(), options, tables);\n+\n+    ImmutableMap.Builder<String, ResolvedCreateFunctionStmt> udfBuilder = ImmutableMap.builder();\n+\n+    ResolvedStatement statement;\n+    ParseResumeLocation parseResumeLocation = new ParseResumeLocation(sql);\n+    do {\n+      statement = analyzer.analyzeNextStatement(parseResumeLocation, options, catalog);\n+      if (statement.nodeKind() == RESOLVED_CREATE_FUNCTION_STMT) {\n+        ResolvedCreateFunctionStmt createFunctionStmt = (ResolvedCreateFunctionStmt) statement;\n+        // ResolvedCreateFunctionStmt does not include the full function name, so build it here.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52237a292ff1a3b001667976f8073744f0124cd3"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NzA0MA==", "bodyText": "I can tell line 185 and this line combined together to verify:\n\nonly one SELECT in a statement list.\nthat SELECT statement should be in the end of list.\n\nBut from readability perspective, neither one explicitly tests there are more than one SELECT in a list. I am afraid that for people who don't have context to read code here, they could not get the one single SELECT constraint (although it is implied implicitly).\nMy suggestion is you only validate cannot contain more than one SELECT statement here and leave Statement list must end in a SELECT statement to line 185.", "url": "https://github.com/apache/beam/pull/12153#discussion_r448547040", "createdAt": "2020-07-01T18:35:39Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSQLPlannerImpl.java", "diffHunk": "@@ -130,30 +135,58 @@ public RelRoot rel(SqlNode sqlNode) throws RelConversionException {\n   }\n \n   public RelRoot rel(String sql, QueryParameters params) {\n-    this.cluster = RelOptCluster.create(planner, new RexBuilder(typeFactory));\n-    this.expressionConverter = new ExpressionConverter(cluster, params);\n+    RelOptCluster cluster = RelOptCluster.create(planner, new RexBuilder(typeFactory));\n \n     QueryTrait trait = new QueryTrait();\n \n-    // Set up table providers that need to be pre-registered\n-    // TODO(https://issues.apache.org/jira/browse/BEAM-8817): share this logic between dialects\n-    List<List<String>> tables = Analyzer.extractTableNamesFromStatement(sql);\n-    TableResolution.registerTables(this.defaultSchemaPlus, tables);\n-\n-    ResolvedStatement statement =\n+    SqlAnalyzer analyzer =\n         SqlAnalyzer.getBuilder()\n             .withQueryParams(params)\n             .withQueryTrait(trait)\n             .withCalciteContext(config.getContext())\n             .withTopLevelSchema(defaultSchemaPlus)\n             .withTypeFactory((JavaTypeFactory) cluster.getTypeFactory())\n-            .analyze(sql);\n+            .build();\n+\n+    AnalyzerOptions options = SqlAnalyzer.initAnalyzerOptions(params);\n+\n+    // Set up table providers that need to be pre-registered\n+    List<List<String>> tables = analyzer.extractTableNames(sql, options);\n+    TableResolution.registerTables(this.defaultSchemaPlus, tables);\n+    SimpleCatalog catalog =\n+        analyzer.createPopulatedCatalog(defaultSchemaPlus.getName(), options, tables);\n+\n+    ImmutableMap.Builder<String, ResolvedCreateFunctionStmt> udfBuilder = ImmutableMap.builder();\n+\n+    ResolvedStatement statement;\n+    ParseResumeLocation parseResumeLocation = new ParseResumeLocation(sql);\n+    do {\n+      statement = analyzer.analyzeNextStatement(parseResumeLocation, options, catalog);\n+      if (statement.nodeKind() == RESOLVED_CREATE_FUNCTION_STMT) {\n+        ResolvedCreateFunctionStmt createFunctionStmt = (ResolvedCreateFunctionStmt) statement;\n+        // ResolvedCreateFunctionStmt does not include the full function name, so build it here.\n+        String functionFullName =\n+            String.format(\n+                \"%s:%s\",\n+                SqlAnalyzer.USER_DEFINED_FUNCTIONS,\n+                String.join(\".\", createFunctionStmt.getNamePath()));\n+        udfBuilder.put(functionFullName, createFunctionStmt);\n+      } else if (statement.nodeKind() == RESOLVED_QUERY_STMT) {\n+        if (!SqlAnalyzer.isEndOfInput(parseResumeLocation)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef98800152be68217ddeae3260a6c88da68b133"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0Nzk5MQ==", "bodyText": "Do you think for Java UDF, will this code path help?", "url": "https://github.com/apache/beam/pull/12153#discussion_r448547991", "createdAt": "2020-07-01T18:37:38Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/ExpressionConverter.java", "diffHunk": "@@ -920,8 +946,23 @@ private RexNode convertResolvedFunctionCall(\n       }\n \n       for (ResolvedExpr expr : functionCall.getArgumentList()) {\n-        operands.add(convertRexNodeFromResolvedExpr(expr, columnList, fieldList));\n+        operands.add(\n+            convertRexNodeFromResolvedExpr(expr, columnList, fieldList, outerFunctionArguments));\n+      }\n+    } else if (funGroup.equals(USER_DEFINED_FUNCTIONS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef98800152be68217ddeae3260a6c88da68b133"}, "originalPosition": 181}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4421bca06243488b18778ea33bfed3868e0f780f", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/4421bca06243488b18778ea33bfed3868e0f780f", "committedDate": "2020-07-01T21:04:22Z", "message": "Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjAwNzcy", "url": "https://github.com/apache/beam/pull/12153#pullrequestreview-441200772", "createdAt": "2020-07-01T21:13:48Z", "commit": {"oid": "4421bca06243488b18778ea33bfed3868e0f780f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjAxMDI1", "url": "https://github.com/apache/beam/pull/12153#pullrequestreview-441201025", "createdAt": "2020-07-01T21:14:17Z", "commit": {"oid": "4421bca06243488b18778ea33bfed3868e0f780f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMToxNDoxN1rOGr1j_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMToxNDoxN1rOGr1j_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxOTUxOQ==", "bodyText": "You will need to update this error message.", "url": "https://github.com/apache/beam/pull/12153#discussion_r448619519", "createdAt": "2020-07-01T21:14:17Z", "author": {"login": "amaliujia"}, "path": "sdks/java/extensions/sql/zetasql/src/test/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSQLDialectSpecTest.java", "diffHunk": "@@ -2841,6 +2842,131 @@ public void testSelectNullExceptAll() {\n     pipeline.run().waitUntilFinish(Duration.standardMinutes(PIPELINE_EXECUTION_WAITTIME_MINUTES));\n   }\n \n+  @Test\n+  public void testMultipleSelectStatementsThrowsException() {\n+    String sql = \"SELECT 1; SELECT 2;\";\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    thrown.expect(UnsupportedOperationException.class);\n+    thrown.expectMessage(\n+        \"Statement list must end in a SELECT statement, and cannot contain more than one SELECT statement.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4421bca06243488b18778ea33bfed3868e0f780f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe4d712fb1d55eb521f907cd9228f04cde245649", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/fe4d712fb1d55eb521f907cd9228f04cde245649", "committedDate": "2020-07-01T21:19:09Z", "message": "Fix test error message."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3313, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}