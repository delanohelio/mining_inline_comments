{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MzI5MTg3", "number": 11532, "title": "[BEAM-9822] Disable grouping when streaming", "bodyText": "Grouping adds significant latency and memory use.\nWhen streaming, end-to-end pipeline latency is important, and many worker threads are executed, meaning that OOM's can frequently occur.\nThis PR disables grouping by default in streaming mode, ensuring lower memory use and faster end-end latency.\nNote, this PR is dependent on PR #11528\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-27T08:14:18Z", "url": "https://github.com/apache/beam/pull/11532", "merged": true, "mergeCommit": {"oid": "3f2d648250437d37904dd62f1cb57db4ffc9dc3a"}, "closed": true, "closedAt": "2020-05-19T20:05:27Z", "author": {"login": "nielm"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbtP9kABqjMyNzUyMjIzOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci6JiSgFqTQxNDc4MTc1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec34badd03167391337a31a2b8868017acc22264", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ec34badd03167391337a31a2b8868017acc22264", "committedDate": "2020-04-27T07:55:57Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "8b56f4419cdd4f8982f097e6558cd905e09af11e", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/8b56f4419cdd4f8982f097e6558cd905e09af11e", "committedDate": "2020-04-27T11:04:50Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b56f4419cdd4f8982f097e6558cd905e09af11e", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/8b56f4419cdd4f8982f097e6558cd905e09af11e", "committedDate": "2020-04-27T11:04:50Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "865a11bea55f0c5e8dee77c544ab5215607147a3", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/865a11bea55f0c5e8dee77c544ab5215607147a3", "committedDate": "2020-04-27T11:13:22Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "865a11bea55f0c5e8dee77c544ab5215607147a3", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/865a11bea55f0c5e8dee77c544ab5215607147a3", "committedDate": "2020-04-27T11:13:22Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "573bfb936940dea91709cdc656c36f41a4715866", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/573bfb936940dea91709cdc656c36f41a4715866", "committedDate": "2020-05-01T11:21:53Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzY4OTg3", "url": "https://github.com/apache/beam/pull/11532#pullrequestreview-404368987", "createdAt": "2020-05-01T19:58:38Z", "commit": {"oid": "573bfb936940dea91709cdc656c36f41a4715866"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOTo1ODozOFrOGPUIsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOTo1ODozOFrOGPUIsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxMTcyOQ==", "bodyText": "I was wondering if this condition needs to be based on the input passed to this stage or based on some parameter from the user?", "url": "https://github.com/apache/beam/pull/11532#discussion_r418711729", "createdAt": "2020-05-01T19:58:38Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1066,7 +1079,12 @@ public SpannerWriteResult expand(PCollection<MutationGroup> input) {\n                               spec.getBatchSizeBytes(),\n                               spec.getMaxNumMutations(),\n                               spec.getMaxNumRows(),\n-                              spec.getGroupingFactor(),\n+                              // Do not group on streaming unless explicitly set.\n+                              spec.getGroupingFactor()\n+                                  .orElse(\n+                                      input.isBounded() == IsBounded.BOUNDED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "573bfb936940dea91709cdc656c36f41a4715866"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "573bfb936940dea91709cdc656c36f41a4715866", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/573bfb936940dea91709cdc656c36f41a4715866", "committedDate": "2020-05-01T11:21:53Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "cecb959cacadb6748dec50c20ff9282ee82b1347", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cecb959cacadb6748dec50c20ff9282ee82b1347", "committedDate": "2020-05-03T10:13:40Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODQ2MjY4", "url": "https://github.com/apache/beam/pull/11532#pullrequestreview-406846268", "createdAt": "2020-05-06T17:45:42Z", "commit": {"oid": "cecb959cacadb6748dec50c20ff9282ee82b1347"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cecb959cacadb6748dec50c20ff9282ee82b1347", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cecb959cacadb6748dec50c20ff9282ee82b1347", "committedDate": "2020-05-03T10:13:40Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "committedDate": "2020-05-18T22:41:00Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/9e56c0815ff6f7e56efe1b86089ede5f2b9ef3da", "committedDate": "2020-05-18T22:41:00Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "committedDate": "2020-05-18T23:42:34Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "committedDate": "2020-05-19T11:06:54Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/3cc214bf9df6e57d70ee327cb8df3766a0861a0f", "committedDate": "2020-05-18T23:42:34Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}, "afterCommit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "committedDate": "2020-05-19T11:06:54Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTg1MTU4", "url": "https://github.com/apache/beam/pull/11532#pullrequestreview-414585158", "createdAt": "2020-05-19T15:48:27Z", "commit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0ODoyN1rOGXm78A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo0ODoyN1rOGXm78A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwODM2OA==", "bodyText": "It would be nice if this were another constant. We could have DEFAULT_GROUPING_FACTOR_BOUNDED and DEFAULT_GROUPING_FACTOR_UNBOUNDED. It doesn't need to be done here, could be in a follow-up PR.", "url": "https://github.com/apache/beam/pull/11532#discussion_r427408368", "createdAt": "2020-05-19T15:48:27Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1059,7 +1071,12 @@ public SpannerWriteResult expand(PCollection<MutationGroup> input) {\n                               spec.getBatchSizeBytes(),\n                               spec.getMaxNumMutations(),\n                               spec.getMaxNumRows(),\n-                              spec.getGroupingFactor(),\n+                              // Do not group on streaming unless explicitly set.\n+                              spec.getGroupingFactor()\n+                                  .orElse(\n+                                      input.isBounded() == IsBounded.BOUNDED\n+                                          ? DEFAULT_GROUPING_FACTOR\n+                                          : 1),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzgxNzU2", "url": "https://github.com/apache/beam/pull/11532#pullrequestreview-414781756", "createdAt": "2020-05-19T20:04:25Z", "commit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3980, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}