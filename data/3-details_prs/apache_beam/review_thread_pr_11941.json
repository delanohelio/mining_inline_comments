{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4ODUwMTc4", "number": 11941, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzowOTo0NlrOEDi26w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzoxMzoxNVrOEDi8wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTUyMjk5OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzowOTo0NlrOGgn7xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxODozOTowOVrOGgrI8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2MTg5NA==", "bodyText": "I'm thinking whether it would be helpful to have startBundle for PairWithRestriction and SplitRestriction. Similar to process fn, PairWithRestriction and SplitRestriction also deal with (element, restriction). For example, I do this in KafkaIO to initialize consumer per bundle instead of per element.", "url": "https://github.com/apache/beam/pull/11941#discussion_r436861894", "createdAt": "2020-06-08T17:09:46Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -193,7 +193,21 @@\n               bundleFinalizer);\n \n       // Register the appropriate handlers.\n-      startFunctionRegistry.register(pTransformId, runner::startBundle);\n+      switch (pTransform.getSpec().getUrn()) {\n+        case PTransformTranslation.PAR_DO_TRANSFORM_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_ELEMENTS_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_SIZED_ELEMENTS_AND_RESTRICTIONS_URN:\n+          startFunctionRegistry.register(pTransformId, runner::startBundle);\n+          break;\n+        case PTransformTranslation.SPLITTABLE_PAIR_WITH_RESTRICTION_URN:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2089bab771435ea1a34e12e7fb6ea4e510cadfb"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTUzMg==", "bodyText": "We can't re-use the existing startBundle/finishBundle methods since it would be confusing to the user as to which context they are executing in (e.g. finishBundle can produce output) so this would require adding startBundleForGetInitialRestriction, finishBundleForGetInitialRestriction, startBundleForPairWithRestriction and finishBundleForPairWithRestriction. I could see value in this for per bundle object lifetime management but any such change should likely happen outside of the scope of this PR.\nAny reason not to use setup/teardown for your object cache?", "url": "https://github.com/apache/beam/pull/11941#discussion_r436891532", "createdAt": "2020-06-08T17:57:51Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -193,7 +193,21 @@\n               bundleFinalizer);\n \n       // Register the appropriate handlers.\n-      startFunctionRegistry.register(pTransformId, runner::startBundle);\n+      switch (pTransform.getSpec().getUrn()) {\n+        case PTransformTranslation.PAR_DO_TRANSFORM_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_ELEMENTS_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_SIZED_ELEMENTS_AND_RESTRICTIONS_URN:\n+          startFunctionRegistry.register(pTransformId, runner::startBundle);\n+          break;\n+        case PTransformTranslation.SPLITTABLE_PAIR_WITH_RESTRICTION_URN:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2MTg5NA=="}, "originalCommit": {"oid": "e2089bab771435ea1a34e12e7fb6ea4e510cadfb"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxNDQxOQ==", "bodyText": "I just got the idea of setup /teardown. Thanks!", "url": "https://github.com/apache/beam/pull/11941#discussion_r436914419", "createdAt": "2020-06-08T18:39:09Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -193,7 +193,21 @@\n               bundleFinalizer);\n \n       // Register the appropriate handlers.\n-      startFunctionRegistry.register(pTransformId, runner::startBundle);\n+      switch (pTransform.getSpec().getUrn()) {\n+        case PTransformTranslation.PAR_DO_TRANSFORM_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_ELEMENTS_URN:\n+        case PTransformTranslation.SPLITTABLE_PROCESS_SIZED_ELEMENTS_AND_RESTRICTIONS_URN:\n+          startFunctionRegistry.register(pTransformId, runner::startBundle);\n+          break;\n+        case PTransformTranslation.SPLITTABLE_PAIR_WITH_RESTRICTION_URN:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2MTg5NA=="}, "originalCommit": {"oid": "e2089bab771435ea1a34e12e7fb6ea4e510cadfb"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTUzNzk0OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzoxMzoxNVrOGgoEqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxODowNjo1NVrOGgqD-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NDE3MA==", "bodyText": "Could you please add a JIRA here, which elaborate this support with more details?", "url": "https://github.com/apache/beam/pull/11941#discussion_r436864170", "createdAt": "2020-06-08T17:13:15Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -784,9 +812,8 @@ private ByteString encodeProgress(double value) throws IOException {\n       default:\n         // no-op\n     }\n-  }\n \n-  private void startBundle() {\n+    // TODO: Support caching state data across bundle boundaries.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2089bab771435ea1a34e12e7fb6ea4e510cadfb"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5Njc2MA==", "bodyText": "Done", "url": "https://github.com/apache/beam/pull/11941#discussion_r436896760", "createdAt": "2020-06-08T18:06:55Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/FnApiDoFnRunner.java", "diffHunk": "@@ -784,9 +812,8 @@ private ByteString encodeProgress(double value) throws IOException {\n       default:\n         // no-op\n     }\n-  }\n \n-  private void startBundle() {\n+    // TODO: Support caching state data across bundle boundaries.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NDE3MA=="}, "originalCommit": {"oid": "e2089bab771435ea1a34e12e7fb6ea4e510cadfb"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3634, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}