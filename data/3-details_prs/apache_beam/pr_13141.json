{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MzAyOTA1", "number": 13141, "title": "[BEAM-9547] Dataframe corrwith.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-19T21:56:33Z", "url": "https://github.com/apache/beam/pull/13141", "merged": true, "mergeCommit": {"oid": "b1cdbf91aa10946874a84017dd72fe6f7a64efa4"}, "closed": true, "closedAt": "2020-10-29T17:18:48Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdULcHPgH2gAyNTA2MzAyOTA1OjZiMTFiYWE5MjM4ODJmODY0NGU1NWUwZDY5NWEyN2VhMGI5MGRmZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXEBSNgH2gAyNTA2MzAyOTA1OjhiMTE0MmU2NTc2ZTMyY2Q2N2NjOWEyOGJkNTFlYmMwNjJmMDM5NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b11baa923882f8644e55e0d695a27ea0b90dfd7", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/6b11baa923882f8644e55e0d695a27ea0b90dfd7", "committedDate": "2020-10-19T21:55:23Z", "message": "[BEAM-9547] Dataframe corrwith."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/b0ffe9ce91221a278c740cc89d8d154e68ab5ff7", "committedDate": "2020-10-19T22:40:14Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDU3OTEx", "url": "https://github.com/apache/beam/pull/13141#pullrequestreview-518057911", "createdAt": "2020-10-27T19:19:21Z", "commit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToxOToyMVrOHpMwdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo1MDoyMFrOHpONkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk2MjY3Ng==", "bodyText": "Is this safe to implement with elementwise_method? (need to justify this to myself)\nI think it will work for most cases.. the resulting expression will require partitionings.Index since we do that if any arg is a DeferredBase, and other should always be one. That should handle axis='index'. Also all of the join modes should work as intended within Index partitions.\nI think actually for axis='columns' Index partitioning is too restrictive. We could do that without any partitioning. Is that right?\nLooking at the remaining args:\n\ncopy: I think copy=False won't work since we can't predict if the operation is inplace or not, it depends on the data.\nfill_value: Works trivially\nmethod: non-default options are order-sensitive\nlimit: I don't think we can support this correctly right now without Singleton partitioning\nlevel, fill_axis, broadcast_axis: I'm not actually sure what these are doing.\n\nCan we reject the options that won't work?", "url": "https://github.com/apache/beam/pull/13141#discussion_r512962676", "createdAt": "2020-10-27T19:19:21Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -575,6 +575,8 @@ def __setitem__(self, key, value):\n     else:\n       raise NotImplementedError(key)\n \n+  align = frame_base._elementwise_method('align')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MjIzNQ==", "bodyText": "It looks like method is actually the only kwarg that overlaps between corr and corrwith. We should probably pass that explicitly, and handle the remaining arg, drop, here.", "url": "https://github.com/apache/beam/pull/13141#discussion_r512982235", "createdAt": "2020-10-27T19:45:32Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -771,6 +773,62 @@ def fill_matrix(*args):\n               requires_partition_by=partitionings.Singleton(),\n               proxy=proxy))\n \n+  @frame_base.args_to_kwargs(pd.DataFrame)\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def corrwith(self, other, axis, **kwargs):\n+    if axis not in (0, 'index'):\n+      raise NotImplementedError('corrwith(axis=%r)' % axis)\n+    if not isinstance(other, frame_base.DeferredFrame):\n+      other = frame_base.DeferredFrame.wrap(\n+          expressions.ConstantExpression(other))\n+\n+    if isinstance(other, DeferredSeries):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      corrs = [self[col].corr(other, **kwargs) for col in proxy.index]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4NDM3Ng==", "bodyText": "nit: The two branches here are almost identical, the only difference is valid_cols vs. proxy.index. You might consider re-working this so the other logic is shared. That might just make it more confusing though... up to you.", "url": "https://github.com/apache/beam/pull/13141#discussion_r512984376", "createdAt": "2020-10-27T19:48:16Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -771,6 +773,62 @@ def fill_matrix(*args):\n               requires_partition_by=partitionings.Singleton(),\n               proxy=proxy))\n \n+  @frame_base.args_to_kwargs(pd.DataFrame)\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def corrwith(self, other, axis, **kwargs):\n+    if axis not in (0, 'index'):\n+      raise NotImplementedError('corrwith(axis=%r)' % axis)\n+    if not isinstance(other, frame_base.DeferredFrame):\n+      other = frame_base.DeferredFrame.wrap(\n+          expressions.ConstantExpression(other))\n+\n+    if isinstance(other, DeferredSeries):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      corrs = [self[col].corr(other, **kwargs) for col in proxy.index]\n+      def fill_dataframe(*args):\n+        result = proxy.copy(deep=True)\n+        for col, value in zip(proxy.index, args):\n+          result[col] = value\n+        return result\n+      with expressions.allow_non_parallel_operations(True):\n+        return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+            'fill_dataframe',\n+            fill_dataframe,\n+            [corr._expr for corr in corrs],\n+            requires_partition_by=partitionings.Singleton(),\n+            proxy=proxy))\n+\n+    elif isinstance(other, DeferredDataFrame):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      valid_cols = list(\n+          set(self.columns)\n+          .intersection(other.columns)\n+          .intersection(proxy.index))\n+      corrs = [self[col].corr(other[col], **kwargs) for col in valid_cols]\n+      def fill_dataframe(*args):\n+        result = proxy.copy(deep=True)\n+        for col, value in zip(valid_cols, args):\n+          result[col] = value\n+        return result\n+      with expressions.allow_non_parallel_operations(True):\n+        return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+            'fill_dataframe',\n+            fill_dataframe,\n+            [corr._expr for corr in corrs],\n+            requires_partition_by=partitionings.Singleton(),\n+            proxy=proxy))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4NjUxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  corrs = [self[col].corr(other[col], **kwargs) for col in valid_cols]\n          \n          \n            \n                  def fill_dataframe(*args):\n          \n          \n            \n                  # Generate expressions to compute the actual correlations\n          \n          \n            \n                  corrs = [self[col].corr(other[col], **kwargs) for col in valid_cols]\n          \n          \n            \n                  # Combine the results\n          \n          \n            \n                  def fill_dataframe(*args):\n          \n      \n    \n    \n  \n\nIt took me a while to realize this is what was going on, hopefully this will expedite it for future readers.", "url": "https://github.com/apache/beam/pull/13141#discussion_r512986512", "createdAt": "2020-10-27T19:50:20Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -771,6 +773,62 @@ def fill_matrix(*args):\n               requires_partition_by=partitionings.Singleton(),\n               proxy=proxy))\n \n+  @frame_base.args_to_kwargs(pd.DataFrame)\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def corrwith(self, other, axis, **kwargs):\n+    if axis not in (0, 'index'):\n+      raise NotImplementedError('corrwith(axis=%r)' % axis)\n+    if not isinstance(other, frame_base.DeferredFrame):\n+      other = frame_base.DeferredFrame.wrap(\n+          expressions.ConstantExpression(other))\n+\n+    if isinstance(other, DeferredSeries):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      corrs = [self[col].corr(other, **kwargs) for col in proxy.index]\n+      def fill_dataframe(*args):\n+        result = proxy.copy(deep=True)\n+        for col, value in zip(proxy.index, args):\n+          result[col] = value\n+        return result\n+      with expressions.allow_non_parallel_operations(True):\n+        return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+            'fill_dataframe',\n+            fill_dataframe,\n+            [corr._expr for corr in corrs],\n+            requires_partition_by=partitionings.Singleton(),\n+            proxy=proxy))\n+\n+    elif isinstance(other, DeferredDataFrame):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      valid_cols = list(\n+          set(self.columns)\n+          .intersection(other.columns)\n+          .intersection(proxy.index))\n+      corrs = [self[col].corr(other[col], **kwargs) for col in valid_cols]\n+      def fill_dataframe(*args):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "925bd834e4dfb1c42172e5828e7c30f36e1e6681", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/925bd834e4dfb1c42172e5828e7c30f36e1e6681", "committedDate": "2020-10-28T17:24:58Z", "message": "Additional comments.\n\nCo-authored-by: Brian Hulette <hulettbh@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c25098245822cc663c4271dabd6f413db0ecde56", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/c25098245822cc663c4271dabd6f413db0ecde56", "committedDate": "2020-10-28T18:19:26Z", "message": "address reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTYwODI1", "url": "https://github.com/apache/beam/pull/13141#pullrequestreview-518960825", "createdAt": "2020-10-28T18:19:41Z", "commit": {"oid": "925bd834e4dfb1c42172e5828e7c30f36e1e6681"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxODoxOTo0MVrOHp3sQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxODoyMDowNlrOHp3tTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2NjExNQ==", "bodyText": "Good call. Done.", "url": "https://github.com/apache/beam/pull/13141#discussion_r513666115", "createdAt": "2020-10-28T18:19:41Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -575,6 +575,8 @@ def __setitem__(self, key, value):\n     else:\n       raise NotImplementedError(key)\n \n+  align = frame_base._elementwise_method('align')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk2MjY3Ng=="}, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2NjIyNA==", "bodyText": "Resolved.", "url": "https://github.com/apache/beam/pull/13141#discussion_r513666224", "createdAt": "2020-10-28T18:19:52Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -771,6 +773,62 @@ def fill_matrix(*args):\n               requires_partition_by=partitionings.Singleton(),\n               proxy=proxy))\n \n+  @frame_base.args_to_kwargs(pd.DataFrame)\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def corrwith(self, other, axis, **kwargs):\n+    if axis not in (0, 'index'):\n+      raise NotImplementedError('corrwith(axis=%r)' % axis)\n+    if not isinstance(other, frame_base.DeferredFrame):\n+      other = frame_base.DeferredFrame.wrap(\n+          expressions.ConstantExpression(other))\n+\n+    if isinstance(other, DeferredSeries):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      corrs = [self[col].corr(other, **kwargs) for col in proxy.index]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MjIzNQ=="}, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2NjM4Mw==", "bodyText": "I've consolidated them now.", "url": "https://github.com/apache/beam/pull/13141#discussion_r513666383", "createdAt": "2020-10-28T18:20:06Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -771,6 +773,62 @@ def fill_matrix(*args):\n               requires_partition_by=partitionings.Singleton(),\n               proxy=proxy))\n \n+  @frame_base.args_to_kwargs(pd.DataFrame)\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def corrwith(self, other, axis, **kwargs):\n+    if axis not in (0, 'index'):\n+      raise NotImplementedError('corrwith(axis=%r)' % axis)\n+    if not isinstance(other, frame_base.DeferredFrame):\n+      other = frame_base.DeferredFrame.wrap(\n+          expressions.ConstantExpression(other))\n+\n+    if isinstance(other, DeferredSeries):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      corrs = [self[col].corr(other, **kwargs) for col in proxy.index]\n+      def fill_dataframe(*args):\n+        result = proxy.copy(deep=True)\n+        for col, value in zip(proxy.index, args):\n+          result[col] = value\n+        return result\n+      with expressions.allow_non_parallel_operations(True):\n+        return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+            'fill_dataframe',\n+            fill_dataframe,\n+            [corr._expr for corr in corrs],\n+            requires_partition_by=partitionings.Singleton(),\n+            proxy=proxy))\n+\n+    elif isinstance(other, DeferredDataFrame):\n+      proxy = self._expr.proxy().corrwith(other._expr.proxy())\n+      self, other = self.align(other, axis=0, join='inner')\n+      valid_cols = list(\n+          set(self.columns)\n+          .intersection(other.columns)\n+          .intersection(proxy.index))\n+      corrs = [self[col].corr(other[col], **kwargs) for col in valid_cols]\n+      def fill_dataframe(*args):\n+        result = proxy.copy(deep=True)\n+        for col, value in zip(valid_cols, args):\n+          result[col] = value\n+        return result\n+      with expressions.allow_non_parallel_operations(True):\n+        return frame_base.DeferredFrame.wrap(\n+          expressions.ComputedExpression(\n+            'fill_dataframe',\n+            fill_dataframe,\n+            [corr._expr for corr in corrs],\n+            requires_partition_by=partitionings.Singleton(),\n+            proxy=proxy))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4NDM3Ng=="}, "originalCommit": {"oid": "b0ffe9ce91221a278c740cc89d8d154e68ab5ff7"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDMwNjg1", "url": "https://github.com/apache/beam/pull/13141#pullrequestreview-519030685", "createdAt": "2020-10-28T19:52:18Z", "commit": {"oid": "c25098245822cc663c4271dabd6f413db0ecde56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b54818fea0820c6c656237fafe53deaa8241d97", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/5b54818fea0820c6c656237fafe53deaa8241d97", "committedDate": "2020-10-28T20:57:38Z", "message": "Merge branch 'master' into dataframe-corr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1142e6576e32cd67cc9a28bd51ebc062f03945", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8b1142e6576e32cd67cc9a28bd51ebc062f03945", "committedDate": "2020-10-28T20:58:31Z", "message": "lint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2127, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}