{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjUxNzEy", "number": 10802, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyMzo1MVrODek5Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDowODoyMFrODeprRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzg4MzMxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyMzo1MVrOFnyijA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMDozNzoyMVrOFn0tOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NjgyOA==", "bodyText": "please use typing.NamedTuple so that we can track the types of members.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377266828", "createdAt": "2020-02-10T19:23:51Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3Mzk1OQ==", "bodyText": "I'm not sure whether I can use typing.NamedTuple directly since it is only supported since py3.5", "url": "https://github.com/apache/beam/pull/10802#discussion_r377273959", "createdAt": "2020-02-10T19:38:09Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NjgyOA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3NjQ5NA==", "bodyText": "You can do so safely.  typing is a requirement for python versions less than 3.8 (and there's a PR to adjust that to 3.5).  We're already importing typing in numerous places throughout the code.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377276494", "createdAt": "2020-02-10T19:43:07Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NjgyOA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMwMjMyOA==", "bodyText": "Changed in 8aa9821", "url": "https://github.com/apache/beam/pull/10802#discussion_r377302328", "createdAt": "2020-02-10T20:37:21Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NjgyOA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzg5MTU1OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyNjoyMFrOFnynmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDoxOToxMVrOFn6RBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODEyMA==", "bodyText": "why use a namedtuple here if there is only one member?", "url": "https://github.com/apache/beam/pull/10802#discussion_r377268120", "createdAt": "2020-02-10T19:26:20Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3Mzk4NA==", "bodyText": "To keep the similar structure with SplitResultResidual.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377273984", "createdAt": "2020-02-10T19:38:14Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODEyMA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3NzU3Mg==", "bodyText": "I'll leave the final call on that up to @robertwb, but my instinct is to use a type alias here, unless there's some need to do tuple operations on this type, or it's likely that it will grow more members in the future.\nI'm not sure of the exact type of windowed_value here, but a type alias would be something like:\nSplitResultPrimary = WindowedValue", "url": "https://github.com/apache/beam/pull/10802#discussion_r377277572", "createdAt": "2020-02-10T19:45:23Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODEyMA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MzQxNA==", "bodyText": "Nothing comes to mind immediately as to what fields we'd want to add here (though originally even the residual didn't have anything extra). Mostly I like the consistency, so I'd lean towards keeping it as is.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377393414", "createdAt": "2020-02-11T00:19:11Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODEyMA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzg5NDczOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyNzoxN1rOFnypfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMDowNjozOVrOFnz1kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODYwNA==", "bodyText": "no whitespace between type comment and docs.  not sure if this is caught by yapf or pylint, but the prevailing style is to omit this.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377268604", "createdAt": "2020-02-10T19:27:17Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):\n+  \"\"\"A thread-safe wrapper which wraps a `RestritionTracker`.\n+\n+  This wrapper guarantees synchronization of modifying restrictions across\n+  multi-thread.\n+  \"\"\"\n+  def __init__(self, restriction_tracker):\n+    # type: (RestrictionTracker) -> None\n+    from apache_beam.io.iobase import RestrictionTracker\n+    if not isinstance(restriction_tracker, RestrictionTracker):\n+      raise ValueError(\n+          'Initialize ThreadsafeRestrictionTracker requires'\n+          'RestrictionTracker.')\n+    self._restriction_tracker = restriction_tracker\n+    # Records an absolute timestamp when defer_remainder is called.\n+    self._deferred_timestamp = None\n+    self._lock = threading.RLock()\n+    self._deferred_residual = None\n+    self._deferred_watermark = None\n+\n+  def current_restriction(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_restriction()\n+\n+  def try_claim(self, position):\n+    with self._lock:\n+      return self._restriction_tracker.try_claim(position)\n+\n+  def defer_remainder(self, deferred_time=None):\n+    \"\"\"Performs self-checkpoint on current processing restriction with an\n+    expected resuming time.\n+\n+    Self-checkpoint could happen during processing elements. When executing an\n+    DoFn.process(), you may want to stop processing an element and resuming\n+    later if current element has been processed quit a long time or you also\n+    want to have some outputs from other elements. ``defer_remainder()`` can be\n+    called on per element if needed.\n+\n+    Args:\n+      deferred_time: A relative ``timestamp.Duration`` that indicates the ideal\n+      time gap between now and resuming, or an absolute ``timestamp.Timestamp``\n+      for resuming execution time. If the time_delay is None, the deferred work\n+      will be executed as soon as possible.\n+    \"\"\"\n+\n+    # Record current time for calculating deferred_time later.\n+    self._deferred_timestamp = timestamp.Timestamp.now()\n+    if (deferred_time and not isinstance(deferred_time, timestamp.Duration) and\n+        not isinstance(deferred_time, timestamp.Timestamp)):\n+      raise ValueError(\n+          'The timestamp of deter_remainder() should be a '\n+          'Duration or a Timestamp, or None.')\n+    self._deferred_watermark = deferred_time\n+    checkpoint = self.try_split(0)\n+    if checkpoint:\n+      _, self._deferred_residual = checkpoint\n+\n+  def check_done(self):\n+    with self._lock:\n+      return self._restriction_tracker.check_done()\n+\n+  def current_progress(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_progress()\n+\n+  def try_split(self, fraction_of_remainder):\n+    with self._lock:\n+      return self._restriction_tracker.try_split(fraction_of_remainder)\n+\n+  def deferred_status(self):\n+    # type: () -> Optional[Tuple[Any, Timestamp]]\n+\n+    \"\"\"Returns deferred work which is produced by ``defer_remainder()``.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4ODA4MQ==", "bodyText": "I just realized I was wrong about this.  I guess this is something that became standard after the yapf change.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377288081", "createdAt": "2020-02-10T20:06:39Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):\n+  \"\"\"A thread-safe wrapper which wraps a `RestritionTracker`.\n+\n+  This wrapper guarantees synchronization of modifying restrictions across\n+  multi-thread.\n+  \"\"\"\n+  def __init__(self, restriction_tracker):\n+    # type: (RestrictionTracker) -> None\n+    from apache_beam.io.iobase import RestrictionTracker\n+    if not isinstance(restriction_tracker, RestrictionTracker):\n+      raise ValueError(\n+          'Initialize ThreadsafeRestrictionTracker requires'\n+          'RestrictionTracker.')\n+    self._restriction_tracker = restriction_tracker\n+    # Records an absolute timestamp when defer_remainder is called.\n+    self._deferred_timestamp = None\n+    self._lock = threading.RLock()\n+    self._deferred_residual = None\n+    self._deferred_watermark = None\n+\n+  def current_restriction(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_restriction()\n+\n+  def try_claim(self, position):\n+    with self._lock:\n+      return self._restriction_tracker.try_claim(position)\n+\n+  def defer_remainder(self, deferred_time=None):\n+    \"\"\"Performs self-checkpoint on current processing restriction with an\n+    expected resuming time.\n+\n+    Self-checkpoint could happen during processing elements. When executing an\n+    DoFn.process(), you may want to stop processing an element and resuming\n+    later if current element has been processed quit a long time or you also\n+    want to have some outputs from other elements. ``defer_remainder()`` can be\n+    called on per element if needed.\n+\n+    Args:\n+      deferred_time: A relative ``timestamp.Duration`` that indicates the ideal\n+      time gap between now and resuming, or an absolute ``timestamp.Timestamp``\n+      for resuming execution time. If the time_delay is None, the deferred work\n+      will be executed as soon as possible.\n+    \"\"\"\n+\n+    # Record current time for calculating deferred_time later.\n+    self._deferred_timestamp = timestamp.Timestamp.now()\n+    if (deferred_time and not isinstance(deferred_time, timestamp.Duration) and\n+        not isinstance(deferred_time, timestamp.Timestamp)):\n+      raise ValueError(\n+          'The timestamp of deter_remainder() should be a '\n+          'Duration or a Timestamp, or None.')\n+    self._deferred_watermark = deferred_time\n+    checkpoint = self.try_split(0)\n+    if checkpoint:\n+      _, self._deferred_residual = checkpoint\n+\n+  def check_done(self):\n+    with self._lock:\n+      return self._restriction_tracker.check_done()\n+\n+  def current_progress(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_progress()\n+\n+  def try_split(self, fraction_of_remainder):\n+    with self._lock:\n+      return self._restriction_tracker.try_split(fraction_of_remainder)\n+\n+  def deferred_status(self):\n+    # type: () -> Optional[Tuple[Any, Timestamp]]\n+\n+    \"\"\"Returns deferred work which is produced by ``defer_remainder()``.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2ODYwNA=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzg5NzY2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyODoxNVrOFnyrTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxOTo0MzozNFrOFoWn0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTA2OQ==", "bodyText": "I know that this class is just being copied over from another file, but I'd love to see some type annotations added to it.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377269069", "createdAt": "2020-02-10T19:28:15Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3NTkwOQ==", "bodyText": "Thanks for pointing this out, but I don't think adding type annotations should be in the scope of this PR. The plan is, after this PR checked in, I'll modify #10375 and checked it in. Then have another PR to do the type stuff.\nAnd I'm curious how can we test the typing? Do we run tox -e mypy?", "url": "https://github.com/apache/beam/pull/10802#discussion_r377275909", "createdAt": "2020-02-10T19:41:57Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTA2OQ=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MzE1MQ==", "bodyText": "sounds good.\n\nAnd I'm curious how can we test the typing? Do we run tox -e mypy?\n\ntox -e py37-mypy\nNote that there's an issue with the tox config that's preventing colored output in mypy.  So you may want to do (from a python3 venv):\npip install mypy\ncd sdks/python\nmypy\n\nThere's also a fair bit of mypy error noise still since not all the PRs have been merged yet, so you'll want to focus on file paths relevant to you change.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377283151", "createdAt": "2020-02-10T19:56:10Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTA2OQ=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjU5Mg==", "bodyText": "I agree that adding types would be nice, but is probably out of scope. (It would make sense to add types on the base class at the same time.)", "url": "https://github.com/apache/beam/pull/10802#discussion_r377392592", "createdAt": "2020-02-11T00:16:13Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTA2OQ=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg1ODAwMg==", "bodyText": "Create a JIRA here: https://issues.apache.org/jira/browse/BEAM-9296. I'll follow up when finishing API changes.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377858002", "createdAt": "2020-02-11T19:43:34Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTA2OQ=="}, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzg5ODc3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyODozMlrOFnyr9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToyODozMlrOFnyr9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2OTIzOA==", "bodyText": "same thing here wrt type annotations", "url": "https://github.com/apache/beam/pull/10802#discussion_r377269238", "createdAt": "2020-02-10T19:28:32Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,173 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from collections import namedtuple\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import Optional\n+from typing import Tuple\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+\n+SplitResultPrimary = namedtuple(\n+    'SplitResultPrimary', 'windowed_value')\n+\n+SplitResultResidual = namedtuple(\n+    'SplitResultResidual',\n+    'windowed_value current_watermark deferred_timestamp')\n+\n+class ThreadsafeRestrictionTracker(object):\n+  \"\"\"A thread-safe wrapper which wraps a `RestritionTracker`.\n+\n+  This wrapper guarantees synchronization of modifying restrictions across\n+  multi-thread.\n+  \"\"\"\n+  def __init__(self, restriction_tracker):\n+    # type: (RestrictionTracker) -> None\n+    from apache_beam.io.iobase import RestrictionTracker\n+    if not isinstance(restriction_tracker, RestrictionTracker):\n+      raise ValueError(\n+          'Initialize ThreadsafeRestrictionTracker requires'\n+          'RestrictionTracker.')\n+    self._restriction_tracker = restriction_tracker\n+    # Records an absolute timestamp when defer_remainder is called.\n+    self._deferred_timestamp = None\n+    self._lock = threading.RLock()\n+    self._deferred_residual = None\n+    self._deferred_watermark = None\n+\n+  def current_restriction(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_restriction()\n+\n+  def try_claim(self, position):\n+    with self._lock:\n+      return self._restriction_tracker.try_claim(position)\n+\n+  def defer_remainder(self, deferred_time=None):\n+    \"\"\"Performs self-checkpoint on current processing restriction with an\n+    expected resuming time.\n+\n+    Self-checkpoint could happen during processing elements. When executing an\n+    DoFn.process(), you may want to stop processing an element and resuming\n+    later if current element has been processed quit a long time or you also\n+    want to have some outputs from other elements. ``defer_remainder()`` can be\n+    called on per element if needed.\n+\n+    Args:\n+      deferred_time: A relative ``timestamp.Duration`` that indicates the ideal\n+      time gap between now and resuming, or an absolute ``timestamp.Timestamp``\n+      for resuming execution time. If the time_delay is None, the deferred work\n+      will be executed as soon as possible.\n+    \"\"\"\n+\n+    # Record current time for calculating deferred_time later.\n+    self._deferred_timestamp = timestamp.Timestamp.now()\n+    if (deferred_time and not isinstance(deferred_time, timestamp.Duration) and\n+        not isinstance(deferred_time, timestamp.Timestamp)):\n+      raise ValueError(\n+          'The timestamp of deter_remainder() should be a '\n+          'Duration or a Timestamp, or None.')\n+    self._deferred_watermark = deferred_time\n+    checkpoint = self.try_split(0)\n+    if checkpoint:\n+      _, self._deferred_residual = checkpoint\n+\n+  def check_done(self):\n+    with self._lock:\n+      return self._restriction_tracker.check_done()\n+\n+  def current_progress(self):\n+    with self._lock:\n+      return self._restriction_tracker.current_progress()\n+\n+  def try_split(self, fraction_of_remainder):\n+    with self._lock:\n+      return self._restriction_tracker.try_split(fraction_of_remainder)\n+\n+  def deferred_status(self):\n+    # type: () -> Optional[Tuple[Any, Timestamp]]\n+\n+    \"\"\"Returns deferred work which is produced by ``defer_remainder()``.\n+\n+    When there is a self-checkpoint performed, the system needs to fulfill the\n+    DelayedBundleApplication with deferred_work for a  ProcessBundleResponse.\n+    The system calls this API to get deferred_residual with watermark together\n+    to help the runner to schedule a future work.\n+\n+    Returns: (deferred_residual, time_delay) if having any residual, else None.\n+    \"\"\"\n+    if self._deferred_residual:\n+      # If _deferred_watermark is None, create Duration(0).\n+      if not self._deferred_watermark:\n+        self._deferred_watermark = timestamp.Duration()\n+      # If an absolute timestamp is provided, calculate the delta between\n+      # the absoluted time and the time deferred_status() is called.\n+      elif isinstance(self._deferred_watermark, timestamp.Timestamp):\n+        self._deferred_watermark = (\n+            self._deferred_watermark - timestamp.Timestamp.now())\n+      # If a Duration is provided, the deferred time should be:\n+      # provided duration - the spent time since the defer_remainder() is\n+      # called.\n+      elif isinstance(self._deferred_watermark, timestamp.Duration):\n+        self._deferred_watermark -= (\n+            timestamp.Timestamp.now() - self._deferred_timestamp)\n+      return self._deferred_residual, self._deferred_watermark\n+    return None\n+\n+\n+class RestrictionTrackerView(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b2a312a7afbc96f8711ed14b5f3e8d0079d86db"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNDY2MDEyOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDowNDo0M1rOFn6Brw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDowNDo0M1rOFn6Brw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4OTQ4Nw==", "bodyText": "You can still use tuple unpacking here, e.g.\n(element_and_restriction, deferred_timestamp, current_watermark) = deferred_remainder", "url": "https://github.com/apache/beam/pull/10802#discussion_r377389487", "createdAt": "2020-02-11T00:04:43Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -906,26 +906,25 @@ def delayed_bundle_application(self,\n     # type: (...) -> beam_fn_api_pb2.DelayedBundleApplication\n     assert op.input_info is not None\n     # TODO(SDF): For non-root nodes, need main_input_coder + residual_coder.\n-    ((element_and_restriction, output_watermark),\n-     deferred_watermark) = deferred_remainder\n-    if deferred_watermark:\n-      assert isinstance(deferred_watermark, timestamp.Duration)\n+    element_and_restriction = deferred_remainder.windowed_value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9821439fbb941c83c61e34b52aedc1404dacc"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNDY2NjkyOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/sdf_utils.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDowODoyMFrOFn6FxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMToyMzo1N1rOFn7TCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MDUzMg==", "bodyText": "Maybe call this field primary[_value] and the other residual[_value]?", "url": "https://github.com/apache/beam/pull/10802#discussion_r377390532", "createdAt": "2020-02-11T00:08:20Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import NamedTuple\n+from typing import Optional\n+from typing import Tuple\n+from apache_beam.utils.windowed_value import WindowedValue\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+SplitResultPrimary = NamedTuple(\n+    'SplitResultPrimary', [('windowed_value', WindowedValue)])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9821439fbb941c83c61e34b52aedc1404dacc"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxMDMxNA==", "bodyText": "Thanks! Like the idea of primary_value and residual_value.", "url": "https://github.com/apache/beam/pull/10802#discussion_r377410314", "createdAt": "2020-02-11T01:23:57Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -0,0 +1,176 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Common utility class to help SDK harness to execute an SDF. \"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import logging\n+import threading\n+from builtins import object\n+from typing import TYPE_CHECKING\n+from typing import Any\n+from typing import NamedTuple\n+from typing import Optional\n+from typing import Tuple\n+from apache_beam.utils.windowed_value import WindowedValue\n+\n+from apache_beam.utils import timestamp\n+\n+if TYPE_CHECKING:\n+  from apache_beam.io.iobase import RestrictionTracker\n+  from apache_beam.utils.timestamp import Timestamp\n+\n+_LOGGER = logging.getLogger(__name__)\n+\n+SplitResultPrimary = NamedTuple(\n+    'SplitResultPrimary', [('windowed_value', WindowedValue)])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MDUzMg=="}, "originalCommit": {"oid": "8aa9821439fbb941c83c61e34b52aedc1404dacc"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2184, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}