{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMjAxNDA0", "number": 13211, "title": "[BEAM-8106] Separate Java8/11 container image build tasks", "bodyText": "Rename existing Java8 docker container and add separate gradle task for Java 11 container\nThis PR:\n\nSplits out docker build tasks into common.gradle\nAdd new build.gradle for Java8/11\nChanges the runner test tasks to use -PcompileAndRunTestsWithJava11 to determine which test container image is used (Beam worker harness container image does not get inferred from Java 11 version)\n\nFollow-up PR will actually add Java 11 container to release and a validateRunner test suite.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-28T00:48:24Z", "url": "https://github.com/apache/beam/pull/13211", "merged": true, "mergeCommit": {"oid": "30c1eeff298c9081f9c72ffdcaf24cdcacd9833c"}, "closed": true, "closedAt": "2020-11-17T20:34:31Z", "author": {"login": "emilymye"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXuqWXgBqjM5NDMzNjcyNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdywuNhAFqTU3NDY2MjkxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07594e701fa46174a04f1a5531dc361e26f378d0", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/07594e701fa46174a04f1a5531dc361e26f378d0", "committedDate": "2020-10-28T00:40:52Z", "message": "add Java 11 image to released images"}, "afterCommit": {"oid": "7438e08ecdaaa43a587b3b2ec7e9596b95ee563a", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/7438e08ecdaaa43a587b3b2ec7e9596b95ee563a", "committedDate": "2020-10-30T22:39:03Z", "message": "add separate docker Gradle tasks for java8/11"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7438e08ecdaaa43a587b3b2ec7e9596b95ee563a", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/7438e08ecdaaa43a587b3b2ec7e9596b95ee563a", "committedDate": "2020-10-30T22:39:03Z", "message": "add separate docker Gradle tasks for java8/11"}, "afterCommit": {"oid": "3b51fc106d3f796484527a0f39bfacd243f0eb27", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/3b51fc106d3f796484527a0f39bfacd243f0eb27", "committedDate": "2020-10-31T04:01:31Z", "message": "add separate gradle task for java11 container image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b51fc106d3f796484527a0f39bfacd243f0eb27", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/3b51fc106d3f796484527a0f39bfacd243f0eb27", "committedDate": "2020-10-31T04:01:31Z", "message": "add separate gradle task for java11 container image"}, "afterCommit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2", "committedDate": "2020-11-02T21:21:35Z", "message": "add separate java8/11 image tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDM2NTcx", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-522036571", "createdAt": "2020-11-02T22:07:48Z", "commit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjowNzo0OFrOHsXawg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjowNzo0OFrOHsXawg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI4MzA3NA==", "bodyText": "since this uses the runner buildAndPushDockerContainer task which now checks for -PcompileAndRunTestsWithJava11, we don't need this flag anymore", "url": "https://github.com/apache/beam/pull/13211#discussion_r516283074", "createdAt": "2020-11-02T22:07:48Z", "author": {"login": "emilymye"}, "path": ".test-infra/jenkins/job_PreCommit_Java_Examples_Dataflow_Java11.groovy", "diffHunk": "@@ -46,7 +46,6 @@ builder.build {\n     gradle {\n       rootBuildScriptDir(properties.checkoutDir)\n       tasks 'javaExamplesDataflowPreCommit'\n-      switches '-PimageJavaVersion=11'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDM3OTQ3", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-522037947", "createdAt": "2020-11-02T22:08:30Z", "commit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjowODozMFrOHsXcJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjowODozMFrOHsXcJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI4MzQyOQ==", "bodyText": "Docker tasks were split out into common.gradle", "url": "https://github.com/apache/beam/pull/13211#discussion_r516283429", "createdAt": "2020-11-02T22:08:30Z", "author": {"login": "emilymye"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -54,17 +55,6 @@ dependencies {\n   dockerDependency library.java.kafka_clients\n }\n \n-task copyDockerfileDependencies(type: Copy) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60bbbc4c019b72a6f16ae60b97ac8f88e7b8301f", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/60bbbc4c019b72a6f16ae60b97ac8f88e7b8301f", "committedDate": "2020-11-02T22:11:19Z", "message": "change evaluationDependsOn to separate java8/11 tasks"}, "afterCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/a3f65fe426a473ff9f5c48457c0ec316be15dfdf", "committedDate": "2020-11-10T18:54:01Z", "message": "change evaluationDependsOn to separate java8/11 tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTc5MjY3", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-527579267", "createdAt": "2020-11-10T20:25:23Z", "commit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDoyNToyM1rOHwuTYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0NDo1OVrOHwu7dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjMyMw==", "bodyText": "Ack, thank you", "url": "https://github.com/apache/beam/pull/13211#discussion_r520852323", "createdAt": "2020-11-10T20:25:23Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -54,17 +55,6 @@ dependencies {\n   dockerDependency library.java.kafka_clients\n }\n \n-task copyDockerfileDependencies(type: Copy) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI4MzQyOQ=="}, "originalCommit": {"oid": "0971c9c7ef3ecc2d7bf61f7a1464840dab0db1c2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1NDA1OQ==", "bodyText": "(not a blocker for this PR) @kennknowles can you comment on why we need this? It would be good to have a comment explaining it. Looks like it was added in ebd65e5", "url": "https://github.com/apache/beam/pull/13211#discussion_r520854059", "createdAt": "2020-11-10T20:28:56Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -86,51 +76,21 @@ licenseReport {\n   renderers = [new JsonReportRenderer()]\n }\n \n-def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion') : '8'\n-docker {\n-  name containerImageName(\n-          name: \"${project.docker_image_default_repo_prefix}java${imageJavaVersion}_sdk\",\n-          root: project.rootProject.hasProperty([\"docker-repository-root\"]) ?\n-                  project.rootProject[\"docker-repository-root\"] :\n-                  project.docker_image_default_repo_root,\n-          tag: project.rootProject.hasProperty([\"docker-tag\"]) ?\n-                  project.rootProject[\"docker-tag\"] : project.sdk_version)\n-  dockerfile project.file(\"./Dockerfile\")\n-  files \"./build/\"\n-  buildArgs([\n-    'pull_licenses': project.rootProject.hasProperty([\"docker-pull-licenses\"]) ||\n-                     project.rootProject.hasProperty([\"isRelease\"]),\n-    'java_version': imageJavaVersion,\n-  ])\n+task buildAll {\n+  dependsOn ':sdks:java:container:java8:docker'\n+  dependsOn ':sdks:java:container:java11:docker'\n }\n \n task pullLicenses(type: Exec) {\n+  dependsOn generateLicenseReport\n+  generateLicenseReport.outputs.cacheIf { false }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1OTU0OA==", "bodyText": "Maybe we should keep the :sdks:java:container:docker task for a bit and just have it error with a message directing people to java8:docker and/or java11:docker?", "url": "https://github.com/apache/beam/pull/13211#discussion_r520859548", "createdAt": "2020-11-10T20:39:32Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -86,51 +76,21 @@ licenseReport {\n   renderers = [new JsonReportRenderer()]\n }\n \n-def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion') : '8'\n-docker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MjU4MA==", "bodyText": "Are there plans to make this and the other portable tests runnable with the Java 11 container? Seems like we should drop a TODO and/or file a jira", "url": "https://github.com/apache/beam/pull/13211#discussion_r520862580", "createdAt": "2020-11-10T20:44:59Z", "author": {"login": "TheNeuralBit"}, "path": "runners/portability/java/build.gradle", "diffHunk": "@@ -214,7 +214,7 @@ def createUlrValidatesRunnerTask = { name, environmentType ->\n   }\n \n   if (environmentType == \"DOCKER\") {\n-    vrTask.dependsOn \":sdks:java:container:docker\"\n+    vrTask.dependsOn \":sdks:java:container:java8:docker\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjAwNTY0", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-527600564", "createdAt": "2020-11-10T20:56:54Z", "commit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo1Njo1NFrOHwvUFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMTowNTozNFrOHwvlsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2ODg4NQ==", "bodyText": "Seems just as easy to make it a parameter. You could make the $ver a parameter as elsewhere in this PR or you could go further and pass in the name of the target to depend on.\nPro: if anyone renames the target they can search and find the fact that it is depended on.\nCon: if anyone renames the target they do have to change it in all those places so if done manually it is more work. Also the control flow reading is a little more complex.\nAll in all, I dislike mechanical assembly of target names, whether for definition or execution. So I prefer treating the whole target name as an atomic value and passing it in.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520868885", "createdAt": "2020-11-10T20:56:54Z", "author": {"login": "kennknowles"}, "path": "runners/portability/java/build.gradle", "diffHunk": "@@ -214,7 +214,7 @@ def createUlrValidatesRunnerTask = { name, environmentType ->\n   }\n \n   if (environmentType == \"DOCKER\") {\n-    vrTask.dependsOn \":sdks:java:container:docker\"\n+    vrTask.dependsOn \":sdks:java:container:java8:docker\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MjU4MA=="}, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTIyOQ==", "bodyText": "Unused?", "url": "https://github.com/apache/beam/pull/13211#discussion_r520869229", "createdAt": "2020-11-10T20:57:32Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -86,51 +76,21 @@ licenseReport {\n   renderers = [new JsonReportRenderer()]\n }\n \n-def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion') : '8'\n-docker {\n-  name containerImageName(\n-          name: \"${project.docker_image_default_repo_prefix}java${imageJavaVersion}_sdk\",\n-          root: project.rootProject.hasProperty([\"docker-repository-root\"]) ?\n-                  project.rootProject[\"docker-repository-root\"] :\n-                  project.docker_image_default_repo_root,\n-          tag: project.rootProject.hasProperty([\"docker-tag\"]) ?\n-                  project.rootProject[\"docker-tag\"] : project.sdk_version)\n-  dockerfile project.file(\"./Dockerfile\")\n-  files \"./build/\"\n-  buildArgs([\n-    'pull_licenses': project.rootProject.hasProperty([\"docker-pull-licenses\"]) ||\n-                     project.rootProject.hasProperty([\"isRelease\"]),\n-    'java_version': imageJavaVersion,\n-  ])\n+task buildAll {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTc4NQ==", "bodyText": "I noticed when I was fixing this file up that the dependency report was being pulled from the build cache. I guess it doesn't depend on the build.gradle so when deps change or when the config changes it doesn't update the report. I could be wrong. It may have been a temporary problem related to the particular change I was making.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520869785", "createdAt": "2020-11-10T20:58:37Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/build.gradle", "diffHunk": "@@ -86,51 +76,21 @@ licenseReport {\n   renderers = [new JsonReportRenderer()]\n }\n \n-def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion') : '8'\n-docker {\n-  name containerImageName(\n-          name: \"${project.docker_image_default_repo_prefix}java${imageJavaVersion}_sdk\",\n-          root: project.rootProject.hasProperty([\"docker-repository-root\"]) ?\n-                  project.rootProject[\"docker-repository-root\"] :\n-                  project.docker_image_default_repo_root,\n-          tag: project.rootProject.hasProperty([\"docker-tag\"]) ?\n-                  project.rootProject[\"docker-tag\"] : project.sdk_version)\n-  dockerfile project.file(\"./Dockerfile\")\n-  files \"./build/\"\n-  buildArgs([\n-    'pull_licenses': project.rootProject.hasProperty([\"docker-pull-licenses\"]) ||\n-                     project.rootProject.hasProperty([\"isRelease\"]),\n-    'java_version': imageJavaVersion,\n-  ])\n+task buildAll {\n+  dependsOn ':sdks:java:container:java8:docker'\n+  dependsOn ':sdks:java:container:java11:docker'\n }\n \n task pullLicenses(type: Exec) {\n+  dependsOn generateLicenseReport\n+  generateLicenseReport.outputs.cacheIf { false }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1NDA1OQ=="}, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTEzMg==", "bodyText": "It would be handy to have some reverse pointers from this file to where it is used, in case things move around. Since this file is essentially meant to be used as a parameterized entrypoint for the other two modules. I know it may seem obvious but someone without context coming here will take a minute to sort it out.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520871132", "createdAt": "2020-11-10T21:01:08Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/common.gradle", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+applyDockerNature()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTQwMQ==", "bodyText": "My dream, which may be impossible, is that this can be passed as a parameter somehow to the apply from: line so that the control and data flow are more clear.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520871401", "createdAt": "2020-11-10T21:01:41Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/java11/build.gradle", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+plugins {\n+    id 'base'\n+    id 'org.apache.beam.module'\n+}\n+\n+project.ext {\n+    imageJavaVersion = '11'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTY1Mw==", "bodyText": "I suggest making this non-optional and failing if the file is included by a project that did not pass the parameter.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520871653", "createdAt": "2020-11-10T21:02:07Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/common.gradle", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+applyDockerNature()\n+\n+def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion').replace(\"java\", \"\") : '8'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MjI2Nw==", "bodyText": "I would also suggest potentially passing in the whole atomic name. Also maybe no need for \"Python\" in the name.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520872267", "createdAt": "2020-11-10T21:03:22Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/common.gradle", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+applyDockerNature()\n+\n+def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion').replace(\"java\", \"\") : '8'\n+\n+description = \"Apache Beam :: SDKs :: Python :: Container :: Java ${imageJavaVersion} Container\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MzM5Mw==", "bodyText": "Same comment about trying to keep names a bit less constructed by string append. I can see that the Java version is used in a bunch of places that need to match, so I can accept that one being injected.\nHow much of this could go in e.g. applyDockerNature(...) ?\nI don't like how all of our different types of builds are defined on one monolithic file (BeamModulePlugin) with a bunch of cross-dependencies. At some point I'd love them to be factored apart into more independent plugins. But relative to the status quo, this file does seem like another kind of \"nature\". So this adds another kind of composition for folks to know about. In fairness, this composition is simpler and cleaner than the monolithic file. However, this is exactly how the monolithic file came to be: we had an apply from:... situation that grew and grew until it was impossible to deal with.", "url": "https://github.com/apache/beam/pull/13211#discussion_r520873393", "createdAt": "2020-11-10T21:05:34Z", "author": {"login": "kennknowles"}, "path": "sdks/java/container/common.gradle", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+applyDockerNature()\n+\n+def imageJavaVersion = project.hasProperty('imageJavaVersion') ? project.findProperty('imageJavaVersion').replace(\"java\", \"\") : '8'\n+\n+description = \"Apache Beam :: SDKs :: Python :: Container :: Java ${imageJavaVersion} Container\"\n+\n+configurations {\n+    dockerDependency\n+    sdkHarnessLauncher\n+    pulledLicenses\n+}\n+\n+dependencies {\n+    pulledLicenses project(path: \":sdks:java:container\", configuration: \"pulledLicenses\")\n+    dockerDependency project(path: \":sdks:java:container\", configuration: \"dockerDependency\")\n+    sdkHarnessLauncher project(path: \":sdks:java:container\", configuration: \"sdkHarnessLauncher\")\n+}\n+\n+task copyDockerfileDependencies(type: Copy) {\n+    from configurations.dockerDependency\n+    rename \"slf4j-api.*\", \"slf4j-api.jar\"\n+    rename \"slf4j-jdk14.*\", \"slf4j-jdk14.jar\"\n+    rename 'beam-sdks-java-harness-.*.jar', 'beam-sdks-java-harness.jar'\n+    rename 'beam-sdks-java-io-kafka.*.jar', 'beam-sdks-java-io-kafka.jar'\n+    rename 'kafka-clients.*.jar', 'kafka-clients.jar'\n+    into \"build/target\"\n+}\n+\n+task copySdkHarnessLauncher(type: Copy) {\n+    from configurations.sdkHarnessLauncher\n+    into \"build/target\"\n+}\n+\n+task copyPulledLicenses(type: Copy) {\n+    from configurations.pulledLicenses\n+    into \"build/target\"\n+}\n+\n+task copyGolangLicenses(type: Copy) {\n+    from \"${project(':release:go-licenses:java').buildDir}/output\"\n+    into \"build/target/go-licenses\"\n+    dependsOn ':release:go-licenses:java:createLicenses'\n+}\n+\n+task skipPullLicenses(type: Exec) {\n+    executable \"sh\"\n+    args \"-c\", \"mkdir -p build/target/third_party_licenses && touch build/target/third_party_licenses/skip\"\n+}\n+\n+docker {\n+    name containerImageName(\n+            name: \"${project.docker_image_default_repo_prefix}java${imageJavaVersion}_sdk\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3f65fe426a473ff9f5c48457c0ec316be15dfdf", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/a3f65fe426a473ff9f5c48457c0ec316be15dfdf", "committedDate": "2020-11-10T18:54:01Z", "message": "change evaluationDependsOn to separate java8/11 tasks"}, "afterCommit": {"oid": "e366f9f3c19abba3abd32d9942e59508fd4f598b", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/e366f9f3c19abba3abd32d9942e59508fd4f598b", "committedDate": "2020-11-12T07:59:07Z", "message": "fixes to common java build script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNjUwODYz", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-531650863", "createdAt": "2020-11-16T19:46:36Z", "commit": {"oid": "e366f9f3c19abba3abd32d9942e59508fd4f598b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxOTo0NjozNlrOH0OuEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxOTo0NjozNlrOH0OuEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyOTE2OA==", "bodyText": "typo nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Build script containign common build tasks for Java SDK Docker images.\n          \n          \n            \n             * Build script containing common build tasks for Java SDK Docker images.", "url": "https://github.com/apache/beam/pull/13211#discussion_r524529168", "createdAt": "2020-11-16T19:46:36Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/container/common.gradle", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * License); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an AS IS BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/**\n+ * Build script containign common build tasks for Java SDK Docker images.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e366f9f3c19abba3abd32d9942e59508fd4f598b"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNjUxNzQ0", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-531651744", "createdAt": "2020-11-16T19:47:48Z", "commit": {"oid": "e366f9f3c19abba3abd32d9942e59508fd4f598b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "847f62d7d8a7bd6306d78978ca5c66ac9714ecc0", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/847f62d7d8a7bd6306d78978ca5c66ac9714ecc0", "committedDate": "2020-11-16T22:44:40Z", "message": "add separate java8/11 image tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0ecf8c88a39af667246e9099a4d9eb61599260", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/dc0ecf8c88a39af667246e9099a4d9eb61599260", "committedDate": "2020-11-16T22:44:50Z", "message": "change evaluationDependsOn to separate java8/11 tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f235085b28b05b839972a36d00428f98e51dca6d", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/f235085b28b05b839972a36d00428f98e51dca6d", "committedDate": "2020-11-16T22:44:52Z", "message": "add dockerTaskArg to createUlrValidatesRunnerTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac4b867ad4b22df9b2af3cdca461a8adff9afd1", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/6ac4b867ad4b22df9b2af3cdca461a8adff9afd1", "committedDate": "2020-11-16T22:44:53Z", "message": "remove buildall task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dfed762930123b1919d888512548c6e95fdbafb", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/0dfed762930123b1919d888512548c6e95fdbafb", "committedDate": "2020-11-16T22:44:54Z", "message": "fixes to common java build script"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e366f9f3c19abba3abd32d9942e59508fd4f598b", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/e366f9f3c19abba3abd32d9942e59508fd4f598b", "committedDate": "2020-11-12T07:59:07Z", "message": "fixes to common java build script"}, "afterCommit": {"oid": "0dfed762930123b1919d888512548c6e95fdbafb", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/0dfed762930123b1919d888512548c6e95fdbafb", "committedDate": "2020-11-16T22:44:54Z", "message": "fixes to common java build script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a859e4a1329c94a2c428bc8b52db7c9db086fa0", "author": {"user": {"login": "emilymye", "name": "emily"}}, "url": "https://github.com/apache/beam/commit/6a859e4a1329c94a2c428bc8b52db7c9db086fa0", "committedDate": "2020-11-17T01:35:54Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc0NjYyOTE4", "url": "https://github.com/apache/beam/pull/13211#pullrequestreview-574662918", "createdAt": "2021-01-22T22:19:21Z", "commit": {"oid": "6a859e4a1329c94a2c428bc8b52db7c9db086fa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQyMjoxOToyMVrOIY3eGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQyMjoxOToyMVrOIY3eGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjk0NTU2MQ==", "bodyText": "The finalizeBy definition here breaks the Kafka Performance Test[1] because it makes the docker image get cleaned up as soon as it is pushed.\nWe define the cleanup logic here: https://github.com/apache/beam/blame/master/runners/google-cloud-dataflow-java/build.gradle#L280-L287\n[1] https://ci-beam.apache.org/job/beam_PerformanceTests_Kafka_IO/", "url": "https://github.com/apache/beam/pull/13211#discussion_r562945561", "createdAt": "2021-01-22T22:19:21Z", "author": {"login": "boyuanzz"}, "path": "runners/google-cloud-dataflow-java/build.gradle", "diffHunk": "@@ -246,9 +247,11 @@ def createRunnerV2ValidatesRunnerTest = { Map args ->\n // task directly ('dependsOn buildAndPushDockerContainer'). This ensures the correct\n // task ordering such that the registry doesn't get cleaned up prior to task completion.\n task buildAndPushDockerContainer() {\n-  dependsOn \":sdks:java:container:docker\"\n+  def javaVer = project.hasProperty('compileAndRunTestsWithJava11') ? \"java11\" : \"java8\"\n+  dependsOn \":sdks:java:container:${javaVer}:docker\"\n+  finalizedBy 'cleanUpDockerImages'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a859e4a1329c94a2c428bc8b52db7c9db086fa0"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1787, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}