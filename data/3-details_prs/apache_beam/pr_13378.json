{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDc2OTY1", "number": 13378, "title": "[BEAM-11208] Fix for QUOTA_EXCEEDED failures in BQ Storage streams sp\u2026", "bodyText": "Fix for BigQuery storage streams failing with QUOTA_EXCEEDED errors in split.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-18T21:16:05Z", "url": "https://github.com/apache/beam/pull/13378", "merged": true, "mergeCommit": {"oid": "1c453dc70528a5492b4748de6c7960dbf020e447"}, "closed": true, "closedAt": "2020-12-11T20:50:24Z", "author": {"login": "vachan-shetty"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd0uM5AH2gAyNTIzNDc2OTY1OmIzMWViNjdlM2VmMTQyOGFmOTkwNjVmNzRjYTAwNGMwNTU2ODk1YjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd22zFAFqTUzMzk2NzQwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b31eb67e3ef1428af99065f74ca004c0556895b6", "author": {"user": {"login": "vachan-shetty", "name": "Vachan"}}, "url": "https://github.com/apache/beam/commit/b31eb67e3ef1428af99065f74ca004c0556895b6", "committedDate": "2020-11-18T21:06:34Z", "message": "[BEAM-11208] Fix for QUOTA_EXCEEDED failures in BQ Storage streams split."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5", "author": {"user": {"login": "vachan-shetty", "name": "Vachan"}}, "url": "https://github.com/apache/beam/commit/af007bf2dea579539de1724230c6b065d97ae8e5", "committedDate": "2020-11-18T22:07:43Z", "message": "[BEAM-11208] Fix formatting issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTIzMzcx", "url": "https://github.com/apache/beam/pull/13378#pullrequestreview-533923371", "createdAt": "2020-11-18T22:11:33Z", "commit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMTozNFrOH2EYwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMzowM1rOH2EbeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzAyNA==", "bodyText": "Nit: I would just initialize this in the declaration above (e.g. private boolean splitPossible = true;) rather than in the constructor.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526457024", "createdAt": "2020-11-18T22:11:34Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -178,6 +179,7 @@ private BigQueryStorageStreamReader(\n       this.parseFn = source.parseFn;\n       this.storageClient = source.bqServices.getStorageClient(options);\n       this.tableSchema = fromJsonString(source.jsonTableSchema, TableSchema.class);\n+      this.splitPossible = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzcyMA==", "bodyText": "Nit: I would structure this check as an early return (e.g. if (!splitPossible) { return null; }) rather than putting the whole implementation into a new block.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526457720", "createdAt": "2020-11-18T22:13:03Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -288,78 +290,85 @@ public synchronized void close() {\n         return null;\n       }\n \n-      SplitReadStreamRequest splitRequest =\n-          SplitReadStreamRequest.newBuilder()\n-              .setName(source.readStream.getName())\n-              .setFraction((float) fraction)\n-              .build();\n-\n-      SplitReadStreamResponse splitResponse = storageClient.splitReadStream(splitRequest);\n-      if (!splitResponse.hasPrimaryStream() || !splitResponse.hasRemainderStream()) {\n-        // No more splits are possible!\n-        Metrics.counter(\n-                BigQueryStorageStreamReader.class,\n-                \"split-at-fraction-calls-failed-due-to-impossible-split-point\")\n-            .inc();\n-        LOG.info(\n-            \"BigQuery Storage API stream {} cannot be split at {}.\",\n-            source.readStream.getName(),\n-            fraction);\n-        return null;\n-      }\n+      if (splitPossible) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf", "author": {"user": {"login": "vachan-shetty", "name": "Vachan"}}, "url": "https://github.com/apache/beam/commit/bd04d3e47bc81b17e17339c84b1e7e0c7332bedf", "committedDate": "2020-11-18T22:29:46Z", "message": "[BEAM-11208] Review changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTM2NTIz", "url": "https://github.com/apache/beam/pull/13378#pullrequestreview-533936523", "createdAt": "2020-11-18T22:32:37Z", "commit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMjozN1rOH2FC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMjo1MVrOH2FDNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzc5Ng==", "bodyText": "Nit: I don't think this is correct, or required. Once we've reached this point, we know that the splitReadStream call above has in fact succeeded.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526467796", "createdAt": "2020-11-18T22:32:37Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzg5Mw==", "bodyText": "Same comment here.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526467893", "createdAt": "2020-11-18T22:32:51Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;\n           return null;\n         } catch (Exception e) {\n           Metrics.counter(\n                   BigQueryStorageStreamReader.class,\n                   \"split-at-fraction-calls-failed-due-to-other-reasons\")\n               .inc();\n           LOG.error(\"BigQuery Storage API stream split failed.\", e);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7f304e636551db692e18370ac6828b0417eac3", "author": {"user": {"login": "vachan-shetty", "name": "Vachan"}}, "url": "https://github.com/apache/beam/commit/4a7f304e636551db692e18370ac6828b0417eac3", "committedDate": "2020-11-18T22:58:02Z", "message": "[BEAM-11208] Review changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTY3NDA1", "url": "https://github.com/apache/beam/pull/13378#pullrequestreview-533967405", "createdAt": "2020-11-18T23:35:46Z", "commit": {"oid": "4a7f304e636551db692e18370ac6828b0417eac3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4476, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}