{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDc4ODQ3", "number": 10994, "title": "[BEAM-8335] TeststreamService integration with DirectRunner", "bodyText": "Adds the TestStreamService to the DirectRunner which allows for reading TestStream Events remotely via RPC.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-27T21:19:42Z", "url": "https://github.com/apache/beam/pull/10994", "merged": true, "mergeCommit": {"oid": "23c4c2062da5aaeb562885e51e3020995492a316"}, "closed": true, "closedAt": "2020-03-10T18:11:51Z", "author": {"login": "rohdesamuel"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI1R-sgBqjMwODMyODM2MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMEXKzABqjMxMTIzODI2NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c38154e27db112245a67b04bc2cb0e7cd0ed9399", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/c38154e27db112245a67b04bc2cb0e7cd0ed9399", "committedDate": "2020-02-27T21:17:35Z", "message": "ReverseTestStream Implementation\n\nChange-Id: Ie59b9483f4a36796efa203f811610c7fa6cc318c"}, "afterCommit": {"oid": "86d73967a6238b14304f8299bc3786910eb27b11", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/86d73967a6238b14304f8299bc3786910eb27b11", "committedDate": "2020-02-28T19:35:12Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: If797691dffdbbde225f49019f20f9ac05de7c154"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86d73967a6238b14304f8299bc3786910eb27b11", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/86d73967a6238b14304f8299bc3786910eb27b11", "committedDate": "2020-02-28T19:35:12Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: If797691dffdbbde225f49019f20f9ac05de7c154"}, "afterCommit": {"oid": "0b9904106811518d369c3f58879a33671b518539", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/0b9904106811518d369c3f58879a33671b518539", "committedDate": "2020-03-03T19:18:42Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: If797691dffdbbde225f49019f20f9ac05de7c154"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MzA5NTA4", "url": "https://github.com/apache/beam/pull/10994#pullrequestreview-368309508", "createdAt": "2020-03-03T20:43:35Z", "commit": {"oid": "0b9904106811518d369c3f58879a33671b518539"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e311881bd570dc70cbc6b70ee017040fbe3cb727", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/e311881bd570dc70cbc6b70ee017040fbe3cb727", "committedDate": "2020-03-04T02:02:09Z", "message": "address comments, still broken\n\nChange-Id: Ia4c5ed793e35844563cc6a2aaba8bb7d59de2ef4"}, "afterCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/171d28284c18470adba62fe47742eba4f994d500", "committedDate": "2020-03-04T19:10:59Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTcyNTEx", "url": "https://github.com/apache/beam/pull/10994#pullrequestreview-369172511", "createdAt": "2020-03-04T22:30:35Z", "commit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozMDozNVrOFyADGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozMDozNVrOFyADGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzkxMg==", "bodyText": "This should be events += instead of events =", "url": "https://github.com/apache/beam/pull/10994#discussion_r387973912", "createdAt": "2020-03-04T22:30:35Z", "author": {"login": "rohdesamuel"}, "path": "sdks/python/apache_beam/runners/direct/transform_evaluator.py", "diffHunk": "@@ -527,9 +548,21 @@ def process_element(self, element):\n       for event in self.test_stream._set_up(self.test_stream.output_tags):\n         events.append(event)\n \n-    events += [e for e in self.test_stream.events(self.current_index)]\n+    # Index into the global state of all the different TestStream event streams.\n+    # Retrieve this TestStream's event stream and read from it.\n+    try:\n+      events = [next(self.test_stream_events[self.event_index])]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTYzMzI2", "url": "https://github.com/apache/beam/pull/10994#pullrequestreview-369163326", "createdAt": "2020-03-04T22:13:46Z", "commit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoxMzo0NlrOFx_mvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo0Mzo0NVrOFyAX7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NjY1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                reader = self._reader.read_multiple([['full', key]\n          \n          \n            \n                reader = self._reader.read_multiple([('full', key)", "url": "https://github.com/apache/beam/pull/10994#discussion_r387966654", "createdAt": "2020-03-04T22:13:46Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/testing/test_stream_service.py", "diffHunk": "@@ -52,5 +56,9 @@ def stop(self):\n   def Events(self, request, context):\n     \"\"\"Streams back all of the events from the streaming cache.\"\"\"\n \n-    for e in self._events:\n+    # TODO(srohde): Once we get rid of the CacheManager, get rid of this 'full'\n+    # label.\n+    reader = self._reader.read_multiple([['full', key]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NzgyMQ==", "bodyText": "please document inputs", "url": "https://github.com/apache/beam/pull/10994#discussion_r387967821", "createdAt": "2020-03-04T22:16:24Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/testing/test_stream.py", "diffHunk": "@@ -236,14 +235,19 @@ class TestStream(PTransform):\n \n   \"\"\"\n   def __init__(\n-      self, coder=coders.FastPrimitivesCoder(), events=None, output_tags=None):\n+      self,\n+      coder=coders.FastPrimitivesCoder(),\n+      events=None,\n+      output_tags=None,\n+      endpoint=None):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NjkzNg==", "bodyText": "Let's add an assert to make sure that this is only called when we have in-memory events vs rpc events (also in the method below).", "url": "https://github.com/apache/beam/pull/10994#discussion_r387976936", "createdAt": "2020-03-04T22:37:57Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/direct/test_stream_impl.py", "diffHunk": "@@ -226,17 +237,53 @@ def expand(self, pcoll):\n   def _infer_output_coder(self, input_type=None, input_coder=None):\n     return self.coder\n \n-  def _events_from_script(self, index):\n-    yield self._events[index]\n-\n-  def events(self, index):\n-    return self._events_from_script(index)\n-\n-  def begin(self):\n-    return 0\n-\n-  def end(self, index):\n-    return index >= len(self._events)\n+  @staticmethod\n+  def events_from_script(events):\n+    \"\"\"Yields the in-memory events.\n+    \"\"\"\n+    return itertools.chain(events)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3OTI0NQ==", "bodyText": "s/key/tag/ ?", "url": "https://github.com/apache/beam/pull/10994#discussion_r387979245", "createdAt": "2020-03-04T22:43:45Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/testing/test_stream_service.py", "diffHunk": "@@ -52,5 +56,9 @@ def stop(self):\n   def Events(self, request, context):\n     \"\"\"Streams back all of the events from the streaming cache.\"\"\"\n \n-    for e in self._events:\n+    # TODO(srohde): Once we get rid of the CacheManager, get rid of this 'full'\n+    # label.\n+    reader = self._reader.read_multiple([['full', key]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NjY1NA=="}, "originalCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "171d28284c18470adba62fe47742eba4f994d500", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/171d28284c18470adba62fe47742eba4f994d500", "committedDate": "2020-03-04T19:10:59Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "committedDate": "2020-03-04T23:18:48Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/7e1c49cc815a438175b9bab2bd50a6d5ca87c9dc", "committedDate": "2020-03-04T23:18:48Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "0faa09c4582e868fe6e9f14279a3e17677111dd5", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/0faa09c4582e868fe6e9f14279a3e17677111dd5", "committedDate": "2020-03-05T17:48:39Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0faa09c4582e868fe6e9f14279a3e17677111dd5", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/0faa09c4582e868fe6e9f14279a3e17677111dd5", "committedDate": "2020-03-05T17:48:39Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "85eb3cf33125bbb091d30745187d711be84941e3", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/85eb3cf33125bbb091d30745187d711be84941e3", "committedDate": "2020-03-05T20:17:10Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDg3Nzg1", "url": "https://github.com/apache/beam/pull/10994#pullrequestreview-370087785", "createdAt": "2020-03-06T05:20:12Z", "commit": {"oid": "85eb3cf33125bbb091d30745187d711be84941e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85eb3cf33125bbb091d30745187d711be84941e3", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/85eb3cf33125bbb091d30745187d711be84941e3", "committedDate": "2020-03-05T20:17:10Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "committedDate": "2020-03-07T00:13:58Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/db24481c47f8549fb8b4dff1cd84a1834b6d19eb", "committedDate": "2020-03-07T00:13:58Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "committedDate": "2020-03-07T00:33:54Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7e5f454a74e89c033465ba12c3b0f26bca786fd", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/b7e5f454a74e89c033465ba12c3b0f26bca786fd", "committedDate": "2020-03-09T20:57:40Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/34bdf4f07a54705e47817c4a6c94d4a1ef291b98", "committedDate": "2020-03-07T00:33:54Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}, "afterCommit": {"oid": "b7e5f454a74e89c033465ba12c3b0f26bca786fd", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/b7e5f454a74e89c033465ba12c3b0f26bca786fd", "committedDate": "2020-03-09T20:57:40Z", "message": "BEAM[8335] TestStreamService integration with DirectRunner\n\nChange-Id: I83c7c9221e118d49a9005707650803c28630fe2a"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2986, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}