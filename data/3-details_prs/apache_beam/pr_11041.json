{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNzE5Njkz", "number": 11041, "title": "[BEAM-4076] Use beam join api in sql", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-04T17:20:35Z", "url": "https://github.com/apache/beam/pull/11041", "merged": true, "mergeCommit": {"oid": "b564239081e9351c56fb0e7d263495b95dd3f8f3"}, "closed": true, "closedAt": "2020-03-23T05:43:42Z", "author": {"login": "reuvenlax"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNFg1MgH2gAyMzgzNzE5NjkzOjdhNDk4NWEyNmRhMDljY2Q3MDNmMGVjNjEyMzZhYmY4MjcwNDczN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYkMPYgFqTM5NTYxNTczOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a4985a26da09ccd703f0ec61236abf82704737b", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/7a4985a26da09ccd703f0ec61236abf82704737b", "committedDate": "2020-03-13T00:52:29Z", "message": "switch cogbk to use Beam transform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80de8586b5301bc6935793ac3f45e4b1f1722d17", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/80de8586b5301bc6935793ac3f45e4b1f1722d17", "committedDate": "2020-03-13T00:57:49Z", "message": "finish join"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e950d34fafb7f1ec90bcc31f44660534659c17e", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1e950d34fafb7f1ec90bcc31f44660534659c17e", "committedDate": "2020-03-04T17:18:31Z", "message": "finish join"}, "afterCommit": {"oid": "80de8586b5301bc6935793ac3f45e4b1f1722d17", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/80de8586b5301bc6935793ac3f45e4b1f1722d17", "committedDate": "2020-03-13T00:57:49Z", "message": "finish join"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32cdd427dba363183db1dfb8c2e5e924abe029a3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/32cdd427dba363183db1dfb8c2e5e924abe029a3", "committedDate": "2020-03-16T05:50:43Z", "message": "support side-input joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee139046e5b5c9cbf740993624f8d744adfa3cd4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/ee139046e5b5c9cbf740993624f8d744adfa3cd4", "committedDate": "2020-03-16T05:52:41Z", "message": "support side-input joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbac923ca5f903dd2a8c97f329fb316a07734a34", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/bbac923ca5f903dd2a8c97f329fb316a07734a34", "committedDate": "2020-03-16T05:53:00Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "462974e9fb4a11c088198d7ec3b0e11e58856eca", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/462974e9fb4a11c088198d7ec3b0e11e58856eca", "committedDate": "2020-03-16T23:01:16Z", "message": "make FieldAccessDescriptor always be field-insertion order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8420598c7b813b931801d52f6c31094e18d152fe", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/8420598c7b813b931801d52f6c31094e18d152fe", "committedDate": "2020-03-19T02:51:38Z", "message": "fix side-input joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165fd7b2c7ac2cc9ceaf0797585a558521366fc3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/165fd7b2c7ac2cc9ceaf0797585a558521366fc3", "committedDate": "2020-03-19T04:38:34Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f0ce339bd5d31a293fea73d02ca63eed4b5ab3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a6f0ce339bd5d31a293fea73d02ca63eed4b5ab3", "committedDate": "2020-03-19T05:55:44Z", "message": "remove obsolete test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fafd96ec92619fe4e2e00ac260b606c08f7b8b1e", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/fafd96ec92619fe4e2e00ac260b606c08f7b8b1e", "committedDate": "2020-03-19T16:44:20Z", "message": "add javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzkyNjQ0", "url": "https://github.com/apache/beam/pull/11041#pullrequestreview-378792644", "createdAt": "2020-03-20T20:29:41Z", "commit": {"oid": "fafd96ec92619fe4e2e00ac260b606c08f7b8b1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4460b8478df3a9f51c0628de031871879e877cac", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/4460b8478df3a9f51c0628de031871879e877cac", "committedDate": "2020-03-23T03:59:50Z", "message": "add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37b1fbaa7ea1b64303eaacae9e670797a92b1a50", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/37b1fbaa7ea1b64303eaacae9e670797a92b1a50", "committedDate": "2020-03-23T04:15:16Z", "message": "update sql transform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjE1NzM4", "url": "https://github.com/apache/beam/pull/11041#pullrequestreview-395615738", "createdAt": "2020-04-17T16:50:12Z", "commit": {"oid": "37b1fbaa7ea1b64303eaacae9e670797a92b1a50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjo1MDoxMlrOGHVknA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjo1MDoxMlrOGHVknA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0NjY1Mg==", "bodyText": "This actually hardcodes a bad assumption a bit further than it was before: that the join is only on columns. We want to move in the other direction, and allow join conditions to be more general RexNodes, many of which still work for CoGBK and side input lookup joins. This is BEAM-6112.", "url": "https://github.com/apache/beam/pull/11041#discussion_r410346652", "createdAt": "2020-04-17T16:50:12Z", "author": {"login": "kennknowles"}, "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/transform/BeamJoinTransforms.java", "diffHunk": "@@ -45,111 +41,35 @@\n /** Collections of {@code PTransform} and {@code DoFn} used to perform JOIN operation. */\n public class BeamJoinTransforms {\n \n-  /** A {@code SimpleFunction} to extract join fields from the specified row. */\n-  public static class ExtractJoinFields extends SimpleFunction<Row, KV<Row, Row>> {\n-    private final List<SerializableRexNode> joinColumns;\n-    private final Schema schema;\n-    private int leftRowColumnCount;\n-\n-    public ExtractJoinFields(\n-        boolean isLeft,\n-        List<Pair<RexNode, RexNode>> joinColumns,\n-        Schema schema,\n-        int leftRowColumnCount) {\n-      this.joinColumns =\n-          joinColumns.stream()\n-              .map(pair -> SerializableRexNode.builder(isLeft ? pair.left : pair.right).build())\n-              .collect(toList());\n-      this.schema = schema;\n-      this.leftRowColumnCount = leftRowColumnCount;\n-    }\n-\n-    @Override\n-    public KV<Row, Row> apply(Row input) {\n-      Row row =\n-          joinColumns.stream()\n-              .map(v -> getValue(v, input, leftRowColumnCount))\n-              .collect(toRow(schema));\n-      return KV.of(row, input);\n-    }\n-\n-    @SuppressWarnings(\"unused\")\n-    private Schema.Field toField(Schema schema, Integer fieldIndex) {\n-      Schema.Field original = schema.getField(fieldIndex);\n-      return original.withName(\"c\" + fieldIndex);\n-    }\n-\n-    private Object getValue(\n-        SerializableRexNode serializableRexNode, Row input, int leftRowColumnCount) {\n-      if (serializableRexNode instanceof SerializableRexInputRef) {\n-        return input.getValue(\n-            ((SerializableRexInputRef) serializableRexNode).getIndex() - leftRowColumnCount);\n-      } else { // It can only be SerializableFieldAccess.\n-        List<Integer> indexes = ((SerializableRexFieldAccess) serializableRexNode).getIndexes();\n-        // retrieve row based on the first column reference.\n-        Row rowField = input.getValue(indexes.get(0) - leftRowColumnCount);\n-        for (int i = 1; i < indexes.size() - 1; i++) {\n-          rowField = rowField.getRow(indexes.get(i));\n-        }\n-        return rowField.getValue(indexes.get(indexes.size() - 1));\n-      }\n-    }\n+  public static FieldAccessDescriptor getJoinColumns(\n+      boolean isLeft,\n+      List<Pair<RexNode, RexNode>> joinColumns,\n+      int leftRowColumnCount,\n+      Schema schema) {\n+    List<SerializableRexNode> joinColumnsBuilt =\n+        joinColumns.stream()\n+            .map(pair -> SerializableRexNode.builder(isLeft ? pair.left : pair.right).build())\n+            .collect(toList());\n+    return FieldAccessDescriptor.union(\n+        joinColumnsBuilt.stream()\n+            .map(v -> getJoinColumn(v, leftRowColumnCount).resolve(schema))\n+            .collect(Collectors.toList()));\n   }\n \n-  /** A {@code DoFn} which implement the sideInput-JOIN. */\n-  public static class SideInputJoinDoFn extends DoFn<KV<Row, Row>, Row> {\n-    private final PCollectionView<Map<Row, Iterable<Row>>> sideInputView;\n-    private final JoinRelType joinType;\n-    private final Row rightNullRow;\n-    private final boolean swap;\n-    private final Schema schema;\n-\n-    public SideInputJoinDoFn(\n-        JoinRelType joinType,\n-        Row rightNullRow,\n-        PCollectionView<Map<Row, Iterable<Row>>> sideInputView,\n-        boolean swap,\n-        Schema schema) {\n-      this.joinType = joinType;\n-      this.rightNullRow = rightNullRow;\n-      this.sideInputView = sideInputView;\n-      this.swap = swap;\n-      this.schema = schema;\n-    }\n-\n-    @ProcessElement\n-    public void processElement(ProcessContext context) {\n-      Row key = context.element().getKey();\n-      Row leftRow = context.element().getValue();\n-      Map<Row, Iterable<Row>> key2Rows = context.sideInput(sideInputView);\n-      Iterable<Row> rightRowsIterable = key2Rows.get(key);\n-\n-      if (rightRowsIterable != null && rightRowsIterable.iterator().hasNext()) {\n-        for (Row aRightRowsIterable : rightRowsIterable) {\n-          context.output(combineTwoRowsIntoOne(leftRow, aRightRowsIterable, swap, schema));\n-        }\n-      } else {\n-        if (joinType == JoinRelType.LEFT) {\n-          context.output(combineTwoRowsIntoOne(leftRow, rightNullRow, swap, schema));\n-        }\n+  private static FieldAccessDescriptor getJoinColumn(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37b1fbaa7ea1b64303eaacae9e670797a92b1a50"}, "originalPosition": 132}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3018, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}