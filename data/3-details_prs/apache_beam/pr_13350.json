{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMTkwODI4", "number": 13350, "title": "[BEAM-11266] Python IO MongoDB: add bucket_auto aggregation option for bundling in Atlas.", "bodyText": "This fixes issue BEAM-11266 allowing to use ReadFromMongoDB with MongoDB Atlas by optionally using @bucketAuto MongoDB aggregation instead of splitVector:\n  pipeline | ReadFromMongoDB(uri='mongodb+srv://user:pwd@cluster0.mongodb.net',\n                             db='testdb',\n                             coll='input',\n                             bucket_auto=True)\n\nThis enhancement is based on the solution, provided by Susumu Asaga in this comment to the issue BEAM-4567, related to Java MongoDB connector.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-15T12:52:03Z", "url": "https://github.com/apache/beam/pull/13350", "merged": true, "mergeCommit": {"oid": "67339a9195562e5ed90d8bd1a188f9e819a1e7d0"}, "closed": true, "closedAt": "2020-11-24T00:55:29Z", "author": {"login": "nikie"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcvxJWAH2gAyNTIxMTkwODI4Ojk0YTg1MzM5YzcwMDhhYTc2NzZiYzJkOTg3MjcwNTMwOTc0NDIyMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfbOhPgFqTUzNjgyMzI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "94a85339c7008aa7676bc2d9872705309744220c", "author": {"user": {"login": "nikie", "name": "Eugene Nikolaiev"}}, "url": "https://github.com/apache/beam/commit/94a85339c7008aa7676bc2d9872705309744220c", "committedDate": "2020-11-15T12:46:20Z", "message": "[BEAM-11266] Python IO MongoDB: add bucket_auto aggregation option for bundling in Atlas."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTk2NDgz", "url": "https://github.com/apache/beam/pull/13350#pullrequestreview-531596483", "createdAt": "2020-11-16T18:32:48Z", "commit": {"oid": "94a85339c7008aa7676bc2d9872705309744220c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODozMjo0OFrOH0MFyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODozNTo1NVrOH0MM3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NjA4OQ==", "bodyText": "The split function will likely be called recursively for dynamic rebalancing, so for a range with start_pos and end_pos, it can be further split upon backend request, so it might not be reasonable to always use the total collection size divided by desired_chunk_size to calculate the bucket count. Is it possible to only get the buckets within the give _id range? and we can probably use an average document size times the number of documents to calculate the size of the range being split.", "url": "https://github.com/apache/beam/pull/13350#discussion_r524486089", "createdAt": "2020-11-16T18:32:48Z", "author": {"login": "y1chi"}, "path": "sdks/python/apache_beam/io/mongodbio.py", "diffHunk": "@@ -241,6 +275,27 @@ def _get_split_keys(self, desired_chunk_size_in_mb, start_pos, end_pos):\n               max={'_id': end_pos},\n               maxChunkSize=desired_chunk_size_in_mb)['splitKeys'])\n \n+  def _get_buckets(self, desired_chunk_size, start_pos, end_pos):\n+    if start_pos >= end_pos:\n+      # single document not splittable\n+      return []\n+    size = self.estimate_size()\n+    bucket_count = size // desired_chunk_size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a85339c7008aa7676bc2d9872705309744220c"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NzkwMg==", "bodyText": "the return buckets should guarantee the _id range is start_pos and end_pos otherwise same document could be read multiple times.", "url": "https://github.com/apache/beam/pull/13350#discussion_r524487902", "createdAt": "2020-11-16T18:35:55Z", "author": {"login": "y1chi"}, "path": "sdks/python/apache_beam/io/mongodbio.py", "diffHunk": "@@ -241,6 +275,27 @@ def _get_split_keys(self, desired_chunk_size_in_mb, start_pos, end_pos):\n               max={'_id': end_pos},\n               maxChunkSize=desired_chunk_size_in_mb)['splitKeys'])\n \n+  def _get_buckets(self, desired_chunk_size, start_pos, end_pos):\n+    if start_pos >= end_pos:\n+      # single document not splittable\n+      return []\n+    size = self.estimate_size()\n+    bucket_count = size // desired_chunk_size\n+    if size % desired_chunk_size != 0:\n+      bucket_count += 1\n+    with beam.io.mongodbio.MongoClient(self.uri, **self.spec) as client:\n+      buckets = list(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a85339c7008aa7676bc2d9872705309744220c"}, "originalPosition": 179}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e5f2894572800e7a72dd67de7a6077e9befa1c2", "author": {"user": {"login": "nikie", "name": "Eugene Nikolaiev"}}, "url": "https://github.com/apache/beam/commit/7e5f2894572800e7a72dd67de7a6077e9befa1c2", "committedDate": "2020-11-22T18:34:39Z", "message": "[BEAM-11266] Python IO MongoDB: add bucket_auto aggregation option for bundling in Atlas.\n\nBucket_auto mode:\n- Respects dynamic rebalancing, filter by _id range in each split.\n- Respects custom filter by merging it with the _id range filter, so\n  that splits hold similar number of docs actually matching the filter\n  (not possible in splitVector mode).\n- Estimates bundle size for non-initial splits by counting docs with\n  filters applied and using 'avgObjSize' from MongoDB collstats.\n- Uses bundle generator common with splitVector mode for clarity of\n  covering all the same cases.\n\nMisc:\n- Refactor _merge_id_filter to use '$and' only if necessary.\n- Fix one-off issue with single-document-not-splittable checks\n  for both bucket_auto and splitVector modes (unit test added,\n  before the fix if branches were unreachable).\n\nUnit tests:\n- Increase coverage and sanity.\n- Refactor collection mock filter and projection handling.\n\nIntegration tests:\n- Add read cases: splitVector/bucket_auto * filter/no-filter.\n- Add checks for expected docs count."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODIzMjk0", "url": "https://github.com/apache/beam/pull/13350#pullrequestreview-536823294", "createdAt": "2020-11-23T20:32:11Z", "commit": {"oid": "7e5f2894572800e7a72dd67de7a6077e9befa1c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4894, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}