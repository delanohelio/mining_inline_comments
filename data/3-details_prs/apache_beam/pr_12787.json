{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjU2MzY5", "number": 12787, "title": "[BEAM-10641] Add eliminate_common_key_with_none graph optimizer", "bodyText": "If multiple KeyWithNone stages share a common input, then all but one stages will be eliminated along with their output PCollections. Transforms that originally read input from the output PCollection of the eliminated KeyWithNone stages will be remapped to read input from the output PCollection of the remaining KeyWithNone stage.\nThis allows pack_combiners to pack sibling CombineGlobally stages, rather than just CombinePerKey stages.\n\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-08T19:41:18Z", "url": "https://github.com/apache/beam/pull/12787", "merged": true, "mergeCommit": {"oid": "8f829ddffed87dcee477e5c3114bec734840d954"}, "closed": true, "closedAt": "2020-09-15T18:03:48Z", "author": {"login": "yifanmai"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG8xTMAH2gAyNDgyMjU2MzY5Ojk4OThmNTY2ZjdkMTcwZmNmODhlZDg0ZTU2NzliZDQ3ZDhhODE2OWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH5UKZgH2gAyNDgyMjU2MzY5OmMzZGNhOTA5ZTE1YTU4ZGU2ZmQ5MWRiMzZhM2Y1MWRjZDhkMmFhMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9898f566f7d170fcf88ed84e5679bd47d8a8169a", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/9898f566f7d170fcf88ed84e5679bd47d8a8169a", "committedDate": "2020-09-08T19:28:56Z", "message": "Add eliminate_common_key_with_none optimizer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4605aedd5a7c230cbc170046b740e5f320b408ac", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/4605aedd5a7c230cbc170046b740e5f320b408ac", "committedDate": "2020-09-08T19:30:14Z", "message": "Add eliminate_common_key_with_none to runners"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b048551784a265c81a5a2fa191d858cc82d020d", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/7b048551784a265c81a5a2fa191d858cc82d020d", "committedDate": "2020-09-08T19:37:36Z", "message": "Update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTQ4Mjkz", "url": "https://github.com/apache/beam/pull/12787#pullrequestreview-484548293", "createdAt": "2020-09-08T22:55:05Z", "commit": {"oid": "7b048551784a265c81a5a2fa191d858cc82d020d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjo1NTowNVrOHOwqbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDowMjoyNFrOHOx63w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzOTQwNw==", "bodyText": "Nit: rather than mutating sibling_stages and using it below with itertools, it'd be easier to follow if you yield sibling_stages[0] here and only iterate over the ineligible_stages below.\nIf you'd prefer to use the loop below, at least make a new flat list of the stages.", "url": "https://github.com/apache/beam/pull/12787#discussion_r485239407", "createdAt": "2020-09-08T22:55:05Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -704,6 +705,64 @@ def fix_side_input_pcoll_coders(stages, pipeline_context):\n   return stages\n \n \n+def eliminate_common_key_with_none(stages, context):\n+  # type: (Iterable[Stage], TransformContext) -> Iterable[Stage]\n+\n+  \"\"\"Runs common subexpression elimination for sibling KeyWithNone stages.\n+\n+  If multiple KeyWithNone stages share a common input, then all but one stages\n+  will be eliminated along with their output PCollections. Transforms that\n+  read input from the output of the eliminated KeyWithNone stages will be\n+  remapped to read input from the output of the remaining KeyWithNone stage.\n+  \"\"\"\n+  # Partition stages by whether they are eligible for common KeyWithNone\n+  # elimination, and group eligible KeyWithNone stages by parent and\n+  # environment.\n+  grouped_eligible_stages = collections.defaultdict(list)\n+  ineligible_stages = []\n+  for stage in stages:\n+    is_eligible = False\n+    if len(stage.transforms) == 1:\n+      transform = only_transform(stage.transforms)\n+      if (transform.spec.urn == common_urns.primitives.PAR_DO.urn and\n+          len(transform.inputs) == 1 and len(transform.outputs) == 1):\n+        pardo_payload = proto_utils.parse_Bytes(\n+            transform.spec.payload, beam_runner_api_pb2.ParDoPayload)\n+        if pardo_payload.do_fn.urn == python_urns.KEY_WITH_NONE_DOFN:\n+          is_eligible = True\n+\n+    if is_eligible:\n+      input_pcoll_id = only_element(transform.inputs.values())\n+      stage_key = (input_pcoll_id, stage.environment)\n+      grouped_eligible_stages[stage_key].append(stage)\n+    else:\n+      ineligible_stages.append(stage)\n+\n+  # Eliminate stages and build the PCollection remapping dictionary.\n+  pcoll_id_remap = {}\n+  for sibling_stages in grouped_eligible_stages.values():\n+    output_pcoll_ids = [\n+        only_element(stage.transforms[0].outputs.values())\n+        for stage in sibling_stages\n+    ]\n+    for to_delete_pcoll_id in output_pcoll_ids[1:]:\n+      pcoll_id_remap[to_delete_pcoll_id] = output_pcoll_ids[0]\n+      del context.components.pcollections[to_delete_pcoll_id]\n+    del sibling_stages[1:]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b048551784a265c81a5a2fa191d858cc82d020d"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1OTk5OQ==", "bodyText": "Most of this is very general. What if you had a merge_key(stage) helper function which only returned something for this case (but was generally extensible) and then threw stuff into the dict according to this key (say, if it was not None), and then the rest of the logic could follow.", "url": "https://github.com/apache/beam/pull/12787#discussion_r485259999", "createdAt": "2020-09-09T00:02:24Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -704,6 +705,64 @@ def fix_side_input_pcoll_coders(stages, pipeline_context):\n   return stages\n \n \n+def eliminate_common_key_with_none(stages, context):\n+  # type: (Iterable[Stage], TransformContext) -> Iterable[Stage]\n+\n+  \"\"\"Runs common subexpression elimination for sibling KeyWithNone stages.\n+\n+  If multiple KeyWithNone stages share a common input, then all but one stages\n+  will be eliminated along with their output PCollections. Transforms that\n+  read input from the output of the eliminated KeyWithNone stages will be\n+  remapped to read input from the output of the remaining KeyWithNone stage.\n+  \"\"\"\n+  # Partition stages by whether they are eligible for common KeyWithNone\n+  # elimination, and group eligible KeyWithNone stages by parent and\n+  # environment.\n+  grouped_eligible_stages = collections.defaultdict(list)\n+  ineligible_stages = []\n+  for stage in stages:\n+    is_eligible = False", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b048551784a265c81a5a2fa191d858cc82d020d"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6e93a1b93e0385f61fdd4d9db28b44d7c3b073", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/fa6e93a1b93e0385f61fdd4d9db28b44d7c3b073", "committedDate": "2020-09-09T16:54:14Z", "message": "Dostring edit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59dc3b788e2a3f651479c5241dfab547abc0cb87", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/59dc3b788e2a3f651479c5241dfab547abc0cb87", "committedDate": "2020-09-09T21:49:46Z", "message": "Refactor out _group_stages_by_key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzc1NTE4", "url": "https://github.com/apache/beam/pull/12787#pullrequestreview-486375518", "createdAt": "2020-09-10T23:23:21Z", "commit": {"oid": "59dc3b788e2a3f651479c5241dfab547abc0cb87"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyMzoyMVrOHQI_JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyMzoyNVrOHQI_OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NjUwMA==", "bodyText": "Use transform.inputs.keys().", "url": "https://github.com/apache/beam/pull/12787#discussion_r486686500", "createdAt": "2020-09-10T23:23:21Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -704,6 +705,71 @@ def fix_side_input_pcoll_coders(stages, pipeline_context):\n   return stages\n \n \n+def _group_stages_by_key(stages, get_stage_key):\n+  grouped_stages = collections.defaultdict(list)\n+  stages_with_none_key = []\n+  for stage in stages:\n+    stage_key = get_stage_key(stage)\n+    if stage_key is None:\n+      stages_with_none_key.append(stage)\n+    else:\n+      grouped_stages[stage_key].append(stage)\n+  return (grouped_stages, stages_with_none_key)\n+\n+\n+def eliminate_common_key_with_none(stages, context):\n+  # type: (Iterable[Stage], TransformContext) -> Iterable[Stage]\n+\n+  \"\"\"Runs common subexpression elimination for sibling KeyWithNone stages.\n+\n+  If multiple KeyWithNone stages share a common input, then all but one stages\n+  will be eliminated along with their output PCollections. Transforms that\n+  originally read input from the output PCollection of the eliminated\n+  KeyWithNone stages will be remapped to read input from the output PCollection\n+  of the remaining KeyWithNone stage.\n+  \"\"\"\n+\n+  # Partition stages by whether they are eligible for common KeyWithNone\n+  # elimination, and group eligible KeyWithNone stages by parent and\n+  # environment.\n+  def get_stage_key(stage):\n+    if len(stage.transforms) == 1:\n+      transform = only_transform(stage.transforms)\n+      if (transform.spec.urn == common_urns.primitives.PAR_DO.urn and\n+          len(transform.inputs) == 1 and len(transform.outputs) == 1):\n+        pardo_payload = proto_utils.parse_Bytes(\n+            transform.spec.payload, beam_runner_api_pb2.ParDoPayload)\n+        if pardo_payload.do_fn.urn == python_urns.KEY_WITH_NONE_DOFN:\n+          return (only_element(transform.inputs.values()), stage.environment)\n+    return None\n+\n+  grouped_eligible_stages, ineligible_stages = _group_stages_by_key(\n+      stages, get_stage_key)\n+\n+  # Eliminate stages and build the PCollection remapping dictionary.\n+  pcoll_id_remap = {}\n+  remaining_stages = []\n+  for sibling_stages in grouped_eligible_stages.values():\n+    output_pcoll_ids = [\n+        only_element(stage.transforms[0].outputs.values())\n+        for stage in sibling_stages\n+    ]\n+    for to_delete_pcoll_id in output_pcoll_ids[1:]:\n+      pcoll_id_remap[to_delete_pcoll_id] = output_pcoll_ids[0]\n+      del context.components.pcollections[to_delete_pcoll_id]\n+    remaining_stages.append(sibling_stages[0])\n+\n+  # Yield stages while remapping input PCollections if needed.\n+  stages_to_yield = itertools.chain(ineligible_stages, remaining_stages)\n+  for stage in stages_to_yield:\n+    for transform in stage.transforms:\n+      for input_key in list(transform.inputs):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59dc3b788e2a3f651479c5241dfab547abc0cb87"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NjUyMQ==", "bodyText": "Just a thought: most of this is generic too (parameterized by a merge_stages : stages -> stage(s), pcoll_remap).", "url": "https://github.com/apache/beam/pull/12787#discussion_r486686521", "createdAt": "2020-09-10T23:23:25Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -704,6 +705,71 @@ def fix_side_input_pcoll_coders(stages, pipeline_context):\n   return stages\n \n \n+def _group_stages_by_key(stages, get_stage_key):\n+  grouped_stages = collections.defaultdict(list)\n+  stages_with_none_key = []\n+  for stage in stages:\n+    stage_key = get_stage_key(stage)\n+    if stage_key is None:\n+      stages_with_none_key.append(stage)\n+    else:\n+      grouped_stages[stage_key].append(stage)\n+  return (grouped_stages, stages_with_none_key)\n+\n+\n+def eliminate_common_key_with_none(stages, context):\n+  # type: (Iterable[Stage], TransformContext) -> Iterable[Stage]\n+\n+  \"\"\"Runs common subexpression elimination for sibling KeyWithNone stages.\n+\n+  If multiple KeyWithNone stages share a common input, then all but one stages\n+  will be eliminated along with their output PCollections. Transforms that\n+  originally read input from the output PCollection of the eliminated\n+  KeyWithNone stages will be remapped to read input from the output PCollection\n+  of the remaining KeyWithNone stage.\n+  \"\"\"\n+\n+  # Partition stages by whether they are eligible for common KeyWithNone\n+  # elimination, and group eligible KeyWithNone stages by parent and\n+  # environment.\n+  def get_stage_key(stage):\n+    if len(stage.transforms) == 1:\n+      transform = only_transform(stage.transforms)\n+      if (transform.spec.urn == common_urns.primitives.PAR_DO.urn and\n+          len(transform.inputs) == 1 and len(transform.outputs) == 1):\n+        pardo_payload = proto_utils.parse_Bytes(\n+            transform.spec.payload, beam_runner_api_pb2.ParDoPayload)\n+        if pardo_payload.do_fn.urn == python_urns.KEY_WITH_NONE_DOFN:\n+          return (only_element(transform.inputs.values()), stage.environment)\n+    return None\n+\n+  grouped_eligible_stages, ineligible_stages = _group_stages_by_key(\n+      stages, get_stage_key)\n+\n+  # Eliminate stages and build the PCollection remapping dictionary.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59dc3b788e2a3f651479c5241dfab547abc0cb87"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3dca909e15a58de6fd91db36a3f51dcd8d2aa36", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/c3dca909e15a58de6fd91db36a3f51dcd8d2aa36", "committedDate": "2020-09-11T18:01:19Z", "message": "Lint and review fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4692, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}