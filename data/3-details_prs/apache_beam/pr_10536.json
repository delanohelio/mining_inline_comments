{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjg4NzA3", "number": 10536, "title": "[BEAM-7861] Add direct_running_mode option for direct runners to switch between multi_threading and multi_processing easily", "bodyText": "This PR introduces a new direct option --direct_running_mode to make it easy to switch between multi_threading and multi_processing mode for FnApiRunner.\nWhen direct_running_mode = 'in_memory', EmbeddedWorkerHandler is used. (This is the default mode)\nWhen direct_running_mode = 'multi_threading', EmbeddedGrpcWorkerHandler is used.\nWhen direct_running_mode = 'multi_processing', SubprocessSdkWorkerHandler is used.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-08T22:43:37Z", "url": "https://github.com/apache/beam/pull/10536", "merged": true, "mergeCommit": {"oid": "0bdd5c2a2390f77f7c7aa119fed178c2bae9e771"}, "closed": true, "closedAt": "2020-01-10T01:58:37Z", "author": {"login": "Hannah-Jiang"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4ffmwAFqTM0MDI0MjAxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4z-mEgFqTM0MDkwNzQ2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjQyMDE2", "url": "https://github.com/apache/beam/pull/10536#pullrequestreview-340242016", "createdAt": "2020-01-09T01:15:52Z", "commit": {"oid": "c394c532935e12e00aeb56dd08c4c5e217d140ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMToxNTo1MlrOFbokrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMToxNTo1MlrOFbokrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyMDYyMg==", "bodyText": "Would it make sense to add another choice for EmbeddedWorkerHandler and change the default to that, instead of defaulting to None?", "url": "https://github.com/apache/beam/pull/10536#discussion_r364520622", "createdAt": "2020-01-09T01:15:52Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/options/pipeline_options.py", "diffHunk": "@@ -438,6 +438,12 @@ def _add_argparse_args(cls, parser):\n         type=int,\n         default=1,\n         help='number of parallel running workers.')\n+    parser.add_argument(\n+        '--direct_running_mode',\n+        default=None,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c394c532935e12e00aeb56dd08c4c5e217d140ca"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79", "committedDate": "2020-01-09T18:22:49Z", "message": "BEAM-7861 add direct_running_mode option\n\n[BEAM-7861] add in_memory choice"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c394c532935e12e00aeb56dd08c4c5e217d140ca", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/c394c532935e12e00aeb56dd08c4c5e217d140ca", "committedDate": "2020-01-08T22:41:28Z", "message": "BEAM-7861 add direct_running_mode option"}, "afterCommit": {"oid": "b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79", "committedDate": "2020-01-09T18:22:49Z", "message": "BEAM-7861 add direct_running_mode option\n\n[BEAM-7861] add in_memory choice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzczNTQ0", "url": "https://github.com/apache/beam/pull/10536#pullrequestreview-340773544", "createdAt": "2020-01-09T19:49:33Z", "commit": {"oid": "b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxOTo0OTozNFrOFcBg2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxOTo0OTozNFrOFcBg2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDkyOTI0Mw==", "bodyText": "Could this be None any more? Since it has a default value.", "url": "https://github.com/apache/beam/pull/10536#discussion_r364929243", "createdAt": "2020-01-09T19:49:34Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -450,6 +450,21 @@ def run_pipeline(self,\n         pipeline_options.DirectOptions).direct_runner_bundle_repeat\n     self._num_workers = options.view_as(\n         pipeline_options.DirectOptions).direct_num_workers or self._num_workers\n+\n+    # set direct workers running mode if it is defined with pipeline options.\n+    if options.view_as(pipeline_options.DirectOptions).direct_running_mode \\\n+        is not None:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3f33d96d571c0e455bea8e08e4ed7b2ff2e7f79"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwODY1ODIz", "url": "https://github.com/apache/beam/pull/10536#pullrequestreview-340865823", "createdAt": "2020-01-09T22:52:41Z", "commit": {"oid": "e6faf9cf05d72af69b6934b164ee6e2a64afe290"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMjo1Mjo0MVrOFcFywg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMjo1Mjo0MVrOFcFywg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk5OTM2Mg==", "bodyText": "Why not utf-8?", "url": "https://github.com/apache/beam/pull/10536#discussion_r364999362", "createdAt": "2020-01-09T22:52:41Z", "author": {"login": "ibzib"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner.py", "diffHunk": "@@ -450,6 +450,19 @@ def run_pipeline(self,\n         pipeline_options.DirectOptions).direct_runner_bundle_repeat\n     self._num_workers = options.view_as(\n         pipeline_options.DirectOptions).direct_num_workers or self._num_workers\n+\n+    # set direct workers running mode if it is defined with pipeline options.\n+    running_mode = \\\n+      options.view_as(pipeline_options.DirectOptions).direct_running_mode\n+    if running_mode == 'multi_threading':\n+      self._default_environment = environments.EmbeddedPythonGrpcEnvironment()\n+    elif running_mode == 'multi_processing':\n+      command_bytes = b'%s -m apache_beam.runners.worker.sdk_worker_main' \\\n+                       % sys.executable.encode('ascii')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6faf9cf05d72af69b6934b164ee6e2a64afe290"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6df2feea283424c837bf00c125703b3dac642c", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/6b6df2feea283424c837bf00c125703b3dac642c", "committedDate": "2020-01-09T23:46:45Z", "message": "[BEAM-7861] rephrase direct_running_mode option checking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6faf9cf05d72af69b6934b164ee6e2a64afe290", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/e6faf9cf05d72af69b6934b164ee6e2a64afe290", "committedDate": "2020-01-09T22:11:35Z", "message": "[BEAM-7861] rephrase direct_running_mode option checking"}, "afterCommit": {"oid": "6b6df2feea283424c837bf00c125703b3dac642c", "author": {"user": {"login": "Hannah-Jiang", "name": "Hannah Jiang"}}, "url": "https://github.com/apache/beam/commit/6b6df2feea283424c837bf00c125703b3dac642c", "committedDate": "2020-01-09T23:46:45Z", "message": "[BEAM-7861] rephrase direct_running_mode option checking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTA3NDYz", "url": "https://github.com/apache/beam/pull/10536#pullrequestreview-340907463", "createdAt": "2020-01-10T01:08:13Z", "commit": {"oid": "6b6df2feea283424c837bf00c125703b3dac642c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3682, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}