{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDUwNjgw", "number": 12305, "title": "[BEAM-9968] Guarantee that outstanding split/progress requests are handled before bundle completion (and before any final progress/checkpoint data sent to handlers).", "bodyText": "The test was failing because there was an outstanding split request that was queued in the FnApiControlClient(\n  \n    \n      beam/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/FnApiControlClient.java\n    \n    \n         Line 134\n      in\n      f7b23ec\n    \n    \n    \n    \n\n        \n          \n           requestReceiver.onError( \n        \n    \n  \n\n) which if all outstanding responses haven't returned will throw an error which causes the test to fail because of this exception being unexpected. This should also fix the progress test since it could also see this issue.\nDuring the investigation of the test failure, I also discovered that BeamFnDataSizeBasedBufferingOutboundObserver was throwing an exception if close was called multiple times which is against the contract for CloseableFnDataReceiver and the CountingFnDataReceiver to only increment the count after the delegate accepted the value.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-17T20:46:27Z", "url": "https://github.com/apache/beam/pull/12305", "merged": true, "mergeCommit": {"oid": "e688b28a590b2c3f7b9cf793faefc6d9e9e88f35"}, "closed": true, "closedAt": "2020-07-17T23:01:05Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc16BAuAH2gAyNDUxNDUwNjgwOjEyMWM3Njc2ZGU4MTYxNmI1NThkZTI3NjRjZTNkMjNiMmQ3NTE2ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc16ZhFAH2gAyNDUxNDUwNjgwOmQ3ZmFiNzEwZjI0OGI1M2Q4OWNmYTUwZTUwYWE2M2U2MzZhODE5NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "121c7676de81616b558de2764ce3d23b2d7516fd", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/121c7676de81616b558de2764ce3d23b2d7516fd", "committedDate": "2020-07-17T20:39:40Z", "message": "[BEAM-9968] Guarantee that outstanding split/progress requests are handled before bundle completion (and before and final progress/checkpoint data sent to handlers).\n\nThe test was failing because there was an outstanding split request that was queued in the FnApiControlClient(https://github.com/apache/beam/blob/f7b23ec69fa68f4f0b6386ecec32ab12982e4098/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/FnApiControlClient.java#L134) which if all outstanding responses haven't returned will throw an error which causes the test to fail because of this exception being unexpected. This should also fix the progress test since it could also see this issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwOTU1ODIx", "url": "https://github.com/apache/beam/pull/12305#pullrequestreview-450955821", "createdAt": "2020-07-17T21:02:44Z", "commit": {"oid": "121c7676de81616b558de2764ce3d23b2d7516fd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMTowMjo0NFrOGzhHCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMTowMjo0NFrOGzhHCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MzAzNA==", "bodyText": "Does this need to be volatile?", "url": "https://github.com/apache/beam/pull/12305#discussion_r456673034", "createdAt": "2020-07-17T21:02:44Z", "author": {"login": "apilloud"}, "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/control/SdkHarnessClient.java", "diffHunk": "@@ -310,6 +312,9 @@ public ActiveBundle newBundle(\n       private final BundleSplitHandler splitHandler;\n       private final BundleCheckpointHandler checkpointHandler;\n       private final BundleFinalizationHandler finalizationHandler;\n+      private final Phaser outstandingRequests;\n+      private final AtomicBoolean isClosed;\n+      private boolean bundleIsCompleted;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "121c7676de81616b558de2764ce3d23b2d7516fd"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7fab710f248b53d89cfa50e50aa63e636a81960", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/d7fab710f248b53d89cfa50e50aa63e636a81960", "committedDate": "2020-07-17T21:06:26Z", "message": "fixup! Make sure we use ActiveBundle.this to guarantee which object we are synchronizing against."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3826, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}