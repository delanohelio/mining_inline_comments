{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTI4OTk1", "number": 11338, "title": "[BEAM-7923] Screendiff Integration Tests", "bodyText": "Added a screendiff integration test infrastructure: https://docs.google.com/document/d/1tk2P0Cu9hMjbtDWfIuQEFj07q20iqasqLPVtYVpxw3w/edit?usp=sharing\nAdded the first test notebook: init_square_cube.ipynb with golden\nscreenshot 7a35f487b2a5f3a9b9852a8659eeb4bd.png and its test: init_square_cube_test.py.\nTo add a new test, simply follow the above example. To generate a new\ngolden, run tests with nosetests apache_beam/runners/interactive/testing/integration/tests/xxx_test.py --with-save-baseline.\nAdded new dependency group [interactive_test].\nThe test is not part of the Jenkins pre-commit process yet. To run it\nlocally, make sure both [interactive] and [interactive_test]\ndependencies are installed, and you have chrome installed.\nTo enable such integration tests on Jenkins, chrome driver plugin\nshould be installed.\nThe BaseTestCase provided in the screen_diff module supports running\ntests for all notebooks under a directory, a single test for a golden\nor a single test for a notebook.\n\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-07T22:15:47Z", "url": "https://github.com/apache/beam/pull/11338", "merged": true, "mergeCommit": {"oid": "1754d039fa0a029e62cd815d17a17712284c1cd5"}, "closed": true, "closedAt": "2020-04-14T16:31:49Z", "author": {"login": "KevinGG"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVasZZgH2gAyNDAwNTI4OTk1OjVhNWNiYjQ3ODU4MDBmMWNjNWZmNzk4MjA1NWQyMmViNTFiNjA2NWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXSuGTgH2gAyNDAwNTI4OTk1OjViOTVmYTdjNTIwNzFkYzNkNjFjMjc0Y2MxOWZiZGRkZjZmOWRmYjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e", "author": {"user": {"login": "KevinGG", "name": "Ning Kang"}}, "url": "https://github.com/apache/beam/commit/5a5cbb4785800f1cc5ff7982055d22eb51b6065e", "committedDate": "2020-04-07T22:04:31Z", "message": "[BEAM-7923] Screendiff Integration Tests\n\n1. Added a screendiff integration test infrastructure: https://docs.google.com/document/d/1tk2P0Cu9hMjbtDWfIuQEFj07q20iqasqLPVtYVpxw3w/edit?usp=sharing\n2. Added the first test notebook: init_square_cube.ipynb with golden\n   screenshot 7a35f487b2a5f3a9b9852a8659eeb4bd.png and its test: init_square_cube_test.py.\n3. To add a new test, simply follow the above example. To generate a new\n   golden, run tests with `nosetests apache_beam/runners/interactive/testing/integration/tests/xxx_test.py --with-save-baseline`.\n4. Added new dependency group [interactive_test].\n5. The test is not part of the Jenkins pre-commit process yet. To run it\n   locally, make sure both [interactive] and [interactive_test]\n   dependencies are installed, and you have chrome installed.\n6. To enable such integration tests on Jenkins, chrome driver plugin\n   should be installed.\n7. The BaseTestCase provided in the screen_diff module supports running\n   tests for all notebooks under a directory, a single test for a golden\n   or a single test for a notebook."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NTYxNDA4", "url": "https://github.com/apache/beam/pull/11338#pullrequestreview-389561408", "createdAt": "2020-04-07T23:36:59Z", "commit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzozNjo1OVrOGCZ6qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDowMzoyMVrOGCaarw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NDk1NQ==", "bodyText": "Could we delegate to nbcovert to produce the html output? We can reduce most of this function that way.", "url": "https://github.com/apache/beam/pull/11338#discussion_r405174955", "createdAt": "2020-04-07T23:36:59Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/interactive/testing/integration/notebook_executor.py", "diffHunk": "@@ -0,0 +1,131 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Module to execute jupyter notebooks and gather the output into renderable\n+HTML files.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import os\n+import shutil\n+\n+from apache_beam.runners.interactive.utils import obfuscate\n+\n+try:\n+  import nbformat\n+  from nbconvert.preprocessors import ExecutePreprocessor\n+  _interactive_integration_ready = True\n+except ImportError:\n+  _interactive_integration_ready = False\n+\n+\n+class NotebookExecutor(object):\n+  \"\"\"Executor that reads notebooks, executes it and gathers outputs into static\n+  HTML pages that can be served.\"\"\"\n+  def __init__(self, path):\n+    # type: (str) -> None\n+\n+    assert _interactive_integration_ready, (\n+        '[interactive_test] dependency is not installed.')\n+    assert os.path.exists(path), '{} does not exist.'.format(path)\n+    self._paths = []\n+    if os.path.isdir(path):\n+      for root, _, files in os.walk(path):\n+        for filename in files:\n+          if filename.endswith('.ipynb'):\n+            self._paths.append(os.path.join(root, filename))\n+    elif path.endswith('.ipynb'):\n+      self._paths.append(path)\n+    assert len(\n+        self._paths) > 0, ('No notebooks to be executed under{}'.format(path))\n+    self._dir = os.path.dirname(self._paths[0])\n+    self._output_html_dir = os.path.join(self._dir, 'output')\n+    self.cleanup()\n+    self._output_html_paths = {}\n+    self._notebook_path_to_execution_id = {}\n+\n+  def cleanup(self):\n+    \"\"\"Cleans up the output folder.\"\"\"\n+    _cleanup(self._output_html_dir)\n+\n+  def execute(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MjAzNA==", "bodyText": "How does this interact with our regular unittest framework? Could one skip, or run specific tests as needed?", "url": "https://github.com/apache/beam/pull/11338#discussion_r405182034", "createdAt": "2020-04-07T23:59:35Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/interactive/testing/integration/screen_diff.py", "diffHunk": "@@ -0,0 +1,203 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Module to conduct screen diff based notebook integration tests.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import os\n+import threading\n+import unittest\n+from http.server import SimpleHTTPRequestHandler\n+from http.server import ThreadingHTTPServer\n+from multiprocessing import Process\n+\n+from apache_beam.runners.interactive import interactive_environment as ie\n+from apache_beam.runners.interactive.testing.integration import notebook_executor\n+\n+try:\n+  import chromedriver_binary  # pylint: disable=unused-import\n+  from needle.cases import NeedleTestCase", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4Mjc3Mw==", "bodyText": "Could we compare produced html outputs? Do we need to compare that pixels are equivalent, if instead we can compare the html outputs?", "url": "https://github.com/apache/beam/pull/11338#discussion_r405182773", "createdAt": "2020-04-08T00:02:00Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/interactive/testing/integration/screen_diff.py", "diffHunk": "@@ -0,0 +1,203 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Module to conduct screen diff based notebook integration tests.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import os\n+import threading\n+import unittest\n+from http.server import SimpleHTTPRequestHandler\n+from http.server import ThreadingHTTPServer\n+from multiprocessing import Process\n+\n+from apache_beam.runners.interactive import interactive_environment as ie\n+from apache_beam.runners.interactive.testing.integration import notebook_executor\n+\n+try:\n+  import chromedriver_binary  # pylint: disable=unused-import\n+  from needle.cases import NeedleTestCase\n+  from needle.driver import NeedleChrome\n+  from selenium.webdriver.chrome.options import Options\n+  _interactive_integration_ready = (\n+      notebook_executor._interactive_integration_ready)\n+except ImportError:\n+  _interactive_integration_ready = False\n+\n+\n+class ScreenDiffIntegrationTestEnvironment(object):\n+  \"\"\"A test environment to conduct screen diff integration tests for notebooks.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4Mjk5MQ==", "bodyText": "High level question, do we need to compare that pixels did not change with chnages? What benefit do we get from it?", "url": "https://github.com/apache/beam/pull/11338#discussion_r405182991", "createdAt": "2020-04-08T00:02:46Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/interactive/testing/integration/tests/init_square_cube_test.py", "diffHunk": "@@ -0,0 +1,37 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Integration tests for interactive beam.\"\"\"\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+from apache_beam.runners.interactive.testing.integration.screen_diff import BaseTestCase\n+\n+\n+@unittest.skipIf(\n+    BaseTestCase.should_skip(),\n+    '[interactive] and [interactive_test] dependency are both required.')\n+class InitSquareCubeTest(BaseTestCase):\n+  def test_init_square_cube_notebook(self):\n+    self.assert_notebook('init_square_cube')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MzE1MQ==", "bodyText": "This is a quite a large addition for the value we are getting.\nAnd,\n\nshould this be integrated with tox?\njenkins?\nwhich platforms does this test work in?", "url": "https://github.com/apache/beam/pull/11338#discussion_r405183151", "createdAt": "2020-04-08T00:03:21Z", "author": {"login": "aaltay"}, "path": "sdks/python/setup.py", "diffHunk": "@@ -222,6 +222,17 @@ def get_version():\n     'ipython>=5.8.0,<8',\n     'timeloop>=1.0.2,<2',\n ]\n+\n+INTERACTIVE_BEAM_TEST = [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5cbb4785800f1cc5ff7982055d22eb51b6065e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c47e3befa415e6b19b3dba1c4e15b311b15a6e", "author": {"user": {"login": "KevinGG", "name": "Ning Kang"}}, "url": "https://github.com/apache/beam/commit/b1c47e3befa415e6b19b3dba1c4e15b311b15a6e", "committedDate": "2020-04-09T00:22:10Z", "message": "Added ipykernel setup in the notebook_executor; added more deps in setup so that the test can work in a standalone tox test env; skipped tests by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2979353c8a1215cd459dd87420982fc1a1c3a878", "author": {"user": {"login": "KevinGG", "name": "Ning Kang"}}, "url": "https://github.com/apache/beam/commit/2979353c8a1215cd459dd87420982fc1a1c3a878", "committedDate": "2020-04-09T01:22:21Z", "message": "Make screen_diff interpretable even when [interactive_test] dep is not installed; tests if not skipped properly will run as noop when dependencies are not available."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "934c45b44329a5706b8b66e145efdb733f7b266a", "author": {"user": {"login": "KevinGG", "name": "Ning Kang"}}, "url": "https://github.com/apache/beam/commit/934c45b44329a5706b8b66e145efdb733f7b266a", "committedDate": "2020-04-09T01:40:11Z", "message": "Make the noop base test case skipped by default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTU5ODQ3", "url": "https://github.com/apache/beam/pull/11338#pullrequestreview-390959847", "createdAt": "2020-04-09T16:44:24Z", "commit": {"oid": "934c45b44329a5706b8b66e145efdb733f7b266a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTYwNTM2", "url": "https://github.com/apache/beam/pull/11338#pullrequestreview-390960536", "createdAt": "2020-04-09T16:45:24Z", "commit": {"oid": "934c45b44329a5706b8b66e145efdb733f7b266a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo0NToyNVrOGDg27w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo0NToyNVrOGDg27w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNzI2Mw==", "bodyText": "Why is this added here and not to the test list?", "url": "https://github.com/apache/beam/pull/11338#discussion_r406337263", "createdAt": "2020-04-09T16:45:25Z", "author": {"login": "aaltay"}, "path": "sdks/python/setup.py", "diffHunk": "@@ -220,8 +220,21 @@ def get_version():\n INTERACTIVE_BEAM = [\n     'facets-overview>=1.0.0,<2',\n     'ipython>=5.8.0,<8',\n+    'ipykernel>=5.2.0,<6',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "934c45b44329a5706b8b66e145efdb733f7b266a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTc2MDgy", "url": "https://github.com/apache/beam/pull/11338#pullrequestreview-391576082", "createdAt": "2020-04-10T17:53:55Z", "commit": {"oid": "934c45b44329a5706b8b66e145efdb733f7b266a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b95fa7c52071dc3d61c274cc19fbdddf6f9dfb2", "author": {"user": {"login": "KevinGG", "name": "Ning Kang"}}, "url": "https://github.com/apache/beam/commit/5b95fa7c52071dc3d61c274cc19fbdddf6f9dfb2", "committedDate": "2020-04-13T17:54:59Z", "message": "Replace ThreadingHTTPServer (py37) with HTTPServer (py3+) and SimpleHTTPServer (py2)."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4489, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}