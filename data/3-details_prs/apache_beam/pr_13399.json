{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0OTg3NDI2", "number": 13399, "title": "[BEAM-11312] Log cloud build url and enable kaniko cache in sdk_container_builder", "bodyText": "\u2026iner_builder\nThis PR adds logging for the build history url in the case the google cloud build run failed, and also enables kaniko cache for better build performance as https://cloud.google.com/cloud-build/docs/kaniko-cache suggested. Experiment shows with kaniko cache, the build time for is greatly reduced after initial build. This helps user to launch job faster with prebuilt python sdk workflow.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-20T22:31:14Z", "url": "https://github.com/apache/beam/pull/13399", "merged": true, "mergeCommit": {"oid": "edc087efc7bb78e4f06bf9b73fbbdc85c76fb10d"}, "closed": true, "closedAt": "2020-12-04T21:38:23Z", "author": {"login": "y1chi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdefHoEgH2gAyNTI0OTg3NDI2OjllYzAwZTQzYWQ5YWU4OTg5YWQwYTZhMWYyNTg2MmFkYTc4MDhiZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi9yG4AH2gAyNTI0OTg3NDI2OjUzOGY0OTM4MjUwNWE1NTQ3MjVlYzY1Yjc1NGI1NjQxMjM1ODgwZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ec00e43ad9ae8989ad0a6a1f25862ada7808be3", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/9ec00e43ad9ae8989ad0a6a1f25862ada7808be3", "committedDate": "2020-11-20T22:30:21Z", "message": "[BEAM-11312] Log cloud build url and enable kaniko cache in sdk_container_builder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDAxMjk5", "url": "https://github.com/apache/beam/pull/13399#pullrequestreview-541401299", "createdAt": "2020-12-01T00:30:37Z", "commit": {"oid": "9ec00e43ad9ae8989ad0a6a1f25862ada7808be3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDozMDozOFrOH8TWZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDozMDozOFrOH8TWZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5MzYzNw==", "bodyText": "I'm curious - why list_builds vs get_build using the operation build ID here?", "url": "https://github.com/apache/beam/pull/13399#discussion_r532993637", "createdAt": "2020-12-01T00:30:38Z", "author": {"login": "emilymye"}, "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -236,10 +235,21 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info('Building sdk container, this may take a few minutes...')\n+    _LOGGER.info(\n+        'Building sdk container with google cloud build, this may '\n+        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n     # if build fails exception will be raised and stops the job submission.\n-    result = operation.result()\n+    try:\n+      result = operation.result()\n+    except Exception as e:\n+      build_lists = client.list_builds(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec00e43ad9ae8989ad0a6a1f25862ada7808be3"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/cda6ddaacd9257e6695e30d8635992ed211a6b89", "committedDate": "2020-12-04T18:03:12Z", "message": "Log url before build finishes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjUzODY0", "url": "https://github.com/apache/beam/pull/13399#pullrequestreview-545253864", "createdAt": "2020-12-04T19:53:06Z", "commit": {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTo1MzowNlrOH_fzlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTo1MzowNlrOH_fzlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0MzQ0Ng==", "bodyText": "Consider filing a feature request for the owner of this library.", "url": "https://github.com/apache/beam/pull/13399#discussion_r536343446", "createdAt": "2020-12-04T19:53:06Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -235,24 +235,26 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info(\n-        'Building sdk container with google cloud build, this may '\n-        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n-    # if build fails exception will be raised and stops the job submission.\n-    try:\n-      result = operation.result()\n-    except Exception as e:\n-      build_lists = client.list_builds(\n-          project_id=project_id,\n-          filter=\"source.storage_source.bucket=\\\"%s\\\" AND source\"\n-          \".storage_source.object=\\\"%s\\\"\" % (gcs_bucket, gcs_object))\n-      for build in build_lists:\n-        _LOGGER.error(\"Build failed, check log at %s\" % build.log_url)\n-      raise e\n     _LOGGER.info(\n-        \"Python SDK container pre-build finished in %.2f seconds, \"\n-        \"check build log at %s\" % (time.time() - now, result.log_url))\n+      'Building sdk container with google cloud build, this may '\n+      'take a few minutes...')\n+    # TODO: we shouldn't need to query build log url with list_builds if log", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjU2MDg2", "url": "https://github.com/apache/beam/pull/13399#pullrequestreview-545256086", "createdAt": "2020-12-04T19:56:52Z", "commit": {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTo1Njo1MlrOH_f7OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTo1Njo1MlrOH_f7OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0NTQwMA==", "bodyText": "nit: s/google cloud build/Google Cloud Build here and below.", "url": "https://github.com/apache/beam/pull/13399#discussion_r536345400", "createdAt": "2020-12-04T19:56:52Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/portability/sdk_container_builder.py", "diffHunk": "@@ -235,24 +235,26 @@ def invoke_docker_build_and_push(self, container_image_name):\n     build.timeout = Duration().FromSeconds(seconds=1800)\n \n     now = time.time()\n-    _LOGGER.info(\n-        'Building sdk container with google cloud build, this may '\n-        'take a few minutes...')\n     operation = client.create_build(project_id=project_id, build=build)\n-    # if build fails exception will be raised and stops the job submission.\n-    try:\n-      result = operation.result()\n-    except Exception as e:\n-      build_lists = client.list_builds(\n-          project_id=project_id,\n-          filter=\"source.storage_source.bucket=\\\"%s\\\" AND source\"\n-          \".storage_source.object=\\\"%s\\\"\" % (gcs_bucket, gcs_object))\n-      for build in build_lists:\n-        _LOGGER.error(\"Build failed, check log at %s\" % build.log_url)\n-      raise e\n     _LOGGER.info(\n-        \"Python SDK container pre-build finished in %.2f seconds, \"\n-        \"check build log at %s\" % (time.time() - now, result.log_url))\n+      'Building sdk container with google cloud build, this may '", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cda6ddaacd9257e6695e30d8635992ed211a6b89"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538f49382505a554725ec65b754b5641235880fc", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/538f49382505a554725ec65b754b5641235880fc", "committedDate": "2020-12-04T20:29:36Z", "message": "Fix format."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4510, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}