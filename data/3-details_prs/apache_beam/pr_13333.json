{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzYxMjMy", "number": 13333, "title": "Further dataframe batch consolidation.", "bodyText": "Concatenate small dataframe before shuffle.\nOmit shuffling of empty partitions.\n\nThis requires some adjustment to use the proxy object\nif all partitions from all workers are empty.\n\n\n\nProjections, filterings, and aggregations are common operations that often greatly reduce the size of a dataframe, and can result in small output batches which have high relative overhead.\nThis is in reaction to looking at the number of (relatively tiny) elements in the dataflow ui.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-13T18:23:57Z", "url": "https://github.com/apache/beam/pull/13333", "merged": true, "mergeCommit": {"oid": "b18784ffd6eb306ab58e6fe5d3de01fd02052fa7"}, "closed": true, "closedAt": "2020-11-16T20:41:58Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcLXAcAH2gAyNTIwNzYxMjMyOmE3ZWE3NThmMmNiY2IwMWExN2U1ZGIwMWFkNWQ3YTYyMTAzMzFlYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddJ1IUgH2gAyNTIwNzYxMjMyOjYzMDBjMzMyYjMyYzBkZTQ5NDA1MzJmODY1YzEzZWY3NGI2NmNjYTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7ea758f2cbcb01a17e5db01ad5d7a6210331eab", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/a7ea758f2cbcb01a17e5db01ad5d7a6210331eab", "committedDate": "2020-11-13T18:21:12Z", "message": "Further dataframe batch consolidation.\n\n* Concatinate small dataframe before shuffle.\n* Omit shuffling of empty partitions.\n    - This requires some adjustment to use the proxy object\n      if *all* partitions from all workers are empty.\n\nProjections, filterings, and aggregations are common operations\nthat often greatly reduce the size of a dataframe, and can result\nin small output batches which have high relative overhead."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee", "committedDate": "2020-11-13T18:21:21Z", "message": "Add another test.\n\nAlso use iloc in place of bare index to fix non-int indices."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNjA5MzEx", "url": "https://github.com/apache/beam/pull/13333#pullrequestreview-531609311", "createdAt": "2020-11-16T18:49:39Z", "commit": {"oid": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo0OTozOVrOH0MuNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxOTowMTowOVrOH0NJEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5NjQzOA==", "bodyText": "nit: maybe add a comment like this to clarify the intention\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return expr.proxy(\n          \n          \n            \n                        ).iloc[:0] if partition[expr._id] is None else partition[expr._id]\n          \n          \n            \n                        # Use proxy if there's no data in this partition\n          \n          \n            \n                        return expr.proxy(\n          \n          \n            \n                        ).iloc[:0] if partition[expr._id] is None else partition[expr._id]", "url": "https://github.com/apache/beam/pull/13333#discussion_r524496438", "createdAt": "2020-11-16T18:49:39Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/transforms.py", "diffHunk": "@@ -223,8 +235,12 @@ def expand(self, pcolls):\n \n         # Actually evaluate the expressions.\n         def evaluate(partition, stage=self.stage, **side_inputs):\n+          def lookup(expr):\n+            return expr.proxy(\n+            ).iloc[:0] if partition[expr._id] is None else partition[expr._id]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMzMxNQ==", "bodyText": "This is frustratingly similar to _ReBatch... but I don't see a reasonable way to combine them.", "url": "https://github.com/apache/beam/pull/13333#discussion_r524503315", "createdAt": "2020-11-16T19:01:09Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/transforms.py", "diffHunk": "@@ -410,6 +426,35 @@ def _total_memory_usage(frame):\n     float('inf')\n \n \n+class _PreBatch(beam.DoFn):\n+  def __init__(self, target_size=TARGET_PARTITION_SIZE):\n+    self._target_size = target_size\n+\n+  def start_bundle(self):\n+    self._parts = collections.defaultdict(list)\n+    self._running_size = 0\n+\n+  def process(\n+      self,\n+      part,\n+      window=beam.DoFn.WindowParam,\n+      timestamp=beam.DoFn.TimestampParam):\n+    part_size = _total_memory_usage(part)\n+    if part_size >= self._target_size:\n+      yield part\n+    else:\n+      self._running_size += part_size\n+      self._parts[window, timestamp].append(part)\n+      if self._running_size >= self._target_size:\n+        yield from self.finish_bundle()\n+\n+  def finish_bundle(self):\n+    for (window, timestamp), parts in self._parts.items():\n+      yield windowed_value.WindowedValue(\n+          pd.concat(parts), timestamp, (window, ))\n+    self.start_bundle()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ef95b5ede1e5a66de21b84c4f8e4d3b525379ee"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6300c332b32c0de4940532f865c13ef74b66cca6", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/6300c332b32c0de4940532f865c13ef74b66cca6", "committedDate": "2020-11-16T19:08:13Z", "message": "Update sdks/python/apache_beam/dataframe/transforms.py\n\nCo-authored-by: Brian Hulette <hulettbh@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4861, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}