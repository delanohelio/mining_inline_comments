{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNjg4MTkx", "number": 13060, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0Mzo1NlrOEuGszw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjoyNzo0M1rOEusxwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc5NzI3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0Mzo1N1rOHiTDCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0Mzo1N1rOHiTDCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTcwNw==", "bodyText": "I changed this import because profiler was conflicting with some local variable names, and this was the simplest resolution.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505725707", "createdAt": "2020-10-15T17:43:57Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -62,13 +64,15 @@\n from apache_beam.runners.portability.fn_api_runner.translations import only_element\n from apache_beam.runners.portability.fn_api_runner.worker_handlers import WorkerHandlerManager\n from apache_beam.transforms import environments\n-from apache_beam.utils import profiler\n from apache_beam.utils import proto_utils\n from apache_beam.utils import thread_pool_executor\n+from apache_beam.utils.profiler import Profile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Nzc5ODc4OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0NDoyMFrOHiTEAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMTozMjoxM1rOHjTUXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTk1Mg==", "bodyText": "Can I safely get rid of this attribute?", "url": "https://github.com/apache/beam/pull/13060#discussion_r505725952", "createdAt": "2020-10-15T17:44:20Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -539,6 +548,7 @@ def merge_results(last_result):\n       else:\n         data_input = deferred_inputs\n         input_timers = fired_timers\n+        # FIXME: this seems unused, and produces an attr-defined error\n         bundle_manager._registered = True", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0ODExMg==", "bodyText": "Yes, this should not be needed anymore.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506748112", "createdAt": "2020-10-16T22:30:25Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -539,6 +548,7 @@ def merge_results(last_result):\n       else:\n         data_input = deferred_inputs\n         input_timers = fired_timers\n+        # FIXME: this seems unused, and produces an attr-defined error\n         bundle_manager._registered = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTk1Mg=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3ODcxNw==", "bodyText": "Removed.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506778717", "createdAt": "2020-10-17T01:32:13Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -539,6 +548,7 @@ def merge_results(last_result):\n       else:\n         data_input = deferred_inputs\n         input_timers = fired_timers\n+        # FIXME: this seems unused, and produces an attr-defined error\n         bundle_manager._registered = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTk1Mg=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NzgwMDc4OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0NDo1MVrOHiTFPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjozMjowMVrOHjRegg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjI3MA==", "bodyText": "We discussed this before and you said this was safe, but just wanted to double check.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505726270", "createdAt": "2020-10-15T17:44:51Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -307,6 +308,9 @@ def executable_stage_transform(\n           for side in side_inputs\n       },\n                           main_input=main_input_id)\n+      # at this point we should have resolved an environment, as the key of\n+      # components.environments cannot be None.\n+      assert self.environment is not None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0ODU0Ng==", "bodyText": "Yes, that looks safe.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506748546", "createdAt": "2020-10-16T22:32:01Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -307,6 +308,9 @@ def executable_stage_transform(\n           for side in side_inputs\n       },\n                           main_input=main_input_id)\n+      # at this point we should have resolved an environment, as the key of\n+      # components.environments cannot be None.\n+      assert self.environment is not None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjI3MA=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NzgxMzg3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/utils/profiler.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0ODoyN1rOHiTNWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0ODoyN1rOHiTNWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyODM0NQ==", "bodyText": "I decided to change this to pass in self.profile_location because in this context, where it's called, we know that it's not None.  Let's us avoid calling assert inside self._upload_profile_data", "url": "https://github.com/apache/beam/pull/13060#discussion_r505728345", "createdAt": "2020-10-15T17:48:27Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/utils/profiler.py", "diffHunk": "@@ -113,7 +116,10 @@ def __exit__(self, *args):\n           h = self.hpy.heap()\n           heap_dump_data = '%s\\n%s' % (h, h.more)\n           self._upload_profile_data(\n-              'memory_profile', heap_dump_data, write_binary=False)\n+              self.profile_location,\n+              'memory_profile',\n+              heap_dump_data,\n+              write_binary=False)\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTA5MzY3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxMTo0MlrOHifrIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMTozMToxNFrOHjTT5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMjU3Nw==", "bodyText": "note to self:  standardize on PartitionableBuffer vs execution.PartitionableBuffer", "url": "https://github.com/apache/beam/pull/13060#discussion_r505932577", "createdAt": "2020-10-16T00:11:42Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -355,9 +361,9 @@ def _run_bundle_multiple_times_for_testing(\n       self,\n       runner_execution_context,  # type: execution.FnApiRunnerExecutionContext\n       bundle_manager,  # type: BundleManager\n-      data_input,\n+      data_input,  # type: Dict[str, PartitionableBuffer]\n       data_output,  # type: DataOutput\n-      fired_timers,\n+      fired_timers,  # type: Mapping[Tuple[str, str], execution.PartitionableBuffer]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3ODU5Ng==", "bodyText": "resolved", "url": "https://github.com/apache/beam/pull/13060#discussion_r506778596", "createdAt": "2020-10-17T01:31:14Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -355,9 +361,9 @@ def _run_bundle_multiple_times_for_testing(\n       self,\n       runner_execution_context,  # type: execution.FnApiRunnerExecutionContext\n       bundle_manager,  # type: BundleManager\n-      data_input,\n+      data_input,  # type: Dict[str, PartitionableBuffer]\n       data_output,  # type: DataOutput\n-      fired_timers,\n+      fired_timers,  # type: Mapping[Tuple[str, str], execution.PartitionableBuffer]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMjU3Nw=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTA5NzQxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/worker_handlers.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxNDowMlrOHiftTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjozNjoyN1rOHjRizg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMzEzNA==", "bodyText": "It would be good to get confirmation that this assert is correct.  AFAICT this method should never return None.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505933134", "createdAt": "2020-10-16T00:14:02Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/worker_handlers.py", "diffHunk": "@@ -1062,34 +1104,41 @@ def close(self):\n \n \n class ControlFuture(object):\n-  def __init__(self, instruction_id, response=None):\n+  def __init__(self,\n+               instruction_id,  # type: str\n+               response=None  # type: Optional[beam_fn_api_pb2.InstructionResponse]\n+              ):\n+    # type: (...) -> None\n     self.instruction_id = instruction_id\n-    if response:\n-      self._response = response\n-    else:\n-      self._response = None\n+    self._response = response\n+    if response is None:\n       self._condition = threading.Condition()\n-    self._exception = None\n+    self._exception = None  # type: Optional[Exception]\n \n   def is_done(self):\n+    # type: () -> bool\n     return self._response is not None\n \n   def set(self, response):\n+    # type: (beam_fn_api_pb2.InstructionResponse) -> None\n     with self._condition:\n       self._response = response\n       self._condition.notify_all()\n \n   def get(self, timeout=None):\n+    # type: (Optional[float]) -> beam_fn_api_pb2.InstructionResponse\n     if not self._response and not self._exception:\n       with self._condition:\n         if not self._response and not self._exception:\n           self._condition.wait(timeout)\n     if self._exception:\n       raise self._exception\n     else:\n+      assert self._response is not None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 479}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0OTY0Ng==", "bodyText": "Correct, either an exception will be thrown, a timeout will be thrown, or the response is non-None.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506749646", "createdAt": "2020-10-16T22:36:27Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/worker_handlers.py", "diffHunk": "@@ -1062,34 +1104,41 @@ def close(self):\n \n \n class ControlFuture(object):\n-  def __init__(self, instruction_id, response=None):\n+  def __init__(self,\n+               instruction_id,  # type: str\n+               response=None  # type: Optional[beam_fn_api_pb2.InstructionResponse]\n+              ):\n+    # type: (...) -> None\n     self.instruction_id = instruction_id\n-    if response:\n-      self._response = response\n-    else:\n-      self._response = None\n+    self._response = response\n+    if response is None:\n       self._condition = threading.Condition()\n-    self._exception = None\n+    self._exception = None  # type: Optional[Exception]\n \n   def is_done(self):\n+    # type: () -> bool\n     return self._response is not None\n \n   def set(self, response):\n+    # type: (beam_fn_api_pb2.InstructionResponse) -> None\n     with self._condition:\n       self._response = response\n       self._condition.notify_all()\n \n   def get(self, timeout=None):\n+    # type: (Optional[float]) -> beam_fn_api_pb2.InstructionResponse\n     if not self._response and not self._exception:\n       with self._condition:\n         if not self._response and not self._exception:\n           self._condition.wait(timeout)\n     if self._exception:\n       raise self._exception\n     else:\n+      assert self._response is not None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMzEzNA=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 479}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NDAzNTg2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/execution.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjoyNzo0M1rOHjRaIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMToxMTowMFrOHjTL1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NzQyNA==", "bodyText": "How about making them raise errors rather than be no-ops?", "url": "https://github.com/apache/beam/pull/13060#discussion_r506747424", "createdAt": "2020-10-16T22:27:43Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/execution.py", "diffHunk": "@@ -227,12 +251,24 @@ def __iter__(self):\n     \"\"\"\n     return itertools.chain(*self.partition(1))\n \n+  # these should never be accessed, but they allow this class to meet the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NjUzMw==", "bodyText": "I prefer the current solution because it's reasonable and safe to call clear() and reset() on this class and have it do nothing:  there's simply nothing to clear or reset.   It seems wrong to meet the protocol definition, but then error if the methods are called: that's not really meeting the protocol.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506776533", "createdAt": "2020-10-17T01:11:00Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/execution.py", "diffHunk": "@@ -227,12 +251,24 @@ def __iter__(self):\n     \"\"\"\n     return itertools.chain(*self.partition(1))\n \n+  # these should never be accessed, but they allow this class to meet the", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NzQyNA=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3159, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}