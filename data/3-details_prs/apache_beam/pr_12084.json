{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTkyNjE3", "number": 12084, "title": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID", "bodyText": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-25T00:53:36Z", "url": "https://github.com/apache/beam/pull/12084", "merged": true, "mergeCommit": {"oid": "1aa3eb5abd27b46e16b5f3e56b0a1a99e4114ec0"}, "closed": true, "closedAt": "2020-07-06T18:26:26Z", "author": {"login": "ajamato"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuj7FsgBqjM0Nzk5MTAxMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwz0_SgBqjM1MDQ3NzUyMDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa45c4389f77b9cf1384b390ef36080fc787931c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/fa45c4389f77b9cf1384b390ef36080fc787931c", "committedDate": "2020-06-25T00:52:27Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "b917196e2f03ffdfd63dd49fe6729b334c3ebadf", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b917196e2f03ffdfd63dd49fe6729b334c3ebadf", "committedDate": "2020-06-25T00:57:23Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b917196e2f03ffdfd63dd49fe6729b334c3ebadf", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b917196e2f03ffdfd63dd49fe6729b334c3ebadf", "committedDate": "2020-06-25T00:57:23Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "6a8b2d29250962d33f2de1c89a3d1bf11a97895a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6a8b2d29250962d33f2de1c89a3d1bf11a97895a", "committedDate": "2020-06-25T19:36:40Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a8b2d29250962d33f2de1c89a3d1bf11a97895a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6a8b2d29250962d33f2de1c89a3d1bf11a97895a", "committedDate": "2020-06-25T19:36:40Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "54f60c3755f757369d447eec1259203395f76181", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/54f60c3755f757369d447eec1259203395f76181", "committedDate": "2020-06-25T22:21:56Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54f60c3755f757369d447eec1259203395f76181", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/54f60c3755f757369d447eec1259203395f76181", "committedDate": "2020-06-25T22:21:56Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "a2cce709b5014ad334b24e50046273f727746d7a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a2cce709b5014ad334b24e50046273f727746d7a", "committedDate": "2020-06-25T23:35:08Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2cce709b5014ad334b24e50046273f727746d7a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a2cce709b5014ad334b24e50046273f727746d7a", "committedDate": "2020-06-25T23:35:08Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "77265f82d95a4f42e130d8c76e03863de304aa56", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/77265f82d95a4f42e130d8c76e03863de304aa56", "committedDate": "2020-06-26T00:45:33Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77265f82d95a4f42e130d8c76e03863de304aa56", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/77265f82d95a4f42e130d8c76e03863de304aa56", "committedDate": "2020-06-26T00:45:33Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "459b9e0dd8c8ccff381e946b35f99d25268947a8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/459b9e0dd8c8ccff381e946b35f99d25268947a8", "committedDate": "2020-06-26T01:00:27Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "459b9e0dd8c8ccff381e946b35f99d25268947a8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/459b9e0dd8c8ccff381e946b35f99d25268947a8", "committedDate": "2020-06-26T01:00:27Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "b6f929ae90a842ea714bb71d7fca915281805645", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b6f929ae90a842ea714bb71d7fca915281805645", "committedDate": "2020-06-26T23:40:10Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6f929ae90a842ea714bb71d7fca915281805645", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b6f929ae90a842ea714bb71d7fca915281805645", "committedDate": "2020-06-26T23:40:10Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/16429501a4de8d17bdc380a2e97dd53c033d21b4", "committedDate": "2020-06-29T20:49:26Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTUzOTg2", "url": "https://github.com/apache/beam/pull/12084#pullrequestreview-440553986", "createdAt": "2020-07-01T05:23:59Z", "commit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNToyNDowMFrOGrXMfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNTozOTowMlrOGrXdBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMTk4Mg==", "bodyText": "(nit)Up to you, but you could reduce to this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                job_labels = dict() if job_labels is None else job_labels\n          \n          \n            \n                job_labels = job_labels or {}", "url": "https://github.com/apache/beam/pull/12084#discussion_r448121982", "createdAt": "2020-07-01T05:24:00Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():\n+  \"\"\"Creates a BigQueryIOMetadata.\n+\n+  This will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  dataflow_job_id = gce_metadata_util.FetchDataflowJobId()\n+  # If a dataflow_job id is returned on GCE metadata. Then it means\n+  # This program is running on a Dataflow GCE VM.\n+  is_dataflow_runner = bool(dataflow_job_id)\n+  kwargs = {}\n+  if is_dataflow_runner:\n+    kwargs['beam_job_id'] = dataflow_job_id\n+  return BigQueryIOMetadata(**kwargs)\n+\n+\n+class BigQueryIOMetadata(object):\n+  \"\"\"Metadata class for BigQueryIO. i.e. to use as BQ job labels.\n+\n+  Do not construct directly, use the CreateBigQueryIOMetadata factory.\n+  Which will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  def __init__(self, beam_job_id=None):\n+    self.beam_job_id = beam_job_id\n+\n+  def add_additional_bq_job_labels(self, job_labels=None):\n+    job_labels = dict() if job_labels is None else job_labels", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMjkwNQ==", "bodyText": "Do you want to add the display data item for this DoFn?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448122905", "createdAt": "2020-07-01T05:27:13Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_file_loads.py", "diffHunk": "@@ -327,10 +329,13 @@ def __init__(\n     self.write_disposition = write_disposition\n     self.test_client = test_client\n     self._observed_tables = set()\n+    self.bq_io_metadata = None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMzE2Nw==", "bodyText": "we usually make functions be snake_case. Could you change this please?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448123167", "createdAt": "2020-07-01T05:28:09Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMzMzNw==", "bodyText": "make functions snake_case please", "url": "https://github.com/apache/beam/pull/12084#discussion_r448123337", "createdAt": "2020-07-01T05:28:57Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNDEwNQ==", "bodyText": "os.path.join should ensure URLs are joined properly independently of whether the key has/does not have a leading slash. Do you think that'd be good to add?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448124105", "createdAt": "2020-07-01T05:31:49Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):\n+  try:\n+    h = get_new_http(timeout_secs=5)\n+    headers = {\"Metadata-Flavor\": \"Google\"}\n+    uri = BASE_METADATA_URL + key", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNTU5Mg==", "bodyText": "this means that for other runners, BQ will receive jobs with a label of 'beam_job_id'=None - is that fine?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448125592", "createdAt": "2020-07-01T05:37:07Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():\n+  \"\"\"Creates a BigQueryIOMetadata.\n+\n+  This will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  dataflow_job_id = gce_metadata_util.FetchDataflowJobId()\n+  # If a dataflow_job id is returned on GCE metadata. Then it means\n+  # This program is running on a Dataflow GCE VM.\n+  is_dataflow_runner = bool(dataflow_job_id)\n+  kwargs = {}\n+  if is_dataflow_runner:\n+    kwargs['beam_job_id'] = dataflow_job_id\n+  return BigQueryIOMetadata(**kwargs)\n+\n+\n+class BigQueryIOMetadata(object):\n+  \"\"\"Metadata class for BigQueryIO. i.e. to use as BQ job labels.\n+\n+  Do not construct directly, use the CreateBigQueryIOMetadata factory.\n+  Which will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  def __init__(self, beam_job_id=None):\n+    self.beam_job_id = beam_job_id\n+\n+  def add_additional_bq_job_labels(self, job_labels=None):\n+    job_labels = dict() if job_labels is None else job_labels\n+    if self.beam_job_id and 'beam_job_id' not in job_labels:\n+      job_labels['beam_job_id'] = self.beam_job_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNjIxNA==", "bodyText": "(up to you)", "url": "https://github.com/apache/beam/pull/12084#discussion_r448126214", "createdAt": "2020-07-01T05:39:02Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):\n+  try:\n+    h = get_new_http(timeout_secs=5)\n+    headers = {\"Metadata-Flavor\": \"Google\"}\n+    uri = BASE_METADATA_URL + key", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNDEwNQ=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTU5NjMx", "url": "https://github.com/apache/beam/pull/12084#pullrequestreview-440559631", "createdAt": "2020-07-01T05:41:27Z", "commit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNTo0MToyN1rOGrXfmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwNTo0MToyN1rOGrXfmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNjg3NA==", "bodyText": "how will it work for non-dataflow workers? Will it fail immediately? time out?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448126874", "createdAt": "2020-07-01T05:41:27Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):\n+  try:\n+    h = get_new_http(timeout_secs=5)\n+    headers = {\"Metadata-Flavor\": \"Google\"}\n+    uri = BASE_METADATA_URL + key\n+    resp, content = h.request(uri, \"GET\", headers=headers)\n+    if resp.status == 200:\n+      return content\n+  except httplib2.HttpLib2Error:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/16429501a4de8d17bdc380a2e97dd53c033d21b4", "committedDate": "2020-06-29T20:49:26Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "5ab2b0a1051863fca3f85887cb8fe2d0933a630f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/5ab2b0a1051863fca3f85887cb8fe2d0933a630f", "committedDate": "2020-07-01T20:20:43Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTEwMDAz", "url": "https://github.com/apache/beam/pull/12084#pullrequestreview-441110003", "createdAt": "2020-07-01T18:37:47Z", "commit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNzo0OFrOGrxM5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDowNTowNVrOGrzrBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODA2OA==", "bodyText": "Yes. Done", "url": "https://github.com/apache/beam/pull/12084#discussion_r448548068", "createdAt": "2020-07-01T18:37:48Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_file_loads.py", "diffHunk": "@@ -327,10 +329,13 @@ def __init__(\n     self.write_disposition = write_disposition\n     self.test_client = test_client\n     self._observed_tables = set()\n+    self.bq_io_metadata = None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMjkwNQ=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTk2MA==", "bodyText": "Done", "url": "https://github.com/apache/beam/pull/12084#discussion_r448549960", "createdAt": "2020-07-01T18:41:35Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMzE2Nw=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTAwNg==", "bodyText": "Done", "url": "https://github.com/apache/beam/pull/12084#discussion_r448551006", "createdAt": "2020-07-01T18:43:45Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():\n+  \"\"\"Creates a BigQueryIOMetadata.\n+\n+  This will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  dataflow_job_id = gce_metadata_util.FetchDataflowJobId()\n+  # If a dataflow_job id is returned on GCE metadata. Then it means\n+  # This program is running on a Dataflow GCE VM.\n+  is_dataflow_runner = bool(dataflow_job_id)\n+  kwargs = {}\n+  if is_dataflow_runner:\n+    kwargs['beam_job_id'] = dataflow_job_id\n+  return BigQueryIOMetadata(**kwargs)\n+\n+\n+class BigQueryIOMetadata(object):\n+  \"\"\"Metadata class for BigQueryIO. i.e. to use as BQ job labels.\n+\n+  Do not construct directly, use the CreateBigQueryIOMetadata factory.\n+  Which will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  def __init__(self, beam_job_id=None):\n+    self.beam_job_id = beam_job_id\n+\n+  def add_additional_bq_job_labels(self, job_labels=None):\n+    job_labels = dict() if job_labels is None else job_labels", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMTk4Mg=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTY4Mg==", "bodyText": "No, it shouldn't populate the label at all in that case. Because of the\n\"if self.beam_job_id\"\nIt won't evaluate the if if it's None or an empty string.\nOr have I made a mistake which I don't see?", "url": "https://github.com/apache/beam/pull/12084#discussion_r448551682", "createdAt": "2020-07-01T18:45:08Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -0,0 +1,55 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Metadata for use in BigQueryIO, i.e. a job_id to use in BQ job labels.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from apache_beam.io.gcp import gce_metadata_util\n+\n+\n+def CreateBigQueryIOMetadata():\n+  \"\"\"Creates a BigQueryIOMetadata.\n+\n+  This will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  dataflow_job_id = gce_metadata_util.FetchDataflowJobId()\n+  # If a dataflow_job id is returned on GCE metadata. Then it means\n+  # This program is running on a Dataflow GCE VM.\n+  is_dataflow_runner = bool(dataflow_job_id)\n+  kwargs = {}\n+  if is_dataflow_runner:\n+    kwargs['beam_job_id'] = dataflow_job_id\n+  return BigQueryIOMetadata(**kwargs)\n+\n+\n+class BigQueryIOMetadata(object):\n+  \"\"\"Metadata class for BigQueryIO. i.e. to use as BQ job labels.\n+\n+  Do not construct directly, use the CreateBigQueryIOMetadata factory.\n+  Which will request metadata properly based on which runner is being used.\n+  \"\"\"\n+  def __init__(self, beam_job_id=None):\n+    self.beam_job_id = beam_job_id\n+\n+  def add_additional_bq_job_labels(self, job_labels=None):\n+    job_labels = dict() if job_labels is None else job_labels\n+    if self.beam_job_id and 'beam_job_id' not in job_labels:\n+      job_labels['beam_job_id'] = self.beam_job_id", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNTU5Mg=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MjkyNQ==", "bodyText": "Done", "url": "https://github.com/apache/beam/pull/12084#discussion_r448552925", "createdAt": "2020-07-01T18:47:32Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyMzMzNw=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MzQ4MA==", "bodyText": "No, because on windows it will add backslashes. Let's just keep it simple like this for now. Since its a private method, we should expect proper methods like fetch_dataflow_job_id to be written for future keys.", "url": "https://github.com/apache/beam/pull/12084#discussion_r448553480", "createdAt": "2020-07-01T18:48:44Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):\n+  try:\n+    h = get_new_http(timeout_secs=5)\n+    headers = {\"Metadata-Flavor\": \"Google\"}\n+    uri = BASE_METADATA_URL + key", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNDEwNQ=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4ODU0OQ==", "bodyText": "The URL should not resolve, so it should fail quickly after attempting a request, not for the full timeout. Ideally we are making this request as infrequently as possible.\nI've also just added a method to validate the label, in the off case that the metadata server is giving bad output. I don't want this to make the BQ jobs fail (they will fail if given invalid labels).", "url": "https://github.com/apache/beam/pull/12084#discussion_r448588549", "createdAt": "2020-07-01T20:05:05Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/gce_metadata_util.py", "diffHunk": "@@ -0,0 +1,51 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Fetches GCE metadata if the calling process is running on a GCE VM.\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+import httplib2\n+\n+from apache_beam.internal.http_client import get_new_http\n+\n+BASE_METADATA_URL = \"http://metadata/computeMetadata/v1/\"\n+\n+\n+def FetchMetadata(key):\n+  try:\n+    h = get_new_http(timeout_secs=5)\n+    headers = {\"Metadata-Flavor\": \"Google\"}\n+    uri = BASE_METADATA_URL + key\n+    resp, content = h.request(uri, \"GET\", headers=headers)\n+    if resp.status == 200:\n+      return content\n+  except httplib2.HttpLib2Error:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEyNjg3NA=="}, "originalCommit": {"oid": "16429501a4de8d17bdc380a2e97dd53c033d21b4"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48fa73e51b683148f102187c3a67278118cbb8ac", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/48fa73e51b683148f102187c3a67278118cbb8ac", "committedDate": "2020-07-02T00:37:16Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ab2b0a1051863fca3f85887cb8fe2d0933a630f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/5ab2b0a1051863fca3f85887cb8fe2d0933a630f", "committedDate": "2020-07-01T20:20:43Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}, "afterCommit": {"oid": "48fa73e51b683148f102187c3a67278118cbb8ac", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/48fa73e51b683148f102187c3a67278118cbb8ac", "committedDate": "2020-07-02T00:37:16Z", "message": "[BEAM-10317] Python - Update BigQueryIO to tag BigQuery Jobs with the Dataflow Job ID"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3843, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}