{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDM5MjQ2", "number": 10919, "title": "[BEAM-9347] Don't overwrite default runner harness for unified worker", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-21T00:04:46Z", "url": "https://github.com/apache/beam/pull/10919", "merged": true, "mergeCommit": {"oid": "e9cbb8c5c929d47d62060beac77221e2c9bde1be"}, "closed": true, "closedAt": "2020-02-24T22:35:16Z", "author": {"login": "angoenka"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGUuufAH2gAyMzc4MDM5MjQ2Ojc5NjJmYTYwMjcwODMyNzdkYjRiNjNjNjQ5ZjU5ODkzOGVhNjIyNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHlVR8gFqTM2Mzc0OTk4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7962fa6027083277db4b63c649f598938ea62272", "author": {"user": {"login": "angoenka", "name": "Ankur"}}, "url": "https://github.com/apache/beam/commit/7962fa6027083277db4b63c649f598938ea62272", "committedDate": "2020-02-21T00:38:46Z", "message": "[BEAM-9347] Don't overwrite default runner harness for unified worker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a8d95d56363dd8a777b457018230fb37b30b6df", "author": {"user": {"login": "angoenka", "name": "Ankur"}}, "url": "https://github.com/apache/beam/commit/0a8d95d56363dd8a777b457018230fb37b30b6df", "committedDate": "2020-02-21T00:03:51Z", "message": "[BEAM-9347] Don't overwrite default runner harness for unified worker"}, "afterCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272", "author": {"user": {"login": "angoenka", "name": "Ankur"}}, "url": "https://github.com/apache/beam/commit/7962fa6027083277db4b63c649f598938ea62272", "committedDate": "2020-02-21T00:38:46Z", "message": "[BEAM-9347] Don't overwrite default runner harness for unified worker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDAwNDA3", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363000407", "createdAt": "2020-02-22T01:50:28Z", "commit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMTo1MDoyOFrOFtI18g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMTo1MDoyOFrOFtI18g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg==", "bodyText": "PTAL at this method - we need to remove some of the statements in 922-928.", "url": "https://github.com/apache/beam/pull/10919#discussion_r382875122", "createdAt": "2020-02-22T01:50:28Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -916,6 +919,9 @@ def _use_unified_worker(pipeline_options):\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n \n+  if debug_options.lookup_experiment(use_unified_worker_flag):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDAxMDc1", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363001075", "createdAt": "2020-02-22T01:58:03Z", "commit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMTo1ODowNFrOFtI4uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMTo1ODowNFrOFtI4uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTgzMg==", "bodyText": "I think it will be easier to read if we restructure this:\nif (self.debug_options.lookup_experiment('runner_harness_container_image') or \n    _use_unified_worker(self.debug_options)):\n   # Comment on WHY we don't want to set the override\n   pass\nelse:\n   <...set the override...>\n\nWDYT?", "url": "https://github.com/apache/beam/pull/10919#discussion_r382875832", "createdAt": "2020-02-22T01:58:04Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,11 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n+      # Don't add the default image overwrite if user overwrites or", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjczODE4", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363673818", "createdAt": "2020-02-24T20:19:58Z", "commit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoxOTo1OFrOFtuiHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyODo1M1rOFtuxvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MjYzNg==", "bodyText": "We can move 925-926 to dataflow_runner.py but then i feel the logic to determine unified_worker usage will be more staggered.\nI think it will be better to keep the interpretation of use_unified_worker and use_runner_v2 at a single place.\nFor now, we support both flag but I think we will transition to use_runner_v2 over time (not sure by when).", "url": "https://github.com/apache/beam/pull/10919#discussion_r383492636", "createdAt": "2020-02-24T20:19:58Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -916,6 +919,9 @@ def _use_unified_worker(pipeline_options):\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n \n+  if debug_options.lookup_experiment(use_unified_worker_flag):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, "originalCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NjYzNw==", "bodyText": "I think it will be easier to read if we restructure this:\nif (self.debug_options.lookup_experiment('runner_harness_container_image') or \n    _use_unified_worker(self.debug_options)):\n   # Comment on WHY we don't want to set the override\n   pass\nelse:\n   <...set the override...>\n\nWDYT?\n\nI think it makes sense. Will update it.\n\nAlso, should we be passing pipeline_options instead of debug options? Perhaps it works either way but passing pipeline options would be cleaner since that's what the signature of _use_unified_worker() expects.\n\nI think the code is structured in a way that a self.debug_options is referenced every where and the reference to it can be different from options passed in the method argument. So I think it will need a more thoughtful refactoring to move to change it to options in the right manner. Which I think we can differ.", "url": "https://github.com/apache/beam/pull/10919#discussion_r383496637", "createdAt": "2020-02-24T20:28:53Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,11 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n+      # Don't add the default image overwrite if user overwrites or", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTgzMg=="}, "originalCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca", "author": {"user": {"login": "angoenka", "name": "Ankur"}}, "url": "https://github.com/apache/beam/commit/8cd57753e2c179861562de24cd7ae4f02bfd8aca", "committedDate": "2020-02-24T20:31:23Z", "message": "Addressing comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzAzMjYy", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363703262", "createdAt": "2020-02-24T21:11:35Z", "commit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMToxMTozNVrOFtv_ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMToxNjoxM1rOFtwIRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjUyMg==", "bodyText": "I think that it would be cleaner to not modify experiments in _use_unified_worker, since the name of this method does not suggest that it modifies the state, and it would also be easier to follow the logic. Also, if Dataflow runner relies on the fact that \"use_runner_v2\" experiment is set, it might be better to set it explicitly at some point, instead of relying on the fact that \"_use_unified_worker\" will be called. Leaving this up to you.", "url": "https://github.com/apache/beam/pull/10919#discussion_r383516522", "createdAt": "2020-02-24T21:11:35Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -916,6 +919,9 @@ def _use_unified_worker(pipeline_options):\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n \n+  if debug_options.lookup_experiment(use_unified_worker_flag):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NTEyMg=="}, "originalCommit": {"oid": "7962fa6027083277db4b63c649f598938ea62272"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjk1Mw==", "bodyText": "Few thoughts here\n\nI think we cannot instantiate DebugOptions() in self.debug_options = self.debug_options or DebugOptions(). We should create a view of existing options.  All views of pipeline options should be views of the same underlying object, and I think that line can break this invariant if we follow the or branch. Do you know why we added it?\nFor the purpose of this PR it should be sufficient to pass options into _use_unified_worker() in line 190.", "url": "https://github.com/apache/beam/pull/10919#discussion_r383516953", "createdAt": "2020-02-24T21:12:28Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxODc5MQ==", "bodyText": "This comment repeats the logic; I thought you might want to explain why we don't want to pin the image for UW.\nConsider: \"In case of using UW, harness container should be defined by DF service unless explicitly overridden.\"", "url": "https://github.com/apache/beam/pull/10919#discussion_r383518791", "createdAt": "2020-02-24T21:16:13Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(\n+          'runner_harness_container_image') or _use_unified_worker(\n+              self.debug_options):\n+        # Don't add the default image overwrite if user overwrites or", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzEwNjg3", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363710687", "createdAt": "2020-02-24T21:23:50Z", "commit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMToyMzo1MFrOFtwXRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMTozMDoxMFrOFtwjmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyMjYyOQ==", "bodyText": "I agree. I think I added it because in certain case it was passed in test. I might be wrong though.\nMakes sense. I will update the PR with both these suggestions.", "url": "https://github.com/apache/beam/pull/10919#discussion_r383522629", "createdAt": "2020-02-24T21:23:50Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNjk1Mw=="}, "originalCommit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNTc4NA==", "bodyText": "Updates the comment.", "url": "https://github.com/apache/beam/pull/10919#discussion_r383525784", "createdAt": "2020-02-24T21:30:10Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -186,8 +186,13 @@ def __init__(self, packages, options, environment_version, pipeline_url):\n     if job_type.startswith('FNAPI_'):\n       self.debug_options = self.debug_options or DebugOptions()\n       self.debug_options.experiments = self.debug_options.experiments or []\n-      if not self.debug_options.lookup_experiment(\n-          'runner_harness_container_image'):\n+      if self.debug_options.lookup_experiment(\n+          'runner_harness_container_image') or _use_unified_worker(\n+              self.debug_options):\n+        # Don't add the default image overwrite if user overwrites or", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxODc5MQ=="}, "originalCommit": {"oid": "8cd57753e2c179861562de24cd7ae4f02bfd8aca"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aae13bdd1351b4dc80d91f36a42c996c03e05976", "author": {"user": {"login": "angoenka", "name": "Ankur"}}, "url": "https://github.com/apache/beam/commit/aae13bdd1351b4dc80d91f36a42c996c03e05976", "committedDate": "2020-02-24T21:33:02Z", "message": "Addressing more comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzQ5OTg4", "url": "https://github.com/apache/beam/pull/10919#pullrequestreview-363749988", "createdAt": "2020-02-24T22:33:17Z", "commit": {"oid": "aae13bdd1351b4dc80d91f36a42c996c03e05976"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2826, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}