{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3Njg4Mzgw", "number": 12389, "title": "[BEAM-10587] Support Maps in BigQuery", "bodyText": "Maps are currently not supported when converting a Beam Schema to a BigQuery TableFieldSchema.  This improvement will convert Maps to repeated records with 'key' and 'value' fields.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-28T09:35:28Z", "url": "https://github.com/apache/beam/pull/12389", "merged": true, "mergeCommit": {"oid": "0e0ffac8999db6e086d6cb9d92440726ee2c9886"}, "closed": true, "closedAt": "2020-10-15T16:27:20Z", "author": {"login": "rworley-monster"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5gb8bgFqTQ1NzEyNDA5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSgLz0AFqTUwODU0ODk5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTI0MDk1", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-457124095", "createdAt": "2020-07-29T00:53:28Z", "commit": {"oid": "3bbf390c0d344a170e604ec140211cf09a5d2c06"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDo1MzoyOFrOG4kwQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDo1MzoyOFrOG4kwQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NTYxOA==", "bodyText": "I believe the type you want here is TableRow.", "url": "https://github.com/apache/beam/pull/12389#discussion_r461975618", "createdAt": "2020-07-29T00:53:28Z", "author": {"login": "apilloud"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -442,6 +450,17 @@ private static Object fromBeamField(FieldType fieldType, Object fieldValue) {\n         }\n         return convertedItems;\n \n+      case MAP:\n+        Map<?, ?> pairs = (Map<?, ?>) fieldValue;\n+        convertedItems = Lists.newArrayListWithCapacity(pairs.size());\n+        for (Map.Entry<?, ?> pair : pairs.entrySet()) {\n+          HashMap<String, Object> item = new HashMap<>(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bbf390c0d344a170e604ec140211cf09a5d2c06"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzI4OTQ1", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-467728945", "createdAt": "2020-08-14T16:57:43Z", "commit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjo1Nzo0M1rOHA74Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjo1Nzo0M1rOHA74Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0MzExOA==", "bodyText": "You'll need to convert the types stored in the map as well. Something like fromBeamField(fieldType.getMapKeyType(), pair.getKey())", "url": "https://github.com/apache/beam/pull/12389#discussion_r470743118", "createdAt": "2020-08-14T16:57:43Z", "author": {"login": "apilloud"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -443,6 +467,17 @@ public static TableRow toTableRow(Row row) {\n         }\n         return convertedItems;\n \n+      case MAP:\n+        Map<?, ?> pairs = (Map<?, ?>) fieldValue;\n+        convertedItems = Lists.newArrayListWithCapacity(pairs.size());\n+        for (Map.Entry<?, ?> pair : pairs.entrySet()) {\n+          convertedItems.add(\n+              new TableRow()\n+                  .set(BIGQUERY_MAP_KEY_FIELD_NAME, pair.getKey())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzM3Mzk4", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-467737398", "createdAt": "2020-08-14T17:11:18Z", "commit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoxMToxOFrOHA8S6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoxMToxOFrOHA8S6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc0OTkyOA==", "bodyText": "nit: The name might be a little confusing, this isn't actually converting an Avro Map type. Something like convertAvroRecordToMap might reduce that risk.", "url": "https://github.com/apache/beam/pull/12389#discussion_r470749928", "createdAt": "2020-08-14T17:11:18Z", "author": {"login": "apilloud"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -679,6 +714,20 @@ private static Object convertAvroArray(\n     return ret;\n   }\n \n+  private static Object convertAvroMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzM5ODYw", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-467739860", "createdAt": "2020-08-14T17:15:14Z", "commit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoxNToxNFrOHA8bHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoxNToxNFrOHA8bHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1MjAyOA==", "bodyText": "We prefer to use ImmutableMap when possible, there are examples in this file.", "url": "https://github.com/apache/beam/pull/12389#discussion_r470752028", "createdAt": "2020-08-14T17:15:14Z", "author": {"login": "apilloud"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -679,6 +714,20 @@ private static Object convertAvroArray(\n     return ret;\n   }\n \n+  private static Object convertAvroMap(\n+      FieldType beamField, Object value, BigQueryUtils.ConversionOptions options) {\n+    List<GenericData.Record> records = (List<GenericData.Record>) value;\n+    HashMap<Object, Object> ret = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzQ0OTAx", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-467744901", "createdAt": "2020-08-14T17:23:36Z", "commit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoyMzozNlrOHA8qwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNzoyMzozNlrOHA8qwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1NjAzNA==", "bodyText": "This is something that is going to need more discussion. I have two concerns:\n\nThe ZetaSQL dialect doesn't support map types, so this will break that use case.\nThe user might have a row matching this struct that isn't suppose to be a map.", "url": "https://github.com/apache/beam/pull/12389#discussion_r470756034", "createdAt": "2020-08-14T17:23:36Z", "author": {"login": "apilloud"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -263,6 +267,18 @@ private static FieldType fromTableFieldSchemaType(\n                 \"SqlTimestampWithLocalTzType\", FieldType.STRING, \"\", FieldType.DATETIME) {});\n       case \"STRUCT\":\n       case \"RECORD\":\n+        // check if record represents a map entry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c3f57e2d0567ad11fb53a49c556cf9395b1912f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/c8f56e5668cc6de3a90d5df646f37ed3fff9241d", "committedDate": "2020-08-17T15:27:15Z", "message": "[BEAM-10587] Support Maps in BigQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c09006b2740f96d6549d89d3a5473dbd8b252b2", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/3c09006b2740f96d6549d89d3a5473dbd8b252b2", "committedDate": "2020-08-17T15:27:15Z", "message": "Fix builder formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b620fc57fe2beabbe75319a2affdfd4df59f900", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/9b620fc57fe2beabbe75319a2affdfd4df59f900", "committedDate": "2020-08-17T15:27:15Z", "message": "Read BigQuery maps into Beam Schema and Row"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c95ec65503952100380ccebcf7e43a2a6954ad9", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/4c95ec65503952100380ccebcf7e43a2a6954ad9", "committedDate": "2020-08-17T15:27:15Z", "message": "Convert map entries from Beam fields to TableRow values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8795b2449ca700aaba8badc747938c6ecd28a37", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/e8795b2449ca700aaba8badc747938c6ecd28a37", "committedDate": "2020-09-18T08:36:08Z", "message": "Merge remote-tracking branch 'upstream/master' into schema-to-bigquery-map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f6c927f2c232564146eacf964534672d4671959", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/7f6c927f2c232564146eacf964534672d4671959", "committedDate": "2020-09-18T19:14:54Z", "message": "Add map conversion tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad00c61aeb09a6d747fdcd3da202c07ed996012b", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/ad00c61aeb09a6d747fdcd3da202c07ed996012b", "committedDate": "2020-09-18T20:47:14Z", "message": "Switch to vendored Guava"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83333adcf056dfb01b31cb679b0a49f8285b8c33", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/83333adcf056dfb01b31cb679b0a49f8285b8c33", "committedDate": "2020-10-09T12:23:11Z", "message": "Merge branch 'master' of https://github.com/apache/beam into schema-to-bigquery-map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d3659179f2509cadebf602a4c6c293c23ccf60", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/f4d3659179f2509cadebf602a4c6c293c23ccf60", "committedDate": "2020-10-14T08:33:40Z", "message": "Merge branch 'master' of https://github.com/apache/beam into schema-to-bigquery-map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "612a74b807e071fcf069f08edf7a2f127bed1f19", "author": {"user": {"login": "rworley-monster", "name": null}}, "url": "https://github.com/apache/beam/commit/612a74b807e071fcf069f08edf7a2f127bed1f19", "committedDate": "2020-10-14T11:44:57Z", "message": "Add SchemaConversionOptions, infer maps from BigQuery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTQ4OTk3", "url": "https://github.com/apache/beam/pull/12389#pullrequestreview-508548997", "createdAt": "2020-10-14T16:57:44Z", "commit": {"oid": "612a74b807e071fcf069f08edf7a2f127bed1f19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3966, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}