{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwOTAxMzky", "number": 13345, "title": "[BEAM-4136] Keep strong reference to loggers to avoid potential NPE", "bodyText": "I haven't found evidence that this is the cause but I strongly suspect the cause of the NPE on this line:\n\n  \n    \n      beam/sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java\n    \n    \n         Line 162\n      in\n      43e8b99\n    \n    \n    \n    \n\n        \n          \n           assertNull(LogManager.getLogManager().getLogger(\"ConfiguredLogger\").getLevel()); \n        \n    \n  \n\n\nis that the Logger corresponding to \"ConfiguredLogger\" has been GC'd. The javadoc for Logger.getLogger notes:\n\nNote: The LogManager may only retain a weak reference to the newly created Logger. It is important to understand that a previously created Logger with the given name may be garbage collected at any time if there is no strong reference to the Logger.\n\nOnce the client is closed the only reference to the logger is removed and there's the possibility it gets GC'd before we try to access it for the assertion.\nThis PR also removes warning suppression in BeamFnLoggingClient.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-13T23:34:31Z", "url": "https://github.com/apache/beam/pull/13345", "merged": true, "mergeCommit": {"oid": "890332ea2bd8bd515d859651b2b9b290de8821ae"}, "closed": true, "closedAt": "2020-11-17T16:51:41Z", "author": {"login": "TheNeuralBit"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcPvsTgH2gAyNTIwOTAxMzkyOmRkNjg5OGI4MTc5Y2Y2ZDg0OTIyMDdmMzkwZWY1MDE0OTIyOTU5MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddcVl_AFqTUzMjU2ODA5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dd6898b8179cf6d8492207f390ef50149229590e", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/dd6898b8179cf6d8492207f390ef50149229590e", "committedDate": "2020-11-13T23:27:47Z", "message": "Enable checker on BeamFnLoggingClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700ed4c65eabb9299e46a23e52fc6ce105808c93", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/700ed4c65eabb9299e46a23e52fc6ce105808c93", "committedDate": "2020-11-13T23:27:47Z", "message": "keep a reference to loggers in BeamLoggingClientTest.testLogging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTI2MDEy", "url": "https://github.com/apache/beam/pull/13345#pullrequestreview-530526012", "createdAt": "2020-11-14T01:44:05Z", "commit": {"oid": "700ed4c65eabb9299e46a23e52fc6ce105808c93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMTo0NDowNVrOHzF5qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMTo0NDowNVrOHzF5qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMzNjEwNA==", "bodyText": "Out of time for today, but I just noticed this can happen in other tests as well. For example in this run we see the same flake in testWhenServerHangsUpEarlyThatClientIsAbleCleanup\nLeaving a note here so I remember to fix it later", "url": "https://github.com/apache/beam/pull/13345#discussion_r523336104", "createdAt": "2020-11-14T01:44:05Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/logging/BeamFnLoggingClientTest.java", "diffHunk": "@@ -146,20 +147,25 @@ public void testLogging() throws Exception {\n               apiServiceDescriptor,\n               (Endpoints.ApiServiceDescriptor descriptor) -> channel);\n \n+      // Keep a strong reference to the loggers in this block. Otherwise the call to client.close()\n+      // removes the only reference and the logger may get GC'd (BEAM-4136).\n+      Logger rootLogger = LogManager.getLogManager().getLogger(\"\");\n+      Logger configuredLogger = LogManager.getLogManager().getLogger(\"ConfiguredLogger\");\n+\n       // Ensure that log levels were correctly set.\n-      assertEquals(Level.OFF, LogManager.getLogManager().getLogger(\"\").getLevel());\n-      assertEquals(Level.FINE, LogManager.getLogManager().getLogger(\"ConfiguredLogger\").getLevel());\n+      assertEquals(Level.OFF, rootLogger.getLevel());\n+      assertEquals(Level.FINE, configuredLogger.getLevel());\n \n       // Should be filtered because the default log level override is OFF\n-      LogManager.getLogManager().getLogger(\"\").log(FILTERED_RECORD);\n+      rootLogger.log(FILTERED_RECORD);\n       // Should not be filtered because the default log level override for ConfiguredLogger is DEBUG\n-      LogManager.getLogManager().getLogger(\"ConfiguredLogger\").log(TEST_RECORD);\n-      LogManager.getLogManager().getLogger(\"ConfiguredLogger\").log(TEST_RECORD_WITH_EXCEPTION);\n+      configuredLogger.log(TEST_RECORD);\n+      configuredLogger.log(TEST_RECORD_WITH_EXCEPTION);\n       client.close();\n \n       // Verify that after close, log levels are reset.\n-      assertEquals(Level.INFO, LogManager.getLogManager().getLogger(\"\").getLevel());\n-      assertNull(LogManager.getLogManager().getLogger(\"ConfiguredLogger\").getLevel());\n+      assertEquals(Level.INFO, rootLogger.getLevel());\n+      assertNull(configuredLogger.getLevel());\n \n       assertTrue(clientClosedStream.get());\n       assertTrue(channel.isShutdown());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700ed4c65eabb9299e46a23e52fc6ce105808c93"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eded3452042d6c4f306c00258121cd4ab579e8be", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/eded3452042d6c4f306c00258121cd4ab579e8be", "committedDate": "2020-11-16T17:08:25Z", "message": "Fix other BeamFnLoggingClientTest tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTY4MDkx", "url": "https://github.com/apache/beam/pull/13345#pullrequestreview-532568091", "createdAt": "2020-11-17T16:41:58Z", "commit": {"oid": "eded3452042d6c4f306c00258121cd4ab579e8be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4890, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}