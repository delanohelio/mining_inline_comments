{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NjQzMTI3", "number": 13536, "title": "[BEAM-11360] Updates Dataflow Python multi-language pipelines to use portable job submission by default", "bodyText": "Also cleans up multi-language pipelines related hooks in Python SDK that are not needed when we use portable job submission (hence directly generate Dataflow steps from the Runner API proto).\nThese hooks were mostly were added in PRs #8270 and #11185.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-12-12T01:42:07Z", "url": "https://github.com/apache/beam/pull/13536", "merged": true, "mergeCommit": {"oid": "9f97585160fae644d9b4a7f0dca6558c82c29723"}, "closed": true, "closedAt": "2020-12-15T20:28:58Z", "author": {"login": "chamikaramj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlShtwgBqjQxMDMxMzQ5NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmgWaaAFqTU1MjgzNjA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95409877bcbedb701cfeb01018215f1daea69cb0", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/95409877bcbedb701cfeb01018215f1daea69cb0", "committedDate": "2020-12-12T01:30:04Z", "message": "Updates Dataflow Python multi-language pipelines to use portable job submission by default\n\nAlso cleans up hooks in Python SDK that are not needed when we directly generate Dataflow steps from the Runner API proto."}, "afterCommit": {"oid": "22483f62b40118e73225c19a506e2cba4c6a0c4b", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/22483f62b40118e73225c19a506e2cba4c6a0c4b", "committedDate": "2020-12-12T01:47:23Z", "message": "Updates Dataflow Python multi-language pipelines to use portable job submission by default\n\nAlso cleans up hooks in Python SDK that are not needed when we directly generate Dataflow steps from the Runner API proto."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDM4ODE0", "url": "https://github.com/apache/beam/pull/13536#pullrequestreview-552038814", "createdAt": "2020-12-15T01:35:11Z", "commit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMTozNToxMVrOIF0uKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwMTozNjowOFrOIF0vnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3NzU3Ng==", "bodyText": "Don't we have to do something with external_transform_finder.contains_external_transforms? (Or is this fully redundant with the statement above?)\n(IMHO, this visitor pattern is a bit error-prone, perhaps it'd be worth a static method on ExternalTransformFinder that does the visiting and returns a boolean.)", "url": "https://github.com/apache/beam/pull/13536#discussion_r542977576", "createdAt": "2020-12-15T01:35:11Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -509,19 +514,25 @@ def run(self, test_runner_api='AUTO'):\n             self.runner.__class__.__name__ == 'SwitchingDirectRunner' and\n             not self._options.view_as(StandardOptions).streaming)\n \n+        # Multi-language pipelines that contain external pipeline segments may\n+        # not be able to create a Python pipeline object graph. Hence following\n+        # runner API check should be skipped for such pipelines.\n+        external_transform_finder = ExternalTransformFinder()\n+        self.visit(external_transform_finder)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3Nzk1MQ==", "bodyText": "Just to check, this implies runner v2, right?", "url": "https://github.com/apache/beam/pull/13536#discussion_r542977951", "createdAt": "2020-12-15T01:36:08Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -580,6 +533,11 @@ def run_pipeline(self, pipeline, options):\n       debug_options.add_experiment(\n           'min_cpu_platform=' + worker_options.min_cpu_platform)\n \n+    if pipeline.contains_external_transforms:\n+      # All Dataflow multi-language pipelines use portable job submission by\n+      # default.\n+      debug_options.add_experiment(\"use_portable_job_submission\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf82e7e33528365f92220b491ae96f2461fce08", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/edf82e7e33528365f92220b491ae96f2461fce08", "committedDate": "2020-12-15T02:03:35Z", "message": "Updates Dataflow Python multi-language pipelines to use portable job submission by default\n\nAlso cleans up hooks in Python SDK that are not needed when we directly generate Dataflow steps from the Runner API proto."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abb61473886c6715c870beb5efc5abd6dc5129eb", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/abb61473886c6715c870beb5efc5abd6dc5129eb", "committedDate": "2020-12-15T02:03:36Z", "message": "Fixes yapf."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb404ad586367201b8eca1c4cf44beb3aef01347", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/eb404ad586367201b8eca1c4cf44beb3aef01347", "committedDate": "2020-12-15T04:32:39Z", "message": "Addresses reviewer comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/0b1ab4b31c7e3a5b9ab81c18505ac9de79689257", "committedDate": "2020-12-12T03:58:15Z", "message": "Fixes yapf."}, "afterCommit": {"oid": "eb404ad586367201b8eca1c4cf44beb3aef01347", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/eb404ad586367201b8eca1c4cf44beb3aef01347", "committedDate": "2020-12-15T04:32:39Z", "message": "Addresses reviewer comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODM2MDYw", "url": "https://github.com/apache/beam/pull/13536#pullrequestreview-552836060", "createdAt": "2020-12-15T20:20:13Z", "commit": {"oid": "eb404ad586367201b8eca1c4cf44beb3aef01347"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMDoyMDoxNFrOIGeUew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMDoyMTowNVrOIGeWOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY1OTEzMQ==", "bodyText": "Yes, updated to also include a Runner v2 check.", "url": "https://github.com/apache/beam/pull/13536#discussion_r543659131", "createdAt": "2020-12-15T20:20:14Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -580,6 +533,11 @@ def run_pipeline(self, pipeline, options):\n       debug_options.add_experiment(\n           'min_cpu_platform=' + worker_options.min_cpu_platform)\n \n+    if pipeline.contains_external_transforms:\n+      # All Dataflow multi-language pipelines use portable job submission by\n+      # default.\n+      debug_options.add_experiment(\"use_portable_job_submission\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3Nzk1MQ=="}, "originalCommit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY1OTU3Ng==", "bodyText": "This was redundant. Updated.\nAlso, updated the visitor class by adding a static method like you mentioned.", "url": "https://github.com/apache/beam/pull/13536#discussion_r543659576", "createdAt": "2020-12-15T20:21:05Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -509,19 +514,25 @@ def run(self, test_runner_api='AUTO'):\n             self.runner.__class__.__name__ == 'SwitchingDirectRunner' and\n             not self._options.view_as(StandardOptions).streaming)\n \n+        # Multi-language pipelines that contain external pipeline segments may\n+        # not be able to create a Python pipeline object graph. Hence following\n+        # runner API check should be skipped for such pipelines.\n+        external_transform_finder = ExternalTransformFinder()\n+        self.visit(external_transform_finder)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk3NzU3Ng=="}, "originalCommit": {"oid": "0b1ab4b31c7e3a5b9ab81c18505ac9de79689257"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4407, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}