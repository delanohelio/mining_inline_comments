{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjA5Njk0", "number": 11918, "title": "[BEAM-10188] Add instructions to programmatically publish release to Github", "bodyText": "This fixes BEAM-10188.\nSee discussion in the dev@ list: https://lists.apache.org/thread.html/re367d262333078501c47856e9b8a0fc3fd7db60c2d2ebb181275481a%40%3Cdev.beam.apache.org%3E\nThis assumes that the blog post starts with \"We are happy\", which has been the case in most recent posts. But perhaps you'd like to tweak that?", "createdAt": "2020-06-04T06:05:40Z", "url": "https://github.com/apache/beam/pull/11918", "merged": true, "mergeCommit": {"oid": "4df16aa99a116243586e7f1ee3caaa23c0051e72"}, "closed": true, "closedAt": "2020-06-04T20:21:23Z", "author": {"login": "jphalip"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn3s_dgH2gAyNDI3NjA5Njk0OjU5Yjg3ZDg3YzNjZWRmODlmZGExMWY1Y2YzMWMwNjZjODUyMDY0ZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoD-bCgFqTQyNDc5ODM0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6", "author": {"user": {"login": "jphalip", "name": "Julien Phalip"}}, "url": "https://github.com/apache/beam/commit/59b87d87c3cedf89fda11f5cf31c066c852064d6", "committedDate": "2020-06-04T06:03:03Z", "message": "Add instructions to programmatically publish release to Github\n\nFixes BEAM-10188"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTY2MzM1", "url": "https://github.com/apache/beam/pull/11918#pullrequestreview-424566335", "createdAt": "2020-06-04T15:26:22Z", "commit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNToyNjoyMlrOGfLbAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNTo0NTozOFrOGfMY4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM0NjE3OA==", "bodyText": "This should be apache/beam :)", "url": "https://github.com/apache/beam/pull/11918#discussion_r435346178", "createdAt": "2020-06-04T15:26:22Z", "author": {"login": "TheNeuralBit"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):\n+\n+    json_escape () {\n+        printf '%s' \"$1\" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))'\n+    }\n+    \n+    RELEASE_NOTES=$(sed -n '/^We are happy/,$p' website/www/site/content/en/blog/beam-${RELEASE}.md)\n+    ESCAPED_NOTES=$(json_escape ${RELEASE_NOTES})\n+    \n+    RELEASE_JSON=\"$(cat <<-EOF\n+    {\n+      \"tag_name\": \"${VERSION_TAG}\",\n+      \"name\": \"Beam ${RELEASE} release\",\n+      \"body\": ${ESCAPED_NOTES}\n+    }\n+    EOF\n+    )\"\n+    \n+    curl https://api.github.com/repos/jphalip/beam/releases \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM1MTA3MA==", "bodyText": "There's an earlier step in the release guide that has us create a github token and write it to script.config. It would be nice if this were a script in release/src/main/scripts/ and could read the same token from script.config.", "url": "https://github.com/apache/beam/pull/11918#discussion_r435351070", "createdAt": "2020-06-04T15:33:09Z", "author": {"login": "TheNeuralBit"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2MjAxOA==", "bodyText": "It could be more robust to look for the license comment, I'm not quite sure how this sed command works but if you can make it retrieve everything after a multiline match something like this could work: <!--.*Apache License, Version 2\\.0.*-->.\nI'd be fine leaving it as-is, but if we do there should be some kind of trap for when \"We are happy\" isn't matched so we don't unintentionally publish empty release notes.", "url": "https://github.com/apache/beam/pull/11918#discussion_r435362018", "createdAt": "2020-06-04T15:45:38Z", "author": {"login": "TheNeuralBit"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):\n+\n+    json_escape () {\n+        printf '%s' \"$1\" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))'\n+    }\n+    \n+    RELEASE_NOTES=$(sed -n '/^We are happy/,$p' website/www/site/content/en/blog/beam-${RELEASE}.md)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTgxMzMy", "url": "https://github.com/apache/beam/pull/11918#pullrequestreview-424581332", "createdAt": "2020-06-04T15:38:54Z", "commit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNTozODo1NFrOGfMEUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNTo0OToxNlrOGfMiLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM1Njc1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                curl https://api.github.com/repos/jphalip/beam/releases \\\n          \n          \n            \n                curl https://api.github.com/repos/apache/beam/releases \\", "url": "https://github.com/apache/beam/pull/11918#discussion_r435356754", "createdAt": "2020-06-04T15:38:54Z", "author": {"login": "ibzib"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):\n+\n+    json_escape () {\n+        printf '%s' \"$1\" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))'\n+    }\n+    \n+    RELEASE_NOTES=$(sed -n '/^We are happy/,$p' website/www/site/content/en/blog/beam-${RELEASE}.md)\n+    ESCAPED_NOTES=$(json_escape ${RELEASE_NOTES})\n+    \n+    RELEASE_JSON=\"$(cat <<-EOF\n+    {\n+      \"tag_name\": \"${VERSION_TAG}\",\n+      \"name\": \"Beam ${RELEASE} release\",\n+      \"body\": ${ESCAPED_NOTES}\n+    }\n+    EOF\n+    )\"\n+    \n+    curl https://api.github.com/repos/jphalip/beam/releases \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2MzYzMw==", "bodyText": "Maybe instead we could just remove the webpage header. (We could probably keep the license, since it's in a comment.)", "url": "https://github.com/apache/beam/pull/11918#discussion_r435363633", "createdAt": "2020-06-04T15:48:05Z", "author": {"login": "ibzib"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):\n+\n+    json_escape () {\n+        printf '%s' \"$1\" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))'\n+    }\n+    \n+    RELEASE_NOTES=$(sed -n '/^We are happy/,$p' website/www/site/content/en/blog/beam-${RELEASE}.md)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2NDM5Nw==", "bodyText": "Perhaps we should print the body and ask for user confirmation before uploading.", "url": "https://github.com/apache/beam/pull/11918#discussion_r435364397", "createdAt": "2020-06-04T15:49:16Z", "author": {"login": "ibzib"}, "path": "website/www/site/content/en/contribute/release-guide.md", "diffHunk": "@@ -1134,12 +1134,29 @@ Create and push a new signed tag for the released version by copying the tag for\n     git tag -s \"$VERSION_TAG\" \"$RC_TAG\"\n     git push upstream \"$VERSION_TAG\"\n \n-After the tag is uploaded, publish the release in the Github UI.\n-1. Navigate to `https://github.com/apache/beam/releases/tag/$VERSION_TAG`.\n-1. Click the \"Edit tag\" button.\n-1. Give the release a title, such as `Beam 2.21.0`.\n-1. For the release description, copy the current version's changes from `CHANGES.md`. (You may want to touch up the formatting a bit.)\n-1. Click the \"Publish release\" button.\n+After the tag is uploaded, publish the release by calling the Github API (Make sure that the `GITHUB_TOKEN` variable is set):\n+\n+    json_escape () {\n+        printf '%s' \"$1\" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))'\n+    }\n+    \n+    RELEASE_NOTES=$(sed -n '/^We are happy/,$p' website/www/site/content/en/blog/beam-${RELEASE}.md)\n+    ESCAPED_NOTES=$(json_escape ${RELEASE_NOTES})\n+    \n+    RELEASE_JSON=\"$(cat <<-EOF\n+    {\n+      \"tag_name\": \"${VERSION_TAG}\",\n+      \"name\": \"Beam ${RELEASE} release\",\n+      \"body\": ${ESCAPED_NOTES}\n+    }\n+    EOF\n+    )\"\n+    \n+    curl https://api.github.com/repos/jphalip/beam/releases \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b87d87c3cedf89fda11f5cf31c066c852064d6"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ac884167b95f3384bc01c477bf47da861e43056", "author": {"user": {"login": "jphalip", "name": "Julien Phalip"}}, "url": "https://github.com/apache/beam/commit/4ac884167b95f3384bc01c477bf47da861e43056", "committedDate": "2020-06-04T19:03:10Z", "message": "Move release notes commands to separate script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "352ff8567e1919d37d26000840f611e8886f91d5", "author": {"user": {"login": "jphalip", "name": "Julien Phalip"}}, "url": "https://github.com/apache/beam/commit/352ff8567e1919d37d26000840f611e8886f91d5", "committedDate": "2020-06-04T19:15:47Z", "message": "Add confirmation message to Github release notes script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "600c9bbb4e2a3a18450ab4b21bf66fdfb1796987", "author": {"user": {"login": "jphalip", "name": "Julien Phalip"}}, "url": "https://github.com/apache/beam/commit/600c9bbb4e2a3a18450ab4b21bf66fdfb1796987", "committedDate": "2020-06-04T19:18:46Z", "message": "Load env vars in Github release notes script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4599418584775f6df2f44d88aa3ed856a2e7762b", "author": {"user": {"login": "jphalip", "name": "Julien Phalip"}}, "url": "https://github.com/apache/beam/commit/4599418584775f6df2f44d88aa3ed856a2e7762b", "committedDate": "2020-06-04T19:21:28Z", "message": "Small tweak to github release notes script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzY3MjUz", "url": "https://github.com/apache/beam/pull/11918#pullrequestreview-424767253", "createdAt": "2020-06-04T19:34:50Z", "commit": {"oid": "4599418584775f6df2f44d88aa3ed856a2e7762b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Nzk4MzQ0", "url": "https://github.com/apache/beam/pull/11918#pullrequestreview-424798344", "createdAt": "2020-06-04T20:20:57Z", "commit": {"oid": "4599418584775f6df2f44d88aa3ed856a2e7762b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3994, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}