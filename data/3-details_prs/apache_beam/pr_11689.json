{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDg5Mjk5", "number": 11689, "title": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-05-13T03:19:32Z", "url": "https://github.com/apache/beam/pull/11689", "merged": true, "mergeCommit": {"oid": "fd8d0c61917149844a80f92adf91e5b944b685ec"}, "closed": true, "closedAt": "2020-05-13T19:44:14Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgyZvvABqjMzMzA0Mjg0Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg8d0cAH2gAyNDE3MDg5Mjk5OjBkYjM0MWZkMjI0ODU2MDkxODhjZGM2NDA4NWZiZjE0MWQ2ZjY0Yzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1703add4f4f6b1cf65b445c2d50593fb7e5e04f", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/f1703add4f4f6b1cf65b445c2d50593fb7e5e04f", "committedDate": "2020-05-13T05:50:50Z", "message": "fixup! Fix issue where we weren't resetting the read index/stopping position in BeamFnDataReadRunner\n\nI created a bug to handle an unlikely race condition where the read index being reported could be from the last bundle."}, "afterCommit": {"oid": "d2f001ed5582c5fe87886799f7c1b00abf58a79d", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/d2f001ed5582c5fe87886799f7c1b00abf58a79d", "committedDate": "2020-05-13T05:54:51Z", "message": "fixup! Fix issue where we weren't resetting the read index/stopping position in BeamFnDataReadRunner\n\nI created a bug to handle an unlikely race condition where the read index being reported could be from the last bundle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/760a4cdf271341152103e6230418f0426be01d3f", "committedDate": "2020-05-13T13:33:01Z", "message": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2f001ed5582c5fe87886799f7c1b00abf58a79d", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/d2f001ed5582c5fe87886799f7c1b00abf58a79d", "committedDate": "2020-05-13T05:54:51Z", "message": "fixup! Fix issue where we weren't resetting the read index/stopping position in BeamFnDataReadRunner\n\nI created a bug to handle an unlikely race condition where the read index being reported could be from the last bundle."}, "afterCommit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/760a4cdf271341152103e6230418f0426be01d3f", "committedDate": "2020-05-13T13:33:01Z", "message": "[BEAM-9945] Ensure that the read index represents the number of fully processed elements including at the end of the channel or after splitting."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTM0NjQ4", "url": "https://github.com/apache/beam/pull/11689#pullrequestreview-411134648", "createdAt": "2020-05-13T17:14:30Z", "commit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoxNDozMFrOGU7lBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoxNDozMFrOGU7lBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDgzNg==", "bodyText": "Should we also check start == true here like trySplit?", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600836", "createdAt": "2020-05-13T17:14:30Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -165,6 +166,8 @@\n \n     addProgressRequestCallback.accept(\n         () -> {\n+          // TODO(BEAM-9979): Fix race condition where reused BeamFnDataReadRunner reports", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTM1MDA0", "url": "https://github.com/apache/beam/pull/11689#pullrequestreview-411135004", "createdAt": "2020-05-13T17:14:58Z", "commit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTMyNTYz", "url": "https://github.com/apache/beam/pull/11689#pullrequestreview-411132563", "createdAt": "2020-05-13T17:11:47Z", "commit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoxMTo0N1rOGU7epw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoxNDo0MVrOGU7laQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5OTIwNw==", "bodyText": "It doesn't seem like the index should be incremented here.", "url": "https://github.com/apache/beam/pull/11689#discussion_r424599207", "createdAt": "2020-05-13T17:11:47Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -317,6 +321,7 @@ def is_valid_split_point(index):\n   def finish(self):\n     # type: () -> None\n     with self.splitting_lock:\n+      self.index += 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDE2OQ==", "bodyText": "Operators have a reset method that could be used here.", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600169", "createdAt": "2020-05-13T17:13:18Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -219,6 +219,10 @@ def process_encoded(self, encoded_windowed_values):\n \n   def monitoring_infos(self, transform_id, tag_to_pcollection_id):\n     # type: (str, Dict[str, str]) -> Dict[FrozenSet, metrics_pb2.MonitoringInfo]\n+\n+    # TODO(BEAM-9979): Fix race condition where reused DataInputOperation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMDkzNw==", "bodyText": "I don't think this should be incremented here.", "url": "https://github.com/apache/beam/pull/11689#discussion_r424600937", "createdAt": "2020-05-13T17:14:41Z", "author": {"login": "robertwb"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -293,5 +305,9 @@ public void blockTillReadFinishes() throws Exception {\n         processBundleInstructionIdSupplier.get(),\n         pTransformId);\n     readFuture.awaitCompletion();\n+    synchronized (splittingLock) {\n+      started = false;\n+      index += 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760a4cdf271341152103e6230418f0426be01d3f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a30219e648315b4100c28229c8bbcf311de233", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/a3a30219e648315b4100c28229c8bbcf311de233", "committedDate": "2020-05-13T17:17:43Z", "message": "fixup! Fix checkstyle issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTQ2NjQ4", "url": "https://github.com/apache/beam/pull/11689#pullrequestreview-411146648", "createdAt": "2020-05-13T17:30:10Z", "commit": {"oid": "a3a30219e648315b4100c28229c8bbcf311de233"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0db341fd22485609188cdc64085fbf141d6f64c8", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/0db341fd22485609188cdc64085fbf141d6f64c8", "committedDate": "2020-05-13T17:38:32Z", "message": "fixup! use reset method in bundle_processor.py to avoid race condition on metrics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4977, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}