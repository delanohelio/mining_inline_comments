{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MTc1ODQz", "number": 12762, "title": "[BEAM-10948] Ensuring that BigQuery jobs are tagged with the Dataflow step that launches them", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-02T21:20:47Z", "url": "https://github.com/apache/beam/pull/12762", "merged": true, "mergeCommit": {"oid": "2ff8337aa943623dfaabaf8b42876b4d9ee1c963"}, "closed": true, "closedAt": "2020-09-22T17:59:37Z", "author": {"login": "pabloem"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFCwmWgH2gAyNDc4MTc1ODQzOmFmYjkyM2RlZDg2ZTRlM2IxZDNjYzhlN2RhYjlkOGEzZmNkOTQzYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLNHcfAH2gAyNDc4MTc1ODQzOmE1ZDgwMjAxN2VhOGE5OTM1N2NkZjIwYTcyMzgwYTNjMmI0NTNhMjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afb923ded86e4e3b1d3cc8e7dab9d8a3fcd943c7", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/afb923ded86e4e3b1d3cc8e7dab9d8a3fcd943c7", "committedDate": "2020-09-02T21:19:45Z", "message": "Adding step names to BQ jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "887382ac72a7a77538fcbf6f777302f2b910946e", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/887382ac72a7a77538fcbf6f777302f2b910946e", "committedDate": "2020-09-02T22:22:18Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/b1b1ae73d10d050b5b0fb572ceec2b1ee411627e", "committedDate": "2020-09-03T20:10:33Z", "message": "Fixin step naming. Cannot add step name to BQ job name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTgzNTMx", "url": "https://github.com/apache/beam/pull/12762#pullrequestreview-482183531", "createdAt": "2020-09-03T20:34:13Z", "commit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDozNDoxM1rOHM2ksA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDo0MTo0OVrOHM2yPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzOTA4OA==", "bodyText": "This is likely to cause the BQ job to fail. The step_name would need to be sanitized. For the cloud label format\nhttps://cloud.google.com/resource-manager/docs/creating-managing-labels#requirements\n\nKeys have a minimum length of 1 character and a maximum length of 63 characters, and cannot be empty. Values can be empty, and have a maximum length of 63 characters.\nKeys and values can contain only lowercase letters, numeric characters, underscores, and dashes. All characters must use UTF-8 encoding, and international characters are allowed.", "url": "https://github.com/apache/beam/pull/12762#discussion_r483239088", "createdAt": "2020-09-03T20:34:13Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -64,6 +64,8 @@ def create_bigquery_io_metadata():\n     # As we do not want a bad label to fail the BQ job.\n     if _is_valid_cloud_label_value(dataflow_job_id):\n       kwargs['beam_job_id'] = dataflow_job_id\n+  if step_name:\n+    kwargs['step_name'] = step_name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDA2OQ==", "bodyText": "Do we know the format of the step_name. Is this just what the SDK harness is referring to the step as?\nIIRC these did not reflect something meaningful, in the original graph to the user. So we probably don't want to show them\nI know the pcollections in python at least were very opaque \"pcollection1\", \"pcollection2\", etc.\nNormally we rely on the DF RunnerHarness to translate those before sending to the UI (ex: on metrics)", "url": "https://github.com/apache/beam/pull/12762#discussion_r483240069", "createdAt": "2020-09-03T20:36:16Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_file_loads.py", "diffHunk": "@@ -826,7 +836,8 @@ def _load_data(\n             TriggerCopyJobs(\n                 create_disposition=self.create_disposition,\n                 write_disposition=self.write_disposition,\n-                test_client=self.test_client),\n+                test_client=self.test_client,\n+                step_name=step_name),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MDM2OQ==", "bodyText": "Would you mind sharing the motivation with me on this. Its not entirely clear why you are making this change to me.\nCan you make equivalent changes in the Java implementation as well? For a consistent experience", "url": "https://github.com/apache/beam/pull/12762#discussion_r483240369", "createdAt": "2020-09-03T20:36:58Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -625,6 +625,7 @@ def to_type_hint(self):\n \n \n class _CustomBigQuerySource(BoundedSource):\n+\n   def __init__(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI0MjU1OQ==", "bodyText": "I looked at the file, and it seems like self.label not referenced anywhere else in the class, and I don't see a call to super ctor which would set it.\nIs this using a werid pattern, where something external is taking the object and attaching parameters to it?\nIs it possible to fix up that style, so there is a clear method or something we can see where it gets added extenrally?\nOr to t lease define a default, empty value with a comment saying how it gets set", "url": "https://github.com/apache/beam/pull/12762#discussion_r483242559", "createdAt": "2020-09-03T20:41:49Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -1875,14 +1895,22 @@ def process(self, unused_element, signal):\n     temp_location = pcoll.pipeline.options.view_as(\n         GoogleCloudOptions).temp_location\n     gcs_location = self._get_destination_uri(temp_location)\n+    job_name = pcoll.pipeline.options.view_as(GoogleCloudOptions).job_name\n \n+    try:\n+      step_name = self.label", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b1ae73d10d050b5b0fb572ceec2b1ee411627e"}, "originalPosition": 153}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc7b18aab1ddea17175151f6d943eb52c0645c2", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/fdc7b18aab1ddea17175151f6d943eb52c0645c2", "committedDate": "2020-09-03T21:37:50Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDMwMTI2", "url": "https://github.com/apache/beam/pull/12762#pullrequestreview-484430126", "createdAt": "2020-09-08T19:25:39Z", "commit": {"oid": "fdc7b18aab1ddea17175151f6d943eb52c0645c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDA5MjE3", "url": "https://github.com/apache/beam/pull/12762#pullrequestreview-490009217", "createdAt": "2020-09-16T20:48:44Z", "commit": {"oid": "fdc7b18aab1ddea17175151f6d943eb52c0645c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODo0NVrOHTDrmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODo0NVrOHTDrmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NTMwNA==", "bodyText": "Ah, just remembered that I checked in helpers in both python and java a python/apache_beam/io/gcp/bigquery_io_metadata.py\nYou may want to move the santize function to those files.\n_is_valid_cloud_label_value", "url": "https://github.com/apache/beam/pull/12762#discussion_r489745304", "createdAt": "2020-09-16T20:48:45Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_io_metadata.py", "diffHunk": "@@ -28,6 +28,11 @@\n _VALID_CLOUD_LABEL_PATTERN = re.compile(r'^[a-z0-9\\_\\-]{1,63}$')\n \n \n+def _sanitize_value(value):\n+  \"\"\"Sanitizes a value into a valid BigQuery label value.\"\"\"\n+  return re.sub('[^\\w-]+', '', value.lower().replace('/', '-'))[0:63]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc7b18aab1ddea17175151f6d943eb52c0645c2"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5971ec692d3a5a522474147dd85339410aaa65c2", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/5971ec692d3a5a522474147dd85339410aaa65c2", "committedDate": "2020-09-21T20:48:53Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4904c0b6c6e491af2db063c43324b60983590d6", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/d4904c0b6c6e491af2db063c43324b60983590d6", "committedDate": "2020-09-21T22:21:58Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d802017ea8a99357cdf20a72380a3c2b453a22", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/a5d802017ea8a99357cdf20a72380a3c2b453a22", "committedDate": "2020-09-22T00:47:18Z", "message": "fixup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4646, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}