{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMTExMDI1", "number": 13493, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMDowNzo0MlrOFBiqxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoxOTo0MVrOFCCU9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MTYwOTAzOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMDowNzo0MlrOIARa9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDozNzo1N1rOIB8xRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg==", "bodyText": "This seems to be casuing lint failure. I was following the WindowedValue example:\n\n  \n    \n      beam/sdks/python/apache_beam/typehints/typehints.py\n    \n    \n         Line 1050\n      in\n      30f9a60\n    \n    \n    \n    \n\n        \n          \n           class WindowedTypeConstraint(with_metaclass(GetitemConstructor, TypeConstraint)", "url": "https://github.com/apache/beam/pull/13493#discussion_r537156342", "createdAt": "2020-12-07T00:07:42Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzYzNA==", "bodyText": "What kind of lint errors are you getting?", "url": "https://github.com/apache/beam/pull/13493#discussion_r537903634", "createdAt": "2020-12-07T23:11:58Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg=="}, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMjMxMw==", "bodyText": "I don't know what with_metaclass does. You could add the __getitem__ implementation directly if it's causing issues.", "url": "https://github.com/apache/beam/pull/13493#discussion_r537912313", "createdAt": "2020-12-07T23:25:28Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg=="}, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTQwMw==", "bodyText": "GetItemConstructor basically defines __getitem__. I tried getting rid of it and defining __getitem__ directly but I got the error\nTypeError: 'type' object is not subscriptable", "url": "https://github.com/apache/beam/pull/13493#discussion_r538631403", "createdAt": "2020-12-08T17:25:41Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg=="}, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2MjEwMA==", "bodyText": "This works:\n  def __class_getitem__(cls, py_type):\n    return cls(py_type)\nThe alternative is to use a wrapper object instance such as IterableHint that has __getitem__, and then define Iterable = IterableHint().", "url": "https://github.com/apache/beam/pull/13493#discussion_r538762100", "createdAt": "2020-12-08T19:53:49Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg=="}, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkxNTE0MQ==", "bodyText": "Thanks for the tip!!! Updated the code to define __class_getitem__ directly in ShardedKeyTypeConstraint.", "url": "https://github.com/apache/beam/pull/13493#discussion_r538915141", "createdAt": "2020-12-09T00:37:57Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/typehints/sharded_key_type.py", "diffHunk": "@@ -25,8 +25,12 @@\n from apache_beam.typehints.typehints import match_type_variables\n from apache_beam.utils.sharded_key import ShardedKey\n \n+from future.utils import with_metaclass\n \n-class ShardedKeyTypeConstraint(typehints.TypeConstraint):\n+\n+class ShardedKeyTypeConstraint(with_metaclass(typehints.GetitemConstructor,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NjM0Mg=="}, "originalCommit": {"oid": "eefd9b7cdcf84b4e27a9c50e4980c07cf54ae3b0"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NjcwNzI4OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/util.py", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo1MzozMlrOIA-fkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMjozNToxMVrOIB_eng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NDgwMg==", "bodyText": "Please use:\nfrom apache_beam.typehints import ShardedKeyType\n\nAnd use Tuple and Iterable types from the typing module (they will get converted to the ones in typehints). In general use either typing.Tuple or apache_beam.typehints.Tuple. The constraint classes are internal to the typehints modules.\nFor the ShardedKeyType import to work, you can add the corresponding import statement to apache_beam/typehints/__init__.py. This also avoid the cyclic import you mentioned that happened with my suggestion to put ShardedKeyType in typehints.py.", "url": "https://github.com/apache/beam/pull/13493#discussion_r537894802", "createdAt": "2020-12-07T22:53:32Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -72,6 +72,9 @@\n from apache_beam.transforms.window import NonMergingWindowFn\n from apache_beam.transforms.window import TimestampCombiner\n from apache_beam.transforms.window import TimestampedValue\n+from apache_beam.typehints.sharded_key_type import ShardedKeyType\n+from apache_beam.typehints.typehints import IterableTypeConstraint\n+from apache_beam.typehints.typehints import TupleConstraint", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkxNDc5Nw==", "bodyText": "Updated the code to use Tuple and Iterable directly. Couldn't add ShardedKeyType to apache_beam/typehints/__init__.py due to circular imports in coders\nImportError while loading conftest '/usr/local/google/home/sychen/Documents/GitHub/working_dir/beam/sdks/python/conftest.py'.\nconftest.py:23: in <module>\n    from apache_beam.options import pipeline_options\napache_beam/__init__.py:95: in <module>\n    from apache_beam import coders\napache_beam/coders/__init__.py:19: in <module>\n    from apache_beam.coders.coders import *\napache_beam/coders/coders.py:52: in <module>\n    from apache_beam.typehints import typehints\napache_beam/typehints/__init__.py:25: in <module>\n    from apache_beam.typehints.sharded_key_type import ShardedKeyType\napache_beam/typehints/sharded_key_type.py:22: in <module>\n    from apache_beam.coders import typecoders\napache_beam/coders/typecoders.py:81: in <module>\n    from apache_beam.coders.coders import CoderElementType\nE   ImportError: cannot import name 'CoderElementType' from partially initialized module 'apache_beam.coders.coders' (most likely due to a circular import) (/usr/local/google/home/sychen/Documents/GitHub/working_dir/beam/sdks/python/apache_beam/coders/coders.py)", "url": "https://github.com/apache/beam/pull/13493#discussion_r538914797", "createdAt": "2020-12-09T00:36:56Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -72,6 +72,9 @@\n from apache_beam.transforms.window import NonMergingWindowFn\n from apache_beam.transforms.window import TimestampCombiner\n from apache_beam.transforms.window import TimestampedValue\n+from apache_beam.typehints.sharded_key_type import ShardedKeyType\n+from apache_beam.typehints.typehints import IterableTypeConstraint\n+from apache_beam.typehints.typehints import TupleConstraint", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NDgwMg=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk1OTUxOA==", "bodyText": "Okay, this is fine then :)", "url": "https://github.com/apache/beam/pull/13493#discussion_r538959518", "createdAt": "2020-12-09T02:35:11Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -72,6 +72,9 @@\n from apache_beam.transforms.window import NonMergingWindowFn\n from apache_beam.transforms.window import TimestampCombiner\n from apache_beam.transforms.window import TimestampedValue\n+from apache_beam.typehints.sharded_key_type import ShardedKeyType\n+from apache_beam.typehints.typehints import IterableTypeConstraint\n+from apache_beam.typehints.typehints import TupleConstraint", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NDgwMg=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NjczMzczOnYy", "diffSide": "LEFT", "path": "sdks/python/apache_beam/transforms/util.py", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMToyNFrOIA-ueg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTozMToxN1rOIClyHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA==", "bodyText": "Any reason why this isn't:\n  @typehints.with_output_types(Tuple[ShardedKeyType[K], Iterable[V]])\n?", "url": "https://github.com/apache/beam/pull/13493#discussion_r537898618", "createdAt": "2020-12-07T23:01:24Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTIzNg==", "bodyText": "Because I got an error saying:\narg = ShardedKey[int], msg = 'Tuple[t0, t1, ...]: each t must be a type.', is_argument = True\n\n    def _type_check(arg, msg, is_argument=True):\n        \"\"\"Check that the argument is a type, and return it (internal helper).\n    \n        As a special case, accept None and return type(None) instead. Also wrap strings\n        into ForwardRef instances. Consider several corner cases, for example plain\n        special forms like Union are not valid, while Union[int, str] is OK, etc.\n        The msg argument is a human-readable error message, e.g::\n    \n            \"Union[arg, ...]: arg should be a type.\"\n    \n        We append the repr() of the actual value (truncated to 100 chars).\n        \"\"\"\n        invalid_generic_forms = (Generic, Protocol)\n        if is_argument:\n            invalid_generic_forms = invalid_generic_forms + (ClassVar, Final)\n    \n        if arg is None:\n            return type(None)\n        if isinstance(arg, str):\n            return ForwardRef(arg)\n        if (isinstance(arg, _GenericAlias) and\n                arg.__origin__ in invalid_generic_forms):\n            raise TypeError(f\"{arg} is not valid as type argument\")\n        if (isinstance(arg, _SpecialForm) and arg not in (Any, NoReturn) or\n                arg in (Generic, Protocol)):\n            raise TypeError(f\"Plain {arg} is not valid as type argument\")\n        if isinstance(arg, (type, TypeVar, ForwardRef)):\n            return arg\n        if not callable(arg):\n>           raise TypeError(f\"{msg} Got {arg!r:.100}.\")\nE           TypeError: Tuple[t0, t1, ...]: each t must be a type. Got ShardedKey[int].\n\n../../../../../../.pyenv/versions/3.8.5/lib/python3.8/typing.py:149: TypeError\n\n\nAny insights?", "url": "https://github.com/apache/beam/pull/13493#discussion_r538631236", "createdAt": "2020-12-08T17:25:30Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3NTQ3NQ==", "bodyText": "Right, Python's typing types don't recognize Beam's own internal types.\n\n\nProbably not a solution:\nShardedKeyTypeConstraint could inherit from typing.Generic[typing.TypeVar('K')], but that produces 2 more problems. Neither are hard but add complexity, plus none of the other Beam typehints do this.\n\nAccessing the type argument that Generic stores on different versions of Python. (__args__ or __parameters__ I believe)\nPickling. Python's typing types have had issues with pickling.\n\n\n\nProbably the right solution but breaks consistency with the other decorators:\n@typehints.with_output_types(typehints.Tuple[ShardedKeyType[K], typehints.Iterable[V]])\nBeam already converts to internal type so this is a cosmetic change.", "url": "https://github.com/apache/beam/pull/13493#discussion_r538775475", "createdAt": "2020-12-08T20:15:53Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkxNDc1Mg==", "bodyText": "Ah that explains. To avoid the decorator inconsistency I still keep the infer_output_type method but instead use typehint.Tuple as opposed to TupleConstraint directly. Is that acceptable?", "url": "https://github.com/apache/beam/pull/13493#discussion_r538914752", "createdAt": "2020-12-09T00:36:50Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk1ODc2Mg==", "bodyText": "I don't believe you need infer_output_type if you have the with_output_types decorator.\nAlso, I tested this a bit myself and it ended up looking like this:\n  @typehints.with_input_types(typehints.Tuple[K_i, V_i])\n  @typehints.with_output_types(typehints.Tuple[ShardedKeyType[K_i], typehints.Iterable[V_i]])\n  class WithShardedKey(PTransform):\nwhere:\nK_i = typehints.TypeVariable('K_i')\nV_i = typehints.TypeVariable('V_i')\nedit: not sure if with_input_types needs to change but it looks consistent", "url": "https://github.com/apache/beam/pull/13493#discussion_r538958762", "createdAt": "2020-12-09T02:33:01Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzODExMQ==", "bodyText": "Sorry I misunderstood and thought having something like typehints.Tuple in the decoration was not preferred. Pushed a commit to use decoration instead.", "url": "https://github.com/apache/beam/pull/13493#discussion_r539038111", "createdAt": "2020-12-09T06:16:42Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4NzEwMw==", "bodyText": "It's not preferred, but I'd rather have the output type documented there than not at all.", "url": "https://github.com/apache/beam/pull/13493#discussion_r539587103", "createdAt": "2020-12-09T19:31:17Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5ODYxOA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NjczNzkxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/util.py", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMjozM1rOIA-wsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTowMzoyOFrOIBxd4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTE4Nw==", "bodyText": "If you keep this line, I believe the value_type should be Iterable[value_type].", "url": "https://github.com/apache/beam/pull/13493#discussion_r537899187", "createdAt": "2020-12-07T23:02:33Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -815,18 +817,25 @@ def __init__(self, batch_size, max_buffering_duration_secs=None):\n     _shard_id_prefix = uuid.uuid4().bytes\n \n     def expand(self, pcoll):\n+      key_type, value_type = pcoll.element_type.tuple_types\n       sharded_pcoll = pcoll | Map(\n           lambda key_value: (\n               ShardedKey(\n                   key_value[0],\n                   # Use [uuid, thread id] as the shard id.\n                   GroupIntoBatches.WithShardedKey._shard_id_prefix + bytes(\n                       threading.get_ident().to_bytes(8, 'big'))),\n-              key_value[1]))\n+              key_value[1])).with_output_types(\n+                  TupleConstraint([ShardedKeyType[key_type], value_type]))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTE4Nw==", "bodyText": "Why? The MapFn converts the input K, V to ShardedKey, V. The output of the composite transform is ShardedKey, Iterable[V].", "url": "https://github.com/apache/beam/pull/13493#discussion_r538631187", "createdAt": "2020-12-08T17:25:28Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -815,18 +817,25 @@ def __init__(self, batch_size, max_buffering_duration_secs=None):\n     _shard_id_prefix = uuid.uuid4().bytes\n \n     def expand(self, pcoll):\n+      key_type, value_type = pcoll.element_type.tuple_types\n       sharded_pcoll = pcoll | Map(\n           lambda key_value: (\n               ShardedKey(\n                   key_value[0],\n                   # Use [uuid, thread id] as the shard id.\n                   GroupIntoBatches.WithShardedKey._shard_id_prefix + bytes(\n                       threading.get_ident().to_bytes(8, 'big'))),\n-              key_value[1]))\n+              key_value[1])).with_output_types(\n+                  TupleConstraint([ShardedKeyType[key_type], value_type]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTE4Nw=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcyOTk1Mw==", "bodyText": "Sorry, my mistake I didn't read this carefully enough.", "url": "https://github.com/apache/beam/pull/13493#discussion_r538729953", "createdAt": "2020-12-08T19:03:28Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -815,18 +817,25 @@ def __init__(self, batch_size, max_buffering_duration_secs=None):\n     _shard_id_prefix = uuid.uuid4().bytes\n \n     def expand(self, pcoll):\n+      key_type, value_type = pcoll.element_type.tuple_types\n       sharded_pcoll = pcoll | Map(\n           lambda key_value: (\n               ShardedKey(\n                   key_value[0],\n                   # Use [uuid, thread id] as the shard id.\n                   GroupIntoBatches.WithShardedKey._shard_id_prefix + bytes(\n                       threading.get_ident().to_bytes(8, 'big'))),\n-              key_value[1]))\n+              key_value[1])).with_output_types(\n+                  TupleConstraint([ShardedKeyType[key_type], value_type]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTE4Nw=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Njc2NTc5OnYy", "diffSide": "LEFT", "path": "sdks/python/apache_beam/transforms/util.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoxMDo1OVrOIA_AUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoyNTozNlrOIBrcpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzE4NA==", "bodyText": "Just curious, does @typehints.with_output_types not work here?", "url": "https://github.com/apache/beam/pull/13493#discussion_r537903184", "createdAt": "2020-12-07T23:10:59Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTMzMg==", "bodyText": "Udi also had a similar question. I got TypeError when trying to use Tuple[ShardedKey,...]. See my reply below.", "url": "https://github.com/apache/beam/pull/13493#discussion_r538631332", "createdAt": "2020-12-08T17:25:36Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -785,7 +788,6 @@ def expand(self, pcoll):\n \n   @experimental()\n   @typehints.with_input_types(Tuple[K, V])\n-  @typehints.with_output_types(Tuple[K, Iterable[V]])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzE4NA=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Njc5NjA2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/util.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoxOTo0MVrOIA_Qxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoyNToyNVrOIBrbyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwNzM5OQ==", "bodyText": "If you keep the with_output_types decorator, please remove this.", "url": "https://github.com/apache/beam/pull/13493#discussion_r537907399", "createdAt": "2020-12-07T23:19:41Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -815,18 +817,25 @@ def __init__(self, batch_size, max_buffering_duration_secs=None):\n     _shard_id_prefix = uuid.uuid4().bytes\n \n     def expand(self, pcoll):\n+      key_type, value_type = pcoll.element_type.tuple_types\n       sharded_pcoll = pcoll | Map(\n           lambda key_value: (\n               ShardedKey(\n                   key_value[0],\n                   # Use [uuid, thread id] as the shard id.\n                   GroupIntoBatches.WithShardedKey._shard_id_prefix + bytes(\n                       threading.get_ident().to_bytes(8, 'big'))),\n-              key_value[1]))\n+              key_value[1])).with_output_types(\n+                  TupleConstraint([ShardedKeyType[key_type], value_type]))\n       return (\n           sharded_pcoll\n           | GroupIntoBatches(self.batch_size, self.max_buffering_duration_secs))\n \n+    def infer_output_type(self, input_type):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTExNQ==", "bodyText": "Couldn't use the decorator due to the error I mentioned in another comment.", "url": "https://github.com/apache/beam/pull/13493#discussion_r538631115", "createdAt": "2020-12-08T17:25:25Z", "author": {"login": "nehsyc"}, "path": "sdks/python/apache_beam/transforms/util.py", "diffHunk": "@@ -815,18 +817,25 @@ def __init__(self, batch_size, max_buffering_duration_secs=None):\n     _shard_id_prefix = uuid.uuid4().bytes\n \n     def expand(self, pcoll):\n+      key_type, value_type = pcoll.element_type.tuple_types\n       sharded_pcoll = pcoll | Map(\n           lambda key_value: (\n               ShardedKey(\n                   key_value[0],\n                   # Use [uuid, thread id] as the shard id.\n                   GroupIntoBatches.WithShardedKey._shard_id_prefix + bytes(\n                       threading.get_ident().to_bytes(8, 'big'))),\n-              key_value[1]))\n+              key_value[1])).with_output_types(\n+                  TupleConstraint([ShardedKeyType[key_type], value_type]))\n       return (\n           sharded_pcoll\n           | GroupIntoBatches(self.batch_size, self.max_buffering_duration_secs))\n \n+    def infer_output_type(self, input_type):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwNzM5OQ=="}, "originalCommit": {"oid": "06e43c039b4f703fcb3da79922e4d2191b2b6219"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2517, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}