{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDY5NTk2", "number": 12172, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMToyMjoyNFrOEL5Ldw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1ODo1MVrOEOy7vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwOTA2NjE1OnYy", "diffSide": "RIGHT", "path": ".github/workflows/build_wheels.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMToyMjoyNFrOGtsAKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1OTo0OFrOGvIKIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2MDA0MQ==", "bodyText": "cp27 is missing for windows-latests above. Why are we installing a Python 2.7 compiler?", "url": "https://github.com/apache/beam/pull/12172#discussion_r450560041", "createdAt": "2020-07-07T01:22:24Z", "author": {"login": "aaltay"}, "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -119,19 +123,24 @@ jobs:\n       uses: actions/setup-python@v2\n       with:\n         python-version: 3.7\n+    - name: Install Visual C++ for Python 2.7 on Windows", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a17e6c0d4ad2cf73c81ba24dd67b28970be1d52"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2OTkyMg==", "bodyText": "Good point, that should be a letftover. I've just removed it.", "url": "https://github.com/apache/beam/pull/12172#discussion_r452069922", "createdAt": "2020-07-09T08:59:48Z", "author": {"login": "damgad"}, "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -119,19 +123,24 @@ jobs:\n       uses: actions/setup-python@v2\n       with:\n         python-version: 3.7\n+    - name: Install Visual C++ for Python 2.7 on Windows", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2MDA0MQ=="}, "originalCommit": {"oid": "8a17e6c0d4ad2cf73c81ba24dd67b28970be1d52"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDkwNDE3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDoxNzozNVrOGwEf5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwOTo0NjozNlrOGx2oIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1ODUzMw==", "bodyText": "These error codes are never checked by the callers. That would seem to give incorrect results (especially if timespec is initialized with random data (e.g. on the stack) each time.\nIs there a simpler/more robust API we could call instead in this case, even if it is lower precision?", "url": "https://github.com/apache/beam/pull/12172#discussion_r453058533", "createdAt": "2020-07-10T20:17:35Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef BEAM_CROSSPLATFORM_TIME_H\n+#define BEAM_CROSSPLATFORM_TIME_H\n+\n+#include <time.h>\n+\n+#ifdef _WIN32\n+#include <windows.h>\n+\n+/**\n+ * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n+ * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ */\n+int clock_gettime(int clk_id, struct timespec *tv) {\n+    static LARGE_INTEGER counterFrequency = {0};\n+    LARGE_INTEGER counterValue;\n+\n+    if (0 == counterFrequency.QuadPart) {\n+        if (0 == QueryPerformanceFrequency(&counterFrequency)) {\n+            /* System doesn't support performance counters. It's guaranteed to not happen\n+            on systems that run Windows XP or later */\n+            return -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgwNTE3OQ==", "bodyText": "Nice catch! :)\nThe performance counter is the only API that is designed to measure execution time that I know. There is GetSystemTime and family with lower precision, which will act more like CLOCK_REALTIME. I see four solutions there:\n\nLeave it as it is. I'm not sure if that's a real-life issue in our case, as the function is guaranteed to succeed on WinXP+ (?)\nSwitch to the less accurate GetSystemTime\nUse GetSystemTime as a failover procedure if PerformanceCounter Failed. The downside here is that we will have different clk types (MONOTHONIClike and REALTIMElike ) depending on the platform.\nWrite some fancy logic to merge the PerformanceCounter and GetSystemTime to have precise REALTIMElike output and failover to less precise GetSystemTime.\n\nWhat do you think?", "url": "https://github.com/apache/beam/pull/12172#discussion_r453805179", "createdAt": "2020-07-13T17:17:11Z", "author": {"login": "damgad"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef BEAM_CROSSPLATFORM_TIME_H\n+#define BEAM_CROSSPLATFORM_TIME_H\n+\n+#include <time.h>\n+\n+#ifdef _WIN32\n+#include <windows.h>\n+\n+/**\n+ * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n+ * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ */\n+int clock_gettime(int clk_id, struct timespec *tv) {\n+    static LARGE_INTEGER counterFrequency = {0};\n+    LARGE_INTEGER counterValue;\n+\n+    if (0 == counterFrequency.QuadPart) {\n+        if (0 == QueryPerformanceFrequency(&counterFrequency)) {\n+            /* System doesn't support performance counters. It's guaranteed to not happen\n+            on systems that run Windows XP or later */\n+            return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1ODUzMw=="}, "originalCommit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MTUzOA==", "bodyText": "IMO, both 3 and 1 sounds fine. 3 might be slightly better. WinXP+ is practically all modern Windows versions.", "url": "https://github.com/apache/beam/pull/12172#discussion_r453991538", "createdAt": "2020-07-13T22:50:55Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef BEAM_CROSSPLATFORM_TIME_H\n+#define BEAM_CROSSPLATFORM_TIME_H\n+\n+#include <time.h>\n+\n+#ifdef _WIN32\n+#include <windows.h>\n+\n+/**\n+ * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n+ * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ */\n+int clock_gettime(int clk_id, struct timespec *tv) {\n+    static LARGE_INTEGER counterFrequency = {0};\n+    LARGE_INTEGER counterValue;\n+\n+    if (0 == counterFrequency.QuadPart) {\n+        if (0 == QueryPerformanceFrequency(&counterFrequency)) {\n+            /* System doesn't support performance counters. It's guaranteed to not happen\n+            on systems that run Windows XP or later */\n+            return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1ODUzMw=="}, "originalCommit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyODQxNw==", "bodyText": "I've just pushed the third option", "url": "https://github.com/apache/beam/pull/12172#discussion_r454928417", "createdAt": "2020-07-15T09:46:36Z", "author": {"login": "damgad"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef BEAM_CROSSPLATFORM_TIME_H\n+#define BEAM_CROSSPLATFORM_TIME_H\n+\n+#include <time.h>\n+\n+#ifdef _WIN32\n+#include <windows.h>\n+\n+/**\n+ * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n+ * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ */\n+int clock_gettime(int clk_id, struct timespec *tv) {\n+    static LARGE_INTEGER counterFrequency = {0};\n+    LARGE_INTEGER counterValue;\n+\n+    if (0 == counterFrequency.QuadPart) {\n+        if (0 == QueryPerformanceFrequency(&counterFrequency)) {\n+            /* System doesn't support performance counters. It's guaranteed to not happen\n+            on systems that run Windows XP or later */\n+            return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1ODUzMw=="}, "originalCommit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzOTUwMDE0OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1ODo1MVrOGyJh4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1ODo1MVrOGyJh4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzODExNQ==", "bodyText": "nit:\nThis part if (0 == counterFrequency.QuadPart && performanceCounterAvailable) could be simplified to if (0 == counterFrequency.QuadPart) because counterFrequency.QuadPart will be set to a non-zero value either way after the first query.", "url": "https://github.com/apache/beam/pull/12172#discussion_r455238115", "createdAt": "2020-07-15T17:58:51Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -26,24 +26,32 @@\n \n /**\n  * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n- * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ * ignored and function act as for CLOCK_MONOTONIC. On Windows XP or later Performance Counter is used.\n+ * On older platforms, where there's no Performance Counter, SystemTime will be used as a failover.\n  */\n int clock_gettime(int clk_id, struct timespec *tv) {\n     static LARGE_INTEGER counterFrequency = {0};\n-    LARGE_INTEGER counterValue;\n+    static BOOL performanceCounterAvailable = TRUE;\n+    LARGE_INTEGER counterValue = {0};\n \n-    if (0 == counterFrequency.QuadPart) {\n+    //initialization\n+    if (0 == counterFrequency.QuadPart && performanceCounterAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f4edc685c53533ce967be1b3ab959aafc571cf1"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3477, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}