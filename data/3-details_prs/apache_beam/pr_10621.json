{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzOTI5MjM1", "number": 10621, "title": "[BEAM-9056] Staging artifacts from environment", "bodyText": "Staging artifacts from environment. This PR implements the first part of a cross-language pipeline dependency management. Details: https://docs.google.com/document/d/1L7MJcfyy9mg2Ahfw5XPhUeBe-dyvAPMOYOiFA1-kAog\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-17T02:03:18Z", "url": "https://github.com/apache/beam/pull/10621", "merged": true, "mergeCommit": {"oid": "80a2ff66c4ce403ae183bcaa59bbd52959d2b3da"}, "closed": true, "closedAt": "2020-03-12T20:59:53Z", "author": {"login": "ihji"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-50FpgBqjI5ODc2NTUwNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMd-RJABqjMxMTcxMjU3NDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae7df272392edf07c70cd43655f3f90132a01dd3", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/ae7df272392edf07c70cd43655f3f90132a01dd3", "committedDate": "2020-01-17T01:54:43Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "120d471da5d49e417a3914f5cd6be84a70d30724", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/120d471da5d49e417a3914f5cd6be84a70d30724", "committedDate": "2020-01-28T23:18:39Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "120d471da5d49e417a3914f5cd6be84a70d30724", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/120d471da5d49e417a3914f5cd6be84a70d30724", "committedDate": "2020-01-28T23:18:39Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "4499912f60b3fe2eb8fb081fa5ad7cbb5cbc292f", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/4499912f60b3fe2eb8fb081fa5ad7cbb5cbc292f", "committedDate": "2020-01-30T00:53:03Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4499912f60b3fe2eb8fb081fa5ad7cbb5cbc292f", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/4499912f60b3fe2eb8fb081fa5ad7cbb5cbc292f", "committedDate": "2020-01-30T00:53:03Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/acdff31a049a8f3627c3a627709372c850ea5e95", "committedDate": "2020-01-30T23:54:06Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzgzODIx", "url": "https://github.com/apache/beam/pull/10621#pullrequestreview-354783821", "createdAt": "2020-02-06T21:27:25Z", "commit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMToyNzoyNlrOFmqygw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0MDowOFrOFmrJFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5MTI2Nw==", "bodyText": "Path is relative, absolute or either ?", "url": "https://github.com/apache/beam/pull/10621#discussion_r376091267", "createdAt": "2020-02-06T21:27:26Z", "author": {"login": "chamikaramj"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -1087,6 +1087,44 @@ message SideInput {\n   FunctionSpec window_mapping_fn = 3;\n }\n \n+message StandardArtifacts {\n+  enum Types {\n+    // A URN for artifacts stored in a local directory.\n+    // payload: ArtifactFilePayload.\n+    FILE     = 0 [(beam_urn) = \"beam:artifact:file:v1\"];\n+    // A URN for artifacts embedded in ArtifactInformation proto.\n+    // payload: raw data bytes.\n+    EMBEDDED = 1 [(beam_urn) = \"beam:artifact:embedded:v1\"];\n+    // A URN for artifacts described by HTTP links.\n+    // payload: a string for an artifact HTTP URL\n+    HTTP     = 2 [(beam_urn) = \"beam:artifact:http:v1\"];\n+    // A URN for artifacts hosted on PYPI.\n+    // artifact_id: a PYPI project name\n+    // version_range: a PYPI compatible version string\n+    // payload: None\n+    PYPI     = 3 [(beam_urn) = \"beam:artifact:pypi:v1\"];\n+    // A URN for artifacts hosted on Maven central.\n+    // artifact_id: [maven group id]:[maven artifact id]\n+    // version_range: a Maven compatible version string\n+    // payload: None\n+    MAVEN    = 4 [(beam_urn) = \"beam:artifact:maven:v1\"];\n+  }\n+}\n+\n+message ArtifactFilePayload {\n+  // A path to an artifact file on a local system.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5MTU1MQ==", "bodyText": "Can you elaborate what this is ? Also do bother of these get set or only one of them ?", "url": "https://github.com/apache/beam/pull/10621#discussion_r376091551", "createdAt": "2020-02-06T21:28:05Z", "author": {"login": "chamikaramj"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -1087,6 +1087,44 @@ message SideInput {\n   FunctionSpec window_mapping_fn = 3;\n }\n \n+message StandardArtifacts {\n+  enum Types {\n+    // A URN for artifacts stored in a local directory.\n+    // payload: ArtifactFilePayload.\n+    FILE     = 0 [(beam_urn) = \"beam:artifact:file:v1\"];\n+    // A URN for artifacts embedded in ArtifactInformation proto.\n+    // payload: raw data bytes.\n+    EMBEDDED = 1 [(beam_urn) = \"beam:artifact:embedded:v1\"];\n+    // A URN for artifacts described by HTTP links.\n+    // payload: a string for an artifact HTTP URL\n+    HTTP     = 2 [(beam_urn) = \"beam:artifact:http:v1\"];\n+    // A URN for artifacts hosted on PYPI.\n+    // artifact_id: a PYPI project name\n+    // version_range: a PYPI compatible version string\n+    // payload: None\n+    PYPI     = 3 [(beam_urn) = \"beam:artifact:pypi:v1\"];\n+    // A URN for artifacts hosted on Maven central.\n+    // artifact_id: [maven group id]:[maven artifact id]\n+    // version_range: a Maven compatible version string\n+    // payload: None\n+    MAVEN    = 4 [(beam_urn) = \"beam:artifact:maven:v1\"];\n+  }\n+}\n+\n+message ArtifactFilePayload {\n+  // A path to an artifact file on a local system.\n+  string local_path = 1;\n+  // A generated staged name (no path).\n+  string staged_name = 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5MjM4MA==", "bodyText": "Please add documentation for this (including properties).", "url": "https://github.com/apache/beam/pull/10621#discussion_r376092380", "createdAt": "2020-02-06T21:29:57Z", "author": {"login": "chamikaramj"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -1087,6 +1087,44 @@ message SideInput {\n   FunctionSpec window_mapping_fn = 3;\n }\n \n+message StandardArtifacts {\n+  enum Types {\n+    // A URN for artifacts stored in a local directory.\n+    // payload: ArtifactFilePayload.\n+    FILE     = 0 [(beam_urn) = \"beam:artifact:file:v1\"];\n+    // A URN for artifacts embedded in ArtifactInformation proto.\n+    // payload: raw data bytes.\n+    EMBEDDED = 1 [(beam_urn) = \"beam:artifact:embedded:v1\"];\n+    // A URN for artifacts described by HTTP links.\n+    // payload: a string for an artifact HTTP URL\n+    HTTP     = 2 [(beam_urn) = \"beam:artifact:http:v1\"];\n+    // A URN for artifacts hosted on PYPI.\n+    // artifact_id: a PYPI project name\n+    // version_range: a PYPI compatible version string\n+    // payload: None\n+    PYPI     = 3 [(beam_urn) = \"beam:artifact:pypi:v1\"];\n+    // A URN for artifacts hosted on Maven central.\n+    // artifact_id: [maven group id]:[maven artifact id]\n+    // version_range: a Maven compatible version string\n+    // payload: None\n+    MAVEN    = 4 [(beam_urn) = \"beam:artifact:maven:v1\"];\n+  }\n+}\n+\n+message ArtifactFilePayload {\n+  // A path to an artifact file on a local system.\n+  string local_path = 1;\n+  // A generated staged name (no path).\n+  string staged_name = 2;\n+}\n+\n+message ArtifactInformation {\n+  string urn = 1;\n+  bytes payload = 2;\n+  string artifact_id = 3;\n+  string version_range = 4;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5MzgwMQ==", "bodyText": "Please add a TODO to remove this experiment when full solution is fully implemented (for all supported runners).", "url": "https://github.com/apache/beam/pull/10621#discussion_r376093801", "createdAt": "2020-02-06T21:32:55Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Environments.java", "diffHunk": "@@ -171,6 +193,83 @@ public static Environment createProcessEnvironment(\n     }\n   }\n \n+  public static Collection<ArtifactInformation> getArtifacts(PipelineOptions options) {\n+    Set<String> pathsToStage = Sets.newHashSet();\n+    List<String> experiments = options.as(ExperimentalOptions.class).getExperiments();\n+    if (experiments != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5NDk4Ng==", "bodyText": "Is this method just to get artifacts from the experiment ? If so please name this method accordingly.", "url": "https://github.com/apache/beam/pull/10621#discussion_r376094986", "createdAt": "2020-02-06T21:35:25Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Environments.java", "diffHunk": "@@ -171,6 +193,83 @@ public static Environment createProcessEnvironment(\n     }\n   }\n \n+  public static Collection<ArtifactInformation> getArtifacts(PipelineOptions options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5NzA0NQ==", "bodyText": "\"Unsupported artifact type ...\" might be a better error here.", "url": "https://github.com/apache/beam/pull/10621#discussion_r376097045", "createdAt": "2020-02-06T21:40:08Z", "author": {"login": "chamikaramj"}, "path": "runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java", "diffHunk": "@@ -203,11 +146,33 @@ public PipelineResult run(Pipeline pipeline) {\n           prepareJobResponse.getArtifactStagingEndpoint();\n       String stagingSessionToken = prepareJobResponse.getStagingSessionToken();\n \n+      ImmutableList.Builder<StagedFile> filesToStageBuilder = ImmutableList.builder();\n+      for (Map.Entry<String, RunnerApi.Environment> entry :\n+          pipelineProto.getComponents().getEnvironmentsMap().entrySet()) {\n+        for (RunnerApi.ArtifactInformation info : entry.getValue().getDependenciesList()) {\n+          if (BeamUrns.getUrn(RunnerApi.StandardArtifacts.Types.FILE).equals(info.getUrn())) {\n+            RunnerApi.ArtifactFilePayload filePayload;\n+            try {\n+              filePayload = RunnerApi.ArtifactFilePayload.parseFrom(info.getPayload());\n+            } catch (InvalidProtocolBufferException e) {\n+              throw new RuntimeException(\"Error parsing artifact file payload.\", e);\n+            }\n+            filesToStageBuilder.add(\n+                StagedFile.of(new File(filePayload.getLocalPath()), filePayload.getStagedName()));\n+          } else {\n+            throw new RuntimeException(\n+                String.format(\"expect file artifact type but %s\", info.getUrn()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95"}, "originalPosition": 155}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acdff31a049a8f3627c3a627709372c850ea5e95", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/acdff31a049a8f3627c3a627709372c850ea5e95", "committedDate": "2020-01-30T23:54:06Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "0c52b405fb907164127d77baebb12101c5f52664", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/0c52b405fb907164127d77baebb12101c5f52664", "committedDate": "2020-02-10T23:28:40Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c52b405fb907164127d77baebb12101c5f52664", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/0c52b405fb907164127d77baebb12101c5f52664", "committedDate": "2020-02-10T23:28:40Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "b2357bd3af92d57682148afedc9cbcc6fde5fd9b", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/b2357bd3af92d57682148afedc9cbcc6fde5fd9b", "committedDate": "2020-02-14T22:36:21Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2357bd3af92d57682148afedc9cbcc6fde5fd9b", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/b2357bd3af92d57682148afedc9cbcc6fde5fd9b", "committedDate": "2020-02-14T22:36:21Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "7c878a361d4b249f1277834d14aa0c2e540925cd", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/7c878a361d4b249f1277834d14aa0c2e540925cd", "committedDate": "2020-02-19T23:44:43Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c878a361d4b249f1277834d14aa0c2e540925cd", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/7c878a361d4b249f1277834d14aa0c2e540925cd", "committedDate": "2020-02-19T23:44:43Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "303a1ddd056ac97f10f4c694a5ab24e12ef1f044", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/303a1ddd056ac97f10f4c694a5ab24e12ef1f044", "committedDate": "2020-02-21T01:10:26Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "303a1ddd056ac97f10f4c694a5ab24e12ef1f044", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/303a1ddd056ac97f10f4c694a5ab24e12ef1f044", "committedDate": "2020-02-21T01:10:26Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "acb5f3fa282cc1974c5195a48a10cba70b9601c0", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/acb5f3fa282cc1974c5195a48a10cba70b9601c0", "committedDate": "2020-02-21T01:47:06Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acb5f3fa282cc1974c5195a48a10cba70b9601c0", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/acb5f3fa282cc1974c5195a48a10cba70b9601c0", "committedDate": "2020-02-21T01:47:06Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "fd637a856570a644471e9e5b551eaeae79de294f", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/fd637a856570a644471e9e5b551eaeae79de294f", "committedDate": "2020-02-24T20:55:03Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd637a856570a644471e9e5b551eaeae79de294f", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/fd637a856570a644471e9e5b551eaeae79de294f", "committedDate": "2020-02-24T20:55:03Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/91cee049e8ffad3fe78668162903234ef7554c3b", "committedDate": "2020-02-25T23:30:50Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTMxNjc1", "url": "https://github.com/apache/beam/pull/10621#pullrequestreview-365131675", "createdAt": "2020-02-26T18:19:35Z", "commit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxODoxOTozNVrOFu2wLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTo1NDozNFrOFu5_3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3NTg4Ng==", "bodyText": "Is this the behavior expected by Beam runners (zipping up directories) ?", "url": "https://github.com/apache/beam/pull/10621#discussion_r384675886", "createdAt": "2020-02-26T18:19:35Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Environments.java", "diffHunk": "@@ -175,6 +197,90 @@ public static Environment createProcessEnvironment(\n     }\n   }\n \n+  public static Collection<ArtifactInformation> getArtifacts(PipelineOptions options) {\n+    Set<String> pathsToStage = Sets.newHashSet();\n+    // TODO(heejong): remove jar_packages experimental flag when cross-language dependency\n+    //   management is implemented for all runners.\n+    List<String> experiments = options.as(ExperimentalOptions.class).getExperiments();\n+    if (experiments != null) {\n+      Optional<String> jarPackages =\n+          experiments.stream()\n+              .filter((String flag) -> flag.startsWith(\"jar_packages=\"))\n+              .findFirst();\n+      jarPackages.ifPresent(\n+          s -> pathsToStage.addAll(Arrays.asList(s.replaceFirst(\"jar_packages=\", \"\").split(\",\"))));\n+    }\n+    List<String> stagingFiles = options.as(PortablePipelineOptions.class).getFilesToStage();\n+    if (stagingFiles == null) {\n+      pathsToStage.addAll(\n+          detectClassPathResourcesToStage(Environments.class.getClassLoader(), options));\n+      if (pathsToStage.isEmpty()) {\n+        throw new IllegalArgumentException(\"No classpath elements found.\");\n+      }\n+      LOG.debug(\n+          \"PortablePipelineOptions.filesToStage was not specified. \"\n+              + \"Defaulting to files from the classpath: {}\",\n+          pathsToStage.size());\n+    } else {\n+      pathsToStage.addAll(stagingFiles);\n+    }\n+\n+    ImmutableList.Builder<ArtifactInformation> filesToStage = ImmutableList.builder();\n+    for (String path : pathsToStage) {\n+      File file = new File(path);\n+      if (new File(path).exists()) {\n+        // Spurious items get added to the classpath. Filter by just those that exist.\n+        if (file.isDirectory()) {\n+          // Zip up directories so we can upload them to the artifact service.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcyOTA1Mw==", "bodyText": "Probably it's better to explicitly declare the given environment as the default (through an additional argument to registerEnvironment()) instead of assuming first one that was passed to here to be the default.", "url": "https://github.com/apache/beam/pull/10621#discussion_r384729053", "createdAt": "2020-02-26T19:54:34Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/SdkComponents.java", "diffHunk": "@@ -261,14 +263,20 @@ public String registerCoder(Coder<?> coder) throws IOException {\n    * return the same unique ID.\n    */\n   public String registerEnvironment(Environment env) {\n+    String environmentId;\n     String existing = environmentIds.get(env);\n     if (existing != null) {\n-      return existing;\n+      environmentId = existing;\n+    } else {\n+      String name = uniqify(env.getUrn(), environmentIds.values());\n+      environmentIds.put(env, name);\n+      componentsBuilder.putEnvironments(name, env);\n+      environmentId = name;\n     }\n-    String name = uniqify(env.getUrn(), environmentIds.values());\n-    environmentIds.put(env, name);\n-    componentsBuilder.putEnvironments(name, env);\n-    return name;\n+    if (defaultEnvironmentId == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzQyNDcz", "url": "https://github.com/apache/beam/pull/10621#pullrequestreview-365342473", "createdAt": "2020-02-27T00:32:50Z", "commit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDozMjo1MFrOFvBYFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDo0NDoyOFrOFvBlSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTk0Mg==", "bodyText": "Looks like this was the previous behavior.", "url": "https://github.com/apache/beam/pull/10621#discussion_r384849942", "createdAt": "2020-02-27T00:32:50Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Environments.java", "diffHunk": "@@ -175,6 +197,90 @@ public static Environment createProcessEnvironment(\n     }\n   }\n \n+  public static Collection<ArtifactInformation> getArtifacts(PipelineOptions options) {\n+    Set<String> pathsToStage = Sets.newHashSet();\n+    // TODO(heejong): remove jar_packages experimental flag when cross-language dependency\n+    //   management is implemented for all runners.\n+    List<String> experiments = options.as(ExperimentalOptions.class).getExperiments();\n+    if (experiments != null) {\n+      Optional<String> jarPackages =\n+          experiments.stream()\n+              .filter((String flag) -> flag.startsWith(\"jar_packages=\"))\n+              .findFirst();\n+      jarPackages.ifPresent(\n+          s -> pathsToStage.addAll(Arrays.asList(s.replaceFirst(\"jar_packages=\", \"\").split(\",\"))));\n+    }\n+    List<String> stagingFiles = options.as(PortablePipelineOptions.class).getFilesToStage();\n+    if (stagingFiles == null) {\n+      pathsToStage.addAll(\n+          detectClassPathResourcesToStage(Environments.class.getClassLoader(), options));\n+      if (pathsToStage.isEmpty()) {\n+        throw new IllegalArgumentException(\"No classpath elements found.\");\n+      }\n+      LOG.debug(\n+          \"PortablePipelineOptions.filesToStage was not specified. \"\n+              + \"Defaulting to files from the classpath: {}\",\n+          pathsToStage.size());\n+    } else {\n+      pathsToStage.addAll(stagingFiles);\n+    }\n+\n+    ImmutableList.Builder<ArtifactInformation> filesToStage = ImmutableList.builder();\n+    for (String path : pathsToStage) {\n+      File file = new File(path);\n+      if (new File(path).exists()) {\n+        // Spurious items get added to the classpath. Filter by just those that exist.\n+        if (file.isDirectory()) {\n+          // Zip up directories so we can upload them to the artifact service.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3NTg4Ng=="}, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDY2OQ==", "bodyText": "Would this be better placed in createOrGetDefaultEnvironment?", "url": "https://github.com/apache/beam/pull/10621#discussion_r384850669", "createdAt": "2020-02-27T00:35:24Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/SdkComponents.java", "diffHunk": "@@ -88,11 +88,13 @@ public static SdkComponents create(RunnerApi.Components components) {\n   public static SdkComponents create(PipelineOptions options) {\n     SdkComponents sdkComponents = new SdkComponents(RunnerApi.Components.getDefaultInstance(), \"\");\n     PortablePipelineOptions portablePipelineOptions = options.as(PortablePipelineOptions.class);\n-    sdkComponents.defaultEnvironmentId =\n-        sdkComponents.registerEnvironment(\n-            Environments.createOrGetDefaultEnvironment(\n+    sdkComponents.registerEnvironment(\n+        Environments.createOrGetDefaultEnvironment(\n                 portablePipelineOptions.getDefaultEnvironmentType(),\n-                portablePipelineOptions.getDefaultEnvironmentConfig()));\n+                portablePipelineOptions.getDefaultEnvironmentConfig())\n+            .toBuilder()\n+            .addAllDependencies(Environments.getArtifacts(options))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MTE3MQ==", "bodyText": "+1", "url": "https://github.com/apache/beam/pull/10621#discussion_r384851171", "createdAt": "2020-02-27T00:37:01Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/SdkComponents.java", "diffHunk": "@@ -261,14 +263,20 @@ public String registerCoder(Coder<?> coder) throws IOException {\n    * return the same unique ID.\n    */\n   public String registerEnvironment(Environment env) {\n+    String environmentId;\n     String existing = environmentIds.get(env);\n     if (existing != null) {\n-      return existing;\n+      environmentId = existing;\n+    } else {\n+      String name = uniqify(env.getUrn(), environmentIds.values());\n+      environmentIds.put(env, name);\n+      componentsBuilder.putEnvironments(name, env);\n+      environmentId = name;\n     }\n-    String name = uniqify(env.getUrn(), environmentIds.values());\n-    environmentIds.put(env, name);\n-    componentsBuilder.putEnvironments(name, env);\n-    return name;\n+    if (defaultEnvironmentId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcyOTA1Mw=="}, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MTgxMw==", "bodyText": "Perhaps it's worth pulling this out into a separate method?", "url": "https://github.com/apache/beam/pull/10621#discussion_r384851813", "createdAt": "2020-02-27T00:39:08Z", "author": {"login": "robertwb"}, "path": "runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java", "diffHunk": "@@ -200,11 +143,44 @@ public PipelineResult run(Pipeline pipeline) {\n           prepareJobResponse.getArtifactStagingEndpoint();\n       String stagingSessionToken = prepareJobResponse.getStagingSessionToken();\n \n+      ImmutableList.Builder<StagedFile> filesToStageBuilder = ImmutableList.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MzA2Nw==", "bodyText": "Does this actually stage them, or just add them to the returned list? If not, the name and docstring should be updated.", "url": "https://github.com/apache/beam/pull/10621#discussion_r384853067", "createdAt": "2020-02-27T00:43:37Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/stager.py", "diffHunk": "@@ -331,22 +389,23 @@ def _download_file(from_url, to_path):\n   def _is_remote_path(path):\n     return path.find('://') != -1\n \n-  def _stage_jar_packages(self, jar_packages, staging_location, temp_dir):\n-    # type: (...) -> List[str]\n+  @staticmethod\n+  def _stage_jar_packages(jar_packages, temp_dir):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 257}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MzA5OQ==", "bodyText": "Similarly.", "url": "https://github.com/apache/beam/pull/10621#discussion_r384853099", "createdAt": "2020-02-27T00:43:44Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/stager.py", "diffHunk": "@@ -377,34 +436,33 @@ def _stage_jar_packages(self, jar_packages, staging_location, temp_dir):\n \n     for package in local_packages:\n       basename = os.path.basename(package)\n-      staged_path = FileSystems.join(staging_location, basename)\n-      self.stage_artifact(package, staged_path)\n-      resources.append(basename)\n+      resources.append((package, basename))\n \n     return resources\n \n-  def _stage_extra_packages(self, extra_packages, staging_location, temp_dir):\n-    # type: (...) -> List[str]\n+  @staticmethod\n+  def _stage_extra_packages(extra_packages, temp_dir):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 294}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MzMyMQ==", "bodyText": "same", "url": "https://github.com/apache/beam/pull/10621#discussion_r384853321", "createdAt": "2020-02-27T00:44:28Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/stager.py", "diffHunk": "@@ -547,21 +601,22 @@ def _desired_sdk_filename_in_staging_location(sdk_location):\n     else:\n       return DATAFLOW_SDK_TARBALL_FILE\n \n-  def _stage_beam_sdk(self, sdk_remote_location, staging_location, temp_dir):\n-    # type: (...) -> List[str]\n+  @staticmethod\n+  def _stage_beam_sdk(sdk_remote_location, temp_dir):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 356}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/91cee049e8ffad3fe78668162903234ef7554c3b", "committedDate": "2020-02-25T23:30:50Z", "message": "[BEAM-9056] Staging artifacts from environment"}, "afterCommit": {"oid": "0b15aac649776ab86698330d24031f94f1c955ac", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/0b15aac649776ab86698330d24031f94f1c955ac", "committedDate": "2020-02-28T01:46:26Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTA1MzQw", "url": "https://github.com/apache/beam/pull/10621#pullrequestreview-369905340", "createdAt": "2020-03-05T20:52:37Z", "commit": {"oid": "d5b0d554e074ea1ad0841008b0d10e00d235bbbc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1MjozN1rOFyjvqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1MjozN1rOFyjvqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1ODc2MQ==", "bodyText": "Ok. Let's still do this immediately after this one though so that we do not forget about it.", "url": "https://github.com/apache/beam/pull/10621#discussion_r388558761", "createdAt": "2020-03-05T20:52:37Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/SdkComponents.java", "diffHunk": "@@ -261,14 +263,20 @@ public String registerCoder(Coder<?> coder) throws IOException {\n    * return the same unique ID.\n    */\n   public String registerEnvironment(Environment env) {\n+    String environmentId;\n     String existing = environmentIds.get(env);\n     if (existing != null) {\n-      return existing;\n+      environmentId = existing;\n+    } else {\n+      String name = uniqify(env.getUrn(), environmentIds.values());\n+      environmentIds.put(env, name);\n+      componentsBuilder.putEnvironments(name, env);\n+      environmentId = name;\n     }\n-    String name = uniqify(env.getUrn(), environmentIds.values());\n-    environmentIds.put(env, name);\n-    componentsBuilder.putEnvironments(name, env);\n-    return name;\n+    if (defaultEnvironmentId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcyOTA1Mw=="}, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTg5MDAx", "url": "https://github.com/apache/beam/pull/10621#pullrequestreview-370589001", "createdAt": "2020-03-06T19:56:43Z", "commit": {"oid": "d5b0d554e074ea1ad0841008b0d10e00d235bbbc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxOTo1Njo0M1rOFzFpZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxOTo1Njo0M1rOFzFpZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNDIxNA==", "bodyText": "This is a case where doing it in a different commit in the same PR could make sense. But I'm OK with deferring as long as it happens soon.", "url": "https://github.com/apache/beam/pull/10621#discussion_r389114214", "createdAt": "2020-03-06T19:56:43Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/SdkComponents.java", "diffHunk": "@@ -261,14 +263,20 @@ public String registerCoder(Coder<?> coder) throws IOException {\n    * return the same unique ID.\n    */\n   public String registerEnvironment(Environment env) {\n+    String environmentId;\n     String existing = environmentIds.get(env);\n     if (existing != null) {\n-      return existing;\n+      environmentId = existing;\n+    } else {\n+      String name = uniqify(env.getUrn(), environmentIds.values());\n+      environmentIds.put(env, name);\n+      componentsBuilder.putEnvironments(name, env);\n+      environmentId = name;\n     }\n-    String name = uniqify(env.getUrn(), environmentIds.values());\n-    environmentIds.put(env, name);\n-    componentsBuilder.putEnvironments(name, env);\n-    return name;\n+    if (defaultEnvironmentId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcyOTA1Mw=="}, "originalCommit": {"oid": "91cee049e8ffad3fe78668162903234ef7554c3b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fce2528b0ff011ff3d416ac9e70c8d7264b1f3c", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/6fce2528b0ff011ff3d416ac9e70c8d7264b1f3c", "committedDate": "2020-03-11T02:25:45Z", "message": "[BEAM-9056] Staging artifacts from environment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1f662e44c84cc49faf486e542ebeb35669ebf58", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/c1f662e44c84cc49faf486e542ebeb35669ebf58", "committedDate": "2020-03-09T18:28:20Z", "message": "fix python formatting"}, "afterCommit": {"oid": "6fce2528b0ff011ff3d416ac9e70c8d7264b1f3c", "author": {"user": {"login": "ihji", "name": "Heejong Lee"}}, "url": "https://github.com/apache/beam/commit/6fce2528b0ff011ff3d416ac9e70c8d7264b1f3c", "committedDate": "2020-03-11T02:25:45Z", "message": "[BEAM-9056] Staging artifacts from environment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3508, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}