{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NjUyODIx", "number": 12225, "title": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11", "bodyText": "The LocalFileSystemsTest relied on System.setProperty(\"user.dir\") to set the working directory for file resolution, to simulate a user trying to resolve and stage files relative to where they launch their pipeline.\nSetting System.setProperty(\"user.dir\") was never intended to work, but it worked by luck up to and including Java 8. In Java 11 is no longer works. There is no replacement, short of launching a subprocess with a different working directory.\nWe can get adequate test coverage by calling package-private helper methods.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-10T21:31:58Z", "url": "https://github.com/apache/beam/pull/12225", "merged": true, "mergeCommit": {"oid": "c5222392322bea50320e9e2a8e62b3a099b4ad94"}, "closed": true, "closedAt": "2020-07-13T22:46:03Z", "author": {"login": "kennknowles"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczqtVagBqjM1MzU1NDMwMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0lKdDgBqjM1NDA2MzE5MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b46be4a8a14c902a9c57324e793507697ff3ffc0", "author": {"user": {"login": "kennknowles", "name": "Kenn Knowles"}}, "url": "https://github.com/apache/beam/commit/b46be4a8a14c902a9c57324e793507697ff3ffc0", "committedDate": "2020-07-10T21:28:51Z", "message": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11"}, "afterCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351", "author": {"user": {"login": "kennknowles", "name": "Kenn Knowles"}}, "url": "https://github.com/apache/beam/commit/bc22394883439694b4f15163c91dce503ab84351", "committedDate": "2020-07-10T21:41:36Z", "message": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzI3MjY5", "url": "https://github.com/apache/beam/pull/12225#pullrequestreview-447327269", "createdAt": "2020-07-13T14:53:43Z", "commit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDo1Mzo0M1rOGwsNdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToxMjo0NFrOGwtDbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwOTE3NQ==", "bodyText": "pwd is a bit unclear as a parameter name.", "url": "https://github.com/apache/beam/pull/12225#discussion_r453709175", "createdAt": "2020-07-13T14:53:43Z", "author": {"login": "tysonjh"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -90,9 +91,14 @@\n \n   @Override\n   protected List<MatchResult> match(List<String> specs) throws IOException {\n+    return match(new File(\".\").getAbsolutePath(), specs);\n+  }\n+\n+  @VisibleForTesting\n+  List<MatchResult> match(String pwd, List<String> specs) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMjk5MA==", "bodyText": "Can you change the relativeFile name to something else? It may actually be an absolute file and that would be confusing.", "url": "https://github.com/apache/beam/pull/12225#discussion_r453722990", "createdAt": "2020-07-13T15:12:44Z", "author": {"login": "tysonjh"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -223,12 +229,22 @@ private MatchResult matchOne(String spec) throws IOException {\n     // it considers it an invalid file system pattern. We should use\n     // new File(spec) to avoid such validation.\n     // See https://bugs.openjdk.java.net/browse/JDK-8197918\n-    final File file = new File(spec);\n+    // However, new File(parent, child) resolves absolute `child` in a system-dependent\n+    // way that is generally incorrect, for example new File($PWD, \"/tmp/foo\") resolves\n+    // to $PWD/tmp/foo on many systems, unlike Paths.get($PWD).resolve(\"/tmp/foo\") which\n+    // correctly resolves to \"/tmp/foo\". We add just this one piece of logic here, without\n+    // switching to Paths which could require a rewrite of this module to support\n+    // both Windows and correct file resolution.\n+    // The root cause is that globs are not files but we are using file manipulation libraries\n+    // to work with them.\n+    final File relativeFile = new File(spec);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40c46befaf6e22ce783ce973c34edaa0d613abfc", "author": {"user": {"login": "kennknowles", "name": "Kenn Knowles"}}, "url": "https://github.com/apache/beam/commit/40c46befaf6e22ce783ce973c34edaa0d613abfc", "committedDate": "2020-07-13T17:47:23Z", "message": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDYyMDc3", "url": "https://github.com/apache/beam/pull/12225#pullrequestreview-447462077", "createdAt": "2020-07-13T17:38:42Z", "commit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozODo0MlrOGwy2pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzo0NzowMlrOGwzJ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxODAyMA==", "bodyText": "Changed to baseDir", "url": "https://github.com/apache/beam/pull/12225#discussion_r453818020", "createdAt": "2020-07-13T17:38:42Z", "author": {"login": "kennknowles"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -90,9 +91,14 @@\n \n   @Override\n   protected List<MatchResult> match(List<String> specs) throws IOException {\n+    return match(new File(\".\").getAbsolutePath(), specs);\n+  }\n+\n+  @VisibleForTesting\n+  List<MatchResult> match(String pwd, List<String> specs) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwOTE3NQ=="}, "originalCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyMjkzMw==", "bodyText": "Renamed to specAsFile since basically it is just cramming the string into a File object, and renamed file into absoluteFile since it is now rooted in a base directory unless it was already absolute.", "url": "https://github.com/apache/beam/pull/12225#discussion_r453822933", "createdAt": "2020-07-13T17:47:02Z", "author": {"login": "kennknowles"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/LocalFileSystem.java", "diffHunk": "@@ -223,12 +229,22 @@ private MatchResult matchOne(String spec) throws IOException {\n     // it considers it an invalid file system pattern. We should use\n     // new File(spec) to avoid such validation.\n     // See https://bugs.openjdk.java.net/browse/JDK-8197918\n-    final File file = new File(spec);\n+    // However, new File(parent, child) resolves absolute `child` in a system-dependent\n+    // way that is generally incorrect, for example new File($PWD, \"/tmp/foo\") resolves\n+    // to $PWD/tmp/foo on many systems, unlike Paths.get($PWD).resolve(\"/tmp/foo\") which\n+    // correctly resolves to \"/tmp/foo\". We add just this one piece of logic here, without\n+    // switching to Paths which could require a rewrite of this module to support\n+    // both Windows and correct file resolution.\n+    // The root cause is that globs are not files but we are using file manipulation libraries\n+    // to work with them.\n+    final File relativeFile = new File(spec);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyMjk5MA=="}, "originalCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc22394883439694b4f15163c91dce503ab84351", "author": {"user": {"login": "kennknowles", "name": "Kenn Knowles"}}, "url": "https://github.com/apache/beam/commit/bc22394883439694b4f15163c91dce503ab84351", "committedDate": "2020-07-10T21:41:36Z", "message": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11"}, "afterCommit": {"oid": "40c46befaf6e22ce783ce973c34edaa0d613abfc", "author": {"user": {"login": "kennknowles", "name": "Kenn Knowles"}}, "url": "https://github.com/apache/beam/commit/40c46befaf6e22ce783ce973c34edaa0d613abfc", "committedDate": "2020-07-13T17:47:23Z", "message": "[BEAM-10080] Fix LocalFileSystemsTest to work with Java 11"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4052, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}