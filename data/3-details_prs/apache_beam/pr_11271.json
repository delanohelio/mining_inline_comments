{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1OTcwODcx", "number": 11271, "title": "[BEAM-9624] Adds Convert to Accumulators operator for use in combiner lifting for streaming pipelines", "bodyText": "The Convert To Accumulators operation is defined here:\nhttps://s.apache.org/beam-runner-api-combine-model#heading=h.h5697l1scd9x\nIt is used by streaming pipelines where we want to lift the combiner into the GBK, but don't want to also lift the combiner into a PGBK before the GBK. This PGBK can behave badly with certain triggers.\nThis PR also adds an implementation of Convert to Accumulators for the Go, Java, and Python SDKs.\nR: @robertwb, @lukecwik, @lostluck\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-30T23:47:00Z", "url": "https://github.com/apache/beam/pull/11271", "merged": true, "mergeCommit": {"oid": "9e01c5a1b05c29a8ada57c913180bfdcc7522579"}, "closed": true, "closedAt": "2020-04-02T21:11:07Z", "author": {"login": "acrites"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS0nrHgH2gAyMzk1OTcwODcxOjNlMTU1YzcwNTU5OWRhN2I0Yzg0OTY2ZWQ4Y2ZmNjc4NzI1ZTc1NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTdQyzAFqTM4NTkwMzUyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e155c705599da7b4c84966ed8cff678725e7576", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/3e155c705599da7b4c84966ed8cff678725e7576", "committedDate": "2020-03-30T20:35:07Z", "message": "Adds convert_to_accumulators URN and associated implementations for Go/Java/Python SDKs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf8f0ae0baafa5e461cb801951f39d4c79699c0", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/5cf8f0ae0baafa5e461cb801951f39d4c79699c0", "committedDate": "2020-03-30T20:47:19Z", "message": "Fixes copy-paste error in proto comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed8dc9840488888130b48b18f38648497163366", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/5ed8dc9840488888130b48b18f38648497163366", "committedDate": "2020-03-30T21:06:45Z", "message": "Fixes spelling error in comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/77b84cf8bfb940b014ea73b7247d0ba4ddd3507f", "committedDate": "2020-03-30T21:49:55Z", "message": "Add test for Java ConvertToAccumulators."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzY1MTU5", "url": "https://github.com/apache/beam/pull/11271#pullrequestreview-384365159", "createdAt": "2020-03-31T02:41:20Z", "commit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMjo0MToyMVrOF-DPPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMjo0NzozN1rOF-DVRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwOTA4NA==", "bodyText": "Please add to the checkState in the static initialization block to make sure this value doesn't deviate from the string constant here.\nNote, we do it this way so the Java compiler can treat the value as a string constant.", "url": "https://github.com/apache/beam/pull/11271#discussion_r400609084", "createdAt": "2020-03-31T02:41:21Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PTransformTranslation.java", "diffHunk": "@@ -101,6 +101,8 @@\n       \"beam:transform:combine_per_key_merge_accumulators:v1\";\n   public static final String COMBINE_PER_KEY_EXTRACT_OUTPUTS_TRANSFORM_URN =\n       \"beam:transform:combine_per_key_extract_outputs:v1\";\n+  public static final String COMBINE_PER_KEY_CONVERT_TO_ACCUMULATORS_TRANSFORM_URN =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMDYyOA==", "bodyText": "Please add a test like Combine/LiftedCombine: \n  \n    \n      beam/sdks/go/pkg/beam/core/runtime/exec/combine_test.go\n    \n    \n         Line 84\n      in\n      c8e200b\n    \n    \n    \n    \n\n        \n          \n           func TestLiftedCombine(t *testing.T) {", "url": "https://github.com/apache/beam/pull/11271#discussion_r400610628", "createdAt": "2020-03-31T02:47:37Z", "author": {"login": "lukecwik"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine.go", "diffHunk": "@@ -499,3 +499,30 @@ func (n *ExtractOutput) ProcessElement(ctx context.Context, value *FullValue, va\n \t}\n \treturn n.Out.ProcessElement(n.Combine.ctx, &FullValue{Windows: value.Windows, Elm: value.Elm, Elm2: out, Timestamp: value.Timestamp})\n }\n+\n+// ConvertToAccumulators is an executor for converting an input value to an accumulator value.\n+type ConvertToAccumulators struct {\n+\t*Combine\n+}\n+\n+func (n *ConvertToAccumulators) String() string {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0ODQ3NjY0", "url": "https://github.com/apache/beam/pull/11271#pullrequestreview-384847664", "createdAt": "2020-03-31T15:26:00Z", "commit": {"oid": "77b84cf8bfb940b014ea73b7247d0ba4ddd3507f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/f6cacc102dc7b4a32c9c11ce73af8069680ea970", "committedDate": "2020-04-01T00:20:28Z", "message": "Adds a test for go and extra checking in java translation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d650fe4b0fdccc5213dceda5677dfa04f38814aa", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/d650fe4b0fdccc5213dceda5677dfa04f38814aa", "committedDate": "2020-04-01T00:39:23Z", "message": "Merge remote-tracking branch 'upstream/master' into convert-to-accumulators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9e9f14d6df0639afb77deb57e5c992ac4e9b19", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/fb9e9f14d6df0639afb77deb57e5c992ac4e9b19", "committedDate": "2020-04-01T00:43:01Z", "message": "Changes number of parameters to createRunnerForPTransform since signature changed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjIzNDMx", "url": "https://github.com/apache/beam/pull/11271#pullrequestreview-385223431", "createdAt": "2020-04-01T02:17:30Z", "commit": {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjoxNzozMFrOF-ugnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMjoxNzozMFrOF-ugnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxODA0NA==", "bodyText": "This will validate that you get the right output but doesn't actually ensure that convertToAccumulators didn't do any combining.\nIt might be worthwhile to just test the convertToAccumulators step without any of the other steps alongside it.", "url": "https://github.com/apache/beam/pull/11271#discussion_r401318044", "createdAt": "2020-04-01T02:17:30Z", "author": {"login": "lukecwik"}, "path": "sdks/go/pkg/beam/core/runtime/exec/combine_test.go", "diffHunk": "@@ -113,6 +113,40 @@ func TestLiftedCombine(t *testing.T) {\n \n }\n \n+// TestConvertToaccumulators verifies that if we just do ConvertToAccumulators instead\n+// of LiftedCombine before the GBK we still get the right answer.\n+func TestConvertToAccumulators(t *testing.T) {\n+\twithCoder := func(t *testing.T, suffix string, key interface{}, keyCoder *coder.Coder) {\n+\t\tfor _, test := range tests {\n+\t\t\tt.Run(fnName(test.Fn)+\"_\"+suffix, func(t *testing.T) {\n+\t\t\t\tedge := getCombineEdge(t, test.Fn, reflectx.Int, test.AccumCoder)\n+\n+\t\t\t\tout := &CaptureNode{UID: 1}\n+\t\t\t\textract := &ExtractOutput{Combine: &Combine{UID: 2, Fn: edge.CombineFn, Out: out}}\n+\t\t\t\tmerge := &MergeAccumulators{Combine: &Combine{UID: 3, Fn: edge.CombineFn, Out: extract}}\n+\t\t\t\tgbk := &simpleGBK{UID: 4, KeyCoder: keyCoder, Out: merge}\n+\t\t\t\tconvertToAccumulators := &ConvertToAccumulators{Combine: &Combine{UID: 5, Fn: edge.CombineFn, Out: gbk}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cacc102dc7b4a32c9c11ce73af8069680ea970"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3cf7514eddf23da6ffe7d4a0e45807a11d3f1ec", "author": {"user": {"login": "acrites", "name": "Andrew Crites"}}, "url": "https://github.com/apache/beam/commit/a3cf7514eddf23da6ffe7d4a0e45807a11d3f1ec", "committedDate": "2020-04-01T18:30:59Z", "message": "Changes ConvertToAccumulator test to only test the ConverToAccumulators phase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTAzNTI5", "url": "https://github.com/apache/beam/pull/11271#pullrequestreview-385903529", "createdAt": "2020-04-01T19:56:14Z", "commit": {"oid": "a3cf7514eddf23da6ffe7d4a0e45807a11d3f1ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4812, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}