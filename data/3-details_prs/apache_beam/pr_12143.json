{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzc0MzAy", "number": 12143, "title": "[BEAM-10291] Adding full thread dump upon lull detection for Dataflow\u2026", "bodyText": "Adding full thread dump upon lull detection for Dataflow Java worker.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-01T00:42:55Z", "url": "https://github.com/apache/beam/pull/12143", "merged": true, "mergeCommit": {"oid": "a90c51a6914d9ce3fb392b2bf22d2e973f7d513b"}, "closed": true, "closedAt": "2020-07-08T19:56:17Z", "author": {"login": "davidyan74"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwfRd7gH2gAyNDQyMzc0MzAyOjliMDAxZDNlZmI0NjIwZTE4MWExMDc4YjQ1N2M0MDE3Y2UzMmQ3YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy9boSgH2gAyNDQyMzc0MzAyOmE0YjVmYTJkOGJkOTgzMjc2NDgzYjliMzZkNDA2MzkzMGY1MzNhZjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b001d3efb4620e181a1078b457c4017ce32d7b4", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/9b001d3efb4620e181a1078b457c4017ce32d7b4", "committedDate": "2020-07-01T00:40:35Z", "message": "[BEAM-10291] Adding full thread dump upon lull detection for Dataflow Java worker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42e0d7a202689c3b306b7aa6dcb498abd1b1790d", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/42e0d7a202689c3b306b7aa6dcb498abd1b1790d", "committedDate": "2020-07-01T15:49:37Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7221e7be61a86e6070837db9ba3afdcbce2ca9", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/ca7221e7be61a86e6070837db9ba3afdcbce2ca9", "committedDate": "2020-07-01T17:25:56Z", "message": "added more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64875cc0ac6dfeaba752ed8fdf6200e9e3ad69ac", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/64875cc0ac6dfeaba752ed8fdf6200e9e3ad69ac", "committedDate": "2020-07-01T17:33:51Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f1eb236a27d4c76feb59078240b99547b65e3e", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/f5f1eb236a27d4c76feb59078240b99547b65e3e", "committedDate": "2020-07-01T17:35:39Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTY4NDgz", "url": "https://github.com/apache/beam/pull/12143#pullrequestreview-444168483", "createdAt": "2020-07-07T19:00:46Z", "commit": {"oid": "f5f1eb236a27d4c76feb59078240b99547b65e3e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTowMDo0NlrOGuLrVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTowNzozNVrOGuL45A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3ODk5OA==", "bodyText": "Instead, add Clock to the constructor above (lines 188-200), make the clock member final, and pass Clock.SYSTEM in the constructor without it?", "url": "https://github.com/apache/beam/pull/12143#discussion_r451078998", "createdAt": "2020-07-07T19:00:46Z", "author": {"login": "pabloem"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowOperationContext.java", "diffHunk": "@@ -194,6 +200,18 @@ public DataflowExecutionState(\n       this.metricsContainer = metricsContainer;\n     }\n \n+    public DataflowExecutionState(\n+        NameContext nameContext,\n+        String stateName,\n+        @Nullable String requestingStepName,\n+        @Nullable Integer inputIndex,\n+        @Nullable MetricsContainer metricsContainer,\n+        ProfileScope profileScope,\n+        Clock clock) {\n+      this(nameContext, stateName, requestingStepName, inputIndex, metricsContainer, profileScope);\n+      this.clock = clock;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f1eb236a27d4c76feb59078240b99547b65e3e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MjQ2OA==", "bodyText": "This means that a full thread dump will happen the very first time a lull is logged. Lulls are not that unusual, right? We want full thread dumps for pipelines that are truly stuck, not for pipelines that are experiencing a slow stage.\nPerhaps we should use the millis argument from reportLull, and only report when millis passes 20 minutes?", "url": "https://github.com/apache/beam/pull/12143#discussion_r451082468", "createdAt": "2020-07-07T19:07:35Z", "author": {"login": "pabloem"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/DataflowOperationContext.java", "diffHunk": "@@ -264,7 +276,49 @@ public void reportLull(Thread trackedThread, long millis) {\n       logRecord.setLoggerName(DataflowOperationContext.LOG.getName());\n \n       // Publish directly in the context of this specific ExecutionState.\n-      DataflowWorkerLoggingInitializer.getLoggingHandler().publish(this, logRecord);\n+      DataflowWorkerLoggingHandler dataflowLoggingHandler =\n+          DataflowWorkerLoggingInitializer.getLoggingHandler();\n+      dataflowLoggingHandler.publish(this, logRecord);\n+\n+      if (shouldLogFullThreadDump()) {\n+        Map<Thread, StackTraceElement[]> threadSet = Thread.getAllStackTraces();\n+        for (Map.Entry<Thread, StackTraceElement[]> entry : threadSet.entrySet()) {\n+          Thread thread = entry.getKey();\n+          StackTraceElement[] stackTrace = entry.getValue();\n+          StringBuilder message = new StringBuilder();\n+          message.append(thread.toString()).append(\":\\n\");\n+          message.append(getStackTraceForLullMessage(stackTrace));\n+          logRecord = new LogRecord(Level.INFO, message.toString());\n+          logRecord.setLoggerName(DataflowOperationContext.LOG.getName());\n+          dataflowLoggingHandler.publish(this, logRecord);\n+        }\n+      }\n+    }\n+\n+    // A full thread dump is performed at most once every 20 minutes.\n+    private static final long LOG_LULL_FULL_THREAD_DUMP_MS = 20 * 60 * 1000;\n+\n+    // Last time when a full thread dump was performed.\n+    private long lastFullThreadDumpMillis = 0;\n+\n+    private boolean shouldLogFullThreadDump() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f1eb236a27d4c76feb59078240b99547b65e3e"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f630afc5de93f6e141aa1be77b554aba4ba63e3", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/4f630afc5de93f6e141aa1be77b554aba4ba63e3", "committedDate": "2020-07-08T15:44:50Z", "message": "Only perform full thread dump when the lull duration is more than 20 minutes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43cc8ecb8abd12a369dc586fe6dbf70f9b1cb99e", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/43cc8ecb8abd12a369dc586fe6dbf70f9b1cb99e", "committedDate": "2020-07-08T16:53:44Z", "message": "Minor constructor change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4b5fa2d8bd983276483b9b36d4063930f533af7", "author": {"user": {"login": "davidyan74", "name": "David Yan"}}, "url": "https://github.com/apache/beam/commit/a4b5fa2d8bd983276483b9b36d4063930f533af7", "committedDate": "2020-07-08T16:56:41Z", "message": "spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3263, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}