{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MzE1MjY1", "number": 11885, "title": "Add a GCThrashingPerPeriod option for MemoryMonitor", "bodyText": "Add a GCThrashingPerPeriod option for MemoryMonitor\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-02T02:41:20Z", "url": "https://github.com/apache/beam/pull/11885", "merged": true, "mergeCommit": {"oid": "043cdfdbb940023a6cf18072cc8eb181bb7182d0"}, "closed": true, "closedAt": "2020-06-03T01:14:23Z", "author": {"login": "aaltay"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnLtxogH2gAyNDI2MzE1MjY1OjFkMzkxNmM5NWUzYWVmNWM3MTEyMDUxNTJiZmE2ZWI1YThmOTUwMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnWWSXgFqTQyMjc3ODUzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/1d3916c95e3aef5c711205152bfa6eb5a8f95007", "committedDate": "2020-06-02T02:48:05Z", "message": "Add an GCThrashingPerPeriod option for MemoryMonitor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1105aea88d338a478734591f24483ac86bf39c54", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/1105aea88d338a478734591f24483ac86bf39c54", "committedDate": "2020-06-02T02:39:27Z", "message": "Add an GCThrashingPerPeriod option for MemoryMonitor"}, "afterCommit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/1d3916c95e3aef5c711205152bfa6eb5a8f95007", "committedDate": "2020-06-02T02:48:05Z", "message": "Add an GCThrashingPerPeriod option for MemoryMonitor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzEwODQ2", "url": "https://github.com/apache/beam/pull/11885#pullrequestreview-422310846", "createdAt": "2020-06-02T03:01:41Z", "commit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMTo0MVrOGdghLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowNDowMlrOGdgjMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDY3MQ==", "bodyText": "Avoid confusion with minus sign, and phrase more in terms of behavior. Maybe something like:\n\nThe GC thrashing threshold percentage. A given period of time is considered \"thrashing\" if this percentage of CPU time is spent in garbage collection. Dataflow will force fail tasks after sustained periods of thrashing.\"\n\nYou could say \"percentage in the range (0.0, 100.0)\" but I think that is redundant.", "url": "https://github.com/apache/beam/pull/11885#discussion_r433594671", "createdAt": "2020-06-02T03:01:41Z", "author": {"login": "kennknowles"}, "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/options/DataflowPipelineDebugOptions.java", "diffHunk": "@@ -192,6 +192,22 @@ public Dataflow create(PipelineOptions options) {\n \n   void setDumpHeapOnOOM(boolean dumpHeapBeforeExit);\n \n+  /**\n+   * The GC thrashing threshold (0.00 - 100.00) for every period to be used by MemoryMonitor. If the\n+   * time spent on garbage collection in one period exceeds this threshold, that period is\n+   * considered to be in GC thrashing.\n+   *\n+   * <p>If {@literal 100} is given as the value, MemoryMonitor will be disabled.\n+   */\n+  @Description(\n+      \"The GC thrashing threshold (0.00 - 100.00) for every period to be used by MemoryMonitor. \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDczMQ==", "bodyText": "Nit: Conventionally I would use 50.0 to emphasize its double-ness.", "url": "https://github.com/apache/beam/pull/11885#discussion_r433594731", "createdAt": "2020-06-02T03:01:57Z", "author": {"login": "kennknowles"}, "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/options/DataflowPipelineDebugOptions.java", "diffHunk": "@@ -192,6 +192,22 @@ public Dataflow create(PipelineOptions options) {\n \n   void setDumpHeapOnOOM(boolean dumpHeapBeforeExit);\n \n+  /**\n+   * The GC thrashing threshold (0.00 - 100.00) for every period to be used by MemoryMonitor. If the\n+   * time spent on garbage collection in one period exceeds this threshold, that period is\n+   * considered to be in GC thrashing.\n+   *\n+   * <p>If {@literal 100} is given as the value, MemoryMonitor will be disabled.\n+   */\n+  @Description(\n+      \"The GC thrashing threshold (0.00 - 100.00) for every period to be used by MemoryMonitor. \"\n+          + \"If the time spent on garbage collection in one period exceeds this threshold, that \"\n+          + \"period is considered to be in GC thrashing.\")\n+  @Default.Double(50)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg5NA==", "bodyText": "Java style is lowercase for fields", "url": "https://github.com/apache/beam/pull/11885#discussion_r433594894", "createdAt": "2020-06-02T03:02:42Z", "author": {"login": "kennknowles"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/util/MemoryMonitor.java", "diffHunk": "@@ -174,6 +167,13 @@ public long totalGCTimeMilliseconds() {\n   /** If true, dump the heap when thrashing or requested. */\n   private final boolean canDumpHeap;\n \n+  /**\n+   * The GC thrashing threshold (0.00 - 100.00) for every period. If the time spent on garbage\n+   * collection in one period exceeds this threshold, that period is considered to be in GC\n+   * thrashing.\n+   */\n+  private final double GCThrashingPercentagePerPeriod;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NTE4NA==", "bodyText": "Nit: this sounds a bit like a warning of user error, when actually it might be what they want. Ok to leave as-is.", "url": "https://github.com/apache/beam/pull/11885#discussion_r433595184", "createdAt": "2020-06-02T03:04:02Z", "author": {"login": "kennknowles"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/util/MemoryMonitor.java", "diffHunk": "@@ -467,6 +474,14 @@ private void shutDownDueToGcThrashing(int thrashingCount) {\n   public void run() {\n     synchronized (waitingForStateChange) {\n       Preconditions.checkState(!isRunning.getAndSet(true), \"already running\");\n+\n+      if (this.GCThrashingPercentagePerPeriod <= 0 || this.GCThrashingPercentagePerPeriod >= 100) {\n+        LOG.warn(\n+            \"GCThrashingPercentagePerPeriod: {} is not valid value. Not starting MemoryMonitor.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3916c95e3aef5c711205152bfa6eb5a8f95007"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fada829a196359e69ebe7552309ce08797c563cc", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/fada829a196359e69ebe7552309ce08797c563cc", "committedDate": "2020-06-02T03:56:40Z", "message": "reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzc4NTMz", "url": "https://github.com/apache/beam/pull/11885#pullrequestreview-422778533", "createdAt": "2020-06-02T15:11:24Z", "commit": {"oid": "fada829a196359e69ebe7552309ce08797c563cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4511, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}