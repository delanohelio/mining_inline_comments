{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzk2NTI5", "number": 13335, "title": "[BEAM-10921]: Fix BEAM-10921 and underlying issues", "bodyText": "Worst issue of BEAM-10921 was clearing the InteractiveEnvironment when other tests were running. This caused the flakiness. Fixing this, it was shown that getting the user_pipeline was broken due to an incorrect assumption that PCollection proto IDs were unique across all pipelines. After fixing this, I found that the pipeline.py clobbers the pipeline reference when doing a run() with different a new pipeline reference given to the run_pipeline() method. Other places also had non-idempotent testing, and a new limiter interface was added to the BackgroundCachingJob.\nThe fixes are, unfortunately, interlinked with each other and a single PR must be made to fix all at once.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-13T19:07:40Z", "url": "https://github.com/apache/beam/pull/13335", "merged": true, "mergeCommit": {"oid": "d7655c12f7e0d575513c937ad53c45fbe1339c2d"}, "closed": true, "closedAt": "2020-11-24T23:34:39Z", "author": {"login": "rohdesamuel"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcMQUaABqjM5OTUwNDkyODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfyObZAFqTUzODA0NDYzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62338e69444f4a00013c1ec102e80a51fdf64856", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/62338e69444f4a00013c1ec102e80a51fdf64856", "committedDate": "2020-11-13T19:02:28Z", "message": "Fix BEAM-10921 and underlying issues"}, "afterCommit": {"oid": "d4a28b955f58263ca81c284c156b57ab20095383", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/d4a28b955f58263ca81c284c156b57ab20095383", "committedDate": "2020-11-13T19:23:29Z", "message": "Fix BEAM-10921 and underlying issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4a28b955f58263ca81c284c156b57ab20095383", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/d4a28b955f58263ca81c284c156b57ab20095383", "committedDate": "2020-11-13T19:23:29Z", "message": "Fix BEAM-10921 and underlying issues"}, "afterCommit": {"oid": "a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "committedDate": "2020-11-13T19:41:56Z", "message": "Fix BEAM-10921 and underlying issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/4de80057c23304d1b9e4d7be01916d8519d5466c", "committedDate": "2020-11-13T20:46:22Z", "message": "Fix BEAM-10921 and underlying issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/a9864ffb7f93e5e143c0e474e76d9c35d6453b18", "committedDate": "2020-11-13T19:41:56Z", "message": "Fix BEAM-10921 and underlying issues"}, "afterCommit": {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/4de80057c23304d1b9e4d7be01916d8519d5466c", "committedDate": "2020-11-13T20:46:22Z", "message": "Fix BEAM-10921 and underlying issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNjM1MDQ0", "url": "https://github.com/apache/beam/pull/13335#pullrequestreview-531635044", "createdAt": "2020-11-16T19:24:39Z", "commit": {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxOToyNDozOVrOH0N-DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxOToyNDozOVrOH0N-DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNjg3Ng==", "bodyText": "LGTM, only one question:\nDoes the UserPipelineTracker clean up the user pipeline and their derived pipelines when a user pipeline is out of scope (e.g., deleted or garbage collected)? Or are the pipelines tracked never get garbage collected at all?\nIs there any side effect when the user uses an outdated pipeline ref or a new pipeline ref (from re-executions) that results in the same __hash__ or __eq__/in to be True? Will that give back a wrong user_pipeline when the tracker thinks the pipeline is tracked while it's not?", "url": "https://github.com/apache/beam/pull/13335#discussion_r524516876", "createdAt": "2020-11-16T19:24:39Z", "author": {"login": "KevinGG"}, "path": "sdks/python/apache_beam/runners/interactive/interactive_environment.py", "diffHunk": "@@ -163,7 +165,8 @@ def __init__(self):\n     # the gRPC server serves.\n     self._test_stream_service_controllers = {}\n     self._cached_source_signature = {}\n-    self._tracked_user_pipelines = set()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de80057c23304d1b9e4d7be01916d8519d5466c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/4821b16ade2fb4411eda0cd81bf20206c4620902", "committedDate": "2020-11-17T01:04:14Z", "message": "Add eviction capabilities to the UserPipelineTracker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzYzNTE0", "url": "https://github.com/apache/beam/pull/13335#pullrequestreview-532763514", "createdAt": "2020-11-17T20:00:35Z", "commit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzA1MTA0", "url": "https://github.com/apache/beam/pull/13335#pullrequestreview-536705104", "createdAt": "2020-11-23T17:40:35Z", "commit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNzo0MDozNVrOH4YfSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNzo0MzowNFrOH4YlCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4MzUyOQ==", "bodyText": "nit: relies -> relies on", "url": "https://github.com/apache/beam/pull/13335#discussion_r528883529", "createdAt": "2020-11-23T17:40:35Z", "author": {"login": "davidyan74"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -504,10 +504,12 @@ def run(self, test_runner_api='AUTO'):\n       if test_runner_api == 'AUTO':\n         # Don't pay the cost of a round-trip if we're going to be going through\n         # the FnApi anyway...\n+        # The InteractiveRunner relies a constant pipeline reference, skip it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NDA2NQ==", "bodyText": "Is there a better way for the runner to indicate it relies on a constant pipeline reference?", "url": "https://github.com/apache/beam/pull/13335#discussion_r528884065", "createdAt": "2020-11-23T17:41:29Z", "author": {"login": "davidyan74"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -504,10 +504,12 @@ def run(self, test_runner_api='AUTO'):\n       if test_runner_api == 'AUTO':\n         # Don't pay the cost of a round-trip if we're going to be going through\n         # the FnApi anyway...\n+        # The InteractiveRunner relies a constant pipeline reference, skip it.\n         test_runner_api = (\n             not self.runner.is_fnapi_compatible() and (\n                 self.runner.__class__.__name__ != 'SwitchingDirectRunner' or\n-                self._options.view_as(StandardOptions).streaming))\n+                self._options.view_as(StandardOptions).streaming) and\n+            self.runner.__class__.__name__ != 'InteractiveRunner')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NTAwMg==", "bodyText": "Should we take this opportunity to update the name according to the new convention? e.g. \"background caching job\" -> \"background source recording job\". It's fine if you plan to do this in a later PR instead.", "url": "https://github.com/apache/beam/pull/13335#discussion_r528885002", "createdAt": "2020-11-23T17:43:04Z", "author": {"login": "davidyan74"}, "path": "sdks/python/apache_beam/runners/interactive/background_caching_job.py", "diffHunk": "@@ -121,7 +121,8 @@ def state(self):\n       return self._pipeline_result.state\n \n \n-def attempt_to_run_background_caching_job(runner, user_pipeline, options=None):\n+def attempt_to_run_background_caching_job(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4821b16ade2fb4411eda0cd81bf20206c4620902"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c0d49893a1b96e4be7a1ec4d4a9aacc18fd682", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/77c0d49893a1b96e4be7a1ec4d4a9aacc18fd682", "committedDate": "2020-11-24T20:20:46Z", "message": "Fix grammar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05525987b6b85e1ea97af79905b0dde4970b874d", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/05525987b6b85e1ea97af79905b0dde4970b874d", "committedDate": "2020-11-24T22:56:28Z", "message": "Clean up logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDM2MzEw", "url": "https://github.com/apache/beam/pull/13335#pullrequestreview-538036310", "createdAt": "2020-11-24T23:01:20Z", "commit": {"oid": "05525987b6b85e1ea97af79905b0dde4970b874d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDQ0NjM1", "url": "https://github.com/apache/beam/pull/13335#pullrequestreview-538044635", "createdAt": "2020-11-24T23:19:55Z", "commit": {"oid": "05525987b6b85e1ea97af79905b0dde4970b874d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4866, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}