{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MzQ1NDA2", "number": 11454, "title": "[BEAM-8871] Support trySplit for ByteKeyRangeTracker", "bodyText": "r: @lukecwik\ncc: @youngoli\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-17T21:19:53Z", "url": "https://github.com/apache/beam/pull/11454", "merged": true, "mergeCommit": {"oid": "28fd5971294c1927f81854cf2841062a10dc171c"}, "closed": true, "closedAt": "2020-04-24T01:54:30Z", "author": {"login": "boyuanzz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYoEm5AFqTM5NTc4MDE3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaj6RFABqjMyNjcwMDk5Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzgwMTcz", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-395780173", "createdAt": "2020-04-17T21:21:30Z", "commit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMToyMTozMFrOGHdd8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMToyMTozMFrOGHdd8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3NjAxOA==", "bodyText": "This is taken from https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/io/range/ByteKeyRangeTest.java#L365-L382", "url": "https://github.com/apache/beam/pull/11454#discussion_r410476018", "createdAt": "2020-04-17T21:21:30Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -287,4 +318,30 @@ public void testBacklogPartiallyCompleted() {\n     tracker.tryClaim(ByteKey.of(0xa0));\n     assertThat(tracker.getSize(), allOf(greaterThan(0.), lessThan(1.)));\n   }\n+\n+  /** Asserts the two ByteKey are equal except trailing zeros. */\n+  private static void assertByteKeyEqualExceptPadding(ByteKey expected, ByteKey key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzg0OTI1", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-395784925", "createdAt": "2020-04-17T21:31:41Z", "commit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozMTo0MVrOGHds7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozMTo0MVrOGHds7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3OTg1NA==", "bodyText": "Should this method then be @Nullable  and/or in the parent class?", "url": "https://github.com/apache/beam/pull/11454#discussion_r410479854", "createdAt": "2020-04-17T21:31:41Z", "author": {"login": "iemejia"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,38 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n-\n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Nzg2MTIz", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-395786123", "createdAt": "2020-04-17T21:34:21Z", "commit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozNDoyMVrOGHdwwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMTozNDoyMVrOGHdwwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4MDgzNA==", "bodyText": "s/starKey/startKey", "url": "https://github.com/apache/beam/pull/11454#discussion_r410480834", "createdAt": "2020-04-17T21:34:21Z", "author": {"login": "iemejia"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/range/ByteKeyRange.java", "diffHunk": "@@ -218,6 +218,10 @@ public double estimateFractionForKey(ByteKey key) {\n   public ByteKey interpolateKey(double fraction) {\n     checkArgument(\n         fraction >= 0.0 && fraction < 1.0, \"Fraction %s must be in the range [0, 1)\", fraction);\n+    // Return starKey when fraction is 0 in order to avoid adding trailing zeros during computation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68ba8266219f2007f6fb1ba9c7c9a5702463e326", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/68ba8266219f2007f6fb1ba9c7c9a5702463e326", "committedDate": "2020-04-17T22:53:20Z", "message": "Update trySplit logic to treat checkpoint specially."}, "afterCommit": {"oid": "a4aa88616399273d0b0e9d6d59be79ad256208ce", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a4aa88616399273d0b0e9d6d59be79ad256208ce", "committedDate": "2020-04-17T22:54:35Z", "message": "Update trySplit logic to treat checkpoint specially."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODc3NjA5", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-395877609", "createdAt": "2020-04-18T03:36:39Z", "commit": {"oid": "13cfe2eec07bf133ba3cd53636bbca5e3b9b4295"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwMzozNjo0MFrOGHkjJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwMzo0MjoxNVrOGHksCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU5MjAzOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * position. Each claimed position should be a valid split point.\n          \n          \n            \n               * position. Each claimed position MUST be a valid split point.", "url": "https://github.com/apache/beam/pull/11454#discussion_r410592039", "createdAt": "2020-04-18T03:36:40Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/RestrictionTracker.java", "diffHunk": "@@ -29,7 +30,7 @@\n public abstract class RestrictionTracker<RestrictionT, PositionT> {\n   /**\n    * Attempts to claim the block of work in the current restriction identified by the given\n-   * position.\n+   * position. Each claimed position should be a valid split point.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cfe2eec07bf133ba3cd53636bbca5e3b9b4295"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU5MzU2Ng==", "bodyText": "We should make it clear that a checkpoint must return a valid split result or null where null represents that there is no residual.", "url": "https://github.com/apache/beam/pull/11454#discussion_r410593566", "createdAt": "2020-04-18T03:40:22Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/RestrictionTracker.java", "diffHunk": "@@ -80,6 +81,7 @@\n    *     represent based upon the current known remaining amount of work.\n    * @return a {@link SplitResult} if a split was possible, otherwise returns {@code null}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cfe2eec07bf133ba3cd53636bbca5e3b9b4295"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU5NDA1Ng==", "bodyText": "Make that method public and call it from this test since they are both in the same module.", "url": "https://github.com/apache/beam/pull/11454#discussion_r410594056", "createdAt": "2020-04-18T03:41:37Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -287,4 +318,30 @@ public void testBacklogPartiallyCompleted() {\n     tracker.tryClaim(ByteKey.of(0xa0));\n     assertThat(tracker.getSize(), allOf(greaterThan(0.), lessThan(1.)));\n   }\n+\n+  /** Asserts the two ByteKey are equal except trailing zeros. */\n+  private static void assertByteKeyEqualExceptPadding(ByteKey expected, ByteKey key) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3NjAxOA=="}, "originalCommit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDU5NDMxMw==", "bodyText": "That works for me.", "url": "https://github.com/apache/beam/pull/11454#discussion_r410594313", "createdAt": "2020-04-18T03:42:15Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,38 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n-\n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ3OTg1NA=="}, "originalCommit": {"oid": "ab5444cdb8606ae98fc9bef52ccfa03de943743f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzYyNDY3", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-399362467", "createdAt": "2020-04-23T18:22:50Z", "commit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODoyMjo1MFrOGK1-Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTowMjowMFrOGK3ivA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMzE4Ng==", "bodyText": "or startKey == endKey", "url": "https://github.com/apache/beam/pull/11454#discussion_r414023186", "createdAt": "2020-04-23T18:22:50Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,56 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzNDg5MQ==", "bodyText": "We should return [startKey, startKey) as the primary unless startKey is \"\" and then we should return NO_KEYS", "url": "https://github.com/apache/beam/pull/11454#discussion_r414034891", "createdAt": "2020-04-23T18:40:17Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,56 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;\n+    }\n+    // There is no more remaining work after the entire range has been claimed.\n+    if (lastAttemptedKey != null && lastAttemptedKey.isEmpty()) {\n+      return null;\n+    }\n \n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    ByteKey startKey = (lastAttemptedKey == null) ? range.getStartKey() : next(lastAttemptedKey);\n+    ByteKey endKey = range.getEndKey();\n+    // There is no more space for split.\n+    if (!endKey.isEmpty() && startKey.compareTo(endKey) >= 0) {\n+      return null;\n     }\n \n-    // Return an empty range if the current range is done.\n-    if (lastAttemptedKey.isEmpty()\n-        || !(range.getEndKey().isEmpty() || range.getEndKey().compareTo(lastAttemptedKey) > 0)) {\n-      return SplitResult.of(range, NO_KEYS);\n+    // Treat checkpoint specially because {@link ByteKeyRange#interpolateKey} computes a key with\n+    // trailing zeros when fraction is 0.\n+    if (fractionOfRemainder == 0.0) {\n+      // If we haven't done any work, we should return the original range we were processing\n+      // as the checkpoint.\n+      if (lastAttemptedKey == null) {\n+        // We update our current range to an interval that contains no elements.\n+        ByteKeyRange rval = range;\n+        range = NO_KEYS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzODEyMA==", "bodyText": "I would get rid of this local variable since its not being computed and is always range.getEndKey(). We can see that it doesn't add value since you use range.getEndKey() and not endKey below.", "url": "https://github.com/apache/beam/pull/11454#discussion_r414038120", "createdAt": "2020-04-23T18:45:22Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,56 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;\n+    }\n+    // There is no more remaining work after the entire range has been claimed.\n+    if (lastAttemptedKey != null && lastAttemptedKey.isEmpty()) {\n+      return null;\n+    }\n \n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    ByteKey startKey = (lastAttemptedKey == null) ? range.getStartKey() : next(lastAttemptedKey);\n+    ByteKey endKey = range.getEndKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzODI3Ng==", "bodyText": "startKey -> unprocessedRangeStartKey", "url": "https://github.com/apache/beam/pull/11454#discussion_r414038276", "createdAt": "2020-04-23T18:45:36Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,56 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;\n+    }\n+    // There is no more remaining work after the entire range has been claimed.\n+    if (lastAttemptedKey != null && lastAttemptedKey.isEmpty()) {\n+      return null;\n+    }\n \n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    ByteKey startKey = (lastAttemptedKey == null) ? range.getStartKey() : next(lastAttemptedKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzOTQ3MA==", "bodyText": "compare whether splitPos >= range.getEndKey()", "url": "https://github.com/apache/beam/pull/11454#discussion_r414039470", "createdAt": "2020-04-23T18:47:30Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -64,31 +64,56 @@ public ByteKeyRange currentRestriction() {\n \n   @Override\n   public SplitResult<ByteKeyRange> trySplit(double fractionOfRemainder) {\n-    // TODO(BEAM-8871): Add support for splitting off a fixed amount of work for this restriction\n-    // instead of only supporting checkpointing.\n+    // No split on an empty range.\n+    if (NO_KEYS.equals(range)) {\n+      return null;\n+    }\n+    // There is no more remaining work after the entire range has been claimed.\n+    if (lastAttemptedKey != null && lastAttemptedKey.isEmpty()) {\n+      return null;\n+    }\n \n-    // If we haven't done any work, we should return the original range we were processing\n-    // as the checkpoint.\n-    if (lastAttemptedKey == null) {\n-      ByteKeyRange rval = range;\n-      // We update our current range to an interval that contains no elements.\n-      range = NO_KEYS;\n-      return SplitResult.of(range, rval);\n+    ByteKey startKey = (lastAttemptedKey == null) ? range.getStartKey() : next(lastAttemptedKey);\n+    ByteKey endKey = range.getEndKey();\n+    // There is no more space for split.\n+    if (!endKey.isEmpty() && startKey.compareTo(endKey) >= 0) {\n+      return null;\n     }\n \n-    // Return an empty range if the current range is done.\n-    if (lastAttemptedKey.isEmpty()\n-        || !(range.getEndKey().isEmpty() || range.getEndKey().compareTo(lastAttemptedKey) > 0)) {\n-      return SplitResult.of(range, NO_KEYS);\n+    // Treat checkpoint specially because {@link ByteKeyRange#interpolateKey} computes a key with\n+    // trailing zeros when fraction is 0.\n+    if (fractionOfRemainder == 0.0) {\n+      // If we haven't done any work, we should return the original range we were processing\n+      // as the checkpoint.\n+      if (lastAttemptedKey == null) {\n+        // We update our current range to an interval that contains no elements.\n+        ByteKeyRange rval = range;\n+        range = NO_KEYS;\n+        return SplitResult.of(range, rval);\n+      } else {\n+        range = ByteKeyRange.of(range.getStartKey(), startKey);\n+        return SplitResult.of(range, ByteKeyRange.of(startKey, endKey));\n+      }\n     }\n \n-    // Otherwise we compute the \"remainder\" of the range from the last key.\n-    assert lastAttemptedKey.equals(lastClaimedKey)\n-        : \"Expect both keys to be equal since the last key attempted was a valid key in the range.\";\n-    ByteKey nextKey = next(lastAttemptedKey);\n-    ByteKeyRange res = ByteKeyRange.of(nextKey, range.getEndKey());\n-    this.range = ByteKeyRange.of(range.getStartKey(), nextKey);\n-    return SplitResult.of(range, res);\n+    ByteKeyRange unprocessedRange = ByteKeyRange.of(startKey, range.getEndKey());\n+    ByteKey splitPos;\n+    try {\n+      // The interpolateKey shouldn't return empty key. Please refer to {@link\n+      // ByteKeyRange#interpolateKey}.\n+      splitPos = unprocessedRange.interpolateKey(fractionOfRemainder);\n+      checkState(!splitPos.isEmpty());\n+    } catch (Exception e) {\n+      // There is no way to interpolate a key based on provided fraction.\n+      return null;\n+    }\n+    // Computed splitPos is out of current tracking restriction.\n+    if (!range.getEndKey().isEmpty() && splitPos.equals(range.getEndKey())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzOTczMg==", "bodyText": "We should cover the case where start == end at the NO_KEYS check at the top since it would be valid to be done and not have attempted anything because of how checkpoint is implemented.", "url": "https://github.com/apache/beam/pull/11454#discussion_r414039732", "createdAt": "2020-04-23T18:47:55Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTracker.java", "diffHunk": "@@ -156,6 +181,11 @@ public void checkDone() throws IllegalStateException {\n       return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0Mjc1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @return a {@link SplitResult} if a split was possible, otherwise returns {@code null}. A\n          \n          \n            \n               *     checkpoint(fractionOfRemainder == 0) must either return a valid split result or null which\n          \n          \n            \n               *     means there is no more left work.\n          \n          \n            \n               * @return a {@link SplitResult} if a split was possible, otherwise returns {@code null}. If the {@code fractionOfRemainder == 0}, a {@code null} result MUST imply that the restriction tracker is done and there is no more work left to do.", "url": "https://github.com/apache/beam/pull/11454#discussion_r414042759", "createdAt": "2020-04-23T18:52:26Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/RestrictionTracker.java", "diffHunk": "@@ -78,8 +79,11 @@\n    *\n    * @param fractionOfRemainder A hint as to the fraction of work the primary restriction should\n    *     represent based upon the current known remaining amount of work.\n-   * @return a {@link SplitResult} if a split was possible, otherwise returns {@code null}.\n+   * @return a {@link SplitResult} if a split was possible, otherwise returns {@code null}. A\n+   *     checkpoint(fractionOfRemainder == 0) must either return a valid split result or null which\n+   *     means there is no more left work.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0NDAxNg==", "bodyText": "Add a tryClaim test for empty ranges covering NO_KEYS and when startKey == endKey", "url": "https://github.com/apache/beam/pull/11454#discussion_r414044016", "createdAt": "2020-04-23T18:54:27Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -50,6 +52,7 @@ public void testTryClaim() throws Exception {\n     assertTrue(tracker.tryClaim(ByteKey.of(0x50)));\n     assertTrue(tracker.tryClaim(ByteKey.of(0x99)));\n     assertFalse(tracker.tryClaim(ByteKey.of(0xc0)));\n+    tracker.checkDone();\n   }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0ODAzMg==", "bodyText": "Why is the primary here 0x00 for the start key and not ByteKey.EMPTY?", "url": "https://github.com/apache/beam/pull/11454#discussion_r414048032", "createdAt": "2020-04-23T19:00:38Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -152,9 +158,35 @@ public void testCheckpointAfterLastUsingEmptyKey() throws Exception {\n     assertTrue(tracker.tryClaim(ByteKey.of(0x90)));\n     assertTrue(tracker.tryClaim(ByteKey.of(0xa0)));\n     assertFalse(tracker.tryClaim(ByteKey.EMPTY));\n-    ByteKeyRange checkpoint = tracker.trySplit(0).getResidual();\n+    assertNull(tracker.trySplit(0));\n     assertEquals(ByteKeyRange.of(ByteKey.of(0x10), ByteKey.of(0xc0)), tracker.currentRestriction());\n-    assertEquals(ByteKeyRangeTracker.NO_KEYS, checkpoint);\n+    tracker.checkDone();\n+  }\n+\n+  @Test\n+  public void testTrySplit() throws Exception {\n+    ByteKeyRangeTracker tracker =\n+        ByteKeyRangeTracker.of(ByteKeyRange.of(ByteKey.EMPTY, ByteKey.of(0x80)));\n+    SplitResult<ByteKeyRange> res = tracker.trySplit(0.5);\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.EMPTY, ByteKey.of(0x40)), res.getPrimary());\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.of(0x40), ByteKey.of(0x80)), res.getResidual());\n+    tracker.tryClaim(ByteKey.of(0x00));\n+    res = tracker.trySplit(0.5);\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.of(0x00), ByteKey.of(0x20)), res.getPrimary());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0ODIyNQ==", "bodyText": "Start with the ALL_KEYS range.", "url": "https://github.com/apache/beam/pull/11454#discussion_r414048225", "createdAt": "2020-04-23T19:00:57Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -152,9 +158,35 @@ public void testCheckpointAfterLastUsingEmptyKey() throws Exception {\n     assertTrue(tracker.tryClaim(ByteKey.of(0x90)));\n     assertTrue(tracker.tryClaim(ByteKey.of(0xa0)));\n     assertFalse(tracker.tryClaim(ByteKey.EMPTY));\n-    ByteKeyRange checkpoint = tracker.trySplit(0).getResidual();\n+    assertNull(tracker.trySplit(0));\n     assertEquals(ByteKeyRange.of(ByteKey.of(0x10), ByteKey.of(0xc0)), tracker.currentRestriction());\n-    assertEquals(ByteKeyRangeTracker.NO_KEYS, checkpoint);\n+    tracker.checkDone();\n+  }\n+\n+  @Test\n+  public void testTrySplit() throws Exception {\n+    ByteKeyRangeTracker tracker =\n+        ByteKeyRangeTracker.of(ByteKeyRange.of(ByteKey.EMPTY, ByteKey.of(0x80)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0ODk1Ng==", "bodyText": "Cover the case where startKey == endKey and also add a call for trySplit at 0.5", "url": "https://github.com/apache/beam/pull/11454#discussion_r414048956", "createdAt": "2020-04-23T19:02:00Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/splittabledofn/ByteKeyRangeTrackerTest.java", "diffHunk": "@@ -152,9 +158,35 @@ public void testCheckpointAfterLastUsingEmptyKey() throws Exception {\n     assertTrue(tracker.tryClaim(ByteKey.of(0x90)));\n     assertTrue(tracker.tryClaim(ByteKey.of(0xa0)));\n     assertFalse(tracker.tryClaim(ByteKey.EMPTY));\n-    ByteKeyRange checkpoint = tracker.trySplit(0).getResidual();\n+    assertNull(tracker.trySplit(0));\n     assertEquals(ByteKeyRange.of(ByteKey.of(0x10), ByteKey.of(0xc0)), tracker.currentRestriction());\n-    assertEquals(ByteKeyRangeTracker.NO_KEYS, checkpoint);\n+    tracker.checkDone();\n+  }\n+\n+  @Test\n+  public void testTrySplit() throws Exception {\n+    ByteKeyRangeTracker tracker =\n+        ByteKeyRangeTracker.of(ByteKeyRange.of(ByteKey.EMPTY, ByteKey.of(0x80)));\n+    SplitResult<ByteKeyRange> res = tracker.trySplit(0.5);\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.EMPTY, ByteKey.of(0x40)), res.getPrimary());\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.of(0x40), ByteKey.of(0x80)), res.getResidual());\n+    tracker.tryClaim(ByteKey.of(0x00));\n+    res = tracker.trySplit(0.5);\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.of(0x00), ByteKey.of(0x20)), res.getPrimary());\n+    assertKeyRangeEqualExceptPadding(\n+        ByteKeyRange.of(ByteKey.of(0x20), ByteKey.of(0x40)), res.getResidual());\n+    assertNull(tracker.trySplit(1));\n+  }\n+\n+  @Test\n+  public void testTrySplitAtEmptyRange() throws Exception {\n+    ByteKeyRangeTracker tracker = ByteKeyRangeTracker.of(ByteKeyRangeTracker.NO_KEYS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cf62fb0bb060005ffaa196c543743b321e3279"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDgzNzQw", "url": "https://github.com/apache/beam/pull/11454#pullrequestreview-399483740", "createdAt": "2020-04-23T21:17:32Z", "commit": {"oid": "a4a8d06e8cbe4591e777fe121d31fea8704c93fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4a8d06e8cbe4591e777fe121d31fea8704c93fb", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a4a8d06e8cbe4591e777fe121d31fea8704c93fb", "committedDate": "2020-04-23T21:07:49Z", "message": "Update RestrictionTracker comment as suggested."}, "afterCommit": {"oid": "6e0bdbde1a177db22ea6081c11082cd3c9759fdc", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6e0bdbde1a177db22ea6081c11082cd3c9759fdc", "committedDate": "2020-04-23T21:31:01Z", "message": "[BEAM-8871] Support trySplit for ByteKeyRangeTracker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89958d8311b7225be51f3d86f03cb58581279372", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/89958d8311b7225be51f3d86f03cb58581279372", "committedDate": "2020-04-23T21:38:17Z", "message": "[BEAM-8871] Support trySplit for ByteKeyRangeTracker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e0bdbde1a177db22ea6081c11082cd3c9759fdc", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6e0bdbde1a177db22ea6081c11082cd3c9759fdc", "committedDate": "2020-04-23T21:31:01Z", "message": "[BEAM-8871] Support trySplit for ByteKeyRangeTracker"}, "afterCommit": {"oid": "89958d8311b7225be51f3d86f03cb58581279372", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/89958d8311b7225be51f3d86f03cb58581279372", "committedDate": "2020-04-23T21:38:17Z", "message": "[BEAM-8871] Support trySplit for ByteKeyRangeTracker"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4300, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}