{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDE3NDc5", "number": 11911, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNToxNDozOFrOEE7ygw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNzowMFrOEIJ7kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNjA5MzQ3OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwNToxNDozOFrOGi3SKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMjowMDowMlrOGmkL3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA==", "bodyText": "Do we only care about IllegalStateException  here? It seems like other exceptions might also be thrown.", "url": "https://github.com/apache/beam/pull/11911#discussion_r439210538", "createdAt": "2020-06-12T05:14:38Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MzYyNA==", "bodyText": "Instead of adding this try catch, we should update the handler to not throw the exception in the first place.\nHere: \n  \n    \n      beam/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java\n    \n    \n         Line 378\n      in\n      bca893e\n    \n    \n    \n    \n\n        \n          \n           public BeamFnApi.InstructionResponse.Builder trySplit(BeamFnApi.InstructionRequest request) { \n        \n    \n  \n\n\nHere: \n  \n    \n      beam/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java\n    \n    \n         Line 344\n      in\n      bca893e\n    \n    \n    \n    \n\n        \n          \n           if (bundleProcessor == null) { \n        \n    \n  \n\n\nWe should add a simple unit test that covers this as well.", "url": "https://github.com/apache/beam/pull/11911#discussion_r442563624", "createdAt": "2020-06-19T00:04:24Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2NjUzOQ==", "bodyText": "I don't think that will resolve the issue of runner waiting for a response here and timing out (with a bad error in the case of Dataflow).\nHow about catching all exceptions here and sending a error response to the runner set here: https://github.com/apache/beam/blob/master/model/fn-execution/src/main/proto/beam_fn_api.proto#L129\n?", "url": "https://github.com/apache/beam/pull/11911#discussion_r442566539", "createdAt": "2020-06-19T00:15:34Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2ODA5MQ==", "bodyText": "Nvm, we already do it here: https://github.com/apache/beam/blob/master/sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java#L182\nI'm looking more closely at this now. Sorry about the delay.", "url": "https://github.com/apache/beam/pull/11911#discussion_r442568091", "createdAt": "2020-06-19T00:21:55Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTMzOA==", "bodyText": "I would suggest sending back an empty successful response instead of throwing an error. Empty progress/split responses are no-ops from the runners side.", "url": "https://github.com/apache/beam/pull/11911#discussion_r442969338", "createdAt": "2020-06-19T17:42:52Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2OTc2OA==", "bodyText": "It took me forever to get to this PR so I wouldn't worry about the delay.", "url": "https://github.com/apache/beam/pull/11911#discussion_r442969768", "createdAt": "2020-06-19T17:43:53Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MTkzNQ==", "bodyText": "Updated to send an empty successful response instead of failing. Also added unit tests.", "url": "https://github.com/apache/beam/pull/11911#discussion_r443091935", "createdAt": "2020-06-20T02:00:02Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/BeamFnControlClient.java", "diffHunk": "@@ -159,6 +159,16 @@ public void processInstructionRequests(Executor executor)\n             } catch (Error e) {\n               sendErrorResponse(e);\n               throw e;\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIxMDUzOA=="}, "originalCommit": {"oid": "fcbcf9e3cf00a4a940ada058634f0a500d6c1fd1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTg2MTIxOnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNDowMVrOGn8rew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozNjowN1rOGoiMig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTgxOQ==", "bodyText": "validate the contents of the response", "url": "https://github.com/apache/beam/pull/11911#discussion_r444541819", "createdAt": "2020-06-23T22:24:01Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NjQ5MA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445156490", "createdAt": "2020-06-24T20:36:07Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTgxOQ=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTg2MTM2OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNDowNFrOGn8rlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozNTozNFrOGoiLVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTg0NQ==", "bodyText": "validate the contents of the response", "url": "https://github.com/apache/beam/pull/11911#discussion_r444541845", "createdAt": "2020-06-23T22:24:04Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(\n+        BeamFnApi.InstructionRequest.newBuilder()\n+            .setInstructionId(\"999L\")\n+            .setProcessBundleSplit(\n+                BeamFnApi.ProcessBundleSplitRequest.newBuilder().setInstructionId(\"unknown-id\"))\n+            .build());\n+  }\n+\n+  @Test\n+  public void testProgressBeforeBundleDoesNotFail() throws Exception {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.progress(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NjE4MQ==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445156181", "createdAt": "2020-06-24T20:35:34Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/control/ProcessBundleHandlerTest.java", "diffHunk": "@@ -260,6 +260,46 @@ BundleProcessor get(\n     }\n   }\n \n+  @Test\n+  public void testTrySplitBeforeBundleDoesNotFail() {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.trySplit(\n+        BeamFnApi.InstructionRequest.newBuilder()\n+            .setInstructionId(\"999L\")\n+            .setProcessBundleSplit(\n+                BeamFnApi.ProcessBundleSplitRequest.newBuilder().setInstructionId(\"unknown-id\"))\n+            .build());\n+  }\n+\n+  @Test\n+  public void testProgressBeforeBundleDoesNotFail() throws Exception {\n+    ProcessBundleHandler handler =\n+        new ProcessBundleHandler(\n+            PipelineOptionsFactory.create(),\n+            null,\n+            beamFnDataClient,\n+            null /* beamFnStateClient */,\n+            null /* finalizeBundleHandler */,\n+            ImmutableMap.of(),\n+            new BundleProcessorCache());\n+\n+    handler.progress(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0MTg0NQ=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTg2NzY4OnYy", "diffSide": "LEFT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoyNzowMFrOGn8vhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozMzo0N1rOGoiHvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0Mjg1Mw==", "bodyText": "nit, you could remove the level of nesting by using a guard statement (here and below):\nif (bundleProcessor == null) {\n  return BeamFnApi.InstructionResponse.newBuilder().setProcessBundleProgress(BeamFnApi.ProcessBundleProgressResponse.getDefaultInstance());\n}", "url": "https://github.com/apache/beam/pull/11911#discussion_r444542853", "createdAt": "2020-06-23T22:27:00Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -341,53 +341,52 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       throws Exception {\n     BundleProcessor bundleProcessor =\n         bundleProcessorCache.find(request.getProcessBundleProgress().getInstructionId());\n-    if (bundleProcessor == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1NTI2MA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/11911#discussion_r445155260", "createdAt": "2020-06-24T20:33:47Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -341,53 +341,52 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       throws Exception {\n     BundleProcessor bundleProcessor =\n         bundleProcessorCache.find(request.getProcessBundleProgress().getInstructionId());\n-    if (bundleProcessor == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU0Mjg1Mw=="}, "originalCommit": {"oid": "c14f537e1997a3978dae8ffd80589f5e80a56c3b"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3602, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}