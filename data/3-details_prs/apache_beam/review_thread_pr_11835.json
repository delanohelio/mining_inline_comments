{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDQ1NDQx", "number": 11835, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOToxOTo1MFrOEApBZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOToxOTo1MFrOEApBZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MTA3NTU3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/trigger_test.py", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOToxOTo1MFrOGcDJnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoxOTo0MlrOGel2bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NDkyNA==", "bodyText": "Never trigger is misnamed. It means that the trigger itself never fires, but that at window GC output is produced. That's why PAssert uses it to gather the full result.", "url": "https://github.com/apache/beam/pull/11835#discussion_r432064924", "createdAt": "2020-05-28T19:19:50Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/trigger_test.py", "diffHunk": "@@ -518,6 +519,28 @@ def format_result(k_v):\n                   'B-3': {10, 15, 16},\n               }.items())))\n \n+  def test_never(self):\n+    with TestPipeline() as p:\n+\n+      def construct_timestamped(k_t):\n+        return TimestampedValue((k_t[0], k_t[1]), k_t[1])\n+\n+      def format_result(k_v):\n+        return ('%s-%s' % (k_v[0], len(k_v[1])), set(k_v[1]))\n+\n+      result = (\n+          p\n+          | beam.Create([1, 1, 2, 3, 4, 5, 10, 11])\n+          | beam.FlatMap(lambda t: [('A', t), ('B', t + 5)])\n+          | beam.Map(construct_timestamped)\n+          | beam.WindowInto(\n+              FixedWindows(10),\n+              trigger=Never(),\n+              accumulation_mode=AccumulationMode.DISCARDING)\n+          | beam.GroupByKey()\n+          | beam.Map(format_result))\n+      assert_that(result, equal_to([]))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c05629dce4e5539d1089c79d5f81831b906e67"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA5MzIzNw==", "bodyText": "Ack. (Interestingly, I originally was expecting it to fire at EoW.) The ULR doesn't yet support gc timers. I can look into fixing this (or at least making the \"Never\" trigger correct).\nAs an aside, the non-trivial triggering and windowing in PAssert makes it less than ideal for validating new runners.", "url": "https://github.com/apache/beam/pull/11835#discussion_r432093237", "createdAt": "2020-05-28T20:05:53Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/trigger_test.py", "diffHunk": "@@ -518,6 +519,28 @@ def format_result(k_v):\n                   'B-3': {10, 15, 16},\n               }.items())))\n \n+  def test_never(self):\n+    with TestPipeline() as p:\n+\n+      def construct_timestamped(k_t):\n+        return TimestampedValue((k_t[0], k_t[1]), k_t[1])\n+\n+      def format_result(k_v):\n+        return ('%s-%s' % (k_v[0], len(k_v[1])), set(k_v[1]))\n+\n+      result = (\n+          p\n+          | beam.Create([1, 1, 2, 3, 4, 5, 10, 11])\n+          | beam.FlatMap(lambda t: [('A', t), ('B', t + 5)])\n+          | beam.Map(construct_timestamped)\n+          | beam.WindowInto(\n+              FixedWindows(10),\n+              trigger=Never(),\n+              accumulation_mode=AccumulationMode.DISCARDING)\n+          | beam.GroupByKey()\n+          | beam.Map(format_result))\n+      assert_that(result, equal_to([]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NDkyNA=="}, "originalCommit": {"oid": "85c05629dce4e5539d1089c79d5f81831b906e67"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5ODI0NQ==", "bodyText": "I couldn't find an existing bug about closing behaviors, so I filed BEAM-10149. That seems pretty invasive to change as part of this PR, so I added a hack to support its use with proper closing behavior in batch only. PTAL.", "url": "https://github.com/apache/beam/pull/11835#discussion_r432198245", "createdAt": "2020-05-29T00:42:51Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/trigger_test.py", "diffHunk": "@@ -518,6 +519,28 @@ def format_result(k_v):\n                   'B-3': {10, 15, 16},\n               }.items())))\n \n+  def test_never(self):\n+    with TestPipeline() as p:\n+\n+      def construct_timestamped(k_t):\n+        return TimestampedValue((k_t[0], k_t[1]), k_t[1])\n+\n+      def format_result(k_v):\n+        return ('%s-%s' % (k_v[0], len(k_v[1])), set(k_v[1]))\n+\n+      result = (\n+          p\n+          | beam.Create([1, 1, 2, 3, 4, 5, 10, 11])\n+          | beam.FlatMap(lambda t: [('A', t), ('B', t + 5)])\n+          | beam.Map(construct_timestamped)\n+          | beam.WindowInto(\n+              FixedWindows(10),\n+              trigger=Never(),\n+              accumulation_mode=AccumulationMode.DISCARDING)\n+          | beam.GroupByKey()\n+          | beam.Map(format_result))\n+      assert_that(result, equal_to([]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NDkyNA=="}, "originalCommit": {"oid": "85c05629dce4e5539d1089c79d5f81831b906e67"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMjY2OA==", "bodyText": "Good point about that in PAssert. Though isn't the triggering just \"fire at GC\" and the windowing nothing special? Previously, it depended on side inputs which tend to come later in a runner's lifecycle.", "url": "https://github.com/apache/beam/pull/11835#discussion_r434012668", "createdAt": "2020-06-02T16:28:41Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/trigger_test.py", "diffHunk": "@@ -518,6 +519,28 @@ def format_result(k_v):\n                   'B-3': {10, 15, 16},\n               }.items())))\n \n+  def test_never(self):\n+    with TestPipeline() as p:\n+\n+      def construct_timestamped(k_t):\n+        return TimestampedValue((k_t[0], k_t[1]), k_t[1])\n+\n+      def format_result(k_v):\n+        return ('%s-%s' % (k_v[0], len(k_v[1])), set(k_v[1]))\n+\n+      result = (\n+          p\n+          | beam.Create([1, 1, 2, 3, 4, 5, 10, 11])\n+          | beam.FlatMap(lambda t: [('A', t), ('B', t + 5)])\n+          | beam.Map(construct_timestamped)\n+          | beam.WindowInto(\n+              FixedWindows(10),\n+              trigger=Never(),\n+              accumulation_mode=AccumulationMode.DISCARDING)\n+          | beam.GroupByKey()\n+          | beam.Map(format_result))\n+      assert_that(result, equal_to([]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NDkyNA=="}, "originalCommit": {"oid": "85c05629dce4e5539d1089c79d5f81831b906e67"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMDYwNg==", "bodyText": "I think even the concept of GC triggers (which have to be scheduled at a different time than a \"normal\" trigger at EOW) and late data is rather advanced. Also, yes, it used a custom (java serializable) WindowFn (didn't investigate which one this was). Possibly the right thing to do here would be to use \"standard\" triggers for the normal case, and advanced features when needed, assuming they can be queried at pipeline construction time. But this is completely an aside.\nThanks for the review. I discovered another couple of issues when running the full suite; I'll get them into separate PRs.", "url": "https://github.com/apache/beam/pull/11835#discussion_r434730606", "createdAt": "2020-06-03T17:19:42Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/trigger_test.py", "diffHunk": "@@ -518,6 +519,28 @@ def format_result(k_v):\n                   'B-3': {10, 15, 16},\n               }.items())))\n \n+  def test_never(self):\n+    with TestPipeline() as p:\n+\n+      def construct_timestamped(k_t):\n+        return TimestampedValue((k_t[0], k_t[1]), k_t[1])\n+\n+      def format_result(k_v):\n+        return ('%s-%s' % (k_v[0], len(k_v[1])), set(k_v[1]))\n+\n+      result = (\n+          p\n+          | beam.Create([1, 1, 2, 3, 4, 5, 10, 11])\n+          | beam.FlatMap(lambda t: [('A', t), ('B', t + 5)])\n+          | beam.Map(construct_timestamped)\n+          | beam.WindowInto(\n+              FixedWindows(10),\n+              trigger=Never(),\n+              accumulation_mode=AccumulationMode.DISCARDING)\n+          | beam.GroupByKey()\n+          | beam.Map(format_result))\n+      assert_that(result, equal_to([]))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NDkyNA=="}, "originalCommit": {"oid": "85c05629dce4e5539d1089c79d5f81831b906e67"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3720, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}