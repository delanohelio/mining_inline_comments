{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODcyNjc1", "number": 13550, "title": "[BEAM-11458] Upgrade SamzRunner to Samza 1.5", "bodyText": "Samza 1.5 support\nPrepare for Async ParDo (BEAM-6550)\nMemory usage optimization for event time timers\nTestStream support\n\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-12-14T23:48:52Z", "url": "https://github.com/apache/beam/pull/13550", "merged": true, "mergeCommit": {"oid": "3663e03644f44966ecd873c41f60186565893657"}, "closed": true, "closedAt": "2020-12-18T00:13:27Z", "author": {"login": "kw2542"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmOhUIgH2gAyNTM5ODcyNjc1OjUzZmZhZWI5YWY0NTNiZmU0ZDY0YjMxNTQyMzQ3ODZhY2I3NGZmZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnMxSvgFqTU1NTA4Njc1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53ffaeb9af453bfe4d64b3154234786acb74ffea", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/53ffaeb9af453bfe4d64b3154234786acb74ffea", "committedDate": "2020-12-14T23:41:25Z", "message": "[BEAM-11458] Backport Samza Runner Changes\n\n1. Samza 1.5 support\n2. Prepare for Async ParDo (BEAM-6550)\n3. Memory usage optimization for event time timers\n4. TestStream support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2", "committedDate": "2020-12-15T01:18:04Z", "message": "Fix KeyedTimerData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6c5b1b0463626f0650bb88f0fc0f6c97419e32b", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/e6c5b1b0463626f0650bb88f0fc0f6c97419e32b", "committedDate": "2020-12-15T18:06:01Z", "message": "Suppress keyFor error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzExMzM3", "url": "https://github.com/apache/beam/pull/13550#pullrequestreview-552711337", "createdAt": "2020-12-15T17:44:03Z", "commit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNzo0NDowM1rOIGX2xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODoyOToxMlrOIGZyKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1MzIyMw==", "bodyText": "we already have commons_lang3 in the compile path. I think we can remove this.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543553223", "createdAt": "2020-12-15T17:44:03Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/build.gradle", "diffHunk": "@@ -64,6 +70,7 @@ dependencies {\n   compile \"org.apache.kafka:kafka-clients:0.11.0.2\"\n   testCompile project(path: \":sdks:java:core\", configuration: \"shadowTest\")\n   testCompile project(path: \":runners:core-java\", configuration: \"testRuntime\")\n+  testCompile library.java.commons_lang3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1ODMwNw==", "bodyText": "Better naming for this. Suggest using a new package,e.g. ...runners.samza.cluster., and remove Beam from the class name as it's confusing for other runners.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543558307", "createdAt": "2020-12-15T17:51:04Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/BeamJobCoordinatorRunner.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.runners.samza;\n+\n+import java.time.Duration;\n+import org.apache.samza.application.SamzaApplication;\n+import org.apache.samza.application.descriptors.ApplicationDescriptor;\n+import org.apache.samza.clustermanager.JobCoordinatorLaunchUtil;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.context.ExternalContext;\n+import org.apache.samza.job.ApplicationStatus;\n+import org.apache.samza.runtime.ApplicationRunner;\n+\n+/** Runs on Yarn AM, execute planning and launches JobCoordinator. */\n+public class BeamJobCoordinatorRunner implements ApplicationRunner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MDk4Mw==", "bodyText": "@Zhangyx39 discussed this change, along with the changes in MetricsEnvironment.java, in open source before. Please sync up with him about how do we want to proceed. Please keep the metrics change out of the scope of this RB.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543560983", "createdAt": "2020-12-15T17:54:42Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/SamzaExecutionContext.java", "diffHunk": "@@ -178,7 +179,11 @@ public SamzaExecutionContext create(\n \n       final MetricsRegistryMap metricsRegistry =\n           (MetricsRegistryMap) containerContext.getContainerMetricsRegistry();\n-      SamzaExecutionContext.this.setMetricsContainer(new SamzaMetricsContainer(metricsRegistry));\n+      SamzaMetricsContainer samzaMetricsContainer =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2MzExNQ==", "bodyText": "Seems this can just be a local var instead of holding it as member.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543563115", "createdAt": "2020-12-15T17:57:31Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/SamzaJobServerDriver.java", "diffHunk": "@@ -37,16 +38,17 @@\n import org.slf4j.LoggerFactory;\n \n /** Driver program that starts a job server. */\n-// TODO extend JobServerDriver\n+// TODO(BEAM-8510): extend JobServerDriver\n @SuppressWarnings({\n   \"nullness\" // TODO(https://issues.apache.org/jira/browse/BEAM-10402)\n })\n public class SamzaJobServerDriver {\n   private static final Logger LOG = LoggerFactory.getLogger(SamzaJobServerDriver.class);\n \n   private final SamzaPortablePipelineOptions pipelineOptions;\n+  private ExpansionServer expansionServer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NDQ2MQ==", "bodyText": "final for all the vars (this and below).", "url": "https://github.com/apache/beam/pull/13550#discussion_r543564461", "createdAt": "2020-12-15T17:59:27Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/SamzaJobServerDriver.java", "diffHunk": "@@ -100,17 +94,46 @@ protected JobInvocation invokeWithExecutor(\n         InMemoryJobService.DEFAULT_MAX_INVOCATION_HISTORY);\n   }\n \n+  private ExpansionServer createExpansionService(String host, int expansionPort)\n+      throws IOException {\n+    if (host == null) {\n+      host = InetAddress.getLoopbackAddress().getHostName();\n+    }\n+    ExpansionServer expansionServer =\n+        ExpansionServer.create(new ExpansionService(), host, expansionPort);\n+    LOG.info(\n+        \"Java ExpansionService started on {}:{}\",\n+        expansionServer.getHost(),\n+        expansionServer.getPort());\n+    return expansionServer;\n+  }\n+\n   public void run() throws Exception {\n-    final InMemoryJobService service = createJobService(pipelineOptions);\n-    final GrpcFnServer<InMemoryJobService> jobServiceGrpcFnServer =\n+    // Create services\n+    InMemoryJobService service = createJobService();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NjU5MQ==", "bodyText": "keep this as private? Otherwise move it to a util class.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543566591", "createdAt": "2020-12-15T18:02:19Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/adapter/BoundedSourceSystem.java", "diffHunk": "@@ -439,16 +438,14 @@ public SystemAdmin getAdmin(String systemName, Config config) {\n       return source;\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n-    private static <T> Coder<WindowedValue<T>> getCoder(Config config) {\n-      return Base64Serializer.deserializeUnchecked(config.get(\"coder\"), Coder.class);\n-    }\n-\n-    private static SamzaPipelineOptions getPipelineOptions(Config config) {\n-      return Base64Serializer.deserializeUnchecked(\n-              config.get(\"beamPipelineOptions\"), SerializablePipelineOptions.class)\n-          .get()\n-          .as(SamzaPipelineOptions.class);\n+    static SamzaPipelineOptions getPipelineOptions(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3NDYyNQ==", "bodyText": "This flag seems a bit cumbersome to understand, as we already have running flag to control the looping.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543574625", "createdAt": "2020-12-15T18:14:07Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/adapter/UnboundedSourceSystem.java", "diffHunk": "@@ -268,6 +269,7 @@ public void register(SystemStreamPartition ssp, String offset) {\n       private final FnWithMetricsWrapper metricsWrapper;\n \n       private volatile boolean running;\n+      private volatile boolean maxWatermarkReached = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3NTc5MQ==", "bodyText": "This var seems not adding too much value. We should be able to tell the watermark time from nextWatermark.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543575791", "createdAt": "2020-12-15T18:15:48Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/adapter/UnboundedSourceSystem.java", "diffHunk": "@@ -363,20 +365,32 @@ public void run() {\n       private void updateWatermark() throws InterruptedException {\n         final long time = System.currentTimeMillis();\n         if (time - lastWatermarkTime > watermarkInterval) {\n+          long watermarkMillis = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3NjgzNQ==", "bodyText": "Shall we add\nrunning = false", "url": "https://github.com/apache/beam/pull/13550#discussion_r543576835", "createdAt": "2020-12-15T18:17:21Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/adapter/UnboundedSourceSystem.java", "diffHunk": "@@ -363,20 +365,32 @@ public void run() {\n       private void updateWatermark() throws InterruptedException {\n         final long time = System.currentTimeMillis();\n         if (time - lastWatermarkTime > watermarkInterval) {\n+          long watermarkMillis = Long.MAX_VALUE;\n           for (UnboundedReader reader : readers) {\n             final SystemStreamPartition ssp = readerToSsp.get(reader);\n             final Instant currentWatermark =\n                 currentWatermarks.containsKey(ssp)\n                     ? currentWatermarks.get(ssp)\n                     : BoundedWindow.TIMESTAMP_MIN_VALUE;\n             final Instant nextWatermark = reader.getWatermark();\n+            if (nextWatermark != null) {\n+              watermarkMillis = Math.min(nextWatermark.getMillis(), watermarkMillis);\n+            }\n             if (currentWatermark.isBefore(nextWatermark)) {\n               currentWatermarks.put(ssp, nextWatermark);\n-              enqueueWatermark(reader);\n+              if (BoundedWindow.TIMESTAMP_MAX_VALUE.isAfter(nextWatermark)) {\n+                enqueueWatermark(reader);\n+              } else {\n+                // Max watermark has been reached for this reader.\n+                enqueueMaxWatermarkAndEndOfStream(reader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3OTA1NQ==", "bodyText": "I think using previous check of nextWatermark inside the loop should be good enough.", "url": "https://github.com/apache/beam/pull/13550#discussion_r543579055", "createdAt": "2020-12-15T18:20:39Z", "author": {"login": "xinyuiscool"}, "path": "runners/samza/src/main/java/org/apache/beam/runners/samza/adapter/UnboundedSourceSystem.java", "diffHunk": "@@ -363,20 +365,32 @@ public void run() {\n       private void updateWatermark() throws InterruptedException {\n         final long time = System.currentTimeMillis();\n         if (time - lastWatermarkTime > watermarkInterval) {\n+          long watermarkMillis = Long.MAX_VALUE;\n           for (UnboundedReader reader : readers) {\n             final SystemStreamPartition ssp = readerToSsp.get(reader);\n             final Instant currentWatermark =\n                 currentWatermarks.containsKey(ssp)\n                     ? currentWatermarks.get(ssp)\n                     : BoundedWindow.TIMESTAMP_MIN_VALUE;\n             final Instant nextWatermark = reader.getWatermark();\n+            if (nextWatermark != null) {\n+              watermarkMillis = Math.min(nextWatermark.getMillis(), watermarkMillis);\n+            }\n             if (currentWatermark.isBefore(nextWatermark)) {\n               currentWatermarks.put(ssp, nextWatermark);\n-              enqueueWatermark(reader);\n+              if (BoundedWindow.TIMESTAMP_MAX_VALUE.isAfter(nextWatermark)) {\n+                enqueueWatermark(reader);\n+              } else {\n+                // Max watermark has been reached for this reader.\n+                enqueueMaxWatermarkAndEndOfStream(reader);\n+              }\n             }\n           }\n \n           lastWatermarkTime = time;\n+          if (watermarkMillis == BoundedWindow.TIMESTAMP_MAX_VALUE.getMillis()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU4NDgxMA==", "bodyText": "As mentioned above, please exclude this change from the pr and discuss with @Zhangyx39", "url": "https://github.com/apache/beam/pull/13550#discussion_r543584810", "createdAt": "2020-12-15T18:29:12Z", "author": {"login": "xinyuiscool"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/metrics/MetricsEnvironment.java", "diffHunk": "@@ -53,6 +54,12 @@\n \n   private static final ThreadLocal<@Nullable MetricsContainer> CONTAINER_FOR_THREAD =\n       new ThreadLocal<>();\n+  private static final AtomicReference<MetricsContainer> CONTAINER_GLOBAL = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c5fe65afc5f4e99c2a6fe2732c576e2c16852a2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "168841ee0df20bad23abac1f1e0ea14ea514cb09", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/168841ee0df20bad23abac1f1e0ea14ea514cb09", "committedDate": "2020-12-15T22:13:21Z", "message": "Exclude metrics changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9231bf88ff8eb1c104ca180c28f9f065323df3d0", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/9231bf88ff8eb1c104ca180c28f9f065323df3d0", "committedDate": "2020-12-15T22:15:49Z", "message": "Update SamzaJobServerDriver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26129bbddfe70320f3455f4b3f9b392d21a81b38", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/26129bbddfe70320f3455f4b3f9b392d21a81b38", "committedDate": "2020-12-16T00:13:04Z", "message": "Simplify UnboundedSourceSystem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf6c68cd8da13791bc364770839a2070dee2f0e1", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/cf6c68cd8da13791bc364770839a2070dee2f0e1", "committedDate": "2020-12-16T00:31:40Z", "message": "Fix spotless java error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01766db1feaa27a59725de44e805c44dd0187a48", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/01766db1feaa27a59725de44e805c44dd0187a48", "committedDate": "2020-12-16T18:58:34Z", "message": "Move BeamJobCoordinatorRunner from org.apache.beam.runners.samza to org.apache.beam.runners.samza.container"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b768bf8cbc931d13bd4e7d0da2d46d0d40b8c196", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/b768bf8cbc931d13bd4e7d0da2d46d0d40b8c196", "committedDate": "2020-12-16T22:26:08Z", "message": "Enable TestStream tests excluding processing time test stream."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8160739ddda1ab659bfa27eaeed31e60450a0e6", "author": {"user": {"login": "kw2542", "name": "Ke Wu"}}, "url": "https://github.com/apache/beam/commit/b8160739ddda1ab659bfa27eaeed31e60450a0e6", "committedDate": "2020-12-16T22:51:42Z", "message": "Fix import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MDg2NzUx", "url": "https://github.com/apache/beam/pull/13550#pullrequestreview-555086751", "createdAt": "2020-12-18T00:12:59Z", "commit": {"oid": "b8160739ddda1ab659bfa27eaeed31e60450a0e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4430, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}