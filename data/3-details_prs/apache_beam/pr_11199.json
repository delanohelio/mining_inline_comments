{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjEyMjQ4", "number": 11199, "title": "[BEAM-9562] Update Timer encoding with respect of dynamic timers", "bodyText": "R: @robertwb @lukecwik\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-23T20:06:08Z", "url": "https://github.com/apache/beam/pull/11199", "merged": true, "mergeCommit": {"oid": "fff532ec432e65445ff12568e63ee6e0e7d3a17f"}, "closed": true, "closedAt": "2020-04-03T16:33:27Z", "author": {"login": "boyuanzz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ0MAhgFqTM4MDM4NjkyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT56YaABqjMxOTQ4ODIwODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzg2OTIy", "url": "https://github.com/apache/beam/pull/11199#pullrequestreview-380386922", "createdAt": "2020-03-24T14:51:11Z", "commit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDo1MToxMVrOF6z-PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDo1MjoyNlrOF60CIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxMzI0NA==", "bodyText": "You don't need to change this to v2 since these are not stable yet.", "url": "https://github.com/apache/beam/pull/11199#discussion_r397213244", "createdAt": "2020-03-24T14:51:11Z", "author": {"login": "lukecwik"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -718,9 +726,15 @@ message StandardCoders {\n     //                        1: 80 00 00 00 00 00 00 01\n     //                      256: 80 00 00 00 00 00 01 00\n     //      9223372036854775807: FF FF FF FF FF FF FF FF\n-    //   payload - user defined data, uses the component coder\n-    // Components: Coder for the payload.\n-    TIMER = 4 [(beam_urn) = \"beam:coder:timer:v1\"];\n+    //\n+    //   hold timestamp - similar to fire timestamp, but stands for the\n+    //     watermark the timer is expected to hold.\n+    //\n+    //   windows - uses the component coder.\n+    //\n+    //   paneinfo - similar to how paneinfo gets encoded in WindowedValue.\n+    // Components: Coder for the user key, coder for the windows,\n+    TIMER = 4 [(beam_urn) = \"beam:coder:timer:v2\"];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxMzgzNA==", "bodyText": "The dynamic tag is supposed to be part of the encoding.", "url": "https://github.com/apache/beam/pull/11199#discussion_r397213834", "createdAt": "2020-03-24T14:51:56Z", "author": {"login": "lukecwik"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -703,13 +703,21 @@ message StandardCoders {\n     // Components: Coder for a single element.\n     ITERABLE = 3 [(beam_urn) = \"beam:coder:iterable:v1\"];\n \n-    // Encodes a timer containing a timestamp and a user specified payload.\n-    // The encoding is represented as: timestamp payload\n-    //   timestamp - a big endian 8 byte integer representing millis-since-epoch.\n-    //     The encoded representation is shifted so that the byte representation of\n-    //     negative values are lexicographically ordered before the byte representation\n-    //     of positive values. This is typically done by subtracting -9223372036854775808\n-    //     from the value and encoding it as a signed big endian integer. Example values:\n+    // Encodes a timer containing a user key, a clear bit,\n+    // a fire timestamp, a hold timestamp, the windows that the user key is in,\n+    // the paneinfo of the user key.\n+    // The encoding is represented as:\n+    //   user key - user defined key, uses the component coder.\n+    //", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxNDI0Mg==", "bodyText": "timer_id == timer_family_tag since the timer_id represents the key from timer_family_specs.\nNote that we will either need to remove timer_specs from ParDoPayload or ensure that timer_specs and timer_family_specs don't share any keys.", "url": "https://github.com/apache/beam/pull/11199#discussion_r397214242", "createdAt": "2020-03-24T14:52:26Z", "author": {"login": "lukecwik"}, "path": "model/fn-execution/src/main/proto/beam_fn_api.proto", "diffHunk": "@@ -609,16 +609,20 @@ message Elements {\n     // represents the producer of these timers.\n     string transform_id = 2;\n \n+    // (Optional) The local timer family name used to identify the associated\n+    // timer family specification\n+    string timer_family_tag = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTI4MDYz", "url": "https://github.com/apache/beam/pull/11199#pullrequestreview-380528063", "createdAt": "2020-03-24T17:15:00Z", "commit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNzoxNTowMFrOF66yag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNzoyMDoxNVrOF67A-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyNDkwNg==", "bodyText": "This should be timers to represent a full stream of timers.", "url": "https://github.com/apache/beam/pull/11199#discussion_r397324906", "createdAt": "2020-03-24T17:15:00Z", "author": {"login": "robertwb"}, "path": "model/fn-execution/src/main/proto/beam_fn_api.proto", "diffHunk": "@@ -609,16 +609,20 @@ message Elements {\n     // represents the producer of these timers.\n     string transform_id = 2;\n \n+    // (Optional) The local timer family name used to identify the associated\n+    // timer family specification\n+    string timer_family_tag = 3;\n+\n     // (Optional) The local timer name used to identify the associated timer specification.\n-    string timer_id = 3;\n+    string timer_id = 4;\n \n     // (Optional) Represents a logical byte stream of a timer. Encoded according\n     // to the coder in the timer spec.\n-    bytes timer = 4;\n+    bytes timer = 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzMyODYzNQ==", "bodyText": "We should agree on terminology. The \"family\" represents the set of timers, within that one has multiple [dynamic] tags. I would call this timer_family_id.\nWe should not have both timer_specs and timer_family_specs.", "url": "https://github.com/apache/beam/pull/11199#discussion_r397328635", "createdAt": "2020-03-24T17:20:15Z", "author": {"login": "robertwb"}, "path": "model/fn-execution/src/main/proto/beam_fn_api.proto", "diffHunk": "@@ -609,16 +609,20 @@ message Elements {\n     // represents the producer of these timers.\n     string transform_id = 2;\n \n+    // (Optional) The local timer family name used to identify the associated\n+    // timer family specification\n+    string timer_family_tag = 3;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxNDI0Mg=="}, "originalCommit": {"oid": "0453c3f9e2a1fe32ed06d1d75dfd57d877d4a45c"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "057544ce9416c352c60b71311f9de3ecbdaea09d", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/057544ce9416c352c60b71311f9de3ecbdaea09d", "committedDate": "2020-03-24T20:48:30Z", "message": "Update Timer.timer to Timer.timers"}, "afterCommit": {"oid": "43ca8789d34e9786043bc201ee3d11f0706f0d25", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/43ca8789d34e9786043bc201ee3d11f0706f0d25", "committedDate": "2020-03-27T04:49:08Z", "message": "Update Timer encoding into V2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjU3MTM1", "url": "https://github.com/apache/beam/pull/11199#pullrequestreview-383257135", "createdAt": "2020-03-27T23:56:41Z", "commit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMzo1Njo0MVrOF9E48A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwMDoxODo0NVrOF9FJPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4NzU2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE)));\n          \n          \n            \n                                Timer.Coder.of(((KvCoder) mainInput.getCoder()).getKeyCoder(), GlobalWindow.Coder.INSTANCE)));", "url": "https://github.com/apache/beam/pull/11199#discussion_r399587568", "createdAt": "2020-03-27T23:56:41Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/ParDoTranslation.java", "diffHunk": "@@ -197,7 +199,7 @@ public boolean canTranslate(PTransform<?, ?> pTransform) {\n                     ((KvCoder) mainInput.getCoder()).getKeyCoder(),\n                     // TODO: Add support for timer payloads to the SDK\n                     // We currently assume that all payloads are unspecified.\n-                    Timer.Coder.of(VoidCoder.of())));\n+                    Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4NzYxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                // TODO: Add support for timer payloads to the SDK\n          \n          \n            \n                                // We currently assume that all payloads are unspecified.", "url": "https://github.com/apache/beam/pull/11199#discussion_r399587616", "createdAt": "2020-03-27T23:56:54Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/ParDoTranslation.java", "diffHunk": "@@ -197,7 +199,7 @@ public boolean canTranslate(PTransform<?, ?> pTransform) {\n                     ((KvCoder) mainInput.getCoder()).getKeyCoder(),\n                     // TODO: Add support for timer payloads to the SDK\n                     // We currently assume that all payloads are unspecified.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODAzOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns a timer for the given timestamp with a user specified payload.\n          \n          \n            \n               * Returns a timer for the given timestamp with a user specified key.", "url": "https://github.com/apache/beam/pull/11199#discussion_r399588039", "createdAt": "2020-03-27T23:59:05Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,14 +49,26 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a timer for the given timestamp with a user specified payload.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODYxMQ==", "bodyText": "May I suggest you create these two static methods for creating the two common cases?\n.of(userKey, dynamicTimerTag, fireTimestamp, holdTimestamp, windows, pane);\n.cleared(userKey, dynamicTImerTag);\nthis way you can make sure that dynamicTimerTag, fireTimestamp, holdTimestamp, windows and pane are not null", "url": "https://github.com/apache/beam/pull/11199#discussion_r399588611", "createdAt": "2020-03-28T00:02:06Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,14 +49,26 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a timer for the given timestamp with a user specified payload.\n+   *\n+   * @return\n+   */\n+  // TODO(BEAM-9562): Plumb through actual Timer fields.\n+  public static <T> Timer<T> of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODY2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public abstract Boolean getClearBit();\n          \n          \n            \n              public abstract boolean getClearBit();", "url": "https://github.com/apache/beam/pull/11199#discussion_r399588665", "createdAt": "2020-03-28T00:02:23Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -57,11 +78,24 @@\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract T getUserKey();\n+\n+  public abstract String getDynamicTimerTag();\n+\n+  public abstract Boolean getClearBit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4ODc4Mg==", "bodyText": "please update class comment", "url": "https://github.com/apache/beam/pull/11199#discussion_r399588782", "createdAt": "2020-03-28T00:02:59Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -73,59 +107,81 @@\n    */\n   public static class Coder<T> extends StructuredCoder<Timer<T>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4OTI0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Boolean clearBit = BooleanCoder.of().decode(inStream);\n          \n          \n            \n                  boolean clearBit = BooleanCoder.of().decode(inStream);", "url": "https://github.com/apache/beam/pull/11199#discussion_r399589246", "createdAt": "2020-03-28T00:05:24Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -73,59 +107,81 @@\n    */\n   public static class Coder<T> extends StructuredCoder<Timer<T>> {\n \n-    public static <T> Coder of(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      return new Coder(payloadCoder);\n+    public static <T> Coder<T> of(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      return new Coder<>(keyCoder, windowCoder);\n     }\n \n-    private final org.apache.beam.sdk.coders.Coder<T> payloadCoder;\n+    private final org.apache.beam.sdk.coders.Coder<T> keyCoder;\n+    private final org.apache.beam.sdk.coders.Coder<Collection<? extends BoundedWindow>>\n+        windowsCoder;\n \n-    private Coder(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      this.payloadCoder = payloadCoder;\n+    private Coder(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      this.keyCoder = keyCoder;\n+      this.windowsCoder = (org.apache.beam.sdk.coders.Coder) CollectionCoder.of(windowCoder);\n+      ;\n     }\n \n     @Override\n     public void encode(Timer<T> timer, OutputStream outStream) throws CoderException, IOException {\n-      InstantCoder.of().encode(timer.getTimestamp(), outStream);\n-      payloadCoder.encode(timer.getPayload(), outStream);\n+      keyCoder.encode(timer.getUserKey(), outStream);\n+      StringUtf8Coder.of().encode(timer.getDynamicTimerTag(), outStream);\n+      BooleanCoder.of().encode(timer.getClearBit(), outStream);\n+      if (!timer.getClearBit()) {\n+        InstantCoder.of().encode(timer.getFireTimestamp(), outStream);\n+        InstantCoder.of().encode(timer.getHoldTimestamp(), outStream);\n+        windowsCoder.encode(timer.getWindows(), outStream);\n+        PaneInfoCoder.INSTANCE.encode(timer.getPane(), outStream);\n+      }\n     }\n \n     @Override\n     public Timer<T> decode(InputStream inStream) throws CoderException, IOException {\n-      Instant instant = InstantCoder.of().decode(inStream);\n-      T value = payloadCoder.decode(inStream);\n-      return Timer.of(instant, value);\n+      T userKey = keyCoder.decode(inStream);\n+      String dynamicTimerTag = StringUtf8Coder.of().decode(inStream);\n+      Boolean clearBit = BooleanCoder.of().decode(inStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4OTMxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Instant holeTimestamp = InstantCoder.of().decode(inStream);\n          \n          \n            \n                  Instant holdTimestamp = InstantCoder.of().decode(inStream);", "url": "https://github.com/apache/beam/pull/11199#discussion_r399589315", "createdAt": "2020-03-28T00:05:45Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -73,59 +107,81 @@\n    */\n   public static class Coder<T> extends StructuredCoder<Timer<T>> {\n \n-    public static <T> Coder of(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      return new Coder(payloadCoder);\n+    public static <T> Coder<T> of(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      return new Coder<>(keyCoder, windowCoder);\n     }\n \n-    private final org.apache.beam.sdk.coders.Coder<T> payloadCoder;\n+    private final org.apache.beam.sdk.coders.Coder<T> keyCoder;\n+    private final org.apache.beam.sdk.coders.Coder<Collection<? extends BoundedWindow>>\n+        windowsCoder;\n \n-    private Coder(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      this.payloadCoder = payloadCoder;\n+    private Coder(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      this.keyCoder = keyCoder;\n+      this.windowsCoder = (org.apache.beam.sdk.coders.Coder) CollectionCoder.of(windowCoder);\n+      ;\n     }\n \n     @Override\n     public void encode(Timer<T> timer, OutputStream outStream) throws CoderException, IOException {\n-      InstantCoder.of().encode(timer.getTimestamp(), outStream);\n-      payloadCoder.encode(timer.getPayload(), outStream);\n+      keyCoder.encode(timer.getUserKey(), outStream);\n+      StringUtf8Coder.of().encode(timer.getDynamicTimerTag(), outStream);\n+      BooleanCoder.of().encode(timer.getClearBit(), outStream);\n+      if (!timer.getClearBit()) {\n+        InstantCoder.of().encode(timer.getFireTimestamp(), outStream);\n+        InstantCoder.of().encode(timer.getHoldTimestamp(), outStream);\n+        windowsCoder.encode(timer.getWindows(), outStream);\n+        PaneInfoCoder.INSTANCE.encode(timer.getPane(), outStream);\n+      }\n     }\n \n     @Override\n     public Timer<T> decode(InputStream inStream) throws CoderException, IOException {\n-      Instant instant = InstantCoder.of().decode(inStream);\n-      T value = payloadCoder.decode(inStream);\n-      return Timer.of(instant, value);\n+      T userKey = keyCoder.decode(inStream);\n+      String dynamicTimerTag = StringUtf8Coder.of().decode(inStream);\n+      Boolean clearBit = BooleanCoder.of().decode(inStream);\n+      if (clearBit) {\n+        return Timer.of(userKey, dynamicTimerTag, clearBit);\n+      }\n+      Instant fireTimestamp = InstantCoder.of().decode(inStream);\n+      Instant holeTimestamp = InstantCoder.of().decode(inStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4OTYzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  verifyDeterministic(this, \"Windows coder must be deterministic\", windowsCoder);\n          \n          \n            \n                  verifyDeterministic(this, \"Window coder must be deterministic\", windowsCoder);", "url": "https://github.com/apache/beam/pull/11199#discussion_r399589633", "createdAt": "2020-03-28T00:07:35Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -73,59 +107,81 @@\n    */\n   public static class Coder<T> extends StructuredCoder<Timer<T>> {\n \n-    public static <T> Coder of(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      return new Coder(payloadCoder);\n+    public static <T> Coder<T> of(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      return new Coder<>(keyCoder, windowCoder);\n     }\n \n-    private final org.apache.beam.sdk.coders.Coder<T> payloadCoder;\n+    private final org.apache.beam.sdk.coders.Coder<T> keyCoder;\n+    private final org.apache.beam.sdk.coders.Coder<Collection<? extends BoundedWindow>>\n+        windowsCoder;\n \n-    private Coder(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      this.payloadCoder = payloadCoder;\n+    private Coder(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      this.keyCoder = keyCoder;\n+      this.windowsCoder = (org.apache.beam.sdk.coders.Coder) CollectionCoder.of(windowCoder);\n+      ;\n     }\n \n     @Override\n     public void encode(Timer<T> timer, OutputStream outStream) throws CoderException, IOException {\n-      InstantCoder.of().encode(timer.getTimestamp(), outStream);\n-      payloadCoder.encode(timer.getPayload(), outStream);\n+      keyCoder.encode(timer.getUserKey(), outStream);\n+      StringUtf8Coder.of().encode(timer.getDynamicTimerTag(), outStream);\n+      BooleanCoder.of().encode(timer.getClearBit(), outStream);\n+      if (!timer.getClearBit()) {\n+        InstantCoder.of().encode(timer.getFireTimestamp(), outStream);\n+        InstantCoder.of().encode(timer.getHoldTimestamp(), outStream);\n+        windowsCoder.encode(timer.getWindows(), outStream);\n+        PaneInfoCoder.INSTANCE.encode(timer.getPane(), outStream);\n+      }\n     }\n \n     @Override\n     public Timer<T> decode(InputStream inStream) throws CoderException, IOException {\n-      Instant instant = InstantCoder.of().decode(inStream);\n-      T value = payloadCoder.decode(inStream);\n-      return Timer.of(instant, value);\n+      T userKey = keyCoder.decode(inStream);\n+      String dynamicTimerTag = StringUtf8Coder.of().decode(inStream);\n+      Boolean clearBit = BooleanCoder.of().decode(inStream);\n+      if (clearBit) {\n+        return Timer.of(userKey, dynamicTimerTag, clearBit);\n+      }\n+      Instant fireTimestamp = InstantCoder.of().decode(inStream);\n+      Instant holeTimestamp = InstantCoder.of().decode(inStream);\n+      Collection<? extends BoundedWindow> windows = windowsCoder.decode(inStream);\n+      PaneInfo pane = PaneInfoCoder.INSTANCE.decode(inStream);\n+      return Timer.of(\n+          userKey, dynamicTimerTag, clearBit, fireTimestamp, holeTimestamp, windows, pane);\n     }\n \n     @Override\n     public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n-      return Collections.singletonList(payloadCoder);\n-    }\n-\n-    @Override\n-    public void verifyDeterministic() throws NonDeterministicException {\n-      verifyDeterministic(this, \"Payload coder must be deterministic\", payloadCoder);\n+      return Collections.singletonList(keyCoder);\n     }\n \n     @Override\n-    public boolean consistentWithEquals() {\n-      return payloadCoder.consistentWithEquals();\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getComponents() {\n+      return Arrays.asList(keyCoder, windowsCoder);\n     }\n \n     @Override\n-    public Object structuralValue(Timer<T> value) {\n-      return Timer.of(value.getTimestamp(), payloadCoder.structuralValue(value.getPayload()));\n-    }\n-\n-    @Override\n-    public boolean isRegisterByteSizeObserverCheap(Timer<T> value) {\n-      return payloadCoder.isRegisterByteSizeObserverCheap(value.getPayload());\n+    public void verifyDeterministic() throws NonDeterministicException {\n+      verifyDeterministic(this, \"UserKey coder must be deterministic\", keyCoder);\n+      verifyDeterministic(this, \"Windows coder must be deterministic\", windowsCoder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MTQyNQ==", "bodyText": "why do you have to specify the tag_coder_impl, shouldn't it always be Python's string utf8 coder?", "url": "https://github.com/apache/beam/pull/11199#discussion_r399591425", "createdAt": "2020-03-28T00:16:50Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -629,22 +629,56 @@ def estimate_size(self, unused_value, nested=False):\n \n class TimerCoderImpl(StreamCoderImpl):\n   \"\"\"For internal use only; no backwards-compatibility guarantees.\"\"\"\n-  def __init__(self, payload_coder_impl):\n+  def __init__(self, key_coder_impl, window_coder_impl, tag_coder_impl):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MTQ5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                self._key_coder_impl.encode_to_stream(value.user_key, out, nested)\n          \n          \n            \n                self._key_coder_impl.encode_to_stream(value.user_key, out, True)\n          \n      \n    \n    \n  \n\nWe should ignore the nested field since it will change the encoding.", "url": "https://github.com/apache/beam/pull/11199#discussion_r399591496", "createdAt": "2020-03-28T00:17:21Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -629,22 +629,56 @@ def estimate_size(self, unused_value, nested=False):\n \n class TimerCoderImpl(StreamCoderImpl):\n   \"\"\"For internal use only; no backwards-compatibility guarantees.\"\"\"\n-  def __init__(self, payload_coder_impl):\n+  def __init__(self, key_coder_impl, window_coder_impl, tag_coder_impl):\n     self._timestamp_coder_impl = TimestampCoderImpl()\n-    self._payload_coder_impl = payload_coder_impl\n+    self._boolean_coder_impl = BooleanCoderImpl()\n+    self._pane_info_coder_impl = PaneInfoCoderImpl()\n+    self._key_coder_impl = key_coder_impl\n+    self._windows_coder_impl = TupleSequenceCoderImpl(window_coder_impl)\n+    self._tag_coder_impl = tag_coder_impl\n \n   def encode_to_stream(self, value, out, nested):\n     # type: (dict, create_OutputStream, bool) -> None\n-    self._timestamp_coder_impl.encode_to_stream(value['timestamp'], out, True)\n-    self._payload_coder_impl.encode_to_stream(value.get('payload'), out, True)\n+    self._key_coder_impl.encode_to_stream(value.user_key, out, nested)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MTUxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  self._pane_info_coder_impl.encode_to_stream(value.paneinfo, out, True)\n          \n          \n            \n                  self._pane_info_coder_impl.encode_to_stream(value.paneinfo, out, nested)", "url": "https://github.com/apache/beam/pull/11199#discussion_r399591519", "createdAt": "2020-03-28T00:17:33Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -629,22 +629,56 @@ def estimate_size(self, unused_value, nested=False):\n \n class TimerCoderImpl(StreamCoderImpl):\n   \"\"\"For internal use only; no backwards-compatibility guarantees.\"\"\"\n-  def __init__(self, payload_coder_impl):\n+  def __init__(self, key_coder_impl, window_coder_impl, tag_coder_impl):\n     self._timestamp_coder_impl = TimestampCoderImpl()\n-    self._payload_coder_impl = payload_coder_impl\n+    self._boolean_coder_impl = BooleanCoderImpl()\n+    self._pane_info_coder_impl = PaneInfoCoderImpl()\n+    self._key_coder_impl = key_coder_impl\n+    self._windows_coder_impl = TupleSequenceCoderImpl(window_coder_impl)\n+    self._tag_coder_impl = tag_coder_impl\n \n   def encode_to_stream(self, value, out, nested):\n     # type: (dict, create_OutputStream, bool) -> None\n-    self._timestamp_coder_impl.encode_to_stream(value['timestamp'], out, True)\n-    self._payload_coder_impl.encode_to_stream(value.get('payload'), out, True)\n+    self._key_coder_impl.encode_to_stream(value.user_key, out, nested)\n+    self._tag_coder_impl.encode_to_stream(\n+        value.dynamic_timer_tag, out, True)\n+    self._boolean_coder_impl.encode_to_stream(value.clear_bit, out, True)\n+    if not value.clear_bit:\n+      self._timestamp_coder_impl.encode_to_stream(\n+          value.fire_timestamp, out, True)\n+      self._timestamp_coder_impl.encode_to_stream(\n+          value.hold_timestamp, out, True)\n+      self._windows_coder_impl.encode_to_stream(value.windows, out, True)\n+      self._pane_info_coder_impl.encode_to_stream(value.paneinfo, out, True)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU5MTc0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                user_key = self._key_coder_impl.decode_from_stream(in_stream, nested)\n          \n          \n            \n                user_key = self._key_coder_impl.decode_from_stream(in_stream, True)", "url": "https://github.com/apache/beam/pull/11199#discussion_r399591742", "createdAt": "2020-03-28T00:18:45Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -629,22 +629,56 @@ def estimate_size(self, unused_value, nested=False):\n \n class TimerCoderImpl(StreamCoderImpl):\n   \"\"\"For internal use only; no backwards-compatibility guarantees.\"\"\"\n-  def __init__(self, payload_coder_impl):\n+  def __init__(self, key_coder_impl, window_coder_impl, tag_coder_impl):\n     self._timestamp_coder_impl = TimestampCoderImpl()\n-    self._payload_coder_impl = payload_coder_impl\n+    self._boolean_coder_impl = BooleanCoderImpl()\n+    self._pane_info_coder_impl = PaneInfoCoderImpl()\n+    self._key_coder_impl = key_coder_impl\n+    self._windows_coder_impl = TupleSequenceCoderImpl(window_coder_impl)\n+    self._tag_coder_impl = tag_coder_impl\n \n   def encode_to_stream(self, value, out, nested):\n     # type: (dict, create_OutputStream, bool) -> None\n-    self._timestamp_coder_impl.encode_to_stream(value['timestamp'], out, True)\n-    self._payload_coder_impl.encode_to_stream(value.get('payload'), out, True)\n+    self._key_coder_impl.encode_to_stream(value.user_key, out, nested)\n+    self._tag_coder_impl.encode_to_stream(\n+        value.dynamic_timer_tag, out, True)\n+    self._boolean_coder_impl.encode_to_stream(value.clear_bit, out, True)\n+    if not value.clear_bit:\n+      self._timestamp_coder_impl.encode_to_stream(\n+          value.fire_timestamp, out, True)\n+      self._timestamp_coder_impl.encode_to_stream(\n+          value.hold_timestamp, out, True)\n+      self._windows_coder_impl.encode_to_stream(value.windows, out, True)\n+      self._pane_info_coder_impl.encode_to_stream(value.paneinfo, out, True)\n \n   def decode_from_stream(self, in_stream, nested):\n     # type: (create_InputStream, bool) -> dict\n     # TODO(robertwb): Consider using a concrete class rather than a dict here.\n-    return dict(\n-        timestamp=self._timestamp_coder_impl.decode_from_stream(\n+    from apache_beam.transforms import userstate\n+    user_key = self._key_coder_impl.decode_from_stream(in_stream, nested)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fee34918537de1a553d298da1d7a8e08a10b05"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67f2843ba91b35ee2660ea72dd650f3f51c04f5b", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/67f2843ba91b35ee2660ea72dd650f3f51c04f5b", "committedDate": "2020-04-01T21:57:46Z", "message": "Update standard_coders.yaml"}, "afterCommit": {"oid": "e1cbcce5c3a33f7a7c50ccb7418ec10fa342d686", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/e1cbcce5c3a33f7a7c50ccb7418ec10fa342d686", "committedDate": "2020-04-01T21:59:45Z", "message": "Update standard_coders.yaml"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "371e1e8bf6d1ca5a3e6531481e4fb2344938049a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/371e1e8bf6d1ca5a3e6531481e4fb2344938049a", "committedDate": "2020-04-01T22:00:12Z", "message": "Update standard_coders.yaml"}, "afterCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/d63f9cf3ce5b9683505582e4e47554ca5376405e", "committedDate": "2020-04-01T22:00:26Z", "message": "Update standard_coders.yaml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTQ5MzQ4", "url": "https://github.com/apache/beam/pull/11199#pullrequestreview-386549348", "createdAt": "2020-04-02T15:37:08Z", "commit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNTozNzowOFrOF_xNLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjoxNjoxM1rOF_y6BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMDc5Nw==", "bodyText": "Please add a test for a cleared timer encoding.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402410797", "createdAt": "2020-04-02T15:37:08Z", "author": {"login": "lukecwik"}, "path": "model/fn-execution/src/main/resources/org/apache/beam/model/fnexecution/v1/standard_coders.yaml", "diffHunk": "@@ -207,15 +224,19 @@ examples:\n \n coder:\n   urn: \"beam:coder:timer:v1\"\n-  components: [{urn: \"beam:coder:bytes:v1\"}]\n+  components: [{urn: \"beam:coder:string_utf8:v1\"},\n+               {urn: \"beam:coder:global_window:v1\"}]\n examples:\n-  \"\\0\\0\\0\\0\\0\\0\\0\\0\\u0003abc\": {timestamp: -9223372036854775808, payload: abc}\n-  \"\\x7f\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\\x01\\u0003abc\": {timestamp: -255, payload: abc}\n-  \"\\x7f\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\\u0003abc\": {timestamp: -1, payload: abc}\n-  \"\\x80\\0\\0\\0\\0\\0\\0\\0\\u0003abc\": {timestamp: 0, payload: abc}\n-  \"\\x80\\0\\0\\0\\0\\0\\0\\x01\\u0003abc\": {timestamp: 1, payload: abc}\n-  \"\\x80\\0\\0\\0\\0\\0\\x01\\0\\u0003abc\": {timestamp: 256, payload: abc}\n-  \"\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\\u0003abc\": {timestamp: 9223372036854775807, payload: abc}\n+  \"\\u0003\\u006b\\u0065\\u0079\\u0003\\u0074\\u0061\\u0067\\u0000\\u0080\\u0000\\u0000\\u0000\\u0000\\u0000\\u0003\\u00e8\\u0080\\u0000\\u0000\\u0000\\u0000\\u0000\\u0003\\u00e8\\u0000\\u0000\\u0000\\u0001\\u000f\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMTUzMA==", "bodyText": "You sure the charset needs to be ISO_8859_1?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #   byte[] byets = CoderUtils.encodeToByteArray(coder, timer);\n          \n          \n            \n            #   String str = new String(byets, java.nio.charset.StandardCharsets.ISO_8859_1);\n          \n          \n            \n            #   byte[] bytes = CoderUtils.encodeToByteArray(coder, timer);\n          \n          \n            \n            #   String str = new String(bytes, java.nio.charset.StandardCharsets.ISO_8859_1);", "url": "https://github.com/apache/beam/pull/11199#discussion_r402411530", "createdAt": "2020-04-02T15:38:11Z", "author": {"login": "lukecwik"}, "path": "model/fn-execution/src/main/resources/org/apache/beam/model/fnexecution/v1/standard_coders.yaml", "diffHunk": "@@ -28,6 +28,23 @@\n #             one of a few standard JSON types such as numbers, strings, dicts that map naturally\n #             to the type encoded by the coder.\n #\n+# Java code snippet to generate example bytes:\n+#   Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n+#   Instant now = new Instant(1000L);\n+#   Timer<String> timer = Timer.of(\n+#     \"key\",\n+#     \"tag\",\n+#     now,\n+#     now,\n+#     Collections.singletonList(GlobalWindow.INSTANCE),\n+#     PaneInfo.NO_FIRING);\n+#   byte[] byets = CoderUtils.encodeToByteArray(coder, timer);\n+#   String str = new String(byets, java.nio.charset.StandardCharsets.ISO_8859_1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMzk4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A timer consists of a userKey, a dynamicTimerTag, a clearBit, a fireTimestamp, a holdTimestamp a\n          \n          \n            \n             * list of window and pane.\n          \n          \n            \n             * A timer consists of a user key, a dynamic timer tag and either a bit that says that this timer should be cleared or data representing the firing timestamp, hold timestamp and a list of windows and pane information that should be used when producing output.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402413982", "createdAt": "2020-04-02T15:41:35Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -21,17 +21,27 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n+import java.util.Objects;\n import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n import org.apache.beam.sdk.coders.CoderException;\n+import org.apache.beam.sdk.coders.CollectionCoder;\n import org.apache.beam.sdk.coders.InstantCoder;\n+import org.apache.beam.sdk.coders.StringUtf8Coder;\n import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.transforms.windowing.BoundedWindow;\n+import org.apache.beam.sdk.transforms.windowing.PaneInfo;\n+import org.apache.beam.sdk.transforms.windowing.PaneInfo.PaneInfoCoder;\n import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n import org.joda.time.Instant;\n \n /**\n- * A timer consists of a timestamp and a corresponding user supplied payload.\n+ * A timer consists of a userKey, a dynamicTimerTag, a clearBit, a fireTimestamp, a holdTimestamp a\n+ * list of window and pane.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNDczMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n          \n          \n            \n               * holdTimestamp, windows and pane.\n          \n          \n            \n               * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code fireTimestamp},\n          \n          \n            \n               * {@code holdTimestamp}, {@code windows} and {@code pane}.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402414733", "createdAt": "2020-04-02T15:42:39Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNjU5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n          \n          \n            \n               * from TimerSpec.\n          \n          \n            \n               * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link TimerSpec}.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402416594", "createdAt": "2020-04-02T15:45:14Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNzY0OQ==", "bodyText": "fire timestamp and hold timestamp can be null when the clear is set.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402417649", "createdAt": "2020-04-02T15:46:43Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the clearBit is true.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the windows which is associated with the timer. This field is nullable only when the\n+   * clearBit is true.\n+   */\n+  @Nullable\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * clearBit is true.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    } else {\n+      Timer<?> that = (Timer<?>) other;\n+\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && this.getFireTimestamp().equals(that.getFireTimestamp())\n+          && this.getHoldTimestamp().equals(that.getHoldTimestamp())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODIzNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /** Returns a boolean which indicate whether the timer is going to be cleared. */\n          \n          \n            \n              /** Returns whether the timer is going to be cleared. */", "url": "https://github.com/apache/beam/pull/11199#discussion_r402418237", "createdAt": "2020-04-02T15:47:34Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODU0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n          \n          \n            \n               * the clearBit is true.\n          \n          \n            \n               * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n          \n          \n            \n               * the timer is being cleared.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402418547", "createdAt": "2020-04-02T15:47:56Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyNTQxNQ==", "bodyText": "CC: @robertwb @reuvenlax\nOriginally I was thinking that timers should always be relative but now that I think about it more I think we should make this field absolute. When timers are created during normal element processing within an SDK then watermark timer should be computed based upon the input elements timestamp and processing time timers can be computed using the system's clock. For timers created during timer callbacks, the timers should always be relative to the fire timestamp of that timer.\nHold timestamps by default should be the input elements timestamp plus an optional positive offset during normal element processing and they should be the hold timestamp of the fired timer plus an optional positive offset during timer callbacks.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402425415", "createdAt": "2020-04-02T15:57:10Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyNjkzMg==", "bodyText": "This was missed during the doc review but the timer will always need to encode the windowing information otherwise we won't know what windows the timer is in to clear.\nWe'll need to update the documentation for this as well.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402426932", "createdAt": "2020-04-02T15:59:12Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the clearBit is true.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the windows which is associated with the timer. This field is nullable only when the\n+   * clearBit is true.\n+   */\n+  @Nullable\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * clearBit is true.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    } else {\n+      Timer<?> that = (Timer<?>) other;\n+\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && this.getFireTimestamp().equals(that.getFireTimestamp())\n+          && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n+          && Objects.equals(this.getWindows(), that.getWindows())\n+          && Objects.equals(this.getPane(), that.getPane());\n+    }\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    // Hash only the millis of the timestamp to be consistent with equals\n+    return Objects.hash(\n+        getUserKey(),\n+        getDynamicTimerTag(),\n+        getClearBit(),\n+        getFireTimestamp().getMillis(),\n+        getHoldTimestamp().getMillis(),\n+        getWindows(),\n+        getPane());\n+  }\n \n   /**\n    * A {@link org.apache.beam.sdk.coders.Coder} for timers.\n    *\n-   * <p>This coder is deterministic if the payload coder is deterministic.\n+   * <p>This coder is deterministic if both the key coder and window coder are deterministic.\n    *\n-   * <p>This coder is inexpensive for size estimation of elements if the payload coder is\n-   * inexpensive for size estimation.\n+   * <p>This coder is inexpensive for size estimation of elements if the key coder is inexpensive\n+   * for size estimation.\n    */\n   public static class Coder<T> extends StructuredCoder<Timer<T>> {\n \n-    public static <T> Coder of(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      return new Coder(payloadCoder);\n+    public static <T> Coder<T> of(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      return new Coder<>(keyCoder, windowCoder);\n     }\n \n-    private final org.apache.beam.sdk.coders.Coder<T> payloadCoder;\n-\n-    private Coder(org.apache.beam.sdk.coders.Coder<T> payloadCoder) {\n-      this.payloadCoder = payloadCoder;\n+    private final org.apache.beam.sdk.coders.Coder<T> keyCoder;\n+    private final org.apache.beam.sdk.coders.Coder<Collection<? extends BoundedWindow>>\n+        windowsCoder;\n+    private final org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder;\n+\n+    private Coder(\n+        org.apache.beam.sdk.coders.Coder<T> keyCoder,\n+        org.apache.beam.sdk.coders.Coder<? extends BoundedWindow> windowCoder) {\n+      this.windowCoder = windowCoder;\n+      this.keyCoder = keyCoder;\n+      this.windowsCoder = (org.apache.beam.sdk.coders.Coder) CollectionCoder.of(windowCoder);\n     }\n \n     @Override\n     public void encode(Timer<T> timer, OutputStream outStream) throws CoderException, IOException {\n-      InstantCoder.of().encode(timer.getTimestamp(), outStream);\n-      payloadCoder.encode(timer.getPayload(), outStream);\n+      keyCoder.encode(timer.getUserKey(), outStream);\n+      StringUtf8Coder.of().encode(timer.getDynamicTimerTag(), outStream);\n+      BooleanCoder.of().encode(timer.getClearBit(), outStream);\n+      if (!timer.getClearBit()) {\n+        InstantCoder.of().encode(timer.getFireTimestamp(), outStream);\n+        InstantCoder.of().encode(timer.getHoldTimestamp(), outStream);\n+        windowsCoder.encode(timer.getWindows(), outStream);\n+        PaneInfoCoder.INSTANCE.encode(timer.getPane(), outStream);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyODcyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n          \n          \n            \n               * the clearBit is true.\n          \n          \n            \n               * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n          \n          \n            \n               * the timer is being cleared.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402428722", "createdAt": "2020-04-02T16:01:47Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the clearBit is true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyODg5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the windows which is associated with the timer. This field is nullable only when the\n          \n          \n            \n               * clearBit is true.\n          \n          \n            \n               * Returns the windows which is associated with the timer.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402428893", "createdAt": "2020-04-02T16:02:02Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the clearBit is true.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the windows which is associated with the timer. This field is nullable only when the\n+   * clearBit is true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQyOTA0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the paneinfo that is related to the timer. This field is nullable only when the\n          \n          \n            \n               * clearBit is true.\n          \n          \n            \n               * Returns the paneinfo that is related to the timer. This field is nullable only when the\n          \n          \n            \n               * timer is being cleared.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402429043", "createdAt": "2020-04-02T16:02:16Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +50,197 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given userKey, dynamicTimerTag, fireTimestamp,\n+   * holdTimestamp, windows and pane.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      Collection<? extends BoundedWindow> windows,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, false, fireTimestamp, holdTimestamp, windows, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag. */\n+  public static <T> Timer<T> cleared(T userKey, String dynamicTimerTag) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, true, null, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is empty string only when the timer is set\n+   * from TimerSpec.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns a boolean which indicate whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the clearBit is true.\n    *\n    * <p>The time is relative to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the clearBit is true.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the windows which is associated with the timer. This field is nullable only when the\n+   * clearBit is true.\n+   */\n+  @Nullable\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * clearBit is true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMDUxNA==", "bodyText": "check that clear is equal", "url": "https://github.com/apache/beam/pull/11199#discussion_r402430514", "createdAt": "2020-04-02T16:04:25Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/CommonCoderTest.java", "diffHunk": "@@ -434,8 +452,16 @@ private void verifyDecodedValue(CommonCoder coder, Object expectedValue, Object\n       assertFalse(expectedValueIterator.hasNext());\n \n     } else if (s.equals(getUrn(StandardCoders.Enum.TIMER))) {\n-      assertEquals(((Timer) expectedValue).getTimestamp(), ((Timer) actualValue).getTimestamp());\n-      assertThat(((Timer) expectedValue).getPayload(), equalTo(((Timer) actualValue).getPayload()));\n+      assertEquals(((Timer) expectedValue).getUserKey(), ((Timer) actualValue).getUserKey());\n+      assertEquals(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMTE1MA==", "bodyText": "use two different instant objects otherwise you can't tell if they get swapped accidentally", "url": "https://github.com/apache/beam/pull/11199#discussion_r402431150", "createdAt": "2020-04-02T16:05:24Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/TimerTest.java", "diffHunk": "@@ -36,39 +38,121 @@\n   private static final Instant INSTANT = Instant.now();\n \n   @Test\n-  public void testTimer() {\n-    Timer<Void> timerA = Timer.of(INSTANT);\n-    assertEquals(INSTANT, timerA.getTimestamp());\n-    assertNull(timerA.getPayload());\n+  public void testClearTimer() {\n+    Timer<String> clearedTimer = Timer.cleared(\"timer\", \"tag\");\n+    assertTrue(clearedTimer.getClearBit());\n+    assertEquals(\"timer\", clearedTimer.getUserKey());\n+    assertEquals(\"tag\", clearedTimer.getDynamicTimerTag());\n+  }\n \n-    Timer<String> timerB = Timer.of(INSTANT, \"ABC\");\n-    assertEquals(INSTANT, timerB.getTimestamp());\n-    assertEquals(\"ABC\", timerB.getPayload());\n+  @Test\n+  public void testTimer() {\n+    Timer<String> timer =\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMjk2Ng==", "bodyText": "Add a cleared timer for this case.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402432966", "createdAt": "2020-04-02T16:07:53Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/TimerTest.java", "diffHunk": "@@ -36,39 +38,121 @@\n   private static final Instant INSTANT = Instant.now();\n \n   @Test\n-  public void testTimer() {\n-    Timer<Void> timerA = Timer.of(INSTANT);\n-    assertEquals(INSTANT, timerA.getTimestamp());\n-    assertNull(timerA.getPayload());\n+  public void testClearTimer() {\n+    Timer<String> clearedTimer = Timer.cleared(\"timer\", \"tag\");\n+    assertTrue(clearedTimer.getClearBit());\n+    assertEquals(\"timer\", clearedTimer.getUserKey());\n+    assertEquals(\"tag\", clearedTimer.getDynamicTimerTag());\n+  }\n \n-    Timer<String> timerB = Timer.of(INSTANT, \"ABC\");\n-    assertEquals(INSTANT, timerB.getTimestamp());\n-    assertEquals(\"ABC\", timerB.getPayload());\n+  @Test\n+  public void testTimer() {\n+    Timer<String> timer =\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING);\n+    assertEquals(\"key\", timer.getUserKey());\n+    assertEquals(\"tag\", timer.getDynamicTimerTag());\n+    assertEquals(INSTANT, timer.getFireTimestamp());\n+    assertEquals(INSTANT, timer.getHoldTimestamp());\n+    assertEquals(Collections.singleton(GlobalWindow.INSTANCE), timer.getWindows());\n+    assertEquals(PaneInfo.NO_FIRING, timer.getPane());\n+    assertFalse(timer.getClearBit());\n   }\n \n   @Test\n-  public void testTimerCoderWithInconsistentWithEqualsPayloadCoder() throws Exception {\n-    Coder<Timer<byte[]>> coder = Timer.Coder.of(ByteArrayCoder.of());\n+  public void testTimerCoderWithInconsistentWithEqualsComponentCoders() throws Exception {\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n     CoderProperties.coderSerializable(coder);\n     CoderProperties.structuralValueDecodeEncodeEqual(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMzEzNw==", "bodyText": "Add a cleared timer for this case.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402433137", "createdAt": "2020-04-02T16:08:10Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/TimerTest.java", "diffHunk": "@@ -36,39 +38,121 @@\n   private static final Instant INSTANT = Instant.now();\n \n   @Test\n-  public void testTimer() {\n-    Timer<Void> timerA = Timer.of(INSTANT);\n-    assertEquals(INSTANT, timerA.getTimestamp());\n-    assertNull(timerA.getPayload());\n+  public void testClearTimer() {\n+    Timer<String> clearedTimer = Timer.cleared(\"timer\", \"tag\");\n+    assertTrue(clearedTimer.getClearBit());\n+    assertEquals(\"timer\", clearedTimer.getUserKey());\n+    assertEquals(\"tag\", clearedTimer.getDynamicTimerTag());\n+  }\n \n-    Timer<String> timerB = Timer.of(INSTANT, \"ABC\");\n-    assertEquals(INSTANT, timerB.getTimestamp());\n-    assertEquals(\"ABC\", timerB.getPayload());\n+  @Test\n+  public void testTimer() {\n+    Timer<String> timer =\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING);\n+    assertEquals(\"key\", timer.getUserKey());\n+    assertEquals(\"tag\", timer.getDynamicTimerTag());\n+    assertEquals(INSTANT, timer.getFireTimestamp());\n+    assertEquals(INSTANT, timer.getHoldTimestamp());\n+    assertEquals(Collections.singleton(GlobalWindow.INSTANCE), timer.getWindows());\n+    assertEquals(PaneInfo.NO_FIRING, timer.getPane());\n+    assertFalse(timer.getClearBit());\n   }\n \n   @Test\n-  public void testTimerCoderWithInconsistentWithEqualsPayloadCoder() throws Exception {\n-    Coder<Timer<byte[]>> coder = Timer.Coder.of(ByteArrayCoder.of());\n+  public void testTimerCoderWithInconsistentWithEqualsComponentCoders() throws Exception {\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n     CoderProperties.coderSerializable(coder);\n     CoderProperties.structuralValueDecodeEncodeEqual(\n-        coder, Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)));\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n     CoderProperties.structuralValueConsistentWithEquals(\n-        coder, Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)), Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)));\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING),\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n   }\n \n   @Test\n-  public void testTimerCoderWithConsistentWithEqualsPayloadCoder() throws Exception {\n-    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of());\n-    CoderProperties.coderDecodeEncodeEqual(coder, Timer.of(INSTANT, \"ABC\"));\n+  public void testTimerCoderWithConsistentWithEqualsComponentCoders() throws Exception {\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMzg3MQ==", "bodyText": "We can get rid of this test since standard_coders.yaml covers it.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402433871", "createdAt": "2020-04-02T16:09:13Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/TimerTest.java", "diffHunk": "@@ -36,39 +38,121 @@\n   private static final Instant INSTANT = Instant.now();\n \n   @Test\n-  public void testTimer() {\n-    Timer<Void> timerA = Timer.of(INSTANT);\n-    assertEquals(INSTANT, timerA.getTimestamp());\n-    assertNull(timerA.getPayload());\n+  public void testClearTimer() {\n+    Timer<String> clearedTimer = Timer.cleared(\"timer\", \"tag\");\n+    assertTrue(clearedTimer.getClearBit());\n+    assertEquals(\"timer\", clearedTimer.getUserKey());\n+    assertEquals(\"tag\", clearedTimer.getDynamicTimerTag());\n+  }\n \n-    Timer<String> timerB = Timer.of(INSTANT, \"ABC\");\n-    assertEquals(INSTANT, timerB.getTimestamp());\n-    assertEquals(\"ABC\", timerB.getPayload());\n+  @Test\n+  public void testTimer() {\n+    Timer<String> timer =\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING);\n+    assertEquals(\"key\", timer.getUserKey());\n+    assertEquals(\"tag\", timer.getDynamicTimerTag());\n+    assertEquals(INSTANT, timer.getFireTimestamp());\n+    assertEquals(INSTANT, timer.getHoldTimestamp());\n+    assertEquals(Collections.singleton(GlobalWindow.INSTANCE), timer.getWindows());\n+    assertEquals(PaneInfo.NO_FIRING, timer.getPane());\n+    assertFalse(timer.getClearBit());\n   }\n \n   @Test\n-  public void testTimerCoderWithInconsistentWithEqualsPayloadCoder() throws Exception {\n-    Coder<Timer<byte[]>> coder = Timer.Coder.of(ByteArrayCoder.of());\n+  public void testTimerCoderWithInconsistentWithEqualsComponentCoders() throws Exception {\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n     CoderProperties.coderSerializable(coder);\n     CoderProperties.structuralValueDecodeEncodeEqual(\n-        coder, Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)));\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n     CoderProperties.structuralValueConsistentWithEquals(\n-        coder, Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)), Timer.of(INSTANT, \"ABC\".getBytes(UTF_8)));\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING),\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n   }\n \n   @Test\n-  public void testTimerCoderWithConsistentWithEqualsPayloadCoder() throws Exception {\n-    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of());\n-    CoderProperties.coderDecodeEncodeEqual(coder, Timer.of(INSTANT, \"ABC\"));\n+  public void testTimerCoderWithConsistentWithEqualsComponentCoders() throws Exception {\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n+    CoderProperties.coderDecodeEncodeEqual(\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singletonList(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n     CoderProperties.coderConsistentWithEquals(\n-        coder, Timer.of(INSTANT, \"ABC\"), Timer.of(INSTANT, \"ABC\"));\n-    CoderProperties.coderDeterministic(coder, Timer.of(INSTANT, \"ABC\"), Timer.of(INSTANT, \"ABC\"));\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singletonList(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING),\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singletonList(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n+    CoderProperties.coderDeterministic(\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singletonList(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING),\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            INSTANT,\n+            INSTANT,\n+            Collections.singletonList(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING));\n   }\n \n   @Test\n   public void testTimerCoderWireFormat() throws Exception {\n-    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of());\n+    Coder<Timer<String>> coder = Timer.Coder.of(StringUtf8Coder.of(), GlobalWindow.Coder.INSTANCE);\n     CoderProperties.coderEncodesBase64(\n-        coder, Timer.of(new Instant(255L), \"ABC\"), \"gAAAAAAAAP8DQUJD\");\n+        coder,\n+        Timer.of(\n+            \"key\",\n+            \"tag\",\n+            new Instant(225L),\n+            new Instant(225L),\n+            Collections.singleton(GlobalWindow.INSTANCE),\n+            PaneInfo.NO_FIRING),\n+        \"A2tleQN0YWcAgAAAAAAAAOGAAAAAAAAA4QAAAAEP\");\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzNzczMQ==", "bodyText": "Why is this change necessary?", "url": "https://github.com/apache/beam/pull/11199#discussion_r402437731", "createdAt": "2020-04-02T16:14:43Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coders_test_common.py", "diffHunk": "@@ -80,8 +81,9 @@ def tearDownClass(cls):\n         coders.RunnerAPICoderHolder,\n         coders.ToBytesCoder\n     ])\n-    assert not standard - cls.seen, standard - cls.seen\n-    assert not standard - cls.seen_nested, standard - cls.seen_nested\n+    cls.seen_nested -= set([coders.ProtoCoder, CustomCoder])\n+    assert not standard - cls.seen\n+    assert not cls.seen_nested - standard", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzODY2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                # TODO(c): Plumb through actual timer fields.\n          \n          \n            \n                # TODO(BEAM-9562): Plumb through actual timer fields.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402438661", "createdAt": "2020-04-02T16:16:13Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -580,16 +580,36 @@ def __init__(self,\n \n   def set(self, ts):\n     ts = timestamp.Timestamp.of(ts)\n+    # TODO(c): Plumb through actual timer fields.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d63f9cf3ce5b9683505582e4e47554ca5376405e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODgzMzk2", "url": "https://github.com/apache/beam/pull/11199#pullrequestreview-386883396", "createdAt": "2020-04-03T01:30:07Z", "commit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "state": "APPROVED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMTozMDowN1rOGACGdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMTo0OTowOVrOGACZxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NzYwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n          \n          \n            \n              /** Returns a cleared timer for the given {@code userKey}, {@code dynamicTimerTag} and {@code windows}. */", "url": "https://github.com/apache/beam/pull/11199#discussion_r402687607", "createdAt": "2020-04-03T01:30:07Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NzcxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A timer consists of a user key, a dynamic timer tag and either a bit that says that this timer\n          \n          \n            \n             * should be cleared or data representing the firing timestamp, hold timestamp and a list of windows\n          \n          \n            \n             * and pane information that should be used when producing output.\n          \n          \n            \n             * A timer consists of a user key, a dynamic timer tag, a set of windows and either a bit that says that this timer\n          \n          \n            \n             * should be cleared or data representing the firing timestamp, hold timestamp and pane information that should be used when producing output.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402687712", "createdAt": "2020-04-03T01:30:34Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -21,17 +21,29 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n+import java.util.Objects;\n import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n import org.apache.beam.sdk.coders.CoderException;\n+import org.apache.beam.sdk.coders.CollectionCoder;\n import org.apache.beam.sdk.coders.InstantCoder;\n+import org.apache.beam.sdk.coders.StringUtf8Coder;\n import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.state.TimerSpec;\n+import org.apache.beam.sdk.transforms.windowing.BoundedWindow;\n+import org.apache.beam.sdk.transforms.windowing.PaneInfo;\n+import org.apache.beam.sdk.transforms.windowing.PaneInfo.PaneInfoCoder;\n import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n import org.joda.time.Instant;\n \n /**\n- * A timer consists of a timestamp and a corresponding user supplied payload.\n+ * A timer consists of a user key, a dynamic timer tag and either a bit that says that this timer\n+ * should be cleared or data representing the firing timestamp, hold timestamp and a list of windows\n+ * and pane information that should be used when producing output.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4NzgyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n          \n          \n            \n               * TimerSpec}.\n          \n          \n            \n               * Returns the tag that the timer is set on. The tag is {@code \"\"} when the timer is for a {@link\n          \n          \n            \n               * TimerSpec}.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402687822", "createdAt": "2020-04-03T01:31:01Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4ODA4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns the paneinfo that is related to the timer. This field is nullable only when the\n          \n          \n            \n               * timer is being cleared.\n          \n          \n            \n               * Returns the {@link PaneInfo} that is related to the timer. This field is nullable only when the\n          \n          \n            \n               * timer is being cleared.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402688089", "createdAt": "2020-04-03T01:32:03Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /** Returns whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the timer is being cleared.\n    *\n-   * <p>The time is relative to the time domain defined in the {@link\n+   * <p>The time is absolute to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the timer is being cleared.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * timer is being cleared.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4ODc2OQ==", "bodyText": "This will make the method less error prone in case the contract changes.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (this.getClearBit()) {\n          \n          \n            \n                  return Objects.equals(this.getUserKey(), that.getUserKey())\n          \n          \n            \n                      && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n          \n          \n            \n                      && (this.getClearBit() == that.getClearBit())\n          \n          \n            \n                      && Objects.equals(this.getWindows(), that.getWindows());\n          \n          \n            \n                }\n          \n          \n            \n                return Objects.equals(this.getUserKey(), that.getUserKey())\n          \n          \n            \n                    && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n          \n          \n            \n                    && (this.getClearBit() == that.getClearBit())\n          \n          \n            \n                    && this.getFireTimestamp().equals(that.getFireTimestamp())\n          \n          \n            \n                    && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n          \n          \n            \n                    && Objects.equals(this.getWindows(), that.getWindows())\n          \n          \n            \n                    && Objects.equals(this.getPane(), that.getPane());\n          \n          \n            \n              }\n          \n          \n            \n                return Objects.equals(this.getUserKey(), that.getUserKey())\n          \n          \n            \n                    && Objects.equals(this.getDynamicTimerTag(), that.getDynamicTimerTag())\n          \n          \n            \n                    && Objects.equals(this.getWindows(), that.getWindows())\n          \n          \n            \n                    && (this.getClearBit() == that.getClearBit())\n          \n          \n            \n                    && Objects.equals(this.getFireTimestamp(), that.getFireTimestamp())\n          \n          \n            \n                    && Objects.equals(this.getHoldTimestamp(), that.getHoldTimestamp())\n          \n          \n            \n                    && Objects.equals(this.getPane(), that.getPane());\n          \n          \n            \n              }", "url": "https://github.com/apache/beam/pull/11199#discussion_r402688769", "createdAt": "2020-04-03T01:34:41Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /** Returns whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the timer is being cleared.\n    *\n-   * <p>The time is relative to the time domain defined in the {@link\n+   * <p>The time is absolute to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the timer is being cleared.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * timer is being cleared.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    }\n+    Timer<?> that = (Timer<?>) other;\n+    if (this.getClearBit()) {\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && Objects.equals(this.getWindows(), that.getWindows());\n+    }\n+    return Objects.equals(this.getUserKey(), that.getUserKey())\n+        && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+        && (this.getClearBit() == that.getClearBit())\n+        && this.getFireTimestamp().equals(that.getFireTimestamp())\n+        && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n+        && Objects.equals(this.getWindows(), that.getWindows())\n+        && Objects.equals(this.getPane(), that.getPane());\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4ODk3Nw==", "bodyText": "The hash is still stable will null objects.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (getClearBit()) {\n          \n          \n            \n                  return Objects.hash(getUserKey(), getDynamicTimerTag(), getClearBit(), getWindows());\n          \n          \n            \n                }", "url": "https://github.com/apache/beam/pull/11199#discussion_r402688977", "createdAt": "2020-04-03T01:35:30Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /** Returns whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the timer is being cleared.\n    *\n-   * <p>The time is relative to the time domain defined in the {@link\n+   * <p>The time is absolute to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the timer is being cleared.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * timer is being cleared.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    }\n+    Timer<?> that = (Timer<?>) other;\n+    if (this.getClearBit()) {\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && Objects.equals(this.getWindows(), that.getWindows());\n+    }\n+    return Objects.equals(this.getUserKey(), that.getUserKey())\n+        && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+        && (this.getClearBit() == that.getClearBit())\n+        && this.getFireTimestamp().equals(that.getFireTimestamp())\n+        && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n+        && Objects.equals(this.getWindows(), that.getWindows())\n+        && Objects.equals(this.getPane(), that.getPane());\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    // Hash only the millis of the timestamp to be consistent with equals\n+    if (getClearBit()) {\n+      return Objects.hash(getUserKey(), getDynamicTimerTag(), getClearBit(), getWindows());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4OTAzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return Objects.hash(\n          \n          \n            \n                    getUserKey(),\n          \n          \n            \n                    getDynamicTimerTag(),\n          \n          \n            \n                    getClearBit(),\n          \n          \n            \n                    getFireTimestamp().getMillis(),\n          \n          \n            \n                    getHoldTimestamp().getMillis(),\n          \n          \n            \n                    getWindows(),\n          \n          \n            \n                    getPane());\n          \n          \n            \n                return Objects.hash(\n          \n          \n            \n                    getUserKey(),\n          \n          \n            \n                    getDynamicTimerTag(),\n          \n          \n            \n                    getWindows(),\n          \n          \n            \n                    getClearBit(),\n          \n          \n            \n                    getFireTimestamp().getMillis(),\n          \n          \n            \n                    getHoldTimestamp().getMillis(),\n          \n          \n            \n                    getPane());", "url": "https://github.com/apache/beam/pull/11199#discussion_r402689030", "createdAt": "2020-04-03T01:35:45Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /** Returns whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the timer is being cleared.\n    *\n-   * <p>The time is relative to the time domain defined in the {@link\n+   * <p>The time is absolute to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the timer is being cleared.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * timer is being cleared.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    }\n+    Timer<?> that = (Timer<?>) other;\n+    if (this.getClearBit()) {\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && Objects.equals(this.getWindows(), that.getWindows());\n+    }\n+    return Objects.equals(this.getUserKey(), that.getUserKey())\n+        && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+        && (this.getClearBit() == that.getClearBit())\n+        && this.getFireTimestamp().equals(that.getFireTimestamp())\n+        && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n+        && Objects.equals(this.getWindows(), that.getWindows())\n+        && Objects.equals(this.getPane(), that.getPane());\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    // Hash only the millis of the timestamp to be consistent with equals\n+    if (getClearBit()) {\n+      return Objects.hash(getUserKey(), getDynamicTimerTag(), getClearBit(), getWindows());\n+    }\n+    return Objects.hash(\n+        getUserKey(),\n+        getDynamicTimerTag(),\n+        getClearBit(),\n+        getFireTimestamp().getMillis(),\n+        getHoldTimestamp().getMillis(),\n+        getWindows(),\n+        getPane());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4OTE4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * <p>This coder is inexpensive for size estimation of elements if the key coder is inexpensive\n          \n          \n            \n               * for size estimation.\n          \n          \n            \n               * <p>This coder is inexpensive for size estimation of elements if the key coder and window coder are inexpensive\n          \n          \n            \n               * for size estimation.", "url": "https://github.com/apache/beam/pull/11199#discussion_r402689183", "createdAt": "2020-04-03T01:36:25Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */\n+  public abstract Collection<? extends BoundedWindow> getWindows();\n+\n+  /** Returns whether the timer is going to be cleared. */\n+  public abstract boolean getClearBit();\n+\n   /**\n-   * Returns the timestamp of when the timer is scheduled to fire.\n+   * Returns the timestamp of when the timer is scheduled to fire. This field is nullable only when\n+   * the timer is being cleared.\n    *\n-   * <p>The time is relative to the time domain defined in the {@link\n+   * <p>The time is absolute to the time domain defined in the {@link\n    * org.apache.beam.model.pipeline.v1.RunnerApi.TimerFamilySpec} that is associated with this\n    * timer.\n    */\n-  public abstract Instant getTimestamp();\n+  @Nullable\n+  public abstract Instant getFireTimestamp();\n \n-  /** A user supplied payload. */\n+  /**\n+   * Returns the watermark that the timer is supposed to be held. This field is nullable only when\n+   * the timer is being cleared.\n+   */\n   @Nullable\n-  public abstract T getPayload();\n+  public abstract Instant getHoldTimestamp();\n+\n+  /**\n+   * Returns the paneinfo that is related to the timer. This field is nullable only when the\n+   * timer is being cleared.\n+   */\n+  @Nullable\n+  public abstract PaneInfo getPane();\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    if (!(other instanceof Timer)) {\n+      return false;\n+    }\n+    Timer<?> that = (Timer<?>) other;\n+    if (this.getClearBit()) {\n+      return Objects.equals(this.getUserKey(), that.getUserKey())\n+          && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+          && (this.getClearBit() == that.getClearBit())\n+          && Objects.equals(this.getWindows(), that.getWindows());\n+    }\n+    return Objects.equals(this.getUserKey(), that.getUserKey())\n+        && this.getDynamicTimerTag().equals(that.getDynamicTimerTag())\n+        && (this.getClearBit() == that.getClearBit())\n+        && this.getFireTimestamp().equals(that.getFireTimestamp())\n+        && this.getHoldTimestamp().equals(that.getHoldTimestamp())\n+        && Objects.equals(this.getWindows(), that.getWindows())\n+        && Objects.equals(this.getPane(), that.getPane());\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    // Hash only the millis of the timestamp to be consistent with equals\n+    if (getClearBit()) {\n+      return Objects.hash(getUserKey(), getDynamicTimerTag(), getClearBit(), getWindows());\n+    }\n+    return Objects.hash(\n+        getUserKey(),\n+        getDynamicTimerTag(),\n+        getClearBit(),\n+        getFireTimestamp().getMillis(),\n+        getHoldTimestamp().getMillis(),\n+        getWindows(),\n+        getPane());\n+  }\n \n   /**\n    * A {@link org.apache.beam.sdk.coders.Coder} for timers.\n    *\n-   * <p>This coder is deterministic if the payload coder is deterministic.\n+   * <p>This coder is deterministic if both the key coder and window coder are deterministic.\n    *\n-   * <p>This coder is inexpensive for size estimation of elements if the payload coder is\n-   * inexpensive for size estimation.\n+   * <p>This coder is inexpensive for size estimation of elements if the key coder is inexpensive\n+   * for size estimation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY5MjIxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /** Returns the windows which is associated with the timer. */\n          \n          \n            \n              /** Returns the windows which are associated with the timer. */", "url": "https://github.com/apache/beam/pull/11199#discussion_r402692210", "createdAt": "2020-04-03T01:47:52Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/Timer.java", "diffHunk": "@@ -40,92 +52,201 @@\n @AutoValue\n public abstract class Timer<T> {\n \n-  /** Returns a timer for the given timestamp with a {@code null} payload. */\n-  public static Timer<Void> of(Instant time) {\n-    return of(time, (Void) null);\n+  /**\n+   * Returns a non-cleared timer for the given {@code userKey}, {@code dynamicTimerTag}, {@code\n+   * fireTimestamp}, {@code holdTimestamp}, {@code windows} and {@code pane}.\n+   */\n+  public static <T> Timer<T> of(\n+      T userKey,\n+      String dynamicTimerTag,\n+      Collection<? extends BoundedWindow> windows,\n+      Instant fireTimestamp,\n+      Instant holdTimestamp,\n+      PaneInfo pane) {\n+    return new AutoValue_Timer(\n+        userKey, dynamicTimerTag, windows, false, fireTimestamp, holdTimestamp, pane);\n   }\n \n-  /** Returns a timer for the given timestamp with a user specified payload. */\n-  public static <T> Timer<T> of(Instant timestamp, @Nullable T payload) {\n-    return new AutoValue_Timer(timestamp, payload);\n+  /** Returns a cleared timer for the given userKey, dynamicTimerTag and windows. */\n+  public static <T> Timer<T> cleared(\n+      T userKey, String dynamicTimerTag, Collection<? extends BoundedWindow> windows) {\n+    return new AutoValue_Timer(userKey, dynamicTimerTag, windows, true, null, null, null);\n   }\n \n+  /** Returns the key that the timer is set on. */\n+  public abstract T getUserKey();\n+\n+  /**\n+   * Returns the tag that the timer is set on. This tag is {@code \"\"} when the timer is for a {@link\n+   * TimerSpec}.\n+   */\n+  public abstract String getDynamicTimerTag();\n+\n+  /** Returns the windows which is associated with the timer. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY5MjU1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final Instant FIREINSTANT = new Instant(123L);\n          \n          \n            \n              private static final Instant HOLDINSTANT = new Instant(456L);\n          \n          \n            \n              private static final Instant FIRE_TIME = new Instant(123L);\n          \n          \n            \n              private static final Instant HOLD_TIME = new Instant(456L);", "url": "https://github.com/apache/beam/pull/11199#discussion_r402692551", "createdAt": "2020-04-03T01:49:09Z", "author": {"login": "lukecwik"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/TimerTest.java", "diffHunk": "@@ -33,42 +35,128 @@\n /** Tests for {@link Timer}. */\n @RunWith(JUnit4.class)\n public class TimerTest {\n-  private static final Instant INSTANT = Instant.now();\n+  private static final Instant FIREINSTANT = new Instant(123L);\n+  private static final Instant HOLDINSTANT = new Instant(456L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca7a1239ccead1a04fc6d42c1533bb11ea3012b"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "151b2f80997810ed9311124d2831b70a51d1c07a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/151b2f80997810ed9311124d2831b70a51d1c07a", "committedDate": "2020-04-03T05:18:35Z", "message": "Update Timer encoding"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02c783659d23b79b7a1ea88619eb23ab2a889678", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/02c783659d23b79b7a1ea88619eb23ab2a889678", "committedDate": "2020-04-03T03:23:53Z", "message": "Spotless Apply"}, "afterCommit": {"oid": "151b2f80997810ed9311124d2831b70a51d1c07a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/151b2f80997810ed9311124d2831b70a51d1c07a", "committedDate": "2020-04-03T05:18:35Z", "message": "Update Timer encoding"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4630, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}