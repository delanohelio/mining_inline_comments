{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMzM4OTc4", "number": 10752, "title": "[BEAM-9269] Add commit deadline for Spanner writes.", "bodyText": "Spanner's default commit deadline of 60mins does not give enough feedback to the pipeline when the spanner database is overloaded.\nUsing a shorter (configurable) commit deadline of 15secs, along with backoff/retry logic allows the Dataflow pipeline to take some of the load off Spanner when it gets overloaded, leading to greater overall throughput.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-03T14:10:00Z", "url": "https://github.com/apache/beam/pull/10752", "merged": true, "mergeCommit": {"oid": "dd9f5d28cc2f55697283058963fd2d8607aa3cd6"}, "closed": true, "closedAt": "2020-02-12T17:45:35Z", "author": {"login": "nielm"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-0osqgH2gAyMzcwMzM4OTc4OmVjZmIxMjU4ODljMTI4NDhiMWVlYzc0NGUzYmJjYzk3OGQwODY3NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDW4JxAFqTM1NjkzMTQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ecfb125889c12848b1eec744e3bbcc978d086763", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ecfb125889c12848b1eec744e3bbcc978d086763", "committedDate": "2020-01-28T17:17:45Z", "message": "Add commit deadline for Spanner writes.\n\nSpanner's default commit deadline of 60mins does not give enough\nfeedback to the pipeline when it is overloaded.\n\nUsing a shorter (configurable) commit deadline of 15secs, along\nwith backoff/retry logic allows the Dataflow pipeline to take\nsome of the load off Spanner when it gets overloaded, often\nleading to greater overall throughput."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzU5MTU5", "url": "https://github.com/apache/beam/pull/10752#pullrequestreview-356359159", "createdAt": "2020-02-11T00:24:41Z", "commit": {"oid": "ecfb125889c12848b1eec744e3bbcc978d086763"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDoyNDo0MVrOFn6Wpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMDozNDozOVrOFn6haQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NDg1NQ==", "bodyText": "Can this be made configurable.", "url": "https://github.com/apache/beam/pull/10752#discussion_r377394855", "createdAt": "2020-02-11T00:24:41Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerConfig.java", "diffHunk": "@@ -42,6 +50,10 @@\n   private static final String USER_AGENT_PREFIX = \"Apache_Beam_Java\";\n   // A default host name for batch traffic.\n   private static final String DEFAULT_HOST = \"https://batch-spanner.googleapis.com/\";\n+  // Deadline for Commit API call.\n+  private static final Duration DEFAULT_COMMIT_DEADLINE = Duration.standardSeconds(15);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecfb125889c12848b1eec744e3bbcc978d086763"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NTU2Nw==", "bodyText": "we can remove this if this is not being used.", "url": "https://github.com/apache/beam/pull/10752#discussion_r377395567", "createdAt": "2020-02-11T00:27:10Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1285,30 +1373,84 @@ public void processElement(ProcessContext c) throws Exception {\n       boolean tryIndividual = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecfb125889c12848b1eec744e3bbcc978d086763"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NzYwOQ==", "bodyText": "Would an average writeLatency(if its possible to calculate) be more actionable to the user rather than a total write latency? In the sense, if the write latency is high then the user can reduce the workers.", "url": "https://github.com/apache/beam/pull/10752#discussion_r377397609", "createdAt": "2020-02-11T00:34:39Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1248,20 +1307,44 @@ public void processElement(ProcessContext c) {\n     }\n   }\n \n-  private static class WriteToSpannerFn extends DoFn<Iterable<MutationGroup>, Void> {\n+  @VisibleForTesting\n+  static class WriteToSpannerFn extends DoFn<Iterable<MutationGroup>, Void> {\n \n     private transient SpannerAccessor spannerAccessor;\n     private final SpannerConfig spannerConfig;\n     private final FailureMode failureMode;\n-    private final Counter mutationGroupBatchesCounter =\n-        Metrics.counter(WriteGrouped.class, \"mutation_group_batches\");\n-    private final Counter mutationGroupWriteSuccessCounter =\n+\n+    @VisibleForTesting static Sleeper sleeper = Sleeper.DEFAULT;\n+\n+    private final Counter mutationGroupBatchesReceived =\n+        Metrics.counter(WriteGrouped.class, \"mutation_group_batches_received\");\n+    private final Counter mutationGroupBatchesWriteSuccess =\n+        Metrics.counter(WriteGrouped.class, \"mutation_group_batches_write_success\");\n+    private final Counter mutationGroupBatchesWriteFail =\n+        Metrics.counter(WriteGrouped.class, \"mutation_group_batches_write_fail\");\n+\n+    private final Counter mutationGroupsReceived =\n+        Metrics.counter(WriteGrouped.class, \"mutation_groups_received\");\n+    private final Counter mutationGroupsWriteSuccess =\n         Metrics.counter(WriteGrouped.class, \"mutation_groups_write_success\");\n-    private final Counter mutationGroupWriteFailCounter =\n+    private final Counter mutationGroupsWriteFail =\n         Metrics.counter(WriteGrouped.class, \"mutation_groups_write_fail\");\n \n+    private final Counter spannerWriteSuccess =\n+        Metrics.counter(WriteGrouped.class, \"spanner_write_success\");\n+    private final Counter spannerWriteFail =\n+        Metrics.counter(WriteGrouped.class, \"spanner_write_fail\");\n+    private final Counter spannerWriteTotalLatency =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecfb125889c12848b1eec744e3bbcc978d086763"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1ff5b808020d237e2e0e23c453b52a192ef2ae", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/fd1ff5b808020d237e2e0e23c453b52a192ef2ae", "committedDate": "2020-02-11T11:37:55Z", "message": "Remove unused variable, fix log message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODc0MTE1", "url": "https://github.com/apache/beam/pull/10752#pullrequestreview-356874115", "createdAt": "2020-02-11T18:02:10Z", "commit": {"oid": "fd1ff5b808020d237e2e0e23c453b52a192ef2ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTMxNDA3", "url": "https://github.com/apache/beam/pull/10752#pullrequestreview-356931407", "createdAt": "2020-02-11T19:27:06Z", "commit": {"oid": "fd1ff5b808020d237e2e0e23c453b52a192ef2ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxOToyNzowNlrOFoWGaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxOToyNzowNlrOFoWGaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg0OTQ0OQ==", "bodyText": "Just to confirm, this deadline will not cause Dataflow workitems to fail but just that request will be retried by SpannerIO within the same workitem ? (otherwise jobs can significantly slow down or fail if we rely on workitem retries.)", "url": "https://github.com/apache/beam/pull/10752#discussion_r377849449", "createdAt": "2020-02-11T19:27:06Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerConfig.java", "diffHunk": "@@ -136,13 +163,51 @@ public SpannerConfig withHost(ValueProvider<String> host) {\n     return toBuilder().setHost(host).build();\n   }\n \n+  public SpannerConfig withCommitDeadline(Duration commitDeadline) {\n+    return withCommitDeadline(ValueProvider.StaticValueProvider.of(commitDeadline));\n+  }\n+\n+  public SpannerConfig withCommitDeadline(ValueProvider<Duration> commitDeadline) {\n+    return toBuilder().setCommitDeadline(commitDeadline).build();\n+  }\n+\n+  public SpannerConfig withMaxCumulativeBackoff(Duration maxCumulativeBackoff) {\n+    return withMaxCumulativeBackoff(ValueProvider.StaticValueProvider.of(maxCumulativeBackoff));\n+  }\n+\n+  public SpannerConfig withMaxCumulativeBackoff(ValueProvider<Duration> maxCumulativeBackoff) {\n+    return toBuilder().setMaxCumulativeBackoff(maxCumulativeBackoff).build();\n+  }\n+\n   @VisibleForTesting\n   SpannerConfig withServiceFactory(ServiceFactory<Spanner, SpannerOptions> serviceFactory) {\n     return toBuilder().setServiceFactory(serviceFactory).build();\n   }\n \n   public SpannerAccessor connectToSpanner() {\n     SpannerOptions.Builder builder = SpannerOptions.newBuilder();\n+\n+    if (getCommitDeadline() != null && getCommitDeadline().get().getMillis() > 0) {\n+\n+      // In Spanner API version 1.21 or above, we can set the deadline / total Timeout on an API\n+      // call using the following code:\n+      //\n+      // UnaryCallSettings.Builder commitSettings =\n+      // builder.getSpannerStubSettingsBuilder().commitSettings();\n+      // RetrySettings.Builder commitRetrySettings = commitSettings.getRetrySettings().toBuilder()\n+      // commitSettings.setRetrySettings(\n+      //     commitRetrySettings.setTotalTimeout(\n+      //         Duration.ofMillis(getCommitDeadlineMillis().get()))\n+      //     .build());\n+      //\n+      // However, at time of this commit, the Spanner API is at only at v1.6.0, where the only\n+      // method to set a deadline is with GRPC Interceptors, so we have to use that...\n+      SpannerInterceptorProvider interceptorProvider =\n+          SpannerInterceptorProvider.createDefault()\n+              .with(new CommitDeadlineSettingInterceptor(getCommitDeadline().get()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd1ff5b808020d237e2e0e23c453b52a192ef2ae"}, "originalPosition": 115}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3361, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}