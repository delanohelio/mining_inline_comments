{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDY5NTk2", "number": 12172, "title": "[BEAM-10185] Building python wheels for Windows (on Github Actions)", "bodyText": "This PR adds the Windows configuration to the existing mechanism that generates python wheels using Github Actions.\nAs the POSIX functions usleep and clock_gettime are not present on the Windows platform, alternative versions have to be implemented using native API. The conditional compilation (depending on the platform) is introduced to choose the correct implementation.\nOn Windows XP and later the implementation of clock_gettime is guaranteed to have a resolution higher than 1\u00b5s. The real resolution of the usleep seems to be around tens of \u00b5s on my machine. That's about two orders of magnitude worse than posix version on my ubuntu, but that's probably related to the OS scheduler. Anyway, that shouldn't be an issue in the current usage of the function.\nCredits for @TobKed for the Github actions configuration. I've only helped with the proper cythonization on Windows.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-03T13:51:51Z", "url": "https://github.com/apache/beam/pull/12172", "merged": true, "mergeCommit": {"oid": "188f89dc8c06895da2c0597aae4d0ec1c3f2416f"}, "closed": true, "closedAt": "2020-07-17T16:31:40Z", "author": {"login": "damgad"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxXyhJAFqTQ0MjUzMTE2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1kdOFABqjM1NTQ4MTE5OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTMxMTYx", "url": "https://github.com/apache/beam/pull/12172#pullrequestreview-442531161", "createdAt": "2020-07-03T18:31:22Z", "commit": {"oid": "8a17e6c0d4ad2cf73c81ba24dd67b28970be1d52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTAwNjM4", "url": "https://github.com/apache/beam/pull/12172#pullrequestreview-443500638", "createdAt": "2020-07-07T01:22:23Z", "commit": {"oid": "8a17e6c0d4ad2cf73c81ba24dd67b28970be1d52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMToyMjoyNFrOGtsAKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMToyMjoyNFrOGtsAKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2MDA0MQ==", "bodyText": "cp27 is missing for windows-latests above. Why are we installing a Python 2.7 compiler?", "url": "https://github.com/apache/beam/pull/12172#discussion_r450560041", "createdAt": "2020-07-07T01:22:24Z", "author": {"login": "aaltay"}, "path": ".github/workflows/build_wheels.yml", "diffHunk": "@@ -119,19 +123,24 @@ jobs:\n       uses: actions/setup-python@v2\n       with:\n         python-version: 3.7\n+    - name: Install Visual C++ for Python 2.7 on Windows", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a17e6c0d4ad2cf73c81ba24dd67b28970be1d52"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Njc3Mjkx", "url": "https://github.com/apache/beam/pull/12172#pullrequestreview-446677291", "createdAt": "2020-07-10T20:17:35Z", "commit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDoxNzozNVrOGwEf5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDoxNzozNVrOGwEf5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1ODUzMw==", "bodyText": "These error codes are never checked by the callers. That would seem to give incorrect results (especially if timespec is initialized with random data (e.g. on the stack) each time.\nIs there a simpler/more robust API we could call instead in this case, even if it is lower precision?", "url": "https://github.com/apache/beam/pull/12172#discussion_r453058533", "createdAt": "2020-07-10T20:17:35Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef BEAM_CROSSPLATFORM_TIME_H\n+#define BEAM_CROSSPLATFORM_TIME_H\n+\n+#include <time.h>\n+\n+#ifdef _WIN32\n+#include <windows.h>\n+\n+/**\n+ * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n+ * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ */\n+int clock_gettime(int clk_id, struct timespec *tv) {\n+    static LARGE_INTEGER counterFrequency = {0};\n+    LARGE_INTEGER counterValue;\n+\n+    if (0 == counterFrequency.QuadPart) {\n+        if (0 == QueryPerformanceFrequency(&counterFrequency)) {\n+            /* System doesn't support performance counters. It's guaranteed to not happen\n+            on systems that run Windows XP or later */\n+            return -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d7aaf2d891a6edcc7b3a219aa28eab72ec1ee0"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjAwOTMx", "url": "https://github.com/apache/beam/pull/12172#pullrequestreview-449200931", "createdAt": "2020-07-15T17:58:51Z", "commit": {"oid": "1f4edc685c53533ce967be1b3ab959aafc571cf1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1ODo1MVrOGyJh4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1ODo1MVrOGyJh4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzODExNQ==", "bodyText": "nit:\nThis part if (0 == counterFrequency.QuadPart && performanceCounterAvailable) could be simplified to if (0 == counterFrequency.QuadPart) because counterFrequency.QuadPart will be set to a non-zero value either way after the first query.", "url": "https://github.com/apache/beam/pull/12172#discussion_r455238115", "createdAt": "2020-07-15T17:58:51Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/runners/worker/crossplatform_time.h", "diffHunk": "@@ -26,24 +26,32 @@\n \n /**\n  * Alternative to POSIX clock_gettime that may be run on Windows platform. The clk_id parameter is\n- * ignored, and function always act as for CLOCK_MONOTONIC. Windows performance counter is used.\n+ * ignored and function act as for CLOCK_MONOTONIC. On Windows XP or later Performance Counter is used.\n+ * On older platforms, where there's no Performance Counter, SystemTime will be used as a failover.\n  */\n int clock_gettime(int clk_id, struct timespec *tv) {\n     static LARGE_INTEGER counterFrequency = {0};\n-    LARGE_INTEGER counterValue;\n+    static BOOL performanceCounterAvailable = TRUE;\n+    LARGE_INTEGER counterValue = {0};\n \n-    if (0 == counterFrequency.QuadPart) {\n+    //initialization\n+    if (0 == counterFrequency.QuadPart && performanceCounterAvailable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f4edc685c53533ce967be1b3ab959aafc571cf1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3afb6aff52f2f9406a7d93e89668fc50c4711534", "author": {"user": {"login": "TobKed", "name": "Tobiasz K\u0119dzierski"}}, "url": "https://github.com/apache/beam/commit/3afb6aff52f2f9406a7d93e89668fc50c4711534", "committedDate": "2020-07-16T09:35:47Z", "message": "Build python wheels on GItHub actions for Windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b2c16be47b8e0c7986d5190e116211b07192442", "author": {"user": {"login": "TobKed", "name": "Tobiasz K\u0119dzierski"}}, "url": "https://github.com/apache/beam/commit/1b2c16be47b8e0c7986d5190e116211b07192442", "committedDate": "2020-07-16T09:35:47Z", "message": "Turn on cythonize for Windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "921d0db15909736d1a16e759afaae437e4d3e403", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/921d0db15909736d1a16e759afaae437e4d3e403", "committedDate": "2020-07-16T09:35:47Z", "message": "added crossplatform time.h and unistd.h headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba8fee945fcb5d4525fe24a93461fb753b2f0ea4", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/ba8fee945fcb5d4525fe24a93461fb753b2f0ea4", "committedDate": "2020-07-16T09:35:48Z", "message": "adding h files to sdist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51641952730e9baa1499ae238f69537de110f077", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/51641952730e9baa1499ae238f69537de110f077", "committedDate": "2020-07-16T09:35:48Z", "message": "fixed cp37 wheel for windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e087bb07c9f2e7d4c30e89bdae12fbebe9974582", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/e087bb07c9f2e7d4c30e89bdae12fbebe9974582", "committedDate": "2020-07-16T09:35:49Z", "message": "added lincense headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6ad155dd440d282070262de66840593ba6dd927", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/a6ad155dd440d282070262de66840593ba6dd927", "committedDate": "2020-07-16T09:35:49Z", "message": "fixed python line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cfb8c2c3faf67511d9ec1c1c929ea21b0919209", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/0cfb8c2c3faf67511d9ec1c1c929ea21b0919209", "committedDate": "2020-07-16T09:35:49Z", "message": "removing vcpython27 from windows wheels dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db00471e246d31f772aeb8fbd66a25e91ff5bbf", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/2db00471e246d31f772aeb8fbd66a25e91ff5bbf", "committedDate": "2020-07-16T09:35:50Z", "message": "clock_gettime: adding failover procedure if performance counter is not available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db208d6ac9f797ed24bf8d1a4ce9af7aac6f28f0", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/db208d6ac9f797ed24bf8d1a4ce9af7aac6f28f0", "committedDate": "2020-07-16T11:40:37Z", "message": "fixing wheels 'Add checksums' step on windows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f4edc685c53533ce967be1b3ab959aafc571cf1", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/1f4edc685c53533ce967be1b3ab959aafc571cf1", "committedDate": "2020-07-15T09:40:14Z", "message": "clock_gettime: adding failover procedure if performance counter is not available"}, "afterCommit": {"oid": "db208d6ac9f797ed24bf8d1a4ce9af7aac6f28f0", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/db208d6ac9f797ed24bf8d1a4ce9af7aac6f28f0", "committedDate": "2020-07-16T11:40:37Z", "message": "fixing wheels 'Add checksums' step on windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2670b86aa9c701a365f585fac67cd72803b06468", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/2670b86aa9c701a365f585fac67cd72803b06468", "committedDate": "2020-07-16T12:53:27Z", "message": "simplifying initialization condition for clock_gettime windows implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd6e4f4f38466eebe310be12ec30d5d41579b931", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/fd6e4f4f38466eebe310be12ec30d5d41579b931", "committedDate": "2020-07-16T14:07:43Z", "message": "fixed os variable name in buildwheels gh actions workflow"}, "afterCommit": {"oid": "5ffd35c1b6d57ee49e2e08236dff443111cb036b", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/5ffd35c1b6d57ee49e2e08236dff443111cb036b", "committedDate": "2020-07-16T15:12:43Z", "message": "fixed os variable name in buildwheels gh actions workflow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f7367cea6351f2f7addfdd2d22a3c1b0289b27", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/d1f7367cea6351f2f7addfdd2d22a3c1b0289b27", "committedDate": "2020-07-16T19:32:24Z", "message": "fixed os variable name in buildwheels gh actions workflow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ffd35c1b6d57ee49e2e08236dff443111cb036b", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/5ffd35c1b6d57ee49e2e08236dff443111cb036b", "committedDate": "2020-07-16T15:12:43Z", "message": "fixed os variable name in buildwheels gh actions workflow"}, "afterCommit": {"oid": "d1f7367cea6351f2f7addfdd2d22a3c1b0289b27", "author": {"user": {"login": "damgad", "name": "Damian Gadomski"}}, "url": "https://github.com/apache/beam/commit/d1f7367cea6351f2f7addfdd2d22a3c1b0289b27", "committedDate": "2020-07-16T19:32:24Z", "message": "fixed os variable name in buildwheels gh actions workflow"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3358, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}