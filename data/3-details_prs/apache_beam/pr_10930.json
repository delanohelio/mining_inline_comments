{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDY2MDg1", "number": 10930, "title": "[BEAM-9252] Exclude jboss's Main and module-info.java", "bodyText": "CC: @robinyqiu\nHow to install the vendored JAR locally\nsuztomo@suxtomo24:~/beam6/vendor/grpc-1_26_0$ ../../gradlew -PvendoredDependenciesOnly -Ppublishing publishToMavenLocal\nConfiguration on demand is an incubating feature.\n\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 6.0.\nUse '--warning-mode all' to show the individual deprecation warnings.\nSee https://docs.gradle.org/5.2.1/userguide/command_line_interface.html#sec:command_line_warnings\n\nBUILD SUCCESSFUL in 12s\n4 actionable tasks: 4 executed\nsuztomo@suxtomo24:~/beam6/vendor/grpc-1_26_0$ jar tf /usr/local/google/home/suztomo/.m2/repository/org/apache/beam/beam-vendor-grpc-1_26_0/0.2-SNAPSHOT/beam-vendor-grpc-1_26_0-0.2-SNAPSHOT.jar |grep org/jboss/modules/Main\nsuztomo@suxtomo24:~/beam6/vendor/grpc-1_26_0$ jar tf /usr/local/google/home/suztomo/.m2/repository/org/apache/beam/beam-vendor-grpc-1_26_0/0.2-SNAPSHOT/beam-vendor-grpc-1_26_0-0.2-SNAPSHOT.jar |grep module-info\nsuztomo@suxtomo24:~/beam6/vendor/grpc-1_26_0$ \n\nHow to use the vendored JAR from Maven project\nsuztomo@suxtomo24:~/jbonofre-beam-samples$ git diff\ndiff --git a/pom.xml b/pom.xml\nindex 6296cf2..2a366e1 100644\n--- a/pom.xml\n+++ b/pom.xml\n@@ -79,6 +79,12 @@\n \n     <dependencyManagement>\n         <dependencies>\n+            <!-- Temporary override to confirm the shading issue (BEAM-9252) -->\n+            <dependency>\n+                <groupId>org.apache.beam</groupId>\n+                <artifactId>beam-vendor-grpc-1_26_0</artifactId>\n+                <version>0.2-SNAPSHOT</version>\n+            </dependency>\n\nThe solution worked for jbonofre-beam-samples shading: https://gist.github.com/suztomo/929f82458c30176de669e0abf1a443a4 .\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-21T20:47:27Z", "url": "https://github.com/apache/beam/pull/10930", "merged": true, "mergeCommit": {"oid": "91125d1d1fc1fe8c5684a486c9b6163c4ec41549"}, "closed": true, "closedAt": "2020-02-22T00:12:02Z", "author": {"login": "suztomo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGl85jAH2gAyMzc4NDY2MDg1OjhmYjI3YThjNzE5NGJhMGVjYjkxMDliZTI3MWQ0M2Q3YWRjZDZkNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGnKz4AFqTM2Mjk0NjQzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8fb27a8c7194ba0ecb9109be271d43d7adcd6d77", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/apache/beam/commit/8fb27a8c7194ba0ecb9109be271d43d7adcd6d77", "committedDate": "2020-02-21T20:42:38Z", "message": "Exclude jboss's Main and module-info.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTI2NzA1", "url": "https://github.com/apache/beam/pull/10930#pullrequestreview-362926705", "createdAt": "2020-02-21T21:26:21Z", "commit": {"oid": "8fb27a8c7194ba0ecb9109be271d43d7adcd6d77"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMToyNjoyMVrOFtFEeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTozMjowOFrOFtFNCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgxMzMwNg==", "bodyText": "A similar change is needed in:\n\n  \n    \n      beam/buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy\n    \n    \n         Line 970\n      in\n      1133f7b\n    \n    \n    \n    \n\n        \n          \n           exclude \"**/module-info.class\"", "url": "https://github.com/apache/beam/pull/10930#discussion_r382813306", "createdAt": "2020-02-21T21:26:21Z", "author": {"login": "lukecwik"}, "path": "buildSrc/src/main/groovy/org/apache/beam/gradle/VendorJavaPlugin.groovy", "diffHunk": "@@ -131,15 +131,15 @@ artifactId=${project.name}\n         inputs.files project.configurations.shadow.artifacts.files\n         doLast {\n           project.configurations.shadow.artifacts.files.each {\n-            FileTree exposedClasses = project.zipTree(it).matching {\n+            FileTree unexpectedlyExposedClasses = project.zipTree(it).matching {\n               include \"**/*.class\"\n               exclude \"org/apache/beam/vendor/**\"\n               // BEAM-5919: Exclude paths for Java 9 multi-release jars.\n-              exclude \"**/module-info.class\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb27a8c7194ba0ecb9109be271d43d7adcd6d77"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgxNTQ5Ng==", "bodyText": "The glob matching semantics allegedly follow ANT pattern matching so I'm lost as to why **/module-info.class didn't exclude the top level pattern.", "url": "https://github.com/apache/beam/pull/10930#discussion_r382815496", "createdAt": "2020-02-21T21:32:08Z", "author": {"login": "lukecwik"}, "path": "buildSrc/src/main/groovy/org/apache/beam/gradle/VendorJavaPlugin.groovy", "diffHunk": "@@ -131,15 +131,15 @@ artifactId=${project.name}\n         inputs.files project.configurations.shadow.artifacts.files\n         doLast {\n           project.configurations.shadow.artifacts.files.each {\n-            FileTree exposedClasses = project.zipTree(it).matching {\n+            FileTree unexpectedlyExposedClasses = project.zipTree(it).matching {\n               include \"**/*.class\"\n               exclude \"org/apache/beam/vendor/**\"\n               // BEAM-5919: Exclude paths for Java 9 multi-release jars.\n-              exclude \"**/module-info.class\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb27a8c7194ba0ecb9109be271d43d7adcd6d77"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6935576731fe5043a5e4a8abfeb82984c2b97ed", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/apache/beam/commit/b6935576731fe5043a5e4a8abfeb82984c2b97ed", "committedDate": "2020-02-21T22:04:44Z", "message": "Not to ignore root module-info.class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQ2Mjc2", "url": "https://github.com/apache/beam/pull/10930#pullrequestreview-362946276", "createdAt": "2020-02-21T22:07:26Z", "commit": {"oid": "b6935576731fe5043a5e4a8abfeb82984c2b97ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMjowNzoyNlrOFtGAow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMjowNzoyNlrOFtGAow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyODcwNw==", "bodyText": "Reverting this change https://github.com/apache/beam/pull/10463/files#r382787180 . validateShadedJarDoesntLeakNonProjectClasses should fail upon root module-info.class.", "url": "https://github.com/apache/beam/pull/10930#discussion_r382828707", "createdAt": "2020-02-21T22:07:26Z", "author": {"login": "suztomo"}, "path": "buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy", "diffHunk": "@@ -967,7 +967,7 @@ class BeamModulePlugin implements Plugin<Project> {\n                 FileTree exposedClasses = project.zipTree(it).matching {\n                   include \"**/*.class\"\n                   // BEAM-5919: Exclude paths for Java 9 multi-release jars.\n-                  exclude \"**/module-info.class\"\n+                  exclude \"META-INF/versions/*/module-info.class\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6935576731fe5043a5e4a8abfeb82984c2b97ed"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQ2NDMy", "url": "https://github.com/apache/beam/pull/10930#pullrequestreview-362946432", "createdAt": "2020-02-21T22:07:44Z", "commit": {"oid": "b6935576731fe5043a5e4a8abfeb82984c2b97ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2837, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}