{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTY4Mzc2", "number": 10627, "title": "[BEAM-2535] Support outputTimestamp and watermark holds in processing timers.", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-17T14:31:16Z", "url": "https://github.com/apache/beam/pull/10627", "merged": true, "mergeCommit": {"oid": "a005fd765a762183ca88df90f261f6d4a20cf3e0"}, "closed": true, "closedAt": "2020-02-09T07:55:28Z", "author": {"login": "rehmanmuradali"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7PoU2gH2gAyMzY0MTY4Mzc2OmRlNmQzYWIwMWVjYzA1NjQ3ZmZjYWU5ZDA5NTMwZmViOTU1YzYzMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBw3jsAH2gAyMzY0MTY4Mzc2OjYzZjNhNzFlNGQzZDU0OWY4YzcyZDExMzA5N2NhMDFhMjExMzk5OGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "de6d3ab01ecc05647ffcae9d09530feb955c6300", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/de6d3ab01ecc05647ffcae9d09530feb955c6300", "committedDate": "2020-01-17T14:29:05Z", "message": "Adding outputTimestamp for processing Timers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695db95297c55326e5585693178765eff57e520b", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/695db95297c55326e5585693178765eff57e520b", "committedDate": "2020-01-17T20:02:42Z", "message": "Calculating outputTimestamp with outputTimestampOffset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41cbfb5e50d172d980f34fda66d3981f7d308dd5", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/41cbfb5e50d172d980f34fda66d3981f7d308dd5", "committedDate": "2020-01-17T20:44:33Z", "message": "Correcting calculation of outputtimestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00dceb3d8a15831a9c074b93f797b388456dfc49", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/00dceb3d8a15831a9c074b93f797b388456dfc49", "committedDate": "2020-01-21T12:30:25Z", "message": "Updating test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41d3912f47bfd23de1be9b8930ace22729582bf", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/e41d3912f47bfd23de1be9b8930ace22729582bf", "committedDate": "2020-01-23T16:50:56Z", "message": "Updating Input and Output Watermarks for processing timers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0b2e2ee3f3282149cf0906828620d41d0a88f9b", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/a0b2e2ee3f3282149cf0906828620d41d0a88f9b", "committedDate": "2020-01-23T17:06:39Z", "message": "Adding outputTimestamp category in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a33f137f7caa8ed45c80d94f439972fd5e7bb9f7", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/a33f137f7caa8ed45c80d94f439972fd5e7bb9f7", "committedDate": "2020-01-24T08:03:50Z", "message": "Merge branch 'master' into feature/processing-time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87906d1370a2215292c9f1aacb5973942f322eee", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/87906d1370a2215292c9f1aacb5973942f322eee", "committedDate": "2020-01-24T10:34:39Z", "message": "Add missing imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f401ed216cb55e42630baa13a2af230e9ba12c", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/17f401ed216cb55e42630baa13a2af230e9ba12c", "committedDate": "2020-01-27T13:04:26Z", "message": "Updating firedTime for processingTimers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef4407f489d076b19078eb4526f4e37098ceb30b", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/ef4407f489d076b19078eb4526f4e37098ceb30b", "committedDate": "2020-01-28T11:09:50Z", "message": "Updating OnTimer, Removed equal checks in test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/aa1a9386b4e9a0c7ce321f732f2c16677a9e773e", "committedDate": "2020-01-28T11:11:24Z", "message": "Merge branch 'master' into feature/processing-time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzk2OTI1", "url": "https://github.com/apache/beam/pull/10627#pullrequestreview-350396925", "createdAt": "2020-01-29T20:18:35Z", "commit": {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDoxODozNVrOFjWQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDoyMzoxMVrOFjWX8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwOTA2MA==", "bodyText": "I'm not sure that we need withOutputTimestampOffset - I think withOutputTimestamp is sufficient.", "url": "https://github.com/apache/beam/pull/10627#discussion_r372609060", "createdAt": "2020-01-29T20:18:35Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1074,6 +1075,12 @@ public Timer withOutputTimestamp(Instant outputTimestamp) {\n       return this;\n     }\n \n+    @Override\n+    public Timer withOutputTimestampOffset(Duration outputTimestampOffset) {\n+      this.outputTimestampOffset = outputTimestampOffset;\n+      return this;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMDczMQ==", "bodyText": "I think that we should verify that the output timestamp is > the timestamp of the input message (if in processElement) or the output timestamp of the firing timer (if in processTimer). The < check remains correct - even for processing-time timers.", "url": "https://github.com/apache/beam/pull/10627#discussion_r372610731", "createdAt": "2020-01-29T20:22:23Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,15 +1099,19 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n \n+      if (TimeDomain.PROCESSING_TIME.equals(spec.getTimeDomain())) {\n+        outputTimestamp =\n+            outputTimestampOffset.equals(Duration.ZERO)\n+                ? target\n+                : target.minus(offset.minus(outputTimestampOffset));\n+      }\n+\n       if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMTA1OQ==", "bodyText": "I think that if the timer is processing time, then then default outputTimestamp should be that of the input element (or the output time of the firing timer if in processTimer).", "url": "https://github.com/apache/beam/pull/10627#discussion_r372611059", "createdAt": "2020-01-29T20:23:11Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,15 +1099,19 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa1a9386b4e9a0c7ce321f732f2c16677a9e773e"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e27d620e4a3b91ddec8823be22a42a9f8c98fbba", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/e27d620e4a3b91ddec8823be22a42a9f8c98fbba", "committedDate": "2020-01-30T14:29:23Z", "message": "Removing outputTimestamp Offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1ee2202255475d121b0880ee345d41848162c9", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/1d1ee2202255475d121b0880ee345d41848162c9", "committedDate": "2020-01-30T18:17:16Z", "message": "Adding validation of output timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cac7b674ce8afafa920112e81d049e843a049b02", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/cac7b674ce8afafa920112e81d049e843a049b02", "committedDate": "2020-01-30T19:41:36Z", "message": "Adding validation of output timestamp with respect to input element and firing timer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/54e897759e7a07a92116a027e38f15db08d5f08d", "committedDate": "2020-01-30T19:45:54Z", "message": "Minor fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTExNDM1", "url": "https://github.com/apache/beam/pull/10627#pullrequestreview-351111435", "createdAt": "2020-01-30T20:13:42Z", "commit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDoxMzo0MlrOFj4gCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDoyNToxNFrOFj4zzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDE4Nw==", "bodyText": "I think this should be timestamp(), not fireTimestamp().", "url": "https://github.com/apache/beam/pull/10627#discussion_r373170187", "createdAt": "2020-01-30T20:13:42Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -930,7 +935,7 @@ public Timer timer(String timerId) {\n       try {\n         TimerSpec spec = (TimerSpec) signature.timerDeclarations().get(timerId).field().get(fn);\n         return new TimerInternalsTimer(\n-            window, getNamespace(), timerId, spec, stepContext.timerInternals());\n+            window, getNamespace(), timerId, spec, fireTimestamp(), stepContext.timerInternals());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MDMxNg==", "bodyText": "ditto - this should be timestamp() not fireTimestamp()", "url": "https://github.com/apache/beam/pull/10627#discussion_r373170316", "createdAt": "2020-01-30T20:13:57Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -942,7 +947,12 @@ public TimerMap timerFamily(String timerFamilyId) {\n         TimerSpec spec =\n             (TimerSpec) signature.timerFamilyDeclarations().get(timerFamilyId).field().get(fn);\n         return new TimerInternalsTimerMap(\n-            timerFamilyId, window(), getNamespace(), spec, stepContext.timerInternals());\n+            timerFamilyId,\n+            window(),\n+            getNamespace(),\n+            spec,\n+            fireTimestamp(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MTA3Ng==", "bodyText": "check outputTimestamp is in the window for processing-timer as well.", "url": "https://github.com/apache/beam/pull/10627#discussion_r373171076", "createdAt": "2020-01-30T20:15:39Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,14 +1107,25 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n+      // For processing timers\n+      if (outputTimestamp == null) {\n+        // For processing timers output timestamp will be:\n+        // 1) timestamp of input element\n+        // OR\n+        // 2) output timestamp of firing timer.\n+        outputTimestamp = elementInputTimestamp;\n+      }\n+\n+      checkArgument(\n+          !outputTimestamp.isBefore(elementInputTimestamp),\n+          \"output timestamp %s should be after input message timestamp or output timestamp of firing timers %s\",\n+          outputTimestamp,\n+          elementInputTimestamp);\n \n       if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3MjAwMQ==", "bodyText": "I think you want the second DoFn to set an event-time timer. That way you can test that the watermark hold in the first DoFn prevents firing of the second DoFn's timer, which it will only do if the second DoFn's timer is even time.", "url": "https://github.com/apache/beam/pull/10627#discussion_r373172001", "createdAt": "2020-01-30T20:17:46Z", "author": {"login": "reuvenlax"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3807,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NDgyOQ==", "bodyText": "I don't think this is right. We want to fire timers based on firing time, not based on the hold.", "url": "https://github.com/apache/beam/pull/10627#discussion_r373174829", "createdAt": "2020-01-30T20:24:18Z", "author": {"login": "reuvenlax"}, "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -676,7 +676,9 @@ private synchronized void updateTimers(TimerUpdate update) {\n       Map<StructuralKey<?>, List<TimerData>> firedTimers;\n       switch (domain) {\n         case PROCESSING_TIME:\n-          firedTimers = extractFiredTimers(firingTime, processingTimers);\n+          firedTimers =\n+              extractFiredTimers(\n+                  INSTANT_ORDERING.min(firingTime, earliestHold.get()), processingTimers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE3NTI0NA==", "bodyText": "I wonder if this is sufficient. The NavigableSet is ordered by timer firing time, not by outputTimestamp. This means that the logic to just look at the first timer (which was correct before we had holds) is probably no longer enough. we probably need to iterate over the set (or we need to have a second data structure to hold the watermark holds and take the minimum of that data structure).", "url": "https://github.com/apache/beam/pull/10627#discussion_r373175244", "createdAt": "2020-01-30T20:25:14Z", "author": {"login": "reuvenlax"}, "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -597,16 +597,16 @@ public synchronized Instant getEarliestTimerTimestamp() {\n       Instant earliest = THE_END_OF_TIME.get();\n       for (NavigableSet<TimerData> timers : processingTimers.values()) {\n         if (!timers.isEmpty()) {\n-          earliest = INSTANT_ORDERING.min(timers.first().getTimestamp(), earliest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54e897759e7a07a92116a027e38f15db08d5f08d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "311a38d623b72c70202641ee9c0454ec1d3306a0", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/311a38d623b72c70202641ee9c0454ec1d3306a0", "committedDate": "2020-01-31T09:21:13Z", "message": "Input Element timestamp fix, processing timer after window validation, firing time fix, test case updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7cd4a5a805f13a8e81c38db7aa6dc14fd55bfbb", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/b7cd4a5a805f13a8e81c38db7aa6dc14fd55bfbb", "committedDate": "2020-01-31T12:32:19Z", "message": "Get earliest outputTimestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/4c6b602e16407bc099673555bc72a45692d2b1ad", "committedDate": "2020-01-31T12:47:41Z", "message": "Adding outputtimestamp validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTEyMDA4", "url": "https://github.com/apache/beam/pull/10627#pullrequestreview-351912008", "createdAt": "2020-02-02T00:38:48Z", "commit": {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwMDozODo0OFrOFkfmTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwMzozMzoyOVrOFkf89g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMDc2NA==", "bodyText": "are we missing an else clause here?", "url": "https://github.com/apache/beam/pull/10627#discussion_r373810764", "createdAt": "2020-02-02T00:38:48Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,24 +1107,39 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n-\n-      if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        Instant windowExpiry = window.maxTimestamp().plus(allowedLateness);\n-        checkArgument(\n-            !target.isAfter(windowExpiry),\n-            \"Attempted to set event time timer that outputs for %s but that is\"\n-                + \" after the expiration of window %s\",\n-            target,\n-            windowExpiry);\n+      // For processing timers\n+      if (outputTimestamp == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMjIyMA==", "bodyText": "final", "url": "https://github.com/apache/beam/pull/10627#discussion_r373812220", "createdAt": "2020-02-02T01:21:00Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -987,6 +997,7 @@ public void outputWithTimestamp(OutputT output, Instant timestamp) {\n     private final TimerSpec spec;\n     private Instant target;\n     private Instant outputTimestamp;\n+    private Instant elementInputTimestamp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxNjU2Ng==", "bodyText": "check this before setting outputTimestamp above (and only if outputTimestamp != null)", "url": "https://github.com/apache/beam/pull/10627#discussion_r373816566", "createdAt": "2020-02-02T03:33:29Z", "author": {"login": "reuvenlax"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/SimpleDoFnRunner.java", "diffHunk": "@@ -1092,24 +1107,39 @@ private void verifyAbsoluteTimeDomain() {\n      * </ul>\n      */\n     private void setAndVerifyOutputTimestamp() {\n-      // Output timestamp is currently not supported in processing time timers.\n-      if (outputTimestamp != null && !TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        throw new IllegalStateException(\"Cannot set outputTimestamp in processing time domain.\");\n-      }\n+\n       // Output timestamp is set to the delivery time if not initialized by an user.\n-      if (outputTimestamp == null) {\n+      if (outputTimestamp == null && TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n         outputTimestamp = target;\n       }\n-\n-      if (TimeDomain.EVENT_TIME.equals(spec.getTimeDomain())) {\n-        Instant windowExpiry = window.maxTimestamp().plus(allowedLateness);\n-        checkArgument(\n-            !target.isAfter(windowExpiry),\n-            \"Attempted to set event time timer that outputs for %s but that is\"\n-                + \" after the expiration of window %s\",\n-            target,\n-            windowExpiry);\n+      // For processing timers\n+      if (outputTimestamp == null) {\n+        // For processing timers output timestamp will be:\n+        // 1) timestamp of input element\n+        // OR\n+        // 2) output timestamp of firing timer.\n+        outputTimestamp = elementInputTimestamp;\n       }\n+\n+      checkArgument(\n+          !outputTimestamp.isBefore(elementInputTimestamp),\n+          \"output timestamp %s should be after input message timestamp or output timestamp of firing timers %s\",\n+          outputTimestamp,\n+          elementInputTimestamp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c6b602e16407bc099673555bc72a45692d2b1ad"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d085688642c806814a6b0bec4169cf629944957b", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/d085688642c806814a6b0bec4169cf629944957b", "committedDate": "2020-02-02T07:38:11Z", "message": "Output Timestamp validation fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb", "committedDate": "2020-02-02T07:39:04Z", "message": "Merge branch 'master' into feature/processing-time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDg4NzQ4", "url": "https://github.com/apache/beam/pull/10627#pullrequestreview-354088748", "createdAt": "2020-02-05T22:33:40Z", "commit": {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjozMzo0MFrOFmJgqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0Mjo1MlrOFmJuvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0NjAyNg==", "bodyText": "just use timer.set, not timer.offset", "url": "https://github.com/apache/beam/pull/10627#discussion_r375546026", "createdAt": "2020-02-05T22:33:40Z", "author": {"login": "reuvenlax"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3812,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.EVENT_TIME);\n+\n+            @StateId(\"timerFired\")\n+            final StateSpec<ValueState<Boolean>> timerFiredState = StateSpecs.value();\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState) {\n+              Boolean timerFired = timerFiredState.read();\n+              assertTrue(timerFired == null || !timerFired);\n+              // Set a timer to 8. This is earlier than the previous DoFn's timer, but after the\n+              // previous\n+              // DoFn timer's watermark hold. This timer should not fire until the previous timer\n+              // fires and removes\n+              // the watermark hold.\n+              timer.offset(Duration.standardSeconds(8)).setRelative();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0ODgzMA==", "bodyText": "I think you might have to advance processing time to at least 11.\nYou also need to advance the watermark to at least 10 to allow the timer to fire. Right now this isn't testing anything, because the input watermark is preventing the timer from firing.", "url": "https://github.com/apache/beam/pull/10627#discussion_r375548830", "createdAt": "2020-02-05T22:40:49Z", "author": {"login": "reuvenlax"}, "path": "sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java", "diffHunk": "@@ -3806,6 +3812,90 @@ public void onTimer(\n       pipeline.run();\n     }\n \n+    @Test\n+    @Category({\n+      ValidatesRunner.class,\n+      UsesStatefulParDo.class,\n+      UsesTimersInParDo.class,\n+      UsesTestStreamWithProcessingTime.class,\n+      UsesTestStreamWithOutputTimestamp.class\n+    })\n+    public void testOutputTimestampWithProcessingTime() {\n+      final String timerId = \"foo\";\n+      DoFn<KV<String, Integer>, KV<String, Integer>> fn1 =\n+          new DoFn<KV<String, Integer>, KV<String, Integer>>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.PROCESSING_TIME);\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @Timestamp Instant timestamp,\n+                OutputReceiver<KV<String, Integer>> o) {\n+              timer\n+                  .withOutputTimestamp(timestamp.plus(Duration.standardSeconds(5)))\n+                  .offset(Duration.standardSeconds(10))\n+                  .setRelative();\n+              // Output a message. This will cause the next DoFn to set a timer as well.\n+              o.output(KV.of(\"foo\", 100));\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(OnTimerContext c, BoundedWindow w) {}\n+          };\n+\n+      DoFn<KV<String, Integer>, Integer> fn2 =\n+          new DoFn<KV<String, Integer>, Integer>() {\n+\n+            @TimerId(timerId)\n+            private final TimerSpec timer = TimerSpecs.timer(TimeDomain.EVENT_TIME);\n+\n+            @StateId(\"timerFired\")\n+            final StateSpec<ValueState<Boolean>> timerFiredState = StateSpecs.value();\n+\n+            @ProcessElement\n+            public void processElement(\n+                @TimerId(timerId) Timer timer,\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState) {\n+              Boolean timerFired = timerFiredState.read();\n+              assertTrue(timerFired == null || !timerFired);\n+              // Set a timer to 8. This is earlier than the previous DoFn's timer, but after the\n+              // previous\n+              // DoFn timer's watermark hold. This timer should not fire until the previous timer\n+              // fires and removes\n+              // the watermark hold.\n+              timer.offset(Duration.standardSeconds(8)).setRelative();\n+            }\n+\n+            @OnTimer(timerId)\n+            public void onTimer(\n+                @StateId(\"timerFired\") ValueState<Boolean> timerFiredState,\n+                OutputReceiver<Integer> o) {\n+              timerFiredState.write(true);\n+              o.output(100);\n+            }\n+          };\n+\n+      TestStream<KV<String, Integer>> stream =\n+          TestStream.create(KvCoder.of(StringUtf8Coder.of(), VarIntCoder.of()))\n+              .advanceProcessingTime(Duration.standardSeconds(1))\n+              // Cause fn2 to set a timer.\n+              .addElements(KV.of(\"key\", 1))\n+              // Normally this would case fn2's timer to expire, but it shouldn't here because of\n+              // the output timestamp.\n+              .advanceProcessingTime(Duration.standardSeconds(9))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0OTYzMA==", "bodyText": "What about the other getEarliestTimerTimestamp function? Does that need to be updated?", "url": "https://github.com/apache/beam/pull/10627#discussion_r375549630", "createdAt": "2020-02-05T22:42:52Z", "author": {"login": "reuvenlax"}, "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/WatermarkManager.java", "diffHunk": "@@ -597,20 +597,29 @@ public synchronized Instant getEarliestTimerTimestamp() {\n       Instant earliest = THE_END_OF_TIME.get();\n       for (NavigableSet<TimerData> timers : processingTimers.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45ecc6a72bc3dd7803e9651b1b8adb097ee29cb"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63f3a71e4d3d549f8c72d113097ca01a2113998c", "author": {"user": {"login": "rehmanmuradali", "name": "Rehman Murad Ali"}}, "url": "https://github.com/apache/beam/commit/63f3a71e4d3d549f8c72d113097ca01a2113998c", "committedDate": "2020-02-06T20:36:08Z", "message": "Test case fix, getMinimumOutputTimestamp fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3513, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}