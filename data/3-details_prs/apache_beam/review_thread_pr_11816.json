{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMjA2OTE3", "number": 11816, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDoxMjo1OFrOD_sUrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0NzoxMlrOD_zWvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MTEzMDcwOnYy", "diffSide": "LEFT", "path": ".test-infra/jenkins/CommonJobProperties.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDoxMjo1OFrOGagOlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDoxMjo1OFrOGagOlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NDE4Mw==", "bodyText": "This code is unused, I decided it's a good occasion to remove it", "url": "https://github.com/apache/beam/pull/11816#discussion_r430444183", "createdAt": "2020-05-26T14:12:58Z", "author": {"login": "kamilwu"}, "path": ".test-infra/jenkins/CommonJobProperties.groovy", "diffHunk": "@@ -268,23 +268,6 @@ class CommonJobProperties {\n     return mapToArgString(joinedArgs)\n   }\n \n-  static def setupKubernetes(def context, def namespace, def kubeconfigLocation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MjI3ODg0OnYy", "diffSide": "RIGHT", "path": ".test-infra/metrics/build_and_publish_containers.sh", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0NTo1N1rOGarmXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzo0OTo1OVrOGd9Cuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw==", "bodyText": "will latest overwrite container image version? If not, we should add cleanup script for old versions.", "url": "https://github.com/apache/beam/pull/11816#discussion_r430630493", "createdAt": "2020-05-26T18:45:57Z", "author": {"login": "Ardagan"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc4MzAwMw==", "bodyText": "It won't.\nWe have a script that removes all images older than 24 hours from Jenkins workers: \n  \n    \n      beam/.test-infra/jenkins/job_Inventory.groovy\n    \n    \n         Line 69\n      in\n      a13ef24\n    \n    \n    \n    \n\n        \n          \n           shell('docker system prune --all --filter until=24h --force') \n        \n    \n  \n\n\nBut, as far as I know, we don't have a similar cleanup task for images that were pushed to Container Registry (gcr)", "url": "https://github.com/apache/beam/pull/11816#discussion_r431783003", "createdAt": "2020-05-28T12:01:38Z", "author": {"login": "kamilwu"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODMxNw==", "bodyText": "One possible solution would be to create a cron job that would remove untagged images on Container Registry (very similar to this one: https://github.com/apache/beam/blob/master/.test-infra/jenkins/job_CancelStaleDataflowJobs.groovy). WDYT?", "url": "https://github.com/apache/beam/pull/11816#discussion_r431818317", "createdAt": "2020-05-28T13:04:32Z", "author": {"login": "kamilwu"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODg0NA==", "bodyText": "Could be done in a separate PR.", "url": "https://github.com/apache/beam/pull/11816#discussion_r431818844", "createdAt": "2020-05-28T13:05:23Z", "author": {"login": "kamilwu"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY5Mjk0MA==", "bodyText": "@Ardagan", "url": "https://github.com/apache/beam/pull/11816#discussion_r433692940", "createdAt": "2020-06-02T08:03:36Z", "author": {"login": "kamilwu"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MjAxMQ==", "bodyText": "Since we already have a script, it should be fine.", "url": "https://github.com/apache/beam/pull/11816#discussion_r434062011", "createdAt": "2020-06-02T17:49:59Z", "author": {"login": "Ardagan"}, "path": ".test-infra/metrics/build_and_publish_containers.sh", "diffHunk": "@@ -36,8 +33,8 @@ fi\n \n echo\n echo ===========Start==========\n-CONTAINER_VERSION_NAME=$1\n-DO_PUSH=$2\n+DO_PUSH=$1\n+CONTAINER_VERSION_NAME=${2:-latest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDQ5Mw=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MjI4Mjg0OnYy", "diffSide": "RIGHT", "path": ".test-infra/metrics/build.gradle", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0NzoxMlrOGarpEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxMzowNFrOGbSgNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ==", "bodyText": "Is there a reason to detect timee vs automatic job trigger by commit to master with relevant folder?", "url": "https://github.com/apache/beam/pull/11816#discussion_r430631185", "createdAt": "2020-05-26T18:47:12Z", "author": {"login": "Ardagan"}, "path": ".test-infra/metrics/build.gradle", "diffHunk": "@@ -50,9 +51,49 @@ dockerCompose {\n \n dockerCompose.isRequiredBy(testMetricsStack)\n \n-task preCommit { dependsOn testMetricsStack }\n+task validateConfiguration(type: Exec) {\n+  commandLine 'sh', '-c', 'kubectl apply --dry-run=true -Rf kubernetes'\n+}\n+\n+task preCommit {\n+  dependsOn validateConfiguration\n+  dependsOn testMetricsStack\n+}\n+\n+task buildAndPublishContainers(type: Exec) {\n+  commandLine './build_and_publish_containers.sh', 'true'\n+}\n+\n+// Applies new configuration to all resources labeled with `app=beammetrics`\n+// and forces Kubernetes to re-pull images.\n+task applyConfiguration() {\n+  doLast {\n+    assert grgit : 'Cannot use outside of git repository'\n+\n+    def git = grgit.open()\n+    def commitedChanges = git.log(paths: ['.test-infra/metrics']).findAll {\n+      it.dateTime > ZonedDateTime.now().minusHours(6)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxOTg4OA==", "bodyText": "To be honest, I don't know if this is possible. We're using ghprb plugin to integrate Github with Jenkins, and comments from this issue (jenkinsci/ghprb-plugin#651) claim this feature (triggering on merging to master) is outside the scope of the plugin. That's why I decided to create a cron job (Website_Publish is based on a cron job too).\nDo you want me to continue searching for a trigger-on-merge solution?", "url": "https://github.com/apache/beam/pull/11816#discussion_r431219888", "createdAt": "2020-05-27T15:14:21Z", "author": {"login": "kamilwu"}, "path": ".test-infra/metrics/build.gradle", "diffHunk": "@@ -50,9 +51,49 @@ dockerCompose {\n \n dockerCompose.isRequiredBy(testMetricsStack)\n \n-task preCommit { dependsOn testMetricsStack }\n+task validateConfiguration(type: Exec) {\n+  commandLine 'sh', '-c', 'kubectl apply --dry-run=true -Rf kubernetes'\n+}\n+\n+task preCommit {\n+  dependsOn validateConfiguration\n+  dependsOn testMetricsStack\n+}\n+\n+task buildAndPublishContainers(type: Exec) {\n+  commandLine './build_and_publish_containers.sh', 'true'\n+}\n+\n+// Applies new configuration to all resources labeled with `app=beammetrics`\n+// and forces Kubernetes to re-pull images.\n+task applyConfiguration() {\n+  doLast {\n+    assert grgit : 'Cannot use outside of git repository'\n+\n+    def git = grgit.open()\n+    def commitedChanges = git.log(paths: ['.test-infra/metrics']).findAll {\n+      it.dateTime > ZonedDateTime.now().minusHours(6)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI2Nzg5Mw==", "bodyText": "Postcommit job builder already triggers on commit but it also triggers periodically. It actually makes sense to attempt deployment periodically in case trigger fails. Lets keep it as is.", "url": "https://github.com/apache/beam/pull/11816#discussion_r431267893", "createdAt": "2020-05-27T16:13:04Z", "author": {"login": "Ardagan"}, "path": ".test-infra/metrics/build.gradle", "diffHunk": "@@ -50,9 +51,49 @@ dockerCompose {\n \n dockerCompose.isRequiredBy(testMetricsStack)\n \n-task preCommit { dependsOn testMetricsStack }\n+task validateConfiguration(type: Exec) {\n+  commandLine 'sh', '-c', 'kubectl apply --dry-run=true -Rf kubernetes'\n+}\n+\n+task preCommit {\n+  dependsOn validateConfiguration\n+  dependsOn testMetricsStack\n+}\n+\n+task buildAndPublishContainers(type: Exec) {\n+  commandLine './build_and_publish_containers.sh', 'true'\n+}\n+\n+// Applies new configuration to all resources labeled with `app=beammetrics`\n+// and forces Kubernetes to re-pull images.\n+task applyConfiguration() {\n+  doLast {\n+    assert grgit : 'Cannot use outside of git repository'\n+\n+    def git = grgit.open()\n+    def commitedChanges = git.log(paths: ['.test-infra/metrics']).findAll {\n+      it.dateTime > ZonedDateTime.now().minusHours(6)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTE4NQ=="}, "originalCommit": {"oid": "cfd4d75e72586760e6926ea525f1e9e3d4035912"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3706, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}