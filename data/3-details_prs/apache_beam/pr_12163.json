{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMzAyNTMy", "number": 12163, "title": "[BEAM-9712] Refactor ZetaSQL planner code and support setting default timezone", "bodyText": "Enable setting default timezone option on ZetaSQL analyzer. Default timezone is used both at\n\nquery analysis time (e.g. CAST literal to TIMESTAMP), and\nexpression execution time (e.g. TIMESTAMP() constructor).\n\nAlso simplified some ZetaSQL planner code, including:\n\nremove unnecessary and confusing builder pattern in SqlAnalyzer\nremove unused method analyze() in SqlAnalyzer\nremove unnecessary Planner interface implementation in ZetaSQLPlannerImpl\nadd a different overload of BeamEnumerableConverter.toRowList() for compliance test harness\n\nr: @apilloud\ncc: @ibzib @kennknowles\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-02T06:23:47Z", "url": "https://github.com/apache/beam/pull/12163", "merged": true, "mergeCommit": {"oid": "c7446e84f36bbeccc7bf9744ebc27ba0a8aebc50"}, "closed": true, "closedAt": "2020-07-09T18:20:20Z", "author": {"login": "robinyqiu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxDDIBABqjM1MDgyNjk1Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczRrZ-gFqTQ0NTc3Mzg1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11a24047b519dfbe48400429657d10f6b281a771", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/11a24047b519dfbe48400429657d10f6b281a771", "committedDate": "2020-07-02T06:08:42Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}, "afterCommit": {"oid": "33c13caf93b571e078580e85f2a229834738c13f", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/33c13caf93b571e078580e85f2a229834738c13f", "committedDate": "2020-07-02T18:21:17Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33c13caf93b571e078580e85f2a229834738c13f", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/33c13caf93b571e078580e85f2a229834738c13f", "committedDate": "2020-07-02T18:21:17Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}, "afterCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92", "committedDate": "2020-07-02T18:27:12Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjgzODQx", "url": "https://github.com/apache/beam/pull/12163#pullrequestreview-443283841", "createdAt": "2020-07-06T17:42:08Z", "commit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNzo0MjowOFrOGthE_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNzo0ODowOVrOGthQ3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4MTA1Mg==", "bodyText": "Can you add a note about which values are allowed here?", "url": "https://github.com/apache/beam/pull/12163#discussion_r450381052", "createdAt": "2020-07-06T17:42:08Z", "author": {"login": "ibzib"}, "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/BeamSqlPipelineOptions.java", "diffHunk": "@@ -30,6 +30,12 @@\n \n   void setPlannerName(String className);\n \n+  @Description(\"Default timezone for ZetaSQL analyzer; currently has no effect on CalciteSQL.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4MTU2Mg==", "bodyText": "If defaultTimezone is set here, we should warn the user it will have no effect.", "url": "https://github.com/apache/beam/pull/12163#discussion_r450381562", "createdAt": "2020-07-06T17:43:11Z", "author": {"login": "ibzib"}, "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/CalciteQueryPlanner.java", "diffHunk": "@@ -75,7 +75,9 @@\n   private final Planner planner;\n   private final JdbcConnection connection;\n \n-  public CalciteQueryPlanner(JdbcConnection connection, RuleSet[] ruleSets) {\n+  public CalciteQueryPlanner(\n+      JdbcConnection connection, RuleSet[] ruleSets, String defaultTimezone) {\n+    // TODO: support setting default timezone?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4MTY4Nw==", "bodyText": "Can you create and link a JIRA?", "url": "https://github.com/apache/beam/pull/12163#discussion_r450381687", "createdAt": "2020-07-06T17:43:26Z", "author": {"login": "ibzib"}, "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/CalciteQueryPlanner.java", "diffHunk": "@@ -75,7 +75,9 @@\n   private final Planner planner;\n   private final JdbcConnection connection;\n \n-  public CalciteQueryPlanner(JdbcConnection connection, RuleSet[] ruleSets) {\n+  public CalciteQueryPlanner(\n+      JdbcConnection connection, RuleSet[] ruleSets, String defaultTimezone) {\n+    // TODO: support setting default timezone?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4MzIzMw==", "bodyText": "While we're at it, maybe we should rename this getAnalyzerOptions. To me, init implies a one-time setup operation, which this is not.", "url": "https://github.com/apache/beam/pull/12163#discussion_r450383233", "createdAt": "2020-07-06T17:46:34Z", "author": {"login": "ibzib"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/SqlAnalyzer.java", "diffHunk": "@@ -187,8 +167,10 @@ static AnalyzerOptions initAnalyzerOptions() {\n     return options;\n   }\n \n-  static AnalyzerOptions initAnalyzerOptions(QueryParameters queryParams) {\n-    AnalyzerOptions options = initAnalyzerOptions();\n+  static AnalyzerOptions initAnalyzerOptions(QueryParameters queryParams, String defaultTimezone) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4NDA5NQ==", "bodyText": "Consider making this a javadoc comment so we can add a link.", "url": "https://github.com/apache/beam/pull/12163#discussion_r450384095", "createdAt": "2020-07-06T17:48:09Z", "author": {"login": "ibzib"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSQLQueryPlanner.java", "diffHunk": "@@ -65,9 +65,12 @@ public ZetaSQLQueryPlanner(FrameworkConfig config) {\n     plannerImpl = new ZetaSQLPlannerImpl(config);\n   }\n \n-  public ZetaSQLQueryPlanner(JdbcConnection jdbcConnection, RuleSet[] ruleSets) {\n+  // Called by BeamSqlEnv.instantiatePlanner() reflectively", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8baaa0bb1a1f8d81dccc20d1d0c37875b1ba92"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a30e29d9444467969bc0f03456910c768250058a", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/a30e29d9444467969bc0f03456910c768250058a", "committedDate": "2020-07-06T19:49:19Z", "message": "Address comment"}, "afterCommit": {"oid": "5e212a7bd1729e5926865dac13dda162ed72025e", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/5e212a7bd1729e5926865dac13dda162ed72025e", "committedDate": "2020-07-06T20:46:39Z", "message": "Address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzk4MTQ3", "url": "https://github.com/apache/beam/pull/12163#pullrequestreview-443398147", "createdAt": "2020-07-06T20:49:50Z", "commit": {"oid": "5e212a7bd1729e5926865dac13dda162ed72025e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "982dd1496bd0b53c24cd9e12a8c19f9eee29520f", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/982dd1496bd0b53c24cd9e12a8c19f9eee29520f", "committedDate": "2020-07-09T14:01:39Z", "message": "Fix bug in timestamp literal unparsing"}, "afterCommit": {"oid": "014d63ecd48232471088c8479ece3b622d948182", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/014d63ecd48232471088c8479ece3b622d948182", "committedDate": "2020-07-09T14:23:38Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "014d63ecd48232471088c8479ece3b622d948182", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/014d63ecd48232471088c8479ece3b622d948182", "committedDate": "2020-07-09T14:23:38Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}, "afterCommit": {"oid": "eea5773c327d36892e0a99938d38ab3eae4650cd", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/eea5773c327d36892e0a99938d38ab3eae4650cd", "committedDate": "2020-07-09T14:26:03Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93fb84254155582b54d06d482f44ba179edfab16", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/93fb84254155582b54d06d482f44ba179edfab16", "committedDate": "2020-07-09T14:34:00Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eea5773c327d36892e0a99938d38ab3eae4650cd", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/eea5773c327d36892e0a99938d38ab3eae4650cd", "committedDate": "2020-07-09T14:26:03Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}, "afterCommit": {"oid": "93fb84254155582b54d06d482f44ba179edfab16", "author": {"user": {"login": "robinyqiu", "name": "Yueyang Qiu"}}, "url": "https://github.com/apache/beam/commit/93fb84254155582b54d06d482f44ba179edfab16", "committedDate": "2020-07-09T14:34:00Z", "message": "Refactor ZetaSQL planner code and support setting default timezone"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzczODU2", "url": "https://github.com/apache/beam/pull/12163#pullrequestreview-445773856", "createdAt": "2020-07-09T16:20:37Z", "commit": {"oid": "93fb84254155582b54d06d482f44ba179edfab16"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjoyMDozOFrOGvYf4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjoyMDozOFrOGvYf4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzNzYzMw==", "bodyText": "nit: I'd prefer if you didn't rename this method, there are a bunch of references to it inside google. (Alternatively please rename the method of the same name in the C++ validator to match.)", "url": "https://github.com/apache/beam/pull/12163#discussion_r452337633", "createdAt": "2020-07-09T16:20:38Z", "author": {"login": "apilloud"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/SqlAnalyzer.java", "diffHunk": "@@ -182,11 +164,10 @@ ResolvedStatement analyzeNextStatement(\n     return resolvedStatement;\n   }\n \n-  static AnalyzerOptions initAnalyzerOptions() {\n+  static AnalyzerOptions baseAnalyzerOptions() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93fb84254155582b54d06d482f44ba179edfab16"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3337, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}