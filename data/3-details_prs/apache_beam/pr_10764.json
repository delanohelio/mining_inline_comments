{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODYyNzg4", "number": 10764, "title": "[BEAM-9146] Integrate GCP Video Intelligence functionality for Python SDK", "bodyText": "This PR relates to https://issues.apache.org/jira/browse/BEAM-9146 and integrates GCP Video Intelligence functionality as part of a PTransform that implicitly accepts a PCollection of GCS URIs or raw bytes.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-02-04T14:19:19Z", "url": "https://github.com/apache/beam/pull/10764", "merged": true, "mergeCommit": {"oid": "efe193e805d7203adc24837b53ec20a13087442f"}, "closed": true, "closedAt": "2020-02-19T16:36:10Z", "author": {"login": "EDjur"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBCFqUAH2gAyMzcwODYyNzg4OjZhYjUwMTNhM2UzZTcwM2EyNzM0ZmFiNjBmYmZjNmVkNjFjMGE5ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF0vfDAH2gAyMzcwODYyNzg4OjI2YTE5YjBjOTUxZmU0ZTBmNTRhNTk1ZjAyODAwNjEwNWU1MGYxMmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ab5013a3e3e703a2734fab60fbfc6ed61c0a9de", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/6ab5013a3e3e703a2734fab60fbfc6ed61c0a9de", "committedDate": "2020-02-04T14:06:00Z", "message": "[BEAM-9146] PTransform that integrates Video Intelligence functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/0e54a6423bb5b220a6d3e1d7bc7e937af2541033", "committedDate": "2020-02-04T14:14:55Z", "message": "Removed unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjI1MTM4", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-353625138", "createdAt": "2020-02-05T10:53:05Z", "commit": {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMDo1MzowNVrOFlzjlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMDo1MzowNVrOFlzjlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE4NjMyNA==", "bodyText": "I think we should also accept other parameters, not only features.\nA must have is video_context, because sometimes it provides additional feature-specific parameters. Others are location_id and possibly metadata. Take a look at the interface of annotate_video()", "url": "https://github.com/apache/beam/pull/10764#discussion_r375186324", "createdAt": "2020-02-05T10:53:05Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/io/gcp/ai/video_intelligence.py", "diffHunk": "@@ -0,0 +1,75 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.io.gcp.ai import helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+\n+  def __init__(self, features):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjY4NjQw", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-353668640", "createdAt": "2020-02-05T12:11:35Z", "commit": {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjoxMTozNVrOFl1mpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjoxMTozNVrOFl1mpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIxOTg3Ng==", "bodyText": "In Python 2 str and bytes are the same. Since Beam still supports Python 2.7, this code must be compatible with both Python 2 and 3.\nConsider using future.utils module which provides some methods that can help you to check type of an element.", "url": "https://github.com/apache/beam/pull/10764#discussion_r375219876", "createdAt": "2020-02-05T12:11:35Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/io/gcp/ai/video_intelligence.py", "diffHunk": "@@ -0,0 +1,75 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.io.gcp.ai import helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+\n+  def __init__(self, features):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence.enums.Feature``])\n+          the Video Intelligence API features to detect\n+    \"\"\"\n+    super(AnnotateVideo).__init__()\n+    self.features = features\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(self._VideoAnnotateFn(features=self.features))\n+\n+  @typehints.with_input_types(Union[str, bytes])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+\n+    def __init__(self, features):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, str):  # Is element an URI to a GCS bucket", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e54a6423bb5b220a6d3e1d7bc7e937af2541033"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86aeff86aaa37f538ffcafa92fff78b4647c5c6a", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/86aeff86aaa37f538ffcafa92fff78b4647c5c6a", "committedDate": "2020-02-06T13:55:29Z", "message": "byte and string comparison now supporting py23. Added extra args to annotate_video. Added requirement in setup.py"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d3fc4ba18bd551f8a2156c675cba6545e39d7a", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/d2d3fc4ba18bd551f8a2156c675cba6545e39d7a", "committedDate": "2020-02-06T13:57:04Z", "message": "Folder restructuring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/c1abf00aff393c3e72e8837bc23e45c865ed0520", "committedDate": "2020-02-06T14:30:25Z", "message": "Yapf formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjQxNzA5", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-354641709", "createdAt": "2020-02-06T17:36:56Z", "commit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozNjo1NlrOFmkD1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzo0MjoxNVrOFmkOQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MTAxNQ==", "bodyText": "Would it make sense to make 120 configurable?", "url": "https://github.com/apache/beam/pull/10764#discussion_r375981015", "createdAt": "2020-02-06T17:36:56Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.video_context = video_context\n+      self.location_id = location_id\n+      self.metadata = metadata\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, text_type):  # Is element an URI to a GCS bucket\n+        response = self._client.annotate_video(\n+            input_uri=element,\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata)\n+      elif isinstance(element, binary_type):  # Is element raw bytes\n+        response = self._client.annotate_video(\n+            input_content=element,\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata)\n+      else:\n+        raise TypeError(\n+            \"{}: input element needs to be either {} or {}\"\n+            \" got {} instead\".format(\n+                self.__class__.__name__, text_type, binary_type, type(element)))\n+      self.counter.inc()\n+      yield response.result(timeout=120)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjA5NQ==", "bodyText": "DoFn does not return a PCollection. Maybe we can update this to something like\nA DoFn that sends each input element to the GCP Video Intelligence API service and outputs an element with the return result of the API.", "url": "https://github.com/apache/beam/pull/10764#discussion_r375982095", "createdAt": "2020-02-06T17:39:06Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4Mjk3Mg==", "bodyText": "Should we guard this similar to other optional dependencies (example: https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/gcp/gcsio.py#L53)", "url": "https://github.com/apache/beam/pull/10764#discussion_r375982972", "createdAt": "2020-02-06T17:40:53Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence_helper.py", "diffHunk": "@@ -0,0 +1,36 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+Cloud Video Intelligence client\n+\n+For internal use only; no backwards-compatibility guarantees.\n+\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from google.cloud import videointelligence", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MzY4Mw==", "bodyText": "Are we expecting to use this for other APIs as well?", "url": "https://github.com/apache/beam/pull/10764#discussion_r375983683", "createdAt": "2020-02-06T17:42:15Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence_helper.py", "diffHunk": "@@ -0,0 +1,36 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+Cloud Video Intelligence client\n+\n+For internal use only; no backwards-compatibility guarantees.\n+\"\"\"\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from google.cloud import videointelligence\n+\n+\n+@ttl_cache(maxsize=128, ttl=3600)\n+def get_videointelligence_client():", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjYzMzQw", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-354663340", "createdAt": "2020-02-06T18:10:57Z", "commit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODoxMDo1N1rOFmlGBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODoxMDo1N1rOFmlGBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5Nzk1OQ==", "bodyText": "Does the API have support for batching? If yes, it might be a good feature to support.", "url": "https://github.com/apache/beam/pull/10764#discussion_r375997959", "createdAt": "2020-02-06T18:10:57Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.ml.gcp import video_intelligence_helper as helper\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self, features, video_context=None, location_id=None, metadata=None):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A ``DoFn`` that sends every element to the GCP Video Intelligence API\n+      and returns a PCollection of\n+    ``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``.\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata):\n+      super(AnnotateVideo._VideoAnnotateFn, self).__init__()\n+      self._client = None\n+      self.features = features\n+      self.video_context = video_context\n+      self.location_id = location_id\n+      self.metadata = metadata\n+      self.counter = Metrics.counter(self.__class__, \"API Calls\")\n+\n+    def start_bundle(self):\n+      self._client = helper.get_videointelligence_client()\n+\n+    def process(self, element, *args, **kwargs):\n+      if isinstance(element, text_type):  # Is element an URI to a GCS bucket", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abf00aff393c3e72e8837bc23e45c865ed0520"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfe848a4ac0d31ca83058cb197cae6a816ab9b6b", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/bfe848a4ac0d31ca83058cb197cae6a816ab9b6b", "committedDate": "2020-02-06T18:53:02Z", "message": "Merged helper into main file. Added timeout default arg. Doc fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/ebb701c6202ac1ac0b3d5d5992e78807bd868b2e", "committedDate": "2020-02-06T18:56:52Z", "message": "Optimise imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzA0MDU2", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-354704056", "createdAt": "2020-02-06T19:15:12Z", "commit": {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOToxNToxMlrOFmnB6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOToxNToxMlrOFmnB6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyOTY3NA==", "bodyText": "We can default the timeout to 120 here. If you think that is a reasonable default.", "url": "https://github.com/apache/beam/pull/10764#discussion_r376029674", "createdAt": "2020-02-06T19:15:12Z", "author": {"login": "aaltay"}, "path": "sdks/python/apache_beam/ml/gcp/video_intelligence.py", "diffHunk": "@@ -0,0 +1,131 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"\n+A connector for sending API requests to the GCP Video Intelligence API.\n+\"\"\"\n+from __future__ import absolute_import\n+\n+from cachetools.func import ttl_cache\n+from future.utils import binary_type, text_type\n+from typing import Union\n+\n+from apache_beam import typehints\n+from apache_beam.metrics import Metrics\n+from apache_beam.transforms import DoFn, ParDo, PTransform\n+\n+try:\n+  from google.cloud import videointelligence\n+except ImportError:\n+  raise ImportError(\n+      'Google Cloud Video Intelligence not supported for this execution environment '\n+      '(could not import google.cloud.videointelligence).')\n+\n+__all__ = ['AnnotateVideo']\n+\n+\n+@ttl_cache(maxsize=128, ttl=3600)\n+def get_videointelligence_client():\n+  \"\"\"Returns a Cloud Video Intelligence client.\"\"\"\n+  _client = videointelligence.VideoIntelligenceServiceClient()\n+  return _client\n+\n+\n+class AnnotateVideo(PTransform):\n+  \"\"\"A ``PTransform`` for annotating video using the GCP Video Intelligence API\n+  ref: https://cloud.google.com/video-intelligence/docs\n+  \"\"\"\n+  def __init__(\n+      self,\n+      features,\n+      video_context=None,\n+      location_id=None,\n+      metadata=None,\n+      timeout=120):\n+    \"\"\"\n+      Args:\n+        features: (List[``videointelligence_v1.enums.Feature``]) Required.\n+          the Video Intelligence API features to detect\n+        video_context: (dict, ``videointelligence_v1.types.VideoContext``)\n+          Optional.\n+          Additional video context and/or feature-specific parameters.\n+        location_id: (str) Optional.\n+          Cloud region where annotation should take place.\n+          If no region is specified, a region will be determined\n+          based on video file location.\n+        metadata: (Sequence[Tuple[str, str]]) Optional.\n+          Additional metadata that is provided to the method.\n+        timeout: (int) Optional.\n+          The time in seconds to wait for the response from the Video Intelligence API\n+    \"\"\"\n+    super(AnnotateVideo, self).__init__()\n+    self.features = features\n+    self.video_context = video_context\n+    self.location_id = location_id\n+    self.metadata = metadata\n+    self.timeout = timeout\n+\n+  def expand(self, pvalue):\n+    return pvalue | ParDo(\n+        self._VideoAnnotateFn(\n+            features=self.features,\n+            video_context=self.video_context,\n+            location_id=self.location_id,\n+            metadata=self.metadata,\n+            timeout=self.timeout))\n+\n+  @typehints.with_input_types(Union[text_type, binary_type])\n+  class _VideoAnnotateFn(DoFn):\n+    \"\"\" A DoFn that sends each input element to the GCP Video Intelligence API\n+        service and outputs an element with the return result of the API\n+        (``google.cloud.videointelligence_v1.types.AnnotateVideoResponse``).\n+     \"\"\"\n+    def __init__(self, features, video_context, location_id, metadata, timeout):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzA0NDIx", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-354704421", "createdAt": "2020-02-06T19:15:51Z", "commit": {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDUzOTU0", "url": "https://github.com/apache/beam/pull/10764#pullrequestreview-355053954", "createdAt": "2020-02-07T10:12:42Z", "commit": {"oid": "ebb701c6202ac1ac0b3d5d5992e78807bd868b2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50e5be0ac80fccaa499732ce68e147370b303d3e", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/50e5be0ac80fccaa499732ce68e147370b303d3e", "committedDate": "2020-02-10T08:17:15Z", "message": "Rename to make more consistent with the rest of BEAM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d596188e1d4548d5f8f9c464bcccf5137e8a33", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/a3d596188e1d4548d5f8f9c464bcccf5137e8a33", "committedDate": "2020-02-10T08:20:45Z", "message": "Docstring 'video_intelligence' -> 'videointelligenceml'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e14a6bee706c330e5365acd90cf053e2cd6509", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/73e14a6bee706c330e5365acd90cf053e2cd6509", "committedDate": "2020-02-11T08:14:44Z", "message": "yapf formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1f8944275afb1072ac0946d739f9a2d58ee48db", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/c1f8944275afb1072ac0946d739f9a2d58ee48db", "committedDate": "2020-02-11T19:20:45Z", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7450cea79c4ef4bd5ef3196c096039681b227472", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/7450cea79c4ef4bd5ef3196c096039681b227472", "committedDate": "2020-02-11T19:24:54Z", "message": "Added new feature note in changes.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2723b7193f25deca7f7f1677f173f7b5e489022d", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/2723b7193f25deca7f7f1677f173f7b5e489022d", "committedDate": "2020-02-12T21:14:01Z", "message": "Lint fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69509dd181dc83f8555af5390b34df29b5b561ac", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/69509dd181dc83f8555af5390b34df29b5b561ac", "committedDate": "2020-02-12T21:21:22Z", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a3b8dbf5c5d0c021bbe9b7d12bf42ed4c30bf88", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/4a3b8dbf5c5d0c021bbe9b7d12bf42ed4c30bf88", "committedDate": "2020-02-12T21:34:20Z", "message": "Disabled correct pylint metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03135c515d3ddb810ddc5883e22b19f2115708f3", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/03135c515d3ddb810ddc5883e22b19f2115708f3", "committedDate": "2020-02-13T08:10:30Z", "message": "Re-ordered imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ababbf6c48d843f63bb3e32e8299c55eae75d9d4", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/ababbf6c48d843f63bb3e32e8299c55eae75d9d4", "committedDate": "2020-02-13T10:06:53Z", "message": "Re-ordered imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6818f354db5dd943daa981b8b7041ce7dfd5fd8f", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/6818f354db5dd943daa981b8b7041ce7dfd5fd8f", "committedDate": "2020-02-13T10:56:31Z", "message": "Added call to unittest.main() in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9a150575c29f67a8126929605d059adba3d470", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/4c9a150575c29f67a8126929605d059adba3d470", "committedDate": "2020-02-18T13:23:52Z", "message": "Split into 2 PTransforms -> 1. Video context as side input. 2. Video context as part of element tuple"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86356f74183f23e9f3b9abc3ba6825f26cc4ad65", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/86356f74183f23e9f3b9abc3ba6825f26cc4ad65", "committedDate": "2020-02-18T13:24:29Z", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "702e3d7732ad37c1bd3a693be86f6ae3b8d81b75", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/702e3d7732ad37c1bd3a693be86f6ae3b8d81b75", "committedDate": "2020-02-18T13:29:21Z", "message": "Added AnnotateVideoWithContext to CHANGES.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e7044f314a06c1dbc505886f657a4c5cf0e381", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/63e7044f314a06c1dbc505886f657a4c5cf0e381", "committedDate": "2020-02-18T16:41:33Z", "message": "Merge branch 'master' into BEAM-9146/gcp-video-intelligence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c3af025815a5468c0e76e9127f460f1e5d4fea1", "author": {"user": {"login": "aaltay", "name": "Ahmet Altay"}}, "url": "https://github.com/apache/beam/commit/4c3af025815a5468c0e76e9127f460f1e5d4fea1", "committedDate": "2020-02-18T19:28:14Z", "message": "Add final new line."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a19b0c951fe4e0f54a595f028006105e50f12f", "author": {"user": {"login": "EDjur", "name": "Elias Djurfeldt"}}, "url": "https://github.com/apache/beam/commit/26a19b0c951fe4e0f54a595f028006105e50f12f", "committedDate": "2020-02-19T11:22:38Z", "message": "Fixed pycommon:docs issue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3395, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}