{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODc5NjE2", "number": 13069, "title": "[BEAM-10475] Add a well-known coder for ShardedKey in Java/Python SDK", "bodyText": "Add a well-known coder for ShardedKey in Java/Python SDK\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-10T00:50:13Z", "url": "https://github.com/apache/beam/pull/13069", "merged": true, "mergeCommit": {"oid": "64d247cbc8b0a2969441214ead668ea1353aec8a"}, "closed": true, "closedAt": "2020-10-24T06:44:34Z", "author": {"login": "nehsyc"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRALYpgBqjM4NjIyMDQ1MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVKTadABqjM5MTE0NzI1OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b4953750465c142617ae951b03feb372b3e367d", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/2b4953750465c142617ae951b03feb372b3e367d", "committedDate": "2020-10-10T00:44:47Z", "message": "Add well-known ShardedKey coder in Java SDK"}, "afterCommit": {"oid": "925b27a38305a3aff18f0d1edd4583d43ae20fc4", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/925b27a38305a3aff18f0d1edd4583d43ae20fc4", "committedDate": "2020-10-10T01:04:52Z", "message": "Add a well-known ShardedKey coder in Java SDK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTMyMjg0", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-506132284", "createdAt": "2020-10-10T23:23:59Z", "commit": {"oid": "925b27a38305a3aff18f0d1edd4583d43ae20fc4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQyMzoyMzo1OVrOHfjHqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQyMzoyMzo1OVrOHfjHqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0MzMwNw==", "bodyText": "Currently the shard id is encoded using a ByteArrayCoder which uses a VarInt coder to encode/decode the length in 32bits. That is consistent with the parsing logic in the unified worker. But in Python we seem to be using 64bits  (e.g., VarIntCoder). Should I make it consistent by explicitly encoding / decoding a long value here?", "url": "https://github.com/apache/beam/pull/13069#discussion_r502843307", "createdAt": "2020-10-10T23:23:59Z", "author": {"login": "nehsyc"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   null indicator\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      BooleanCoder.of().encode(shardedKey.getShardId() != null, outStream);\n+      if (shardedKey.getShardId() != null) {\n+        shardCoder.encode(shardedKey.getShardId(), outStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "925b27a38305a3aff18f0d1edd4583d43ae20fc4"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzkyMzUx", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-506792351", "createdAt": "2020-10-12T17:16:22Z", "commit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzoxNjoyMlrOHgG-Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzoyMDo0OFrOHgHGFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzMDczMA==", "bodyText": "I thought we were going to use the empty byte array as the default and not differentiate null.\nIt will remove an if from encode/decode logic and also save one byte in the encoded representation.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503430730", "createdAt": "2020-10-12T17:16:22Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   null indicator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzMjQ1MQ==", "bodyText": "Please also implement structuralValue, verifyDeterministic, consistentWithEquals, isRegisterByteSizeObserverCheap.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503432451", "createdAt": "2020-10-12T17:20:13Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   null indicator\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      BooleanCoder.of().encode(shardedKey.getShardId() != null, outStream);\n+      if (shardedKey.getShardId() != null) {\n+        shardCoder.encode(shardedKey.getShardId(), outStream);\n+      }\n+      keyCoder.encode(shardedKey.getKey(), outStream);\n+    }\n+\n+    @Override\n+    public ShardedKey<K> decode(InputStream inStream) throws IOException {\n+      if (!BooleanCoder.of().decode(inStream)) {\n+        K key = keyCoder.decode(inStream);\n+        return ShardedKey.of(key, null);\n+      }\n+      byte[] shardId = shardCoder.decode(inStream);\n+      K key = keyCoder.decode(inStream);\n+      return ShardedKey.of(key, shardId);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getComponents() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public void verifyDeterministic() throws NonDeterministicException {\n+      verifyDeterministic(this, \"Key coder must be deterministic\", keyCoder);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzMjcyNQ==", "bodyText": "This is already implemented in StructuredCoder.java, no point in duplicating.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503432725", "createdAt": "2020-10-12T17:20:48Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   null indicator\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      BooleanCoder.of().encode(shardedKey.getShardId() != null, outStream);\n+      if (shardedKey.getShardId() != null) {\n+        shardCoder.encode(shardedKey.getShardId(), outStream);\n+      }\n+      keyCoder.encode(shardedKey.getKey(), outStream);\n+    }\n+\n+    @Override\n+    public ShardedKey<K> decode(InputStream inStream) throws IOException {\n+      if (!BooleanCoder.of().decode(inStream)) {\n+        K key = keyCoder.decode(inStream);\n+        return ShardedKey.of(key, null);\n+      }\n+      byte[] shardId = shardCoder.decode(inStream);\n+      K key = keyCoder.decode(inStream);\n+      return ShardedKey.of(key, shardId);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getComponents() {\n+      return Collections.singletonList(keyCoder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Nzg1MTU5", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-506785159", "createdAt": "2020-10-12T17:03:57Z", "commit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzowMzo1OFrOHgGnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOTowNzowMFrOHgKGDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNDg1OA==", "bodyText": "Can you remove the irrelevant whitespace changes?", "url": "https://github.com/apache/beam/pull/13069#discussion_r503424858", "createdAt": "2020-10-12T17:03:58Z", "author": {"login": "robertwb"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -1215,23 +1243,23 @@ message StandardArtifacts {\n   enum Types {\n     // A URN for locally-accessible artifact files.\n     // payload: ArtifactFilePayload\n-    FILE      = 0 [(beam_urn) = \"beam:artifact:type:file:v1\"];\n+    FILE = 0 [(beam_urn) = \"beam:artifact:type:file:v1\"];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNTA1MQ==", "bodyText": "There seems to be lots of whitespace changes in this file (and elsewhere).", "url": "https://github.com/apache/beam/pull/13069#discussion_r503425051", "createdAt": "2020-10-12T17:04:20Z", "author": {"login": "robertwb"}, "path": "runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/CommonCoderTest.java", "diffHunk": "@@ -89,6 +90,7 @@\n /** Tests that Java SDK coders standardized by the Fn API meet the common spec. */\n @RunWith(Parameterized.class)\n public class CommonCoderTest {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MDM1Nw==", "bodyText": "The two encodings are the same for all values in the range we'll be dealing with (and neither Java nor GRPC can handle >4G sized byte arrays) so we should be fine here.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503480357", "createdAt": "2020-10-12T19:03:24Z", "author": {"login": "robertwb"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   null indicator\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      BooleanCoder.of().encode(shardedKey.getShardId() != null, outStream);\n+      if (shardedKey.getShardId() != null) {\n+        shardCoder.encode(shardedKey.getShardId(), outStream);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0MzMwNw=="}, "originalCommit": {"oid": "925b27a38305a3aff18f0d1edd4583d43ae20fc4"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MDc3Nw==", "bodyText": "Are we leveraging AutoValue for hash and equality? If so, I don't think that'll work with byte[] here.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503480777", "createdAt": "2020-10-12T19:04:26Z", "author": {"login": "robertwb"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import javax.annotation.Nullable;\n+import org.apache.beam.sdk.coders.BooleanCoder;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key, @Nullable byte[] shardId) {\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  @Nullable\n+  public abstract byte[] getShardId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4MTg2OQ==", "bodyText": "We shouldn't add this, it should be copied on demand. Otherwise things may diverge which defeats the purpose of standard coders.", "url": "https://github.com/apache/beam/pull/13069#discussion_r503481869", "createdAt": "2020-10-12T19:07:00Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/portability/api/standard_coders.yaml", "diffHunk": "@@ -0,0 +1,410 @@\n+#", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c033272b5324789e17fc359ffc3276c4de8bdb6"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4897281f9de440bea57416fbb2499dacfc59f6b", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/a4897281f9de440bea57416fbb2499dacfc59f6b", "committedDate": "2020-10-13T05:04:40Z", "message": "Merge branch 'coder' of github.com:nehsyc/beam into coder"}, "afterCommit": {"oid": "638b902cef2a6b62b1d7433170b1344494065dc7", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/638b902cef2a6b62b1d7433170b1344494065dc7", "committedDate": "2020-10-13T05:07:06Z", "message": "Default empty shard id & add ShardedKey coder in Python"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "638b902cef2a6b62b1d7433170b1344494065dc7", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/638b902cef2a6b62b1d7433170b1344494065dc7", "committedDate": "2020-10-13T05:07:06Z", "message": "Default empty shard id & add ShardedKey coder in Python"}, "afterCommit": {"oid": "b73a4633e4dab7cdc3c5e5bd983fdffc1a6ae7f4", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/b73a4633e4dab7cdc3c5e5bd983fdffc1a6ae7f4", "committedDate": "2020-10-13T05:24:58Z", "message": "Default empty shard id & add ShardedKey coder in Python\n\nRun yapf"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b73a4633e4dab7cdc3c5e5bd983fdffc1a6ae7f4", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/b73a4633e4dab7cdc3c5e5bd983fdffc1a6ae7f4", "committedDate": "2020-10-13T05:24:58Z", "message": "Default empty shard id & add ShardedKey coder in Python\n\nRun yapf"}, "afterCommit": {"oid": "333978fdf6b5f93d2aebacc543453980a10e9c2a", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/333978fdf6b5f93d2aebacc543453980a10e9c2a", "committedDate": "2020-10-13T05:43:50Z", "message": "Default empty shard id & add ShardedKey coder in Python\n\nRun yapf"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "606fc050f752831588d4eb36d3001ff90991cf95", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/606fc050f752831588d4eb36d3001ff90991cf95", "committedDate": "2020-10-13T05:48:56Z", "message": "Delete json"}, "afterCommit": {"oid": "f23b49a3db48f8e699fa4b92b8495d9bf39457d4", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/f23b49a3db48f8e699fa4b92b8495d9bf39457d4", "committedDate": "2020-10-13T06:05:21Z", "message": "Delete json"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f23b49a3db48f8e699fa4b92b8495d9bf39457d4", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/f23b49a3db48f8e699fa4b92b8495d9bf39457d4", "committedDate": "2020-10-13T06:05:21Z", "message": "Delete json"}, "afterCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/154790f17d853a96e8e66e4d5625521845ef729d", "committedDate": "2020-10-13T06:35:29Z", "message": "Default empty shard id & add ShardedKey coder in Python\n\nRun spotlessApply & yapf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjcxNzUw", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-507671750", "createdAt": "2020-10-13T17:25:50Z", "commit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzoyNTo1MFrOHgxxvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzozMDoxOVrOHgx7yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMjAyOQ==", "bodyText": "Maybe move these to the yaml file so they can be shared among all languages.", "url": "https://github.com/apache/beam/pull/13069#discussion_r504132029", "createdAt": "2020-10-13T17:25:50Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/coders/coders_test_common.py", "diffHunk": "@@ -570,6 +571,37 @@ def test_map_coder(self):\n         }, {}, {i: str(i)\n                 for i in range(5000)})\n \n+  def test_sharded_key_coder(self):\n+    coder = coders.ShardedKeyCoder(coders.BytesCoder())\n+    # Verify cloud object representation\n+    self.assertEqual({\n+        '@type': 'kind:sharded_key',\n+        'component_encodings': [coders.BytesCoder().as_cloud_object()]\n+    },\n+                     coder.as_cloud_object())\n+\n+    # Test binary representation\n+    self.assertEqual(b'\\x00\\x00', coder.encode(ShardedKey(b'')))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMjE5Nw==", "bodyText": "Have at least one example with a non-bytes key type?", "url": "https://github.com/apache/beam/pull/13069#discussion_r504132197", "createdAt": "2020-10-13T17:26:08Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/coders/coders_test_common.py", "diffHunk": "@@ -570,6 +571,37 @@ def test_map_coder(self):\n         }, {}, {i: str(i)\n                 for i in range(5000)})\n \n+  def test_sharded_key_coder(self):\n+    coder = coders.ShardedKeyCoder(coders.BytesCoder())\n+    # Verify cloud object representation\n+    self.assertEqual({\n+        '@type': 'kind:sharded_key',\n+        'component_encodings': [coders.BytesCoder().as_cloud_object()]\n+    },\n+                     coder.as_cloud_object())\n+\n+    # Test binary representation\n+    self.assertEqual(b'\\x00\\x00', coder.encode(ShardedKey(b'')))\n+    self.assertEqual(b'\\x00\\x03key', coder.encode(ShardedKey(b'key')))\n+    self.assertEqual(b'\\x00\\x00', coder.encode(ShardedKey(b'', b'')))\n+    self.assertEqual(b'\\x03123\\00', coder.encode(ShardedKey(b'', b'123')))\n+    self.assertEqual(b'\\x03123\\03key', coder.encode(ShardedKey(b'key', b'123')))\n+\n+    test_values = [\n+        ShardedKey(b''),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMzYzMg==", "bodyText": "You can drop the anding with 0xFFFF. You could also just return hash((self.key, self.shard_key)) (i.e. has the tuple).", "url": "https://github.com/apache/beam/pull/13069#discussion_r504133632", "createdAt": "2020-10-13T17:28:38Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/sharded_key.py", "diffHunk": "@@ -0,0 +1,65 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+\n+class ShardedKey(object):\n+  \"\"\"A sharded key consisting of a user key and a shard id.\n+\n+  Attributes:\n+    key: The user key.\n+    shard_id: An opaque byte string that uniquely represents a shard of the key.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      key,\n+      shard_id=b'',  # type: bytes\n+  ):\n+    # type: (...) -> None\n+    assert shard_id is not None\n+    self._key = key\n+    self._shard_id = shard_id\n+\n+  @property\n+  def key(self):\n+    return self._key\n+\n+  @property\n+  def shard_id(self):\n+    return self._shard_id\n+\n+  def __repr__(self):\n+    return '(%s, %s)' % (repr(self.key), self.shard_id)\n+\n+  def __eq__(self, other):\n+    return (\n+        type(self) == type(other) and self.key == other.key and\n+        self.shard_id == other.shard_id)\n+\n+  def __ne__(self, other):\n+    # TODO(BEAM-5949): Needed for Python 2 compatibility.\n+    return not self == other\n+\n+  def __hash__(self):\n+    return ((hash(self.key) & 0xFFFFFFFFFFFFFFF) + 3 *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNDMzNg==", "bodyText": "Do we intend this to be public? IMHO, it'd be better to not have it part of the public API (and we can always add it later if needed).", "url": "https://github.com/apache/beam/pull/13069#discussion_r504134336", "createdAt": "2020-10-13T17:29:53Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/sharded_key.py", "diffHunk": "@@ -0,0 +1,65 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+\n+class ShardedKey(object):\n+  \"\"\"A sharded key consisting of a user key and a shard id.\n+\n+  Attributes:\n+    key: The user key.\n+    shard_id: An opaque byte string that uniquely represents a shard of the key.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      key,\n+      shard_id=b'',  # type: bytes\n+  ):\n+    # type: (...) -> None\n+    assert shard_id is not None\n+    self._key = key\n+    self._shard_id = shard_id\n+\n+  @property\n+  def key(self):\n+    return self._key\n+\n+  @property\n+  def shard_id(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNDYwMQ==", "bodyText": "Same for Java.", "url": "https://github.com/apache/beam/pull/13069#discussion_r504134601", "createdAt": "2020-10-13T17:30:19Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/sharded_key.py", "diffHunk": "@@ -0,0 +1,65 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+\n+class ShardedKey(object):\n+  \"\"\"A sharded key consisting of a user key and a shard id.\n+\n+  Attributes:\n+    key: The user key.\n+    shard_id: An opaque byte string that uniquely represents a shard of the key.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      key,\n+      shard_id=b'',  # type: bytes\n+  ):\n+    # type: (...) -> None\n+    assert shard_id is not None\n+    self._key = key\n+    self._shard_id = shard_id\n+\n+  @property\n+  def key(self):\n+    return self._key\n+\n+  @property\n+  def shard_id(self):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNDMzNg=="}, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjYxMzgx", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-507661381", "createdAt": "2020-10-13T17:12:01Z", "commit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzoxMjowMVrOHgxRTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzozNzozNFrOHgyLKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyMzcyNg==", "bodyText": "Instead of referencing varInt(len(shard id)) shard id we should just say that the shard id is encoded using beam:coder:bytes:v1\nOther coders descriptions should be more like row where we refer to other well known encodings.", "url": "https://github.com/apache/beam/pull/13069#discussion_r504123726", "createdAt": "2020-10-13T17:12:01Z", "author": {"login": "lukecwik"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -879,6 +879,29 @@ message StandardCoders {\n     // Components: None\n     // Experimental.\n     ROW = 13 [(beam_urn) = \"beam:coder:row:v1\"];\n+\n+    // Encodes a use key and a shard id which is an opaque byte string.\n+    //\n+    // The encoding for a sharded key consists of the length prefixed shard id\n+    // and the encoded user key in the following order:\n+    //\n+    //     varInt(len(shard id))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyOTc2NQ==", "bodyText": "In the long run we should aim to replace the existing implementation and its usage within WriteFiles.", "url": "https://github.com/apache/beam/pull/13069#discussion_r504129765", "createdAt": "2020-10-13T17:22:02Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMTYyMg==", "bodyText": "the bytearraycoder isn't consistent with equals yet the AutoValue ShardedKey is so we should state that ShardedKey is consistent with equals iff keyCoder is.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return shardCoder.consistentWithEquals() && keyCoder.consistentWithEquals();\n          \n          \n            \n                  return keyCoder.consistentWithEquals();", "url": "https://github.com/apache/beam/pull/13069#discussion_r504131622", "createdAt": "2020-10-13T17:25:11Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key) {\n+    return new AutoValue_ShardedKey(new byte[0], key);\n+  }\n+\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      shardCoder.encode(shardedKey.getShardId(), outStream);\n+      keyCoder.encode(shardedKey.getKey(), outStream);\n+    }\n+\n+    @Override\n+    public ShardedKey<K> decode(InputStream inStream) throws IOException {\n+      byte[] shardId = shardCoder.decode(inStream);\n+      K key = keyCoder.decode(inStream);\n+      return ShardedKey.of(key, shardId);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public void verifyDeterministic() throws NonDeterministicException {\n+      shardCoder.verifyDeterministic();\n+      keyCoder.verifyDeterministic();\n+    }\n+\n+    @Override\n+    public boolean consistentWithEquals() {\n+      return shardCoder.consistentWithEquals() && keyCoder.consistentWithEquals();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMjIwMA==", "bodyText": "See KvCoder for an example:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  keyCoder.verifyDeterministic();\n          \n          \n            \n                  verifyDeterministic(this, \"Key coder must be deterministic\", keyCoder);", "url": "https://github.com/apache/beam/pull/13069#discussion_r504132200", "createdAt": "2020-10-13T17:26:09Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key) {\n+    return new AutoValue_ShardedKey(new byte[0], key);\n+  }\n+\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      shardCoder.encode(shardedKey.getShardId(), outStream);\n+      keyCoder.encode(shardedKey.getKey(), outStream);\n+    }\n+\n+    @Override\n+    public ShardedKey<K> decode(InputStream inStream) throws IOException {\n+      byte[] shardId = shardCoder.decode(inStream);\n+      K key = keyCoder.decode(inStream);\n+      return ShardedKey.of(key, shardId);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public void verifyDeterministic() throws NonDeterministicException {\n+      shardCoder.verifyDeterministic();\n+      keyCoder.verifyDeterministic();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMjU2MA==", "bodyText": "No point in checking something that is required to be deterministic\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  shardCoder.verifyDeterministic();", "url": "https://github.com/apache/beam/pull/13069#discussion_r504132560", "createdAt": "2020-10-13T17:26:46Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key) {\n+    return new AutoValue_ShardedKey(new byte[0], key);\n+  }\n+\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new AutoValue_ShardedKey(shardId, key);\n+  }\n+\n+  @SuppressWarnings(\"mutable\")\n+  public abstract byte[] getShardId();\n+\n+  public abstract K getKey();\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   length of shard id\n+      //   shard id\n+      //   encoded user key\n+      shardCoder.encode(shardedKey.getShardId(), outStream);\n+      keyCoder.encode(shardedKey.getKey(), outStream);\n+    }\n+\n+    @Override\n+    public ShardedKey<K> decode(InputStream inStream) throws IOException {\n+      byte[] shardId = shardCoder.decode(inStream);\n+      K key = keyCoder.decode(inStream);\n+      return ShardedKey.of(key, shardId);\n+    }\n+\n+    @Override\n+    public List<? extends org.apache.beam.sdk.coders.Coder<?>> getCoderArguments() {\n+      return Collections.singletonList(keyCoder);\n+    }\n+\n+    @Override\n+    public void verifyDeterministic() throws NonDeterministicException {\n+      shardCoder.verifyDeterministic();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMzQ3NA==", "bodyText": "Please make byte[0] a constant. Please add comment saying that the default shard identifier is the empty byte string.", "url": "https://github.com/apache/beam/pull/13069#discussion_r504133474", "createdAt": "2020-10-13T17:28:21Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import com.google.auto.value.AutoValue;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/**\n+ * A sharded key consisting of a user key and a shard id represented by bytes.\n+ *\n+ * <p>This is a more generic definition of {@link org.apache.beam.sdk.values.ShardedKey}.\n+ */\n+@AutoValue\n+public abstract class ShardedKey<K> {\n+\n+  public static <K> ShardedKey<K> of(K key) {\n+    return new AutoValue_ShardedKey(new byte[0], key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzNzIxNw==", "bodyText": "Why do you need the LengthPrefixCoderImpl here?", "url": "https://github.com/apache/beam/pull/13069#discussion_r504137217", "createdAt": "2020-10-13T17:35:12Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -1365,3 +1366,38 @@ def estimate_size(self, value, nested=False):\n     # type: (Any, bool) -> int\n     value_size = self._value_coder.estimate_size(value)\n     return get_varint_size(value_size) + value_size\n+\n+\n+class ShardedKeyCoderImpl(StreamCoderImpl):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  A coder for sharded user keys.\n+\n+  The encoding and decoding should follow the order:\n+      length of shard id byte string\n+      shard id byte string\n+      encoded user key\n+  \"\"\"\n+  def __init__(self, key_coder_impl):\n+    self._shard_id_coder_impl = LengthPrefixCoderImpl(BytesCoderImpl())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODI2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                self._key_coder_impl.encode_to_stream(value.key, out, True)\n          \n          \n            \n                self._key_coder_impl.encode_to_stream(value.key, out, nested)", "url": "https://github.com/apache/beam/pull/13069#discussion_r504138260", "createdAt": "2020-10-13T17:37:03Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -1365,3 +1366,38 @@ def estimate_size(self, value, nested=False):\n     # type: (Any, bool) -> int\n     value_size = self._value_coder.estimate_size(value)\n     return get_varint_size(value_size) + value_size\n+\n+\n+class ShardedKeyCoderImpl(StreamCoderImpl):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  A coder for sharded user keys.\n+\n+  The encoding and decoding should follow the order:\n+      length of shard id byte string\n+      shard id byte string\n+      encoded user key\n+  \"\"\"\n+  def __init__(self, key_coder_impl):\n+    self._shard_id_coder_impl = LengthPrefixCoderImpl(BytesCoderImpl())\n+    self._key_coder_impl = key_coder_impl\n+\n+  def encode_to_stream(self, value, out, nested):\n+    # type: (ShardedKey, create_OutputStream, bool) -> None\n+    self._shard_id_coder_impl.encode_to_stream(value.shard_id, out, True)\n+    self._key_coder_impl.encode_to_stream(value.key, out, True)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODMwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                key = self._key_coder_impl.decode_from_stream(in_stream, True)\n          \n          \n            \n                key = self._key_coder_impl.decode_from_stream(in_stream, nested)", "url": "https://github.com/apache/beam/pull/13069#discussion_r504138309", "createdAt": "2020-10-13T17:37:09Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -1365,3 +1366,38 @@ def estimate_size(self, value, nested=False):\n     # type: (Any, bool) -> int\n     value_size = self._value_coder.estimate_size(value)\n     return get_varint_size(value_size) + value_size\n+\n+\n+class ShardedKeyCoderImpl(StreamCoderImpl):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  A coder for sharded user keys.\n+\n+  The encoding and decoding should follow the order:\n+      length of shard id byte string\n+      shard id byte string\n+      encoded user key\n+  \"\"\"\n+  def __init__(self, key_coder_impl):\n+    self._shard_id_coder_impl = LengthPrefixCoderImpl(BytesCoderImpl())\n+    self._key_coder_impl = key_coder_impl\n+\n+  def encode_to_stream(self, value, out, nested):\n+    # type: (ShardedKey, create_OutputStream, bool) -> None\n+    self._shard_id_coder_impl.encode_to_stream(value.shard_id, out, True)\n+    self._key_coder_impl.encode_to_stream(value.key, out, True)\n+\n+  def decode_from_stream(self, in_stream, nested):\n+    # type: (create_InputStream, bool) -> ShardedKey\n+    shard_id = self._shard_id_coder_impl.decode_from_stream(in_stream, True)\n+    key = self._key_coder_impl.decode_from_stream(in_stream, True)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODUzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    self._key_coder_impl.estimate_size(value.key, nested=True))\n          \n          \n            \n                    self._key_coder_impl.estimate_size(value.key, nested=nested))", "url": "https://github.com/apache/beam/pull/13069#discussion_r504138536", "createdAt": "2020-10-13T17:37:34Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -1365,3 +1366,38 @@ def estimate_size(self, value, nested=False):\n     # type: (Any, bool) -> int\n     value_size = self._value_coder.estimate_size(value)\n     return get_varint_size(value_size) + value_size\n+\n+\n+class ShardedKeyCoderImpl(StreamCoderImpl):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  A coder for sharded user keys.\n+\n+  The encoding and decoding should follow the order:\n+      length of shard id byte string\n+      shard id byte string\n+      encoded user key\n+  \"\"\"\n+  def __init__(self, key_coder_impl):\n+    self._shard_id_coder_impl = LengthPrefixCoderImpl(BytesCoderImpl())\n+    self._key_coder_impl = key_coder_impl\n+\n+  def encode_to_stream(self, value, out, nested):\n+    # type: (ShardedKey, create_OutputStream, bool) -> None\n+    self._shard_id_coder_impl.encode_to_stream(value.shard_id, out, True)\n+    self._key_coder_impl.encode_to_stream(value.key, out, True)\n+\n+  def decode_from_stream(self, in_stream, nested):\n+    # type: (create_InputStream, bool) -> ShardedKey\n+    shard_id = self._shard_id_coder_impl.decode_from_stream(in_stream, True)\n+    key = self._key_coder_impl.decode_from_stream(in_stream, True)\n+    return ShardedKey(key=key, shard_id=shard_id)\n+\n+  def estimate_size(self, value, nested=False):\n+    # type: (Any, bool) -> int\n+    estimated_size = 0\n+    estimated_size += (\n+        self._shard_id_coder_impl.estimate_size(value.shard_id, nested=True))\n+    estimated_size += (\n+        self._key_coder_impl.estimate_size(value.key, nested=True))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 75}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbe3b05f50ec7f0b30245147036abe97072faccb", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/cbe3b05f50ec7f0b30245147036abe97072faccb", "committedDate": "2020-10-15T19:53:07Z", "message": "make shard id opaque; fix some documentations; add more test cases"}, "afterCommit": {"oid": "bbb52ad8d380b36bbdb46523dab7d6c203369ceb", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/bbb52ad8d380b36bbdb46523dab7d6c203369ceb", "committedDate": "2020-10-16T19:46:05Z", "message": "make shard id opaque; fix some documentations; add more test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODE5Nzgx", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-510819781", "createdAt": "2020-10-16T21:57:04Z", "commit": {"oid": "bbb52ad8d380b36bbdb46523dab7d6c203369ceb"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTo1NzowNFrOHjQ3ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjowMDozOFrOHjQ74w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczODUzMw==", "bodyText": "True is correct and matches the description and Java. Let's not create more coders that have different nested/unnested encodings.", "url": "https://github.com/apache/beam/pull/13069#discussion_r506738533", "createdAt": "2020-10-16T21:57:04Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/coders/coder_impl.py", "diffHunk": "@@ -1365,3 +1366,38 @@ def estimate_size(self, value, nested=False):\n     # type: (Any, bool) -> int\n     value_size = self._value_coder.estimate_size(value)\n     return get_varint_size(value_size) + value_size\n+\n+\n+class ShardedKeyCoderImpl(StreamCoderImpl):\n+  \"\"\"For internal use only; no backwards-compatibility guarantees.\n+\n+  A coder for sharded user keys.\n+\n+  The encoding and decoding should follow the order:\n+      length of shard id byte string\n+      shard id byte string\n+      encoded user key\n+  \"\"\"\n+  def __init__(self, key_coder_impl):\n+    self._shard_id_coder_impl = LengthPrefixCoderImpl(BytesCoderImpl())\n+    self._key_coder_impl = key_coder_impl\n+\n+  def encode_to_stream(self, value, out, nested):\n+    # type: (ShardedKey, create_OutputStream, bool) -> None\n+    self._shard_id_coder_impl.encode_to_stream(value.shard_id, out, True)\n+    self._key_coder_impl.encode_to_stream(value.key, out, True)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzODI2MA=="}, "originalCommit": {"oid": "154790f17d853a96e8e66e4d5625521845ef729d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczODkxMQ==", "bodyText": "Is this yapf or some other auto-formatter?", "url": "https://github.com/apache/beam/pull/13069#discussion_r506738911", "createdAt": "2020-10-16T21:58:12Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/coders/coders.py", "diffHunk": "@@ -312,11 +312,12 @@ def register_urn(\n \n   @classmethod\n   @overload\n-  def register_urn(cls,\n-                   urn,  # type: str\n-                   parameter_type,  # type: Optional[Type[T]]\n-                   fn  # type: Callable[[T, List[Coder], PipelineContext], Any]\n-                  ):\n+  def register_urn(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbb52ad8d380b36bbdb46523dab7d6c203369ceb"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczOTQwOA==", "bodyText": "Any reason not to make this required?", "url": "https://github.com/apache/beam/pull/13069#discussion_r506739408", "createdAt": "2020-10-16T21:59:49Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/sharded_key.py", "diffHunk": "@@ -0,0 +1,62 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+\n+class ShardedKey(object):\n+  \"\"\"\n+  A sharded key consisting of a user key and an opaque shard id represented by\n+  bytes.\n+\n+  Attributes:\n+    key: The user key.\n+    shard_id: An opaque byte string that uniquely represents a shard of the key.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      key,\n+      shard_id=b'',  # type: bytes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbb52ad8d380b36bbdb46523dab7d6c203369ceb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczOTY4Mw==", "bodyText": "We don't need Python 2 compatibility anymore.", "url": "https://github.com/apache/beam/pull/13069#discussion_r506739683", "createdAt": "2020-10-16T22:00:38Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/utils/sharded_key.py", "diffHunk": "@@ -0,0 +1,62 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+from __future__ import absolute_import\n+\n+\n+class ShardedKey(object):\n+  \"\"\"\n+  A sharded key consisting of a user key and an opaque shard id represented by\n+  bytes.\n+\n+  Attributes:\n+    key: The user key.\n+    shard_id: An opaque byte string that uniquely represents a shard of the key.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      key,\n+      shard_id=b'',  # type: bytes\n+  ):\n+    # type: (...) -> None\n+    assert shard_id is not None\n+    self._key = key\n+    self._shard_id = shard_id\n+\n+  @property\n+  def key(self):\n+    return self._key\n+\n+  def __repr__(self):\n+    return '(%s, %s)' % (repr(self.key), self._shard_id)\n+\n+  def __eq__(self, other):\n+    return (\n+        type(self) == type(other) and self.key == other.key and\n+        self._shard_id == other._shard_id)\n+\n+  def __ne__(self, other):\n+    # TODO(BEAM-5949): Needed for Python 2 compatibility.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbb52ad8d380b36bbdb46523dab7d6c203369ceb"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk0MzM0", "url": "https://github.com/apache/beam/pull/13069#pullrequestreview-515094334", "createdAt": "2020-10-22T20:29:19Z", "commit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyOToxOVrOHmyo0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozODowNVrOHmy6Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNzU4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Encodes a use key and a shard id which is an opaque byte string.\n          \n          \n            \n                // Encodes a user key and a shard id which is an opaque byte string.", "url": "https://github.com/apache/beam/pull/13069#discussion_r510437586", "createdAt": "2020-10-22T20:29:19Z", "author": {"login": "lukecwik"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -879,6 +879,28 @@ message StandardCoders {\n     // Components: None\n     // Experimental.\n     ROW = 13 [(beam_urn) = \"beam:coder:row:v1\"];\n+\n+    // Encodes a use key and a shard id which is an opaque byte string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzODAxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //     - length prefixed shard id using beam:coder:bytes:v1\n          \n          \n            \n                //     - bytes shard id using beam:coder:bytes:v1", "url": "https://github.com/apache/beam/pull/13069#discussion_r510438012", "createdAt": "2020-10-22T20:30:04Z", "author": {"login": "lukecwik"}, "path": "model/pipeline/src/main/proto/beam_runner_api.proto", "diffHunk": "@@ -879,6 +879,28 @@ message StandardCoders {\n     // Components: None\n     // Experimental.\n     ROW = 13 [(beam_urn) = \"beam:coder:row:v1\"];\n+\n+    // Encodes a use key and a shard id which is an opaque byte string.\n+    //\n+    // The encoding for a sharded key consists of a shard id byte string and the\n+    // encoded user key in the following order:\n+    //\n+    //     - length prefixed shard id using beam:coder:bytes:v1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTI4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */\n          \n          \n            \n              /** Creates a ShardedKey with given key and shard id. Shard id must not be null and must not be mutated. */", "url": "https://github.com/apache/beam/pull/13069#discussion_r510439285", "createdAt": "2020-10-22T20:32:35Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/** A sharded key consisting of a user key and an opaque shard id represented by bytes. */\n+public class ShardedKey<K> {\n+  private static final byte[] EMPTY_SHARD_ID = new byte[0];\n+\n+  private final K key;\n+  private final byte[] shardId;\n+\n+  protected ShardedKey(K key, byte[] shardId) {\n+    this.key = key;\n+    this.shardId = shardId;\n+  }\n+\n+  /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTY0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return \"ShardedKey{\" + \"key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";\n          \n          \n            \n                return \"ShardedKey{key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";", "url": "https://github.com/apache/beam/pull/13069#discussion_r510439643", "createdAt": "2020-10-22T20:33:17Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/** A sharded key consisting of a user key and an opaque shard id represented by bytes. */\n+public class ShardedKey<K> {\n+  private static final byte[] EMPTY_SHARD_ID = new byte[0];\n+\n+  private final K key;\n+  private final byte[] shardId;\n+\n+  protected ShardedKey(K key, byte[] shardId) {\n+    this.key = key;\n+    this.shardId = shardId;\n+  }\n+\n+  /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(key != null, \"Key should not be null!\");\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new ShardedKey<K>(key, shardId);\n+  }\n+\n+  public K getKey() {\n+    return key;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return \"ShardedKey{\" + \"key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDA3MQ==", "bodyText": "rename h$ to hash", "url": "https://github.com/apache/beam/pull/13069#discussion_r510440071", "createdAt": "2020-10-22T20:34:07Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/** A sharded key consisting of a user key and an opaque shard id represented by bytes. */\n+public class ShardedKey<K> {\n+  private static final byte[] EMPTY_SHARD_ID = new byte[0];\n+\n+  private final K key;\n+  private final byte[] shardId;\n+\n+  protected ShardedKey(K key, byte[] shardId) {\n+    this.key = key;\n+    this.shardId = shardId;\n+  }\n+\n+  /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(key != null, \"Key should not be null!\");\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new ShardedKey<K>(key, shardId);\n+  }\n+\n+  public K getKey() {\n+    return key;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return \"ShardedKey{\" + \"key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";\n+  }\n+\n+  @Override\n+  public boolean equals(Object o) {\n+    if (o == this) {\n+      return true;\n+    }\n+    if (o instanceof ShardedKey) {\n+      ShardedKey<?> that = (ShardedKey<?>) o;\n+      return this.key.equals(that.key) && Arrays.equals(this.shardId, that.shardId);\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    int h$ = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDM5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  //   length prefixed shard id byte string\n          \n          \n            \n                  //   shard id byte string", "url": "https://github.com/apache/beam/pull/13069#discussion_r510440391", "createdAt": "2020-10-22T20:34:39Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/** A sharded key consisting of a user key and an opaque shard id represented by bytes. */\n+public class ShardedKey<K> {\n+  private static final byte[] EMPTY_SHARD_ID = new byte[0];\n+\n+  private final K key;\n+  private final byte[] shardId;\n+\n+  protected ShardedKey(K key, byte[] shardId) {\n+    this.key = key;\n+    this.shardId = shardId;\n+  }\n+\n+  /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(key != null, \"Key should not be null!\");\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new ShardedKey<K>(key, shardId);\n+  }\n+\n+  public K getKey() {\n+    return key;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return \"ShardedKey{\" + \"key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";\n+  }\n+\n+  @Override\n+  public boolean equals(Object o) {\n+    if (o == this) {\n+      return true;\n+    }\n+    if (o instanceof ShardedKey) {\n+      ShardedKey<?> that = (ShardedKey<?>) o;\n+      return this.key.equals(that.key) && Arrays.equals(this.shardId, that.shardId);\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    int h$ = 1;\n+    h$ *= 1000003;\n+    h$ ^= key.hashCode();\n+    h$ *= 1000003;\n+    h$ ^= Arrays.hashCode(shardId);\n+    return h$;\n+  }\n+\n+  public static class Coder<K> extends StructuredCoder<ShardedKey<K>> {\n+\n+    private final ByteArrayCoder shardCoder = ByteArrayCoder.of();\n+    private final org.apache.beam.sdk.coders.Coder<K> keyCoder;\n+\n+    private Coder(org.apache.beam.sdk.coders.Coder<K> coder) {\n+      keyCoder = coder;\n+    }\n+\n+    public static <K> ShardedKey.Coder<K> of(org.apache.beam.sdk.coders.Coder<K> keyCoder) {\n+      return new ShardedKey.Coder<K>(keyCoder);\n+    }\n+\n+    public org.apache.beam.sdk.coders.Coder<K> getKeyCoder() {\n+      return keyCoder;\n+    }\n+\n+    @Override\n+    public void encode(ShardedKey<K> shardedKey, OutputStream outStream) throws IOException {\n+      // The encoding should follow the order:\n+      //   length prefixed shard id byte string", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MjA2Nw==", "bodyText": "FYI, this equals method assumes the key type has a valid equals method and generally shouldn't be used. We should use structuralValue anywhere for comparisons.", "url": "https://github.com/apache/beam/pull/13069#discussion_r510442067", "createdAt": "2020-10-22T20:38:05Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/util/ShardedKey.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.util;\n+\n+import static org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.beam.sdk.coders.ByteArrayCoder;\n+import org.apache.beam.sdk.coders.StructuredCoder;\n+import org.apache.beam.sdk.util.common.ElementByteSizeObserver;\n+\n+/** A sharded key consisting of a user key and an opaque shard id represented by bytes. */\n+public class ShardedKey<K> {\n+  private static final byte[] EMPTY_SHARD_ID = new byte[0];\n+\n+  private final K key;\n+  private final byte[] shardId;\n+\n+  protected ShardedKey(K key, byte[] shardId) {\n+    this.key = key;\n+    this.shardId = shardId;\n+  }\n+\n+  /** Creates a ShardedKey with given key and shard id. Shard id must not be null. */\n+  public static <K> ShardedKey<K> of(K key, byte[] shardId) {\n+    checkArgument(key != null, \"Key should not be null!\");\n+    checkArgument(shardId != null, \"Shard id should not be null!\");\n+    return new ShardedKey<K>(key, shardId);\n+  }\n+\n+  public K getKey() {\n+    return key;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return \"ShardedKey{\" + \"key=\" + key + \", shardId=\" + Arrays.toString(shardId) + \"}\";\n+  }\n+\n+  @Override\n+  public boolean equals(Object o) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa105d15a4d2d2be97e2aedef9b5fa7abf541466"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61d86f1611a1b993845fe1fa3ff10451b76123ec", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/61d86f1611a1b993845fe1fa3ff10451b76123ec", "committedDate": "2020-10-22T21:19:23Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Lukasz Cwik <lcwik@google.com>"}, "afterCommit": {"oid": "23e472df156d2e8d22c9ea7c6086245e7e1ae685", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/23e472df156d2e8d22c9ea7c6086245e7e1ae685", "committedDate": "2020-10-22T22:19:16Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23e472df156d2e8d22c9ea7c6086245e7e1ae685", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/23e472df156d2e8d22c9ea7c6086245e7e1ae685", "committedDate": "2020-10-22T22:19:16Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}, "afterCommit": {"oid": "b3f89572052d7116134674deb643cef0efef313f", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/b3f89572052d7116134674deb643cef0efef313f", "committedDate": "2020-10-22T22:54:11Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3f89572052d7116134674deb643cef0efef313f", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/b3f89572052d7116134674deb643cef0efef313f", "committedDate": "2020-10-22T22:54:11Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}, "afterCommit": {"oid": "1cb27fe8d17e0cdba466cebe00e289f34d73f9f0", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/1cb27fe8d17e0cdba466cebe00e289f34d73f9f0", "committedDate": "2020-10-22T23:00:25Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9d8c66da16d18b802ba44b9ad529cfad604bbe", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/df9d8c66da16d18b802ba44b9ad529cfad604bbe", "committedDate": "2020-10-22T23:09:36Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1cb27fe8d17e0cdba466cebe00e289f34d73f9f0", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/1cb27fe8d17e0cdba466cebe00e289f34d73f9f0", "committedDate": "2020-10-22T23:00:25Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}, "afterCommit": {"oid": "df9d8c66da16d18b802ba44b9ad529cfad604bbe", "author": {"user": {"login": "nehsyc", "name": "Siyuan Chen"}}, "url": "https://github.com/apache/beam/commit/df9d8c66da16d18b802ba44b9ad529cfad604bbe", "committedDate": "2020-10-22T23:09:36Z", "message": "Add a well-known ShardedKey coder in Java/Python SDK"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1924, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}