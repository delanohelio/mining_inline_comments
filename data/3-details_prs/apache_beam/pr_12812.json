{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MTgwMjM1", "number": 12812, "title": "[BEAM-10873] Stronger testing of dataframe partitioning declarations.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-10T18:18:03Z", "url": "https://github.com/apache/beam/pull/12812", "merged": true, "mergeCommit": {"oid": "6279815d8004e3f93061dc2d6b8105103a1571df"}, "closed": true, "closedAt": "2020-09-15T17:28:51Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHo9IogBqjM3NTM1MDY2Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI8-trAFqTQ4ODI0NjU4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d394f005f0aa7e1770f47e85c84902056f600734", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/d394f005f0aa7e1770f47e85c84902056f600734", "committedDate": "2020-09-10T18:15:14Z", "message": "[BEAM-10873] Use partitioinig session for tests.\n\nAlso reject the default nsmallest and nlargest which assume keep='first'\nand introduce keep='any' option."}, "afterCommit": {"oid": "304ce827cb248270e58cebd381f4bf590cb194da", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/304ce827cb248270e58cebd381f4bf590cb194da", "committedDate": "2020-09-10T22:57:32Z", "message": "[BEAM-10873] Use partitioinig session for tests.\n\nAlso reject the default nsmallest and nlargest which assume keep='first'\nand introduce keep='any' option."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjI1NjIw", "url": "https://github.com/apache/beam/pull/12812#pullrequestreview-488225620", "createdAt": "2020-09-14T23:38:13Z", "commit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzozODoxM1rOHRrOrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1NDo0N1rOHRrhkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NjExMQ==", "bodyText": "any is not part of the pandas API. I assume this is an option you're adding to provide a way to get exactly n without promising to get the first or last since that's order-sensitive?\nThat makes sense - but we should probably document the places where we diverge from pandas like this (could just be a TODO here and/or a jira for now).", "url": "https://github.com/apache/beam/pull/12812#discussion_r488296111", "createdAt": "2020-09-14T23:38:13Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -551,9 +559,13 @@ def merge(\n       return merged.reset_index(drop=True)\n \n   @frame_base.args_to_kwargs(pd.DataFrame)\n-  def nlargest(self, **kwargs):\n-    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def nlargest(self, keep, **kwargs):\n+    if keep == 'any':\n+      keep = 'first'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDQ1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            class PartitioningSession(Session):\n          \n          \n            \n              def evaluate(self, expr):\n          \n          \n            \n            class PartitioningSession(Session):\n          \n          \n            \n              \"\"\"An extension of Session that ensures input dataframes are split into at least `len(df)` separate partitions and input in a random order. For testing only.\n          \n          \n            \n              \"\"\"\n          \n          \n            \n              def evaluate(self, expr):\n          \n      \n    \n    \n  \n\nOr something like that :)", "url": "https://github.com/apache/beam/pull/12812#discussion_r488300457", "createdAt": "2020-09-14T23:53:00Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/expressions.py", "diffHunk": "@@ -45,6 +45,45 @@ def lookup(self, expr):  #  type: (Expression) -> Any\n     return self._bindings[expr]\n \n \n+class PartitioningSession(Session):\n+  def evaluate(self, expr):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMDk0NQ==", "bodyText": "Also: I take it PartitioningSession revealed this problem with first/last? That's good to know, I was wondering about these options earlier but figured I was misunderstanding something.", "url": "https://github.com/apache/beam/pull/12812#discussion_r488300945", "createdAt": "2020-09-14T23:54:47Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -551,9 +559,13 @@ def merge(\n       return merged.reset_index(drop=True)\n \n   @frame_base.args_to_kwargs(pd.DataFrame)\n-  def nlargest(self, **kwargs):\n-    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def nlargest(self, keep, **kwargs):\n+    if keep == 'any':\n+      keep = 'first'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NjExMQ=="}, "originalCommit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a27e075200c06bca61ff7d4e71acd06ac1a848fe", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/a27e075200c06bca61ff7d4e71acd06ac1a848fe", "committedDate": "2020-09-15T00:48:24Z", "message": "Use index for partitioning of elementwise operations with multiple DataFrame inputs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0f95a8406dbb924e6f117176385e9a13365d16b", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/b0f95a8406dbb924e6f117176385e9a13365d16b", "committedDate": "2020-09-15T00:48:43Z", "message": "[BEAM-10873] Introduce partitioning session for stronger testing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7433760a61963851a82773cf5ce8409875cd36f1", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/7433760a61963851a82773cf5ce8409875cd36f1", "committedDate": "2020-09-15T00:48:43Z", "message": "[BEAM-10873] Use partitioinig session for tests.\n\nAlso reject the default nsmallest and nlargest which assume keep='first'\nand introduce keep='any' option."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/49f2ce027d6fead8bb9b44a898bb3d86da278ffc", "committedDate": "2020-09-11T19:09:02Z", "message": "Work around lint error."}, "afterCommit": {"oid": "7433760a61963851a82773cf5ce8409875cd36f1", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/7433760a61963851a82773cf5ce8409875cd36f1", "committedDate": "2020-09-15T00:48:43Z", "message": "[BEAM-10873] Use partitioinig session for tests.\n\nAlso reject the default nsmallest and nlargest which assume keep='first'\nand introduce keep='any' option."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjQ2NTgz", "url": "https://github.com/apache/beam/pull/12812#pullrequestreview-488246583", "createdAt": "2020-09-15T00:43:38Z", "commit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo0MzozOFrOHRsYoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo0MzozOFrOHRsYoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNTA0MA==", "bodyText": "Yep, exactly. Dropped a TODO. I'm thinking we may want a context (like we have for non-parallel operations) for operations like this to explicitly say that one doesn't care about ordering (e.g. nlargest would default to any so df.nlargest(10) would just work as-is.\nPartitioningSession caused the rows to get perumuted.", "url": "https://github.com/apache/beam/pull/12812#discussion_r488315040", "createdAt": "2020-09-15T00:43:38Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/dataframe/frames.py", "diffHunk": "@@ -551,9 +559,13 @@ def merge(\n       return merged.reset_index(drop=True)\n \n   @frame_base.args_to_kwargs(pd.DataFrame)\n-  def nlargest(self, **kwargs):\n-    if 'keep' in kwargs and kwargs['keep'] != 'all':\n+  @frame_base.populate_defaults(pd.DataFrame)\n+  def nlargest(self, keep, **kwargs):\n+    if keep == 'any':\n+      keep = 'first'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NjExMQ=="}, "originalCommit": {"oid": "49f2ce027d6fead8bb9b44a898bb3d86da278ffc"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2653, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}