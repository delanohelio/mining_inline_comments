{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExOTQ0Njkw", "number": 13217, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjoxNDo0OFrOE6GQMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMDowNToyMFrOE6NI8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MzU1MzEzOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/internal/metrics/metric.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjoxNDo0OFrOH09IcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNDo0MFrOH1DJ-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4OTU4NQ==", "bodyText": "fyi - from now on, you can use type hints directly, not as comments (no need to change anything atm)", "url": "https://github.com/apache/beam/pull/13217#discussion_r525289585", "createdAt": "2020-11-17T16:14:48Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/internal/metrics/metric.py", "diffHunk": "@@ -136,3 +165,64 @@ def log_metrics(self, reset_after_logging=False):\n           self._last_logging_millis = current_millis\n       finally:\n         self._lock.release()\n+\n+\n+class ServiceCallMetric(object):\n+  \"\"\"Metric class which records Service API call metrics.\n+\n+  This class will capture a request count metric for the specified\n+  request_count_urn and base_labels.\n+\n+  When call() is invoked the status must be provided, which will\n+  be converted to a canonical GCP status code, if possible.\n+\n+  TODO(ajamato): Add Request latency metric.\n+  \"\"\"\n+  def __init__(self, request_count_urn, base_labels=None):\n+    # type: (str, Optional[Dict[str, str]]) -> None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4ODI4MA==", "bodyText": "ack", "url": "https://github.com/apache/beam/pull/13217#discussion_r525388280", "createdAt": "2020-11-17T18:24:40Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/internal/metrics/metric.py", "diffHunk": "@@ -136,3 +165,64 @@ def log_metrics(self, reset_after_logging=False):\n           self._last_logging_millis = current_millis\n       finally:\n         self._lock.release()\n+\n+\n+class ServiceCallMetric(object):\n+  \"\"\"Metric class which records Service API call metrics.\n+\n+  This class will capture a request count metric for the specified\n+  request_count_urn and base_labels.\n+\n+  When call() is invoked the status must be provided, which will\n+  be converted to a canonical GCP status code, if possible.\n+\n+  TODO(ajamato): Add Request latency metric.\n+  \"\"\"\n+  def __init__(self, request_count_urn, base_labels=None):\n+    # type: (str, Optional[Dict[str, str]]) -> None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4OTU4NQ=="}, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MzU5MzUwOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjoyMjo1OFrOH09hUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNDoyNlrOH1DJQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NTk1Mw==", "bodyText": "The method here would be a BatchWrite? Or a Streaming Insert maybe?", "url": "https://github.com/apache/beam/pull/13217#discussion_r525295953", "createdAt": "2020-11-17T16:22:58Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -566,10 +568,30 @@ def _insert_all_rows(\n             skipInvalidRows=skip_invalid_rows,\n             # TODO(silviuc): Should have an option for ignoreUnknownValues?\n             rows=rows))\n+\n+    resource = '//bigquery.googleapis.com/projects/%s/datasets/%s/tables/%s' % (\n+        project_id, dataset_id, table_id)\n+\n+    labels = {\n+        # TODO(ajamato): Add Ptransform label.\n+        monitoring_infos.SERVICE_LABEL: 'BigQuery',\n+        monitoring_infos.METHOD_LABEL: 'BigQueryBatchWrite',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4ODA5OA==", "bodyText": "Added a clarifying comment. I don't want this to be that specific. I.e. if new APIs are introduced, which do the same thing from a dataflow pipeline's perspective \"Write batches of elements to BigQuery\"", "url": "https://github.com/apache/beam/pull/13217#discussion_r525388098", "createdAt": "2020-11-17T18:24:26Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -566,10 +568,30 @@ def _insert_all_rows(\n             skipInvalidRows=skip_invalid_rows,\n             # TODO(silviuc): Should have an option for ignoreUnknownValues?\n             rows=rows))\n+\n+    resource = '//bigquery.googleapis.com/projects/%s/datasets/%s/tables/%s' % (\n+        project_id, dataset_id, table_id)\n+\n+    labels = {\n+        # TODO(ajamato): Add Ptransform label.\n+        monitoring_infos.SERVICE_LABEL: 'BigQuery',\n+        monitoring_infos.METHOD_LABEL: 'BigQueryBatchWrite',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NTk1Mw=="}, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MzU5NzMyOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjoyMzo0OVrOH09j1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNDozMVrOH1DJjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NjU5Ng==", "bodyText": "Maybe add the resource calculation to a helper method? So it can be reused later? (I imagine you'll add these metrics for other methods?)", "url": "https://github.com/apache/beam/pull/13217#discussion_r525296596", "createdAt": "2020-11-17T16:23:49Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -566,10 +568,30 @@ def _insert_all_rows(\n             skipInvalidRows=skip_invalid_rows,\n             # TODO(silviuc): Should have an option for ignoreUnknownValues?\n             rows=rows))\n+\n+    resource = '//bigquery.googleapis.com/projects/%s/datasets/%s/tables/%s' % (\n+        project_id, dataset_id, table_id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNDQ1Mg==", "bodyText": "or a constant IDK : )", "url": "https://github.com/apache/beam/pull/13217#discussion_r525324452", "createdAt": "2020-11-17T16:58:34Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -566,10 +568,30 @@ def _insert_all_rows(\n             skipInvalidRows=skip_invalid_rows,\n             # TODO(silviuc): Should have an option for ignoreUnknownValues?\n             rows=rows))\n+\n+    resource = '//bigquery.googleapis.com/projects/%s/datasets/%s/tables/%s' % (\n+        project_id, dataset_id, table_id)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NjU5Ng=="}, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4ODE3Mg==", "bodyText": "done", "url": "https://github.com/apache/beam/pull/13217#discussion_r525388172", "createdAt": "2020-11-17T18:24:31Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -566,10 +568,30 @@ def _insert_all_rows(\n             skipInvalidRows=skip_invalid_rows,\n             # TODO(silviuc): Should have an option for ignoreUnknownValues?\n             rows=rows))\n+\n+    resource = '//bigquery.googleapis.com/projects/%s/datasets/%s/tables/%s' % (\n+        project_id, dataset_id, table_id)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NjU5Ng=="}, "originalCommit": {"oid": "966597c8c050b67f9d3949bd8bdc1af34d71781b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDY4MTQ1OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/metrics/metricbase.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMDowNToyMFrOH1IPcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMjozNDo1NVrOH1ORQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ3MTYwMA==", "bodyText": "ah one more thing: You may need to sort the list here so that ordering on labels will be consistent?", "url": "https://github.com/apache/beam/pull/13217#discussion_r525471600", "createdAt": "2020-11-17T20:05:20Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -50,34 +52,56 @@ class MetricName(object):\n   allows grouping related metrics together and also prevents collisions\n   between multiple metrics of the same name.\n   \"\"\"\n-  def __init__(self, namespace, name):\n-    # type: (str, str) -> None\n+  def __init__(self, namespace, name, urn=None, labels=None):\n+    # type: (Optional[str], Optional[str], Optional[str], Optional[Dict[str, str]]) -> None\n \n     \"\"\"Initializes ``MetricName``.\n \n+    Note: namespace and name should be set for user metrics,\n+    urn and labels should be set for an arbitrary metric to package into a\n+    MonitoringInfo.\n+\n     Args:\n       namespace: A string with the namespace of a metric.\n       name: A string with the name of a metric.\n+      urn: URN to populate on a MonitoringInfo, when sending to RunnerHarness.\n+      labels: Labels to populate on a MonitoringInfo\n     \"\"\"\n-    if not namespace:\n-      raise ValueError('Metric namespace must be non-empty')\n-    if not name:\n-      raise ValueError('Metric name must be non-empty')\n+    if not urn:\n+      if not namespace:\n+        raise ValueError('Metric namespace must be non-empty')\n+      if not name:\n+        raise ValueError('Metric name must be non-empty')\n     self.namespace = namespace\n     self.name = name\n+    self.urn = urn\n+    self.labels = labels if labels else {}\n \n   def __eq__(self, other):\n-    return self.namespace == other.namespace and self.name == other.name\n+    return (\n+        self.namespace == other.namespace and self.name == other.name and\n+        self.urn == other.urn and self.labels == other.labels)\n \n   def __ne__(self, other):\n     # TODO(BEAM-5949): Needed for Python 2 compatibility.\n     return not self == other\n \n   def __str__(self):\n-    return 'MetricName(namespace={}, name={})'.format(self.namespace, self.name)\n+    return 'MetricName(namespace={}, name={}, urn={}, labels={})'.format(\n+        self.namespace, self.name, self.urn, self.labels)\n \n   def __hash__(self):\n-    return hash((self.namespace, self.name))\n+    return hash((self.namespace, self.name, self.urn) +\n+                tuple(self.labels.items()))\n+\n+  def fast_name(self):\n+    name = self.name or ''\n+    namespace = self.namespace or ''\n+    urn = self.urn or ''\n+    labels = ''\n+    if self.labels:\n+      labels = '_'.join(['%s=%s' % (k, v) for (k, v) in self.labels.items()])\n+    return '%d_%s%s%s%s' % (len(name), name, namespace, urn, labels)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d33248d41fc75229be9c9fb29fdcd767ae30403"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU3MDM3MQ==", "bodyText": "oh seems like the answer is no from 3.6: https://softwaremaniacs.org/blog/2020/02/05/dicts-ordered/\nSince we don't support 3.5 anymore, I think you can ignore this.", "url": "https://github.com/apache/beam/pull/13217#discussion_r525570371", "createdAt": "2020-11-17T22:34:55Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -50,34 +52,56 @@ class MetricName(object):\n   allows grouping related metrics together and also prevents collisions\n   between multiple metrics of the same name.\n   \"\"\"\n-  def __init__(self, namespace, name):\n-    # type: (str, str) -> None\n+  def __init__(self, namespace, name, urn=None, labels=None):\n+    # type: (Optional[str], Optional[str], Optional[str], Optional[Dict[str, str]]) -> None\n \n     \"\"\"Initializes ``MetricName``.\n \n+    Note: namespace and name should be set for user metrics,\n+    urn and labels should be set for an arbitrary metric to package into a\n+    MonitoringInfo.\n+\n     Args:\n       namespace: A string with the namespace of a metric.\n       name: A string with the name of a metric.\n+      urn: URN to populate on a MonitoringInfo, when sending to RunnerHarness.\n+      labels: Labels to populate on a MonitoringInfo\n     \"\"\"\n-    if not namespace:\n-      raise ValueError('Metric namespace must be non-empty')\n-    if not name:\n-      raise ValueError('Metric name must be non-empty')\n+    if not urn:\n+      if not namespace:\n+        raise ValueError('Metric namespace must be non-empty')\n+      if not name:\n+        raise ValueError('Metric name must be non-empty')\n     self.namespace = namespace\n     self.name = name\n+    self.urn = urn\n+    self.labels = labels if labels else {}\n \n   def __eq__(self, other):\n-    return self.namespace == other.namespace and self.name == other.name\n+    return (\n+        self.namespace == other.namespace and self.name == other.name and\n+        self.urn == other.urn and self.labels == other.labels)\n \n   def __ne__(self, other):\n     # TODO(BEAM-5949): Needed for Python 2 compatibility.\n     return not self == other\n \n   def __str__(self):\n-    return 'MetricName(namespace={}, name={})'.format(self.namespace, self.name)\n+    return 'MetricName(namespace={}, name={}, urn={}, labels={})'.format(\n+        self.namespace, self.name, self.urn, self.labels)\n \n   def __hash__(self):\n-    return hash((self.namespace, self.name))\n+    return hash((self.namespace, self.name, self.urn) +\n+                tuple(self.labels.items()))\n+\n+  def fast_name(self):\n+    name = self.name or ''\n+    namespace = self.namespace or ''\n+    urn = self.urn or ''\n+    labels = ''\n+    if self.labels:\n+      labels = '_'.join(['%s=%s' % (k, v) for (k, v) in self.labels.items()])\n+    return '%d_%s%s%s%s' % (len(name), name, namespace, urn, labels)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ3MTYwMA=="}, "originalCommit": {"oid": "0d33248d41fc75229be9c9fb29fdcd767ae30403"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2879, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}