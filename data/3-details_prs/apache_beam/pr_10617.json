{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzOTA0NTE1", "number": 10617, "title": "[BEAM-8889] Cleanup Beam to GCS connector interfacing code so it uses higher level objects such as GoogleCloudStorage.", "bodyText": "When GCS connector is used, allow for use of grpc when GCS client allows it.\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-17T00:06:54Z", "url": "https://github.com/apache/beam/pull/10617", "merged": true, "mergeCommit": {"oid": "06831353fea86ce605770beba9e147b345fb13ea"}, "closed": true, "closedAt": "2020-01-31T18:04:45Z", "author": {"login": "vnorigoog"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7BmSPgH2gAyMzYzOTA0NTE1OjUwMjM0OWQ0YTA0MWJhYmNiYmM3ODllODZlZmEzZjU2ODg4NmQyZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_iEpEAH2gAyMzYzOTA0NTE1Ojk1NTYwZWExMGRkYzE3ZWExNTkwYmY3ZjNiNTM1ZDU5NmM1MTk0ZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "502349d4a041babcbbc789e86efa3f568886d2e1", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/502349d4a041babcbbc789e86efa3f568886d2e1", "committedDate": "2020-01-16T22:08:11Z", "message": "adding gRPC to GCS connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8e8d5d99207e213a68ae55e91aba9512cb6366d", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/d8e8d5d99207e213a68ae55e91aba9512cb6366d", "committedDate": "2020-01-17T20:19:07Z", "message": "adding gRPC to GCS connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTAwMzky", "url": "https://github.com/apache/beam/pull/10617#pullrequestreview-346100392", "createdAt": "2020-01-21T18:35:39Z", "commit": {"oid": "d8e8d5d99207e213a68ae55e91aba9512cb6366d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxODozNTozOVrOFgEf9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxODozNTozOVrOFgEf9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE3MjQ2OA==", "bodyText": "I'm a bit hesitant to have this but i'm okay if we have to. @chamikaramj Do you think this is still necessary? If this is required, we might consider to have new API in getCloudStorage().create to accept uploadBufferSizeBytes to avoid code for each type of channels.", "url": "https://github.com/apache/beam/pull/10617#discussion_r369172468", "createdAt": "2020-01-21T18:35:39Z", "author": {"login": "veblush"}, "path": "sdks/java/extensions/google-cloud-platform-core/src/main/java/org/apache/beam/sdk/extensions/gcp/util/GcsUtil.java", "diffHunk": "@@ -427,22 +440,14 @@ public WritableByteChannel create(GcsPath path, String type) throws IOException\n    */\n   public WritableByteChannel create(GcsPath path, String type, Integer uploadBufferSizeBytes)\n       throws IOException {\n-    GoogleCloudStorageWriteChannel channel =\n-        new GoogleCloudStorageWriteChannel(\n-            executorService,\n-            storageClient,\n-            new ClientRequestHelper<>(),\n-            path.getBucket(),\n-            path.getObject(),\n-            type,\n-            /* kmsKeyName= */ null,\n-            AsyncWriteChannelOptions.newBuilder().build(),\n-            new ObjectWriteConditions(),\n-            Collections.emptyMap());\n+    WritableByteChannel channel = getCloudStorage().create(new StorageResourceId(path.getBucket()));\n     if (uploadBufferSizeBytes != null) {\n-      channel.setUploadBufferSize(uploadBufferSizeBytes);\n+      if (channel instanceof GoogleCloudStorageWriteChannel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e8d5d99207e213a68ae55e91aba9512cb6366d"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ba5215094d98e8a185284c2faa879ba8050b7e", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/21ba5215094d98e8a185284c2faa879ba8050b7e", "committedDate": "2020-01-24T00:29:27Z", "message": "some tests are failing.\ndebugging."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MjE2NzU0", "url": "https://github.com/apache/beam/pull/10617#pullrequestreview-348216754", "createdAt": "2020-01-24T20:50:48Z", "commit": {"oid": "21ba5215094d98e8a185284c2faa879ba8050b7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDo1MDo0OFrOFhqDOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMDo1MDo0OFrOFhqDOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzNjI4MQ==", "bodyText": "Can we combine this with code below? Does it need to call setGrpcEnabled, too?", "url": "https://github.com/apache/beam/pull/10617#discussion_r370836281", "createdAt": "2020-01-24T20:50:48Z", "author": {"login": "veblush"}, "path": "sdks/java/extensions/google-cloud-platform-core/src/main/java/org/apache/beam/sdk/extensions/gcp/util/GcsUtil.java", "diffHunk": "@@ -427,23 +447,21 @@ public WritableByteChannel create(GcsPath path, String type) throws IOException\n    */\n   public WritableByteChannel create(GcsPath path, String type, Integer uploadBufferSizeBytes)\n       throws IOException {\n-    GoogleCloudStorageWriteChannel channel =\n-        new GoogleCloudStorageWriteChannel(\n-            executorService,\n-            storageClient,\n-            new ClientRequestHelper<>(),\n-            path.getBucket(),\n-            path.getObject(),\n-            type,\n-            /* kmsKeyName= */ null,\n-            AsyncWriteChannelOptions.newBuilder().build(),\n-            new ObjectWriteConditions(),\n-            Collections.emptyMap());\n-    if (uploadBufferSizeBytes != null) {\n-      channel.setUploadBufferSize(uploadBufferSizeBytes);\n+    if (uploadBufferSizeBytes == null) {\n+      return googleCloudStorage.create(new StorageResourceId(path.getBucket()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ba5215094d98e8a185284c2faa879ba8050b7e"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7ac6e53a24f9f07fc2246219fb725515b85746", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/dc7ac6e53a24f9f07fc2246219fb725515b85746", "committedDate": "2020-01-24T22:04:23Z", "message": "This now includes changes to make Beam GCS connector code ready to use\ngRPC when gcsio is released with gRPC support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c05dda5d970fc3886a0e50f914dc3a7b8e8c8304", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/c05dda5d970fc3886a0e50f914dc3a7b8e8c8304", "committedDate": "2020-01-24T22:08:21Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7430318d08832973e129dfd862d72b7f4e5a99a7", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/7430318d08832973e129dfd862d72b7f4e5a99a7", "committedDate": "2020-01-24T22:10:49Z", "message": "This now includes changes to make Beam GCS connector code ready to use gRPC when gcsio is released with gRPC support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bafd3b986ca63ed7cf7a16dcc0dbbfe2ce89a74d", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/bafd3b986ca63ed7cf7a16dcc0dbbfe2ce89a74d", "committedDate": "2020-01-24T22:11:26Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Mjg0MjIy", "url": "https://github.com/apache/beam/pull/10617#pullrequestreview-348284222", "createdAt": "2020-01-24T23:51:45Z", "commit": {"oid": "bafd3b986ca63ed7cf7a16dcc0dbbfe2ce89a74d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMzo1MTo0NVrOFhtUiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMzo1MTo0NVrOFhtUiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4OTg2Nw==", "bodyText": "Seems like this changes contentType from whatever provided above to always null. We should check the code base to see if this may introduce any behavioral changes.", "url": "https://github.com/apache/beam/pull/10617#discussion_r370889867", "createdAt": "2020-01-24T23:51:45Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/extensions/google-cloud-platform-core/src/main/java/org/apache/beam/sdk/extensions/gcp/util/GcsUtil.java", "diffHunk": "@@ -427,23 +449,29 @@ public WritableByteChannel create(GcsPath path, String type) throws IOException\n    */\n   public WritableByteChannel create(GcsPath path, String type, Integer uploadBufferSizeBytes)\n       throws IOException {\n-    GoogleCloudStorageWriteChannel channel =\n-        new GoogleCloudStorageWriteChannel(\n-            executorService,\n-            storageClient,\n-            new ClientRequestHelper<>(),\n-            path.getBucket(),\n-            path.getObject(),\n-            type,\n-            /* kmsKeyName= */ null,\n-            AsyncWriteChannelOptions.newBuilder().build(),\n-            new ObjectWriteConditions(),\n-            Collections.emptyMap());\n-    if (uploadBufferSizeBytes != null) {\n-      channel.setUploadBufferSize(uploadBufferSizeBytes);\n+    if (uploadBufferSizeBytes == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bafd3b986ca63ed7cf7a16dcc0dbbfe2ce89a74d"}, "originalPosition": 141}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fad3a23bd840b3b0a04ec5eacee789e3a142a22", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/1fad3a23bd840b3b0a04ec5eacee789e3a142a22", "committedDate": "2020-01-28T19:56:57Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "075bf1c30f6560f88beaae6f60c53e6a4e09ebf7", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/075bf1c30f6560f88beaae6f60c53e6a4e09ebf7", "committedDate": "2020-01-28T19:58:05Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzMxNDI5", "url": "https://github.com/apache/beam/pull/10617#pullrequestreview-349731429", "createdAt": "2020-01-28T21:54:04Z", "commit": {"oid": "075bf1c30f6560f88beaae6f60c53e6a4e09ebf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "797bdc13621dabd81554af47a02671131cdbd463", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/797bdc13621dabd81554af47a02671131cdbd463", "committedDate": "2020-01-30T22:13:01Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95560ea10ddc17ea1590bf7f3b535d596c5194e3", "author": {"user": {"login": "vnorigoog", "name": "Vasu Nori"}}, "url": "https://github.com/apache/beam/commit/95560ea10ddc17ea1590bf7f3b535d596c5194e3", "committedDate": "2020-01-30T22:14:00Z", "message": "Merge branch 'grpc-changes' of https://github.com/vnorigoog/beam into grpc-changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3493, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}