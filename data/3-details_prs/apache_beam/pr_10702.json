{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTQ5NDc2", "number": 10702, "title": "[BEAM-5605] Migrate splittable DoFn methods to use \"new\" DoFn style argument providing.", "bodyText": "Defined a new @Restriction parameter type to pass in the restriction.\nUpdated GetSize/GetInitialRestriction/SplitRestriction/NewTracker to take these new DoFn style parameters.\nUpdated lots of documentation and existing implementations to use the new DoFn argument passing.\nFixed ByteBuddyDoFnInvokerFactory to support return values that aren't references.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-28T17:54:52Z", "url": "https://github.com/apache/beam/pull/10702", "merged": true, "mergeCommit": {"oid": "c0bec8761b4ddd6ab218afae2c5aadbaffd5473d"}, "closed": true, "closedAt": "2020-02-05T18:23:06Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-5O6vgH2gAyMzY4MTQ5NDc2OjNiODk0MGYyMzljYmJlZDAxOTU2NGQzYTMzZjA4M2I5ZGYyYzAyMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBI_4EgFqTM1MzMzNzUyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b8940f239cbbed019564d3a33f083b9df2c0229", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/3b8940f239cbbed019564d3a33f083b9df2c0229", "committedDate": "2020-01-28T22:39:07Z", "message": "[BEAM-5605] Migrate splittable DoFn methods to use \"new\" DoFn style argument providing.\n\nDefined a new @Restriction parameter type to pass in the restriction.\nUpdated GetSize/GetInitialRestriction/SplitRestriction/NewTracker to take these new DoFn style parameters.\nUpdated lots of documentation and existing implementations to use the new DoFn argument passing.\nFixed ByteBuddyDoFnInvokerFactory to support return values that aren't references."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/565da3cb324d58e618c3e5851027f6dca072f8af", "committedDate": "2020-01-28T22:39:13Z", "message": "fixup! Fix ValidatesRunner splittable DoFn tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "513aa7d0ab3fe8202c5a699062e70c36d70d471d", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/513aa7d0ab3fe8202c5a699062e70c36d70d471d", "committedDate": "2020-01-28T21:35:02Z", "message": "fixup! Fix ValidatesRunner splittable DoFn tests."}, "afterCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/565da3cb324d58e618c3e5851027f6dca072f8af", "committedDate": "2020-01-28T22:39:13Z", "message": "fixup! Fix ValidatesRunner splittable DoFn tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzkzMTg1", "url": "https://github.com/apache/beam/pull/10702#pullrequestreview-349793185", "createdAt": "2020-01-29T00:16:01Z", "commit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMDoxNjowMVrOFi5Beg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMTowMDo1N1rOFi5uMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMDE3MA==", "bodyText": "What happens if one chooses not to implement these? Might be useful to describe that here to encourage users to do it.", "url": "https://github.com/apache/beam/pull/10702#discussion_r372130170", "createdAt": "2020-01-29T00:16:01Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNjA3Mg==", "bodyText": "Is this similar to the GetSize requirement in that one should do one or the other? Or is it required that the user does exactly one of them? Maybe this is just because I'm unfamiliar with SDF, but I think these either/or requirements could be clearer.", "url": "https://github.com/apache/beam/pull/10702#discussion_r372136072", "createdAt": "2020-01-29T00:39:09Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzNzE5Mg==", "bodyText": "nit: maybe this should be first and should read The type of restrictions, {@code R}, used in all restriction methods must be the same.\nThen you can reference R elsewhere without having to define it again.\nUp to you, just an idea I had that may increase clarity", "url": "https://github.com/apache/beam/pull/10702#discussion_r372137192", "createdAt": "2020-01-29T00:43:45Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.\n    *   <li>It <i>may</i> define a {@link GetRestrictionCoder} method.\n    *   <li>The type of restrictions used by all of these methods must be the same.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MDgxMw==", "bodyText": "What does it mean that schema element parameters aren't supported - that you can't use FieldAccess? Or that we won't automatically convert types that have equivalent schemas? both (seems likely)?", "url": "https://github.com/apache/beam/pull/10702#discussion_r372140813", "createdAt": "2020-01-29T00:57:54Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -758,11 +804,19 @@ public Duration getAllowedTimestampSkew() {\n    * Annotation for the method that maps an element to an initial restriction for a <a\n    * href=\"https://s.apache.org/splittable-do-fn\">splittable</a> {@link DoFn}.\n    *\n-   * <p>Signature: {@code RestrictionT getInitialRestriction(InputT element, <optional arguments>);}\n+   * <p>Signature: {@code RestrictionT getInitialRestriction(<arguments>);}\n    *\n-   * <p>The optional arguments are allowed to be:\n+   * <p>This method must satisfy the following constraints:\n    *\n    * <ul>\n+   *   <li>The return type {@code RestrictionT} defines the restriction type used within this\n+   *       splittable DoFn. All other methods that use a {@link Restriction @Restriction} parameter\n+   *       must use the same type that is used here. It is suggested to use as narrow of a return\n+   *       type definition as possible (for example prefer to use a square type over a shape type as\n+   *       a square is a type of a shape).\n+   *   <li>If one of its arguments is tagged with the {@link Element} annotation, then it will be\n+   *       passed the current element being processed; the argument must be of type {@code InputT}.\n+   *       Note that schema element parameters are currently unsupported.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MTYxNw==", "bodyText": "Would be helpful to add an \"If this DoFn is splittable,\" here just to be very clear.", "url": "https://github.com/apache/beam/pull/10702#discussion_r372141617", "createdAt": "2020-01-29T01:00:57Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -614,45 +612,93 @@ public Duration getAllowedTimestampSkew() {\n    * <p>See <a href=\"https://s.apache.org/splittable-do-fn\">the proposal</a> for an overview of the\n    * involved concepts (<i>splittable DoFn</i>, <i>restriction</i>, <i>restriction tracker</i>).\n    *\n-   * <p>If a {@link DoFn} is splittable, the following constraints must be respected:\n+   * <p>A splittable {@link DoFn} must obey the following constraints:\n    *\n    * <ul>\n    *   <li>It <i>must</i> define a {@link GetInitialRestriction} method.\n-   *   <li>It <i>may</i> define a {@link GetSize} method.\n-   *   <li>It <i>may</i> define a {@link SplitRestriction} method.\n+   *   <li>It <i>should</i> define a {@link GetSize} method or ensure that the {@link\n+   *       RestrictionTracker} implements {@link Sizes.HasSize}.\n+   *   <li>It <i>should</i> define a {@link SplitRestriction} method.\n    *   <li>It <i>may</i> define a {@link NewTracker} method returning a subtype of {@code\n    *       RestrictionTracker<R>} where {@code R} is the restriction type returned by {@link\n    *       GetInitialRestriction}. This method is optional in case the restriction type returned by\n    *       {@link GetInitialRestriction} implements {@link HasDefaultTracker}.\n    *   <li>It <i>may</i> define a {@link GetRestrictionCoder} method.\n    *   <li>The type of restrictions used by all of these methods must be the same.\n-   *   <li>Its {@link ProcessElement} method <i>may</i> return a {@link ProcessContinuation} to\n-   *       indicate whether there is more work to be done for the current element.\n-   *   <li>Its {@link ProcessElement} method <i>must not</i> use any extra context parameters, such\n-   *       as {@link BoundedWindow}.\n    *   <li>The {@link DoFn} itself <i>may</i> be annotated with {@link BoundedPerElement} or {@link\n    *       UnboundedPerElement}, but not both at the same time. If it's not annotated with either of\n    *       these, it's assumed to be {@link BoundedPerElement} if its {@link ProcessElement} method\n    *       returns {@code void} and {@link UnboundedPerElement} if it returns a {@link\n    *       ProcessContinuation}.\n+   *   <li>Timers and state must not be used.\n    * </ul>\n    *\n    * <p>A non-splittable {@link DoFn} <i>must not</i> define any of these methods.\n+   *\n+   * <p>This method must satisfy the following constraints:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b638dda24b1a8a6831562dec94cd4866efd544", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/92b638dda24b1a8a6831562dec94cd4866efd544", "committedDate": "2020-01-29T17:16:05Z", "message": "fixup! Address javadoc comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODExNzMy", "url": "https://github.com/apache/beam/pull/10702#pullrequestreview-349811732", "createdAt": "2020-01-29T01:17:42Z", "commit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMToxNzo0M1rOFi59_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMToxNzo0M1rOFi59_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0NTY2MQ==", "bodyText": "Does creating tracker require passing in element?", "url": "https://github.com/apache/beam/pull/10702#discussion_r372145661", "createdAt": "2020-01-29T01:17:43Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/DoFn.java", "diffHunk": "@@ -871,13 +960,20 @@ public Duration getAllowedTimestampSkew() {\n    * Annotation for the method that creates a new {@link RestrictionTracker} for the restriction of\n    * a <a href=\"https://s.apache.org/splittable-do-fn\">splittable</a> {@link DoFn}.\n    *\n-   * <p>Signature: {@code MyRestrictionTracker newTracker(RestrictionT restriction, <optional\n-   * arguments>);} where {@code MyRestrictionTracker} must be a subtype of {@code\n-   * RestrictionTracker<RestrictionT>}.\n+   * <p>Signature: {@code MyRestrictionTracker newTracker(<optional arguments>);}\n    *\n-   * <p>The optional arguments are allowed to be:\n+   * <p>This method must satisfy the following constraints:\n    *\n    * <ul>\n+   *   <li>The return type must be a subtype of {@code RestrictionTracker<RestrictionT, PositionT>}.\n+   *       It is suggested to use as narrow of a return type definition as possible (for example\n+   *       prefer to use a square type over a shape type as a square is a type of a shape).\n+   *   <li>If one of its arguments is tagged with the {@link Element} annotation, then it will be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565da3cb324d58e618c3e5851027f6dca072f8af"}, "originalPosition": 256}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzM3NTIw", "url": "https://github.com/apache/beam/pull/10702#pullrequestreview-353337520", "createdAt": "2020-02-04T22:09:01Z", "commit": {"oid": "92b638dda24b1a8a6831562dec94cd4866efd544"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3624, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}