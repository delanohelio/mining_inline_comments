{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODY3MzQ3", "number": 12984, "title": "[BEAM-10994] Add ability for HotKeyLogger to log a key", "bodyText": "Adds interface for HotKeyLogger to take an object key.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-01T00:09:14Z", "url": "https://github.com/apache/beam/pull/12984", "merged": true, "mergeCommit": {"oid": "7d150b0c963fd1f98d90507358d15defff43bb0a"}, "closed": true, "closedAt": "2020-10-13T22:48:21Z", "author": {"login": "rohdesamuel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQmYx-gFqTUwNTA3OTA2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSOUqrgFqTUwNzc4ODg1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MDc5MDYy", "url": "https://github.com/apache/beam/pull/12984#pullrequestreview-505079062", "createdAt": "2020-10-08T18:58:41Z", "commit": {"oid": "e402e108577103b77febe3c5c7edccddfafdc6c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxODo1ODo0MVrOHesV4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxOTowMzowM1rOHesfWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NTgyNA==", "bodyText": "you should rely on slf4j for log formatting with parameters as we won't pay the cost of forming the string if logging is disabled. e.g.:\nLOG.warn(\"my message with param 1 {}, param 2 {}\", param1, param2);", "url": "https://github.com/apache/beam/pull/12984#discussion_r501945824", "createdAt": "2020-10-08T18:58:41Z", "author": {"login": "lukecwik"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/HotKeyLogger.java", "diffHunk": "@@ -67,11 +72,19 @@ protected boolean isThrottled() {\n     return false;\n   }\n \n-  protected String getHotKeyMessage(String userStepName, String hotKeyAge) {\n+  protected String getHotKeyMessage(String userStepName, String hotKeyAge, Object hotkey) {\n+    if (hotkey == null) {\n+      return MessageFormat.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e402e108577103b77febe3c5c7edccddfafdc6c8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0ODI1MA==", "bodyText": "You can use ExpectedLogs as a test rule to capture whether output was produced or not instead of abstracting out a getHotKeyMessage. See \n  \n    \n      beam/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/SerializableCoderTest.java\n    \n    \n         Line 259\n      in\n      cfca7f1\n    \n    \n    \n    \n\n        \n          \n           public void coderWarnsForInterface() throws Exception { \n        \n    \n  \n\n for an example.", "url": "https://github.com/apache/beam/pull/12984#discussion_r501948250", "createdAt": "2020-10-08T19:03:03Z", "author": {"login": "lukecwik"}, "path": "runners/google-cloud-dataflow-java/worker/src/test/java/org/apache/beam/runners/dataflow/worker/HotKeyLoggerTest.java", "diffHunk": "@@ -50,11 +50,11 @@ public void SetUp() {\n   }\n \n   @Test\n-  public void correctHotKeyMessage() {\n+  public void correctHotKeyMessageWithoutKey() {\n     HotKeyLogger hotKeyLogger = new HotKeyLogger(clock);\n \n     assertFalse(hotKeyLogger.isThrottled());\n-    String m = hotKeyLogger.getHotKeyMessage(\"TEST_STEP_ID\", \"1s\");\n+    String m = hotKeyLogger.getHotKeyMessage(\"TEST_STEP_ID\", \"1s\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e402e108577103b77febe3c5c7edccddfafdc6c8"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "301a3d1087e377bbc53f807f27ad76ec9516c443", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/301a3d1087e377bbc53f807f27ad76ec9516c443", "committedDate": "2020-10-12T21:23:50Z", "message": "remove GetHotKeyMesage"}, "afterCommit": {"oid": "ac736a9c566fc0a2306c45c844eda5c51f63cfea", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/ac736a9c566fc0a2306c45c844eda5c51f63cfea", "committedDate": "2020-10-12T21:25:27Z", "message": "remove GetHotKeyMesage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjU1MzI0", "url": "https://github.com/apache/beam/pull/12984#pullrequestreview-507655324", "createdAt": "2020-10-13T17:04:32Z", "commit": {"oid": "518eeadd04c30be05d8dd89693a6d8b8bab9e9e3"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzowNDozMlrOHgw-4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzowNzoxNFrOHgxEzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExOTAxMQ==", "bodyText": "Note that null is a valid key type and using null to differentiate between log without key and log with key will miss this usecase which is why I proposed the two suggestions below:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                logHotKeyDetection(userStepName, hotKeyAge, null);\n          \n          \n            \n                if (isThrottled()) {\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                LOG.warn(\n          \n          \n            \n                    \"A hot key was detected in step '{}' with age of '{}'. This is \"\n          \n          \n            \n                        + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n          \n          \n            \n                        + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n          \n          \n            \n                    userStepName,\n          \n          \n            \n                    TimeUtil.toCloudDuration(hotKeyAge));", "url": "https://github.com/apache/beam/pull/12984#discussion_r504119011", "createdAt": "2020-10-13T17:04:32Z", "author": {"login": "lukecwik"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/HotKeyLogger.java", "diffHunk": "@@ -47,10 +46,31 @@\n \n   /** Logs a detection of the hot key every 5 minutes. */\n   public void logHotKeyDetection(String userStepName, Duration hotKeyAge) {\n+    logHotKeyDetection(userStepName, hotKeyAge, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518eeadd04c30be05d8dd89693a6d8b8bab9e9e3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExOTI5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (hotkey == null) {\n          \n          \n            \n                  LOG.warn(\n          \n          \n            \n                      \"A hot key was detected in step '{}' with age of '{}'. This is \"\n          \n          \n            \n                          + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n          \n          \n            \n                          + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n          \n          \n            \n                      userStepName,\n          \n          \n            \n                      TimeUtil.toCloudDuration(hotKeyAge));\n          \n          \n            \n                } else {\n          \n          \n            \n                  LOG.warn(\n          \n          \n            \n                      \"A hot key '{}' was detected in step '{}' with age of '{}'. This is \"\n          \n          \n            \n                          + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n          \n          \n            \n                          + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n          \n          \n            \n                      hotkey,\n          \n          \n            \n                      userStepName,\n          \n          \n            \n                      TimeUtil.toCloudDuration(hotKeyAge));\n          \n          \n            \n                }\n          \n          \n            \n                LOG.warn(\n          \n          \n            \n                    \"A hot key '{}' was detected in step '{}' with age of '{}'. This is \"\n          \n          \n            \n                        + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n          \n          \n            \n                        + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n          \n          \n            \n                    hotkey,\n          \n          \n            \n                    userStepName,\n          \n          \n            \n                    TimeUtil.toCloudDuration(hotKeyAge));\n          \n          \n            \n                }", "url": "https://github.com/apache/beam/pull/12984#discussion_r504119298", "createdAt": "2020-10-13T17:05:01Z", "author": {"login": "lukecwik"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/HotKeyLogger.java", "diffHunk": "@@ -47,10 +46,31 @@\n \n   /** Logs a detection of the hot key every 5 minutes. */\n   public void logHotKeyDetection(String userStepName, Duration hotKeyAge) {\n+    logHotKeyDetection(userStepName, hotKeyAge, null);\n+  }\n+\n+  /** Logs a detection of the hot key every 5 minutes with the given key. */\n+  public void logHotKeyDetection(String userStepName, Duration hotKeyAge, Object hotkey) {\n     if (isThrottled()) {\n       return;\n     }\n-    LOG.warn(getHotKeyMessage(userStepName, TimeUtil.toCloudDuration(hotKeyAge)));\n+\n+    if (hotkey == null) {\n+      LOG.warn(\n+          \"A hot key was detected in step '{}' with age of '{}'. This is \"\n+              + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n+              + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n+          userStepName,\n+          TimeUtil.toCloudDuration(hotKeyAge));\n+    } else {\n+      LOG.warn(\n+          \"A hot key '{}' was detected in step '{}' with age of '{}'. This is \"\n+              + \"a symptom of key distribution being skewed. To fix, please inspect your data and \"\n+              + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n+          hotkey,\n+          userStepName,\n+          TimeUtil.toCloudDuration(hotKeyAge));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518eeadd04c30be05d8dd89693a6d8b8bab9e9e3"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyMDUyNg==", "bodyText": "might as well cover the null as an object case to ensure we don't regress.", "url": "https://github.com/apache/beam/pull/12984#discussion_r504120526", "createdAt": "2020-10-13T17:07:14Z", "author": {"login": "lukecwik"}, "path": "runners/google-cloud-dataflow-java/worker/src/test/java/org/apache/beam/runners/dataflow/worker/HotKeyLoggerTest.java", "diffHunk": "@@ -50,18 +45,29 @@ public void SetUp() {\n   }\n \n   @Test\n-  public void correctHotKeyMessage() {\n+  public void correctHotKeyMessageWithoutKey() {\n     HotKeyLogger hotKeyLogger = new HotKeyLogger(clock);\n \n-    assertFalse(hotKeyLogger.isThrottled());\n-    String m = hotKeyLogger.getHotKeyMessage(\"TEST_STEP_ID\", \"1s\");\n+    hotKeyLogger.logHotKeyDetection(\"TEST_STEP_ID\", Duration.standardSeconds(1));\n     assertTrue(hotKeyLogger.isThrottled());\n \n-    assertEquals(\n+    expectedLogs.verifyWarn(\n         \"A hot key was detected in step 'TEST_STEP_ID' with age of '1s'. This is a \"\n             + \"symptom of key distribution being skewed. To fix, please inspect your data and \"\n-            + \"pipeline to ensure that elements are evenly distributed across your key space.\",\n-        m);\n+            + \"pipeline to ensure that elements are evenly distributed across your key space.\");\n+  }\n+\n+  @Test\n+  public void correctHotKeyMessageWithKey() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518eeadd04c30be05d8dd89693a6d8b8bab9e9e3"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7e2d31bb1e4dcb6f259d48428271c57404d3a30", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/e7e2d31bb1e4dcb6f259d48428271c57404d3a30", "committedDate": "2020-10-13T19:37:20Z", "message": "Add ability for HotKeyLogger to log a key."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c19fe09f96ef46d8a0090e70db28dd2efef83e8", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/2c19fe09f96ef46d8a0090e70db28dd2efef83e8", "committedDate": "2020-10-13T19:25:43Z", "message": "remove spaces to appease spotless"}, "afterCommit": {"oid": "e7e2d31bb1e4dcb6f259d48428271c57404d3a30", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/e7e2d31bb1e4dcb6f259d48428271c57404d3a30", "committedDate": "2020-10-13T19:37:20Z", "message": "Add ability for HotKeyLogger to log a key."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Nzg4ODU0", "url": "https://github.com/apache/beam/pull/12984#pullrequestreview-507788854", "createdAt": "2020-10-13T20:09:07Z", "commit": {"oid": "e7e2d31bb1e4dcb6f259d48428271c57404d3a30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2225, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}