{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MDYzOTEy", "number": 13245, "title": "[BEAM-11075] Go SDK's synthetic source supports hot keys generation", "bodyText": "Add support for HotKeys and HotKeysFraction when generating Synthetic Source in Beam GO SDK", "createdAt": "2020-11-02T13:35:00Z", "url": "https://github.com/apache/beam/pull/13245", "merged": true, "mergeCommit": {"oid": "0ab52bb2feba6a4bdae4ec77e14a3a213eceeaa5"}, "closed": true, "closedAt": "2020-11-09T11:48:00Z", "author": {"login": "tszerszen"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYnH0FgFqTUyMTc3NDM3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdaAGMhAFqTUyNTU2Mzg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzc0Mzc0", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-521774374", "createdAt": "2020-11-02T16:10:52Z", "commit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjoxMDo1MlrOHsLJKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjoyNTowM1rOHsLvtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4MTk2Mw==", "bodyText": "Why \"2\"?", "url": "https://github.com/apache/beam/pull/13245#discussion_r516081963", "createdAt": "2020-11-02T16:10:52Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -165,10 +175,12 @@ type SourceConfigBuilder struct {\n func DefaultSourceConfig() *SourceConfigBuilder {\n \treturn &SourceConfigBuilder{\n \t\tcfg: SourceConfig{\n-\t\t\tNumElements:   1, // 0 is invalid (drops elements).\n-\t\t\tInitialSplits: 1, // 0 is invalid (drops elements).\n-\t\t\tKeySize:       8, // 0 is invalid (drops elements).\n-\t\t\tValueSize:     8, // 0 is invalid (drops elements).\n+\t\t\tNumElements:    1, // 0 is invalid (drops elements).\n+\t\t\tInitialSplits:  1, // 0 is invalid (drops elements).\n+\t\t\tKeySize:        8, // 0 is invalid (drops elements).\n+\t\t\tValueSize:      8, // 0 is invalid (drops elements).\n+\t\t\tHotKeys:        2, // 0 is invalid (drops elements).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDM5NQ==", "bodyText": "Python tests use num_hot_keys, let's do the same in Go. hot_key_fraction is correct.", "url": "https://github.com/apache/beam/pull/13245#discussion_r516084395", "createdAt": "2020-11-02T16:14:21Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -262,8 +281,10 @@ func (b *SourceConfigBuilder) BuildFromJSON(jsonData []byte) SourceConfig {\n // synthetic source. It should be created via a SourceConfigBuilder, not by\n // directly initializing it (the fields are public to allow encoding).\n type SourceConfig struct {\n-\tNumElements   int `json:\"num_records\"`\n-\tInitialSplits int `json:\"initial_splits\"`\n-\tKeySize       int `json:\"key_size\"`\n-\tValueSize     int `json:\"value_size\"`\n+\tNumElements    int `json:\"num_records\"`\n+\tInitialSplits  int `json:\"initial_splits\"`\n+\tHotKeys        int `json:\"hot_keys\"`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NTkyMg==", "bodyText": "By default, there should be no hot keys at all (every key should be unique).", "url": "https://github.com/apache/beam/pull/13245#discussion_r516085922", "createdAt": "2020-11-02T16:16:32Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -165,10 +175,12 @@ type SourceConfigBuilder struct {\n func DefaultSourceConfig() *SourceConfigBuilder {\n \treturn &SourceConfigBuilder{\n \t\tcfg: SourceConfig{\n-\t\t\tNumElements:   1, // 0 is invalid (drops elements).\n-\t\t\tInitialSplits: 1, // 0 is invalid (drops elements).\n-\t\t\tKeySize:       8, // 0 is invalid (drops elements).\n-\t\t\tValueSize:     8, // 0 is invalid (drops elements).\n+\t\t\tNumElements:    1, // 0 is invalid (drops elements).\n+\t\t\tInitialSplits:  1, // 0 is invalid (drops elements).\n+\t\t\tKeySize:        8, // 0 is invalid (drops elements).\n+\t\t\tValueSize:      8, // 0 is invalid (drops elements).\n+\t\t\tHotKeys:        2, // 0 is invalid (drops elements).", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4MTk2Mw=="}, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4ODQ1Mw==", "bodyText": "HotKeyFraction is supposed to be a floating point number from 0 to 1, right?", "url": "https://github.com/apache/beam/pull/13245#discussion_r516088453", "createdAt": "2020-11-02T16:20:16Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -235,6 +247,12 @@ func (b *SourceConfigBuilder) Build() SourceConfig {\n \tif b.cfg.ValueSize <= 0 {\n \t\tpanic(fmt.Sprintf(\"SourceConfig.ValueSize must be >= 1. Got: %v\", b.cfg.ValueSize))\n \t}\n+\tif b.cfg.HotKeys <= 0 {\n+\t\tpanic(fmt.Sprintf(\"SourceConfig.HotKeys must be >= 1. Got: %v\", b.cfg.HotKeys))\n+\t}\n+\tif b.cfg.HotKeyFraction <= 0 {\n+\t\tpanic(fmt.Sprintf(\"SourceConfig.HotKeyFraction must be >= 1. Got: %v\", b.cfg.HotKeyFraction))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5MTExOQ==", "bodyText": "I think you forgot about setters for your new variables. Please add them, because right now, we can only set them via JSON.", "url": "https://github.com/apache/beam/pull/13245#discussion_r516091119", "createdAt": "2020-11-02T16:24:04Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -262,8 +281,10 @@ func (b *SourceConfigBuilder) BuildFromJSON(jsonData []byte) SourceConfig {\n // synthetic source. It should be created via a SourceConfigBuilder, not by\n // directly initializing it (the fields are public to allow encoding).\n type SourceConfig struct {\n-\tNumElements   int `json:\"num_records\"`\n-\tInitialSplits int `json:\"initial_splits\"`\n-\tKeySize       int `json:\"key_size\"`\n-\tValueSize     int `json:\"value_size\"`\n+\tNumElements    int `json:\"num_records\"`\n+\tInitialSplits  int `json:\"initial_splits\"`\n+\tHotKeys        int `json:\"hot_keys\"`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDM5NQ=="}, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5MTgzMQ==", "bodyText": "num_keys -> num_hot_keys", "url": "https://github.com/apache/beam/pull/13245#discussion_r516091831", "createdAt": "2020-11-02T16:25:03Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -246,7 +264,8 @@ func (b *SourceConfigBuilder) Build() SourceConfig {\n // {\n // \t \"num_records\": 5,\n // \t \"key_size\": 5,\n-// \t \"value_size\": 5\n+// \t \"value_size\": 5,\n+//\t \"num_keys\": 5,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88a4588d5fee0ed8f275f61e54f9858b47f8eda"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da2a652ec242dae35bfaefdebf285a94b1b67173", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/da2a652ec242dae35bfaefdebf285a94b1b67173", "committedDate": "2020-11-03T08:13:25Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}, "afterCommit": {"oid": "493eea026e613d40c48cbd4588ed227379d7a210", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/493eea026e613d40c48cbd4588ed227379d7a210", "committedDate": "2020-11-03T08:18:24Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "493eea026e613d40c48cbd4588ed227379d7a210", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/493eea026e613d40c48cbd4588ed227379d7a210", "committedDate": "2020-11-03T08:18:24Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}, "afterCommit": {"oid": "da2a652ec242dae35bfaefdebf285a94b1b67173", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/da2a652ec242dae35bfaefdebf285a94b1b67173", "committedDate": "2020-11-03T08:13:25Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31fb1dc9167cde74b593c26ec2bdac5a84c8b8ce", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/31fb1dc9167cde74b593c26ec2bdac5a84c8b8ce", "committedDate": "2020-11-03T08:23:07Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da2a652ec242dae35bfaefdebf285a94b1b67173", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/da2a652ec242dae35bfaefdebf285a94b1b67173", "committedDate": "2020-11-03T08:13:25Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}, "afterCommit": {"oid": "31fb1dc9167cde74b593c26ec2bdac5a84c8b8ce", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/31fb1dc9167cde74b593c26ec2bdac5a84c8b8ce", "committedDate": "2020-11-03T08:23:07Z", "message": "[BEAM-11075] - GO SDK - Synthetic source HotKeys and HotKeysFraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1794c6947d22f06f461a3779650bca0a04e64f31", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1794c6947d22f06f461a3779650bca0a04e64f31", "committedDate": "2020-11-04T08:56:57Z", "message": "[BEAM-11075] - GO SDK - Tests for synthetic source HotKeys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMTk2NDc3", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-523196477", "createdAt": "2020-11-04T09:48:43Z", "commit": {"oid": "1794c6947d22f06f461a3779650bca0a04e64f31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwOTo0ODo0M1rOHtQgeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwOTo0ODo0M1rOHtQgeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIxODQyNA==", "bodyText": "I think this whole logic could be simplified. What we need to do is to count distinct elements in the keys slice. So it can look something like this:\ncounter := make(map[byte]int) // no need to convert to string\nfor _, key := range keys {\n    counter[key]++\n}\nAfter that you can use len(keys) and len(counter) in assertions.", "url": "https://github.com/apache/beam/pull/13245#discussion_r517218424", "createdAt": "2020-11-04T09:48:43Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source_test.go", "diffHunk": "@@ -162,6 +164,83 @@ func TestSourceConfig_BuildFromJSON(t *testing.T) {\n \t}\n }\n \n+// TestSourceConfig_NumHotKeys tests that setting the number of hot keys\n+// for a synthetic source works correctly.\n+func TestSourceConfigBuilder_NumHotKeys(t *testing.T) {\n+\ttests := []struct {\n+\t\telms    int\n+\t\thotKeys int\n+\t}{\n+\t\t{elms: 15, hotKeys: 2},\n+\t\t{elms: 30, hotKeys: 10},\n+\t\t{elms: 50, hotKeys: 25},\n+\t}\n+\tfor _, test := range tests {\n+\t\ttest := test\n+\t\tt.Run(fmt.Sprintf(\"(elm = %v)\", test.hotKeys), func(t *testing.T) {\n+\t\t\tdfn := sourceFn{}\n+\t\t\tcfg := DefaultSourceConfig()\n+\t\t\tcfg.NumElements(test.elms)\n+\t\t\tcfg.HotKeyFraction(1.0)\n+\t\t\tcfg.NumHotKeys(test.hotKeys)\n+\n+\t\t\tkeys, _, err := simulateSourceFn(t, &dfn, cfg.Build())\n+\t\t\tif err != nil {\n+\t\t\t\tt.Errorf(\"Failure processing sourceFn: %v\", err)\n+\t\t\t}\n+\n+\t\t\ttype val struct {\n+\t\t\t\tnum      int\n+\t\t\t\tisHotKey bool\n+\t\t\t}\n+\n+\t\t\tm := make(map[string]val)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1794c6947d22f06f461a3779650bca0a04e64f31"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb85a5832faa316d13572fbabe8b0cee1cec43b", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/4fb85a5832faa316d13572fbabe8b0cee1cec43b", "committedDate": "2020-11-04T10:36:03Z", "message": "GO SDK - Tests for synthetic source hotKeyFraction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjU2NDI2", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-523256426", "createdAt": "2020-11-04T11:03:02Z", "commit": {"oid": "4fb85a5832faa316d13572fbabe8b0cee1cec43b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTowMzowMlrOHtTSIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTowMzowMlrOHtTSIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2MzkwNQ==", "bodyText": "Do you really need nested iterations? If I'm not mistaken, this code would be just fine:\nfor _, key := range keys {\n  encoded := hex.EncodeToString(key)\n  m[encoded]++", "url": "https://github.com/apache/beam/pull/13245#discussion_r517263905", "createdAt": "2020-11-04T11:03:02Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source_test.go", "diffHunk": "@@ -168,62 +169,48 @@ func TestSourceConfig_BuildFromJSON(t *testing.T) {\n // for a synthetic source works correctly.\n func TestSourceConfigBuilder_NumHotKeys(t *testing.T) {\n \ttests := []struct {\n-\t\telms    int\n-\t\thotKeys int\n+\t\telms           int\n+\t\thotKeys        int\n+\t\thotKeyFraction float64\n \t}{\n-\t\t{elms: 15, hotKeys: 2},\n-\t\t{elms: 30, hotKeys: 10},\n-\t\t{elms: 50, hotKeys: 25},\n+\t\t{elms: 15, hotKeys: 2, hotKeyFraction: 1.0},\n+\t\t{elms: 30, hotKeys: 10, hotKeyFraction: 1.0},\n+\t\t{elms: 50, hotKeys: 25, hotKeyFraction: 1.0},\n+\t\t{elms: 30, hotKeys: 10, hotKeyFraction: 0.5},\n+\t\t{elms: 50, hotKeys: 25, hotKeyFraction: 0.75},\n \t}\n \tfor _, test := range tests {\n \t\ttest := test\n \t\tt.Run(fmt.Sprintf(\"(elm = %v)\", test.hotKeys), func(t *testing.T) {\n \t\t\tdfn := sourceFn{}\n \t\t\tcfg := DefaultSourceConfig()\n \t\t\tcfg.NumElements(test.elms)\n-\t\t\tcfg.HotKeyFraction(1.0)\n+\t\t\tcfg.HotKeyFraction(test.hotKeyFraction)\n \t\t\tcfg.NumHotKeys(test.hotKeys)\n \n \t\t\tkeys, _, err := simulateSourceFn(t, &dfn, cfg.Build())\n \t\t\tif err != nil {\n \t\t\t\tt.Errorf(\"Failure processing sourceFn: %v\", err)\n \t\t\t}\n \n-\t\t\ttype val struct {\n-\t\t\t\tnum      int\n-\t\t\t\tisHotKey bool\n-\t\t\t}\n-\n-\t\t\tm := make(map[string]val)\n+\t\t\tm := make(map[string]int)\n \t\t\tfor i := 0; i < len(keys); i++ {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fb85a5832faa316d13572fbabe8b0cee1cec43b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8641b6232021b4c4230b4fffd1bf8991ea3dc42", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/c8641b6232021b4c4230b4fffd1bf8991ea3dc42", "committedDate": "2020-11-04T11:10:50Z", "message": "fix: User range when counting keys instead of nested for loops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aa11c34329732cc1331c720849747f3c68bf8dc", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/3aa11c34329732cc1331c720849747f3c68bf8dc", "committedDate": "2020-11-04T11:48:30Z", "message": "fix: don't run flaky hotKeyFraction tests only with hotKeyFraction 1.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjk2OTk5", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-523296999", "createdAt": "2020-11-04T12:01:59Z", "commit": {"oid": "3aa11c34329732cc1331c720849747f3c68bf8dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo1OVrOHtVLBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo1OVrOHtVLBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDg1Mg==", "bodyText": "In general, we shouldn't commit commented out code. That being said, there are two solutions:\n\nremove this completely,\nif you feel that hotKeyFraction should be tested, but not necessarily now for whatever reason, create a // TODO(BEAM-xxx) and describe what should be done here.", "url": "https://github.com/apache/beam/pull/13245#discussion_r517294852", "createdAt": "2020-11-04T12:01:59Z", "author": {"login": "kamilwu"}, "path": "sdks/go/pkg/beam/io/synthetic/source_test.go", "diffHunk": "@@ -175,8 +175,8 @@ func TestSourceConfigBuilder_NumHotKeys(t *testing.T) {\n \t\t{elms: 15, hotKeys: 2, hotKeyFraction: 1.0},\n \t\t{elms: 30, hotKeys: 10, hotKeyFraction: 1.0},\n \t\t{elms: 50, hotKeys: 25, hotKeyFraction: 1.0},\n-\t\t{elms: 30, hotKeys: 10, hotKeyFraction: 0.5},\n-\t\t{elms: 50, hotKeys: 25, hotKeyFraction: 0.75},\n+\t\t// {elms: 30, hotKeys: 10, hotKeyFraction: 0.5}, tests for hotKeyFraction < 1.0 could be Flaky", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aa11c34329732cc1331c720849747f3c68bf8dc"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4", "committedDate": "2020-11-04T12:05:10Z", "message": "fix: remove hot key fraction testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzE2MTA1", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-523316105", "createdAt": "2020-11-04T12:30:40Z", "commit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTA4OTcx", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-523908971", "createdAt": "2020-11-05T03:57:09Z", "commit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzo1NzowOVrOHtys5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNDo0Njo0N1rOHtzZiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc3ODY2MA==", "bodyText": "Nit: The style in the Go SDK is to separate standard Go package imports from other others. So in this case it's actually the beam/core/sdf import that should be moved to the lower group, separate from the standard Go packages.", "url": "https://github.com/apache/beam/pull/13245#discussion_r517778660", "createdAt": "2020-11-05T03:57:09Z", "author": {"login": "youngoli"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -26,13 +26,12 @@ import (\n \t\"bytes\"\n \t\"encoding/json\"\n \t\"fmt\"\n+\t\"github.com/apache/beam/sdks/go/pkg/beam\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc4MTkxNQ==", "bodyText": "It's unnecessary to create a new sourceFn here just to use the rng field. You should be able to get the same behavior by using the rand.Rand object directly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tgenerator := sourceFn{}\n          \n          \n            \n            \t\tgenerator.rng = rand.New(rand.NewSource(i))\n          \n          \n            \n            \t\trandomSample := generator.rng.Float64()\n          \n          \n            \n            \t\tgenerator := rand.New(rand.NewSource(i))\n          \n          \n            \n            \t\trandomSample := generator.Float64()", "url": "https://github.com/apache/beam/pull/13245#discussion_r517781915", "createdAt": "2020-11-05T04:11:51Z", "author": {"login": "youngoli"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -131,8 +130,19 @@ func (fn *sourceFn) ProcessElement(rt *sdf.LockRTracker, config SourceConfig, em\n \tfor i := rt.GetRestriction().(offsetrange.Restriction).Start; rt.TryClaim(i) == true; i++ {\n \t\tkey := make([]byte, config.KeySize)\n \t\tval := make([]byte, config.ValueSize)\n-\t\tif _, err := fn.rng.Read(key); err != nil {\n-\t\t\treturn err\n+\t\tgenerator := sourceFn{}\n+\t\tgenerator.rng = rand.New(rand.NewSource(i))\n+\t\trandomSample := generator.rng.Float64()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc4ODE0OQ==", "bodyText": "I would avoid making local instances of rand.Rand here unless you have a very good reason here. Is the reason you're creating new, local instances of rand.Rand and seeding them with the restriction positions because you want to get completely deterministic behavior, regardless of any splitting that might occur on the restriction?\nIf so: Then be aware that this implementation is going to get identical results per input (in this case, per SourceConfig). For example, if you make two SourceConfigs for 10 elements each, then both of them will seed these generators with the numbers 0-9, which can lead to strangely identical results. If you want purely deterministic output that is still different per SourceConfig, then each SourceConfig will probably need some kind of unique but deterministic salt that can be added to these numbers (example: rand.NewSource(i + fn.salt))).\nOn the other hand, if this check and the hotkey distributions don't need to be deterministic, then I would simplify a bit and just use the existing Rand object (fn.rng) more. Or, if you need to customize the rng for test purposes, you can add more randWrapper fields to the SourceFn struct. I think the only spot where you would need deterministic values in that case is for filling out the actual hotkey value, and even then I think there's room for optimizing so we don't constantly create and reseed a rand.Rand.", "url": "https://github.com/apache/beam/pull/13245#discussion_r517788149", "createdAt": "2020-11-05T04:38:49Z", "author": {"login": "youngoli"}, "path": "sdks/go/pkg/beam/io/synthetic/source.go", "diffHunk": "@@ -131,8 +130,19 @@ func (fn *sourceFn) ProcessElement(rt *sdf.LockRTracker, config SourceConfig, em\n \tfor i := rt.GetRestriction().(offsetrange.Restriction).Start; rt.TryClaim(i) == true; i++ {\n \t\tkey := make([]byte, config.KeySize)\n \t\tval := make([]byte, config.ValueSize)\n-\t\tif _, err := fn.rng.Read(key); err != nil {\n-\t\t\treturn err\n+\t\tgenerator := sourceFn{}\n+\t\tgenerator.rng = rand.New(rand.NewSource(i))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5MDA4OA==", "bodyText": "I don't think the numOfAllKeys check here is necessary. It essentially boils down to counting the number of elements emitted which is already done by other unit tests. The only reason I can see for this is if you suspect that enabling hot keys might cause elements to drop, when they wouldn't otherwise, but based on your implementation I don't think that's something to worry about.", "url": "https://github.com/apache/beam/pull/13245#discussion_r517790088", "createdAt": "2020-11-05T04:46:47Z", "author": {"login": "youngoli"}, "path": "sdks/go/pkg/beam/io/synthetic/source_test.go", "diffHunk": "@@ -162,6 +163,59 @@ func TestSourceConfig_BuildFromJSON(t *testing.T) {\n \t}\n }\n \n+// TestSourceConfig_NumHotKeys tests that setting the number of hot keys\n+// for a synthetic source works correctly.\n+func TestSourceConfigBuilder_NumHotKeys(t *testing.T) {\n+\ttests := []struct {\n+\t\telms    int\n+\t\thotKeys int\n+\t}{\n+\t\t{elms: 15, hotKeys: 2},\n+\t\t{elms: 30, hotKeys: 10},\n+\t\t{elms: 50, hotKeys: 25},\n+\t}\n+\tfor _, test := range tests {\n+\t\ttest := test\n+\t\tt.Run(fmt.Sprintf(\"(elm = %v)\", test.hotKeys), func(t *testing.T) {\n+\t\t\tdfn := sourceFn{}\n+\t\t\tcfg := DefaultSourceConfig()\n+\t\t\tcfg.NumElements(test.elms)\n+\t\t\tcfg.HotKeyFraction(1.0)\n+\t\t\tcfg.NumHotKeys(test.hotKeys)\n+\n+\t\t\tkeys, _, err := simulateSourceFn(t, &dfn, cfg.Build())\n+\t\t\tif err != nil {\n+\t\t\t\tt.Errorf(\"Failure processing sourceFn: %v\", err)\n+\t\t\t}\n+\n+\t\t\tm := make(map[string]int)\n+\t\t\tfor _, key := range keys {\n+\t\t\t\tencoded := hex.EncodeToString(key)\n+\t\t\t\tm[encoded]++\n+\t\t\t}\n+\n+\t\t\tnumOfHotKeys := 0\n+\t\t\tnumOfAllKeys := 0\n+\t\t\tfor _, element := range m {\n+\t\t\t\tnumOfAllKeys += element\n+\t\t\t\tif element > 1 {\n+\t\t\t\t\tnumOfHotKeys += 1\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tif numOfAllKeys != test.elms {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09b9e46ca0cd626a216d4235e6fecd4c2ebd8df4"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f510db4e642cd733c45b2365e8b761f016405d5", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6f510db4e642cd733c45b2365e8b761f016405d5", "committedDate": "2020-11-05T06:55:01Z", "message": "fix: dont create new sourceFn and remove check numOfAllElms for hot keys test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd8a7693dd642afdaa0ae4b7dffb7dd382b826a0", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/fd8a7693dd642afdaa0ae4b7dffb7dd382b826a0", "committedDate": "2020-11-06T07:22:02Z", "message": "fix: create generator before for loop and seed it inside fori"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTYzODg3", "url": "https://github.com/apache/beam/pull/13245#pullrequestreview-525563887", "createdAt": "2020-11-07T00:06:02Z", "commit": {"oid": "fd8a7693dd642afdaa0ae4b7dffb7dd382b826a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1863, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}