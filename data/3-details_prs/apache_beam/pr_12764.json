{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MjM1ODIx", "number": 12764, "title": "[BEAM-10009] Add beam:logical_type:micros_instant:v1", "bodyText": "This PR adds support for beam:logical_type:micros_instant:v1 in Python and Java. It also adds logic for translating logical types which do not use the argument to portable Beam schemas.\nIn Python, micros_instant:v1 is the default mapping for the microsecond-precision beam.utils.timestamp.Timestamp type when inferring a schema.\nThe change is tested via unit tests in Python and Java, as well as a new entry in standard_coders_test.yaml.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-02T23:12:27Z", "url": "https://github.com/apache/beam/pull/12764", "merged": true, "mergeCommit": {"oid": "422e1116babd6d977b3cf5025a1c14933cc4aa44"}, "closed": true, "closedAt": "2020-09-11T17:59:04Z", "author": {"login": "TheNeuralBit"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFEA6AAH2gAyNDc4MjM1ODIxOjcxNWI1MGEwYjZmODlhNDYzNmM5MmRjZmIyMjA3MWFhY2U4Njk0YTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHqp9egH2gAyNDc4MjM1ODIxOmZjZDg4YWNiMTBlZWE5YzM3MDg5ZTc5ZDAwMWE2YmY5MjUxNzllNmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "715b50a0b6f89a4636c92dcfb22071aace8694a9", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/715b50a0b6f89a4636c92dcfb22071aace8694a9", "committedDate": "2020-09-02T22:47:28Z", "message": "Add MicrosInstant.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf50e19967ad9d3794db3643de3643ac3f26c66e", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/cf50e19967ad9d3794db3643de3643ac3f26c66e", "committedDate": "2020-09-02T22:47:28Z", "message": "Java: add support for micros_instant in portability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48922ea618afc4780b085f657439ece2ebb08e7b", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/48922ea618afc4780b085f657439ece2ebb08e7b", "committedDate": "2020-09-02T23:03:26Z", "message": "LogicalType support in python schema translation and RowCoder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d988d37449a097cadcc2197fe96e569431070c41", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/d988d37449a097cadcc2197fe96e569431070c41", "committedDate": "2020-09-02T23:03:26Z", "message": "Add support for micros_instant in Python"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b348f0147310c51d3fa4d66cc878cd56b01e812b", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/b348f0147310c51d3fa4d66cc878cd56b01e812b", "committedDate": "2020-09-02T23:03:26Z", "message": "Add integration test for micros_instant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "422eb0f6ed41f46d1e6192b9b3b85ace9593b67c", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/422eb0f6ed41f46d1e6192b9b3b85ace9593b67c", "committedDate": "2020-09-02T23:03:26Z", "message": "CommonCoderTest.java: Add support for parsing logical types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/25618a6fc13673dfe80d680a97521c80de5b212e", "committedDate": "2020-09-02T23:03:26Z", "message": "standard_coders_test.py: add support for parsing rows and logical types"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDc1MTUx", "url": "https://github.com/apache/beam/pull/12764#pullrequestreview-482075151", "createdAt": "2020-09-03T17:56:37Z", "commit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzo1NjozOFrOHMxljg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzo1NzozMVrOHMxndw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1NzM5MA==", "bodyText": "I see other logical types handle null input in this function and toInputType() as well. Should we also add it here?", "url": "https://github.com/apache/beam/pull/12764#discussion_r483157390", "createdAt": "2020-09-03T17:56:38Z", "author": {"login": "robinyqiu"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/schemas/logicaltypes/MicrosInstant.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.schemas.logicaltypes;\n+\n+import java.time.Instant;\n+import org.apache.beam.sdk.schemas.Schema;\n+import org.apache.beam.sdk.values.Row;\n+\n+/**\n+ * A timestamp represented as microseconds since the epoch.\n+ *\n+ * <p>WARNING: This logical type exists solely for interoperability with other type systems such as\n+ * SQL and other Beam SDKs. It should never be used in a native Java context where the {@code\n+ * java.time.Instant} instances it describes may have higher than microsecond precision. Ignoring\n+ * this will likely result in an {@code AssertionError} at pipeline execution time.\n+ *\n+ * <p>For a more faithful logical type to use with {@code java.time.Instant}, see {@link\n+ * NanosInstant}.\n+ */\n+public class MicrosInstant implements Schema.LogicalType<Instant, Row> {\n+  public static final String IDENTIFIER = \"beam:logical_type:micros_instant:v1\";\n+  private final Schema schema;\n+\n+  public MicrosInstant() {\n+    this.schema = Schema.builder().addInt64Field(\"seconds\").addInt32Field(\"micros\").build();\n+  }\n+\n+  @Override\n+  public Row toBaseType(Instant input) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE1Nzg3OQ==", "bodyText": "I think this can be a constant. We don't need to initialize it in constructor.", "url": "https://github.com/apache/beam/pull/12764#discussion_r483157879", "createdAt": "2020-09-03T17:57:31Z", "author": {"login": "robinyqiu"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/schemas/logicaltypes/MicrosInstant.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.schemas.logicaltypes;\n+\n+import java.time.Instant;\n+import org.apache.beam.sdk.schemas.Schema;\n+import org.apache.beam.sdk.values.Row;\n+\n+/**\n+ * A timestamp represented as microseconds since the epoch.\n+ *\n+ * <p>WARNING: This logical type exists solely for interoperability with other type systems such as\n+ * SQL and other Beam SDKs. It should never be used in a native Java context where the {@code\n+ * java.time.Instant} instances it describes may have higher than microsecond precision. Ignoring\n+ * this will likely result in an {@code AssertionError} at pipeline execution time.\n+ *\n+ * <p>For a more faithful logical type to use with {@code java.time.Instant}, see {@link\n+ * NanosInstant}.\n+ */\n+public class MicrosInstant implements Schema.LogicalType<Instant, Row> {\n+  public static final String IDENTIFIER = \"beam:logical_type:micros_instant:v1\";\n+  private final Schema schema;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjg0NzYz", "url": "https://github.com/apache/beam/pull/12764#pullrequestreview-482284763", "createdAt": "2020-09-04T00:31:55Z", "commit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMDozMTo1NVrOHM7pcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMDozMTo1NVrOHM7pcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyMjIyNA==", "bodyText": "Since.", "url": "https://github.com/apache/beam/pull/12764#discussion_r483322224", "createdAt": "2020-09-04T00:31:55Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/typehints/schemas.py", "diffHunk": "@@ -279,3 +301,184 @@ def schema_from_element_type(element_type):  # (type) -> schema_pb2.Schema\n def named_fields_from_element_type(\n     element_type):  # (type) -> typing.List[typing.Tuple[unicode, type]]\n   return named_fields_from_schema(schema_from_element_type(element_type))\n+\n+\n+# Registry of typings for a schema by UUID\n+class LogicalTypeRegistry(object):\n+  def __init__(self):\n+    self.by_urn = {}\n+    self.by_logical_type = {}\n+    self.by_language_type = {}\n+\n+  def add(self, urn, logical_type):\n+    self.by_urn[urn] = logical_type\n+    self.by_logical_type[logical_type] = urn\n+    self.by_language_type[logical_type.language_type()] = logical_type\n+\n+  def get_logical_type_by_urn(self, urn):\n+    return self.by_urn.get(urn, None)\n+\n+  def get_urn_by_logial_type(self, logical_type):\n+    return self.by_logical_type.get(logical_type, None)\n+\n+  def get_logical_type_by_language_type(self, representation_type):\n+    return self.by_language_type.get(representation_type, None)\n+\n+\n+LanguageT = TypeVar('LanguageT')\n+RepresentationT = TypeVar('RepresentationT')\n+ArgT = TypeVar('ArgT')\n+\n+\n+class LogicalType(Generic[LanguageT, RepresentationT, ArgT]):\n+  _known_logical_types = LogicalTypeRegistry()\n+\n+  @classmethod\n+  def urn(cls):\n+    # type: () -> unicode\n+\n+    \"\"\"Return the URN used to identify this logical type\"\"\"\n+    raise NotImplementedError()\n+\n+  @classmethod\n+  def language_type(cls):\n+    # type: () -> type\n+\n+    \"\"\"Return the language type this LogicalType encodes.\n+\n+    The returned type should match LanguageT\"\"\"\n+    raise NotImplementedError()\n+\n+  @classmethod\n+  def representation_type(cls):\n+    # type: () -> type\n+\n+    \"\"\"Return the type of the representation this LogicalType uses to encode the\n+    language type.\n+\n+    The returned type should match RepresentationT\"\"\"\n+    raise NotImplementedError()\n+\n+  @classmethod\n+  def argument_type(cls):\n+    # type: () -> type\n+\n+    \"\"\"Return the type of the argument used for variations of this LogicalType.\n+\n+    The returned type should match ArgT\"\"\"\n+    raise NotImplementedError(cls)\n+\n+  def argument(self):\n+    # type: () -> ArgT\n+\n+    \"\"\"Return the argument for this instance of the LogicalType.\"\"\"\n+    raise NotImplementedError()\n+\n+  def to_representation_type(value):\n+    # type: (LanguageT) -> RepresentationT\n+\n+    \"\"\"Convert an instance of LanguageT to RepresentationT.\"\"\"\n+    raise NotImplementedError()\n+\n+  def to_language_type(value):\n+    # type: (RepresentationT) -> LanguageT\n+\n+    \"\"\"Convert an instance of RepresentationT to LanguageT.\"\"\"\n+    raise NotImplementedError()\n+\n+  @classmethod\n+  def register_logical_type(cls, logical_type_cls):\n+    \"\"\"Register an implementation of LogicalType.\"\"\"\n+    cls._known_logical_types.add(logical_type_cls.urn(), logical_type_cls)\n+\n+  @classmethod\n+  def from_typing(cls, typ):\n+    # type: (type) -> LogicalType\n+\n+    \"\"\"Construct an instance of a registered LogicalType implementation given a\n+    typing.\n+\n+    Raises ValueError if no registered LogicalType implementation can encode the\n+    given typing.\"\"\"\n+\n+    logical_type = cls._known_logical_types.get_logical_type_by_language_type(\n+        typ)\n+    if logical_type is None:\n+      raise ValueError(\"No logical type registered for typing '%s'\" % typ)\n+\n+    return logical_type._from_typing(typ)\n+\n+  @classmethod\n+  def _from_typing(cls, typ):\n+    # type: (type) -> LogicalType\n+\n+    \"\"\"Construct an instance of this LogicalType implementation given a typing.\n+    \"\"\"\n+    raise NotImplementedError()\n+\n+  @classmethod\n+  def from_runner_api(cls, logical_type_proto):\n+    # type: (schema_pb2.LogicalType) -> LogicalType\n+\n+    \"\"\"Construct an instance of a registered LogicalType implementation given a\n+    proto LogicalType.\n+\n+    Raises ValueError if no LogicalType registered for the given URN.\n+    \"\"\"\n+    logical_type = cls._known_logical_types.get_logical_type_by_urn(\n+        logical_type_proto.urn)\n+    if logical_type is None:\n+      raise ValueError(\n+          \"No logical type registered for URN '%s'\" % logical_type_proto.urn)\n+    # TODO(bhulette): Use argument\n+    return logical_type()\n+\n+\n+class NoArgumentLogicalType(LogicalType[LanguageT, RepresentationT, None]):\n+  @classmethod\n+  def argument_type(cls):\n+    # type: () -> type\n+    return None\n+\n+  def argument(self):\n+    # type: () -> ArgT\n+    return None\n+\n+  @classmethod\n+  def _from_typing(cls, typ):\n+    # type: (type) -> LogicalType\n+\n+    # Sicne there's no argument, there can be no additional information encoded", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25618a6fc13673dfe80d680a97521c80de5b212e"}, "originalPosition": 216}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba055370686bb34375a6f23c18cdcd5dd2ab26d0", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/ba055370686bb34375a6f23c18cdcd5dd2ab26d0", "committedDate": "2020-09-11T00:56:23Z", "message": "Add BEAM-10878 TODOs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd88acb10eea9c37089e79d001a6bf925179e6a", "author": {"user": {"login": "TheNeuralBit", "name": "Brian Hulette"}}, "url": "https://github.com/apache/beam/commit/fcd88acb10eea9c37089e79d001a6bf925179e6a", "committedDate": "2020-09-11T00:56:33Z", "message": "fix typos"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4651, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}