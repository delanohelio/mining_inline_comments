{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDkxMDk2", "number": 12639, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMToyNjoyMlrOEaQaYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MzowM1rOEan9hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTY3MzI4OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMToyNjoyMlrOHDktuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjoxMzo1NFrOHEJCVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUwOTMwNA==", "bodyText": "should we also check index != -1?", "url": "https://github.com/apache/beam/pull/12639#discussion_r473509304", "createdAt": "2020-08-20T01:26:22Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -237,8 +232,9 @@ public void trySplit(\n     }\n \n     synchronized (splittingLock) {\n-      // Don't attempt to split if we haven't started.\n-      if (!started) {\n+      // Don't attempt to split if we are already done since there isn't a meaningful split we can\n+      // provide.\n+      if (index == stopIndex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b036d637f30366072d12ca9bc2e916f3425b5ac"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwNDQwNQ==", "bodyText": "No, the logic below will allow us to choose a stopIndex even if registerInputLocation has not been invoked. See testSplittingWhenNoElementsProcessed. I added a variant of that test where we split before registerInputLocation happens to get coverage for this case.", "url": "https://github.com/apache/beam/pull/12639#discussion_r474104405", "createdAt": "2020-08-20T16:13:54Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/BeamFnDataReadRunner.java", "diffHunk": "@@ -237,8 +232,9 @@ public void trySplit(\n     }\n \n     synchronized (splittingLock) {\n-      // Don't attempt to split if we haven't started.\n-      if (!started) {\n+      // Don't attempt to split if we are already done since there isn't a meaningful split we can\n+      // provide.\n+      if (index == stopIndex) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUwOTMwNA=="}, "originalCommit": {"oid": "1b036d637f30366072d12ca9bc2e916f3425b5ac"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzUzMTU3OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo1MzowM1rOHEK6uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNTowMlrOHEN_9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA==", "bodyText": "I may misunderstand some content here but I thought we don't perform splitting if the bundle is not started.", "url": "https://github.com/apache/beam/pull/12639#discussion_r474135224", "createdAt": "2020-08-20T16:53:03Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "diffHunk": "@@ -352,6 +354,35 @@ public void testRegistration() {\n       fail(\"Expected registrar not found.\");\n     }\n \n+    @Test\n+    public void testSplittingBeforeStartBundle() throws Exception {\n+      List<WindowedValue<String>> outputValues = new ArrayList<>();\n+      BeamFnDataReadRunner<String> readRunner =\n+          createReadRunner(outputValues::add, PTRANSFORM_ID, mockBeamFnDataClient);\n+      // The split should happen at 5 since the allowedSplitPoints is empty.\n+      assertEquals(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8705a9a11880a9befc6dfdf4e2e9641c8a331081"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NDYxOA==", "bodyText": "A bundle can be started before each transforms start method has been invoked since we invoke start starting from the leaves and going to the parents and then we invoke finish in reverse order.\nHaving this definition of started allows us to get msec counters for start methods since they can be slow, checkpointing without processing through this read transform...", "url": "https://github.com/apache/beam/pull/12639#discussion_r474144618", "createdAt": "2020-08-20T17:09:55Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "diffHunk": "@@ -352,6 +354,35 @@ public void testRegistration() {\n       fail(\"Expected registrar not found.\");\n     }\n \n+    @Test\n+    public void testSplittingBeforeStartBundle() throws Exception {\n+      List<WindowedValue<String>> outputValues = new ArrayList<>();\n+      BeamFnDataReadRunner<String> readRunner =\n+          createReadRunner(outputValues::add, PTRANSFORM_ID, mockBeamFnDataClient);\n+      // The split should happen at 5 since the allowedSplitPoints is empty.\n+      assertEquals(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}, "originalCommit": {"oid": "8705a9a11880a9befc6dfdf4e2e9641c8a331081"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3MzMwMg==", "bodyText": "I see. So that means we are now allowing splitting before processing gets started, right?", "url": "https://github.com/apache/beam/pull/12639#discussion_r474173302", "createdAt": "2020-08-20T18:01:48Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "diffHunk": "@@ -352,6 +354,35 @@ public void testRegistration() {\n       fail(\"Expected registrar not found.\");\n     }\n \n+    @Test\n+    public void testSplittingBeforeStartBundle() throws Exception {\n+      List<WindowedValue<String>> outputValues = new ArrayList<>();\n+      BeamFnDataReadRunner<String> readRunner =\n+          createReadRunner(outputValues::add, PTRANSFORM_ID, mockBeamFnDataClient);\n+      // The split should happen at 5 since the allowedSplitPoints is empty.\n+      assertEquals(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}, "originalCommit": {"oid": "8705a9a11880a9befc6dfdf4e2e9641c8a331081"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NTcxNg==", "bodyText": "We always did before as well since registerInputLocation doesn't mean we have seen any elements yet just that we are eligible to get them. This expands that time frame before receiving the first element slightly.", "url": "https://github.com/apache/beam/pull/12639#discussion_r474185716", "createdAt": "2020-08-20T18:25:02Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/test/java/org/apache/beam/fn/harness/BeamFnDataReadRunnerTest.java", "diffHunk": "@@ -352,6 +354,35 @@ public void testRegistration() {\n       fail(\"Expected registrar not found.\");\n     }\n \n+    @Test\n+    public void testSplittingBeforeStartBundle() throws Exception {\n+      List<WindowedValue<String>> outputValues = new ArrayList<>();\n+      BeamFnDataReadRunner<String> readRunner =\n+          createReadRunner(outputValues::add, PTRANSFORM_ID, mockBeamFnDataClient);\n+      // The split should happen at 5 since the allowedSplitPoints is empty.\n+      assertEquals(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzNTIyNA=="}, "originalCommit": {"oid": "8705a9a11880a9befc6dfdf4e2e9641c8a331081"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 549, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}