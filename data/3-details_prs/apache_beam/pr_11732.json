{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MDAzMTIz", "number": 11732, "title": "[BEAM-10017] Expose Cassandra Connect and Read timeouts", "bodyText": "This PR is intended to expose all of the available Cassandra client socket options so the client can be tuned for various environments.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-05-16T18:08:26Z", "url": "https://github.com/apache/beam/pull/11732", "merged": true, "mergeCommit": {"oid": "6eb8733f853d95260178c592b594eb637b44099d"}, "closed": true, "closedAt": "2020-06-04T10:11:24Z", "author": {"login": "nfisher"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcibrmZAFqTQxMzM4MDcyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcloV8VgBqjMzODEzNjczNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMzgwNzIz", "url": "https://github.com/apache/beam/pull/11732#pullrequestreview-413380723", "createdAt": "2020-05-18T08:34:34Z", "commit": {"oid": "f23f587465478637cf6e6a7ae8ae0974e39155d1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MTQyOTky", "url": "https://github.com/apache/beam/pull/11732#pullrequestreview-415142992", "createdAt": "2020-05-20T09:14:47Z", "commit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwOToxNDo0N1rOGYCk0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxNzowNVrOGYE3tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg2MTIwMw==", "bodyText": "Can you also change a leftover in the javadoc: An IO to read and write from/to Apache Cassandra ?", "url": "https://github.com/apache/beam/pull/11732#discussion_r427861203", "createdAt": "2020-05-20T09:14:47Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -106,19 +107,13 @@\n  *\n  * <h3>Cassandra Socket Options</h3>\n  *\n- * <p>The following example illustrates various options for tuning client socket:\n+ * <p>The following example illustrates setting timeouts for the Cassandra client:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3NDk1Mw==", "bodyText": "you need a javadoc for both methods as they are both public (2 versions for backward compatibility as valueprovider was introduced lately)\n\n\nspecify that they are millis\n\n\nadd links to cassandra socketoptions setConnectTimeOut", "url": "https://github.com/apache/beam/pull/11732#discussion_r427874953", "createdAt": "2020-05-20T09:36:49Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -330,6 +331,24 @@ private CassandraIO() {}\n       return builder().setMinNumberOfSplits(minNumberOfSplits).build();\n     }\n \n+    /** Cassandra client socket option to set the connect timeout. */\n+    public Read<T> withConnectTimeout(Integer timeout) {\n+      return withConnectTimeout(ValueProvider.StaticValueProvider.of(timeout));\n+    }\n+\n+    public Read<T> withConnectTimeout(ValueProvider<Integer> timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3NTA5MA==", "bodyText": "same as above", "url": "https://github.com/apache/beam/pull/11732#discussion_r427875090", "createdAt": "2020-05-20T09:37:00Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -330,6 +331,24 @@ private CassandraIO() {}\n       return builder().setMinNumberOfSplits(minNumberOfSplits).build();\n     }\n \n+    /** Cassandra client socket option to set the connect timeout. */\n+    public Read<T> withConnectTimeout(Integer timeout) {\n+      return withConnectTimeout(ValueProvider.StaticValueProvider.of(timeout));\n+    }\n+\n+    public Read<T> withConnectTimeout(ValueProvider<Integer> timeout) {\n+      return builder().setConnectTimeout(timeout).build();\n+    }\n+\n+    /** Cassandra client socket option to set the read timeout. */\n+    public Read<T> withReadTimeout(Integer timeout) {\n+      return withReadTimeout(ValueProvider.StaticValueProvider.of(timeout));\n+    }\n+\n+    public Read<T> withReadTimeout(ValueProvider<Integer> timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3OTQ0NQ==", "bodyText": "Add input values check (!= null && > 0) as in the other methods with the checkArgument call. As the value provider version method relies on this version, put the checkArgument here. Do not forget to put the validation in the other parameters methods", "url": "https://github.com/apache/beam/pull/11732#discussion_r427879445", "createdAt": "2020-05-20T09:44:07Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -330,6 +331,24 @@ private CassandraIO() {}\n       return builder().setMinNumberOfSplits(minNumberOfSplits).build();\n     }\n \n+    /** Cassandra client socket option to set the connect timeout. */\n+    public Read<T> withConnectTimeout(Integer timeout) {\n+      return withConnectTimeout(ValueProvider.StaticValueProvider.of(timeout));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5NzM1NQ==", "bodyText": "Add readTimeout cf glocal review comment", "url": "https://github.com/apache/beam/pull/11732#discussion_r427897355", "createdAt": "2020-05-20T10:14:20Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -811,6 +840,9 @@ public T getCurrent() throws NoSuchElementException {\n \n     abstract MutationType mutationType();\n \n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5NzU5NA==", "bodyText": "Add withReadTimeout cf global review comment", "url": "https://github.com/apache/beam/pull/11732#discussion_r427897594", "createdAt": "2020-05-20T10:14:50Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -948,6 +980,15 @@ public T getCurrent() throws NoSuchElementException {\n       return builder().setConsistencyLevel(consistencyLevel).build();\n     }\n \n+    /** Cassandra client socket option for connect timeout. */\n+    public Write<T> withConnectTimeout(Integer timeout) {\n+      return withConnectTimeout(ValueProvider.StaticValueProvider.of(timeout));\n+    }\n+\n+    public Write<T> withConnectTimeout(ValueProvider<Integer> timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5Nzc5Ng==", "bodyText": "add read timeout", "url": "https://github.com/apache/beam/pull/11732#discussion_r427897796", "createdAt": "2020-05-20T10:15:14Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -948,6 +980,15 @@ public T getCurrent() throws NoSuchElementException {\n       return builder().setConsistencyLevel(consistencyLevel).build();\n     }\n \n+    /** Cassandra client socket option for connect timeout. */\n+    public Write<T> withConnectTimeout(Integer timeout) {\n+      return withConnectTimeout(ValueProvider.StaticValueProvider.of(timeout));\n+    }\n+\n+    public Write<T> withConnectTimeout(ValueProvider<Integer> timeout) {\n+      return builder().setConnectTimeout(timeout).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5Nzk0Mw==", "bodyText": "add read timeout", "url": "https://github.com/apache/beam/pull/11732#discussion_r427897943", "createdAt": "2020-05-20T10:15:30Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -1023,6 +1065,8 @@ private String getMutationTypeName() {\n \n       abstract Builder<T> setMutationType(MutationType mutationType);\n \n+      abstract Builder<T> setConnectTimeout(ValueProvider<Integer> timeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5ODU5NA==", "bodyText": "no more null check needed if both timeouts are set as part of Read and Write and if you add the validation of inputs in the with* methods", "url": "https://github.com/apache/beam/pull/11732#discussion_r427898594", "createdAt": "2020-05-20T10:16:44Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -1116,6 +1163,18 @@ private static Cluster getCluster(\n           new QueryOptions().setConsistencyLevel(ConsistencyLevel.valueOf(consistencyLevel.get())));\n     }\n \n+    SocketOptions socketOptions = new SocketOptions();\n+\n+    builder.withSocketOptions(socketOptions);\n+\n+    if (connectTimeout != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5ODY5NQ==", "bodyText": "same as above", "url": "https://github.com/apache/beam/pull/11732#discussion_r427898695", "createdAt": "2020-05-20T10:16:54Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -1116,6 +1163,18 @@ private static Cluster getCluster(\n           new QueryOptions().setConsistencyLevel(ConsistencyLevel.valueOf(consistencyLevel.get())));\n     }\n \n+    SocketOptions socketOptions = new SocketOptions();\n+\n+    builder.withSocketOptions(socketOptions);\n+\n+    if (connectTimeout != null) {\n+      socketOptions.setConnectTimeoutMillis(connectTimeout.get());\n+    }\n+\n+    if (readTimeout != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5ODgwNA==", "bodyText": "pass the read timeout", "url": "https://github.com/apache/beam/pull/11732#discussion_r427898804", "createdAt": "2020-05-20T10:17:05Z", "author": {"login": "echauchot"}, "path": "sdks/java/io/cassandra/src/main/java/org/apache/beam/sdk/io/cassandra/CassandraIO.java", "diffHunk": "@@ -1142,7 +1201,9 @@ private static Cluster getCluster(\n               spec.username(),\n               spec.password(),\n               spec.localDc(),\n-              spec.consistencyLevel());\n+              spec.consistencyLevel(),\n+              spec.connectTimeout(),\n+              null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848"}, "originalPosition": 192}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1d235f4abdd83c40bd3673a9dad1ff4d5822848", "author": {"user": {"login": "nfisher", "name": "Nathan Fisher"}}, "url": "https://github.com/apache/beam/commit/d1d235f4abdd83c40bd3673a9dad1ff4d5822848", "committedDate": "2020-05-20T01:19:59Z", "message": "Add connect and read timeouts to C* client"}, "afterCommit": {"oid": "16ae640846375e6ce873398e080fb452719e9b03", "author": {"user": {"login": "nfisher", "name": "Nathan Fisher"}}, "url": "https://github.com/apache/beam/commit/16ae640846375e6ce873398e080fb452719e9b03", "committedDate": "2020-05-20T13:18:54Z", "message": "Address javadoc issues raised in PR will squash later"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eb8733f853d95260178c592b594eb637b44099d", "author": {"user": {"login": "nfisher", "name": "Nathan Fisher"}}, "url": "https://github.com/apache/beam/commit/6eb8733f853d95260178c592b594eb637b44099d", "committedDate": "2020-05-28T06:59:34Z", "message": "[BEAM-10017] Expose Cassandra Connect/Read timeouts\n\nThis adds the ability to specify a connect and read timeout socket\noption to the Cassandra IO driver."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c6dc267310b13715d4f648c29b4685b80385ec0", "author": {"user": {"login": "nfisher", "name": "Nathan Fisher"}}, "url": "https://github.com/apache/beam/commit/2c6dc267310b13715d4f648c29b4685b80385ec0", "committedDate": "2020-05-28T00:35:50Z", "message": "Add readTimeout to Writer and checkArgument to timeout builders"}, "afterCommit": {"oid": "6eb8733f853d95260178c592b594eb637b44099d", "author": {"user": {"login": "nfisher", "name": "Nathan Fisher"}}, "url": "https://github.com/apache/beam/commit/6eb8733f853d95260178c592b594eb637b44099d", "committedDate": "2020-05-28T06:59:34Z", "message": "[BEAM-10017] Expose Cassandra Connect/Read timeouts\n\nThis adds the ability to specify a connect and read timeout socket\noption to the Cassandra IO driver."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}