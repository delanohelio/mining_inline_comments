{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NTMzNjEz", "number": 11060, "title": "[BEAM-9454] Create Deduplication transform based on user timer/state", "bodyText": "Create a Deduplication PTransform by using user timer/state in python SDK.\nR: @lukecwik @robertwb\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-05T22:31:03Z", "url": "https://github.com/apache/beam/pull/11060", "merged": true, "mergeCommit": {"oid": "cf072345e2d3c4c791e20b59d885b5beade82209"}, "closed": true, "closedAt": "2020-03-31T16:36:53Z", "author": {"login": "boyuanzz"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMIpI-gBqjMxMTI5NzU4NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS2_XIABqjMxODA4NjQ0NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "907221ee65c6ac41d16c7d539f2327869093d096", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/907221ee65c6ac41d16c7d539f2327869093d096", "committedDate": "2020-03-09T22:54:11Z", "message": "Add test"}, "afterCommit": {"oid": "52db933e30d4dd2fd8bdf46e351bcdeda5f0e006", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/52db933e30d4dd2fd8bdf46e351bcdeda5f0e006", "committedDate": "2020-03-10T01:57:05Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjgyMDk1", "url": "https://github.com/apache/beam/pull/11060#pullrequestreview-373682095", "createdAt": "2020-03-12T15:53:38Z", "commit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNjowNTozOVrOF1lD2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNjoyNzo0MlrOF1l8wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNjA0Mg==", "bodyText": "The Python timer API seems primitive compared to the Java SDK\nUse a switch case for the three types:\nDEPENDENT_REAL_TIME\nREAL_TIME\nWATERMARK\nand throw an error otherwise since you won't know what to do.", "url": "https://github.com/apache/beam/pull/11060#discussion_r391726042", "createdAt": "2020-03-12T16:05:39Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      time_domain=userstate.TimeDomain.REAL_TIME,\n+      duration=Duration(10 * 60)):\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True not in seen_state.read():\n+          if domain is userstate.TimeDomain.REAL_TIME:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNzUyOQ==", "bodyText": "I should have used a guard style statement in the Java implementation instead of nesting.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if True not in seen_state.read():\n          \n          \n            \n                      if domain is userstate.TimeDomain.REAL_TIME:\n          \n          \n            \n                        expiry_timer.set(Timestamp.now() + duration)\n          \n          \n            \n                      else:\n          \n          \n            \n                        expiry_timer.set(ts + duration)\n          \n          \n            \n                      seen_state.add(True)\n          \n          \n            \n                      value, _ = element\n          \n          \n            \n                      yield value\n          \n          \n            \n                    if True in seen_state.read():\n          \n          \n            \n                      return\n          \n          \n            \n            \n          \n          \n            \n                    if domain is userstate.TimeDomain.REAL_TIME:\n          \n          \n            \n                      expiry_timer.set(Timestamp.now() + duration)\n          \n          \n            \n                    else:\n          \n          \n            \n                      expiry_timer.set(ts + duration)\n          \n          \n            \n                    seen_state.add(True)\n          \n          \n            \n                    value, _ = element\n          \n          \n            \n                    yield value", "url": "https://github.com/apache/beam/pull/11060#discussion_r391727529", "createdAt": "2020-03-12T16:07:55Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self,\n+      time_domain=userstate.TimeDomain.REAL_TIME,\n+      duration=Duration(10 * 60)):\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True not in seen_state.read():\n+          if domain is userstate.TimeDomain.REAL_TIME:\n+            expiry_timer.set(Timestamp.now() + duration)\n+          else:\n+            expiry_timer.set(ts + duration)\n+          seen_state.add(True)\n+          value, _ = element\n+          yield value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyODYwMg==", "bodyText": "It would be useful to expose a keyed deduplication transform as the common implementation that all use internally so in the future we can turn into a well known URN and then runners could provide optimized deduplication transform implementations.\nWe want pipeline authors to use this transform and I think it should go into sdks/python/apache_beam/transforms/util.py or into a dedicated file such as sdks/python/apache_beam/transforms/ such as deduplicate.py.\nCC: @udim What do you think?", "url": "https://github.com/apache/beam/pull/11060#discussion_r391728602", "createdAt": "2020-03-12T16:09:37Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyOTg1Mg==", "bodyText": "Is test stream unsupported in these other setups?", "url": "https://github.com/apache/beam/pull/11060#discussion_r391729852", "createdAt": "2020-03-12T16:11:33Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -1250,6 +1313,9 @@ def test_sdf_with_sdf_initiated_checkpointing(self):\n   def test_sdf_with_watermark_tracking(self):\n     raise unittest.SkipTest(\"This test is for a single worker only.\")\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    raise unittest.SkipTest(\"This test is for a single worker only.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc0MDYwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              \"\"\" A PTransform which deduplicate input records over a time domain and\n          \n          \n            \n              \"\"\" A PTransform which deduplicates input records over a time domain and", "url": "https://github.com/apache/beam/pull/11060#discussion_r391740608", "createdAt": "2020-03-12T16:27:42Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/sdf_utils.py", "diffHunk": "@@ -244,3 +251,63 @@ def get_estimator_state(self):\n         return None\n \n     return _NoOpWatermarkEstimator()\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicate input records over a time domain and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3657894e8369634fc403a1e444acd4c666915b2d"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8cb05da1ab536eeb7b993b9be44dfacf2a88823", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/d8cb05da1ab536eeb7b993b9be44dfacf2a88823", "committedDate": "2020-03-13T21:16:49Z", "message": "Fixup"}, "afterCommit": {"oid": "c97572c6b41684abc63241f19ed67819f7b6d499", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/c97572c6b41684abc63241f19ed67819f7b6d499", "committedDate": "2020-03-14T02:58:49Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c9760d623a7a8ea21d681038b447558f24e9a07", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6c9760d623a7a8ea21d681038b447558f24e9a07", "committedDate": "2020-03-17T02:17:38Z", "message": "Fix again"}, "afterCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/68c44dc083dea1934294ba71e571dbe97c54e710", "committedDate": "2020-03-17T18:06:38Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDAyNTcy", "url": "https://github.com/apache/beam/pull/11060#pullrequestreview-376402572", "createdAt": "2020-03-17T21:01:53Z", "commit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMTowMTo1M1rOF3t60w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMToyMjo0M1rOF3uisw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODMzOQ==", "bodyText": "fn_api_runner_test primarily for testing primitives. I would put this in apache_beam.transforms.deduplicate_test (or util_test, if that's where we plan to move it).", "url": "https://github.com/apache/beam/pull/11060#discussion_r393968339", "createdAt": "2020-03-17T21:01:53Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2ODg0Ng==", "bodyText": "Generally we've been following the convention of importing modules rather than objects from modules. http://google.github.io/styleguide/pyguide.html#22-imports", "url": "https://github.com/apache/beam/pull/11060#discussion_r393968846", "createdAt": "2020-03-17T21:03:01Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -65,6 +65,7 @@\n from apache_beam.transforms import environments\n from apache_beam.transforms import userstate\n from apache_beam.transforms import window\n+from apache_beam.transforms.deduplicate import DeduplictaionWithinDuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2OTQ2OQ==", "bodyText": "IIRC, the FnApiRunner does respect timestamps. (Not sure about the Create transform though.)", "url": "https://github.com/apache/beam/pull/11060#discussion_r393969469", "createdAt": "2020-03-17T21:04:08Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3MDQ1NA==", "bodyText": "The duplication of value_1 probably merits a comment.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393970454", "createdAt": "2020-03-17T21:06:00Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.\n+    with self.create_pipeline() as p:\n+      inputs = [\n+          window.TimestampedValue('value_1', 1),\n+          window.TimestampedValue('value_1', 2),\n+          window.TimestampedValue('value_1', 3)\n+      ]\n+      actual = (\n+          p\n+          | beam.Create(inputs)\n+          | beam.WindowInto(window.FixedWindows(10))\n+          | DeduplictaionWithinDuration(duration=timestamp.Duration(5)))\n+      assert_that(actual, equal_to(['value_1']))\n+\n+  @unittest.skip('TestStream not yet supported')\n+  def test_deduplication_transform_with_event_time(self):\n+    test_stream = (\n+        TestStream().advance_watermark_to(0).add_elements([\n+            window.TimestampedValue('value_1', 1),\n+            window.TimestampedValue('value_1', 2),\n+            window.TimestampedValue('value_1', 10)\n+        ]).advance_watermark_to(10).add_elements([\n+            window.TimestampedValue('value_1', 6)\n+        ]).add_elements([window.TimestampedValue('value_2', 15)\n+                         ]).advance_watermark_to_infinity())\n+\n+    with self.create_pipeline() as p:\n+      actual = (\n+          p\n+          | test_stream\n+          | DeduplictaionWithinDuration(\n+              duration=timestamp.Duration(10),\n+              time_domain=userstate.TimeDomain.WATERMARK))\n+      assert_that(actual, equal_to(['value_1', 'value_1', 'value_2']))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3Mjc4NA==", "bodyText": "PTransform names are generally verbs. Perhaps just call this Deduplicate. The duration argument would typically be part of the constructor, e.g. Deduplicate(duration=...), so wouldn't need to be repeated in the name.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393972784", "createdAt": "2020-03-17T21:10:37Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NDY3Ng==", "bodyText": "I would make duration a required parameter; I don't think there's a good default we can pick for all pipelines. (This also allows us to have a more intelligent default in the future, e.g. dynamically based on the actual watermark/propagation delay in the pipeline.)\nAlso, is it not possible to have both a real and watermark delay? This API forces you to do one or the other.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393974676", "createdAt": "2020-03-17T21:14:35Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3NjM5OA==", "bodyText": "I would expose a DeduplicatePerKey transform which emits a single KV per key, and then have the generic Deduplicate build on that.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393976398", "createdAt": "2020-03-17T21:18:00Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):\n+    if time_domain not in (TimeDomain.WATERMARK, TimeDomain.REAL_TIME):\n+      raise ValueError(\n+          'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+          'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+          (time_domain, ))\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True in seen_state.read():\n+          return\n+\n+        if domain == TimeDomain.REAL_TIME:\n+          expiry_timer.set(Timestamp.now() + duration)\n+        elif domain == TimeDomain.WATERMARK:\n+          expiry_timer.set(ts + duration)\n+        else:\n+          raise ValueError(\n+              'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+              'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+              (domain, ))\n+        seen_state.add(True)\n+        value, _ = element\n+        yield value\n+\n+      def infer_output_type(self, input_type):\n+        key_type, _ = trivial_inference.key_value_types(input_type)\n+        return key_type\n+\n+      @userstate.on_timer(timer_spec)\n+      def process_timer(self, seen_state=DoFn.StateParam(state_spec)):\n+        seen_state.clear()\n+\n+    return DeduplicationFn()\n+\n+  def expand(self, pcoll):\n+    return (\n+        pcoll\n+        | 'KeyByElement' >> Map(lambda x: (x, None))\n+        | 'DeduplicateFn' >> ParDo(self._create_deduplicate_fn()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3ODMyOA==", "bodyText": "Suppose one has values with timestamps 10, 1, 12, and duration 10. This will not properly deduplicate because the timer will fire at 11 clearing state before 12 gets seen.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393978328", "createdAt": "2020-03-17T21:22:12Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,108 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.core import DoFn\n+from apache_beam.transforms.core import Map\n+from apache_beam.transforms.core import ParDo\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.typehints import trivial_inference\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+__all__ = [\n+    'DeduplictaionWithinDuration',\n+]\n+\n+\n+class DeduplictaionWithinDuration(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates input records over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(\n+      self, time_domain=TimeDomain.REAL_TIME, duration=Duration(10 * 60)):\n+    if time_domain not in (TimeDomain.WATERMARK, TimeDomain.REAL_TIME):\n+      raise ValueError(\n+          'Unsupported TimeDomain: %r. DeduplictaionWithinDuration'\n+          'expects TimeDomain.WATERMARK or TimeDomain.REAL_TIME' %\n+          (time_domain, ))\n+    self.time_domain = time_domain\n+    self.duration = duration\n+\n+  def _create_deduplicate_fn(self):\n+    timer_spec = userstate.TimerSpec('expiry_timer', self.time_domain)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())\n+    duration = self.duration\n+    domain = self.time_domain\n+\n+    class DeduplicationFn(DoFn):\n+      def process(\n+          self,\n+          element,\n+          ts=DoFn.TimestampParam,\n+          seen_state=DoFn.StateParam(state_spec),\n+          expiry_timer=DoFn.TimerParam(timer_spec)):\n+        if True in seen_state.read():\n+          return\n+\n+        if domain == TimeDomain.REAL_TIME:\n+          expiry_timer.set(Timestamp.now() + duration)\n+        elif domain == TimeDomain.WATERMARK:\n+          expiry_timer.set(ts + duration)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk3ODU0Nw==", "bodyText": "It's be a stronger test to add elements one at a time.", "url": "https://github.com/apache/beam/pull/11060#discussion_r393978547", "createdAt": "2020-03-17T21:22:43Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner_test.py", "diffHunk": "@@ -448,6 +449,42 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_deduplication_transform_with_processing_time(self):\n+    # Note that current FnApiRunner doesn't respect either real timestamp.\n+    with self.create_pipeline() as p:\n+      inputs = [\n+          window.TimestampedValue('value_1', 1),\n+          window.TimestampedValue('value_1', 2),\n+          window.TimestampedValue('value_1', 3)\n+      ]\n+      actual = (\n+          p\n+          | beam.Create(inputs)\n+          | beam.WindowInto(window.FixedWindows(10))\n+          | DeduplictaionWithinDuration(duration=timestamp.Duration(5)))\n+      assert_that(actual, equal_to(['value_1']))\n+\n+  @unittest.skip('TestStream not yet supported')\n+  def test_deduplication_transform_with_event_time(self):\n+    test_stream = (\n+        TestStream().advance_watermark_to(0).add_elements([\n+            window.TimestampedValue('value_1', 1),\n+            window.TimestampedValue('value_1', 2),\n+            window.TimestampedValue('value_1', 10)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c44dc083dea1934294ba71e571dbe97c54e710"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "932510705b1e11dc8b4db1e433b6c8eaf98b99dc", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/932510705b1e11dc8b4db1e433b6c8eaf98b99dc", "committedDate": "2020-03-18T01:17:09Z", "message": "Test only. Revert later."}, "afterCommit": {"oid": "6df2be73a464516a3cd6faccd409e38a10856655", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6df2be73a464516a3cd6faccd409e38a10856655", "committedDate": "2020-03-18T18:38:42Z", "message": "Fix lint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2209d9641a6822beb8e661fc2615c883cb762be7", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/2209d9641a6822beb8e661fc2615c883cb762be7", "committedDate": "2020-03-19T04:10:42Z", "message": "fix test"}, "afterCommit": {"oid": "166b8a85f3c5c62aa26f0a53b618977e0f1a2ae9", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/166b8a85f3c5c62aa26f0a53b618977e0f1a2ae9", "committedDate": "2020-03-19T17:51:14Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzE3NzU4", "url": "https://github.com/apache/beam/pull/11060#pullrequestreview-379717758", "createdAt": "2020-03-23T18:41:24Z", "commit": {"oid": "51611d387b547ea8856f8502181c7567f9bba57b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODo0MToyNFrOF6TLcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODo0OTo0NlrOF6TeXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NTk1NA==", "bodyText": "Perhaps this should be a combining state?", "url": "https://github.com/apache/beam/pull/11060#discussion_r396675954", "createdAt": "2020-03-23T18:41:24Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within\n+  a runner and care might need to be used to ensure that the deduplication time\n+  limit is long enough to remove duplicates but short enough to not cause\n+  performance problems within a runner. Each runner may provide an optimized\n+  implementation of their choice using the deduplication time domain and\n+  threshold specified.\n+\n+  Does not preserve any order the input PCollection might have had.\n+  \"\"\"\n+  def __init__(self, processing_time_duration=None, event_time_duration=None):\n+    if processing_time_duration is None and event_time_duration is None:\n+      raise ValueError(\n+          'DeduplicatePerKey requires at lease provide either'\n+          'processing_time_duration or event_time_duration.')\n+    self.processing_time_duration = processing_time_duration\n+    self.event_time_duration = event_time_duration\n+\n+  def _create_deduplicate_fn(self):\n+    processing_timer_spec = userstate.TimerSpec(\n+        'processing_timer', TimeDomain.REAL_TIME)\n+    event_timer_spec = userstate.TimerSpec('event_timer', TimeDomain.WATERMARK)\n+    state_spec = userstate.BagStateSpec('seen', BooleanCoder())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51611d387b547ea8856f8502181c7567f9bba57b"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3NzI1NA==", "bodyText": "Is it not possible to sickbay it for only dataflow?", "url": "https://github.com/apache/beam/pull/11060#discussion_r396677254", "createdAt": "2020-03-23T18:43:37Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate_test.py", "diffHunk": "@@ -0,0 +1,168 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"Unit tests for deduplicate transform by using TestStream.\"\"\"\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+from nose.plugins.attrib import attr\n+\n+import apache_beam as beam\n+from apache_beam.coders import coders\n+from apache_beam.testing.test_pipeline import TestPipeline\n+from apache_beam.testing.test_stream import TestStream\n+from apache_beam.testing.util import assert_that\n+from apache_beam.testing.util import equal_to\n+from apache_beam.testing.util import equal_to_per_window\n+from apache_beam.transforms import deduplicate\n+from apache_beam.transforms import window\n+from apache_beam.utils.timestamp import Duration\n+from apache_beam.utils.timestamp import Timestamp\n+\n+\n+# TestStream is only supported in streaming pipeline. The Deduplicate transform\n+# also requires Timer support. Sickbaying this testsuite until dataflow runner\n+# supports both TestStream and user timer.\n+@attr('ValidatesRunner', 'sickbay-batch', 'sickbay-streaming')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51611d387b547ea8856f8502181c7567f9bba57b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MDYyMg==", "bodyText": "I might phrase this as \"Time durations are required so as to avoid unbounded memory and/or storage requirements on the runner...\"", "url": "https://github.com/apache/beam/pull/11060#discussion_r396680622", "createdAt": "2020-03-23T18:49:25Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.\n+\n+  The durations specified may impose memory and/or storage requirements within", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51611d387b547ea8856f8502181c7567f9bba57b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MDc5OQ==", "bodyText": "It's not really best effort, rather it is only respected within the time domains (and there you can count on it).", "url": "https://github.com/apache/beam/pull/11060#discussion_r396680799", "createdAt": "2020-03-23T18:49:46Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/transforms/deduplicate.py", "diffHunk": "@@ -0,0 +1,133 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+# pytype: skip-file\n+\n+\"\"\"a collection of ptransforms for deduplicating elements.\"\"\"\n+\n+from __future__ import absolute_import\n+from __future__ import division\n+\n+import typing\n+\n+from apache_beam import typehints\n+from apache_beam.coders.coders import BooleanCoder\n+from apache_beam.transforms import core\n+from apache_beam.transforms import ptransform\n+from apache_beam.transforms import userstate\n+from apache_beam.transforms.timeutil import TimeDomain\n+from apache_beam.utils import timestamp\n+\n+__all__ = [\n+    'Deduplicate',\n+    'DeduplicatePerKey',\n+]\n+\n+K = typing.TypeVar('K')\n+V = typing.TypeVar('V')\n+\n+\n+@typehints.with_input_types(typing.Tuple[K, V])\n+@typehints.with_output_types(typing.Tuple[K, V])\n+class DeduplicatePerKey(ptransform.PTransform):\n+  \"\"\" A PTransform which deduplicates <key, value> pair over a time domain and\n+  threshold. Values in different windows will NOT be considered duplicates of\n+  each other. Deduplication is best effort.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51611d387b547ea8856f8502181c7567f9bba57b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjI2NTgz", "url": "https://github.com/apache/beam/pull/11060#pullrequestreview-383226583", "createdAt": "2020-03-27T22:06:51Z", "commit": {"oid": "d686727ac215e7f67282b990e624f207a62c7dd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d686727ac215e7f67282b990e624f207a62c7dd5", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/d686727ac215e7f67282b990e624f207a62c7dd5", "committedDate": "2020-03-23T20:55:40Z", "message": "Update comments."}, "afterCommit": {"oid": "68f436d35ede88ae71b03915e50e16ed3dca4f0c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/68f436d35ede88ae71b03915e50e16ed3dca4f0c", "committedDate": "2020-03-29T00:39:55Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68f436d35ede88ae71b03915e50e16ed3dca4f0c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/68f436d35ede88ae71b03915e50e16ed3dca4f0c", "committedDate": "2020-03-29T00:39:55Z", "message": "[BEAM-9454] Add Deduplication PTransform"}, "afterCommit": {"oid": "67b0807623b0e38433f9326b06d37a6b4e3505ff", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/67b0807623b0e38433f9326b06d37a6b4e3505ff", "committedDate": "2020-03-29T03:22:42Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67b0807623b0e38433f9326b06d37a6b4e3505ff", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/67b0807623b0e38433f9326b06d37a6b4e3505ff", "committedDate": "2020-03-29T03:22:42Z", "message": "[BEAM-9454] Add Deduplication PTransform"}, "afterCommit": {"oid": "f5c82ef811852f3b5735fce527a1ea5baaf49a46", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/f5c82ef811852f3b5735fce527a1ea5baaf49a46", "committedDate": "2020-03-29T03:28:07Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5c82ef811852f3b5735fce527a1ea5baaf49a46", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/f5c82ef811852f3b5735fce527a1ea5baaf49a46", "committedDate": "2020-03-29T03:28:07Z", "message": "[BEAM-9454] Add Deduplication PTransform"}, "afterCommit": {"oid": "21dc0072b36115cc5d596ae2079d13fa45be6ec0", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/21dc0072b36115cc5d596ae2079d13fa45be6ec0", "committedDate": "2020-03-30T22:14:23Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "committedDate": "2020-03-30T23:20:35Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21dc0072b36115cc5d596ae2079d13fa45be6ec0", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/21dc0072b36115cc5d596ae2079d13fa45be6ec0", "committedDate": "2020-03-30T22:14:23Z", "message": "[BEAM-9454] Add Deduplication PTransform"}, "afterCommit": {"oid": "203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/203efbdaadbc3576e60bf66eb2b19a18ed886e3f", "committedDate": "2020-03-30T23:20:35Z", "message": "[BEAM-9454] Add Deduplication PTransform"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3061, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}