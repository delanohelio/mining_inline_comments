{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMzQ1MDEx", "number": 13483, "title": "[BEAM-11800] Support ARRAY_AGG fn for Zetasql dialect", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-12-04T07:19:25Z", "url": "https://github.com/apache/beam/pull/13483", "merged": true, "mergeCommit": {"oid": "31e1b84d46b0564192f1c678972d195f2f2ea840"}, "closed": true, "closedAt": "2021-02-19T21:08:22Z", "author": {"login": "sonam-vend"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkRjjsAFqTU0NzY3MTc0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd7wfJjAFqTU5NDU3ODEzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjcxNzQ2", "url": "https://github.com/apache/beam/pull/13483#pullrequestreview-547671746", "createdAt": "2020-12-08T22:05:43Z", "commit": {"oid": "5216b44cab5042b9c55db6bb6bc3a2ec956f2957"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowNTo0M1rOIB4VpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjowNTo0M1rOIB4VpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0MjUzMg==", "bodyText": "I think here we expect schema:\nSchema schema = Schema.builder().addArrayField(\"array_field\", FieldType.of(FieldType.INT64)).build();\n\nmeaning it is an \"array of int64\"", "url": "https://github.com/apache/beam/pull/13483#discussion_r538842532", "createdAt": "2020-12-08T22:05:43Z", "author": {"login": "robinyqiu"}, "path": "sdks/java/extensions/sql/zetasql/src/test/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSqlDialectSpecTest.java", "diffHunk": "@@ -4067,4 +4060,21 @@ public void testSimpleTableName() {\n             Row.withSchema(singleField).addValues(15L).build());\n     pipeline.run().waitUntilFinish(Duration.standardMinutes(PIPELINE_EXECUTION_WAITTIME_MINUTES));\n   }\n+\n+  @Test\n+  public void testArrayAggregation() {\n+    String sql =\n+            \"SELECT ARRAY_AGG(x) AS array_agg\\n\" +\n+                    \"FROM UNNEST([2, 1, -2, 3, -2, 1, 2]) AS x\";\n+\n+    ZetaSQLQueryPlanner zetaSQLQueryPlanner = new ZetaSQLQueryPlanner(config);\n+    BeamRelNode beamRelNode = zetaSQLQueryPlanner.convertToBeamRel(sql);\n+    PCollection<Row> stream = BeamSqlRelUtils.toPCollection(pipeline, beamRelNode);\n+\n+    Schema schema = Schema.builder().addArrayField(\"array_field\", FieldType.of(Schema.TypeName.ARRAY)).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5216b44cab5042b9c55db6bb6bc3a2ec956f2957"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjgwMDMx", "url": "https://github.com/apache/beam/pull/13483#pullrequestreview-547680031", "createdAt": "2020-12-08T22:18:11Z", "commit": {"oid": "5216b44cab5042b9c55db6bb6bc3a2ec956f2957"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxODoxMVrOIB4yqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxODoxMVrOIB4yqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTk2MA==", "bodyText": "Here you simply created an array type without specifying the element type. I guess that's why the error message says the \"inferred type is ARRAY NOT NULL\" (just array type, your can ignore the \"NOT NULL\" suffix), where it should be \"BIGINT NOT NULL ARRAY NOT NULL\" (array of bigint).\nTo create an array type with element type specified, you may want to use createTypeFactory().createArrayType(), like here: https://github.com/robinyqiu/beam/blob/cbe87445d4259b6b485bc010231dda1895022d83/sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/ZetaSqlCalciteTranslationUtils.java#L170", "url": "https://github.com/apache/beam/pull/13483#discussion_r538849960", "createdAt": "2020-12-08T22:18:11Z", "author": {"login": "robinyqiu"}, "path": "sdks/java/extensions/sql/zetasql/src/main/java/org/apache/beam/sdk/extensions/sql/zetasql/translation/SqlOperators.java", "diffHunk": "@@ -81,6 +72,12 @@\n           x -> createTypeFactory().createSqlType(SqlTypeName.VARCHAR),\n           new UdafImpl<>(new StringAgg.StringAggString()));\n \n+  public static final SqlOperator ARR_AGG_ARR_FN =\n+          createUdafOperator(\n+                  \"array_agg\",\n+                  x -> createTypeFactory().createSqlType(SqlTypeName.ARRAY),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5216b44cab5042b9c55db6bb6bc3a2ec956f2957"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9903af960d97ada08e00a6cf35e33d13f64f210", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/b9903af960d97ada08e00a6cf35e33d13f64f210", "committedDate": "2021-02-12T08:36:00Z", "message": "Implemeted ARRAY_AGG fn for Zetasql dialect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eebf131d48ea11708c817031783938b64b4b36cb", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/eebf131d48ea11708c817031783938b64b4b36cb", "committedDate": "2021-02-12T08:36:06Z", "message": "savning current dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98fb3b4a05634652e176da1d3a3edd022fe2ae49", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/98fb3b4a05634652e176da1d3a3edd022fe2ae49", "committedDate": "2021-02-12T08:36:06Z", "message": "Modified implementation of array_Agg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd26f61524c165a2440718a49029e7f0f203ee8c", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/dd26f61524c165a2440718a49029e7f0f203ee8c", "committedDate": "2021-02-12T10:35:46Z", "message": "draft implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be5c1a6eff47a56c62788e1ed74079e7542aa029", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/be5c1a6eff47a56c62788e1ed74079e7542aa029", "committedDate": "2020-12-15T18:09:52Z", "message": "Removed unused relDataType"}, "afterCommit": {"oid": "dd26f61524c165a2440718a49029e7f0f203ee8c", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/dd26f61524c165a2440718a49029e7f0f203ee8c", "committedDate": "2021-02-12T10:35:46Z", "message": "draft implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc09191ca9fafd3f82173a75e4d720e0417514fb", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/cc09191ca9fafd3f82173a75e4d720e0417514fb", "committedDate": "2021-02-17T06:00:31Z", "message": "a fix in the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f3bba96468ab49b98924dcdc1cc7718b005410", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/03f3bba96468ab49b98924dcdc1cc7718b005410", "committedDate": "2021-02-17T06:14:37Z", "message": "renamed test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkzNzI1MDQ3", "url": "https://github.com/apache/beam/pull/13483#pullrequestreview-593725047", "createdAt": "2021-02-18T23:02:44Z", "commit": {"oid": "03f3bba96468ab49b98924dcdc1cc7718b005410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQyMzowMjo0NFrOIn_pGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQyMzowMjo0NFrOIn_pGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODgwODA5MA==", "bodyText": "The Beam ARRAY type expect the data to be a Collection type, not Object[] type (i.e Beam ARRAY != Java array). That's why you get the error during cast. The fix should be simple: change the return type of this function to list (also the third class generic parameter).", "url": "https://github.com/apache/beam/pull/13483#discussion_r578808090", "createdAt": "2021-02-18T23:02:44Z", "author": {"login": "robinyqiu"}, "path": "sdks/java/extensions/sql/src/main/java/org/apache/beam/sdk/extensions/sql/impl/udaf/ArrayAgg.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.extensions.sql.impl.udaf;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.beam.sdk.transforms.Combine;\n+\n+public class ArrayAgg {\n+\n+  public static class ArrayAggArray extends Combine.CombineFn<Object, List<Object>, Object[]> {\n+    @Override\n+    public List<Object> createAccumulator() {\n+      return new ArrayList<>();\n+    }\n+\n+    @Override\n+    public List<Object> addInput(List<Object> accum, Object input) {\n+      accum.add(input);\n+      return accum;\n+    }\n+\n+    @Override\n+    public List<Object> mergeAccumulators(Iterable<List<Object>> accums) {\n+      List<Object> merged = new ArrayList<>();\n+      for (List<Object> accum : accums) {\n+        for (Object o : accum) {\n+          merged.add(o);\n+        }\n+      }\n+      return merged;\n+    }\n+\n+    @Override\n+    public Object[] extractOutput(List<Object> accumulator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f3bba96468ab49b98924dcdc1cc7718b005410"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "161811df8def52c94e285076d19fc36173ee3fd6", "author": {"user": {"login": "sonam-vend", "name": "Sonam Ramchand"}}, "url": "https://github.com/apache/beam/commit/161811df8def52c94e285076d19fc36173ee3fd6", "committedDate": "2021-02-19T09:26:36Z", "message": "fixed return type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk0NTc4MTM1", "url": "https://github.com/apache/beam/pull/13483#pullrequestreview-594578135", "createdAt": "2021-02-19T21:08:14Z", "commit": {"oid": "161811df8def52c94e285076d19fc36173ee3fd6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4312, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}