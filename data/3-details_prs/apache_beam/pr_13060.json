{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNjg4MTkx", "number": 13060, "title": "[BEAM-7746] Fix typing in runners", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-09T16:06:34Z", "url": "https://github.com/apache/beam/pull/13060", "merged": true, "mergeCommit": {"oid": "5156634d465ccfd3a36beefddaf660689c79feaa"}, "closed": true, "closedAt": "2020-10-22T02:41:02Z", "author": {"login": "chadrik"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS1ZHAABqjM4ODI4MTY2NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUJdzQgBqjM4OTUxOTQyNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0cdcd1ab72a4c24cdc0d2d2ce258a271f5546cf", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/b0cdcd1ab72a4c24cdc0d2d2ce258a271f5546cf", "committedDate": "2020-10-06T20:28:43Z", "message": "[BEAM-7746] Fix typing in runners"}, "afterCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/d5b67e4303908a0ce85763e082c4da3105e8c52d", "committedDate": "2020-10-15T17:40:03Z", "message": "[BEAM-7746] Fix typing in runners"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjIyNDcw", "url": "https://github.com/apache/beam/pull/13060#pullrequestreview-509622470", "createdAt": "2020-10-15T17:43:56Z", "commit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0Mzo1N1rOHiTDCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0Mzo1N1rOHiTDCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTcwNw==", "bodyText": "I changed this import because profiler was conflicting with some local variable names, and this was the simplest resolution.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505725707", "createdAt": "2020-10-15T17:43:57Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -62,13 +64,15 @@\n from apache_beam.runners.portability.fn_api_runner.translations import only_element\n from apache_beam.runners.portability.fn_api_runner.worker_handlers import WorkerHandlerManager\n from apache_beam.transforms import environments\n-from apache_beam.utils import profiler\n from apache_beam.utils import proto_utils\n from apache_beam.utils import thread_pool_executor\n+from apache_beam.utils.profiler import Profile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjIyNzcy", "url": "https://github.com/apache/beam/pull/13060#pullrequestreview-509622772", "createdAt": "2020-10-15T17:44:20Z", "commit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0NDoyMFrOHiTEAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0ODoyN1rOHiTNWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTk1Mg==", "bodyText": "Can I safely get rid of this attribute?", "url": "https://github.com/apache/beam/pull/13060#discussion_r505725952", "createdAt": "2020-10-15T17:44:20Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -539,6 +548,7 @@ def merge_results(last_result):\n       else:\n         data_input = deferred_inputs\n         input_timers = fired_timers\n+        # FIXME: this seems unused, and produces an attr-defined error\n         bundle_manager._registered = True", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjI3MA==", "bodyText": "We discussed this before and you said this was safe, but just wanted to double check.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505726270", "createdAt": "2020-10-15T17:44:51Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -307,6 +308,9 @@ def executable_stage_transform(\n           for side in side_inputs\n       },\n                           main_input=main_input_id)\n+      # at this point we should have resolved an environment, as the key of\n+      # components.environments cannot be None.\n+      assert self.environment is not None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyODM0NQ==", "bodyText": "I decided to change this to pass in self.profile_location because in this context, where it's called, we know that it's not None.  Let's us avoid calling assert inside self._upload_profile_data", "url": "https://github.com/apache/beam/pull/13060#discussion_r505728345", "createdAt": "2020-10-15T17:48:27Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/utils/profiler.py", "diffHunk": "@@ -113,7 +116,10 @@ def __exit__(self, *args):\n           h = self.hpy.heap()\n           heap_dump_data = '%s\\n%s' % (h, h.more)\n           self._upload_profile_data(\n-              'memory_profile', heap_dump_data, write_binary=False)\n+              self.profile_location,\n+              'memory_profile',\n+              heap_dump_data,\n+              write_binary=False)\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTEwOTA0", "url": "https://github.com/apache/beam/pull/13060#pullrequestreview-509910904", "createdAt": "2020-10-16T00:11:41Z", "commit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxMTo0MlrOHifrIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxMTo0MlrOHifrIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMjU3Nw==", "bodyText": "note to self:  standardize on PartitionableBuffer vs execution.PartitionableBuffer", "url": "https://github.com/apache/beam/pull/13060#discussion_r505932577", "createdAt": "2020-10-16T00:11:42Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -355,9 +361,9 @@ def _run_bundle_multiple_times_for_testing(\n       self,\n       runner_execution_context,  # type: execution.FnApiRunnerExecutionContext\n       bundle_manager,  # type: BundleManager\n-      data_input,\n+      data_input,  # type: Dict[str, PartitionableBuffer]\n       data_output,  # type: DataOutput\n-      fired_timers,\n+      fired_timers,  # type: Mapping[Tuple[str, str], execution.PartitionableBuffer]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTEyNjE4", "url": "https://github.com/apache/beam/pull/13060#pullrequestreview-509912618", "createdAt": "2020-10-16T00:14:02Z", "commit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxNDowMlrOHiftTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDoxNDowMlrOHiftTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMzEzNA==", "bodyText": "It would be good to get confirmation that this assert is correct.  AFAICT this method should never return None.", "url": "https://github.com/apache/beam/pull/13060#discussion_r505933134", "createdAt": "2020-10-16T00:14:02Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/worker_handlers.py", "diffHunk": "@@ -1062,34 +1104,41 @@ def close(self):\n \n \n class ControlFuture(object):\n-  def __init__(self, instruction_id, response=None):\n+  def __init__(self,\n+               instruction_id,  # type: str\n+               response=None  # type: Optional[beam_fn_api_pb2.InstructionResponse]\n+              ):\n+    # type: (...) -> None\n     self.instruction_id = instruction_id\n-    if response:\n-      self._response = response\n-    else:\n-      self._response = None\n+    self._response = response\n+    if response is None:\n       self._condition = threading.Condition()\n-    self._exception = None\n+    self._exception = None  # type: Optional[Exception]\n \n   def is_done(self):\n+    # type: () -> bool\n     return self._response is not None\n \n   def set(self, response):\n+    # type: (beam_fn_api_pb2.InstructionResponse) -> None\n     with self._condition:\n       self._response = response\n       self._condition.notify_all()\n \n   def get(self, timeout=None):\n+    # type: (Optional[float]) -> beam_fn_api_pb2.InstructionResponse\n     if not self._response and not self._exception:\n       with self._condition:\n         if not self._response and not self._exception:\n           self._condition.wait(timeout)\n     if self._exception:\n       raise self._exception\n     else:\n+      assert self._response is not None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 479}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODMwMjgw", "url": "https://github.com/apache/beam/pull/13060#pullrequestreview-510830280", "createdAt": "2020-10-16T22:27:43Z", "commit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjoyNzo0M1rOHjRaIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjozNjoyN1rOHjRizg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NzQyNA==", "bodyText": "How about making them raise errors rather than be no-ops?", "url": "https://github.com/apache/beam/pull/13060#discussion_r506747424", "createdAt": "2020-10-16T22:27:43Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/execution.py", "diffHunk": "@@ -227,12 +251,24 @@ def __iter__(self):\n     \"\"\"\n     return itertools.chain(*self.partition(1))\n \n+  # these should never be accessed, but they allow this class to meet the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0ODExMg==", "bodyText": "Yes, this should not be needed anymore.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506748112", "createdAt": "2020-10-16T22:30:25Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -539,6 +548,7 @@ def merge_results(last_result):\n       else:\n         data_input = deferred_inputs\n         input_timers = fired_timers\n+        # FIXME: this seems unused, and produces an attr-defined error\n         bundle_manager._registered = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTk1Mg=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0ODU0Ng==", "bodyText": "Yes, that looks safe.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506748546", "createdAt": "2020-10-16T22:32:01Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -307,6 +308,9 @@ def executable_stage_transform(\n           for side in side_inputs\n       },\n                           main_input=main_input_id)\n+      # at this point we should have resolved an environment, as the key of\n+      # components.environments cannot be None.\n+      assert self.environment is not None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjI3MA=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0OTY0Ng==", "bodyText": "Correct, either an exception will be thrown, a timeout will be thrown, or the response is non-None.", "url": "https://github.com/apache/beam/pull/13060#discussion_r506749646", "createdAt": "2020-10-16T22:36:27Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/worker_handlers.py", "diffHunk": "@@ -1062,34 +1104,41 @@ def close(self):\n \n \n class ControlFuture(object):\n-  def __init__(self, instruction_id, response=None):\n+  def __init__(self,\n+               instruction_id,  # type: str\n+               response=None  # type: Optional[beam_fn_api_pb2.InstructionResponse]\n+              ):\n+    # type: (...) -> None\n     self.instruction_id = instruction_id\n-    if response:\n-      self._response = response\n-    else:\n-      self._response = None\n+    self._response = response\n+    if response is None:\n       self._condition = threading.Condition()\n-    self._exception = None\n+    self._exception = None  # type: Optional[Exception]\n \n   def is_done(self):\n+    # type: () -> bool\n     return self._response is not None\n \n   def set(self, response):\n+    # type: (beam_fn_api_pb2.InstructionResponse) -> None\n     with self._condition:\n       self._response = response\n       self._condition.notify_all()\n \n   def get(self, timeout=None):\n+    # type: (Optional[float]) -> beam_fn_api_pb2.InstructionResponse\n     if not self._response and not self._exception:\n       with self._condition:\n         if not self._response and not self._exception:\n           self._condition.wait(timeout)\n     if self._exception:\n       raise self._exception\n     else:\n+      assert self._response is not None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMzEzNA=="}, "originalCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d"}, "originalPosition": 479}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5b67e4303908a0ce85763e082c4da3105e8c52d", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/d5b67e4303908a0ce85763e082c4da3105e8c52d", "committedDate": "2020-10-15T17:40:03Z", "message": "[BEAM-7746] Fix typing in runners"}, "afterCommit": {"oid": "f3af4275cfef9a3bfab479abae490d0e5bbd6cc5", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/f3af4275cfef9a3bfab479abae490d0e5bbd6cc5", "committedDate": "2020-10-17T01:30:43Z", "message": "[BEAM-7746] Fix typing in runners"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3af4275cfef9a3bfab479abae490d0e5bbd6cc5", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/f3af4275cfef9a3bfab479abae490d0e5bbd6cc5", "committedDate": "2020-10-17T01:30:43Z", "message": "[BEAM-7746] Fix typing in runners"}, "afterCommit": {"oid": "ff2626266d299064407bf54c532743ce2c11db2b", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/ff2626266d299064407bf54c532743ce2c11db2b", "committedDate": "2020-10-19T18:38:26Z", "message": "[BEAM-7746] Fix typing in runners"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95e2374c659ba9e7fbe42ac217c0b367120b6ee1", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/95e2374c659ba9e7fbe42ac217c0b367120b6ee1", "committedDate": "2020-10-19T19:06:33Z", "message": "[BEAM-7746] Fix typing in runners"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff2626266d299064407bf54c532743ce2c11db2b", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/ff2626266d299064407bf54c532743ce2c11db2b", "committedDate": "2020-10-19T18:38:26Z", "message": "[BEAM-7746] Fix typing in runners"}, "afterCommit": {"oid": "95e2374c659ba9e7fbe42ac217c0b367120b6ee1", "author": {"user": {"login": "chadrik", "name": "Chad Dombrova"}}, "url": "https://github.com/apache/beam/commit/95e2374c659ba9e7fbe42ac217c0b367120b6ee1", "committedDate": "2020-10-19T19:06:33Z", "message": "[BEAM-7746] Fix typing in runners"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2379, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}