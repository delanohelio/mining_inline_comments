{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMTE0MTg5", "number": 11355, "title": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-08T22:35:17Z", "url": "https://github.com/apache/beam/pull/11355", "merged": true, "mergeCommit": {"oid": "cc42ab8f2faad5971d3df630e669e02641d2a0fb"}, "closed": true, "closedAt": "2020-04-10T00:13:11Z", "author": {"login": "y1chi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVwuP3gBqjMyMTYyMzY4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWFHUSAH2gAyNDAxMTE0MTg5OmY0MjdiNWYzNmUyYWZiYTE4MTlhOTcxOThjYTE3NTcxMWIxYmYwNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "151292d182a4174a0ef1227e8fe2f97d36f1f414", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/151292d182a4174a0ef1227e8fe2f97d36f1f414", "committedDate": "2020-04-08T22:32:40Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}, "afterCommit": {"oid": "194373d147dfdeb5cc871590d7769a2b6c933df2", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/194373d147dfdeb5cc871590d7769a2b6c933df2", "committedDate": "2020-04-08T23:44:20Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "194373d147dfdeb5cc871590d7769a2b6c933df2", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/194373d147dfdeb5cc871590d7769a2b6c933df2", "committedDate": "2020-04-08T23:44:20Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}, "afterCommit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "committedDate": "2020-04-08T23:46:32Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDA2ODM3", "url": "https://github.com/apache/beam/pull/11355#pullrequestreview-390406837", "createdAt": "2020-04-08T23:54:18Z", "commit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo1NDoxOFrOGDE8mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo1NjozMFrOGDE_Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3OTk2Mw==", "bodyText": "Debug options have has convenience method for lookup and adding experiments. We can use those instead of raw list.", "url": "https://github.com/apache/beam/pull/11355#discussion_r405879963", "createdAt": "2020-04-08T23:54:18Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDA4MA==", "bodyText": "@pabloem Do we need to add BQ option here as well?", "url": "https://github.com/apache/beam/pull/11355#discussion_r405880080", "createdAt": "2020-04-08T23:54:44Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []\n+    if 'use_runner_v2' in experiments:\n+      if not 'beam_fn_api' in experiments:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDYwMg==", "bodyText": "We have a method apiclient.use_unified_worker. We can use that instead of checking it explicitly.\nAlso, we can simplify/remove that method if we sanitize the options here.", "url": "https://github.com/apache/beam/pull/11355#discussion_r405880602", "createdAt": "2020-04-08T23:56:30Z", "author": {"login": "angoenka"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -566,6 +572,17 @@ def run_pipeline(self, pipeline, options):\n     result.metric_results = self._metrics\n     return result\n \n+  def _maybe_add_unified_worker_missing_options(self, options):\n+    # set default beam_fn_api and use_unified_worker experiment if\n+    # 'use_runner_v2' experiment flag exists, no-op otherwise.\n+    experiments = options.view_as(DebugOptions).experiments or []\n+    if 'use_runner_v2' in experiments:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/0ece19a3cfe0697aa7a5d2ba02487cf91d9245d6", "committedDate": "2020-04-08T23:46:32Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}, "afterCommit": {"oid": "1608cfa90d4e167a4433c08f02c41f7d964350ab", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/1608cfa90d4e167a4433c08f02c41f7d964350ab", "committedDate": "2020-04-09T18:48:05Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd2302d034defb56019715f3f7b64a94e95e7add", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/bd2302d034defb56019715f3f7b64a94e95e7add", "committedDate": "2020-04-09T18:51:19Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1608cfa90d4e167a4433c08f02c41f7d964350ab", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/1608cfa90d4e167a4433c08f02c41f7d964350ab", "committedDate": "2020-04-09T18:48:05Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}, "afterCommit": {"oid": "bd2302d034defb56019715f3f7b64a94e95e7add", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/bd2302d034defb56019715f3f7b64a94e95e7add", "committedDate": "2020-04-09T18:51:19Z", "message": "[BEAM-9727] Automatically set required experiment flags for dataflow runner v2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23538f3f7654ff875352d5e5588015b139a8d162", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/23538f3f7654ff875352d5e5588015b139a8d162", "committedDate": "2020-04-09T18:54:58Z", "message": "Minor doc fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4", "committedDate": "2020-04-09T20:09:23Z", "message": "Add bq sink experiment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTA2MDEx", "url": "https://github.com/apache/beam/pull/11355#pullrequestreview-391106011", "createdAt": "2020-04-09T20:23:24Z", "commit": {"oid": "d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyMzoyNFrOGDoGNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyMzoyNFrOGDoGNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTg2Mg==", "bodyText": "formatting issue", "url": "https://github.com/apache/beam/pull/11355#discussion_r406455862", "createdAt": "2020-04-09T20:23:24Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/dataflow/internal/apiclient.py", "diffHunk": "@@ -1014,16 +1014,13 @@ def _use_fnapi(pipeline_options):\n \n \n def _use_unified_worker(pipeline_options):\n-  if not _use_fnapi(pipeline_options):\n-    return False\n   debug_options = pipeline_options.view_as(DebugOptions)\n   use_unified_worker_flag = 'use_unified_worker'\n+  use_runner_v2_flag = 'use_runner_v2'\n \n-  if debug_options.lookup_experiment(use_unified_worker_flag):\n-    return debug_options.lookup_experiment(use_unified_worker_flag)\n-\n-  if debug_options.lookup_experiment('use_runner_v2'):\n-    debug_options.add_experiment(use_unified_worker_flag)\n+  if (debug_options.lookup_experiment(use_runner_v2_flag) and not\n+  debug_options.lookup_experiment(use_unified_worker_flag)):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d40ae9a097f5beb3a01d8ab3df7bf602b1b5bcd4"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ff8428187c8551742f717849a3d00119f914f4", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/23ff8428187c8551742f717849a3d00119f914f4", "committedDate": "2020-04-09T20:29:10Z", "message": "Fix lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTc0Mjgx", "url": "https://github.com/apache/beam/pull/11355#pullrequestreview-391174281", "createdAt": "2020-04-09T22:31:56Z", "commit": {"oid": "23ff8428187c8551742f717849a3d00119f914f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f427b5f36e2afba1819a97198ca175711b1bf077", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/f427b5f36e2afba1819a97198ca175711b1bf077", "committedDate": "2020-04-09T23:29:56Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4545, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}