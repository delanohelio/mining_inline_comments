{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzE3NDI0", "number": 12927, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1OTowNFrOEoLYaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzowMDoyMFrOEoLcWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTY0OTY4OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/io/avroio.py", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1OTowNFrOHZHgvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxOToxNToxOFrOHbXsJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg==", "bodyText": "What is the context for this change (do you by chance have a pertaining fastavro commit that changes this behavior)?", "url": "https://github.com/apache/beam/pull/12927#discussion_r496099516", "createdAt": "2020-09-28T16:59:04Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcxMjM1OQ==", "bodyText": "It turned out this change is unnecessary -- I'll remove it then.\nThe problem was with pyenv and Python interpreter on my machine. It lacked libpython.so. As a result, I couldn't import cythonized code. Instead, a pure Python version, _write_py.py, was being used: https://github.com/fastavro/fastavro/blob/master/fastavro/write.py#L3. That pure Python version has some differences, but most importantly, the Writer class doesn't set self.fo field:\nhttps://github.com/fastavro/fastavro/blob/master/fastavro/_write_py.py#L411 (pure Python)\nvs.\nhttps://github.com/fastavro/fastavro/blob/master/fastavro/_write.pyx#L559 (cython)\nI wrongly assumed it was the fault of updating the package.", "url": "https://github.com/apache/beam/pull/12927#discussion_r496712359", "createdAt": "2020-09-29T13:23:30Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MjcwMQ==", "bodyText": "Actually, it is a change in 0.22.0: fastavro/fastavro@6c55c31#diff-96a4a8649900b3ff9f22a57de25baca4R498\nhttps://github.com/fastavro/fastavro/blob/f468264b0f86661f1893c8b32bc592fb44e39c75/ChangeLog#L91\nCython is an optional dependency in Beam, so we should not have to rely on presence of cython.\nIt seems strange that fastavro public api is now different in cythonized and non-cythonized version. Are you interested in reaching out to fastavro folks to clarify whether this is something they want to fix?\nWe explicitly close the filehandle due to: https://issues.apache.org/jira/browse/BEAM-7747. Perhaps there is a better way?", "url": "https://github.com/apache/beam/pull/12927#discussion_r497092701", "createdAt": "2020-09-29T22:17:00Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5NjMzMQ==", "bodyText": "Asked on fastavro/fastavro#343 (comment)", "url": "https://github.com/apache/beam/pull/12927#discussion_r497096331", "createdAt": "2020-09-29T22:26:07Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyMDU2NA==", "bodyText": "Thanks. We've already got an answer, let's wait until we know if it's possible for the fo attribute to become available.", "url": "https://github.com/apache/beam/pull/12927#discussion_r497520564", "createdAt": "2020-09-30T13:44:18Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzMDc4MA==", "bodyText": "Let's do the following:\n\n\nFile a JIRA for this issue, mention in the Jira the error message that you observed. Let's mention in the JIRA  the workaround (install cython or downgrade fastavro to 0.21.24) in case users discover this error.\n\n\nAdd a workaround in code:\n\n\ntry:\n  writer.fo.close()\nexcept AttributeError:\n  # We can clean this up after fastavro lower bound includes  a fix for https://github.com/fastavro/fastavro/issues/472.\n  writer.encoder.close()\n\n\nTest that the workaround works.\n\nThanks for spotting this.  How did you catch it by the way? Was it a unit test failure that occurred locally? I wonder why our non-cython test suite does not catch it.", "url": "https://github.com/apache/beam/pull/12927#discussion_r497830780", "createdAt": "2020-09-30T22:13:41Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxNzU5OA==", "bodyText": "Was it a unit test failure that occurred locally?\n\nYes.\n\nI wonder why our non-cython test suite does not catch it.\n\nI think it doesn't really depend on whether cython is installed or not. pip install fastavro downloads a wheel built on the specific platform, which already contains libraries that can be imported. For example, on my Linux machine:\npip install --force-reinstall fastavro==0.23.6\n\nCollecting fastavro==0.23.6\n  Using cached fastavro-0.23.6-cp37-cp37m-manylinux2010_x86_64.whl (1.4 MB)\n\nls site-packages/fastavro | grep write \n\njson_write.py\n_logical_writers.cpython-37m-x86_64-linux-gnu.so\nlogical_writers.py\n_logical_writers_py.py\n_write.cpython-37m-x86_64-linux-gnu.so   <-- this is the library I'm talking about\nwrite.py\n_write_py.py\n\nI'm pretty sure the same happens on Jenkins and on our users' machines. So how did I catch the bug? That .so library links with libpython3.x.so:\nldd site-packages/fastavro/_write.cpython-37m-x86_64-linux-gnu.so\n\nlinux-vdso.so.1 (0x00007ffd7abf7000)\nlibpython3.7m.so.1.0 => not found\nlibc.so.6 => /lib64/libc.so.6 (0x00007f8c548e3000)\n/lib64/ld-linux-x86-64.so.2 (0x00007f8c54d07000)\n\nwhich I didn't have on my machine due to misconfiguration (I already know it's pyenv fault, but this is a different story). That's why the first import statement failed, ImportError was raised, and pure Python version was used instead.\nTo sum up, it is a problem, but the chances that someone will encounter this are pretty low. Anyway, I think it still makes sense to file a JIRA and test the workaround that you proposed.", "url": "https://github.com/apache/beam/pull/12927#discussion_r498217598", "createdAt": "2020-10-01T12:49:15Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2MTczMg==", "bodyText": "Ah that's right. Cython presence only matters if  we are  installing fastavro from sources.", "url": "https://github.com/apache/beam/pull/12927#discussion_r498461732", "createdAt": "2020-10-01T19:15:18Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/io/avroio.py", "diffHunk": "@@ -627,11 +627,19 @@ def write_record(self, writer, value):\n     writer.append(value)\n \n \n+class _FastAvroWriter(Writer):\n+  \"\"\"An adapter class which exposes a file handle so that it can be closed\n+  by the sink. \"\"\"\n+  def __init__(self, file_handle, schema, codec):\n+    super(_FastAvroWriter, self).__init__(file_handle, schema, codec)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5OTUxNg=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTY1OTc4OnYy", "diffSide": "RIGHT", "path": "sdks/python/setup.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzowMDoyMFrOHZHmKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMjoxODo0MVrOHZqTIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwMDkwNA==", "bodyText": "Do we need to increase the lower bound (is the change not compatible with earlier fastavro releases)?", "url": "https://github.com/apache/beam/pull/12927#discussion_r496100904", "createdAt": "2020-09-28T17:00:20Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/setup.py", "diffHunk": "@@ -141,7 +141,7 @@ def get_version():\n     # server, therefore list of allowed versions is very narrow.\n     # See: https://github.com/uqfoundation/dill/issues/341.\n     'dill>=0.3.1.1,<0.3.2',\n-    'fastavro>=0.21.4,<0.24',\n+    'fastavro>=1.0.0,<2',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY2OTQ3Mw==", "bodyText": "Not really. I'll restore the previous bound", "url": "https://github.com/apache/beam/pull/12927#discussion_r496669473", "createdAt": "2020-09-29T12:18:41Z", "author": {"login": "kamilwu"}, "path": "sdks/python/setup.py", "diffHunk": "@@ -141,7 +141,7 @@ def get_version():\n     # server, therefore list of allowed versions is very narrow.\n     # See: https://github.com/uqfoundation/dill/issues/341.\n     'dill>=0.3.1.1,<0.3.2',\n-    'fastavro>=0.21.4,<0.24',\n+    'fastavro>=1.0.0,<2',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEwMDkwNA=="}, "originalCommit": {"oid": "bf6cc32d547dff03c0c2d9f8395da8eb1257b6b9"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3237, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}