{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0ODUxMjQz", "number": 13395, "title": "[BEAM-11426] Add FHIR Search to io/gcp/healthcare/FhirIO", "bodyText": "Add FHIR Search to io/gcp/healthcare/FhirIO\nR: @lastomato\nR: @pabloem\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-20T17:27:57Z", "url": "https://github.com/apache/beam/pull/13395", "merged": true, "mergeCommit": {"oid": "5caeb5d4ad571243a878f75b6720e19472a38540"}, "closed": true, "closedAt": "2020-12-08T23:04:12Z", "author": {"login": "janeliulwq"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeQjKVgH2gAyNTI0ODUxMjQzOjM3ZjExMzRhZTVjOTYwMTYwMzY0NDIwNjJlZDBlYzVhN2U2ZWRjYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkQoTsgH2gAyNTI0ODUxMjQzOjk1OGFiMDkxMzJiMWY5M2Y2NWU5MjVmMjE3YzM4YTc4NTliODYxMzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "37f1134ae5c96016036442062ed0ec5a7e6edcb4", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/37f1134ae5c96016036442062ed0ec5a7e6edcb4", "committedDate": "2020-11-20T05:31:51Z", "message": "Add Search to FHIRIO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ce0ed246618a594596248882259594c332eb0c", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/c7ce0ed246618a594596248882259594c332eb0c", "committedDate": "2020-11-20T17:14:59Z", "message": "Add Search to FHIRIO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba4b260ba9d370e6034ee754242f913074138ab", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/cba4b260ba9d370e6034ee754242f913074138ab", "committedDate": "2020-11-20T17:17:38Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7015ba7b4c520c2c2ae78ede16fa0aa1ee27ca61", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/7015ba7b4c520c2c2ae78ede16fa0aa1ee27ca61", "committedDate": "2020-11-20T17:23:17Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/1cedaed15134216b919b1ae5c42ba487b8faf421", "committedDate": "2020-11-20T17:24:18Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NzU0NDU3", "url": "https://github.com/apache/beam/pull/13395#pullrequestreview-535754457", "createdAt": "2020-11-20T20:28:22Z", "commit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMDoyODoyMlrOH3ftjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMDo0Njo1NVrOH3gNUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1MzI5NA==", "bodyText": "Should we pass the queries in as well, or is it part of fhirStore?", "url": "https://github.com/apache/beam/pull/13395#discussion_r527953294", "createdAt": "2020-11-20T20:28:22Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +215,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection\n+   *\n+   * @return the search\n+   * @see Search\n+   */\n+  public static Search searchResources(String fhirStore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1NDg4Mw==", "bodyText": "nit: maybe remove this comment? Doesn't seem to be very informative.", "url": "https://github.com/apache/beam/pull/13395#discussion_r527954883", "createdAt": "2020-11-20T20:31:45Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1398,206 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, Object>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      /** The Pct. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1OTc3Ng==", "bodyText": "You will need to handle pagination here, see how this is handled for ListMessages: https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java#L682.", "url": "https://github.com/apache/beam/pull/13395#discussion_r527959776", "createdAt": "2020-11-20T20:43:09Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java", "diffHunk": "@@ -545,6 +529,26 @@ public HttpBody readFhirResource(String resourceId) throws IOException {\n     return client.projects().locations().datasets().fhirStores().fhir().read(resourceId).execute();\n   }\n \n+  @Override\n+  public HttpBody searchFhirResource(\n+          String fhirStore,\n+          String resourceType,\n+          @Nullable Map<String, Object> parameters)\n+          throws IOException {\n+    SearchResourcesRequest request = new SearchResourcesRequest().setResourceType(resourceType);\n+    Search search = client\n+            .projects()\n+            .locations()\n+            .datasets()\n+            .fhirStores()\n+            .fhir()\n+            .search(fhirStore, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk2MTQyNg==", "bodyText": "I just realized that your case is totally different from what I thought, I expect a single query is used to generate the input to the pipeline, while it looks like we are doing something in reverse here, the search parameters are from the input. Can you confirm this is indeed the use case you have in mind? Please feel free to reach out to me offline.", "url": "https://github.com/apache/beam/pull/13395#discussion_r527961426", "createdAt": "2020-11-20T20:46:55Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +215,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection\n+   *\n+   * @return the search\n+   * @see Search\n+   */\n+  public static Search searchResources(String fhirStore) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk1MzI5NA=="}, "originalCommit": {"oid": "1cedaed15134216b919b1ae5c42ba487b8faf421"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55a28e1aa754b417224afdfbfb781d5c4327bd9c", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/55a28e1aa754b417224afdfbfb781d5c4327bd9c", "committedDate": "2020-11-23T04:46:32Z", "message": "Search iterator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef752e3f57c67367f4b3f61276da79beb837815", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/eef752e3f57c67367f4b3f61276da79beb837815", "committedDate": "2020-11-23T04:51:13Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0b91e9801279fd81701d541d8e4d46d5b8b5654", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/b0b91e9801279fd81701d541d8e4d46d5b8b5654", "committedDate": "2020-11-23T05:04:57Z", "message": "Switch output type to String"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b3b79c64b6b78b7c059cf35d19acf486756720", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/31b3b79c64b6b78b7c059cf35d19acf486756720", "committedDate": "2020-11-23T17:04:56Z", "message": "Added documentation for search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9144adc234fac396f45e0231f223734f7d7937e3", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/9144adc234fac396f45e0231f223734f7d7937e3", "committedDate": "2020-11-24T06:37:59Z", "message": "Add FhirIOSearchIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/ba1ef19f6215ca496fae9003b17b55f027bf9e35", "committedDate": "2020-11-24T18:44:28Z", "message": "Add a timelimit to test to avoid OOM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODE0MTc5", "url": "https://github.com/apache/beam/pull/13395#pullrequestreview-537814179", "createdAt": "2020-11-24T18:55:13Z", "commit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo1NToxM1rOH5Q1zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo1ODoxM1rOH5Q82w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNjc5Nw==", "bodyText": "nit: end with a period.", "url": "https://github.com/apache/beam/pull/13395#discussion_r529806797", "createdAt": "2020-11-24T18:55:13Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +227,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzExMw==", "bodyText": "nit: you can remove these if they are obvious. Same for other comments.", "url": "https://github.com/apache/beam/pull/13395#discussion_r529807113", "createdAt": "2020-11-24T18:55:43Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -215,6 +227,16 @@ public static Read readResources() {\n     return new Read();\n   }\n \n+  /**\n+   * Search resources from a PCollection\n+   *\n+   * @return the search", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODA5Mw==", "bodyText": "nit: You can let IntelliJ format these long lines.", "url": "https://github.com/apache/beam/pull/13395#discussion_r529808093", "createdAt": "2020-11-24T18:57:20Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwODYwMw==", "bodyText": "Please only catch the exceptions you expect to handle.", "url": "https://github.com/apache/beam/pull/13395#discussion_r529808603", "createdAt": "2020-11-24T18:58:13Z", "author": {"login": "lastomato"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));\n+      }\n+\n+      /**\n+       * Gets failed searches.\n+       *\n+       * @return the failed searches\n+       */\n+      public PCollection<HealthcareIOError<String>> getFailedSearches() {\n+        return failedSearches;\n+      }\n+\n+      /**\n+       * Gets resources.\n+       *\n+       * @return the resources\n+       */\n+      public PCollection<String> getResources() {\n+        return resources;\n+      }\n+\n+      @Override\n+      public Pipeline getPipeline() {\n+        return this.pct.getPipeline();\n+      }\n+\n+      @Override\n+      public Map<TupleTag<?>, PValue> expand() {\n+        return ImmutableMap.of(OUT, resources);\n+      }\n+\n+      @Override\n+      public void finishSpecifyingOutput(\n+              String transformName, PInput input, PTransform<?, ?> transform) {}\n+    }\n+\n+    /** The tag for the main output of Fhir Messages. */\n+    public static final TupleTag<String> OUT = new TupleTag<String>() {};\n+    /** The tag for the deadletter output of Fhir Messages. */\n+    public static final TupleTag<HealthcareIOError<String>> DEAD_LETTER =\n+            new TupleTag<HealthcareIOError<String>>() {};\n+\n+    @Override\n+    public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> input) {\n+      return input.apply(\"Fetch Fhir messages\", new SearchResourcesJsonString(this.fhirStore));\n+    }\n+\n+    /**\n+     * DoFn to fetch resources from an Google Cloud Healthcare FHIR store based on search request\n+     *\n+     * <p>This DoFn consumes a {@link PCollection} of search requests consisting of resource type\n+     * and search parameters, and fetches all matching resources based on the search criteria and\n+     * will output a {@link PCollectionTuple} which contains the output and dead-letter {@link\n+     * PCollection}*.\n+     *\n+     * <p>The {@link PCollectionTuple} output will contain the following {@link PCollection}:\n+     *\n+     * <ul>\n+     *   <li>{@link FhirIO.Search#OUT} - Contains all {@link PCollection} records successfully search\n+     *       from the Fhir store.\n+     *   <li>{@link FhirIO.Search#DEAD_LETTER} - Contains all {@link PCollection} of {@link\n+     *       HealthcareIOError}* of failed searches from the Fhir store, with\n+     *       error message and stacktrace.\n+     * </ul>\n+     */\n+    static class SearchResourcesJsonString\n+            extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+\n+      private final ValueProvider<String> fhirStore;\n+\n+      /** Instantiates a new Search Fhir resources DoFn. */\n+      public SearchResourcesJsonString(ValueProvider<String> fhirStore) {\n+        this.fhirStore = fhirStore;\n+      }\n+\n+      @Override\n+      public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> resourceIds) {\n+        return new FhirIO.Search.Result(\n+                resourceIds.apply(\n+                        ParDo.of(new SearchResourcesFn(this.fhirStore))\n+                                .withOutputTags(FhirIO.Search.OUT, TupleTagList.of(FhirIO.Search.DEAD_LETTER))));\n+      }\n+\n+      /** DoFn for searching messages from the Fhir store with error handling. */\n+      static class SearchResourcesFn extends DoFn<KV<String, Map<String, String>>, String> {\n+\n+        private Counter failedSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"failed-fhir-searches\");\n+        private static final Logger LOG = LoggerFactory.getLogger(SearchResourcesFn.class);\n+        private final Counter successfulSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"successful-fhir-searches\");\n+        private HealthcareApiClient client;\n+        private final ValueProvider<String> fhirStore;\n+\n+        /** Instantiates a new Fhir resources search fn. */\n+        SearchResourcesFn(ValueProvider<String> fhirStore) {\n+          this.fhirStore = fhirStore;\n+        }\n+\n+        /**\n+         * Instantiate healthcare client.\n+         *\n+         * @throws IOException the io exception\n+         */\n+        @Setup\n+        public void instantiateHealthcareClient() throws IOException {\n+          this.client = new HttpHealthcareApiClient();\n+        }\n+\n+        /**\n+         * Process element.\n+         *\n+         * @param context the context\n+         */\n+        @ProcessElement\n+        public void processElement(ProcessContext context) {\n+          KV<String, Map<String, String>> elementValues = context.element();\n+          try {\n+            context.output(searchResources(\n+                    this.client, this.fhirStore.toString(), elementValues.getKey(), elementValues.getValue()));\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "originalPosition": 236}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f064d194901704793a0c364e8bda0a3ccb44a9d", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/4f064d194901704793a0c364e8bda0a3ccb44a9d", "committedDate": "2020-11-24T19:47:22Z", "message": "Reformatting and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58fee42168b6bf1f3b573ce843637a745e6f2897", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/58fee42168b6bf1f3b573ce843637a745e6f2897", "committedDate": "2020-11-25T18:49:53Z", "message": "Reformatting and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7fdba8e85f8edaafd80d9f0292311f8b8982d42", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/c7fdba8e85f8edaafd80d9f0292311f8b8982d42", "committedDate": "2020-11-25T18:50:59Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c27ab33750edd54818d6293ff19d7a5f0cbc9ddf", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/c27ab33750edd54818d6293ff19d7a5f0cbc9ddf", "committedDate": "2020-11-30T19:11:54Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ac2a19bcc94982d5813d6d03c318bb82a5228e", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/f5ac2a19bcc94982d5813d6d03c318bb82a5228e", "committedDate": "2020-11-30T20:20:04Z", "message": "Fix library import errors from the newly merged DICOM code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyOTIxMzA3", "url": "https://github.com/apache/beam/pull/13395#pullrequestreview-542921307", "createdAt": "2020-12-02T14:58:58Z", "commit": {"oid": "f5ac2a19bcc94982d5813d6d03c318bb82a5228e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDo1ODo1OFrOH9fB-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDo1ODo1OFrOH9fB-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzMzU5NQ==", "bodyText": "Note that this test has failed (https://ci-beam.apache.org/job/beam_PreCommit_Java_Commit/14889/testReport/junit/org.apache.beam.sdk.io.gcp.healthcare/FhirIOTest/test_FhirIO_failedSearches/) - please fix", "url": "https://github.com/apache/beam/pull/13395#discussion_r534233595", "createdAt": "2020-12-02T14:58:58Z", "author": {"login": "pabloem"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIOTest.java", "diffHunk": "@@ -58,6 +56,25 @@ public void test_FhirIO_failedReads() {\n     pipeline.run();\n   }\n \n+  @Test\n+  public void test_FhirIO_failedSearches() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ac2a19bcc94982d5813d6d03c318bb82a5228e"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDYyNTI1", "url": "https://github.com/apache/beam/pull/13395#pullrequestreview-543062525", "createdAt": "2020-12-02T17:17:24Z", "commit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzoxNzoyNFrOH9lpKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzoxNzoyNFrOH9lpKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0MTkzMQ==", "bodyText": "I had recommended using async calls. In this case, I see that the calls happen within the iterator. I think this is fine as it is. I have a question though:\nUsually, will one element often produce one result from the iterator? Or usually more than one? I see that in lines 1608:1609, for the first iteration, there will be two calls to Fhir (one in hasNext, and one in next). Is it possible to try to reduce this to one?\nI expect your connector to have a bottleneck on IO. I would recommend you add a distribution-type metric to track time spent on IO.", "url": "https://github.com/apache/beam/pull/13395#discussion_r534341931", "createdAt": "2020-12-02T17:17:24Z", "author": {"login": "pabloem"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java", "diffHunk": "@@ -1388,4 +1410,208 @@ public void deidentify(ProcessContext context)\n       }\n     }\n   }\n+\n+  /** The type Search. */\n+  public static class Search extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+    private static final Logger LOG = LoggerFactory.getLogger(Search.class);\n+\n+    private final ValueProvider<String> fhirStore;\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(ValueProvider<String> fhirStore) {\n+      this.fhirStore = fhirStore;\n+    }\n+\n+    /**\n+     * Instantiates a new Search.\n+     *\n+     * @param fhirStore the fhir store\n+     */\n+    Search(String fhirStore) {\n+      this.fhirStore = StaticValueProvider.of(fhirStore);\n+    }\n+\n+    /** The type Result. */\n+    public static class Result implements POutput, PInput {\n+      private PCollection<String> resources;\n+\n+      private PCollection<HealthcareIOError<String>> failedSearches;\n+      PCollectionTuple pct;\n+\n+      /**\n+       * Create FhirIO.Search.Result form PCollectionTuple with OUT and DEAD_LETTER tags.\n+       *\n+       * @param pct the pct\n+       * @return the search result\n+       * @throws IllegalArgumentException the illegal argument exception\n+       */\n+      static FhirIO.Search.Result of(PCollectionTuple pct) throws IllegalArgumentException {\n+        if (pct.getAll()\n+                .keySet()\n+                .containsAll((Collection<?>) TupleTagList.of(OUT).and(DEAD_LETTER))) {\n+          return new FhirIO.Search.Result(pct);\n+        } else {\n+          throw new IllegalArgumentException(\n+                  \"The PCollection tuple must have the FhirIO.Search.OUT \"\n+                          + \"and FhirIO.Search.DEAD_LETTER tuple tags\");\n+        }\n+      }\n+\n+      private Result(PCollectionTuple pct) {\n+        this.pct = pct;\n+        this.resources = pct.get(OUT);\n+        this.failedSearches =\n+                pct.get(DEAD_LETTER).setCoder(HealthcareIOErrorCoder.of(StringUtf8Coder.of()));\n+      }\n+\n+      /**\n+       * Gets failed searches.\n+       *\n+       * @return the failed searches\n+       */\n+      public PCollection<HealthcareIOError<String>> getFailedSearches() {\n+        return failedSearches;\n+      }\n+\n+      /**\n+       * Gets resources.\n+       *\n+       * @return the resources\n+       */\n+      public PCollection<String> getResources() {\n+        return resources;\n+      }\n+\n+      @Override\n+      public Pipeline getPipeline() {\n+        return this.pct.getPipeline();\n+      }\n+\n+      @Override\n+      public Map<TupleTag<?>, PValue> expand() {\n+        return ImmutableMap.of(OUT, resources);\n+      }\n+\n+      @Override\n+      public void finishSpecifyingOutput(\n+              String transformName, PInput input, PTransform<?, ?> transform) {}\n+    }\n+\n+    /** The tag for the main output of Fhir Messages. */\n+    public static final TupleTag<String> OUT = new TupleTag<String>() {};\n+    /** The tag for the deadletter output of Fhir Messages. */\n+    public static final TupleTag<HealthcareIOError<String>> DEAD_LETTER =\n+            new TupleTag<HealthcareIOError<String>>() {};\n+\n+    @Override\n+    public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> input) {\n+      return input.apply(\"Fetch Fhir messages\", new SearchResourcesJsonString(this.fhirStore));\n+    }\n+\n+    /**\n+     * DoFn to fetch resources from an Google Cloud Healthcare FHIR store based on search request\n+     *\n+     * <p>This DoFn consumes a {@link PCollection} of search requests consisting of resource type\n+     * and search parameters, and fetches all matching resources based on the search criteria and\n+     * will output a {@link PCollectionTuple} which contains the output and dead-letter {@link\n+     * PCollection}*.\n+     *\n+     * <p>The {@link PCollectionTuple} output will contain the following {@link PCollection}:\n+     *\n+     * <ul>\n+     *   <li>{@link FhirIO.Search#OUT} - Contains all {@link PCollection} records successfully search\n+     *       from the Fhir store.\n+     *   <li>{@link FhirIO.Search#DEAD_LETTER} - Contains all {@link PCollection} of {@link\n+     *       HealthcareIOError}* of failed searches from the Fhir store, with\n+     *       error message and stacktrace.\n+     * </ul>\n+     */\n+    static class SearchResourcesJsonString\n+            extends PTransform<PCollection<KV<String, Map<String, String>>>, FhirIO.Search.Result> {\n+\n+      private final ValueProvider<String> fhirStore;\n+\n+      /** Instantiates a new Search Fhir resources DoFn. */\n+      public SearchResourcesJsonString(ValueProvider<String> fhirStore) {\n+        this.fhirStore = fhirStore;\n+      }\n+\n+      @Override\n+      public FhirIO.Search.Result expand(PCollection<KV<String, Map<String, String>>> resourceIds) {\n+        return new FhirIO.Search.Result(\n+                resourceIds.apply(\n+                        ParDo.of(new SearchResourcesFn(this.fhirStore))\n+                                .withOutputTags(FhirIO.Search.OUT, TupleTagList.of(FhirIO.Search.DEAD_LETTER))));\n+      }\n+\n+      /** DoFn for searching messages from the Fhir store with error handling. */\n+      static class SearchResourcesFn extends DoFn<KV<String, Map<String, String>>, String> {\n+\n+        private Counter failedSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"failed-fhir-searches\");\n+        private static final Logger LOG = LoggerFactory.getLogger(SearchResourcesFn.class);\n+        private final Counter successfulSearches =\n+                Metrics.counter(SearchResourcesFn.class, \"successful-fhir-searches\");\n+        private HealthcareApiClient client;\n+        private final ValueProvider<String> fhirStore;\n+\n+        /** Instantiates a new Fhir resources search fn. */\n+        SearchResourcesFn(ValueProvider<String> fhirStore) {\n+          this.fhirStore = fhirStore;\n+        }\n+\n+        /**\n+         * Instantiate healthcare client.\n+         *\n+         * @throws IOException the io exception\n+         */\n+        @Setup\n+        public void instantiateHealthcareClient() throws IOException {\n+          this.client = new HttpHealthcareApiClient();\n+        }\n+\n+        /**\n+         * Process element.\n+         *\n+         * @param context the context\n+         */\n+        @ProcessElement\n+        public void processElement(ProcessContext context) {\n+          KV<String, Map<String, String>> elementValues = context.element();\n+          try {\n+            context.output(searchResources(\n+                    this.client, this.fhirStore.toString(), elementValues.getKey(), elementValues.getValue()));\n+          } catch (Exception e) {\n+            failedSearches.inc();\n+            LOG.warn(\n+                    String.format(\n+                            \"Error search FHIR messages writing to Dead Letter \"\n+                                    + \"Queue. Cause: %s Stack Trace: %s\",\n+                            e.getMessage(), Throwables.getStackTraceAsString(e)));\n+            context.output(FhirIO.Search.DEAD_LETTER, HealthcareIOError.of(this.fhirStore.toString(), e));\n+          }\n+        }\n+\n+        private String searchResources(HealthcareApiClient client, String fhirStore, String resourceType,\n+                                       @Nullable Map<String, String> parameters)\n+                throws IllegalArgumentException {\n+          long startTime = System.currentTimeMillis();\n+\n+          HttpHealthcareApiClient.FhirResourcePages.FhirResourcePagesIterator iter =\n+                  new HttpHealthcareApiClient.FhirResourcePages.FhirResourcePagesIterator(\n+                          client, fhirStore, resourceType, parameters);\n+          JsonArray result = new JsonArray();\n+          while (iter.hasNext()) {\n+            result.addAll(iter.next());\n+          }\n+          this.successfulSearches.inc();\n+          return result.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1ef19f6215ca496fae9003b17b55f027bf9e35"}, "originalPosition": 260}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c18a993aa9e300411eb72b4e21b9672027462b5", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/5c18a993aa9e300411eb72b4e21b9672027462b5", "committedDate": "2020-12-02T21:30:35Z", "message": "Spotless + failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b72cee03db9faf40d16e544a5596fd0da15d6af1", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/b72cee03db9faf40d16e544a5596fd0da15d6af1", "committedDate": "2020-12-02T22:53:03Z", "message": "Spotless + failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a37060d628795e293f89207a6fb2e647bc41608", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/7a37060d628795e293f89207a6fb2e647bc41608", "committedDate": "2020-12-02T22:59:10Z", "message": "Merge branch 'master' of https://github.com/janeliulwq/beam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66fe586e34580be8ab9707687cba54aaaf84d8dd", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/66fe586e34580be8ab9707687cba54aaaf84d8dd", "committedDate": "2020-12-03T16:09:49Z", "message": "Add distribution metric for latency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08da34baa66a2ab9718e8f174db0a6c10c9e0991", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/08da34baa66a2ab9718e8f174db0a6c10c9e0991", "committedDate": "2020-12-03T19:45:32Z", "message": "Reformatted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065bc7679d822229b00347b53720e8d393ab5d9d", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/065bc7679d822229b00347b53720e8d393ab5d9d", "committedDate": "2020-12-04T21:18:28Z", "message": "Revert star imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "376e0d5b3c57ec5e37bf73cf6bf4622eae8f3b32", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/376e0d5b3c57ec5e37bf73cf6bf4622eae8f3b32", "committedDate": "2020-12-04T21:20:35Z", "message": "Reapply spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94c80052f6ddc5896b78faf20734fd631773acf1", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/94c80052f6ddc5896b78faf20734fd631773acf1", "committedDate": "2020-12-04T22:27:30Z", "message": "Use vendored guava"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4218b7d1f791e205eb53a60b204a7c46ccaec961", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/4218b7d1f791e205eb53a60b204a7c46ccaec961", "committedDate": "2020-12-08T18:49:06Z", "message": "Switch FhirSearchIT from streaming pipeline to batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "958ab09132b1f93f65e925f217c38a7859b86131", "author": {"user": {"login": "janeliulwq", "name": null}}, "url": "https://github.com/apache/beam/commit/958ab09132b1f93f65e925f217c38a7859b86131", "committedDate": "2020-12-08T21:01:01Z", "message": "Limit # of searches during test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4500, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}