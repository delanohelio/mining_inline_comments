{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNzM2Mjk2", "number": 11222, "title": "[BEAM-4150] Don't window PCollection coders.", "bodyText": "Now that no SDKs require it.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-25T17:51:49Z", "url": "https://github.com/apache/beam/pull/11222", "merged": true, "mergeCommit": {"oid": "1e6688e82e63f7700e7ac96ed4132c2e7cfedf53"}, "closed": true, "closedAt": "2020-03-27T18:55:37Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRPqanABqjMxNjYwNjY4ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRiY_mABqjMxNzAwMjEzMzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a55b919460d900978a6d8bbcb5b9e57edd6a3ce", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/5a55b919460d900978a6d8bbcb5b9e57edd6a3ce", "committedDate": "2020-03-25T17:51:05Z", "message": "[BEAM-4150] Don't window PCollection coders."}, "afterCommit": {"oid": "fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8", "committedDate": "2020-03-25T22:57:24Z", "message": "[BEAM-4150] Don't window PCollection coders.\n\nThis also paves the way for non-elementwise data channel coders."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTk3NDk2", "url": "https://github.com/apache/beam/pull/11222#pullrequestreview-381597496", "createdAt": "2020-03-25T22:59:01Z", "commit": {"oid": "fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjo1OTowMVrOF7xgbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjo1OTowMVrOF7xgbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIyMTQyMQ==", "bodyText": "This was an extra copy of the method that wasn't used anywhere.", "url": "https://github.com/apache/beam/pull/11222#discussion_r398221421", "createdAt": "2020-03-25T22:59:01Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -882,66 +885,13 @@ def _add_residuals_and_channel_splits_to_deferred_inputs(\n         prev_stops[\n             channel_split.transform_id] = channel_split.last_primary_element\n \n-  @staticmethod", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/fba0b7ad5a2b7b1b7bc6abd7ac2a07604ad52db8", "committedDate": "2020-03-25T22:57:24Z", "message": "[BEAM-4150] Don't window PCollection coders.\n\nThis also paves the way for non-elementwise data channel coders."}, "afterCommit": {"oid": "8f7a277f69db27c7fc0289a3ad79cfd7db81a99e", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8f7a277f69db27c7fc0289a3ad79cfd7db81a99e", "committedDate": "2020-03-25T23:00:18Z", "message": "[BEAM-4150] Don't window PCollection coders.\n\nThis also paves the way for non-elementwise data channel coders."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f7a277f69db27c7fc0289a3ad79cfd7db81a99e", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8f7a277f69db27c7fc0289a3ad79cfd7db81a99e", "committedDate": "2020-03-25T23:00:18Z", "message": "[BEAM-4150] Don't window PCollection coders.\n\nThis also paves the way for non-elementwise data channel coders."}, "afterCommit": {"oid": "a3ac58eedb058fe53125de50ac4aee99e9d9fc91", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/a3ac58eedb058fe53125de50ac4aee99e9d9fc91", "committedDate": "2020-03-26T00:17:42Z", "message": "[BEAM-4150] Don't window PCollection coders."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTM2MTY4", "url": "https://github.com/apache/beam/pull/11222#pullrequestreview-382136168", "createdAt": "2020-03-26T15:39:03Z", "commit": {"oid": "50e29a717edc228fceeec16a36d53635f4baa4c1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNTo0NDo1M1rOF8NVpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNTo0NTo0OFrOF8NYUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3NzQxNA==", "bodyText": "Note this check is already done within length_prefix_coder where it will return the original coder id if its a safe coder so you can always use it.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if pcoll.coder_id in self.safe_coders:\n          \n          \n            \n                  channel_coder = self.length_prefixed_coder(channel_coder)\n          \n          \n            \n                channel_coder = self.length_prefixed_coder(channel_coder)", "url": "https://github.com/apache/beam/pull/11222#discussion_r398677414", "createdAt": "2020-03-26T15:44:53Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -347,6 +348,22 @@ def add_or_get_coder_id(self,\n     self.components.coders[new_coder_id].CopyFrom(coder_proto)\n     return new_coder_id\n \n+  def add_data_channel_coder(self, pcoll_id):\n+    pcoll = self.components.pcollections[pcoll_id]\n+    proto = beam_runner_api_pb2.Coder(\n+        spec=beam_runner_api_pb2.FunctionSpec(\n+            urn=common_urns.coders.WINDOWED_VALUE.urn),\n+        component_coder_ids=[\n+            pcoll.coder_id,\n+            self.components.windowing_strategies[\n+                pcoll.windowing_strategy_id].window_coder_id\n+        ])\n+    channel_coder = self.add_or_get_coder_id(\n+        proto, pcoll.coder_id + '_windowed')\n+    if pcoll.coder_id in self.safe_coders:\n+      channel_coder = self.length_prefixed_coder(channel_coder)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50e29a717edc228fceeec16a36d53635f4baa4c1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3ODA5OQ==", "bodyText": "If possible try and keep the typing information on methods.", "url": "https://github.com/apache/beam/pull/11222#discussion_r398678099", "createdAt": "2020-03-26T15:45:48Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner.py", "diffHunk": "@@ -426,7 +423,8 @@ def _collect_written_timers_and_add_to_deferred_inputs(\n       pipeline_components,  # type: beam_runner_api_pb2.Components\n       stage,  # type: translations.Stage\n       bundle_context_manager,  # type: execution.BundleContextManager\n-      deferred_inputs  # type: MutableMapping[str, PartitionableBuffer]\n+      deferred_inputs,  # type: MutableMapping[str, PartitionableBuffer]\n+      data_channel_coders,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50e29a717edc228fceeec16a36d53635f4baa4c1"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzI0OTY1", "url": "https://github.com/apache/beam/pull/11222#pullrequestreview-382324965", "createdAt": "2020-03-26T19:00:28Z", "commit": {"oid": "d4f9e567ec9f09af7995c23a7fb629488d407f56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzU3Njg1", "url": "https://github.com/apache/beam/pull/11222#pullrequestreview-382357685", "createdAt": "2020-03-26T19:46:16Z", "commit": {"oid": "d4f9e567ec9f09af7995c23a7fb629488d407f56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8678977164b643ce2a9d7f06f47b16790227863", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/b8678977164b643ce2a9d7f06f47b16790227863", "committedDate": "2020-03-26T20:46:41Z", "message": "[BEAM-4150] Use explicit map for data channel coders.\n\nThis is needed to remove the windowing from PCollection coders, but also\npaves the way for non-elementwise data channel coders."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "019ecf24a0852f3d2145264234fbd4b639da5368", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/019ecf24a0852f3d2145264234fbd4b639da5368", "committedDate": "2020-03-26T20:46:42Z", "message": "[BEAM-4150] Don't window PCollection coders."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4f9e567ec9f09af7995c23a7fb629488d407f56", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/d4f9e567ec9f09af7995c23a7fb629488d407f56", "committedDate": "2020-03-26T18:13:44Z", "message": "Add some more typing information."}, "afterCommit": {"oid": "019ecf24a0852f3d2145264234fbd4b639da5368", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/019ecf24a0852f3d2145264234fbd4b639da5368", "committedDate": "2020-03-26T20:46:42Z", "message": "[BEAM-4150] Don't window PCollection coders."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4694, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}