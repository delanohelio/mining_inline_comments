{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MzUxMjMz", "number": 10689, "title": "[BEAM-6703] Make Dataflow ValidatesRunner test use Java 11 in test execution", "bodyText": "In order to properly test the Dataflow runner with Java 11, it's necessary to compile all the classes with Java 8 and then run with Java 11 using version 11 worker harness image. Previous version did not execute the runner code with proper JRE.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-27T07:38:37Z", "url": "https://github.com/apache/beam/pull/10689", "merged": true, "mergeCommit": {"oid": "1f94c99b4e1e1ae60096623536d545fb3b2fe7be"}, "closed": true, "closedAt": "2020-02-05T19:42:29Z", "author": {"login": "mwalenia"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9gGohgH2gAyMzY3MzUxMjMzOmZlODdlZTdkMzc3NDc3ZGRjYjA4NjNjY2MwYmU0ODJkYmZlNDc2YmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBbeuOAFqTM1Mzk4OTYwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/fe87ee7d377477ddcb0863ccc0be482dbfe476bb", "committedDate": "2020-01-24T14:48:31Z", "message": "[BEAM-6703] Make Dataflow ValidatesRunner test use Java 11 in test execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjM1MzUy", "url": "https://github.com/apache/beam/pull/10689#pullrequestreview-349635352", "createdAt": "2020-01-28T19:18:16Z", "commit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOToxODoxNlrOFixWHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOToxODoxNlrOFixWHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNDM4MQ==", "bodyText": "I suggest use trigger phrase\n\"Run beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11\"\nit is same in terms of being descriptive, but much easier to figure out.\nOr \"Run Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11\".", "url": "https://github.com/apache/beam/pull/10689#discussion_r372004381", "createdAt": "2020-01-28T19:18:16Z", "author": {"login": "Ardagan"}, "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjM2NDQ5", "url": "https://github.com/apache/beam/pull/10689#pullrequestreview-349636449", "createdAt": "2020-01-28T19:19:57Z", "commit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDkxMDM2", "url": "https://github.com/apache/beam/pull/10689#pullrequestreview-350491036", "createdAt": "2020-01-29T23:14:40Z", "commit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzoxNDo0MFrOFjayBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzoxODo1M1rOFja22Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzI3MA==", "bodyText": "Can we preferably use a Jenkins environment variable for the Java home locations here and in the direct runner Java 11 case?", "url": "https://github.com/apache/beam/pull/10689#discussion_r372683270", "createdAt": "2020-01-29T23:14:40Z", "author": {"login": "lukecwik"}, "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzM0Mw==", "bodyText": "Any reason why we aren't using the paths specified in https://cwiki.apache.org/confluence/display/INFRA/JDK+Installation+Matrix?\nIf we aren't using an ASF jenkins machine VM image as our base then that is fine but can we define the constants somewhere and share them across the relevant locations?", "url": "https://github.com/apache/beam/pull/10689#discussion_r372683343", "createdAt": "2020-01-29T23:14:55Z", "author": {"login": "lukecwik"}, "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDA3OQ==", "bodyText": "Why do we have a validatesJava11Runner task? (Shouldn't we just invoke the validatesRunner task?)", "url": "https://github.com/apache/beam/pull/10689#discussion_r372684079", "createdAt": "2020-01-29T23:17:21Z", "author": {"login": "lukecwik"}, "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'\n \n+  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n   publishers {\n     archiveJunit('**/build/test-results/**/*.xml')\n   }\n \n   steps {\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)\n+      tasks(':runners:google-cloud-dataflow-java:testJar')\n+      tasks(':runners:google-cloud-dataflow-java:worker:legacy-worker:shadowJar')\n+      switches(\"-Dorg.gradle.java.home=${JAVA_8_HOME}\")\n+    }\n+    \n     gradle {\n       rootBuildScriptDir(commonJobProperties.checkoutDir)\n       tasks(':runners:google-cloud-dataflow-java:validatesJava11Runner')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4NDUwNQ==", "bodyText": "Can we override the javaVersion property instead of splitting these into two commands?\nThis would lead us to using the Java 11 compiler with a source and class target of version 8 or do we want to explicitly guarantee that we are using the Java 8 compiler?", "url": "https://github.com/apache/beam/pull/10689#discussion_r372684505", "createdAt": "2020-01-29T23:18:53Z", "author": {"login": "lukecwik"}, "path": ".test-infra/jenkins/job_PostCommit_Java_ValidatesRunner_Dataflow_Java11.groovy", "diffHunk": "@@ -20,26 +20,40 @@ import CommonJobProperties as commonJobProperties\n import PostcommitJobBuilder\n \n \n-PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java11_ValidatesRunner_Dataflow',\n+PostcommitJobBuilder.postCommitJob('beam_PostCommit_Java_ValidatesRunner_Dataflow_Java11',\n   'Run Dataflow ValidatesRunner Java 11', 'Google Cloud Dataflow Runner ValidatesRunner Tests On Java 11', this) {\n \n   description('Runs the ValidatesRunner suite on the Dataflow runner with Java 11 worker harness.')\n \n-  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n+  def JAVA_11_HOME = '/usr/lib/jvm/java-11-openjdk-amd64'\n+  def JAVA_8_HOME = '/usr/lib/jvm/java-8-openjdk-amd64'\n \n+  commonJobProperties.setTopLevelMainJobProperties(delegate, 'master', 270)\n   publishers {\n     archiveJunit('**/build/test-results/**/*.xml')\n   }\n \n   steps {\n+    gradle {\n+      rootBuildScriptDir(commonJobProperties.checkoutDir)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe87ee7d377477ddcb0863ccc0be482dbfe476bb"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7506ccef6cc272a80c7edf2aa3260aaed3db1c3c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/7506ccef6cc272a80c7edf2aa3260aaed3db1c3c", "committedDate": "2020-01-31T10:40:00Z", "message": "Change JDK paths in job definition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acd5ae9f5ce5cd5cce7e429b1b27b740925a2763", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/acd5ae9f5ce5cd5cce7e429b1b27b740925a2763", "committedDate": "2020-01-31T11:54:46Z", "message": "Change JDk paths back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "committedDate": "2020-02-05T08:49:40Z", "message": "Remove redundant gradle tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e645a56846bf85a24bb5e2ae1aaaa22843ff30f4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/e645a56846bf85a24bb5e2ae1aaaa22843ff30f4", "committedDate": "2020-02-04T09:34:48Z", "message": "Remove redundant gradle tasks"}, "afterCommit": {"oid": "dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/dc34d08c53eb2b6d7b1be524e62d489b5374a3c8", "committedDate": "2020-02-05T08:49:40Z", "message": "Remove redundant gradle tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTg5NjA2", "url": "https://github.com/apache/beam/pull/10689#pullrequestreview-353989606", "createdAt": "2020-02-05T19:41:00Z", "commit": {"oid": "dc34d08c53eb2b6d7b1be524e62d489b5374a3c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3608, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}