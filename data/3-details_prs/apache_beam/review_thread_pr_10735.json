{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MzU3NDI5", "number": 10735, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMDoxNjozNlrODcWN0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxODoyMTo1N1rODcunzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMDUwNzA0OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/decorators.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMDoxNjozNlrOFkW05A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMDoxNjozNlrOFkW05A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY2NzA0NA==", "bodyText": "Type comment should go after the function.  No need for ... unless you are skipping the definition of an argument (the type of self is implicit).\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              def strip_iterable(self):  # type: (...) -> IOTypeHints\n          \n          \n            \n              def strip_iterable(self):\n          \n          \n            \n                # type: () -> IOTypeHints", "url": "https://github.com/apache/beam/pull/10735#discussion_r373667044", "createdAt": "2020-01-31T20:16:36Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -305,7 +326,7 @@ def has_simple_output_type(self):\n     return (self.output_types and len(self.output_types[0]) == 1 and\n             not self.output_types[1])\n \n-  def strip_iterable(self):\n+  def strip_iterable(self):  # type: (...) -> IOTypeHints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1590b0d9b1992644bff105bd889fe1d954c26ce7"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMDgwMTQ2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/decorators.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjozMTo0NVrOFkZuLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjozMTo0NVrOFkZuLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNDQ3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              def with_output_types(self, *args, **kwargs):  # type: (...) -> IOTypeHints\n          \n          \n            \n              def with_output_types(self, *args, **kwargs):\n          \n          \n            \n                # type: (...) -> IOTypeHints", "url": "https://github.com/apache/beam/pull/10735#discussion_r373714477", "createdAt": "2020-01-31T22:31:45Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -283,16 +301,19 @@ def from_callable(fn):\n       output_args.append(typehints.Any)\n \n     return IOTypeHints(input_types=(tuple(input_args), input_kwargs),\n-                       output_types=(tuple(output_args), {}))\n+                       output_types=(tuple(output_args), {}),\n+                       origin=cls._make_traceback(None))\n \n-  def set_input_types(self, *args, **kwargs):\n-    self.input_types = args, kwargs\n+  def with_input_types(self, *args, **kwargs):  # type: (...) -> IOTypeHints\n+    return self._replace(input_types=(args, kwargs),\n+                         origin=self._make_traceback(self))\n \n-  def set_output_types(self, *args, **kwargs):\n-    self.output_types = args, kwargs\n+  def with_output_types(self, *args, **kwargs):  # type: (...) -> IOTypeHints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1590b0d9b1992644bff105bd889fe1d954c26ce7"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMDgwMjE4OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/decorators.py", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjozMjowNlrOFkZumA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjozMjowNlrOFkZumA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNDU4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              def with_input_types(self, *args, **kwargs):  # type: (...) -> IOTypeHints\n          \n          \n            \n              def with_input_types(self, *args, **kwargs):\n          \n          \n            \n                # type: (...) -> IOTypeHints", "url": "https://github.com/apache/beam/pull/10735#discussion_r373714584", "createdAt": "2020-01-31T22:32:06Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -283,16 +301,19 @@ def from_callable(fn):\n       output_args.append(typehints.Any)\n \n     return IOTypeHints(input_types=(tuple(input_args), input_kwargs),\n-                       output_types=(tuple(output_args), {}))\n+                       output_types=(tuple(output_args), {}),\n+                       origin=cls._make_traceback(None))\n \n-  def set_input_types(self, *args, **kwargs):\n-    self.input_types = args, kwargs\n+  def with_input_types(self, *args, **kwargs):  # type: (...) -> IOTypeHints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1590b0d9b1992644bff105bd889fe1d954c26ce7"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNDQ5OTExOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/decorators.py", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxODoxOTo1MVrOFk7E8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo1NToyNlrOFk981w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MDk3Nw==", "bodyText": "My guess is that this is going to trip up mypy, but we can defer that to a future mypy PR if you'd like.  This is the pattern that I use for these cases:\n_IOTypeHints = NamedTuple('_IOTypeHints', [\n    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n    ('origin', List[str])\n])\n\nclass IOTypeHints(_IOTypeHints):", "url": "https://github.com/apache/beam/pull/10735#discussion_r374260977", "createdAt": "2020-02-03T18:19:51Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -217,7 +220,10 @@ def get_signature(func):\n   return signature\n \n \n-class IOTypeHints(object):\n+class IOTypeHints(NamedTuple('IOTypeHints', [\n+    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('origin', List[str])])):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2NDc1Mw==", "bodyText": "The tradeoff is that this produces a sub-par repr for IOTypeHints:\nIn [2]: from typing import *\n\nIn [3]: _IOTypeHints = NamedTuple('_IOTypeHints', [\n   ...:     ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n   ...:     ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n   ...:     ('origin', List[str])\n   ...: ])\n\nIn [4]: class IOTypeHints(_IOTypeHints):pass\n\nIn [5]: x = IOTypeHints(None, None, ['foo'])\n\nIn [6]: x\nOut[6]: _IOTypeHints(input_types=None, output_types=None, origin=['foo'])\nDoing a quick investigation to see if there's a hack fix for this.", "url": "https://github.com/apache/beam/pull/10735#discussion_r374264753", "createdAt": "2020-02-03T18:27:21Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -217,7 +220,10 @@ def get_signature(func):\n   return signature\n \n \n-class IOTypeHints(object):\n+class IOTypeHints(NamedTuple('IOTypeHints', [\n+    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('origin', List[str])])):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MDk3Nw=="}, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MDI3NA==", "bodyText": "Something like this:\n    def __repr__(self):\n      repr_fmt = '{typename}({repr_fmt})'.format(\n            typename=type(self).__name__, \n            repr_fmt=', '.join('{name}=%r'.format(name=name) for name in self._fields)\n      )\n      return repr_fmt % self", "url": "https://github.com/apache/beam/pull/10735#discussion_r374270274", "createdAt": "2020-02-03T18:38:10Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -217,7 +220,10 @@ def get_signature(func):\n   return signature\n \n \n-class IOTypeHints(object):\n+class IOTypeHints(NamedTuple('IOTypeHints', [\n+    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('origin', List[str])])):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MDk3Nw=="}, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwMDI1Ng==", "bodyText": "Trip up how?\nI see this error in lint (should be fixed in next commit):\napache_beam/typehints/decorators.py:353: error: Value of type \"Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]\" is not indexable  [index]\n\nThis is the line:\noutput_type = self.output_types[0][0]\n\nSo it seems that mypy is correctly parsing these type hints.", "url": "https://github.com/apache/beam/pull/10735#discussion_r374300256", "createdAt": "2020-02-03T19:39:40Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -217,7 +220,10 @@ def get_signature(func):\n   return signature\n \n \n-class IOTypeHints(object):\n+class IOTypeHints(NamedTuple('IOTypeHints', [\n+    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('origin', List[str])])):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MDk3Nw=="}, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwODA1NQ==", "bodyText": "I assumed that mypy would need the intermediate class or would want that class's name to match the name provided to NamedTuple().  For example, both of these are invalid:\nclass Foo(Generic[TypeVar('T')]):  # TypeVar needs to be defined above\n    pass\n\nT = TypeVar('T_with_suffix')  # TypeVar name needs to match variable name\nclass Bar(Generic[T]):\n    pass\nI just did my own isolated test of this and you're right, mypy has no issue with it, so it appears there's nothing special about the name given to NamedTuple, as far as mypy is concerned.\nThanks for taking the time to test that.  I was trying to give some quick feedback without getting too drawn in, but once I did get drawn in, I should have gone back and checked my original assumption!", "url": "https://github.com/apache/beam/pull/10735#discussion_r374308055", "createdAt": "2020-02-03T19:55:26Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -217,7 +220,10 @@ def get_signature(func):\n   return signature\n \n \n-class IOTypeHints(object):\n+class IOTypeHints(NamedTuple('IOTypeHints', [\n+    ('input_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('output_types', Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]),\n+    ('origin', List[str])])):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MDk3Nw=="}, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNDUwNTczOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/typehints/decorators.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxODoyMTo1N1rOFk7JAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo1MDowNlrOFk9yYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MjAxNg==", "bodyText": "would be nice to add a type annotation to this:\n  def empty(cls):\n    # type: () -> IOTypeHints\n    return IOTypeHints(None, None, [])", "url": "https://github.com/apache/beam/pull/10735#discussion_r374262016", "createdAt": "2020-02-03T18:21:57Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -228,18 +234,30 @@ class IOTypeHints(object):\n       May be None. The list and dict correspond to args and kwargs.\n     output_types: (tuple, dict) List of typing types, and an optional dictionary\n       (unused). Only the first element of the list is used. May be None.\n+    origin: (List[str]) Stack of tracebacks of method calls used to create this\n+      instance.\n   \"\"\"\n-  __slots__ = ('input_types', 'output_types')\n \n-  def __init__(self,\n-               input_types=None,  # type: Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]\n-               output_types=None  # type: Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]\n-              ):\n-    self.input_types = input_types\n-    self.output_types = output_types\n+  traceback_limit = 5\n \n-  @staticmethod\n-  def from_callable(fn):\n+  @classmethod\n+  def _make_traceback(cls, base):  # type: (Optional[IOTypeHints]) -> List[str]\n+    # Omit this method and the IOTypeHints method that called it.\n+    num_frames_skip = 2\n+    tb = traceback.format_stack(limit=cls.traceback_limit + num_frames_skip)\n+    tb_lines = 'TH>' + ''.join(tb[:-num_frames_skip]).replace('\\n', '\\nTH>')\n+\n+    res = [tb_lines + '\\nbased on: ' + str(base)]\n+    if base is not None:\n+      res += base.origin\n+    return res\n+\n+  @classmethod\n+  def empty(cls):\n+    return IOTypeHints(None, None, [])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwNTM3OA==", "bodyText": "done", "url": "https://github.com/apache/beam/pull/10735#discussion_r374305378", "createdAt": "2020-02-03T19:50:06Z", "author": {"login": "udim"}, "path": "sdks/python/apache_beam/typehints/decorators.py", "diffHunk": "@@ -228,18 +234,30 @@ class IOTypeHints(object):\n       May be None. The list and dict correspond to args and kwargs.\n     output_types: (tuple, dict) List of typing types, and an optional dictionary\n       (unused). Only the first element of the list is used. May be None.\n+    origin: (List[str]) Stack of tracebacks of method calls used to create this\n+      instance.\n   \"\"\"\n-  __slots__ = ('input_types', 'output_types')\n \n-  def __init__(self,\n-               input_types=None,  # type: Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]\n-               output_types=None  # type: Optional[Tuple[Tuple[Any, ...], Dict[str, Any]]]\n-              ):\n-    self.input_types = input_types\n-    self.output_types = output_types\n+  traceback_limit = 5\n \n-  @staticmethod\n-  def from_callable(fn):\n+  @classmethod\n+  def _make_traceback(cls, base):  # type: (Optional[IOTypeHints]) -> List[str]\n+    # Omit this method and the IOTypeHints method that called it.\n+    num_frames_skip = 2\n+    tb = traceback.format_stack(limit=cls.traceback_limit + num_frames_skip)\n+    tb_lines = 'TH>' + ''.join(tb[:-num_frames_skip]).replace('\\n', '\\nTH>')\n+\n+    res = [tb_lines + '\\nbased on: ' + str(base)]\n+    if base is not None:\n+      res += base.origin\n+    return res\n+\n+  @classmethod\n+  def empty(cls):\n+    return IOTypeHints(None, None, [])", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2MjAxNg=="}, "originalCommit": {"oid": "cea11604369f827b9babf424e505c5ec8c4b7941"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2114, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}