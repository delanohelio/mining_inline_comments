{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzkxMDMw", "number": 12144, "title": "[BEAM-10395] Deduplicate uploads by destinations before uploading", "bodyText": "If a job is configured to upload multiple files to the same destination, they'll end up attempting to overwrite each other in parallel, causing the runner to need to retry multiple times until one wins the race.  This change deduplicates them by destination.\nR: @lukecwik @pabloem\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-01T01:47:53Z", "url": "https://github.com/apache/beam/pull/12144", "merged": true, "mergeCommit": {"oid": "8fc613a6bd4815e146ffd4a7a01863c142d4267c"}, "closed": true, "closedAt": "2020-07-10T02:33:39Z", "author": {"login": "steveniemitz"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczXRf8gFqTQ0NjAyNDA3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczYyAtABqjM1MzE5NDYwMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDI0MDcx", "url": "https://github.com/apache/beam/pull/12144#pullrequestreview-446024071", "createdAt": "2020-07-09T23:03:09Z", "commit": {"oid": "c544cbac5c3d8edd372792648855348091ea6210"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzowMzowOVrOGvkmHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzowMzowOVrOGvkmHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNTgzOQ==", "bodyText": "Should this throw an exception? IIUC, this would most likely mean that a user-specified file to upload would fail, right? (classpath JAR files with equal names should have equal contents as they usually include version in their name)\nWouldn't it be best to error out, and inform the use about that?", "url": "https://github.com/apache/beam/pull/12144#discussion_r452535839", "createdAt": "2020-07-09T23:03:09Z", "author": {"login": "pabloem"}, "path": "runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/util/PackageUtil.java", "diffHunk": "@@ -311,8 +315,26 @@ public DataflowPackage stageToFile(\n       CompletionStage<StagingResult> stagingResult =\n           computePackageAttributes(source, hash, dest, stagingPath)\n               .thenComposeAsync(\n-                  packageAttributes ->\n-                      stagePackage(packageAttributes, retrySleeper, createOptions));\n+                  packageAttributes -> {\n+                    String destLocation = packageAttributes.getDestination().getLocation();\n+                    String existingHash =\n+                        distinctDestinations.putIfAbsent(destLocation, packageAttributes.getHash());\n+                    if (existingHash == null) {\n+                      return stagePackage(packageAttributes, retrySleeper, createOptions);\n+                    } else {\n+                      if (!existingHash.equals(packageAttributes.getHash())) {\n+                        LOG.warn(\n+                            \"Upload of {} would overwrite {} with different content\",\n+                            packageAttributes.getSource(),\n+                            destLocation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c544cbac5c3d8edd372792648855348091ea6210"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDI0MjY3", "url": "https://github.com/apache/beam/pull/12144#pullrequestreview-446024267", "createdAt": "2020-07-09T23:03:43Z", "commit": {"oid": "c544cbac5c3d8edd372792648855348091ea6210"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddb851e893fdfe467379691cfc5d9fe25f908596", "author": {"user": {"login": "steveniemitz", "name": "Steven Niemitz"}}, "url": "https://github.com/apache/beam/commit/ddb851e893fdfe467379691cfc5d9fe25f908596", "committedDate": "2020-07-10T00:48:25Z", "message": "Deduplicate uploads by destinations before uploading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c544cbac5c3d8edd372792648855348091ea6210", "author": {"user": {"login": "steveniemitz", "name": "Steven Niemitz"}}, "url": "https://github.com/apache/beam/commit/c544cbac5c3d8edd372792648855348091ea6210", "committedDate": "2020-07-01T01:45:24Z", "message": "Deduplicate uploads by destinations before uploading"}, "afterCommit": {"oid": "ddb851e893fdfe467379691cfc5d9fe25f908596", "author": {"user": {"login": "steveniemitz", "name": "Steven Niemitz"}}, "url": "https://github.com/apache/beam/commit/ddb851e893fdfe467379691cfc5d9fe25f908596", "committedDate": "2020-07-10T00:48:25Z", "message": "Deduplicate uploads by destinations before uploading"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3268, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}