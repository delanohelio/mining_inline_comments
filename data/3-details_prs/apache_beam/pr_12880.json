{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5ODExMzU2", "number": 12880, "title": "[BEAM-10933] Adjust GBK type before creating the pipeline proto", "bodyText": "These have to be done before creating the pipeline proto for Dataflow to be able to correctly generate job requests from portable protos.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-19T19:04:59Z", "url": "https://github.com/apache/beam/pull/12880", "merged": true, "mergeCommit": {"oid": "0e90411915f2b241e45e7cf222f1a4bb456d9458"}, "closed": true, "closedAt": "2020-09-22T01:35:21Z", "author": {"login": "chamikaramj"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLFuGigFqTQ5Mjc3MTk0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLNP3jABqjM3OTExMDU2OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzcxOTQx", "url": "https://github.com/apache/beam/pull/12880#pullrequestreview-492771941", "createdAt": "2020-09-21T16:10:17Z", "commit": {"oid": "23e6c0d74e364cf479721ea1d1bfacb9fcab1a53"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxMDoxN1rOHVYWFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxMDoxN1rOHVYWFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4MTAxNQ==", "bodyText": "@CraigChambersG I was under the impression that this wasn't true and that Dataflow v2 handled this.", "url": "https://github.com/apache/beam/pull/12880#discussion_r492181015", "createdAt": "2020-09-21T16:10:17Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -430,6 +430,15 @@ def _check_for_unsupported_fnapi_features(self, pipeline_proto):\n                 components.coders[windowing_strategy.window_coder_id].spec.urn,\n                 windowing_strategy.window_fn.urn))\n \n+  def _adjust_types_for_dataflow(self, pipeline):\n+    # Dataflow runner requires a KV type for GBK inputs, hence we enforce that\n+    # here.\n+    pipeline.visit(self.group_by_key_input_visitor())\n+\n+    # Dataflow runner requires output type of the Flatten to be the same as the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23e6c0d74e364cf479721ea1d1bfacb9fcab1a53"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTg3MTI0", "url": "https://github.com/apache/beam/pull/12880#pullrequestreview-492987124", "createdAt": "2020-09-21T21:17:57Z", "commit": {"oid": "dfdda4e66a30834a203d70b78a7633e5c355e1fb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxNzo1OFrOHViwcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToyMjozOVrOHVi47g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MTYwMw==", "bodyText": "Why do the type encodings not survive the round trip (pipeline -> proto -> pipeline)?", "url": "https://github.com/apache/beam/pull/12880#discussion_r492351603", "createdAt": "2020-09-21T21:17:58Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -488,12 +497,15 @@ def run_pipeline(self, pipeline, options):\n       # Cross language transform require using a pipeline object constructed\n       # from the full pipeline proto to make sure that expanded version of\n       # external transforms are reflected in the Pipeline job graph.\n+      # TODO(chamikara): remove following pipeline and pipeline proto recreation\n+      # after portable job submission path is fully in place.\n       from apache_beam import Pipeline\n       pipeline = Pipeline.from_runner_api(\n           self.proto_pipeline,\n           pipeline.runner,\n           options,\n           allow_proto_holders=True)\n+      self._adjust_types_for_dataflow(pipeline)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdda4e66a30834a203d70b78a7633e5c355e1fb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1Mzc3NA==", "bodyText": "_adjust_pipeline_for_dataflow_v2?", "url": "https://github.com/apache/beam/pull/12880#discussion_r492353774", "createdAt": "2020-09-21T21:22:39Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -430,6 +430,11 @@ def _check_for_unsupported_fnapi_features(self, pipeline_proto):\n                 components.coders[windowing_strategy.window_coder_id].spec.urn,\n                 windowing_strategy.window_fn.urn))\n \n+  def _adjust_types_for_dataflow(self, pipeline):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdda4e66a30834a203d70b78a7633e5c355e1fb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDIyNzQx", "url": "https://github.com/apache/beam/pull/12880#pullrequestreview-493022741", "createdAt": "2020-09-21T22:25:21Z", "commit": {"oid": "23e6c0d74e364cf479721ea1d1bfacb9fcab1a53"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyNToyMlrOHVkhFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyNjoxOVrOHVkiWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MDQzOQ==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/12880#discussion_r492380439", "createdAt": "2020-09-21T22:25:22Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -430,6 +430,11 @@ def _check_for_unsupported_fnapi_features(self, pipeline_proto):\n                 components.coders[windowing_strategy.window_coder_id].spec.urn,\n                 windowing_strategy.window_fn.urn))\n \n+  def _adjust_types_for_dataflow(self, pipeline):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1Mzc3NA=="}, "originalCommit": {"oid": "dfdda4e66a30834a203d70b78a7633e5c355e1fb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MDc2Mw==", "bodyText": "Verified that types are preserved in the pipeline->proto->pipeline roundtrip and removed this.", "url": "https://github.com/apache/beam/pull/12880#discussion_r492380763", "createdAt": "2020-09-21T22:26:19Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner.py", "diffHunk": "@@ -488,12 +497,15 @@ def run_pipeline(self, pipeline, options):\n       # Cross language transform require using a pipeline object constructed\n       # from the full pipeline proto to make sure that expanded version of\n       # external transforms are reflected in the Pipeline job graph.\n+      # TODO(chamikara): remove following pipeline and pipeline proto recreation\n+      # after portable job submission path is fully in place.\n       from apache_beam import Pipeline\n       pipeline = Pipeline.from_runner_api(\n           self.proto_pipeline,\n           pipeline.runner,\n           options,\n           allow_proto_holders=True)\n+      self._adjust_types_for_dataflow(pipeline)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MTYwMw=="}, "originalCommit": {"oid": "dfdda4e66a30834a203d70b78a7633e5c355e1fb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDMwNzc3", "url": "https://github.com/apache/beam/pull/12880#pullrequestreview-493030777", "createdAt": "2020-09-21T22:43:40Z", "commit": {"oid": "38a941ddf0323af6c536fd2b4718f92d2ab0f97b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a4d4161b9544f029d2bf143d8cecddca7239f3", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/83a4d4161b9544f029d2bf143d8cecddca7239f3", "committedDate": "2020-09-22T00:56:22Z", "message": "Performs Dataflow specific pipeline updates before creating the pipeine proto"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38a941ddf0323af6c536fd2b4718f92d2ab0f97b", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/38a941ddf0323af6c536fd2b4718f92d2ab0f97b", "committedDate": "2020-09-21T22:23:31Z", "message": "Address reviewer comments"}, "afterCommit": {"oid": "83a4d4161b9544f029d2bf143d8cecddca7239f3", "author": {"user": {"login": "chamikaramj", "name": "Chamikara Jayalath"}}, "url": "https://github.com/apache/beam/commit/83a4d4161b9544f029d2bf143d8cecddca7239f3", "committedDate": "2020-09-22T00:56:22Z", "message": "Performs Dataflow specific pipeline updates before creating the pipeine proto"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2395, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}