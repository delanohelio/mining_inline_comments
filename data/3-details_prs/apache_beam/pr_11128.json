{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDExNTYx", "number": 11128, "title": "[BEAM-9524] Fix for ib.show() executing indefinitely", "bodyText": "The problem was that the StreamingCache needed a way to communicate with the BackgroundCachingJob that it was done, so it knew when to stop tailing the file. This was previously done with capturing the user_pipeline when making the StreamingCache. However, the StreamingCache is used as a global cache for all pipelines. Thus, when the pipeline was redefined the StreamingCache had a stale reference to the previous pipeline and would loop forever.\nThe fix is to change the cache key of PCollection to be pipeline specific. In this PR, it can be seen that the pipeline id is used in the cache key. This is used to tell the StreamingCache what pipeline it's associated with. The StreamingCache can't be created with the user_pipeline because the  pipeline_instrument object is dependent on the cache which creates the user pipeline.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-13T21:50:39Z", "url": "https://github.com/apache/beam/pull/11128", "merged": true, "mergeCommit": {"oid": "d545ece09d24f428518a8ebbad09b1559ce5aa23"}, "closed": true, "closedAt": "2020-03-20T01:31:15Z", "author": {"login": "rohdesamuel"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNZgX0gBqjMxMjg3MDMyNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPTZ6pgH2gAyMzg4MDExNTYxOmFhNzBiOGM0NDJiOGZjMGIyOTcxMmQwZWRmNzIyNWUzNGE1NmZkYWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38b4a64b6a260b5d14018643ccfb2984dd3f275c", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/38b4a64b6a260b5d14018643ccfb2984dd3f275c", "committedDate": "2020-03-13T21:49:58Z", "message": "Fix the streaming cache problem\n\nChange-Id: I5d53a6b23e7be4e89e72bf2756b1e82918554c98"}, "afterCommit": {"oid": "a9178bcc06e1570d608be5eb89f9b18b8aded88a", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/a9178bcc06e1570d608be5eb89f9b18b8aded88a", "committedDate": "2020-03-14T00:08:42Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9178bcc06e1570d608be5eb89f9b18b8aded88a", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/a9178bcc06e1570d608be5eb89f9b18b8aded88a", "committedDate": "2020-03-14T00:08:42Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}, "afterCommit": {"oid": "8f2efd8038eece48e1b023f619f92f240815dca9", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/8f2efd8038eece48e1b023f619f92f240815dca9", "committedDate": "2020-03-16T21:40:32Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f2efd8038eece48e1b023f619f92f240815dca9", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/8f2efd8038eece48e1b023f619f92f240815dca9", "committedDate": "2020-03-16T21:40:32Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}, "afterCommit": {"oid": "68f2c6d46d6ae343aeaaaed534079c776e425363", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/68f2c6d46d6ae343aeaaaed534079c776e425363", "committedDate": "2020-03-16T21:56:09Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68f2c6d46d6ae343aeaaaed534079c776e425363", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/68f2c6d46d6ae343aeaaaed534079c776e425363", "committedDate": "2020-03-16T21:56:09Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}, "afterCommit": {"oid": "8cb62c1fc02a23c1f5ab6fbf7643d5b08e2189d6", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/8cb62c1fc02a23c1f5ab6fbf7643d5b08e2189d6", "committedDate": "2020-03-16T22:11:06Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cb62c1fc02a23c1f5ab6fbf7643d5b08e2189d6", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/8cb62c1fc02a23c1f5ab6fbf7643d5b08e2189d6", "committedDate": "2020-03-16T22:11:06Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}, "afterCommit": {"oid": "3e1d6065d824239802f5635b8e4685be7858fbd4", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/3e1d6065d824239802f5635b8e4685be7858fbd4", "committedDate": "2020-03-16T22:49:29Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDU0MTYw", "url": "https://github.com/apache/beam/pull/11128#pullrequestreview-377054160", "createdAt": "2020-03-18T16:51:48Z", "commit": {"oid": "3e1d6065d824239802f5635b8e4685be7858fbd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo1MTo0OFrOF4OG3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo1MTo0OFrOF4OG3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NTcwOA==", "bodyText": "what is a pipeline ID? Are you sure it's unique? I see elsewhere you're using the id(..) of the objects?", "url": "https://github.com/apache/beam/pull/11128#discussion_r394495708", "createdAt": "2020-03-18T16:51:48Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/caching/streaming_cache.py", "diffHunk": "@@ -153,7 +153,8 @@ def __init__(\n     self._coder = coder\n     self._labels = labels\n     self._is_cache_complete = (\n-        is_cache_complete if is_cache_complete else lambda: True)\n+        is_cache_complete if is_cache_complete else lambda _: True)\n+    self._pipeline_id = labels[-1].split('_')[-1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e1d6065d824239802f5635b8e4685be7858fbd4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b253834668a2b8ea03ce199cfcbdbcd965be324", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/2b253834668a2b8ea03ce199cfcbdbcd965be324", "committedDate": "2020-03-19T00:58:04Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54a7e19cf7159841d4388bc9749c2083c0ee5c9b", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/54a7e19cf7159841d4388bc9749c2083c0ee5c9b", "committedDate": "2020-03-19T00:58:04Z", "message": "Add CacheKey class\n\nChange-Id: I1ab6e7036172d7e2d07c774778a50e165df6bdca"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e1d6065d824239802f5635b8e4685be7858fbd4", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/3e1d6065d824239802f5635b8e4685be7858fbd4", "committedDate": "2020-03-16T22:49:29Z", "message": "Fix ib.show() spinning forever when rexecuting cells without kernel restart\n\nChange-Id: I53aa32a75645086efffa091a53880a076c3a689d"}, "afterCommit": {"oid": "54a7e19cf7159841d4388bc9749c2083c0ee5c9b", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/54a7e19cf7159841d4388bc9749c2083c0ee5c9b", "committedDate": "2020-03-19T00:58:04Z", "message": "Add CacheKey class\n\nChange-Id: I1ab6e7036172d7e2d07c774778a50e165df6bdca"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODQzODI5", "url": "https://github.com/apache/beam/pull/11128#pullrequestreview-377843829", "createdAt": "2020-03-19T15:40:41Z", "commit": {"oid": "54a7e19cf7159841d4388bc9749c2083c0ee5c9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNTo0MDo0MVrOF40ZGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNTo0MDo0MVrOF40ZGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMjk3MA==", "bodyText": "Check length of the list?", "url": "https://github.com/apache/beam/pull/11128#discussion_r395122970", "createdAt": "2020-03-19T15:40:41Z", "author": {"login": "davidyan74"}, "path": "sdks/python/apache_beam/runners/interactive/pipeline_instrument.py", "diffHunk": "@@ -63,6 +63,24 @@ def __hash__(self):\n         self.producer_version))\n \n \n+# TODO: turn this into a dataclass object when we finally get off of Python2.\n+class CacheKey:\n+  def __init__(self, var, version, producer_version, pipeline_id):\n+    self.var = var\n+    self.version = version\n+    self.producer_version = producer_version\n+    self.pipeline_id = pipeline_id\n+\n+  @staticmethod\n+  def from_str(r):\n+    split = r.split('|')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54a7e19cf7159841d4388bc9749c2083c0ee5c9b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa70b8c442b8fc0b29712d0edf7225e34a56fdac", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/aa70b8c442b8fc0b29712d0edf7225e34a56fdac", "committedDate": "2020-03-19T22:11:27Z", "message": "fix dep loop\n\nChange-Id: I247f37cd7acffb6ad796ce0fa8b54b0feff400d1"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}