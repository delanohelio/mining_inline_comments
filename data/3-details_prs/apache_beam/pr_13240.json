{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNDYxMjg1", "number": 13240, "title": "[BEAM-11146] Add fasterCopy option to Flink runner", "bodyText": "The fasterCopy option, removes an unnecessary deep copy in the Flink runner between each operator. This should lead to improved performance in all cases. The Jira issue has more info.\nThis is my first contribution to Beam and I just did what I thought was right. The biggest issue here was to get pipeline options into the CoderTypeSerializer. I tried my best, but welcome any feedback!\nOne thing I am not quite sure how to do is test this. Should all flink tests be ran twice with this option toggled? All tests pass with the change in CoderTypeSerializer applied, but I've not tried all of them with the flag enabled. How would one go about this?\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-31T16:33:12Z", "url": "https://github.com/apache/beam/pull/13240", "merged": true, "mergeCommit": {"oid": "4836937762a026bf0ce7a681e7af513d124bc26f"}, "closed": true, "closedAt": "2020-11-03T13:06:55Z", "author": {"login": "rHermes"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdX-4fxgBqjM5NDQzMzc0ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY1fBMAFqTUyMjI5NzExOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae172d712ef9a6e062d13a00531b157fe7684935", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/ae172d712ef9a6e062d13a00531b157fe7684935", "committedDate": "2020-10-31T16:31:57Z", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases."}, "afterCommit": {"oid": "91cf254b091f1aeb83c1be2b9506bc3b056e518d", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/91cf254b091f1aeb83c1be2b9506bc3b056e518d", "committedDate": "2020-10-31T17:33:08Z", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/52943de2c1e6afbd2d752ccf0549126d42476c00", "committedDate": "2020-10-31T17:40:16Z", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91cf254b091f1aeb83c1be2b9506bc3b056e518d", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/91cf254b091f1aeb83c1be2b9506bc3b056e518d", "committedDate": "2020-10-31T17:33:08Z", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases."}, "afterCommit": {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/52943de2c1e6afbd2d752ccf0549126d42476c00", "committedDate": "2020-10-31T17:40:16Z", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTA1OTYw", "url": "https://github.com/apache/beam/pull/13240#pullrequestreview-521905960", "createdAt": "2020-11-02T18:49:20Z", "commit": {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0OToyMFrOHsRdUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo1MTozMVrOHsRhyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NTQyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private SerializablePipelineOptions pipelineOptions;\n          \n          \n            \n                private final SerializablePipelineOptions pipelineOptions;", "url": "https://github.com/apache/beam/pull/13240#discussion_r516185424", "createdAt": "2020-11-02T18:49:20Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -1194,29 +1200,35 @@ public void verifyDeterministic() throws NonDeterministicException {\n     private Map<TupleTag<?>, Integer> tagsToIds;\n     private Map<TupleTag<?>, OutputTag<WindowedValue<?>>> tagsToOutputTags;\n     private Map<TupleTag<?>, Coder<WindowedValue<?>>> tagsToCoders;\n+    private SerializablePipelineOptions pipelineOptions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NjU3MA==", "bodyText": "Perhaps, create a static factory method for all of these defaults? E.g. FlinkPipelineOptions.default()", "url": "https://github.com/apache/beam/pull/13240#discussion_r516186570", "createdAt": "2020-11-02T18:51:31Z", "author": {"login": "mxm"}, "path": "runners/flink/src/test/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperatorTest.java", "diffHunk": "@@ -761,7 +797,9 @@ void testSideInputs(boolean keyed) throws Exception {\n               doFnOperator,\n               keySelector,\n               null,\n-              new CoderTypeInformation<>(FlinkKeyUtils.ByteBufferCoder.of()));\n+              new CoderTypeInformation<>(\n+                  FlinkKeyUtils.ByteBufferCoder.of(),\n+                  PipelineOptionsFactory.as(FlinkPipelineOptions.class)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "504f4df1e0986414df2b9104b53af931f46c34a6", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/504f4df1e0986414df2b9104b53af931f46c34a6", "committedDate": "2020-11-02T19:25:28Z", "message": "Merge remote-tracking branch 'upstream/master' into BEAM-11146-faster-copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ff19db299dc3c231939efdce140bb33185e121", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/c8ff19db299dc3c231939efdce140bb33185e121", "committedDate": "2020-11-03T07:27:22Z", "message": "Add defaults() function to FlinkPipelineOptions\n\nThis was requested in the pull request, to make things neater."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c2554e2db47e924a4628d570131489799f7c731", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/4c2554e2db47e924a4628d570131489799f7c731", "committedDate": "2020-11-02T20:06:42Z", "message": "Add defaults() function to FlinkPipelineOptions\n\nThis was requested in the pull request, to make things neater."}, "afterCommit": {"oid": "c8ff19db299dc3c231939efdce140bb33185e121", "author": {"user": {"login": "rHermes", "name": "Teodor Sp\u00e6ren"}}, "url": "https://github.com/apache/beam/commit/c8ff19db299dc3c231939efdce140bb33185e121", "committedDate": "2020-11-03T07:27:22Z", "message": "Add defaults() function to FlinkPipelineOptions\n\nThis was requested in the pull request, to make things neater."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMjk3MTE5", "url": "https://github.com/apache/beam/pull/13240#pullrequestreview-522297119", "createdAt": "2020-11-03T09:07:41Z", "commit": {"oid": "c8ff19db299dc3c231939efdce140bb33185e121"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwOTowNzo0MVrOHslgSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwOTowODoxMlrOHslhbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA==", "bodyText": "Small suggestion, can we name this zeroCopy, as that is actually what it is.", "url": "https://github.com/apache/beam/pull/13240#discussion_r516513864", "createdAt": "2020-11-03T09:07:41Z", "author": {"login": "je-ik"}, "path": "runners/flink/1.8/src/main/java/org/apache/beam/runners/flink/translation/types/CoderTypeSerializer.java", "diffHunk": "@@ -49,20 +50,18 @@\n    * org.apache.beam.sdk.io.FileSystems} registration needed for {@link\n    * org.apache.beam.sdk.transforms.Reshuffle} translation.\n    */\n-  @SuppressWarnings(\"unused\")\n-  private final @Nullable SerializablePipelineOptions pipelineOptions;\n+  private final SerializablePipelineOptions pipelineOptions;\n \n-  public CoderTypeSerializer(Coder<T> coder) {\n-    Preconditions.checkNotNull(coder);\n-    this.coder = coder;\n-    this.pipelineOptions = null;\n-  }\n+  private final boolean fasterCopy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8ff19db299dc3c231939efdce140bb33185e121"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNDE1Ng==", "bodyText": "Maybe rename to copyIfNeeded, as when the flag is on, it doesn't copy anything.", "url": "https://github.com/apache/beam/pull/13240#discussion_r516514156", "createdAt": "2020-11-03T09:08:12Z", "author": {"login": "je-ik"}, "path": "runners/flink/1.8/src/main/java/org/apache/beam/runners/flink/translation/types/CoderTypeSerializer.java", "diffHunk": "@@ -82,10 +81,14 @@ public T createInstance() {\n \n   @Override\n   public T copy(T t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8ff19db299dc3c231939efdce140bb33185e121"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1847, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}