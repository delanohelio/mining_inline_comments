{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjQ5NzEw", "number": 11557, "title": "[BEAM-9845] Stage artifacts over expansion service.", "bodyText": "This removes the need for a special jar_packages experiment, allowing expansion services to specify their own dependencies.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-28T17:11:08Z", "url": "https://github.com/apache/beam/pull/11557", "merged": true, "mergeCommit": {"oid": "10dc1bb683aa9c219397cb3474b676a4fbac5a0e"}, "closed": true, "closedAt": "2020-05-08T05:33:36Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccHIvvgBqjMyODEzMjQxMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgWUfUgFqTQwOTUzNDQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b685ac1421f2b65486ce9a4486da95a871f95f04", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/b685ac1421f2b65486ce9a4486da95a871f95f04", "committedDate": "2020-04-28T17:00:56Z", "message": "[BEAM-9845] Stage artifacts over expansion service."}, "afterCommit": {"oid": "8fbb78a493b1baa5b4e6e1ae3e12a1f4575f8c64", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8fbb78a493b1baa5b4e6e1ae3e12a1f4575f8c64", "committedDate": "2020-04-28T17:14:41Z", "message": "[BEAM-9845] Stage artifacts over expansion service."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTgyNDg3", "url": "https://github.com/apache/beam/pull/11557#pullrequestreview-403582487", "createdAt": "2020-04-30T14:35:46Z", "commit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozNTo0N1rOGOsO_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToxNjowMVrOGOuCyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA1Nzk4Mg==", "bodyText": "Is the resolution order documented somewhere?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418057982", "createdAt": "2020-04-30T14:35:47Z", "author": {"login": "mxm"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/DefaultArtifactResolver.java", "diffHunk": "@@ -62,6 +63,24 @@ public void register(ResolutionFn fn) {\n     fns.add(fn);\n   }\n \n+  @Override\n+  public List<RunnerApi.ArtifactInformation> resolveArtifacts(\n+      List<RunnerApi.ArtifactInformation> artifacts) {\n+    for (ResolutionFn fn : Lists.reverse(fns)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MDc0NQ==", "bodyText": "Was this necessary to transfer the artifacts?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418060745", "createdAt": "2020-04-30T14:39:20Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/utils/subprocess_server.py", "diffHunk": "@@ -98,7 +98,9 @@ def log_stdout():\n         t.daemon = True\n         t.start()\n         wait_secs = .1\n-        channel = grpc.insecure_channel(endpoint)\n+        channel_options = [(\"grpc.max_receive_message_length\", -1),\n+                           (\"grpc.max_send_message_length\", -1)]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MzgwOA==", "bodyText": "Please remove or replace with logging", "url": "https://github.com/apache/beam/pull/11557#discussion_r418083808", "createdAt": "2020-04-30T15:10:31Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -317,13 +317,17 @@ def expand(self, pvalueish):\n         transform=transform_proto)\n \n     with self._service() as service:\n+      print(type(service))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4NzYyNQ==", "bodyText": "Should this be prefixed by something pipeline-specific?", "url": "https://github.com/apache/beam/pull/11557#discussion_r418087625", "createdAt": "2020-04-30T15:16:01Z", "author": {"login": "mxm"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -211,6 +211,8 @@ def __init__(self, runner=None, options=None, argv=None):\n         experiments.append('beam_fn_api')\n         self._options.view_as(DebugOptions).experiments = experiments\n \n+    self.local_tempdir = tempfile.mkdtemp(prefix='beam-pipeline-temp')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTUxOTc4", "url": "https://github.com/apache/beam/pull/11557#pullrequestreview-403951978", "createdAt": "2020-04-30T23:51:35Z", "commit": {"oid": "4e39d055007060288d6c3abc32cd14f51d47f3a5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTc3Njc1", "url": "https://github.com/apache/beam/pull/11557#pullrequestreview-403977675", "createdAt": "2020-05-01T01:22:15Z", "commit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToyMjoxNlrOGO_lwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToyOTo1NVrOGO_sjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3NTEwNg==", "bodyText": "This assumes that the set of classpath resources required to execute Java SDK harness and execute the cross-langauge Java step to be the same as the set of classpath resources specified when starting up the expansion service, right ?\nI'm wondering if we can always rely on this. At least we should document this so that users are aware how to stage additional resources if needed.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418375106", "createdAt": "2020-05-01T01:22:16Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/expansion-service/src/main/java/org/apache/beam/sdk/expansion/service/ExpansionService.java", "diffHunk": "@@ -317,6 +321,14 @@ default InputT createInput(Pipeline p, Map<String, PCollection<?>> inputs) {\n     Pipeline pipeline = Pipeline.create();\n     ExperimentalOptions.addExperiment(\n         pipeline.getOptions().as(ExperimentalOptions.class), \"beam_fn_api\");\n+    List<String> classpathResources =\n+        detectClassPathResourcesToStage(Environments.class.getClassLoader(), pipeline.getOptions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3Njg0NQ==", "bodyText": "Can we update 'validate_runner_xlang_test.py' for Spark and Flink as well or do we need additional changes before that.\njar_packages cannot be completely removed yet since Dataflow needs it.", "url": "https://github.com/apache/beam/pull/11557#discussion_r418376845", "createdAt": "2020-05-01T01:29:55Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/transforms/sql_test.py", "diffHunk": "@@ -66,20 +66,8 @@ class SqlTransformTest(unittest.TestCase):\n         --tests apache_beam.transforms.sql_test \\\\\n         --test-pipeline-options=\"--runner=FlinkRunner\"\n   \"\"\"\n-  @staticmethod\n-  def make_test_pipeline():\n-    path_to_jar = subprocess_server.JavaJarServer.path_to_beam_jar(\n-        \":sdks:java:extensions:sql:expansion-service:shadowJar\")\n-    test_pipeline = TestPipeline()\n-    # TODO(BEAM-9238): Remove this when it's no longer needed for artifact\n-    # staging.\n-    test_pipeline.get_pipeline_options().view_as(DebugOptions).experiments = [\n-        'jar_packages=' + path_to_jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47361eccc0ff5b9c64e7cd30702c27a25a518e0"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7b5e4a65c699f3a1e3c39ff7dc27d108585afeb", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/e7b5e4a65c699f3a1e3c39ff7dc27d108585afeb", "committedDate": "2020-05-05T06:30:50Z", "message": "[BEAM-9577] Resolve dependencies in Java expansion service."}, "afterCommit": {"oid": "93fe47337a5dbd14e3d6dba79484f51bf82d424c", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/93fe47337a5dbd14e3d6dba79484f51bf82d424c", "committedDate": "2020-05-05T08:26:52Z", "message": "[BEAM-9577] Resolve dependencies in Java expansion service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e725118fb1afb6d869b9b4e19110aae26ddd26ed", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/e725118fb1afb6d869b9b4e19110aae26ddd26ed", "committedDate": "2020-05-06T08:46:27Z", "message": "Move job server to its own module.\n\nThis avoids circular dependencies with the expansion service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61d0029246b7af7c656d03f10b3001475a811ea9", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/61d0029246b7af7c656d03f10b3001475a811ea9", "committedDate": "2020-05-06T08:46:27Z", "message": "[BEAM-9845] Stage artifacts over expansion service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "544e56874a84deee4e597b48ce8d3b501ab117a6", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/544e56874a84deee4e597b48ce8d3b501ab117a6", "committedDate": "2020-05-06T08:46:27Z", "message": "[BEAM-9577] Resolve dependencies in Java expansion service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de83a82c1d22a8eda9f214a6d57e9d69215979de", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/de83a82c1d22a8eda9f214a6d57e9d69215979de", "committedDate": "2020-05-06T10:09:18Z", "message": "Start artifact service in expansion service driver.\n0;256;0c# Please enter the commit message for your changes. Lines starting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93fe47337a5dbd14e3d6dba79484f51bf82d424c", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/93fe47337a5dbd14e3d6dba79484f51bf82d424c", "committedDate": "2020-05-05T08:26:52Z", "message": "[BEAM-9577] Resolve dependencies in Java expansion service."}, "afterCommit": {"oid": "de83a82c1d22a8eda9f214a6d57e9d69215979de", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/de83a82c1d22a8eda9f214a6d57e9d69215979de", "committedDate": "2020-05-06T10:09:18Z", "message": "Start artifact service in expansion service driver.\n0;256;0c# Please enter the commit message for your changes. Lines starting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTM0NDA3", "url": "https://github.com/apache/beam/pull/11557#pullrequestreview-409534407", "createdAt": "2020-05-11T21:11:57Z", "commit": {"oid": "de83a82c1d22a8eda9f214a6d57e9d69215979de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMToxMTo1N1rOGTtjmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMToxMTo1N1rOGTtjmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyMjUyMA==", "bodyText": "This import is guarded and optional. So if the guard fails, this always fails.", "url": "https://github.com/apache/beam/pull/11557#discussion_r423322520", "createdAt": "2020-05-11T21:11:57Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -443,6 +470,18 @@ def _normalize(coder_proto):\n         environment_id=self._expanded_transform.environment_id)\n \n \n+class ExpansionAndArtifactRetrievalStub(\n+    beam_expansion_api_pb2_grpc.ExpansionServiceStub):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de83a82c1d22a8eda9f214a6d57e9d69215979de"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4055, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}