{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzM4NTY1", "number": 11472, "title": "[BEAM-2939, BEAM-5602] Migrate from HasSize to HasProgress interface for restriction trackers and use the progress value during sizing, splitting and reporting", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-20T22:37:36Z", "url": "https://github.com/apache/beam/pull/11472", "merged": true, "mergeCommit": {"oid": "0291976d6029b4cf4d72caa03bd3836900fb6328"}, "closed": true, "closedAt": "2020-04-23T19:06:27Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaL_mMABqjMyNjE3NDE1NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcahu1QAFqTM5OTM5NDY0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1ad28b6f74f67e13256c0c09a2c9669ca302b6c", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/e1ad28b6f74f67e13256c0c09a2c9669ca302b6c", "committedDate": "2020-04-21T02:01:22Z", "message": "fixup! Fix unit test and update Read reporting to correctly report work completed and work remaining instead of relying on initial size which can't be reported effectively."}, "afterCommit": {"oid": "561c1cae399927ea7b2ea2f23c0bbb356ba591f7", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/561c1cae399927ea7b2ea2f23c0bbb356ba591f7", "committedDate": "2020-04-22T17:46:17Z", "message": "[BEAM-2939] Fold Sizes sub-interfaces into RestrictionTracker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "561c1cae399927ea7b2ea2f23c0bbb356ba591f7", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/561c1cae399927ea7b2ea2f23c0bbb356ba591f7", "committedDate": "2020-04-22T17:46:17Z", "message": "[BEAM-2939] Fold Sizes sub-interfaces into RestrictionTracker"}, "afterCommit": {"oid": "1c842638e13a37caa9456f500d68255ea806ebe3", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/1c842638e13a37caa9456f500d68255ea806ebe3", "committedDate": "2020-04-22T17:55:52Z", "message": "[BEAM-2939] Fold Sizes sub-interfaces into RestrictionTracker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93b3a0ffdfecd4d2a29c49306a8f0679f008fedc", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/93b3a0ffdfecd4d2a29c49306a8f0679f008fedc", "committedDate": "2020-04-22T22:47:54Z", "message": "[BEAM-2939] Expose HasProgress interface for restriction trackers and use the progress value during splitting\n\nNote that this change excludes a necessary \"rename\" of the Sizes class to something more appropriate to make the review simpler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7568b060c343574d2c9c7eec5c5e37ee9bbf0159", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/7568b060c343574d2c9c7eec5c5e37ee9bbf0159", "committedDate": "2020-04-22T22:47:54Z", "message": "[BEAM-2939] Add the ability for SDK harness runners to provide additional monitoring infos.\n\nThis is towards reporting splittable dofn work completed and work remaining."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac97ea0e32834506de29103697d42cec9fcdb97", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/7ac97ea0e32834506de29103697d42cec9fcdb97", "committedDate": "2020-04-22T22:47:54Z", "message": "[BEAM-2939] Integrate progress reporting for splittable dofns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a02eb606ae56570ec8a5ae68d3f70578efe9abf9", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/a02eb606ae56570ec8a5ae68d3f70578efe9abf9", "committedDate": "2020-04-22T22:47:55Z", "message": "[BEAM-2939] Fold Sizes sub-interfaces into RestrictionTracker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/cfa6692bd82b4c7db44c9c9c5083792f94dd8e98", "committedDate": "2020-04-22T22:47:55Z", "message": "[BEAM-2939] Drop HasSize in favor of using HasProgress#getProgress#getWorkRemaining as the default if the DoFn doesn't override GetSize."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c842638e13a37caa9456f500d68255ea806ebe3", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/1c842638e13a37caa9456f500d68255ea806ebe3", "committedDate": "2020-04-22T17:55:52Z", "message": "[BEAM-2939] Fold Sizes sub-interfaces into RestrictionTracker"}, "afterCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/cfa6692bd82b4c7db44c9c9c5083792f94dd8e98", "committedDate": "2020-04-22T22:47:55Z", "message": "[BEAM-2939] Drop HasSize in favor of using HasProgress#getProgress#getWorkRemaining as the default if the DoFn doesn't override GetSize."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzQ0ODk1", "url": "https://github.com/apache/beam/pull/11472#pullrequestreview-398744895", "createdAt": "2020-04-23T04:06:53Z", "commit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDowNjo1M1rOGKVoyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDoyNTowOFrOGKV9ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5MzQ1MA==", "bodyText": "Do we want to highlight that this fallback may impact batch autoscaling if HasProcess is not implemented correctly.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413493450", "createdAt": "2020-04-23T04:06:53Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/DoFnInvoker.java", "diffHunk": "@@ -94,9 +94,13 @@ void invokeOnTimer(\n   void invokeSplitRestriction(ArgumentProvider<InputT, OutputT> arguments);\n \n   /**\n-   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to get the size\n-   * from the {@link RestrictionTracker} if it supports {@link Sizes.HasSize}, otherwise returns\n-   * 1.0.\n+   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to:\n+   *\n+   * <ol>\n+   *   <li>get the work remaining from the {@link RestrictionTracker} if it supports {@link\n+   *       HasProgress}.\n+   *   <li>returning the constant {@link 1.0}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NDI5Ng==", "bodyText": "I'm not very familiar with how this invoker works but I thought we check whether restrictionTracker  has HasSize, if not then fallback to progress.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413494296", "createdAt": "2020-04-23T04:09:50Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "diffHunk": "@@ -397,12 +396,14 @@ public WatermarkEstimatorStateT getState() {\n   }\n \n   public static class DefaultGetSize {\n-    /** Uses {@link Sizes.HasSize} to produce the size. */\n+    /** Uses {@link HasProgress} to produce the size. */\n     @SuppressWarnings(\"unused\")\n     public static <InputT, OutputT> double invokeGetSize(\n         DoFnInvoker.ArgumentProvider<InputT, OutputT> argumentProvider) {\n-      if (argumentProvider.restrictionTracker() instanceof HasSize) {\n-        return ((HasSize) argumentProvider.restrictionTracker()).getSize();\n+      if (argumentProvider.restrictionTracker() instanceof HasProgress) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5ODgxMA==", "bodyText": "I though we still want to keep this and make HasProgress as a fallback?", "url": "https://github.com/apache/beam/pull/11472#discussion_r413498810", "createdAt": "2020-04-23T04:25:08Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/Sizes.java", "diffHunk": "@@ -1,54 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.beam.sdk.transforms.splittabledofn;\n-\n-import org.apache.beam.sdk.annotations.Experimental;\n-import org.apache.beam.sdk.annotations.Experimental.Kind;\n-\n-/** Definitions and convenience methods for reporting sizes for SplittableDoFns. */\n-@Experimental(Kind.SPLITTABLE_DO_FN)\n-public final class Sizes {\n-  /**\n-   * {@link RestrictionTracker}s which can provide a size should implement this interface.\n-   * Implementations that do not implement this interface will be assumed to have an equivalent\n-   * size.\n-   */\n-  public interface HasSize {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzYyMDg3", "url": "https://github.com/apache/beam/pull/11472#pullrequestreview-399362087", "createdAt": "2020-04-23T18:22:18Z", "commit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODoyMjoxOFrOGK18zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODoyMjoxOFrOGK18zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMjg2MQ==", "bodyText": "When a bundle finished, will the progress.workRemaining always be 0?", "url": "https://github.com/apache/beam/pull/11472#discussion_r414022861", "createdAt": "2020-04-23T18:22:18Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -311,9 +315,14 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       // Get finish bundle Execution Time Metrics.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getFinishFunctionRegistry().getExecutionTimeMonitoringInfos());\n-      // Extract all other MonitoringInfos other than the execution time monitoring infos.\n+      // Extract MonitoringInfos that come from the metrics container registry.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getMetricsContainerRegistry().getMonitoringInfos());\n+      // Add any additional monitoring infos that the \"runners\" report explicitly.\n+      for (ProgressRequestCallback progressRequestCallback :\n+          bundleProcessor.getProgressRequestCallbacks()) {\n+        response.addAllMonitoringInfos(progressRequestCallback.getMonitoringInfos());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5Mzk0NjQ5", "url": "https://github.com/apache/beam/pull/11472#pullrequestreview-399394649", "createdAt": "2020-04-23T19:06:08Z", "commit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4341, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}