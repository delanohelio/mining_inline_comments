{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MzQ5MTY4", "number": 10504, "title": "[BEAM-9062] Improve assertion error for equal_to", "bodyText": "Now lists the first element found in actual not found in expected, or all of the elements from actual. Only effects the exception error message, which is not covered by any unit tests.\nPlease add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-05T23:53:19Z", "url": "https://github.com/apache/beam/pull/10504", "merged": true, "mergeCommit": {"oid": "383357757294c84fd905b412a5314e4830d1493b"}, "closed": true, "closedAt": "2020-01-07T22:46:39Z", "author": {"login": "sorensenjs"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3gfi_gH2gAyMzU5MzQ5MTY4OmJiM2NkNGYxZDM1NDBhMDY2NWQ2MmQzNjM2MmM4Y2YxMzFiOGI4YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4GY0xAFqTMzOTQ3MzY5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb3cd4f1d3540a0665d62d36362c8cf131b8b8ad", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/bb3cd4f1d3540a0665d62d36362c8cf131b8b8ad", "committedDate": "2020-01-05T23:52:11Z", "message": "Improve assertion error for equal_to\n\nNow lists the first element found in actual not found in expected, or all of the elements from actual. Only effects the exception error message, which is not covered by any unit tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODc5NjU2", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-338879656", "createdAt": "2020-01-06T20:35:28Z", "commit": {"oid": "bb3cd4f1d3540a0665d62d36362c8cf131b8b8ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMDozNToyOFrOFaohiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMDozNToyOFrOFaohiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ3MTI0MA==", "bodyText": "Thanks, @sorensenjs!\n'expected missing X' may be also read as:  expected the missing element X. Consider rewording as \"unexpected element\" and \"missing element\".", "url": "https://github.com/apache/beam/pull/10504#discussion_r363471240", "createdAt": "2020-01-06T20:35:28Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/util.py", "diffHunk": "@@ -179,10 +179,11 @@ def _equal(actual):\n           expected_list.remove(element)\n         except ValueError:\n           raise BeamAssertException(\n-              'Failed assert: %r == %r' % (expected, actual))\n+              'Failed assert: %r == %r, expected missing %r' %", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb3cd4f1d3540a0665d62d36362c8cf131b8b8ad"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70d6e42d3c84144f75e80fe9e0b51381dfec62f3", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/70d6e42d3c84144f75e80fe9e0b51381dfec62f3", "committedDate": "2020-01-06T21:35:58Z", "message": "Update util.py\n\nAddress recommended change to add 'element' to clarify exception message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64b0351a4a1db60165d2e14a4fb9d6aa193d4b3e", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/64b0351a4a1db60165d2e14a4fb9d6aa193d4b3e", "committedDate": "2020-01-06T21:40:03Z", "message": "Update util.py\n\nFurther clarifications."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTU3NTA2", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-338957506", "createdAt": "2020-01-06T23:30:48Z", "commit": {"oid": "64b0351a4a1db60165d2e14a4fb9d6aa193d4b3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzozMDo0OFrOFasN3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzozMDo0OFrOFasN3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzMTc0Mg==", "bodyText": "This line exceeds 80 characters. Please fix. Thanks to this PR I realized our lint checker stopped catching this error: https://issues.apache.org/jira/browse/BEAM-9058. Fix is in flight (#10510).", "url": "https://github.com/apache/beam/pull/10504#discussion_r363531742", "createdAt": "2020-01-06T23:30:48Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/util.py", "diffHunk": "@@ -179,11 +179,12 @@ def _equal(actual):\n           expected_list.remove(element)\n         except ValueError:\n           raise BeamAssertException(\n-              'Failed assert: %r == %r, expected missing element %r' %\n+              'Failed assert: %r == %r, right side missing at least element %r' %", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64b0351a4a1db60165d2e14a4fb9d6aa193d4b3e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf72fdc862ebc3415f5575510a7adc5ecaa78f51", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/cf72fdc862ebc3415f5575510a7adc5ecaa78f51", "committedDate": "2020-01-07T00:06:56Z", "message": "Update util.py\n\nFix line too long."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "820d2a2c65b5907357c7c9ff8503b1c570ca45d9", "author": {"user": {"login": "tvalentyn", "name": null}}, "url": "https://github.com/apache/beam/commit/820d2a2c65b5907357c7c9ff8503b1c570ca45d9", "committedDate": "2020-01-07T00:23:09Z", "message": "Switch left and right."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7c426a35f20a154e31d0ff281ba6fba96a5ef17", "author": {"user": {"login": "tvalentyn", "name": null}}, "url": "https://github.com/apache/beam/commit/f7c426a35f20a154e31d0ff281ba6fba96a5ef17", "committedDate": "2020-01-07T01:13:22Z", "message": "Switch actual<->expected, left<->right and add a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e688f2ef90ae6dc12e0ac53ca50998801e313ffe", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/e688f2ef90ae6dc12e0ac53ca50998801e313ffe", "committedDate": "2020-01-07T01:28:09Z", "message": "Add unit tests and more complete messaging about missing elements."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2fca02b548f6dc287499b85d62a9502e02ed97a", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/e2fca02b548f6dc287499b85d62a9502e02ed97a", "committedDate": "2020-01-07T01:32:11Z", "message": "Merge branch 'patch-1' of https://github.com/sorensenjs/beam into patch-1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b286e45bb06200608423f505cb82523e1d353f98", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/b286e45bb06200608423f505cb82523e1d353f98", "committedDate": "2020-01-07T01:34:27Z", "message": "Resolve merge conflict."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d48036a5f57ac4eb8c189397c0f0c6ee4d2199c7", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/d48036a5f57ac4eb8c189397c0f0c6ee4d2199c7", "committedDate": "2020-01-07T01:48:02Z", "message": "Switch actual and expected print order."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDAwODkz", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-339000893", "createdAt": "2020-01-07T02:21:02Z", "commit": {"oid": "d48036a5f57ac4eb8c189397c0f0c6ee4d2199c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMjoyMTowMlrOFauZFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMjoyMTowMlrOFauZFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU2NzM4Mg==", "bodyText": "Since currently LHS is actual, RHS is expected, I think the error should say \"right side is missing...\" or \"unexpected elements: ...\", and left_missing should be renamed.", "url": "https://github.com/apache/beam/pull/10504#discussion_r363567382", "createdAt": "2020-01-07T02:21:02Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/util.py", "diffHunk": "@@ -166,23 +166,27 @@ def _equal(actual):\n       sorted_actual = sorted(actual)\n       if sorted_expected != sorted_actual:\n         raise BeamAssertException(\n-            'Failed assert: %r == %r' % (sorted_expected, sorted_actual))\n+            'Failed assert: %r == %r' % (sorted_actual, sorted_expected))\n     # Slower method, used in two cases:\n     # 1) If sorted expected != actual, use this method to verify the inequality.\n     #    This ensures we don't raise any false negatives for types that don't\n     #    have a deterministic sort order.\n     # 2) As a fallback if we encounter a TypeError in python 3. this method\n     #    works on collections that have different types.\n     except (BeamAssertException, TypeError):\n+      left_missing = []\n       for element in actual:\n         try:\n           expected_list.remove(element)\n         except ValueError:\n-          raise BeamAssertException(\n-              'Failed assert: %r == %r' % (expected, actual))\n-      if expected_list:\n-        raise BeamAssertException(\n-            'Failed assert: %r == %r' % (expected, actual))\n+          left_missing.append(element)\n+      if left_missing or expected_list:\n+        msg = 'Failed assert: %r == %r' % (actual, expected)\n+        if left_missing:\n+          msg = msg + ', left side missing elements %r' % left_missing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d48036a5f57ac4eb8c189397c0f0c6ee4d2199c7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea925f5dc456b178512df6e113f7eae6c6c2c97", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/eea925f5dc456b178512df6e113f7eae6c6c2c97", "committedDate": "2020-01-07T02:51:33Z", "message": "Remove left/right in favor of missing and unexpected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzYxODU5", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-339361859", "createdAt": "2020-01-07T16:44:35Z", "commit": {"oid": "eea925f5dc456b178512df6e113f7eae6c6c2c97"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjo0NDozNlrOFa_H3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjo0NDozNlrOFa_H3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg0MTUwMg==", "bodyText": "nit: extra \"missing\" in test name.", "url": "https://github.com/apache/beam/pull/10504#discussion_r363841502", "createdAt": "2020-01-07T16:44:36Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/util_test.py", "diffHunk": "@@ -67,6 +67,26 @@ def test_assert_that_fails(self):\n       with TestPipeline() as p:\n         assert_that(p | Create([1, 10, 100]), equal_to([1, 2, 3]))\n \n+  def test_assert_missing(self):\n+    with self.assertRaisesRegexp(Exception,\n+                                 \"missing elements \\['c'\\]\"):\n+      with TestPipeline() as p:\n+        assert_that(p | Create(['a', 'b']), equal_to(['a', 'b', 'c']))\n+\n+  def test_assert_unexpected(self):\n+    with self.assertRaisesRegexp(Exception,\n+                                 \"unexpected elements \\['c', 'd'\\]\"):\n+      with TestPipeline() as p:\n+        assert_that(p | Create(['a', 'b', 'c', 'd']), equal_to(['a', 'b']))\n+\n+  def test_assert_missing_missing_and_unexpected(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea925f5dc456b178512df6e113f7eae6c6c2c97"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da60159a22a6f7b82bd8a3c42e84577fe670ae81", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/da60159a22a6f7b82bd8a3c42e84577fe670ae81", "committedDate": "2020-01-07T17:11:10Z", "message": "Address lint errors, and remove extra missing in test name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ea6e63ffb30eb7c02df179835089d72df4f21a", "author": {"user": {"login": "sorensenjs", "name": "Jeffrey Sorensen"}}, "url": "https://github.com/apache/beam/commit/74ea6e63ffb30eb7c02df179835089d72df4f21a", "committedDate": "2020-01-07T18:39:05Z", "message": "Make lint clean on py2/py3."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ced311b21e338a6a14cbbef6a04d871b67c4c73f", "author": {"user": {"login": "tvalentyn", "name": null}}, "url": "https://github.com/apache/beam/commit/ced311b21e338a6a14cbbef6a04d871b67c4c73f", "committedDate": "2020-01-07T19:56:23Z", "message": "Switch Py2 and Py3 try-except clause to avoid a warning at test runtime on Py3 and add another possible order of unexpected elements."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDczMDE1", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-339473015", "createdAt": "2020-01-07T19:59:54Z", "commit": {"oid": "74ea6e63ffb30eb7c02df179835089d72df4f21a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOTo1OTo1NVrOFbEOrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOTo1OTo1NVrOFbEOrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyNTE2NA==", "bodyText": "PCollections don't guarantee the order of elements, so once PCollection materializes we may access its elements in the order of 'a', 'b', 'd', 'c', in which case the generated error message will be \"unexpected elements ['d', 'c']\". While also correct, this message will fail current assertion. Added a small change to accommodate that, and reversed the order in try clause to avoid a warning at runtime on Py3.", "url": "https://github.com/apache/beam/pull/10504#discussion_r363925164", "createdAt": "2020-01-07T19:59:55Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/util_test.py", "diffHunk": "@@ -67,6 +73,26 @@ def test_assert_that_fails(self):\n       with TestPipeline() as p:\n         assert_that(p | Create([1, 10, 100]), equal_to([1, 2, 3]))\n \n+  def test_assert_missing(self):\n+    with self.assertRaisesRegex(BeamAssertException,\n+                                r\"missing elements \\['c'\\]\"):\n+      with TestPipeline() as p:\n+        assert_that(p | Create(['a', 'b']), equal_to(['a', 'b', 'c']))\n+\n+  def test_assert_unexpected(self):\n+    with self.assertRaisesRegex(BeamAssertException,\n+                                r\"unexpected elements \\['c', 'd'\\]\"):\n+      with TestPipeline() as p:\n+        assert_that(p | Create(['a', 'b', 'c', 'd']), equal_to(['a', 'b']))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ea6e63ffb30eb7c02df179835089d72df4f21a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDczNjk5", "url": "https://github.com/apache/beam/pull/10504#pullrequestreview-339473699", "createdAt": "2020-01-07T20:01:14Z", "commit": {"oid": "ced311b21e338a6a14cbbef6a04d871b67c4c73f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3901, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}