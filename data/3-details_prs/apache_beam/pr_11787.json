{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjU4Njgx", "number": 11787, "title": "[BEAM-10063] Better emulate the pandas testing environment.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-05-22T00:56:44Z", "url": "https://github.com/apache/beam/pull/11787", "merged": true, "mergeCommit": {"oid": "e3ba948a05155311eb51adf5fe1ee9648ab782b8"}, "closed": true, "closedAt": "2020-06-04T15:58:26Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcj0osygH2gAyNDIxNjU4NjgxOjViZmEwNGIzZmQ1Zjg5ZWM3MmY5ZjQ0NTE0MDFlYjAzNDc3MzdlZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn2Gb_AH2gAyNDIxNjU4NjgxOmMxMGEyNTE3ODc1ZGM3ZTI3YWRiYzVlMGM1MGViN2E2Zjg3NjZiMjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "committedDate": "2020-05-22T16:12:57Z", "message": "[BEAM-10063] Better emulate the pandas testing environment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b22ffb744e484dce3ac19e0c0fca8ee60553d7ef", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/b22ffb744e484dce3ac19e0c0fca8ee60553d7ef", "committedDate": "2020-05-22T00:55:55Z", "message": "[BEAM-10063] Better emulate the pandas testing environment."}, "afterCommit": {"oid": "5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/5bfa04b3fd5f89ec72f9f4451401eb0347737efb", "committedDate": "2020-05-22T16:12:57Z", "message": "[BEAM-10063] Better emulate the pandas testing environment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64", "committedDate": "2020-05-26T16:18:51Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDEzNzI5", "url": "https://github.com/apache/beam/pull/11787#pullrequestreview-424013729", "createdAt": "2020-06-03T23:57:08Z", "commit": {"oid": "a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMzo1NzowOFrOGexXhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMzo1NzowOFrOGexXhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkxOTMwMw==", "bodyText": "It looks like this is inlined in FakePandasObject.__call__ now, we should either remove _deferred_frame or call it from FakePandasObject. I think I'm partial to the latter since the method modifies _inputs, but either way is fine.", "url": "https://github.com/apache/beam/pull/11787#discussion_r434919303", "createdAt": "2020-06-03T23:57:08Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/dataframe/doctests.py", "diffHunk": "@@ -66,30 +93,19 @@ def __init__(self):\n     self._all_frames = {}\n \n   def fake_pandas_module(self):\n-    class FakePandas(object):\n-      \"\"\"A stand-in for the pandas top-level module.\n-      \"\"\"\n-      # For now, only populated with the frame types (below).\n-      # TODO(BEAM-9561): We may want to put more here.\n-      pass\n-\n-    fake_pd = FakePandas()\n-    for pandas_type, deferred_type in DeferredFrame._pandas_type_map.items():\n-      setattr(\n-          fake_pd,\n-          pandas_type.__name__,\n-          self._deferred_frame(pandas_type, deferred_type))\n-\n-    return fake_pd\n-\n-  def _deferred_frame(self, pandas_type, deferred_type):\n+    return FakePandasObject(pd, self)\n+\n+  def _deferred_frame(self, pandas_callable):\n     \"\"\"Creates a \"constructor\" that record the actual value as an input and\n     returns a placeholder frame in its place.\"\"\"\n     def wrapper(*args, **kwargs):\n-      df = pandas_type(*args, **kwargs)\n-      placeholder = expressions.PlaceholderExpression(df[0:0])\n-      self._inputs[placeholder] = df\n-      return deferred_type(placeholder)\n+      df = pandas_callable(*args, **kwargs)\n+      if type(df) in DeferredFrame._pandas_type_map.keys():\n+        placeholder = expressions.PlaceholderExpression(df[0:0])\n+        self._inputs[placeholder] = df\n+        return DeferredFrame.wrap(placeholder)\n+      else:\n+        return df", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a34ed5ec5cd90a735ac214aab7ffee82d0c8cb64"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c10a2517875dc7e27adbc5e0c50eb7a6f8766b29", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/c10a2517875dc7e27adbc5e0c50eb7a6f8766b29", "committedDate": "2020-06-04T04:11:02Z", "message": "remove unused copy of code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4797, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}