{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODQyODk4", "number": 12067, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0MToyMVrOEJSryA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyODoyMVrOEKrl5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTc4NzYwOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/pipeline_context.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0MToyMVrOGpxUzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0MToyMVrOGpxUzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1Mjk0Mg==", "bodyText": "Partitioning the cached ID assignments by id(pipeline) is a sub-par and dangerous solution because id is only guaranteed to be unique among objects that have non-overlapping lifetimes. If we go with something like this approach, we need to at least tie these instances' lifetimes to the lifetime of the pipeline.", "url": "https://github.com/apache/beam/pull/12067#discussion_r446452942", "createdAt": "2020-06-26T23:41:21Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/runners/pipeline_context.py", "diffHunk": "@@ -49,6 +50,52 @@\n   from apache_beam.coders.coder_impl import IterableStateWriter\n \n \n+class _UniqueRefAssigner(object):\n+  \"\"\"Utility for assigning unique refs to proto messages for use in components.\n+\n+  Instances of _UniqueRefAssigner are global (scoped by the base string). That\n+  way once a unique ref is assigned it will be used consistently across\n+  PipelineContext instances.\n+  \"\"\"\n+  _INSTANCES = {}  # type: Dict[Tuple[Pipeline, str], _UniqueRefAssigner]\n+\n+  def __init__(self, base):\n+    self._base = base\n+    self._counter = 0\n+    self._obj_to_id = {}  # type: Dict[Any, str]\n+\n+  def get_or_assign(self, obj=None, label=None):\n+    # type: (Optional[Any], Optional[str]) -> str\n+\n+    \"\"\"Retrieve the unique ref for the given object.\n+\n+    Generates and assigns a unique ref if one hasn't been assigned yet. label\n+    will be incorporated into the unique ref when assigning a new unique ref,\n+    otherwise it is ignored.\"\"\"\n+    if obj not in self._obj_to_id:\n+      self._obj_to_id[obj] = self._unique_ref(obj, label)\n+\n+    return self._obj_to_id[obj]\n+\n+  def _unique_ref(self, obj=None, label=None):\n+    self._counter += 1\n+    return \"%s_%s_%d\" % (self._base, label or type(obj).__name__, self._counter)\n+\n+  @classmethod\n+  def get_instance(cls, pipeline, base):\n+    # type: (Optional[Pipeline], str) -> _UniqueRefAssigner\n+\n+    \"\"\"Return the _UniqueRefAssigner with the given base string.\n+\n+    Creates a new instance if one doesn't already exist for this base string.\"\"\"\n+    key = (id(pipeline), base)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf25e6a82c9cbd5002a2846e3345b84f91d8abd"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjMzOTU2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/pipeline.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyMjowM1rOGr3MCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0NTowOVrOGtk02g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjE1Mw==", "bodyText": "There's not actually a circular dependency of classes. You could move this class in here and that would be fine.", "url": "https://github.com/apache/beam/pull/12067#discussion_r448646153", "createdAt": "2020-07-01T22:22:03Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -221,6 +221,14 @@ def __init__(self, runner=None, options=None, argv=None):\n     # then the transform will have to be cloned with a new label.\n     self.applied_labels = set()  # type: Set[str]\n \n+    # Create a context for assigning IDs to components. Ensures that any\n+    # components that receive an ID during pipeline construction (for example in\n+    # ExternalTransform), will receive the same component ID when generating the\n+    # full pipeline proto.\n+    from apache_beam.runners import pipeline_context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MjQ1OA==", "bodyText": "Done, thanks!", "url": "https://github.com/apache/beam/pull/12067#discussion_r450442458", "createdAt": "2020-07-06T19:45:09Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -221,6 +221,14 @@ def __init__(self, runner=None, options=None, argv=None):\n     # then the transform will have to be cloned with a new label.\n     self.applied_labels = set()  # type: Set[str]\n \n+    # Create a context for assigning IDs to components. Ensures that any\n+    # components that receive an ID during pipeline construction (for example in\n+    # ExternalTransform), will receive the same component ID when generating the\n+    # full pipeline proto.\n+    from apache_beam.runners import pipeline_context", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjE1Mw=="}, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjM1MjExOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/pipeline_context.py", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNzoxN1rOGr3TPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNzoxN1rOGr3TPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0Nzk5OQ==", "bodyText": "There's a lot of overlap between the purpose of this and the purpose of the PipelineContext but I can see how they are different. I see that the pipeline only takes the context at to_runner_api time, and the context has tweaks like use_fake_coders and default_environment. So when using xlang expansion you can keep just the ids and throw away the contents that will be generated according to these tweaks later.", "url": "https://github.com/apache/beam/pull/12067#discussion_r448647999", "createdAt": "2020-07-01T22:27:17Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/runners/pipeline_context.py", "diffHunk": "@@ -49,6 +50,32 @@\n   from apache_beam.coders.coder_impl import IterableStateWriter\n \n \n+class ComponentIdContext(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjM1NDI5OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/transforms/external.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyODoyMVrOGr3UlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0NDozNFrOGtkz3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0ODM0MQ==", "bodyText": "Based on this use, maybe _component_id_context isn't private at all? And maybe it is a component_id_map or some such. It isn't \"context\" in the sense that it isn't \"the stuff surrounding the thing you are interested in\".", "url": "https://github.com/apache/beam/pull/12067#discussion_r448648341", "createdAt": "2020-07-01T22:28:21Z", "author": {"login": "kennknowles"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -286,7 +286,8 @@ def expand(self, pvalueish):\n     pipeline = (\n         next(iter(self._inputs.values())).pipeline\n         if self._inputs else pvalueish.pipeline)\n-    context = pipeline_context.PipelineContext()\n+    context = pipeline_context.PipelineContext(\n+        component_id_context=pipeline._component_id_context)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MjIwNQ==", "bodyText": "Good point, renamed it to component_id_map everywhere", "url": "https://github.com/apache/beam/pull/12067#discussion_r450442205", "createdAt": "2020-07-06T19:44:34Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/python/apache_beam/transforms/external.py", "diffHunk": "@@ -286,7 +286,8 @@ def expand(self, pvalueish):\n     pipeline = (\n         next(iter(self._inputs.values())).pipeline\n         if self._inputs else pvalueish.pipeline)\n-    context = pipeline_context.PipelineContext()\n+    context = pipeline_context.PipelineContext(\n+        component_id_context=pipeline._component_id_context)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0ODM0MQ=="}, "originalCommit": {"oid": "cd9a47ad634abf222bbf272d31c94a27cf9070d5"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3572, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}