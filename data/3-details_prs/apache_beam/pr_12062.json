{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4NDEzMjcy", "number": 12062, "title": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token", "bodyText": "When the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n\n\nXLang\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-23T08:40:43Z", "url": "https://github.com/apache/beam/pull/12062", "merged": true, "mergeCommit": {"oid": "bd38c983bb63e53b629fe7db502e914f7638bd85"}, "closed": true, "closedAt": "2020-06-25T13:05:36Z", "author": {"login": "mxm"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuBw9lgBqjM0NzE5NDUyMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcurK3VgBqjM0ODE0NzA3Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "933213ef8b6be75b6c40e8490fee763438067e51", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/933213ef8b6be75b6c40e8490fee763438067e51", "committedDate": "2020-06-23T08:39:25Z", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}, "afterCommit": {"oid": "18e5df392987e073ff9a2158f3791d6e0e718ee3", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/18e5df392987e073ff9a2158f3791d6e0e718ee3", "committedDate": "2020-06-23T09:09:38Z", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTE3MTcx", "url": "https://github.com/apache/beam/pull/12062#pullrequestreview-435917171", "createdAt": "2020-06-23T15:46:43Z", "commit": {"oid": "18e5df392987e073ff9a2158f3791d6e0e718ee3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo0Njo0M1rOGnvfRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo0Njo0M1rOGnvfRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyNTcwMg==", "bodyText": "You should update the comment related to error handling to make sure that users discard the factory every time they want a new cache token.", "url": "https://github.com/apache/beam/pull/12062#discussion_r444325702", "createdAt": "2020-06-23T15:46:43Z", "author": {"login": "lukecwik"}, "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/state/InMemoryBagUserStateFactory.java", "diffHunk": "@@ -41,9 +41,12 @@\n public class InMemoryBagUserStateFactory<K, V, W extends BoundedWindow>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18e5df392987e073ff9a2158f3791d6e0e718ee3"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODgzMDQ5", "url": "https://github.com/apache/beam/pull/12062#pullrequestreview-436883049", "createdAt": "2020-06-24T18:01:32Z", "commit": {"oid": "9847976462b8540d398a8296a6b6e8a347e3d8fa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODowMTozMlrOGodM9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODowMTozMlrOGodM9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3NDY3OQ==", "bodyText": "I think we'll want to move the cache token generation up higher to the ByteStringStateRequestHandlerToBagUserStateHandlerFactoryAdapter or the factory has to own the cache token or we add a method which is a supplier to the StateRequestHandlers#forBagUserState. The comment added for this class should be moved appropriately.", "url": "https://github.com/apache/beam/pull/12062#discussion_r445074679", "createdAt": "2020-06-24T18:01:32Z", "author": {"login": "lukecwik"}, "path": "runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/state/InMemoryBagUserStateFactory.java", "diffHunk": "@@ -37,13 +37,19 @@\n /**\n  * Holds user state in memory. Only one key is active at a time due to the GroupReduceFunction being\n  * called once per key. Needs to be reset via {@code resetForNewKey()} before processing a new key.\n+ *\n+ * <p>In case of any failures, this factory must be discarded. Otherwise, the contained state cache\n+ * token would be reused which would corrupt the state cache.\n  */\n public class InMemoryBagUserStateFactory<K, V, W extends BoundedWindow>\n     implements StateRequestHandlers.BagUserStateHandlerFactory<K, V, W> {\n \n+  private final ByteString cacheToken;\n+\n   private List<InMemorySingleKeyBagState> handlers;\n \n   public InMemoryBagUserStateFactory() {\n+    cacheToken = ByteString.copyFrom(UUID.randomUUID().toString().getBytes(Charsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9847976462b8540d398a8296a6b6e8a347e3d8fa"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9847976462b8540d398a8296a6b6e8a347e3d8fa", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/9847976462b8540d398a8296a6b6e8a347e3d8fa", "committedDate": "2020-06-24T09:43:05Z", "message": "[BEAM-10305] Add a comment to clarify reuse in case of failures"}, "afterCommit": {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/be7b5f2221e003adc99ab911b2413e9b75764141", "committedDate": "2020-06-24T20:12:10Z", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTc2MDU5", "url": "https://github.com/apache/beam/pull/12062#pullrequestreview-436976059", "createdAt": "2020-06-24T20:19:09Z", "commit": {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDoxOTowOVrOGohqBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDoxOTowOVrOGohqBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE0NzY1Mg==", "bodyText": "Looks like this should be using the StateRequestHandler instead, will update.", "url": "https://github.com/apache/beam/pull/12062#discussion_r445147652", "createdAt": "2020-06-24T20:19:09Z", "author": {"login": "mxm"}, "path": "runners/java-fn-execution/src/test/java/org/apache/beam/runners/fnexecution/state/StateRequestHandlersTest.java", "diffHunk": "@@ -59,4 +68,46 @@ public void testDelegatingStateHandlerThrowsWhenNotFound() throws Exception {\n     StateRequestHandlers.delegateBasedUponType(new EnumMap<>(StateKey.TypeCase.class))\n         .handle(StateRequest.getDefaultInstance());\n   }\n+\n+  @Test\n+  public void testUserStateCacheTokenGeneration() {\n+    ProcessBundleDescriptors.ExecutableProcessBundleDescriptor processBundleDescriptor =\n+        Mockito.mock(ProcessBundleDescriptors.ExecutableProcessBundleDescriptor.class);\n+    InMemoryBagUserStateFactory inMemoryBagUserStateFactory = new InMemoryBagUserStateFactory<>();\n+    StateRequestHandler stateRequestHandler =\n+        StateRequestHandlers.forBagUserStateHandlerFactory(\n+            processBundleDescriptor, inMemoryBagUserStateFactory);\n+\n+    Iterable<BeamFnApi.ProcessBundleRequest.CacheToken> cacheTokens =\n+        stateRequestHandler.getCacheTokens();\n+    assertThat(Iterables.size(cacheTokens), is(1));\n+\n+    BeamFnApi.ProcessBundleRequest.CacheToken cacheToken = Iterables.getOnlyElement(cacheTokens);\n+    assertThat(\n+        cacheToken.getUserState(),\n+        is(BeamFnApi.ProcessBundleRequest.CacheToken.UserState.getDefaultInstance()));\n+    assertThat(cacheToken.getToken(), is(notNullValue()));\n+\n+    inMemoryBagUserStateFactory.forUserState(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDQ1MTEw", "url": "https://github.com/apache/beam/pull/12062#pullrequestreview-437045110", "createdAt": "2020-06-24T22:18:21Z", "commit": {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be7b5f2221e003adc99ab911b2413e9b75764141", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/be7b5f2221e003adc99ab911b2413e9b75764141", "committedDate": "2020-06-24T20:12:10Z", "message": "[BEAM-10305] Let InMemoryBagUserStateFactory only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}, "afterCommit": {"oid": "8ae80434c3a7eb70c1112d0377a2df34e5627438", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/8ae80434c3a7eb70c1112d0377a2df34e5627438", "committedDate": "2020-06-25T08:47:25Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ae80434c3a7eb70c1112d0377a2df34e5627438", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/8ae80434c3a7eb70c1112d0377a2df34e5627438", "committedDate": "2020-06-25T08:47:25Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}, "afterCommit": {"oid": "6817c19636d0ff82947f3526bb68c78a1af6f862", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/6817c19636d0ff82947f3526bb68c78a1af6f862", "committedDate": "2020-06-25T09:19:53Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d65ed6d44b41165126ba7533057200ed8abbebb", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/5d65ed6d44b41165126ba7533057200ed8abbebb", "committedDate": "2020-06-25T09:24:11Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6817c19636d0ff82947f3526bb68c78a1af6f862", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/6817c19636d0ff82947f3526bb68c78a1af6f862", "committedDate": "2020-06-25T09:19:53Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}, "afterCommit": {"oid": "5d65ed6d44b41165126ba7533057200ed8abbebb", "author": {"user": {"login": "mxm", "name": "Maximilian Michels"}}, "url": "https://github.com/apache/beam/commit/5d65ed6d44b41165126ba7533057200ed8abbebb", "committedDate": "2020-06-25T09:24:11Z", "message": "[BEAM-10305] Let StateRequestHandler for user state only use a single cache token\n\nWhen the state cache is enabled in the Python SDK, the batch mode of the Flink\nRunner currently only allows a single user state cell because a new cache token\nis generated for each state cell; the caching code in the Python SDK Harness\nonly supports one cache token per user state handler.\n\nTheoretically multiple cache tokens would work but would just be adding to the\npayload. We should make sure to just send a single cache token in batch\nmode (which is already the case in streaming)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3708, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}