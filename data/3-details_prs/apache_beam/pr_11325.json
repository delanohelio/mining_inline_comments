{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODc4MTYx", "number": 11325, "title": "[BEAM-4374, BEAM-6189] Delete and remove deprecated Metrics proto", "bodyText": "This completes the migration off of the Metrics proto to the MonitoringInfo proto.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-06T20:09:13Z", "url": "https://github.com/apache/beam/pull/11325", "merged": true, "mergeCommit": {"oid": "2a0b3f74a9a466cb13eb6a106a6c4103d1fc82d4"}, "closed": true, "closedAt": "2020-04-07T00:51:36Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVEZ5gAH2gAyMzk5ODc4MTYxOmJjNDRhMDFkZWRkMDdjNjkyMjNiNzAxNWFiOTBkNGMwOWIyNDI4OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVHcQ9AFqTM4ODY5MDg5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/bc44a01dedd07c69223b7015ab90d4c09b24289e", "committedDate": "2020-04-06T20:06:24Z", "message": "[BEAM-4374, BEAM-6189] Delete and remove deprecated Metrics proto\n\nThis completes the migration off of the Metrics proto to the MonitoringInfo proto."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjA3MDM1", "url": "https://github.com/apache/beam/pull/11325#pullrequestreview-388607035", "createdAt": "2020-04-06T20:51:15Z", "commit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDo1MToxNlrOGBpY7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTowMDo1MFrOGBpuPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3OTg4Ng==", "bodyText": "Why are these also deprecated now?\nWill you be only using the bytes map now? I don't really get how this will work by looking at the ProcessBundle(Progress)Response protos. It seems like you would need the MonitoringInfo at least once to have enough metadata be able to decode the bytes and associate multiple updates together. I don't really understand the protocol that you have in mind here.", "url": "https://github.com/apache/beam/pull/11325#discussion_r404379886", "createdAt": "2020-04-06T20:51:16Z", "author": {"login": "ajamato"}, "path": "model/fn-execution/src/main/proto/beam_fn_api.proto", "diffHunk": "@@ -253,18 +253,13 @@ message ProcessBundleRequest {\n }\n \n message ProcessBundleResponse {\n-  // (Optional) If metrics reporting is supported by the SDK, this represents\n-  // the final metrics to record for this bundle.\n-  // DEPRECATED\n-  Metrics metrics = 1;\n-\n   // (Optional) Specifies that the bundle has not been completed and the\n   // following applications need to be scheduled and executed in the future.\n   // A runner that does not yet support residual roots MUST still check that\n   // this is empty for correctness.\n   repeated DelayedBundleApplication residual_roots = 2;\n \n-  // (Required) The list of metrics or other MonitoredState\n+  // DEPRECATED (Required) The list of metrics or other MonitoredState\n   // collected while processing this bundle.\n   repeated org.apache.beam.model.pipeline.v1.MonitoringInfo monitoring_infos = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NDMxNA==", "bodyText": "Are you sure this won't break existing integrations? I believe only the Python and Java SDK have moved everything to MonitoringInfos. The Go SDK has not yet", "url": "https://github.com/apache/beam/pull/11325#discussion_r404384314", "createdAt": "2020-04-06T20:59:00Z", "author": {"login": "ajamato"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/fn/control/BeamFnMapTaskExecutor.java", "diffHunk": "@@ -341,30 +339,16 @@ void updateProgress() {\n           grpcWriteOperation.abortWait();\n         }\n \n-        // TODO(BEAM-6189): Replace getProcessBundleProgress with getMonitoringInfos when Metrics\n-        // is deprecated.\n         ProcessBundleProgressResponse processBundleProgressResponse =\n             MoreFutures.get(bundleProcessOperation.getProcessBundleProgress());\n \n         final List<MonitoringInfo> monitoringInfosList =\n             processBundleProgressResponse.getMonitoringInfosList();\n \n-        // Supporting deprecated metrics until all supported runners are migrated to using\n-        // MonitoringInfos\n-        Metrics metrics = processBundleProgressResponse.getMetrics();\n-        double elementsConsumed =\n-            bundleProcessOperation.getInputElementsConsumed(monitoringInfosList);\n-\n-        if (elementsConsumed == 0) {\n-          elementsConsumed = bundleProcessOperation.getInputElementsConsumed(metrics);\n-        }\n-\n         updateMetrics(monitoringInfosList);\n-        updateMetricsDeprecated(metrics);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NTM0Mw==", "bodyText": "You way want to add this back, if you truly cannot yet delete the deprecated metrics", "url": "https://github.com/apache/beam/pull/11325#discussion_r404385343", "createdAt": "2020-04-06T21:00:50Z", "author": {"login": "ajamato"}, "path": "runners/google-cloud-dataflow-java/worker/src/test/java/org/apache/beam/runners/dataflow/worker/fn/control/RegisterAndProcessBundleOperationTest.java", "diffHunk": "@@ -242,200 +240,6 @@ public void close() {}\n     operation.finish();\n   }\n \n-  @Test\n-  public void testTentativeUserMetrics() throws Exception {\n-    IdGenerator idGenerator = makeIdGeneratorStartingFrom(777L);\n-\n-    CountDownLatch processBundleLatch = new CountDownLatch(1);\n-\n-    final String stepName = \"fakeStepNameWithUserMetrics\";\n-    final String namespace = \"sdk/whatever\";\n-    final String name = \"someCounter\";\n-    final long counterValue = 42;\n-\n-    final BeamFnApi.Metrics.User.MetricName metricName =\n-        BeamFnApi.Metrics.User.MetricName.newBuilder()\n-            .setNamespace(namespace)\n-            .setName(name)\n-            .build();\n-\n-    InstructionRequestHandler instructionRequestHandler =\n-        new InstructionRequestHandler() {\n-          @Override\n-          public CompletionStage<InstructionResponse> handle(InstructionRequest request) {\n-            switch (request.getRequestCase()) {\n-              case REGISTER:\n-                return CompletableFuture.completedFuture(responseFor(request).build());\n-              case PROCESS_BUNDLE:\n-                return MoreFutures.supplyAsync(\n-                    () -> {\n-                      processBundleLatch.await();\n-                      return responseFor(request).build();\n-                    });\n-              case PROCESS_BUNDLE_PROGRESS:\n-                return CompletableFuture.completedFuture(\n-                    responseFor(request)\n-                        .setProcessBundleProgress(\n-                            BeamFnApi.ProcessBundleProgressResponse.newBuilder()\n-                                .setMetrics(\n-                                    BeamFnApi.Metrics.newBuilder()\n-                                        .putPtransforms(\n-                                            stepName,\n-                                            BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                .addUser(\n-                                                    BeamFnApi.Metrics.User.newBuilder()\n-                                                        .setMetricName(metricName)\n-                                                        .setCounterData(\n-                                                            BeamFnApi.Metrics.User.CounterData\n-                                                                .newBuilder()\n-                                                                .setValue(counterValue)))\n-                                                .build())))\n-                        .build());\n-              default:\n-                // block forever\n-                return new CompletableFuture<>();\n-            }\n-          }\n-\n-          @Override\n-          public void close() {}\n-        };\n-\n-    RegisterAndProcessBundleOperation operation =\n-        new RegisterAndProcessBundleOperation(\n-            idGenerator,\n-            instructionRequestHandler,\n-            mockBeamFnStateDelegator,\n-            REGISTER_REQUEST,\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableTable.of(),\n-            ImmutableMap.of(),\n-            mockContext);\n-\n-    operation.start();\n-\n-    BeamFnApi.Metrics metrics = MoreFutures.get(operation.getProcessBundleProgress()).getMetrics();\n-    assertThat(metrics.getPtransformsOrThrow(stepName).getUserCount(), equalTo(1));\n-\n-    BeamFnApi.Metrics.User userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), equalTo(counterValue));\n-\n-    processBundleLatch.countDown();\n-    operation.finish();\n-  }\n-\n-  @Test\n-  public void testFinalUserMetrics() throws Exception {\n-    List<BeamFnApi.InstructionRequest> requests = new ArrayList<>();\n-    IdGenerator idGenerator = makeIdGeneratorStartingFrom(777L);\n-    ExecutorService executorService = Executors.newCachedThreadPool();\n-\n-    CountDownLatch processBundleLatch = new CountDownLatch(1);\n-\n-    final String stepName = \"fakeStepNameWithUserMetrics\";\n-    final String namespace = \"sdk/whatever\";\n-    final String name = \"someCounter\";\n-    final long counterValue = 42;\n-    final long finalCounterValue = 77;\n-\n-    final BeamFnApi.Metrics.User.MetricName metricName =\n-        BeamFnApi.Metrics.User.MetricName.newBuilder()\n-            .setNamespace(namespace)\n-            .setName(name)\n-            .build();\n-\n-    InstructionRequestHandler instructionRequestHandler =\n-        new InstructionRequestHandler() {\n-          @Override\n-          public CompletionStage<InstructionResponse> handle(InstructionRequest request) {\n-            switch (request.getRequestCase()) {\n-              case REGISTER:\n-                return CompletableFuture.completedFuture(responseFor(request).build());\n-              case PROCESS_BUNDLE:\n-                return MoreFutures.supplyAsync(\n-                    () -> {\n-                      processBundleLatch.await();\n-                      return responseFor(request)\n-                          .setProcessBundle(\n-                              BeamFnApi.ProcessBundleResponse.newBuilder()\n-                                  .setMetrics(\n-                                      BeamFnApi.Metrics.newBuilder()\n-                                          .putPtransforms(\n-                                              stepName,\n-                                              BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                  .addUser(\n-                                                      BeamFnApi.Metrics.User.newBuilder()\n-                                                          .setMetricName(metricName)\n-                                                          .setCounterData(\n-                                                              BeamFnApi.Metrics.User.CounterData\n-                                                                  .newBuilder()\n-                                                                  .setValue(finalCounterValue)))\n-                                                  .build())))\n-                          .build();\n-                    });\n-              case PROCESS_BUNDLE_PROGRESS:\n-                return CompletableFuture.completedFuture(\n-                    responseFor(request)\n-                        .setProcessBundleProgress(\n-                            BeamFnApi.ProcessBundleProgressResponse.newBuilder()\n-                                .setMetrics(\n-                                    BeamFnApi.Metrics.newBuilder()\n-                                        .putPtransforms(\n-                                            stepName,\n-                                            BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                .addUser(\n-                                                    BeamFnApi.Metrics.User.newBuilder()\n-                                                        .setMetricName(metricName)\n-                                                        .setCounterData(\n-                                                            BeamFnApi.Metrics.User.CounterData\n-                                                                .newBuilder()\n-                                                                .setValue(counterValue)))\n-                                                .build())))\n-                        .build());\n-              default:\n-                // block forever\n-                return new CompletableFuture<>();\n-            }\n-          }\n-\n-          @Override\n-          public void close() {}\n-        };\n-\n-    RegisterAndProcessBundleOperation operation =\n-        new RegisterAndProcessBundleOperation(\n-            idGenerator,\n-            instructionRequestHandler,\n-            mockBeamFnStateDelegator,\n-            REGISTER_REQUEST,\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableTable.of(),\n-            ImmutableMap.of(),\n-            mockContext);\n-\n-    operation.start();\n-\n-    // Force some intermediate metrics to test crosstalk is not introduced\n-    BeamFnApi.Metrics metrics = MoreFutures.get(operation.getProcessBundleProgress()).getMetrics();\n-    BeamFnApi.Metrics.User userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), not(equalTo(finalCounterValue)));\n-\n-    processBundleLatch.countDown();\n-    operation.finish();\n-\n-    metrics = MoreFutures.get(operation.getFinalMetrics());\n-\n-    userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), equalTo(finalCounterValue));\n-  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 205}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjQ2NjY2", "url": "https://github.com/apache/beam/pull/11325#pullrequestreview-388646666", "createdAt": "2020-04-06T21:56:10Z", "commit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTo1NjoxMFrOGBrZeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTo1Nzo1MFrOGBrcaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMjc5NA==", "bodyText": "sgtm, Using ProcessBundleProgressMetadata should be called after the get the IDs, makes sense.", "url": "https://github.com/apache/beam/pull/11325#discussion_r404412794", "createdAt": "2020-04-06T21:56:10Z", "author": {"login": "ajamato"}, "path": "model/fn-execution/src/main/proto/beam_fn_api.proto", "diffHunk": "@@ -253,18 +253,13 @@ message ProcessBundleRequest {\n }\n \n message ProcessBundleResponse {\n-  // (Optional) If metrics reporting is supported by the SDK, this represents\n-  // the final metrics to record for this bundle.\n-  // DEPRECATED\n-  Metrics metrics = 1;\n-\n   // (Optional) Specifies that the bundle has not been completed and the\n   // following applications need to be scheduled and executed in the future.\n   // A runner that does not yet support residual roots MUST still check that\n   // this is empty for correctness.\n   repeated DelayedBundleApplication residual_roots = 2;\n \n-  // (Required) The list of metrics or other MonitoredState\n+  // DEPRECATED (Required) The list of metrics or other MonitoredState\n   // collected while processing this bundle.\n   repeated org.apache.beam.model.pipeline.v1.MonitoringInfo monitoring_infos = 3;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3OTg4Ng=="}, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMjg5Ng==", "bodyText": "SGTM", "url": "https://github.com/apache/beam/pull/11325#discussion_r404412896", "createdAt": "2020-04-06T21:56:24Z", "author": {"login": "ajamato"}, "path": "runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/fn/control/BeamFnMapTaskExecutor.java", "diffHunk": "@@ -341,30 +339,16 @@ void updateProgress() {\n           grpcWriteOperation.abortWait();\n         }\n \n-        // TODO(BEAM-6189): Replace getProcessBundleProgress with getMonitoringInfos when Metrics\n-        // is deprecated.\n         ProcessBundleProgressResponse processBundleProgressResponse =\n             MoreFutures.get(bundleProcessOperation.getProcessBundleProgress());\n \n         final List<MonitoringInfo> monitoringInfosList =\n             processBundleProgressResponse.getMonitoringInfosList();\n \n-        // Supporting deprecated metrics until all supported runners are migrated to using\n-        // MonitoringInfos\n-        Metrics metrics = processBundleProgressResponse.getMetrics();\n-        double elementsConsumed =\n-            bundleProcessOperation.getInputElementsConsumed(monitoringInfosList);\n-\n-        if (elementsConsumed == 0) {\n-          elementsConsumed = bundleProcessOperation.getInputElementsConsumed(metrics);\n-        }\n-\n         updateMetrics(monitoringInfosList);\n-        updateMetricsDeprecated(metrics);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NDMxNA=="}, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMzU0NA==", "bodyText": "The legacy metrics proto deleted in this PR. You may want to check with to make sure no other runner is consuming this.", "url": "https://github.com/apache/beam/pull/11325#discussion_r404413544", "createdAt": "2020-04-06T21:57:50Z", "author": {"login": "ajamato"}, "path": "runners/google-cloud-dataflow-java/worker/src/test/java/org/apache/beam/runners/dataflow/worker/fn/control/RegisterAndProcessBundleOperationTest.java", "diffHunk": "@@ -242,200 +240,6 @@ public void close() {}\n     operation.finish();\n   }\n \n-  @Test\n-  public void testTentativeUserMetrics() throws Exception {\n-    IdGenerator idGenerator = makeIdGeneratorStartingFrom(777L);\n-\n-    CountDownLatch processBundleLatch = new CountDownLatch(1);\n-\n-    final String stepName = \"fakeStepNameWithUserMetrics\";\n-    final String namespace = \"sdk/whatever\";\n-    final String name = \"someCounter\";\n-    final long counterValue = 42;\n-\n-    final BeamFnApi.Metrics.User.MetricName metricName =\n-        BeamFnApi.Metrics.User.MetricName.newBuilder()\n-            .setNamespace(namespace)\n-            .setName(name)\n-            .build();\n-\n-    InstructionRequestHandler instructionRequestHandler =\n-        new InstructionRequestHandler() {\n-          @Override\n-          public CompletionStage<InstructionResponse> handle(InstructionRequest request) {\n-            switch (request.getRequestCase()) {\n-              case REGISTER:\n-                return CompletableFuture.completedFuture(responseFor(request).build());\n-              case PROCESS_BUNDLE:\n-                return MoreFutures.supplyAsync(\n-                    () -> {\n-                      processBundleLatch.await();\n-                      return responseFor(request).build();\n-                    });\n-              case PROCESS_BUNDLE_PROGRESS:\n-                return CompletableFuture.completedFuture(\n-                    responseFor(request)\n-                        .setProcessBundleProgress(\n-                            BeamFnApi.ProcessBundleProgressResponse.newBuilder()\n-                                .setMetrics(\n-                                    BeamFnApi.Metrics.newBuilder()\n-                                        .putPtransforms(\n-                                            stepName,\n-                                            BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                .addUser(\n-                                                    BeamFnApi.Metrics.User.newBuilder()\n-                                                        .setMetricName(metricName)\n-                                                        .setCounterData(\n-                                                            BeamFnApi.Metrics.User.CounterData\n-                                                                .newBuilder()\n-                                                                .setValue(counterValue)))\n-                                                .build())))\n-                        .build());\n-              default:\n-                // block forever\n-                return new CompletableFuture<>();\n-            }\n-          }\n-\n-          @Override\n-          public void close() {}\n-        };\n-\n-    RegisterAndProcessBundleOperation operation =\n-        new RegisterAndProcessBundleOperation(\n-            idGenerator,\n-            instructionRequestHandler,\n-            mockBeamFnStateDelegator,\n-            REGISTER_REQUEST,\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableTable.of(),\n-            ImmutableMap.of(),\n-            mockContext);\n-\n-    operation.start();\n-\n-    BeamFnApi.Metrics metrics = MoreFutures.get(operation.getProcessBundleProgress()).getMetrics();\n-    assertThat(metrics.getPtransformsOrThrow(stepName).getUserCount(), equalTo(1));\n-\n-    BeamFnApi.Metrics.User userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), equalTo(counterValue));\n-\n-    processBundleLatch.countDown();\n-    operation.finish();\n-  }\n-\n-  @Test\n-  public void testFinalUserMetrics() throws Exception {\n-    List<BeamFnApi.InstructionRequest> requests = new ArrayList<>();\n-    IdGenerator idGenerator = makeIdGeneratorStartingFrom(777L);\n-    ExecutorService executorService = Executors.newCachedThreadPool();\n-\n-    CountDownLatch processBundleLatch = new CountDownLatch(1);\n-\n-    final String stepName = \"fakeStepNameWithUserMetrics\";\n-    final String namespace = \"sdk/whatever\";\n-    final String name = \"someCounter\";\n-    final long counterValue = 42;\n-    final long finalCounterValue = 77;\n-\n-    final BeamFnApi.Metrics.User.MetricName metricName =\n-        BeamFnApi.Metrics.User.MetricName.newBuilder()\n-            .setNamespace(namespace)\n-            .setName(name)\n-            .build();\n-\n-    InstructionRequestHandler instructionRequestHandler =\n-        new InstructionRequestHandler() {\n-          @Override\n-          public CompletionStage<InstructionResponse> handle(InstructionRequest request) {\n-            switch (request.getRequestCase()) {\n-              case REGISTER:\n-                return CompletableFuture.completedFuture(responseFor(request).build());\n-              case PROCESS_BUNDLE:\n-                return MoreFutures.supplyAsync(\n-                    () -> {\n-                      processBundleLatch.await();\n-                      return responseFor(request)\n-                          .setProcessBundle(\n-                              BeamFnApi.ProcessBundleResponse.newBuilder()\n-                                  .setMetrics(\n-                                      BeamFnApi.Metrics.newBuilder()\n-                                          .putPtransforms(\n-                                              stepName,\n-                                              BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                  .addUser(\n-                                                      BeamFnApi.Metrics.User.newBuilder()\n-                                                          .setMetricName(metricName)\n-                                                          .setCounterData(\n-                                                              BeamFnApi.Metrics.User.CounterData\n-                                                                  .newBuilder()\n-                                                                  .setValue(finalCounterValue)))\n-                                                  .build())))\n-                          .build();\n-                    });\n-              case PROCESS_BUNDLE_PROGRESS:\n-                return CompletableFuture.completedFuture(\n-                    responseFor(request)\n-                        .setProcessBundleProgress(\n-                            BeamFnApi.ProcessBundleProgressResponse.newBuilder()\n-                                .setMetrics(\n-                                    BeamFnApi.Metrics.newBuilder()\n-                                        .putPtransforms(\n-                                            stepName,\n-                                            BeamFnApi.Metrics.PTransform.newBuilder()\n-                                                .addUser(\n-                                                    BeamFnApi.Metrics.User.newBuilder()\n-                                                        .setMetricName(metricName)\n-                                                        .setCounterData(\n-                                                            BeamFnApi.Metrics.User.CounterData\n-                                                                .newBuilder()\n-                                                                .setValue(counterValue)))\n-                                                .build())))\n-                        .build());\n-              default:\n-                // block forever\n-                return new CompletableFuture<>();\n-            }\n-          }\n-\n-          @Override\n-          public void close() {}\n-        };\n-\n-    RegisterAndProcessBundleOperation operation =\n-        new RegisterAndProcessBundleOperation(\n-            idGenerator,\n-            instructionRequestHandler,\n-            mockBeamFnStateDelegator,\n-            REGISTER_REQUEST,\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableMap.of(),\n-            ImmutableTable.of(),\n-            ImmutableMap.of(),\n-            mockContext);\n-\n-    operation.start();\n-\n-    // Force some intermediate metrics to test crosstalk is not introduced\n-    BeamFnApi.Metrics metrics = MoreFutures.get(operation.getProcessBundleProgress()).getMetrics();\n-    BeamFnApi.Metrics.User userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), not(equalTo(finalCounterValue)));\n-\n-    processBundleLatch.countDown();\n-    operation.finish();\n-\n-    metrics = MoreFutures.get(operation.getFinalMetrics());\n-\n-    userMetric = metrics.getPtransformsOrThrow(stepName).getUser(0);\n-    assertThat(userMetric.getMetricName(), equalTo(metricName));\n-    assertThat(userMetric.getCounterData().getValue(), equalTo(finalCounterValue));\n-  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NTM0Mw=="}, "originalCommit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "originalPosition": 205}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjkwODkx", "url": "https://github.com/apache/beam/pull/11325#pullrequestreview-388690891", "createdAt": "2020-04-06T23:38:42Z", "commit": {"oid": "bc44a01dedd07c69223b7015ab90d4c09b24289e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4437, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}