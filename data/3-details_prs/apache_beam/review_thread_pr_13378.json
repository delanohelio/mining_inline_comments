{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDc2OTY1", "number": 13378, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMTozM1rOE6ydDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMjo1MVrOE6y4XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDc5NTAwOnYy", "diffSide": "RIGHT", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMTozNFrOH2EYwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMDozOFrOH2E-5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzAyNA==", "bodyText": "Nit: I would just initialize this in the declaration above (e.g. private boolean splitPossible = true;) rather than in the constructor.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526457024", "createdAt": "2020-11-18T22:11:34Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -178,6 +179,7 @@ private BigQueryStorageStreamReader(\n       this.parseFn = source.parseFn;\n       this.storageClient = source.bqServices.getStorageClient(options);\n       this.tableSchema = fromJsonString(source.jsonTableSchema, TableSchema.class);\n+      this.splitPossible = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Njc4OA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526466788", "createdAt": "2020-11-18T22:30:38Z", "author": {"login": "vachan-shetty"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -178,6 +179,7 @@ private BigQueryStorageStreamReader(\n       this.parseFn = source.parseFn;\n       this.storageClient = source.bqServices.getStorageClient(options);\n       this.tableSchema = fromJsonString(source.jsonTableSchema, TableSchema.class);\n+      this.splitPossible = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzAyNA=="}, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDc5OTM2OnYy", "diffSide": "RIGHT", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjoxMzowM1rOH2EbeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMDo0MVrOH2E_Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzcyMA==", "bodyText": "Nit: I would structure this check as an early return (e.g. if (!splitPossible) { return null; }) rather than putting the whole implementation into a new block.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526457720", "createdAt": "2020-11-18T22:13:03Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -288,78 +290,85 @@ public synchronized void close() {\n         return null;\n       }\n \n-      SplitReadStreamRequest splitRequest =\n-          SplitReadStreamRequest.newBuilder()\n-              .setName(source.readStream.getName())\n-              .setFraction((float) fraction)\n-              .build();\n-\n-      SplitReadStreamResponse splitResponse = storageClient.splitReadStream(splitRequest);\n-      if (!splitResponse.hasPrimaryStream() || !splitResponse.hasRemainderStream()) {\n-        // No more splits are possible!\n-        Metrics.counter(\n-                BigQueryStorageStreamReader.class,\n-                \"split-at-fraction-calls-failed-due-to-impossible-split-point\")\n-            .inc();\n-        LOG.info(\n-            \"BigQuery Storage API stream {} cannot be split at {}.\",\n-            source.readStream.getName(),\n-            fraction);\n-        return null;\n-      }\n+      if (splitPossible) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2NjgxOA==", "bodyText": "Done.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526466818", "createdAt": "2020-11-18T22:30:41Z", "author": {"login": "vachan-shetty"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -288,78 +290,85 @@ public synchronized void close() {\n         return null;\n       }\n \n-      SplitReadStreamRequest splitRequest =\n-          SplitReadStreamRequest.newBuilder()\n-              .setName(source.readStream.getName())\n-              .setFraction((float) fraction)\n-              .build();\n-\n-      SplitReadStreamResponse splitResponse = storageClient.splitReadStream(splitRequest);\n-      if (!splitResponse.hasPrimaryStream() || !splitResponse.hasRemainderStream()) {\n-        // No more splits are possible!\n-        Metrics.counter(\n-                BigQueryStorageStreamReader.class,\n-                \"split-at-fraction-calls-failed-due-to-impossible-split-point\")\n-            .inc();\n-        LOG.info(\n-            \"BigQuery Storage API stream {} cannot be split at {}.\",\n-            source.readStream.getName(),\n-            fraction);\n-        return null;\n-      }\n+      if (splitPossible) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzcyMA=="}, "originalCommit": {"oid": "af007bf2dea579539de1724230c6b065d97ae8e5"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDg2NDI2OnYy", "diffSide": "RIGHT", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMjozN1rOH2FC1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzowMDo1MVrOH2F0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzc5Ng==", "bodyText": "Nit: I don't think this is correct, or required. Once we've reached this point, we know that the splitReadStream call above has in fact succeeded.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526467796", "createdAt": "2020-11-18T22:32:37Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4MDQ0MQ==", "bodyText": "Removed.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526480441", "createdAt": "2020-11-18T23:00:51Z", "author": {"login": "vachan-shetty"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzc5Ng=="}, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDg2NDkzOnYy", "diffSide": "RIGHT", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjozMjo1MVrOH2FDNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzowMDozOFrOH2Fz5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzg5Mw==", "bodyText": "Same comment here.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526467893", "createdAt": "2020-11-18T22:32:51Z", "author": {"login": "kmjung"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;\n           return null;\n         } catch (Exception e) {\n           Metrics.counter(\n                   BigQueryStorageStreamReader.class,\n                   \"split-at-fraction-calls-failed-due-to-other-reasons\")\n               .inc();\n           LOG.error(\"BigQuery Storage API stream split failed.\", e);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4MDM1Ng==", "bodyText": "Removed.", "url": "https://github.com/apache/beam/pull/13378#discussion_r526480356", "createdAt": "2020-11-18T23:00:38Z", "author": {"login": "vachan-shetty"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryStorageStreamSource.java", "diffHunk": "@@ -335,13 +341,15 @@ public synchronized void close() {\n                   + \"the left of the split fraction {}.\",\n               source.readStream.getName(),\n               fraction);\n+          splitPossible = false;\n           return null;\n         } catch (Exception e) {\n           Metrics.counter(\n                   BigQueryStorageStreamReader.class,\n                   \"split-at-fraction-calls-failed-due-to-other-reasons\")\n               .inc();\n           LOG.error(\"BigQuery Storage API stream split failed.\", e);\n+          splitPossible = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2Nzg5Mw=="}, "originalCommit": {"oid": "bd04d3e47bc81b17e17339c84b1e7e0c7332bedf"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2603, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}