{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MTEzNjAy", "number": 11529, "title": "[BEAM-9822] Simplify pipeline when batching is disabled.", "bodyText": "Batching is often disabled in streaming pipelines to improve latency. When this is the case, there is no\npoint in adding several transforms to group/sort/batch the elements, so if batching is disabled, a simple pipeline is used.\nNote, this PR is dependent on PR #11528 and PR #11532\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-26T16:33:19Z", "url": "https://github.com/apache/beam/pull/11529", "merged": true, "mergeCommit": {"oid": "b33ed49f75e2b3074211a8d907cab91270828fea"}, "closed": true, "closedAt": "2020-05-21T01:24:04Z", "author": {"login": "nielm"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbqmaAABqjMyNzQ0ODc4MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjN90NgFqTQxNTYzNzEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "911f8422f128825f1931ae67cfa3a00c02a1dc06", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/911f8422f128825f1931ae67cfa3a00c02a1dc06", "committedDate": "2020-04-26T16:14:55Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "4bde0787b5c5ae438c7b450634fa539158f4b4d5", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/4bde0787b5c5ae438c7b450634fa539158f4b4d5", "committedDate": "2020-04-27T07:59:16Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bde0787b5c5ae438c7b450634fa539158f4b4d5", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/4bde0787b5c5ae438c7b450634fa539158f4b4d5", "committedDate": "2020-04-27T07:59:16Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "committedDate": "2020-04-27T13:34:03Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/f133b406f15c49b2e9c8f03b0ed41b3728d53d43", "committedDate": "2020-04-27T13:34:03Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "committedDate": "2020-04-27T14:02:36Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/5d7dda43b64fd4d631674337ec9e73c4e8a808e2", "committedDate": "2020-04-27T14:02:36Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "40316593c05b84598c88a2d40aa4101e86b8421f", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/40316593c05b84598c88a2d40aa4101e86b8421f", "committedDate": "2020-05-01T11:23:42Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODQ0OTAy", "url": "https://github.com/apache/beam/pull/11529#pullrequestreview-406844902", "createdAt": "2020-05-06T17:44:01Z", "commit": {"oid": "40316593c05b84598c88a2d40aa4101e86b8421f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODQ2NTg0", "url": "https://github.com/apache/beam/pull/11529#pullrequestreview-406846584", "createdAt": "2020-05-06T17:46:07Z", "commit": {"oid": "40316593c05b84598c88a2d40aa4101e86b8421f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40316593c05b84598c88a2d40aa4101e86b8421f", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/40316593c05b84598c88a2d40aa4101e86b8421f", "committedDate": "2020-05-01T11:23:42Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "29559733904d041af7b7dcdc9ecbe8f3e64c9385", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/29559733904d041af7b7dcdc9ecbe8f3e64c9385", "committedDate": "2020-05-18T22:50:33Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29559733904d041af7b7dcdc9ecbe8f3e64c9385", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/29559733904d041af7b7dcdc9ecbe8f3e64c9385", "committedDate": "2020-05-18T22:50:33Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "718884b96e5a0f20512592b7cc24e454131c8144", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/718884b96e5a0f20512592b7cc24e454131c8144", "committedDate": "2020-05-18T23:43:10Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/d64df6a95fb818a8eadfad9d3f2fbd4ceac32660", "committedDate": "2020-05-19T11:06:54Z", "message": "Disable grouping by default when streaming.\n\nGrouping adds significant latency and memory use, and when streaming\nthis causes both OOMs and high pipeline latencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ade11d9035e76d145457e7125809ea5f5206be54", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ade11d9035e76d145457e7125809ea5f5206be54", "committedDate": "2020-05-19T11:14:51Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "718884b96e5a0f20512592b7cc24e454131c8144", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/718884b96e5a0f20512592b7cc24e454131c8144", "committedDate": "2020-05-18T23:43:10Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}, "afterCommit": {"oid": "ade11d9035e76d145457e7125809ea5f5206be54", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ade11d9035e76d145457e7125809ea5f5206be54", "committedDate": "2020-05-19T11:14:51Z", "message": "Simplify pipeline when batching is disabled.\n\nWhen batching is disabled, there is no need for SpannerIO to read the\nschema, group, sort, batch and write batches, so simplify the pipeline\nto just write the mutation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Nzk0MzY5", "url": "https://github.com/apache/beam/pull/11529#pullrequestreview-414794369", "createdAt": "2020-05-19T20:23:08Z", "commit": {"oid": "ade11d9035e76d145457e7125809ea5f5206be54"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoyMzowOFrOGXxOmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoyMzowOFrOGXxOmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3Njk4NQ==", "bodyText": "This doesn't seem to be used. It seems we should either:\n\nPass fakeServiceFactory to withServiceFactory and the verify calls below, or\nJust remove fakeServiceFactory and use serviceFactory here instead. It seems to be capable of verifying that the schema isn't read, so I'm not sure there's value in building another fake that doesn't have a schema.\n\nI'd prefer the latter, but I'd be fine with the former if you think that's better.", "url": "https://github.com/apache/beam/pull/11529#discussion_r427576985", "createdAt": "2020-05-19T20:23:08Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIOWriteTest.java", "diffHunk": "@@ -263,6 +263,17 @@ private void verifyBatches(Iterable<Mutation>... batches) {\n \n   @Test\n   public void noBatching() throws Exception {\n+\n+    // This test uses a different mock/fake because it explicitly does not want to populate the\n+    // Spanner schema.\n+    FakeServiceFactory fakeServiceFactory = new FakeServiceFactory();\n+    ReadOnlyTransaction tx = mock(ReadOnlyTransaction.class);\n+    when(fakeServiceFactory.mockDatabaseClient().readOnlyTransaction()).thenReturn(tx);\n+\n+    // Capture batches sent to writeAtLeastOnce.\n+    when(fakeServiceFactory.mockDatabaseClient().writeAtLeastOnce(mutationBatchesCaptor.capture()))\n+        .thenReturn(null);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade11d9035e76d145457e7125809ea5f5206be54"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ffe54998873645adf6d31f407b76d9f0c8b378e", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/9ffe54998873645adf6d31f407b76d9f0c8b378e", "committedDate": "2020-05-20T19:07:12Z", "message": "Fix noBatching test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NjM3MTIx", "url": "https://github.com/apache/beam/pull/11529#pullrequestreview-415637121", "createdAt": "2020-05-20T19:09:43Z", "commit": {"oid": "9ffe54998873645adf6d31f407b76d9f0c8b378e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3970, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}