{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzM4NTY1", "number": 11472, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDowNjo1M1rOD1FJgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODoyMjoxOFrOD1aa2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTg1NDc0OnYy", "diffSide": "RIGHT", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/DoFnInvoker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDowNjo1M1rOGKVoyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNToyMzo0NVrOGKXHrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5MzQ1MA==", "bodyText": "Do we want to highlight that this fallback may impact batch autoscaling if HasProcess is not implemented correctly.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413493450", "createdAt": "2020-04-23T04:06:53Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/DoFnInvoker.java", "diffHunk": "@@ -94,9 +94,13 @@ void invokeOnTimer(\n   void invokeSplitRestriction(ArgumentProvider<InputT, OutputT> arguments);\n \n   /**\n-   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to get the size\n-   * from the {@link RestrictionTracker} if it supports {@link Sizes.HasSize}, otherwise returns\n-   * 1.0.\n+   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to:\n+   *\n+   * <ol>\n+   *   <li>get the work remaining from the {@link RestrictionTracker} if it supports {@link\n+   *       HasProgress}.\n+   *   <li>returning the constant {@link 1.0}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNzc0Mw==", "bodyText": "This is an internal comment for the implementation here.\nThe user having comments are in DoFn.java and RestrictionTracker.java", "url": "https://github.com/apache/beam/pull/11472#discussion_r413517743", "createdAt": "2020-04-23T05:23:45Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/DoFnInvoker.java", "diffHunk": "@@ -94,9 +94,13 @@ void invokeOnTimer(\n   void invokeSplitRestriction(ArgumentProvider<InputT, OutputT> arguments);\n \n   /**\n-   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to get the size\n-   * from the {@link RestrictionTracker} if it supports {@link Sizes.HasSize}, otherwise returns\n-   * 1.0.\n+   * Invoke the {@link DoFn.GetSize} method on the bound {@link DoFn}. Falls back to:\n+   *\n+   * <ol>\n+   *   <li>get the work remaining from the {@link RestrictionTracker} if it supports {@link\n+   *       HasProgress}.\n+   *   <li>returning the constant {@link 1.0}.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5MzQ1MA=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTg2MDUyOnYy", "diffSide": "RIGHT", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDowOTo1MFrOGKVsGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNzowODo1N1rOGKy7Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NDI5Ng==", "bodyText": "I'm not very familiar with how this invoker works but I thought we check whether restrictionTracker  has HasSize, if not then fallback to progress.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413494296", "createdAt": "2020-04-23T04:09:50Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "diffHunk": "@@ -397,12 +396,14 @@ public WatermarkEstimatorStateT getState() {\n   }\n \n   public static class DefaultGetSize {\n-    /** Uses {@link Sizes.HasSize} to produce the size. */\n+    /** Uses {@link HasProgress} to produce the size. */\n     @SuppressWarnings(\"unused\")\n     public static <InputT, OutputT> double invokeGetSize(\n         DoFnInvoker.ArgumentProvider<InputT, OutputT> argumentProvider) {\n-      if (argumentProvider.restrictionTracker() instanceof HasSize) {\n-        return ((HasSize) argumentProvider.restrictionTracker()).getSize();\n+      if (argumentProvider.restrictionTracker() instanceof HasProgress) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNTI1OA==", "bodyText": "HasSize was removed.\nDoFn can provide a method annotated with @GetSize and the fallback is the HasProgress on the RestrictionTracker. This is analogous to RestrictionProvider/RProvider being able to provide the size while the RestrictionTracker/RTracker provide progress in Python/Go.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413515258", "createdAt": "2020-04-23T05:16:38Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "diffHunk": "@@ -397,12 +396,14 @@ public WatermarkEstimatorStateT getState() {\n   }\n \n   public static class DefaultGetSize {\n-    /** Uses {@link Sizes.HasSize} to produce the size. */\n+    /** Uses {@link HasProgress} to produce the size. */\n     @SuppressWarnings(\"unused\")\n     public static <InputT, OutputT> double invokeGetSize(\n         DoFnInvoker.ArgumentProvider<InputT, OutputT> argumentProvider) {\n-      if (argumentProvider.restrictionTracker() instanceof HasSize) {\n-        return ((HasSize) argumentProvider.restrictionTracker()).getSize();\n+      if (argumentProvider.restrictionTracker() instanceof HasProgress) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NDI5Ng=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk3MTc2OA==", "bodyText": "Thanks for explaining this! If so, do we still need to keep GetSize? It seems like highly overlap with HasProgress.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413971768", "createdAt": "2020-04-23T17:06:48Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "diffHunk": "@@ -397,12 +396,14 @@ public WatermarkEstimatorStateT getState() {\n   }\n \n   public static class DefaultGetSize {\n-    /** Uses {@link Sizes.HasSize} to produce the size. */\n+    /** Uses {@link HasProgress} to produce the size. */\n     @SuppressWarnings(\"unused\")\n     public static <InputT, OutputT> double invokeGetSize(\n         DoFnInvoker.ArgumentProvider<InputT, OutputT> argumentProvider) {\n-      if (argumentProvider.restrictionTracker() instanceof HasSize) {\n-        return ((HasSize) argumentProvider.restrictionTracker()).getSize();\n+      if (argumentProvider.restrictionTracker() instanceof HasProgress) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NDI5Ng=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk3MzI2Ng==", "bodyText": "Yes, because it allows the user to provide an override on how size is computed without needing to implement a restriction tracker. This is similar to how a restriction provider can compute the size.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413973266", "createdAt": "2020-04-23T17:08:57Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/reflect/ByteBuddyDoFnInvokerFactory.java", "diffHunk": "@@ -397,12 +396,14 @@ public WatermarkEstimatorStateT getState() {\n   }\n \n   public static class DefaultGetSize {\n-    /** Uses {@link Sizes.HasSize} to produce the size. */\n+    /** Uses {@link HasProgress} to produce the size. */\n     @SuppressWarnings(\"unused\")\n     public static <InputT, OutputT> double invokeGetSize(\n         DoFnInvoker.ArgumentProvider<InputT, OutputT> argumentProvider) {\n-      if (argumentProvider.restrictionTracker() instanceof HasSize) {\n-        return ((HasSize) argumentProvider.restrictionTracker()).getSize();\n+      if (argumentProvider.restrictionTracker() instanceof HasProgress) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5NDI5Ng=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTg5MzUwOnYy", "diffSide": "LEFT", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/Sizes.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDoyNTowOFrOGKV9ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNToyMjo0MlrOGKXGMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5ODgxMA==", "bodyText": "I though we still want to keep this and make HasProgress as a fallback?", "url": "https://github.com/apache/beam/pull/11472#discussion_r413498810", "createdAt": "2020-04-23T04:25:08Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/Sizes.java", "diffHunk": "@@ -1,54 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.beam.sdk.transforms.splittabledofn;\n-\n-import org.apache.beam.sdk.annotations.Experimental;\n-import org.apache.beam.sdk.annotations.Experimental.Kind;\n-\n-/** Definitions and convenience methods for reporting sizes for SplittableDoFns. */\n-@Experimental(Kind.SPLITTABLE_DO_FN)\n-public final class Sizes {\n-  /**\n-   * {@link RestrictionTracker}s which can provide a size should implement this interface.\n-   * Implementations that do not implement this interface will be assumed to have an equivalent\n-   * size.\n-   */\n-  public interface HasSize {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNzM2Mw==", "bodyText": "The intent was to remove using size as a progress signal. Which means that all restriction trackers need to implement the slightly more complicated HasProgress. Since that is the case, there is no need to keep HasSize around as a fallback since we can use the work remaining as the default size when it is not overridden by a @GetSize override.", "url": "https://github.com/apache/beam/pull/11472#discussion_r413517363", "createdAt": "2020-04-23T05:22:42Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/splittabledofn/Sizes.java", "diffHunk": "@@ -1,54 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.beam.sdk.transforms.splittabledofn;\n-\n-import org.apache.beam.sdk.annotations.Experimental;\n-import org.apache.beam.sdk.annotations.Experimental.Kind;\n-\n-/** Definitions and convenience methods for reporting sizes for SplittableDoFns. */\n-@Experimental(Kind.SPLITTABLE_DO_FN)\n-public final class Sizes {\n-  /**\n-   * {@link RestrictionTracker}s which can provide a size should implement this interface.\n-   * Implementations that do not implement this interface will be assumed to have an equivalent\n-   * size.\n-   */\n-  public interface HasSize {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5ODgxMA=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzMzOTc5OnYy", "diffSide": "RIGHT", "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODoyMjoxOFrOGK18zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxODozNDozNlrOGK2c2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMjg2MQ==", "bodyText": "When a bundle finished, will the progress.workRemaining always be 0?", "url": "https://github.com/apache/beam/pull/11472#discussion_r414022861", "createdAt": "2020-04-23T18:22:18Z", "author": {"login": "boyuanzz"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -311,9 +315,14 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       // Get finish bundle Execution Time Metrics.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getFinishFunctionRegistry().getExecutionTimeMonitoringInfos());\n-      // Extract all other MonitoringInfos other than the execution time monitoring infos.\n+      // Extract MonitoringInfos that come from the metrics container registry.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getMetricsContainerRegistry().getMonitoringInfos());\n+      // Add any additional monitoring infos that the \"runners\" report explicitly.\n+      for (ProgressRequestCallback progressRequestCallback :\n+          bundleProcessor.getProgressRequestCallbacks()) {\n+        response.addAllMonitoringInfos(progressRequestCallback.getMonitoringInfos());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAzMTA2Nw==", "bodyText": "Progress metrics won't appear in the final monitoring infos since there are no active elements. Any residuals will contain their size if a sized SDF element and processing URN was used.", "url": "https://github.com/apache/beam/pull/11472#discussion_r414031067", "createdAt": "2020-04-23T18:34:36Z", "author": {"login": "lukecwik"}, "path": "sdks/java/harness/src/main/java/org/apache/beam/fn/harness/control/ProcessBundleHandler.java", "diffHunk": "@@ -311,9 +315,14 @@ private void createRunnerAndConsumersForPTransformRecursively(\n       // Get finish bundle Execution Time Metrics.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getFinishFunctionRegistry().getExecutionTimeMonitoringInfos());\n-      // Extract all other MonitoringInfos other than the execution time monitoring infos.\n+      // Extract MonitoringInfos that come from the metrics container registry.\n       response.addAllMonitoringInfos(\n           bundleProcessor.getMetricsContainerRegistry().getMonitoringInfos());\n+      // Add any additional monitoring infos that the \"runners\" report explicitly.\n+      for (ProgressRequestCallback progressRequestCallback :\n+          bundleProcessor.getProgressRequestCallbacks()) {\n+        response.addAllMonitoringInfos(progressRequestCallback.getMonitoringInfos());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMjg2MQ=="}, "originalCommit": {"oid": "cfa6692bd82b4c7db44c9c9c5083792f94dd8e98"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1333, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}