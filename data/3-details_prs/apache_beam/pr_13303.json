{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDEyNzQ2", "number": 13303, "title": "[BEAM-11196] Ensure parent of fused stages is not one of its transforms", "bodyText": "#13202 introduces a bug where the algorithm that determines the parents of fused stage can create loops, because the lowest common ancestor algorithm considers a transform to be its own parent. Fusing a single transform A will result cause the fused stage's parent to be set to A. Fusing a transform A with a descendant B will also cause fused stage's parent to be set to A. To fix this, if the parent of the fused stage would be one of transforms to be fused, set the parent to the parent of that transform instead.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-11T19:45:09Z", "url": "https://github.com/apache/beam/pull/13303", "merged": true, "mergeCommit": {"oid": "3d36122d82e40996077d873c0cdfe5433b997f96"}, "closed": true, "closedAt": "2020-11-14T04:37:23Z", "author": {"login": "yifanmai"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbjMfvgH2gAyNTE5NDEyNzQ2OmUwZGQwZGVjYzJhZDI2YWVmOWFhNGU1Njk0YjA3MDUxMzFkYmM1ZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcPSOkAH2gAyNTE5NDEyNzQ2OjJlZTdhZTM4M2NlZTA1YzNmNDNkZjVmZjIwMTRiZDgyMzEzNDU5ZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e0dd0decc2ad26aef9aa4e5694b0705131dbc5d9", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/e0dd0decc2ad26aef9aa4e5694b0705131dbc5d9", "committedDate": "2020-11-11T19:33:31Z", "message": "Ensure parent of fused stages is not one of the fused stages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4642c890c7eaeafa372d5f73b77db6adab84083", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/c4642c890c7eaeafa372d5f73b77db6adab84083", "committedDate": "2020-11-11T19:44:57Z", "message": "Fix docstring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "068b2c69f9f6531dc376227192e7f134e50754db", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/068b2c69f9f6531dc376227192e7f134e50754db", "committedDate": "2020-11-12T20:29:07Z", "message": "Fix typing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e6b03abc610d20dd4e25dad7f82639e460d3f9d", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/2e6b03abc610d20dd4e25dad7f82639e460d3f9d", "committedDate": "2020-11-12T20:30:00Z", "message": "Fix whitespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5Nzc4ODk1", "url": "https://github.com/apache/beam/pull/13303#pullrequestreview-529778895", "createdAt": "2020-11-13T06:18:19Z", "commit": {"oid": "e0dd0decc2ad26aef9aa4e5694b0705131dbc5d9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNjoxODoxOVrOHydm5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNjoyNDo0NlrOHydtYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3NTk0Mg==", "bodyText": "is it guaranteed that result in stages no longer holds after this?", "url": "https://github.com/apache/beam/pull/13303#discussion_r522675942", "createdAt": "2020-11-13T06:18:19Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -1212,6 +1213,22 @@ def get_ancestors(name):\n   return None\n \n \n+def _parent_for_fused_stages(stages, context):\n+  # type: (Iterable[str], TransformContext) -> Optional[str]\n+\n+  '''Returns the name of the new parent for the fused stages.\n+\n+  The new parent is the lowest common ancestor of the fused stages that is not\n+  contained in the set of fused stages. The provided context is used to compute\n+  ancestors of stages.\n+  '''\n+  result = functools.reduce(\n+      lambda a, b: _lowest_common_ancestor(a, b, context), stages)\n+  if result in stages:\n+    result = context.parents_map().get(result)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0dd0decc2ad26aef9aa4e5694b0705131dbc5d9"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3NzYwMg==", "bodyText": "dumb question: what's a key-with-none stage? Is it obvious why a single-sibling stage should be marked 'ineligible' or it needs a comment? Thanks.", "url": "https://github.com/apache/beam/pull/13303#discussion_r522677602", "createdAt": "2020-11-13T06:24:46Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -788,14 +789,14 @@ def get_stage_key(stage):\n   pcoll_id_remap = {}\n   remaining_stages = []\n   for sibling_stages in grouped_eligible_stages.values():\n+    if len(sibling_stages) == 1:\n+      ineligible_stages.extend(sibling_stages)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e6b03abc610d20dd4e25dad7f82639e460d3f9d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ce79474680e38b6a0d84d17e4906821afa884ef", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/8ce79474680e38b6a0d84d17e4906821afa884ef", "committedDate": "2020-11-13T21:21:11Z", "message": "Revert unnecessary change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDM3NzE4", "url": "https://github.com/apache/beam/pull/13303#pullrequestreview-530437718", "createdAt": "2020-11-13T21:49:45Z", "commit": {"oid": "8ce79474680e38b6a0d84d17e4906821afa884ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b91f196ec1751f7e58ca6ffc843d7d906638cb7c", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/b91f196ec1751f7e58ca6ffc843d7d906638cb7c", "committedDate": "2020-11-13T22:00:42Z", "message": "Typehint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee7ae383cee05c3f43df5ff2014bd82313459fb", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/2ee7ae383cee05c3f43df5ff2014bd82313459fb", "committedDate": "2020-11-13T22:55:36Z", "message": "lint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4772, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}