{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MjI2ODk0", "number": 10629, "title": "[BEAM-9130] Migrate HDFS IT to use tox env.", "bodyText": "Delegates to tox: apache_beam sdist build, package installation, and test procedure.\nGradle tasks: Remove unnecessary installGcpTest dep and virtualenv usage.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-17T16:42:19Z", "url": "https://github.com/apache/beam/pull/10629", "merged": true, "mergeCommit": {"oid": "e6a8cbdd2a58bc213611a4878c24c317be5fe353"}, "closed": true, "closedAt": "2020-01-17T18:58:26Z", "author": {"login": "udim"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7RfHZAH2gAyMzY0MjI2ODk0OmY3Y2IwYzBiYmQwODRjM2M3ZDhhN2M1ZTZiZmViY2M2Yzg1YTdjZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7SNxuAFqTM0NDczMDYzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7cb0c0bbd084c3c7d8a7c5e6bfebcc6c85a7cd8", "author": {"user": {"login": "udim", "name": "Udi Meiri"}}, "url": "https://github.com/apache/beam/commit/f7cb0c0bbd084c3c7d8a7c5e6bfebcc6c85a7cd8", "committedDate": "2020-01-17T16:38:50Z", "message": "Migrate HDFS IT to use tox env."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a29197f9285bdbd10cbeecd3166d90e1c17a61", "author": {"user": {"login": "udim", "name": "Udi Meiri"}}, "url": "https://github.com/apache/beam/commit/86a29197f9285bdbd10cbeecd3166d90e1c17a61", "committedDate": "2020-01-17T17:18:13Z", "message": "Fix for py2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72066dda7dd190a1b69a3ba1b6084ea72923ebce", "author": {"user": {"login": "udim", "name": "Udi Meiri"}}, "url": "https://github.com/apache/beam/commit/72066dda7dd190a1b69a3ba1b6084ea72923ebce", "committedDate": "2020-01-17T17:05:52Z", "message": "Fix for py2"}, "afterCommit": {"oid": "86a29197f9285bdbd10cbeecd3166d90e1c17a61", "author": {"user": {"login": "udim", "name": "Udi Meiri"}}, "url": "https://github.com/apache/beam/commit/86a29197f9285bdbd10cbeecd3166d90e1c17a61", "committedDate": "2020-01-17T17:18:13Z", "message": "Fix for py2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzMwNjM4", "url": "https://github.com/apache/beam/pull/10629#pullrequestreview-344730638", "createdAt": "2020-01-17T17:28:47Z", "commit": {"oid": "72066dda7dd190a1b69a3ba1b6084ea72923ebce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzoyOTozOVrOFfAF_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzoyOTozOVrOFfAF_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MTcxMQ==", "bodyText": "so our goal is to install grpcio-tools (and therefore protobuf, one of its deps) into the same python environment where sdist is run, before the tests run.  This is easier said than done.\nInstalling build-requirements.txt here in the dockerfile affects the environment where tox is installed and runs, but i'm not sure if it affects the environments where tox runs sdist, especially if tox is trying to create a temp env to run sdist (which I know it does when it's operating in pep517 mode).\nAdding build-requirements.txt to the deps in tox.ini I think only affects the environment where the tests run, but not where tox runs sdist.\ngen_protos.py also does its own attempt to install build-requirements.txt if it detects grpcio-tools is not installed, but it does it in a weird way with a target install directory, which I think might not be reliable for the google .pth file that makes protobufs importable in python2 (see earlier discussion about site dirs).\nSo, I've got 2 ideas left for how to hack this together without going full pep517:\n\nrun python setup.py sdist here in dockerland, after installing build-requirements, and pass the sdist to tox.  That should guarantee that sdist is run in an env where protobuf is properly installed where the google .pth file will work, since we're installing it into the site-packages of the python interpreter running here, and not some temp dir.\nchange the logic in gen_protos where it installs build-requirements to also ensure that the directory it installs into is added as a site dir, by calling site.addsitedir() on that directory from the environment where we want to be able to import google.protobuf.", "url": "https://github.com/apache/beam/pull/10629#discussion_r368051711", "createdAt": "2020-01-17T17:29:39Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/io/hdfs_integration_test/Dockerfile", "diffHunk": "@@ -24,22 +24,13 @@ FROM $BASE_IMAGE\n \n WORKDIR /app\n ENV HDFSCLI_CONFIG /app/sdks/python/apache_beam/io/hdfs_integration_test/hdfscli.cfg\n-RUN pip install --no-cache-dir holdup gsutil\n-RUN gsutil cp gs://dataflow-samples/shakespeare/kinglear.txt .\n \n-# Install Beam and dependencies.\n-ADD sdks/python /app/sdks/python\n-ADD model /app/model\n-RUN cd sdks/python && \\\n-    python setup.py sdist && \\\n-    pip install --no-cache-dir $(ls dist/apache-beam-*.tar.gz | tail -n1)[gcp]\n+# Add Beam SDK sources.\n+COPY sdks/python /app/sdks/python\n+COPY model /app/model\n+\n+# This step should look like setupVirtualenv minus virtualenv creation.\n+RUN pip install --no-cache-dir tox==3.11.1 -r sdks/python/build-requirements.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86a29197f9285bdbd10cbeecd3166d90e1c17a61"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3519, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}