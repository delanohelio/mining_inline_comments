{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDk5NzI0", "number": 12960, "title": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset", "bodyText": "Allow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration.\nThere are some uses cases that require temporary datasets created when using beam.io.BigQuerySource to be in a different GCP project (e.g service account permissions, billing).\nWe could make the project where temporary datasets configurable, so that the temp dataset is created in a user specified project. Example:\npipeline = p | \"Read from BQ source\" >> beam.io.ReadFromBigQuery(\n      query=q,\n      use_standard_sql=True,\n      project='frankzhao-test-project',\n      temp_dataset=bigquery.DatasetReference(\n          projectId='bigquery-project', datasetId='bq_temp'))\n\nThis PR adds the temp_dataset option to allow user configuration of the temporary dataset location when using ReadFromBigQuery, which defaults to the execution project. A DatasetReference is used to allow for the dataset location to be in a different project (BEAM-10859).\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-09-29T02:17:20Z", "url": "https://github.com/apache/beam/pull/12960", "merged": true, "mergeCommit": {"oid": "7038af28c23e3eac7ead6797328cc6c7dac06874"}, "closed": true, "closedAt": "2020-11-10T20:27:56Z", "author": {"login": "frankzhao"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNe0A8gBqjM4MTcxODE0MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbHXfXgBqjM5NzgzNDA2MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "973e62acba684fc0271d140b3b6802513007bb1c", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/973e62acba684fc0271d140b3b6802513007bb1c", "committedDate": "2020-09-29T02:05:14Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}, "afterCommit": {"oid": "bbe413bebf3bff4d7697f2df95ffdaf421148d62", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/bbe413bebf3bff4d7697f2df95ffdaf421148d62", "committedDate": "2020-09-29T02:31:59Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbe413bebf3bff4d7697f2df95ffdaf421148d62", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/bbe413bebf3bff4d7697f2df95ffdaf421148d62", "committedDate": "2020-09-29T02:31:59Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}, "afterCommit": {"oid": "9a14567a6b29bc8f1f60f3d727a8847e516ac00a", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/9a14567a6b29bc8f1f60f3d727a8847e516ac00a", "committedDate": "2020-10-01T00:58:51Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzY4NzIx", "url": "https://github.com/apache/beam/pull/12960#pullrequestreview-507768721", "createdAt": "2020-10-13T19:39:38Z", "commit": {"oid": "71c3ea69535268d1e37a8b97decefbf1a0e466ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxOTozOTozOFrOHg2gNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxOTozOTozOFrOHg2gNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwOTQ2MA==", "bodyText": "The BigQueryReader is only used in the Dataflow native BigQuerySource - I don't think this is compatible, so we should probably revert changes to it.\nLet's focus on temp_dataset for _CustomBigQuerySource.", "url": "https://github.com/apache/beam/pull/12960#discussion_r504209460", "createdAt": "2020-10-13T19:39:38Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -1096,7 +1114,8 @@ def __init__(\n       test_bigquery_client=None,\n       use_legacy_sql=True,\n       flatten_results=True,\n-      kms_key=None):\n+      kms_key=None,\n+      temp_dataset=None):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71c3ea69535268d1e37a8b97decefbf1a0e466ab"}, "originalPosition": 116}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9963808c5ce9c386b2d1ce7e1dfd9c4f0ca4346e", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/9963808c5ce9c386b2d1ce7e1dfd9c4f0ca4346e", "committedDate": "2020-10-27T09:47:56Z", "message": "Revert changes to BigQueryReader"}, "afterCommit": {"oid": "f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "committedDate": "2020-10-27T10:29:44Z", "message": "Revert changes to BigQueryReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/f3b4c5d97c0b6bb259d8d62e86eae2e140dc023d", "committedDate": "2020-10-27T10:29:44Z", "message": "Revert changes to BigQueryReader"}, "afterCommit": {"oid": "5d25ada09e50267d0988379ab304c25765b363ef", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/5d25ada09e50267d0988379ab304c25765b363ef", "committedDate": "2020-10-27T11:15:44Z", "message": "Revert changes to BigQueryReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d25ada09e50267d0988379ab304c25765b363ef", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/5d25ada09e50267d0988379ab304c25765b363ef", "committedDate": "2020-10-27T11:15:44Z", "message": "Revert changes to BigQueryReader"}, "afterCommit": {"oid": "07445956fb6b6bf83bbd2028ce6714d5cfeba053", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/07445956fb6b6bf83bbd2028ce6714d5cfeba053", "committedDate": "2020-10-27T23:39:35Z", "message": "Revert changes to BigQueryReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a8e99177e30907f4ffb400c11b0b03b7c6a8a92", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/8a8e99177e30907f4ffb400c11b0b03b7c6a8a92", "committedDate": "2020-10-28T11:53:13Z", "message": "Fix project_id when cleaning up temporary dataset"}, "afterCommit": {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "committedDate": "2020-10-28T12:19:36Z", "message": "Fix project_id when cleaning up temporary dataset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDA5OTQ5", "url": "https://github.com/apache/beam/pull/12960#pullrequestreview-520009949", "createdAt": "2020-10-29T19:36:58Z", "commit": {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTozNjo1OVrOHqrmiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTo0MToyMlrOHqrvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxNjYxNw==", "bodyText": "in beam, we usually break lines using parentheses, kind of like this:\ndataset_id = (\n    dataset_reference.datasetId if dataset_reference else temp_table.datasetId)", "url": "https://github.com/apache/beam/pull/12960#discussion_r514516617", "createdAt": "2020-10-29T19:36:59Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -731,16 +744,19 @@ def create_temporary_dataset(self, project_id, location):\n   @retry.with_exponential_backoff(\n       num_retries=MAX_RETRIES,\n       retry_filter=retry.retry_on_server_errors_and_timeout_filter)\n-  def clean_up_temporary_dataset(self, project_id):\n+  def clean_up_temporary_dataset(self, project_id, dataset_reference=None):\n+    if dataset_reference:\n+      project_id = dataset_reference.projectId\n     temp_table = self._get_temp_table(project_id)\n+    dataset_id = dataset_reference.datasetId if dataset_reference \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxODkzNg==", "bodyText": "how about we add a get_temporary_dataset function to BigqueryWrapper, and we can define a self.temp_dataset = self.temp_dataset or bq.get_temporary_dataset() (this logic would need to run in the split, and `- and once we've done that, we can just pass the dataset name around to every call? That way we will treat the user-defined dataset and the automatic dataset the same way?", "url": "https://github.com/apache/beam/pull/12960#discussion_r514518936", "createdAt": "2020-10-29T19:41:22Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/io/gcp/bigquery.py", "diffHunk": "@@ -712,6 +713,7 @@ def __init__(\n     self.bq_io_metadata = None  # Populate in setup, as it may make an RPC\n     self.bigquery_job_labels = bigquery_job_labels or {}\n     self.use_json_exports = use_json_exports\n+    self.temp_dataset = temp_dataset", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/be45d63d6bc32ee0ca38f45b1b5764cf746b1c74", "committedDate": "2020-10-28T12:19:36Z", "message": "Fix project_id when cleaning up temporary dataset"}, "afterCommit": {"oid": "6980d936a2100e447e1421a84c3e8c58c3f47b7d", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/6980d936a2100e447e1421a84c3e8c58c3f47b7d", "committedDate": "2020-11-10T05:04:00Z", "message": "Refactor to pass dataset through BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6980d936a2100e447e1421a84c3e8c58c3f47b7d", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/6980d936a2100e447e1421a84c3e8c58c3f47b7d", "committedDate": "2020-11-10T05:04:00Z", "message": "Refactor to pass dataset through BigQueryWrapper"}, "afterCommit": {"oid": "85830ab244f9c93acc76f91287337b17c6e74d61", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/85830ab244f9c93acc76f91287337b17c6e74d61", "committedDate": "2020-11-10T05:11:57Z", "message": "Refactor to pass dataset through BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85830ab244f9c93acc76f91287337b17c6e74d61", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/85830ab244f9c93acc76f91287337b17c6e74d61", "committedDate": "2020-11-10T05:11:57Z", "message": "Refactor to pass dataset through BigQueryWrapper"}, "afterCommit": {"oid": "ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "committedDate": "2020-11-10T05:58:33Z", "message": "Refactor to pass dataset through BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/ba6b32bea97b6f7bf1ceb704174ca30dd9f1ba18", "committedDate": "2020-11-10T05:58:33Z", "message": "Refactor to pass dataset through BigQueryWrapper"}, "afterCommit": {"oid": "bffe7bdf6758acbeeb5441d314c4eed8851f7295", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/bffe7bdf6758acbeeb5441d314c4eed8851f7295", "committedDate": "2020-11-10T06:33:03Z", "message": "Refactor to pass dataset through BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bffe7bdf6758acbeeb5441d314c4eed8851f7295", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/bffe7bdf6758acbeeb5441d314c4eed8851f7295", "committedDate": "2020-11-10T06:33:03Z", "message": "Refactor to pass dataset through BigQueryWrapper"}, "afterCommit": {"oid": "6cdedaafeef5335fd0cc06367302581a86da4173", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/6cdedaafeef5335fd0cc06367302581a86da4173", "committedDate": "2020-11-10T10:19:00Z", "message": "Refactor to pass dataset through BigQueryWrapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bd1260475191321af56182787435a9c617066f", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/50bd1260475191321af56182787435a9c617066f", "committedDate": "2020-11-10T11:07:52Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cdedaafeef5335fd0cc06367302581a86da4173", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/6cdedaafeef5335fd0cc06367302581a86da4173", "committedDate": "2020-11-10T10:19:00Z", "message": "Refactor to pass dataset through BigQueryWrapper"}, "afterCommit": {"oid": "50bd1260475191321af56182787435a9c617066f", "author": {"user": {"login": "frankzhao", "name": "Frank Zhao"}}, "url": "https://github.com/apache/beam/commit/50bd1260475191321af56182787435a9c617066f", "committedDate": "2020-11-10T11:07:52Z", "message": "[BEAM-9804] Allow user configuration of BigQuery temporary dataset\n\nAllow ReadFromBigQuery to use a user pre-configured dataset for the temporary dataset.\nUsing a DatasetReference will also allow for cross project temporary dataset configuration."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2600, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}