{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNjMxNjM0", "number": 11567, "title": "[BEAM-8132] Report Python metrics to InfluxDB", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-29T10:44:04Z", "url": "https://github.com/apache/beam/pull/11567", "merged": true, "mergeCommit": {"oid": "334682d4a8ac5e1ebd298ba3b8020a9161884927"}, "closed": true, "closedAt": "2020-05-12T12:22:25Z", "author": {"login": "kamilwu"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccWTEVABqjMyODQwNTE5NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgQjLlAH2gAyNDEwNjMxNjM0OmM4YjI4MTgxOTEzYTU5MmFhZmQ1YjNmZmY2NzE0YWJjNDk4NzIzYjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9786fedc8a7cf0e2a0ef4c6f5eb15beb7fe99cc6", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/9786fedc8a7cf0e2a0ef4c6f5eb15beb7fe99cc6", "committedDate": "2020-04-29T10:43:12Z", "message": "[BEAM-8132] Report Python metrics to InfluxDB"}, "afterCommit": {"oid": "159a3606e8121eb87804504c5640c279fd16fc8a", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/159a3606e8121eb87804504c5640c279fd16fc8a", "committedDate": "2020-04-29T10:54:31Z", "message": "[BEAM-8132] Report Python metrics to InfluxDB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/52c2553b7547fb095b22951fc0be9811f6013938", "committedDate": "2020-05-08T10:44:10Z", "message": "[BEAM-8132] Report Python metrics to InfluxDB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "159a3606e8121eb87804504c5640c279fd16fc8a", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/159a3606e8121eb87804504c5640c279fd16fc8a", "committedDate": "2020-04-29T10:54:31Z", "message": "[BEAM-8132] Report Python metrics to InfluxDB"}, "afterCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/52c2553b7547fb095b22951fc0be9811f6013938", "committedDate": "2020-05-08T10:44:10Z", "message": "[BEAM-8132] Report Python metrics to InfluxDB"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjE0NDI0", "url": "https://github.com/apache/beam/pull/11567#pullrequestreview-408214424", "createdAt": "2020-05-08T12:49:59Z", "commit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMjo0OTo1OVrOGSkaXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxMzowMjowNFrOGSkvvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNDEyNA==", "bodyText": "I am not sure if I correctly understand what measurement means. Is it name for metric such as runtime or name of place where metric will be stored as \"table\" or \"column\"?", "url": "https://github.com/apache/beam/pull/11567#discussion_r422124124", "createdAt": "2020-05-08T12:49:59Z", "author": {"login": "kkucharc"}, "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -45,6 +47,19 @@ def _add_argparse_args(cls, parser):\n         '--metrics_table',\n         help='A BigQuery table where metrics should be '\n         'written.')\n+    parser.add_argument(\n+        '--influx_measurement',\n+        help='An InfluxDB measurement where metrics should be published to. If '", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNTA0OA==", "bodyText": "Is it something we could enable to provide via PipelineOptions as well?", "url": "https://github.com/apache/beam/pull/11567#discussion_r422125048", "createdAt": "2020-05-08T12:52:05Z", "author": {"login": "kkucharc"}, "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -67,22 +82,30 @@ def _str_to_boolean(value):\n \n \n class LoadTest(object):\n+  \"\"\"Base class for all integration and performance tests which export\n+  metrics to external databases: BigQuery or/and InfluxDB.\n+\n+  Refer to :class:`~apache_beam.testing.load_tests.LoadTestOptions` for more\n+  information on the required pipeline options.\n+\n+  If using InfluxDB with Basic HTTP authentication enabled, provide the\n+  following environment options: `INFLUXDB_USER` and `INFLUXDB_USER_PASSWORD`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyNzk0NA==", "bodyText": "Maybe we should remove this if since we have now two targets where we publish metrics?", "url": "https://github.com/apache/beam/pull/11567#discussion_r422127944", "createdAt": "2020-05-08T12:58:21Z", "author": {"login": "kkucharc"}, "path": "sdks/python/apache_beam/testing/load_tests/load_test.py", "diffHunk": "@@ -67,22 +82,30 @@ def _str_to_boolean(value):\n \n \n class LoadTest(object):\n+  \"\"\"Base class for all integration and performance tests which export\n+  metrics to external databases: BigQuery or/and InfluxDB.\n+\n+  Refer to :class:`~apache_beam.testing.load_tests.LoadTestOptions` for more\n+  information on the required pipeline options.\n+\n+  If using InfluxDB with Basic HTTP authentication enabled, provide the\n+  following environment options: `INFLUXDB_USER` and `INFLUXDB_USER_PASSWORD`.\n+  \"\"\"\n   def __init__(self):\n     # Be sure to set blocking to false for timeout_ms to work properly\n     self.pipeline = TestPipeline(is_integration_test=True, blocking=False)\n     assert not self.pipeline.blocking\n \n-    load_test_options = self.pipeline.get_pipeline_options().view_as(\n-        LoadTestOptions)\n-    self.timeout_ms = load_test_options.timeout_ms\n-    self.input_options = load_test_options.input_options\n-    self.metrics_namespace = load_test_options.metrics_table or 'default'\n-    publish_to_bq = load_test_options.publish_to_big_query\n+    options = self.pipeline.get_pipeline_options().view_as(LoadTestOptions)\n+    self.timeout_ms = options.timeout_ms\n+    self.input_options = options.input_options\n+    self.metrics_namespace = options.metrics_table or 'default'\n+    publish_to_bq = options.publish_to_big_query\n     if publish_to_bq is None:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyODc5OQ==", "bodyText": "Do you think it would be good to have consistent parameter naming for influx and bq? Or we plan to abandon bq in future?", "url": "https://github.com/apache/beam/pull/11567#discussion_r422128799", "createdAt": "2020-05-08T13:00:25Z", "author": {"login": "kkucharc"}, "path": "sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py", "diffHunk": "@@ -167,14 +175,15 @@ class MetricsReader(object):\n   A :class:`MetricsReader` retrieves metrics from pipeline result,\n   prepares it for publishers and setup publishers.\n   \"\"\"\n-  publishers = []  # type: List[ConsoleMetricsPublisher]\n+  publishers = []  # type: List[Any]\n \n   def __init__(\n       self,\n       project_name=None,\n       bq_table=None,\n       bq_dataset=None,\n       publish_to_bq=False,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjEyOTU5Ng==", "bodyText": "Why do we need this default value here? Isn't it provided from pipeline options default value?", "url": "https://github.com/apache/beam/pull/11567#discussion_r422129596", "createdAt": "2020-05-08T13:02:04Z", "author": {"login": "kkucharc"}, "path": "sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py", "diffHunk": "@@ -404,6 +419,77 @@ def save(self, results):\n     return self._client.insert_rows(self._bq_table, results)\n \n \n+class InfluxDBMetricsPublisherOptions(object):\n+  def __init__(\n+      self,\n+      measurement,  # type: str\n+      db_name,  # type: str\n+      hostname='http://localhost:8086',  # type: str", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c2553b7547fb095b22951fc0be9811f6013938"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b28181913a592aafd5b3fff6714abc498723b6", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/c8b28181913a592aafd5b3fff6714abc498723b6", "committedDate": "2020-05-11T14:28:34Z", "message": "fix: addressing comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4094, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}