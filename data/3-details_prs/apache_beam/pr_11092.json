{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MjIwNjc3", "number": 11092, "title": "[BEAM-9085] Fix performance regression in SyntheticSource on Python 3", "bodyText": "Beam was using numpy.random.RandomState during generation of Synthetic input, which, starting from NumPy 1.17, is considered as a legacy generator. This caused the slowdown on Python 3. The solution is using random module instead of Numpy on Python 3, and keep using Numpy on Python 2 until we deprecate Python 2 support.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-10T15:58:24Z", "url": "https://github.com/apache/beam/pull/11092", "merged": true, "mergeCommit": {"oid": "79b2d87b59819ee55fb8600e8a845c6ba5b98d64"}, "closed": true, "closedAt": "2020-04-09T17:44:36Z", "author": {"login": "kamilwu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVS7AZAH2gAyMzg2MjIwNjc3OjFlMjMwZmEwMWIwNDcxNDIyYjI3MTNjN2Q3ZGM1MTcyYmFiMTg2ZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWAJM6AFqTM5MTAwMDU1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1e230fa01b0471422b2713c7d7dc5172bab186ee", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/1e230fa01b0471422b2713c7d7dc5172bab186ee", "committedDate": "2020-04-07T13:01:14Z", "message": "[BEAM-9085] Fix performance regression in SyntheticSource\n\nBeam was using `numpy.random.RandomState` during generation of Synthetic input, which, starting from NumPy 1.17, is considered as a legacy generator. This caused the slowdown on Python 3. The solution was using `random` module instead of Numpy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c59f45cf2a313b5f5f8c7f0b76318c279df5bcc", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/0c59f45cf2a313b5f5f8c7f0b76318c279df5bcc", "committedDate": "2020-04-07T13:01:14Z", "message": "fix: Disable \"map built-in referenced when not iterating\" pylint warning"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ed724b0e13ed5b0c47b2c5b33b4fa5b7886bed5", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/6ed724b0e13ed5b0c47b2c5b33b4fa5b7886bed5", "committedDate": "2020-03-11T10:03:26Z", "message": "fix: Disable \"map built-in referenced when not iterating\" pylint warning"}, "afterCommit": {"oid": "1bdbcae364277d5ea20547e8ed24df1920dec4b0", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/1bdbcae364277d5ea20547e8ed24df1920dec4b0", "committedDate": "2020-04-08T09:10:16Z", "message": "fix: keep using numpy.RandomState for python 2.7"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5ODE3Njk5", "url": "https://github.com/apache/beam/pull/11092#pullrequestreview-389817699", "createdAt": "2020-04-08T09:46:01Z", "commit": {"oid": "1bdbcae364277d5ea20547e8ed24df1920dec4b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo0NjowMlrOGCnf9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo0NjowMlrOGCnf9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM5NzQ5Mg==", "bodyText": "@tvalentyn Do we have a JIRA issue that accumulates all things that have to be done when Beam drops py2? I know there is a https://issues.apache.org/jira/browse/BEAM-5949, but this refers only to __ne__", "url": "https://github.com/apache/beam/pull/11092#discussion_r405397492", "createdAt": "2020-04-08T09:46:02Z", "author": {"login": "kamilwu"}, "path": "sdks/python/apache_beam/testing/synthetic_pipeline.py", "diffHunk": "@@ -61,6 +65,35 @@\n   np = None\n \n \n+class _Random(Random):\n+  \"\"\"A subclass of `random.Random` from the Python Standard Library that\n+  provides a method returning random bytes of arbitrary length.\n+  \"\"\"\n+\n+  # `numpy.random.RandomState` does not provide `random()` method, we keep this\n+  # for compatibility reasons.\n+  random_sample = Random.random\n+\n+  def bytes(self, length):\n+    \"\"\"Returns random bytes.\n+\n+    Args:\n+      length (int): Number of random bytes.\n+    \"\"\"\n+    n = length // 8 + 1\n+    # pylint: disable=map-builtin-not-iterating\n+    return struct.pack(\n+        '{}Q'.format(n), *map(self.getrandbits, itertools.repeat(64,\n+                                                                 n)))[:length]\n+\n+\n+Generator = _Random\n+\n+# TODO: Remove this when Beam drops Python 2.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bdbcae364277d5ea20547e8ed24df1920dec4b0"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5a8bb35576b37e403f5071c7ec24ff93a42eae7", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/a5a8bb35576b37e403f5071c7ec24ff93a42eae7", "committedDate": "2020-04-08T09:50:07Z", "message": "fix: keep using numpy.RandomState for python 2.7"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bdbcae364277d5ea20547e8ed24df1920dec4b0", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/1bdbcae364277d5ea20547e8ed24df1920dec4b0", "committedDate": "2020-04-08T09:10:16Z", "message": "fix: keep using numpy.RandomState for python 2.7"}, "afterCommit": {"oid": "a5a8bb35576b37e403f5071c7ec24ff93a42eae7", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/a5a8bb35576b37e403f5071c7ec24ff93a42eae7", "committedDate": "2020-04-08T09:50:07Z", "message": "fix: keep using numpy.RandomState for python 2.7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6ab608743e0c0fc182e4ab10da48239da1cf18c", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/e6ab608743e0c0fc182e4ab10da48239da1cf18c", "committedDate": "2020-04-08T13:08:22Z", "message": "fix: silent sphinx warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDUyMDg4", "url": "https://github.com/apache/beam/pull/11092#pullrequestreview-390452088", "createdAt": "2020-04-09T02:27:53Z", "commit": {"oid": "e6ab608743e0c0fc182e4ab10da48239da1cf18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjoyNzo1M1rOGDHdOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjoyNzo1M1rOGDHdOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMTA4MA==", "bodyText": "Since we don't need py2 compatibility anymore, consider using to_bytes. Here's an equivalent for chunk_size=8. It seems to be somewhat slower than current method (perhaps since I'm not using map+repeat()), but with larger chuck_size, seems to be more efficient. Large chunk size may be less efficient for short bytesequences.\nchunk_size_bytes = 8 // TBD - larger chunks seem to improve performance.\nchunk_size_bits = chunk_size_bytes * 8\nnum_chunks = length // chunk_size_bytes + 1\n\nreturn b''.join([self.getrandbits(chunk_size_bits).to_bytes(chunk_size_bytes, sys.byteorder) for _ in range(num_chunks)])[:length]\n\nIf you decide to keep current implementation - please add a comment explaining the mechanics for readers not familiar with this code (we generate 8-byte stings, and then fit them into a representation of C++'s long-long, which also takes up 8 bytes).", "url": "https://github.com/apache/beam/pull/11092#discussion_r405921080", "createdAt": "2020-04-09T02:27:53Z", "author": {"login": "tvalentyn"}, "path": "sdks/python/apache_beam/testing/synthetic_pipeline.py", "diffHunk": "@@ -61,6 +65,35 @@\n   np = None\n \n \n+class _Random(Random):\n+  \"\"\"A subclass of `random.Random` from the Python Standard Library that\n+  provides a method returning random bytes of arbitrary length.\n+  \"\"\"\n+\n+  # `numpy.random.RandomState` does not provide `random()` method, we keep this\n+  # for compatibility reasons.\n+  random_sample = Random.random\n+\n+  def bytes(self, length):\n+    \"\"\"Returns random bytes.\n+\n+    Args:\n+      length (int): Number of random bytes.\n+    \"\"\"\n+    n = length // 8 + 1\n+    # pylint: disable=map-builtin-not-iterating\n+    return struct.pack(\n+        '{}Q'.format(n),\n+        *map(self.getrandbits, itertools.repeat(64, n)))[:length]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6ab608743e0c0fc182e4ab10da48239da1cf18c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a983f5960d6dfe040cb733b5d1f07516e4cd147", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/3a983f5960d6dfe040cb733b5d1f07516e4cd147", "committedDate": "2020-04-09T08:50:45Z", "message": "fix: add jira issue id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102f8626334419eeda1f14cae64bed4bad97402f", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/102f8626334419eeda1f14cae64bed4bad97402f", "committedDate": "2020-04-09T11:49:25Z", "message": "fix: use `to_bytes`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c40df98f0d3e03d93434d7ab0018defedf1c131", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/2c40df98f0d3e03d93434d7ab0018defedf1c131", "committedDate": "2020-04-09T11:41:57Z", "message": "fix: use `to_bytes`"}, "afterCommit": {"oid": "102f8626334419eeda1f14cae64bed4bad97402f", "author": {"user": {"login": "kamilwu", "name": "Kamil Wasilewski"}}, "url": "https://github.com/apache/beam/commit/102f8626334419eeda1f14cae64bed4bad97402f", "committedDate": "2020-04-09T11:49:25Z", "message": "fix: use `to_bytes`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDAwNTU0", "url": "https://github.com/apache/beam/pull/11092#pullrequestreview-391000554", "createdAt": "2020-04-09T17:42:28Z", "commit": {"oid": "102f8626334419eeda1f14cae64bed4bad97402f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3134, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}