{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDk5MjYy", "number": 12564, "title": "[BEAM-10612] add Flink 1.11 runner", "bodyText": "WIP\nAlmost there except the following error:\n> Task :runners:flink:1.11:compileJava\n/home/neville/src/apache/beam-git/runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java:702: error: timeServiceManager has private access in AbstractStreamOperator\n      timeServiceManager.advanceWatermark(new Watermark(inputWatermarkHold));\n\nI tried working around it by forking the test & back porting the StreamOperatorStateContext.internalTimerServiceManager logic from upstream but ran into other issues including checkstyle errors w.r.t. missing package-info.java and test failures.\nIt worked with my forked upstream Flink build with AbstractStreamOperator.timeServiceManager reverted to protected.\n@mxm any ideas?\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-13T01:53:34Z", "url": "https://github.com/apache/beam/pull/12564", "merged": true, "mergeCommit": {"oid": "efad73ccd3d1be868980ea6f5465840aca858a24"}, "closed": true, "closedAt": "2020-08-15T10:06:22Z", "author": {"login": "nevillelyh"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-bQQngFqTQ2NjUxNzM4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-37EWgBqjM2NTcwNjA5NTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTE3Mzgx", "url": "https://github.com/apache/beam/pull/12564#pullrequestreview-466517381", "createdAt": "2020-08-13T07:42:05Z", "commit": {"oid": "28771436d428f66c44483791d04844a7e3e99351"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo0MjowNVrOG__wsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo0MjowNVrOG__wsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1ODEyOA==", "bodyText": "Do you think we could avoid duplicating all this code? If the signature changed, we should rather define an Interface to retrieve the pipeline/construct the environment, which different versions can override. Alternatively, using reflection is also a valid option in tests.", "url": "https://github.com/apache/beam/pull/12564#discussion_r469758128", "createdAt": "2020-08-13T07:42:05Z", "author": {"login": "mxm"}, "path": "runners/flink/1.11/src/test/java/org/apache/beam/runners/flink/FlinkRunnerTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.runners.flink;\n+\n+import static org.hamcrest.CoreMatchers.allOf;\n+\n+import org.apache.beam.sdk.Pipeline;\n+import org.apache.beam.sdk.PipelineResult;\n+import org.apache.beam.sdk.io.GenerateSequence;\n+import org.apache.beam.sdk.options.PipelineOptions;\n+import org.apache.beam.sdk.options.PipelineOptionsFactory;\n+import org.apache.flink.client.program.OptimizerPlanEnvironment;\n+import org.apache.flink.client.program.PackagedProgram;\n+import org.apache.flink.client.program.PackagedProgramUtils;\n+import org.apache.flink.client.program.ProgramInvocationException;\n+import org.apache.flink.configuration.Configuration;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/**\n+ * Test for {@link FlinkRunner}.\n+ *\n+ * <p>This test is copied to 1.10 is becauses the signature of the method getPipeline in\n+ * OptimizerPlanEnvironment has been changed in Flink 1.10, please refer to\n+ * https://github.com/apache/flink/commit/0ea4dd7e9d56a017743ca6794d28537800faab6f for more details.\n+ */\n+public class FlinkRunnerTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28771436d428f66c44483791d04844a7e3e99351"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28771436d428f66c44483791d04844a7e3e99351", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/28771436d428f66c44483791d04844a7e3e99351", "committedDate": "2020-08-13T01:13:14Z", "message": "fork RemoteMiniClusterImpl to 1.12 and fix breakage"}, "afterCommit": {"oid": "9bf540482f4f11703f93517417f92205c60db8a4", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/9bf540482f4f11703f93517417f92205c60db8a4", "committedDate": "2020-08-13T17:26:17Z", "message": "fix FlinkRunnerTest\n\n- OptimizerPlanEnvironment constructor change\n- OptimizerPlanEnvironment.getPipeline => PackagedProgramUtils.getPipelineFromProgram\n- Add FlinkRunnerTestCompat and consolidate tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bf540482f4f11703f93517417f92205c60db8a4", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/9bf540482f4f11703f93517417f92205c60db8a4", "committedDate": "2020-08-13T17:26:17Z", "message": "fix FlinkRunnerTest\n\n- OptimizerPlanEnvironment constructor change\n- OptimizerPlanEnvironment.getPipeline => PackagedProgramUtils.getPipelineFromProgram\n- Add FlinkRunnerTestCompat and consolidate tests"}, "afterCommit": {"oid": "d2f3a75c10828cb8e22738487f3746a8130dddc5", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/d2f3a75c10828cb8e22738487f3746a8130dddc5", "committedDate": "2020-08-13T17:30:24Z", "message": "fix FlinkRunnerTest\n\n- OptimizerPlanEnvironment constructor change\n- OptimizerPlanEnvironment.getPipeline => PackagedProgramUtils.getPipelineFromProgram\n- Add FlinkRunnerTestCompat and consolidate tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2f3a75c10828cb8e22738487f3746a8130dddc5", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/d2f3a75c10828cb8e22738487f3746a8130dddc5", "committedDate": "2020-08-13T17:30:24Z", "message": "fix FlinkRunnerTest\n\n- OptimizerPlanEnvironment constructor change\n- OptimizerPlanEnvironment.getPipeline => PackagedProgramUtils.getPipelineFromProgram\n- Add FlinkRunnerTestCompat and consolidate tests"}, "afterCommit": {"oid": "8ee08b5608ff0c6c428c2f1856404696b37ff681", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/8ee08b5608ff0c6c428c2f1856404696b37ff681", "committedDate": "2020-08-13T17:56:44Z", "message": "fix FlinkRunnerTest\n\n- OptimizerPlanEnvironment constructor change\n- OptimizerPlanEnvironment.getPipeline => PackagedProgramUtils.getPipelineFromProgram\n- Add FlinkRunnerTestCompat and consolidate tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDcwOTEw", "url": "https://github.com/apache/beam/pull/12564#pullrequestreview-467470910", "createdAt": "2020-08-14T10:25:11Z", "commit": {"oid": "8ee08b5608ff0c6c428c2f1856404696b37ff681"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMDoyNToxMVrOHAvqGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMDozNDowM1rOHAv5Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0Mjg3NQ==", "bodyText": "nit: unrelated change", "url": "https://github.com/apache/beam/pull/12564#discussion_r470542875", "createdAt": "2020-08-14T10:25:11Z", "author": {"login": "mxm"}, "path": "runners/flink/1.8/build.gradle", "diffHunk": "@@ -17,7 +17,6 @@\n  */\n \n def basePath = '..'\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ee08b5608ff0c6c428c2f1856404696b37ff681"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0MzM3MQ==", "bodyText": "Is it really the blob server port here or do we want the Job server RPC port?", "url": "https://github.com/apache/beam/pull/12564#discussion_r470543371", "createdAt": "2020-08-14T10:26:13Z", "author": {"login": "mxm"}, "path": "runners/flink/1.11/src/test/java/org/apache/beam/runners/flink/RemoteMiniClusterImpl.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.runners.flink;\n+\n+import org.apache.flink.runtime.minicluster.MiniCluster;\n+import org.apache.flink.runtime.minicluster.MiniClusterConfiguration;\n+\n+/** A {@link MiniCluster} which allows remote connections for the end-to-end test. */\n+public class RemoteMiniClusterImpl extends RemoteMiniCluster {\n+\n+  public RemoteMiniClusterImpl(MiniClusterConfiguration miniClusterConfiguration) {\n+    super(miniClusterConfiguration);\n+  }\n+\n+  @Override\n+  public int getClusterPort() {\n+    return getClusterInformation().getBlobServerPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ee08b5608ff0c6c428c2f1856404696b37ff681"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU0NjcwNg==", "bodyText": "Thanks!\nIf the problem doesn't go away after running ./gradlew -p runners/flink clean, then you might have to add a suppression here: \n  \n    \n      beam/sdks/java/build-tools/src/main/resources/beam/suppressions.xml\n    \n    \n         Line 111\n      in\n      02bf081\n    \n    \n    \n    \n\n        \n          \n           <suppress checks=\"JavadocPackage\" files=\".*runners.flink.*CoderTypeSerializer\\.java\"/>", "url": "https://github.com/apache/beam/pull/12564#discussion_r470546706", "createdAt": "2020-08-14T10:34:03Z", "author": {"login": "mxm"}, "path": "runners/flink/1.11/src/test/java/org/apache/beam/runners/flink/FlinkRunnerTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.runners.flink;\n+\n+import static org.hamcrest.CoreMatchers.allOf;\n+\n+import org.apache.beam.sdk.Pipeline;\n+import org.apache.beam.sdk.PipelineResult;\n+import org.apache.beam.sdk.io.GenerateSequence;\n+import org.apache.beam.sdk.options.PipelineOptions;\n+import org.apache.beam.sdk.options.PipelineOptionsFactory;\n+import org.apache.flink.client.program.OptimizerPlanEnvironment;\n+import org.apache.flink.client.program.PackagedProgram;\n+import org.apache.flink.client.program.PackagedProgramUtils;\n+import org.apache.flink.client.program.ProgramInvocationException;\n+import org.apache.flink.configuration.Configuration;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/**\n+ * Test for {@link FlinkRunner}.\n+ *\n+ * <p>This test is copied to 1.10 is becauses the signature of the method getPipeline in\n+ * OptimizerPlanEnvironment has been changed in Flink 1.10, please refer to\n+ * https://github.com/apache/flink/commit/0ea4dd7e9d56a017743ca6794d28537800faab6f for more details.\n+ */\n+public class FlinkRunnerTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc1ODEyOA=="}, "originalCommit": {"oid": "28771436d428f66c44483791d04844a7e3e99351"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzE1MTAx", "url": "https://github.com/apache/beam/pull/12564#pullrequestreview-467715101", "createdAt": "2020-08-14T16:35:31Z", "commit": {"oid": "a090ca5531c56d948eb59c4bd727a289363cd6be"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNTozMVrOHA7NIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNTozMVrOHA7NIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczMjA2Nw==", "bodyText": "Maybe add a field for this instead of calling the getter every time?", "url": "https://github.com/apache/beam/pull/12564#discussion_r470732067", "createdAt": "2020-08-14T16:35:31Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -699,7 +699,7 @@ public final void processWatermark1(Watermark mark) throws Exception {\n \n     long inputWatermarkHold = applyInputWatermarkHold(getEffectiveInputWatermark());\n     if (keyCoder != null) {\n-      timeServiceManager.advanceWatermark(new Watermark(inputWatermarkHold));\n+      getTimeServiceManagerCompat().advanceWatermark(new Watermark(inputWatermarkHold));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a090ca5531c56d948eb59c4bd727a289363cd6be"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a090ca5531c56d948eb59c4bd727a289363cd6be", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/a090ca5531c56d948eb59c4bd727a289363cd6be", "committedDate": "2020-08-14T15:34:00Z", "message": "fix mini cluster RPC service port workaround"}, "afterCommit": {"oid": "3be2b32411513d9daf00acec208a37942a4d6c15", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/3be2b32411513d9daf00acec208a37942a4d6c15", "committedDate": "2020-08-14T17:03:14Z", "message": "[BEAM-10612] Add flink 1.11 runner\n\n- Fix deprecated OperatorStateStore.getOperatorState => getListState\n- Fix WindowedValue OutputTag in DoFnOperatorTest and ExecutableStageDoFnOperatorTest\n- Fix FlinkStreamingTransformTranslatorsTest\n- Fix SourceTransformation => LegacySourceTransformation rename\n- Fix timeServiceManager access change in AbstractStreamOperator\n- Fix RemoteMiniClusterImpl RPC service port work around\n- Abstract version specific env and PackagedProgram logic in FlinkRunnerTest\n- Suppress checkstyle false alarm on AbstractStreamOperatorCompat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5893ee4a81e195362ee5eefc34498a71d9b88600", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/5893ee4a81e195362ee5eefc34498a71d9b88600", "committedDate": "2020-08-14T17:18:23Z", "message": "[BEAM-10612] Add flink 1.11 runner\n\n- Fix deprecated OperatorStateStore.getOperatorState => getListState\n- Fix WindowedValue OutputTag in DoFnOperatorTest and ExecutableStageDoFnOperatorTest\n- Fix FlinkStreamingTransformTranslatorsTest\n- Fix SourceTransformation => LegacySourceTransformation rename\n- Fix timeServiceManager access change in AbstractStreamOperator\n- Fix RemoteMiniClusterImpl RPC service port work around\n- Abstract version specific env and PackagedProgram logic in FlinkRunnerTest\n- Suppress checkstyle false alarm on AbstractStreamOperatorCompat"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3be2b32411513d9daf00acec208a37942a4d6c15", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/3be2b32411513d9daf00acec208a37942a4d6c15", "committedDate": "2020-08-14T17:03:14Z", "message": "[BEAM-10612] Add flink 1.11 runner\n\n- Fix deprecated OperatorStateStore.getOperatorState => getListState\n- Fix WindowedValue OutputTag in DoFnOperatorTest and ExecutableStageDoFnOperatorTest\n- Fix FlinkStreamingTransformTranslatorsTest\n- Fix SourceTransformation => LegacySourceTransformation rename\n- Fix timeServiceManager access change in AbstractStreamOperator\n- Fix RemoteMiniClusterImpl RPC service port work around\n- Abstract version specific env and PackagedProgram logic in FlinkRunnerTest\n- Suppress checkstyle false alarm on AbstractStreamOperatorCompat"}, "afterCommit": {"oid": "5893ee4a81e195362ee5eefc34498a71d9b88600", "author": {"user": {"login": "nevillelyh", "name": "Neville Li"}}, "url": "https://github.com/apache/beam/commit/5893ee4a81e195362ee5eefc34498a71d9b88600", "committedDate": "2020-08-14T17:18:23Z", "message": "[BEAM-10612] Add flink 1.11 runner\n\n- Fix deprecated OperatorStateStore.getOperatorState => getListState\n- Fix WindowedValue OutputTag in DoFnOperatorTest and ExecutableStageDoFnOperatorTest\n- Fix FlinkStreamingTransformTranslatorsTest\n- Fix SourceTransformation => LegacySourceTransformation rename\n- Fix timeServiceManager access change in AbstractStreamOperator\n- Fix RemoteMiniClusterImpl RPC service port work around\n- Abstract version specific env and PackagedProgram logic in FlinkRunnerTest\n- Suppress checkstyle false alarm on AbstractStreamOperatorCompat"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3493, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}