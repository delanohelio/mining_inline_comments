{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDI4MDUy", "number": 11275, "title": "[BEAM-9648]: DirectRunner should return null on timeout", "bodyText": "According to PipelineResult if waitUntilFinish(Duration) is supported it should return null.\nPlease add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-03-31T15:52:01Z", "url": "https://github.com/apache/beam/pull/11275", "merged": true, "mergeCommit": {"oid": "c3bd4854e879da65060de8cd259865a9b34742c7"}, "closed": true, "closedAt": "2020-04-16T20:21:09Z", "author": {"login": "regadas"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTFHgXAH2gAyMzk2NDI4MDUyOmYzYjFiMDFlNGU4OTViMWE5ZGY1MWJiMDhlZTdiMzFlNzM4OGZlZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXRxN0gFqTM5MjI3MTA4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3b1b01e4e895b1a9df51bb08ee7b31e7388fee8", "author": {"user": {"login": "regadas", "name": "Filipe Regadas"}}, "url": "https://github.com/apache/beam/commit/f3b1b01e4e895b1a9df51bb08ee7b31e7388fee8", "committedDate": "2020-03-31T15:48:22Z", "message": "[BEAM-9648]: DirectRunner should return null on timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzIyNTUz", "url": "https://github.com/apache/beam/pull/11275#pullrequestreview-390322553", "createdAt": "2020-04-08T20:51:41Z", "commit": {"oid": "f3b1b01e4e895b1a9df51bb08ee7b31e7388fee8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1MTo0MVrOGDAgSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1MTo0MVrOGDAgSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNzE3Ng==", "bodyText": "This allows for a race condition where we exit the while loop above not due to a timeout but would turn it into a timeout here because of the timing.\nWe could clean-up the loop above so it only exits on timeout while all non-timeout returns happen within the loop with something like:\n    while (Instant.now().isBefore(completionTime)) {\n      // Get an update; don't block forever if another thread has handled it. The call to poll will\n      // wait the entire timeout; this call primarily exists to relinquish any core.\n      VisibleExecutorUpdate update = visibleUpdates.tryNext(Duration.millis(25L));\n      if (pipelineState.get().isTerminal() || (update != null && isTerminalStateUpdate(update))) {\n        // there are no updates to process and no updates will ever be published because the\n        // executor is shutdown OR there has been an update and the update is terminal\n        return pipelineState.get();\n      } else if (update != null && update.thrown.isPresent()) {\n        Throwable thrown = update.thrown.get();\n        if (thrown instanceof Exception) {\n          throw (Exception) thrown;\n        } else if (thrown instanceof Error) {\n          throw (Error) thrown;\n        } else {\n          throw new Exception(\"Unknown Type of Throwable\", thrown);\n        }\n      }\n    }\n    return null;", "url": "https://github.com/apache/beam/pull/11275#discussion_r405807176", "createdAt": "2020-04-08T20:51:41Z", "author": {"login": "lukecwik"}, "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/ExecutorServiceParallelExecutor.java", "diffHunk": "@@ -260,6 +260,11 @@ public State waitUntilFinish(Duration duration) throws Exception {\n         }\n       }\n     }\n+\n+    if (Instant.now().isAfter(completionTime)) {\n+      return null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3b1b01e4e895b1a9df51bb08ee7b31e7388fee8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21bb8ec6066cc92b34ffe25fa12c991f8bb92c9e", "author": {"user": {"login": "regadas", "name": "Filipe Regadas"}}, "url": "https://github.com/apache/beam/commit/21bb8ec6066cc92b34ffe25fa12c991f8bb92c9e", "committedDate": "2020-04-09T00:21:56Z", "message": "fixup! [BEAM-9648]: DirectRunner should return null on timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDE2OTYz", "url": "https://github.com/apache/beam/pull/11275#pullrequestreview-390416963", "createdAt": "2020-04-09T00:24:35Z", "commit": {"oid": "21bb8ec6066cc92b34ffe25fa12c991f8bb92c9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMDoyNDozNVrOGDFgHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMDoyNDozNVrOGDFgHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4OTA1Mg==", "bodyText": "@lukecwik also found out that this conditional would throw an NPE", "url": "https://github.com/apache/beam/pull/11275#discussion_r405889052", "createdAt": "2020-04-09T00:24:35Z", "author": {"login": "regadas"}, "path": "runners/direct-java/src/main/java/org/apache/beam/runners/direct/ExecutorServiceParallelExecutor.java", "diffHunk": "@@ -269,7 +277,7 @@ public State getPipelineState() {\n   }\n \n   private boolean isTerminalStateUpdate(VisibleExecutorUpdate update) {\n-    return !(update.getNewState() == null && update.getNewState().isTerminal());\n+    return update.getNewState() != null && update.getNewState().isTerminal();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21bb8ec6066cc92b34ffe25fa12c991f8bb92c9e"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjcxMDg1", "url": "https://github.com/apache/beam/pull/11275#pullrequestreview-392271085", "createdAt": "2020-04-13T16:48:29Z", "commit": {"oid": "21bb8ec6066cc92b34ffe25fa12c991f8bb92c9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4835, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}