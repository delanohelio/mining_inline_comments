{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NDE0NDQ0", "number": 12241, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjo1OTo1MVrOEOWOBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMzo0NFrOEOWTnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDc5NTU3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/common.py", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjo1OTo1MVrOGxcxyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzo0NDoxMFrOGxecBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA==", "bodyText": "Are you trying to deep-copy current_windowed_value, threadsafe_restriction_tracker  and threadsafe_watermark_estimator ? If so, we need to do it explicitly copy.deepcopy.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454504904", "createdAt": "2020-07-14T16:59:51Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxMDMxMA==", "bodyText": "I think I misunderstood the logic here, deep-copy is incorrect. So within the lock, why do we need to keep a local reference?", "url": "https://github.com/apache/beam/pull/12241#discussion_r454510310", "createdAt": "2020-07-14T17:08:54Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxODU3MQ==", "bodyText": "The purpose of the lock is to get a consistent point in time copy of the references to the current objects.\nWe don't need a deep copy. Splitting will fail if the restriction becomes finished and the main processing loop moves onto the next element.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454518571", "createdAt": "2020-07-14T17:22:33Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyNTYwOQ==", "bodyText": "Any reason that local references are need here, even within the lock?", "url": "https://github.com/apache/beam/pull/12241#discussion_r454525609", "createdAt": "2020-07-14T17:33:46Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUzMjEwMA==", "bodyText": "The lock ends before the if since the if indentation level is not at the same level as with lock statement.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454532100", "createdAt": "2020-07-14T17:44:10Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDgwMDc2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/common.py", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMTowNlrOGxc05g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzo0NToyMFrOGxefCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTcwMg==", "bodyText": "Would it be better to both check threadsafe_restriction_tracker  and threadsafe_watermark_estimator for easy reading?", "url": "https://github.com/apache/beam/pull/12241#discussion_r454505702", "createdAt": "2020-07-14T17:01:06Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value\n+      threadsafe_restriction_tracker = self.threadsafe_restriction_tracker\n+      threadsafe_watermark_estimator = self.threadsafe_watermark_estimator\n+\n+    if threadsafe_restriction_tracker:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxODU1Mw==", "bodyText": "There is an assumption that if one is set then the other is set. Similarly, if one is unset then the other is unset.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454518553", "createdAt": "2020-07-14T17:22:31Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value\n+      threadsafe_restriction_tracker = self.threadsafe_restriction_tracker\n+      threadsafe_watermark_estimator = self.threadsafe_watermark_estimator\n+\n+    if threadsafe_restriction_tracker:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTcwMg=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUyODU5Ng==", "bodyText": "I would add a comment above to state the assumption. But it's minor though.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454528596", "createdAt": "2020-07-14T17:38:32Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value\n+      threadsafe_restriction_tracker = self.threadsafe_restriction_tracker\n+      threadsafe_watermark_estimator = self.threadsafe_watermark_estimator\n+\n+    if threadsafe_restriction_tracker:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTcwMg=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUzMjg3NQ==", "bodyText": "I have a much larger rewrite here to support per window invocation where this will become a non-issue so I'll pass on this since we will need to hold the lock for the entire split call.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454532875", "createdAt": "2020-07-14T17:45:20Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value\n+      threadsafe_restriction_tracker = self.threadsafe_restriction_tracker\n+      threadsafe_watermark_estimator = self.threadsafe_watermark_estimator\n+\n+    if threadsafe_restriction_tracker:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTcwMg=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDgwOTkxOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/runners/common.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMzo0NFrOGxc6wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzoyMjo0NFrOGxdnvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNzIwMA==", "bodyText": "If we are deep copying objects, it seems like we can use the lock to guard the copying logic only, instead of the entire split logic.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454507200", "createdAt": "2020-07-14T17:03:44Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxODcxNw==", "bodyText": "Not deep copying objects.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454518717", "createdAt": "2020-07-14T17:22:44Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNzIwMA=="}, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1037, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}