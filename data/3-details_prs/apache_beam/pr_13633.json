{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NjY0NjAw", "number": 13633, "title": "[BEAM-9541] Use a single source of truth for latest Flink version in Gradle tasks.", "bodyText": "This PR only changes Gradle files (tests and examples). I will make separate PRs for other usages, such as Jenkins test configs, Python, release scripts, the website, and miscellaneous comments.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-12-29T22:53:59Z", "url": "https://github.com/apache/beam/pull/13633", "merged": true, "mergeCommit": {"oid": "9b85af031a9f439dc68132932cc7df76fc11ccce"}, "closed": true, "closedAt": "2021-01-05T22:54:32Z", "author": {"login": "ibzib"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdrCuiMgH2gAyNTQ2NjY0NjAwOmYxMjBlYjdhZGQ1YmI4NWViMTYxNzgzYzJkMzkxNTY0MDRiZGFhOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtROZGAH2gAyNTQ2NjY0NjAwOmUxMmEwZDg0YjJjZDBmYzU2MWU4OTc5NmNlZGJjZTE0MWIzYjQzNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f120eb7add5bb85eb161783c2d39156404bdaa96", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/f120eb7add5bb85eb161783c2d39156404bdaa96", "committedDate": "2020-12-29T22:46:37Z", "message": "[BEAM-9541] Add flink_versions to gradle.properties."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eacb40ee9591b8133b6017eb72b37702a2b9417", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/7eacb40ee9591b8133b6017eb72b37702a2b9417", "committedDate": "2020-12-29T23:23:21Z", "message": "[BEAM-9541] All Gradle tasks use latest Flink version."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b7b24ba91d10767a35ddac508a26e0e02afcb90", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/3b7b24ba91d10767a35ddac508a26e0e02afcb90", "committedDate": "2020-12-29T23:20:34Z", "message": "Apply spotless Groovy to release scripts.\n\nSpotless was not enforced previously since release/build.gradle did not use the Beam module plugin."}, "afterCommit": {"oid": "7eacb40ee9591b8133b6017eb72b37702a2b9417", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/7eacb40ee9591b8133b6017eb72b37702a2b9417", "committedDate": "2020-12-29T23:23:21Z", "message": "[BEAM-9541] All Gradle tasks use latest Flink version."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/08706dfd17cc25733042f1ad2aa6bde3b818dfa1", "committedDate": "2020-12-31T01:22:20Z", "message": "Disable Flink classloader leak check when using local execution mode.\n\nOtherwise the check will throw an error when the expansion service is called after the local cluster runs a job."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTE1NDQ3", "url": "https://github.com/apache/beam/pull/13633#pullrequestreview-560915447", "createdAt": "2021-01-04T10:16:43Z", "commit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMDoxNjo0M1rOINsKxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMDoxNjo0M1rOINsKxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyNjA1NQ==", "bodyText": "Just for pure curiosity, why is this needed?", "url": "https://github.com/apache/beam/pull/13633#discussion_r551226055", "createdAt": "2021-01-04T10:16:43Z", "author": {"login": "iemejia"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -375,4 +377,10 @@ private static void setManagedMemoryByFraction(final Configuration config) {\n       config.setString(\"taskmanager.memory.managed.size\", String.valueOf(managedMemorySize));\n     }\n   }\n+\n+  private static void disableClassLoaderLeakCheck(final Configuration config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTIzMTkz", "url": "https://github.com/apache/beam/pull/13633#pullrequestreview-560923193", "createdAt": "2021-01-04T10:28:15Z", "commit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMDoyODoxNlrOINsi7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMDozMDoyNlrOINsnfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIzMjIzNg==", "bodyText": "I believe this is because of GRPC which may attempt to load classes after the Flink job has been removed. Loading new classes on closed classloaders will error without this setting.", "url": "https://github.com/apache/beam/pull/13633#discussion_r551232236", "createdAt": "2021-01-04T10:28:16Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -375,4 +377,10 @@ private static void setManagedMemoryByFraction(final Configuration config) {\n       config.setString(\"taskmanager.memory.managed.size\", String.valueOf(managedMemorySize));\n     }\n   }\n+\n+  private static void disableClassLoaderLeakCheck(final Configuration config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyNjA1NQ=="}, "originalCommit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIzMzEyMw==", "bodyText": "Personal preference but I find this easier to read:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (version == flink_minor_version) {\n          \n          \n            \n                  break\n          \n          \n            \n                }\n          \n          \n            \n                mustRunAfter(\":runners:flink:${version}:test\")\n          \n          \n            \n                if (version != flink_minor_version) {\n          \n          \n            \n                  mustRunAfter(\":runners:flink:${version}:test\")\n          \n          \n            \n                }", "url": "https://github.com/apache/beam/pull/13633#discussion_r551233123", "createdAt": "2021-01-04T10:29:58Z", "author": {"login": "mxm"}, "path": "runners/flink/flink_runner.gradle", "diffHunk": "@@ -108,17 +108,14 @@ test {\n   if (System.getProperty(\"beamSurefireArgline\")) {\n     jvmArgs System.getProperty(\"beamSurefireArgline\")\n   }\n-  // TODO Running tests of all Flink versions in parallel can be too harsh on Jenkins memory\n-  // Run them serially for now, to avoid \"Exit code 137\", i.e. Jenkins host killing the Gradle test process\n-  if (project.path == \":runners:flink:1.9\") {\n-    mustRunAfter(\":runners:flink:1.8:test\")\n-  } else if (project.path == \":runners:flink:1.10\") {\n-    mustRunAfter(\":runners:flink:1.8:test\")\n-    mustRunAfter(\":runners:flink:1.9:test\")\n-  } else if (project.path == \":runners:flink:1.11\") {\n-    mustRunAfter(\":runners:flink:1.8:test\")\n-    mustRunAfter(\":runners:flink:1.9:test\")\n-    mustRunAfter(\":runners:flink:1.10:test\")\n+  // TODO(BEAM-6418) Running tests of all Flink versions in parallel can be too harsh on Jenkins memory.\n+  // Run them serially for now, to avoid \"Exit code 137\", i.e. Jenkins host killing the Gradle test process.\n+  def flink_minor_version = project.path.split(':').last()\n+  for (version in project.ext.allFlinkVersions) {\n+    if (version == flink_minor_version) {\n+      break\n+    }\n+    mustRunAfter(\":runners:flink:${version}:test\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIzMzQwNA==", "bodyText": "In any case, we should add a note or JIRA ticket to why this is necessary.", "url": "https://github.com/apache/beam/pull/13633#discussion_r551233404", "createdAt": "2021-01-04T10:30:26Z", "author": {"login": "mxm"}, "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkExecutionEnvironments.java", "diffHunk": "@@ -375,4 +377,10 @@ private static void setManagedMemoryByFraction(final Configuration config) {\n       config.setString(\"taskmanager.memory.managed.size\", String.valueOf(managedMemorySize));\n     }\n   }\n+\n+  private static void disableClassLoaderLeakCheck(final Configuration config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyNjA1NQ=="}, "originalCommit": {"oid": "08706dfd17cc25733042f1ad2aa6bde3b818dfa1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e12a0d84b2cd0fc561e89796cedbce141b3b4359", "author": {"user": {"login": "ibzib", "name": "Kyle Weaver"}}, "url": "https://github.com/apache/beam/commit/e12a0d84b2cd0fc561e89796cedbce141b3b4359", "committedDate": "2021-01-05T20:47:56Z", "message": "[BEAM-11570] Comment with link to context."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4286, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}