{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5ODc1MDgz", "number": 12883, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQxNzo0MDo1OVrOElcVAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjo0Njo0NFrOEnh7Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3Njk2ODk2OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/metrics/metric.py", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQxNzo0MDo1OVrOHU74Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMDoxMzoyM1rOHbeSyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDYzOA==", "bodyText": "can't override a method", "url": "https://github.com/apache/beam/pull/12883#discussion_r491714638", "createdAt": "2020-09-20T17:40:59Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -101,23 +121,26 @@ def gauge(namespace, name):\n   class DelegatingCounter(Counter):\n     \"\"\"Metrics Counter that Delegates functionality to MetricsEnvironment.\"\"\"\n     def __init__(self, metric_name):\n+      # type: (MetricName) -> None\n       super(Metrics.DelegatingCounter, self).__init__()\n       self.metric_name = metric_name\n-      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)\n+      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)  # type: ignore[assignment]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwOTQ4NA==", "bodyText": "Is it not possible to override the behaviour by assigning self.inc to something else in the subclass?\nNot saying I am a fan of this pattern or anything. But I think its still possible to override it that way\n(Though I don't think it should be addressed in this PR)", "url": "https://github.com/apache/beam/pull/12883#discussion_r495109484", "createdAt": "2020-09-25T16:45:11Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -101,23 +121,26 @@ def gauge(namespace, name):\n   class DelegatingCounter(Counter):\n     \"\"\"Metrics Counter that Delegates functionality to MetricsEnvironment.\"\"\"\n     def __init__(self, metric_name):\n+      # type: (MetricName) -> None\n       super(Metrics.DelegatingCounter, self).__init__()\n       self.metric_name = metric_name\n-      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)\n+      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)  # type: ignore[assignment]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDYzOA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxNzE0MQ==", "bodyText": "Here's the workaround:\n  class DelegatingCounter(Counter):\n    \"\"\"Metrics Counter that Delegates functionality to MetricsEnvironment.\"\"\"\n    def __init__(self, metric_name):\n      # type: (MetricName) -> None\n      super(Metrics.DelegatingCounter, self).__init__(metric_name)\n      self._inc = MetricUpdater(cells.CounterCell, metric_name, default=1)\n\n    def inc(value=None):\n      self._inc(value)\nI don't know the reasoning behind this limitation.  Even the simplest scenario fails on the latest version of mypy:\nclass Foo(object):\n  x = None  # type: Callable[[], None]\n\ndef blah():\n  # type: () -> None\n  pass\n\nclass Bar(Foo):\n  def __init__(self):\n    # type: () -> None\n    self.x = blah\nNote that it does work without complaint if the callable is defined on the class:\nclass Bar(Foo):\n   x = blah\nbut we can't do that because MetricUpdater needs the metric_name.\nSo, since what's being done in this metrics code is valid python, I thought ignoring the error was the most expedient path.  If mypy fixes this in a future version, these lines will generate an \"unused type ignore\" error and we can get rid of them.", "url": "https://github.com/apache/beam/pull/12883#discussion_r495317141", "createdAt": "2020-09-25T23:31:29Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -101,23 +121,26 @@ def gauge(namespace, name):\n   class DelegatingCounter(Counter):\n     \"\"\"Metrics Counter that Delegates functionality to MetricsEnvironment.\"\"\"\n     def __init__(self, metric_name):\n+      # type: (MetricName) -> None\n       super(Metrics.DelegatingCounter, self).__init__()\n       self.metric_name = metric_name\n-      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)\n+      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)  # type: ignore[assignment]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDYzOA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU2OTkyOA==", "bodyText": "Yes, please go ahead and ignore this error. (Note also that this code is structured in this way for performance reasons; previously we had pipelines where the bulk of the CPU was spent in generic counter update code, whereas here MetricUpdater is as fast as possible for incrementing an int).", "url": "https://github.com/apache/beam/pull/12883#discussion_r498569928", "createdAt": "2020-10-02T00:13:23Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/metrics/metric.py", "diffHunk": "@@ -101,23 +121,26 @@ def gauge(namespace, name):\n   class DelegatingCounter(Counter):\n     \"\"\"Metrics Counter that Delegates functionality to MetricsEnvironment.\"\"\"\n     def __init__(self, metric_name):\n+      # type: (MetricName) -> None\n       super(Metrics.DelegatingCounter, self).__init__()\n       self.metric_name = metric_name\n-      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)\n+      self.inc = MetricUpdater(cells.CounterCell, metric_name, default=1)  # type: ignore[assignment]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDYzOA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3Njk2OTk3OnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/metrics/metricbase.py", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQxNzo0MjoxMlrOHU74zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMDoxODozMFrOHYY9EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDc2NA==", "bodyText": "there seems to be an assumption that this attribute exists.  should we give this class an __init__ that takes a metric_name argument?", "url": "https://github.com/apache/beam/pull/12883#discussion_r491714764", "createdAt": "2020-09-20T17:42:12Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -78,7 +80,7 @@ def __hash__(self):\n \n class Metric(object):\n   \"\"\"Base interface of a metric object.\"\"\"\n-  pass\n+  metric_name = None  # type: MetricName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4NDM4OQ==", "bodyText": "I think it exists due to some double inheritance. @ajamato what is the best solution here?", "url": "https://github.com/apache/beam/pull/12883#discussion_r494684389", "createdAt": "2020-09-25T00:38:27Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -78,7 +80,7 @@ def __hash__(self):\n \n class Metric(object):\n   \"\"\"Base interface of a metric object.\"\"\"\n-  pass\n+  metric_name = None  # type: MetricName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDc2NA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMDA3NQ==", "bodyText": "Its not due to multiple inheritance, its just self.metric_name is simply not set in the base Metric class, but only in the DelegatingCounter, DelegatingDistribution and DelegatingGauge class. (Which have an init which takes a metric_name and assigns it to self). The rest of the code in the repo is assuming self.metric_name is set, as they only deal with the subclasses.\nI recommend adding init with a metric_name parameter to Metric and its subclasses (Counter, Distribution and Gauge). This already exists on DelegatingX classes, but could be done in the base Metric init instead.\nAlso,\nIf it were up to me we would remove Counter, Distribution and Gauge classes and just have the DelegatingCounter DelegatingDistribution and DelegatingGauge classes.\nThough, I am unsure if some external implementation to the beam repo uses those classes (Counter, Distribution and Gauge).", "url": "https://github.com/apache/beam/pull/12883#discussion_r495120075", "createdAt": "2020-09-25T17:04:57Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -78,7 +80,7 @@ def __hash__(self):\n \n class Metric(object):\n   \"\"\"Base interface of a metric object.\"\"\"\n-  pass\n+  metric_name = None  # type: MetricName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDc2NA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxODYzNg==", "bodyText": "I recommend adding init with a metric_name parameter to Metric and its subclasses (Counter, Distribution and Gauge). This already exists on DelegatingX classes, but could be done in the base Metric init instead.\n\nAdding metric_name to Metric.__init__ definitely seems like the best solution to me, so I did that.\n\nIf it were up to me we would remove Counter, Distribution and Gauge classes and just have the DelegatingCounter DelegatingDistribution and DelegatingGauge classes.\n\nLeaving this for a future task.", "url": "https://github.com/apache/beam/pull/12883#discussion_r495318636", "createdAt": "2020-09-25T23:34:57Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -78,7 +80,7 @@ def __hash__(self):\n \n class Metric(object):\n   \"\"\"Base interface of a metric object.\"\"\"\n-  pass\n+  metric_name = None  # type: MetricName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDc2NA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMzNjcyMQ==", "bodyText": "Sounds good. I wouldn't want to scope\u00a0creep that into your PR. Definitely\u00a0for another day :).", "url": "https://github.com/apache/beam/pull/12883#discussion_r495336721", "createdAt": "2020-09-26T00:18:30Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/metricbase.py", "diffHunk": "@@ -78,7 +80,7 @@ def __hash__(self):\n \n class Metric(object):\n   \"\"\"Base interface of a metric object.\"\"\"\n-  pass\n+  metric_name = None  # type: MetricName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTcxNDc2NA=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODg1NzYyOnYy", "diffSide": "RIGHT", "path": "sdks/python/apache_beam/metrics/cells.py", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjo0Njo0NFrOHYLIyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMzozMTo0N1rOHYXxBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExMDM0Nw==", "bodyText": "I don't really undersand the reason for the conditional import. Whether or not TYPE_CHECKING is enabled, this file still depends on MetricName", "url": "https://github.com/apache/beam/pull/12883#discussion_r495110347", "createdAt": "2020-09-25T16:46:44Z", "author": {"login": "ajamato"}, "path": "sdks/python/apache_beam/metrics/cells.py", "diffHunk": "@@ -29,8 +29,12 @@\n import threading\n import time\n from builtins import object\n+from typing import TYPE_CHECKING\n from typing import Optional\n \n+if TYPE_CHECKING:\n+  from apache_beam.metrics.metricbase import MetricName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMxNzI1Mg==", "bodyText": "leftover cruft. fixed", "url": "https://github.com/apache/beam/pull/12883#discussion_r495317252", "createdAt": "2020-09-25T23:31:47Z", "author": {"login": "chadrik"}, "path": "sdks/python/apache_beam/metrics/cells.py", "diffHunk": "@@ -29,8 +29,12 @@\n import threading\n import time\n from builtins import object\n+from typing import TYPE_CHECKING\n from typing import Optional\n \n+if TYPE_CHECKING:\n+  from apache_beam.metrics.metricbase import MetricName", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExMDM0Nw=="}, "originalCommit": {"oid": "a7ca8527b4a19e05ac5fde7cdd2a2d1a74c85f17"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3175, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}