{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMzM5Mjc5", "number": 10529, "title": "[BEAM-9044] Protobuf options to Schema options", "bodyText": "[BEAM-9044] Protobuf options to Schema options\nConvert protobuf options to Row schema options. It gets the options from a proto message descriptor and converts them into beam schema options on the Schema. It does the same from proto field descriptors, converting them into beam field options.\nThe converter creates typed options as the proto options are also fully typed. For the convertion it uses the ProtoDynamicSchema to resolve the types.\n\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-01-08T08:32:21Z", "url": "https://github.com/apache/beam/pull/10529", "merged": true, "mergeCommit": {"oid": "06a120cd1cd35a0f31f8a5e62c6169105c7a4e93"}, "closed": true, "closedAt": "2020-04-03T11:39:35Z", "author": {"login": "alexvanboxel"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5BClAABqjI5MzkwNzA1NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT_UezABqjMxOTYwMjM1MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9843670877028a58597689d69d4d2f88ed68c61", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/d9843670877028a58597689d69d4d2f88ed68c61", "committedDate": "2020-01-08T08:22:42Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "7a2dbac139163ec689c97cc337a0fd5ce921bd08", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/7a2dbac139163ec689c97cc337a0fd5ce921bd08", "committedDate": "2020-01-10T16:18:12Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a2dbac139163ec689c97cc337a0fd5ce921bd08", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/7a2dbac139163ec689c97cc337a0fd5ce921bd08", "committedDate": "2020-01-10T16:18:12Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "4eb8f25e1f0909b23dc97222605635cc1d412a38", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/4eb8f25e1f0909b23dc97222605635cc1d412a38", "committedDate": "2020-01-13T21:21:41Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4eb8f25e1f0909b23dc97222605635cc1d412a38", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/4eb8f25e1f0909b23dc97222605635cc1d412a38", "committedDate": "2020-01-13T21:21:41Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "c6578d0f3f916db0b277f966666424a66c29232c", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/c6578d0f3f916db0b277f966666424a66c29232c", "committedDate": "2020-02-13T10:00:43Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6578d0f3f916db0b277f966666424a66c29232c", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/c6578d0f3f916db0b277f966666424a66c29232c", "committedDate": "2020-02-13T10:00:43Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "7aa174e2c0735f202934cfcd71ffc3ffcf6ea478", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/7aa174e2c0735f202934cfcd71ffc3ffcf6ea478", "committedDate": "2020-02-26T10:37:48Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7aa174e2c0735f202934cfcd71ffc3ffcf6ea478", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/7aa174e2c0735f202934cfcd71ffc3ffcf6ea478", "committedDate": "2020-02-26T10:37:48Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "ccc7eb1fb23d41f34c77f6f587df588926d7b95b", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/ccc7eb1fb23d41f34c77f6f587df588926d7b95b", "committedDate": "2020-02-29T10:36:07Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccc7eb1fb23d41f34c77f6f587df588926d7b95b", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/ccc7eb1fb23d41f34c77f6f587df588926d7b95b", "committedDate": "2020-02-29T10:36:07Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "31da15fb17006f353265c86afbfe9b28b51ec3b3", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/31da15fb17006f353265c86afbfe9b28b51ec3b3", "committedDate": "2020-03-19T09:04:26Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31da15fb17006f353265c86afbfe9b28b51ec3b3", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/31da15fb17006f353265c86afbfe9b28b51ec3b3", "committedDate": "2020-03-19T09:04:26Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}, "afterCommit": {"oid": "d5f3bf34fc4d84ff4d004805214e48d9d171add7", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/d5f3bf34fc4d84ff4d004805214e48d9d171add7", "committedDate": "2020-03-19T10:51:43Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTgxOTI2", "url": "https://github.com/apache/beam/pull/10529#pullrequestreview-379181926", "createdAt": "2020-03-23T07:30:21Z", "commit": {"oid": "d5f3bf34fc4d84ff4d004805214e48d9d171add7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNzozMDoyMVrOF55X8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNzozMTo1N1rOF55abQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1MzE2OA==", "bodyText": "We want to switch this metadata to use options. However you are translating proto option names directly to field names, which means there's no guarantee that these other options won't conflict. Maybe prefix all of these options with something to prevent potential conflict?", "url": "https://github.com/apache/beam/pull/10529#discussion_r396253168", "createdAt": "2020-03-23T07:30:21Z", "author": {"login": "reuvenlax"}, "path": "sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java", "diffHunk": "@@ -205,10 +205,12 @@ static Schema getSchema(Descriptors.Descriptor descriptor) {\n         // Store proto field number in metadata.\n         FieldType fieldType =\n             withMetaData(beamFieldTypeFromProtoField(fieldDescriptor), fieldDescriptor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5f3bf34fc4d84ff4d004805214e48d9d171add7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1MzgwNQ==", "bodyText": "As mentioned above, I think we should add a well-known prefix here.", "url": "https://github.com/apache/beam/pull/10529#discussion_r396253805", "createdAt": "2020-03-23T07:31:57Z", "author": {"login": "reuvenlax"}, "path": "sdks/java/extensions/protobuf/src/main/java/org/apache/beam/sdk/extensions/protobuf/ProtoSchemaTranslator.java", "diffHunk": "@@ -352,4 +354,49 @@ private static FieldType beamFieldTypeFromSingularProtoField(\n     }\n     return fieldType;\n   }\n+\n+  private static Schema.Options getFieldOptions(FieldDescriptor fieldDescriptor) {\n+    return getOptions(fieldDescriptor.getOptions().getAllFields());\n+  }\n+\n+  private static Schema.Options getSchemaOptions(Descriptors.Descriptor descriptor) {\n+    return getOptions(descriptor.getOptions().getAllFields());\n+  }\n+\n+  private static Schema.Options getOptions(Map<FieldDescriptor, Object> allFields) {\n+    Schema.Options.Builder optionsBuilder = Schema.Options.builder();\n+    for (Map.Entry<FieldDescriptor, Object> entry : allFields.entrySet()) {\n+      FieldDescriptor fieldDescriptor = entry.getKey();\n+      FieldType fieldType = beamFieldTypeFromProtoField(fieldDescriptor);\n+\n+      switch (fieldType.getTypeName()) {\n+        case BYTE:\n+        case BYTES:\n+        case INT16:\n+        case INT32:\n+        case INT64:\n+        case DECIMAL:\n+        case FLOAT:\n+        case DOUBLE:\n+        case STRING:\n+        case BOOLEAN:\n+        case LOGICAL_TYPE:\n+        case ROW:\n+        case ARRAY:\n+        case ITERABLE:\n+          Field field = Field.of(\"OPTION\", fieldType);\n+          ProtoDynamicMessageSchema schema = ProtoDynamicMessageSchema.forSchema(Schema.of(field));\n+          optionsBuilder.setOption(\n+              fieldDescriptor.getFullName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5f3bf34fc4d84ff4d004805214e48d9d171add7"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5860c486fae06c762cd4bf2a8b845f8c139cc5c5", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/5860c486fae06c762cd4bf2a8b845f8c139cc5c5", "committedDate": "2020-03-25T09:54:19Z", "message": "Fixup: Add URN prefix to options."}, "afterCommit": {"oid": "496d77a94acc05a4895e6c976a452d1cd6cb93f9", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/496d77a94acc05a4895e6c976a452d1cd6cb93f9", "committedDate": "2020-03-26T07:46:57Z", "message": "Fixup: Add URN prefix to options."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "496d77a94acc05a4895e6c976a452d1cd6cb93f9", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/496d77a94acc05a4895e6c976a452d1cd6cb93f9", "committedDate": "2020-03-26T07:46:57Z", "message": "Fixup: Add URN prefix to options."}, "afterCommit": {"oid": "f7185f63b139747719f1c240c1c5326b9637dde8", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/f7185f63b139747719f1c240c1c5326b9637dde8", "committedDate": "2020-03-27T12:41:08Z", "message": "Fixup: Add URN prefix to options."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e741380c7924d50a48e813ae992d2c3c722a8342", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/e741380c7924d50a48e813ae992d2c3c722a8342", "committedDate": "2020-04-03T11:35:51Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7d7492c826f20c78bb7de40e0a21d74aadabce1", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/a7d7492c826f20c78bb7de40e0a21d74aadabce1", "committedDate": "2020-03-28T12:57:31Z", "message": "[BEAM-9604] Remove use of metadata in Protobuf schema"}, "afterCommit": {"oid": "e741380c7924d50a48e813ae992d2c3c722a8342", "author": {"user": {"login": "alexvanboxel", "name": "Alex Van Boxel"}}, "url": "https://github.com/apache/beam/commit/e741380c7924d50a48e813ae992d2c3c722a8342", "committedDate": "2020-04-03T11:35:51Z", "message": "[BEAM-9044] Protobuf options to Schema options\n\nConvert protobuf options to Row schema options. It gets the options\nfrom a proto message descriptor and converts them into beam schema\noptions on the Schema. It does the same from proto field descriptors,\nconverting them into beam field options.\n\nThe converter creates typed options as the proto options are also\nfully typed. For the convertion it uses the ProtoDynamicSchema\nto resolve the types."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3664, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}