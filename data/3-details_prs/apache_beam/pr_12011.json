{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NTIxMTI5", "number": 12011, "title": "[BEAM-9269] Set Spanner commit deadline using GRPC api not interceptor.", "bodyText": "Spanner client library 1.21+ allow setting deadlines via the SpannerOptions object. Use this instead of the somewhat hacky method of an RPC interceptor.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-06-15T12:53:52Z", "url": "https://github.com/apache/beam/pull/12011", "merged": true, "mergeCommit": {"oid": "4cd23649bd2bf721c320372e13b4284327374730"}, "closed": true, "closedAt": "2020-06-25T15:37:59Z", "author": {"login": "nielm"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr8wZ4AFqTQzMTkyODI4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuraF8gBqjM0ODE1NTAxODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTI4Mjg3", "url": "https://github.com/apache/beam/pull/12011#pullrequestreview-431928287", "createdAt": "2020-06-16T22:11:47Z", "commit": {"oid": "add706f14ce4d9ab164896b32e8827048a21eeb6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMjoxMTo0OFrOGku9DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMjoxMTo0OFrOGku9DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE3MTIxMg==", "bodyText": "This patch sounds good. But i have a question.  RetrySettings seems to support retry with backoff. The following retry mechanism could be moved to here as well.\nhttps://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java#L1485\nCan that be done? Not as part of this patch. I could send out a PR as well after testing. That would clean up some code in SpannerIO as well", "url": "https://github.com/apache/beam/pull/12011#discussion_r441171212", "createdAt": "2020-06-16T22:11:48Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerAccessor.java", "diffHunk": "@@ -63,23 +65,19 @@ static SpannerAccessor create(SpannerConfig spannerConfig) {\n     ValueProvider<Duration> commitDeadline = spannerConfig.getCommitDeadline();\n     if (commitDeadline != null && commitDeadline.get().getMillis() > 0) {\n \n-      // In Spanner API version 1.21 or above, we can set the deadline / total Timeout on an API\n-      // call using the following code:\n-      //\n-      // UnaryCallSettings.Builder commitSettings =\n-      // builder.getSpannerStubSettingsBuilder().commitSettings();\n-      // RetrySettings.Builder commitRetrySettings = commitSettings.getRetrySettings().toBuilder()\n-      // commitSettings.setRetrySettings(\n-      //     commitRetrySettings.setTotalTimeout(\n-      //         Duration.ofMillis(getCommitDeadlineMillis().get()))\n-      //     .build());\n-      //\n-      // However, at time of this commit, the Spanner API is at only at v1.6.0, where the only\n-      // method to set a deadline is with GRPC Interceptors, so we have to use that...\n-      SpannerInterceptorProvider interceptorProvider =\n-          SpannerInterceptorProvider.createDefault()\n-              .with(new CommitDeadlineSettingInterceptor(commitDeadline.get()));\n-      builder.setInterceptorProvider(interceptorProvider);\n+      // Set the GRPC deadline on the Commit API call.\n+      UnaryCallSettings.Builder commitSettings =\n+          builder.getSpannerStubSettingsBuilder().commitSettings();\n+      RetrySettings.Builder commitRetrySettings = commitSettings.getRetrySettings().toBuilder();\n+      commitSettings.setRetrySettings(\n+          commitRetrySettings", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add706f14ce4d9ab164896b32e8827048a21eeb6"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjQ5MDQ2", "url": "https://github.com/apache/beam/pull/12011#pullrequestreview-436249046", "createdAt": "2020-06-24T00:37:04Z", "commit": {"oid": "add706f14ce4d9ab164896b32e8827048a21eeb6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjQ5MTU0", "url": "https://github.com/apache/beam/pull/12011#pullrequestreview-436249154", "createdAt": "2020-06-24T00:37:25Z", "commit": {"oid": "add706f14ce4d9ab164896b32e8827048a21eeb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "add706f14ce4d9ab164896b32e8827048a21eeb6", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/add706f14ce4d9ab164896b32e8827048a21eeb6", "committedDate": "2020-06-15T12:50:48Z", "message": "Set Spanner commit deadline using GRPC api not interceptor.\n\nSpanner client library 1.20+ allow setting deadlines via the\nSpannerOptions object. Use this instead of an RPC interceptor."}, "afterCommit": {"oid": "76c215cacc15ba57e7e7b79ad3a2750444a04140", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/76c215cacc15ba57e7e7b79ad3a2750444a04140", "committedDate": "2020-06-24T17:37:39Z", "message": "Set Spanner commit deadline using GRPC api not interceptor.\n\nSpanner client library 1.20+ allow setting deadlines via the\nSpannerOptions object. Use this instead of an RPC interceptor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2d9f233dd429330b5640a813bfa5d3f997d39a", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cc2d9f233dd429330b5640a813bfa5d3f997d39a", "committedDate": "2020-06-25T09:27:51Z", "message": "Set Spanner commit deadline using GRPC api not interceptor.\n\nSpanner client library 1.20+ allow setting deadlines via the\nSpannerOptions object. Use this instead of an RPC interceptor."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c215cacc15ba57e7e7b79ad3a2750444a04140", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/76c215cacc15ba57e7e7b79ad3a2750444a04140", "committedDate": "2020-06-24T17:37:39Z", "message": "Set Spanner commit deadline using GRPC api not interceptor.\n\nSpanner client library 1.20+ allow setting deadlines via the\nSpannerOptions object. Use this instead of an RPC interceptor."}, "afterCommit": {"oid": "cc2d9f233dd429330b5640a813bfa5d3f997d39a", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cc2d9f233dd429330b5640a813bfa5d3f997d39a", "committedDate": "2020-06-25T09:27:51Z", "message": "Set Spanner commit deadline using GRPC api not interceptor.\n\nSpanner client library 1.20+ allow setting deadlines via the\nSpannerOptions object. Use this instead of an RPC interceptor."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3450, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}