{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjQzNjY0", "number": 13117, "title": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies", "bodyText": "License script was not pulling source for license names that were spelled out. LGPL/MPL worked, but \"GNU Lesser Public License\" and \"Mozzilla Public License\" were not matched.\nThis uncovered an issue with module names with upper case characters; fixed by not forcing lower case.\nAdded logging.\nR: @emilymye\nR: @Hannah-Jiang\nR: @robinyqiu\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-14T21:02:37Z", "url": "https://github.com/apache/beam/pull/13117", "merged": true, "mergeCommit": {"oid": "f1ee42a8c3f2439f7e02e5544681d977f9803f12"}, "closed": true, "closedAt": "2020-10-15T20:18:47Z", "author": {"login": "alanmyrvold"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSkCbBAFqTUwODc0NzQ1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS1GBUgBqjM4ODI3MzI1ODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzQ3NDU4", "url": "https://github.com/apache/beam/pull/13117#pullrequestreview-508747458", "createdAt": "2020-10-14T21:21:14Z", "commit": {"oid": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMToyMToxNFrOHhlfHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMToyNTowMFrOHhll8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3OTIzMQ==", "bodyText": "Do all source jars follow this pattern?", "url": "https://github.com/apache/beam/pull/13117#discussion_r504979231", "createdAt": "2020-10-14T21:21:14Z", "author": {"login": "Hannah-Jiang"}, "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -101,13 +101,22 @@ def pull_from_url(file_name, url, dep, no_list):\n \n def pull_source_code(base_url, dir_name, dep):\n     # base_url example: https://repo1.maven.org/maven2/org/mortbay/jetty/jsp-2.1/6.1.14/\n-    soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    try:\n+      soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    except:\n+      logging.error('Error reading source base from {base_url}'.format(base_url=base_url))\n+      raise\n+    source_count = 0\n     for href in (a[\"href\"] for a in soup.select(\"a[href]\")):\n         if href.endswith(\n-                '.jar') and not 'javadoc' in href:  # download jar file only\n+                '.jar') and 'sources.jar' in href:  # download sources jar file only", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MDk3OA==", "bodyText": "How about changing the level to debug? If there are many packages need to pull source, there would be a lot of log printed out.", "url": "https://github.com/apache/beam/pull/13117#discussion_r504980978", "createdAt": "2020-10-14T21:25:00Z", "author": {"login": "Hannah-Jiang"}, "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -101,13 +101,22 @@ def pull_from_url(file_name, url, dep, no_list):\n \n def pull_source_code(base_url, dir_name, dep):\n     # base_url example: https://repo1.maven.org/maven2/org/mortbay/jetty/jsp-2.1/6.1.14/\n-    soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    try:\n+      soup = BeautifulSoup(urlopen(base_url).read(), \"html.parser\")\n+    except:\n+      logging.error('Error reading source base from {base_url}'.format(base_url=base_url))\n+      raise\n+    source_count = 0\n     for href in (a[\"href\"] for a in soup.select(\"a[href]\")):\n         if href.endswith(\n-                '.jar') and not 'javadoc' in href:  # download jar file only\n+                '.jar') and 'sources.jar' in href:  # download sources jar file only\n             file_name = dir_name + '/' + href\n             url = base_url + '/' + href\n+            logging.info('Pulling source from {url}'.format(url=url))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODU0ODA3", "url": "https://github.com/apache/beam/pull/13117#pullrequestreview-508854807", "createdAt": "2020-10-15T00:15:16Z", "commit": {"oid": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDoxNToxNlrOHhsXmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDoxNToxNlrOHhsXmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5MTk5Mw==", "bodyText": "Do we only skip self-dependencies for non-auto-pulled libraries? Mostly this function seems very long and complicated to start with, and having the skipping returns at the top would make me feel a little better.", "url": "https://github.com/apache/beam/pull/13117#discussion_r505091993", "createdAt": "2020-10-15T00:15:16Z", "author": {"login": "emilymye"}, "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -140,17 +149,22 @@ def execute(dep):\n     }\n     '''\n \n-    name = dep['moduleName'].split(':')[1].lower()\n+    name = dep['moduleName'].split(':')[1]\n     version = dep['moduleVersion']\n     name_version = name + '-' + version\n+    # javac is not a runtime dependency\n+    if name == 'javac':\n+      logging.debug('Skipping', name_version)\n+      return\n     dir_name = '{license_dir}/{name_version}.jar'.format(\n         license_dir=license_dir, name_version=name_version)\n \n     # if auto pulled, directory is existing at {license_dir}\n     if not os.path.isdir(dir_name):\n         # skip self dependencies\n         if dep['moduleName'].startswith('beam'):\n-            logging.debug('Skippig', name_version)\n+            logging.debug('Skipping', name_version)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e38d9df43ffe961c3ef8b31cce60db5e3a6d28d5"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "050258b080da846b7dde6289242ee195ddb89a6e", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/050258b080da846b7dde6289242ee195ddb89a6e", "committedDate": "2020-10-15T16:31:50Z", "message": "Updates from review"}, "afterCommit": {"oid": "1db7b6e3282826fc047ecc9c2542cae65401ccb1", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/1db7b6e3282826fc047ecc9c2542cae65401ccb1", "committedDate": "2020-10-15T16:35:56Z", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d0f9b1b8be70033814ef804889e52f273462b65", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/8d0f9b1b8be70033814ef804889e52f273462b65", "committedDate": "2020-10-15T16:55:39Z", "message": "Change exclusion to use name"}, "afterCommit": {"oid": "d4255e07ecb843c1e4ecb7987ed81c95b480f00a", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/d4255e07ecb843c1e4ecb7987ed81c95b480f00a", "committedDate": "2020-10-15T16:57:26Z", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTkzMDEx", "url": "https://github.com/apache/beam/pull/13117#pullrequestreview-509593011", "createdAt": "2020-10-15T17:06:30Z", "commit": {"oid": "8d0f9b1b8be70033814ef804889e52f273462b65"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzowNjo1M1rOHiRrfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzowNjo1M1rOHiRrfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwMzI5Mg==", "bodyText": "If I compare to the original code, it should be dep['moduleName'] instead of name. If a beam package is 'beam:xxx' and the xxx does not has beam in it, it wouldn't skipped. And I also recommend applying lower() when checking if startswith 'beam'.", "url": "https://github.com/apache/beam/pull/13117#discussion_r505703292", "createdAt": "2020-10-15T17:06:53Z", "author": {"login": "Hannah-Jiang"}, "path": "sdks/java/container/license_scripts/pull_licenses_java.py", "diffHunk": "@@ -140,17 +149,22 @@ def execute(dep):\n     }\n     '''\n \n-    name = dep['moduleName'].split(':')[1].lower()\n+    name = dep['moduleName'].split(':')[1]\n     version = dep['moduleVersion']\n     name_version = name + '-' + version\n+    # javac is not a runtime dependency\n+    if name == 'javac':\n+      logging.debug('Skipping', name_version)\n+      return\n+    # skip self dependencies\n+    if name.startswith('beam'):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4255e07ecb843c1e4ecb7987ed81c95b480f00a"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "committedDate": "2020-10-15T17:19:01Z", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc041aa6ff7000167d3523600c2bb05b79a4b9c8", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/fc041aa6ff7000167d3523600c2bb05b79a4b9c8", "committedDate": "2020-10-15T17:17:15Z", "message": "revert name change"}, "afterCommit": {"oid": "098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "author": {"user": {"login": "alanmyrvold", "name": "Alan Myrvold"}}, "url": "https://github.com/apache/beam/commit/098a36ac45f7b8d8b7cbca247f86cd272cb0e6f4", "committedDate": "2020-10-15T17:19:01Z", "message": "[BEAM-11067] Update java license script to include source for GNU and Mozilla dependencies"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}