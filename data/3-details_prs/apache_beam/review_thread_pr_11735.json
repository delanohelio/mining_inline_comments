{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MDI4MzY3", "number": 11735, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMjowMToyM1rOD9HlMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMjowMToyM1rOD9HlMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NDEzOTM5OnYy", "diffSide": "RIGHT", "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/Read.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMjowMToyM1rOGWc4ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQyMjowMToyM1rOGWc4ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5NTA1MA==", "bodyText": "This is the key part of the change here, moving watermarkEstimator.setWatermark out of the while loop.", "url": "https://github.com/apache/beam/pull/11735#discussion_r426195050", "createdAt": "2020-05-16T22:01:23Z", "author": {"login": "lukecwik"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/io/Read.java", "diffHunk": "@@ -487,51 +493,54 @@ public void splitRestriction(\n \n     @NewTracker\n     public RestrictionTracker<\n-            KV<UnboundedSource<OutputT, CheckpointT>, CheckpointT>, UnboundedSourceValue<OutputT>[]>\n+            UnboundedSourceRestriction<OutputT, CheckpointT>, UnboundedSourceValue<OutputT>[]>\n         restrictionTracker(\n-            @Restriction KV<UnboundedSource<OutputT, CheckpointT>, CheckpointT> restriction,\n+            @Restriction UnboundedSourceRestriction<OutputT, CheckpointT> restriction,\n             PipelineOptions pipelineOptions) {\n       return new UnboundedSourceAsSDFRestrictionTracker(restriction, pipelineOptions);\n     }\n \n     @ProcessElement\n     public ProcessContinuation processElement(\n-        RestrictionTracker<\n-                KV<UnboundedSource<OutputT, CheckpointT>, CheckpointT>, UnboundedSourceValue[]>\n+        RestrictionTracker<UnboundedSourceRestriction<OutputT, CheckpointT>, UnboundedSourceValue[]>\n             tracker,\n         ManualWatermarkEstimator<Instant> watermarkEstimator,\n         OutputReceiver<ValueWithRecordId<OutputT>> receiver,\n         BundleFinalizer bundleFinalizer)\n         throws IOException {\n-      KV<UnboundedSource<OutputT, CheckpointT>, CheckpointT> initialRestriction =\n+      UnboundedSourceRestriction<OutputT, CheckpointT> initialRestriction =\n           tracker.currentRestriction();\n \n       UnboundedSourceValue<OutputT>[] out = new UnboundedSourceValue[1];\n       while (tracker.tryClaim(out)) {\n         receiver.outputWithTimestamp(\n             new ValueWithRecordId<>(out[0].getValue(), out[0].getId()), out[0].getTimestamp());\n-        watermarkEstimator.setWatermark(ensureTimestampWithinBounds(out[0].getWatermark()));\n       }\n \n+      UnboundedSourceRestriction<OutputT, CheckpointT> currentRestriction =\n+          tracker.currentRestriction();\n+\n+      // Advance the watermark even if zero elements may have been output.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b153252b6612cd57c8be7d20a736ec9ea48879d"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3788, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}