{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMzQyOTk0", "number": 13221, "title": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index", "bodyText": "is used for the state namespace.\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\nAnother way to accomplish this would be to change the TriggerStateMachine\nprefetch methods to take a TriggerContext instead of a raw state accessor.\nThis would allow for TriggerStateMachine to get the correct state for\nsubtriggers.  That seems more inline with how the nonprefetch methods work\nhowever that is a public interface change.\nPlease add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-29T15:05:06Z", "url": "https://github.com/apache/beam/pull/13221", "merged": true, "mergeCommit": {"oid": "9dba074daa0f2538d75bc33f2d6e1cae9eb2f7f0"}, "closed": true, "closedAt": "2020-11-03T19:13:49Z", "author": {"login": "scwhittle"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXTqnLABqjM5MzY4NjgzMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY-HMDgFqTUyMjc5ODc3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fd63bb118e3a6a1faa83ac39c4454d0c153f4dd", "author": {"user": {"login": "scwhittle", "name": null}}, "url": "https://github.com/apache/beam/commit/8fd63bb118e3a6a1faa83ac39c4454d0c153f4dd", "committedDate": "2020-10-29T14:45:43Z", "message": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index\nis used for the state namespace.\n\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\n\nAnother way to accomplish this would be to change the TriggerStateMachine\nprefetch methods to take a TriggerContext instead of a raw state accessor.\nThis would allow for TriggerStateMachine to get the correct state for\nsubtriggers.  That seems more inline with how the nonprefetch methods work\nhowever that is a public interface change."}, "afterCommit": {"oid": "33d8068cb773947bb4ace84e853d2aa2ead70904", "author": {"user": {"login": "scwhittle", "name": null}}, "url": "https://github.com/apache/beam/commit/33d8068cb773947bb4ace84e853d2aa2ead70904", "committedDate": "2020-10-29T15:11:56Z", "message": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index\nis used for the state namespace.\n\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\n\nAnother way to accomplish this would be to change the TriggerStateMachine\nprefetch methods to take a TriggerContext instead of a raw state accessor.\nThis would allow for TriggerStateMachine to get the correct state for\nsubtriggers.  That seems more inline with how the nonprefetch methods work\nhowever that is a public interface change."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTM5Nzg1", "url": "https://github.com/apache/beam/pull/13221#pullrequestreview-521939785", "createdAt": "2020-11-02T19:41:35Z", "commit": {"oid": "33d8068cb773947bb4ace84e853d2aa2ead70904"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e093b5f5203caa1b754ec19e5341fb3a13d2cb7", "author": {"user": {"login": "scwhittle", "name": null}}, "url": "https://github.com/apache/beam/commit/8e093b5f5203caa1b754ec19e5341fb3a13d2cb7", "committedDate": "2020-11-03T11:09:25Z", "message": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index\nis used for the state namespace.\n\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\n\nThe prefetch methods are made abstract on TriggerStateMachine and changed\nto take a PrefetchContext which has enough information to fetch the correct\nstate namespaces for subtriggers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33d8068cb773947bb4ace84e853d2aa2ead70904", "author": {"user": {"login": "scwhittle", "name": null}}, "url": "https://github.com/apache/beam/commit/33d8068cb773947bb4ace84e853d2aa2ead70904", "committedDate": "2020-10-29T15:11:56Z", "message": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index\nis used for the state namespace.\n\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\n\nAnother way to accomplish this would be to change the TriggerStateMachine\nprefetch methods to take a TriggerContext instead of a raw state accessor.\nThis would allow for TriggerStateMachine to get the correct state for\nsubtriggers.  That seems more inline with how the nonprefetch methods work\nhowever that is a public interface change."}, "afterCommit": {"oid": "8e093b5f5203caa1b754ec19e5341fb3a13d2cb7", "author": {"user": {"login": "scwhittle", "name": null}}, "url": "https://github.com/apache/beam/commit/8e093b5f5203caa1b754ec19e5341fb3a13d2cb7", "committedDate": "2020-11-03T11:09:25Z", "message": "[BEAM-11144] Fix trigger prefetching so that the correct trigger index\nis used for the state namespace.\n\nPreviously prefetching was fetching non-existent state, possibly adding\nunnecessary fetches as well as neglecting to prefetch actual state used.\n\nThe prefetch methods are made abstract on TriggerStateMachine and changed\nto take a PrefetchContext which has enough information to fetch the correct\nstate namespaces for subtriggers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzk4Nzcx", "url": "https://github.com/apache/beam/pull/13221#pullrequestreview-522798771", "createdAt": "2020-11-03T19:08:54Z", "commit": {"oid": "8e093b5f5203caa1b754ec19e5341fb3a13d2cb7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxOTowODo1NFrOHs8wrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxOToxMjowN1rOHs84LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NDg5Mg==", "bodyText": "This was one of the cases where I was thinking it only made sense to prefetch the active subtrigger. Of course, I was missing the whole point that you can't know which one that is until you do a fetch. So maybe my whole idea was foolish.", "url": "https://github.com/apache/beam/pull/13221#discussion_r516894892", "createdAt": "2020-11-03T19:08:54Z", "author": {"login": "kennknowles"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/triggers/AfterEachStateMachine.java", "diffHunk": "@@ -48,6 +48,13 @@ private AfterEachStateMachine(List<TriggerStateMachine> subTriggers) {\n     checkArgument(subTriggers.size() > 1);\n   }\n \n+  @Override\n+  public void prefetchOnElement(PrefetchContext c) {\n+    for (ExecutableTriggerStateMachine subTrigger : c.trigger().subTriggers()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e093b5f5203caa1b754ec19e5341fb3a13d2cb7"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NjgxMw==", "bodyText": "This was the other one. Same problem with my thinking.", "url": "https://github.com/apache/beam/pull/13221#discussion_r516896813", "createdAt": "2020-11-03T19:12:07Z", "author": {"login": "kennknowles"}, "path": "runners/core-java/src/main/java/org/apache/beam/runners/core/triggers/AfterWatermarkStateMachine.java", "diffHunk": "@@ -91,6 +91,13 @@ public AfterWatermarkEarlyAndLate withLateFirings(TriggerStateMachine lateTrigge\n       return new AfterWatermarkEarlyAndLate(earlyTrigger, lateTrigger);\n     }\n \n+    @Override\n+    public void prefetchOnElement(PrefetchContext c) {\n+      for (ExecutableTriggerStateMachine subTrigger : c.trigger().subTriggers()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e093b5f5203caa1b754ec19e5341fb3a13d2cb7"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1810, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}