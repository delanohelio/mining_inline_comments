{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4ODM1ODMy", "number": 10492, "title": "[BEAM-9041, BEAM-9042] SchemaCoder equals should not rely on from/toRowFunction equality", "bodyText": "This PR fixes both issues because (1) one fix depends on the other, and (2) to make it easier to validate/cherry pick into 2.18.0's branch.\nBEAM-9041: Don't rely on equality for the from/to functions in SchemaCoder because nobody implements equals on SerializableFunction. I tried to do this with byte equality, maybe there is a better way to do it but I could not think of another.\nBEAM-9042: Since Avro's Schema class is not Serializable I made it transient. Another approach could have been to transform the Schema into a String (not sure if this is needed but I can change it if you think it is worth).\nR: @TheNeuralBit", "createdAt": "2020-01-03T00:11:15Z", "url": "https://github.com/apache/beam/pull/10492", "merged": true, "mergeCommit": {"oid": "8aba30f8c77c0a563d375452185732f73e870f0d"}, "closed": true, "closedAt": "2020-01-08T00:17:06Z", "author": {"login": "iemejia"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3xORXAFqTMzODgzNTQ3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4IBSUABqjI5MjkxODczNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODM1NDc1", "url": "https://github.com/apache/beam/pull/10492#pullrequestreview-338835475", "createdAt": "2020-01-06T19:11:27Z", "commit": {"oid": "5d5b015ba09cc967256dddbc6f6624b25606cd7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOToxMToyOFrOFamghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOToxMToyOFrOFamghA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQzODIxMg==", "bodyText": "Couldn't you just implement equals here instead of changing to comparing byte equality of the serialized function in SchemaCoder?", "url": "https://github.com/apache/beam/pull/10492#discussion_r363438212", "createdAt": "2020-01-06T19:11:28Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/schemas/utils/AvroUtils.java", "diffHunk": "@@ -431,7 +431,20 @@ public static GenericRecord toGenericRecord(\n    */\n   public static SerializableFunction<Row, GenericRecord> getRowToGenericRecordFunction(\n       @Nullable org.apache.avro.Schema avroSchema) {\n-    return g -> toGenericRecord(g, avroSchema);\n+    return new RowToGenericRecordFn(avroSchema);\n+  }\n+\n+  private static class RowToGenericRecordFn implements SerializableFunction<Row, GenericRecord> {\n+    private final transient org.apache.avro.Schema avroSchema;\n+\n+    RowToGenericRecordFn(@Nullable org.apache.avro.Schema avroSchema) {\n+      this.avroSchema = avroSchema;\n+    }\n+\n+    @Override\n+    public GenericRecord apply(Row input) {\n+      return toGenericRecord(input, avroSchema);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5b015ba09cc967256dddbc6f6624b25606cd7e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d5b015ba09cc967256dddbc6f6624b25606cd7e", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/5d5b015ba09cc967256dddbc6f6624b25606cd7e", "committedDate": "2020-01-02T23:59:58Z", "message": "[BEAM-9042] Fix RowToGenericRecordFn to avoid AvroSchema serialization capture"}, "afterCommit": {"oid": "dfa7d69e9f7902941deb95c113b08420b35ff081", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/dfa7d69e9f7902941deb95c113b08420b35ff081", "committedDate": "2020-01-07T17:02:36Z", "message": "[BEAM-9042] Fix RowToGenericRecordFn Avro schema serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDU1Mzg3", "url": "https://github.com/apache/beam/pull/10492#pullrequestreview-339455387", "createdAt": "2020-01-07T19:28:46Z", "commit": {"oid": "cf76be77f225d68df623813cd440621cdb197cb8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOToyODo0NlrOFbDbEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOToyODo0NlrOFbDbEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkxMTk1NQ==", "bodyText": "\ud83d\udc4d thanks!", "url": "https://github.com/apache/beam/pull/10492#discussion_r363911955", "createdAt": "2020-01-07T19:28:46Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/schemas/SchemaCoder.java", "diffHunk": "@@ -102,7 +102,8 @@ protected SchemaCoder(\n \n   /**\n    * Returns a {@link SchemaCoder} for the specified class. If no schema is registered for this\n-   * class, then throws {@link NoSuchSchemaException}.\n+   * class, then throws {@link NoSuchSchemaException}. The parameter functions to convert from and\n+   * to Rows <b>must</b> implement the equals contract.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf76be77f225d68df623813cd440621cdb197cb8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDYxNjkx", "url": "https://github.com/apache/beam/pull/10492#pullrequestreview-339461691", "createdAt": "2020-01-07T19:39:48Z", "commit": {"oid": "cf76be77f225d68df623813cd440621cdb197cb8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOTozOTo0OFrOFbDtRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOTozOTo0OFrOFbDtRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkxNjYxMg==", "bodyText": "I'm not 100% sure but it looks like the failures are occurring when avroSchema is null. Either way I think you need to check if avroSchemaAsString is null here.", "url": "https://github.com/apache/beam/pull/10492#discussion_r363916612", "createdAt": "2020-01-07T19:39:48Z", "author": {"login": "TheNeuralBit"}, "path": "sdks/java/core/src/main/java/org/apache/beam/sdk/schemas/utils/AvroUtils.java", "diffHunk": "@@ -431,7 +465,47 @@ public static GenericRecord toGenericRecord(\n    */\n   public static SerializableFunction<Row, GenericRecord> getRowToGenericRecordFunction(\n       @Nullable org.apache.avro.Schema avroSchema) {\n-    return g -> toGenericRecord(g, avroSchema);\n+    return new RowToGenericRecordFn(avroSchema);\n+  }\n+\n+  private static class RowToGenericRecordFn implements SerializableFunction<Row, GenericRecord> {\n+    private transient org.apache.avro.Schema avroSchema;\n+\n+    RowToGenericRecordFn(@Nullable org.apache.avro.Schema avroSchema) {\n+      this.avroSchema = avroSchema;\n+    }\n+\n+    @Override\n+    public GenericRecord apply(Row input) {\n+      return toGenericRecord(input, avroSchema);\n+    }\n+\n+    @Override\n+    public boolean equals(Object other) {\n+      if (this == other) {\n+        return true;\n+      }\n+      if (other == null || getClass() != other.getClass()) {\n+        return false;\n+      }\n+      RowToGenericRecordFn that = (RowToGenericRecordFn) other;\n+      return avroSchema.equals(that.avroSchema);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(avroSchema);\n+    }\n+\n+    private void writeObject(ObjectOutputStream out) throws IOException {\n+      final String avroSchemaAsString = (avroSchema == null) ? null : avroSchema.toString();\n+      out.writeObject(avroSchemaAsString);\n+    }\n+\n+    private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException {\n+      final String avroSchemaAsString = (String) in.readObject();\n+      avroSchema = new org.apache.avro.Schema.Parser().parse(avroSchemaAsString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf76be77f225d68df623813cd440621cdb197cb8"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e4490cca2b902f719839a42a1ff482fb11c2444", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/3e4490cca2b902f719839a42a1ff482fb11c2444", "committedDate": "2020-01-07T21:51:07Z", "message": "[BEAM-9041] Add missing equals methods for GenericRecord <-> Row conversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e63b5af96ae3ad903dabf1ace2629b85766757c", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/0e63b5af96ae3ad903dabf1ace2629b85766757c", "committedDate": "2020-01-07T21:51:07Z", "message": "[BEAM-9042] Fix RowToGenericRecordFn Avro schema serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71de81f7d47bf4c93601d5216b2efadb7ce6aaee", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/71de81f7d47bf4c93601d5216b2efadb7ce6aaee", "committedDate": "2020-01-07T21:51:07Z", "message": "[BEAM-9042] Update SchemaCoder doc with info about functions requiring equals"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe17671fb3da74a8880ef9c4f204f2a099a401a2", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/fe17671fb3da74a8880ef9c4f204f2a099a401a2", "committedDate": "2020-01-07T21:51:26Z", "message": "[BEAM-9042] Test serializability and equality of Row<->GenericRecord functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf76be77f225d68df623813cd440621cdb197cb8", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/cf76be77f225d68df623813cd440621cdb197cb8", "committedDate": "2020-01-07T17:09:36Z", "message": "[BEAM-9042] Update SchemaCoder doc with info about functions requiring equals"}, "afterCommit": {"oid": "fe17671fb3da74a8880ef9c4f204f2a099a401a2", "author": {"user": {"login": "iemejia", "name": "Isma\u00ebl Mej\u00eda"}}, "url": "https://github.com/apache/beam/commit/fe17671fb3da74a8880ef9c4f204f2a099a401a2", "committedDate": "2020-01-07T21:51:26Z", "message": "[BEAM-9042] Test serializability and equality of Row<->GenericRecord functions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3875, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}