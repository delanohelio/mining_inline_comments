{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NjAxNzk1", "number": 12995, "title": "[BEAM-2914] Add portable merging window support to Python.", "bodyText": "This adds support to the Python SDK and the Python ULR.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-10-01T23:34:35Z", "url": "https://github.com/apache/beam/pull/12995", "merged": true, "mergeCommit": {"oid": "625ee1f6e27636f26672e973ecbcecf19a8cb361"}, "closed": true, "closedAt": "2021-02-11T08:05:17Z", "author": {"login": "robertwb"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOaDgOAH2gAyNDk2NjAxNzk1OjhiY2E1ZDc5MDkxODk1Y2RmODBlZjEwZjIzYWQyODE4ZmM3MzliMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd4Plr6AH2gAyNDk2NjAxNzk1OjhjMTA3NTY4ZjVlMjFmMTNjOTQ3YmJiZmNlZGJlZmRlZWQ2ZjM3NmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bca5d79091895cdf80ef10f23ad2818fc739b33", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8bca5d79091895cdf80ef10f23ad2818fc739b33", "committedDate": "2020-10-01T23:33:32Z", "message": "[BEAM-2914] Add portable merging window support to Python."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23dc93d72863032d9f6e12a9299c7272f4425f4a", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/23dc93d72863032d9f6e12a9299c7272f4425f4a", "committedDate": "2020-10-02T23:39:30Z", "message": "yapf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6afead40fe3350c3bd69d80e1c71abd9dfe28f94", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/6afead40fe3350c3bd69d80e1c71abd9dfe28f94", "committedDate": "2020-10-03T00:30:55Z", "message": "Skip flink, grpc fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c95a28b2b8c89801dbe9e6cd1af83aa8c2e3c62", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8c95a28b2b8c89801dbe9e6cd1af83aa8c2e3c62", "committedDate": "2020-10-03T01:05:17Z", "message": "yapf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "745b86b77dd73470461854079de41db84b7433cb", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/745b86b77dd73470461854079de41db84b7433cb", "committedDate": "2020-10-03T01:08:14Z", "message": "Merge branch 'master' into custom-window-merging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a24450d8a6d01f4afee2a4eea988173151cc75", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/d8a24450d8a6d01f4afee2a4eea988173151cc75", "committedDate": "2020-10-06T18:41:39Z", "message": "Merge branch 'master' into custom-window-merging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e647cfe6d3c1bf4e289e60074f14b5ebd0dbb151", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/e647cfe6d3c1bf4e289e60074f14b5ebd0dbb151", "committedDate": "2020-10-06T18:44:13Z", "message": "fix merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb748ef37e12e35722fb0e449931e9af833d006", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/3eb748ef37e12e35722fb0e449931e9af833d006", "committedDate": "2020-10-06T18:48:01Z", "message": "merge fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af2665ff9e7241dd49cf351b1753ecd61e5786e", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8af2665ff9e7241dd49cf351b1753ecd61e5786e", "committedDate": "2020-10-12T16:53:48Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/37986fe315fa8abc719a86eb1ba763157d3368d6", "committedDate": "2020-10-13T00:31:47Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDcxNTY1", "url": "https://github.com/apache/beam/pull/12995#pullrequestreview-563071565", "createdAt": "2021-01-06T22:08:18Z", "commit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMjowODoxOVrOIPXn5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMjowODoxOVrOIPXn5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk4NjU5Nw==", "bodyText": "self._worker_handler -> self._worker_handle?", "url": "https://github.com/apache/beam/pull/12995#discussion_r552986597", "createdAt": "2021-01-06T22:08:19Z", "author": {"login": "y1chi"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/execution.py", "diffHunk": "@@ -298,6 +301,198 @@ def from_runner_api_parameter(window_coder_id, context):\n         context.coders[window_coder_id.decode('utf-8')])\n \n \n+class GenericMergingWindowFn(window.WindowFn):\n+\n+  URN = 'internal-generic-merging'\n+\n+  TO_SDK_TRANSFORM = 'read'\n+  FROM_SDK_TRANSFORM = 'write'\n+\n+  _HANDLES = {}\n+\n+  def __init__(self, execution_context, windowing_strategy_proto):\n+    self._worker_handle = None\n+    self._handle_id = handle_id = uuid.uuid4().hex\n+    self._HANDLES[handle_id] = self\n+    # ExecutionContexts are expensive, we don't want to keep them in the\n+    # static dictionary forever.  Instead we hold a weakref and pop self\n+    # out of the dict once this context goes away.\n+    self._execution_context_ref = weakref.ref(\n+        execution_context, lambda _: self._HANDLES.pop(handle_id, None))\n+    self._windowing_strategy_proto = windowing_strategy_proto\n+    self._process_bundle_descriptor = None\n+    self._counter = 0\n+\n+  def payload(self):\n+    return self._handle_id.encode('utf-8')\n+\n+  @staticmethod\n+  @window.urns.RunnerApiFn.register_urn(URN, bytes)\n+  def from_runner_api_parameter(handle_id, unused_context):\n+    return GenericMergingWindowFn._HANDLES[handle_id.decode('utf-8')]\n+\n+  def assign(self, assign_context):\n+    raise NotImplementedError()\n+\n+  def merge(self, merge_context):\n+    worker_handler = self.worker_handle()\n+\n+    process_bundle_id = self.uid('process')\n+    to_worker = worker_handler.data_conn.output_stream(\n+        process_bundle_id, self.TO_SDK_TRANSFORM)\n+    to_worker.write(\n+        self.windowed_input_coder_impl.encode_nested(\n+            window.GlobalWindows.windowed_value((b'', merge_context.windows))))\n+    to_worker.close()\n+\n+    process_bundle_req = beam_fn_api_pb2.InstructionRequest(\n+        instruction_id=process_bundle_id,\n+        process_bundle=beam_fn_api_pb2.ProcessBundleRequest(\n+            process_bundle_descriptor_id=self._bundle_processor_id))\n+    result_future = worker_handler.control_conn.push(process_bundle_req)\n+    for output in worker_handler.data_conn.input_elements(\n+        process_bundle_id, [self.FROM_SDK_TRANSFORM],\n+        abort_callback=lambda:\n+        (result_future.is_done() and result_future.get().error)):\n+      if isinstance(output, beam_fn_api_pb2.Elements.Data):\n+        windowed_result = self.windowed_output_coder_impl.decode_nested(\n+            output.data)\n+        for merge_result, originals in windowed_result.value[1][1]:\n+          merge_context.merge(originals, merge_result)\n+      else:\n+        raise RuntimeError(\"Unexpected data: %s\" % output)\n+\n+    result = result_future.get()\n+    if result.error:\n+      raise RuntimeError(result.error)\n+    # The result was \"returned\" via the merge callbacks on merge_context above.\n+\n+  def get_window_coder(self):\n+    return self._execution_context_ref().pipeline_context.coders[\n+        self._windowing_strategy_proto.window_coder_id]\n+\n+  def worker_handle(self):\n+    if self._worker_handle is None:\n+      worker_handler_manager = self._execution_context_ref(\n+      ).worker_handler_manager\n+      self._worker_handler = worker_handler_manager.get_worker_handlers(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1ODkyMTQ0", "url": "https://github.com/apache/beam/pull/12995#pullrequestreview-585892144", "createdAt": "2021-02-08T20:25:37Z", "commit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1ODkyNjQ1", "url": "https://github.com/apache/beam/pull/12995#pullrequestreview-585892645", "createdAt": "2021-02-08T20:26:19Z", "commit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQyMDoyNjoxOVrOIh1U3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQyMDoyNjoxOVrOIh1U3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM0NzYxNQ==", "bodyText": "we may need to add this to spark_runner_test.py as well.", "url": "https://github.com/apache/beam/pull/12995#discussion_r572347615", "createdAt": "2021-02-08T20:26:19Z", "author": {"login": "y1chi"}, "path": "sdks/python/apache_beam/runners/portability/flink_runner_test.py", "diffHunk": "@@ -400,6 +400,9 @@ def test_callbacks_with_exception(self):\n   def test_register_finalizations(self):\n     raise unittest.SkipTest(\"BEAM-6868\")\n \n+  def test_custom_merging_window(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37986fe315fa8abc719a86eb1ba763157d3368d6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be5c2975382e69c540dd78ee4d646e40532cd5d4", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/be5c2975382e69c540dd78ee4d646e40532cd5d4", "committedDate": "2021-02-08T21:34:54Z", "message": "Address reviewer comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d29890ef16c2d247bbde2976a16a9dc00f5252a", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/2d29890ef16c2d247bbde2976a16a9dc00f5252a", "committedDate": "2021-02-08T21:58:30Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9978c432405fbe5dfcf2d93bb7620a8f815cd6a1", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/9978c432405fbe5dfcf2d93bb7620a8f815cd6a1", "committedDate": "2021-02-08T22:30:40Z", "message": "mypy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c107568f5e21f13c947bbbfcedbefdeed6f376b", "author": {"user": {"login": "robertwb", "name": "Robert Bradshaw"}}, "url": "https://github.com/apache/beam/commit/8c107568f5e21f13c947bbbfcedbefdeed6f376b", "committedDate": "2021-02-08T23:06:44Z", "message": "yapf"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2243, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}