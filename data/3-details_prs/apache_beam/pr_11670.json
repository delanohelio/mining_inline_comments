{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzkwMTQ5", "number": 11670, "title": "[BEAM-9001, BEAM-6327] Ensure that all transforms (except for required runner implemented transforms) have an environment id.", "bodyText": "Thank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-05-11T22:54:08Z", "url": "https://github.com/apache/beam/pull/11670", "merged": true, "mergeCommit": {"oid": "a5b2046b10bebc59c5bde41d4cb6498058fdada2"}, "closed": true, "closedAt": "2020-05-13T22:45:17Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgXxSxgH2gAyNDE2MzkwMTQ5OjNmYmJiOWU5OWUxN2NiMTFhZWVhZjc3OTU2YWFhYzA3ZmVlMTdmZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchAyBMgFqTQxMTM0ODQzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fbbb9e99e17cb11aeeaf77956aaac07fee17fdf", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/3fbbb9e99e17cb11aeeaf77956aaac07fee17fdf", "committedDate": "2020-05-11T22:53:19Z", "message": "[BEAM-9001, BEAM-6327] Ensure that all transforms (except for required runner implemented transforms) have an environment id."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTk4NjEz", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-409598613", "createdAt": "2020-05-11T23:26:13Z", "commit": {"oid": "3fbbb9e99e17cb11aeeaf77956aaac07fee17fdf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/58a470914dd88617962b65138d6d88fa897075bf", "committedDate": "2020-05-12T04:03:06Z", "message": "fixup! Fix native transform expander to not reinsert deleted transforms."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzE2ODg5", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-410316889", "createdAt": "2020-05-12T18:34:21Z", "commit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozNDoyMVrOGUTynw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozNDoyMVrOGUTynw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0ODk1OQ==", "bodyText": "What does \"Trivial\" mean here? Are there \"Native\" transforms that are not \"Trivial\"?", "url": "https://github.com/apache/beam/pull/11670#discussion_r423948959", "createdAt": "2020-05-12T18:34:21Z", "author": {"login": "ibzib"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/graph/TrivialNativeTransformExpander.java", "diffHunk": "@@ -23,47 +23,51 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-// TODO(BEAM-6327): Remove the need for this.\n-\n-/** PipelineTrimmer removes subcomponents of native transforms that shouldn't be fused. */\n-public class PipelineTrimmer {\n-  private static final Logger LOG = LoggerFactory.getLogger(PipelineTrimmer.class);\n+/**\n+ * TrivialNativeTransformExpander is used to replace transforms with known URNs with their native", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDI4Mjc4", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-410428278", "createdAt": "2020-05-12T21:15:58Z", "commit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMToxNTo1OFrOGUZQVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMToxNTo1OFrOGUZQVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzODQ4Nw==", "bodyText": "This should be native as well, right ?", "url": "https://github.com/apache/beam/pull/11670#discussion_r424038487", "createdAt": "2020-05-12T21:15:58Z", "author": {"login": "chamikaramj"}, "path": "sdks/go/pkg/beam/core/runtime/graphx/translate.go", "diffHunk": "@@ -375,6 +375,7 @@ func (m *marshaller) addMultiEdge(edge NamedEdge) []string {\n \t\tpayload := &pipepb.WindowIntoPayload{\n \t\t\tWindowFn: makeWindowFn(edge.Edge.WindowFn),\n \t\t}\n+\t\ttransformEnvID = m.addDefaultEnv()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDgyMTQ0", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-411082144", "createdAt": "2020-05-13T16:09:57Z", "commit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjowOTo1OFrOGU5ESg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjoxNzo1MFrOGU5ZDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1OTY5MA==", "bodyText": "Probably we should expand the comment here to describe why this is needed.", "url": "https://github.com/apache/beam/pull/11670#discussion_r424559690", "createdAt": "2020-05-13T16:09:58Z", "author": {"login": "chamikaramj"}, "path": "runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/graph/TrivialNativeTransformExpander.java", "diffHunk": "@@ -23,47 +23,51 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-// TODO(BEAM-6327): Remove the need for this.\n-\n-/** PipelineTrimmer removes subcomponents of native transforms that shouldn't be fused. */\n-public class PipelineTrimmer {\n-  private static final Logger LOG = LoggerFactory.getLogger(PipelineTrimmer.class);\n+/**\n+ * TrivialNativeTransformExpander is used to replace transforms with known URNs with their native\n+ * equivalent.\n+ */\n+public class TrivialNativeTransformExpander {\n+  private static final Logger LOG = LoggerFactory.getLogger(TrivialNativeTransformExpander.class);\n \n   /**\n-   * Remove subcomponents of native transforms that shouldn't be fused.\n+   * Replaces transforms with the known URN with a native equivalent stripping the environment and\n+   * removing any sub-transforms from the returned pipeline.\n    *\n    * @param pipeline the pipeline to be trimmed\n    * @param knownUrns set of URNs for the runner's native transforms\n    * @return the trimmed pipeline\n    */\n-  public static Pipeline trim(Pipeline pipeline, Set<String> knownUrns) {\n+  public static Pipeline forKnownUrns(Pipeline pipeline, Set<String> knownUrns) {\n     return makeKnownUrnsPrimitives(pipeline, knownUrns);\n   }\n \n   private static RunnerApi.Pipeline makeKnownUrnsPrimitives(\n       RunnerApi.Pipeline pipeline, Set<String> knownUrns) {\n     RunnerApi.Pipeline.Builder trimmedPipeline = pipeline.toBuilder();\n     for (String ptransformId : pipeline.getComponents().getTransformsMap().keySet()) {\n-      if (knownUrns.contains(\n-          pipeline.getComponents().getTransformsOrThrow(ptransformId).getSpec().getUrn())) {\n-        LOG.debug(\"Removing descendants of known PTransform {}\" + ptransformId);\n+      // Skip over previously removed transforms from the original pipeline.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2MDUzNA==", "bodyText": "Ah ok. I read this as GBK by mistake. Can we do this in a common place and skip the two known runner implemented transforms similar to other SDKs ?", "url": "https://github.com/apache/beam/pull/11670#discussion_r424560534", "createdAt": "2020-05-13T16:11:10Z", "author": {"login": "chamikaramj"}, "path": "sdks/go/pkg/beam/core/runtime/graphx/translate.go", "diffHunk": "@@ -375,6 +375,7 @@ func (m *marshaller) addMultiEdge(edge NamedEdge) []string {\n \t\tpayload := &pipepb.WindowIntoPayload{\n \t\t\tWindowFn: makeWindowFn(edge.Edge.WindowFn),\n \t\t}\n+\t\ttransformEnvID = m.addDefaultEnv()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzODQ4Nw=="}, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NTAwNA==", "bodyText": "Can we add an assert similar to PipelineValidator.java ?", "url": "https://github.com/apache/beam/pull/11670#discussion_r424565004", "createdAt": "2020-05-13T16:17:50Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -123,20 +123,16 @@ class Pipeline(object):\n   should be used to designate new names\n   (e.g. ``input | \"label\" >> my_transform``).\n   \"\"\"\n-\n-  # TODO: BEAM-9001 - set environment ID in all transforms and allow runners to\n-  # override.\n   @classmethod", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb9a55b702a237fc3f0f531f0ea70c43689d474e", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/bb9a55b702a237fc3f0f531f0ea70c43689d474e", "committedDate": "2020-05-13T16:48:05Z", "message": "fixup! Address chamikara's PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjM3NzAy", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-411237702", "createdAt": "2020-05-13T19:34:19Z", "commit": {"oid": "bb9a55b702a237fc3f0f531f0ea70c43689d474e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozNDoxOVrOGVAlEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozNDoxOVrOGVAlEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4Mjc3MA==", "bodyText": "So, it's now the case that Composite Transforms should have environments?", "url": "https://github.com/apache/beam/pull/11670#discussion_r424682770", "createdAt": "2020-05-13T19:34:19Z", "author": {"login": "lostluck"}, "path": "sdks/go/pkg/beam/core/runtime/graphx/translate.go", "diffHunk": "@@ -213,6 +213,7 @@ func (m *marshaller) addScopeTree(s *ScopeTree) string {\n \ttransform := &pipepb.PTransform{\n \t\tUniqueName:    s.Scope.Name,\n \t\tSubtransforms: subtransforms,\n+\t\tEnvironmentId: m.addDefaultEnv(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb9a55b702a237fc3f0f531f0ea70c43689d474e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzQ4NDM5", "url": "https://github.com/apache/beam/pull/11670#pullrequestreview-411348439", "createdAt": "2020-05-13T22:40:05Z", "commit": {"oid": "bb9a55b702a237fc3f0f531f0ea70c43689d474e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjo0MDowNlrOGVF-5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjo0MDowNlrOGVF-5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3MTMwMw==", "bodyText": "Probably we can introduce a new visitor and update runners to use that similar to following ?\nhttps://github.com/apache/beam/blob/master/sdks/python/apache_beam/runners/dataflow/dataflow_runner.py#L557\nBut this is not a blocker.", "url": "https://github.com/apache/beam/pull/11670#discussion_r424771303", "createdAt": "2020-05-13T22:40:06Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/pipeline.py", "diffHunk": "@@ -123,20 +123,16 @@ class Pipeline(object):\n   should be used to designate new names\n   (e.g. ``input | \"label\" >> my_transform``).\n   \"\"\"\n-\n-  # TODO: BEAM-9001 - set environment ID in all transforms and allow runners to\n-  # override.\n   @classmethod", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NTAwNA=="}, "originalCommit": {"oid": "58a470914dd88617962b65138d6d88fa897075bf"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}