{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NjY4Nzcz", "number": 11538, "title": "[BEAM-9831] Improve UX for HL7v2IO", "bodyText": "This implements the following improvements for HL7v2IO based on initial testing with customer\n\nemit early panes rather than blocking on pagination in ListHL7v2Messages. Note, this is because the architecture of this PTransform is such that it fans out from a PCollection of HL7v2 stores (typically just 1) to many, many messages. By default, beam will not emit panes until it estimates all the data has arrived. Because one element is fanning out to (potentially) millions of messages that must be paginated through. Beam only knows \"I'm not done outputting all the values for this single element, so my output must be incomplete\". Unfortunately there is no splitable restriction due to the pagination model not knowing the page tokens ahead of time, this must  happen in a single thread. This change just allows us to start processed the early pages sooner, allowing for a smoother throughput curve of output elements rather than a massive step function when pagination is finally complete.\nallow end users to use HL7v2MessageCoder in their pipelines by making constructor public.\ndrop output only fields (keeping only data and labels) before calling ingestMessages in HL7v2IO.Write rather than expecting the user to do this. (e.g. in a read from one HL7v2 store write directly to another use case)\n\nR: @pabloem\nCC: @lastomato\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-27T18:26:42Z", "url": "https://github.com/apache/beam/pull/11538", "merged": true, "mergeCommit": {"oid": "de53fc3acab66cc276cdddb18597a877cec1809a"}, "closed": true, "closedAt": "2020-04-30T21:49:15Z", "author": {"login": "jaketf"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYmS7gAH2gAyNDA5NjY4NzczOmY0N2E5Nzc0NzU1MDMyZDAyNTc1Zjc2NTdkNTg0MzkxNmY0N2RhYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccgdUigH2gAyNDA5NjY4NzczOjI1MWY0MTc0OWNiNWNhOTQ4MzE1MGIwM2MwZGFlNTYzMzUyYzNlMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f47a9774755032d02575f7657d5843916f47dac9", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/f47a9774755032d02575f7657d5843916f47dac9", "committedDate": "2020-04-17T19:17:20Z", "message": "Patches for HL7v2IO\n\n* Use TestPipeline in ITs\n* Drop schematized data before calling message ingest (should be output only) to help pipelines that read/write from/to two HL7v2 stores\n* Make HL7v2MessageCoder constructor public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ab1818c2399ad56be585ccbc30f882c1b32693", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/55ab1818c2399ad56be585ccbc30f882c1b32693", "committedDate": "2020-04-17T20:15:36Z", "message": "block on run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96d8e93032c3f61373012bea02c3febe53312c81", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/96d8e93032c3f61373012bea02c3febe53312c81", "committedDate": "2020-04-17T20:45:25Z", "message": "add sleep to avoid flakiness due to asyncronous HL7v2 indexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "committedDate": "2020-04-17T23:51:33Z", "message": "E2E integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "committedDate": "2020-04-17T23:55:27Z", "message": "fix merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a23ef7efd9706e3b5f33c35b22213f84963e50", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/40a23ef7efd9706e3b5f33c35b22213f84963e50", "committedDate": "2020-04-17T23:57:48Z", "message": "reconcile double sleeping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "194cf3e719b778ff5a4baf737134b00b8c601591", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/194cf3e719b778ff5a4baf737134b00b8c601591", "committedDate": "2020-04-20T23:42:17Z", "message": "improve error hanlding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "committedDate": "2020-04-20T23:44:49Z", "message": "improve error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6f86186e41c23a18d51036f24bb548d88efeac50", "committedDate": "2020-04-21T00:19:30Z", "message": "fix docs typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766e6fd64af3d17b75e551f1e25dd1aad428e018", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/766e6fd64af3d17b75e551f1e25dd1aad428e018", "committedDate": "2020-04-22T20:02:10Z", "message": "add latency distribution metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e989ec4601df842d377bdc15c53a1324a474de3f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/e989ec4601df842d377bdc15c53a1324a474de3f", "committedDate": "2020-04-22T20:03:38Z", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16399f1494e2071cee97fadaf56dc21a9eefbed3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/16399f1494e2071cee97fadaf56dc21a9eefbed3", "committedDate": "2020-04-22T21:41:01Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef3a33c532535873ee8029a27e2656929ac2e1f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/9ef3a33c532535873ee8029a27e2656929ac2e1f", "committedDate": "2020-04-22T22:16:06Z", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b576636f99f006c5738481ff72f06c576c46d0", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/c8b576636f99f006c5738481ff72f06c576c46d0", "committedDate": "2020-04-22T22:21:16Z", "message": "ingest only data and labels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "committedDate": "2020-04-22T22:26:08Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461b7cd79ece7cf27fb24032fb89cb3616d439ef", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/461b7cd79ece7cf27fb24032fb89cb3616d439ef", "committedDate": "2020-04-22T22:55:14Z", "message": "call spliterator directly, use page size 1000"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2602b477a8ebe535fe3060d643cbef45f0e2892", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b2602b477a8ebe535fe3060d643cbef45f0e2892", "committedDate": "2020-04-22T23:29:10Z", "message": "output elements more eagerly in ListHL72MessageFn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1503fd4600654064e608e3c98c6e9e9b0de20560", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1503fd4600654064e608e3c98c6e9e9b0de20560", "committedDate": "2020-04-23T23:43:42Z", "message": "eagerly emit data from early pages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "committedDate": "2020-04-24T00:51:47Z", "message": "Optimization of Listing and Stablization of ITs\n\n* allow HL7v2 Message listing to emit early panes rather than waiting on pagination of all list results\n* add EBO on HL7v2 Message listing reaching a certain expected length in ITs to account for async indexing BEAM-9779"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc3a8443e7a88cfb46b18b81d6a4a72b880420cd", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/fc3a8443e7a88cfb46b18b81d6a4a72b880420cd", "committedDate": "2020-04-27T18:21:35Z", "message": "implement improvements in BEAM-9831"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2f85e012134be5c1733c170e7b11aea5c952a7", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/ea2f85e012134be5c1733c170e7b11aea5c952a7", "committedDate": "2020-04-27T18:33:38Z", "message": "use HL7V2_INDEXING_TIMEOUT_MINUTES everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402950d0ba4ef45e60d187845df511ea5479ffe3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/402950d0ba4ef45e60d187845df511ea5479ffe3", "committedDate": "2020-04-27T21:39:14Z", "message": "make HL7v2Message constructor public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "454f1ef7d920a799db10e034d0fb430399fa5f5c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/454f1ef7d920a799db10e034d0fb430399fa5f5c", "committedDate": "2020-04-28T16:30:07Z", "message": "Merge branch 'master' into optimization/HL7v2IO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjI4NDcz", "url": "https://github.com/apache/beam/pull/11538#pullrequestreview-401228473", "createdAt": "2020-04-27T18:44:16Z", "commit": {"oid": "ea2f85e012134be5c1733c170e7b11aea5c952a7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODo0NDoxNlrOGMyT6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMToxNTo1M1rOGNnP_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA2MDM5Mw==", "bodyText": "requestTime?", "url": "https://github.com/apache/beam/pull/11538#discussion_r416060393", "createdAt": "2020-04-27T18:44:16Z", "author": {"login": "pabloem"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IO.java", "diffHunk": "@@ -475,7 +497,14 @@ public void initClient() throws IOException {\n     public void listMessages(ProcessContext context) throws IOException {\n       String hl7v2Store = context.element();\n       // Output all elements of all pages.\n-      this.client.getHL7v2MessageStream(hl7v2Store, this.filter).forEach(context::output);\n+      HttpHealthcareApiClient.HL7v2MessagePages pages =\n+          new HttpHealthcareApiClient.HL7v2MessagePages(client, hl7v2Store, this.filter);\n+      long reqestTime = Instant.now().getMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2f85e012134be5c1733c170e7b11aea5c952a7"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkyNzc0MA==", "bodyText": "Unfortunately, this is not possible. If you are paginating from inside the single DoFn processelement call, the data coming out of it will only go downstream after the element is done being processed, so this windowing is not changing that in the execution.\nThis is because bundle execution is committed atomically, so the whole bundle executes before data can go downstream. You do touch on an interesting example, which is one of the reasons that we came up with SplittableDoFn.\nSomething you could try to do is:\nPColll<HL7v2Message> pages = hl7v2Stores.apply(ParDo.of(new RetrieveAndOutputPagesFn()))\n\npages.apply(Reshuffle.viaRandomKey()).apply(ParDo.of(new FetchEachPageFn())\n\nThough I don't know if you can actually do that : )", "url": "https://github.com/apache/beam/pull/11538#discussion_r416927740", "createdAt": "2020-04-28T21:15:53Z", "author": {"login": "pabloem"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IO.java", "diffHunk": "@@ -437,6 +444,20 @@ private Message fetchMessage(HealthcareApiClient client, String msgId)\n           .apply(Create.of(this.hl7v2Stores))\n           .apply(ParDo.of(new ListHL7v2MessagesFn(this.filter)))\n           .setCoder(new HL7v2MessageCoder())\n+          // Listing takes a long time for each input element (HL7v2 store) because it has to\n+          // paginate through results in a single thread / ProcessElement call in order to keep\n+          // track of page token.\n+          // Eagerly emit data on 1 second intervals so downstream processing can get started before\n+          // all of the list results have been paginated through.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454f1ef7d920a799db10e034d0fb430399fa5f5c"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81a3cb2d6aa7aeb8a71aaa461e9bf779da66f16c", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/81a3cb2d6aa7aeb8a71aaa461e9bf779da66f16c", "committedDate": "2020-04-28T22:46:54Z", "message": "add TODO for verifying triggering behavior BEAM-9847"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf3c13764462da3cb935aad9963af78b2a1adfc", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/edf3c13764462da3cb935aad9963af78b2a1adfc", "committedDate": "2020-04-29T22:44:39Z", "message": "remove inappropriate 'optimizaiton', add status code to HealthcareIOError"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "251f41749cb5ca9483150b03c0dae563352c3e12", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/251f41749cb5ca9483150b03c0dae563352c3e12", "committedDate": "2020-04-29T22:44:57Z", "message": "Merge branch 'optimization/HL7v2IO' of github.com:jaketf/beam into optimization/HL7v2IO"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4001, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}