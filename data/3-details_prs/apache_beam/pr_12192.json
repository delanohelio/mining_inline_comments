{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1ODU0MjI4", "number": 12192, "title": "[BEAM-10420] Move restriction/watermark estimator state into PerWindowInvoker", "bodyText": "To be able to have the windowing optimization stay within the PerWindowInvoker, I needed to have it control the creation of the watermark estimator and the restriction tracker thus I supply the restrication and watermark estimator state.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-08T02:12:34Z", "url": "https://github.com/apache/beam/pull/12192", "merged": true, "mergeCommit": {"oid": "ea965cae7cbfc1b8d43f0a1b5b3f14e4471f0405"}, "closed": true, "closedAt": "2020-07-10T17:50:09Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyw05bgFqTQ0NDM2NjY4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczmIiKAH2gAyNDQ1ODU0MjI4OjMyNjkxYjQ4NTg5OTYzNTBiNmIzYTRkYzliOWVjZTQ1YzRlNmE5NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzY2Njg4", "url": "https://github.com/apache/beam/pull/12192#pullrequestreview-444366688", "createdAt": "2020-07-08T02:15:30Z", "commit": {"oid": "facc70e7be1ddb8c49bd3a980398500f753262c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNTozMVrOGuVr4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNTozMVrOGuVr4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0Mjk3OQ==", "bodyText": "This is handled within the PerWindowInvoker already.", "url": "https://github.com/apache/beam/pull/12192#discussion_r451242979", "createdAt": "2020-07-08T02:15:31Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/direct/sdf_direct_runner.py", "diffHunk": "@@ -507,7 +500,6 @@ def initiate_checkpoint():\n       if self._max_num_outputs and output_count >= self._max_num_outputs:\n         initiate_checkpoint()\n \n-    tracker.check_done()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "facc70e7be1ddb8c49bd3a980398500f753262c1"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzY2ODIy", "url": "https://github.com/apache/beam/pull/12192#pullrequestreview-444366822", "createdAt": "2020-07-08T02:15:57Z", "commit": {"oid": "facc70e7be1ddb8c49bd3a980398500f753262c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNTo1N1rOGuVsUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMjoxNTo1N1rOGuVsUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI0MzA4OA==", "bodyText": "This is a bug fix, we should be setting checkpoint_state.checkpointed while holding the lock.", "url": "https://github.com/apache/beam/pull/12192#discussion_r451243088", "createdAt": "2020-07-08T02:15:57Z", "author": {"login": "lukecwik"}, "path": "sdks/python/apache_beam/runners/direct/sdf_direct_runner.py", "diffHunk": "@@ -464,19 +461,15 @@ def initiate_checkpoint():\n       with self._checkpoint_lock:\n         if checkpoint_state.checkpointed:\n           return\n-      checkpoint_state.residual_restriction = tracker.checkpoint()\n-      checkpoint_state.checkpointed = object()\n+        checkpoint_state.checkpointed = object()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "facc70e7be1ddb8c49bd3a980398500f753262c1"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/8efe84c76ffcce1c361e94c21b057f753bdf25b1", "committedDate": "2020-07-08T02:54:05Z", "message": "[BEAM-10420] Migrate SDF logic into PerWindowInvoker\n\nTo be able to have the windowing optimization stay within the PerWindowInvoker, I needed to have it control the creation of the watermark estimator and the restriction tracker thus I supply the restrication and watermark estimator state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f2d2a4fc706f95a2dc6cb6048a0882741839260", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/8f2d2a4fc706f95a2dc6cb6048a0882741839260", "committedDate": "2020-07-08T02:28:56Z", "message": "fixup!"}, "afterCommit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/8efe84c76ffcce1c361e94c21b057f753bdf25b1", "committedDate": "2020-07-08T02:54:05Z", "message": "[BEAM-10420] Migrate SDF logic into PerWindowInvoker\n\nTo be able to have the windowing optimization stay within the PerWindowInvoker, I needed to have it control the creation of the watermark estimator and the restriction tracker thus I supply the restrication and watermark estimator state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MTg2ODA4", "url": "https://github.com/apache/beam/pull/12192#pullrequestreview-446186808", "createdAt": "2020-07-10T07:38:59Z", "commit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNzozODo1OVrOGvtJFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwNzo0MzozMFrOGvtRog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3NTg2MQ==", "bodyText": "New type is just 'object' ?", "url": "https://github.com/apache/beam/pull/12192#discussion_r452675861", "createdAt": "2020-07-10T07:38:59Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -661,8 +661,8 @@ def __init__(self, placeholder):\n \n   def invoke_process(self,\n                      windowed_value,  # type: WindowedValue\n-                     restriction_tracker=None, # type: Optional[RestrictionTracker]\n-                     watermark_estimator=None, # type: Optional[WatermarkEstimator]\n+                     restriction=None,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3NjYyMQ==", "bodyText": "Mention when this can be None.", "url": "https://github.com/apache/beam/pull/12192#discussion_r452676621", "createdAt": "2020-07-10T07:40:28Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -661,8 +661,8 @@ def __init__(self, placeholder):\n \n   def invoke_process(self,\n                      windowed_value,  # type: WindowedValue\n-                     restriction_tracker=None, # type: Optional[RestrictionTracker]\n-                     watermark_estimator=None, # type: Optional[WatermarkEstimator]\n+                     restriction=None,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3ODA1MA==", "bodyText": "This is a tuple ?", "url": "https://github.com/apache/beam/pull/12192#discussion_r452678050", "createdAt": "2020-07-10T07:43:30Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -661,8 +661,8 @@ def __init__(self, placeholder):\n \n   def invoke_process(self,\n                      windowed_value,  # type: WindowedValue\n-                     restriction_tracker=None, # type: Optional[RestrictionTracker]\n-                     watermark_estimator=None, # type: Optional[WatermarkEstimator]\n+                     restriction=None,\n+                     watermark_estimator_state=None,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8efe84c76ffcce1c361e94c21b057f753bdf25b1"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32691b4858996350b6b3a4dc9b9ece45c4e6a976", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/32691b4858996350b6b3a4dc9b9ece45c4e6a976", "committedDate": "2020-07-10T16:21:56Z", "message": "fixup! Address PR comments\n\nAlso make construction of restriction and watermark estimator state owned by caller of process_invoke.\nThis will prevent an issue where 'None' is being used as either type."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4170, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}