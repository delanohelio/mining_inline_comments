{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTQ2NDg3", "number": 12203, "title": "[BEAM-6928] Make Python SDK custom Sink the default Sink for BigQuery", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-09T00:13:23Z", "url": "https://github.com/apache/beam/pull/12203", "merged": true, "mergeCommit": {"oid": "3471c465fa76601bbb616ba622a37fa957f4fa4c"}, "closed": true, "closedAt": "2020-08-04T21:18:49Z", "author": {"login": "pabloem"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczDn_egH2gAyNDQ2NTQ2NDg3OjA4MDQ1ZWJiYzEzNmIyYTFjMWM4YWUxMzU0YTQxZDQyNjcwMDAzNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7q70hAH2gAyNDQ2NTQ2NDg3OmQwOWQwZGUzODRiZGUyMTIzNTRlOGM5NzU2YTIzMWMzYjljNGIwNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08045ebbc136b2a1c1c8ae1354a41d4267000348", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/08045ebbc136b2a1c1c8ae1354a41d4267000348", "committedDate": "2020-07-09T00:09:37Z", "message": "Making Beam sink the default sink for BigQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af449954bb8f1ceac1df0e5e57e50bdefa6e2ee5", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/af449954bb8f1ceac1df0e5e57e50bdefa6e2ee5", "committedDate": "2020-07-09T00:12:43Z", "message": "Sharing the Beam sink update in CHANGES.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "957cdde34fee7cffb41ec471132a2a1c99695560", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/957cdde34fee7cffb41ec471132a2a1c99695560", "committedDate": "2020-07-09T21:03:14Z", "message": "Fixing precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/585241da6d61ba27b6d57a5fbf90b6b4e93b87a1", "committedDate": "2020-07-09T21:44:36Z", "message": "Fix formatter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDY0MTA2", "url": "https://github.com/apache/beam/pull/12203#pullrequestreview-454464106", "createdAt": "2020-07-23T20:17:21Z", "commit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDoxNzoyMVrOG2aD5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMDoyNToyMlrOG2aUQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMzI2OQ==", "bodyText": "Did you mean BigQuerySink ?", "url": "https://github.com/apache/beam/pull/12203#discussion_r459703269", "createdAt": "2020-07-23T20:17:21Z", "author": {"login": "chamikaramj"}, "path": "CHANGES.md", "diffHunk": "@@ -55,6 +55,9 @@\n \n * New overloads for BigtableIO.Read.withKeyRange() and BigtableIO.Read.withRowFilter()\n   methods that take ValueProvider as a parameter (Java) ([BEAM-10283](https://issues.apache.org/jira/browse/BEAM-10283)).\n+* The WriteToBigQuery transform (Python) in Dataflow Batch no longer relies on BigQuerySource by default. It relies on ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDE1OA==", "bodyText": "Can we just change this sink to use the new sink ?", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704158", "createdAt": "2020-07-23T20:19:03Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_it_test.py", "diffHunk": "@@ -227,6 +225,7 @@ def test_big_query_standard_sql_kms_key_native(self):\n         'on_success_matcher': all_of(*pipeline_verifiers),\n         'kms_key': kms_key,\n         'native': True,\n+        'experiments': 'use_dataflow_bq_sink',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDIzOQ==", "bodyText": "Ditto.", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704239", "createdAt": "2020-07-23T20:19:15Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/io/gcp/big_query_query_to_table_it_test.py", "diffHunk": "@@ -305,7 +303,8 @@ def test_big_query_new_types_native(self):\n         'use_standard_sql': False,\n         'native': True,\n         'wait_until_finish_duration': WAIT_UNTIL_FINISH_DURATION_MS,\n-        'on_success_matcher': all_of(*pipeline_verifiers)\n+        'on_success_matcher': all_of(*pipeline_verifiers),\n+        'experiments': 'use_dataflow_bq_sink',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNDYwNg==", "bodyText": "May be call this \"use_legacy_bq_sink\" ?", "url": "https://github.com/apache/beam/pull/12203#discussion_r459704606", "createdAt": "2020-07-23T20:19:56Z", "author": {"login": "chamikaramj"}, "path": "CHANGES.md", "diffHunk": "@@ -55,6 +55,9 @@\n \n * New overloads for BigtableIO.Read.withKeyRange() and BigtableIO.Read.withRowFilter()\n   methods that take ValueProvider as a parameter (Java) ([BEAM-10283](https://issues.apache.org/jira/browse/BEAM-10283)).\n+* The WriteToBigQuery transform (Python) in Dataflow Batch no longer relies on BigQuerySource by default. It relies on \n+  a new, fully-featured transform based on file loads into BigQuery. To revert the behavior to the old implementation,\n+  you may use `--experiments=use_dataflow_bq_sink`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTU2NA==", "bodyText": "Why not run this using the new sink ?", "url": "https://github.com/apache/beam/pull/12203#discussion_r459705564", "createdAt": "2020-07-23T20:21:37Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -698,6 +698,7 @@ def test_gbk_translation(self):\n   def test_write_bigquery_translation(self):\n     runner = DataflowRunner()\n \n+    self.default_properties.append('--experiments=use_dataflow_bq_sink')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNTc2Nw==", "bodyText": "Ditto.", "url": "https://github.com/apache/beam/pull/12203#discussion_r459705767", "createdAt": "2020-07-23T20:21:57Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/dataflow_runner_test.py", "diffHunk": "@@ -749,12 +750,13 @@ def test_write_bigquery_failed_translation(self):\n     \"\"\"Tests that WriteToBigQuery cannot have any consumers if replaced.\"\"\"\n     runner = DataflowRunner()\n \n-    with self.assertRaises(ValueError):\n+    self.default_properties.append('--experiments=use_dataflow_bq_sink')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNjgzNA==", "bodyText": "Can we use the experiment here ? You can get hold of the PipelineOptions through input.", "url": "https://github.com/apache/beam/pull/12203#discussion_r459706834", "createdAt": "2020-07-23T20:24:14Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/ptransform_overrides.py", "diffHunk": "@@ -236,7 +236,10 @@ def enter_composite_transform(self, transform_node):\n         self.visit_transform(transform_node)\n \n       def visit_transform(self, transform_node):\n-        if [o for o in self.outputs if o in transform_node.inputs]:\n+        # Internal consumers of the outputs we're overriding are expected.\n+        # We only error out on non-internal consumers.\n+        if ('BigQueryBatchFileLoads' not in transform_node.full_label and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwNzQ1Ng==", "bodyText": "Why did we have to add this explicit fail ? I don't think we add such visitors for other transforms that do not produce output. Usually succeeding transform just ends up being an no-op.", "url": "https://github.com/apache/beam/pull/12203#discussion_r459707456", "createdAt": "2020-07-23T20:25:22Z", "author": {"login": "chamikaramj"}, "path": "sdks/python/apache_beam/runners/dataflow/ptransform_overrides.py", "diffHunk": "@@ -236,7 +236,10 @@ def enter_composite_transform(self, transform_node):\n         self.visit_transform(transform_node)\n \n       def visit_transform(self, transform_node):\n-        if [o for o in self.outputs if o in transform_node.inputs]:\n+        # Internal consumers of the outputs we're overriding are expected.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "585241da6d61ba27b6d57a5fbf90b6b4e93b87a1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5758f44332e3eb0bd747ad62be7a90bbb777c87", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/f5758f44332e3eb0bd747ad62be7a90bbb777c87", "committedDate": "2020-07-24T18:43:48Z", "message": "addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU5MTIw", "url": "https://github.com/apache/beam/pull/12203#pullrequestreview-458859120", "createdAt": "2020-07-31T01:09:06Z", "commit": {"oid": "f5758f44332e3eb0bd747ad62be7a90bbb777c87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09d0de384bde212354e8c9756a231c3b9c4b063", "author": {"user": {"login": "pabloem", "name": "Pablo"}}, "url": "https://github.com/apache/beam/commit/d09d0de384bde212354e8c9756a231c3b9c4b063", "committedDate": "2020-08-04T18:28:58Z", "message": "Merge branch 'master' into bq-main-sink"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3995, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}