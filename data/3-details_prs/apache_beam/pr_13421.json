{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2ODc0MDU3", "number": 13421, "title": "[BEAM-9602] Add timer family support for python SDK", "bodyText": "Please add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-25T00:09:18Z", "url": "https://github.com/apache/beam/pull/13421", "merged": true, "mergeCommit": {"oid": "8cf88c377b6f0b21ad817ebc0586e1cba9c3feda"}, "closed": true, "closedAt": "2020-12-11T18:08:23Z", "author": {"login": "y1chi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf04zsABqjQwMzU3NzA2NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk9kJaABqjQwOTc5ODA0ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75364f7cd7553352d1c4b2d7b1918612b84cf35f", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/75364f7cd7553352d1c4b2d7b1918612b84cf35f", "committedDate": "2020-11-25T01:14:11Z", "message": "Fix lint"}, "afterCommit": {"oid": "38be5d53da2b3a0165815e004f53da78dd617bbe", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/38be5d53da2b3a0165815e004f53da78dd617bbe", "committedDate": "2020-11-25T02:25:46Z", "message": "Fix lint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38be5d53da2b3a0165815e004f53da78dd617bbe", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/38be5d53da2b3a0165815e004f53da78dd617bbe", "committedDate": "2020-11-25T02:25:46Z", "message": "Fix lint"}, "afterCommit": {"oid": "31bab49570ff4cf3bc43e8d2080f6fb3dc8b12d6", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/31bab49570ff4cf3bc43e8d2080f6fb3dc8b12d6", "committedDate": "2020-11-25T03:41:59Z", "message": "Fix lint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fce0731fbb12de75f10a1ad13da7a799df250587", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/fce0731fbb12de75f10a1ad13da7a799df250587", "committedDate": "2020-11-30T22:51:20Z", "message": "Add MethodWrapper attribute in common.pxd"}, "afterCommit": {"oid": "f2b40401b47c9f265f73eab6549912905c2026b3", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/f2b40401b47c9f265f73eab6549912905c2026b3", "committedDate": "2020-11-30T23:37:55Z", "message": "Add MethodWrapper attribute in common.pxd"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzczMTc0", "url": "https://github.com/apache/beam/pull/13421#pullrequestreview-542373174", "createdAt": "2020-12-01T23:09:33Z", "commit": {"oid": "f2b40401b47c9f265f73eab6549912905c2026b3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzowOTozNFrOH9Dkhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzo0MToxN1rOH9EV1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4MzY4Nw==", "bodyText": "Unnecessary comma?", "url": "https://github.com/apache/beam/pull/13421#discussion_r533783687", "createdAt": "2020-12-01T23:09:34Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/worker/bundle_processor.py", "diffHunk": "@@ -643,15 +643,16 @@ def commit(self):\n \n class OutputTimer(userstate.BaseTimer):\n   def __init__(self,\n+               dynamic_timer_tag,  # type: str\n                key,\n-               window,  # type: windowed_value.BoundedWindow\n+               window,  # type: BoundedWindow\n                timestamp,  # type: timestamp.Timestamp\n                paneinfo,  # type: windowed_value.PaneInfo\n                time_domain, # type: str\n                timer_family_id,  # type: str\n                timer_coder_impl,  # type: coder_impl.TimerCoderImpl\n-               output_stream  # type: data_plane.ClosableOutputStream\n-              ):\n+               output_stream,  # type: data_plane.ClosableOutputStream", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2b40401b47c9f265f73eab6549912905c2026b3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5NjMxMQ==", "bodyText": "You may want to remove the TODO there.", "url": "https://github.com/apache/beam/pull/13421#discussion_r533796311", "createdAt": "2020-12-01T23:41:17Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/transforms/userstate.py", "diffHunk": "@@ -188,15 +190,14 @@ def to_runner_api(self, context, key_coder, window_coder):\n class TimerFamilySpec(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2b40401b47c9f265f73eab6549912905c2026b3"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "417e3e85d8d65f7e8f7fb0d367ce6dffbb41d79b", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/417e3e85d8d65f7e8f7fb0d367ce6dffbb41d79b", "committedDate": "2020-12-03T19:51:25Z", "message": "Skip timer family test in flink_runner_test"}, "afterCommit": {"oid": "77a40e58c57ba4130a5661adad86ff37ca981563", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/77a40e58c57ba4130a5661adad86ff37ca981563", "committedDate": "2020-12-03T20:55:17Z", "message": "Skip timer family test in flink_runner_test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDg5ODg2", "url": "https://github.com/apache/beam/pull/13421#pullrequestreview-544489886", "createdAt": "2020-12-03T22:02:17Z", "commit": {"oid": "77a40e58c57ba4130a5661adad86ff37ca981563"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "597da5d0a3c070755340c0179118b140635f0be6", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/597da5d0a3c070755340c0179118b140635f0be6", "committedDate": "2020-12-08T00:15:11Z", "message": "Remove TimerFamilySpec and reuse TimerSpec for dynamic timer"}, "afterCommit": {"oid": "efb071bd3c6b362843e094b81310ba08534864ba", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/efb071bd3c6b362843e094b81310ba08534864ba", "committedDate": "2020-12-08T19:49:40Z", "message": "Remove TimerFamilySpec and reuse TimerSpec for dynamic timer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjU1MjE4", "url": "https://github.com/apache/beam/pull/13421#pullrequestreview-546655218", "createdAt": "2020-12-08T00:36:30Z", "commit": {"oid": "597da5d0a3c070755340c0179118b140635f0be6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMDozNjozMFrOIBBXKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMToyMTo1M1rOIB2wFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk0MTgwMA==", "bodyText": "Would it be better to have separated functions like get_timer(), get_timer_family instead of using a boolean", "url": "https://github.com/apache/beam/pull/13421#discussion_r537941800", "createdAt": "2020-12-08T00:36:30Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/direct/direct_userstate.py", "diffHunk": "@@ -225,14 +225,28 @@ def __init__(self, step_context, dofn, key_coder):\n \n     self.cached_states = {}\n     self.cached_timers = {}\n-\n-  def get_timer(self, timer_spec, key, window, timestamp, pane):\n+    self.cached_timer_families = {}\n+\n+  def get_timer(\n+      self,\n+      timer_spec: userstate.TimerSpec,\n+      key,\n+      window,\n+      timestamp,\n+      pane,\n+      is_timer_family=False", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "597da5d0a3c070755340c0179118b140635f0be6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgxNjUzMw==", "bodyText": "If one DoFn defines one TimerSpec and uses it in both TimerParam and TimerFamilyParam, we will have collisions on this spec, right?  And in this case, there is no way to register one callback for timer TimerSpec and one callback for timer family TimerSpec` since we are using maps in in implemetation.\nI'm leaning to keep TimerFamilySpec and use TimerParam for both TimerSpec and TimerFamilySpec, where the prefix field will help us reduce the collision.", "url": "https://github.com/apache/beam/pull/13421#discussion_r538816533", "createdAt": "2020-12-08T21:21:53Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/transforms/userstate.py", "diffHunk": "@@ -184,29 +186,6 @@ def to_runner_api(self, context, key_coder, window_coder):\n             coders._TimerCoder(key_coder, window_coder)))\n \n \n-# TODO(BEAM-9602): Provide support for dynamic timer.\n-class TimerFamilySpec(object):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb071bd3c6b362843e094b81310ba08534864ba"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36190a64da7aa0020a6b30fac44401ab9e79600b", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/36190a64da7aa0020a6b30fac44401ab9e79600b", "committedDate": "2020-12-08T22:35:54Z", "message": "Split userstate get_timer() and get_timer_family()"}, "afterCommit": {"oid": "78cbb5d63242bc41a6649a0bda6e5c636f1e0d99", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/78cbb5d63242bc41a6649a0bda6e5c636f1e0d99", "committedDate": "2020-12-08T22:57:19Z", "message": "Split userstate get_timer() and get_timer_family()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bc6264cd49b1ac0942e3329b1059c46f8796a3d", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/5bc6264cd49b1ac0942e3329b1059c46f8796a3d", "committedDate": "2020-12-10T19:16:07Z", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag"}, "afterCommit": {"oid": "b04c76293dd05936c6f08ff8876a36ffaf71a48c", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/b04c76293dd05936c6f08ff8876a36ffaf71a48c", "committedDate": "2020-12-10T19:54:21Z", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b04c76293dd05936c6f08ff8876a36ffaf71a48c", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/b04c76293dd05936c6f08ff8876a36ffaf71a48c", "committedDate": "2020-12-10T19:54:21Z", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag"}, "afterCommit": {"oid": "f4c6368a4ceb0192a291a5c4173b1464403a49c8", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/f4c6368a4ceb0192a291a5c4173b1464403a49c8", "committedDate": "2020-12-10T20:22:49Z", "message": "Use common RuntimeTimer but extend api for allowing dynamic_timer_tag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzA0Mjcy", "url": "https://github.com/apache/beam/pull/13421#pullrequestreview-549704272", "createdAt": "2020-12-10T23:54:33Z", "commit": {"oid": "f4c6368a4ceb0192a291a5c4173b1464403a49c8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo1NDozM1rOIDi2SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDoyMzoxMVrOIDjiMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NzU5Mw==", "bodyText": "Can we also test:\ndynamic_timer.set(timestamp)\ndynamic_timer.set(timestamp, dynamic_timer_tag='')\nhere, where the later one should override the first one?", "url": "https://github.com/apache/beam/pull/13421#discussion_r540587593", "createdAt": "2020-12-10T23:54:33Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/fn_runner_test.py", "diffHunk": "@@ -493,6 +493,30 @@ def is_buffered_correctly(actual):\n \n       assert_that(actual, is_buffered_correctly)\n \n+  def test_pardo_dynamic_timer(self):\n+    class DynamicTimerDoFn(beam.DoFn):\n+      dynamic_timer_spec = userstate.TimerSpec(\n+          'dynamic_timer', userstate.TimeDomain.WATERMARK)\n+\n+      def process(\n+          self, element,\n+          dynamic_timer=beam.DoFn.TimerParam(dynamic_timer_spec)):\n+        dynamic_timer.set(element[1], dynamic_timer_tag=element[0])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c6368a4ceb0192a291a5c4173b1464403a49c8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODgzNQ==", "bodyText": "Remove this?", "url": "https://github.com/apache/beam/pull/13421#discussion_r540598835", "createdAt": "2020-12-11T00:23:11Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/scripts/generate_pydoc.sh", "diffHunk": "@@ -188,6 +188,7 @@ ignore_identifiers = [\n   # DoFn param inner classes, due to a Sphinx misparsing of inner classes\n   '_StateDoFnParam',\n   '_TimerDoFnParam',\n+  '_TimerFamilyDoFnParam',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c6368a4ceb0192a291a5c4173b1464403a49c8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzI5MzMx", "url": "https://github.com/apache/beam/pull/13421#pullrequestreview-549729331", "createdAt": "2020-12-11T01:01:45Z", "commit": {"oid": "8844ec6918c1940b4fe8808049e743fdf78493db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a679babf88e6014abbd64aac5890d7bcdd8dca8e", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/a679babf88e6014abbd64aac5890d7bcdd8dca8e", "committedDate": "2020-12-11T01:20:56Z", "message": "[BEAM-9602] Add timer family support for python SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8844ec6918c1940b4fe8808049e743fdf78493db", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/8844ec6918c1940b4fe8808049e743fdf78493db", "committedDate": "2020-12-11T00:33:43Z", "message": "Address comment"}, "afterCommit": {"oid": "a679babf88e6014abbd64aac5890d7bcdd8dca8e", "author": {"user": {"login": "y1chi", "name": "Yichi Zhang"}}, "url": "https://github.com/apache/beam/commit/a679babf88e6014abbd64aac5890d7bcdd8dca8e", "committedDate": "2020-12-11T01:20:56Z", "message": "[BEAM-9602] Add timer family support for python SDK"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4554, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}