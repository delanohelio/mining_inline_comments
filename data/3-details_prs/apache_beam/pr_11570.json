{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzgwOTg0", "number": 11570, "title": "[BEAM-10047] Merge the stages 'Gather and Sort' and 'Create Batches'", "bodyText": "There is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\nRemoving this encode/decode should save up to 2GB of RAM.\nNote, this PR is dependent on PR #11528,  PR #11532 and PR #11529\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-29T15:19:49Z", "url": "https://github.com/apache/beam/pull/11570", "merged": true, "mergeCommit": {"oid": "d7450bbd164d17b335a042f3dd43da49119d8759"}, "closed": true, "closedAt": "2020-06-26T23:04:23Z", "author": {"login": "nielm"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdAPeFgBqjMyOTI5NzA1MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp1oXRABqjM0Mjg1NDcxNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70c03e20cc40aa4db1655503a80e30fa2ad1ffd7", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/70c03e20cc40aa4db1655503a80e30fa2ad1ffd7", "committedDate": "2020-04-29T15:14:35Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}, "afterCommit": {"oid": "cd15c5e69ddc1a1ff0525b009ba822c7c3db5f18", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cd15c5e69ddc1a1ff0525b009ba822c7c3db5f18", "committedDate": "2020-05-01T11:43:20Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd15c5e69ddc1a1ff0525b009ba822c7c3db5f18", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/cd15c5e69ddc1a1ff0525b009ba822c7c3db5f18", "committedDate": "2020-05-01T11:43:20Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}, "afterCommit": {"oid": "f6a09a2856e8c42aec6460dc9f99f89bdbb2e1af", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/f6a09a2856e8c42aec6460dc9f99f89bdbb2e1af", "committedDate": "2020-05-01T11:49:42Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6a09a2856e8c42aec6460dc9f99f89bdbb2e1af", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/f6a09a2856e8c42aec6460dc9f99f89bdbb2e1af", "committedDate": "2020-05-01T11:49:42Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}, "afterCommit": {"oid": "87d22b580317d8cf0dfbb1446a27abcd353e248b", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/87d22b580317d8cf0dfbb1446a27abcd353e248b", "committedDate": "2020-05-01T12:01:46Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODUzNjA5", "url": "https://github.com/apache/beam/pull/11570#pullrequestreview-406853609", "createdAt": "2020-05-06T17:54:50Z", "commit": {"oid": "87d22b580317d8cf0dfbb1446a27abcd353e248b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzo1NDo1MFrOGReuZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzo1NDo1MFrOGReuZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MjM3Mg==", "bodyText": "Do we need to mark this as synchronized. Looks like all the callers are synchronized themselves.", "url": "https://github.com/apache/beam/pull/11570#discussion_r420982372", "createdAt": "2020-05-06T17:54:50Z", "author": {"login": "allenpradeep"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerIO.java", "diffHunk": "@@ -1171,67 +1145,127 @@ public void processElement(ProcessContext c) {\n    * occur, Therefore this DoFn has to be tested in isolation.\n    */\n   @VisibleForTesting\n-  static class GatherBundleAndSortFn extends DoFn<MutationGroup, Iterable<KV<byte[], byte[]>>> {\n-    private final long maxBatchSizeBytes;\n-    private final long maxNumMutations;\n-    private final long maxNumRows;\n-\n-    // total size of the current batch.\n-    private long batchSizeBytes;\n-    // total number of mutated cells.\n-    private long batchCells;\n-    // total number of rows mutated.\n-    private long batchRows;\n+  static class GatherSortCreateBatchesFn extends DoFn<MutationGroup, Iterable<MutationGroup>> {\n \n+    private final long maxBatchSizeBytes;\n+    private final long maxBatchNumMutations;\n+    private final long maxBatchNumRows;\n+    private final long maxSortableSizeBytes;\n+    private final long maxSortableNumMutations;\n+    private final long maxSortableNumRows;\n     private final PCollectionView<SpannerSchema> schemaView;\n+    private final ArrayList<MutationGroupContainer> mutationsToSort = new ArrayList<>();\n \n-    private transient ArrayList<KV<byte[], byte[]>> mutationsToSort = null;\n+    // total size of MutationGroups in mutationsToSort.\n+    private long sortableSizeBytes;\n+    // total number of mutated cells in mutationsToSort\n+    private long sortableNumCells;\n+    // total number of rows mutated in mutationsToSort\n+    private long sortableNumRows;\n \n-    GatherBundleAndSortFn(\n+    GatherSortCreateBatchesFn(\n         long maxBatchSizeBytes,\n         long maxNumMutations,\n         long maxNumRows,\n         long groupingFactor,\n         PCollectionView<SpannerSchema> schemaView) {\n-      this.maxBatchSizeBytes = maxBatchSizeBytes * groupingFactor;\n-      this.maxNumMutations = maxNumMutations * groupingFactor;\n-      this.maxNumRows = maxNumRows * groupingFactor;\n+      this.maxBatchSizeBytes = maxBatchSizeBytes;\n+      this.maxBatchNumMutations = maxNumMutations;\n+      this.maxBatchNumRows = maxNumRows;\n+\n+      if (groupingFactor <= 0) {\n+        groupingFactor = 1;\n+      }\n+\n+      this.maxSortableSizeBytes = maxBatchSizeBytes * groupingFactor;\n+      this.maxSortableNumMutations = maxNumMutations * groupingFactor;\n+      this.maxSortableNumRows = maxNumRows * groupingFactor;\n       this.schemaView = schemaView;\n     }\n \n     @StartBundle\n     public synchronized void startBundle() throws Exception {\n-      if (mutationsToSort == null) {\n-        initSorter();\n-      } else {\n-        throw new IllegalStateException(\"Sorter should be null here\");\n-      }\n+      initSorter();\n     }\n \n-    private void initSorter() {\n-      mutationsToSort = new ArrayList<KV<byte[], byte[]>>((int) maxNumMutations);\n-      batchSizeBytes = 0;\n-      batchCells = 0;\n-      batchRows = 0;\n+    private synchronized void initSorter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87d22b580317d8cf0dfbb1446a27abcd353e248b"}, "originalPosition": 154}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87d22b580317d8cf0dfbb1446a27abcd353e248b", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/87d22b580317d8cf0dfbb1446a27abcd353e248b", "committedDate": "2020-05-01T12:01:46Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}, "afterCommit": {"oid": "98c0aaf64a9186314a526201583341118509e98e", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/98c0aaf64a9186314a526201583341118509e98e", "committedDate": "2020-05-18T22:56:47Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32282b08995c5377d42338c5e64a0406f7cf4b59", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/32282b08995c5377d42338c5e64a0406f7cf4b59", "committedDate": "2020-05-18T23:29:56Z", "message": "Add additional documentation on Batching and Grouping"}, "afterCommit": {"oid": "ac119f02526c3dc0bc254f0aab1855e432acc024", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ac119f02526c3dc0bc254f0aab1855e432acc024", "committedDate": "2020-05-18T23:38:20Z", "message": "Add additional documentation on Batching and Grouping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac119f02526c3dc0bc254f0aab1855e432acc024", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/ac119f02526c3dc0bc254f0aab1855e432acc024", "committedDate": "2020-05-18T23:38:20Z", "message": "Add additional documentation on Batching and Grouping"}, "afterCommit": {"oid": "8f9443829d9393671117beda29dfba037372d507", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/8f9443829d9393671117beda29dfba037372d507", "committedDate": "2020-05-18T23:43:29Z", "message": "Add additional documentation on Batching and Grouping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f9443829d9393671117beda29dfba037372d507", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/8f9443829d9393671117beda29dfba037372d507", "committedDate": "2020-05-18T23:43:29Z", "message": "Add additional documentation on Batching and Grouping"}, "afterCommit": {"oid": "fcf4a1c998457c07a7986e0e36b14e9975be38bb", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/fcf4a1c998457c07a7986e0e36b14e9975be38bb", "committedDate": "2020-05-19T11:25:20Z", "message": "Add additional documentation on Batching and Grouping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "401fdc06c68e066d6f5b9fdfe200952a132df81e", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/401fdc06c68e066d6f5b9fdfe200952a132df81e", "committedDate": "2020-06-10T08:41:02Z", "message": "Merge the 2 stages 'Gather and Sort' and 'Create Batches'\n\nThere is minimal benefit in separating these 2 stages, and significant\nbenefity in merging them: Gather and Sort encodes incoming\nMutationGroups into a List<byte[]> which would contain up to 1GB.\nThis is then output (copied) to the CreateBatches where it is decoded\nback into MutationGroups.\n\nRemoving this encode/decode should save up to 2GB of RAM."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a74866ba56d92d9476006b7e40a0e0ff916748ca", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/a74866ba56d92d9476006b7e40a0e0ff916748ca", "committedDate": "2020-06-10T08:41:02Z", "message": "Add additional documentation on Batching and Grouping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcf4a1c998457c07a7986e0e36b14e9975be38bb", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/fcf4a1c998457c07a7986e0e36b14e9975be38bb", "committedDate": "2020-05-19T11:25:20Z", "message": "Add additional documentation on Batching and Grouping"}, "afterCommit": {"oid": "a74866ba56d92d9476006b7e40a0e0ff916748ca", "author": {"user": {"login": "nielm", "name": "Niel Markwick"}}, "url": "https://github.com/apache/beam/commit/a74866ba56d92d9476006b7e40a0e0ff916748ca", "committedDate": "2020-06-10T08:41:02Z", "message": "Add additional documentation on Batching and Grouping"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4108, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}