{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2OTYxMDkx", "number": 13277, "title": "[BEAM-10921] Add the UserPipelineTracker to track user pipelines for derived pipelines", "bodyText": "This code is a data structure to track which derived pipelines came from which user pipelines. Previous code to calculate this relationship erroneously used pipeline-specific PCollection ids. This makes the relationship explicit.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-11-06T20:19:34Z", "url": "https://github.com/apache/beam/pull/13277", "merged": true, "mergeCommit": {"oid": "b0dd257f4112d1e0abfe92b65ee82da8eaf20e5b"}, "closed": true, "closedAt": "2020-11-13T17:41:09Z", "author": {"login": "rohdesamuel"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ9pkGgH2gAyNTE2OTYxMDkxOjEyODljMGNhOTA0MjQ3YzdjOGU0YzU3YzA1MDE5MzI4MjI5ZWNiMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb6kQQgBqjM5OTA5OTY4MDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/1289c0ca904247c7c8e4c57c05019328229ecb04", "committedDate": "2020-11-06T21:14:57Z", "message": "[BEAM-10921] Add the DerivationTree to track derived pipelines from user pipelines."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c061dab274d6dc77fa1648aa1ccf0f6e5f05f417", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/c061dab274d6dc77fa1648aa1ccf0f6e5f05f417", "committedDate": "2020-11-06T20:09:21Z", "message": "[BEAM-10921] Add the DerivationTree to track derived pipelines from user pipelines."}, "afterCommit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/1289c0ca904247c7c8e4c57c05019328229ecb04", "committedDate": "2020-11-06T21:14:57Z", "message": "[BEAM-10921] Add the DerivationTree to track derived pipelines from user pipelines."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTI2NDky", "url": "https://github.com/apache/beam/pull/13277#pullrequestreview-525526492", "createdAt": "2020-11-06T22:10:49Z", "commit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjoxMDo0OVrOHu_HoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMjoxMDo0OVrOHu_HoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAzMDY4OA==", "bodyText": "Nit: should it be memorize?", "url": "https://github.com/apache/beam/pull/13277#discussion_r519030688", "createdAt": "2020-11-06T22:10:49Z", "author": {"login": "KevinGG"}, "path": "sdks/python/apache_beam/runners/interactive/derivation_tree.py", "diffHunk": "@@ -0,0 +1,136 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Class that tracks derived/pipeline fragments from user pipelines.\n+\n+For internal use only; no backwards-compatibility guarantees.\n+In the InteractiveRunner the design is to keep the user pipeline unchanged,\n+create a copy of the user pipeline, and modify the copy. When the derived\n+pipeline runs, there should only be per-user pipeline state. This makes sure\n+that derived pipelines can link back to the parent user pipeline.\n+\"\"\"\n+# pytype: skip-file\n+\n+\n+class DerivationTree:\n+  \"\"\"Tracks which pipelines are derived from user pipelines.\n+\n+  This data structure is similar to a disjoint set data structure. A derived\n+  pipeline can only have one parent user pipeline. A user pipeline can have many\n+  derived pipelines.\n+  \"\"\"\n+  class Node:\n+    \"\"\"Object to track the relationship between user to derived pipelines.\"\"\"\n+    def __init__(self):\n+      self.user_pipeline = None\n+      self.derived_pipelines = set()\n+\n+  def __init__(self):\n+    self._tree = {}\n+    self._pid_to_pipelines = {}\n+\n+  def __iter__(self):\n+    \"\"\"Iterates through all the user pipelines.\"\"\"\n+    for n in self._tree.values():\n+      yield n.user_pipeline\n+\n+  def _key(self, pipeline):\n+    return str(id(pipeline))\n+\n+  def clear(self):\n+    \"\"\"Clears the tree of all user and derived pipelines.\"\"\"\n+    self._tree.clear()\n+\n+  def get_pipeline(self, pid):\n+    \"\"\"Returns the pipeline corresponding to the given pipeline id.\"\"\"\n+    if pid in self._pid_to_pipelines:\n+      return self._pid_to_pipelines[pid]\n+    return None\n+\n+  def add_user_pipeline(self, p):\n+    \"\"\"Adds a user pipeline with an empty set of derived pipelines.\"\"\"\n+    self._memoize_pipieline(p)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTcwOTE0", "url": "https://github.com/apache/beam/pull/13277#pullrequestreview-525570914", "createdAt": "2020-11-07T00:40:59Z", "commit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDo0MDo1OVrOHvBgAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMDo0MDo1OVrOHvBgAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2OTY5Nw==", "bodyText": "What is the use case of this? I was wondering whether we could just implement this using a two-way map (i.e. map from user pipeline to multiple derived pipelines and from derived pipeline to user pipeline).", "url": "https://github.com/apache/beam/pull/13277#discussion_r519069697", "createdAt": "2020-11-07T00:40:59Z", "author": {"login": "davidyan74"}, "path": "sdks/python/apache_beam/runners/interactive/derivation_tree_test.py", "diffHunk": "@@ -0,0 +1,181 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+import apache_beam as beam\n+from apache_beam.runners.interactive.derivation_tree import DerivationTree\n+\n+\n+class DerivationTreeTest(unittest.TestCase):\n+  def test_getting_unknown_pid_returns_none(self):\n+    dt = DerivationTree()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(dt.get_pipeline(str(id(p))))\n+\n+  def test_getting_unknown_pipeline_returns_none(self):\n+    dt = DerivationTree()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(dt.get_user_pipeline(p))\n+\n+  def test_no_parent_returns_none(self):\n+    dt = DerivationTree()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+    orphan = beam.Pipeline()\n+\n+    dt.add_derived_pipeline(user, derived)\n+\n+    self.assertIsNone(dt.get_user_pipeline(orphan))\n+\n+  def test_get_user_pipeline_is_same(self):\n+    dt = DerivationTree()\n+\n+    p = beam.Pipeline()\n+    dt.add_user_pipeline(p)\n+\n+    self.assertIs(dt.get_user_pipeline(p), p)\n+\n+  def test_can_add_derived(self):\n+    dt = DerivationTree()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    dt.add_derived_pipeline(user, derived)\n+\n+    self.assertIs(dt.get_user_pipeline(derived), user)\n+\n+  def test_can_add_multiple_derived(self):\n+    \"\"\"Tests that there can be many user pipelines with many derived\n+    pipelines.\n+    \"\"\"\n+    dt = DerivationTree()\n+\n+    # Add the first set of user and derived pipelines.\n+    user1 = beam.Pipeline()\n+    derived11 = beam.Pipeline()\n+    derived12 = beam.Pipeline()\n+\n+    dt.add_derived_pipeline(user1, derived11)\n+    dt.add_derived_pipeline(user1, derived12)\n+\n+    # Add the second set of user and derived pipelines.\n+    user2 = beam.Pipeline()\n+    derived21 = beam.Pipeline()\n+    derived22 = beam.Pipeline()\n+\n+    dt.add_derived_pipeline(user2, derived21)\n+    dt.add_derived_pipeline(user2, derived22)\n+\n+    # Assert that the user pipelines are correct.\n+    self.assertIs(dt.get_user_pipeline(derived11), user1)\n+    self.assertIs(dt.get_user_pipeline(derived12), user1)\n+    self.assertIs(dt.get_user_pipeline(derived21), user2)\n+    self.assertIs(dt.get_user_pipeline(derived22), user2)\n+\n+  def test_cannot_have_multiple_parents(self):\n+    dt = DerivationTree()\n+\n+    user1 = beam.Pipeline()\n+    user2 = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    dt.add_derived_pipeline(user1, derived)\n+    dt.add_derived_pipeline(user2, derived)\n+\n+    self.assertIs(dt.get_user_pipeline(derived), user1)\n+\n+  def test_adding_derived_with_derived_gets_user_pipeline(self):\n+    \"\"\"Tests that one can correctly add a derived pipeline from a derived\n+    pipeline and still get the correct user pipeline.\n+    \"\"\"\n+    dt = DerivationTree()\n+\n+    user = beam.Pipeline()\n+    derived1 = beam.Pipeline()\n+    derived2 = beam.Pipeline()\n+\n+    # Add the first derived pipeline to the user pipelne.\n+    dt.add_derived_pipeline(user, derived1)\n+\n+    # Add the second derived pipeline to the first derived pipeline. This should\n+    # get the user pipeline of the first and add the second to it.\n+    dt.add_derived_pipeline(derived1, derived2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1289c0ca904247c7c8e4c57c05019328229ecb04"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1299cf9f8f492797bc135abb2bc3de0ffc3b6af6", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/1299cf9f8f492797bc135abb2bc3de0ffc3b6af6", "committedDate": "2020-11-09T22:01:31Z", "message": "Simplify DerivationTree implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/e549e3dcdad07e482125369530d60a991a0fe320", "committedDate": "2020-11-10T19:13:58Z", "message": "Rename DerivationTree to UserPipelineTracker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTM3MDI4", "url": "https://github.com/apache/beam/pull/13277#pullrequestreview-527537028", "createdAt": "2020-11-10T19:26:51Z", "commit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDI5MjYx", "url": "https://github.com/apache/beam/pull/13277#pullrequestreview-528429261", "createdAt": "2020-11-11T18:26:16Z", "commit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNjoxNlrOHxZNyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzozOTo0MFrOHxicEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NTQwMA==", "bodyText": "Nit: you can write this as self._pid_to_pipelines.get(pid, None)\n(nit, meaning not a must)", "url": "https://github.com/apache/beam/pull/13277#discussion_r521555400", "createdAt": "2020-11-11T18:26:16Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker.py", "diffHunk": "@@ -0,0 +1,132 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Class that tracks derived/pipeline fragments from user pipelines.\n+\n+For internal use only; no backwards-compatibility guarantees.\n+In the InteractiveRunner the design is to keep the user pipeline unchanged,\n+create a copy of the user pipeline, and modify the copy. When the derived\n+pipeline runs, there should only be per-user pipeline state. This makes sure\n+that derived pipelines can link back to the parent user pipeline.\n+\"\"\"\n+# pytype: skip-file\n+\n+\n+class UserPipelineTracker:\n+  \"\"\"Tracks user pipelines from derived pipelines.\n+\n+  This data structure is similar to a disjoint set data structure. A derived\n+  pipeline can only have one parent user pipeline. A user pipeline can have many\n+  derived pipelines.\n+  \"\"\"\n+  def __init__(self):\n+    self._user_pipelines = set()\n+    self._derived_pipelines = {}\n+    self._pid_to_pipelines = {}\n+\n+  def __iter__(self):\n+    \"\"\"Iterates through all the user pipelines.\"\"\"\n+    for p in self._user_pipelines:\n+      yield p\n+\n+  def _key(self, pipeline):\n+    return str(id(pipeline))\n+\n+  def clear(self):\n+    \"\"\"Clears the tracker of all user and derived pipelines.\"\"\"\n+    self._user_pipelines.clear()\n+    self._derived_pipelines.clear()\n+    self._pid_to_pipelines.clear()\n+\n+  def get_pipeline(self, pid):\n+    \"\"\"Returns the pipeline corresponding to the given pipeline id.\"\"\"\n+    if pid in self._pid_to_pipelines:\n+      return self._pid_to_pipelines[pid]\n+    return None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1OTM0OQ==", "bodyText": "could you add type annotations to these? that would help figure out when we're using the str(id()) and when the object itself, etc.\nWe're full on Python 3, so you can add them like here; https://docs.python.org/3/library/typing.html", "url": "https://github.com/apache/beam/pull/13277#discussion_r521559349", "createdAt": "2020-11-11T18:33:41Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker.py", "diffHunk": "@@ -0,0 +1,132 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Class that tracks derived/pipeline fragments from user pipelines.\n+\n+For internal use only; no backwards-compatibility guarantees.\n+In the InteractiveRunner the design is to keep the user pipeline unchanged,\n+create a copy of the user pipeline, and modify the copy. When the derived\n+pipeline runs, there should only be per-user pipeline state. This makes sure\n+that derived pipelines can link back to the parent user pipeline.\n+\"\"\"\n+# pytype: skip-file\n+\n+\n+class UserPipelineTracker:\n+  \"\"\"Tracks user pipelines from derived pipelines.\n+\n+  This data structure is similar to a disjoint set data structure. A derived\n+  pipeline can only have one parent user pipeline. A user pipeline can have many\n+  derived pipelines.\n+  \"\"\"\n+  def __init__(self):\n+    self._user_pipelines = set()\n+    self._derived_pipelines = {}\n+    self._pid_to_pipelines = {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwNDE0Mw==", "bodyText": "fwiw - I recommend you try to add typehints everywhere going forward. these will be super useful.", "url": "https://github.com/apache/beam/pull/13277#discussion_r521704143", "createdAt": "2020-11-11T23:36:10Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker.py", "diffHunk": "@@ -0,0 +1,132 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+\"\"\"Class that tracks derived/pipeline fragments from user pipelines.\n+\n+For internal use only; no backwards-compatibility guarantees.\n+In the InteractiveRunner the design is to keep the user pipeline unchanged,\n+create a copy of the user pipeline, and modify the copy. When the derived\n+pipeline runs, there should only be per-user pipeline state. This makes sure\n+that derived pipelines can link back to the parent user pipeline.\n+\"\"\"\n+# pytype: skip-file\n+\n+\n+class UserPipelineTracker:\n+  \"\"\"Tracks user pipelines from derived pipelines.\n+\n+  This data structure is similar to a disjoint set data structure. A derived\n+  pipeline can only have one parent user pipeline. A user pipeline can have many\n+  derived pipelines.\n+  \"\"\"\n+  def __init__(self):\n+    self._user_pipelines = set()\n+    self._derived_pipelines = {}\n+    self._pid_to_pipelines = {}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1OTM0OQ=="}, "originalCommit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwNTc3NQ==", "bodyText": "I wonder if this should throw an exception instead of silently failing?", "url": "https://github.com/apache/beam/pull/13277#discussion_r521705775", "createdAt": "2020-11-11T23:38:32Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker_test.py", "diffHunk": "@@ -0,0 +1,181 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+import apache_beam as beam\n+from apache_beam.runners.interactive.user_pipeline_tracker import UserPipelineTracker\n+\n+\n+class UserPipelineTrackerTest(unittest.TestCase):\n+  def test_getting_unknown_pid_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(ut.get_pipeline(str(id(p))))\n+\n+  def test_getting_unknown_pipeline_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(ut.get_user_pipeline(p))\n+\n+  def test_no_parent_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+    orphan = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user, derived)\n+\n+    self.assertIsNone(ut.get_user_pipeline(orphan))\n+\n+  def test_get_user_pipeline_is_same(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+    ut.add_user_pipeline(p)\n+\n+    self.assertIs(ut.get_user_pipeline(p), p)\n+\n+  def test_can_add_derived(self):\n+    ut = UserPipelineTracker()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user, derived)\n+\n+    self.assertIs(ut.get_user_pipeline(derived), user)\n+\n+  def test_can_add_multiple_derived(self):\n+    \"\"\"Tests that there can be many user pipelines with many derived\n+    pipelines.\n+    \"\"\"\n+    ut = UserPipelineTracker()\n+\n+    # Add the first set of user and derived pipelines.\n+    user1 = beam.Pipeline()\n+    derived11 = beam.Pipeline()\n+    derived12 = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user1, derived11)\n+    ut.add_derived_pipeline(user1, derived12)\n+\n+    # Add the second set of user and derived pipelines.\n+    user2 = beam.Pipeline()\n+    derived21 = beam.Pipeline()\n+    derived22 = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user2, derived21)\n+    ut.add_derived_pipeline(user2, derived22)\n+\n+    # Assert that the user pipelines are correct.\n+    self.assertIs(ut.get_user_pipeline(derived11), user1)\n+    self.assertIs(ut.get_user_pipeline(derived12), user1)\n+    self.assertIs(ut.get_user_pipeline(derived21), user2)\n+    self.assertIs(ut.get_user_pipeline(derived22), user2)\n+\n+  def test_cannot_have_multiple_parents(self):\n+    ut = UserPipelineTracker()\n+\n+    user1 = beam.Pipeline()\n+    user2 = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user1, derived)\n+    ut.add_derived_pipeline(user2, derived)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwNjUxNA==", "bodyText": "or perhaps the return value should communicate this somehow", "url": "https://github.com/apache/beam/pull/13277#discussion_r521706514", "createdAt": "2020-11-11T23:39:40Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker_test.py", "diffHunk": "@@ -0,0 +1,181 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+from __future__ import absolute_import\n+\n+import unittest\n+\n+import apache_beam as beam\n+from apache_beam.runners.interactive.user_pipeline_tracker import UserPipelineTracker\n+\n+\n+class UserPipelineTrackerTest(unittest.TestCase):\n+  def test_getting_unknown_pid_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(ut.get_pipeline(str(id(p))))\n+\n+  def test_getting_unknown_pipeline_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+\n+    self.assertIsNone(ut.get_user_pipeline(p))\n+\n+  def test_no_parent_returns_none(self):\n+    ut = UserPipelineTracker()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+    orphan = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user, derived)\n+\n+    self.assertIsNone(ut.get_user_pipeline(orphan))\n+\n+  def test_get_user_pipeline_is_same(self):\n+    ut = UserPipelineTracker()\n+\n+    p = beam.Pipeline()\n+    ut.add_user_pipeline(p)\n+\n+    self.assertIs(ut.get_user_pipeline(p), p)\n+\n+  def test_can_add_derived(self):\n+    ut = UserPipelineTracker()\n+\n+    user = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user, derived)\n+\n+    self.assertIs(ut.get_user_pipeline(derived), user)\n+\n+  def test_can_add_multiple_derived(self):\n+    \"\"\"Tests that there can be many user pipelines with many derived\n+    pipelines.\n+    \"\"\"\n+    ut = UserPipelineTracker()\n+\n+    # Add the first set of user and derived pipelines.\n+    user1 = beam.Pipeline()\n+    derived11 = beam.Pipeline()\n+    derived12 = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user1, derived11)\n+    ut.add_derived_pipeline(user1, derived12)\n+\n+    # Add the second set of user and derived pipelines.\n+    user2 = beam.Pipeline()\n+    derived21 = beam.Pipeline()\n+    derived22 = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user2, derived21)\n+    ut.add_derived_pipeline(user2, derived22)\n+\n+    # Assert that the user pipelines are correct.\n+    self.assertIs(ut.get_user_pipeline(derived11), user1)\n+    self.assertIs(ut.get_user_pipeline(derived12), user1)\n+    self.assertIs(ut.get_user_pipeline(derived21), user2)\n+    self.assertIs(ut.get_user_pipeline(derived22), user2)\n+\n+  def test_cannot_have_multiple_parents(self):\n+    ut = UserPipelineTracker()\n+\n+    user1 = beam.Pipeline()\n+    user2 = beam.Pipeline()\n+    derived = beam.Pipeline()\n+\n+    ut.add_derived_pipeline(user1, derived)\n+    ut.add_derived_pipeline(user2, derived)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwNTc3NQ=="}, "originalCommit": {"oid": "e549e3dcdad07e482125369530d60a991a0fe320"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDkxNjc1", "url": "https://github.com/apache/beam/pull/13277#pullrequestreview-529491675", "createdAt": "2020-11-12T20:58:05Z", "commit": {"oid": "51c3e244a5ff05fda3422b99dbd9709322da89a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDo1ODowNVrOHyOGdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDo1ODowNVrOHyOGdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQyMTg3Ng==", "bodyText": "these would be Dict[str, beam.Pipeline], right?", "url": "https://github.com/apache/beam/pull/13277#discussion_r522421876", "createdAt": "2020-11-12T20:58:05Z", "author": {"login": "pabloem"}, "path": "sdks/python/apache_beam/runners/interactive/user_pipeline_tracker.py", "diffHunk": "@@ -34,31 +38,29 @@ class UserPipelineTracker:\n   derived pipelines.\n   \"\"\"\n   def __init__(self):\n-    self._user_pipelines = set()\n-    self._derived_pipelines = {}\n-    self._pid_to_pipelines = {}\n+    self._user_pipelines: set[beam.Pipeline] = set()\n+    self._derived_pipelines: map[beam.Pipeline] = {}\n+    self._pid_to_pipelines: map[beam.Pipeline] = {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51c3e244a5ff05fda3422b99dbd9709322da89a7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69eb580230ef372fc1c2334cd0f0fe431262c1a5", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/69eb580230ef372fc1c2334cd0f0fe431262c1a5", "committedDate": "2020-11-12T22:46:54Z", "message": "Add type annotations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51c3e244a5ff05fda3422b99dbd9709322da89a7", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/51c3e244a5ff05fda3422b99dbd9709322da89a7", "committedDate": "2020-11-12T01:02:38Z", "message": "Add type annotations"}, "afterCommit": {"oid": "69eb580230ef372fc1c2334cd0f0fe431262c1a5", "author": {"user": {"login": "rohdesamuel", "name": "Sam sam"}}, "url": "https://github.com/apache/beam/commit/69eb580230ef372fc1c2334cd0f0fe431262c1a5", "committedDate": "2020-11-12T22:46:54Z", "message": "Add type annotations"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4710, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}