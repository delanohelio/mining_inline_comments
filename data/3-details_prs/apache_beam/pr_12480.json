{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTQ4NDEx", "number": 12480, "title": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper", "bodyText": "This enables to look for location in BigQueryWrapper for first available referenced table for the user. If you are querying authorised view, you may end up with permission error of accessing referenced table that is in authorised view and be unable to retrieve location, so you should look on next available table for You that you should have permission.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-08-06T10:50:03Z", "url": "https://github.com/apache/beam/pull/12480", "merged": true, "mergeCommit": {"oid": "82a7f62cc9b80504d5a296ec7a26d9cfaf2583a2"}, "closed": true, "closedAt": "2020-08-07T15:48:59Z", "author": {"login": "galuszkak"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8NuRrgBqjM2Mjg1MTkwMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8W1KXgBqjM2MzA5MzA2MTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "deefdb3e1fd2e7de9d6f5e7c33d911a04937f6de", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/deefdb3e1fd2e7de9d6f5e7c33d911a04937f6de", "committedDate": "2020-08-06T10:42:35Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}, "afterCommit": {"oid": "5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "committedDate": "2020-08-06T11:00:24Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/5fca0c359a4f3d15a3e34e16f8022f62ea2df1a7", "committedDate": "2020-08-06T11:00:24Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}, "afterCommit": {"oid": "1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "committedDate": "2020-08-06T11:06:45Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/1f8f392082ef6c474195a22ef5d62f6c4c3d449b", "committedDate": "2020-08-06T11:06:45Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}, "afterCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "committedDate": "2020-08-06T11:54:09Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzIwMzU5", "url": "https://github.com/apache/beam/pull/12480#pullrequestreview-462720359", "createdAt": "2020-08-06T17:15:38Z", "commit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzoxNTozOFrOG88vQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzoyMjoyNlrOG89Dhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2Mjg4MA==", "bodyText": "Is implied by the for loop and can be dropped.", "url": "https://github.com/apache/beam/pull/12480#discussion_r466562880", "createdAt": "2020-08-06T17:15:38Z", "author": {"login": "apilloud"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzcyNw==", "bodyText": "This error message is slightly wrong now. How about: Query %s does not reference any tables you have permission to inspect.", "url": "https://github.com/apache/beam/pull/12480#discussion_r466563727", "createdAt": "2020-08-06T17:17:13Z", "author": {"login": "apilloud"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None\n-      table = referenced_tables[0]\n-      location = self.get_table_location(\n-          table.projectId, table.datasetId, table.tableId)\n-      _LOGGER.info(\n-          \"Using location %r from table %r referenced by query %s\",\n-          location,\n-          table,\n-          query)\n-      return location\n+      for table in referenced_tables:\n+        try:\n+          location = self.get_table_location(\n+              table.projectId, table.datasetId, table.tableId)\n+        except HttpForbiddenError:\n+          # Permission access for table (i.e. from authorized_view),\n+          # try next one\n+          continue\n+        _LOGGER.info(\n+            \"Using location %r from table %r referenced by query %s\",\n+            location,\n+            table,\n+            query)\n+        return location\n \n     _LOGGER.debug(\"Query %s does not reference any tables.\", query)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2ODA3MQ==", "bodyText": "(@pabloem is this something we want to do?)", "url": "https://github.com/apache/beam/pull/12480#discussion_r466568071", "createdAt": "2020-08-06T17:22:26Z", "author": {"login": "apilloud"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools_test.py", "diffHunk": "@@ -50,6 +49,15 @@\n from apache_beam.io.gcp.internal.clients import bigquery\n from apache_beam.options.pipeline_options import PipelineOptions\n \n+# Protect against environments where bigquery library is not available.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODg5MTIy", "url": "https://github.com/apache/beam/pull/12480#pullrequestreview-462889122", "createdAt": "2020-08-06T21:28:11Z", "commit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMToyODoxMlrOG9E3mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTozMDozNFrOG9E7jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NjA4OA==", "bodyText": "@apilloud comment suggest that is also guarding against None value. If that's true, dropping this if, would break code for loop in case referenced_tables is actually None.\nTherefore my question is, are you sure we want to remove that if?", "url": "https://github.com/apache/beam/pull/12480#discussion_r466696088", "createdAt": "2020-08-06T21:28:12Z", "author": {"login": "galuszkak"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2Mjg4MA=="}, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NjIwNA==", "bodyText": "@apilloud will change it. Thanks for pointing this out.", "url": "https://github.com/apache/beam/pull/12480#discussion_r466696204", "createdAt": "2020-08-06T21:28:28Z", "author": {"login": "galuszkak"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools.py", "diffHunk": "@@ -318,15 +319,20 @@ def get_query_location(self, project_id, query, use_legacy_sql):\n \n     referenced_tables = response.statistics.query.referencedTables\n     if referenced_tables:  # Guards against both non-empty and non-None\n-      table = referenced_tables[0]\n-      location = self.get_table_location(\n-          table.projectId, table.datasetId, table.tableId)\n-      _LOGGER.info(\n-          \"Using location %r from table %r referenced by query %s\",\n-          location,\n-          table,\n-          query)\n-      return location\n+      for table in referenced_tables:\n+        try:\n+          location = self.get_table_location(\n+              table.projectId, table.datasetId, table.tableId)\n+        except HttpForbiddenError:\n+          # Permission access for table (i.e. from authorized_view),\n+          # try next one\n+          continue\n+        _LOGGER.info(\n+            \"Using location %r from table %r referenced by query %s\",\n+            location,\n+            table,\n+            query)\n+        return location\n \n     _LOGGER.debug(\"Query %s does not reference any tables.\", query)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2MzcyNw=="}, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NzEwMQ==", "bodyText": "@apilloud this is copy from bigquery_test.py I assumed we want this consistent between files.", "url": "https://github.com/apache/beam/pull/12480#discussion_r466697101", "createdAt": "2020-08-06T21:30:34Z", "author": {"login": "galuszkak"}, "path": "sdks/python/apache_beam/io/gcp/bigquery_tools_test.py", "diffHunk": "@@ -50,6 +49,15 @@\n from apache_beam.io.gcp.internal.clients import bigquery\n from apache_beam.options.pipeline_options import PipelineOptions\n \n+# Protect against environments where bigquery library is not available.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2ODA3MQ=="}, "originalCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "committedDate": "2020-08-06T21:36:14Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/dfdcd2e8aa5de52fe103648393d9d2e3f0f4a782", "committedDate": "2020-08-06T11:54:09Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}, "afterCommit": {"oid": "c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "author": {"user": {"login": "galuszkak", "name": "Kamil Ga\u0142uszka"}}, "url": "https://github.com/apache/beam/commit/c31d2e14ef5ea67df0ca53d6329c5956c86c5efa", "committedDate": "2020-08-06T21:36:14Z", "message": "[BEAM-10647] Fixes get_query_location bug in BigQueryWrapper"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3757, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}