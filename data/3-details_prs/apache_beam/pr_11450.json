{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Mjk5NjAw", "number": 11450, "title": "[BEAM-9779] Patch HL7v2IOWriteIT Flakiness", "bodyText": "Use TestPipeline in ITs\nDrop schematized data before calling message ingest (should be output only) to help pipelines that read/write from/to two HL7v2 stores\nMake HL7v2MessageCoder constructor public\n\nPlease add a meaningful description for your change here\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nApex\nDataflow\nFlink\nGearpump\nSamza\nSpark\n\n\n\n\nGo\n\n---\n---\n\n---\n---\n\n\n\nJava\n\n\n\n\n\n\n\n\n\nPython\n\n---\n\n\n---\n---\n\n\n\nXLang\n---\n---\n---\n\n---\n---\n\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-04-17T19:20:57Z", "url": "https://github.com/apache/beam/pull/11450", "merged": true, "mergeCommit": {"oid": "81d7cbe53364da65329069152d9d7a66b21df278"}, "closed": true, "closedAt": "2020-04-27T21:48:09Z", "author": {"login": "jaketf"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYmS7gAH2gAyNDA1Mjk5NjAwOmY0N2E5Nzc0NzU1MDMyZDAyNTc1Zjc2NTdkNTg0MzkxNmY0N2RhYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcby-tPgH2gAyNDA1Mjk5NjAwOmQ4MDEwN2VkY2Q4ZjRkOWU4NWFiMGNjZjExMDU1MDA3MmEyYzkxMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f47a9774755032d02575f7657d5843916f47dac9", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/f47a9774755032d02575f7657d5843916f47dac9", "committedDate": "2020-04-17T19:17:20Z", "message": "Patches for HL7v2IO\n\n* Use TestPipeline in ITs\n* Drop schematized data before calling message ingest (should be output only) to help pipelines that read/write from/to two HL7v2 stores\n* Make HL7v2MessageCoder constructor public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ab1818c2399ad56be585ccbc30f882c1b32693", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/55ab1818c2399ad56be585ccbc30f882c1b32693", "committedDate": "2020-04-17T20:15:36Z", "message": "block on run"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzQ4OTkw", "url": "https://github.com/apache/beam/pull/11450#pullrequestreview-395748990", "createdAt": "2020-04-17T20:22:12Z", "commit": {"oid": "f47a9774755032d02575f7657d5843916f47dac9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoyMjoxMlrOGHb9QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMDoyMjoxMlrOGHb9QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ1MTI2NQ==", "bodyText": "I could add\npipeline.getOptions().as(DirectOptions.class).setBlockOnRun(true);\nBut I think this is the same as pipeline.run().waitUntilFinish(); for batch pipelines which I already use.", "url": "https://github.com/apache/beam/pull/11450#discussion_r410451265", "createdAt": "2020-04-17T20:22:12Z", "author": {"login": "jaketf"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOWriteIT.java", "diffHunk": "@@ -46,6 +45,8 @@\n   private static final String HL7V2_STORE_NAME =\n       \"hl7v2_store_write_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n \n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f47a9774755032d02575f7657d5843916f47dac9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96d8e93032c3f61373012bea02c3febe53312c81", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/96d8e93032c3f61373012bea02c3febe53312c81", "committedDate": "2020-04-17T20:45:25Z", "message": "add sleep to avoid flakiness due to asyncronous HL7v2 indexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1bbaea69187fe5f2a0e0f04e1af27f5528bb2f2a", "committedDate": "2020-04-17T23:51:33Z", "message": "E2E integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6ede0a8e60d6e7557a15a41d5baf4aaadbe784a8", "committedDate": "2020-04-17T23:55:27Z", "message": "fix merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a23ef7efd9706e3b5f33c35b22213f84963e50", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/40a23ef7efd9706e3b5f33c35b22213f84963e50", "committedDate": "2020-04-17T23:57:48Z", "message": "reconcile double sleeping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "194cf3e719b778ff5a4baf737134b00b8c601591", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/194cf3e719b778ff5a4baf737134b00b8c601591", "committedDate": "2020-04-20T23:42:17Z", "message": "improve error hanlding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/7af97ddd2cec2f05faeaf3b49d7b495b72e2d7e4", "committedDate": "2020-04-20T23:44:49Z", "message": "improve error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/6f86186e41c23a18d51036f24bb548d88efeac50", "committedDate": "2020-04-21T00:19:30Z", "message": "fix docs typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTA0MDA2", "url": "https://github.com/apache/beam/pull/11450#pullrequestreview-398504006", "createdAt": "2020-04-22T19:22:23Z", "commit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxOToyMjoyM1rOGKHIPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxOToyOToxNVrOGKHYjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1NTc0Mg==", "bodyText": "Seems like read and write sections are unrelated. Should these be two different tests ?\nAlternatively we can convert this to a single \"write and then read pipeline\" where data needed for the read step are generated in the write step (and remove data generation in the setUp method.", "url": "https://github.com/apache/beam/pull/11450#discussion_r413255742", "createdAt": "2020-04-22T19:22:23Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Test\n+  public void testHL7v2IOE2E() throws Exception {\n+    HL7v2IO.Read.Result readResult =\n+        pipeline\n+            .apply(\n+                new ListHL7v2MessageIDs(\n+                    Collections.singletonList(\n+                        healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME)))\n+            .apply(HL7v2IO.getAll());\n+\n+    PCollection<Long> numReadMessages =\n+        readResult.getMessages().setCoder(new HL7v2MessageCoder()).apply(Count.globally());\n+    PAssert.thatSingleton(numReadMessages).isEqualTo((long) MESSAGES.size());\n+    PAssert.that(readResult.getFailedReads()).empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1ODQ1OA==", "bodyText": "How do we know that 5000 is enough ? If not the test will be flaky.", "url": "https://github.com/apache/beam/pull/11450#discussion_r413258458", "createdAt": "2020-04-22T19:26:46Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOTestUtil.java", "diffHunk": "@@ -91,10 +92,13 @@ static void deleteAllHL7v2Messages(HealthcareApiClient client, String hl7v2Store\n   }\n \n   /** Populate the test messages into the HL7v2 store. */\n-  static void writeHL7v2Messages(HealthcareApiClient client, String hl7v2Store) throws IOException {\n+  static void writeHL7v2Messages(HealthcareApiClient client, String hl7v2Store)\n+      throws IOException, InterruptedException {\n     for (HL7v2Message msg : MESSAGES) {\n       client.createHL7v2Message(hl7v2Store, msg.toModel());\n     }\n+    // [BEAM-9779] HL7v2 indexing is asyncronous. Add sleep to stabilize this IT.\n+    Sleeper.DEFAULT.sleep(5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI1OTkxOQ==", "bodyText": "Does the store name here uniquely identify the set of data being deleted (just to confirm) ?", "url": "https://github.com/apache/beam/pull/11450#discussion_r413259919", "createdAt": "2020-04-22T19:29:15Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f86186e41c23a18d51036f24bb548d88efeac50"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766e6fd64af3d17b75e551f1e25dd1aad428e018", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/766e6fd64af3d17b75e551f1e25dd1aad428e018", "committedDate": "2020-04-22T20:02:10Z", "message": "add latency distribution metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e989ec4601df842d377bdc15c53a1324a474de3f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/e989ec4601df842d377bdc15c53a1324a474de3f", "committedDate": "2020-04-22T20:03:38Z", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16399f1494e2071cee97fadaf56dc21a9eefbed3", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/16399f1494e2071cee97fadaf56dc21a9eefbed3", "committedDate": "2020-04-22T21:41:01Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef3a33c532535873ee8029a27e2656929ac2e1f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/9ef3a33c532535873ee8029a27e2656929ac2e1f", "committedDate": "2020-04-22T22:16:06Z", "message": "Merge branch 'metrics/HL7v2IO' into patch/HL7v2IO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b576636f99f006c5738481ff72f06c576c46d0", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/c8b576636f99f006c5738481ff72f06c576c46d0", "committedDate": "2020-04-22T22:21:16Z", "message": "ingest only data and labels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/50ba3d8da29f4d4522b29468aa01b800ad96b5e9", "committedDate": "2020-04-22T22:26:08Z", "message": "fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461b7cd79ece7cf27fb24032fb89cb3616d439ef", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/461b7cd79ece7cf27fb24032fb89cb3616d439ef", "committedDate": "2020-04-22T22:55:14Z", "message": "call spliterator directly, use page size 1000"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2602b477a8ebe535fe3060d643cbef45f0e2892", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/b2602b477a8ebe535fe3060d643cbef45f0e2892", "committedDate": "2020-04-22T23:29:10Z", "message": "output elements more eagerly in ListHL72MessageFn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1503fd4600654064e608e3c98c6e9e9b0de20560", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/1503fd4600654064e608e3c98c6e9e9b0de20560", "committedDate": "2020-04-23T23:43:42Z", "message": "eagerly emit data from early pages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/5f9bad7c1c9df7c004f0f4f67185a3d5099a351f", "committedDate": "2020-04-24T00:51:47Z", "message": "Optimization of Listing and Stablization of ITs\n\n* allow HL7v2 Message listing to emit early panes rather than waiting on pagination of all list results\n* add EBO on HL7v2 Message listing reaching a certain expected length in ITs to account for async indexing BEAM-9779"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDYzODQ2", "url": "https://github.com/apache/beam/pull/11450#pullrequestreview-401063846", "createdAt": "2020-04-27T15:25:40Z", "commit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNToyNTo0MVrOGMpH2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNTozNDoxNlrOGMpklQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwOTg0OA==", "bodyText": "This is a pretty large sleep for a single test. Java post commit test suite is run pretty regularly with limited Jenkins resources so I suggest adding a separate test suite for HI7v2 tests and removing this and any other tests that need large sleeps from general Java post-commit test suite.", "url": "https://github.com/apache/beam/pull/11450#discussion_r415909848", "createdAt": "2020-04-27T15:25:41Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/HttpHealthcareApiClient.java", "diffHunk": "@@ -127,6 +114,7 @@ public ListMessagesResponse makeHL7v2ListRequest(\n             .messages()\n             .list(hl7v2Store)\n             .set(\"view\", \"full\")\n+            .setPageSize(1000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxMzM3Ng==", "bodyText": "Ditto. I suggest moving tests that require a large sleep to a new test suite.", "url": "https://github.com/apache/beam/pull/11450#discussion_r415913376", "createdAt": "2020-04-27T15:29:53Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import java.util.concurrent.TimeoutException;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;\n+import org.apache.beam.sdk.values.PCollection;\n+import org.joda.time.Duration;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * This should catch that we read {@link HL7v2Message} with schematized data but do not fail inserts\n+ * with schematized data which should be output only.\n+ */\n+@RunWith(JUnit4.class)\n+public class HL7v2IOReadWriteIT {\n+\n+  private transient HealthcareApiClient client;\n+  private static String healthcareDataset;\n+  private static final String BASE =\n+      \"hl7v2_store_rw_it_\" + System.currentTimeMillis() + \"_\" + (new SecureRandom().nextInt(32));\n+  private static final String INPUT_HL7V2_STORE_NAME = BASE + \"INPUT\";\n+  private static final String OUTPUT_HL7V2_STORE_NAME = BASE + \"OUTPUT\";\n+\n+  @Rule public transient TestPipeline pipeline = TestPipeline.create();\n+\n+  @BeforeClass\n+  public static void createHL7v2tores() throws IOException {\n+    String project = TestPipeline.testingPipelineOptions().as(GcpOptions.class).getProject();\n+    healthcareDataset = String.format(HEALTHCARE_DATASET_TEMPLATE, project);\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.createHL7v2Store(healthcareDataset, INPUT_HL7V2_STORE_NAME);\n+    client.createHL7v2Store(healthcareDataset, OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @AfterClass\n+  public static void deleteHL7v2tores() throws IOException {\n+    HealthcareApiClient client = new HttpHealthcareApiClient();\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+    client.deleteHL7v2Store(healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Before\n+  public void setup() throws Exception {\n+    if (client == null) {\n+      client = new HttpHealthcareApiClient();\n+    }\n+\n+    // Create HL7 messages and write them to HL7v2 Store.\n+    writeHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    deleteAllHL7v2Messages(client, healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME);\n+  }\n+\n+  @Test\n+  public void testHL7v2IOE2E() throws Exception {\n+    HL7v2IO.Read.Result readResult =\n+        pipeline\n+            .apply(\n+                new ListHL7v2MessageIDs(\n+                    Collections.singletonList(\n+                        healthcareDataset + \"/hl7V2Stores/\" + INPUT_HL7V2_STORE_NAME)))\n+            .apply(HL7v2IO.getAll());\n+\n+    PCollection<Long> numReadMessages =\n+        readResult.getMessages().setCoder(new HL7v2MessageCoder()).apply(Count.globally());\n+    PAssert.thatSingleton(numReadMessages).isEqualTo((long) MESSAGES.size());\n+    PAssert.that(readResult.getFailedReads()).empty();\n+\n+    HL7v2IO.Write.Result writeResult =\n+        readResult\n+            .getMessages()\n+            .apply(\n+                HL7v2IO.ingestMessages(\n+                    healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME));\n+\n+    PAssert.that(writeResult.getFailedInsertsWithErr()).empty();\n+\n+    pipeline.run().waitUntilFinish();\n+\n+    try {\n+      HL7v2IOTestUtil.waitForHL7v2Indexing(\n+          client,\n+          healthcareDataset + \"/hl7V2Stores/\" + OUTPUT_HL7V2_STORE_NAME,\n+          MESSAGES.size(),\n+          Duration.standardMinutes(10));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxNzIwNQ==", "bodyText": "Can we please defer adding these new tests till we are sure that the changes to fix flakyness actually fix the immediate issue. Also can you please send additional changes that are not related to BEAM https://issues.apache.org/jira/browse/BEAM-9779 as a separate PR and mention the correct JIRA.", "url": "https://github.com/apache/beam/pull/11450#discussion_r415917205", "createdAt": "2020-04-27T15:34:16Z", "author": {"login": "chamikaramj"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadWriteIT.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.beam.sdk.io.gcp.healthcare;\n+\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.HEALTHCARE_DATASET_TEMPLATE;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.MESSAGES;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.deleteAllHL7v2Messages;\n+import static org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.writeHL7v2Messages;\n+\n+import java.io.IOException;\n+import java.security.SecureRandom;\n+import java.util.Collections;\n+import java.util.concurrent.TimeoutException;\n+import org.apache.beam.sdk.extensions.gcp.options.GcpOptions;\n+import org.apache.beam.sdk.io.gcp.healthcare.HL7v2IOTestUtil.ListHL7v2MessageIDs;\n+import org.apache.beam.sdk.testing.PAssert;\n+import org.apache.beam.sdk.testing.TestPipeline;\n+import org.apache.beam.sdk.transforms.Count;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f9bad7c1c9df7c004f0f4f67185a3d5099a351f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee771ba18e22ea82518702130fc66113c3deeee4", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/ee771ba18e22ea82518702130fc66113c3deeee4", "committedDate": "2020-04-27T16:40:26Z", "message": "revert unrelated changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b33499457fb1be8990967921cc1864a1963d2b", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/d0b33499457fb1be8990967921cc1864a1963d2b", "committedDate": "2020-04-27T16:44:13Z", "message": "add back test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTM4MTU0", "url": "https://github.com/apache/beam/pull/11450#pullrequestreview-401138154", "createdAt": "2020-04-27T16:48:03Z", "commit": {"oid": "d0b33499457fb1be8990967921cc1864a1963d2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjo0ODowNFrOGMtQ3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjo0ODowNFrOGMtQ3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3NzY5NA==", "bodyText": "these tests are actually redundant with the non-deleted testHL7v2IO_ListHL7v2Messages and testHL7v2IO_ListHL7v2Messages_filtered", "url": "https://github.com/apache/beam/pull/11450#discussion_r415977694", "createdAt": "2020-04-27T16:48:04Z", "author": {"login": "jaketf"}, "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/HL7v2IOReadIT.java", "diffHunk": "@@ -86,36 +86,6 @@ public void tearDown() throws Exception {\n     deleteAllHL7v2Messages(this.client, healthcareDataset + \"/hl7V2Stores/\" + HL7V2_STORE_NAME);\n   }\n \n-  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b33499457fb1be8990967921cc1864a1963d2b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92af30086895e564a272eb3743bd32971c2795a2", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/92af30086895e564a272eb3743bd32971c2795a2", "committedDate": "2020-04-27T16:55:02Z", "message": "Add constant for HL7v2 indexing timeout minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a01e7d04dabd607f246aac219304254ed8bd975e", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/a01e7d04dabd607f246aac219304254ed8bd975e", "committedDate": "2020-04-27T16:55:26Z", "message": "Add constant for HL7v2 indexing timeout minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80107edcd8f4d9e85ab0ccf110550072a2c9111", "author": {"user": null}, "url": "https://github.com/apache/beam/commit/d80107edcd8f4d9e85ab0ccf110550072a2c9111", "committedDate": "2020-04-27T17:45:47Z", "message": "fix checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4287, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}