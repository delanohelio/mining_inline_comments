{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NDE0NDQ0", "number": 12241, "title": "[BEAM-10420] Fix minor race condition related to splitting that will cause None has no method 'yyy'", "bodyText": "This will also be important to have this lock when splitting/getting progress for window observing splittable DoFns.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n---\n---\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\n\n\n\n\nNon-portable\n\n\n\n\n\n\nPortable\n---\n\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.", "createdAt": "2020-07-13T18:18:54Z", "url": "https://github.com/apache/beam/pull/12241", "merged": true, "mergeCommit": {"oid": "a9d70fed9069c4f4e9a12860ef711652f5f9c21a"}, "closed": true, "closedAt": "2020-07-14T20:42:30Z", "author": {"login": "lukecwik"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0ld0UAH2gAyNDQ4NDE0NDQ0OjNhZjAyNTJlNWY0MTM3MmZmYWEzY2Y1ZThjMjZkOTUzY2E5ZjJlZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc06St-gFqTQ0ODM1NzI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3af0252e5f41372ffaa3cf5e8c26d953ca9f2efc", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/3af0252e5f41372ffaa3cf5e8c26d953ca9f2efc", "committedDate": "2020-07-13T18:09:12Z", "message": "[BEAM-10420] Fix minor race condition related to splitting that will cause None has no method 'yyy'\n\nThis will be important to have this lock when splitting/getting progress for window observing splittable DoFns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60", "committedDate": "2020-07-13T19:31:22Z", "message": "fixup! Make sure that splitting_lock is defined for cython also fix possible self doesn't have splitting_lock in try_split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14f5914e7ee88fbead6abb1cd8994d8188c273d2", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/14f5914e7ee88fbead6abb1cd8994d8188c273d2", "committedDate": "2020-07-13T22:45:02Z", "message": "fixup!"}, "afterCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60", "author": {"user": {"login": "lukecwik", "name": "Lukasz Cwik"}}, "url": "https://github.com/apache/beam/commit/79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60", "committedDate": "2020-07-13T19:31:22Z", "message": "fixup! Make sure that splitting_lock is defined for cython also fix possible self doesn't have splitting_lock in try_split"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4Mjk0NjY2", "url": "https://github.com/apache/beam/pull/12241#pullrequestreview-448294666", "createdAt": "2020-07-14T16:59:51Z", "commit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjo1OTo1MVrOGxcxyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMzo0NFrOGxc6wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNDkwNA==", "bodyText": "Are you trying to deep-copy current_windowed_value, threadsafe_restriction_tracker  and threadsafe_watermark_estimator ? If so, we need to do it explicitly copy.deepcopy.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454504904", "createdAt": "2020-07-14T16:59:51Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTcwMg==", "bodyText": "Would it be better to both check threadsafe_restriction_tracker  and threadsafe_watermark_estimator for easy reading?", "url": "https://github.com/apache/beam/pull/12241#discussion_r454505702", "createdAt": "2020-07-14T17:01:06Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:\n+      # Make a local reference to member variables that change references during\n+      # processing under lock before attempting to split so we have a consistent\n+      # view of all the references.\n+      current_windowed_value = self.current_windowed_value\n+      threadsafe_restriction_tracker = self.threadsafe_restriction_tracker\n+      threadsafe_watermark_estimator = self.threadsafe_watermark_estimator\n+\n+    if threadsafe_restriction_tracker:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNzIwMA==", "bodyText": "If we are deep copying objects, it seems like we can use the lock to guard the copying logic only, instead of the entire split logic.", "url": "https://github.com/apache/beam/pull/12241#discussion_r454507200", "createdAt": "2020-07-14T17:03:44Z", "author": {"login": "boyuanzz"}, "path": "sdks/python/apache_beam/runners/common.py", "diffHunk": "@@ -842,29 +847,37 @@ def _invoke_process_per_window(self,\n \n   def try_split(self, fraction):\n     # type: (...) -> Optional[Tuple[SplitResultPrimary, SplitResultResidual]]\n-    if self.threadsafe_restriction_tracker and self.current_windowed_value:\n+    if not self.is_splittable:\n+      return None\n+\n+    with self.splitting_lock:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzU3MjQ2", "url": "https://github.com/apache/beam/pull/12241#pullrequestreview-448357246", "createdAt": "2020-07-14T18:25:05Z", "commit": {"oid": "79b5bfb5e9afcfea6ee2663a7d690b44e3f0aa60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4075, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}