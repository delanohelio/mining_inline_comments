{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODI5Mzkx", "number": 13549, "title": "[BEAM-11196] Fix `None` parent when fusing >2 stages", "bodyText": "Fixes a bug introduced by #13202 where the parent for a fused stage (or packed combiner) gets set to None if more than two stages are fused (or packed). This occurs because _lowest_common_ancestor uses the subtransforms field of the PipelineContext's transforms to figure out parent-child relationships. However, a stage that is created by fusion or by another optimizer phase will not be present in the PipelineContext's transforms. As a result, such a stage is passed to _lowest_common_ancestor, it will return None. This change fixes it by additionally using the parent field of the input stages.\nThis bug only affects runners that use translations.pipeline_from_stages with partial=True.\n\nThank you for your contribution! Follow this checklist to help us incorporate your contribution quickly and easily:\n\n Choose reviewer(s) and mention them in a comment (R: @username).\n Format the pull request title like [BEAM-XXX] Fixes bug in ApproximateQuantiles, where you replace BEAM-XXX with the appropriate JIRA issue, if applicable. This will automatically link the pull request to the issue.\n Update CHANGES.md with noteworthy changes.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.\n\nSee the Contributor Guide for more tips on how to make review process smoother.\nPost-Commit Tests Status (on master branch)\n\n\n\nLang\nSDK\nDataflow\nFlink\nSamza\nSpark\nTwister2\n\n\n\n\nGo\n\n---\n\n---\n\n---\n\n\nJava\n\n\n\n\n\n\n\n\nPython\n\n\n\n---\n\n---\n\n\nXLang\n\n\n\n---\n\n---\n\n\n\nPre-Commit Tests Status (on master branch)\n\n\n\n---\nJava\nPython\nGo\nWebsite\nWhitespace\nTypescript\n\n\n\n\nNon-portable\n\n \n\n\n\n\n\n\nPortable\n---\n\n---\n---\n---\n---\n\n\n\nSee .test-infra/jenkins/README for trigger phrase, status and link of all Jenkins jobs.\nGitHub Actions Tests Status (on master branch)\n\n\n\nSee CI.md for more information about GitHub Actions CI.", "createdAt": "2020-12-14T22:05:06Z", "url": "https://github.com/apache/beam/pull/13549", "merged": true, "mergeCommit": {"oid": "52a227020d289f7e091b3c42fdc7cf1485fbf547"}, "closed": true, "closedAt": "2020-12-15T00:24:13Z", "author": {"login": "yifanmai"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmM_M1gH2gAyNTM5ODI5MzkxOjBkMTUyNWJjNjBjYmMxNDFmYjE0NDM3NDQwOTY4MDUzMWI1NzE2NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmOV0yAFqTU1MTk3OTEzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0d1525bc60cbc141fb144374409680531b571662", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/0d1525bc60cbc141fb144374409680531b571662", "committedDate": "2020-12-14T21:54:15Z", "message": "[BEAM-11196] Fix parent of fused stage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a1c026836b7e4e27ef91e208f3828f87d9cb0c", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/f4a1c026836b7e4e27ef91e208f3828f87d9cb0c", "committedDate": "2020-12-14T22:11:46Z", "message": "Lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4333a3d9334073f75c762f44c6e2ce98910e58a4", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/4333a3d9334073f75c762f44c6e2ce98910e58a4", "committedDate": "2020-12-14T22:28:20Z", "message": "type annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4aaf4631435250d185fb5ec1db9491194577c43", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/f4aaf4631435250d185fb5ec1db9491194577c43", "committedDate": "2020-12-14T22:34:49Z", "message": "Fix type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d363416b296f81445be4c4197c854546b58fb394", "author": {"user": {"login": "yifanmai", "name": "Yifan Mai"}}, "url": "https://github.com/apache/beam/commit/d363416b296f81445be4c4197c854546b58fb394", "committedDate": "2020-12-14T23:02:23Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTc0Mjc5", "url": "https://github.com/apache/beam/pull/13549#pullrequestreview-551974279", "createdAt": "2020-12-14T23:18:17Z", "commit": {"oid": "d363416b296f81445be4c4197c854546b58fb394"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzoxODoxN1rOIFxBEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzoxODoxN1rOIFxBEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNjg4MA==", "bodyText": "Is there a case where the parent's parent is not correctly set?", "url": "https://github.com/apache/beam/pull/13549#discussion_r542916880", "createdAt": "2020-12-14T23:18:17Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -1217,23 +1215,33 @@ def get_ancestors(name):\n \n \n def _parent_for_fused_stages(stages, context):\n-  # type: (Iterable[Optional[str]], TransformContext) -> Optional[str]\n+  # type: (Iterable[Stage], TransformContext) -> Optional[str]\n \n   '''Returns the name of the new parent for the fused stages.\n \n   The new parent is the lowest common ancestor of the fused stages that is not\n   contained in the set of stages to be fused. The provided context is used to\n   compute ancestors of stages.\n   '''\n+\n+  parents = context.parents_map()\n+  # If any of the input stages were produced by fusion or an optimizer phase,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d363416b296f81445be4c4197c854546b58fb394"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTc5MTM5", "url": "https://github.com/apache/beam/pull/13549#pullrequestreview-551979139", "createdAt": "2020-12-14T23:28:44Z", "commit": {"oid": "d363416b296f81445be4c4197c854546b58fb394"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzoyODo0NFrOIFxTKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMzoyODo0NFrOIFxTKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkyMTUxMg==", "bodyText": "Ack. Thanks for the clarification.", "url": "https://github.com/apache/beam/pull/13549#discussion_r542921512", "createdAt": "2020-12-14T23:28:44Z", "author": {"login": "robertwb"}, "path": "sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py", "diffHunk": "@@ -1217,23 +1215,33 @@ def get_ancestors(name):\n \n \n def _parent_for_fused_stages(stages, context):\n-  # type: (Iterable[Optional[str]], TransformContext) -> Optional[str]\n+  # type: (Iterable[Stage], TransformContext) -> Optional[str]\n \n   '''Returns the name of the new parent for the fused stages.\n \n   The new parent is the lowest common ancestor of the fused stages that is not\n   contained in the set of stages to be fused. The provided context is used to\n   compute ancestors of stages.\n   '''\n+\n+  parents = context.parents_map()\n+  # If any of the input stages were produced by fusion or an optimizer phase,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxNjg4MA=="}, "originalCommit": {"oid": "d363416b296f81445be4c4197c854546b58fb394"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4426, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}