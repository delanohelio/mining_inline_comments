{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MjI3NTU5", "number": 114, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0MzoyNVrOESOblQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNToxMVrOESOogw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ2MjYxOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/current_assignments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0MzoyNVrOG3SsEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0MzoyNVrOG3SsEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMTA1OQ==", "bodyText": "Remove space before rcp.reservation_name", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460631059", "createdAt": "2020-07-27T03:43:25Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/current_assignments.sql", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the current reservation\n+ * assignments and associated slot capacities\n+ */\n+\n+-- This table retrieves the latest slot capacity for each reservation\n+WITH latest_slot_capacity as (\n+ SELECT\n+   rcp.reservation_name, rcp.slot_capacity\n+ FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ2NzAwOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/current_assignments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0NjowOVrOG3SuYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0NjowOVrOG3SuYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMTY0OQ==", "bodyText": "Indent by two spaces\ngo/sqlstyle#joins", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460631649", "createdAt": "2020-07-27T03:46:09Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/current_assignments.sql", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the current reservation\n+ * assignments and associated slot capacities\n+ */\n+\n+-- This table retrieves the latest slot capacity for each reservation\n+WITH latest_slot_capacity as (\n+ SELECT\n+   rcp.reservation_name, rcp.slot_capacity\n+ FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name ) )\n+-- Extract information about current assignments\n+SELECT\n+  acp.assignment_id,\n+  acp.project_id,\n+  acp.reservation_name,\n+  acp.job_type,\n+  acp.assignee_id,\n+  acp.assignee_type,\n+  lsc.slot_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.ASSIGNMENT_CHANGES_BY_PROJECT AS acp\n+-- Join to obtain the current slot capacities\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  lsc.reservation_name = acp.reservation_name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3MDkxOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo0OTowMVrOG3SwlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MjozMFrOG3SzjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjIxMw==", "bodyText": "We shouldn't nest WITH statements as it makes the logic hard to follow. Instead prefer to place the statement for commitments above the WITH statement for results.\ngo/sqlstyle#with-clause", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632213", "createdAt": "2020-07-27T03:49:01Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjk3Mw==", "bodyText": "Additionally, check your indentation inside the WITH statement", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632973", "createdAt": "2020-07-27T03:52:30Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjIxMw=="}, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3Mzc5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MDo0N1rOG3SyHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MDo0N1rOG3SyHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjYwNA==", "bodyText": "Check your formatting\ngo/sqlstyle#line-wrapping", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632604", "createdAt": "2020-07-27T03:50:47Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3NDI0OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MTowNFrOG3SyXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MTowNFrOG3SyXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjY2OQ==", "bodyText": "Check your formatting\ngo/sqlstyle#line-wrapping", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632669", "createdAt": "2020-07-27T03:51:04Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3NDg5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MTozMVrOG3SyuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MTozMVrOG3SyuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMjc2MQ==", "bodyText": "This looks like it'll fit on a single line", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460632761", "createdAt": "2020-07-27T03:51:31Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3NzI2OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MzoxMlrOG3S0Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1MzoxMlrOG3S0Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzA5NA==", "bodyText": "days is the start of a new WITH statement and should be on a separate line", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633094", "createdAt": "2020-07-27T03:53:12Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ3ODg2OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1NDoyMFrOG3S07w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1NDoyMFrOG3S07w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzMyNw==", "bodyText": "It doesn't look like this SELECT should be indented because it's outside the WITH statements", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633327", "createdAt": "2020-07-27T03:54:20Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (\n+-- This subquery is used to fill in the missing days between a commitment\n+-- starting and ending so that it can be graphed properly.\n+    SELECT day\n+    FROM (\n+      SELECT\n+        start_date,\n+        stop_date\n+      FROM results\n+    ), UNNEST(GENERATE_DATE_ARRAY(start_date, stop_date)) day\n+  )\n+  SELECT TIMESTAMP(day) as date, LAST_VALUE(slot_cummulative IGNORE NULLS) OVER(ORDER BY day) slots,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ4MTMzOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/daily_commitments.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1NTo0MVrOG3S2Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1NTo0MVrOG3S2Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzY1OA==", "bodyText": "Indent ON\ngo/sqlstyle#joins", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460633658", "createdAt": "2020-07-27T03:55:41Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/daily_commitments.sql", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Daily Utilization Report: Returns the slot count for active monthly and\n+ * annual capacity commitments for each day since the first commitment\n+ * was purchased.\n+ */\n+\n+-- This table limits the results to a single entry per day (the latest)\n+WITH results AS (\n+-- This table extracts the commitment history and computes the cumulative\n+-- slot count\n+WITH commitments AS (\n+SELECT\n+  change_timestamp,\n+  commitment_plan,\n+  action,\n+  EXTRACT(DATE\n+  FROM\n+    change_timestamp) AS start_date,\n+  -- Compute the stop date of a commitment by looking at the following\n+  -- change_timestamp and subtracting one day. This works because monthly\n+  -- and yearly commitments cannot be deleted on the same day\n+  -- they were created.\n+  IFNULL(LEAD(DATE_SUB(EXTRACT(DATE\n+        FROM\n+          change_timestamp), INTERVAL 1 DAY)) OVER (PARTITION BY state ORDER BY change_timestamp),\n+    CURRENT_DATE()) AS stop_date,\n+  -- In order to calculate the cumulative slots up to this point, add\n+  -- the slot count of new commitments (indicated by an UPDATE action)\n+  -- and subtract the slot count of deleted commitments\n+  SUM(CASE\n+      WHEN cccp.action = 'UPDATE' THEN cccp.slot_count\n+        ELSE\n+      cccp.slot_count * -1\n+  END\n+    )\n+  -- Cumulative slots are tracked by their state and carried over from\n+  -- previous rows\n+  OVER (PARTITION BY state ORDER BY change_timestamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS slot_cummulative,\n+  -- In the event that multiple changes occurred in one day, we keep track\n+  -- of the most recent cumulative value by using row numbers\n+  ROW_NUMBER() OVER (PARTITION BY EXTRACT(DATE FROM change_timestamp) ORDER BY change_timestamp DESC) AS rn\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.CAPACITY_COMMITMENT_CHANGES_BY_PROJECT AS cccp\n+-- In this case, we only want to look at active commitments that are\n+-- monthly or annual, not flex\n+WHERE\n+  state = 'ACTIVE'\n+  AND commitment_plan != 'FLEX'\n+ORDER BY\n+  change_timestamp\n+)\n+-- Take only the most recent value for any given day\n+SELECT * FROM commitments WHERE rn = 1 ), days AS (\n+-- This subquery is used to fill in the missing days between a commitment\n+-- starting and ending so that it can be graphed properly.\n+    SELECT day\n+    FROM (\n+      SELECT\n+        start_date,\n+        stop_date\n+      FROM results\n+    ), UNNEST(GENERATE_DATE_ARRAY(start_date, stop_date)) day\n+  )\n+  SELECT TIMESTAMP(day) as date, LAST_VALUE(slot_cummulative IGNORE NULLS) OVER(ORDER BY day) slots,\n+FROM days\n+-- Join these results with the cumulative slot count values for each day\n+LEFT JOIN results\n+ON day = DATE(change_timestamp)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ4NzUyOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1OTozNVrOG3S5tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1OTozNVrOG3S5tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDU0OA==", "bodyText": "Put LEAD on a newline", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634548", "createdAt": "2020-07-27T03:59:35Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ4ODM3OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDowNVrOG3S6JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDowNVrOG3S6JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDY2MQ==", "bodyText": "Remove space before rcp.reservation_name", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634661", "createdAt": "2020-07-27T04:00:05Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ4OTIyOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDozOFrOG3S6nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDozOFrOG3S6nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDc4MA==", "bodyText": "Indent 2 spaces", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634780", "createdAt": "2020-07-27T04:00:38Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ4OTUzOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDo1MFrOG3S6yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMDo1MFrOG3S6yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNDgyNw==", "bodyText": "Indent 2 spaces", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460634827", "createdAt": "2020-07-27T04:00:50Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5MjY5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzoxMVrOG3S8mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzoxMVrOG3S8mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTI4OA==", "bodyText": "Place BETWEEN on new line indented by 2 spaces. Indent AND the same\ngo/sqlstyle#between", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635288", "createdAt": "2020-07-27T04:03:11Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 31 days ago but completed 30 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 31 DAY)\n+  AND CURRENT_TIMESTAMP()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5Mjg3OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_month.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzoyMVrOG3S8sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzoyMVrOG3S8sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTMxNA==", "bodyText": "Same as above", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635314", "createdAt": "2020-07-27T04:03:21Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_month.sql", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 30 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last month and dividing by the number of milliseconds\n+  -- in a month\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30) AS average_monthly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 30)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 31 days ago but completed 30 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 31 DAY)\n+  AND CURRENT_TIMESTAMP()\n+  AND jbo.end_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 30 DAY)\n+  AND CURRENT_TIMESTAMP()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5MzMzOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzo0N1rOG3S9Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowMzo0N1rOG3S9Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTM5NA==", "bodyText": "Place LEAD on the next line", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635394", "createdAt": "2020-07-27T04:03:47Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5Mzc5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDoxMVrOG3S9SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDoxMVrOG3S9SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTQ2NQ==", "bodyText": "Remove space before rcp.reservation_name", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635465", "createdAt": "2020-07-27T04:04:11Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5NDU5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDozNlrOG3S9tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDozNlrOG3S9tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTU3NA==", "bodyText": "Indent by 2 spaces", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635574", "createdAt": "2020-07-27T04:04:36Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5NDc3OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDo0MVrOG3S9yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNDo0MVrOG3S9yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTU5NQ==", "bodyText": "Indent by 2 spaces", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635595", "createdAt": "2020-07-27T04:04:41Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5NTU5OnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNTowM1rOG3S-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNTowM1rOG3S-Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTY5MA==", "bodyText": "Place BETWEEN on new line indented by 2 spaces. Indent AND the same\ngo/sqlstyle#between", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635690", "createdAt": "2020-07-27T04:05:03Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 8 days ago but completed 7 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 8 DAY)\n+  AND CURRENT_TIMESTAMP()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTQ5NTcxOnYy", "diffSide": "RIGHT", "path": "views/system_tables/sql/reservation_utilization_week.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNToxMVrOG3S-Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNDowNToxMVrOG3S-Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzNTcxMA==", "bodyText": "Same as above", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/114#discussion_r460635710", "createdAt": "2020-07-27T04:05:11Z", "author": {"login": "ryanmcdowell"}, "path": "views/system_tables/sql/reservation_utilization_week.sql", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * It is assumed that the following query will be run in the administration\n+ * project where the reservations were created. If this is not the case,\n+ * prepend the project id to the table name as follows:\n+ * `{project_id}`.`region-{region_name}`.INFORMATION_SCHEMA.{table}\n+ */\n+\n+/*\n+ * Reservation Utilization Report: Returns the average usage, average\n+ * capacity, current capacity, and average utilization of a reservation\n+ * for the last 7 days\n+ */\n+\n+-- This table retrieves the slot capacity history of every reservation\n+-- including the start and end time of that capacity\n+WITH reservation_slot_capacity AS (\n+  SELECT\n+    -- Concatenation is needed as RESERVATION_CHANGES_BY_PROJECT only\n+    -- includes reservation name but in order to join with\n+    -- JOBS_BY_ORGANIZATION, reservation id is required\n+    CONCAT(\"{project_id}:{location}.\", reservation_name) AS reservation_id,\n+    change_timestamp AS start_time,\n+    IFNULL(LEAD(change_timestamp) OVER (PARTITION BY reservation_name ORDER BY change_timestamp ASC),\n+      CURRENT_TIMESTAMP()) AS end_time,\n+    action,\n+    slot_capacity\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT ),\n+  -- This table retrieves only the current slot capacity of a reservation\n+  latest_slot_capacity AS (\n+  SELECT\n+    rcp.reservation_name,\n+    rcp.slot_capacity,\n+    CONCAT(\"{project_id}:{location}.\", rcp.reservation_name) AS reservation_id,\n+  FROM\n+    `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT AS rcp\n+  WHERE\n+    -- This subquery returns the latest slot capacity for each reservation\n+    -- by extracting the reservation with the maximum timestamp\n+    ( rcp.reservation_name, rcp.change_timestamp) IN (\n+      SELECT AS STRUCT reservation_name, MAX(change_timestamp)\n+      FROM\n+        `region-{region_name}`.INFORMATION_SCHEMA.RESERVATION_CHANGES_BY_PROJECT\n+      GROUP BY\n+        reservation_name)\n+ )\n+-- Compute the average slot utilization and average reservation utilization\n+SELECT\n+  jbo.reservation_id,\n+  -- Slot usage is calculated by aggregating total_slot_ms for all jobs\n+  -- in the last week and dividing by the number of milliseconds in a week\n+  SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7) AS average_weekly_slot_usage,\n+  AVG(rsc.slot_capacity) AS average_reservation_capacity,\n+  (SUM(jbo.total_slot_ms) / (1000 * 60 * 60 * 24 * 7)) / AVG(rsc.slot_capacity) AS reservation_utilization,\n+  lsc.slot_capacity AS latest_capacity\n+FROM\n+  `region-{region_name}`.INFORMATION_SCHEMA.JOBS_BY_ORGANIZATION jbo\n+-- Join the slot capacity history\n+LEFT JOIN\n+  reservation_slot_capacity rsc\n+ON\n+  jbo.reservation_id = rsc.reservation_id\n+  AND jbo.creation_time >= rsc.start_time\n+  AND jbo.creation_time < rsc.end_time\n+-- Join the latest slot capacity\n+LEFT JOIN\n+  latest_slot_capacity lsc\n+ON\n+  jbo.reservation_id = lsc.reservation_id\n+WHERE\n+  -- Includes jobs created 8 days ago but completed 7 days ago\n+  jbo.creation_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 8 DAY)\n+  AND CURRENT_TIMESTAMP()\n+  AND jbo.end_time BETWEEN TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)\n+  AND CURRENT_TIMESTAMP()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "723ee4143ba5cb93cfd2e3538482fe51f8c423e0"}, "originalPosition": 91}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3056, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}