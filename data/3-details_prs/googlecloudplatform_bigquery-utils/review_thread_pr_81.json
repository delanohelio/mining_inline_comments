{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMDI5Mjk4", "number": 81, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0MjoyMVrOEL0fBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1ODo0M1rOEML0CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODI5NzAxOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0MjoyMVrOGtkv6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0MjoyMVrOGtkv6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MTE5NA==", "bodyText": "nit: Visits method scope from an Antlr visitor**.** (with periods)", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450441194", "createdAt": "2020-07-06T19:42:21Z", "author": {"login": "kikkyo"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -20,6 +24,42 @@ class DataFlowEngine {\n             .map { QueryUsages(it.key, it.value.sorted()) }\n     }\n \n+    /**\n+     * Visits method scope from an Antlr visitor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODMxMzMwOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0ODowOFrOGtk6Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo0ODowOFrOGtk6Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0MzgzNA==", "bodyText": "nit: This comment is intentionally leave there for debugging purpose?\nIf just for logging, should we use LOGGER.log (if there is a log method :)).. and we should use \"Add method parameter $paramName.\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450443834", "createdAt": "2020-07-06T19:48:08Z", "author": {"login": "kikkyo"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -20,6 +24,42 @@ class DataFlowEngine {\n             .map { QueryUsages(it.key, it.value.sorted()) }\n     }\n \n+    /**\n+     * Visits method scope from an Antlr visitor\n+     *\n+     * @param[visitChildren] function to visit the rest of the method\n+     */\n+    fun visitMethod(visitChildren: () -> Unit) {\n+        visitScope(visitChildren)\n+    }\n+\n+    /**\n+     * Associates [paramName] as a method argument for the most recently called [visitMethod]\n+     */\n+    fun addMethodParameter(paramName: String) {\n+        LOGGER.debug(\"add method parameter $paramName\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODMyMTgyOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo1MTowMVrOGtk_dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMTo0MToxNVrOGtsT6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0NTE3Mg==", "bodyText": "nit: in java we usually just use interface Map<QueryFragment, Set> = HashMap() if it is the same in kotlin..", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450445172", "createdAt": "2020-07-06T19:51:01Z", "author": {"login": "kikkyo"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -3,12 +3,16 @@ package com.google.cloud.sqlecosystem.sqlextraction\n import com.google.cloud.sqlecosystem.sqlextraction.output.Location\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryUsages\n+import mu.KotlinLogging\n+\n+private val LOGGER = KotlinLogging.logger { }\n \n /**\n  * Backend engine for running data-flow analysis\n+ *\n  * @see FrontEnd\n  */\n-class DataFlowEngine {\n+class DataFlowEngine(private val environment: Environment = Environment()) {\n     private val queryUsages: HashMap<QueryFragment, HashSet<Location>> = HashMap()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NTA5Ng==", "bodyText": "Map is immutable in Kotlin, but I can change it to MutableMap", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450565096", "createdAt": "2020-07-07T01:41:15Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -3,12 +3,16 @@ package com.google.cloud.sqlecosystem.sqlextraction\n import com.google.cloud.sqlecosystem.sqlextraction.output.Location\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryUsages\n+import mu.KotlinLogging\n+\n+private val LOGGER = KotlinLogging.logger { }\n \n /**\n  * Backend engine for running data-flow analysis\n+ *\n  * @see FrontEnd\n  */\n-class DataFlowEngine {\n+class DataFlowEngine(private val environment: Environment = Environment()) {\n     private val queryUsages: HashMap<QueryFragment, HashSet<Location>> = HashMap()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0NTE3Mg=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODMyNDMwOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOTo1MTo1NFrOGtlBBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMTozOToxN1rOGtsSDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0NTU3NQ==", "bodyText": "Is this a global logger? should this be inside the class?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450445575", "createdAt": "2020-07-06T19:51:54Z", "author": {"login": "kikkyo"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -3,12 +3,16 @@ package com.google.cloud.sqlecosystem.sqlextraction\n import com.google.cloud.sqlecosystem.sqlextraction.output.Location\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryUsages\n+import mu.KotlinLogging\n+\n+private val LOGGER = KotlinLogging.logger { }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NDYyMw==", "bodyText": "This was suggested by the framework as the preferred way of obtaining a logger. Otherwise, it increases boilerplate code.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450564623", "createdAt": "2020-07-07T01:39:17Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/DataFlowEngine.kt", "diffHunk": "@@ -3,12 +3,16 @@ package com.google.cloud.sqlecosystem.sqlextraction\n import com.google.cloud.sqlecosystem.sqlextraction.output.Location\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n import com.google.cloud.sqlecosystem.sqlextraction.output.QueryUsages\n+import mu.KotlinLogging\n+\n+private val LOGGER = KotlinLogging.logger { }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0NTU3NQ=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODQwNTkwOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoyMDo0M1rOGtlz_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODozMDo0MlrOGuKtIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1ODYyMQ==", "bodyText": "Should we use init block instead?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450458621", "createdAt": "2020-07-06T20:20:43Z", "author": {"login": "kikkyo"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU2NjIxMA==", "bodyText": "That would execute for the other compiler as well, which is redundant. It might look cleaner though.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r450566210", "createdAt": "2020-07-07T01:45:56Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1ODYyMQ=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA2MzA3Mg==", "bodyText": "Update: using init would break any code using the constructor without arguments.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451063072", "createdAt": "2020-07-07T18:30:42Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1ODYyMQ=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjA3NDYyOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0NjoxNVrOGuJNWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0NjoxNVrOGuJNWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzODU1NA==", "bodyText": "The name reachingDefs is less than ideal for me. I would use something like variableUsage or variableReference.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451038554", "createdAt": "2020-07-07T17:46:15Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjA4MDk2OnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0ODowNlrOGuJRSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0ODowNlrOGuJRSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzOTU2MQ==", "bodyText": "I prefer name isVariableDeclaredInScope.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451039561", "createdAt": "2020-07-07T17:48:06Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjA4NTA3OnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0OToyMVrOGuJUHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0OToyMVrOGuJUHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0MDI4NA==", "bodyText": "I prefer name like getVariableUsage or getVariableReference", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451040284", "createdAt": "2020-07-07T17:49:21Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjA5MjM2OnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1MToyMVrOGuJYlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1MToyMVrOGuJYlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0MTQzMA==", "bodyText": "Similarly, getVariableUsageOrDefault or getVariableReferenceOrDefault.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451041430", "createdAt": "2020-07-07T17:51:21Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {\n+        return if (hasVariableInScope(varName)) {\n+            reachingDefs[varName]\n+        } else {\n+            parentScope!!.getVariable(varName)\n+        }\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     * [default] is returned if variable doesn't exist in any reachable scope.\n+     */\n+    fun getVariableOrDefault(varName: String, default: QueryFragment? = null): QueryFragment? {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjEwMTM3OnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1Mzo1MFrOGuJeQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMjoxOVrOGuJyGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0Mjg4MQ==", "bodyText": "Seems parentScope!!.getVariableOrDefault(varName) should be parentScope!!.getVariableOrDefault(varName, default)?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451042881", "createdAt": "2020-07-07T17:53:50Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {\n+        return if (hasVariableInScope(varName)) {\n+            reachingDefs[varName]\n+        } else {\n+            parentScope!!.getVariable(varName)\n+        }\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     * [default] is returned if variable doesn't exist in any reachable scope.\n+     */\n+    fun getVariableOrDefault(varName: String, default: QueryFragment? = null): QueryFragment? {\n+        return when {\n+            hasVariableInScope(varName) -> reachingDefs[varName]\n+            parentScope != null -> parentScope!!.getVariableOrDefault(varName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0Nzk2MQ==", "bodyText": "Oh oops, thanks for pointing that out!", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451047961", "createdAt": "2020-07-07T18:02:19Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {\n+        return if (hasVariableInScope(varName)) {\n+            reachingDefs[varName]\n+        } else {\n+            parentScope!!.getVariable(varName)\n+        }\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     * [default] is returned if variable doesn't exist in any reachable scope.\n+     */\n+    fun getVariableOrDefault(varName: String, default: QueryFragment? = null): QueryFragment? {\n+        return when {\n+            hasVariableInScope(varName) -> reachingDefs[varName]\n+            parentScope != null -> parentScope!!.getVariableOrDefault(varName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0Mjg4MQ=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjExOTEyOnYy", "diffSide": "RIGHT", "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1ODo0M1rOGuJpng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMzowNFrOGuJzvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NTc5MA==", "bodyText": "Will setVariable be called multiple times for the same variable?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451045790", "createdAt": "2020-07-07T17:58:43Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {\n+        return if (hasVariableInScope(varName)) {\n+            reachingDefs[varName]\n+        } else {\n+            parentScope!!.getVariable(varName)\n+        }\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     * [default] is returned if variable doesn't exist in any reachable scope.\n+     */\n+    fun getVariableOrDefault(varName: String, default: QueryFragment? = null): QueryFragment? {\n+        return when {\n+            hasVariableInScope(varName) -> reachingDefs[varName]\n+            parentScope != null -> parentScope!!.getVariableOrDefault(varName)\n+            else -> default\n+        }\n+    }\n+\n+    /**\n+     * Overwrites the possible queries for the variable [varName] existing in the most recent scope.\n+     * Variable needs to be defined first to be set.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun setVariable(varName: String, query: QueryFragment?) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0ODM4Mw==", "bodyText": "Yes, it will be recursively called until the correct scope is found.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/81#discussion_r451048383", "createdAt": "2020-07-07T18:03:04Z", "author": {"login": "creativitRy"}, "path": "tools/sql_extraction/src/main/kotlin/Environment.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+/**\n+ * A mapping from variable name to all possible query fragment values\n+ */\n+class Environment {\n+    private var parentScope: Environment?\n+    private var reachingDefs: HashMap<String, QueryFragment?>\n+\n+    constructor() {\n+        this.parentScope = null\n+        this.reachingDefs = HashMap()\n+    }\n+\n+    private constructor(copy: Environment) {\n+        this.parentScope = copy.parentScope\n+        this.reachingDefs = copy.reachingDefs\n+    }\n+\n+    /**\n+     * Declare [varName] as a newly declared variable. Its initial reaching query is null.\n+     * [setVariable] only runs successfully for declared variables.\n+     */\n+    fun declareVariable(varName: String) {\n+        reachingDefs[varName] = null\n+    }\n+\n+    /**\n+     * Checks whether a variable of name [varName] was declared in this current scope.\n+     *\n+     * @return true if variable was declared in this scope\n+     */\n+    fun hasVariableInScope(varName: String): Boolean {\n+        return varName in reachingDefs\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun getVariable(varName: String): QueryFragment? {\n+        return if (hasVariableInScope(varName)) {\n+            reachingDefs[varName]\n+        } else {\n+            parentScope!!.getVariable(varName)\n+        }\n+    }\n+\n+    /**\n+     * Gets all possible queries for the variable [varName].\n+     * Variable can be declared in any reachable scope.\n+     * [default] is returned if variable doesn't exist in any reachable scope.\n+     */\n+    fun getVariableOrDefault(varName: String, default: QueryFragment? = null): QueryFragment? {\n+        return when {\n+            hasVariableInScope(varName) -> reachingDefs[varName]\n+            parentScope != null -> parentScope!!.getVariableOrDefault(varName)\n+            else -> default\n+        }\n+    }\n+\n+    /**\n+     * Overwrites the possible queries for the variable [varName] existing in the most recent scope.\n+     * Variable needs to be defined first to be set.\n+     *\n+     * @throws[NullPointerException] if variable does not exist\n+     */\n+    fun setVariable(varName: String, query: QueryFragment?) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NTc5MA=="}, "originalCommit": {"oid": "9aa1ae850f04d813e2b5d3babbd1c7adc7b08c0e"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2979, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}