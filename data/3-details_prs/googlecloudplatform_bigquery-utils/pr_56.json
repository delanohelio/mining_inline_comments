{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MjE4MjM3", "number": 56, "title": "Create big_query_elt_script_logging.sql", "bodyText": "This view parses job events related to ETL processes from the newer Stackdriver audit logs", "createdAt": "2020-05-06T16:59:06Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56", "merged": true, "mergeCommit": {"oid": "5a8d97cec94ac1ca898238b409bcb07dc7196c58"}, "closed": true, "closedAt": "2020-08-19T03:42:55Z", "author": {"login": "NamrataShah5"}, "timelineItems": {"totalCount": 193, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyD1mCgH2gAyNDE0MjE4MjM3OjFhMjU4NDRhZmQ2MjY2MDVkNzkzYjNkZWIxOTE0MGEzMjBiZmZmM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAS9puAFqTQ3MDA5Nzc4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a25844afd626605d793b3deb19140a320bfff3a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1a25844afd626605d793b3deb19140a320bfff3a", "committedDate": "2020-07-05T21:50:33Z", "message": "Update big_query_elt_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95d03ea477a8a46726d9bb957f3e754addb8c8de", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/95d03ea477a8a46726d9bb957f3e754addb8c8de", "committedDate": "2020-07-05T21:58:48Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb04436a5d5e14eae4b254f383e120becfc76210", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/eb04436a5d5e14eae4b254f383e120becfc76210", "committedDate": "2020-07-05T21:59:44Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e047aeaee95a349fd01145eb8828053036b0697d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e047aeaee95a349fd01145eb8828053036b0697d", "committedDate": "2020-07-05T22:16:17Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d4773d489aa4a7f15c1d10e648f0bc107ef968", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d8d4773d489aa4a7f15c1d10e648f0bc107ef968", "committedDate": "2020-07-05T22:17:53Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b48134b7817703c4080155024b9a08bc95e76c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/52b48134b7817703c4080155024b9a08bc95e76c", "committedDate": "2020-07-05T22:25:53Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e930b031b33d1c65f10997b5e27a56f01a9f0271", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e930b031b33d1c65f10997b5e27a56f01a9f0271", "committedDate": "2020-07-05T22:26:47Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7250cf70e45760a4c4307b267a6cd22a22856c7", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d7250cf70e45760a4c4307b267a6cd22a22856c7", "committedDate": "2020-07-05T22:53:23Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd620817fd9af3f4fbc7bd3e6c9ea4395d7d133", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9fd620817fd9af3f4fbc7bd3e6c9ea4395d7d133", "committedDate": "2020-07-05T22:58:47Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fff23c481d252a69250a4dd0b6cad9b4aadf5ae", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7fff23c481d252a69250a4dd0b6cad9b4aadf5ae", "committedDate": "2020-07-05T23:50:00Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d230819c069eb04f93d7b8610e9c1db274007e25", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d230819c069eb04f93d7b8610e9c1db274007e25", "committedDate": "2020-07-08T20:45:33Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c4e0bb7c8cc01e88315a4eedac3e00b1b6311c3", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9c4e0bb7c8cc01e88315a4eedac3e00b1b6311c3", "committedDate": "2020-07-08T20:49:23Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22503a0d7153dacd02e26f53cc69bf8a0dbca78d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/22503a0d7153dacd02e26f53cc69bf8a0dbca78d", "committedDate": "2020-07-08T20:51:53Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d0d7e7b21af62f7db5986d7b50ff6dc6bfe5a2c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9d0d7e7b21af62f7db5986d7b50ff6dc6bfe5a2c", "committedDate": "2020-07-08T21:02:58Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fec956a93306e5567c2200ff851e626ac299d40", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/2fec956a93306e5567c2200ff851e626ac299d40", "committedDate": "2020-07-08T21:04:08Z", "message": "Rename big_query_elt_audit_log_v2.sql to big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "019edf90495f68c308d4fb10fce780d3c7455292", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/019edf90495f68c308d4fb10fce780d3c7455292", "committedDate": "2020-07-08T21:10:08Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd43952f384bc35b1952fbff0f196cd4447cd59", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ecd43952f384bc35b1952fbff0f196cd4447cd59", "committedDate": "2020-07-08T21:32:56Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53a099227a90a1f3ee910e1ddf76dba536c8b77", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a53a099227a90a1f3ee910e1ddf76dba536c8b77", "committedDate": "2020-07-08T21:33:47Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00dc79a469112fcfbb68c28a925a969a3c654ac3", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/00dc79a469112fcfbb68c28a925a969a3c654ac3", "committedDate": "2020-07-09T01:54:52Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9942642082e51ada4939ecec75e9716f6401cb", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3c9942642082e51ada4939ecec75e9716f6401cb", "committedDate": "2020-07-09T21:54:27Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0dad5479fc21a5f250190884201bfc0beb4e4c9", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b0dad5479fc21a5f250190884201bfc0beb4e4c9", "committedDate": "2020-07-09T22:18:22Z", "message": "Update README.md\n\nAdded another sample usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ccf42acb7626e430e3f0753a31cec82475472d3", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4ccf42acb7626e430e3f0753a31cec82475472d3", "committedDate": "2020-07-09T22:18:38Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84fbb52b9ab9b9eba5bc9603dab2def30413b451", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/84fbb52b9ab9b9eba5bc9603dab2def30413b451", "committedDate": "2020-07-09T22:19:28Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8de3d1446716237e0f8eb2024317205a595f8552", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8de3d1446716237e0f8eb2024317205a595f8552", "committedDate": "2020-07-09T22:20:11Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/bac516f0e9b8793547f74a9bf257ecc63f4b0114", "committedDate": "2020-07-09T22:33:55Z", "message": "Update README.md\n\nUpdated with purpose of script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjA4MDAz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-446608003", "createdAt": "2020-07-10T18:24:33Z", "commit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODoyNDozM1rOGwBJHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODoyNDozM1rOGwBJHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwMzU0OQ==", "bodyText": "missing comma at end", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r453003549", "createdAt": "2020-07-10T18:24:33Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,785 @@\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    COALESCE(\n+      CONCAT(\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+        \":\",\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+      ),\n+      CONCAT(\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+        \":\",\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+      )\n+    ) AS jobId,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName')) AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.jobState'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.jobState')\n+    ) AS jobStatusJobState,\n+    SPLIT(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult'),JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.code')),\"/\")[SAFE_OFFSET(1)],\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.code'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.code')\n+    ) AS jobStatusErrorResultCode,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.message'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.message')\n+    ) AS jobStatusErrorResultMessage,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.details'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.details')\n+    ) AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errors'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors')\n+      ),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errors'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors')\n+      ),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobInsertion.job.jobStats.createTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime'))\n+    ) AS jobStatsCreateTime,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobInsertion.job.jobStats.startTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime'))\n+    ) AS jobStatsStartTime,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime'))\n+    ) AS jobStatsEndTime,\n+    COALESCE(\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.totalSlotMs') AS INT64),\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.totalSlotMs') AS INT64)\n+    ) AS jobStatsTotalSlotMs,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.reservationUsage.name'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.reservationUsage.name')\n+    ) AS jobStatsReservationUsageName,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.reservationUsage.slotMs'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.reservationUsage.slotMs')\n+    ) AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.totalProcessedBytes'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.totalProcessedBytes')\n+    ) AS queryJobStatsTotalProcessedBytes,\n+    COALESCE(\n+      CAST(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.totalBilledBytes') AS INT64),\n+       CAST(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64)\n+    ) AS queryJobStatsTotalBilledBytes,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.billingTier'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.billingTier')\n+    ) AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedTables'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedTables')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedViews'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedViews')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedRoutines'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedRoutines')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.outputRowCount'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.outputRowCount')\n+    ) AS queryJobStatsOutputRowCount,\n+    CAST(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.cacheHit'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.cacheHit')\n+    ) AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    COALESCE(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobInsertion.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobInsertion.job.jobStats.startTime')),\n+        MILLISECOND),\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobChange.job.jobStats.startTime')),\n+        MILLISECOND)\n+      ) AS jobStatsRuntimeMs,\n+    COALESCE(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.startTime')),\n+        SECOND),\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND)\n+      ) AS jobStatsRuntimeSecs,\n+    COALESCE(\n+      CAST(CEILING(\n+        TIMESTAMP_DIFF(\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobInsertion.job.jobStats.endTime')),\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobInsertion.job.jobStats.startTime')),\n+          SECOND) / 60 ) AS INT64),\n+      CAST(CEILING(\n+        TIMESTAMP_DIFF(\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobChange.job.jobStats.endTime')),\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobChange.job.jobStats.startTime')),\n+          SECOND) / 60) AS INT64)\n+      ) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.query'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.query')) AS queryConfigQuery,\n+    CAST(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.queryTruncated'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.queryTruncated')) AS BOOL) AS queryConfigQueryTruncated,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.destinationTable'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable')) AS queryConfigDestinationTable,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.createDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.createDisposition')) AS queryConfigCreateDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.writeDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.writeDisposition')) AS queryConfigWriteDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.defaultDataset'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.defaultDataset')) AS queryConfigDefaultDataset,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.priority'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority')) AS queryConfigPriority,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName')\n+      ) AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.statementType'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType')) AS queryConfigStatementType,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.destinationTable'),\n+        \"/\")[SAFE_OFFSET(1)]\n+    ) AS queryConfigDestinationTableProjectId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+          \"/\")[SAFE_OFFSET(3)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.queryConfig.destinationTable'),\n+          \"/\")[SAFE_OFFSET(3)]\n+    ) AS queryConfigDestinationTableDatasetId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+          \"/\")[SAFE_OFFSET(5)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.queryConfig.destinationTable'),\n+          \"/\")[SAFE_OFFSET(5)]\n+    ) AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    COALESCE(\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+        '[\"'), '\"]'), '\",\"'),\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.loadConfig.sourceUris'),\n+        '[\"'), '\"]'), '\",\"')\n+    ) AS loadConfigSourceUris,\n+    COALESCE(\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL),\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL)\n+    ) AS loadConfigSourceUrisTruncated,\n+    COALESCE(\n+       JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson'),\n+       JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.schemaJson')\n+    ) AS loadConfigSchemaJson,\n+    COALESCE(\n+     CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL),\n+     CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL)\n+    ) AS loadConfigSchemaJsonTruncated,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.destinationTable')\n+    ) AS loadConfigDestinationTable,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.createDisposition')\n+    ) AS loadConfigCreateDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.writeDisposition')\n+    ) AS loadConfigWriteDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobInsertion.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName')\n+    ) AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    COALESCE(\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+        '[\"'), '\"]'), '\",\"'),\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.extractConfig.destinationUris'),\n+        '[\"'), '\"]'), '\",\"')\n+    ) AS extractConfigDestinationUris,\n+    COALESCE(\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL),\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL)\n+    ) AS extractConfigDestinationUrisTruncated,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.extractConfig.sourceTable')\n+    ) AS extractConfigSourceTable,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+          \",\")[SAFE_OFFSET(1)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.extractConfig.sourceTable'),\n+        \",\")[SAFE_OFFSET(1)]\n+    ) AS extractConfigSourceTableProjectId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+        \",\")[SAFE_OFFSET(3)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.extractConfig.sourceTable'),\n+        \",\")[SAFE_OFFSET(3)]\n+    ) AS extractConfigSourceTableDatasetId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+        \",\")[SAFE_OFFSET(5)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.extractConfig.sourceTable'),\n+        \",\")[SAFE_OFFSET(5)]\n+    ) AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    COALESCE(\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+        '[\"'),'\"]') ,'\",\"'),\n+      SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobConfig.tableCopyConfig.sourceTables'),\n+        '[\"'),'\"]') ,'\",\"')\n+    ) AS tableCopySourceTables,\n+    COALESCE(\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated')\n+      AS BOOL),\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.sourceTablesTruncated')\n+      AS BOOL)\n+    ) AS tableCopyConfigSourceTablesTruncated,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.destinationTable')\n+    ) AS tableCopyConfigDestinationTable,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.createDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.createDisposition')\n+    ) AS tableCopyConfigCreateDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.writeDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.writeDisposition')\n+    ) AS tableCopyConfigWriteDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName')\n+    ) AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)]\n+    ) AS tableCopyConfigProjectId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]\n+    ) AS tableCopyConfigDatasetId,\n+    COALESCE(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)],\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)]\n+    ) AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_system_event`\n+),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields')),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadFields,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fieldsTruncated') AS BOOL) AS tableDataReadFieldsTruncated,\n+     SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categories'),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadCategories,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categoriesTruncated') AS BOOL) AS tableDataReadCategoriesTruncated,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.reason') AS tableDataReadReason,\n+     JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName') AS tableDataReadJobName,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.sessionName') AS tableDataReadSessionName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDataChange: Table data change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledatachange\n+ */\n+tableDataChangeEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDataChange.jobName'),\n+      \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataChange.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.deletedRowsCount') AS tableDataChangeDeletedRowsCount,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.insertedRowsCount') AS tableDataChangeInsertedRowsCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.truncated') AS BOOL) AS tableDataChangeTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.reason') AS tableDataChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.jobName') AS tableDataChangeJobName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+)\n+ -- End of WITH clauses\n+SELECT\n+  principalEmail,\n+  callerIp,\n+  serviceName,\n+  methodName,\n+  eventName,\n+  projectId,\n+  jobId,\n+  IF(jobChangeJobName IS NULL, False, True) AS hasJobChangeEvent,\n+  IF(tableDeletionJobName is NULL, False, True) AS hasTableDeletionEvent,\n+  IF(tableDataReadJobName IS NULL, False, True) AS hasTableDataReadEvent,\n+  IF(tableDataChangeJobName IS NULL, False, True) AS hasTableDataChangeEvent,\n+  STRUCT(\n+    EXTRACT(MINUTE FROM jobStatsStartTime) AS minuteOfDay,\n+    EXTRACT(HOUR FROM jobStatsStartTime) AS hourOfDay,\n+    EXTRACT(DAYOFWEEK FROM jobStatsStartTime) - 1 AS dayOfWeek,\n+    EXTRACT(DAYOFYEAR FROM jobStatsStartTime) AS dayOfYear,\n+    EXTRACT(WEEK FROM jobStatsStartTime) AS week,\n+    EXTRACT(MONTH FROM jobStatsStartTime) AS month,\n+    EXTRACT(QUARTER FROM jobStatsStartTime) AS quarter,\n+    EXTRACT(YEAR FROM jobStatsStartTime) AS year\n+  ) AS jobStartDate,\n+  jobStatsRuntimeMs AS jobRuntimeMs,\n+  jobStatsRuntimeSecs AS jobRuntimeSec,\n+  REGEXP_CONTAINS(jobId, 'beam') AS isBeamJob,\n+  REGEXP_CONTAINS(queryConfigQuery, 'cloudaudit_googleapis_com_data_access') AS isAuditDashboardQuery,\n+  jobStatsTotalSlotMs / jobStatsRuntimeMs AS avgSlots,\n+  /*\n+   * The following statement breaks down the query into minute buckets\n+   * and provides the average slot usage within that minute. This is a\n+   * crude way of making it so you can retrieve the average slot utilization\n+   * for a particular minute across multiple queries.\n+   */\n+  ARRAY(\n+    SELECT\n+      STRUCT(\n+        TIMESTAMP_TRUNC(\n+          TIMESTAMP_ADD(jobStatsStartTime, INTERVAL bucket_num MINUTE), MINUTE\n+        ) AS time,\n+        jobStatsTotalSlotMs / jobStatsRuntimeMs AS avgSlotUsage\n+      )\n+    FROM UNNEST(GENERATE_ARRAY(1, jobStatsExecutionMinuteBuckets)) AS bucket_num\n+  ) AS jobExecutionTimeline,\n+  ARRAY_LENGTH(queryJobStatsReferencedTables) AS totalTablesProcessed,\n+  ARRAY_LENGTH(queryJobStatsReferencedViews) AS totalViewsProcessed,\n+  (queryJobStatsTotalBilledBytes / pow(2,30)) AS totalBilledGigabytes,\n+  (queryJobStatsTotalBilledBytes / pow(2,40)) AS totalBilledTerabytes,\n+  (queryJobStatsTotalBilledBytes / pow(2,40)) * 5 AS estimatedCostUsd,\n+  CONCAT(\n+    queryConfigDestinationTableDatasetId, '.',\n+    queryConfigDestinationTableId) AS queryDestinationTableRelativePath,\n+  CONCAT(\n+    queryConfigDestinationTableProjectId, '.',\n+    queryConfigDestinationTableDatasetId, '.',\n+    queryConfigDestinationTableId) AS queryDestinationTableAbsolutePath,\n+  queryConfigDestinationTableProjectId AS queryDestinationTableProjectId,\n+  queryConfigDestinationTableDatasetId AS queryDestinationTableDatasetId,\n+  queryConfigDestinationTableId AS queryDestinationTableId,\n+  /*\n+   * jobChange STRUCT\n+   * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobchange\n+  */\n+  STRUCT(\n+    jobChangeJobName AS jobName,\n+    /*\n+     * jobConfig STRUCT\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobconfig\n+     */\n+    STRUCT(\n+      /*\n+       * queryConfig STRUCT\n+       * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+       */\n+      STRUCT(\n+        queryConfigQuery AS query,\n+        queryConfigQueryTruncated AS queryTruncated,\n+        queryConfigDestinationTable AS destinationTable,\n+        queryConfigCreateDisposition AS createDisposition,\n+        queryConfigWriteDisposition AS writeDisposition,\n+        queryConfigDefaultDataset AS defaultDataset,\n+        --TODO Add tableDefinitions\n+        queryConfigPriority AS priority,\n+        STRUCT(\n+          queryConfigDestinationTableEncryptionKmsKeyName AS kmsKeyName\n+        ) AS destinationTableEncryption,\n+        queryConfigStatementType AS statementType\n+      ) AS queryConfig,\n+      /*\n+       * loadConfig STRUCT\n+       * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+       */\n+      STRUCT(\n+        loadConfigSourceUris AS sourceUris,\n+        loadConfigSourceUrisTruncated AS sourceUrisTruncated,\n+        loadConfigSchemaJson AS schemaJson,\n+        loadConfigSchemaJsonTruncated AS schemaJsonTruncated,\n+        loadConfigDestinationTable AS destinationTable,\n+        loadConfigCreateDisposition AS createDisposition,\n+        loadConfigWriteDisposition AS writeDisposition,\n+        STRUCT(\n+          loadConfigDestinationTableEncryptionKmsKeyName AS kmsKeyName\n+        ) AS destinationTableEncryption\n+      ) AS loadConfig,\n+      /*\n+       * extractConfig STRUCT\n+       * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+       */\n+      STRUCT(\n+        extractConfigDestinationUris AS destinationUris,\n+        extractConfigDestinationUrisTruncated AS destinationUrisTruncated,\n+        extractConfigSourceTable AS sourceTable\n+      ) AS extractConfig,\n+      /*\n+       * tableCopyConfig STRUCT\n+       * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+       */\n+      STRUCT(\n+        tableCopySourceTables AS sourceTables,\n+        tableCopyConfigSourceTablesTruncated AS configSourceTablesTruncated,\n+        tableCopyConfigDestinationTable AS configDestinationTable,\n+        tableCopyConfigCreateDisposition AS configCreateDisposition,\n+        tableCopyConfigWriteDisposition AS configWriteDisposition,\n+        STRUCT(\n+          tableCopyConfigDestinationTableEncryptionKmsKeyName AS kmsKeyName\n+        ) AS destinationTableEncryption\n+      ) AS tableCopyConfig\n+    ) AS jobConfig,\n+    /*\n+     * JobStatus STRUCT\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#JobStatus\n+     */\n+    STRUCT(\n+      jobStatusJobState AS jobState,\n+      STRUCT(\n+        jobStatusErrorResultCode AS code,\n+        jobStatusErrorResultMessage AS message,\n+        jobStatusErrorResultDetails AS details\n+      ) AS errorResult,\n+      jobStatusEncounteredErrorMessages AS encounteredErrorMessages,\n+      jobStatusEncounteredErrorCodes AS encounteredErrorCodes\n+    ) AS jobStatus,\n+    /*\n+     * JobStats STRUCT\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    STRUCT(\n+      jobStatsCreateTime AS createTime,\n+      jobStatsStartTime AS startTime,\n+      jobStatsEndTime AS endTime,\n+      jobStatsTotalSlotMs AS totalSlotMs,\n+      jobStatsParentJobName as parentJobName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "originalPosition": 716}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjEzOTcz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-446613973", "createdAt": "2020-07-10T18:30:44Z", "commit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODozMDo0NFrOGwBUcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODozMDo0NFrOGwBUcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNjQ1MA==", "bodyText": "Add parentJobName in your examples and order the child statements in order of execution since the whole point is to track script execution", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r453006450", "createdAt": "2020-07-10T18:30:44Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,98 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql)\n+\n+Customers who run scripts in legacy data warehouses such as Teradata, understandably want to track statement results and metrics. For example, tracking the number of rows affected after a set of DML queries are executed. In order to collect this information for analysis, customers would have to write a statement by setting variables within the script after each query statement, to collect this information. Essentially, users are in charge of managing their own metrics for monitoring. This can become very tedious for users who run thousands, if not more, scripts in a day.  With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobInsertion.job.jobConfig.queryConfig.statementType=\"SCRIPT\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobInsertion.job.jobConfig.queryConfig.statementType=\"SCRIPT\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )\n+        *   Make sure to select\n+            [partitioning](https://cloud.google.com/logging/docs/export/bigquery#partition-tables)\n+            for your BigQuery destination\n+            \n+    Note: You can create a log sink at the folder, billing account, or organization level using an \n+    [aggregated sink](https://cloud.google.com/logging/docs/export/aggregated_sinks#creating_an_aggregated_sink).\n+1.  The log sink will immediately create the BigQuery dataset but the table will\n+    be created once you run a BigQuery job post log sink creation.\n+1.  To use the SELECT statement in\n+    [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql), change\n+    all occurrences of\n+    `project_id.dataset_id.cloudaudit_googleapis_com_data_access` to be the full\n+    table path you created in step 1.\n+    *   `sed\n+        's/project_id.dataset_id.cloudaudit_googleapis_com_data_access/YOUR_PROJECT.YOUR_DATASET.YOUR_TABLE/'\n+        big_query_elt_audit_log_v2.sql`\n+1.  From here, you can do further analysis in BigQuery by querying the view, or\n+    you can connect it to a BI tool such as DataStudio as a data source and\n+    build dashboards.\n+    \n+#### Usage Examples", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "071d68ea2ea865e3616692b5ba9f0ad7c6ebc11e", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/071d68ea2ea865e3616692b5ba9f0ad7c6ebc11e", "committedDate": "2020-07-10T19:07:06Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjQxNTY5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-446641569", "createdAt": "2020-07-10T19:09:44Z", "commit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxOTowOTo0NVrOGwCxzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxOTowOTo0NVrOGwCxzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAzMDM0OA==", "bodyText": "wrap the whole SQL in CREATE OR REPLACE VIEW and add README steps to replace view name with user-desired value", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r453030348", "createdAt": "2020-07-10T19:09:45Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,785 @@\n+WITH jobChangeEvent AS (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bac516f0e9b8793547f74a9bf257ecc63f4b0114"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c34a1b5e1d6b183f3cc7383cd2ef9e0562dd190", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9c34a1b5e1d6b183f3cc7383cd2ef9e0562dd190", "committedDate": "2020-07-10T19:23:47Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c799386340ce06cafd1d00bf025b6012b6b290c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6c799386340ce06cafd1d00bf025b6012b6b290c", "committedDate": "2020-07-10T19:24:42Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2995d683f329c331e8ffb06016e155dc975cb5c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d2995d683f329c331e8ffb06016e155dc975cb5c", "committedDate": "2020-07-10T19:33:18Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f8b924afd57a2f9181b42ea017537c007b91591", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8f8b924afd57a2f9181b42ea017537c007b91591", "committedDate": "2020-07-10T19:35:15Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a49f9f556cac1d030cafc40520a6b59f66f9dfa7", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a49f9f556cac1d030cafc40520a6b59f66f9dfa7", "committedDate": "2020-07-10T20:50:14Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a89f5349a53df6328abc908d59f58df43c595e0f", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a89f5349a53df6328abc908d59f58df43c595e0f", "committedDate": "2020-07-10T20:52:29Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45babab93df5e66f11ae79afd897a2f7366bdaa6", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/45babab93df5e66f11ae79afd897a2f7366bdaa6", "committedDate": "2020-07-10T21:11:52Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967fb0cdb2afab1abde67481c62768c42f0d7efd", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/967fb0cdb2afab1abde67481c62768c42f0d7efd", "committedDate": "2020-07-10T21:12:27Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3a680a85d01c6f10e493433f5911e5a4329544", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5d3a680a85d01c6f10e493433f5911e5a4329544", "committedDate": "2020-07-10T21:53:35Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60262a7a6b35a6fc6c3619608612f0ce2c75381c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/60262a7a6b35a6fc6c3619608612f0ce2c75381c", "committedDate": "2020-07-10T21:54:53Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbcb3d757de22d74a78a7137a98d2b62dab2ad11", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/dbcb3d757de22d74a78a7137a98d2b62dab2ad11", "committedDate": "2020-07-10T22:01:36Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9151a8e27ac78af5ee7644abfb8c92fdb86df380", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9151a8e27ac78af5ee7644abfb8c92fdb86df380", "committedDate": "2020-07-10T22:04:34Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "157ce027b170a08272000103419b409d8386ed6d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/157ce027b170a08272000103419b409d8386ed6d", "committedDate": "2020-07-10T22:17:03Z", "message": "Update README.md\n\nUpdated last sample query to use ARRAY_CONCAT_AGG for type array field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fabea7c08cadcd27703191982433de66fde04127", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/fabea7c08cadcd27703191982433de66fde04127", "committedDate": "2020-07-10T22:19:16Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46a3d8692bb38a751a8712319e301821a5d1f518", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/46a3d8692bb38a751a8712319e301821a5d1f518", "committedDate": "2020-07-10T22:25:23Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c98fb2699aa36c2a8b6d7bd65af1b0e72569f4", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/50c98fb2699aa36c2a8b6d7bd65af1b0e72569f4", "committedDate": "2020-07-17T22:15:30Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9a19df09041fe7cd9d47033018a09fa653b2ca", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/df9a19df09041fe7cd9d47033018a09fa653b2ca", "committedDate": "2020-07-17T22:16:10Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4423f6570e7b41ad2b7e752f2c2d14e842dc847", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f4423f6570e7b41ad2b7e752f2c2d14e842dc847", "committedDate": "2020-07-29T20:45:46Z", "message": "Update big_query_elt_script_logging.sql\n\nRemoved all jobInsertions, SCRIPT has jobChange events now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27a34cfae9006f9a66621580f45ec86f4bfb0c8b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/27a34cfae9006f9a66621580f45ec86f4bfb0c8b", "committedDate": "2020-07-29T20:47:23Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6786a9cf1ef75a203765540eb5deded181c4d9aa", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6786a9cf1ef75a203765540eb5deded181c4d9aa", "committedDate": "2020-07-29T20:48:46Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d46b88499d9d859b0c2dbe28ced72b3983a0cc", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e8d46b88499d9d859b0c2dbe28ced72b3983a0cc", "committedDate": "2020-07-31T01:00:47Z", "message": "Update big_query_elt_script_logging.sql\n\nSyntax fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b", "committedDate": "2020-08-09T14:26:13Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODgxNjYz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463881663", "createdAt": "2020-08-09T15:09:09Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNTowOTowOVrOG97uuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNTowOTowOVrOG97uuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU5NDkzOQ==", "bodyText": "We no longer need jobInsertion events to pass into our sink", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467594939", "createdAt": "2020-08-09T15:09:09Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,108 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql)\n+\n+Customers who run scripts in legacy data warehouses such as Teradata, understandably want to track statement results and metrics. For example, tracking the number of rows affected after a set of DML queries are executed. In order to collect this information for analysis, users would have to set system variables and make logging calls after each DML statement. Essentially, users are in charge of managing monitoring. This can become very tedious for users who run thousands, if not more, scripts in a day.  With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobInsertion.job.jobConfig.queryConfig.statementType=\"SCRIPT\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODgxNjg5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463881689", "createdAt": "2020-08-09T15:09:26Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNTowOToyNlrOG97u9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNTowOToyNlrOG97u9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzU5NDk5OQ==", "bodyText": "Update filter here too", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467594999", "createdAt": "2020-08-09T15:09:26Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,108 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql)\n+\n+Customers who run scripts in legacy data warehouses such as Teradata, understandably want to track statement results and metrics. For example, tracking the number of rows affected after a set of DML queries are executed. In order to collect this information for analysis, users would have to set system variables and make logging calls after each DML statement. Essentially, users are in charge of managing monitoring. This can become very tedious for users who run thousands, if not more, scripts in a day.  With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobInsertion.job.jobConfig.queryConfig.statementType=\"SCRIPT\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobInsertion.job.jobConfig.queryConfig.statementType=\"SCRIPT\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODg2Nzk0", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463886794", "createdAt": "2020-08-09T16:27:04Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjoyNzowNFrOG98NEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjoyNzowNFrOG98NEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYwMjcwNw==", "bodyText": "tableDeletion.table.reason tableDeletion.reason", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467602707", "createdAt": "2020-08-09T16:27:04Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,525 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 235}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODg3Mjgx", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463887281", "createdAt": "2020-08-09T16:34:57Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjozNDo1N1rOG98P9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjozNDo1N1rOG98P9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYwMzQ0NA==", "bodyText": "Rename to match file", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467603444", "createdAt": "2020-08-09T16:34:57Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,108 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODg3NjI4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463887628", "createdAt": "2020-08-09T16:40:18Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MDoxOFrOG98R9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MDoxOFrOG98R9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYwMzk1OQ==", "bodyText": "Customers who run scripts in legacy data warehouses such as Teradata, understandably want to track statement results and metrics. For example, tracking the number of rows affected after a set of DML queries are executed. In order to collect this information for analysis, users would have to set system variables and make logging calls after each DML statement. Essentially, users are in charge of managing monitoring. This can become very tedious for users who run thousands, if not more, scripts in a day.\nA common pattern in data warehousing for tracking results of DML statements is to collect system variable values after each DML statement and write them to a separate logging table. With BigQuery...", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467603959", "createdAt": "2020-08-09T16:40:18Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,108 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql)\n+\n+Customers who run scripts in legacy data warehouses such as Teradata, understandably want to track statement results and metrics. For example, tracking the number of rows affected after a set of DML queries are executed. In order to collect this information for analysis, users would have to set system variables and make logging calls after each DML statement. Essentially, users are in charge of managing monitoring. This can become very tedious for users who run thousands, if not more, scripts in a day.  With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODg3NzU5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463887759", "createdAt": "2020-08-09T16:42:14Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MjoxNFrOG98SwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MjoxNFrOG98SwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYwNDE2MA==", "bodyText": "let's add timestamp right after callerIp since partitioning is based off timestamp.\nThis will let us minimize the amount of data read by view", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467604160", "createdAt": "2020-08-09T16:42:14Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,525 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODg3Nzg4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463887788", "createdAt": "2020-08-09T16:42:36Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MjozNlrOG98S3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxNjo0MjozNlrOG98S3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYwNDE5MQ==", "bodyText": "add timestamp after callerIp,", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467604191", "createdAt": "2020-08-09T16:42:36Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,525 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_system_event`\n+),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields')),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadFields,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fieldsTruncated') AS BOOL) AS tableDataReadFieldsTruncated,\n+     SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categories'),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadCategories,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categoriesTruncated') AS BOOL) AS tableDataReadCategoriesTruncated,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.reason') AS tableDataReadReason,\n+     JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName') AS tableDataReadJobName,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.sessionName') AS tableDataReadSessionName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDataChange: Table data change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledatachange\n+ */\n+tableDataChangeEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDataChange.jobName'),\n+      \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataChange.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.deletedRowsCount') AS tableDataChangeDeletedRowsCount,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.insertedRowsCount') AS tableDataChangeInsertedRowsCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.truncated') AS BOOL) AS tableDataChangeTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.reason') AS tableDataChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.jobName') AS tableDataChangeJobName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+)\n+ -- End of WITH clauses\n+SELECT\n+  principalEmail,\n+  callerIp,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 309}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODk1MDMz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463895033", "createdAt": "2020-08-09T18:45:31Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxODo0NTozMVrOG98_fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxODo0NTozMVrOG98_fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYxNTYxMg==", "bodyText": "Remove coalesce as it's redundant", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467615612", "createdAt": "2020-08-09T18:45:31Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,525 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_system_event`\n+),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 256}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODk2Mzc2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-463896376", "createdAt": "2020-08-09T19:08:14Z", "commit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxOTowODoxNFrOG99H9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQxOTowODoxNFrOG99H9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYxNzc4MA==", "bodyText": "Turns out tableDataReadEvents have an row entry for each table that a job reads. We have to tweak this and any other metadata events that are similar. Below shows an example of pulling all rows into one.\n/*\n\nTableDataRead: Data from tableDataRead audit logs\nhttps://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n*/\ntableDataReadEvent AS (\nSELECT\nCONCAT(\nSPLIT(\nJSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n'$.tableDataRead.jobName'),\n\"/\")[SAFE_OFFSET(1)],\n\":\",\nSPLIT(\nJSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n'$.tableDataRead.jobName'),\n\"/\")[SAFE_OFFSET(3)]\n) AS jobId,\nARRAY_AGG(protopayload_auditlog.resourceName IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableName,\nARRAY_AGG(STRUCT(SPLIT(TRIM(TRIM(\nJSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.fields'),\n'[\"'),'\"]'),'\",\"') AS fields) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadFields,\nARRAY_AGG(CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.fieldsTruncated') AS BOOL) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadFieldsTruncated,\nARRAY_AGG(STRUCT(SPLIT(TRIM(TRIM(\nJSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.categories'),\n'[\"'),'\"]'),'\",\"') AS categories) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadCategories,\nARRAY_AGG(CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.categoriesTruncated') AS BOOL) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadCategoriesTruncated,\nARRAY_AGG(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.reason') IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadReason,\nARRAY_AGG(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n'$.tableDataRead.jobName') IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadJobName,\nARRAY_AGG(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n'$.tableDataRead.sessionName') IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadSessionName,\nFROM project_id.dataset_id.cloudaudit_googleapis_com_data_access\nGROUP BY 1\n),", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r467617780", "createdAt": "2020-08-09T19:08:14Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,525 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_system_event`\n+),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac5055e9cc0c3003b2781ef8d219cb1e1f1ee9b"}, "originalPosition": 242}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "913564286bd8a81770b56db70f2b05d84068320e", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/913564286bd8a81770b56db70f2b05d84068320e", "committedDate": "2020-08-10T20:14:03Z", "message": "Update README.md\n\nUpdated filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b674d22b6716927d1b95cfed77dacddec18f9ba", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0b674d22b6716927d1b95cfed77dacddec18f9ba", "committedDate": "2020-08-11T01:04:59Z", "message": "Update README.md\n\nAddressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebad0f06b7c2e50fc5a997380e94e9a3fd2bb4c1", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ebad0f06b7c2e50fc5a997380e94e9a3fd2bb4c1", "committedDate": "2020-08-11T01:06:36Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc13c5266bd4ff08d990d22a20bdd6f924dfa74", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7cc13c5266bd4ff08d990d22a20bdd6f924dfa74", "committedDate": "2020-08-11T01:16:08Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf4136d02dcd9d772374d39cf410c6a8e06018af", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/bf4136d02dcd9d772374d39cf410c6a8e06018af", "committedDate": "2020-08-13T00:34:01Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b5bc02b4d5a003d454594bb4308951bd45f1781", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6b5bc02b4d5a003d454594bb4308951bd45f1781", "committedDate": "2020-08-17T16:53:22Z", "message": "Update README.md\n\nUpdated one of the sample queries to get all DML events from a script."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40e3df95e5d888d93f39d06e9b10fc308d555e16", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/40e3df95e5d888d93f39d06e9b10fc308d555e16", "committedDate": "2020-08-17T16:55:33Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2f4f925fc0b4b65c826ddf3436eafdf2c7fd50d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f2f4f925fc0b4b65c826ddf3436eafdf2c7fd50d", "committedDate": "2020-08-17T20:11:19Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "229496eaba78d55db4ed014653887362807674c3", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/229496eaba78d55db4ed014653887362807674c3", "committedDate": "2020-08-17T20:12:53Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTk4OTU1", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469598955", "createdAt": "2020-08-18T15:57:40Z", "commit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNTo1Nzo0MFrOHCbPJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNTo1Nzo0MFrOHCbPJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwNTQ0NQ==", "bodyText": "give the view a more useful name, one which users would likely keep. e.g. \"bq_scripting_logs\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472305445", "createdAt": "2020-08-18T15:57:40Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,533 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTk5NzY3", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469599767", "createdAt": "2020-08-18T15:58:34Z", "commit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNTo1ODozNFrOHCbRhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNTo1ODozNFrOHCbRhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwNjA1NQ==", "bodyText": "for scripts that use reservations", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472306055", "createdAt": "2020-08-18T15:58:34Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,119 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_script_logging.sql](/views/audit/big_query_elt_script_logging.sql)\n+\n+A common pattern in data warehousing for tracking results of DML statements is to collect system variable values after each DML statement and write them to a separate logging table. With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )\n+        *   [Partitioning](https://cloud.google.com/logging/docs/export/bigquery#partition-tables)\n+            is not required, but it is strongly recommended to select it for your BigQuery destination\n+            \n+    Note: You can create a log sink at the folder, billing account, or organization level using an \n+    [aggregated sink](https://cloud.google.com/logging/docs/export/aggregated_sinks#creating_an_aggregated_sink).\n+1.  The log sink will immediately create the BigQuery dataset but the table will\n+    be created once you run a BigQuery job post log sink creation.\n+1.  To use the SELECT statement in\n+    [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql), change\n+    all occurrences of\n+    `project_id.dataset_id.cloudaudit_googleapis_com_data_access` to be the full\n+    table path you created in step 1.\n+    *   `sed\n+        's/project_id.dataset_id.cloudaudit_googleapis_com_data_access/YOUR_PROJECT.YOUR_DATASET.YOUR_TABLE/'\n+        big_query_elt_audit_log_v2.sql`\n+1.  From here, you can do further analysis in BigQuery by querying the view, or\n+    you can connect it to a BI tool such as DataStudio as a data source and\n+    build dashboards.\n+    \n+#### Usage Examples\n+Change all occurrences of `YOUR_VIEW` to the full path to the view. \n+\n+* Run this query to see job name, query, total number of billed bytes, job creation time, job start time, job end time, job runtime, and count of inserted rows and deleted rows for DML queries in a script.\n+  \n+  \n+  ```  \n+  SELECT \n+   COALESCE(jobChange.jobStats.parentJobName, jobId) AS common_script_job_id,\n+   jobChange.jobConfig.queryConfig.query,\n+   jobChange.jobStats.queryStats.totalBilledBytes,\n+   jobChange.jobConfig.queryConfig.statementType,\n+   jobChange.jobStats.createTime,\n+   jobChange.jobStats.startTime,\n+   jobChange.jobStats.endTime,\n+   jobRuntimeMs,\n+   tableDataChange.deletedRowsCount,\n+   tableDataChange.insertedRowsCount,\n+  FROM YOUR_VIEW \n+  WHERE \n+  hasJobChangeEvent AND\n+  hasTableDataChangeEvent AND\n+  (jobChange.jobStats.parentJobName IS NOT NULL OR jobChange.jobConfig.queryConfig.statementType = 'SCRIPT')\n+  ORDER BY \n+   jobChange.jobStats.startTime DESC,\n+   common_script_job_id\n+   \n+  ```\n+\n+* Run this query to see job name, query, total number of billed bytes, job creation time, job start time, job end time, and job runtime table read queries in a script.\n+\n+```  \n+  SELECT \n+   COALESCE(jobChange.jobStats.parentJobName, jobId) AS common_script_job_id,\n+   jobChange.jobConfig.queryConfig.query,\n+   jobChange.jobStats.queryStats.totalBilledBytes,\n+   jobChange.jobConfig.queryConfig.statementType,\n+   jobChange.jobStats.createTime,\n+   jobChange.jobStats.startTime,\n+   jobChange.jobStats.endTime,\n+   jobRuntimeMs,\n+  FROM YOUR_VIEW \n+  WHERE \n+  hasJobChangeEvent AND \n+  hasTableDataReadEvent AND\n+  (jobChange.jobStats.parentJobName IS NOT NULL OR jobChange.jobConfig.queryConfig.statementType = 'SCRIPT')\n+  ORDER BY \n+   jobChange.jobStats.startTime DESC,\n+   common_script_job_id\n+   \n+  ```\n+\n+* Run this query to see slot usage for query that uses reservations.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef4331a817d8f74167d02ce5de06f4dcca31efb", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/cef4331a817d8f74167d02ce5de06f4dcca31efb", "committedDate": "2020-08-18T16:02:00Z", "message": "Update README.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjAzOTAx", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469603901", "createdAt": "2020-08-18T16:03:19Z", "commit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjowMzoxOVrOHCbd1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjowMzoxOVrOHCbd1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwOTIwNw==", "bodyText": "Better descriptions needed for these usage examples. Don't list out columns being read in the description, but rather explain concisely what this is useful for.\ne.g. Execute the following query to list out all scripts which modified data in tables.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472309207", "createdAt": "2020-08-18T16:03:19Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,119 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_script_logging.sql](/views/audit/big_query_elt_script_logging.sql)\n+\n+A common pattern in data warehousing for tracking results of DML statements is to collect system variable values after each DML statement and write them to a separate logging table. With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )\n+        *   [Partitioning](https://cloud.google.com/logging/docs/export/bigquery#partition-tables)\n+            is not required, but it is strongly recommended to select it for your BigQuery destination\n+            \n+    Note: You can create a log sink at the folder, billing account, or organization level using an \n+    [aggregated sink](https://cloud.google.com/logging/docs/export/aggregated_sinks#creating_an_aggregated_sink).\n+1.  The log sink will immediately create the BigQuery dataset but the table will\n+    be created once you run a BigQuery job post log sink creation.\n+1.  To use the SELECT statement in\n+    [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql), change\n+    all occurrences of\n+    `project_id.dataset_id.cloudaudit_googleapis_com_data_access` to be the full\n+    table path you created in step 1.\n+    *   `sed\n+        's/project_id.dataset_id.cloudaudit_googleapis_com_data_access/YOUR_PROJECT.YOUR_DATASET.YOUR_TABLE/'\n+        big_query_elt_audit_log_v2.sql`\n+1.  From here, you can do further analysis in BigQuery by querying the view, or\n+    you can connect it to a BI tool such as DataStudio as a data source and\n+    build dashboards.\n+    \n+#### Usage Examples\n+Change all occurrences of `YOUR_VIEW` to the full path to the view. \n+\n+* Run this query to see job name, query, total number of billed bytes, job creation time, job start time, job end time, job runtime, and count of inserted rows and deleted rows for DML queries in a script.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7477c5c65f0345dce1a1c5f21d1bf8e4dac306d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d7477c5c65f0345dce1a1c5f21d1bf8e4dac306d", "committedDate": "2020-08-18T16:04:21Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjA2NjI5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469606629", "createdAt": "2020-08-18T16:06:34Z", "commit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjowNjozNFrOHCbmHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjowNjozNFrOHCbmHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxMTMyNQ==", "bodyText": "keep here as \"timestamp\" only. You alias it in the SELECT below", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472311325", "createdAt": "2020-08-18T16:06:34Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,533 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.view_name` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    timestamp as eventTimestamp,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229496eaba78d55db4ed014653887362807674c3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0634e3e431567490c0313c2c2e3710bf5a66b753", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0634e3e431567490c0313c2c2e3710bf5a66b753", "committedDate": "2020-08-18T16:21:16Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjIwNDkz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469620493", "createdAt": "2020-08-18T16:22:37Z", "commit": {"oid": "d7477c5c65f0345dce1a1c5f21d1bf8e4dac306d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjoyMjozN1rOHCcOIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjoyMjozN1rOHCcOIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMTU3MQ==", "bodyText": "pull this from activity table. refer to my PR for the change", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472321571", "createdAt": "2020-08-18T16:22:37Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,533 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.bq_script_logs` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    timestamp as eventTimestamp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_system_event`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7477c5c65f0345dce1a1c5f21d1bf8e4dac306d"}, "originalPosition": 237}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c932d435726dded2dd678a35b57aeabf7cbcb0a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5c932d435726dded2dd678a35b57aeabf7cbcb0a", "committedDate": "2020-08-18T17:18:04Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/39d57fafb711a9007ddebb1650873d94a732ac4c", "committedDate": "2020-08-18T17:20:50Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzI3Nzk1", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469727795", "createdAt": "2020-08-18T18:43:07Z", "commit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0MzowN1rOHChV2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0MzowN1rOHChV2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNTQ2Nw==", "bodyText": "bigquery-utils/views/audit/bigquery_audit_log_v2.sql\n    \n    \n         Line 659\n      in\n      91dfd4a\n    \n    \n    \n    \n\n        \n          \n           parentJobId, \n        \n    \n  \n\n\nAdd parentJobId as a field below jobId", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472405467", "createdAt": "2020-08-18T18:43:07Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,533 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.bq_script_logs` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    timestamp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName') AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.jobState') AS jobStatusJobState,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult'),\"/\")[SAFE_OFFSET(1)],\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.code') AS jobStatusErrorResultCode,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.message') AS jobStatusErrorResultMessage,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStatus.errorResult.details') AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors'),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime')) AS jobStatsCreateTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime')) AS jobStatsStartTime,\n+    TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.endTime')) AS jobStatsEndTime,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.totalSlotMs') AS INT64) AS jobStatsTotalSlotMs,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.reservationUsage'),\n+      r'\"slotMs\":\\\"(.*?)\\\"}') AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalProcessedBytes') AS queryJobStatsTotalProcessedBytes,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64) AS queryJobStatsTotalBilledBytes,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.billingTier') AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.referencedTables'),\n+      '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedViews'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.queryStats.referencedRoutines'),\n+       '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.outputRowCount') AS queryJobStatsOutputRowCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.queryStats.cacheHit') AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobStats.startTime')),\n+      MILLISECOND) AS jobStatsRuntimeMs,\n+    TIMESTAMP_DIFF(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.startTime')),\n+      SECOND) AS jobStatsRuntimeSecs,\n+    CAST(CEILING(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND) / 60 ) AS INT64) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.query') AS queryConfigQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.queryTruncated') AS BOOL) AS queryConfigQueryTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable') AS queryConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.createDisposition') AS queryConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.writeDisposition') AS queryConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.defaultDataset') AS queryConfigDefaultDataset,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"name\":\\\"(.*?)\\\"}') AS tableDefinitionsName,\n+    REGEXP_EXTRACT_ALL(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,'$.jobChange.job.jobConfig.queryConfig.tableDefinitions'),\n+      r'\"sourceUris\":\\\"(.*?)\\\"}') AS tableDefinitionsSourceUris,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority') AS queryConfigPriority,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName') AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType') AS queryConfigStatementType,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+       '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+       \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName') AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated') AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated') \n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName') AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)]  AS tableCopyConfigDatasetId,\n+    SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_activity`\n+),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    ARRAY_AGG(\n+      protopayload_auditlog.resourceName\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadTableName,\n+    ARRAY_AGG(STRUCT(\n+      SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson, '$.tableDataRead.fields'),\n+      '[\"'),'\"]'),'\",\"')\n+      AS fields) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadFields,\n+    ARRAY_AGG(\n+      CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson, '$.tableDataRead.fieldsTruncated') AS BOOL)\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadFieldsTruncated,\n+    ARRAY_AGG(STRUCT(\n+      SPLIT(TRIM(TRIM(JSON_EXTRACT(protopayload_auditlog.metadataJson,'$.tableDataRead.categories'),\n+      '[\"'),'\"]'),'\",\"')\n+      AS categories) IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadCategories,\n+    ARRAY_AGG(\n+      CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson, '$.tableDataRead.categoriesTruncated') AS BOOL)\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadCategoriesTruncated,\n+    ARRAY_AGG(\n+      JSON_EXTRACT(protopayload_auditlog.metadataJson, '$.tableDataRead.reason')\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadReason,\n+    ARRAY_AGG(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDataRead.jobName')\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadJobName,\n+    ARRAY_AGG(\n+      JSON_EXTRACT(protopayload_auditlog.metadataJson, '$.tableDataRead.sessionName')\n+      IGNORE NULLS ORDER BY protopayload_auditlog.resourceName) AS tableDataReadSessionName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+  GROUP BY jobId\n+),\n+/*\n+ * TableDataChange: Table data change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledatachange\n+ */\n+tableDataChangeEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDataChange.jobName'),\n+      \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataChange.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.deletedRowsCount') AS tableDataChangeDeletedRowsCount,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.insertedRowsCount') AS tableDataChangeInsertedRowsCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.truncated') AS BOOL) AS tableDataChangeTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.reason') AS tableDataChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.jobName') AS tableDataChangeJobName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+)\n+ -- End of WITH clauses\n+SELECT\n+  principalEmail,\n+  callerIp,\n+  timestamp as eventTimestamp,\n+  serviceName,\n+  methodName,\n+  eventName,\n+  projectId,\n+  jobId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "originalPosition": 322}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzI4Mjky", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469728292", "createdAt": "2020-08-18T18:43:49Z", "commit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0Mzo0OVrOHChXNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0Mzo0OVrOHChXNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNTgxMw==", "bodyText": "bigquery-utils/views/audit/bigquery_audit_log_v2.sql\n    \n    \n         Line 39\n      in\n      91dfd4a\n    \n    \n    \n    \n\n        \n          \n           CONCAT( \n        \n    \n  \n\n\nAdd parentJobId below", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472405813", "createdAt": "2020-08-18T18:43:49Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_elt_script_logging.sql", "diffHunk": "@@ -0,0 +1,533 @@\n+CREATE OR REPLACE VIEW `project_id.dataset_id.bq_script_logs` AS (\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    timestamp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    CONCAT(\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzMyMTAx", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469732101", "createdAt": "2020-08-18T18:49:16Z", "commit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0OToxN1rOHChiqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0OToxN1rOHChiqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwODc0Ng==", "bodyText": "Remove DESC from ORDER BY", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472408746", "createdAt": "2020-08-18T18:49:17Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,119 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_script_logging.sql](/views/audit/big_query_elt_script_logging.sql)\n+\n+A common pattern in data warehousing for tracking results of DML statements is to collect system variable values after each DML statement and write them to a separate logging table. With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )\n+        *   [Partitioning](https://cloud.google.com/logging/docs/export/bigquery#partition-tables)\n+            is not required, but it is strongly recommended to select it for your BigQuery destination\n+            \n+    Note: You can create a log sink at the folder, billing account, or organization level using an \n+    [aggregated sink](https://cloud.google.com/logging/docs/export/aggregated_sinks#creating_an_aggregated_sink).\n+1.  The log sink will immediately create the BigQuery dataset but the table will\n+    be created once you run a BigQuery job post log sink creation.\n+1.  To use the SELECT statement in\n+    [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql), change\n+    all occurrences of\n+    `project_id.dataset_id.cloudaudit_googleapis_com_data_access` to be the full\n+    table path you created in step 1.\n+    *   `sed\n+        's/project_id.dataset_id.cloudaudit_googleapis_com_data_access/YOUR_PROJECT.YOUR_DATASET.YOUR_TABLE/'\n+        big_query_elt_audit_log_v2.sql`\n+1.  From here, you can do further analysis in BigQuery by querying the view, or\n+    you can connect it to a BI tool such as DataStudio as a data source and\n+    build dashboards.\n+    \n+#### Usage Examples\n+Change all occurrences of `YOUR_VIEW` to the full path to the view. \n+\n+* Run this query to see a detailed list of scripts which modified tables. The results are ordered with the most recent script runs first, and then further ordering is applied using the script's job id.\n+  \n+  \n+  ```  \n+  SELECT \n+   COALESCE(jobChange.jobStats.parentJobName, jobId) AS common_script_job_id,\n+   jobChange.jobConfig.queryConfig.query,\n+   jobChange.jobStats.queryStats.totalBilledBytes,\n+   jobChange.jobConfig.queryConfig.statementType,\n+   jobChange.jobStats.createTime,\n+   jobChange.jobStats.startTime,\n+   jobChange.jobStats.endTime,\n+   jobRuntimeMs,\n+   tableDataChange.deletedRowsCount,\n+   tableDataChange.insertedRowsCount,\n+  FROM YOUR_VIEW \n+  WHERE \n+  hasJobChangeEvent AND\n+  hasTableDataChangeEvent AND\n+  (jobChange.jobStats.parentJobName IS NOT NULL OR jobChange.jobConfig.queryConfig.statementType = 'SCRIPT')\n+  ORDER BY \n+   jobChange.jobStats.startTime DESC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzMyNTAy", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-469732502", "createdAt": "2020-08-18T18:49:53Z", "commit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0OTo1M1rOHChj-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODo0OTo1M1rOHChj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwOTA4MA==", "bodyText": "once you add the parentJobId, use that in the COALESCE with jobId", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r472409080", "createdAt": "2020-08-18T18:49:53Z", "author": {"login": "danieldeleo"}, "path": "views/audit/README.md", "diffHunk": "@@ -0,0 +1,119 @@\n+This directory contains helper SELECT statements to query BigQuery audit logs \\\n+More information regarding each is detailed below:\n+\n+\n+### [big_query_elt_script_logging.sql](/views/audit/big_query_elt_script_logging.sql)\n+\n+A common pattern in data warehousing for tracking results of DML statements is to collect system variable values after each DML statement and write them to a separate logging table. With BigQuery, you no longer have to log your SQL statement results because Cloud Logging allows you to store, search, analyze, monitor, and set alerts on all your BigQuery scripting activity. The new version of Cloud Logging logs for BigQuery, BigQueryAuditMetadata, provides rich insights into the execution of your scripts. This data can give you insight into your script performance, modifications of your data, and more. This is a BigQuery SELECT statement that has extracted and formatted BigQueryMetaData events, allowing you to write simple queries to monitor your BigQuery jobs.\n+\n+#### Prerequisites\n+\n+[BigQueryAuditMetadata](https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata)\n+\n+1.  Define a BigQuery log sink using any of the following methods:\n+    *   [gcloud command](https://cloud.google.com/bigquery/docs/reference/auditlogs#defining_a_bigquery_log_sink_using_gcloud)\n+        ```\n+        gcloud alpha logging sinks create my-example-sink \\ \n+        bigquery.googleapis.com/projects/my-project-id/datasets/auditlog_dataset \\\n+        --log-filter='protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason=\"QUERY\")' \\ \n+        --use-partitioned-tables\n+        ``` \n+        Note: gcloud **alpha** is needed in order to use the parameter `--use-partitioned-tables` \n+    *   [Cloud Console Logs Viewer](https://cloud.google.com/logging/docs/export/configure_export_v2#dest-create)\n+        Use this filter:\n+        #### protoPayload.metadata.@type=\"type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata\" AND ( (protoPayload.metadata.jobChange.job.jobConfig.queryConfig.statementType=\"SCRIPT\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\" ) OR ( protoPayload.metadata.jobChange.job.jobStats.parentJobName!=\"\" AND protoPayload.metadata.jobChange.job.jobStatus.jobState=\"DONE\") OR protoPayload.metadata.tableDataChange.reason!=\"\" OR protoPayload.metadata.tableDataRead.reason!=\"\"  OR protoPayload.metadata.tableDeletion.reason!=\"\" )\n+        *   [Partitioning](https://cloud.google.com/logging/docs/export/bigquery#partition-tables)\n+            is not required, but it is strongly recommended to select it for your BigQuery destination\n+            \n+    Note: You can create a log sink at the folder, billing account, or organization level using an \n+    [aggregated sink](https://cloud.google.com/logging/docs/export/aggregated_sinks#creating_an_aggregated_sink).\n+1.  The log sink will immediately create the BigQuery dataset but the table will\n+    be created once you run a BigQuery job post log sink creation.\n+1.  To use the SELECT statement in\n+    [big_query_elt_audit_log_v2.sql](/views/audit/big_query_elt_audit_log_v2.sql), change\n+    all occurrences of\n+    `project_id.dataset_id.cloudaudit_googleapis_com_data_access` to be the full\n+    table path you created in step 1.\n+    *   `sed\n+        's/project_id.dataset_id.cloudaudit_googleapis_com_data_access/YOUR_PROJECT.YOUR_DATASET.YOUR_TABLE/'\n+        big_query_elt_audit_log_v2.sql`\n+1.  From here, you can do further analysis in BigQuery by querying the view, or\n+    you can connect it to a BI tool such as DataStudio as a data source and\n+    build dashboards.\n+    \n+#### Usage Examples\n+Change all occurrences of `YOUR_VIEW` to the full path to the view. \n+\n+* Run this query to see a detailed list of scripts which modified tables. The results are ordered with the most recent script runs first, and then further ordering is applied using the script's job id.\n+  \n+  \n+  ```  \n+  SELECT \n+   COALESCE(jobChange.jobStats.parentJobName, jobId) AS common_script_job_id,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d57fafb711a9007ddebb1650873d94a732ac4c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b33f565f2643657c5747271f5829a31b52c61b36", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b33f565f2643657c5747271f5829a31b52c61b36", "committedDate": "2020-08-18T19:11:53Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e64dc4ce662ba0c2709af9a165308d588ee625", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/18e64dc4ce662ba0c2709af9a165308d588ee625", "committedDate": "2020-08-18T19:12:57Z", "message": "Update big_query_elt_script_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a3cada9693cc09f5033664327a3124a769f8b0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f9a3cada9693cc09f5033664327a3124a769f8b0", "committedDate": "2020-08-18T20:20:51Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "916d765cb00873a684b054fe3a016ca02e1c0640", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/916d765cb00873a684b054fe3a016ca02e1c0640", "committedDate": "2020-08-18T20:59:47Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f7f5d9c02e59c664b609deca6d8fc253aae772", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/76f7f5d9c02e59c664b609deca6d8fc253aae772", "committedDate": "2020-08-19T02:51:52Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd8bddaeee5befb25185452f4cd4916041f8342", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5bd8bddaeee5befb25185452f4cd4916041f8342", "committedDate": "2020-08-19T02:54:00Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54962648532b6f892939ec5560992322f468ff9d", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/54962648532b6f892939ec5560992322f468ff9d", "committedDate": "2020-08-19T02:55:39Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a4cb8320ec2af1e1e8a2728837d3a4f772d0529", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0a4cb8320ec2af1e1e8a2728837d3a4f772d0529", "committedDate": "2020-08-19T03:18:42Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aa2c81a5f64215d9215859fdb9e3350a1fab183", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7aa2c81a5f64215d9215859fdb9e3350a1fab183", "committedDate": "2020-08-19T03:21:31Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDk3Nzg2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-470097786", "createdAt": "2020-08-19T03:22:52Z", "commit": {"oid": "7aa2c81a5f64215d9215859fdb9e3350a1fab183"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3de1085556d8fbf8bc0a0f7a7226b03c1153319", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f3de1085556d8fbf8bc0a0f7a7226b03c1153319", "committedDate": "2020-02-26T23:54:50Z", "message": "Create query_audit_v2.sql\n\nThis file is a view and would act as guide for customers using the latest version of BigQuery audit logs (BigQueryAuditMetadata) to easily query on log data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "759d54e3f73cd988f9f5a117948e92328dd2a0b0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/759d54e3f73cd988f9f5a117948e92328dd2a0b0", "committedDate": "2020-03-02T19:14:49Z", "message": "Create README"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2c5c8d1b97825a3d50f609a0555e5c9ee457975", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c2c5c8d1b97825a3d50f609a0555e5c9ee457975", "committedDate": "2020-03-03T03:15:53Z", "message": "Rename query_audit.sql to query_audit_v2.sql\n\nChanged project path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a0e7772854cb764ac80f6dda05c9b7436d0bd7b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7a0e7772854cb764ac80f6dda05c9b7436d0bd7b", "committedDate": "2020-03-03T20:32:51Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4273f798f5b044de82afbb80ae9fe067aac2e3a3", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4273f798f5b044de82afbb80ae9fe067aac2e3a3", "committedDate": "2020-03-03T20:34:41Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2e1dc508e731198864462235c521911ff1ca0f0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b2e1dc508e731198864462235c521911ff1ca0f0", "committedDate": "2020-03-03T23:52:51Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d2153b5a72ee43e196a50191a5892e8b4efc5a9", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3d2153b5a72ee43e196a50191a5892e8b4efc5a9", "committedDate": "2020-03-04T00:13:28Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c47b2ea272dd9a035528be4d646d9ade42bc3245", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c47b2ea272dd9a035528be4d646d9ade42bc3245", "committedDate": "2020-03-05T00:02:24Z", "message": "Update and rename README to README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90060577b029eb46ae4cb74a74cdcbf5e779f2e0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/90060577b029eb46ae4cb74a74cdcbf5e779f2e0", "committedDate": "2020-03-05T00:03:33Z", "message": "Update and rename query_audit_v2.sql to query_audit_new.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d89d880587a2703fb6e5e7e30f63752a8b1ba097", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d89d880587a2703fb6e5e7e30f63752a8b1ba097", "committedDate": "2020-03-05T00:15:41Z", "message": "Rename query_audit_new.sql to query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9723dec0755debd0f5e1007e6b12e7cb930dc0d4", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9723dec0755debd0f5e1007e6b12e7cb930dc0d4", "committedDate": "2020-03-05T17:56:50Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2412256c8a7adf609a61b07ca136a75b6bc3908", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e2412256c8a7adf609a61b07ca136a75b6bc3908", "committedDate": "2020-03-05T17:58:10Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d998fcd2c454911b9085f05aa4cec2d9e712d7cd", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d998fcd2c454911b9085f05aa4cec2d9e712d7cd", "committedDate": "2020-03-05T17:58:59Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a56202600bf351a33cdcf3b38eb0001ab4049b6a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a56202600bf351a33cdcf3b38eb0001ab4049b6a", "committedDate": "2020-03-05T17:59:28Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1795f831740547706d1162291e1868e43808a65a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1795f831740547706d1162291e1868e43808a65a", "committedDate": "2020-03-05T18:12:43Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e262734513a4d857c7a49f4746942d4891a49a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b0e262734513a4d857c7a49f4746942d4891a49a", "committedDate": "2020-03-05T18:36:36Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b96df9a50aa29a55c963ae494ed6fc4cf78248c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5b96df9a50aa29a55c963ae494ed6fc4cf78248c", "committedDate": "2020-03-05T20:49:35Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35632a913c0b3dd9e5b1c826197bc1c3dc76feed", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/35632a913c0b3dd9e5b1c826197bc1c3dc76feed", "committedDate": "2020-03-05T20:53:05Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b43ec5ac5a9adcb73c594383532795138373d88", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1b43ec5ac5a9adcb73c594383532795138373d88", "committedDate": "2020-03-06T16:22:23Z", "message": "Update query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc9faafde824834a27ef0043918ff442a52e83d9", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/fc9faafde824834a27ef0043918ff442a52e83d9", "committedDate": "2020-03-06T21:09:44Z", "message": "Create bigquery_audit_log.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5818057d9e7202937be8449c9159c792a0abb9e0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5818057d9e7202937be8449c9159c792a0abb9e0", "committedDate": "2020-03-06T21:11:54Z", "message": "Rename query_audit_v2.sql to big_query_audit_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81bc0d11cec84704d45fca523b307049eb79b196", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/81bc0d11cec84704d45fca523b307049eb79b196", "committedDate": "2020-03-06T21:12:17Z", "message": "Rename big_query_audit_v2.sql to big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715634e5c112c44536c88a659791fdb7915b09c0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/715634e5c112c44536c88a659791fdb7915b09c0", "committedDate": "2020-03-09T04:31:05Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cea2d81a61c9b778b64b2d91d6253e5b0a4dc6d", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8cea2d81a61c9b778b64b2d91d6253e5b0a4dc6d", "committedDate": "2020-03-09T04:53:42Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0854e3243017cae4fd278cc84f57c11200dd632", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b0854e3243017cae4fd278cc84f57c11200dd632", "committedDate": "2020-03-09T16:40:35Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "644985fd7f05c3490ef21b937b2898e2f3996026", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/644985fd7f05c3490ef21b937b2898e2f3996026", "committedDate": "2020-03-09T17:22:23Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89175f5d860123717adb5c08cd6c6d944b3b27ce", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/89175f5d860123717adb5c08cd6c6d944b3b27ce", "committedDate": "2020-03-09T19:16:01Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "745c8b5d45f309b5a454906cf5f56da58ae665ff", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/745c8b5d45f309b5a454906cf5f56da58ae665ff", "committedDate": "2020-03-09T21:17:34Z", "message": "Update big_query_audit_log_v2.sql\n\nAdded struct for JobStatus and JobStats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46074d711ef42da25b6dd1de2ba17fb87044e02f", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/46074d711ef42da25b6dd1de2ba17fb87044e02f", "committedDate": "2020-03-09T21:33:39Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "450c057d4ca369dceb34e6589d322507b4c96a78", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/450c057d4ca369dceb34e6589d322507b4c96a78", "committedDate": "2020-03-11T20:30:32Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27fe0257155148c4e2852f2bffe41eb5e3fcb339", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/27fe0257155148c4e2852f2bffe41eb5e3fcb339", "committedDate": "2020-03-11T23:01:22Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53049ece0370800aff54a54994a846196aff4525", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/53049ece0370800aff54a54994a846196aff4525", "committedDate": "2020-03-11T23:02:40Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4de1e1ccdd4f634b577e157ee4094c96913b27", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ce4de1e1ccdd4f634b577e157ee4094c96913b27", "committedDate": "2020-03-12T14:24:03Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c49fb9d085a41b3a4f40b712be8a049d7e42d783", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c49fb9d085a41b3a4f40b712be8a049d7e42d783", "committedDate": "2020-03-12T14:24:38Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e5c63a8a03b3fcc5221926babcd7bc8a6d672f1", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9e5c63a8a03b3fcc5221926babcd7bc8a6d672f1", "committedDate": "2020-03-12T15:57:20Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f0d1147595bcf2a597e72c8e7ab7821866d56c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f6f0d1147595bcf2a597e72c8e7ab7821866d56c", "committedDate": "2020-03-12T16:04:45Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c12aaace87f7a9d0f069f97f4cf16a921968cc03", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c12aaace87f7a9d0f069f97f4cf16a921968cc03", "committedDate": "2020-03-12T16:05:37Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6441b5c5219cb9879bd0c49670b07324397189a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c6441b5c5219cb9879bd0c49670b07324397189a", "committedDate": "2020-03-12T16:10:26Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c418427401a6bdff244fbc8aad321d3abb9636f0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c418427401a6bdff244fbc8aad321d3abb9636f0", "committedDate": "2020-03-12T16:14:32Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd63778768a71ce0a85885479f21526d7698013", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0bd63778768a71ce0a85885479f21526d7698013", "committedDate": "2020-03-12T19:20:26Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1691d61e3191f928c45f68d7c13f490bb7a247e4", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1691d61e3191f928c45f68d7c13f490bb7a247e4", "committedDate": "2020-03-12T19:52:56Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c887f8bfb537ca3453829801dcdfa3c88105b185", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c887f8bfb537ca3453829801dcdfa3c88105b185", "committedDate": "2020-03-12T19:55:48Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62a084886376a879558eb5793c5d41c24218f307", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/62a084886376a879558eb5793c5d41c24218f307", "committedDate": "2020-03-12T19:58:27Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c9b51c8ff470f0d063e4eb0cf40b0b55b1ada6b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1c9b51c8ff470f0d063e4eb0cf40b0b55b1ada6b", "committedDate": "2020-03-12T20:10:45Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb29c4a4f8f34ec9b592af719ea03de92a331fdb", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/fb29c4a4f8f34ec9b592af719ea03de92a331fdb", "committedDate": "2020-03-12T20:15:14Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2ab114393b02ecd4f7643495f48e8c2082c6e83", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b2ab114393b02ecd4f7643495f48e8c2082c6e83", "committedDate": "2020-03-12T20:47:19Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ed93dcea8bc1cd20c6c67873c686b837e2f51b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d7ed93dcea8bc1cd20c6c67873c686b837e2f51b", "committedDate": "2020-03-12T21:17:45Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f3753419568b4d94888929f22930cd66ff1f96", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/11f3753419568b4d94888929f22930cd66ff1f96", "committedDate": "2020-03-12T21:18:58Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3ff57102452c24bac15acff8da41c0290f2c7e8", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b3ff57102452c24bac15acff8da41c0290f2c7e8", "committedDate": "2020-03-12T21:19:11Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1a48e4b487a2a2403905bb7401a78f2a44102b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5b1a48e4b487a2a2403905bb7401a78f2a44102b", "committedDate": "2020-03-12T21:19:43Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da9b2bde07b5584f8a10119f47f2ce79f778b40", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/2da9b2bde07b5584f8a10119f47f2ce79f778b40", "committedDate": "2020-03-12T21:20:02Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "371037724e0506a94925e9158497284c681ea04e", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/371037724e0506a94925e9158497284c681ea04e", "committedDate": "2020-03-12T21:20:41Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26283d4535c913d9f39755aa276c2216ed641450", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/26283d4535c913d9f39755aa276c2216ed641450", "committedDate": "2020-03-12T21:22:21Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ab79291f852fd0b0c574e4688a027faea14ee42", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7ab79291f852fd0b0c574e4688a027faea14ee42", "committedDate": "2020-03-13T14:30:35Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25c412929c7bdcb5998c238413caee71c705242", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a25c412929c7bdcb5998c238413caee71c705242", "committedDate": "2020-03-13T14:50:42Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e82677bd1bfe09d8aeeaf05e099da8b3a465f14f", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e82677bd1bfe09d8aeeaf05e099da8b3a465f14f", "committedDate": "2020-03-16T14:31:16Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce95caf3be53a8f039033f19c486a29d65d6b635", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ce95caf3be53a8f039033f19c486a29d65d6b635", "committedDate": "2020-03-16T18:13:01Z", "message": "Update big_query_audit_log_v2.sql\n\nParsing all array of strings correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecde734314952818c43aedd6d4f8f3c2a8c2ced6", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ecde734314952818c43aedd6d4f8f3c2a8c2ced6", "committedDate": "2020-03-16T18:27:11Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca810f230d16780ca49f5d6bc1da3e6ce46a1110", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ca810f230d16780ca49f5d6bc1da3e6ce46a1110", "committedDate": "2020-03-16T21:39:21Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "821ace1462cce0c6596ae7cc222ac3f0a16c8428", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/821ace1462cce0c6596ae7cc222ac3f0a16c8428", "committedDate": "2020-03-18T22:33:25Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fa410cd58ddd243b2bb5287ec6f6a793259f18", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c1fa410cd58ddd243b2bb5287ec6f6a793259f18", "committedDate": "2020-03-20T23:02:32Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0537d26dfd7a2dc0457af64771e1bbd156b6805e", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0537d26dfd7a2dc0457af64771e1bbd156b6805e", "committedDate": "2020-03-20T23:09:27Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b92bc6ecf54bbd0d3b89ed2a07f97ad5747ed4", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/65b92bc6ecf54bbd0d3b89ed2a07f97ad5747ed4", "committedDate": "2020-03-20T23:47:14Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1f052e6691de4cb53eb24306bb8824b69a19f7", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4e1f052e6691de4cb53eb24306bb8824b69a19f7", "committedDate": "2020-03-20T23:57:57Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ba54358faec44a3e08ac367bf92a6320924eab", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/63ba54358faec44a3e08ac367bf92a6320924eab", "committedDate": "2020-03-22T19:09:04Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffff685c2787252b3295d2e488355eb9ce826461", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ffff685c2787252b3295d2e488355eb9ce826461", "committedDate": "2020-03-22T19:22:15Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f224dc2e93f5c4c6235a4fdf35452c1ddcbccb", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/51f224dc2e93f5c4c6235a4fdf35452c1ddcbccb", "committedDate": "2020-03-22T19:45:02Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8291e078ef1c8e66ba5a1913140c9960d6dac784", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8291e078ef1c8e66ba5a1913140c9960d6dac784", "committedDate": "2020-03-22T19:47:33Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e5e5bb61a5267a32c26560deeea0bce3d3683e", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d2e5e5bb61a5267a32c26560deeea0bce3d3683e", "committedDate": "2020-03-22T19:51:20Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82401f2bea9a52134a9612d0cfd335512ce2992b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/82401f2bea9a52134a9612d0cfd335512ce2992b", "committedDate": "2020-03-22T20:08:30Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be6b109d9b0081db1cfd8d879da40b28d39fdfd", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8be6b109d9b0081db1cfd8d879da40b28d39fdfd", "committedDate": "2020-03-22T20:52:35Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1097e139c6b3e8bbd2d75c8ab5859953f58c0253", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1097e139c6b3e8bbd2d75c8ab5859953f58c0253", "committedDate": "2020-03-22T20:53:45Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "006fd20f0db2d29d5dab859e8db5e78332478f2b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/006fd20f0db2d29d5dab859e8db5e78332478f2b", "committedDate": "2020-05-06T14:21:56Z", "message": "Update big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85d1ceff081ef5beaf40de3cf9f57f69accf15b1", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/85d1ceff081ef5beaf40de3cf9f57f69accf15b1", "committedDate": "2020-05-06T16:27:06Z", "message": "Create etl_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483775a1fcddfef2ee87859d292d46d1b24230f9", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/483775a1fcddfef2ee87859d292d46d1b24230f9", "committedDate": "2020-05-06T16:28:51Z", "message": "Delete etl_logging.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dba7db0d6ef9e91d2daaf9b8acfe611c7c9d49c4", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/dba7db0d6ef9e91d2daaf9b8acfe611c7c9d49c4", "committedDate": "2020-05-06T16:49:20Z", "message": "Delete bigquery_audit_log.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eb7baa39d6fc84a2487fdac7a4ed3852e688d7c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5eb7baa39d6fc84a2487fdac7a4ed3852e688d7c", "committedDate": "2020-05-06T16:49:56Z", "message": "Delete query_audit.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99a62ac2cf4af7b58b97157627eb006ea15c241c", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/99a62ac2cf4af7b58b97157627eb006ea15c241c", "committedDate": "2020-05-06T16:51:19Z", "message": "Create big_query_etl_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecc1e40f22208279465d7e1758debc959a277a1a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ecc1e40f22208279465d7e1758debc959a277a1a", "committedDate": "2020-05-06T17:00:05Z", "message": "Delete big_query_audit_log_v2.sql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODk1ODkw", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-406895890", "createdAt": "2020-05-06T18:51:55Z", "commit": {"oid": "ecc1e40f22208279465d7e1758debc959a277a1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1MTo1NlrOGRg21g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1MTo1NlrOGRg21g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNzMwMg==", "bodyText": "Remove obfuscation", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r421017302", "createdAt": "2020-05-06T18:51:56Z", "author": {"login": "danieldeleo"}, "path": "views/audit/big_query_etl_audit_log_v2.sql", "diffHunk": "@@ -0,0 +1,1142 @@\n+*\n+ * Script: BQ Audit Version 2\n+ * Author: NamrataShah5, danieldeleo\n+ * Description:\n+ * This SQL script parses ETL job events from\n+ * the newer BigQueryAuditMetadata Stackdriver logs.\n+ * Reference for BigQueryAuditMetadata: https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata\n+ */\n+\n+WITH jobChangeEvent AS (\n+  SELECT\n+    protopayload_auditlog.authenticationInfo.principalEmail,\n+    resource.labels.project_id AS projectId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.requestMetadata.callerIp') AS callerIp,\n+    protopayload_auditlog.serviceName,\n+    protopayload_auditlog.methodName,\n+    COALESCE(\n+      CONCAT(\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+        \":\",\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+      ),\n+      CONCAT(\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName'),\"/\")[SAFE_OFFSET(1)],\n+        \":\",\n+        SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName'),\"/\")[SAFE_OFFSET(3)]\n+      )\n+    ) AS jobId,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.job.jobName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobInsertion.job.jobName')) AS jobChangeJobName,\n+    /*\n+     * JobStatus: Running state of a job\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstatus\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.jobState'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.jobState')\n+    ) AS jobStatusJobState,\n+    SPLIT(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult'),JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.code')),\"/\")[SAFE_OFFSET(1)],\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.code'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.code')\n+    ) AS jobStatusErrorResultCode,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.message'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.message')\n+    ) AS jobStatusErrorResultMessage,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errorResult.details'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errorResult.details')\n+    ) AS jobStatusErrorResultDetails,\n+    REGEXP_EXTRACT_ALL(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errors'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors')\n+      ),r'\"message\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorMessages,\n+    REGEXP_EXTRACT_ALL(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStatus.errors'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStatus.errors')\n+      ),r'\"code\":\\\"(.*?)\\\"}'\n+    ) AS jobStatusEncounteredErrorCodes,\n+    /*\n+     * JobStats: Job statistics that may change after job starts.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#jobstats\n+     */\n+    JSON_EXTRACT_SCALAR(\n+      protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.parentJobName') AS jobStatsParentJobName,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobInsertion.job.jobStats.createTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.createTime'))\n+    ) AS jobStatsCreateTime,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobInsertion.job.jobStats.startTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(\n+       protopayload_auditlog.metadataJson,'$.jobChange.job.jobStats.startTime'))\n+    ) AS jobStatsStartTime,\n+    COALESCE(\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.endTime')),\n+      TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.endTime'))\n+    ) AS jobStatsEndTime,\n+    COALESCE(\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.totalSlotMs') AS INT64),\n+      CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.totalSlotMs') AS INT64)\n+    ) AS jobStatsTotalSlotMs,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.reservationUsage.name'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.reservationUsage.name')\n+    ) AS jobStatsReservationUsageName,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.reservationUsage.slotMs'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.reservationUsage.slotMs')\n+    ) AS jobStatsReservationUsageSlotMs,\n+    /*\n+     * Query: Query job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query_1\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.totalProcessedBytes'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.totalProcessedBytes')\n+    ) AS queryJobStatsTotalProcessedBytes,\n+    COALESCE(\n+      CAST(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.totalBilledBytes') AS INT64),\n+       CAST(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.totalBilledBytes') AS INT64)\n+    ) AS queryJobStatsTotalBilledBytes,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.billingTier'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.billingTier')\n+    ) AS queryJobStatsBillingTier,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedTables'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedTables')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedTables,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedViews'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedViews')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedViews,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.queryStats.referencedRoutines'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.queryStats.referencedRoutines')\n+      ), '[\"'), '\"]'), '\",\"') AS queryJobStatsReferencedRoutines,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.outputRowCount'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.outputRowCount')\n+    ) AS queryJobStatsOutputRowCount,\n+    CAST(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobStats.queryStats.cacheHit'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.cacheHit')\n+    ) AS BOOL) AS queryJobStatsCacheHit,\n+    /*\n+     * Load: Load job statistics\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load_1\n+     */\n+    CAST(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.loadStats.totalOutputBytes') AS INT64 ) AS loadJobStatsTotalOutputBytes,\n+    /*\n+     * JobStats convenience custom fields\n+     */\n+    COALESCE(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobInsertion.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobInsertion.job.jobStats.startTime')),\n+        MILLISECOND),\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.jobChange.job.jobStats.startTime')),\n+        MILLISECOND)\n+      ) AS jobStatsRuntimeMs,\n+    COALESCE(\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobInsertion.job.jobStats.startTime')),\n+        SECOND),\n+      TIMESTAMP_DIFF(\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.endTime')),\n+        TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.jobChange.job.jobStats.startTime')),\n+        SECOND)\n+      ) AS jobStatsRuntimeSecs,\n+    COALESCE(\n+      CAST(CEILING(\n+        TIMESTAMP_DIFF(\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobInsertion.job.jobStats.endTime')),\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobInsertion.job.jobStats.startTime')),\n+          SECOND) / 60 ) AS INT64),\n+      CAST(CEILING(\n+        TIMESTAMP_DIFF(\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobChange.job.jobStats.endTime')),\n+          TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.jobChange.job.jobStats.startTime')),\n+          SECOND) / 60) AS INT64)\n+      ) AS jobStatsExecutionMinuteBuckets,\n+    /*\n+     * Describes a query job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#query\n+     */\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.query'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.query')) AS queryConfigQuery,\n+    CAST(COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.queryTruncated'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.queryTruncated')) AS BOOL) AS queryConfigQueryTruncated,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.destinationTable'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable')) AS queryConfigDestinationTable,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.createDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.createDisposition')) AS queryConfigCreateDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.writeDisposition'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.writeDisposition')) AS queryConfigWriteDisposition,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.defaultDataset'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.defaultDataset')) AS queryConfigDefaultDataset,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.priority'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.priority')) AS queryConfigPriority,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTableEncryption.kmsKeyName')\n+      ) AS queryConfigDestinationTableEncryptionKmsKeyName,\n+    COALESCE(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobInsertion.job.jobConfig.queryConfig.statementType'),\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.statementType')) AS queryConfigStatementType,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(1)] AS queryConfigDestinationTableProjectId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(3)] AS queryConfigDestinationTableDatasetId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.queryConfig.destinationTable'),\n+      \"/\")[SAFE_OFFSET(5)] AS queryConfigDestinationTableId,\n+    /*\n+     * Describes a load job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#load\n+     */\n+    SPLIT(TRIM(TRIM(\n+      JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobStats.queryStats.sourceUris'),\n+      '[\"'), '\"]'), '\",\"') AS loadConfigSourceUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.sourceUrisTruncated') AS BOOL) AS loadConfigSourceUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJson') AS loadConfigSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.schemaJsonUrisTruncated') AS BOOL) AS loadConfigSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTable') AS loadConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.createDisposition') AS loadConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.writeDisposition') AS loadConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.loadConfig.destinationTableEncryption.kmsKeyName'\n+      ) AS loadConfigDestinationTableEncryptionKmsKeyName,\n+    /*\n+     * Describes an extract job.\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#extract\n+     */\n+    SPLIT(TRIM(TRIM(\n+      JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.destinationUris'),\n+      '[\"'), '\"]'), '\",\"') AS extractConfigDestinationUris,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.destinationUrisTruncated')\n+       AS BOOL) AS extractConfigDestinationUrisTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.extractConfig.sourceTable') AS extractConfigSourceTable,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(1)] AS extractConfigSourceTableProjectId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(3)] AS extractConfigSourceTableDatasetId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.extractConfig.sourceTable'),\n+      \",\")[SAFE_OFFSET(5)] AS extractConfigSourceTableId,\n+    /*\n+     * Describes a copy job, which copies an existing table to another table\n+     * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecopy\n+     */\n+    SPLIT(TRIM(TRIM(\n+      JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.sourceTables'),\n+      '[\"'),'\"]') ,'\",\"') AS tableCopySourceTables,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.sourceTablesTruncated')\n+      AS BOOL) AS tableCopyConfigSourceTablesTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable') AS tableCopyConfigDestinationTable,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.createDisposition') AS tableCopyConfigCreateDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.writeDisposition') AS tableCopyConfigWriteDisposition,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.jobChange.job.jobConfig.tableCopyConfig.destinationTableEncryption.kmsKeyName'\n+    ) AS tableCopyConfigDestinationTableEncryptionKmsKeyName,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(1)] AS tableCopyConfigProjectId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(2)] AS tableCopyConfigDatasetId,\n+    SPLIT(\n+      JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.jobChange.job.jobConfig.tableCopyConfig.destinationTable'),\n+      \".\")[SAFE_OFFSET(3)] AS tableCopyConfigTableId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.before') AS jobChangeBefore,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.jobChange.after') AS jobChangeAfter,\n+    REGEXP_EXTRACT(protopayload_auditlog.metadataJson, r'BigQueryAuditMetadata\",\"(.*?)\":') AS eventName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableCreation: Table creation event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tablecreation\n+ */\n+tableCreationEvent AS (\n+  SELECT\n+    CONCAT(\n+     SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableCreation.jobName'),\"/\")[SAFE_OFFSET(1)],\n+       \":\",\n+     SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableCreation.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+    '$.tableCreation.jobName') AS tableCreationJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.tableName') AS tableCreationTableName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.tableInfo.friendlyName') AS tableCreationTableFriendlyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.tableInfo.description') AS tableCreationTableDescription,\n+    JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.tableInfo.labels') AS tableCreationTableLabels,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.schemaJson') AS tableCreationTableSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableCreation.table.schemaJsonTruncated') AS BOOL) AS tableCreationTableSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.view.query') AS tableCreationViewDefinitionQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.view.queryTruncated') AS BOOL) AS tableCreationViewDefinitionTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.expireTime') AS tableCreationTableExpireTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.createTime') AS tableCreationTableCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCrhange.table.updateTime') AS tableCreationTableUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.truncateTime') AS tableCreationTableTruncateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.table.encryption.kmsKeyName') AS tableCreationTableKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCreation.reason')  AS tableCreationReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access` ),\n+/*\n+ * TableChange: Table metadata change event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#TableChange\n+ */\n+tableChangeEvent AS (\n+  SELECT\n+    CONCAT(\n+     SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableChange.jobName'),\"/\")[SAFE_OFFSET(1)],\n+       \":\",\n+     SPLIT(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableChange.jobName'),\"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+    '$.tableChange.jobName') AS tableChangeJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.tableName') AS tableChangeTableName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.tableInfo.friendlyName') AS tableChangeTableFriendlyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.tableInfo.description') AS tableChangeTableDescription,\n+    JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.tableInfo.labels') AS tableChangeTableLabels,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.schemaJson') AS tableChangeTableSchemaJson,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+     '$.tableChange.table.schemaJsonTruncated') AS BOOL) AS tableChangeTableSchemaJsonTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.view.query') AS tableChangeViewDefinitionQuery,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.view.queryTruncated') AS BOOL) AS tableChangeViewDefinitionTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.expireTime') AS tableChangeTableExpireTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.createTime') AS tableChangeTableCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableCrhange.table.updateTime') AS tableChangeTableUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.truncateTime') AS tableChangeTableTruncateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.table.encryption.kmsKeyName') AS tableChangeTableKmsKeyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.reason')  AS tableChangeReason,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableChange.truncated') AS BOOL) AS tableChangeTruncated\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access` ),\n+/*\n+ * TableDeletion: Table deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledeletion\n+ */\n+tableDeletionEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+      ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDeletion.jobName') AS tableDeletionJobName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDeletion.table.reason') AS tableDeletionReason,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`),\n+/*\n+ * TableDataRead: Data from tableDataRead audit logs\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledataread\n+ */\n+tableDataReadEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    SPLIT(TRIM(TRIM(\n+      COALESCE(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields'),\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fields')),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadFields,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.fieldsTruncated') AS BOOL) AS tableDataReadFieldsTruncated,\n+     SPLIT(TRIM(TRIM(\n+        JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categories'),\n+        '[\"'),'\"]'),'\",\"') AS tableDataReadCategories,\n+     CAST(JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.categoriesTruncated') AS BOOL) AS tableDataReadCategoriesTruncated,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.reason') AS tableDataReadReason,\n+     JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.jobName') AS tableDataReadJobName,\n+     JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+          '$.tableDataRead.sessionName') AS tableDataReadSessionName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * TableDataChange: Table data change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#tabledatachange\n+ */\n+tableDataChangeEvent AS (\n+  SELECT\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, '$.tableDataChange.jobName'),\n+      \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.tableDataChange.jobName'),\n+        \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.deletedRowsCount') AS tableDataChangeDeletedRowsCount,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.datasetCreation.dataset.insertedRowsCount') AS tableDataChangeInsertedRowsCount,\n+    CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.truncated') AS BOOL) AS tableDataChangeTruncated,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.reason') AS tableDataChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.tableDataChange.jobName') AS tableDataChangeJobName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * ModelDeletion: Model deletion event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#modeldeletion\n+ */\n+modelDeletionEvent AS (\n+  SELECT\n+    JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+         '$.modelDeletion.reason') AS modelDeletionReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.modelDeletion.jobName') AS modelDeletionJobName,\n+    CONCAT(\n+     SPLIT(\n+       JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+           '$.modelDeletion.jobName'),\n+           \"/\")[SAFE_OFFSET(1)],\n+     \":\",\n+     SPLIT(\n+       JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+         '$.modelDeletion.jobName'),\n+           \"/\")[SAFE_OFFSET(3)]\n+   ) AS jobId,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * ModelCreation: Model creation event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#modelcreation\n+ */\n+modelCreationEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.reason')  AS modelCreationReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.jobName') AS modelCreationJobName,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.modelCreation.jobName'),\n+           \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.modelCreation.jobName'),\n+         \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.modelName')  AS modelCreationModelName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.modelInfo.entityInfo.friendlyName')  AS modelCreationEntityInfoFriendlyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.modelInfo.entityInfo.description')  AS modelCreationEntityInfoDescription,\n+    JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.modelInfo.entityInfo.labels')  AS modelCreationEntityInfoLabels,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.expireTime')  AS modelCreationModelExpireTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.createTime')  AS modelCreationModelCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.updateTime')  AS modelCreationModelUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelCreation.model.encryption.kmsKeyName')  AS modelCreationEncryptionKmsKeyName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * ModelMetadataChange: Model metadata change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#modelmetadatachange\n+ */\n+modelMetadataChangeEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.reason') AS modelMetadataChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.jobName') AS modelMetadataChangeJobName,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.modelMetadataChange.jobName'),\n+           \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.modelMetadataChange.jobName'),\n+         \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.modelName') AS modelMetadataChangeModelName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.modelInfo.entityInfo.friendlyName') AS modelMetadataChangeEntityInfoFriendlyName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.modelInfo.entityInfo.description') AS modelMetadataChangeEntityInfoDescription,\n+    JSON_EXTRACT(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.modelInfo.entityInfo.labels') AS modelMetadataChangeEntityInfoLabels,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.expireTime') AS modelMetadataChangeModelExpireTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.createTime') AS modelMetadataChangeModelCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.updateTime') AS modelMetadataChangeModelUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.modelMetadataChange.model.encryption.kmsKeyName') AS modelMetadataChangeEncryptionKmsKeyName,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * ModelDataChange: Model data change event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#modeldatachange\n+ */\n+modelDataChangeEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+        '$.modelDataChange.reason')\n+    AS modelDataChangeReason,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.modelDataChange.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.modelDataChange.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * RoutineCreation: Routine creation event.\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#routinecreation\n+ */\n+routineCreationEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineCreation.routine.routineName') AS routineCreationName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineCreation.routine.createTime') AS routineCreationCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineCreation.routine.updateTime') AS routineCreationUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineCreation.reason') AS routineCreationReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineCreation.jobName') AS routineCreationJobName,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.routineCreation.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.routineCreation.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * RoutineChange: Routine change event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#routinechange\n+ */\n+routineChangeEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineChange.routine.routineName') AS routineChangeName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineChange.routine.createTime') AS routineChangeCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineChange.routine.updateTime') AS routineChangeUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineChange.reason') AS routineChangeReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineChange.jobName') AS routineChangeJobName,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.routineChange.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.routineChange.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+),\n+/*\n+ * RoutineDeletion: Routine deletion event\n+ * https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/BigQueryAuditMetadata#routinedeletion\n+ */\n+routineDeletionEvent AS (\n+  SELECT\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineDeletion.routine.routineName') AS routineDeletionName,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineDeletion.routine.createTime') AS routineDeletionCreateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineDeletion.routine.updateTime') AS routineDeletionUpdateTime,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineDeletion.reason') AS routineDeletionReason,\n+    JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+      '$.routineDeletion.jobName') AS routineDeletionJobName,\n+    CONCAT(\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+            '$.routineDeletion.jobName'),\n+            \"/\")[SAFE_OFFSET(1)],\n+      \":\",\n+      SPLIT(\n+        JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson,\n+          '$.routineDeletion.jobName'),\n+            \"/\")[SAFE_OFFSET(3)]\n+    ) AS jobId,\n+  FROM `project_id.dataset_id.cloudaudit_googleapis_com_data_access`\n+) -- End of WITH clauses\n+SELECT\n+  SHA1(principalEmail) AS principalEmail,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc1e40f22208279465d7e1758debc959a277a1a"}, "originalPosition": 762}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b90c5cedea8e6026c418f55487035464aa41288", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4b90c5cedea8e6026c418f55487035464aa41288", "committedDate": "2020-05-08T20:22:49Z", "message": "Update big_query_etl_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b0f14cc8fcad4c3b9a72b7afb199fa18f2a41f", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/90b0f14cc8fcad4c3b9a72b7afb199fa18f2a41f", "committedDate": "2020-05-08T20:39:51Z", "message": "Update big_query_etl_audit_log_v2.sql\n\nRemoved TableCreation, TableDeletion, TableChange, modelDeletionEvent, modelCreationEvent, modelMetadataChange, routineCreationEvent, routineChangeEvent, routineDeletionEvent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5045c1f2128744f307b47da87d650bae245caf89", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5045c1f2128744f307b47da87d650bae245caf89", "committedDate": "2020-05-08T22:04:58Z", "message": "Update big_query_etl_audit_log_v2.sql\n\nDeleted routine creation, routine deletion, routine change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf6dfa44bfd7b7c48696046657f901e34a61047", "author": {"user": {"login": "danieldeleo", "name": "Daniel De Leo"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5cf6dfa44bfd7b7c48696046657f901e34a61047", "committedDate": "2020-05-28T19:20:37Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDE4MjM4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#pullrequestreview-420418238", "createdAt": "2020-05-28T19:22:46Z", "commit": {"oid": "5045c1f2128744f307b47da87d650bae245caf89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOToyMjo0NlrOGcDPQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOToyMjo0NlrOGcDPQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2NjM2OQ==", "bodyText": "Don't delete this file as part of this PR", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/56#discussion_r432066369", "createdAt": "2020-05-28T19:22:46Z", "author": {"login": "danieldeleo"}, "path": "views/audit/query_audit.sql", "diffHunk": "@@ -1,140 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5045c1f2128744f307b47da87d650bae245caf89"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64cbef76d66b41957d7bec86c5825f79c6113dc5", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/64cbef76d66b41957d7bec86c5825f79c6113dc5", "committedDate": "2020-06-11T23:00:22Z", "message": "Create query_audit.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbdc58dd3687eaa3a131dea3a116ebe06db95e0a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/cbdc58dd3687eaa3a131dea3a116ebe06db95e0a", "committedDate": "2020-06-15T20:53:58Z", "message": "Update and rename big_query_etl_audit_log_v2.sql to big_query_elt_audit_log_v2.sql\n\nAdded tableDeletion field and changed file name. Now checking all other fields for missing/incorrect information."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7aa3e21f4f841aa7a7b0eea5059e2af906fdf72", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a7aa3e21f4f841aa7a7b0eea5059e2af906fdf72", "committedDate": "2020-06-15T21:00:58Z", "message": "Update big_query_elt_audit_log_v2.sql\n\nUpdated JOIN, STRUCT with TableDeletionEvent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cf72a33b20193bbeb997e11d5f805efb6c73e86", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1cf72a33b20193bbeb997e11d5f805efb6c73e86", "committedDate": "2020-06-15T23:41:36Z", "message": "Update big_query_elt_audit_log_v2.sql\n\nAdded COALESCE for queryConfig, tableCopyConfig, loadConfig, extractConfig,"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eddd00f044a98c66498a20011d3c943040025ec2", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/eddd00f044a98c66498a20011d3c943040025ec2", "committedDate": "2020-06-16T00:02:56Z", "message": "Update README.md\n\nAdded instructions for big_query_elt_audit_log_v2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80d305dd5c7234ef2f374a86d8b4f1e0db0494b0", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/80d305dd5c7234ef2f374a86d8b4f1e0db0494b0", "committedDate": "2020-06-16T00:03:16Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2f923bb350f6b7b5c9f34428ba24a3941793d6f", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c2f923bb350f6b7b5c9f34428ba24a3941793d6f", "committedDate": "2020-06-16T00:09:07Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d91fa18e25ecb5c878587ce4966cc0c348f532", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/65d91fa18e25ecb5c878587ce4966cc0c348f532", "committedDate": "2020-06-16T00:39:39Z", "message": "Update big_query_elt_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d7d6be435fc59d5cdc2f54de04e3296ec0321c6", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3d7d6be435fc59d5cdc2f54de04e3296ec0321c6", "committedDate": "2020-06-16T00:56:24Z", "message": "Update big_query_elt_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cacb6d6fe91255da431f8fff7931446cb5425fd", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1cacb6d6fe91255da431f8fff7931446cb5425fd", "committedDate": "2020-06-16T00:59:33Z", "message": "Update big_query_elt_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dcceebdc37e4e22b6b24690fdd60c650f1b56bb", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8dcceebdc37e4e22b6b24690fdd60c650f1b56bb", "committedDate": "2020-06-16T01:09:20Z", "message": "Update big_query_elt_audit_log_v2.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c31bfa9fe18daf320a55dc909d6b1285aa2f6a", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/43c31bfa9fe18daf320a55dc909d6b1285aa2f6a", "committedDate": "2020-06-25T23:11:43Z", "message": "Update README.md\n\nUpdated README, added an example. Will add a few more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d07c716ffac0368d9d0c282230247c90ffcd61b", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7d07c716ffac0368d9d0c282230247c90ffcd61b", "committedDate": "2020-06-25T23:13:24Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf833b000caf4bdbd8471553ba75a68b6796f40", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/2cf833b000caf4bdbd8471553ba75a68b6796f40", "committedDate": "2020-06-25T23:14:03Z", "message": "Update README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a11fc16c0a1f3a6ef366c6b0f7d360499736dfa", "author": {"user": {"login": "NamrataShah5", "name": "Namrata S"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7a11fc16c0a1f3a6ef366c6b0f7d360499736dfa", "committedDate": "2020-06-25T23:15:08Z", "message": "Update README.md"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 782, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}