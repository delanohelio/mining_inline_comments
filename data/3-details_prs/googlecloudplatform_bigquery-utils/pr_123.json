{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NzcwMTg2", "number": 123, "title": "Query_Breakdown: Program now executable and works correctly with deletion & correct error tracking ", "bodyText": "TL;DR\n\nWe now have a working, executable program! The program works end-to-end with maven/cli and returns the correct error/error-location for deletion only cases. A few simple tests are included in InputReaderTest, LocationTrackerTest, and QueryBreakdownTest to ensure correctness. A notable case is:\n\nBLAH SELECT a FROM A;\nBLAH SELECT b FROM B GROUP BLAH BY b\nnow highlights errors as we want it to.\n\nFiles to look closely at: InputReader, LocationTracker, QueryBreakdown, Main\n\nSpecifics\n\nInputReader as well as how we store the queries internally has completely changed: before, we maintained internally an invariant that every query would be single line and each new query would be separated by a new line. Now, the program just processes the input as is: this has allowed for multi-line queries to be processed seamlessly--simple tests have been added to ensure this. What is also nice is that this redesign got rid of the \"semicolons in strings\" problem.\n\nLocationTracker is now implemented and can successfully track the original location of the error!\n\nA 2-D Arraylist of integers is used to keep track of the original positions. The indexing system is different (since line/columns start at 1) and therefore must be switched around accordingly.\nDeletion works by eliminating the deleted characters from the LocationTracker's position instance: essentially, position always mimics the current string but with the original locations:\n\nInput: BLAH SELECT b FROM B GROUP BLAH BY b (position: [[1, 2, 3, 4, ... ]])\nOutput: SELECT b FROM B GROUP BY b\nWhen we delete BLAH, the intermediate query will be\nSELECT b FROM B GROUP BLAH BY b (position: [[5, 6, 7, 8, ...]])\nTherefore, when we spot the error in BLAH after GROUP, the start/end column number will be wrong if we get it from the parser's error message. By deleting from the LocationTracker's position 2-D array the first 4 entries when we delete the first BLAH, however, we can use the error message's start/end column to get the original location since it's correctly shifted left by 4.\n\nWe need a deep copy to be passed around the recursion since every path must have a unique copy. Otherwise, the location will not be correctly maintained\nWe initialize a LocationTracker when we first parse the input file through InputReader. Then, an instance is relayed from the main function to the run function, then to the loop. It is best for the LocationTracker to be initialized when reading the input first as the original locations are present there. The correct invariants for LocationTracker are maintained by the loop.\n\n\nMinor change in deletion: we no longer take away extra spaces\n\nNext Steps\n\nNext PR: error-tracking working with Replacement\nNext, Next PR: VS Code Extension Draft\nAhead: VS Code Extension integration (including output format control through flags), Replacement logic improvement, Stabilization/Bug Fixes (private/public modifications, exception redesign, runtime limitation, etc.)", "createdAt": "2020-07-29T23:43:30Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123", "merged": true, "mergeCommit": {"oid": "b280d89caa832c1e0e21b1997bdf40c803ba4861"}, "closed": true, "closedAt": "2020-08-04T18:07:14Z", "author": {"login": "subinbean"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4I5vagH2gAyNDU4NzcwMTg2OmYzMmI2ZGRmNzc4NDI3M2M0ZjA4NGJjMTM2YzI0MGFjNGQ4YjMxNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7qlBiAH2gAyNDU4NzcwMTg2OjcyYzc3MDI3NjJiNTFkYjBhOTZlNmQwZTY1OGMyN2YyMmNiNzIwYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f32b6ddf7784273c4f084bc136c240ac4d8b3154", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f32b6ddf7784273c4f084bc136c240ac4d8b3154", "committedDate": "2020-07-24T19:08:09Z", "message": "replacement and main loop draft done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b09301ba1de656c47401c254eb3979049a24773", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7b09301ba1de656c47401c254eb3979049a24773", "committedDate": "2020-07-24T21:47:02Z", "message": "refactored QueryBreakdown, organized code for PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28adf1077930405db08f5b673d45863f82a0be44", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/28adf1077930405db08f5b673d45863f82a0be44", "committedDate": "2020-07-27T16:09:55Z", "message": "deletion is now working with the main loop and run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d32af029dcc6a72e36b7b39b1b6c5acd9579d1cf", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d32af029dcc6a72e36b7b39b1b6c5acd9579d1cf", "committedDate": "2020-07-28T01:28:25Z", "message": "location tracker sketched"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c576fa062c058e2de724853ba4720dbf2e87c5", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e2c576fa062c058e2de724853ba4720dbf2e87c5", "committedDate": "2020-07-28T15:05:52Z", "message": "new input reader code done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3065c7a7c0e3236fff89f73d2bda1830c750eb06", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3065c7a7c0e3236fff89f73d2bda1830c750eb06", "committedDate": "2020-07-28T17:44:05Z", "message": "tests added for inputreader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4827419e31ac8389fcedb6c51bd9bd93aa3c8034", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4827419e31ac8389fcedb6c51bd9bd93aa3c8034", "committedDate": "2020-07-28T17:58:53Z", "message": "all input reader tests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "993385a7fa87473796c877e4aeef8c3226f88f1b", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/993385a7fa87473796c877e4aeef8c3226f88f1b", "committedDate": "2020-07-28T23:46:53Z", "message": "making new location tracker instance each time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad2ab0eaf9b859c9f8267fd033bf0541ec4528da", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ad2ab0eaf9b859c9f8267fd033bf0541ec4528da", "committedDate": "2020-07-29T00:32:42Z", "message": "deletion part of location tracker draft done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf0f6e23b5a9c585ba4871ebfb26b7a5f23ef2b", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/dbf0f6e23b5a9c585ba4871ebfb26b7a5f23ef2b", "committedDate": "2020-07-29T15:40:08Z", "message": "merge conflicts resolved"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d37cd7b7f0fe35780e2dbc2affec82f9553a2c8f", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d37cd7b7f0fe35780e2dbc2affec82f9553a2c8f", "committedDate": "2020-07-29T16:18:51Z", "message": "deletion refactored to not deal with spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be204995c49008460392880e07b809f4b4ae6d75", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/be204995c49008460392880e07b809f4b4ae6d75", "committedDate": "2020-07-29T19:10:42Z", "message": "simpleDeletion test passes, deletion and location tracking integration is completed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75b4892e8c5f82a9e1187202e5c32358ef720b49", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/75b4892e8c5f82a9e1187202e5c32358ef720b49", "committedDate": "2020-07-29T22:00:46Z", "message": "deletion tests all pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32cd2aa63b236dea7ae74670bb0045188e15bba2", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/32cd2aa63b236dea7ae74670bb0045188e15bba2", "committedDate": "2020-07-29T22:22:36Z", "message": "files and comments cleaned for PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/de1bf6d4eb9924f18f9c002256af1778e134dbe5", "committedDate": "2020-07-29T23:14:25Z", "message": "program now executable through maven and cli interface"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTgyODQx", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#pullrequestreview-458582841", "createdAt": "2020-07-30T16:50:42Z", "commit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo1MDo0M1rOG5rhnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo1MDo0M1rOG5rhnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzNTEzMw==", "bodyText": "throw UnsupportedOperationExceptions instead of return null.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#discussion_r463135133", "createdAt": "2020-07-30T16:50:43Z", "author": {"login": "feiling"}, "path": "tools/query_breakdown/src/main/java/com/google/bigquery/LocationTracker.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package com.google.bigquery;\n+\n+import java.util.ArrayList;\n+\n+/**\n+ * This class tracks the original location of components in the query, thereby making sure that\n+ * the error locations are correctly represented.\n+ */\n+public class LocationTracker {\n+  /* we keep a double arraylist to represent the position of each character (line and column).\n+     We can do this as the line number of the component will not change\n+     (deletion and replacement won't change the line numbers)\n+   */\n+  private ArrayList<ArrayList<Integer>> location;\n+\n+  /**\n+   * Constructor for the class\n+   */\n+  public LocationTracker() {\n+    location = new ArrayList<>();\n+  }\n+\n+  /**\n+   * This method interacts with the InputReader and adds a pair to the location field that\n+   * represents the position (x, y) in the original query. x and y are 1-indexed, so we\n+   * adjust accordingly.\n+   */\n+  public void add(int x, int y) {\n+    location.get(x - 1).add(y);\n+  }\n+\n+  /**\n+   * This method adds an empty line to the location field\n+   */\n+  public void addLine() {\n+    location.add(new ArrayList<>());\n+  }\n+\n+  /**\n+   * This method removes an entry from location specified by (x, y) in the original query\n+   */\n+  public void remove(int x, int y) {\n+    if (x > 0 && x <= location.size()) {\n+      if (y > 0 && y <= location.get(x - 1).size()) {\n+        location.get(x - 1).remove(y - 1);\n+      }\n+    }\n+  }\n+\n+  /**\n+   * This method gets the original position of the component in (x,y) of the intermediate query\n+   */\n+  public int getOriginalPosition(int x, int y) {\n+    return location.get(x - 1).get(y - 1);\n+  }\n+\n+  /**\n+   * This method ensures that the location field is kept correctly despite the deletion.\n+   */\n+  public LocationTracker delete(int line, int startColumn, int endColumn) {\n+    LocationTracker lt = cloneTracker();\n+    for (int i = startColumn; i < endColumn + 1; i++) {\n+     lt.remove(line, startColumn);\n+    }\n+    return lt;\n+  }\n+\n+  /**\n+   * To be implemented\n+   */\n+  public LocationTracker replace() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTg0Nzc0", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#pullrequestreview-458584774", "createdAt": "2020-07-30T16:53:12Z", "commit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo1MzoxM1rOG5rnaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo1MzoxM1rOG5rnaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzNjYxNg==", "bodyText": "Just use name locationTracker.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#discussion_r463136616", "createdAt": "2020-07-30T16:53:13Z", "author": {"login": "feiling"}, "path": "tools/query_breakdown/src/main/java/com/google/bigquery/InputReader.java", "diffHunk": "@@ -12,31 +11,62 @@\n  */\n public class InputReader {\n \n+  private LocationTracker lt;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTkxODQz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#pullrequestreview-458591843", "createdAt": "2020-07-30T17:02:26Z", "commit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzowMjoyNlrOG5r85Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzowMjoyNlrOG5r85Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0MjExNw==", "bodyText": "It's not clear to me how LocationTracker works. It seems that for each pair of (line, column), location.get(line - 1).get(column-1) will return the location. But I don't understand what the location value represents. It's an integer, so I guess it mean the index in the input string?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#discussion_r463142117", "createdAt": "2020-07-30T17:02:26Z", "author": {"login": "feiling"}, "path": "tools/query_breakdown/src/main/java/com/google/bigquery/LocationTracker.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package com.google.bigquery;\n+\n+import java.util.ArrayList;\n+\n+/**\n+ * This class tracks the original location of components in the query, thereby making sure that\n+ * the error locations are correctly represented.\n+ */\n+public class LocationTracker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaed220b72c091cd52a3d28f0c29b3a9f8f41c40", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/eaed220b72c091cd52a3d28f0c29b3a9f8f41c40", "committedDate": "2020-07-30T17:54:22Z", "message": "unsupported operation exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "188ec367f1c3187f51c63af3e460ee71d52c1619", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/188ec367f1c3187f51c63af3e460ee71d52c1619", "committedDate": "2020-07-31T16:34:45Z", "message": "variable name lt updated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5Mzk4MzM5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#pullrequestreview-459398339", "createdAt": "2020-07-31T19:06:41Z", "commit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOTowNjo0MVrOG6TBuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxOTowNjo0MVrOG6TBuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc4MjMyOQ==", "bodyText": "Unit tests should be self-contained, i.e. they don't rely on other data. So we shouldn't rely on the file multipleLineQuery.txt. Please add a method to InputReader such as readFromString(string input), then the test data can be passed to inputReader in the test itself.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#discussion_r463782329", "createdAt": "2020-07-31T19:06:41Z", "author": {"login": "feiling"}, "path": "tools/query_breakdown/src/test/java/com/google/bigquery/LocationTrackerTest.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.google.bigquery;\n+\n+import static org.junit.Assert.*;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import org.junit.Test;\n+\n+public class LocationTrackerTest {\n+\n+  @Test\n+  public void locationTrackerTestInitializedCorrectly() throws IOException {\n+    InputReader ir = new InputReader();\n+    String absPath = new File(\"\").getAbsolutePath();\n+    ir.readInput(absPath + \"/src/test/java/com/google/bigquery\"\n+            + \"/InputTestFiles/multipleLineQuery.txt\");\n+    assertEquals(4, ir.getLocationTracker().getOriginalPosition(3, 4));\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1bf6d4eb9924f18f9c002256af1778e134dbe5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21cdc721ef769760ead21946542a5248fd63a706", "author": {"user": {"login": "subinbean", "name": "Subin Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/21cdc721ef769760ead21946542a5248fd63a706", "committedDate": "2020-07-31T22:13:11Z", "message": "testing more internalized, improved documentation for location tracker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTQ3Mjg5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/123#pullrequestreview-460147289", "createdAt": "2020-08-03T15:59:06Z", "commit": {"oid": "21cdc721ef769760ead21946542a5248fd63a706"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e2e112fe6df731e99730dbd876a7678b5bb3e39", "author": {"user": {"login": "feiling", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0e2e112fe6df731e99730dbd876a7678b5bb3e39", "committedDate": "2020-08-03T15:59:12Z", "message": "Merge branch 'master' into milestone1_4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c7702762b51db0a96e6d0e658c27f22cb720c5", "author": {"user": {"login": "feiling", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/72c7702762b51db0a96e6d0e658c27f22cb720c5", "committedDate": "2020-08-04T18:04:04Z", "message": "Merge branch 'master' into milestone1_4"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 701, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}