{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NjgxNDMw", "number": 93, "title": "SQL Extraction: Basic query confidence rater", "bodyText": "Before I implement a SQL library/framework-specific analyzer, I wrote a way of rating confidence for basic detected fragments. This simply involves counting how many SQL keywords are present in each fragment. Keywords are defined to have weighted values, so some keywords can be given higher/lower weight (via code) if needed. If the first word in the fragment is a keyword, then it is given extra weight.\nFinally, the summed weights are converted to a value between 0 and 1 skewed to the left.", "createdAt": "2020-07-10T23:26:27Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93", "merged": true, "mergeCommit": {"oid": "88a4583ec2ae4f826c195f83a976b7b5acadbb16"}, "closed": true, "closedAt": "2020-07-15T21:18:25Z", "author": {"login": "creativitRy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczsGAOAH2gAyNDQ3NjgxNDMwOjI5YTJlNGQ0NDdhY2M4Y2I1NzI4NjI2MjFlOTYxOWQ2YjdkZjA2NGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1RNeDAH2gAyNDQ3NjgxNDMwOmMyYmZkODdjNWNiZGU3NTY2ZjBjYzQ5MTk3MmY0MjliZDllZTQ0MmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "29a2e4d447acc8cb572862621e9619d6b7df064c", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/29a2e4d447acc8cb572862621e9619d6b7df064c", "committedDate": "2020-07-10T23:18:36Z", "message": "SQL Extraction: Basic query confidence rater"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjkyMzc4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93#pullrequestreview-447692378", "createdAt": "2020-07-13T23:56:31Z", "commit": {"oid": "29a2e4d447acc8cb572862621e9619d6b7df064c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMzo1NjozMVrOGw-6vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMzo1NjozMVrOGw-6vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNTY3OA==", "bodyText": "keywords should be a Set, instead of a Map.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93#discussion_r454015678", "createdAt": "2020-07-13T23:56:31Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/ConfidenceRater.kt", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+private const val WITH_DELIMITER = \"((?<=%1\\$s)|(?=%1\\$s))\"\n+\n+/**\n+ * Rates a [QueryFragment] a confidence value to indicate how likely it is to be a query.\n+ * @see rate\n+ */\n+class ConfidenceRater {\n+    private val keywords: Map<String, Int> = mapOf(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a2e4d447acc8cb572862621e9619d6b7df064c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NjkyNzI5", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93#pullrequestreview-447692729", "createdAt": "2020-07-13T23:57:29Z", "commit": {"oid": "29a2e4d447acc8cb572862621e9619d6b7df064c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMzo1NzoyOVrOGw-76Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMzo1NzoyOVrOGw-76Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAxNTk3Nw==", "bodyText": "What's the purpose of checking index == 0?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93#discussion_r454015977", "createdAt": "2020-07-13T23:57:29Z", "author": {"login": "feiling"}, "path": "tools/sql_extraction/src/main/kotlin/ConfidenceRater.kt", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.google.cloud.sqlecosystem.sqlextraction\n+\n+import com.google.cloud.sqlecosystem.sqlextraction.output.QueryFragment\n+\n+private const val WITH_DELIMITER = \"((?<=%1\\$s)|(?=%1\\$s))\"\n+\n+/**\n+ * Rates a [QueryFragment] a confidence value to indicate how likely it is to be a query.\n+ * @see rate\n+ */\n+class ConfidenceRater {\n+    private val keywords: Map<String, Int> = mapOf(\n+        \"Add\" to 1,\n+        \"All\" to 1,\n+        \"Alter\" to 1,\n+        \"And\" to 1,\n+        \"Any\" to 1,\n+        \"As\" to 1,\n+        \"Asc\" to 1,\n+        \"Backup\" to 1,\n+        \"Between\" to 1,\n+        \"Case\" to 1,\n+        \"Check\" to 1,\n+        \"Column\" to 1,\n+        \"Constraint\" to 1,\n+        \"Create\" to 1,\n+        \"Database\" to 1,\n+        \"Default\" to 1,\n+        \"Delete\" to 1,\n+        \"Desc\" to 1,\n+        \"Distinct\" to 1,\n+        \"Drop\" to 1,\n+        \"Exec\" to 1,\n+        \"Exists\" to 1,\n+        \"Foreign\" to 1,\n+        \"From\" to 1,\n+        \"Full\" to 1,\n+        \"Group\" to 1,\n+        \"Having\" to 1,\n+        \"In\" to 1,\n+        \"Index\" to 1,\n+        \"Inner\" to 1,\n+        \"Insert\" to 1,\n+        \"Is\" to 1,\n+        \"Join\" to 1,\n+        \"Left\" to 1,\n+        \"Like\" to 1,\n+        \"Limit\" to 1,\n+        \"Not\" to 1,\n+        \"Null\" to 1,\n+        \"Or\" to 1,\n+        \"Order\" to 1,\n+        \"Outer\" to 1,\n+        \"Primary\" to 1,\n+        \"Procedure\" to 1,\n+        \"Right\" to 1,\n+        \"RowNum\" to 1,\n+        \"Select\" to 1,\n+        \"Set\" to 1,\n+        \"Table\" to 1,\n+        \"Top\" to 1,\n+        \"Truncate\" to 1,\n+        \"Union\" to 1,\n+        \"Unique\" to 1,\n+        \"Update\" to 1,\n+        \"Values\" to 1,\n+        \"View\" to 1,\n+        \"Where\" to 1\n+    ).mapKeys { it.key.toUpperCase() }\n+\n+    /**\n+     * Given [query], returns a confidence value within range [0.0, 1.0],\n+     * where 1.0 means it is most likely a SQL query\n+     */\n+    fun rate(query: QueryFragment): Double {\n+        val count = countSqlLikeTokens(query)\n+        if (count == 0) return 0.0\n+        return (count) / (count + 1.0)\n+    }\n+\n+    /**\n+     * Count the number of SQL keywords in [query].\n+     * Keywords are weighted, and the return value can be higher than the exact count.\n+     */\n+    private fun countSqlLikeTokens(query: QueryFragment): Int {\n+        if (query.complex != null) {\n+            return query.complex.sumBy(this::countSqlLikeTokens)\n+        } else if (query.literal.isNullOrBlank()) {\n+            return 0\n+        }\n+\n+        var count = 0\n+        for ((index, token) in tokenize(query.literal).withIndex()) {\n+            var localCount = keywords.getOrDefault(token.toUpperCase(), 0)\n+            if (index == 0 && localCount > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a2e4d447acc8cb572862621e9619d6b7df064c"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9796dabd5d8c1feacd07dc21013ab95956d3201", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/b9796dabd5d8c1feacd07dc21013ab95956d3201", "committedDate": "2020-07-14T17:16:38Z", "message": "Change keywords to a Set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0922d66dc9609ed34056bbaad06a0d1e0cddcc22", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0922d66dc9609ed34056bbaad06a0d1e0cddcc22", "committedDate": "2020-07-15T17:52:03Z", "message": "Added comment for preferring keywords found at the start"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzMxMDAy", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/93#pullrequestreview-449331002", "createdAt": "2020-07-15T21:07:03Z", "commit": {"oid": "0922d66dc9609ed34056bbaad06a0d1e0cddcc22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2bfd87c5cbde7566f0cc491972f429bd9ee442c", "author": {"user": {"login": "feiling", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c2bfd87c5cbde7566f0cc491972f429bd9ee442c", "committedDate": "2020-07-15T21:07:10Z", "message": "Merge branch 'master' into confidence"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}