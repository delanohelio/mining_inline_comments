{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDUwMzEz", "number": 155, "title": "Auto Query Fixer: use Regex to locate the incorrect table when fixing the TableNotFound error", "bodyText": "Modify a member function in TableNotFoundFixer to use regex to locate the incorrect table.\nThe new method can handle the table names like a.b.c, a.b.c, a.b.c, a.b.c, a.b.c, and etc.", "createdAt": "2020-08-19T20:53:27Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155", "merged": true, "mergeCommit": {"oid": "03470f43aa5351484342c457d3fc657289a495fc"}, "closed": true, "closedAt": "2020-08-26T17:39:23Z", "author": {"login": "mingen-pan"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAhXc1gH2gAyNDcwNDUwMzEzOjQ4ZGI0NGRiZmUzZTE0MzZhNTEwODBlMTg1NWI1NmY4YzAzMmNjNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCvZVxAH2gAyNDcwNDUwMzEzOjE5MDllYTVjMzBmOGEyYzljYTNlNmRhYTRjZjQ2ZWY1ZWQ1Y2QzMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48db44dbfe3e1436a51080e1855b56f8c032cc44", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/48db44dbfe3e1436a51080e1855b56f8c032cc44", "committedDate": "2020-08-19T20:09:43Z", "message": "Use a regex to find the incorrect table in TableNotFoundFixer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a62b907682579220af264d1a28a9888800b918c", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/6a62b907682579220af264d1a28a9888800b918c", "committedDate": "2020-08-19T20:48:54Z", "message": "Merge remote-tracking branch 'upstream/master' into add_fixer\n\n# Conflicts:\n#\ttools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2c3ed505ea794ca286e0f2d4e5a9e789d22c10", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/9c2c3ed505ea794ca286e0f2d4e5a9e789d22c10", "committedDate": "2020-08-19T20:49:40Z", "message": "Merge with master branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7", "committedDate": "2020-08-19T20:51:11Z", "message": "rename a local variable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTUzNzY2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-471953766", "createdAt": "2020-08-20T20:15:39Z", "commit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoxNTozOVrOHERwoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoxNTozOVrOHERwoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0NzMyOQ==", "bodyText": "788? i think it should corresponding to the index defined in the kind enum?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474247329", "createdAt": "2020-08-20T20:15:39Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -13,8 +13,11 @@ public TokenImpl (Token token) {\n     this.token = token;\n   }\n \n-  @Override public int getKind() {\n-    return token.kind;\n+  @Override public Kind getKind() {\n+    if (token.kind == 788) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTU3MTUz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-471957153", "createdAt": "2020-08-20T20:20:46Z", "commit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoyMDo0NlrOHER7NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoyMDo0NlrOHER7NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MDAzNw==", "bodyText": "i think the most common case would be 'datasetid.tableid', please make sure we handle this case.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474250037", "createdAt": "2020-08-20T20:20:46Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/FixerTest.java", "diffHunk": "@@ -47,6 +47,7 @@ public void setup() {\n     fixerFactory = new FixerFactory(tokenProcessor, bigQueryServiceMock);\n   }\n \n+  //TODO: More test cases are need to test different table name, like `a.b`.c, `a.b.c`, `a`.`b`.c, and a.b.c.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTU4OTY3", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-471958967", "createdAt": "2020-08-20T20:23:38Z", "commit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoyMzozOFrOHESBAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDoyMzozOFrOHESBAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MTUyMQ==", "bodyText": "\"?\" would match one or more times, what is it is \"datasetid.tableid\" without \"\"? how about \"datasetid.tableid`\" which is the most common case.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r474251521", "createdAt": "2020-08-20T20:23:38Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -100,24 +106,32 @@ private String constructFullTableName(String projectId, String datasetId, String\n     return String.format(\"%s.%s.%s\", projectId, datasetId, tableName);\n   }\n \n-  private int findTheIndexOfIncorrectTable() {\n-    // The table in the error message is presented in the legacySQL mode, but this fixer is used to\n-    // fix the\n-    // standardSQL. Thus, the table name needs to be converted to the one consistent with\n-    // standardSQL.\n-    // The change is from project:dataset.table to project.dataset.table.\n-    String tableName = err.getTableName().replace(':', '.');\n-    int index = query.indexOf(tableName);\n-\n-    // Since the TableNotFound error has no position info, this method will convert the index to the\n-    // position and assign to the `err`.\n-    Position position = queryPositionConverter.indexToPos(index);\n-    this.err.setErrorPosition(position);\n-    return index;\n+  private SubstringView findSubstringViewOfIncorrectTable(TableId fullTableId) {\n+    String regex =\n+        String.format(\n+            \"`?%s`?.`?%s`?.`?%s`?\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36e4e2a0ca7cf9f0127c3bf7b4402ea6b2214e7"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4a1be982d047bceac1052b7487c83479f0cf4a95", "committedDate": "2020-08-21T18:30:06Z", "message": "Support matching dataset.table in the TableNotFoundFixer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTA4OTE3", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-475108917", "createdAt": "2020-08-26T02:32:13Z", "commit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwMjozMjoxM1rOHG5caw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwMjozMjoxM1rOHG5caw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NDY2Nw==", "bodyText": "I forgot maybe you explained last time why it is 786?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r476994667", "createdAt": "2020-08-26T02:32:13Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -13,8 +13,11 @@ public TokenImpl (Token token) {\n     this.token = token;\n   }\n \n-  @Override public int getKind() {\n-    return token.kind;\n+  @Override public Kind getKind() {\n+    if (token.kind == 786 || token.kind == 788) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTEwMDYy", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-475110062", "createdAt": "2020-08-26T02:36:24Z", "commit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwMjozNjoyNFrOHG5l_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwMjozNjoyNFrOHG5l_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NzExOA==", "bodyText": "Theoretically I think we should handle single 'table' too? We can add TODO here.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#discussion_r476997118", "createdAt": "2020-08-26T02:36:24Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -100,24 +107,43 @@ private String constructFullTableName(String projectId, String datasetId, String\n     return String.format(\"%s.%s.%s\", projectId, datasetId, tableName);\n   }\n \n-  private int findTheIndexOfIncorrectTable() {\n-    // The table in the error message is presented in the legacySQL mode, but this fixer is used to\n-    // fix the\n-    // standardSQL. Thus, the table name needs to be converted to the one consistent with\n-    // standardSQL.\n-    // The change is from project:dataset.table to project.dataset.table.\n-    String tableName = err.getTableName().replace(':', '.');\n-    int index = query.indexOf(tableName);\n-\n-    // Since the TableNotFound error has no position info, this method will convert the index to the\n-    // position and assign to the `err`.\n-    Position position = queryPositionConverter.indexToPos(index);\n-    this.err.setErrorPosition(position);\n-    return index;\n+  private SubstringView findSubstringViewOfIncorrectTable(TableId fullTableId) {\n+    String regex;\n+    // If the project ID is the default one, then the actual table may not include project ID,\n+    // which looks like \"dataset.table\".", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTEwMzAz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/155#pullrequestreview-475110303", "createdAt": "2020-08-26T02:37:13Z", "commit": {"oid": "4a1be982d047bceac1052b7487c83479f0cf4a95"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5b27543d38fcf379ad209e40ed05ea5f11c8689", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f5b27543d38fcf379ad209e40ed05ea5f11c8689", "committedDate": "2020-08-26T17:33:16Z", "message": "Add todo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1909ea5c30f8a2c9ca3e6daa4cf46ef5ed5cd311", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/1909ea5c30f8a2c9ca3e6daa4cf46ef5ed5cd311", "committedDate": "2020-08-26T17:38:18Z", "message": "Merge branch 'master' into add_fixer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 750, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}