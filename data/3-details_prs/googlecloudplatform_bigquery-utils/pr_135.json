{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMDk0MDI5", "number": 135, "title": "Auto Query Fixer: Implement TableNotFoundFixer", "bodyText": "Implement TableNotFoundFixer and FixerFactory.\nTest is included.", "createdAt": "2020-08-05T01:40:19Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135", "merged": true, "mergeCommit": {"oid": "3121cc88c3dda2eeb3b02724312e0395cb7aad40"}, "closed": true, "closedAt": "2020-08-06T21:55:15Z", "author": {"login": "mingen-pan"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc132YpgH2gAyNDYzMDk0MDI5OmZhYjg1YmVjZGMwMzQ1ZjU3YmZjNzgzOTRjZWFhZDRiNzA2MThiYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8XEZ9AH2gAyNDYzMDk0MDI5OjdjMzJmZjNlOGNmMmI0MGZhOWJhZjA3MzFiMjhiZWRkYjllYTFhNzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fab85becdc0345f57bfc78394ceaad4b70618bb9", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/fab85becdc0345f57bfc78394ceaad4b70618bb9", "committedDate": "2020-07-17T18:08:15Z", "message": "add getMessage method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec1d3710e919bc04b693a2819d896866d298a95", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0ec1d3710e919bc04b693a2819d896866d298a95", "committedDate": "2020-07-17T18:10:58Z", "message": "implement SqlErrorFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c904515daa5d85c2d7761784ea040e7f41188120", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c904515daa5d85c2d7761784ea040e7f41188120", "committedDate": "2020-07-17T18:12:33Z", "message": "Merge remote-tracking branch 'upstream/master' into add_error_class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f546f5d54e17211d513f0b56d6aaa7a545126f0c", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f546f5d54e17211d513f0b56d6aaa7a545126f0c", "committedDate": "2020-07-27T18:17:36Z", "message": "minor change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64133924809dfc239ad0e0f3bf4cb31c2370916e", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/64133924809dfc239ad0e0f3bf4cb31c2370916e", "committedDate": "2020-07-27T18:20:50Z", "message": "Merge remote-tracking branch 'upstream/master' into add_error_class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "225248220a13d782a7daaa74eedd46e0207f97d8", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/225248220a13d782a7daaa74eedd46e0207f97d8", "committedDate": "2020-07-30T23:06:38Z", "message": "Implement tokenizer and a few helper classes to process query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbfbbfc01d8a62c7adf7b77cec349ea1b9e36942", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/cbfbbfc01d8a62c7adf7b77cec349ea1b9e36942", "committedDate": "2020-08-03T19:02:47Z", "message": "Minor change to comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88aa4fa6951b881cf55cc74aa0998cbf6efbd4d5", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/88aa4fa6951b881cf55cc74aa0998cbf6efbd4d5", "committedDate": "2020-08-04T23:43:04Z", "message": "Minor change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55854d7dd138385cd13a0d2792e0c315c8727e4d", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/55854d7dd138385cd13a0d2792e0c315c8727e4d", "committedDate": "2020-08-04T23:47:50Z", "message": "Merge remote-tracking branch 'upstream/master' into add_error_class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/572992edaae8f993873cf9bbaca9fcbbc65dff4c", "committedDate": "2020-08-05T01:37:59Z", "message": "Implement TableNotFoundFixer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTE4OTI2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#pullrequestreview-462118926", "createdAt": "2020-08-06T01:01:21Z", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowMToyMVrOG8flyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowMToyMVrOG8flyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4NTMyMA==", "bodyText": "nit: stylewise we usually don't use paragraph for field comment.\nJust use \"//...\" for short comment.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#discussion_r466085320", "createdAt": "2020-08-06T01:01:21Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/FixOption.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+import lombok.Value;\n+\n+@Value(staticConstructor = \"of\")\n+public class FixOption {\n+  /**\n+   * A short description about this fixing option. Usually, if an identifier is to be modified, this\n+   * field will be the new identifier to replace. For example, if a table is to be replaced, this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTIwODY2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#pullrequestreview-462120866", "createdAt": "2020-08-06T01:08:03Z", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowODowM1rOG8fsJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowODowM1rOG8fsJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4Njk0OQ==", "bodyText": "maybe add a TODO to make this user configurable.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#discussion_r466086949", "createdAt": "2020-08-06T01:08:03Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.utils.queryfixer.QueryPositionConverter;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.TableNotFoundError;\n+import com.google.cloud.bigquery.utils.queryfixer.service.BigQueryService;\n+import com.google.cloud.bigquery.utils.queryfixer.util.PatternMatcher;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The fixer class responsible for \"table not found\" error. It fixes the error by (1) find the\n+ * similar table under the same project and dataset as the incorrect one, and (2) replace the\n+ * incorrect one with the most similar table.\n+ *\n+ * <p>If no similar tables are found in the dataset, the fixer will directly return the error\n+ * without providing any fix options.\n+ */\n+public class TableNotFoundFixer implements IFixer {\n+\n+  /** This regex is able to parse both project:dataset.table and dataset.table. */\n+  private static final String tableIdRegex = \"^((.*?):)?(.*?)\\\\.(.*?)$\";\n+\n+  private final String query;\n+  private final TableNotFoundError err;\n+  private final BigQueryService bigQueryService;\n+  private final QueryPositionConverter queryPositionConverter;\n+\n+  public TableNotFoundFixer(String query, TableNotFoundError err, BigQueryService bigQueryService) {\n+    this.query = query;\n+    this.err = err;\n+    this.bigQueryService = bigQueryService;\n+    this.queryPositionConverter = new QueryPositionConverter(query);\n+  }\n+\n+  @Override\n+  public FixResult fix() {\n+    TableId fullTableId = constructTableId(err.getTableName());\n+    List<String> tableNames =\n+        bigQueryService.listTableNames(fullTableId.getProject(), fullTableId.getDataset());\n+\n+    StringUtil.SimilarStrings similarTables =\n+        StringUtil.findSimilarWords(tableNames, fullTableId.getTable());\n+\n+    // this is an arbitrary standard. It requires the candidate table should share at least 50%\n+    // similarity as\n+    // the incorrect table typo.\n+    int editDistanceThreshold = (fullTableId.getTable().length() + 1) / 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTIxMDI4", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#pullrequestreview-462121028", "createdAt": "2020-08-06T01:08:34Z", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowODozNFrOG8fsvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTowODozNFrOG8fsvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4NzEwMA==", "bodyText": "nit: This", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#discussion_r466087100", "createdAt": "2020-08-06T01:08:34Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.utils.queryfixer.QueryPositionConverter;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.TableNotFoundError;\n+import com.google.cloud.bigquery.utils.queryfixer.service.BigQueryService;\n+import com.google.cloud.bigquery.utils.queryfixer.util.PatternMatcher;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The fixer class responsible for \"table not found\" error. It fixes the error by (1) find the\n+ * similar table under the same project and dataset as the incorrect one, and (2) replace the\n+ * incorrect one with the most similar table.\n+ *\n+ * <p>If no similar tables are found in the dataset, the fixer will directly return the error\n+ * without providing any fix options.\n+ */\n+public class TableNotFoundFixer implements IFixer {\n+\n+  /** This regex is able to parse both project:dataset.table and dataset.table. */\n+  private static final String tableIdRegex = \"^((.*?):)?(.*?)\\\\.(.*?)$\";\n+\n+  private final String query;\n+  private final TableNotFoundError err;\n+  private final BigQueryService bigQueryService;\n+  private final QueryPositionConverter queryPositionConverter;\n+\n+  public TableNotFoundFixer(String query, TableNotFoundError err, BigQueryService bigQueryService) {\n+    this.query = query;\n+    this.err = err;\n+    this.bigQueryService = bigQueryService;\n+    this.queryPositionConverter = new QueryPositionConverter(query);\n+  }\n+\n+  @Override\n+  public FixResult fix() {\n+    TableId fullTableId = constructTableId(err.getTableName());\n+    List<String> tableNames =\n+        bigQueryService.listTableNames(fullTableId.getProject(), fullTableId.getDataset());\n+\n+    StringUtil.SimilarStrings similarTables =\n+        StringUtil.findSimilarWords(tableNames, fullTableId.getTable());\n+\n+    // this is an arbitrary standard. It requires the candidate table should share at least 50%\n+    // similarity as\n+    // the incorrect table typo.\n+    int editDistanceThreshold = (fullTableId.getTable().length() + 1) / 2;\n+\n+    if (similarTables.getStrings().isEmpty()\n+        || similarTables.getDistance() > editDistanceThreshold) {\n+      return FixResult.failure(err);\n+    }\n+\n+    // this method only finds the first occurrence of the incorrect table. It is possible that this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTI0Mzk0", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#pullrequestreview-462124394", "createdAt": "2020-08-06T01:19:44Z", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMToxOTo0NFrOG8f4WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMToxOTo0NFrOG8f4WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5MDA3Mw==", "bodyText": "So we rely on the error message to identify if they used legacy sql?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#discussion_r466090073", "createdAt": "2020-08-06T01:19:44Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/fixer/TableNotFoundFixer.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.google.cloud.bigquery.utils.queryfixer.fixer;\n+\n+import com.google.cloud.bigquery.TableId;\n+import com.google.cloud.bigquery.utils.queryfixer.QueryPositionConverter;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixOption;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.FixResult;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.Position;\n+import com.google.cloud.bigquery.utils.queryfixer.errors.TableNotFoundError;\n+import com.google.cloud.bigquery.utils.queryfixer.service.BigQueryService;\n+import com.google.cloud.bigquery.utils.queryfixer.util.PatternMatcher;\n+import com.google.cloud.bigquery.utils.queryfixer.util.StringUtil;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The fixer class responsible for \"table not found\" error. It fixes the error by (1) find the\n+ * similar table under the same project and dataset as the incorrect one, and (2) replace the\n+ * incorrect one with the most similar table.\n+ *\n+ * <p>If no similar tables are found in the dataset, the fixer will directly return the error\n+ * without providing any fix options.\n+ */\n+public class TableNotFoundFixer implements IFixer {\n+\n+  /** This regex is able to parse both project:dataset.table and dataset.table. */\n+  private static final String tableIdRegex = \"^((.*?):)?(.*?)\\\\.(.*?)$\";\n+\n+  private final String query;\n+  private final TableNotFoundError err;\n+  private final BigQueryService bigQueryService;\n+  private final QueryPositionConverter queryPositionConverter;\n+\n+  public TableNotFoundFixer(String query, TableNotFoundError err, BigQueryService bigQueryService) {\n+    this.query = query;\n+    this.err = err;\n+    this.bigQueryService = bigQueryService;\n+    this.queryPositionConverter = new QueryPositionConverter(query);\n+  }\n+\n+  @Override\n+  public FixResult fix() {\n+    TableId fullTableId = constructTableId(err.getTableName());\n+    List<String> tableNames =\n+        bigQueryService.listTableNames(fullTableId.getProject(), fullTableId.getDataset());\n+\n+    StringUtil.SimilarStrings similarTables =\n+        StringUtil.findSimilarWords(tableNames, fullTableId.getTable());\n+\n+    // this is an arbitrary standard. It requires the candidate table should share at least 50%\n+    // similarity as\n+    // the incorrect table typo.\n+    int editDistanceThreshold = (fullTableId.getTable().length() + 1) / 2;\n+\n+    if (similarTables.getStrings().isEmpty()\n+        || similarTables.getDistance() > editDistanceThreshold) {\n+      return FixResult.failure(err);\n+    }\n+\n+    // this method only finds the first occurrence of the incorrect table. It is possible that this\n+    // table exists in multiple positions of this query. What is worse, it is possible that the\n+    // table name is also part of a literal, then this auto fixing may have problem. The ultimate\n+    // solution for this issue is to use Parser to find the correct position of this table.\n+    int tableStartIndex = findTheIndexOfIncorrectTable();\n+\n+    List<FixOption> fixOptions =\n+        similarTables.getStrings().stream()\n+            .map(\n+                table -> {\n+                  String fullTableName =\n+                      constructFullTableName(\n+                          fullTableId.getProject(), fullTableId.getDataset(), table);\n+                  String fixedQuery = replaceTable(fullTableName, tableStartIndex);\n+                  return FixOption.of(fullTableName, fixedQuery);\n+                })\n+            .collect(Collectors.toList());\n+\n+    return FixResult.success(/*approach= */ \"Replace the table name.\", fixOptions, err);\n+  }\n+\n+  private TableId constructTableId(String fullTableName) {\n+    List<String> contents = PatternMatcher.extract(fullTableName, tableIdRegex);\n+    String projectId;\n+    // Assume the table name from dry-run message is always correct, so no check is performed for\n+    // matching.\n+    // If contents[0] == null, it means the table looks like dataset.table, so the project ID should\n+    // be fetched from the BigQuery Client.\n+    if (contents.get(0) == null) {\n+      projectId = bigQueryService.getBigQueryOptions().getProjectId();\n+    } else {\n+      projectId = contents.get(1);\n+    }\n+    String datasetId = contents.get(2);\n+    String tableName = contents.get(3);\n+    return TableId.of(projectId, datasetId, tableName);\n+  }\n+\n+  private String constructFullTableName(String projectId, String datasetId, String tableName) {\n+    return String.format(\"%s.%s.%s\", projectId, datasetId, tableName);\n+  }\n+\n+  private int findTheIndexOfIncorrectTable() {\n+    // the table in the error message is presented in the legacySQL mode, but this fixer is used to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTI0NDM3", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/135#pullrequestreview-462124437", "createdAt": "2020-08-06T01:19:52Z", "commit": {"oid": "572992edaae8f993873cf9bbaca9fcbbc65dff4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050f5b060e9826100b9019d3bbf1353857215ee0", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/050f5b060e9826100b9019d3bbf1353857215ee0", "committedDate": "2020-08-06T21:53:30Z", "message": "Respond to PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c32ff3e8cf2b40fa9baf0731b28beddb9ea1a73", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7c32ff3e8cf2b40fa9baf0731b28beddb9ea1a73", "committedDate": "2020-08-06T21:54:10Z", "message": "Merge branch 'master' into add_fixer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 720, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}