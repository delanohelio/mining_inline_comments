{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NTU4MTQx", "number": 170, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozNjozOVrOEehYFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NToyMVrOEehmsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDM5NTcyOnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozNjozOVrOHKNzVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDowNjoyMVrOHKOVyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3Mzk0Mg==", "bodyText": "why const pointer? if you don't expect to change the request, we should use const reference.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480473942", "createdAt": "2020-08-31T23:36:39Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4Mjc2Mg==", "bodyText": "Good point. Changed to reference.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480482762", "createdAt": "2020-09-01T00:06:21Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3Mzk0Mg=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDM5NjU4OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozNzowNFrOHKNzzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDowNjoyOVrOHKOV7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NDA2Mg==", "bodyText": "nit: ExtractFunctionRangeResponse* response", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480474062", "createdAt": "2020-08-31T23:37:04Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4Mjc5OA==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480482798", "createdAt": "2020-09-01T00:06:29Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NDA2Mg=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQwMDM2OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzozOTowOFrOHKN1_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDowODowMlrOHKOYPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NDYyMw==", "bodyText": "why return status separately? if error occurs, should it return at line 44? or there could be cases line 44 is ok but getting status() is not ok?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480474623", "createdAt": "2020-08-31T23:39:08Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4MzM4OQ==", "bodyText": "Yes. Line 44 makes sure the ExtractFunctionRange is correct. Then we get a FunctionRange object. Then we need to serialize it to proto, which is line 50. Here may  occur errors.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480483389", "createdAt": "2020-09-01T00:08:02Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NDYyMw=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQwMzc4OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0MDo0MlrOHKN35A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDoxMDoyMFrOHKOd4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NTEwOA==", "bodyText": "you can use unique_ptr ?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480475108", "createdAt": "2020-08-31T23:40:42Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());\n+\n+  // Convert the proto to heap value and hand over the ownership to the response.\n+  auto function_range_proto = new ::bigquery::utils::zetasql_helper::FunctionRangeProto(\n+      status_or_function_range_proto.value()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4NDgzNA==", "bodyText": "I think this is how proto specifies the ownership - assign a pointer to its field. The child pointer will be released automatically when the owner is released. We don't need the unique_ptr here.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480484834", "createdAt": "2020-09-01T00:10:20Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());\n+\n+  // Convert the proto to heap value and hand over the ownership to the response.\n+  auto function_range_proto = new ::bigquery::utils::zetasql_helper::FunctionRangeProto(\n+      status_or_function_range_proto.value()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NTEwOA=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQwNzc3OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0Mjo0NlrOHKN6Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDozNDoxMVrOHKPaqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NTcxMQ==", "bodyText": "pass by reference", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480475711", "createdAt": "2020-08-31T23:42:46Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());\n+\n+  // Convert the proto to heap value and hand over the ownership to the response.\n+  auto function_range_proto = new ::bigquery::utils::zetasql_helper::FunctionRangeProto(\n+      status_or_function_range_proto.value()\n+  );\n+  response->set_allocated_function_range(function_range_proto);\n+  return absl::OkStatus();\n+}\n+\n+absl::Status ZetaSqlHelperLocalServiceImpl::LocateTableRanges(const LocateTableRangesRequest *request,\n+                                                              LocateTableRangesResponse *response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUwMDM5Mw==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480500393", "createdAt": "2020-09-01T00:34:11Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.cc", "diffHunk": "@@ -33,5 +36,51 @@ absl::Status ZetaSqlHelperLocalServiceImpl::Tokenize(\n   return absl::OkStatus();\n }\n \n+absl::Status ZetaSqlHelperLocalServiceImpl::ExtractFunctionRange(\n+    const ExtractFunctionRangeRequest *request,\n+    ExtractFunctionRangeResponse *response) {\n+\n+  std::unique_ptr<::bigquery::utils::zetasql_helper::FunctionRange> output;\n+  ZETASQL_RETURN_IF_ERROR(\n+      ::bigquery::utils::zetasql_helper::ExtractFunctionRange(\n+          request->query(), request->line_number(), request->column_number(), &output\n+      ));\n+\n+  auto status_or_function_range_proto = output->ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_range_proto.status());\n+\n+  // Convert the proto to heap value and hand over the ownership to the response.\n+  auto function_range_proto = new ::bigquery::utils::zetasql_helper::FunctionRangeProto(\n+      status_or_function_range_proto.value()\n+  );\n+  response->set_allocated_function_range(function_range_proto);\n+  return absl::OkStatus();\n+}\n+\n+absl::Status ZetaSqlHelperLocalServiceImpl::LocateTableRanges(const LocateTableRangesRequest *request,\n+                                                              LocateTableRangesResponse *response) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NTcxMQ=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQxMDA1OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.proto", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NDowNFrOHKN7qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDo1Njo1NlrOHKQiYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjA3Mg==", "bodyText": "Please add comment to the proto below.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480476072", "createdAt": "2020-08-31T23:44:04Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.proto", "diffHunk": "@@ -36,4 +47,33 @@ message TokenizeRequest {\n \n message TokenizeResponse {\n   repeated ParseTokenProto parse_token = 1;\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUxODc1NA==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480518754", "createdAt": "2020-09-01T00:56:56Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service.proto", "diffHunk": "@@ -36,4 +47,33 @@ message TokenizeRequest {\n \n message TokenizeResponse {\n   repeated ParseTokenProto parse_token = 1;\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjA3Mg=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQxMjM0OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service_grpc.h", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NTowN1rOHKN86w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTowMDo0N1rOHKQyiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjM5NQ==", "bodyText": "nit: GetAllKeywordsRequest? method name GetAllKeywords?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480476395", "createdAt": "2020-08-31T23:45:07Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service_grpc.h", "diffHunk": "@@ -30,6 +30,17 @@ class ZetaSqlHelperLocalServiceGrpcImpl : public ZetaSqlHelperLocalService::Serv\n   grpc::Status Tokenize(grpc::ServerContext *context, const TokenizeRequest *req,\n                         TokenizeResponse *resp) override;\n \n+  grpc::Status ExtractFunctionRange(grpc::ServerContext *context, const ExtractFunctionRangeRequest *request,\n+                                    ExtractFunctionRangeResponse *response) override;\n+\n+  grpc::Status LocateTableRanges(grpc::ServerContext *context,\n+                                 const LocateTableRangesRequest *request,\n+                                 LocateTableRangesResponse *response) override;\n+\n+  grpc::Status AllKeywords(grpc::ServerContext *context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUyMjg5MQ==", "bodyText": "Yes, I have changed them all to GetAllKeywords", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480522891", "createdAt": "2020-09-01T01:00:47Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/local_service/local_service_grpc.h", "diffHunk": "@@ -30,6 +30,17 @@ class ZetaSqlHelperLocalServiceGrpcImpl : public ZetaSqlHelperLocalService::Serv\n   grpc::Status Tokenize(grpc::ServerContext *context, const TokenizeRequest *req,\n                         TokenizeResponse *resp) override;\n \n+  grpc::Status ExtractFunctionRange(grpc::ServerContext *context, const ExtractFunctionRangeRequest *request,\n+                                    ExtractFunctionRangeResponse *response) override;\n+\n+  grpc::Status LocateTableRanges(grpc::ServerContext *context,\n+                                 const LocateTableRangesRequest *request,\n+                                 LocateTableRangesResponse *response) override;\n+\n+  grpc::Status AllKeywords(grpc::ServerContext *context,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjM5NQ=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQxNDY0OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0NjoyMFrOHKN-RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTowMToxMVrOHKQ0Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3Njc0MA==", "bodyText": "pass by reference if ready only :)", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480476740", "createdAt": "2020-08-31T23:46:20Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUyMzI4Mw==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480523283", "createdAt": "2020-09-01T01:01:11Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3Njc0MA=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQyODMzOnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1MzoxMVrOHKOGfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDoxMjowOVrOHKOiiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3ODg0NQ==", "bodyText": "nit: const auto& argument_range: ....", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480478845", "createdAt": "2020-08-31T23:53:11Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4NjAyNA==", "bodyText": "Just realized the formatter will concat the & and * with the variable..", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480486024", "createdAt": "2020-09-01T00:12:09Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3ODg0NQ=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQyOTg0OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1Mzo1OVrOHKOHZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTowMjowNlrOHKQ4Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTA3Nw==", "bodyText": "nit: zetasql::ASTNode* node", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480479077", "createdAt": "2020-08-31T23:53:59Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {\n+\n+    auto status_or_argument_proto = argument_range.ToProto();\n+    ZETASQL_RETURN_IF_ERROR(status_or_argument_proto.status());\n+    proto.add_arguments()->CopyFrom(status_or_argument_proto.value());\n+  }\n+\n+  return proto;\n+}\n+\n+\n+absl::Status ExtractFunctionRange(absl::string_view query,\n+                                  int row,\n+                                  int column,\n+                                  std::unique_ptr<FunctionRange> *output) {\n+\n+  std::unique_ptr<zetasql::ParserOutput> parser_output;\n+  auto options = BigQueryOptions();\n+  auto status = ParseStatement(query, options.GetParserOptions(), &parser_output);\n+  if (!status.ok()) {\n+    return status;\n+  }\n+\n+  auto offset = get_offset(query, row, column);\n+  auto predicator = [offset](const zetasql::ASTNode *node) {\n+    return node->GetParseLocationRange().start().GetByteOffset() == offset &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUyNDI5MA==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480524290", "createdAt": "2020-09-01T01:02:06Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {\n+\n+    auto status_or_argument_proto = argument_range.ToProto();\n+    ZETASQL_RETURN_IF_ERROR(status_or_argument_proto.status());\n+    proto.add_arguments()->CopyFrom(status_or_argument_proto.value());\n+  }\n+\n+  return proto;\n+}\n+\n+\n+absl::Status ExtractFunctionRange(absl::string_view query,\n+                                  int row,\n+                                  int column,\n+                                  std::unique_ptr<FunctionRange> *output) {\n+\n+  std::unique_ptr<zetasql::ParserOutput> parser_output;\n+  auto options = BigQueryOptions();\n+  auto status = ParseStatement(query, options.GetParserOptions(), &parser_output);\n+  if (!status.ok()) {\n+    return status;\n+  }\n+\n+  auto offset = get_offset(query, row, column);\n+  auto predicator = [offset](const zetasql::ASTNode *node) {\n+    return node->GetParseLocationRange().start().GetByteOffset() == offset &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTA3Nw=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQzMDU0OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NDoxOFrOHKOHzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTowMjowMVrOHKQ3pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTE4MQ==", "bodyText": "nit: ASTFunctionCall*", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480479181", "createdAt": "2020-08-31T23:54:18Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {\n+\n+    auto status_or_argument_proto = argument_range.ToProto();\n+    ZETASQL_RETURN_IF_ERROR(status_or_argument_proto.status());\n+    proto.add_arguments()->CopyFrom(status_or_argument_proto.value());\n+  }\n+\n+  return proto;\n+}\n+\n+\n+absl::Status ExtractFunctionRange(absl::string_view query,\n+                                  int row,\n+                                  int column,\n+                                  std::unique_ptr<FunctionRange> *output) {\n+\n+  std::unique_ptr<zetasql::ParserOutput> parser_output;\n+  auto options = BigQueryOptions();\n+  auto status = ParseStatement(query, options.GetParserOptions(), &parser_output);\n+  if (!status.ok()) {\n+    return status;\n+  }\n+\n+  auto offset = get_offset(query, row, column);\n+  auto predicator = [offset](const zetasql::ASTNode *node) {\n+    return node->GetParseLocationRange().start().GetByteOffset() == offset &&\n+        node->node_kind() == zetasql::ASTNodeKind::AST_FUNCTION_CALL;\n+  };\n+\n+  auto candidate = find_node(parser_output->statement(), predicator);\n+  if (candidate == nullptr) {\n+    return absl::Status(absl::StatusCode::kInvalidArgument, \"Line and/or column numbers are incorrect\");\n+  }\n+\n+  auto function_call = dynamic_cast<const zetasql::ASTFunctionCall *>(candidate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUyNDE5OQ==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480524199", "createdAt": "2020-09-01T01:02:01Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.cc", "diffHunk": "@@ -0,0 +1,94 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"extract_function.h\"\n+#include \"zetasql/public/analyzer.h\"\n+#include \"zetasql/parser/parser.h\"\n+#include \"zetasql_helper/util/util.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+FunctionRange::FunctionRange(const zetasql::ASTFunctionCall *function_call) {\n+  function = function_call->GetParseLocationRange();\n+  name = function_call->function()->GetParseLocationRange();\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  for (auto argument : function_call->arguments()) {\n+    ranges.push_back(argument->GetParseLocationRange());\n+  }\n+  arguments = ranges;\n+}\n+\n+zetasql_base::StatusOr<FunctionRangeProto> FunctionRange::ToProto() const {\n+  FunctionRangeProto proto;\n+  // location range transfer\n+  auto status_or_function_proto = function.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_function_proto.status());\n+\n+  auto range_proto = new zetasql::ParseLocationRangeProto(status_or_function_proto.value());\n+  proto.set_allocated_function(range_proto);\n+\n+  // name range transfer\n+  auto status_or_name_proto = name.ToProto();\n+  ZETASQL_RETURN_IF_ERROR(status_or_name_proto.status());\n+\n+  range_proto = new zetasql::ParseLocationRangeProto(status_or_name_proto.value());\n+  proto.set_allocated_name(range_proto);\n+\n+  for (auto &argument_range : arguments) {\n+\n+    auto status_or_argument_proto = argument_range.ToProto();\n+    ZETASQL_RETURN_IF_ERROR(status_or_argument_proto.status());\n+    proto.add_arguments()->CopyFrom(status_or_argument_proto.value());\n+  }\n+\n+  return proto;\n+}\n+\n+\n+absl::Status ExtractFunctionRange(absl::string_view query,\n+                                  int row,\n+                                  int column,\n+                                  std::unique_ptr<FunctionRange> *output) {\n+\n+  std::unique_ptr<zetasql::ParserOutput> parser_output;\n+  auto options = BigQueryOptions();\n+  auto status = ParseStatement(query, options.GetParserOptions(), &parser_output);\n+  if (!status.ok()) {\n+    return status;\n+  }\n+\n+  auto offset = get_offset(query, row, column);\n+  auto predicator = [offset](const zetasql::ASTNode *node) {\n+    return node->GetParseLocationRange().start().GetByteOffset() == offset &&\n+        node->node_kind() == zetasql::ASTNodeKind::AST_FUNCTION_CALL;\n+  };\n+\n+  auto candidate = find_node(parser_output->statement(), predicator);\n+  if (candidate == nullptr) {\n+    return absl::Status(absl::StatusCode::kInvalidArgument, \"Line and/or column numbers are incorrect\");\n+  }\n+\n+  auto function_call = dynamic_cast<const zetasql::ASTFunctionCall *>(candidate);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTE4MQ=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQzMTM2OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.h", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NDo0NlrOHKOITw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NDo0NlrOHKOITw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTMxMQ==", "bodyText": "nit:", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480479311", "createdAt": "2020-08-31T23:54:46Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/extract_function.h", "diffHunk": "@@ -0,0 +1,60 @@\n+//\n+// Created by mepan on 8/22/20.\n+//\n+\n+#ifndef ZETASQL_HELPER_ZETASQL_HELPER_FUNCTION_LOCATE_FUNCTION_H_\n+#define ZETASQL_HELPER_ZETASQL_HELPER_FUNCTION_LOCATE_FUNCTION_H_\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"zetasql/public/parse_location.h\"\n+#include \"zetasql/parser/parse_tree.h\"\n+#include \"zetasql_helper/scanner/function_range.pb.h\"\n+\n+namespace bigquery::utils::zetasql_helper {\n+\n+// A struct to store the range of different components of a function. It includes the range\n+// of the whole function, the name, and each arguments.\n+struct FunctionRange {\n+  zetasql::ParseLocationRange function;\n+  zetasql::ParseLocationRange name;\n+  std::vector<zetasql::ParseLocationRange> arguments;\n+\n+  FunctionRange(const zetasql::ASTFunctionCall *function_call);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQzMjU4OnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/scanner_test.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NToxMFrOHKOI6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMTowNjoxNVrOHKRJGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTQ2NQ==", "bodyText": "nit: delete the line?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480479465", "createdAt": "2020-08-31T23:55:10Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/scanner_test.cc", "diffHunk": "@@ -0,0 +1,76 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"gtest/gtest.h\"\n+#include \"zetasql_helper/scanner/locate_table.h\"\n+#include \"zetasql_helper/scanner/extract_function.h\"\n+\n+using namespace bigquery::utils::zetasql_helper;\n+\n+class LocationTest : public ::testing::Test {\n+\n+};\n+\n+TEST_F(LocationTest, LocateTableTest1) {\n+  std::string query =\n+      \"SELECT `\u7279\u6b8a\u5b57\u7b26 (unicode characters)`, status FROM bigquery-public-data.`austin_311.311_request`\"\n+      \"cross join `austin_311`.311_request\\n\"\n+      \"where status = '`bigquery-public-data.austin_311.311_request`'\";\n+\n+  std::string table_regex = \"(bigquery-public-data.)?austin_311.311_request\";\n+\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  auto status = LocateTableRanges(query, table_regex, ranges);\n+\n+  EXPECT_TRUE(status.ok());\n+  EXPECT_EQ(2, ranges.size());\n+//  EXPECT_EQ(2, ranges[0].start().GetByteOffset())\n+}\n+\n+std::string range_to_string(absl::string_view query, zetasql::ParseLocationRange &range) {\n+  auto start = range.start().GetByteOffset();\n+  auto length = range.end().GetByteOffset() - range.start().GetByteOffset();\n+  return std::string(query.substr(start, length));\n+}\n+\n+TEST_F(LocationTest, LocateTableTest2) {\n+  std::string query = \"Select max(foo) from bigquery-public-data.mock.survey_2017 group by bar limit 10\";\n+  std::string table_regex = \"bigquery-public-data\\\\.mock\\\\.survey_2017\";\n+\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  auto status = LocateTableRanges(query, table_regex, ranges);\n+\n+  EXPECT_TRUE(status.ok());\n+  EXPECT_EQ(1, ranges.size());\n+//  EXPECT_EQ(2, ranges[0].start().GetByteOffset())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDUyODY2NA==", "bodyText": "I have changed it to two new EXPECT_EQ", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480528664", "createdAt": "2020-09-01T01:06:15Z", "author": {"login": "mingen-pan"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/scanner_test.cc", "diffHunk": "@@ -0,0 +1,76 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"gtest/gtest.h\"\n+#include \"zetasql_helper/scanner/locate_table.h\"\n+#include \"zetasql_helper/scanner/extract_function.h\"\n+\n+using namespace bigquery::utils::zetasql_helper;\n+\n+class LocationTest : public ::testing::Test {\n+\n+};\n+\n+TEST_F(LocationTest, LocateTableTest1) {\n+  std::string query =\n+      \"SELECT `\u7279\u6b8a\u5b57\u7b26 (unicode characters)`, status FROM bigquery-public-data.`austin_311.311_request`\"\n+      \"cross join `austin_311`.311_request\\n\"\n+      \"where status = '`bigquery-public-data.austin_311.311_request`'\";\n+\n+  std::string table_regex = \"(bigquery-public-data.)?austin_311.311_request\";\n+\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  auto status = LocateTableRanges(query, table_regex, ranges);\n+\n+  EXPECT_TRUE(status.ok());\n+  EXPECT_EQ(2, ranges.size());\n+//  EXPECT_EQ(2, ranges[0].start().GetByteOffset())\n+}\n+\n+std::string range_to_string(absl::string_view query, zetasql::ParseLocationRange &range) {\n+  auto start = range.start().GetByteOffset();\n+  auto length = range.end().GetByteOffset() - range.start().GetByteOffset();\n+  return std::string(query.substr(start, length));\n+}\n+\n+TEST_F(LocationTest, LocateTableTest2) {\n+  std::string query = \"Select max(foo) from bigquery-public-data.mock.survey_2017 group by bar limit 10\";\n+  std::string table_regex = \"bigquery-public-data\\\\.mock\\\\.survey_2017\";\n+\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  auto status = LocateTableRanges(query, table_regex, ranges);\n+\n+  EXPECT_TRUE(status.ok());\n+  EXPECT_EQ(1, ranges.size());\n+//  EXPECT_EQ(2, ranges[0].start().GetByteOffset())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTQ2NQ=="}, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNDQzMzEyOnYy", "diffSide": "RIGHT", "path": "tools/zetasql_helper/zetasql_helper/scanner/scanner_test.cc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NToyMVrOHKOJKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1NToyMVrOHKOJKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3OTUyOQ==", "bodyText": "nit: delete the line?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/170#discussion_r480479529", "createdAt": "2020-08-31T23:55:21Z", "author": {"login": "kikkyo"}, "path": "tools/zetasql_helper/zetasql_helper/scanner/scanner_test.cc", "diffHunk": "@@ -0,0 +1,76 @@\n+//\n+// Copyright 2020 BigQuery Utils\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+//\n+\n+#include \"gtest/gtest.h\"\n+#include \"zetasql_helper/scanner/locate_table.h\"\n+#include \"zetasql_helper/scanner/extract_function.h\"\n+\n+using namespace bigquery::utils::zetasql_helper;\n+\n+class LocationTest : public ::testing::Test {\n+\n+};\n+\n+TEST_F(LocationTest, LocateTableTest1) {\n+  std::string query =\n+      \"SELECT `\u7279\u6b8a\u5b57\u7b26 (unicode characters)`, status FROM bigquery-public-data.`austin_311.311_request`\"\n+      \"cross join `austin_311`.311_request\\n\"\n+      \"where status = '`bigquery-public-data.austin_311.311_request`'\";\n+\n+  std::string table_regex = \"(bigquery-public-data.)?austin_311.311_request\";\n+\n+  std::vector<zetasql::ParseLocationRange> ranges;\n+  auto status = LocateTableRanges(query, table_regex, ranges);\n+\n+  EXPECT_TRUE(status.ok());\n+  EXPECT_EQ(2, ranges.size());\n+//  EXPECT_EQ(2, ranges[0].start().GetByteOffset())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c237f5ed77af698740d346cabe4d16a3c9df6de"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2894, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}