{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTM3NzQz", "number": 117, "title": "SQL Extraction: highlight queries in VS Code", "bodyText": "Highlights all query fragments and query usages. Different queries are highlighted in different colors.\n\nAlso un-gitignored the necessary .vscode folder that was autogenerated.", "createdAt": "2020-07-25T00:17:18Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117", "merged": true, "mergeCommit": {"oid": "0b472a9de13baf5df5e5e422c23b9689a2197fa7"}, "closed": true, "closedAt": "2020-07-28T19:44:49Z", "author": {"login": "creativitRy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4NOYfgH2gAyNDU2NTM3NzQzOjY5OWNmZTdiNTVhZmFiMGQ4NmUwNWRjYTdiNDJkMDdhYzRhMGU5Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5Yv-GgH2gAyNDU2NTM3NzQzOjNjYmUxZjFmMzFjNjU5NjI2ODlkYjJmNmVhNTM5ODU2MWI0ZmIwNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "699cfe7b55afab0d86e05dca7b42d07ac4a0e9f8", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/699cfe7b55afab0d86e05dca7b42d07ac4a0e9f8", "committedDate": "2020-07-25T00:10:19Z", "message": "SQL Extraction: highlight queries in VS Code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e86f2c0e207a2dbff9d70f4f82270e964f55c3e3", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e86f2c0e207a2dbff9d70f4f82270e964f55c3e3", "committedDate": "2020-07-27T16:46:51Z", "message": "Better organize highlight method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTgzMTc1", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117#pullrequestreview-455983175", "createdAt": "2020-07-27T17:20:31Z", "commit": {"oid": "e86f2c0e207a2dbff9d70f4f82270e964f55c3e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyMDozMlrOG3sF5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyMDozMlrOG3sF5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0NzI3MQ==", "bodyText": "Are all those files under the .vscode directory needed to build the plugin?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117#discussion_r461047271", "createdAt": "2020-07-27T17:20:32Z", "author": {"login": "feiling"}, "path": "tools/vscode_sql_extraction/.gitignore", "diffHunk": "@@ -3,3 +3,4 @@ node_modules\n .vscode-test/\n *.vsix\n /resources/sql_extraction\n+!/.vscode/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86f2c0e207a2dbff9d70f4f82270e964f55c3e3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTg0ODA2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117#pullrequestreview-455984806", "createdAt": "2020-07-27T17:22:46Z", "commit": {"oid": "e86f2c0e207a2dbff9d70f4f82270e964f55c3e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyMjo0NlrOG3sLQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyMjo0NlrOG3sLQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0ODY0MQ==", "bodyText": "In another pull request, please change getColor() to use the highlight color of the current theme. Add a TODO comment here.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117#discussion_r461048641", "createdAt": "2020-07-27T17:22:46Z", "author": {"login": "feiling"}, "path": "tools/vscode_sql_extraction/src/highlighter.ts", "diffHunk": "@@ -0,0 +1,100 @@\n+import * as path from 'path';\n+import * as vscode from 'vscode';\n+import {Query, locationToRange} from './query';\n+import randomColor from 'randomcolor';\n+\n+/**\n+ * Highlights found queries in the text editor.\n+ */\n+export class Highlighter {\n+  decorations: vscode.TextEditorDecorationType[] = [];\n+\n+  /**\n+   * Highlights all queries in the open document.\n+   *\n+   * @param openEditor currently open editor.\n+   * @param workspaceRoot root path of the open workspace.\n+   * @param queries list of found queries.\n+   */\n+  highlight(\n+    openEditor: vscode.TextEditor,\n+    workspaceRoot: string,\n+    queries: Query[]\n+  ) {\n+    const currentQueries = this.getAllQueriesInCurrentFile(\n+      openEditor,\n+      workspaceRoot,\n+      queries\n+    );\n+    if (currentQueries.length <= 0) {\n+      return;\n+    }\n+\n+    currentQueries.forEach((query, index) => {\n+      const ranges: vscode.Range[] = [];\n+\n+      const workRemaining = [query.query];\n+      while (workRemaining.length > 0) {\n+        const fragment = workRemaining.pop()!;\n+        if (fragment.literal) {\n+          ranges.push(locationToRange(fragment.location));\n+        } else {\n+          // recurse for child fragments\n+          fragment.complex!.forEach(child => {\n+            workRemaining.push(child);\n+          });\n+        }\n+      }\n+\n+      query.usages.forEach(usage => {\n+        ranges.push(locationToRange(usage));\n+      });\n+\n+      openEditor.setDecorations(this.getColor(index), ranges);\n+    });\n+  }\n+\n+  /**\n+   * Gets all queries located in the currently open file.\n+   *\n+   * @param openEditor currently open editor.\n+   * @param workspaceRoot root path of the open workspace.\n+   * @param queries list of found queries.\n+   */\n+  private getAllQueriesInCurrentFile(\n+    openEditor: vscode.TextEditor,\n+    workspaceRoot: string,\n+    queries: Query[]\n+  ) {\n+    let openPath = openEditor.document.uri.path.toString();\n+    if (!path.isAbsolute(openPath)) {\n+      openPath = path.join(workspaceRoot, openPath);\n+    }\n+\n+    return queries.filter(query => {\n+      let filePath = query.file;\n+      if (!path.isAbsolute(filePath)) {\n+        filePath = path.join(workspaceRoot!, query.file);\n+      }\n+      return filePath === openPath;\n+    });\n+  }\n+\n+  /**\n+   * Updates the cache if needed, and then returns the relevant decoration.\n+   *\n+   * @param index decoration number to return.\n+   */\n+  private getColor(index: number): vscode.TextEditorDecorationType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86f2c0e207a2dbff9d70f4f82270e964f55c3e3"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37bc47e3953c2fc409fee1f100120f7ee96c03e", "author": {"user": {"login": "creativitRy", "name": "Gahwon Lee"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/c37bc47e3953c2fc409fee1f100120f7ee96c03e", "committedDate": "2020-07-27T18:39:24Z", "message": "Add todo for theme color"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzkwODgz", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/117#pullrequestreview-456790883", "createdAt": "2020-07-28T16:09:48Z", "commit": {"oid": "c37bc47e3953c2fc409fee1f100120f7ee96c03e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cbe1f1f31c65962689db2f6ea5398561b4fb064", "author": {"user": {"login": "feiling", "name": null}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/3cbe1f1f31c65962689db2f6ea5398561b4fb064", "committedDate": "2020-07-28T16:09:53Z", "message": "Merge branch 'master' into master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 690, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}