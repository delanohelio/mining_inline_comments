{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NjYxMjc5", "number": 91, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMTo0NDoyN1rOEOAJmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMTo0NDoyN1rOEOAJmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMTE3OTc2OnYy", "diffSide": "RIGHT", "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMTo0NDoyN1rOGw6_fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzowMjowOVrOGxoTSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw==", "bodyText": "Does the schema job not return information about the table created that we can use here instead of reparsing the mgiratedSchema?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r453951357", "createdAt": "2020-07-13T21:44:27Z", "author": {"login": "Luminarys"}, "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0MTkwNw==", "bodyText": "I wasn't able to find that. I think the only table information it returns are the query results, which is empty in this case.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454541907", "createdAt": "2020-07-14T17:59:50Z", "author": {"login": "krishsuchdev"}, "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, "originalCommit": {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYzNzAwOQ==", "bodyText": "Testing with the BQ UI it seems like this api is used which returns the table schema. Can you see if it's possible to use this?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454637009", "createdAt": "2020-07-14T20:51:09Z", "author": {"login": "Luminarys"}, "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, "originalCommit": {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4MzQxMg==", "bodyText": "It looks like getQueryResults just returns null for ddl, so it doesnt return a schema for me.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454683412", "createdAt": "2020-07-14T22:33:18Z", "author": {"login": "krishsuchdev"}, "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, "originalCommit": {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MzcwNA==", "bodyText": "Interesting. If it doesn't work then I guess this is fine. Thanks for checking!", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454693704", "createdAt": "2020-07-14T23:02:09Z", "author": {"login": "Luminarys"}, "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, "originalCommit": {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3013, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}