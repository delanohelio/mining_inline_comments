{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDY0MTky", "number": 86, "title": "Query Fixer: reorganize the previous PR and init the project", "bodyText": "", "createdAt": "2020-07-07T00:14:36Z", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86", "merged": true, "mergeCommit": {"oid": "2a53377a186c51694545d7878bc7bfe2565daaca"}, "closed": true, "closedAt": "2020-07-11T00:20:19Z", "author": {"login": "mingen-pan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuk54QAH2gAyNDQ1MDY0MTkyOmEyYTVhODRmZmRmNmNlZWJkNDNjZGRhMzlmMTc3ZjBiNGIxZGMxODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczs-FFgH2gAyNDQ1MDY0MTkyOmUyMDViZjg5NDcyOTY4Mzk1YTg3ZGVmMGJjNDlkODVmYjQ0MjRiYzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a2a5a84ffdf6ceebd43cdda39f177f0b4b1dc187", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/a2a5a84ffdf6ceebd43cdda39f177f0b4b1dc187", "committedDate": "2020-06-25T02:06:24Z", "message": "init a project\ncreate and test a QueryTokenService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f80bd6fc66697b00f278c0cc5ecee9063fb7639", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0f80bd6fc66697b00f278c0cc5ecee9063fb7639", "committedDate": "2020-06-30T21:11:52Z", "message": "reformat the code\nAdd comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ebc50fab3773e85f8b30490392fce784f714f88", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/0ebc50fab3773e85f8b30490392fce784f714f88", "committedDate": "2020-07-01T01:45:14Z", "message": "rename the package name to 'queryfixer'\n\nadd documents for classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccb3d14310ca239e761705b5cab3c7c36768ff5", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/eccb3d14310ca239e761705b5cab3c7c36768ff5", "committedDate": "2020-07-07T00:11:26Z", "message": "decompose the PR into multiple parts.\nThis is the first part: init the project and implement one feature of the QueryTokenProcessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5cd85f8bc0d7b871f86f875ca230bc9ad75121f3", "committedDate": "2020-07-07T00:39:55Z", "message": "minor change in BigQueryParserFactory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTEyNzM1", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#pullrequestreview-445112735", "createdAt": "2020-07-08T20:40:41Z", "commit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "state": "COMMENTED", "comments": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo0MDo0MVrOGu4dFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMToyODoyMlrOGu523g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMjYyOQ==", "bodyText": "nit: \"default\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451812629", "createdAt": "2020-07-08T20:40:41Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMzk3Mw==", "bodyText": "Preconditions.checknotnull() is more popular i think :) https://guava.dev/releases/19.0/api/docs/com/google/common/base/Preconditions.html", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451813973", "createdAt": "2020-07-08T20:43:13Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNDYyOQ==", "bodyText": "nit: Write comment on the field\nparserImpl = FieldUtils.readField(getParser(query), \"parser\", /* field name = */ true);", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451814629", "createdAt": "2020-07-08T20:44:38Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTEzMQ==", "bodyText": "nit: \"Unable\" and ...\"the generated parser**.** \"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451815131", "createdAt": "2020-07-08T20:45:35Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTY5Ng==", "bodyText": "nit: \"The factory.... \" Please pay a bit attention to use upper case when necessary. :)", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451815696", "createdAt": "2020-07-08T20:46:47Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");\n+    }\n+\n+    if (!(parserImpl instanceof SqlBabelParserImpl)) {\n+      throw new ParserCreationException(\"the factory does not produce Babel Parser\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNjc1MQ==", "bodyText": "Does the library provide any interface we should use for SqlBabelParserImpl ? exposing the actual implementation looks a bit strange. Maybe its by design.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451816751", "createdAt": "2020-07-08T20:49:03Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNzM2Ng==", "bodyText": "We don't really comments on the default constructor :) up to you", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451817366", "createdAt": "2020-07-08T20:50:16Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxODgxNQ==", "bodyText": "I think you should attach more details to debug this exception. The simple error message doesn't look very helpful for us to debug.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451818815", "createdAt": "2020-07-08T20:53:07Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTEzMQ=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMDYxNA==", "bodyText": "If we are printing out to the stdout, we should make the error message actionable. e.g., \"Not enough arguments. Please run the tool with \"\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451820614", "createdAt": "2020-07-08T20:56:45Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryFixerMain.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.common.flogger.FluentLogger;\n+\n+public class QueryFixerMain {\n+\n+  private static final FluentLogger logger = FluentLogger.forEnclosingClass();\n+\n+  public static void main(String[] args) {\n+\n+    if (args.length == 0) {\n+      logger.atInfo().log(\"not enough arguments\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMTU3Mg==", "bodyText": "nit: A processor that provides methods for queries and tokens.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451821572", "createdAt": "2020-07-08T20:58:46Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMTgyNg==", "bodyText": "nit: \"Tokenize...\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451821826", "createdAt": "2020-07-08T20:59:15Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on\n+ * positions, and modify a query in token-level.\n+ * */\n+@AllArgsConstructor\n+public class QueryTokenProcessor {\n+\n+  private final BigQueryParserFactory parserFactory;\n+\n+  /**\n+   * tokenize a query and return all its tokens.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMjEwNA==", "bodyText": "nit: please rename \"sql\" to be \"query\" :)", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451822104", "createdAt": "2020-07-08T20:59:47Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on\n+ * positions, and modify a query in token-level.\n+ * */\n+@AllArgsConstructor\n+public class QueryTokenProcessor {\n+\n+  private final BigQueryParserFactory parserFactory;\n+\n+  /**\n+   * tokenize a query and return all its tokens.\n+   * @param sql the query to be tokenized\n+   * @return a list of tokens of the query\n+   */\n+  public List<IToken> getAllTokens(String sql) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMjM5OQ==", "bodyText": "preconditions.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451822399", "createdAt": "2020-07-08T21:00:21Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on\n+ * positions, and modify a query in token-level.\n+ * */\n+@AllArgsConstructor\n+public class QueryTokenProcessor {\n+\n+  private final BigQueryParserFactory parserFactory;\n+\n+  /**\n+   * tokenize a query and return all its tokens.\n+   * @param sql the query to be tokenized\n+   * @return a list of tokens of the query\n+   */\n+  public List<IToken> getAllTokens(String sql) {\n+    Objects.requireNonNull(sql, \"input query should not be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMjk3OA==", "bodyText": "If it is going to used in other places, you can make it static const of the class.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451822978", "createdAt": "2020-07-08T21:01:28Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on\n+ * positions, and modify a query in token-level.\n+ * */\n+@AllArgsConstructor\n+public class QueryTokenProcessor {\n+\n+  private final BigQueryParserFactory parserFactory;\n+\n+  /**\n+   * tokenize a query and return all its tokens.\n+   * @param sql the query to be tokenized\n+   * @return a list of tokens of the query\n+   */\n+  public List<IToken> getAllTokens(String sql) {\n+    Objects.requireNonNull(sql, \"input query should not be null\");\n+\n+    List<IToken> tokens = new ArrayList<>();\n+\n+    // SqlBabelParserImpl has a token manager to tokenize the input query.\n+    SqlBabelParserImpl parserImpl = parserFactory.getBabelParserImpl(sql);\n+\n+    Token token;\n+    final int EndKind = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNDQ0Ng==", "bodyText": "nit: \"An interface\"", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451824446", "createdAt": "2020-07-08T21:04:30Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/IToken.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+/**\n+ * A interface for queries' tokens.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNDg0Mw==", "bodyText": "remove the commented line?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451824843", "createdAt": "2020-07-08T21:05:19Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+/**\n+ * An implementation of token interface based on the Token class of Babel Calcite Parser.\n+ * */\n+public class TokenImpl implements IToken {\n+\n+  private final Token token;\n+\n+  public TokenImpl (Token token) {\n+    this.token = token;\n+  }\n+\n+  @Override public int getKind() {\n+    return token.kind;\n+  }\n+\n+  @Override public String getImage() {\n+    return token.image;\n+  }\n+\n+  @Override public int getBeginLine() {\n+    return token.beginLine;\n+  }\n+\n+  @Override public int getBeginCol() {\n+    return token.beginColumn;\n+  }\n+\n+  @Override public int getEndLine() {\n+    return token.endLine;\n+  }\n+\n+  @Override public int getEndCol() {\n+    return token.endColumn;\n+  }\n+\n+  // babel is a type of parser in Calcite, and this class uses its token for implementation.\n+  public Token getBabelToken() {\n+    return token;\n+  }\n+\n+  @Override public String toString() {\n+    return  String.format(\"%s [%d:%d]\", token.image, token.beginLine, token.beginColumn);\n+  }\n+\n+  //  public static TokenImpl newToken(int ofKind) {\n+//    return new TokenImpl(Token.newToken(ofKind));\n+//  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNTAzNw==", "bodyText": "Add  a comment for the exception?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451825037", "createdAt": "2020-07-08T21:05:43Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/exception/ParserCreationException.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.google.cloud.bigquery.utils.queryfixer.exception;\n+\n+\n+public class ParserCreationException extends RuntimeException {\n+  public ParserCreationException(String message) {\n+    super(message);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNTg5OA==", "bodyText": "nit: getBeginRow(); getBeginColumn()", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451825898", "createdAt": "2020-07-08T21:07:30Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/IToken.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+/**\n+ * A interface for queries' tokens.\n+ * */\n+public interface IToken {\n+\n+  int getKind();\n+\n+  String getImage();\n+\n+  int getBeginLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjUyNQ==", "bodyText": "nit: not sure this has been auto formatted yet... i think usually this should be\n@OverRide\npublic int getKind() {\n...\n}", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451826525", "createdAt": "2020-07-08T21:08:56Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+/**\n+ * An implementation of token interface based on the Token class of Babel Calcite Parser.\n+ * */\n+public class TokenImpl implements IToken {\n+\n+  private final Token token;\n+\n+  public TokenImpl (Token token) {\n+    this.token = token;\n+  }\n+\n+  @Override public int getKind() {\n+    return token.kind;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNzc1Nw==", "bodyText": "nit: convertQueryToTokens()", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451827757", "createdAt": "2020-07-08T21:11:21Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+\n+  @Test\n+  public void convertSqlToTokens() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyODEwNA==", "bodyText": "This should be shared by all test cases in setup()?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451828104", "createdAt": "2020-07-08T21:11:58Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyODM4OA==", "bodyText": "The auto formatting seems a bit weird. The line is too short...", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451828388", "createdAt": "2020-07-08T21:12:40Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+\n+  @Test\n+  public void convertSqlToTokens() {\n+    QueryTokenProcessor tokenService = createService();\n+    String sql = \"Select col from `d1.t1`\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyOTI1Mg==", "bodyText": "Usually we shouldn't print out these in a test.\nIf we want to test out the contents, we should use List expectedTokens  = ... and assert if they are equal", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451829252", "createdAt": "2020-07-08T21:14:33Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+\n+  @Test\n+  public void convertSqlToTokens() {\n+    QueryTokenProcessor tokenService = createService();\n+    String sql = \"Select col from `d1.t1`\\n\" +\n+        \"where t1.col>'val'\";\n+\n+    List<IToken> tokens = tokenService.getAllTokens(sql);\n+    assertEquals(10, tokens.size());\n+    for (IToken token : tokens) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMDY2Nw==", "bodyText": "nit: not sure why there are so many empty lines in between...", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451830667", "createdAt": "2020-07-08T21:17:28Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMTkzMw==", "bodyText": "The best practice for writing tests:\nTests independent behaviors of a method separately:\nExample:\n@test\npublic void displayTransactionResults_showsItemName() {\ntransactionProcessor.displayTransactionResults(\nnew User(), new Transaction(\"Some Item\"));\nassertThat(ui.getText()).contains(\"You bought a Some Item\");\n}", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451831933", "createdAt": "2020-07-08T21:20:19Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParseFactoryTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParseException;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.impl.SqlParserImpl;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class ParseFactoryTest {\n+\n+  @Test\n+  public void getParser() throws SqlParseException {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+    SqlParser parser = factory.getParser(\"select a from b\");\n+    SqlNode node = parser.parseQuery();\n+    assertEquals(SqlKind.SELECT, node.getKind());\n+  }\n+\n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzA5MA==", "bodyText": "public void getParserImpl_returnsIncorrectParser() {}", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451833090", "createdAt": "2020-07-08T21:23:02Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParseFactoryTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParseException;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.impl.SqlParserImpl;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class ParseFactoryTest {\n+\n+  @Test\n+  public void getParser() throws SqlParseException {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+    SqlParser parser = factory.getParser(\"select a from b\");\n+    SqlNode node = parser.parseQuery();\n+    assertEquals(SqlKind.SELECT, node.getKind());\n+  }\n+\n+  @Test\n+  public void queryNotNull() {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+\n+    try {\n+      factory.getBabelParserImpl(null);\n+      fail();\n+    } catch (NullPointerException e) {\n+      assertEquals(\"the input query should not be null\", e.getMessage());\n+    }\n+\n+  }\n+\n+  @Test\n+  public void getParserImplFromIncorrectFactory() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzUxNw==", "bodyText": "Can we add a case for a slightly more complicated query?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451833517", "createdAt": "2020-07-08T21:24:05Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParseFactoryTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParseException;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.impl.SqlParserImpl;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class ParseFactoryTest {\n+\n+  @Test\n+  public void getParser() throws SqlParseException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNTA0NA==", "bodyText": "If most of the settings are default settings, we should consider building it in statically and only set factory here.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451835044", "createdAt": "2020-07-08T21:27:08Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");\n+    }\n+\n+    if (!(parserImpl instanceof SqlBabelParserImpl)) {\n+      throw new ParserCreationException(\"the factory does not produce Babel Parser\");\n+    }\n+    return (SqlBabelParserImpl) parserImpl;\n+  }\n+\n+  protected SqlParser getParser(Reader source) {\n+    return SqlParser.create(source, parserConfig);\n+  }\n+\n+  private SqlParser.Config buildConfig(SqlParserImplFactory factory) {\n+    final SqlParser.ConfigBuilder configBuilder =\n+        SqlParser.configBuilder()\n+            .setParserFactory(factory)\n+            .setQuoting(quoting)\n+            .setUnquotedCasing(unquotedCasing)\n+            .setQuotedCasing(quotedCasing)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNTYxNA==", "bodyText": "also createProcessor() :)", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r451835614", "createdAt": "2020-07-08T21:28:22Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyODEwNA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/8b86a8e36bd784a29c6e7357ff786036a77b80bf", "committedDate": "2020-07-09T18:43:35Z", "message": "revise the review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODMyMDcy", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#pullrequestreview-445832072", "createdAt": "2020-07-09T17:38:49Z", "commit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzozODo1MFrOGvbSgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODo0NDowNFrOGvdb1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4MzM2Mg==", "bodyText": "The weird thing for Calcite is that they don't provide a tokenizer and integrate this function into this class. Thus, it is the class that has getNextToken method (not belong to any interface).\nHowever, since we are going to switch to ZetqSQL, we won't use it in future and it will be removed.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452383362", "createdAt": "2020-07-09T17:38:50Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNjc1MQ=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NDc5MA==", "bodyText": "Done!", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452384790", "createdAt": "2020-07-09T17:41:30Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMzk3Mw=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NjY2Nw==", "bodyText": "Here is something I don't know how to handle. Actually parser is the field of SqlBabelParser so readField will never throw an exception. Should I simply ignore the exception?", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452386667", "createdAt": "2020-07-09T17:44:54Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTEzMQ=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NzA5NA==", "bodyText": "Thanks for pointing out.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452387094", "createdAt": "2020-07-09T17:45:40Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");\n+    }\n+\n+    if (!(parserImpl instanceof SqlBabelParserImpl)) {\n+      throw new ParserCreationException(\"the factory does not produce Babel Parser\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTY5Ng=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4ODQxMA==", "bodyText": "Sorry, I didn't get it. buildConfig is only called in initialization. Then, the parserConfig is stored in a member variable. When a parser is going to be created, only the parserConfig will be used.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452388410", "createdAt": "2020-07-09T17:48:10Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.\n+ */\n+public class BigQueryParserFactory {\n+\n+  private static final Quoting quoting = Quoting.BACK_TICK;\n+  private static final Casing quotedCasing = Casing.UNCHANGED;\n+  private static final SqlConformance conformance = SqlConformanceEnum.DEFAULT;\n+  private final SqlParser.Config parserConfig;\n+  private static final Casing unquotedCasing = Casing.UNCHANGED;\n+\n+  /** Default initialization with the Babel Parser factory. */\n+  public BigQueryParserFactory() {\n+    this(SqlBabelParserImpl.FACTORY);\n+  }\n+\n+  /**\n+   * Initialization with customized factory\n+   *\n+   * @param factory customized factory\n+   */\n+  public BigQueryParserFactory(SqlParserImplFactory factory) {\n+    this.parserConfig = buildConfig(factory);\n+  }\n+\n+  /**\n+   * Get the parser parsing the input query.\n+   *\n+   * @param sql query to parse\n+   * @return a parser loaded with the query\n+   */\n+  public SqlParser getParser(String sql) {\n+    return getParser(new SourceStringReader(sql));\n+  }\n+\n+  /**\n+   * Get the implementation of a parser parsing a query. The implementation provides functions to\n+   * tokenize the query.\n+   *\n+   * @param query the query fed to the parser implementation.\n+   * @return SqlBabelParserImpl the parser implementation\n+   */\n+  public SqlBabelParserImpl getBabelParserImpl(String query) {\n+    Objects.requireNonNull(query, \"the input query should not be null\");\n+\n+    Object parserImpl;\n+    try {\n+      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+    } catch (IllegalAccessException e) {\n+      throw new ParserCreationException(\n+          \"unable to extract the parserImpl from the generated parser\");\n+    }\n+\n+    if (!(parserImpl instanceof SqlBabelParserImpl)) {\n+      throw new ParserCreationException(\"the factory does not produce Babel Parser\");\n+    }\n+    return (SqlBabelParserImpl) parserImpl;\n+  }\n+\n+  protected SqlParser getParser(Reader source) {\n+    return SqlParser.create(source, parserConfig);\n+  }\n+\n+  private SqlParser.Config buildConfig(SqlParserImplFactory factory) {\n+    final SqlParser.ConfigBuilder configBuilder =\n+        SqlParser.configBuilder()\n+            .setParserFactory(factory)\n+            .setQuoting(quoting)\n+            .setUnquotedCasing(unquotedCasing)\n+            .setQuotedCasing(quotedCasing)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNTA0NA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4OTAyNQ==", "bodyText": "I will do it later. I haven't concluded what parameters will be used finally. I will put a TODO here.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452389025", "createdAt": "2020-07-09T17:49:20Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryFixerMain.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.common.flogger.FluentLogger;\n+\n+public class QueryFixerMain {\n+\n+  private static final FluentLogger logger = FluentLogger.forEnclosingClass();\n+\n+  public static void main(String[] args) {\n+\n+    if (args.length == 0) {\n+      logger.atInfo().log(\"not enough arguments\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMDYxNA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4OTc1OA==", "bodyText": "Done.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452389758", "createdAt": "2020-07-09T17:50:41Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMTU3Mg=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDcwNg==", "bodyText": "Not so sure. As far as I plan right now, here may be the only place.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452390706", "createdAt": "2020-07-09T17:52:28Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessor.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+import com.google.cloud.bigquery.utils.queryfixer.entity.TokenImpl;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+/**\n+ * A processor provides methods for query and token. It can be used to tokenize queries, find tokens based on\n+ * positions, and modify a query in token-level.\n+ * */\n+@AllArgsConstructor\n+public class QueryTokenProcessor {\n+\n+  private final BigQueryParserFactory parserFactory;\n+\n+  /**\n+   * tokenize a query and return all its tokens.\n+   * @param sql the query to be tokenized\n+   * @return a list of tokens of the query\n+   */\n+  public List<IToken> getAllTokens(String sql) {\n+    Objects.requireNonNull(sql, \"input query should not be null\");\n+\n+    List<IToken> tokens = new ArrayList<>();\n+\n+    // SqlBabelParserImpl has a token manager to tokenize the input query.\n+    SqlBabelParserImpl parserImpl = parserFactory.getBabelParserImpl(sql);\n+\n+    Token token;\n+    final int EndKind = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMjk3OA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MTQ0NQ==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452391445", "createdAt": "2020-07-09T17:53:53Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/IToken.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+/**\n+ * A interface for queries' tokens.\n+ * */\n+public interface IToken {\n+\n+  int getKind();\n+\n+  String getImage();\n+\n+  int getBeginLine();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNTg5OA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MTk3Mg==", "bodyText": "I think it is auto formatted... I don't code this way either.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452391972", "createdAt": "2020-07-09T17:54:52Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+/**\n+ * An implementation of token interface based on the Token class of Babel Calcite Parser.\n+ * */\n+public class TokenImpl implements IToken {\n+\n+  private final Token token;\n+\n+  public TokenImpl (Token token) {\n+    this.token = token;\n+  }\n+\n+  @Override public int getKind() {\n+    return token.kind;\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNjUyNQ=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MjI4MQ==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452392281", "createdAt": "2020-07-09T17:55:29Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/entity/TokenImpl.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.cloud.bigquery.utils.queryfixer.entity;\n+\n+import org.apache.calcite.sql.parser.babel.Token;\n+\n+/**\n+ * An implementation of token interface based on the Token class of Babel Calcite Parser.\n+ * */\n+public class TokenImpl implements IToken {\n+\n+  private final Token token;\n+\n+  public TokenImpl (Token token) {\n+    this.token = token;\n+  }\n+\n+  @Override public int getKind() {\n+    return token.kind;\n+  }\n+\n+  @Override public String getImage() {\n+    return token.image;\n+  }\n+\n+  @Override public int getBeginLine() {\n+    return token.beginLine;\n+  }\n+\n+  @Override public int getBeginCol() {\n+    return token.beginColumn;\n+  }\n+\n+  @Override public int getEndLine() {\n+    return token.endLine;\n+  }\n+\n+  @Override public int getEndCol() {\n+    return token.endColumn;\n+  }\n+\n+  // babel is a type of parser in Calcite, and this class uses its token for implementation.\n+  public Token getBabelToken() {\n+    return token;\n+  }\n+\n+  @Override public String toString() {\n+    return  String.format(\"%s [%d:%d]\", token.image, token.beginLine, token.beginColumn);\n+  }\n+\n+  //  public static TokenImpl newToken(int ofKind) {\n+//    return new TokenImpl(Token.newToken(ofKind));\n+//  }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNDg0Mw=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxMjQwMw==", "bodyText": "A new case is added.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452412403", "createdAt": "2020-07-09T18:32:12Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParseFactoryTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParseException;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.impl.SqlParserImpl;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class ParseFactoryTest {\n+\n+  @Test\n+  public void getParser() throws SqlParseException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzUxNw=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxMzQ0Mw==", "bodyText": "I think it is caused by auto format.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452413443", "createdAt": "2020-07-09T18:34:12Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMDY2Nw=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxMzY3OA==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452413678", "createdAt": "2020-07-09T18:34:42Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParseFactoryTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParseException;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.impl.SqlParserImpl;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+public class ParseFactoryTest {\n+\n+  @Test\n+  public void getParser() throws SqlParseException {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+    SqlParser parser = factory.getParser(\"select a from b\");\n+    SqlNode node = parser.parseQuery();\n+    assertEquals(SqlKind.SELECT, node.getKind());\n+  }\n+\n+  @Test\n+  public void queryNotNull() {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+\n+    try {\n+      factory.getBabelParserImpl(null);\n+      fail();\n+    } catch (NullPointerException e) {\n+      assertEquals(\"the input query should not be null\", e.getMessage());\n+    }\n+\n+  }\n+\n+  @Test\n+  public void getParserImplFromIncorrectFactory() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzMzA5MA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxNTA5MA==", "bodyText": "I break this on purpose. I want to simulate the BigQuery console, where a user can type a query in multiple lines.", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452415090", "createdAt": "2020-07-09T18:37:24Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+\n+  @Test\n+  public void convertSqlToTokens() {\n+    QueryTokenProcessor tokenService = createService();\n+    String sql = \"Select col from `d1.t1`\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyODM4OA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxNzQ1OA==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452417458", "createdAt": "2020-07-09T18:41:56Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+\n+  @Test\n+  public void convertSqlToTokens() {\n+    QueryTokenProcessor tokenService = createService();\n+    String sql = \"Select col from `d1.t1`\\n\" +\n+        \"where t1.col>'val'\";\n+\n+    List<IToken> tokens = tokenService.getAllTokens(sql);\n+    assertEquals(10, tokens.size());\n+    for (IToken token : tokens) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyOTI1Mg=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxODUxNw==", "bodyText": "Done", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452418517", "createdAt": "2020-07-09T18:44:04Z", "author": {"login": "mingen-pan"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import org.apache.calcite.avatica.util.Casing;\n+import org.apache.calcite.avatica.util.Quoting;\n+import org.apache.calcite.sql.parser.SqlParser;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n+import org.apache.calcite.sql.parser.babel.SqlBabelParserImpl;\n+import org.apache.calcite.sql.validate.SqlConformance;\n+import org.apache.calcite.sql.validate.SqlConformanceEnum;\n+import org.apache.calcite.util.SourceStringReader;\n+import org.apache.commons.lang3.reflect.FieldUtils;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.exception.ParserCreationException;\n+\n+import java.io.Reader;\n+import java.util.Objects;\n+\n+/**\n+ * A factory to generate parsers. The fault generated parser is Babel Parser with BigQuery dialect.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMjYyOQ=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDMyODY2", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#pullrequestreview-446032866", "createdAt": "2020-07-09T23:28:53Z", "commit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzoyODo1NFrOGvlE0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzozNjoyOVrOGvlOIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0MzY5OA==", "bodyText": "nit: There should be space in between /* forceAccess= /<extra space> true", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452543698", "createdAt": "2020-07-09T23:28:54Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/main/java/com/google/cloud/bigquery/utils/queryfixer/BigQueryParserFactory.java", "diffHunk": "@@ -58,18 +58,19 @@ public SqlParser getParser(String sql) {\n    * @return SqlBabelParserImpl the parser implementation\n    */\n   public SqlBabelParserImpl getBabelParserImpl(String query) {\n-    Objects.requireNonNull(query, \"the input query should not be null\");\n+    Preconditions.checkNotNull(query, \"The input query should not be null.\");\n \n     Object parserImpl;\n     try {\n-      parserImpl = FieldUtils.readField(getParser(query), \"parser\", true);\n+      parserImpl = FieldUtils.readField(getParser(query), /* fieldName= */\"parser\", /* forceAccess= */true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NDc5MA==", "bodyText": "getParser_selectQuery()", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452544790", "createdAt": "2020-07-09T23:32:28Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParserFactoryTest.java", "diffHunk": "@@ -11,18 +11,29 @@\n import org.junit.Test;\n \n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n \n-public class ParseFactoryTest {\n+public class ParserFactoryTest {\n \n   @Test\n-  public void getParser() throws SqlParseException {\n+  public void getParser1() throws SqlParseException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTA5NQ==", "bodyText": "getParser_selectWithSubQuery()", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452545095", "createdAt": "2020-07-09T23:33:35Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParserFactoryTest.java", "diffHunk": "@@ -11,18 +11,29 @@\n import org.junit.Test;\n \n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n \n-public class ParseFactoryTest {\n+public class ParserFactoryTest {\n \n   @Test\n-  public void getParser() throws SqlParseException {\n+  public void getParser1() throws SqlParseException {\n     BigQueryParserFactory factory = new BigQueryParserFactory();\n     SqlParser parser = factory.getParser(\"select a from b\");\n     SqlNode node = parser.parseQuery();\n     assertEquals(SqlKind.SELECT, node.getKind());\n   }\n \n+  @Test\n+  public void getParser2() throws SqlParseException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NTM4OA==", "bodyText": "getParser_nullQuery", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452545388", "createdAt": "2020-07-09T23:34:35Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/ParserFactoryTest.java", "diffHunk": "@@ -11,18 +11,29 @@\n import org.junit.Test;\n \n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n \n-public class ParseFactoryTest {\n+public class ParserFactoryTest {\n \n   @Test\n-  public void getParser() throws SqlParseException {\n+  public void getParser1() throws SqlParseException {\n     BigQueryParserFactory factory = new BigQueryParserFactory();\n     SqlParser parser = factory.getParser(\"select a from b\");\n     SqlNode node = parser.parseQuery();\n     assertEquals(SqlKind.SELECT, node.getKind());\n   }\n \n+  @Test\n+  public void getParser2() throws SqlParseException {\n+    BigQueryParserFactory factory = new BigQueryParserFactory();\n+    SqlParser parser =\n+        factory.getParser(\n+            \"select * from (select a, b, c from x cross join y where d > 10) inner join z\");\n+    SqlNode node = parser.parseQuery();\n+    assertEquals(SqlKind.SELECT, node.getKind());\n+  }\n+\n   @Test\n   public void queryNotNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b86a8e36bd784a29c6e7357ff786036a77b80bf"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NjA4Mg==", "bodyText": "I think you can make it a member in testSetup() so you don't have to call it for every test case", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/86#discussion_r452546082", "createdAt": "2020-07-09T23:36:29Z", "author": {"login": "kikkyo"}, "path": "tools/automatic_query_fixer/src/test/java/com/google/cloud/bigquery/utils/queryfixer/QueryTokenProcessorTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.google.cloud.bigquery.utils.queryfixer;\n+\n+import com.google.cloud.bigquery.utils.queryfixer.entity.IToken;\n+\n+import org.junit.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class QueryTokenProcessorTest {\n+\n+  private QueryTokenProcessor createService() {\n+    return new QueryTokenProcessor(new BigQueryParserFactory());\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyODEwNA=="}, "originalCommit": {"oid": "5cd85f8bc0d7b871f86f875ca230bc9ad75121f3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f907074ad2175483fa52068793fbafe3baf970e", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/7f907074ad2175483fa52068793fbafe3baf970e", "committedDate": "2020-07-11T00:19:20Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e205bf89472968395a87def0bc49d85fb4424bc8", "author": {"user": {"login": "mingen-pan", "name": "Mingen Pan"}}, "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/e205bf89472968395a87def0bc49d85fb4424bc8", "committedDate": "2020-07-11T00:19:51Z", "message": "Merge branch 'master' into mepan_init"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 628, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}