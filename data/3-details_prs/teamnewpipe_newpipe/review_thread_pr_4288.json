{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTIzNjk1", "number": 4288, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMzo1NjozMlrOEn1zpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMzo1NjozMlrOEn1zpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMjExNDk1OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMzo1NjozMlrOHYnjHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNjozMDoxMlrOHYoapw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw==", "bodyText": "Is this change needed with the MedidaStyle notifications?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495575837", "createdAt": "2020-09-27T13:56:32Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjM0NQ==", "bodyText": "I think so, as doing this in the background prevents it from being done by Android on the main thread. Also, I think the slowdown is not related to MediaStyle, but rather to the MediaSession, so this code probably helps independently of the type of notifications used. @vkay94 correct me if I'm wrong ;-)", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495576345", "createdAt": "2020-09-27T14:02:07Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTI2Mg==", "bodyText": "In this place\nBitmap.createScaledBitmap\nI'm scaling down the image only once before assigning it to currentThumbnail. Without it Android will resize the thumbnail on every notification update which is a heavy task if the image is large (on YouTube it's large). In this case I made it smaller (much smaller) and if Android needs to resize it the time needed for the resize will be small. I'm not sure about the quality of the thumbnail but for me it looks ok compared to previous thumbnail impelementation. You can then change the width from 200dp (player_notification_thumbnail_width) to something else if the quality is not as good as you want.\nThe main thing that eats main thread's CPU time is an image resize but after this change there is no such problem. Actually I didn't tested in profiler after the change but visually it doesn't lock main thread as before on rotation change and after other changes.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495581262", "createdAt": "2020-09-27T14:55:40Z", "author": {"login": "avently"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjA2NA==", "bodyText": "With media style notifications the thumbnail can be even smaller because it use less space than previous notifications.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495582064", "createdAt": "2020-09-27T15:05:23Z", "author": {"login": "avently"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MzA0Ng==", "bodyText": "Would be better to somehow get the size for thumbnail inside media style notification and apply this size instead of 200dp. Does anyone know the exact size Android uses for notification?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495583046", "createdAt": "2020-09-27T15:15:47Z", "author": {"login": "avently"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MDA1NQ==", "bodyText": "no. I assume that varies from screen size and density.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495590055", "createdAt": "2020-09-27T16:30:12Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw=="}, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3068, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}