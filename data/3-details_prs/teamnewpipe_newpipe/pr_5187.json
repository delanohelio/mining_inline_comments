{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwNjIwOTY0", "number": 5187, "title": "Fix crash when no default browser is set and improve share dialogs (on some devices)", "bodyText": "What is it?\n\n Bugfix (user facing)\n Feature (user facing)\n Codebase improvement (dev facing)\n Meta improvement to the project (dev facing)\n\nDescription of the changes in your PR\nGeneral description of the changes\nThis PR improves sharing content to other apps with the following changes:\n\nfix crash when no browser is set on some devices (NewPipe thinks that the system app chooser is a browser because its package ID isn't \"android\" due to some OEM's system customizations)\ntry to use Android's system share sheet instead of OEM's share sheet (this last is used as a fallback if this first was removed) for:\n\nshare content in clipboard (playlists, videos, tracks, channels and bug reports)\nopen content in browser (playlists, videos, tracks, channels, report on GitHub in bug reports options and comments, install a player prompts) where there is no default app\nopen a video stream / an audio stream in a external player where there is no default app\n\n\nfix double toast Copied to clipboard shown when copying formatted report in crash report activity\n\nCode changes\n\ncatch ActivityNotFoundException when opening an URL or a file if it's a chooser\nadd openFileInApp method in ShareUtils to be able to open streams in external app / downloads in default app or in the app chooser\nedit getDefaultAppPackageName method of ShareUtils to be able to return default app for opening downloads, streams, or URLs\nuse ShareUtils.openFileInApp for downloads / playing streams in external player\nuse ShareUtils.shareUrl for sharing crash report from ErrorActivity to other apps and for sharing a stream in the play queue\nuse ShareUtils.openUrlInBrowser when tap \"Install\" button from install VLC and install Kore dialogs\nuse an ACTION_CHOOSER intent and putting as an extra intent the ACTION_SEND intent to share downloads\nadd a string open_with in English and French which is used for Android's system chooser title\nadd / edit comments and change JavaDocs for remembering that \"android\" package isn't returned when no default app on some devices\nalso indent checkstyle-suppressions.xml file\n\nHere is the difference between the original code and my changes (my device is an Honor 9X, running EMUI 10):\n\n\n\nBefore this PR\nAfter this PR\n\n\n\n\n\n\n\n\nShare panel before this PR\nShare panel after this PR\n\n\n\n\n\n\nOpen in browser before this PR\nOpen in browser after this PR\n\n\n\n\n\n\nOpen a download when no default app set before this PR\nOpen a download when no default app set after this PR\n\n\n\nWhat I changed to do this\nThe trick to do this is to use an ACTION_CHOOSER intent and put the share intent (ACTION_SEND) or the view intent (ACTION_VIEW) as an extra intent.\nNote also if Android's system chooser (in the intent ACTION_CHOOSER) has been directly modified by the OEM, this PR will not change it.\nA few note about UX\nWith my changes, we can't choose which app to always open an intent but only choose for once (if there isn't a default app).\nFixes the following issue(s)\nFixes #3925\nAPK testing\nNewPipe share improvements debug apk.zip (based on 92a87a5)\nDue diligence\n\n I read the contribution guidelines.\n\nImportant note: I am not an Android / Java developer so please be indulgent with me.", "createdAt": "2020-12-15T19:33:39Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187", "merged": true, "mergeCommit": {"oid": "8c9f2af855b10e786441277e2dbc31cb145e7237"}, "closed": true, "closedAt": "2021-01-16T12:42:23Z", "author": {"login": "TiA4f8R"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdwFbA_AFqTU2ODI3OTM5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdws3rHAFqTU2OTkzNTczOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4Mjc5Mzky", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#pullrequestreview-568279392", "createdAt": "2021-01-14T14:23:54Z", "commit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNDoyMzo1NFrOITm2tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNDozODo1M1rOITnieA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzMDQ1NA==", "bodyText": "Why Boolean and not boolean?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557430454", "createdAt": "2021-01-14T14:23:54Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzMDg1Mw==", "bodyText": "Copy-paste leftover", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557430853", "createdAt": "2021-01-14T14:24:28Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {\n+        final String defaultPackageName;\n+        final Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url))\n+                .setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n+        if (httpDefaultBrowserTest) {\n+            defaultPackageName = getDefaultBrowserPackageName(context);\n+        } else {\n+            defaultPackageName = getDefaultAppPackageName(context, intent);\n+        }\n+\n+        if (defaultPackageName.equals(\"android\")) {\n+            // no browser set as default (doesn't work on some devices)\n+            openInDefaultApp(context, intent);\n+        } else {\n+            try {\n+                intent.setPackage(defaultPackageName);\n+                context.startActivity(intent);\n+            } catch (final ActivityNotFoundException e) {\n+                // not a browser but an app chooser because of OEMs changes\n+                intent.setPackage(null);\n+                openInDefaultApp(context, intent);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Open the url with the system default browser.\n+     * <p>\n+     * If no browser is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     * <p>\n+     * This call {@link ShareUtils#openUrlInBrowser(Context, String, Boolean)} with true\n+     * for the boolean parameter\n      *\n      * @param context the context to use\n      * @param url     the url to browse\n-     */\n+     **/\n     public static void openUrlInBrowser(final Context context, final String url) {\n-        final String defaultBrowserPackageName = getDefaultBrowserPackageName(context);\n+        openUrlInBrowser(context, url, true);\n+    }\n+\n+    /**\n+     * Open a content with the system default browser.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDE4NQ==", "bodyText": "This can probably also be moved to ShareUtils", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557434185", "createdAt": "2021-01-14T14:28:48Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/NavigationHelper.java", "diffHunk": "@@ -569,27 +567,14 @@ public static Intent getIntentByLink(final Context context,\n         return getOpenIntent(context, url, service.getServiceId(), linkType);\n     }\n \n-    private static Uri openMarketUrl(final String packageName) {\n-        return Uri.parse(\"market://details\")\n-                .buildUpon()\n-                .appendQueryParameter(\"id\", packageName)\n-                .build();\n-    }\n-\n-    private static Uri getGooglePlayUrl(final String packageName) {\n-        return Uri.parse(\"https://play.google.com/store/apps/details\")\n-                .buildUpon()\n-                .appendQueryParameter(\"id\", packageName)\n-                .build();\n-    }\n-\n     private static void installApp(final Context context, final String packageName) {\n         try {\n             // Try market:// scheme\n-            context.startActivity(new Intent(Intent.ACTION_VIEW, openMarketUrl(packageName)));\n+            ShareUtils.openUrlInBrowser(context, \"market://details?id=\" + packageName, false);\n         } catch (final ActivityNotFoundException e) {\n             // Fall back to google play URL (don't worry F-Droid can handle it :)\n-            context.startActivity(new Intent(Intent.ACTION_VIEW, getGooglePlayUrl(packageName)));\n+            ShareUtils.openUrlInBrowser(context,\n+                    \"https://play.google.com/store/apps/details?id=\" + packageName, false);\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNDg2OA==", "bodyText": "Could you give a better name to this? For me the difference between openContentInApp and openInDefaultApp isn't clear", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557434868", "createdAt": "2021-01-14T14:29:46Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -21,22 +22,80 @@ private ShareUtils() {\n      * Open the url with the system default browser.\n      * <p>\n      * If no browser is set as default, fallbacks to\n-     * {@link ShareUtils#openInDefaultApp(Context, String)}\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context                the context to use\n+     * @param url                    the url to browse\n+     * @param httpDefaultBrowserTest the boolean to set if the\n+     *                               test for the default browser will be for HTTP protocol\n+     *                               or for the created intent\n+     */\n+    public static void openUrlInBrowser(final Context context, final String url,\n+                                        final Boolean httpDefaultBrowserTest) {\n+        final String defaultPackageName;\n+        final Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url))\n+                .setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n+        if (httpDefaultBrowserTest) {\n+            defaultPackageName = getDefaultBrowserPackageName(context);\n+        } else {\n+            defaultPackageName = getDefaultAppPackageName(context, intent);\n+        }\n+\n+        if (defaultPackageName.equals(\"android\")) {\n+            // no browser set as default (doesn't work on some devices)\n+            openInDefaultApp(context, intent);\n+        } else {\n+            try {\n+                intent.setPackage(defaultPackageName);\n+                context.startActivity(intent);\n+            } catch (final ActivityNotFoundException e) {\n+                // not a browser but an app chooser because of OEMs changes\n+                intent.setPackage(null);\n+                openInDefaultApp(context, intent);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Open the url with the system default browser.\n+     * <p>\n+     * If no browser is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     * <p>\n+     * This call {@link ShareUtils#openUrlInBrowser(Context, String, Boolean)} with true\n+     * for the boolean parameter\n      *\n      * @param context the context to use\n      * @param url     the url to browse\n-     */\n+     **/\n     public static void openUrlInBrowser(final Context context, final String url) {\n-        final String defaultBrowserPackageName = getDefaultBrowserPackageName(context);\n+        openUrlInBrowser(context, url, true);\n+    }\n+\n+    /**\n+     * Open a content with the system default browser.\n+     * <p>\n+     * If no app is set as default, fallbacks to\n+     * {@link ShareUtils#openInDefaultApp(Context, Intent)}\n+     *\n+     * @param context the context to use\n+     * @param intent  the intent of the file to open\n+     */\n+    public static void openContentInApp(final Context context, final Intent intent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzNjk4Nw==", "bodyText": "Could you move the falses that would fit into the 100 character limit inline? Also above", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557436987", "createdAt": "2021-01-14T14:32:23Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/about/AboutActivity.java", "diffHunk": "@@ -146,16 +146,20 @@ public View onCreateView(@NonNull final LayoutInflater inflater, final ViewGroup\n             aboutBinding.appVersion.setText(BuildConfig.VERSION_NAME);\n \n             aboutBinding.githubLink.setOnClickListener(nv ->\n-                    openUrlInBrowser(context, context.getString(R.string.github_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.github_url),\n+                            false));\n \n             aboutBinding.donationLink.setOnClickListener(v ->\n-                    openUrlInBrowser(context, context.getString(R.string.donation_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.donation_url),\n+                            false));\n \n             aboutBinding.websiteLink.setOnClickListener(nv ->\n-                    openUrlInBrowser(context, context.getString(R.string.website_url)));\n+                    openUrlInBrowser(context, context.getString(R.string.website_url),\n+                            false));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQzOTc0MA==", "bodyText": "LinkHelper doesn't feel like the right name to me, though I don't have a better suggestion", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557439740", "createdAt": "2021-01-14T14:36:18Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/LinkHelper.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package org.schabi.newpipe.util;\n+\n+import android.content.Context;\n+import android.text.SpannableStringBuilder;\n+import android.text.method.LinkMovementMethod;\n+import android.text.style.ClickableSpan;\n+import android.text.style.URLSpan;\n+import android.text.util.Linkify;\n+import android.view.View;\n+import android.widget.TextView;\n+\n+import androidx.core.text.HtmlCompat;\n+\n+import io.noties.markwon.Markwon;\n+import io.noties.markwon.linkify.LinkifyPlugin;\n+\n+public final class LinkHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ0MTY1Ng==", "bodyText": "Shouldn't this be called shareText, since it is now used to also share json?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#discussion_r557441656", "createdAt": "2021-01-14T14:38:53Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/util/ShareUtils.java", "diffHunk": "@@ -79,13 +156,15 @@ private static String getDefaultBrowserPackageName(final Context context) {\n      * @param url     the url to share\n      */\n     public static void shareUrl(final Context context, final String subject, final String url) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a3df743de42dad4676f26e2557aa206dedaad8e"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a57fd69fb4787d08982c6cfb0d867f365588d6dc", "author": {"user": {"login": "TiA4f8R", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/a57fd69fb4787d08982c6cfb0d867f365588d6dc", "committedDate": "2021-01-16T12:23:06Z", "message": "External sharing improvements\n\nImprove NewPipe's share on some devices + fix crash when no browser is set on some devices\n\nCatching ActivityNotFoundException when trying to open the default browser\nUse an ACTION_CHOOSER intent and put as an extra intent the intent to\nopen an URI / share an URI when no default app is set.\n\nAdd a LinkHelper class which set a custom action when clicking web links\nin the description of a content. This class also helps to implement a confirmation dialog when trying to open web links in an external app."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e98db3bd58adfe2bc298ce672e963587facf33", "author": {"user": {"login": "TiA4f8R", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/79e98db3bd58adfe2bc298ce672e963587facf33", "committedDate": "2021-01-16T12:23:42Z", "message": "Apply the requested changes and little improvements\nApply the requested changes, use ShareUtils.shareText to share an stream in the play queue and optimize imports for Java files, using Android Studio functionality.\n\nApply the requested changes and do little improvements\nApply the requested changes, use ShareUtils.shareText to share an stream in the play queue and optimize imports for Java files, using Android Studio functionality."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "594f0b10ba379b24669bfcb4c04a0f5c3537ea50", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/594f0b10ba379b24669bfcb4c04a0f5c3537ea50", "committedDate": "2021-01-16T12:23:42Z", "message": "Move TextLinkifier computation out of main thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5OTM1NzM5", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5187#pullrequestreview-569935739", "createdAt": "2021-01-16T12:42:14Z", "commit": {"oid": "594f0b10ba379b24669bfcb4c04a0f5c3537ea50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4052, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}