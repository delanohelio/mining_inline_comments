{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMDI1ODcy", "number": 3044, "title": "Description fix and some PeerTube fixes", "bodyText": "I carefully read the contribution guidelines and agree to them.\n\nDescription:\n\nPeerTube: it's now full description (it cut at 250 characters before), and Markdown is supported.\nMediaCCC: descriptions as it should be (newlines added).\nYouTube: timestamps in descriptions are clickable and work. Fixes #1025 (Thanks to @jimbo1qaz & #2536).\n\nPeerTube fixes:\n\nThumbnail is now high quality.\nAge limit is now handled.\nUpload date in \u00abrecently added\u00bb feed is good now (it was delayed as much hours as your are from GMT).\n\nScreenshots & APK\nBefore\nAfter: Thumbnail Description (and see this beautiful Markdown \ud83d\ude03)\nAPK: 2020-02-08_description_and_peertube_fixes#3044.zip\nOther\nTeamNewPipe/NewPipeExtractor#239, needs to be merged before this PR.\nAs mentionned here (comment), I plan to make a second PR later to implement metadata extracted thanks to TeamNewPipe/NewPipeExtractor#239, but this PR is only made of fixes so that it can be hopefully in the next version.", "createdAt": "2020-02-02T16:03:26Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044", "merged": true, "mergeCommit": {"oid": "07544cd19884118a53e12dde913a8492b20b26d8"}, "closed": true, "closedAt": "2020-02-08T23:11:50Z", "author": {"login": "B0pol"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBxQPxAFqTM1NDc2OTcyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCcSnEAFqTM1NTU3Mzg4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzY5NzIw", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#pullrequestreview-354769720", "createdAt": "2020-02-06T21:03:05Z", "commit": {"oid": "c95126f5458295d8a7ba05317a5d60b9950cc4b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTowMzowNlrOFmqHvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTowMzowNlrOFmqHvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MDMxNw==", "bodyText": "Maybe we can avoid the if conditions here by creating a description class in the extractor with fields content and type.\nprepareDescription(info.getDescription().getContent(), info.getDescription().getType());", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376080317", "createdAt": "2020-02-06T21:03:06Z", "author": {"login": "yausername"}, "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1126,7 +1142,20 @@ public void handleResult(@NonNull StreamInfo info) {\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n-        prepareDescription(info.getDescription());\n+        int serviceId = info.getServiceId();\n+\n+        if (serviceId != YOUTUBE_SERVICE_ID) {\n+            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n+        }\n+\n+        if (serviceId == PEERTUBE_SERVICE_ID) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95126f5458295d8a7ba05317a5d60b9950cc4b8"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7045f9711c04a4a0610553f605c8c69a7fd4f21f", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/7045f9711c04a4a0610553f605c8c69a7fd4f21f", "committedDate": "2020-02-06T21:42:09Z", "message": "fix thumbnail for PeerTube, and description changes\n\ndescription:\n- PeerTube: it's now full description (it cut at 250 characters before), and it displays ok (newlines are ok, but markdown isn't)\n- MediaCCC: descriptions are now displayed well (newlines added)\n- YouTube: timestamps in descriptions are clickable and work\n\nmore PeerTube fixes:\nthumbnail is now high quality\nage limit is now handled\nupload date in \u00abrecently added\u00bb feed is good now (it was one hour delayed)\nall fixes come from https://github.com/TeamNewPipe/NewPipeExtractor/pull/239, so it need to be merged before this PR"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c95126f5458295d8a7ba05317a5d60b9950cc4b8", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/c95126f5458295d8a7ba05317a5d60b9950cc4b8", "committedDate": "2020-02-02T15:54:09Z", "message": "fix thumbnail for PeerTube, and description changes\n\ndescription:\n- PeerTube: it's now full description (it cut at 250 characters before), and it displays ok (newlines are ok, but markdown isn't)\n- MediaCCC: descriptions are now displayed well (newlines added)\n- YouTube: timestamps in descriptions are clickable and work\n\nmore PeerTube fixes:\nthumbnail is now high quality\nage limit is now handled\nupload date in \u00abrecently added\u00bb feed is good now (it was one hour delayed)\nall fixes come from https://github.com/TeamNewPipe/NewPipeExtractor/pull/239, so it need to be merged before this PR"}, "afterCommit": {"oid": "7045f9711c04a4a0610553f605c8c69a7fd4f21f", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/7045f9711c04a4a0610553f605c8c69a7fd4f21f", "committedDate": "2020-02-06T21:42:09Z", "message": "fix thumbnail for PeerTube, and description changes\n\ndescription:\n- PeerTube: it's now full description (it cut at 250 characters before), and it displays ok (newlines are ok, but markdown isn't)\n- MediaCCC: descriptions are now displayed well (newlines added)\n- YouTube: timestamps in descriptions are clickable and work\n\nmore PeerTube fixes:\nthumbnail is now high quality\nage limit is now handled\nupload date in \u00abrecently added\u00bb feed is good now (it was one hour delayed)\nall fixes come from https://github.com/TeamNewPipe/NewPipeExtractor/pull/239, so it need to be merged before this PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTU0MzM1", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#pullrequestreview-354954335", "createdAt": "2020-02-07T06:35:49Z", "commit": {"oid": "55837c11ba1dd4db6f13a18b70d0bb19bf01c98b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNjozNTo0OVrOFmzfZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNjozNTo0OVrOFmzfZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIzMzgzMQ==", "bodyText": "How about checking for non-html instead of non-youtube?\nAlso, it would be better to move this into prepareDescription", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376233831", "createdAt": "2020-02-07T06:35:49Z", "author": {"login": "yausername"}, "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1126,6 +1135,10 @@ public void handleResult(@NonNull StreamInfo info) {\n             videoUploadDateView.setVisibility(View.GONE);\n         }\n \n+        if (info.getServiceId() != ServiceList.YouTube.getServiceId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55837c11ba1dd4db6f13a18b70d0bb19bf01c98b"}, "originalPosition": 95}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4b3a50e50b9aa6eb726160967ff8f7286f0003b", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/b4b3a50e50b9aa6eb726160967ff8f7286f0003b", "committedDate": "2020-02-07T13:01:09Z", "message": "refactor linkify urls description"}, "afterCommit": {"oid": "1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "committedDate": "2020-02-07T13:03:24Z", "message": "refactor Description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "committedDate": "2020-02-07T13:14:55Z", "message": "refactor Description"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/1daeb5e7d54a45d1e93fdf89683838e9b7c81ed4", "committedDate": "2020-02-07T13:03:24Z", "message": "refactor Description"}, "afterCommit": {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/badaff8ebcd6f446a6a4b575adba43d627b4c7c2", "committedDate": "2020-02-07T13:14:55Z", "message": "refactor Description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTM1ODMw", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#pullrequestreview-355535830", "createdAt": "2020-02-08T07:42:04Z", "commit": {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzo0MjowNFrOFnPnsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzo0MjowNFrOFnPnsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDcwNA==", "bodyText": "Sorry for asking for so many changes but we would be better off not manipulating the string since it can be buggy.\nWe can add a markdown library to render later in a separate PR.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#discussion_r376694704", "createdAt": "2020-02-08T07:42:04Z", "author": {"login": "yausername"}, "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -919,28 +917,43 @@ private VideoStream getSelectedVideoStream() {\n         return sortedVideoStreams != null ? sortedVideoStreams.get(selectedVideoStreamIndex) : null;\n     }\n \n-    private void prepareDescription(final String descriptionHtml) {\n-        if (TextUtils.isEmpty(descriptionHtml)) {\n+    private void prepareDescription(Description description) {\n+        if (TextUtils.isEmpty(description.getContent()) || description == Description.emptyDescription) {\n             return;\n         }\n \n-        disposables.add(Single.just(descriptionHtml)\n-                .map((@io.reactivex.annotations.NonNull String description) -> {\n-                    Spanned parsedDescription;\n-                    if (Build.VERSION.SDK_INT >= 24) {\n-                        parsedDescription = Html.fromHtml(description, 0);\n-                    } else {\n-                        //noinspection deprecation\n-                        parsedDescription = Html.fromHtml(description);\n-                    }\n-                    return parsedDescription;\n-                })\n-                .subscribeOn(Schedulers.computation())\n-                .observeOn(AndroidSchedulers.mainThread())\n-                .subscribe((@io.reactivex.annotations.NonNull Spanned spanned) -> {\n-                    videoDescriptionView.setText(spanned);\n-                    videoDescriptionView.setVisibility(View.VISIBLE);\n-                }));\n+        if (description.getType() != Description.HTML) {\n+            videoDescriptionView.setAutoLinkMask(Linkify.WEB_URLS);\n+        }\n+\n+        if (description.getType() == Description.HTML) {\n+            disposables.add(Single.just(description.getContent())\n+                    .map((@io.reactivex.annotations.NonNull String descriptionText) -> {\n+                        Spanned parsedDescription;\n+                        if (Build.VERSION.SDK_INT >= 24) {\n+                            parsedDescription = Html.fromHtml(descriptionText, 0);\n+                        } else {\n+                            //noinspection deprecation\n+                            parsedDescription = Html.fromHtml(descriptionText);\n+                        }\n+                        return parsedDescription;\n+                    })\n+                    .subscribeOn(Schedulers.computation())\n+                    .observeOn(AndroidSchedulers.mainThread())\n+                    .subscribe((@io.reactivex.annotations.NonNull Spanned spanned) -> {\n+                        videoDescriptionView.setText(spanned);\n+                        videoDescriptionView.setVisibility(View.VISIBLE);\n+                    }));\n+        } else if (description.getType() == Description.MARKDOWN) {\n+            //in the future we would use a library or a good method to show markdown.\n+            //rn, we just remove **bold**, and let PLAIN_TEXT otherwise\n+            videoDescriptionView.setText(description.getContent().replace(\"**\", \"\"), TextView.BufferType.SPANNABLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "badaff8ebcd6f446a6a4b575adba43d627b4c7c2"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d62fa401d63551785859b0d909f8414e94ba191", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/2d62fa401d63551785859b0d909f8414e94ba191", "committedDate": "2020-02-08T09:48:36Z", "message": "real markdown support for descriptions\n\nand update third-party licences in about page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c68315f64a879522497e694f98fd69786f785c", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/88c68315f64a879522497e694f98fd69786f785c", "committedDate": "2020-02-08T09:54:05Z", "message": "Merge branch 'dev' into tubepeer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTQxMTU4", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#pullrequestreview-355541158", "createdAt": "2020-02-08T10:19:35Z", "commit": {"oid": "88c68315f64a879522497e694f98fd69786f785c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f3d1bfccf9be4182bd2872358263d3c904e447a", "author": {"user": {"login": "B0pol", "name": "bopol"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/3f3d1bfccf9be4182bd2872358263d3c904e447a", "committedDate": "2020-02-08T23:00:14Z", "message": "update extractor version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTczODg0", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3044#pullrequestreview-355573884", "createdAt": "2020-02-08T23:11:36Z", "commit": {"oid": "3f3d1bfccf9be4182bd2872358263d3c904e447a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4018, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}