{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NjE0Mzk2", "number": 5274, "title": "Add stream segments to player controls", "bodyText": "What is it?\n\n Bugfix (user facing)\n Feature (user facing)\n Codebase improvement (dev facing)\n Meta improvement to the project (dev facing)\n\nDescription of the changes in your PR\n\nThis PR adds stream segments for the YouTube service to player controls. The feature provides the following behaviors:\n\nHighlights the current segment depending on the current position of the video (see Preview) / by click\nScrolls automatically to the current playing segment when the list is opened\nSegments list is visible and the video is changed: if the new video has also segments then the new segments are loaded and it scrolls to the correct position, otherwise the list closes.\n\nCode changes:\n\nAdds a new button near to the top controls bar\nUses same layout elements like the play queue => they've been renamed to more generic id/field names, for example queueLayout to itemsListLayout\n\nFixes the following issue(s)\n\n\ncloses #5098\n\nAPK testing\nCheck the build artifact page for the debug apk.\nPreview\nDemo (dynamically changing at 0:22) : https://streamable.com/e/0v66wn\nDue diligence\n\n I read the contribution guidelines.", "createdAt": "2020-12-25T17:08:13Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274", "merged": true, "mergeCommit": {"oid": "98ed80d305faddcd74b37e1e98b41b456062867b"}, "closed": true, "closedAt": "2021-01-15T09:59:35Z", "author": {"login": "vkay94"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpscXQABqjQxNDkxNzYwNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdwLOoMAFqTU2ODY0MTY5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adf3947dc0af2e5348ba638624f8e0c583e37538", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/adf3947dc0af2e5348ba638624f8e0c583e37538", "committedDate": "2020-12-25T16:11:10Z", "message": "Add stream segments to VideoPlayerImpl"}, "afterCommit": {"oid": "91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "committedDate": "2020-12-25T18:14:39Z", "message": "Add stream segments to VideoPlayerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "committedDate": "2020-12-25T18:14:39Z", "message": "Add stream segments to VideoPlayerImpl"}, "afterCommit": {"oid": "5b2452ba001613fc64ab65dbe5f13652e2a275c9", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/5b2452ba001613fc64ab65dbe5f13652e2a275c9", "committedDate": "2020-12-26T13:04:40Z", "message": "Add stream segments to VideoPlayerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b2452ba001613fc64ab65dbe5f13652e2a275c9", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/5b2452ba001613fc64ab65dbe5f13652e2a275c9", "committedDate": "2020-12-26T13:04:40Z", "message": "Add stream segments to VideoPlayerImpl"}, "afterCommit": {"oid": "5784568d61bfaa1f19725353465ef90247243878", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/5784568d61bfaa1f19725353465ef90247243878", "committedDate": "2020-12-26T17:31:31Z", "message": "Add stream segments to VideoPlayerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5784568d61bfaa1f19725353465ef90247243878", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/5784568d61bfaa1f19725353465ef90247243878", "committedDate": "2020-12-26T17:31:31Z", "message": "Add stream segments to VideoPlayerImpl"}, "afterCommit": {"oid": "f3c7412b375178215daccc7adf62303b01eeacb3", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/f3c7412b375178215daccc7adf62303b01eeacb3", "committedDate": "2020-12-27T15:50:18Z", "message": "Add stream segments to VideoPlayerImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3c7412b375178215daccc7adf62303b01eeacb3", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/f3c7412b375178215daccc7adf62303b01eeacb3", "committedDate": "2020-12-27T15:50:18Z", "message": "Add stream segments to VideoPlayerImpl"}, "afterCommit": {"oid": "9a901619a8250d62ee9af0a4cca72744de808ebc", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/9a901619a8250d62ee9af0a4cca72744de808ebc", "committedDate": "2021-01-12T14:54:20Z", "message": "Add stream segments to player"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NTQ2NjI1", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#pullrequestreview-566546625", "createdAt": "2021-01-12T18:18:47Z", "commit": {"oid": "9a901619a8250d62ee9af0a4cca72744de808ebc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a901619a8250d62ee9af0a4cca72744de808ebc", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/9a901619a8250d62ee9af0a4cca72744de808ebc", "committedDate": "2021-01-12T14:54:20Z", "message": "Add stream segments to player"}, "afterCommit": {"oid": "cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "committedDate": "2021-01-12T21:59:52Z", "message": "Add stream segments to player"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "committedDate": "2021-01-12T21:59:52Z", "message": "Add stream segments to player"}, "afterCommit": {"oid": "dbba577f7f97e06b862df03d1d95b87518cf650a", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/dbba577f7f97e06b862df03d1d95b87518cf650a", "committedDate": "2021-01-14T15:28:27Z", "message": "Add stream segments to player"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbba577f7f97e06b862df03d1d95b87518cf650a", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/dbba577f7f97e06b862df03d1d95b87518cf650a", "committedDate": "2021-01-14T15:28:27Z", "message": "Add stream segments to player"}, "afterCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/880daad3fe0e49858dc1e876f0bceb7535b33013", "committedDate": "2021-01-14T16:52:00Z", "message": "Add stream segments to player"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4NDY0NzA1", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#pullrequestreview-568464705", "createdAt": "2021-01-14T17:31:17Z", "commit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzozMToxN1rOITvVDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNzo0ODoxM1rOITv-GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU2OTI5Mg==", "bodyText": "Remove this, I left it here accidentally", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557569292", "createdAt": "2021-01-14T17:31:17Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2837,39 +2851,89 @@ private void onQueueClicked() {\n         buildQueue();\n         //updatePlaybackButtons();//TODO verify this can be removed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3MTc4Nw==", "bodyText": "Change\n    /*//////////////////////////////////////////////////////////////////////////\n    // Play queue and streams\n    //////////////////////////////////////////////////////////////////////////*/\n\ninto\n    /*//////////////////////////////////////////////////////////////////////////\n    // Play queue, segments and streams\n    //////////////////////////////////////////////////////////////////////////*/\n\nabove here", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557571787", "createdAt": "2021-01-14T17:35:30Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2837,39 +2851,89 @@ private void onQueueClicked() {\n         buildQueue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NDExNQ==", "bodyText": "Just to make sure: is it possible that the first segment does not start at 0:00? In that case the result of this function would be wrong when the progress is 0:00, since the first segment has yet to start. Maybe no item should be selected in the adapter in that case?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557574115", "createdAt": "2021-01-14T17:39:13Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2882,12 +2946,33 @@ public void onScrolledDown(final RecyclerView recyclerView) {\n                 if (playQueue != null && !playQueue.isComplete()) {\n                     playQueue.fetch();\n                 } else if (binding != null) {\n-                    binding.playQueue.clearOnScrollListeners();\n+                    binding.itemsList.clearOnScrollListeners();\n                 }\n             }\n         };\n     }\n \n+    private StreamSegmentAdapter.StreamSegmentListener getStreamSegmentListener() {\n+        return (item, seconds) -> {\n+            segmentAdapter.selectSegment(item);\n+            seekTo(seconds * 1000);\n+            triggerProgressUpdate();\n+        };\n+    }\n+\n+    private int getNearestStreamSegmentPosition(final long playbackPosition) {\n+        int nearestPosition = 0;\n+        final List<StreamSegment> segments = currentMetadata.getMetadata().getStreamSegments();\n+\n+        for (int i = 0; i < segments.size(); i++) {\n+            if (segments.get(i).getStartTimeSeconds() * 1000 > playbackPosition) {\n+                break;\n+            }\n+            nearestPosition++;\n+        }\n+        return Math.max(0, nearestPosition - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NjE0OQ==", "bodyText": "Maybe wrap everything in a if (areSegmentsVisible), to make it clearer:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (currentMetadata != null && areSegmentsVisible\n          \n          \n            \n                            && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n          \n          \n            \n                        final int adapterPosition = getNearestStreamSegmentPosition(\n          \n          \n            \n                                simpleExoPlayer.getCurrentPosition());\n          \n          \n            \n                        segmentAdapter.selectSegmentAt(adapterPosition);\n          \n          \n            \n                        binding.itemsList.scrollToPosition(adapterPosition);\n          \n          \n            \n                    } else if (areSegmentsVisible) {\n          \n          \n            \n                        closeItemsList();\n          \n          \n            \n                    }\n          \n          \n            \n                    if (areSegmentsVisible) {\n          \n          \n            \n                        if (currentMetadata != null\n          \n          \n            \n                                && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n          \n          \n            \n                            final int adapterPosition = getNearestStreamSegmentPosition(\n          \n          \n            \n                                    simpleExoPlayer.getCurrentPosition());\n          \n          \n            \n                            segmentAdapter.selectSegmentAt(adapterPosition);\n          \n          \n            \n                            binding.itemsList.scrollToPosition(adapterPosition);\n          \n          \n            \n                        } else {\n          \n          \n            \n                            closeItemsList();\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557576149", "createdAt": "2021-01-14T17:42:25Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -3736,6 +3824,15 @@ private void notifyMetadataUpdateToListeners() {\n         if (activityListener != null && currentMetadata != null) {\n             activityListener.onMetadataUpdate(currentMetadata.getMetadata(), playQueue);\n         }\n+        if (currentMetadata != null && areSegmentsVisible\n+                && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n+            final int adapterPosition = getNearestStreamSegmentPosition(\n+                    simpleExoPlayer.getCurrentPosition());\n+            segmentAdapter.selectSegmentAt(adapterPosition);\n+            binding.itemsList.scrollToPosition(adapterPosition);\n+        } else if (areSegmentsVisible) {\n+            closeItemsList();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 346}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3Njg1NQ==", "bodyText": "This is not a listener, so I don't think this piece of code should be here, but maybe I'm wrong", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557576855", "createdAt": "2021-01-14T17:43:31Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -3758,6 +3855,9 @@ private void notifyProgressUpdateToListeners(final int currentProgress,\n         if (activityListener != null) {\n             activityListener.onProgressUpdate(currentProgress, duration, bufferPercent);\n         }\n+        if (areSegmentsVisible) {\n+            segmentAdapter.selectSegmentAt(getNearestStreamSegmentPosition(currentProgress));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 356}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3OTgwMQ==", "bodyText": "This can probably be moved somewhere else, like in LocalizationUtils (or whatever that file is called). And a localized & standard timestamp should probably be generated by building a LocalDateTime and then formatting it using one of the default option. I'm not completely sure about this though, @B0pol do you have any opinion?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557579801", "createdAt": "2021-01-14T17:48:13Z", "author": {"login": "Stypox"}, "path": "app/src/main/java/org/schabi/newpipe/info_list/StreamSegmentItem.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+package org.schabi.newpipe.info_list\n+\n+import android.widget.ImageView\n+import android.widget.TextView\n+import com.nostra13.universalimageloader.core.ImageLoader\n+import com.xwray.groupie.GroupieViewHolder\n+import com.xwray.groupie.Item\n+import org.schabi.newpipe.R\n+import org.schabi.newpipe.extractor.stream.StreamSegment\n+import org.schabi.newpipe.util.ImageDisplayConstants\n+import java.util.concurrent.TimeUnit\n+\n+class StreamSegmentItem(\n+    private val item: StreamSegment,\n+    private val onClick: StreamSegmentAdapter.StreamSegmentListener\n+) : Item<GroupieViewHolder>() {\n+\n+    companion object {\n+        const val PAYLOAD_SELECT = 1\n+    }\n+\n+    var isSelected = false\n+\n+    override fun bind(viewHolder: GroupieViewHolder, position: Int) {\n+        item.previewUrl?.let {\n+            ImageLoader.getInstance().displayImage(\n+                it, viewHolder.root.findViewById<ImageView>(R.id.previewImage),\n+                ImageDisplayConstants.DISPLAY_THUMBNAIL_OPTIONS\n+            )\n+        }\n+        viewHolder.root.findViewById<TextView>(R.id.textViewTitle).text = item.title\n+        viewHolder.root.findViewById<TextView>(R.id.textViewStartSeconds).text =\n+            secondsToString(item.startTimeSeconds.toLong())\n+        viewHolder.root.setOnClickListener { onClick.onItemClick(this, item.startTimeSeconds) }\n+        viewHolder.root.isSelected = isSelected\n+    }\n+\n+    override fun bind(viewHolder: GroupieViewHolder, position: Int, payloads: MutableList<Any>) {\n+        if (payloads.contains(PAYLOAD_SELECT)) {\n+            viewHolder.root.isSelected = isSelected\n+            return\n+        }\n+        super.bind(viewHolder, position, payloads)\n+    }\n+\n+    private fun secondsToString(seconds: Long): String {\n+        val hours = TimeUnit.SECONDS.toHours(seconds)\n+        val minutes = TimeUnit.SECONDS.toMinutes(seconds)\n+            .minus(TimeUnit.HOURS.toMinutes(hours))\n+        val sec = seconds\n+            .minus(TimeUnit.HOURS.toSeconds(hours))\n+            .minus(TimeUnit.MINUTES.toSeconds(minutes))\n+\n+        return if (hours == 0L) String.format(\"%02d:%02d\", minutes, sec)\n+        else String.format(\"%d:%02d:%02d\", hours, minutes, sec)\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "committedDate": "2021-01-14T20:58:19Z", "message": "Add stream segments to player"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/880daad3fe0e49858dc1e876f0bceb7535b33013", "committedDate": "2021-01-14T16:52:00Z", "message": "Add stream segments to player"}, "afterCommit": {"oid": "37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "author": {"user": {"login": "vkay94", "name": "Viktor K"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "committedDate": "2021-01-14T20:58:19Z", "message": "Add stream segments to player"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4NjQxNjk0", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#pullrequestreview-568641694", "createdAt": "2021-01-14T21:30:32Z", "commit": {"oid": "37aa41afaed3a3f7698fa894e6a5f6cfb12088e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4059, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}