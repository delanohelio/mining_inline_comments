{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTIzNjk1", "number": 4288, "title": "Performance increase", "bodyText": "What is it?\n\n Feature (user facing)\n Code base improvement (dev facing)\n Meta improvement to the project (dev facing)\n\nDescription of the changes in your PR\nThis PR for devs and for users.\nFor devs:\nI made optimizations for managing the player service. Now the player service is bound to static class and there is static listener for all events from the player service. VideoDetailFragment can subscribe/unsubscribe from events dynamically without the need to bind/unbind to the service. Fragment only need to subscribe/unsubscribe to/from events via static PlayerHolder. It gives possibility to skip binding process on configuration change and to speed up orientation change.\nAlso I discovered that prepareAndHandleInfo is terribly slow, something around 1 second on slow device. Whenever currently playing item in playlist changes this method is called and freezes main thread for a long time. Ideal choice would be to rewrite some methods that populates view groups but it's hard to do and time consuming task. Instead I call this method (prepareAndHandleInfo) after timeout which makes main thread free for some time which allows to start playback on next/prev item in playlists fast.\nAlso I found that SerializedCache clones every item in it which takes some time (100-200 ms). So I removed that part from fragment and saving playQueue, streamInfo and stack inside static variables.\nFor users:\nFaster loading time of streams, faster orientation change.\nAlso when you have horizontal + vertical + horizontal videos in queue this is what happens:\n\n\nIn locked global orientation (portrait):\n\nin non-fullscreen mode you play all videos tapping on next arrow button and orientation will be the same\nin fullscreen mode you play tapping on next arrow button from landscape video to vertical will change orientation to portrait, then after vertical video will change to landscape again for landscape video.\n\n\n\nIn locked global orientation (landscape):\n\nevery video will be in landscape\n\n\n\nIn unlocked global orientation:\n\nvideo will be in the same orientation you have your device rotated\nif orientation is portrait and the video is vertical you will be able to play it in fullscreen (fullscreen button appears).\nif orientation is landscape and you are watching landscape video it will be in fullscreen without an ability to make it non-fulscreen (you're able to rotate your device to portrait and the video will be in non-fullscreen mode)\n\n\n\nIf you read correctly you noticed that the player will rotate the video from landscape to portrait and back if you selecting vertical video after/before landscape with locked global orientation. It's useful thing but with a cost. And the cost is wrong size of the video for about 0.1-1 second based on performance of the device. This happens because the app still doing many things in main thread. Mostly because of notifications. Yes, they are terrible slow and nothing we can do in this area except to wait until this PR #3178 will be merged. I hope it fixes the notifications' performance but if not the delay is still acceptable. But even if the notifications will be fast, it doesn't help to reduce the delay to 0 because when orientation changes from one to another there is a delay related to reconstruction of the whole fragment. I made this process faster but the delay is still visible on slow devices.\nHere we have two APKs: the first one is what this PR gives. The second one shows what it means to have all notifications disabled. So I just tested with disabled notifications and the app is soooooo fast when orientation changes and between videos in queue. Of course, we still need the notifications but it's just for educational purposes:)\nRelies on the following changes\nBased on #4272\nTesting apk\nThis PR:\nperformance.zip\nThis PR + disabled notifications (just for experiment)\nperformance-without-notifications.zip\nAgreement\n\n I carefully read the contribution guidelines and agree to them.\n\nThis PR starts at 5b8eda4", "createdAt": "2020-09-17T20:47:29Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288", "merged": true, "mergeCommit": {"oid": "160a04c3c71beb471316f8cd32423c69f48c16b1"}, "closed": true, "closedAt": "2020-09-28T17:45:26Z", "author": {"login": "avently"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ3N9ngH2gAyNDg4OTIzNjk1OjViOGVkYTQ4MDUzZGRmYzJmNzMyY2Q3ZTBlNzkzZTdmNjM2ZWE1M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNVmVsAFqTQ5NzY2NTUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b8eda48053ddfc2f732cd7e0e793e7f636ea53b", "author": {"user": {"login": "avently", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/5b8eda48053ddfc2f732cd7e0e793e7f636ea53b", "committedDate": "2020-09-17T20:42:35Z", "message": "Increased performance of the UI. main thread is not as busy as before"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51", "author": {"user": {"login": "avently", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/c843e77183ffeed80db442ecd53376a6a3d8fa51", "committedDate": "2020-09-23T12:20:25Z", "message": "Made notification thumbnail smaller"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDgzMzgw", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#pullrequestreview-497083380", "createdAt": "2020-09-27T13:56:32Z", "commit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMzo1NjozMlrOHYnjHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxMzo1NjozMlrOHYnjHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTgzNw==", "bodyText": "Is this change needed with the MedidaStyle notifications?", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#discussion_r495575837", "createdAt": "2020-09-27T13:56:32Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/player/BasePlayer.java", "diffHunk": "@@ -497,12 +497,19 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n+        final float width = Math.min(\n+                context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n+                loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n+                (int) width,\n+                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n-                    + \"loadedImage = [\" + loadedImage + \"]\");\n+                    + \"loadedImage = [\" + loadedImage + \"], \"\n+                    + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n+            + \", scaled width = \" + width);\n         }\n-        currentThumbnail = loadedImage;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c843e77183ffeed80db442ecd53376a6a3d8fa51"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0370fa6c007ebc2b2f2e02266598179f65ecfece", "author": {"user": {"login": "avently", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/0370fa6c007ebc2b2f2e02266598179f65ecfece", "committedDate": "2020-09-27T15:02:31Z", "message": "Merged 'dev' branch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDQxNTEy", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#pullrequestreview-497441512", "createdAt": "2020-09-28T12:01:11Z", "commit": {"oid": "0370fa6c007ebc2b2f2e02266598179f65ecfece"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjY1NTMw", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4288#pullrequestreview-497665530", "createdAt": "2020-09-28T15:48:08Z", "commit": {"oid": "0370fa6c007ebc2b2f2e02266598179f65ecfece"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4118, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}