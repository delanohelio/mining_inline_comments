{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NzIyMTc5", "number": 3035, "title": "Fix ReCaptcha activity and correctly save obtained cookies", "bodyText": "[ x] I carefully read the contribution guidelines and agree to them.\n\nDescription\nThis pr aims to solve the many issues regarding the ReCaptchaActivity. In #2527 I tried to fix it, though I was unable to test the changes since I couldn't reproduce any ReCAPTCHAs anymore, so it kept crashing. After @B0pol in #2979 provided a way to reproduce, I was able to redesign the activity. Before the cookies were extracted from the page on close, but unfortunately this didn't imply that the captha was solved, since there could have been redirections or the page didn't close on resolution. Now the user is provided with a \"Done\" button to press when he finishes solving the captcha, that sets the cookies to the downloader.\nSometimes services return a recaptcha challenge error code (429) just to indicate Too Many Requests, so in that case the ReCaptchaActivity is opened, but the only thing the user has to do is press \"Done\" since there are no recaptchas to solve. This is the only scenario I was able to test, and I am confident the Youtube cookie extraction method works since I didn't change it, (it didn't work, but it should be fixed now) though I am not entirely sure that the handleCookies function is always called (someone who knows how WebViewClients work?). (now it is always called on close).\nAlso renamed some recaptcha-related strings to have them match the naming conventions, leading to many changed strings.xml files.\nFollow-ups for next pull requests\nMaybe we should keep a hash-table with all cookies and their values and update that table every time we need, instead of overwriting the whole cookie string every time. Since, for now, the only service with recaptchas is YouTube, there is no problem to always overwrite the old Downloader cookies, but for the future we might need to change this.\nAnyway in the handleCookies function I left the space for other services (other than Youtube) to try and extract cookies.\nFixes & debug apk\nFixes #3023 fixes #2979 fixes #2924 fixes #2788 fixes #2484\nDebug apk: app-debug.zip", "createdAt": "2020-01-29T19:17:53Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035", "merged": true, "mergeCommit": {"oid": "471ce4a24bb9ebb55d24b3fc81863c016cb0fea7"}, "closed": true, "closedAt": "2020-02-02T21:16:22Z", "author": {"login": "Stypox"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_Lpy_AFqTM1MDM5MDExNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAfB10gFqTM1MTk2NzkyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzkwMTE1", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#pullrequestreview-350390115", "createdAt": "2020-01-29T20:06:45Z", "commit": {"oid": "702e41b1650236a3912536b2734241a758d70c57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDowNjo0NVrOFjV73A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDowNjo0NVrOFjV73A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwMzg2OA==", "bodyText": "It might be good to check the service id first. Just in case we get a reCAPTCHA from a different service.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r372603868", "createdAt": "2020-01-29T20:06:45Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -89,74 +91,89 @@ protected void onCreate(Bundle savedInstanceState) {\n         myWebView.loadUrl(url);\n     }\n \n-    private class ReCaptchaWebViewClient extends WebViewClient {\n-        private final Activity context;\n-        private String mCookies;\n+    @Override\n+    public boolean onCreateOptionsMenu(Menu menu) {\n+        boolean ret = super.onCreateOptionsMenu(menu);\n \n-        ReCaptchaWebViewClient(Activity ctx) {\n-            context = ctx;\n+        ActionBar actionBar = getSupportActionBar();\n+        if (actionBar != null) {\n+            actionBar.setDisplayHomeAsUpEnabled(true);\n+            actionBar.setHomeAsUpIndicator(getResources().getDrawable(R.drawable.ic_done_white_24dp));\n+            actionBar.setTitle(R.string.title_activity_recaptcha);\n+            actionBar.setSubtitle(R.string.subtitle_activity_recaptcha);\n         }\n \n-        @Override\n-        public void onPageStarted(WebView view, String url, Bitmap favicon) {\n-            // TODO: Start Loader\n-            super.onPageStarted(view, url, favicon);\n+        return ret;\n+    }\n+\n+    @Override\n+    public void onBackPressed() {\n+        saveCookiesAndFinish();\n+    }\n+\n+    @Override\n+    public boolean onOptionsItemSelected(MenuItem item) {\n+        int id = item.getItemId();\n+        switch (id) {\n+            case android.R.id.home:\n+                saveCookiesAndFinish();\n+                return true;\n+            default:\n+                return false;\n         }\n+    }\n \n-        @Override\n-        public void onPageFinished(WebView view, String url) {\n-            String cookies = CookieManager.getInstance().getCookie(url);\n+    private void saveCookiesAndFinish() {\n+        if (!foundCookies.isEmpty()) {\n+            // Give cookies to Downloader class\n+            DownloaderImpl.getInstance().setCookies(foundCookies);\n+            setResult(RESULT_OK);\n+        }\n \n-            // TODO: Stop Loader\n+        Intent intent = new Intent(this, org.schabi.newpipe.MainActivity.class);\n+        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n+        NavUtils.navigateUpTo(this, intent);\n+    }\n \n-            // find cookies : s_gl & goojf and Add cookies to Downloader\n-            if (find_access_cookies(cookies)) {\n-                // Give cookies to Downloader class\n-                DownloaderImpl.getInstance().setCookies(mCookies);\n \n-                // Closing activity and return to parent\n-                setResult(RESULT_OK);\n-                finish();\n-            }\n-        }\n \n-        private boolean find_access_cookies(String cookies) {\n-            boolean ret = false;\n-            String c_s_gl = \"\";\n-            String c_goojf = \"\";\n-\n-            String[] parts = cookies.split(\"; \");\n-            for (String part : parts) {\n-                if (part.trim().startsWith(\"s_gl\")) {\n-                    c_s_gl = part.trim();\n-                }\n-                if (part.trim().startsWith(\"goojf\")) {\n-                    c_goojf = part.trim();\n-                }\n+    private void handleCookies(@Nullable String cookies) {\n+        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: cookies=\" + (cookies == null ? \"null\" : cookies));\n+        if (cookies == null) return;\n+\n+        addYoutubeCookies(cookies);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "702e41b1650236a3912536b2734241a758d70c57"}, "originalPosition": 171}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTMxOTIy", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#pullrequestreview-351131922", "createdAt": "2020-01-30T20:50:04Z", "commit": {"oid": "54098b925f7e258f62544ee3092e4712e79bf9fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDo1MDowNFrOFj5eiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDo1MDowNFrOFj5eiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NjE4NA==", "bodyText": "I was not able to get a reCAPTCHA while visiting peertube.co.uk, so I could not test your PR. However from what I can say when reading the code, it looks like there is no theme handling in the toolbar. Please ensure to have the correct button color when using the light theme.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373186184", "createdAt": "2020-01-30T20:50:04Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -89,74 +90,89 @@ protected void onCreate(Bundle savedInstanceState) {\n         myWebView.loadUrl(url);\n     }\n \n-    private class ReCaptchaWebViewClient extends WebViewClient {\n-        private final Activity context;\n-        private String mCookies;\n+    @Override\n+    public boolean onCreateOptionsMenu(Menu menu) {\n+        boolean ret = super.onCreateOptionsMenu(menu);\n+\n+        ActionBar actionBar = getSupportActionBar();\n+        if (actionBar != null) {\n+            actionBar.setDisplayHomeAsUpEnabled(true);\n+            actionBar.setHomeAsUpIndicator(getResources().getDrawable(R.drawable.ic_done_white_24dp));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54098b925f7e258f62544ee3092e4712e79bf9fb"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODk0MzI4", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#pullrequestreview-351894328", "createdAt": "2020-02-01T17:19:39Z", "commit": {"oid": "c3c84dff643fe736e0729b65ff897df4d7d8d495"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxNzoxOTozOVrOFkeY7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxNzoxOTozOVrOFkeY7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDk1Ng==", "bodyText": "I guess this was accidentally committed.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373790956", "createdAt": "2020-02-01T17:19:39Z", "author": {"login": "TobiGr"}, "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -138,8 +140,10 @@ private void saveCookiesAndFinish() {\n \n \n \n-    private void handleCookies(@Nullable String cookies) {\n-        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: cookies=\" + (cookies == null ? \"null\" : cookies));\n+    private void handleCookies(String url) {\n+        String cookies = CookieManager.getInstance().getCookie(url);\n+        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: url=\" + url + \"; cookies=\" + (cookies == null ? \"null\" : cookies));\n+        Log.e(TAG, \"handleCookies: url=\" + url + \"; cookies=\" + (cookies == null ? \"null\" : cookies));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3c84dff643fe736e0729b65ff897df4d7d8d495"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0519d8313505b5b074e17906edadacfb276484a", "author": {"user": {"login": "mqus", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/c0519d8313505b5b074e17906edadacfb276484a", "committedDate": "2020-02-01T17:24:16Z", "message": "fixes #3021, see also https://github.com/TeamNewPipe/NewPipe-legacy/pull/21"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61d102dc75a1a1470adab17edcf5d251c67e2549", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/61d102dc75a1a1470adab17edcf5d251c67e2549", "committedDate": "2020-02-01T17:24:16Z", "message": "Change recaptcha string names to match style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d8848825d52226479f7d14d5ddbb7c0d3bf605", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/a3d8848825d52226479f7d14d5ddbb7c0d3bf605", "committedDate": "2020-02-01T17:24:16Z", "message": "Add \"Done\" drawable (only white since it is used on toolbar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daa4fd510320f2ee8a898a38b3851d6408e50a93", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/daa4fd510320f2ee8a898a38b3851d6408e50a93", "committedDate": "2020-02-01T17:24:16Z", "message": "Fix ReCaptchaActivity crash and save cookies correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1638f86e75d546154b28714fd1bd2f9a426e9a", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/4e1638f86e75d546154b28714fd1bd2f9a426e9a", "committedDate": "2020-02-01T17:24:16Z", "message": "Remove space between \"Done\" button and ReCaptchaActivity title"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe138f6d611d4a182db9ddec902f1d4c471752b1", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/fe138f6d611d4a182db9ddec902f1d4c471752b1", "committedDate": "2020-02-01T17:24:16Z", "message": "Improve formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc890a1d1384266916a9382309fcaa3cdbb0115", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/0cc890a1d1384266916a9382309fcaa3cdbb0115", "committedDate": "2020-02-01T17:24:16Z", "message": "Move \"Done\" button and make it theme conpliant in ReCaptcha"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b09028440b2b12b9dfdac786d6489bdbbff131c", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/9b09028440b2b12b9dfdac786d6489bdbbff131c", "committedDate": "2020-02-01T17:24:16Z", "message": "Try to extract cookies just before closing recaptcha activity\n\nEven if the page didn't auto-close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf55c21392090855f2c5e0363e221f92f2827ec", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/1bf55c21392090855f2c5e0363e221f92f2827ec", "committedDate": "2020-02-01T17:24:16Z", "message": "Remove left-behind Log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a6303d64fd124a5a1f879b83808c9a162afb558", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/1a6303d64fd124a5a1f879b83808c9a162afb558", "committedDate": "2020-02-01T17:23:57Z", "message": "Remove left-behind Log"}, "afterCommit": {"oid": "1bf55c21392090855f2c5e0363e221f92f2827ec", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/1bf55c21392090855f2c5e0363e221f92f2827ec", "committedDate": "2020-02-01T17:24:16Z", "message": "Remove left-behind Log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95d51b3075db8e95dadf33321df03c0701e62f3", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/f95d51b3075db8e95dadf33321df03c0701e62f3", "committedDate": "2020-02-01T17:27:00Z", "message": "Merge branch 'dev' of github.com:TeamNewPipe/NewPipe into recaptcha"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6da90961762b92a2d9cae90e4b5879fdf481ce5a", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/6da90961762b92a2d9cae90e4b5879fdf481ce5a", "committedDate": "2020-02-02T20:33:07Z", "message": "Fix addYoutubeCookies functions (Yt changed things lately)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3372bacc6291b4de9f470c7724645d1ac9665964", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/3372bacc6291b4de9f470c7724645d1ac9665964", "committedDate": "2020-02-02T20:36:15Z", "message": "Merge branch 'dev' into recaptcha"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6841158df60b066a0b53fe80f4a780d822c227a", "author": {"user": {"login": "Stypox", "name": "Stypox"}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/b6841158df60b066a0b53fe80f4a780d822c227a", "committedDate": "2020-02-02T20:48:45Z", "message": "Remove unused imports and clean up comment style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTY3OTI1", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#pullrequestreview-351967925", "createdAt": "2020-02-02T21:15:09Z", "commit": {"oid": "b6841158df60b066a0b53fe80f4a780d822c227a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4017, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}