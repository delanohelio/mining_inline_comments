{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjk5NTIx", "number": 4080, "title": "Reduced CPU usage when playing a video by 7-10%", "bodyText": "What is it?\n\n Bug fix (user facing)\n Feature (user facing)\n Code base improvement (dev facing)\n Meta improvement to the project (dev facing)\n\nDescription of the changes in your PR\n\nAfter reading this comment #3948 (comment)\n\nthis new unified player ... drains the bettery twice as much\n\nI checked how much CPU the player uses. And found out that @MD77MD said incorrect information but even if it's not true (about double difference) the new player definitely uses more CPU than 0.19.8. Difference is about 15%. So I started seaching for the cause and found that this line https://github.com/TeamNewPipe/NewPipe/blob/dev/app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java#L1774\nadds 7-10% of CPU load. Actually there is no need to animate the progress bar when it's hidden under the video but it should be updated anyway (without animation) to reflect playing position changes.\nNext. After this change the difference is still here but small: around 5%. Please, note, that I tested it on 5-year old phone while it had 1% of battery and worked on a charger with screen recorder impact so absolute values in your case would be less as well as difference.\nI couldn't find a cause until I realized that MainVideoPlayer (old video player in 0.19.8) doesn't use notification. So it doesn't need to update it twice every second. This was it! After commenting out everything after this line: https://github.com/TeamNewPipe/NewPipe/blob/dev/app/src/main/java/org/schabi/newpipe/player/VideoPlayerImpl.java#L640   the CPU usage was the same compared to 0.19.8 (0-1% difference).\nHere is a screenrecord of comparison (with commented code related to notification) of new and old apps:\nhttps://www.dropbox.com/s/l2sdo5rsjfmjusc/2020-08-05-12-01-09.mp4?dl=0\nOf course this shouldn't be commented out in the current codebase but it gives us information about why this little difference exists: it's needed to update notification.\nTesting apk\ntest-apk.zip\nAgreement\n\n I carefully read the contribution guidelines and agree to them.", "createdAt": "2020-08-05T10:40:01Z", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080", "merged": true, "mergeCommit": {"oid": "b7f50c3e124365b75fa28df5af64f94f32b10ab2"}, "closed": true, "closedAt": "2020-08-17T07:46:08Z", "author": {"login": "avently"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc74DxWgH2gAyNDYzMjk5NTIxOmQ3NTc0OTczZTk3ZmE3YTNhMjFhYTU5OTY3MzExZjYwOTE5NDE4MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_te-GAFqTQ2ODIzNjI2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7574973e97fa7a3a21aa59967311f6091941830", "author": {"user": {"login": "avently", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/d7574973e97fa7a3a21aa59967311f6091941830", "committedDate": "2020-08-05T09:46:25Z", "message": "Reduced CPU usage when playing a video by 7-10%"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTQ1OTY0", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080#pullrequestreview-461545964", "createdAt": "2020-08-05T10:45:22Z", "commit": {"oid": "d7574973e97fa7a3a21aa59967311f6091941830"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0NToyMlrOG8ENDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0NToyMlrOG8ENDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNjYyMA==", "bodyText": "I prefer line breaks at a logical place, i.e. start the next line at \"otherwise\". That's not really an issue though (so don't waste time changing it unless you happen to need to change something else in this PR as well). I'll take an actual look at the code later today (in like 2 hours).", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080#discussion_r465636620", "createdAt": "2020-08-05T10:45:22Z", "author": {"login": "wb9688"}, "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1771,8 +1770,17 @@ private void showPlaybackProgress(final long progress, final long duration) {\n         final int progressSeconds = (int) TimeUnit.MILLISECONDS.toSeconds(progress);\n         final int durationSeconds = (int) TimeUnit.MILLISECONDS.toSeconds(duration);\n         positionView.setMax(durationSeconds);\n-        positionView.setProgressAnimated(progressSeconds);\n-        detailPositionView.setText(Localization.getDurationString(progressSeconds));\n+        // If there is no player inside fragment use animation, otherwise don't because\n+        // it affects CPU", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7574973e97fa7a3a21aa59967311f6091941830"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODAzNjYw", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080#pullrequestreview-461803660", "createdAt": "2020-08-05T15:58:01Z", "commit": {"oid": "d7574973e97fa7a3a21aa59967311f6091941830"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo1ODowMVrOG8QJeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo1ODowMVrOG8QJeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgzMjMxMg==", "bodyText": "So I took a look, but I don't understand in what case there would be no player in the fragment. I also think we shouldn't update the progress in the player when the controls aren't being shown.", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080#discussion_r465832312", "createdAt": "2020-08-05T15:58:01Z", "author": {"login": "wb9688"}, "path": "app/src/main/java/org/schabi/newpipe/fragments/detail/VideoDetailFragment.java", "diffHunk": "@@ -1771,8 +1770,17 @@ private void showPlaybackProgress(final long progress, final long duration) {\n         final int progressSeconds = (int) TimeUnit.MILLISECONDS.toSeconds(progress);\n         final int durationSeconds = (int) TimeUnit.MILLISECONDS.toSeconds(duration);\n         positionView.setMax(durationSeconds);\n-        positionView.setProgressAnimated(progressSeconds);\n-        detailPositionView.setText(Localization.getDurationString(progressSeconds));\n+        // If there is no player inside fragment use animation, otherwise don't because", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7574973e97fa7a3a21aa59967311f6091941830"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aed1687a45749b73386e0e79d0452396960893d9", "author": {"user": {"login": "avently", "name": null}}, "url": "https://github.com/TeamNewPipe/NewPipe/commit/aed1687a45749b73386e0e79d0452396960893d9", "committedDate": "2020-08-16T19:44:27Z", "message": "Improved an animation logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjM2MjY0", "url": "https://github.com/TeamNewPipe/NewPipe/pull/4080#pullrequestreview-468236264", "createdAt": "2020-08-17T07:42:52Z", "commit": {"oid": "aed1687a45749b73386e0e79d0452396960893d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4107, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}