{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODQ1Nzg3", "number": 1448, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDowNToyOFrOEb_6qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDo1NjozOVrOEcA7qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Nzk0MjE5OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/LoadDetailImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDowNToyOFrOHGREfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzozNzo1OVrOHGYfUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzMzE4Mg==", "bodyText": "You could use TFloatArrayList instead. Or shouldn't we rather use a ArrayList of POJOs containing the four power values? That would allow a simple solution for variants with undefined LoadDetail, by using a null POJO.", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476333182", "createdAt": "2020-08-25T10:05:28Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/LoadDetailImpl.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.network.impl.extensions;\n+\n+import com.powsybl.iidm.network.Load;\n+import com.powsybl.iidm.network.extensions.LoadDetail;\n+import com.powsybl.iidm.network.impl.AbstractMultiVariantIdentifiableExtension;\n+import gnu.trove.list.array.TDoubleArrayList;\n+\n+/**\n+ * @author Miora Ralambotiana <miora.ralambotiana at rte-france.com>\n+ */\n+public class LoadDetailImpl extends AbstractMultiVariantIdentifiableExtension<Load> implements LoadDetail {\n+\n+    private final TDoubleArrayList fixedActivePower;\n+\n+    private final TDoubleArrayList fixedReactivePower;\n+\n+    private final TDoubleArrayList variableActivePower;\n+\n+    private final TDoubleArrayList variableReactivePower;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NDczNg==", "bodyText": "I used TFloatArrayList to be consistent with other similar equipments/implementations", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476454736", "createdAt": "2020-08-25T13:37:59Z", "author": {"login": "miovd"}, "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/LoadDetailImpl.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.network.impl.extensions;\n+\n+import com.powsybl.iidm.network.Load;\n+import com.powsybl.iidm.network.extensions.LoadDetail;\n+import com.powsybl.iidm.network.impl.AbstractMultiVariantIdentifiableExtension;\n+import gnu.trove.list.array.TDoubleArrayList;\n+\n+/**\n+ * @author Miora Ralambotiana <miora.ralambotiana at rte-france.com>\n+ */\n+public class LoadDetailImpl extends AbstractMultiVariantIdentifiableExtension<Load> implements LoadDetail {\n+\n+    private final TDoubleArrayList fixedActivePower;\n+\n+    private final TDoubleArrayList fixedReactivePower;\n+\n+    private final TDoubleArrayList variableActivePower;\n+\n+    private final TDoubleArrayList variableReactivePower;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzMzE4Mg=="}, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Nzk2OTI2OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/LoadDetailImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDoxMzo0NFrOHGRVyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDoxMzo0NFrOHGRVyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMzNzYwOA==", "bodyText": "Should it be a TODO? as something needs to be done here one day, doesn't it?", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476337608", "createdAt": "2020-08-25T10:13:44Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/LoadDetailImpl.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.iidm.network.impl.extensions;\n+\n+import com.powsybl.iidm.network.Load;\n+import com.powsybl.iidm.network.extensions.LoadDetail;\n+import com.powsybl.iidm.network.impl.AbstractMultiVariantIdentifiableExtension;\n+import gnu.trove.list.array.TDoubleArrayList;\n+\n+/**\n+ * @author Miora Ralambotiana <miora.ralambotiana at rte-france.com>\n+ */\n+public class LoadDetailImpl extends AbstractMultiVariantIdentifiableExtension<Load> implements LoadDetail {\n+\n+    private final TDoubleArrayList fixedActivePower;\n+\n+    private final TDoubleArrayList fixedReactivePower;\n+\n+    private final TDoubleArrayList variableActivePower;\n+\n+    private final TDoubleArrayList variableReactivePower;\n+\n+    public LoadDetailImpl(Load load, float fixedActivePower, float fixedReactivePower,\n+                          float variableActivePower, float variableReactivePower) {\n+        super(load);\n+        int variantArraySize = getVariantManagerHolder().getVariantManager().getVariantArraySize();\n+        this.fixedActivePower = new TDoubleArrayList(variantArraySize);\n+        this.fixedReactivePower = new TDoubleArrayList(variantArraySize);\n+        this.variableActivePower = new TDoubleArrayList(variantArraySize);\n+        this.variableReactivePower = new TDoubleArrayList(variantArraySize);\n+        for (int i = 0; i < variantArraySize; i++) {\n+            this.fixedActivePower.add(checkPower(fixedActivePower, \"Invalid fixedActivePower\"));\n+            this.fixedReactivePower.add(checkPower(fixedReactivePower, \"Invalid fixedReactivePower\"));\n+            this.variableActivePower.add(checkPower(variableActivePower, \"Invalid variableActivePower\"));\n+            this.variableReactivePower.add(checkPower(variableReactivePower, \"Invalid variableReactivePower\"));\n+        }\n+    }\n+\n+    public float getFixedActivePower() {\n+        return (float) fixedActivePower.get(getVariantIndex());\n+    }\n+\n+    @Override\n+    public LoadDetail setFixedActivePower(float fixedActivePower) {\n+        checkPower(fixedActivePower, \"Invalid fixedActivePower\");\n+        this.fixedActivePower.set(getVariantIndex(), fixedActivePower);\n+        return this;\n+    }\n+\n+    @Override\n+    public float getFixedReactivePower() {\n+        return (float) fixedReactivePower.get(getVariantIndex());\n+    }\n+\n+    @Override\n+    public LoadDetail setFixedReactivePower(float fixedReactivePower) {\n+        checkPower(fixedReactivePower, \"Invalid fixedReactivePower\");\n+        this.fixedReactivePower.set(getVariantIndex(), fixedReactivePower);\n+        return this;\n+    }\n+\n+    @Override\n+    public float getVariableActivePower() {\n+        return (float) variableActivePower.get(getVariantIndex());\n+    }\n+\n+    @Override\n+    public LoadDetail setVariableActivePower(float variableActivePower) {\n+        checkPower(variableActivePower, \"Invalid variableActivePower\");\n+        this.variableActivePower.set(getVariantIndex(), variableActivePower);\n+        return this;\n+    }\n+\n+    @Override\n+    public float getVariableReactivePower() {\n+        return (float) variableReactivePower.get(getVariantIndex());\n+    }\n+\n+    @Override\n+    public LoadDetail setVariableReactivePower(float variableReactivePower) {\n+        checkPower(variableReactivePower, \"Invalid variableReactivePower\");\n+        this.variableReactivePower.set(getVariantIndex(), variableReactivePower);\n+        return this;\n+    }\n+\n+    private static float checkPower(float power, String errorMessage) {\n+        if (Float.isNaN(power)) {\n+            throw new IllegalArgumentException(errorMessage);\n+        }\n+        return power;\n+    }\n+\n+    @Override\n+    public void extendVariantArraySize(int initVariantArraySize, int number, int sourceIndex) {\n+        fixedActivePower.ensureCapacity(fixedActivePower.size() + number);\n+        fixedReactivePower.ensureCapacity(fixedReactivePower.size() + number);\n+        variableActivePower.ensureCapacity(variableActivePower.size() + number);\n+        variableReactivePower.ensureCapacity(variableReactivePower.size() + number);\n+        for (int i = 0; i < number; ++i) {\n+            fixedActivePower.add(fixedActivePower.get(sourceIndex));\n+            fixedReactivePower.add(fixedReactivePower.get(sourceIndex));\n+            variableActivePower.add(variableActivePower.get(sourceIndex));\n+            variableReactivePower.add(variableReactivePower.get(sourceIndex));\n+        }\n+    }\n+\n+    @Override\n+    public void reduceVariantArraySize(int number) {\n+        fixedActivePower.remove(fixedActivePower.size() - number, number);\n+        fixedReactivePower.remove(fixedReactivePower.size() - number, number);\n+        variableActivePower.remove(variableActivePower.size() - number, number);\n+        variableReactivePower.remove(variableReactivePower.size() - number, number);\n+    }\n+\n+    @Override\n+    public void deleteVariantArrayElement(int index) {\n+        // Nothing to do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODEwMjgxOnYy", "diffSide": "RIGHT", "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDo1NDo1NFrOHGSnug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwOTo0ODowMVrOHHEk8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1ODU4Ng==", "bodyText": "Shouldn't the test be in package com.powsybl.iidm.network.impl.extensions of iidm-impl?", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476358586", "createdAt": "2020-08-25T10:54:54Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "diffHunk": "@@ -6,12 +6,18 @@\n  */\n package com.powsybl.iidm.network.extensions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NDI2MA==", "bodyText": "Not sure about it, because it isn't a test specific to the in-memory implementation (it should also work with a persistent for example) however I was not sure if its place was in iidm-tck so I left it here.", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476454260", "createdAt": "2020-08-25T13:37:19Z", "author": {"login": "miovd"}, "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "diffHunk": "@@ -6,12 +6,18 @@\n  */\n package com.powsybl.iidm.network.extensions;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1ODU4Ng=="}, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzE3NzA3Mg==", "bodyText": "Ah you're right, but then SlackTerminalTest should not be in iidm-impl either :/", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r477177072", "createdAt": "2020-08-26T09:48:01Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "diffHunk": "@@ -6,12 +6,18 @@\n  */\n package com.powsybl.iidm.network.extensions;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1ODU4Ng=="}, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3ODEwODU5OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDo1NjozOVrOHGSrPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDo1NjozOVrOHGSrPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1OTQ4NA==", "bodyText": "Could be replaced by Arrays.asList(variant1, variant3)", "url": "https://github.com/powsybl/powsybl-core/pull/1448#discussion_r476359484", "createdAt": "2020-08-25T10:56:39Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-extensions/src/test/java/com/powsybl/iidm/network/extensions/LoadDetailTest.java", "diffHunk": "@@ -73,4 +79,64 @@ public void test() {\n         assertEquals(40f, detail.getVariableActivePower(), 0f);\n         assertEquals(20f, detail.getVariableReactivePower(), 0f);\n     }\n+\n+    @Test\n+    public void variantsCloneTest() {\n+        String variant1 = \"variant1\";\n+        String variant2 = \"variant2\";\n+        String variant3 = \"variant3\";\n+\n+        // Creates the extension\n+        Network network = createTestNetwork();\n+        LoadDetail ld = network.getLoad(\"L\").getExtension(LoadDetail.class);\n+        assertNotNull(ld);\n+\n+        // Testing variant cloning\n+        VariantManager variantManager = network.getVariantManager();\n+        variantManager.cloneVariant(INITIAL_VARIANT_ID, variant1);\n+        variantManager.cloneVariant(variant1, variant2);\n+        variantManager.setWorkingVariant(variant1);\n+        assertEquals(40f, ld.getFixedActivePower(), 0f);\n+        assertEquals(20f, ld.getFixedReactivePower(), 0f);\n+        assertEquals(60f, ld.getVariableActivePower(), 0f);\n+        assertEquals(30f, ld.getVariableReactivePower(), 0f);\n+\n+        // Testing setting different values in the cloned variant and going back to the initial one\n+        ld.setFixedActivePower(60f).setFixedReactivePower(30f).setVariableActivePower(40f).setVariableReactivePower(20f);\n+        assertEquals(60f, ld.getFixedActivePower(), 0f);\n+        assertEquals(30f, ld.getFixedReactivePower(), 0f);\n+        assertEquals(40f, ld.getVariableActivePower(), 0f);\n+        assertEquals(20f, ld.getVariableReactivePower(), 0f);\n+        variantManager.setWorkingVariant(INITIAL_VARIANT_ID);\n+        assertEquals(40f, ld.getFixedActivePower(), 0f);\n+        assertEquals(20f, ld.getFixedReactivePower(), 0f);\n+        assertEquals(60f, ld.getVariableActivePower(), 0f);\n+        assertEquals(30f, ld.getVariableReactivePower(), 0f);\n+\n+        // Removes a variant then adds another variant to test variant recycling (hence calling allocateVariantArrayElement)\n+        variantManager.removeVariant(variant1);\n+        List<String> targetVariantIds = new ArrayList<>();\n+        targetVariantIds.add(variant1);\n+        targetVariantIds.add(variant3);\n+        variantManager.cloneVariant(INITIAL_VARIANT_ID, targetVariantIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328326e96949218d2368c961c07aae5bbb86d8cd"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 15, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}