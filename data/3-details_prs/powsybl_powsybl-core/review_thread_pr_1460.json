{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNTQwMjcx", "number": 1460, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjozNjoyOVrOEz3rmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1Njo1OFrOEz4L_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI1MTEzOnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjozNjoyOVrOHrXAfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODozMzoxNVrOHsQ8BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNzc3Mw==", "bodyText": "As nothing is public is that class, maybe this class should also be private package", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515227773", "createdAt": "2020-10-30T16:36:29Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseContext.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.psse.model;\n+\n+/**\n+ *\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n+ */\n+public class PsseContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NjkwMQ==", "bodyText": "Done", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516176901", "createdAt": "2020-11-02T18:33:15Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseContext.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/**\n+ * Copyright (c) 2020, RTE (http://www.rte-france.com)\n+ * This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+ */\n+package com.powsybl.psse.model;\n+\n+/**\n+ *\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n+ */\n+public class PsseContext {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNzc3Mw=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI2NDE2OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/test/java/com/powsybl/psse/model/PsseRawReaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0MDowOVrOHrXIvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODozMzoyOVrOHsQ8eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyOTg4NA==", "bodyText": "Why don't you use AssertArrayEquals?\nYou can probably also use Arrays.equals if you want to use your logging method", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515229884", "createdAt": "2020-10-30T16:40:09Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/test/java/com/powsybl/psse/model/PsseRawReaderTest.java", "diffHunk": "@@ -33,4 +36,88 @@ public void ieee14BusTest() throws IOException {\n             assertEquals(jsonRef, json);\n         }\n     }\n+\n+    @Test\n+    public void ieee14BusReadFieldsTest() throws IOException {\n+        try (BufferedReader reader = new BufferedReader(new InputStreamReader(getClass().getResourceAsStream(\"/IEEE_14_bus.raw\")))) {\n+            PsseContext context = new PsseContext();\n+            PsseRawModel rawData = new PsseRawReader().read(reader, context);\n+            assertNotNull(rawData);\n+\n+            String[] expectedCaseIdentificationDataReadFields = new String[] {\"ic\", \"sbase\", \"rev\", \"xfrrat\", \"nxfrat\", \"basfrq\", \"title1\", \"title2\"};\n+            String[] actualCaseIdentificationDataReadFields = context.getCaseIdentificationDataReadFields();\n+            assertTrue(compareReadFields(expectedCaseIdentificationDataReadFields, actualCaseIdentificationDataReadFields));\n+\n+            String[] expectedBusDataReadFields = new String[] {\"i\", \"name\", \"baskv\", \"ide\", \"area\", \"zone\", \"owner\", \"vm\", \"va\"};\n+            String[] actualBusDataReadFields = context.getBusDataReadFields();\n+            assertTrue(compareReadFields(expectedBusDataReadFields, actualBusDataReadFields));\n+\n+            String[] expectedLoadDataReadFields = new String[] {\"i\", \"id\", \"status\", \"area\", \"zone\", \"pl\", \"ql\", \"ip\", \"iq\", \"yp\", \"yq\", \"owner\", \"scale\"};\n+            String[] actualLoadDataReadFields = context.getLoadDataReadFields();\n+            assertTrue(compareReadFields(expectedLoadDataReadFields, actualLoadDataReadFields));\n+\n+            String[] expectedFixedBusShuntDataReadFields = new String[] {\"i\", \"id\", \"status\", \"gl\", \"bl\"};\n+            String[] actualFixedBusShuntDataReadFields = context.getFixedBusShuntDataReadFields();\n+            assertTrue(compareReadFields(expectedFixedBusShuntDataReadFields, actualFixedBusShuntDataReadFields));\n+\n+            String[] expectedGeneratorDataReadFields = new String[] {\"i\", \"id\", \"pg\", \"qg\", \"qt\", \"qb\", \"vs\", \"ireg\",\n+                \"mbase\", \"zr\", \"zx\", \"rt\", \"xt\", \"gtap\", \"stat\", \"rmpct\", \"pt\", \"pb\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\",\n+                \"f3\", \"o4\", \"f4\", \"wmod\", \"wpf\"};\n+            String[] actualGeneratorDataReadFields = context.getGeneratorDataReadFields();\n+            assertTrue(compareReadFields(expectedGeneratorDataReadFields, actualGeneratorDataReadFields));\n+\n+            String[] expectedNonTransformerBranchDataReadFields = new String[] {\"i\", \"j\", \"ckt\", \"r\", \"x\", \"b\",\n+                \"ratea\", \"rateb\", \"ratec\", \"gi\", \"bi\", \"gj\", \"bj\", \"st\", \"met\", \"len\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\",\n+                \"f3\", \"o4\", \"f4\"};\n+            String[] actualNonTransformerBranchDataReadFields = context.getNonTransformerBranchDataReadFields();\n+            assertTrue(compareReadFields(expectedNonTransformerBranchDataReadFields, actualNonTransformerBranchDataReadFields));\n+\n+            String[] expected2wTransformerDataReadFields = new String[] {\"i\", \"j\", \"k\", \"ckt\", \"cw\", \"cz\", \"cm\",\n+                \"mag1\", \"mag2\", \"nmetr\", \"name\", \"stat\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\", \"f3\", \"o4\", \"f4\", \"r12\", \"x12\", \"sbase12\"};\n+            String[] actual2wTransformerDataReadFields = context.get2wTransformerDataReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerDataReadFields, actual2wTransformerDataReadFields));\n+\n+            String[] expected2wTransformerW1DataReadFields = new String[] {\"windv\", \"nomv\", \"ang\", \"rata\", \"ratb\",\n+                \"ratc\", \"cod\", \"cont\", \"rma\", \"rmi\", \"vma\", \"vmi\", \"ntp\", \"tab\", \"cr\", \"cx\"};\n+            String[] actual2wTransformerW1DataReadFields = context.get2wTransformerDataWinding1ReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerW1DataReadFields, actual2wTransformerW1DataReadFields));\n+\n+            String[] expected2wTransformerW2DataReadFields = new String[] {\"windv\", \"nomv\"};\n+            String[] actual2wTransformerW2DataReadFields = context.get2wTransformerDataWinding2ReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerW2DataReadFields, actual2wTransformerW2DataReadFields));\n+\n+            String[] expectedAreaInterchangeDataReadFields = new String[] {\"i\", \"isw\", \"pdes\", \"ptol\", \"arname\"};\n+            String[] actualAreaInterchangeDataReadFields = context.getAreaInterchangeDataReadFields();\n+            assertTrue(compareReadFields(expectedAreaInterchangeDataReadFields, actualAreaInterchangeDataReadFields));\n+\n+            String[] expectedZoneDataReadFields = new String[] {\"i\", \"zoname\"};\n+            String[] actualZoneDataReadFields = context.getZoneDataReadFields();\n+            assertTrue(compareReadFields(expectedZoneDataReadFields, actualZoneDataReadFields));\n+\n+            String[] expectedOwnerDataReadFields = new String[] {\"i\", \"owname\"};\n+            String[] actualOwnerDataReadFields = context.getOwnerDataReadFields();\n+            assertTrue(compareReadFields(expectedOwnerDataReadFields, actualOwnerDataReadFields));\n+        }\n+    }\n+\n+    private boolean compareReadFields(String[] expected, String[] actual) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NzAxNg==", "bodyText": "Done", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516177016", "createdAt": "2020-11-02T18:33:29Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/test/java/com/powsybl/psse/model/PsseRawReaderTest.java", "diffHunk": "@@ -33,4 +36,88 @@ public void ieee14BusTest() throws IOException {\n             assertEquals(jsonRef, json);\n         }\n     }\n+\n+    @Test\n+    public void ieee14BusReadFieldsTest() throws IOException {\n+        try (BufferedReader reader = new BufferedReader(new InputStreamReader(getClass().getResourceAsStream(\"/IEEE_14_bus.raw\")))) {\n+            PsseContext context = new PsseContext();\n+            PsseRawModel rawData = new PsseRawReader().read(reader, context);\n+            assertNotNull(rawData);\n+\n+            String[] expectedCaseIdentificationDataReadFields = new String[] {\"ic\", \"sbase\", \"rev\", \"xfrrat\", \"nxfrat\", \"basfrq\", \"title1\", \"title2\"};\n+            String[] actualCaseIdentificationDataReadFields = context.getCaseIdentificationDataReadFields();\n+            assertTrue(compareReadFields(expectedCaseIdentificationDataReadFields, actualCaseIdentificationDataReadFields));\n+\n+            String[] expectedBusDataReadFields = new String[] {\"i\", \"name\", \"baskv\", \"ide\", \"area\", \"zone\", \"owner\", \"vm\", \"va\"};\n+            String[] actualBusDataReadFields = context.getBusDataReadFields();\n+            assertTrue(compareReadFields(expectedBusDataReadFields, actualBusDataReadFields));\n+\n+            String[] expectedLoadDataReadFields = new String[] {\"i\", \"id\", \"status\", \"area\", \"zone\", \"pl\", \"ql\", \"ip\", \"iq\", \"yp\", \"yq\", \"owner\", \"scale\"};\n+            String[] actualLoadDataReadFields = context.getLoadDataReadFields();\n+            assertTrue(compareReadFields(expectedLoadDataReadFields, actualLoadDataReadFields));\n+\n+            String[] expectedFixedBusShuntDataReadFields = new String[] {\"i\", \"id\", \"status\", \"gl\", \"bl\"};\n+            String[] actualFixedBusShuntDataReadFields = context.getFixedBusShuntDataReadFields();\n+            assertTrue(compareReadFields(expectedFixedBusShuntDataReadFields, actualFixedBusShuntDataReadFields));\n+\n+            String[] expectedGeneratorDataReadFields = new String[] {\"i\", \"id\", \"pg\", \"qg\", \"qt\", \"qb\", \"vs\", \"ireg\",\n+                \"mbase\", \"zr\", \"zx\", \"rt\", \"xt\", \"gtap\", \"stat\", \"rmpct\", \"pt\", \"pb\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\",\n+                \"f3\", \"o4\", \"f4\", \"wmod\", \"wpf\"};\n+            String[] actualGeneratorDataReadFields = context.getGeneratorDataReadFields();\n+            assertTrue(compareReadFields(expectedGeneratorDataReadFields, actualGeneratorDataReadFields));\n+\n+            String[] expectedNonTransformerBranchDataReadFields = new String[] {\"i\", \"j\", \"ckt\", \"r\", \"x\", \"b\",\n+                \"ratea\", \"rateb\", \"ratec\", \"gi\", \"bi\", \"gj\", \"bj\", \"st\", \"met\", \"len\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\",\n+                \"f3\", \"o4\", \"f4\"};\n+            String[] actualNonTransformerBranchDataReadFields = context.getNonTransformerBranchDataReadFields();\n+            assertTrue(compareReadFields(expectedNonTransformerBranchDataReadFields, actualNonTransformerBranchDataReadFields));\n+\n+            String[] expected2wTransformerDataReadFields = new String[] {\"i\", \"j\", \"k\", \"ckt\", \"cw\", \"cz\", \"cm\",\n+                \"mag1\", \"mag2\", \"nmetr\", \"name\", \"stat\", \"o1\", \"f1\", \"o2\", \"f2\", \"o3\", \"f3\", \"o4\", \"f4\", \"r12\", \"x12\", \"sbase12\"};\n+            String[] actual2wTransformerDataReadFields = context.get2wTransformerDataReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerDataReadFields, actual2wTransformerDataReadFields));\n+\n+            String[] expected2wTransformerW1DataReadFields = new String[] {\"windv\", \"nomv\", \"ang\", \"rata\", \"ratb\",\n+                \"ratc\", \"cod\", \"cont\", \"rma\", \"rmi\", \"vma\", \"vmi\", \"ntp\", \"tab\", \"cr\", \"cx\"};\n+            String[] actual2wTransformerW1DataReadFields = context.get2wTransformerDataWinding1ReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerW1DataReadFields, actual2wTransformerW1DataReadFields));\n+\n+            String[] expected2wTransformerW2DataReadFields = new String[] {\"windv\", \"nomv\"};\n+            String[] actual2wTransformerW2DataReadFields = context.get2wTransformerDataWinding2ReadFields();\n+            assertTrue(compareReadFields(expected2wTransformerW2DataReadFields, actual2wTransformerW2DataReadFields));\n+\n+            String[] expectedAreaInterchangeDataReadFields = new String[] {\"i\", \"isw\", \"pdes\", \"ptol\", \"arname\"};\n+            String[] actualAreaInterchangeDataReadFields = context.getAreaInterchangeDataReadFields();\n+            assertTrue(compareReadFields(expectedAreaInterchangeDataReadFields, actualAreaInterchangeDataReadFields));\n+\n+            String[] expectedZoneDataReadFields = new String[] {\"i\", \"zoname\"};\n+            String[] actualZoneDataReadFields = context.getZoneDataReadFields();\n+            assertTrue(compareReadFields(expectedZoneDataReadFields, actualZoneDataReadFields));\n+\n+            String[] expectedOwnerDataReadFields = new String[] {\"i\", \"owname\"};\n+            String[] actualOwnerDataReadFields = context.getOwnerDataReadFields();\n+            assertTrue(compareReadFields(expectedOwnerDataReadFields, actualOwnerDataReadFields));\n+        }\n+    }\n+\n+    private boolean compareReadFields(String[] expected, String[] actual) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyOTg4NA=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI2Nzk5OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0MToxM1rOHrXLMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0NDowN1rOHsRSCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMDUxMw==", "bodyText": "Not sure that this should be public. If you make this method private, you don't have to check that reader is not null: this will be done by another public method", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515230513", "createdAt": "2020-10-30T16:41:13Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MjUzOQ==", "bodyText": "Now should be public. Next PR will refact and extend the validation process and at this moment I will try to change the visibility to private", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516182539", "createdAt": "2020-11-02T18:44:07Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMDUxMw=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI3MzI0OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0MjozNFrOHrXOYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0NDoyMFrOHsRShA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMTMyOA==", "bodyText": "Should we log the exception?", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515231328", "createdAt": "2020-10-30T16:42:34Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MjY2MA==", "bodyText": "Done", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516182660", "createdAt": "2020-11-02T18:44:20Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMTMyOA=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI4MDU3OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0NDoyM1rOHrXSxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0NDo0MFrOHsRTKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMjQ1Mw==", "bodyText": "I think we should at least log which assertion is not true, specially if the version is not supported.", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515232453", "createdAt": "2020-10-30T16:44:23Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MjgyNQ==", "bodyText": "Done", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516182825", "createdAt": "2020-11-02T18:44:40Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMjQ1Mw=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI4NDE4OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0NToxN1rOHrXU_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0NTo0N1rOHsRVfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMzAyMg==", "bodyText": "String line = Objects.requireNonNull(readLineAndRemoveComment(reader));\n\nCan the readLineAndRemoveComment really return null?\nSame remark for all occurrences below", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515233022", "createdAt": "2020-10-30T16:45:17Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;\n     }\n \n-    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n-        String line = reader.readLine();\n-        if (line == null) {\n-            return null;\n+    public PsseRawModel read(BufferedReader reader) throws IOException {\n+        PsseContext context = new PsseContext();\n+        return read(reader, context);\n+    }\n+\n+    public PsseRawModel read(BufferedReader reader, PsseContext context) throws IOException {\n+        Objects.requireNonNull(reader);\n+        Objects.requireNonNull(context);\n+\n+        PsseCaseIdentification caseIdentification = readCaseIdentificationData(reader, context);\n+        PsseRawModel model = new PsseRawModel(caseIdentification);\n+\n+        model.getBuses().addAll(readBusData(reader, context));\n+        model.getLoads().addAll(readLoadData(reader, context));\n+        model.getFixedShunts().addAll(readFixedBusShuntData(reader, context));\n+        model.getGenerators().addAll(readGeneratorData(reader, context));\n+        model.getNonTransformerBranches().addAll(readNonTransformerBranchData(reader, context));\n+        model.getTransformers().addAll(readTransformerData(reader, context));\n+        model.getAreas().addAll(readAreaInterchangeData(reader, context));\n+\n+        // 2-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // voltage source converter data\n+        readRecordBlock(reader); // TODO\n+\n+        // impedance correction data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-section line data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getZones().addAll(readZoneData(reader, context));\n+\n+        // inter-area transfer data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getOwners().addAll(readOwnerData(reader, context));\n+\n+        // facts control device data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getSwitchedShunts().addAll(readSwitchedShuntData(reader, context));\n+\n+        // gne device data\n+        readRecordBlock(reader); // TODO\n+\n+        // q record (nothing to do)\n+        readRecordBlock(reader);\n+\n+        return model;\n+    }\n+\n+    // Read blocks\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader, PsseContext context) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MzQyMw==", "bodyText": "Done. Now readLineAndRemoveComment never returns null", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516183423", "createdAt": "2020-11-02T18:45:47Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;\n     }\n \n-    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n-        String line = reader.readLine();\n-        if (line == null) {\n-            return null;\n+    public PsseRawModel read(BufferedReader reader) throws IOException {\n+        PsseContext context = new PsseContext();\n+        return read(reader, context);\n+    }\n+\n+    public PsseRawModel read(BufferedReader reader, PsseContext context) throws IOException {\n+        Objects.requireNonNull(reader);\n+        Objects.requireNonNull(context);\n+\n+        PsseCaseIdentification caseIdentification = readCaseIdentificationData(reader, context);\n+        PsseRawModel model = new PsseRawModel(caseIdentification);\n+\n+        model.getBuses().addAll(readBusData(reader, context));\n+        model.getLoads().addAll(readLoadData(reader, context));\n+        model.getFixedShunts().addAll(readFixedBusShuntData(reader, context));\n+        model.getGenerators().addAll(readGeneratorData(reader, context));\n+        model.getNonTransformerBranches().addAll(readNonTransformerBranchData(reader, context));\n+        model.getTransformers().addAll(readTransformerData(reader, context));\n+        model.getAreas().addAll(readAreaInterchangeData(reader, context));\n+\n+        // 2-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // voltage source converter data\n+        readRecordBlock(reader); // TODO\n+\n+        // impedance correction data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-section line data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getZones().addAll(readZoneData(reader, context));\n+\n+        // inter-area transfer data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getOwners().addAll(readOwnerData(reader, context));\n+\n+        // facts control device data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getSwitchedShunts().addAll(readSwitchedShuntData(reader, context));\n+\n+        // gne device data\n+        readRecordBlock(reader); // TODO\n+\n+        // q record (nothing to do)\n+        readRecordBlock(reader);\n+\n+        return model;\n+    }\n+\n+    // Read blocks\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader, PsseContext context) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzMzAyMg=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODI5NDMyOnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0NzoyOVrOHrXa-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0Njo0NlrOHsRXdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNDU1Mw==", "bodyText": "From my point of view, if readLine returns null, that means we are at the end of the file, whereas we wanted to read more data. Maybe a premature end of file? In that case, should we throw an exception?", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515234553", "createdAt": "2020-10-30T16:47:29Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);\n     }\n \n-    private List<PsseTransformer> readTransformers(BufferedReader reader) throws IOException {\n-        List<PsseTransformer> transformers = new ArrayList<>();\n-\n-        List<String> records = readRecordBlock(reader);\n-        int i = 0;\n-        while (i < records.size()) {\n-            PsseTransformer transformer = new PsseTransformer();\n-            transformer.setFirstRecord(parseRecord(records.get(i++), PsseTransformer.FirstRecord.class));\n-            transformer.setSecondRecord(parseRecord(records.get(i++), PsseTransformer.SecondRecord.class));\n-            transformer.setThirdRecord1(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            transformer.setThirdRecord2(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            if (transformer.getFirstRecord().getK() != 0) {\n-                transformer.setThirdRecord3(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n+    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n+        String line = reader.readLine();\n+        if (line == null) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 337}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MzkyNA==", "bodyText": "Done.  I throw an exception.", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516183924", "createdAt": "2020-11-02T18:46:46Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);\n     }\n \n-    private List<PsseTransformer> readTransformers(BufferedReader reader) throws IOException {\n-        List<PsseTransformer> transformers = new ArrayList<>();\n-\n-        List<String> records = readRecordBlock(reader);\n-        int i = 0;\n-        while (i < records.size()) {\n-            PsseTransformer transformer = new PsseTransformer();\n-            transformer.setFirstRecord(parseRecord(records.get(i++), PsseTransformer.FirstRecord.class));\n-            transformer.setSecondRecord(parseRecord(records.get(i++), PsseTransformer.SecondRecord.class));\n-            transformer.setThirdRecord1(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            transformer.setThirdRecord2(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            if (transformer.getFirstRecord().getK() != 0) {\n-                transformer.setThirdRecord3(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n+    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n+        String line = reader.readLine();\n+        if (line == null) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNDU1Mw=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 337}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODMwNDAxOnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0OTo1NFrOHrXgzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0ODoxNlrOHsRa8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNjA0Ng==", "bodyText": "Are you really sure this is correct: I wonder if the lastIndexOf is correct, or if you should find the first occurence of / ? What if I have a comment that contain a slash?", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515236046", "createdAt": "2020-10-30T16:49:54Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 318}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NDgxNg==", "bodyText": "Done. Change to the  first occurrence.", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516184816", "createdAt": "2020-11-02T18:48:16Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNjA0Ng=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 318}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODMxNDc5OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1MjoyM1rOHrXnKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0ODoyOVrOHsRbaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzY3NA==", "bodyText": "This comment is useless", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515237674", "createdAt": "2020-10-30T16:52:23Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;\n     }\n \n-    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n-        String line = reader.readLine();\n-        if (line == null) {\n-            return null;\n+    public PsseRawModel read(BufferedReader reader) throws IOException {\n+        PsseContext context = new PsseContext();\n+        return read(reader, context);\n+    }\n+\n+    public PsseRawModel read(BufferedReader reader, PsseContext context) throws IOException {\n+        Objects.requireNonNull(reader);\n+        Objects.requireNonNull(context);\n+\n+        PsseCaseIdentification caseIdentification = readCaseIdentificationData(reader, context);\n+        PsseRawModel model = new PsseRawModel(caseIdentification);\n+\n+        model.getBuses().addAll(readBusData(reader, context));\n+        model.getLoads().addAll(readLoadData(reader, context));\n+        model.getFixedShunts().addAll(readFixedBusShuntData(reader, context));\n+        model.getGenerators().addAll(readGeneratorData(reader, context));\n+        model.getNonTransformerBranches().addAll(readNonTransformerBranchData(reader, context));\n+        model.getTransformers().addAll(readTransformerData(reader, context));\n+        model.getAreas().addAll(readAreaInterchangeData(reader, context));\n+\n+        // 2-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // voltage source converter data\n+        readRecordBlock(reader); // TODO\n+\n+        // impedance correction data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-section line data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getZones().addAll(readZoneData(reader, context));\n+\n+        // inter-area transfer data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getOwners().addAll(readOwnerData(reader, context));\n+\n+        // facts control device data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getSwitchedShunts().addAll(readSwitchedShuntData(reader, context));\n+\n+        // gne device data\n+        readRecordBlock(reader); // TODO\n+\n+        // q record (nothing to do)\n+        readRecordBlock(reader);\n+\n+        return model;\n+    }\n+\n+    // Read blocks\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader, PsseContext context) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);\n+\n+        context.setDelimiter(detectDelimiter(line));\n+\n+        String[] headers = caseIdentificationDataHeaders(line.split(context.getDelimiter()).length);\n+        PsseCaseIdentification caseIdentification = parseRecordHeader(line, PsseCaseIdentification.class, headers);\n+        caseIdentification.setTitle1(reader.readLine());\n+        caseIdentification.setTitle2(reader.readLine());\n+\n+        context.setCaseIdentificationDataReadFields(headers);\n+        return caseIdentification;\n+    }\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);\n+\n+        String[] headers = caseIdentificationDataHeaders();\n+        PsseCaseIdentification caseIdentification = parseRecordHeader(line, PsseCaseIdentification.class, headers);\n+        caseIdentification.setTitle1(reader.readLine());\n+        caseIdentification.setTitle2(reader.readLine());\n+\n+        return caseIdentification;\n+    }\n+\n+    private static List<PsseBus> readBusData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = busDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setBusDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseBus.class, headers);\n+    }\n+\n+    private static List<PsseLoad> readLoadData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = loadDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setLoadDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseLoad.class, headers);\n+    }\n+\n+    private static List<PsseFixedShunt> readFixedBusShuntData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = fixedBusShuntDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setFixedBusShuntDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseFixedShunt.class, headers);\n+    }\n+\n+    private static List<PsseGenerator> readGeneratorData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = generatorDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setGeneratorDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseGenerator.class, headers);\n+    }\n+\n+    private static List<PsseNonTransformerBranch> readNonTransformerBranchData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = nonTransformerBranchDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setNonTransformerBranchDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseNonTransformerBranch.class, headers);\n+    }\n+\n+    private static List<PsseTransformer> readTransformerData(BufferedReader reader, PsseContext context) throws IOException {\n+\n+        String[] windingHeaders = transformerWindingDataHeaders();\n+        List<PsseTransformer> transformers = new ArrayList<>();\n+\n+        List<String> records = readRecordBlock(reader);\n+        int i = 0;\n+        while (i < records.size()) {\n+            String record1 = records.get(i++);\n+            String record2 = records.get(i++);\n+            String record3 = records.get(i++);\n+            String record4 = records.get(i++);\n+            String twtRecord = String.join(context.getDelimiter(), record1, record2);\n+\n+            String[] headers = transformerDataHeaders(record1.split(context.getDelimiter()).length);\n+            PsseTransformer transformer = parseRecordHeader(twtRecord, PsseTransformer.class, headers);\n+\n+            transformer.setWindingRecord1(parseRecordHeader(record3, PsseTransformer.WindingRecord.class, windingHeaders));\n+            transformer.setWindingRecord2(parseRecordHeader(record4, PsseTransformer.WindingRecord.class, windingHeaders));\n+\n+            if (transformer.getK() != 0) {\n+                String record5 = records.get(i++);\n+                transformer\n+                    .setWindingRecord3(parseRecordHeader(record5, PsseTransformer.WindingRecord.class, windingHeaders));\n+\n+                if (context.is3wTransformerDataReadFieldsEmpty()) {\n+                    context.set3wTransformerDataReadFields(readFields(twtRecord, headers, context.getDelimiter()),\n+                        readFields(record3, windingHeaders, context.getDelimiter()),\n+                        readFields(record4, windingHeaders, context.getDelimiter()),\n+                        readFields(record5, windingHeaders, context.getDelimiter()));\n+                }\n+            } else {\n+                if (context.is2wTransformerDataReadFieldsEmpty()) {\n+                    context.set2wTransformerDataReadFields(readFields(twtRecord, headers, context.getDelimiter()),\n+                        readFields(record3, windingHeaders, context.getDelimiter()),\n+                        readFields(record4, windingHeaders, context.getDelimiter()));\n+                }\n+            }\n+            transformers.add(transformer);\n         }\n-        return removeComment(line);\n+\n+        return transformers;\n+    }\n+\n+    private static List<PsseArea> readAreaInterchangeData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = areaInterchangeDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setAreaInterchangeDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseArea.class, headers);\n     }\n \n-    private static <T> T parseRecord(String record, Class<T> aClass) {\n-        List<T> beans = parseRecords(Collections.singletonList(record), aClass);\n+    private static List<PsseZone> readZoneData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = zoneDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setZoneDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseZone.class, headers);\n+    }\n+\n+    private static List<PsseOwner> readOwnerData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = ownerDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setOwnerDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseOwner.class, headers);\n+    }\n+\n+    private static List<PsseSwitchedShunt> readSwitchedShuntData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = switchedShuntDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setSwitchedShuntDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseSwitchedShunt.class, headers);\n+    }\n+\n+    // Parse", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 261}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NDkzOQ==", "bodyText": "Done. Deleted", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516184939", "createdAt": "2020-11-02T18:48:29Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -21,39 +23,255 @@\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n \n /**\n  * @author Geoffroy Jamgotchian <geoffroy.jamgotchian at rte-france.com>\n+ * @author Luma Zamarre\u00f1o <zamarrenolm at aia.es>\n+ * @author Jos\u00e9 Antonio Marqu\u00e9s <marquesja at aia.es>\n  */\n public class PsseRawReader {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(PsseRawReader.class);\n \n-    private static String removeComment(String line) {\n-        int slashIndex = line.lastIndexOf('/');\n-        if (slashIndex == -1) {\n-            return line;\n+    public boolean checkCaseIdentification(BufferedReader reader) throws IOException {\n+        Objects.requireNonNull(reader);\n+\n+        // just check the first record if this file is in PSS/E format\n+        PsseCaseIdentification caseIdentification;\n+        try {\n+            caseIdentification = readCaseIdentificationData(reader);\n+        } catch (PsseException e) {\n+            return false; // invalid PSS/E content\n         }\n-        return line.substring(0, slashIndex);\n+\n+        int ic = caseIdentification.getIc();\n+        double sbase = caseIdentification.getSbase();\n+        int rev = caseIdentification.getRev();\n+        double basfrq = caseIdentification.getBasfrq();\n+\n+        if (ic == 0 && sbase > 0. && rev <= PsseConstants.SUPPORTED_VERSION && basfrq > 0.) {\n+            return true;\n+        }\n+\n+        return false;\n     }\n \n-    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n-        String line = reader.readLine();\n-        if (line == null) {\n-            return null;\n+    public PsseRawModel read(BufferedReader reader) throws IOException {\n+        PsseContext context = new PsseContext();\n+        return read(reader, context);\n+    }\n+\n+    public PsseRawModel read(BufferedReader reader, PsseContext context) throws IOException {\n+        Objects.requireNonNull(reader);\n+        Objects.requireNonNull(context);\n+\n+        PsseCaseIdentification caseIdentification = readCaseIdentificationData(reader, context);\n+        PsseRawModel model = new PsseRawModel(caseIdentification);\n+\n+        model.getBuses().addAll(readBusData(reader, context));\n+        model.getLoads().addAll(readLoadData(reader, context));\n+        model.getFixedShunts().addAll(readFixedBusShuntData(reader, context));\n+        model.getGenerators().addAll(readGeneratorData(reader, context));\n+        model.getNonTransformerBranches().addAll(readNonTransformerBranchData(reader, context));\n+        model.getTransformers().addAll(readTransformerData(reader, context));\n+        model.getAreas().addAll(readAreaInterchangeData(reader, context));\n+\n+        // 2-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // voltage source converter data\n+        readRecordBlock(reader); // TODO\n+\n+        // impedance correction data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-terminal DC data\n+        readRecordBlock(reader); // TODO\n+\n+        // multi-section line data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getZones().addAll(readZoneData(reader, context));\n+\n+        // inter-area transfer data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getOwners().addAll(readOwnerData(reader, context));\n+\n+        // facts control device data\n+        readRecordBlock(reader); // TODO\n+\n+        model.getSwitchedShunts().addAll(readSwitchedShuntData(reader, context));\n+\n+        // gne device data\n+        readRecordBlock(reader); // TODO\n+\n+        // q record (nothing to do)\n+        readRecordBlock(reader);\n+\n+        return model;\n+    }\n+\n+    // Read blocks\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader, PsseContext context) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);\n+\n+        context.setDelimiter(detectDelimiter(line));\n+\n+        String[] headers = caseIdentificationDataHeaders(line.split(context.getDelimiter()).length);\n+        PsseCaseIdentification caseIdentification = parseRecordHeader(line, PsseCaseIdentification.class, headers);\n+        caseIdentification.setTitle1(reader.readLine());\n+        caseIdentification.setTitle2(reader.readLine());\n+\n+        context.setCaseIdentificationDataReadFields(headers);\n+        return caseIdentification;\n+    }\n+\n+    private static PsseCaseIdentification readCaseIdentificationData(BufferedReader reader) throws IOException {\n+        String line = readLineAndRemoveComment(reader);\n+        Objects.requireNonNull(line);\n+\n+        String[] headers = caseIdentificationDataHeaders();\n+        PsseCaseIdentification caseIdentification = parseRecordHeader(line, PsseCaseIdentification.class, headers);\n+        caseIdentification.setTitle1(reader.readLine());\n+        caseIdentification.setTitle2(reader.readLine());\n+\n+        return caseIdentification;\n+    }\n+\n+    private static List<PsseBus> readBusData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = busDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setBusDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseBus.class, headers);\n+    }\n+\n+    private static List<PsseLoad> readLoadData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = loadDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setLoadDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseLoad.class, headers);\n+    }\n+\n+    private static List<PsseFixedShunt> readFixedBusShuntData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = fixedBusShuntDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setFixedBusShuntDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseFixedShunt.class, headers);\n+    }\n+\n+    private static List<PsseGenerator> readGeneratorData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = generatorDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setGeneratorDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseGenerator.class, headers);\n+    }\n+\n+    private static List<PsseNonTransformerBranch> readNonTransformerBranchData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = nonTransformerBranchDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setNonTransformerBranchDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseNonTransformerBranch.class, headers);\n+    }\n+\n+    private static List<PsseTransformer> readTransformerData(BufferedReader reader, PsseContext context) throws IOException {\n+\n+        String[] windingHeaders = transformerWindingDataHeaders();\n+        List<PsseTransformer> transformers = new ArrayList<>();\n+\n+        List<String> records = readRecordBlock(reader);\n+        int i = 0;\n+        while (i < records.size()) {\n+            String record1 = records.get(i++);\n+            String record2 = records.get(i++);\n+            String record3 = records.get(i++);\n+            String record4 = records.get(i++);\n+            String twtRecord = String.join(context.getDelimiter(), record1, record2);\n+\n+            String[] headers = transformerDataHeaders(record1.split(context.getDelimiter()).length);\n+            PsseTransformer transformer = parseRecordHeader(twtRecord, PsseTransformer.class, headers);\n+\n+            transformer.setWindingRecord1(parseRecordHeader(record3, PsseTransformer.WindingRecord.class, windingHeaders));\n+            transformer.setWindingRecord2(parseRecordHeader(record4, PsseTransformer.WindingRecord.class, windingHeaders));\n+\n+            if (transformer.getK() != 0) {\n+                String record5 = records.get(i++);\n+                transformer\n+                    .setWindingRecord3(parseRecordHeader(record5, PsseTransformer.WindingRecord.class, windingHeaders));\n+\n+                if (context.is3wTransformerDataReadFieldsEmpty()) {\n+                    context.set3wTransformerDataReadFields(readFields(twtRecord, headers, context.getDelimiter()),\n+                        readFields(record3, windingHeaders, context.getDelimiter()),\n+                        readFields(record4, windingHeaders, context.getDelimiter()),\n+                        readFields(record5, windingHeaders, context.getDelimiter()));\n+                }\n+            } else {\n+                if (context.is2wTransformerDataReadFieldsEmpty()) {\n+                    context.set2wTransformerDataReadFields(readFields(twtRecord, headers, context.getDelimiter()),\n+                        readFields(record3, windingHeaders, context.getDelimiter()),\n+                        readFields(record4, windingHeaders, context.getDelimiter()));\n+                }\n+            }\n+            transformers.add(transformer);\n         }\n-        return removeComment(line);\n+\n+        return transformers;\n+    }\n+\n+    private static List<PsseArea> readAreaInterchangeData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = areaInterchangeDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setAreaInterchangeDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseArea.class, headers);\n     }\n \n-    private static <T> T parseRecord(String record, Class<T> aClass) {\n-        List<T> beans = parseRecords(Collections.singletonList(record), aClass);\n+    private static List<PsseZone> readZoneData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = zoneDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setZoneDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseZone.class, headers);\n+    }\n+\n+    private static List<PsseOwner> readOwnerData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = ownerDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setOwnerDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseOwner.class, headers);\n+    }\n+\n+    private static List<PsseSwitchedShunt> readSwitchedShuntData(BufferedReader reader, PsseContext context) throws IOException {\n+        String[] headers = switchedShuntDataHeaders();\n+        List<String> records = readRecordBlock(reader);\n+\n+        context.setSwitchedShuntDataReadFields(readFields(records, headers, context.getDelimiter()));\n+        return parseRecordsHeader(records, PsseSwitchedShunt.class, headers);\n+    }\n+\n+    // Parse", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzY3NA=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 261}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODMxODMxOnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1MzoxN1rOHrXpQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0ODo1MVrOHsRcJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODIwOQ==", "bodyText": "Should we extract these lines into a method to avoid duplication (see parseRecordsHeader above)", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515238209", "createdAt": "2020-10-30T16:53:17Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -73,6 +291,24 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return beans;\n     }\n \n+    private static String detectDelimiter(String record) {\n+        CsvParserSettings settings = new CsvParserSettings();\n+        settings.setHeaderExtractionEnabled(false);\n+        settings.setQuoteDetectionEnabled(true);\n+        settings.setDelimiterDetectionEnabled(true, ',', ' '); // sequence order is relevant\n+        settings.setProcessorErrorHandler(new RetryableErrorHandler<ParsingContext>() {\n+            @Override\n+            public void handleError(DataProcessingException error, Object[] inputRow, ParsingContext context) {\n+                LOGGER.error(error.getMessage());\n+            }\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 292}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NTEyNA==", "bodyText": "Done.", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516185124", "createdAt": "2020-11-02T18:48:51Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -73,6 +291,24 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return beans;\n     }\n \n+    private static String detectDelimiter(String record) {\n+        CsvParserSettings settings = new CsvParserSettings();\n+        settings.setHeaderExtractionEnabled(false);\n+        settings.setQuoteDetectionEnabled(true);\n+        settings.setDelimiterDetectionEnabled(true, ',', ' '); // sequence order is relevant\n+        settings.setProcessorErrorHandler(new RetryableErrorHandler<ParsingContext>() {\n+            @Override\n+            public void handleError(DataProcessingException error, Object[] inputRow, ParsingContext context) {\n+                LOGGER.error(error.getMessage());\n+            }\n+        });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODIwOQ=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 292}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODMzNDA0OnYy", "diffSide": "RIGHT", "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1Njo1OFrOHrXynA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxODo0OTowMFrOHsRcbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MDYwNA==", "bodyText": "Since you use ArrayUtils, why don't use ArrayUtils.EMPTY_STRING_ARRAY?", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r515240604", "createdAt": "2020-10-30T16:56:58Z", "author": {"login": "mathbagu"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);\n     }\n \n-    private List<PsseTransformer> readTransformers(BufferedReader reader) throws IOException {\n-        List<PsseTransformer> transformers = new ArrayList<>();\n-\n-        List<String> records = readRecordBlock(reader);\n-        int i = 0;\n-        while (i < records.size()) {\n-            PsseTransformer transformer = new PsseTransformer();\n-            transformer.setFirstRecord(parseRecord(records.get(i++), PsseTransformer.FirstRecord.class));\n-            transformer.setSecondRecord(parseRecord(records.get(i++), PsseTransformer.SecondRecord.class));\n-            transformer.setThirdRecord1(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            transformer.setThirdRecord2(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            if (transformer.getFirstRecord().getK() != 0) {\n-                transformer.setThirdRecord3(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n+    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n+        String line = reader.readLine();\n+        if (line == null) {\n+            return null;\n+        }\n+        StringBuffer newLine = new StringBuffer();\n+        Pattern p = Pattern.compile(\"('[^']+')|( )+\");\n+        Matcher m = p.matcher(removeComment(line));\n+        while (m.find()) {\n+            if (m.group().contains(\"'\")) {\n+                m.appendReplacement(newLine, m.group());\n+            } else {\n+                m.appendReplacement(newLine, \" \");\n             }\n-            transformers.add(transformer);\n         }\n-\n-        return transformers;\n+        m.appendTail(newLine);\n+        return newLine.toString().trim();\n     }\n \n-    public PsseRawModel read(BufferedReader reader) throws IOException {\n-        Objects.requireNonNull(reader);\n-\n-        // case identification\n-        PsseCaseIdentification caseIdentification = readCaseIdentification(reader);\n-\n-        PsseRawModel model = new PsseRawModel(caseIdentification);\n-\n-        // bus data\n-        model.getBuses().addAll(parseRecords(readRecordBlock(reader), PsseBus.class));\n-\n-        // load data\n-        model.getLoads().addAll(parseRecords(readRecordBlock(reader), PsseLoad.class));\n-\n-        // fixed shunt data\n-        model.getFixedShunts().addAll(parseRecords(readRecordBlock(reader), PsseFixedShunt.class));\n-\n-        // generator data\n-        model.getGenerators().addAll(parseRecords(readRecordBlock(reader), PsseGenerator.class));\n-\n-        // non transformer data\n-        model.getNonTransformerBranches().addAll(parseRecords(readRecordBlock(reader), PsseNonTransformerBranch.class));\n-\n-        // transformer data\n-        model.getTransformers().addAll(readTransformers(reader));\n-\n-        // area data\n-        model.getAreas().addAll(parseRecords(readRecordBlock(reader), PsseArea.class));\n+    // Read fields\n \n-        // 2-terminal DC data\n-        readRecordBlock(reader); // TODO\n-\n-        // voltage source converter data\n-        readRecordBlock(reader); // TODO\n+    private static String[] readFields(List<String> records, String[] headers, String delimiter) {\n+        if (records.isEmpty()) {\n+            return new String[] {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 393}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NTE5OQ==", "bodyText": "Done", "url": "https://github.com/powsybl/powsybl-core/pull/1460#discussion_r516185199", "createdAt": "2020-11-02T18:49:00Z", "author": {"login": "marqueslanauja"}, "path": "psse/psse-model/src/main/java/com/powsybl/psse/model/PsseRawReader.java", "diffHunk": "@@ -85,122 +321,108 @@ public void handleError(DataProcessingException error, Object[] inputRow, Parsin\n         return records;\n     }\n \n-    private PsseCaseIdentification readCaseIdentification(BufferedReader reader) throws IOException {\n-        String line = readLineAndRemoveComment(reader);\n-        PsseCaseIdentification caseIdentification = parseRecord(line, PsseCaseIdentification.class);\n-        caseIdentification.setTitle1(reader.readLine());\n-        caseIdentification.setTitle2(reader.readLine());\n-        return caseIdentification;\n+    private static String removeComment(String line) {\n+        int slashIndex = line.lastIndexOf('/');\n+        if (slashIndex == -1) {\n+            return line;\n+        }\n+        return line.substring(0, slashIndex);\n     }\n \n-    private List<PsseTransformer> readTransformers(BufferedReader reader) throws IOException {\n-        List<PsseTransformer> transformers = new ArrayList<>();\n-\n-        List<String> records = readRecordBlock(reader);\n-        int i = 0;\n-        while (i < records.size()) {\n-            PsseTransformer transformer = new PsseTransformer();\n-            transformer.setFirstRecord(parseRecord(records.get(i++), PsseTransformer.FirstRecord.class));\n-            transformer.setSecondRecord(parseRecord(records.get(i++), PsseTransformer.SecondRecord.class));\n-            transformer.setThirdRecord1(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            transformer.setThirdRecord2(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n-            if (transformer.getFirstRecord().getK() != 0) {\n-                transformer.setThirdRecord3(parseRecord(records.get(i++), PsseTransformer.ThirdRecord.class));\n+    private static String readLineAndRemoveComment(BufferedReader reader) throws IOException {\n+        String line = reader.readLine();\n+        if (line == null) {\n+            return null;\n+        }\n+        StringBuffer newLine = new StringBuffer();\n+        Pattern p = Pattern.compile(\"('[^']+')|( )+\");\n+        Matcher m = p.matcher(removeComment(line));\n+        while (m.find()) {\n+            if (m.group().contains(\"'\")) {\n+                m.appendReplacement(newLine, m.group());\n+            } else {\n+                m.appendReplacement(newLine, \" \");\n             }\n-            transformers.add(transformer);\n         }\n-\n-        return transformers;\n+        m.appendTail(newLine);\n+        return newLine.toString().trim();\n     }\n \n-    public PsseRawModel read(BufferedReader reader) throws IOException {\n-        Objects.requireNonNull(reader);\n-\n-        // case identification\n-        PsseCaseIdentification caseIdentification = readCaseIdentification(reader);\n-\n-        PsseRawModel model = new PsseRawModel(caseIdentification);\n-\n-        // bus data\n-        model.getBuses().addAll(parseRecords(readRecordBlock(reader), PsseBus.class));\n-\n-        // load data\n-        model.getLoads().addAll(parseRecords(readRecordBlock(reader), PsseLoad.class));\n-\n-        // fixed shunt data\n-        model.getFixedShunts().addAll(parseRecords(readRecordBlock(reader), PsseFixedShunt.class));\n-\n-        // generator data\n-        model.getGenerators().addAll(parseRecords(readRecordBlock(reader), PsseGenerator.class));\n-\n-        // non transformer data\n-        model.getNonTransformerBranches().addAll(parseRecords(readRecordBlock(reader), PsseNonTransformerBranch.class));\n-\n-        // transformer data\n-        model.getTransformers().addAll(readTransformers(reader));\n-\n-        // area data\n-        model.getAreas().addAll(parseRecords(readRecordBlock(reader), PsseArea.class));\n+    // Read fields\n \n-        // 2-terminal DC data\n-        readRecordBlock(reader); // TODO\n-\n-        // voltage source converter data\n-        readRecordBlock(reader); // TODO\n+    private static String[] readFields(List<String> records, String[] headers, String delimiter) {\n+        if (records.isEmpty()) {\n+            return new String[] {};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MDYwNA=="}, "originalCommit": {"oid": "1bff9296bbc9f1e5a3e6af0d7d5bb5d5cbb93d08"}, "originalPosition": 393}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 24, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}