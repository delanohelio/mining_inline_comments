{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDIwMzg5", "number": 1446, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxMzo0NlrOElvZgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToyOTozMFrOEpZE9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDA5MzQ2OnYy", "diffSide": "RIGHT", "path": "commons/src/main/java/com/powsybl/commons/extensions/Extension.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxMzo0NlrOHVYfJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTozMzoxNFrOHVx3rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4MzMzNQ==", "bodyText": "This method sounds very strange. I'm not convinced this method is well placed. For serialization purpose, why the serializer is not responsible to determine if an extension should be serialized or not?", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492183335", "createdAt": "2020-09-21T16:13:46Z", "author": {"login": "mathbagu"}, "path": "commons/src/main/java/com/powsybl/commons/extensions/Extension.java", "diffHunk": "@@ -33,4 +33,12 @@\n      */\n     void setExtendable(T extendable);\n \n+    /**\n+     * Return whether the extension is empty (and thus should not be serialized)\n+     *\n+     * @return true if the extension is empty, false otherwise\n+     */\n+    default boolean isEmpty() {\n+        return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU5OTIxNA==", "bodyText": "Yes indeed, that would be more consistent...", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492599214", "createdAt": "2020-09-22T09:33:14Z", "author": {"login": "flo-dup"}, "path": "commons/src/main/java/com/powsybl/commons/extensions/Extension.java", "diffHunk": "@@ -33,4 +33,12 @@\n      */\n     void setExtendable(T extendable);\n \n+    /**\n+     * Return whether the extension is empty (and thus should not be serialized)\n+     *\n+     * @return true if the extension is empty, false otherwise\n+     */\n+    default boolean isEmpty() {\n+        return false;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4MzMzNQ=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDEwNDI2OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/SlackTerminalImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxNjoyOVrOHVYl5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTozNToxN1rOHVx8Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTA2Mg==", "bodyText": "I think this method should be define on the SlackTerminal API, not for the all extensions (that could concern everything in powsybl, not necessarily IIDM extensions)", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492185062", "createdAt": "2020-09-21T16:16:29Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/SlackTerminalImpl.java", "diffHunk": "@@ -46,7 +46,7 @@ public SlackTerminal setTerminal(Terminal terminal) {\n     }\n \n     @Override\n-    public boolean isCleanable() {\n+    public boolean isEmpty() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwMDM1OA==", "bodyText": "Yes (like it was before that PR), if the serializer is responsible of checking if the serialization is needed, there's no need for that in all the extesions. And what about the name btw, isCleanable / isEmpty?", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492600358", "createdAt": "2020-09-22T09:35:17Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/extensions/SlackTerminalImpl.java", "diffHunk": "@@ -46,7 +46,7 @@ public SlackTerminal setTerminal(Terminal terminal) {\n     }\n \n     @Override\n-    public boolean isCleanable() {\n+    public boolean isEmpty() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTA2Mg=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDEwNjUyOnYy", "diffSide": "RIGHT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxNzowNlrOHVYnWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo0MDowNVrOHVyHWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTQzMw==", "bodyText": "I would use the serializer to check if an extension should be serialized or not.", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492185433", "createdAt": "2020-09-21T16:17:06Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -79,9 +79,7 @@ private NetworkXml() {\n     private static Set<String> getNetworkExtensions(Network n) {\n         Set<String> extensions = new TreeSet<>();\n         for (Identifiable<?> identifiable : n.getIdentifiables()) {\n-            for (Extension<? extends Identifiable<?>> extension : identifiable.getExtensions()) {\n-                extensions.add(extension.getName());\n-            }\n+            identifiable.getExtensions().stream().filter(e -> !e.isEmpty()).forEach(e -> extensions.add(e.getName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwMzIyNw==", "bodyText": "ok as said above", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492603227", "createdAt": "2020-09-22T09:40:05Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -79,9 +79,7 @@ private NetworkXml() {\n     private static Set<String> getNetworkExtensions(Network n) {\n         Set<String> extensions = new TreeSet<>();\n         for (Identifiable<?> identifiable : n.getIdentifiables()) {\n-            for (Extension<? extends Identifiable<?>> extension : identifiable.getExtensions()) {\n-                extensions.add(extension.getName());\n-            }\n+            identifiable.getExtensions().stream().filter(e -> !e.isEmpty()).forEach(e -> extensions.add(e.getName()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTQzMw=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDExMDI5OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxNzo1M1rOHVYpfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNTo0NzoxN1rOHW1FFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTk4MQ==", "bodyText": "I think we really need to cache the extension list for an identifiable, to not iterate several times over the same list.", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492185981", "createdAt": "2020-09-21T16:17:53Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY0MTY2Ng==", "bodyText": "Indeed, it's done twice when writing the xml: first for the namespaces, then for the extension itslef", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r493641666", "createdAt": "2020-09-23T14:31:29Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTk4MQ=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcwMDM3Mg==", "bodyText": "Edit: It's now computed only once, when creating the NetworkXmlWriterContext", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r493700372", "createdAt": "2020-09-23T15:47:17Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NTk4MQ=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDExMTc4OnYy", "diffSide": "LEFT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjoxODoxN1rOHVYqYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozMDoyNVrOHWCtgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NjIwOQ==", "bodyText": "This is a regression?", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492186209", "createdAt": "2020-09-21T16:18:17Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())\n                     .filter(e -> getExtensionXmlSerializer(options, e.getName()) != null)\n                     .collect(Collectors.toList());\n             if (!extensions.isEmpty()) {\n                 context.getExtensionsWriter().writeStartElement(context.getVersion().getNamespaceURI(), EXTENSION_ELEMENT_NAME);\n                 context.getExtensionsWriter().writeAttribute(ID, context.getAnonymizer().anonymizeString(identifiable.getId()));\n                 for (Extension<? extends Identifiable<?>> extension : extensions) {\n-                    if (options.withExtension(extension.getName())) {\n-                        writeExtension(extension, context);\n-                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwNDM2Ng==", "bodyText": "I don't think so, it's always true because of the filter a few lines above", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492604366", "createdAt": "2020-09-22T09:42:05Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())\n                     .filter(e -> getExtensionXmlSerializer(options, e.getName()) != null)\n                     .collect(Collectors.toList());\n             if (!extensions.isEmpty()) {\n                 context.getExtensionsWriter().writeStartElement(context.getVersion().getNamespaceURI(), EXTENSION_ELEMENT_NAME);\n                 context.getExtensionsWriter().writeAttribute(ID, context.getAnonymizer().anonymizeString(identifiable.getId()));\n                 for (Extension<? extends Identifiable<?>> extension : extensions) {\n-                    if (options.withExtension(extension.getName())) {\n-                        writeExtension(extension, context);\n-                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NjIwOQ=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NTEzNw==", "bodyText": "Good catch", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r492875137", "createdAt": "2020-09-22T16:30:25Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -217,15 +215,14 @@ private static void writeExtensions(Network n, NetworkXmlWriterContext context,\n \n             Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n                     .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> !e.isEmpty())\n                     .filter(e -> getExtensionXmlSerializer(options, e.getName()) != null)\n                     .collect(Collectors.toList());\n             if (!extensions.isEmpty()) {\n                 context.getExtensionsWriter().writeStartElement(context.getVersion().getNamespaceURI(), EXTENSION_ELEMENT_NAME);\n                 context.getExtensionsWriter().writeAttribute(ID, context.getAnonymizer().anonymizeString(identifiable.getId()));\n                 for (Extension<? extends Identifiable<?>> extension : extensions) {\n-                    if (options.withExtension(extension.getName())) {\n-                        writeExtension(extension, context);\n-                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE4NjIwOQ=="}, "originalCommit": {"oid": "58799132ca069718b4b52ad9c0f71b636ad1911b"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzg5MjM4OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoxNzozN1rOHa9cXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoxNzozN1rOHa9cXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAzMTcxMQ==", "bodyText": "I think we should also check here options.withExtension(e.getName()), otherwise we might end up declaring the namespace of an extension which is not exported", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r498031711", "createdAt": "2020-10-01T07:17:37Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -183,16 +166,27 @@ private static void writeExtension(Extension<? extends Identifiable<?>> extensio\n         }\n     }\n \n-    private static ExtensionXmlSerializer getExtensionXmlSerializer(ExportOptions options, String extensionName) {\n+    private static ExtensionXmlSerializer getExtensionXmlSerializer(ExportOptions options, Extension<? extends Identifiable<?>> extension) {\n         ExtensionXmlSerializer extensionXmlSerializer = options.isThrowExceptionIfExtensionNotFound()\n-                ? EXTENSIONS_SUPPLIER.get().findProviderOrThrowException(extensionName)\n-                : EXTENSIONS_SUPPLIER.get().findProvider(extensionName);\n+                ? EXTENSIONS_SUPPLIER.get().findProviderOrThrowException(extension.getName())\n+                : EXTENSIONS_SUPPLIER.get().findProvider(extension.getName());\n         if (extensionXmlSerializer == null) {\n-            LOGGER.warn(\"No Extension XML Serializer for {}\", extensionName);\n+            if (options.isThrowExceptionIfExtensionNotFound()) {\n+                throw new PowsyblException(\"XmlSerializer for\" + extension.getName() + \"not found\");\n+            } else {\n+                LOGGER.warn(\"No Extension XML Serializer for {}\", extension.getName());\n+            }\n+        } else if (!extensionXmlSerializer.isSerializable(extension)) {\n+            return null;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca616d1c3d612de2590d56e1fae619c91e75e87"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzkwNDI2OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoyMToyMFrOHa9jfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoyMToyMFrOHa9jfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAzMzUzMg==", "bodyText": "No need to test it as it is already filtered out above", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r498033532", "createdAt": "2020-10-01T07:21:20Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -209,19 +203,24 @@ private static String getNamespaceUri(ExtensionXmlSerializer extensionXmlSeriali\n                 .orElseGet(extensionXmlSerializer::getNamespaceUri);\n     }\n \n-    private static void writeExtensions(Network n, NetworkXmlWriterContext context) throws XMLStreamException {\n+    private static void writeExtensions(Network n, NetworkXmlWriterContext context, ExportOptions options) throws XMLStreamException {\n \n-        for (Identifiable<?> identifiable : IidmXmlUtil.sorted(n.getIdentifiables(), context.getOptions())) {\n+        for (Identifiable<?> identifiable : IidmXmlUtil.sorted(n.getIdentifiables(), options)) {\n             if (!context.isExportedEquipment(identifiable)) {\n                 continue;\n             }\n \n-            Map<Extension<? extends Identifiable<?>>, ExtensionXmlSerializer> identifExtnSerializers = context.getExtensionXmlSerializers().get(identifiable);\n-            if (!identifExtnSerializers.isEmpty()) {\n+            Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n+                    .filter(e -> options.withExtension(e.getName()))\n+                    .filter(e -> getExtensionXmlSerializer(options, e) != null)\n+                    .collect(Collectors.toList());\n+            if (!extensions.isEmpty()) {\n                 context.getExtensionsWriter().writeStartElement(context.getVersion().getNamespaceURI(), EXTENSION_ELEMENT_NAME);\n                 context.getExtensionsWriter().writeAttribute(ID, context.getAnonymizer().anonymizeString(identifiable.getId()));\n-                for (Extension<? extends Identifiable<?>> extension : IidmXmlUtil.sortedExtensions(identifExtnSerializers.keySet(), context.getOptions())) {\n-                    writeExtension(extension, identifExtnSerializers.get(extension), context);\n+                for (Extension<? extends Identifiable<?>> extension : IidmXmlUtil.sortedExtensions(extensions, options)) {\n+                    if (options.withExtension(extension.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca616d1c3d612de2590d56e1fae619c91e75e87"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzkzMjM0OnYy", "diffSide": "RIGHT", "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoyOToxNVrOHa90FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNzoyOToxNVrOHa90FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAzNzc4MQ==", "bodyText": "This filter can be removed if we check it in getExtensionXmlSerializer", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r498037781", "createdAt": "2020-10-01T07:29:15Z", "author": {"login": "flo-dup"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/NetworkXml.java", "diffHunk": "@@ -209,19 +203,24 @@ private static String getNamespaceUri(ExtensionXmlSerializer extensionXmlSeriali\n                 .orElseGet(extensionXmlSerializer::getNamespaceUri);\n     }\n \n-    private static void writeExtensions(Network n, NetworkXmlWriterContext context) throws XMLStreamException {\n+    private static void writeExtensions(Network n, NetworkXmlWriterContext context, ExportOptions options) throws XMLStreamException {\n \n-        for (Identifiable<?> identifiable : IidmXmlUtil.sorted(n.getIdentifiables(), context.getOptions())) {\n+        for (Identifiable<?> identifiable : IidmXmlUtil.sorted(n.getIdentifiables(), options)) {\n             if (!context.isExportedEquipment(identifiable)) {\n                 continue;\n             }\n \n-            Map<Extension<? extends Identifiable<?>>, ExtensionXmlSerializer> identifExtnSerializers = context.getExtensionXmlSerializers().get(identifiable);\n-            if (!identifExtnSerializers.isEmpty()) {\n+            Collection<? extends Extension<? extends Identifiable<?>>> extensions = identifiable.getExtensions().stream()\n+                    .filter(e -> options.withExtension(e.getName()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca616d1c3d612de2590d56e1fae619c91e75e87"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODM3OTQyOnYy", "diffSide": "RIGHT", "path": "commons/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToyOTozMFrOHbCGkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwOToyOTozMFrOHbCGkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEwODA0OA==", "bodyText": "Isn't mockito-core enough? If yes, use the ${mockito.version}", "url": "https://github.com/powsybl/powsybl-core/pull/1446#discussion_r498108048", "createdAt": "2020-10-01T09:29:30Z", "author": {"login": "miovd"}, "path": "commons/pom.xml", "diffHunk": "@@ -140,6 +140,12 @@\n             <artifactId>xmlunit-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-all</artifactId>\n+            <version>1.10.19</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca616d1c3d612de2590d56e1fae619c91e75e87"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 12, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}