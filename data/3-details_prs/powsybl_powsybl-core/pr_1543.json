{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3ODQ1MDc1", "number": 1543, "title": "Timeseries csv parser", "bodyText": "Please check if the PR fulfills these requirements (please use '[x]' to check the checkboxes, or submit the PR and then click the checkboxes)\n\n The commit message follows our guidelines\n Tests for the changes have been added (for bug fixes / features)\n Docs have been added / updated (for bug fixes / features)\n\nWhat kind of change does this PR introduce? (Bug fix, feature, docs update, ...)\nFeature\nWhat is the current behavior? (You can also link to an open issue here)\nIn the current implementation, TimeSeries only imports CSV files if the data is represented in a regular time series and the file has a version column.\nWhat is the new behavior (if this is a feature change)?\nThe import of CSV files has been modified to make the version column optional, as well as to include irregular series and the possibility of defining the time column with long values.", "createdAt": "2020-11-09T15:30:03Z", "url": "https://github.com/powsybl/powsybl-core/pull/1543", "merged": true, "mergeCommit": {"oid": "2d52087cec43903be26b833d88af5f22cd46b80e"}, "closed": true, "closedAt": "2021-01-19T11:24:18Z", "author": {"login": "marcosmc"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZiHpaAH2gAyNTE3ODQ1MDc1OjkxN2M2ZDA1MzgxOWIwNjYwN2YwNmRjOTExODkwYmI1NzExOWQ4ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxnmAUAFqTU3MTAzMzE0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "917c6d053819b06607f06dc911890bb57119d8fa", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/917c6d053819b06607f06dc911890bb57119d8fa", "committedDate": "2020-11-05T13:10:28Z", "message": "add Regular and Irregular Index\nadd Long and ZonedDataTime options\ncolumn \"version\" is optional\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620ecdf8dd3d5c673cb2fb6b4ebc4937b5faa0e3", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/620ecdf8dd3d5c673cb2fb6b4ebc4937b5faa0e3", "committedDate": "2020-11-06T11:37:34Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1eadf97ae129f7cbc386a891eef26212a6bfc806", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/1eadf97ae129f7cbc386a891eef26212a6bfc806", "committedDate": "2020-11-09T15:22:26Z", "message": "use a single list of times\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20837f8ea843ade1c4d4698559c734c38c21c34a", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/20837f8ea843ade1c4d4698559c734c38c21c34a", "committedDate": "2020-11-09T15:23:47Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cefaa640476826261ba9bb5b3e68600391c8c1c", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/2cefaa640476826261ba9bb5b3e68600391c8c1c", "committedDate": "2020-11-10T08:09:18Z", "message": "add versioned flag and increase coverage\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b4a291b65f27fad257315efbc41965f566e3181", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/5b4a291b65f27fad257315efbc41965f566e3181", "committedDate": "2020-11-10T10:03:37Z", "message": "check if time column has datetime format\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e80ee62f68c204d3fd8fa29fec23f5c7414956d5", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/e80ee62f68c204d3fd8fa29fec23f5c7414956d5", "committedDate": "2020-11-10T15:14:27Z", "message": "Use a variable to indicate the format of the Time column\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef152dec12705b43fbc05ac7469e9c8551faf6f1", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/ef152dec12705b43fbc05ac7469e9c8551faf6f1", "committedDate": "2020-11-11T08:21:12Z", "message": "Increase coverage\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3612608fde07656f2288d3146e0997305578c0ee", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/3612608fde07656f2288d3146e0997305578c0ee", "committedDate": "2020-11-19T10:28:35Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a24558d424d9d403e7f04097ec968179a16cf8ed", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/a24558d424d9d403e7f04097ec968179a16cf8ed", "committedDate": "2020-11-19T10:32:06Z", "message": "time and version columns are not sensitive\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deabb7f148efb129ed9ed7662267cf6855650b09", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/deabb7f148efb129ed9ed7662267cf6855650b09", "committedDate": "2020-11-19T10:58:21Z", "message": "fix test\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDUyMDgw", "url": "https://github.com/powsybl/powsybl-core/pull/1543#pullrequestreview-534452080", "createdAt": "2020-11-19T13:38:10Z", "commit": {"oid": "deabb7f148efb129ed9ed7662267cf6855650b09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "304b66eaa37a15d19bbb8e398b467145c7a8a44e", "author": {"user": {"login": "geofjamg", "name": "Geoffroy Jamgotchian"}}, "url": "https://github.com/powsybl/powsybl-core/commit/304b66eaa37a15d19bbb8e398b467145c7a8a44e", "committedDate": "2020-11-29T21:28:43Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTI0Mzg4", "url": "https://github.com/powsybl/powsybl-core/pull/1543#pullrequestreview-540524388", "createdAt": "2020-11-29T21:31:32Z", "commit": {"oid": "deabb7f148efb129ed9ed7662267cf6855650b09"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMTozMzowNFrOH7nQdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMTozMzo0NVrOH7nSHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI3MTIyMQ==", "bodyText": "This is too much parameters, add a TimeSeries.CsvParserConfig with default values.", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r532271221", "createdAt": "2020-11-29T21:33:04Z", "author": {"login": "geofjamg"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -125,20 +131,32 @@ static StringTimeSeries createString(String name, TimeSeriesIndex index, String.\n     }\n \n     static Map<Integer, List<TimeSeries>> parseCsv(Path file) {\n-        return parseCsv(file, TimeSeriesConstants.DEFAULT_SEPARATOR);\n+        return parseCsv(file, TimeSeriesConstants.DEFAULT_SEPARATOR, true, TimeFormat.DATE_TIME);\n+    }\n+\n+    static Map<Integer, List<TimeSeries>> parseCsv(Path file, boolean versioned, TimeFormat timeFormat) {\n+        return parseCsv(file, TimeSeriesConstants.DEFAULT_SEPARATOR, versioned, timeFormat);\n     }\n \n     static Map<Integer, List<TimeSeries>> parseCsv(String csv, char separator) {\n         try (BufferedReader reader = new BufferedReader(new StringReader(csv))) {\n-            return parseCsv(reader, separator);\n+            return parseCsv(reader, separator, true, TimeFormat.DATE_TIME);\n         } catch (IOException e) {\n             throw new UncheckedIOException(e);\n         }\n     }\n \n-    static Map<Integer, List<TimeSeries>> parseCsv(Path file, char separator) {\n+    static Map<Integer, List<TimeSeries>> parseCsv(String csv, char separator, boolean versioned, TimeFormat timeFormat) {\n+        try (BufferedReader reader = new BufferedReader(new StringReader(csv))) {\n+            return parseCsv(reader, separator, versioned, timeFormat);\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    static Map<Integer, List<TimeSeries>> parseCsv(Path file, char separator, boolean versioned, TimeFormat timeFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "304b66eaa37a15d19bbb8e398b467145c7a8a44e"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI3MTY0Ng==", "bodyText": "static final is useless", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r532271646", "createdAt": "2020-11-29T21:33:45Z", "author": {"login": "geofjamg"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -472,4 +541,6 @@ static void parseChunks(JsonParser parser, TimeSeriesMetadata metadata, List<Tim\n     static List<TimeSeries> parseJson(Path file) {\n         return JsonUtil.parseJson(file, TimeSeries::parseJson);\n     }\n+\n+    static final Logger LOG = LoggerFactory.getLogger(TimeSeries.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "304b66eaa37a15d19bbb8e398b467145c7a8a44e"}, "originalPosition": 338}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48e7256ac0b7fa4f6b6664b1bc908bb6e19b4cfa", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/48e7256ac0b7fa4f6b6664b1bc908bb6e19b4cfa", "committedDate": "2020-12-03T12:10:44Z", "message": "Add CsvParserConfig\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ed7763bd01afc7405ae3e43ac52ae2ce2abe63", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/79ed7763bd01afc7405ae3e43ac52ae2ce2abe63", "committedDate": "2020-12-03T12:11:04Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b1f6c05889b38ba5e46dd94f3953b28ee918d02", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/6b1f6c05889b38ba5e46dd94f3953b28ee918d02", "committedDate": "2020-12-03T12:26:37Z", "message": "remove unused import\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdf6bc64b20afa032ab26b5371806110353c7a8b", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/fdf6bc64b20afa032ab26b5371806110353c7a8b", "committedDate": "2020-12-03T12:29:02Z", "message": "write Timeseries to CSV file\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/4b0e336e5ea619a1e163e7d38782f78e0c6ee52a", "committedDate": "2020-12-03T15:55:02Z", "message": "fix sonar\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDk0NzUz", "url": "https://github.com/powsybl/powsybl-core/pull/1543#pullrequestreview-547094753", "createdAt": "2020-12-08T10:59:44Z", "commit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDo1OTo0NFrOIBTw-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMToxMjozOVrOIBURlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0MzMyMg==", "bodyText": "Should be static?", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538243322", "createdAt": "2020-12-08T10:59:44Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -152,18 +169,48 @@ static String checkString(String token) {\n         return token.isEmpty() ? null : token;\n     }\n \n+    class CsvParserConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0MzQ0NA==", "bodyText": "Should be private and final", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538243444", "createdAt": "2020-12-08T10:59:56Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -152,18 +169,48 @@ static String checkString(String token) {\n         return token.isEmpty() ? null : token;\n     }\n \n+    class CsvParserConfig {\n+        boolean versioned;\n+        TimeFormat timeFormat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NDMwMA==", "bodyText": "Same comment there: you could also fix the declaration of the class and the fields", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538244300", "createdAt": "2020-12-08T11:01:19Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -152,18 +169,48 @@ static String checkString(String token) {\n         return token.isEmpty() ? null : token;\n     }\n \n+    class CsvParserConfig {\n+        boolean versioned;\n+        TimeFormat timeFormat;\n+\n+        CsvParserConfig() {\n+            this(true, TimeFormat.DATE_TIME);\n+        }\n+\n+        public CsvParserConfig(boolean versioned, TimeFormat timeFormat) {\n+            this.versioned = versioned;\n+            this.timeFormat = timeFormat;\n+        }\n+\n+        public boolean versioned() {\n+            return versioned;\n+        }\n+\n+        public TimeFormat timeFormat() {\n+            return timeFormat;\n+        }\n+    }\n+\n     class CsvParsingContext {\n         final List<String> names;\n+        final CsvParserConfig csvParserConfig;\n+        final int fixedColumns;\n \n         final TimeSeriesDataType[] dataTypes;\n         final Object[] values;\n \n-        final List<ZonedDateTime> times = new ArrayList<>();\n+        final List<Long> times = new ArrayList<>();\n \n         TimeSeriesIndex refIndex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NTk1Mg==", "bodyText": "I wonder if the separator should be added in the CsvParserConfig and then pass the config to this method", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538245952", "createdAt": "2020-12-08T11:03:48Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -338,11 +418,19 @@ static CsvParsingContext readCsvHeader(CsvListReader csvListReader, String separ\n         if (!duplicates.isEmpty()) {\n             throw new TimeSeriesException(\"Bad CSV header, there are duplicates in time series names \" + duplicates);\n         }\n-        List<String> names = Arrays.asList(tokens).subList(2, tokens.length);\n-        return new CsvParsingContext(names);\n+        List<String> names = Arrays.asList(tokens).subList(csvParserConfig.versioned() ? 2 : 1, tokens.length);\n+        return new CsvParsingContext(names, csvParserConfig);\n+    }\n+\n+    static void checkCsvHeader(String separatorStr, boolean versioned, String[] tokens) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 332}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NjMxMA==", "bodyText": "I wonder if the separator should be added in the config and the pass only the config to this method", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538246310", "createdAt": "2020-12-08T11:04:17Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -319,15 +400,14 @@ static void readCsvValues(CsvListReader reader, CsvParsingContext context,\n         timeSeriesPerVersion.put(currentVersion, context.createTimeSeries());\n     }\n \n-    static CsvParsingContext readCsvHeader(CsvListReader csvListReader, String separatorStr) throws IOException {\n+    static CsvParsingContext readCsvHeader(CsvListReader csvListReader, String separatorStr, CsvParserConfig csvParserConfig) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 308}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NzA0OA==", "bodyText": "Is an empty timeseries totally dumb? Maybe it could be useful for the timeline (see my comment about null TS vs empty TS in #1539)", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538247048", "createdAt": "2020-12-08T11:05:22Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -288,11 +340,40 @@ private Duration checkRegularSpacing() {\n                     StringDataChunk chunk = new UncompressedStringDataChunk(0, stringValues.toArray(new String[0])).tryToCompress();\n                     timeSeriesList.add(new StringTimeSeries(metadata, chunk));\n                 } else {\n-                    throw assertDataType(dataTypes[i - 2]);\n+                    throw assertDataType(dataTypes[i - fixedColumns]);\n                 }\n             }\n             return timeSeriesList;\n         }\n+\n+        private TimeSeriesIndex getTimeSeriesIndex() {\n+            Long spacing = checkRegularSpacing();\n+            if (spacing != Long.MIN_VALUE) {\n+                return new RegularTimeSeriesIndex(times.get(0), times.get(times.size() - 1), spacing);\n+            } else {\n+                return new IrregularTimeSeriesIndex(times.stream().mapToLong(l -> l).toArray());\n+            }\n+        }\n+\n+        private long checkRegularSpacing() {\n+            if (times.size() < 2) {\n+                throw new TimeSeriesException(\"At least 2 rows are expected\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 269}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NzQ4OQ==", "bodyText": "Add a default case that throws an AssertionError with the unexpected timeFormat", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538247489", "createdAt": "2020-12-08T11:06:04Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -190,42 +237,66 @@ private TDoubleArrayList createDoubleValues() {\n             return stringValues;\n         }\n \n+        int getVersion(List<String> tokens) {\n+            return csvParserConfig.versioned() ? Integer.parseInt(tokens.get(1)) : 0;\n+        }\n+\n+        int timesSize() {\n+            return times.size();\n+        }\n+\n+        int expectedTokens() {\n+            return names.size() + fixedColumns;\n+        }\n+\n         void parseToken(int i, String token) {\n-            if (dataTypes[i - 2] == null) {\n+            if (dataTypes[i - fixedColumns] == null) {\n                 // test double parsing, in case of error we consider it a string time series\n                 if (Doubles.tryParse(token) != null) {\n-                    dataTypes[i - 2] = TimeSeriesDataType.DOUBLE;\n+                    dataTypes[i - fixedColumns] = TimeSeriesDataType.DOUBLE;\n                     TDoubleArrayList doubleValues = createDoubleValues();\n                     doubleValues.add(parseDouble(token));\n-                    values[i - 2] = doubleValues;\n+                    values[i - fixedColumns] = doubleValues;\n                 } else {\n-                    dataTypes[i - 2] = TimeSeriesDataType.STRING;\n+                    dataTypes[i - fixedColumns] = TimeSeriesDataType.STRING;\n                     List<String> stringValues = createStringValues();\n                     stringValues.add(checkString(token));\n-                    values[i - 2] = stringValues;\n+                    values[i - fixedColumns] = stringValues;\n                 }\n             } else {\n-                if (dataTypes[i - 2] == TimeSeriesDataType.DOUBLE) {\n-                    ((TDoubleArrayList) values[i - 2]).add(parseDouble(token));\n-                } else if (dataTypes[i - 2] == TimeSeriesDataType.STRING) {\n-                    ((List<String>) values[i - 2]).add(checkString(token));\n+                if (dataTypes[i - fixedColumns] == TimeSeriesDataType.DOUBLE) {\n+                    ((TDoubleArrayList) values[i - fixedColumns]).add(parseDouble(token));\n+                } else if (dataTypes[i - fixedColumns] == TimeSeriesDataType.STRING) {\n+                    ((List<String>) values[i - fixedColumns]).add(checkString(token));\n                 } else {\n-                    throw assertDataType(dataTypes[i - 2]);\n+                    throw assertDataType(dataTypes[i - fixedColumns]);\n                 }\n             }\n         }\n \n         void parseLine(List<String> tokens) {\n-            for (int i = 2; i < tokens.size(); i++) {\n+            for (int i = fixedColumns; i < tokens.size(); i++) {\n                 String token = tokens.get(i) != null ? tokens.get(i).trim() : \"\";\n                 parseToken(i, token);\n             }\n-            // empty last cell case\n-            if (tokens.size() == names.size() + 1) {\n-                parseToken(tokens.size(), \"\");\n-            }\n \n-            times.add(ZonedDateTime.parse(tokens.get(0)));\n+            parseTokenTime(tokens);\n+        }\n+\n+        void parseTokenTime(List<String> tokens) {\n+            switch (csvParserConfig.timeFormat()) {\n+                case DATE_TIME:\n+                    times.add(ZonedDateTime.parse(tokens.get(0)).toInstant().toEpochMilli());\n+                    break;\n+                case FRACTIONS_OF_SECOND:\n+                    Double time = Double.parseDouble(tokens.get(0)) * 1000;\n+                    times.add(time.longValue());\n+                    break;\n+                case MILLIS:\n+                    Double millis = Double.parseDouble(tokens.get(0));\n+                    times.add(millis.longValue());\n+                    break;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 197}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0ODg2MA==", "bodyText": "What did you have in mind by replacing the equality by this epsilon? Maybe you should also introduce a constant instead of a magic number. What is the unit of this value?", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538248860", "createdAt": "2020-12-08T11:08:16Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeries.java", "diffHunk": "@@ -288,11 +340,40 @@ private Duration checkRegularSpacing() {\n                     StringDataChunk chunk = new UncompressedStringDataChunk(0, stringValues.toArray(new String[0])).tryToCompress();\n                     timeSeriesList.add(new StringTimeSeries(metadata, chunk));\n                 } else {\n-                    throw assertDataType(dataTypes[i - 2]);\n+                    throw assertDataType(dataTypes[i - fixedColumns]);\n                 }\n             }\n             return timeSeriesList;\n         }\n+\n+        private TimeSeriesIndex getTimeSeriesIndex() {\n+            Long spacing = checkRegularSpacing();\n+            if (spacing != Long.MIN_VALUE) {\n+                return new RegularTimeSeriesIndex(times.get(0), times.get(times.size() - 1), spacing);\n+            } else {\n+                return new IrregularTimeSeriesIndex(times.stream().mapToLong(l -> l).toArray());\n+            }\n+        }\n+\n+        private long checkRegularSpacing() {\n+            if (times.size() < 2) {\n+                throw new TimeSeriesException(\"At least 2 rows are expected\");\n+            }\n+\n+            long spacing = Long.MIN_VALUE;\n+            for (int i = 1; i < times.size(); i++) {\n+                long duration = times.get(i) - times.get(i - 1);\n+                if (spacing == Long.MIN_VALUE) {\n+                    spacing = duration;\n+                } else {\n+                    if (1e-4 < Math.abs(duration - spacing)) {\n+                        return Long.MIN_VALUE;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 279}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0OTgxMg==", "bodyText": "I wonder if the flush should be moved in the writeCsv() method to avoid user to forget it. What do you think?", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538249812", "createdAt": "2020-12-08T11:09:40Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeriesTable.java", "diffHunk": "@@ -534,15 +537,33 @@ private static BufferedWriter createWriter(Path file) throws IOException {\n \n     public void writeCsv(Path file) {\n         try (BufferedWriter writer = createWriter(file)) {\n-            writeCsv(writer, TimeSeriesConstants.DEFAULT_SEPARATOR, ZoneId.systemDefault());\n+            writeCsv(writer, TimeSeriesConstants.DEFAULT_SEPARATOR, ZoneId.systemDefault(), new CsvParserConfig());\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    public void writeCsv(Path file, CsvParserConfig csvParserConfig) {\n+        try (BufferedWriter writer = createWriter(file)) {\n+            writeCsv(writer, TimeSeriesConstants.DEFAULT_SEPARATOR, ZoneId.systemDefault(), csvParserConfig);\n         } catch (IOException e) {\n             throw new UncheckedIOException(e);\n         }\n     }\n \n     public String toCsvString(char separator, ZoneId zoneId) {\n         try (StringWriter writer = new StringWriter()) {\n-            writeCsv(writer, separator, zoneId);\n+            writeCsv(writer, separator, zoneId, new CsvParserConfig());\n+            writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI1MDI2Nw==", "bodyText": "Add a default case that throws an exception", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538250267", "createdAt": "2020-12-08T11:10:25Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeriesTable.java", "diffHunk": "@@ -640,14 +679,32 @@ private void dumpCache(Writer writer, CsvConfig config, int point, CsvCache cach\n         }\n     }\n \n-    public void writeCsv(Writer writer, char separator, ZoneId zoneId) {\n+    private void writeTime(Writer writer, CsvConfig config, int point, int cachedPoint) throws IOException {\n+        long time = tableIndex.getTimeAt(point + cachedPoint);\n+        switch (config.getTimeFormat()) {\n+            case DATE_TIME:\n+                ZonedDateTime dateTime = ZonedDateTime.ofInstant(Instant.ofEpochMilli(time), ZoneId.systemDefault());\n+                writer.write(dateTime.format(config.dateTimeFormatter));\n+                break;\n+            case FRACTIONS_OF_SECOND:\n+                Long longTime = new Long(time);\n+                double convertedTime = longTime.doubleValue();\n+                writer.write(Double.toString(convertedTime / 1000));\n+                break;\n+            case MILLIS:\n+                writer.write(Long.toString(time));\n+                break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI1MTY3MA==", "bodyText": "Is this code equivalent to:\nwriter.write(Double.toString(time / 1000.0));\n\nI think that time / 1000.0 will be automatically cast into a double (thanks to the .0)", "url": "https://github.com/powsybl/powsybl-core/pull/1543#discussion_r538251670", "createdAt": "2020-12-08T11:12:39Z", "author": {"login": "mathbagu"}, "path": "time-series/time-series-api/src/main/java/com/powsybl/timeseries/TimeSeriesTable.java", "diffHunk": "@@ -640,14 +679,32 @@ private void dumpCache(Writer writer, CsvConfig config, int point, CsvCache cach\n         }\n     }\n \n-    public void writeCsv(Writer writer, char separator, ZoneId zoneId) {\n+    private void writeTime(Writer writer, CsvConfig config, int point, int cachedPoint) throws IOException {\n+        long time = tableIndex.getTimeAt(point + cachedPoint);\n+        switch (config.getTimeFormat()) {\n+            case DATE_TIME:\n+                ZonedDateTime dateTime = ZonedDateTime.ofInstant(Instant.ofEpochMilli(time), ZoneId.systemDefault());\n+                writer.write(dateTime.format(config.dateTimeFormatter));\n+                break;\n+            case FRACTIONS_OF_SECOND:\n+                Long longTime = new Long(time);\n+                double convertedTime = longTime.doubleValue();\n+                writer.write(Double.toString(convertedTime / 1000));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0e336e5ea619a1e163e7d38782f78e0c6ee52a"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd320dc51d5c8ebf30d2e8f11b7b922eb4479ca", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/2bd320dc51d5c8ebf30d2e8f11b7b922eb4479ca", "committedDate": "2020-12-14T08:34:11Z", "message": "Fix PR\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe398c313f82d98e0eda2d64560f0fef90648ff", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/8fe398c313f82d98e0eda2d64560f0fef90648ff", "committedDate": "2020-12-14T08:34:32Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d5ccb9c552ca86eba8e0ef83c9afa4f96eaef4", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/26d5ccb9c552ca86eba8e0ef83c9afa4f96eaef4", "committedDate": "2020-12-15T10:08:06Z", "message": "Join two CSV configuration classes into a single class\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f0e9fc6f34f1460502f91a41742b3a97cd7c678", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/7f0e9fc6f34f1460502f91a41742b3a97cd7c678", "committedDate": "2020-12-15T10:09:26Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0afa0088a62a730b029ae9b7edf1fc365b5f5389", "author": {"user": {"login": "marcosmc", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/0afa0088a62a730b029ae9b7edf1fc365b5f5389", "committedDate": "2021-01-18T15:41:28Z", "message": "Merge branch 'master' into timeseries-csv-parser\n\nSigned-off-by: Marcos de Miguel <demiguelm@aia.es>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d4d0b931fda1764064df45a85d64a2ca892b950", "author": {"user": {"login": "geofjamg", "name": "Geoffroy Jamgotchian"}}, "url": "https://github.com/powsybl/powsybl-core/commit/9d4d0b931fda1764064df45a85d64a2ca892b950", "committedDate": "2021-01-18T16:17:30Z", "message": "Merge branch 'master' into timeseries-csv-parser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcxMDMzMTQ3", "url": "https://github.com/powsybl/powsybl-core/pull/1543#pullrequestreview-571033147", "createdAt": "2021-01-19T09:07:21Z", "commit": {"oid": "9d4d0b931fda1764064df45a85d64a2ca892b950"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4076, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}