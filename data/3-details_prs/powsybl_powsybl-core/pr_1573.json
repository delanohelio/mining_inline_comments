{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NjgyOTY2", "number": 1573, "title": "Add alphabetical sort criterion to determine the main node in order to have name invariance of a substation", "bodyText": "Please check if the PR fulfills these requirements (please use '[x]' to check the checkboxes, or submit the PR and then click the checkboxes)\n\n The commit message follows our guidelines\n Tests for the changes have been added (for bug fixes / features)\n Docs have been added / updated (for bug fixes / features)\n\nDoes this PR already have an issue describing the problem ? If so, link to this issue using '#XXX' and skip the rest\nNo\nWhat kind of change does this PR introduce? (Bug fix, feature, docs update, ...)\nFeature\nWhat is the current behavior? (You can also link to an open issue here)\nThe name of a substation is  determined by the main node (highest voltage level and the lowest busbar number).\nWhen there are several candidate nodes it is the first of the list and this list is not invariant.\nWhat is the new behavior (if this is a feature change)?\nWhen there are several candidate nodes for a main node in a substation, it is always the lexicographically greater that will be chosen.\nDoes this PR introduce a breaking change or deprecate an API? If yes, check the following:\nNo", "createdAt": "2020-12-14T17:29:04Z", "url": "https://github.com/powsybl/powsybl-core/pull/1573", "merged": true, "mergeCommit": {"oid": "0d9d6140717445805f5fe066314062ba19467ed9"}, "closed": true, "closedAt": "2021-01-08T15:58:56Z", "author": {"login": "SlimaneAmar"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmJP0hgH2gAyNTM5NjgyOTY2OjE0NTg4MWRjZjNiYmUwNjNkNTdmZWRmMTU2Yjg0NmU0ZDU0Y2Q3MmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt1QWJgH2gAyNTM5NjgyOTY2OmQyOWVmNGRhNTNiZDdhNmViZGJkNTNkNjlhYTAxMmY5YTdjODRmYjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "145881dcf3bbe063d57fedf156b846e4d54cd72e", "author": {"user": {"login": "SlimaneAmar", "name": "Slimane Amar"}}, "url": "https://github.com/powsybl/powsybl-core/commit/145881dcf3bbe063d57fedf156b846e4d54cd72e", "committedDate": "2020-12-14T17:32:47Z", "message": "Add alphabetical sort criterion to determine the main node in order to have name invariance of a substation\n\nSigned-off-by: Slimane AMAR <slimane.amar@rte-france.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a72237b536cbda2be50157c154cd849bb1a7598", "author": {"user": {"login": "SlimaneAmar", "name": "Slimane Amar"}}, "url": "https://github.com/powsybl/powsybl-core/commit/3a72237b536cbda2be50157c154cd849bb1a7598", "committedDate": "2020-12-14T17:15:05Z", "message": "Add alphabetical sort criterion to determine the main node in order to have name invariance of a substation\n\nSigned-off-by: Slimane AMAR <slimane.amar@rte-france.com>"}, "afterCommit": {"oid": "145881dcf3bbe063d57fedf156b846e4d54cd72e", "author": {"user": {"login": "SlimaneAmar", "name": "Slimane Amar"}}, "url": "https://github.com/powsybl/powsybl-core/commit/145881dcf3bbe063d57fedf156b846e4d54cd72e", "committedDate": "2020-12-14T17:32:47Z", "message": "Add alphabetical sort criterion to determine the main node in order to have name invariance of a substation\n\nSigned-off-by: Slimane AMAR <slimane.amar@rte-france.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODA0Mjk5", "url": "https://github.com/powsybl/powsybl-core/pull/1573#pullrequestreview-551804299", "createdAt": "2020-12-14T19:03:18Z", "commit": {"oid": "145881dcf3bbe063d57fedf156b846e4d54cd72e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowMzoxOFrOIFg-5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNzoyNFrOIFjTXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1NDE4Mw==", "bodyText": "Use IntStream.range(0, 100) instead of IntStream.iterate(0, i -> i + 1).limit(100)", "url": "https://github.com/powsybl/powsybl-core/pull/1573#discussion_r542654183", "createdAt": "2020-12-14T19:03:18Z", "author": {"login": "mathbagu"}, "path": "ucte/ucte-converter/src/test/java/com/powsybl/ucte/converter/UcteImporterTest.java", "diffHunk": "@@ -176,5 +179,16 @@ public void testVoltageRegulatingXnode() {\n         assertEquals(1.0, dl.getGeneration().getReactiveLimits().getMaxQ(dl.getGeneration().getTargetP()), 0.01);\n         assertEquals(-1.0, dl.getGeneration().getReactiveLimits().getMinQ(dl.getGeneration().getTargetP()), 0.01);\n     }\n+\n+    @Test\n+    public void substationNameInvariance() {\n+        ResourceDataSource dataSource = new ResourceDataSource(\"VLsCreationIssue\", new ResourceSet(\"/\", \"VLsCreationIssue.uct\"));\n+\n+        IntStream.iterate(0, i -> i + 1).limit(100).forEach(i -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145881dcf3bbe063d57fedf156b846e4d54cd72e"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MjE4OA==", "bodyText": "Looking to the code, this algorithm doesn't return the first node in the alphabetic order. I change your unit test like this:\n##C 2007.05.01\nTest case for UCTE import issue in PowSyBl core package\nWhen multiples VLs with the same nominal voltage are present in a substation, only one is created\ncontact : slimane.amar@rte-france.com\n\n##N\n##ZFR\nF1TEST11 1TEST11 1    0 0        0.15546 72.7296 0.00000 0.00000\nF1TEST21 1TEST21 1    0 0        0.15546 72.7296 0.00000 0.00000\nF1TEST2A 1TEST2A 1    0 0        0.15546 72.7296 0.00000 0.00000\nFTESTA11 TESTAP7      0 0        0.00000 0.00000 0.00000 0.00000\nFTESTU11 TESTUP7 1-2  0 0        0.00000 0.00000 0.00000 0.00000\n\n##T\nF1TEST11 FTESTU11 1 0 380.0 380.0 1186. 0.1280 44.280 0.000000 0.0000   1803 TESTUY771\nFTESTA11 FTESTU11 1 0 380.0 380.0 1186. 0.1280 44.280 0.000000 0.0000   1803 TESTAY771\n\nWith your proposal, it returns FTESTU11 but the first node in alphabetical order is F1TEST11. I think you have to fix the implementation to be simpler to understand or to explain what you expect.\nThis is my proposal:\n\nfirst, extract this lambda to a well named method and replace the sorted + findfirst by a min()\nthen change the implementation of the lambda:\n\nPrefer the real node rather than an XNODE (line 196-201 of the current implementation)\nPrefer the highest voltage level (line 178)\nPrefer the first busbar number: numbers before letters (line 181 has to be fixed)\nPrefer the first nodeCode : use the alphabetical order", "url": "https://github.com/powsybl/powsybl-core/pull/1573#discussion_r542692188", "createdAt": "2020-12-14T19:37:24Z", "author": {"login": "mathbagu"}, "path": "ucte/ucte-network/src/main/java/com/powsybl/ucte/network/ext/UcteNetworkExt.java", "diffHunk": "@@ -201,7 +200,8 @@ private void updateSubstation() {\n                                     nodeCode2.getUcteCountryCode() == UcteCountryCode.XX) {\n                                 return -1;\n                             } else {\n-                                return compareVoltageLevelThenBusbar(nodeCode1, nodeCode2);\n+                                int c = compareVoltageLevelThenBusbar(nodeCode1, nodeCode2);\n+                                return (c != 0) ? c : nodeCode2.compareTo(nodeCode1); // Alphabetical order to always have the same main node (invariant)\n                             }\n                         })\n                         .findFirst()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145881dcf3bbe063d57fedf156b846e4d54cd72e"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce166802644c0a9c6cd687c5c9fe0aeb73ea2d8d", "author": {"user": {"login": "mathbagu", "name": "Mathieu BAGUE"}}, "url": "https://github.com/powsybl/powsybl-core/commit/ce166802644c0a9c6cd687c5c9fe0aeb73ea2d8d", "committedDate": "2020-12-14T19:52:50Z", "message": "Fix implementation\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e5214bd5e41d1a721a9bf0fb886870ced198ff", "author": {"user": {"login": "mathbagu", "name": "Mathieu BAGUE"}}, "url": "https://github.com/powsybl/powsybl-core/commit/70e5214bd5e41d1a721a9bf0fb886870ced198ff", "committedDate": "2020-12-17T12:24:39Z", "message": "Fix implementation\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fc56ba1f8e8b95186dedc5f631ef56ed3b4d95f", "author": {"user": {"login": "mathbagu", "name": "Mathieu BAGUE"}}, "url": "https://github.com/powsybl/powsybl-core/commit/9fc56ba1f8e8b95186dedc5f631ef56ed3b4d95f", "committedDate": "2020-12-17T12:26:10Z", "message": "Merge branch 'master' into substation_name_invariance_for_ucte_import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "759eaf16fa8ebb6433693d04f4006446f34d6707", "author": {"user": {"login": "SlimaneAmar", "name": "Slimane Amar"}}, "url": "https://github.com/powsybl/powsybl-core/commit/759eaf16fa8ebb6433693d04f4006446f34d6707", "committedDate": "2020-12-18T13:27:18Z", "message": "Rename the test file (#1573)\n\nSigned-off-by: Slimane AMAR <slimane.amar@rte-france.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNTQzMjg0", "url": "https://github.com/powsybl/powsybl-core/pull/1573#pullrequestreview-563543284", "createdAt": "2021-01-07T14:45:52Z", "commit": {"oid": "759eaf16fa8ebb6433693d04f4006446f34d6707"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29ef4da53bd7a6ebdbd53d69aa012f9a7c84fb1", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/d29ef4da53bd7a6ebdbd53d69aa012f9a7c84fb1", "committedDate": "2021-01-07T14:46:39Z", "message": "Merge branch 'master' into substation_name_invariance_for_ucte_import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4092, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}