{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NjI5NzU4", "number": 1535, "title": "Allows to log error rather than throwing exceptions when there is an IIDM-XML version incompatibility during export", "bodyText": "Please check if the PR fulfills these requirements (please use '[x]' to check the checkboxes, or submit the PR and then click the checkboxes)\n\n The commit message follows our guidelines\n Tests for the changes have been added (for bug fixes / features)\n Docs have been added / updated (for bug fixes / features)\n\nDoes this PR already have an issue describing the problem ? If so, link to this issue using '#XXX' and skip the rest\nNo\nWhat kind of change does this PR introduce? (Bug fix, feature, docs update, ...)\nFeature\nWhat is the current behavior? (You can also link to an open issue here)\nWhen a new equipment (non linear shunt or dangling line's generation) is present in a network, backward XIIDM export is not possible: an exception is thrown.\nWhat is the new behavior (if this is a feature change)?\nWhen a new equipment (non linear shunt or dangling line's generation) is present in a network, an export option can be set up in order not to throw an exception but only to log an error. This equipment is exported in best effort (dangling line's generation is reported on p0 and q0 and non linear shunt are exported as shunt with only one current section)\nDoes this PR introduce a breaking change or deprecate an API? If yes, check the following:\nNo\nOther information:\nLinked documentation PR: powsybl/powsybl.github.io#167\n(if any of the questions/checkboxes don't apply, please delete them entirely)", "createdAt": "2020-11-03T10:19:33Z", "url": "https://github.com/powsybl/powsybl-core/pull/1535", "merged": true, "mergeCommit": {"oid": "3e9b019502307094de34c1b2675aaf4fc97370ad"}, "closed": true, "closedAt": "2020-11-16T10:15:41Z", "author": {"login": "MioRtia"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY2TjfgH2gAyNTE0NjI5NzU4Ojk0OGM2ZTkwY2RkMGEyYjg1ZGFkZTYxMWViMWRlNGI0M2JlMmY3MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddB5GpgFqTUzMTE2NDk3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "948c6e90cdd0a2b85dade611eb1de4b43be2f712", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/948c6e90cdd0a2b85dade611eb1de4b43be2f712", "committedDate": "2020-11-03T10:07:39Z", "message": "Add in ExportOptions the possibility to chose the behavior when there is an IIDM version incompatibility\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b832ea556f7c600b1b23d5d97367f7fc6364f5c2", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/b832ea556f7c600b1b23d5d97367f7fc6364f5c2", "committedDate": "2020-11-03T10:18:29Z", "message": "Add the option in XMLExporter\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a2638f6b3a4f595a7f24db275965c07c808aff", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/93a2638f6b3a4f595a7f24db275965c07c808aff", "committedDate": "2020-11-03T13:11:14Z", "message": "Fix code smells\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77075d7b534e45d4666056523cfeac6986b5c612", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/77075d7b534e45d4666056523cfeac6986b5c612", "committedDate": "2020-11-03T13:24:25Z", "message": "Refactoring\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTMzNzM4", "url": "https://github.com/powsybl/powsybl-core/pull/1535#pullrequestreview-526133738", "createdAt": "2020-11-09T10:51:36Z", "commit": {"oid": "77075d7b534e45d4666056523cfeac6986b5c612"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDo1MTozNlrOHvpCBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMDo1Mzo1NFrOHvpHQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxNzM4Mg==", "bodyText": "I'm not totally sure this is OK. The new shunt API wasn't available before XIIDM v1.3. If the model is non-linear, should we throw an exception instead? From my point of view, it's not equivalent and should not be supported", "url": "https://github.com/powsybl/powsybl-core/pull/1535#discussion_r519717382", "createdAt": "2020-11-09T10:51:36Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -51,8 +51,11 @@ protected void writeRootElementAttributes(ShuntCompensator sc, VoltageLevel vl,\n             IidmXmlUtil.assertMinimumVersion(getRootElementName(), SHUNT_NON_LINEAR_MODEL, IidmXmlUtil.ErrorMessage.NOT_SUPPORTED, IidmXmlVersion.V_1_3, context);\n         }\n         IidmXmlUtil.runUntilMaximumVersion(IidmXmlVersion.V_1_2, context, () -> {\n-            XmlUtil.writeDouble(B_PER_SECTION, sc.getModel(ShuntCompensatorLinearModel.class).getBPerSection(), context.getWriter());\n-            context.getWriter().writeAttribute(MAXIMUM_SECTION_COUNT, Integer.toString(sc.getMaximumSectionCount()));\n+            ShuntCompensatorModel model = sc.getModel();\n+            double bPerSection = model instanceof ShuntCompensatorLinearModel ? ((ShuntCompensatorLinearModel) model).getBPerSection() : sc.getB();\n+            XmlUtil.writeDouble(B_PER_SECTION, bPerSection, context.getWriter());\n+            int maximumSectionCount = model instanceof ShuntCompensatorLinearModel ? sc.getMaximumSectionCount() : 1;\n+            context.getWriter().writeAttribute(MAXIMUM_SECTION_COUNT, Integer.toString(maximumSectionCount));\n             context.getWriter().writeAttribute(\"currentSectionCount\", Integer.toString(sc.getSectionCount()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77075d7b534e45d4666056523cfeac6986b5c612"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxODcyMQ==", "bodyText": "If we encounter a non linear model, and should export it in a previous version, we silently ignore it. Should we throw an exception? The exported network is not equivalent then.", "url": "https://github.com/powsybl/powsybl-core/pull/1535#discussion_r519718721", "createdAt": "2020-11-09T10:53:54Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/ShuntXml.java", "diffHunk": "@@ -81,13 +84,15 @@ private static void writeModel(ShuntCompensator sc, NetworkXmlWriterContext cont\n             XmlUtil.writeDouble(\"gPerSection\", sc.getModel(ShuntCompensatorLinearModel.class).getGPerSection(), context.getWriter());\n             context.getWriter().writeAttribute(MAXIMUM_SECTION_COUNT, Integer.toString(sc.getMaximumSectionCount()));\n         } else if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-            context.getWriter().writeStartElement(context.getVersion().getNamespaceURI(), SHUNT_NON_LINEAR_MODEL);\n-            for (ShuntCompensatorNonLinearModel.Section s : sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections()) {\n-                context.getWriter().writeEmptyElement(context.getVersion().getNamespaceURI(), \"section\");\n-                XmlUtil.writeDouble(\"b\", s.getB(), context.getWriter());\n-                XmlUtil.writeDouble(\"g\", s.getG(), context.getWriter());\n-            }\n-            context.getWriter().writeEndElement();\n+            IidmXmlUtil.runFromMinimumVersion(IidmXmlVersion.V_1_3, context, () -> {\n+                context.getWriter().writeStartElement(context.getVersion().getNamespaceURI(), SHUNT_NON_LINEAR_MODEL);\n+                for (ShuntCompensatorNonLinearModel.Section s : sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections()) {\n+                    context.getWriter().writeEmptyElement(context.getVersion().getNamespaceURI(), \"section\");\n+                    XmlUtil.writeDouble(\"b\", s.getB(), context.getWriter());\n+                    XmlUtil.writeDouble(\"g\", s.getG(), context.getWriter());\n+                }\n+                context.getWriter().writeEndElement();\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77075d7b534e45d4666056523cfeac6986b5c612"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "859422b4d4a8d34d589cf05a68bf9a0dd0947bbf", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/859422b4d4a8d34d589cf05a68bf9a0dd0947bbf", "committedDate": "2020-11-09T16:05:12Z", "message": "Add generation fields in backward best effort\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c1b74a3216b39f174aedf88f53816d60f9cb686", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/9c1b74a3216b39f174aedf88f53816d60f9cb686", "committedDate": "2020-11-09T16:14:35Z", "message": "Correction: current section for non linear shunt is always 1\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79696009e33b9e2ca1d7a69e266449669275d31f", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/79696009e33b9e2ca1d7a69e266449669275d31f", "committedDate": "2020-11-10T10:28:22Z", "message": "Add tests and javadoc\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f43cae429963fb635ea0acd8ceb7735cbfc110", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/57f43cae429963fb635ea0acd8ceb7735cbfc110", "committedDate": "2020-11-10T11:04:58Z", "message": "Add test\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTQxNjQ5", "url": "https://github.com/powsybl/powsybl-core/pull/1535#pullrequestreview-531141649", "createdAt": "2020-11-16T09:23:21Z", "commit": {"oid": "57f43cae429963fb635ea0acd8ceb7735cbfc110"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToyMzoyMVrOHzvW7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToyMzoyMVrOHzvW7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAxNTM0Mg==", "bodyText": "There is no good reason to create a supplier if you always call the get() method. I would replace it by a simple string and check if ERROR level is enabled", "url": "https://github.com/powsybl/powsybl-core/pull/1535#discussion_r524015342", "createdAt": "2020-11-16T09:23:21Z", "author": {"login": "mathbagu"}, "path": "iidm/iidm-xml-converter/src/main/java/com/powsybl/iidm/xml/util/IidmXmlUtil.java", "diffHunk": "@@ -57,92 +66,196 @@ default void run() {\n         }\n     }\n \n+    private static String message(String elementName, ErrorMessage type, IidmXmlVersion version, IidmXmlVersion contextVersion, String reason) {\n+        return elementName + \" is \" + type.message + \" for IIDM-XML version \" + contextVersion.toString(\".\") + \". \" + reason + version.toString(\".\");\n+    }\n+\n     private static PowsyblException createException(String rootElementName, String elementName, ErrorMessage type, IidmXmlVersion version, IidmXmlVersion contextVersion, String reason) {\n         return createException(rootElementName + \".\" + elementName, type, version, contextVersion, reason);\n     }\n \n     private static PowsyblException createException(String elementName, ErrorMessage type, IidmXmlVersion version, IidmXmlVersion contextVersion, String reason) {\n-        return new PowsyblException(elementName + \" is \" + type.message + \" for IIDM-XML version \" + contextVersion.toString(\".\") + \". \" + reason + version.toString(\".\"));\n+        return new PowsyblException(message(elementName, type, version, contextVersion, reason));\n+    }\n+\n+    private static void createExceptionOrLogError(String rootElementName, String elementName, ErrorMessage type, IidmXmlVersion refVersion, String reason, NetworkXmlWriterContext context) {\n+        createExceptionOrLogError(rootElementName + \".\" + elementName, type, refVersion, reason, context);\n+    }\n+\n+    private static void createExceptionOrLogError(String elementName, ErrorMessage type, IidmXmlVersion refVersion, String reason, NetworkXmlWriterContext context) {\n+        if (context.getOptions().getIidmVersionIncompatibilityBehavior() == ExportOptions.IidmVersionIncompatibilityBehavior.THROW_EXCEPTION) {\n+            throw createException(elementName, type, refVersion, context.getVersion(), reason);\n+        } else if (context.getOptions().getIidmVersionIncompatibilityBehavior() == ExportOptions.IidmVersionIncompatibilityBehavior.LOG_ERROR) {\n+            Supplier<String> message = () -> message(elementName, type, refVersion, context.getVersion(), reason);\n+            LOGGER.error(message.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f43cae429963fb635ea0acd8ceb7735cbfc110"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc340a15fc1cb35145e268ce54908762f23d789d", "author": {"user": {"login": "MioRtia", "name": null}}, "url": "https://github.com/powsybl/powsybl-core/commit/fc340a15fc1cb35145e268ce54908762f23d789d", "committedDate": "2020-11-16T09:50:33Z", "message": "Reviewer's comment: not using a supplier, only check error level is enabled\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c1945d4cb54bb4950154ee58a117e1b9e2569c1", "author": {"user": {"login": "mathbagu", "name": "Mathieu BAGUE"}}, "url": "https://github.com/powsybl/powsybl-core/commit/5c1945d4cb54bb4950154ee58a117e1b9e2569c1", "committedDate": "2020-11-16T09:53:03Z", "message": "Merge branch 'master' into version_compatibility_error_level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTY0OTc4", "url": "https://github.com/powsybl/powsybl-core/pull/1535#pullrequestreview-531164978", "createdAt": "2020-11-16T09:53:19Z", "commit": {"oid": "5c1945d4cb54bb4950154ee58a117e1b9e2569c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4067, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}