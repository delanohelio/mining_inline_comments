{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MTA5MzI4", "number": 5481, "title": "NPE protection on WebInfConfiguration.deconfigure()", "bodyText": "NPE protection on IO.delete(File)\nFail in jetty-maven-plugin if unable to create temp directory.\nNPE protection in WebInfConfiguration.deconfigure()\nRemoving Temp dir forced deletion in WebInfConfiguration.configureTempDirectory()", "createdAt": "2020-10-20T21:32:57Z", "url": "https://github.com/eclipse/jetty.project/pull/5481", "merged": true, "mergeCommit": {"oid": "f4c55c65e07e7fd810a96e4137b7adfe7e9829eb"}, "closed": true, "closedAt": "2020-10-20T22:27:34Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUfp86AH2gAyNTA3MTA5MzI4OjBlOThjMzcwZmQwMDQ5MmRjNjk3M2UwMTdiOWI3Y2MzMzE1MjgwYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUgY6xAH2gAyNTA3MTA5MzI4OmZhNmM4ZjdkZWNmODljZTAwNzc0ZjhhYTM0YzJmZDFlZmIyM2ExNTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e98c370fd00492dc6973e017b9b7cc3315280be", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/0e98c370fd00492dc6973e017b9b7cc3315280be", "committedDate": "2020-10-20T21:28:36Z", "message": "Issue #5480 - NPE protection on IO.delete(File)\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "227dd47157c6839d137b49a14e6085f42787f444", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/227dd47157c6839d137b49a14e6085f42787f444", "committedDate": "2020-10-20T21:29:22Z", "message": "Issue #5480 - Fail in jetty-maven-plugin if unable to create temp directory.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/6be6fae291eff4ff8d7449d7f222812e02c76645", "committedDate": "2020-10-20T21:30:39Z", "message": "Issue #5480 - NPE Check in WebInfConfiguration.deconfigure()\n\n+ Removing Temp dir deletion in configureTempDirectory()\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTU0NzI1", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513154725", "createdAt": "2020-10-20T21:38:56Z", "commit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTozODo1N1rOHlSHeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTozOTo0NVrOHlSI_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjE4Ng==", "bodyText": "I'm not sure about this .... we need to check that if the dir should not be persisted then anything that is already in it should be removed before we try and unpack the webapp into it.", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856186", "createdAt": "2020-10-20T21:38:57Z", "author": {"login": "janbartel"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjU3Mw==", "bodyText": "You need to keep the if (!context.isPersistTempDirectory) dir.deleteOnExit.", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856573", "createdAt": "2020-10-20T21:39:45Z", "author": {"login": "janbartel"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it\n+        if (!dir.exists())\n         {\n-            if (!IO.delete(dir))\n-                throw new IllegalStateException(\"Failed to delete temp dir \" + dir);\n+            if (!dir.mkdirs())\n+            {\n+                throw new IllegalStateException(\"Unable to create temp dir \" + dir);\n+            }\n         }\n \n-        //if it doesn't exist make it\n-        if (!dir.exists())\n-            dir.mkdirs();\n-\n-        if (!context.isPersistTempDirectory())\n-            dir.deleteOnExit();\n-\n-        //is it useable\n+        // is it useable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTU1NTcw", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513155570", "createdAt": "2020-10-20T21:40:17Z", "commit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTo0MDoxN1rOHlSKDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTo0MDo0OFrOHlSLDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1Njg0Ng==", "bodyText": "You've changed the logic here.   This was always deleting and recreating a non persistent temp dir.\nWe  don't want to do that any more because of hijacking!   But I think we have to ensure the tempdir is empty if it is not persistent.", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508856846", "createdAt": "2020-10-20T21:40:17Z", "author": {"login": "gregw"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +522,16 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if it doesn't exist make it\n+        if (!dir.exists())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NzEwMA==", "bodyText": "assign getTempDirectory() to a variable", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508857100", "createdAt": "2020-10-20T21:40:48Z", "author": {"login": "gregw"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -355,7 +355,7 @@ public void configure(WebAppContext context) throws Exception\n     public void deconfigure(WebAppContext context) throws Exception\n     {\n         //if we're not persisting the temp dir contents delete it\n-        if (!context.isPersistTempDirectory())\n+        if (!context.isPersistTempDirectory() && context.getTempDirectory() != null && context.getTempDirectory().exists())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be6fae291eff4ff8d7449d7f222812e02c76645"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316", "committedDate": "2020-10-20T21:53:09Z", "message": "Issue #5480 - Safer temp directory management\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTY2NzE3", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513166717", "createdAt": "2020-10-20T21:59:48Z", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTo1OTo0OFrOHlSuOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMTo1OTo0OFrOHlSuOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjEwNw==", "bodyText": "This execution path does not use configureTempDirectory.\nIt's always a new, and unique, directory.\nAlso, it is always !isPersisTempDirectory()", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508866107", "createdAt": "2020-10-20T21:59:48Z", "author": {"login": "joakime"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -504,13 +506,15 @@ public void makeTempDirectory(File parent, WebAppContext context)\n             //if it is to be persisted, make sure it will be the same name\n             //by not using File.createTempFile, which appends random digits\n             tmpDir = new File(parent, temp);\n+            configureTempDirectory(tmpDir, context);\n         }\n         else\n         {\n-            //ensure file will always be unique by appending random digits\n+            // ensure dir will always be unique by having classlib generate random path name\n             tmpDir = Files.createTempDirectory(parent.toPath(), temp).toFile();\n+            tmpDir.deleteOnExit();\n+            ensureTempDirUsable(tmpDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTY3NzYy", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513167762", "createdAt": "2020-10-20T22:01:38Z", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjowMTozOFrOHlSxcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjowMTozOFrOHlSxcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NjkyOQ==", "bodyText": "probably should now be called ensureTempDirectory ?", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508866929", "createdAt": "2020-10-20T22:01:38Z", "author": {"login": "gregw"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -504,13 +506,15 @@ public void makeTempDirectory(File parent, WebAppContext context)\n             //if it is to be persisted, make sure it will be the same name\n             //by not using File.createTempFile, which appends random digits\n             tmpDir = new File(parent, temp);\n+            configureTempDirectory(tmpDir, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTY4NDYy", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513168462", "createdAt": "2020-10-20T22:02:51Z", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjowMjo1MVrOHlSzdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMjowMjo1MVrOHlSzdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2NzQ0NQ==", "bodyText": "how hard is it to check if it is empty or not.   if it is empty, it would be good to avoid deleting it.", "url": "https://github.com/eclipse/jetty.project/pull/5481#discussion_r508867445", "createdAt": "2020-10-20T22:02:51Z", "author": {"login": "gregw"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebInfConfiguration.java", "diffHunk": "@@ -522,21 +526,30 @@ public void configureTempDirectory(File dir, WebAppContext context)\n         if (dir == null)\n             throw new IllegalArgumentException(\"Null temp dir\");\n \n-        //if dir exists and we don't want it persisted, delete it\n-        if (dir.exists() && !context.isPersistTempDirectory())\n+        // if dir exists and we don't want it persisted, delete it\n+        if (!context.isPersistTempDirectory() && dir.exists() && !IO.delete(dir))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTczODUz", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513173853", "createdAt": "2020-10-20T22:13:24Z", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTc1MDA2", "url": "https://github.com/eclipse/jetty.project/pull/5481#pullrequestreview-513175006", "createdAt": "2020-10-20T22:15:43Z", "commit": {"oid": "c7ae5b50ab8bfffe46aca5cc8cf1ceef305fa316"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6c8f7decf89ce00774f8aa34c2fd1efb23a156", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/fa6c8f7decf89ce00774f8aa34c2fd1efb23a156", "committedDate": "2020-10-20T22:19:54Z", "message": "Issue #5480 - Only delete non-persist temp dir if not-empty\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4980, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}