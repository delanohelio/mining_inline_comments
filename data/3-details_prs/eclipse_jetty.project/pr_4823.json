{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NzUzNzc3", "number": 4823, "title": "Issue #4798 - Recover from Selector Failures", "bodyText": "The second commit has the changes related to fixing the issue (the first is a code cleanup).", "createdAt": "2020-04-27T21:20:41Z", "url": "https://github.com/eclipse/jetty.project/pull/4823", "merged": true, "mergeCommit": {"oid": "0ab2b42055546b8063f83214d5eaf084efdf0aaf"}, "closed": true, "closedAt": "2020-05-04T15:43:29Z", "author": {"login": "sbordet"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb1upAgH2gAyNDA5NzUzNzc3OjQ2YWQ5MDU5OGM2NWQxMjcxMjQzOTVkYjMyMTcyZjM4MTU3OWE4MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccrHtZAFqTQwMzQyMTAzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46ad90598c65d127124395db32172f381579a825", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/46ad90598c65d127124395db32172f381579a825", "committedDate": "2020-04-27T20:57:57Z", "message": "Code cleanups."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/952a20f81cabdc046832cb8c519151f148206bbe", "committedDate": "2020-04-27T21:19:06Z", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nImplemented selector recovery by transferring\nall keys to a newly created selector.\n\nUpdated code so that it does not assume that the\nSelectionKey never changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxOTM4NzE1", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-401938715", "createdAt": "2020-04-28T15:13:35Z", "commit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNToxMzozNVrOGNZGWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNToxNToyOVrOGNZMVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NTg5OQ==", "bodyText": "Both implementations of this method don't use the oldKey parameter. Use it or drop it?", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416695899", "createdAt": "2020-04-28T15:13:35Z", "author": {"login": "lorban"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ManagedSelector.java", "diffHunk": "@@ -378,14 +473,25 @@ public String toString()\n          * detected by the {@link ManagedSelector} for this endpoint.\n          *\n          * @return a job that may block or null\n+         * @param key the selected SelectionKey\n          */\n-        Runnable onSelected();\n+        Runnable onSelected(SelectionKey key);\n \n         /**\n          * Callback method invoked when all the keys selected by the\n          * {@link ManagedSelector} for this endpoint have been processed.\n+         * @param key the SelectionKey to update\n+         */\n+        void updateKey(SelectionKey key);\n+\n+        /**\n+         * Callback method invoked when a selectable is transferred\n+         * from one selector to a new selector.\n+         *\n+         * @param oldKey the old SelectionKey\n+         * @param newKey the new SelectionKey\n          */\n-        void updateKey();\n+        void replaceKey(SelectionKey oldKey, SelectionKey newKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "originalPosition": 226}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzA4OQ==", "bodyText": "This class does very little more than ChannelEndPoint Shouldn't the two be merged?", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416697089", "createdAt": "2020-04-28T15:15:05Z", "author": {"login": "lorban"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/SocketChannelEndPoint.java", "diffHunk": "@@ -18,24 +18,15 @@\n \n package org.eclipse.jetty.io;\n \n-import java.io.IOException;\n-import java.net.InetSocketAddress;\n import java.net.Socket;\n import java.nio.channels.SelectableChannel;\n import java.nio.channels.SelectionKey;\n import java.nio.channels.SocketChannel;\n \n-import org.eclipse.jetty.util.log.Log;\n-import org.eclipse.jetty.util.log.Logger;\n import org.eclipse.jetty.util.thread.Scheduler;\n \n public class SocketChannelEndPoint extends ChannelEndPoint", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NzQyOQ==", "bodyText": "Why disabled?", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416697429", "createdAt": "2020-04-28T15:15:29Z", "author": {"login": "lorban"}, "path": "tests/test-http-client-transport/src/test/java/org/eclipse/jetty/http/client/AsyncIOServletTest.java", "diffHunk": "@@ -398,6 +399,7 @@ public void onError(Throwable t)\n     @ParameterizedTest\n     @ArgumentsSource(TransportProvider.class)\n     @Tag(\"Unstable\")\n+    @Disabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxOTUxNDAx", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-401951401", "createdAt": "2020-04-28T15:26:16Z", "commit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNToyNjoxNlrOGNZuEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNToyNjo1NlrOGNZwVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcwNjA2Ng==", "bodyText": "I think it is strange to have both replaceKey and to pass in the key to onSelected etc.\nIf you are passing in the key for the main usages, then findKey is probably OK for the remaining cases.\nSo get rid of one mechanism or the other.", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416706066", "createdAt": "2020-04-28T15:26:16Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ManagedSelector.java", "diffHunk": "@@ -378,14 +473,25 @@ public String toString()\n          * detected by the {@link ManagedSelector} for this endpoint.\n          *\n          * @return a job that may block or null\n+         * @param key the selected SelectionKey\n          */\n-        Runnable onSelected();\n+        Runnable onSelected(SelectionKey key);\n \n         /**\n          * Callback method invoked when all the keys selected by the\n          * {@link ManagedSelector} for this endpoint have been processed.\n+         * @param key the SelectionKey to update\n+         */\n+        void updateKey(SelectionKey key);\n+\n+        /**\n+         * Callback method invoked when a selectable is transferred\n+         * from one selector to a new selector.\n+         *\n+         * @param oldKey the old SelectionKey\n+         * @param newKey the new SelectionKey\n          */\n-        void updateKey();\n+        void replaceKey(SelectionKey oldKey, SelectionKey newKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NTg5OQ=="}, "originalCommit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "originalPosition": 226}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcwNjY0Nw==", "bodyText": "compute is not really very meaningful", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r416706647", "createdAt": "2020-04-28T15:26:56Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ManagedSelector.java", "diffHunk": "@@ -160,22 +145,132 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    void compute(Selector selector, SelectableChannel channel, SelectionKey selectionKey, Consumer<SelectionKey> action)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952a20f81cabdc046832cb8c519151f148206bbe"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/8c75eeccce81b158c2513ec29f6d6f644735568b", "committedDate": "2020-04-29T09:57:06Z", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTcxODA5", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-402571809", "createdAt": "2020-04-29T11:17:21Z", "commit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMToxNzoyMVrOGN6Qlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMToyNDowNlrOGN6dnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTE5MQ==", "bodyText": "you may as well return the key here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _selector.runKeyAction(selector, _channel, _key, this::updateKey);\n          \n          \n            \n                    _key = _selector.runKeyAction(selector, _channel, _key, this::updateKey);", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417239191", "createdAt": "2020-04-29T11:17:21Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)\n+    {\n+        _selector.runKeyAction(selector, _channel, _key, this::updateKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MDE3Mw==", "bodyText": "This is not used in updateKey(Selector selector)  or is it the other update key?   Eitherway, it is confusing, can we change one of the method names?", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417240173", "createdAt": "2020-04-29T11:19:19Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -94,14 +88,7 @@ public void close()\n         }\n     }\n \n-    private final ManagedSelector.SelectorUpdate _updateKeyAction = new ManagedSelector.SelectorUpdate()\n-    {\n-        @Override\n-        public void update(Selector selector)\n-        {\n-            updateKey();\n-        }\n-    };\n+    private final ManagedSelector.SelectorUpdate _updateKeyAction = this::updateKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MjUyNw==", "bodyText": "maybe call this one updateKeyAction", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417242527", "createdAt": "2020-04-29T11:24:06Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "originalPosition": 172}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzk1Mjk4", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-402795298", "createdAt": "2020-04-29T15:41:22Z", "commit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo0MToyM1rOGOFCtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo0MTo0M1rOGOFDtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNTg2Mw==", "bodyText": "So the updateKeyAction method is submitted to the selector, which calls us back here and then we call compute on the selector because our _key might be out of date....  All to avoid an array deref in keyFor  !!! I think we are getting too tricky.\nThe other callback pass the key, so we can just use it.  This callback passes the selector, so let's use use keyFor here and get rid of _key field.", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417415863", "createdAt": "2020-04-29T15:41:23Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MjUyNw=="}, "originalCommit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNjExOA==", "bodyText": "let's get rid of the _key field (as above)", "url": "https://github.com/eclipse/jetty.project/pull/4823#discussion_r417416118", "createdAt": "2020-04-29T15:41:43Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ChannelEndPoint.java", "diffHunk": "@@ -357,12 +353,16 @@ public Runnable onSelected()\n         return task;\n     }\n \n+    private void updateKey(Selector selector)\n+    {\n+        _selector.runKeyAction(selector, _channel, _key, this::updateKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTE5MQ=="}, "originalCommit": {"oid": "8c75eeccce81b158c2513ec29f6d6f644735568b"}, "originalPosition": 174}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a028b663bf8cce5569e3876d6089e2550b35e2e", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/0a028b663bf8cce5569e3876d6089e2550b35e2e", "committedDate": "2020-04-30T08:55:29Z", "message": "Issue #4798 - Better handling of fatal Selector failures.\n\nMore updates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMzU2OTcx", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-403356971", "createdAt": "2020-04-30T09:34:56Z", "commit": {"oid": "0a028b663bf8cce5569e3876d6089e2550b35e2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNDIxMDMx", "url": "https://github.com/eclipse/jetty.project/pull/4823#pullrequestreview-403421031", "createdAt": "2020-04-30T11:10:18Z", "commit": {"oid": "0a028b663bf8cce5569e3876d6089e2550b35e2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 365, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}