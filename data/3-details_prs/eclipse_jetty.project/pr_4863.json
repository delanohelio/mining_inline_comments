{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MDYxODIz", "number": 4863, "title": "Issue #4860 - NPE from HttpFields", "bodyText": "Fix handling of null fields in HttpFields for #4860 :\n\nAdded paranoid catch in HttpChannel so even if fix doesn't work we won't loop forever.\nFixed bug in iterator with nextIndex\nDo not allow null fields to be set with list iterator\nimproved test coverage", "createdAt": "2020-05-11T12:05:01Z", "url": "https://github.com/eclipse/jetty.project/pull/4863", "merged": true, "mergeCommit": {"oid": "86a40a07d6f23ef797a1d1ad96977f5a8c91258e"}, "closed": true, "closedAt": "2020-05-12T02:04:51Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgOYrUgH2gAyNDE2MDYxODIzOmM0OTdiNjE5MTdhNGU0ZmQwOWJiMDk4YmQyNjRiZjA2ZTYyZGIzMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgXYXEgH2gAyNDE2MDYxODIzOmQxMjdkYjUxODZiZTQ5NTBkOTIxOTliNWNkYTQzYjRmNmE5NGExMjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c497b61917a4e4fd09bb098bd264bf06e62db317", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/c497b61917a4e4fd09bb098bd264bf06e62db317", "committedDate": "2020-05-11T11:57:17Z", "message": "Issue #4860 NPE from HttpFields\n\nParanoid catch if sending and exception page throws an exception.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6af6af6419b43fce0c7c291579677681f901b676", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/6af6af6419b43fce0c7c291579677681f901b676", "committedDate": "2020-05-11T11:58:27Z", "message": "Issue #4860 NPE from HttpFields\n\nImproved test coverage\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ac7fe4f9c0726c70102e83fe4e3a93901d9872c", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1ac7fe4f9c0726c70102e83fe4e3a93901d9872c", "committedDate": "2020-05-11T12:00:04Z", "message": "Issue #4860 NPE from HttpFields\n\n + Fix bug with list iterator nextIndex\n + List iterator cannot inject null fields\n + minor cleanups\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTE0NzUy", "url": "https://github.com/eclipse/jetty.project/pull/4863#pullrequestreview-409114752", "createdAt": "2020-05-11T12:13:55Z", "commit": {"oid": "1ac7fe4f9c0726c70102e83fe4e3a93901d9872c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c7c98f4690d2db399005b48dd42e9d2f5131edd", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/2c7c98f4690d2db399005b48dd42e9d2f5131edd", "committedDate": "2020-05-11T15:03:12Z", "message": "Eliminate warnings\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90da10dac57c9a4cf5bea85176077e5862c9589b", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/90da10dac57c9a4cf5bea85176077e5862c9589b", "committedDate": "2020-05-11T15:05:56Z", "message": "Issue #4860 - Improving testPreventNullField testcase\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "committedDate": "2020-05-11T15:34:52Z", "message": "Issue #4860 - Consistency to HttpFields API\n\nIf a null name (or HttpHeader or HttpField) is used\nit should throw an ISE\n\n+ .add() should remain consistent\n+ .put() should remain consistent\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MzUxMjk1", "url": "https://github.com/eclipse/jetty.project/pull/4863#pullrequestreview-409351295", "createdAt": "2020-05-11T16:51:40Z", "commit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNjo1MTo0MFrOGTkyFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNjo1MTo0MFrOGTkyFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3ODc3NQ==", "bodyText": "@joakime This comment is wrong.  Setting null used to put in a null entry, but now is a noop.", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423178775", "createdAt": "2020-05-11T16:51:40Z", "author": {"login": "gregw"}, "path": "jetty-http/src/test/java/org/eclipse/jetty/http/HttpFieldsTest.java", "diffHunk": "@@ -710,15 +749,15 @@ public void testPreventNullField()\n         assertThat(fields.size(), is(1));\n         ListIterator<HttpField> iter = fields.listIterator();\n         iter.next();\n-        iter.set(null);\n+        iter.set(null); // set field to null - null entry in list now", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NDQ0Mjg1", "url": "https://github.com/eclipse/jetty.project/pull/4863#pullrequestreview-409444285", "createdAt": "2020-05-11T18:56:42Z", "commit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxODo1Njo0MlrOGTpM9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxOToyMToyOVrOGTqBbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTE4OQ==", "bodyText": "Since you bothered adding a message to the NPE, make it \"header name cannot be null\", or at least \"header name\", as \"name\" alone is just too laconic to be useful.", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251189", "createdAt": "2020-05-11T18:56:42Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpField.java", "diffHunk": "@@ -40,7 +40,7 @@ public HttpField(HttpHeader header, String name, String value)\n         if (_header != null && name == null)\n             _name = _header.asString();\n         else\n-            _name = Objects.requireNonNull(name);\n+            _name = Objects.requireNonNull(name, \"name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTQ4NA==", "bodyText": "\"header cannot be null\".", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251484", "createdAt": "2020-05-11T18:57:15Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -671,6 +676,8 @@ public void put(HttpHeader header, HttpHeaderValue value)\n      */\n     public void put(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTYwNw==", "bodyText": "\"name cannot be null\"", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251607", "createdAt": "2020-05-11T18:57:27Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -685,7 +692,12 @@ public void put(HttpHeader header, String value)\n      */\n     public void put(String name, List<String> list)\n     {\n+        Objects.requireNonNull(name, \"name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MjU1MQ==", "bodyText": "\"header cannot be null\"", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423252551", "createdAt": "2020-05-11T18:59:11Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -723,6 +736,8 @@ public void add(HttpHeader header, HttpHeaderValue value)\n      */\n     public void add(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzIyMA==", "bodyText": "We are no-op all the other cases, most notably add(String, String) above, so why throw here?", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423253220", "createdAt": "2020-05-11T19:00:28Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -723,6 +736,8 @@ public void add(HttpHeader header, HttpHeaderValue value)\n      */\n     public void add(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");\n+\n         if (value == null)\n             throw new IllegalArgumentException(\"null value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2NDYyMw==", "bodyText": "Should not the last parameter be _size++ - _cursor?\nAnd yes, I would rather separate the ++ and -- to different lines so that they are more comprehensible.\nFor example, it takes too much brain power to know if 5++ - 3 is 2 or 3.\nWe have tests that call add(HttpField) but the error in the copy does not show because the array is initialized to 16 elements but in the tests _size is only 4-5.", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423264623", "createdAt": "2020-05-11T19:21:29Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -1199,16 +1217,22 @@ public void set(HttpField field)\n         {\n             if (_current < 0)\n                 throw new IllegalStateException();\n-            _fields[_current] = field;\n+            if (field == null)\n+                remove();\n+            else\n+                _fields[_current] = field;\n         }\n \n         @Override\n         public void add(HttpField field)\n         {\n-            _fields = Arrays.copyOf(_fields, _fields.length + 1);\n-            System.arraycopy(_fields, _cursor, _fields, _cursor + 1, _size++);\n-            _fields[_cursor++] = field;\n-            _current = -1;\n+            if (field != null)\n+            {\n+                _fields = Arrays.copyOf(_fields, _fields.length + 1);\n+                System.arraycopy(_fields, _cursor, _fields, _cursor + 1, _size++);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59a66158ed0c12dd10cec842b0ccf595cbe2e4eb", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/59a66158ed0c12dd10cec842b0ccf595cbe2e4eb", "committedDate": "2020-05-11T20:09:19Z", "message": "Issue #4860 NPE HttpFields\n\nFixes from review.\nFixed iterator overflow bug\nclearer updates of size\nbetter nonNull messages\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTAwODAw", "url": "https://github.com/eclipse/jetty.project/pull/4863#pullrequestreview-409500800", "createdAt": "2020-05-11T20:21:44Z", "commit": {"oid": "59a66158ed0c12dd10cec842b0ccf595cbe2e4eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dc024b2b1b4d84493675403df77e2724bed831f", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/4dc024b2b1b4d84493675403df77e2724bed831f", "committedDate": "2020-05-11T22:25:49Z", "message": "Issue #4860 - Fixing test comment\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d127db5186be4950d92199b5cda43b4f6a94a126", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/d127db5186be4950d92199b5cda43b4f6a94a126", "committedDate": "2020-05-11T22:26:05Z", "message": "Merge branch 'jetty-9.4.x-4860-NullHttpFields' of github.com:eclipse/jetty.project into jetty-9.4.x-4860-NullHttpFields"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 390, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}