{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MTEyOTI4", "number": 5807, "title": "Cleanup of charset usage in Response", "bodyText": "Closes #5757\n\nImprove documentation for EncodingFrom enum with relation to assumed vs inferred charsets.\nClean up code and simplify logic relating to charsets in Response.\nLocale can now be cleared with setLocale(null) similar to how you would clear the charset, this will also clear the charset if it is EncodingFrom.LOCALE.", "createdAt": "2020-12-14T04:09:08Z", "url": "https://github.com/eclipse/jetty.project/pull/5807", "merged": true, "mergeCommit": {"oid": "65a908b65d2acccc48944f0c0d84ab3b693e6d3a"}, "closed": true, "closedAt": "2020-12-21T05:09:50Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj9VpJAH2gAyNTM5MTEyOTI4OjU0OTBiM2FkZDRkOGU4OTZmMzY1ZTk5MjJmYTcwODgzOTQ0ZDgyNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnTqYPAFqTU1NTI3MjkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5490b3add4d8e896f365e9922fa70883944d825e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/5490b3add4d8e896f365e9922fa70883944d825e", "committedDate": "2020-12-07T22:32:26Z", "message": "Issue #5757 - improve javadoc around inferred and assumed charsets\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5fab09498f7c9f4af7deb0ba57389657df85e0c", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f5fab09498f7c9f4af7deb0ba57389657df85e0c", "committedDate": "2020-12-09T04:25:46Z", "message": "Issue #5757 - cleanup logic around character encoding in Response\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/908acd59046d9d72e236870aa513a9f5e946b445", "committedDate": "2020-12-14T06:22:36Z", "message": "The default iso-8859-1 encoding should be set in the Content-Type.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTQzNzY5", "url": "https://github.com/eclipse/jetty.project/pull/5807#pullrequestreview-551143769", "createdAt": "2020-12-14T08:38:48Z", "commit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODozODo0OFrOIFFUxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODo0OToxM1rOIFFueA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwMTAzMA==", "bodyText": "is that the only mechanism to get an inferred type?\nI think it would be best just to say that  the charset is inferred from the content-type and will be added as a parameter to the content-type", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542201030", "createdAt": "2020-12-14T08:38:48Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -103,11 +103,35 @@\n \n     private enum EncodingFrom\n     {\n-        NOT_SET, INFERRED, SET_LOCALE, SET_CONTENT_TYPE, SET_CHARACTER_ENCODING\n+        /**\n+         * Character encoding was not set, or the encoding was cleared with {@code setCharacterEncoding(null)}.\n+         */\n+        NOT_SET,\n+\n+        /**\n+         * Character encoding was not explicitly set but has a default value defined by the {@code encoding.properties} file.\n+         * @see MimeTypes#getInferredEncodings().\n+         */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwMTYxMw==", "bodyText": "No, because content-type has already been set, hence we have a mimeType.   We don't need to add the charset as Assumed charsets are never added to the content-type - by definition of what assumed is (otherwise they are inferred).", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542201613", "createdAt": "2020-12-14T08:39:50Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNTMwNw==", "bodyText": "probably should mention it only sets inferred and default", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542205307", "createdAt": "2020-12-14T08:45:42Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNzMxMg==", "bodyText": "Yes - if not set here will never be set", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542207312", "createdAt": "2020-12-14T08:48:44Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?\n+        if (_mimeType != null && _mimeType.isCharsetAssumed())\n+            return _mimeType.getCharsetString();\n+\n+        // Try charset assumed from content type (assumed charsets are not added to content type header).\n+        encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n+        if (encoding != null)\n+            return encoding;\n+\n+        // Try char set inferred from content type.\n+        encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        if (encoding != null)\n         {\n-            String encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n-            if (encoding != null)\n-                return encoding;\n+            if (setContentType)\n+                setCharacterEncoding(encoding, EncodingFrom.INFERRED);\n+            return encoding;\n+        }\n \n-            encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        // Try any default char encoding for the context. TODO: should this be added to Content-Type header?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIwNzYwOA==", "bodyText": "Not really INFERRED - maybe need a DEFAULT?", "url": "https://github.com/eclipse/jetty.project/pull/5807#discussion_r542207608", "createdAt": "2020-12-14T08:49:13Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Response.java", "diffHunk": "@@ -754,26 +778,57 @@ public void setStatusWithReason(int sc, String message)\n     @Override\n     public String getCharacterEncoding()\n     {\n-        if (_characterEncoding == null)\n+        return getCharacterEncoding(false);\n+    }\n+\n+    /**\n+     * Private utility method to get the character encoding.\n+     * A standard call to {@link #getCharacterEncoding()} should not change the Content-Type header.\n+     * But when {@link #getWriter()} is called we must decide what Content Type to use, so this will allow an inferred\n+     * charset to be set in in the Content-Type.\n+     * @param setContentType set the Content-Type header if this is set to true, otherwise just calculate what it should be.\n+     * @return the character encoding for this response.\n+     */\n+    private String getCharacterEncoding(boolean setContentType)\n+    {\n+        // First try explicit char encoding.\n+        if (_characterEncoding != null)\n+            return _characterEncoding;\n+\n+        String encoding;\n+\n+        // Try charset from mime type. TODO: should this be added to Content-Type header?\n+        if (_mimeType != null && _mimeType.isCharsetAssumed())\n+            return _mimeType.getCharsetString();\n+\n+        // Try charset assumed from content type (assumed charsets are not added to content type header).\n+        encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n+        if (encoding != null)\n+            return encoding;\n+\n+        // Try char set inferred from content type.\n+        encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        if (encoding != null)\n         {\n-            String encoding = MimeTypes.getCharsetAssumedFromContentType(_contentType);\n-            if (encoding != null)\n-                return encoding;\n+            if (setContentType)\n+                setCharacterEncoding(encoding, EncodingFrom.INFERRED);\n+            return encoding;\n+        }\n \n-            encoding = MimeTypes.getCharsetInferredFromContentType(_contentType);\n+        // Try any default char encoding for the context. TODO: should this be added to Content-Type header?\n+        Context context = _channel.getRequest().getContext();\n+        if (context != null)\n+        {\n+            encoding = context.getResponseCharacterEncoding();\n             if (encoding != null)\n                 return encoding;\n-\n-            Context context = _channel.getRequest().getContext();\n-            if (context != null)\n-            {\n-                encoding = context.getResponseCharacterEncoding();\n-                if (encoding != null)\n-                    return encoding;\n-            }\n-            return StringUtil.__ISO_8859_1;\n         }\n-        return _characterEncoding;\n+\n+        // Fallback to last resort iso-8859-1.\n+        encoding = StringUtil.__ISO_8859_1;\n+        if (setContentType)\n+            setCharacterEncoding(encoding, EncodingFrom.INFERRED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "908acd59046d9d72e236870aa513a9f5e946b445"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b13fb8ad1e7ca96e7f6594e4c12099315b0e90de", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/b13fb8ad1e7ca96e7f6594e4c12099315b0e90de", "committedDate": "2020-12-15T01:21:47Z", "message": "Resolve TODOs and other changes from review.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88a838fb176eb749764dc897c4f466d648b30d9d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/88a838fb176eb749764dc897c4f466d648b30d9d", "committedDate": "2020-12-15T02:40:22Z", "message": "Introduce extra enum state for DEFAULT encoding.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e5c9c5241a22ce06aca722a0504ed281d880f1f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/1e5c9c5241a22ce06aca722a0504ed281d880f1f", "committedDate": "2020-12-15T02:34:26Z", "message": "Introduce extra enum state for DEFAULT encoding.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}, "afterCommit": {"oid": "88a838fb176eb749764dc897c4f466d648b30d9d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/88a838fb176eb749764dc897c4f466d648b30d9d", "committedDate": "2020-12-15T02:40:22Z", "message": "Introduce extra enum state for DEFAULT encoding.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MjcyOTM4", "url": "https://github.com/eclipse/jetty.project/pull/5807#pullrequestreview-555272938", "createdAt": "2020-12-18T08:14:46Z", "commit": {"oid": "88a838fb176eb749764dc897c4f466d648b30d9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4953, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}