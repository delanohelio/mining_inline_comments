{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjYwNTk3", "number": 5094, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1Mzo0OFrOETI0Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDo1NTowMVrOETM5Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTAyODc0OnYy", "diffSide": "LEFT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1Mzo0OFrOG4s2Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODoyNjoyM1rOG4uBkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODIzOA==", "bodyText": "strictly speaking this has nothing to do with contexthandler locking.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462108238", "createdAt": "2020-07-29T07:53:48Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -1805,7 +1805,7 @@ public void setMetaData(org.eclipse.jetty.http.MetaData.Request request)\n         }\n         else if (encoded.startsWith(\"/\"))\n         {\n-            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(URIUtil.decodePath(encoded));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyNzUwNQ==", "bodyText": "sorry, but it is little :)", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462127505", "createdAt": "2020-07-29T08:26:23Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -1805,7 +1805,7 @@ public void setMetaData(org.eclipse.jetty.http.MetaData.Request request)\n         }\n         else if (encoded.startsWith(\"/\"))\n         {\n-            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(URIUtil.decodePath(encoded));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODIzOA=="}, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTAyOTk2OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NDowNFrOG4s3Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NDowNFrOG4s3Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODQxOQ==", "bodyText": "oops this is an unrelated change that accidentally slipped in.\nThe uri.getDecodedPath() method  does exactly URIUtil.decodePath(encoded), but caches the results so they can be reused if needed again.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462108419", "createdAt": "2020-07-29T07:54:04Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -1805,7 +1805,7 @@ public void setMetaData(org.eclipse.jetty.http.MetaData.Request request)\n         }\n         else if (encoded.startsWith(\"/\"))\n         {\n-            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(URIUtil.decodePath(encoded));\n+            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(uri.getDecodedPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTA0MzMwOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NzozMlrOG4s-_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NzozMlrOG4s-_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMDQ2Mg==", "bodyText": "If UNAVAILABLE, should the state go to SHUTDOWN?", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462110462", "createdAt": "2020-07-29T07:57:32Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -777,7 +778,23 @@ public boolean isShutdown()\n     @Override\n     public Future<Void> shutdown()\n     {\n-        _availability = isRunning() ? Availability.SHUTDOWN : Availability.UNAVAILABLE;\n+        while (true)\n+        {\n+            Availability availability = _availability.get();\n+            switch (availability)\n+            {\n+                case STOPPED:\n+                    return new FutureCallback(new IllegalStateException(getState()));\n+                case STARTING:\n+                case AVAILABLE:\n+                    if (!_availability.compareAndSet(availability, Availability.SHUTDOWN))\n+                        continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTA1MDk5OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1OTozOFrOG4tDtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODozMDozOFrOG4uMow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMTY2OA==", "bodyText": "Maybe should throw an ISE if you try to set availability whilst shutdown or stopped?", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462111668", "createdAt": "2020-07-29T07:59:38Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -796,12 +813,29 @@ public boolean isAvailable()\n      */\n     public void setAvailable(boolean available)\n     {\n-        synchronized (this)\n+        // Only supported state transitions are:\n+        //   UNAVAILABLE --true---> AVAILABLE\n+        //   STARTING -----false--> UNAVAILABLE\n+        //   AVAILABLE ----false--> UNAVAILABLE\n+        if (available)\n+            _availability.compareAndSet(Availability.UNAVAILABLE, Availability.AVAILABLE);\n+        else\n         {\n-            if (available && isRunning())\n-                _availability = Availability.AVAILABLE;\n-            else if (!available || !isRunning())\n-                _availability = Availability.UNAVAILABLE;\n+            while (true)\n+            {\n+                Availability availability = _availability.get();\n+                switch (availability)\n+                {\n+                    case STARTING:\n+                    case AVAILABLE:\n+                        if (!_availability.compareAndSet(availability, Availability.UNAVAILABLE))\n+                            continue;\n+                        break;\n+                    default:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzMDMzOQ==", "bodyText": "I think perhaps only if trying to set available==true, as all other states are equivalent to available==false", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462130339", "createdAt": "2020-07-29T08:30:38Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -796,12 +813,29 @@ public boolean isAvailable()\n      */\n     public void setAvailable(boolean available)\n     {\n-        synchronized (this)\n+        // Only supported state transitions are:\n+        //   UNAVAILABLE --true---> AVAILABLE\n+        //   STARTING -----false--> UNAVAILABLE\n+        //   AVAILABLE ----false--> UNAVAILABLE\n+        if (available)\n+            _availability.compareAndSet(Availability.UNAVAILABLE, Availability.AVAILABLE);\n+        else\n         {\n-            if (available && isRunning())\n-                _availability = Availability.AVAILABLE;\n-            else if (!available || !isRunning())\n-                _availability = Availability.UNAVAILABLE;\n+            while (true)\n+            {\n+                Availability availability = _availability.get();\n+                switch (availability)\n+                {\n+                    case STARTING:\n+                    case AVAILABLE:\n+                        if (!_availability.compareAndSet(availability, Availability.UNAVAILABLE))\n+                            continue;\n+                        break;\n+                    default:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMTY2OA=="}, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTA2NzE2OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowNDoxNFrOG4tN1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowNDoxNFrOG4tN1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNDI2Mg==", "bodyText": "Can we have a comment about the meanings of the different states, particularly UNAVAILABLE vs STOPPED, which is a new state.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462114262", "createdAt": "2020-07-29T08:04:14Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -230,10 +231,10 @@ public static void setServerInfo(String serverInfo)\n \n     public enum Availability\n     {\n-        UNAVAILABLE, STARTING, AVAILABLE, SHUTDOWN,\n+        STOPPED, STARTING, AVAILABLE, UNAVAILABLE, SHUTDOWN,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTA3OTQ2OnYy", "diffSide": "LEFT", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebAppContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowNzo0MFrOG4tVTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTowNDoxMlrOG4vb4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNjE3Mg==", "bodyText": "Need an explanation of this change as on the face of it, it is the exact opposite of the original intent.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462116172", "createdAt": "2020-07-29T08:07:40Z", "author": {"login": "janbartel"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebAppContext.java", "diffHunk": "@@ -1434,7 +1434,7 @@ protected void stopContext() throws Exception\n                 setClassLoader(null);\n             }\n \n-            setAvailable(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE1MDYyNA==", "bodyText": "I can't really explain.  It looks to me that it was just plain wrong, but didn't matter because we were stopping already.\nI think it actually dates from when availability was just in the webapp and it had to clear unavailable status   This is no longer required, so I will try without anything here.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462150624", "createdAt": "2020-07-29T09:04:12Z", "author": {"login": "gregw"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebAppContext.java", "diffHunk": "@@ -1434,7 +1434,7 @@ protected void stopContext() throws Exception\n                 setClassLoader(null);\n             }\n \n-            setAvailable(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNjE3Mg=="}, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTY5NjcwOnYy", "diffSide": "RIGHT", "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDo1NTowMVrOG4zOQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDozMToxOVrOG673_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA==", "bodyText": "This is an unrelated change.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462212674", "createdAt": "2020-07-29T10:55:01Z", "author": {"login": "joakime"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzODAyMg==", "bodyText": "Yes, see note explaining it above.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462238022", "createdAt": "2020-07-29T11:47:17Z", "author": {"login": "gregw"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA=="}, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIzODk3MQ==", "bodyText": "Oh no it's another unrelated change!   Double ooops", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462238971", "createdAt": "2020-07-29T11:49:23Z", "author": {"login": "gregw"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA=="}, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5NTYxOQ==", "bodyText": "These are useful and good changes.\nJust would have liked to see them in a different commit explaining why they were made.\nRight now they seem to be related to the change for commit 36b2a4b (Issue #5088 Review ContextHandler Locking), which will be super confusing in the future.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462295619", "createdAt": "2020-07-29T13:25:26Z", "author": {"login": "joakime"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA=="}, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTU4Mg==", "bodyText": "yep - my bad!", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r464451582", "createdAt": "2020-08-03T14:31:19Z", "author": {"login": "gregw"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA=="}, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2450, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}