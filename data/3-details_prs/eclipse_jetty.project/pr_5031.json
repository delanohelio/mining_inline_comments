{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDc5Nzcy", "number": 5031, "title": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10", "bodyText": "Changes for Jetty-10 based off PR #5024 for issue #5018.\nI have changed the signature for WebSocketClient.connect() back to what it was in jetty 9.4.x, it is now taking a ClientUpgradeRequest and not the api UpgradeRequest. This is an API change so not sure if that is still okay now the beta release is out.\nI don't think we want the timeout on the org.eclipse.jetty.websocket.api.UpgradeRequest as it is only usable for the clients upgrade request anyway.", "createdAt": "2020-07-08T08:25:40Z", "url": "https://github.com/eclipse/jetty.project/pull/5031", "merged": true, "mergeCommit": {"oid": "fc473f3368ffcf47f5e9093e3fdca36745479aa9"}, "closed": true, "closedAt": "2020-07-15T23:19:48Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy10fiAH2gAyNDQ2MDc5NzcyOmExNzk1MzVkYjM2ZGUwNDA0YzhlNDI0OGQwZTBkNDJmZTNjNGQxOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1GUauAFqTQ0ODczNTg1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a179535db36de0404c8e4248d0e0d42fe3c4d196", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a179535db36de0404c8e4248d0e0d42fe3c4d196", "committedDate": "2020-07-08T08:04:36Z", "message": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/25d7b99ba1c00c75ad10140c0e9ee9c44e257de2", "committedDate": "2020-07-08T22:11:05Z", "message": "Issue #5018 - add WebSocketClient UpgradeRequest timeout to jetty 10\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3Mjg4Nzc1", "url": "https://github.com/eclipse/jetty.project/pull/5031#pullrequestreview-447288775", "createdAt": "2020-07-13T14:11:53Z", "commit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoxMTo1M1rOGwqX3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoyNjoyM1rOGwq--g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3OTA2OA==", "bodyText": "Please move this static field to the top of the class and make it private.\nAlso, no need to pass it as parameter to quoteIfNeeded().", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453679068", "createdAt": "2020-07-13T14:11:53Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -297,6 +292,25 @@ public void setSession(Object session)\n         throw new UnsupportedOperationException(\"HttpSession not available on Client request\");\n     }\n \n+    /**\n+     * @param timeout the total timeout for the request/response conversation of the WebSocket handshake;\n+     * use zero or a negative value to disable the timeout\n+     * @param unit the timeout unit\n+     */\n+    public void setTimeout(long timeout, TimeUnit unit)\n+    {\n+        this.timeout = unit.toMillis(timeout);\n+    }\n+\n+    /**\n+     * @return the total timeout for this request, in milliseconds;\n+     * zero or negative if the timeout is disabled\n+     */\n+    public long getTimeout()\n+    {\n+        return timeout;\n+    }\n+\n     /**\n      * ABNF from RFC 2616, RFC 822, and RFC 6455 specified characters requiring quoting.\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw==", "bodyText": "Return the hardcoded value HttpVersion.HTTP_1_1.asString().\nWe don't want to throw if someone calls this method for logging purposes.", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453680647", "createdAt": "2020-07-13T14:14:24Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -161,13 +161,13 @@ public String getHost()\n     @Override\n     public String getHttpVersion()\n     {\n-        return httpVersion;\n+        throw new UnsupportedOperationException(\"HttpVersion not available on ClientUpgradeRequest\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDk2Nw==", "bodyText": "Return hardcoded HttpMethod.GET.asString().", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453680967", "createdAt": "2020-07-13T14:14:53Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -161,13 +161,13 @@ public String getHost()\n     @Override\n     public String getHttpVersion()\n     {\n-        return httpVersion;\n+        throw new UnsupportedOperationException(\"HttpVersion not available on ClientUpgradeRequest\");\n     }\n \n     @Override\n     public String getMethod()\n     {\n-        return method;\n+        throw new UnsupportedOperationException(\"Method not available on ClientUpgradeRequest\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4NDgwNw==", "bodyText": "You don't need to allocate this CF, just return what whenComplete() returns below.", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453684807", "createdAt": "2020-07-13T14:20:17Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -149,9 +149,8 @@ public void onHandshakeResponse(HttpRequest request, HttpResponse response)\n                 }\n             });\n         }\n-        upgradeRequest.setConfiguration(configurationCustomizer);\n-        CompletableFuture<Session> futureSession = new CompletableFuture<>();\n \n+        CompletableFuture<Session> futureSession = new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4ODQ5Ng==", "bodyText": "Uh, no. It's a mistake that request.getHeaders() returns a HttpFields.Mutable.\nI'll fix jetty-10.0.x so please rebase this PR.\nThis code should be: headers(fields -> request.getHeaders().forEach(fields::put)).", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453688496", "createdAt": "2020-07-13T14:25:33Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/impl/JettyClientUpgradeRequest.java", "diffHunk": "@@ -53,15 +50,7 @@ public JettyClientUpgradeRequest(WebSocketCoreClient coreClient, UpgradeRequest\n             request.getHeaders().forEach(fields::put);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTA4Mg==", "bodyText": "No need for the comment.", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r453689082", "createdAt": "2020-07-13T14:26:23Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/impl/JettyClientUpgradeRequest.java", "diffHunk": "@@ -71,13 +60,8 @@ public JettyClientUpgradeRequest(WebSocketCoreClient coreClient, UpgradeRequest\n                 .map(c -> new ExtensionConfig(c.getName(), c.getParameters()))\n                 .collect(Collectors.toList()));\n \n-            // Copy method from upgradeRequest object\n-            if (request.getMethod() != null)\n-                method(request.getMethod());\n-\n-            // Copy version from upgradeRequest object\n-            if (request.getHttpVersion() != null)\n-                version(HttpVersion.fromString(request.getHttpVersion()));\n+            // Copy timeout from upgradeRequest object", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df34a6269b658f4faf1a06d081fb0c6063677e96", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/df34a6269b658f4faf1a06d081fb0c6063677e96", "committedDate": "2020-07-14T06:39:23Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5018-WebSocketClientRequestTimeout\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "145dcf502ce20fb4231d78c95b53664590142422", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/145dcf502ce20fb4231d78c95b53664590142422", "committedDate": "2020-07-14T06:52:50Z", "message": "cleanups after merge\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODk0OTYw", "url": "https://github.com/eclipse/jetty.project/pull/5031#pullrequestreview-447894960", "createdAt": "2020-07-14T08:25:30Z", "commit": {"oid": "145dcf502ce20fb4231d78c95b53664590142422"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODoyNTozMFrOGxJhsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODoyNTozMFrOGxJhsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE4OTQ4OA==", "bodyText": "@lachlan-roberts so why there are these 2 methods then? A relic of 9.4.x?\nIf we cannot implement them like you correctly point out, let's remove them.", "url": "https://github.com/eclipse/jetty.project/pull/5031#discussion_r454189488", "createdAt": "2020-07-14T08:25:30Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/ClientUpgradeRequest.java", "diffHunk": "@@ -161,13 +161,13 @@ public String getHost()\n     @Override\n     public String getHttpVersion()\n     {\n-        return httpVersion;\n+        throw new UnsupportedOperationException(\"HttpVersion not available on ClientUpgradeRequest\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4MDY0Nw=="}, "originalCommit": {"oid": "25d7b99ba1c00c75ad10140c0e9ee9c44e257de2"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzI1NTA5", "url": "https://github.com/eclipse/jetty.project/pull/5031#pullrequestreview-448725509", "createdAt": "2020-07-15T08:11:51Z", "commit": {"oid": "145dcf502ce20fb4231d78c95b53664590142422"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzM1ODU5", "url": "https://github.com/eclipse/jetty.project/pull/5031#pullrequestreview-448735859", "createdAt": "2020-07-15T08:25:48Z", "commit": {"oid": "145dcf502ce20fb4231d78c95b53664590142422"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 362, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}