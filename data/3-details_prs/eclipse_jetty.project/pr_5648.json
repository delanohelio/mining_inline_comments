{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNTE3NTMy", "number": 5648, "title": "Use Filter name to identify the WebSocketUpgradeFilter.", "bodyText": "Don't allow configuration of WebSocketMapping attribute.\nThe WebSocketUpgradeFilter is identified by it's name, which must be set as the fully qualified class name.", "createdAt": "2020-11-13T11:14:12Z", "url": "https://github.com/eclipse/jetty.project/pull/5648", "merged": true, "mergeCommit": {"oid": "eeba2c475489f9d9691da039234adfa0c2287714"}, "closed": true, "closedAt": "2020-11-23T15:47:14Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcFI3-AH2gAyNTIwNTE3NTMyOjA0OTNhMTExMDY3ZmM1N2ExZTU1ZGEyZTZlYjg2MDhjMzQ1OTNkOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfWnN1AFqTUzNjU2MzM0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0493a111067fc57a1e55da2e6eb8608c34593d9f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/0493a111067fc57a1e55da2e6eb8608c34593d9f", "committedDate": "2020-11-13T11:06:20Z", "message": "Use Filter name to identify the WebSocketUpgradeFilter.\n\nDon't allow configuration of WebSocketMapping attribute.\nThe WebSocketUpgradeFilter is identified by it's name, which must be set as the fully qualified class name.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDA2NjEz", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-530006613", "createdAt": "2020-11-13T12:04:02Z", "commit": {"oid": "0493a111067fc57a1e55da2e6eb8608c34593d9f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165beff3f36fddf0c9a5e105a39a9ac12e41d658", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/165beff3f36fddf0c9a5e105a39a9ac12e41d658", "committedDate": "2020-11-13T23:43:14Z", "message": "add test for multiple WebSocketUpgradeFilters\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dad0b1b7e62b47efb2d4e8b748446a15479d4f5", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/6dad0b1b7e62b47efb2d4e8b748446a15479d4f5", "committedDate": "2020-11-13T23:46:09Z", "message": "rename WebSocketMapping to WebSocketMappings\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDg3NDQy", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-530487442", "createdAt": "2020-11-13T23:55:47Z", "commit": {"oid": "6dad0b1b7e62b47efb2d4e8b748446a15479d4f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzo1NTo0OFrOHzDOzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzo1NTo0OFrOHzDOzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5MjM2NA==", "bodyText": "Could we simplify this to just WebSocketUpgradeFilter instead of the fully qualified class name?", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r523292364", "createdAt": "2020-11-13T23:55:48Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-javax-tests/src/test/resources/alt-filter-web.xml", "diffHunk": "@@ -12,16 +12,12 @@\n   </context-param>\n \n   <filter>\n-    <filter-name>wsuf-test</filter-name>\n+    <filter-name>org.eclipse.jetty.websocket.util.server.WebSocketUpgradeFilter</filter-name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dad0b1b7e62b47efb2d4e8b748446a15479d4f5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b22c6bc66115bc013b7b696d10dbe0a3d22e20d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/3b22c6bc66115bc013b7b696d10dbe0a3d22e20d", "committedDate": "2020-11-16T04:57:28Z", "message": "fix broken test: AltFilterTest\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjE3Nzg5", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-531217789", "createdAt": "2020-11-16T11:01:48Z", "commit": {"oid": "3b22c6bc66115bc013b7b696d10dbe0a3d22e20d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDM3ODk5", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-531437899", "createdAt": "2020-11-16T15:36:46Z", "commit": {"oid": "3b22c6bc66115bc013b7b696d10dbe0a3d22e20d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52e61156d3118b40b57294df906a27a4fd82b7e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f52e61156d3118b40b57294df906a27a4fd82b7e", "committedDate": "2020-11-17T09:57:21Z", "message": "add test for a subclassed WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMjM2NTg2", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-532236586", "createdAt": "2020-11-17T10:45:50Z", "commit": {"oid": "f52e61156d3118b40b57294df906a27a4fd82b7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "committedDate": "2020-11-18T04:10:14Z", "message": "Add tests for the ordering of the default WebSocketUpgradeFilter.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjIwNDc3", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-533220477", "createdAt": "2020-11-18T08:50:32Z", "commit": {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo1MDozMlrOH1jDRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo1Mzo1NVrOH1jLkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMDg1Mg==", "bodyText": "Use version 4.0 for XMLs.", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r525910852", "createdAt": "2020-11-18T08:50:32Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketWebApp.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.eclipse.jetty.websocket.tests;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+\n+import org.eclipse.jetty.toolchain.test.FS;\n+import org.eclipse.jetty.toolchain.test.IO;\n+import org.eclipse.jetty.toolchain.test.MavenTestingUtils;\n+import org.eclipse.jetty.util.TypeUtil;\n+import org.eclipse.jetty.util.resource.PathResource;\n+import org.eclipse.jetty.webapp.WebAppContext;\n+import org.eclipse.jetty.websocket.server.config.JettyWebSocketConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public class JettyWebSocketWebApp extends WebAppContext\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger(JettyWebSocketWebApp.class);\n+\n+    private final Path contextDir;\n+    private final Path webInf;\n+    private final Path classesDir;\n+\n+    public JettyWebSocketWebApp(String contextName)\n+    {\n+        // Ensure context directory.\n+        Path testDir = MavenTestingUtils.getTargetTestingPath(JettyWebSocketWebApp.class.getName());\n+        contextDir = testDir.resolve(contextName);\n+        FS.ensureEmpty(contextDir);\n+\n+        // Ensure WEB-INF directories.\n+        webInf = contextDir.resolve(\"WEB-INF\");\n+        FS.ensureDirExists(webInf);\n+        classesDir = webInf.resolve(\"classes\");\n+        FS.ensureDirExists(classesDir);\n+\n+        // Configure the WebAppContext.\n+        setContextPath(\"/\" + contextName);\n+        setBaseResource(new PathResource(contextDir));\n+        addConfiguration(new JettyWebSocketConfiguration());\n+    }\n+\n+    public Path getContextDir()\n+    {\n+        return contextDir;\n+    }\n+\n+    public void createWebXml() throws IOException\n+    {\n+        String emptyWebXml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\" +\n+            \"<web-app xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://java.sun.com/xml/ns/javaee\\\" \" +\n+            \"xsi:schemaLocation=\\\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd\\\" \" +\n+            \"metadata-complete=\\\"false\\\" version=\\\"3.0\\\"></web-app>\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMTg3OA==", "bodyText": "Is the filter class required? I ask because for e.g. the default Servlet is not required, and would be great to avoid the duplication between filter-name and filter-class.", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r525911878", "createdAt": "2020-11-18T08:52:12Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-tests/src/test/resources/wsuf-ordering2.xml", "diffHunk": "@@ -0,0 +1,32 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<web-app\n+  xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee\n+\t\t http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd\"\n+  version=\"3.1\">\n+\n+  <!-- Make sure the default filter is first. -->\n+  <filter>\n+    <filter-name>org.eclipse.jetty.websocket.util.server.WebSocketUpgradeFilter</filter-name>\n+    <filter-class>org.eclipse.jetty.websocket.util.server.WebSocketUpgradeFilter</filter-class>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMjk3OA==", "bodyText": "This is a surprise... I thought the default filter was always the first? IMHO it would be better if it is, unless too complicated.", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r525912978", "createdAt": "2020-11-18T08:53:55Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketFilterTest.java", "diffHunk": "@@ -297,6 +308,98 @@ public void testCustomUpgradeFilter() throws Exception\n         assertThat(socket.textMessages.poll(), is(\"hElLo wOrLd\"));\n     }\n \n+    @Test\n+    public void testDefaultWebSocketUpgradeFilterOrdering() throws Exception\n+    {\n+        String timeoutFromAltFilter = \"5999\";\n+        JettyWebSocketWebApp webApp = new JettyWebSocketWebApp(\"wsuf-ordering1\");\n+        Path webXml = MavenTestingUtils.getTestResourcePath(\"wsuf-ordering1.xml\");\n+        webApp.copyWebXml(webXml);\n+        webApp.copyClass(WebSocketEchoServletContextListener.class);\n+        webApp.copyClass(WebSocketEchoServletContextListener.EchoSocket.class);\n+\n+        server.setHandler(webApp);\n+        server.start();\n+        client.start();\n+\n+        // We have both websocket upgrade filters installed.\n+        FilterHolder[] filterHolders = webApp.getServletHandler().getFilters();\n+        assertThat(filterHolders.length, is(2));\n+        assertThat(filterHolders[0].getFilter(), instanceOf(WebSocketUpgradeFilter.class));\n+        assertThat(filterHolders[1].getFilter(), instanceOf(WebSocketUpgradeFilter.class));\n+\n+        // The custom filter defined in web.xml should be first in line so it will do the upgrade.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a83a261e10d7522b9689b63e3eed8346442d579", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/6a83a261e10d7522b9689b63e3eed8346442d579", "committedDate": "2020-11-18T10:27:25Z", "message": "Always add the default WebSocketUpgradeFilter as the first filter.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODIyNjY1", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-533822665", "createdAt": "2020-11-18T19:54:19Z", "commit": {"oid": "6a83a261e10d7522b9689b63e3eed8346442d579"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bc4ee6509808d6dd7e1602a95d7515c4e6ac378", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7bc4ee6509808d6dd7e1602a95d7515c4e6ac378", "committedDate": "2020-11-18T20:48:16Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfdcf3e4cc7946b56b15c600e7672c3466c4d91f", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/dfdcf3e4cc7946b56b15c600e7672c3466c4d91f", "committedDate": "2020-11-20T18:11:41Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d52c1fc4785f414a95a613dcb32d5d4071e3219f", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/d52c1fc4785f414a95a613dcb32d5d4071e3219f", "committedDate": "2020-11-23T15:04:34Z", "message": "Merged branch 'jetty-10.0.x' into 'jetty-10.0.x-WebSocketUpgradeFilter'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTYzMzQ4", "url": "https://github.com/eclipse/jetty.project/pull/5648#pullrequestreview-536563348", "createdAt": "2020-11-23T15:09:38Z", "commit": {"oid": "d52c1fc4785f414a95a613dcb32d5d4071e3219f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4967, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}