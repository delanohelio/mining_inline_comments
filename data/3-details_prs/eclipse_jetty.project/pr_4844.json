{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDMyODcx", "number": 4844, "title": "proxy v2 skip address length bytes when LOCAL command is specified", "bodyText": "Fixes #4843", "createdAt": "2020-05-04T15:47:25Z", "url": "https://github.com/eclipse/jetty.project/pull/4844", "merged": true, "mergeCommit": {"oid": "c50a52a392a5db624c939f985f5665c2f836d54e"}, "closed": true, "closedAt": "2020-05-07T15:16:58Z", "author": {"login": "lorban"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceQFhDgBqjMzMDMyNTUzNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcep9DKAFqTQwNjY5ODA1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6077bdf2f1d62b8f35b43300767251a4be4ae409", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/6077bdf2f1d62b8f35b43300767251a4be4ae409", "committedDate": "2020-05-04T15:46:12Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}, "afterCommit": {"oid": "e857957aa4936b2a1761e7c60785f303df90dda6", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/e857957aa4936b2a1761e7c60785f303df90dda6", "committedDate": "2020-05-05T08:48:06Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e857957aa4936b2a1761e7c60785f303df90dda6", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/e857957aa4936b2a1761e7c60785f303df90dda6", "committedDate": "2020-05-05T08:48:06Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}, "afterCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/70f873904a7ad3cd0438e5e514e86042eef866dd", "committedDate": "2020-05-05T08:49:32Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjgxMzg3", "url": "https://github.com/eclipse/jetty.project/pull/4844#pullrequestreview-405681387", "createdAt": "2020-05-05T10:56:03Z", "commit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1NjowNFrOGQkM9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToyMlrOGQkTNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMzU0Mg==", "bodyText": "I don't think this is correct.\nBy this point, the buffer is guaranteed to have at least _length bytes in it, so Math.min() is not necessary.\nFurthermore, I think it's wrong for LOCAL to upgrade the connection (it happens few lines below) - it was probably wrong before too.\nI don't know exactly what needs to be done when receiving a LOCAL command though - perhaps just read and discard until -1. Let's discuss this.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420023542", "createdAt": "2020-05-05T10:56:04Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ProxyConnectionFactory.java", "diffHunk": "@@ -662,6 +662,10 @@ private void parseBodyAndUpgrade() throws IOException\n                     if (LOG.isDebugEnabled())\n                         LOG.debug(\"Proxy v2 {} {}\", getEndPoint(), proxyEndPoint.toString());\n                 }\n+                else\n+                {\n+                    _buffer.position(_buffer.position() + Math.min(_buffer.remaining(), _length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNDc0MA==", "bodyText": "I'm not sure you should get back a 200 OK response for a LOCAL command.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420024740", "createdAt": "2020-05-05T10:58:32Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyConnectionTest.java", "diffHunk": "@@ -151,6 +151,39 @@ public void testIPv6V2(RequestProcessor p) throws Exception\n         assertThat(response, Matchers.containsString(\"remote=ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff:12345\"));\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"requestProcessors\")\n+    public void testLocalV2(RequestProcessor p) throws Exception\n+    {\n+        String proxy =\n+            // Preamble\n+            \"0D0A0D0A000D0A515549540A\" +\n+\n+                // V2, LOCAL\n+                \"20\" +\n+\n+                // 0x1 : AF_INET    0x1 : STREAM.\n+                \"11\" +\n+\n+                // Address length is 16.\n+                \"0010\" +\n+\n+                // gibberish\n+                \"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\"\n+            ;\n+        String http = \"GET /path HTTP/1.1\\n\" +\n+            \"Host: server:80\\n\" +\n+            \"Connection: close\\n\" +\n+            \"\\n\";\n+\n+        String response = p.sendRequestWaitingForResponse(TypeUtil.fromHexString(proxy), http.getBytes(StandardCharsets.US_ASCII));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNTE0MQ==", "bodyText": "I'm not sure a LOCAL command should reply to HTTP requests.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420025141", "createdAt": "2020-05-05T10:59:22Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyProtocolTest.java", "diffHunk": "@@ -193,4 +193,81 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n             }\n         }\n     }\n+\n+    @Test\n+    public void testProxyProtocolV2Local() throws Exception\n+    {\n+        start(new AbstractHandler()\n+        {\n+            @Override\n+            public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException\n+            {\n+                baseRequest.setHandled(true);\n+            }\n+        });\n+\n+        try (Socket socket = new Socket(\"localhost\", connector.getLocalPort()))\n+        {\n+            String proxy =\n+                // Preamble\n+                \"0D0A0D0A000D0A515549540A\" +\n+\n+                    // V2, LOCAL\n+                    \"20\" +\n+\n+                    // 0x1 : AF_INET    0x1 : STREAM.  Address length is 2*4 + 2*2 = 12 bytes.\n+                    \"11\" +\n+\n+                    // length of remaining header (4+4+2+2+6+3 = 21)\n+                    \"0015\" +\n+\n+                    // uint32_t src_addr; uint32_t dst_addr; uint16_t src_port; uint16_t dst_port;\n+                    \"C0A80001\" +\n+                    \"7f000001\" +\n+                    \"3039\" +\n+                    \"1F90\" +\n+\n+                    // NOOP value 0\n+                    \"040000\" +\n+\n+                    // NOOP value ABCDEF\n+                    \"040003ABCDEF\";\n+\n+            String request1 =\n+                \"GET /1 HTTP/1.1\\r\\n\" +\n+                    \"Host: localhost\\r\\n\" +\n+                    \"\\r\\n\";\n+            OutputStream output = socket.getOutputStream();\n+            output.write(TypeUtil.fromHexString(proxy));\n+            output.write(request1.getBytes(StandardCharsets.UTF_8));\n+            output.flush();\n+\n+            InputStream input = socket.getInputStream();\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8));\n+            String response1 = reader.readLine();\n+            assertTrue(response1.startsWith(\"HTTP/1.1 200 \"));\n+            while (true)\n+            {\n+                if (reader.readLine().isEmpty())\n+                    break;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/d34cb2598b4199d01a67eba37c800910ac4e409d", "committedDate": "2020-05-05T11:51:30Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/70f873904a7ad3cd0438e5e514e86042eef866dd", "committedDate": "2020-05-05T08:49:32Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}, "afterCommit": {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/d34cb2598b4199d01a67eba37c800910ac4e409d", "committedDate": "2020-05-05T11:51:30Z", "message": "proxy v2 skip address length bytes when LOCAL command is specified\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzQ2MDA5", "url": "https://github.com/eclipse/jetty.project/pull/4844#pullrequestreview-405746009", "createdAt": "2020-05-05T12:39:08Z", "commit": {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2Njk4MDU3", "url": "https://github.com/eclipse/jetty.project/pull/4844#pullrequestreview-406698057", "createdAt": "2020-05-06T14:56:36Z", "commit": {"oid": "d34cb2598b4199d01a67eba37c800910ac4e409d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 375, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}