{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2Mzk1NDQ4", "number": 4931, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMTo0MDo1NlrOEB-R7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyOTo1NFrOESWOdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTA0NDI5OnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMTo0MDo1NlrOGeJUbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToxOTo0OFrOGkSwUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzE1MQ==", "bodyText": "Not sure how we should stop accepting new incoming connections before this.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r434263151", "createdAt": "2020-06-03T01:40:56Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -260,4 +262,19 @@ protected void doStart() throws Exception\n             deferredEndpointConfigs.clear();\n         }\n     }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        LifeCycle.stop(sessionTracker);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9423a8753e49bc1dcc61121ab18286f855c23b3a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk0OTE3Ng==", "bodyText": "Can stopping the sessionTracker take time? Can it block? Can it call user code?   If any of the above, then this is precisely what we don't want to do in a shutdown thread.   Why can't this be done in doStop?  at the very least a comment is needed, but I think a different approach is required.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r437949176", "createdAt": "2020-06-10T08:24:52Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -260,4 +262,19 @@ protected void doStart() throws Exception\n             deferredEndpointConfigs.clear();\n         }\n     }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        LifeCycle.stop(sessionTracker);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzE1MQ=="}, "originalCommit": {"oid": "9423a8753e49bc1dcc61121ab18286f855c23b3a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwOTIwMw==", "bodyText": "It won't block in jetty code but it will call the user code with onClosed. We already stop the SessionTracker when the server is stopped (in 9.4 as well) so if this is an issue it already exists in the codebase before this change.\nThe problem here is that Server.doStop() shuts down all the connectors before calling super.doStop() and this closes the existing connections. So we can't react to the stop and close the WebSocket sessions as all the existing connections have already been closed.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r440709203", "createdAt": "2020-06-16T09:19:48Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -260,4 +262,19 @@ protected void doStart() throws Exception\n             deferredEndpointConfigs.clear();\n         }\n     }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        LifeCycle.stop(sessionTracker);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzE1MQ=="}, "originalCommit": {"oid": "9423a8753e49bc1dcc61121ab18286f855c23b3a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNjk1MDk4OnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDozNDozMFrOGu4RSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo0NTozN1rOGu4m6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgwOTYxMA==", "bodyText": "Try something like the below.  This lets the caller wait for this to complete or not, as it likes.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                {\n          \n          \n            \n                    LifeCycle.stop(sessionTracker);\n          \n          \n            \n                    CompletableFuture<Void> shutdown = new CompletableFuture<>();\n          \n          \n            \n                    shutdown.complete(null);\n          \n          \n            \n                    return shutdown;\n          \n          \n            \n                }\n          \n          \n            \n                {\n          \n          \n            \n                    CompletableFuture<Void> shutdown = new CompletableFuture<>();\n          \n          \n            \n                    new Thread(()->\n          \n          \n            \n                    {\n          \n          \n            \n                        try\n          \n          \n            \n                        {\n          \n          \n            \n                            LifeCycle.stop(sessionTracker);\n          \n          \n            \n                        }\n          \n          \n            \n                        catch(Exception e)\n          \n          \n            \n                        {\n          \n          \n            \n                            LOG.warn(e);\n          \n          \n            \n                        }\n          \n          \n            \n                        finally\n          \n          \n            \n                        {\n          \n          \n            \n                            shutdown.complete(null);\n          \n          \n            \n                        }\n          \n          \n            \n                    }.start();\n          \n          \n            \n                    return shutdown;\n          \n          \n            \n                }", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r451809610", "createdAt": "2020-07-08T20:34:30Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -301,4 +303,19 @@ protected void doStart() throws Exception\n             deferredEndpointConfigs.clear();\n         }\n     }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        LifeCycle.stop(sessionTracker);\n+        CompletableFuture<Void> shutdown = new CompletableFuture<>();\n+        shutdown.complete(null);\n+        return shutdown;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed9c60fc90c7969b200699f977e43c328311da6e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxNTE0NA==", "bodyText": "Shouldn't the exception be caught and cause the shutdown CompletableFuture to fail with an exception?", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r451815144", "createdAt": "2020-07-08T20:45:37Z", "author": {"login": "joakime"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -301,4 +303,19 @@ protected void doStart() throws Exception\n             deferredEndpointConfigs.clear();\n         }\n     }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        LifeCycle.stop(sessionTracker);\n+        CompletableFuture<Void> shutdown = new CompletableFuture<>();\n+        shutdown.complete(null);\n+        return shutdown;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgwOTYxMA=="}, "originalCommit": {"oid": "ed9c60fc90c7969b200699f977e43c328311da6e"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjgzNTE4OnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOToyMDo0MVrOG0CAcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMzo1NzoxMlrOG2id-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMjAxNg==", "bodyText": "This thread should be a daemon thread so it doesn't stop the JVM exiting.\nI'm also wondering if we should implement cancel on the CompletableFuture and interrupt the thread if it is called?\nWe might then need some support in Graceful.shutdown or Server.doStop to actually do that cancel.... but perhaps that is feature creep for this PR.   So let's just make this thread look OK", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r457212016", "createdAt": "2020-07-20T09:20:41Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -307,9 +307,22 @@ protected void doStart() throws Exception\n     @Override\n     public CompletableFuture<Void> shutdown()\n     {\n-        LifeCycle.stop(sessionTracker);\n         CompletableFuture<Void> shutdown = new CompletableFuture<>();\n-        shutdown.complete(null);\n+        new Thread(() ->\n+        {\n+            try\n+            {\n+                LifeCycle.stop(sessionTracker);\n+            }\n+            catch (Throwable t)\n+            {\n+                LOG.warn(\"Error while stopping SessionTracker\", t);\n+            }\n+            finally\n+            {\n+                shutdown.complete(null);\n+            }\n+        }).start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7f2e3e56366b95b46ed2e861dd9a3a9325c3d4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzQ2Mw==", "bodyText": "I think we might have a bigger problem here if SessionTracker.doStop() needs to be called by a different thread. We also use the SessionTracker on the client which would have the same issue. So we shouldn't store the SessionTracker as a bean anymore and its lifecycle needs to be manually managed.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r458533463", "createdAt": "2020-07-22T04:54:28Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -307,9 +307,22 @@ protected void doStart() throws Exception\n     @Override\n     public CompletableFuture<Void> shutdown()\n     {\n-        LifeCycle.stop(sessionTracker);\n         CompletableFuture<Void> shutdown = new CompletableFuture<>();\n-        shutdown.complete(null);\n+        new Thread(() ->\n+        {\n+            try\n+            {\n+                LifeCycle.stop(sessionTracker);\n+            }\n+            catch (Throwable t)\n+            {\n+                LOG.warn(\"Error while stopping SessionTracker\", t);\n+            }\n+            finally\n+            {\n+                shutdown.complete(null);\n+            }\n+        }).start();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMjAxNg=="}, "originalCommit": {"oid": "9f7f2e3e56366b95b46ed2e861dd9a3a9325c3d4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3MzcyNA==", "bodyText": "Ah yes, stop() is synchronized.\nI think the SessionTracker should remain as a managed bean so it is stopped normally if the container is stopped, but that shutdown should first remove the tracker as a bean and then stop it in another thread.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r458873724", "createdAt": "2020-07-22T15:19:58Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -307,9 +307,22 @@ protected void doStart() throws Exception\n     @Override\n     public CompletableFuture<Void> shutdown()\n     {\n-        LifeCycle.stop(sessionTracker);\n         CompletableFuture<Void> shutdown = new CompletableFuture<>();\n-        shutdown.complete(null);\n+        new Thread(() ->\n+        {\n+            try\n+            {\n+                LifeCycle.stop(sessionTracker);\n+            }\n+            catch (Throwable t)\n+            {\n+                LOG.warn(\"Error while stopping SessionTracker\", t);\n+            }\n+            finally\n+            {\n+                shutdown.complete(null);\n+            }\n+        }).start();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMjAxNg=="}, "originalCommit": {"oid": "9f7f2e3e56366b95b46ed2e861dd9a3a9325c3d4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MTAxNw==", "bodyText": "Wasn't the whole point of this so that we never called the SessionTracker stop if the container is stopped as it could block in an onClosed? So why would we still have the SessionTracker as a managed bean on the container.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r459841017", "createdAt": "2020-07-24T03:57:12Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/internal/JavaxWebSocketServerContainer.java", "diffHunk": "@@ -307,9 +307,22 @@ protected void doStart() throws Exception\n     @Override\n     public CompletableFuture<Void> shutdown()\n     {\n-        LifeCycle.stop(sessionTracker);\n         CompletableFuture<Void> shutdown = new CompletableFuture<>();\n-        shutdown.complete(null);\n+        new Thread(() ->\n+        {\n+            try\n+            {\n+                LifeCycle.stop(sessionTracker);\n+            }\n+            catch (Throwable t)\n+            {\n+                LOG.warn(\"Error while stopping SessionTracker\", t);\n+            }\n+            finally\n+            {\n+                shutdown.complete(null);\n+            }\n+        }).start();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMjAxNg=="}, "originalCommit": {"oid": "9f7f2e3e56366b95b46ed2e861dd9a3a9325c3d4"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MjgzODk2OnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-jetty-server/src/main/java/org/eclipse/jetty/websocket/server/JettyWebSocketServerContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOToyMToyOFrOG0CClQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOToyMToyOFrOG0CClQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxMjU2NQ==", "bodyText": "Same comments as above.... looking like we need a utility class to do this threadful stopping.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r457212565", "createdAt": "2020-07-20T09:21:28Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-jetty-server/src/main/java/org/eclipse/jetty/websocket/server/JettyWebSocketServerContainer.java", "diffHunk": "@@ -267,9 +267,22 @@ public void setAutoFragment(boolean autoFragment)\n     @Override\n     public CompletableFuture<Void> shutdown()\n     {\n-        LifeCycle.stop(sessionTracker);\n         CompletableFuture<Void> shutdown = new CompletableFuture<>();\n-        shutdown.complete(null);\n+        new Thread(() ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7f2e3e56366b95b46ed2e861dd9a3a9325c3d4"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NjcxNjExOnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-util/src/main/java/org/eclipse/jetty/websocket/util/ShutdownUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyMjoyNlrOG3eUhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyMjoyNlrOG3eUhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyMTYzNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static CompletableFuture<Void> shutdown(LifeCycle lifeCycle)\n          \n          \n            \n                public static CompletableFuture<Void> stop(LifeCycle lifeCycle)", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r460821636", "createdAt": "2020-07-27T11:22:26Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-util/src/main/java/org/eclipse/jetty/websocket/util/ShutdownUtil.java", "diffHunk": "@@ -0,0 +1,75 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.websocket.util;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.eclipse.jetty.util.component.LifeCycle;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ShutdownUtil\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger(ShutdownUtil.class);\n+\n+    /**\n+     * Shutdown a {@link LifeCycle} in a new daemon thread and be notified on the result in a {@link CompletableFuture}.\n+     * @param lifeCycle the LifeCycle to stop.\n+     * @return the CompletableFuture to be notified when the stop either completes or fails.\n+     */\n+    public static CompletableFuture<Void> shutdown(LifeCycle lifeCycle)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NjcyNzg1OnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-util/src/main/java/org/eclipse/jetty/websocket/util/ShutdownUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyNjoxMlrOG3ebgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyNjoxMlrOG3ebgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyMzQyNg==", "bodyText": "This is good.\nBut now you should probably modify the loop in SessionTracker.doStop() to check if interrupted and if so it can break the iteration.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r460823426", "createdAt": "2020-07-27T11:26:12Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-util/src/main/java/org/eclipse/jetty/websocket/util/ShutdownUtil.java", "diffHunk": "@@ -0,0 +1,75 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.websocket.util;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.eclipse.jetty.util.component.LifeCycle;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ShutdownUtil\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger(ShutdownUtil.class);\n+\n+    /**\n+     * Shutdown a {@link LifeCycle} in a new daemon thread and be notified on the result in a {@link CompletableFuture}.\n+     * @param lifeCycle the LifeCycle to stop.\n+     * @return the CompletableFuture to be notified when the stop either completes or fails.\n+     */\n+    public static CompletableFuture<Void> shutdown(LifeCycle lifeCycle)\n+    {\n+        AtomicReference<Thread> stopThreadReference = new AtomicReference<>();\n+        CompletableFuture<Void> shutdown = new CompletableFuture<>()\n+        {\n+            @Override\n+            public boolean cancel(boolean mayInterruptIfRunning)\n+            {\n+                boolean canceled = super.cancel(mayInterruptIfRunning);\n+                if (canceled && mayInterruptIfRunning)\n+                {\n+                    Thread thread = stopThreadReference.get();\n+                    if (thread != null)\n+                        thread.interrupt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NjczNzgyOnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyOToyMVrOG3ehWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0MDozNFrOG4AdeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyNDkyMg==", "bodyText": "Hmmmm I don't really like such hard coded default timeouts.... but at least there is a setter.\nWhat happens if you make the default wait forever?", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r460824922", "createdAt": "2020-07-27T11:29:21Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -68,6 +71,7 @@\n     private final Configuration.ConfigurationCustomizer configurationCustomizer = new Configuration.ConfigurationCustomizer();\n     private final WebSocketComponents components = new WebSocketComponents();\n     private boolean stopAtShutdown = false;\n+    private long _stopTimeout = 200;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDk4NA==", "bodyText": "I have changed this default to Long.MAX_VALUE, so it will always do the proper close of all the sessions, which is fine assuming it doesn't block in user code in onClosed.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r461380984", "createdAt": "2020-07-28T07:40:34Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -68,6 +71,7 @@\n     private final Configuration.ConfigurationCustomizer configurationCustomizer = new Configuration.ConfigurationCustomizer();\n     private final WebSocketComponents components = new WebSocketComponents();\n     private boolean stopAtShutdown = false;\n+    private long _stopTimeout = 200;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyNDkyMg=="}, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NjczOTczOnYy", "diffSide": "RIGHT", "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMToyOTo1NFrOG3eigw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0MDozNVrOG4Adfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyNTIxOQ==", "bodyText": "Need javadoc: what are the units? Can it be disabled? Can it be set to wait forever?", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r460825219", "createdAt": "2020-07-27T11:29:54Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -388,11 +391,48 @@ public synchronized void setStopAtShutdown(boolean stop)\n         stopAtShutdown = stop;\n     }\n \n+    public void setStopTimeout(long stopTimeout)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDk5MA==", "bodyText": "It works exactly the same as Server stopTimemout, if it is less or equal to 0 we don't attempt a graceful stop, if it is greater than 0 we use the value.", "url": "https://github.com/eclipse/jetty.project/pull/4931#discussion_r461380990", "createdAt": "2020-07-28T07:40:35Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-jetty-client/src/main/java/org/eclipse/jetty/websocket/client/WebSocketClient.java", "diffHunk": "@@ -388,11 +391,48 @@ public synchronized void setStopAtShutdown(boolean stop)\n         stopAtShutdown = stop;\n     }\n \n+    public void setStopTimeout(long stopTimeout)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyNTIxOQ=="}, "originalCommit": {"oid": "e13d26ab45e6490fbf73ba01a8eb239553d138a0"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2583, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}