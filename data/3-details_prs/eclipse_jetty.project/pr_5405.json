{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTM3NDI1", "number": 5405, "title": "Issue #5378 - add test to reproduce issue with WebSocketUpgradeFilter not started", "bodyText": "Issue #5378\nImprove testing with the WebSocketUpgradeFilter, and reproduce the original failure from cometd.\nThis should pass tests once the fix from PR #5397 is merged into this branch.", "createdAt": "2020-10-07T21:53:33Z", "url": "https://github.com/eclipse/jetty.project/pull/5405", "merged": true, "mergeCommit": {"oid": "967749bf92300a29908eb962bf10008e3c9f20d4"}, "closed": true, "closedAt": "2020-10-08T11:46:13Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQUH_PgH2gAyNDk5NTM3NDI1OjJhNGQ2NzJmYzFjY2Y4MmE1N2VlNmE5OGZlMGE3MThkY2RmM2IxMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQc0rLAFqTUwNDUxNjAzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a4d672fc1ccf82a57ee6a98fe0a718dcdf3b104", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2a4d672fc1ccf82a57ee6a98fe0a718dcdf3b104", "committedDate": "2020-10-07T21:46:51Z", "message": "Issue #5378 - improve testing for WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7003b3c42e06425b6dc07599039b1661811c3e19", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7003b3c42e06425b6dc07599039b1661811c3e19", "committedDate": "2020-10-07T21:46:51Z", "message": "Issue #5378 - guard against concurrent requests lazily initializing the filter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d2beb2861d795a479ab89de6f9bd6446b7548648", "committedDate": "2020-10-07T22:27:09Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5378-LazyWSUpgradeFilter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTEyODgy", "url": "https://github.com/eclipse/jetty.project/pull/5405#pullrequestreview-504512882", "createdAt": "2020-10-08T07:50:43Z", "commit": {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1MDo0M1rOHeSGnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1MjoxNFrOHeSKBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTkzMg==", "bodyText": "Are there other ensureFoo methods in the websocket setup that also need such locks?", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501515932", "createdAt": "2020-10-08T07:50:43Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-util-server/src/main/java/org/eclipse/jetty/websocket/util/server/WebSocketUpgradeFilter.java", "diffHunk": "@@ -105,22 +109,27 @@ private static FilterHolder getFilter(ServletContext servletContext)\n      */\n     public static FilterHolder ensureFilter(ServletContext servletContext)\n     {\n-        FilterHolder existingFilter = WebSocketUpgradeFilter.getFilter(servletContext);\n-        if (existingFilter != null)\n-            return existingFilter;\n-\n-        final String name = \"WebSocketUpgradeFilter\";\n-        final String pathSpec = \"/*\";\n-        FilterHolder holder = new FilterHolder(new WebSocketUpgradeFilter());\n-        holder.setName(name);\n-        holder.setInitParameter(MAPPING_ATTRIBUTE_INIT_PARAM, WebSocketMapping.DEFAULT_KEY);\n-\n-        holder.setAsyncSupported(true);\n-        ServletHandler servletHandler = ContextHandler.getContextHandler(servletContext).getChildHandlerByClass(ServletHandler.class);\n-        servletHandler.addFilterWithMapping(holder, pathSpec, EnumSet.of(DispatcherType.REQUEST));\n-        if (LOG.isDebugEnabled())\n-            LOG.debug(\"Adding {} mapped to {} in {}\", holder, pathSpec, servletContext);\n-        return holder;\n+        // Lock in case two concurrent requests are initializing the filter lazily.\n+        try (AutoLock l = LOCK.lock())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNjgwNQ==", "bodyText": "Can we put a check within configure on the start of the contextHandler passed?  If it is started then it should ISE.   No sure about if it is starting?", "url": "https://github.com/eclipse/jetty.project/pull/5405#discussion_r501516805", "createdAt": "2020-10-08T07:52:14Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketFilterTest.java", "diffHunk": "@@ -45,18 +50,29 @@\n     private WebSocketClient client;\n     private ServletContextHandler contextHandler;\n \n-    @BeforeEach\n-    public void start() throws Exception\n+    public void start(JettyWebSocketServletContainerInitializer.Configurator configurator) throws Exception\n+    {\n+        start(configurator, null);\n+    }\n+\n+    public void start(ServletHolder servletHolder) throws Exception\n+    {\n+        start(null, servletHolder);\n+    }\n+\n+    public void start(JettyWebSocketServletContainerInitializer.Configurator configurator, ServletHolder servletHolder) throws Exception\n     {\n         server = new Server();\n         connector = new ServerConnector(server);\n         server.addConnector(connector);\n \n         contextHandler = new ServletContextHandler(ServletContextHandler.SESSIONS);\n         contextHandler.setContextPath(\"/\");\n+        if (servletHolder != null)\n+            contextHandler.addServlet(servletHolder, \"/\");\n         server.setHandler(contextHandler);\n \n-        JettyWebSocketServletContainerInitializer.configure(contextHandler, null);\n+        JettyWebSocketServletContainerInitializer.configure(contextHandler, configurator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTE2MDM4", "url": "https://github.com/eclipse/jetty.project/pull/5405#pullrequestreview-504516038", "createdAt": "2020-10-08T07:54:54Z", "commit": {"oid": "d2beb2861d795a479ab89de6f9bd6446b7548648"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 27, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}