{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MDA1NDMz", "number": 5219, "title": "Fixes #5217 - Review RoundRobinConnectionPool", "bodyText": "Introduced IndexedConnectionPool and RandomConnectionPool.\nClarified semantic of RoundRobinConnectionPool.\nSigned-off-by: Simone Bordet simone.bordet@gmail.com", "createdAt": "2020-09-01T11:11:17Z", "url": "https://github.com/eclipse/jetty.project/pull/5219", "merged": true, "mergeCommit": {"oid": "01135e15151a94fa5792a58fae611bb8c7b45989"}, "closed": true, "closedAt": "2020-09-09T13:31:29Z", "author": {"login": "sbordet"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdElam8gH2gAyNDc3MDA1NDMzOmYxYTgyMWYwYTlkZDY2ZDhiMjRhMDFiMmNkZjM0MmZmNmEyYTEyZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHMPA_AFqTQ4NTAwOTIwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc", "committedDate": "2020-09-01T11:08:29Z", "message": "Fixes #5217 - Review RoundRobinConnectionPool\n\nIntroduced IndexedConnectionPool and RandomConnectionPool.\nClarified semantic of RoundRobinConnectionPool.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NzYwOTg1", "url": "https://github.com/eclipse/jetty.project/pull/5219#pullrequestreview-479760985", "createdAt": "2020-09-01T13:50:14Z", "commit": {"oid": "f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzo1MDoxNVrOHK3NRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzo1MDoxNVrOHK3NRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MjMyNg==", "bodyText": "I think the cache should be forced to false, otherwise you risk reaching a steady state where one thread continuously uses the connection at the same index.", "url": "https://github.com/eclipse/jetty.project/pull/5219#discussion_r481152326", "createdAt": "2020-09-01T13:50:15Z", "author": {"login": "lorban"}, "path": "jetty-client/src/main/java/org/eclipse/jetty/client/IndexedConnectionPool.java", "diffHunk": "@@ -0,0 +1,79 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.client;\n+\n+import org.eclipse.jetty.client.api.Connection;\n+import org.eclipse.jetty.util.Callback;\n+import org.eclipse.jetty.util.Pool;\n+import org.eclipse.jetty.util.annotation.ManagedObject;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+/**\n+ * <p>A {@link MultiplexConnectionPool} that picks connections at a particular\n+ * index between {@code 0} and {@link #getMaxConnectionCount()}.</p>\n+ * <p>The algorithm that decides the index value is decided by subclasses.</p>\n+ * <p>To acquire a connection, this class obtains the index value and attempts\n+ * to activate the pool entry at that index.\n+ * If this activation fails, another attempt to activate an alternative pool\n+ * entry is performed, to avoid stalling connection acquisition if there is\n+ * an available entry at a different index.</p>\n+ */\n+@ManagedObject\n+public abstract class IndexedConnectionPool extends MultiplexConnectionPool\n+{\n+    private static final Logger LOG = Log.getLogger(IndexedConnectionPool.class);\n+\n+    private final Pool<Connection> pool;\n+\n+    public IndexedConnectionPool(HttpDestination destination, int maxConnections, boolean cache, Callback requester, int maxMultiplex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODczOTE0", "url": "https://github.com/eclipse/jetty.project/pull/5219#pullrequestreview-479873914", "createdAt": "2020-09-01T15:40:43Z", "commit": {"oid": "f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0MDo0M1rOHK8h9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0MDo0M1rOHK8h9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzOTU0MQ==", "bodyText": "When the integer goes overflows, you will start going the opposite way around the the pool", "url": "https://github.com/eclipse/jetty.project/pull/5219#discussion_r481239541", "createdAt": "2020-09-01T15:40:43Z", "author": {"login": "gregw"}, "path": "jetty-client/src/main/java/org/eclipse/jetty/client/RoundRobinConnectionPool.java", "diffHunk": "@@ -43,36 +55,16 @@ public RoundRobinConnectionPool(HttpDestination destination, int maxConnections,\n     public RoundRobinConnectionPool(HttpDestination destination, int maxConnections, Callback requester, int maxMultiplex)\n     {\n         super(destination, maxConnections, false, requester, maxMultiplex);\n-        pool = destination.getBean(Pool.class);\n-    }\n-\n-    @Override\n-    protected Connection acquire(boolean create)\n-    {\n         // If there are queued requests and connections get\n         // closed due to idle timeout or overuse, we want to\n         // aggressively try to open new connections to replace\n         // those that were closed to process queued requests.\n-        return super.acquire(true);\n+        setMaximizeConnections(true);\n     }\n \n     @Override\n-    protected Connection activate()\n+    protected int getIndex(int maxConnections)\n     {\n-        Pool<Connection>.Entry entry;\n-        try (Locker.Lock l = lock.lock())\n-        {\n-            int index = Math.abs(offset % pool.getMaxEntries());\n-            entry = pool.acquireAt(index);\n-            if (LOG.isDebugEnabled())\n-                LOG.debug(\"activated at index={} entry={}\", index, entry);\n-            if (entry != null)\n-                ++offset;\n-        }\n-        if (entry == null)\n-            return null;\n-        Connection connection = entry.getPooled();\n-        acquired(connection);\n-        return connection;\n+        return Math.abs(offset.getAndIncrement() % maxConnections);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a821f0a9dd66d8b24a01b2cdf342ff6a2a12fc"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20cea6c94fd62df9b672fe91c522bb5c9d09910", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/d20cea6c94fd62df9b672fe91c522bb5c9d09910", "committedDate": "2020-09-01T17:14:01Z", "message": "Fixes #5217 - Review RoundRobinConnectionPool\n\nUpdates after review.\nFixed broken tests.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwODE2NTYx", "url": "https://github.com/eclipse/jetty.project/pull/5219#pullrequestreview-480816561", "createdAt": "2020-09-02T13:26:13Z", "commit": {"oid": "d20cea6c94fd62df9b672fe91c522bb5c9d09910"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDA5MjAw", "url": "https://github.com/eclipse/jetty.project/pull/5219#pullrequestreview-485009200", "createdAt": "2020-09-09T13:29:58Z", "commit": {"oid": "d20cea6c94fd62df9b672fe91c522bb5c9d09910"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 321, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}