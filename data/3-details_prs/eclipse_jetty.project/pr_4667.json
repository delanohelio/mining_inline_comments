{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MzExNDIy", "number": 4667, "title": "Issue #4662 Ensure contextDestroyed called after filters and servlets destroyed", "bodyText": "Closes #4662\nAfter  #4083 we called the ServletContextListeners.contextDestroyed too early, before the filters and servlets were destroyed.  This PR fixes that, and also reworks the initialization sequence of the filters/servlets/listeners so that the context starting and stopping code is more symmetrical.", "createdAt": "2020-03-12T15:30:34Z", "url": "https://github.com/eclipse/jetty.project/pull/4667", "merged": true, "mergeCommit": {"oid": "cf0e3c530f4ab878c8e0d83449fd9225ed8446f4"}, "closed": true, "closedAt": "2020-04-06T08:12:20Z", "author": {"login": "janbartel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM9ZzbAH2gAyMzg3MzExNDIyOjhkYTllZTdlNzZlOGI0ODBmMWVlM2ZlODdhMjJhZDVjZDU4YjQwODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTpoa3AH2gAyMzg3MzExNDIyOjlkNTdiZjM3ODJlZjk0ZTFkMGE5YzRjMzc1Y2UzMGMwNjMzYWE1ZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085", "committedDate": "2020-03-12T15:25:34Z", "message": "Issue #4662 Ensure contextDestroyed called after filters and servlets destroyed\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzM4ODc1", "url": "https://github.com/eclipse/jetty.project/pull/4667#pullrequestreview-376338875", "createdAt": "2020-03-17T19:25:43Z", "commit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxOToyNTo0NFrOF3qzHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxOToyNjo0M1rOF3q1Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxNzIxMw==", "bodyText": "What is this comment all about?\nDoes using ServletHolder via ServletContextHandler change the behavior in some way?", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r393917213", "createdAt": "2020-03-17T19:25:44Z", "author": {"login": "joakime"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletLifeCycleTest.java", "diffHunk": "@@ -60,8 +60,8 @@ public void testLifeCycle() throws Exception\n         context.getObjectFactory().addDecorator(new TestDecorator());\n \n         ServletHandler sh = context.getServletHandler();\n-        sh.addListener(new ListenerHolder(TestListener.class));\n-        context.addEventListener(context.getServletContext().createListener(TestListener2.class));\n+        sh.addListener(new ListenerHolder(TestListener.class)); //added directly to ServletHandler\n+        context.addEventListener(context.getServletContext().createListener(TestListener2.class));//create,decorate and add listener to context - no holder!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkxNzc0Mg==", "bodyText": "Does a servlet added via the dynamic ServletContext.addServlet() methods during servlet init trip this up in any way?", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r393917742", "createdAt": "2020-03-17T19:26:43Z", "author": {"login": "joakime"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -405,6 +475,37 @@ public void destroyServer() throws Exception\n         _server.join();\n     }\n \n+    @Test\n+    public void testDestroyOrder() throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2Njk5Nzgx", "url": "https://github.com/eclipse/jetty.project/pull/4667#pullrequestreview-376699781", "createdAt": "2020-03-18T09:40:48Z", "commit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo0MDo0OFrOF39BdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo0MDo0OFrOF39BdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIxNTc5Ng==", "bodyText": "We need a way to ensure that contextDestroyed is called by the ContextHandler if there is no ServletHandler present.", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r394215796", "createdAt": "2020-03-18T09:40:48Z", "author": {"login": "gregw"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -307,6 +308,9 @@ protected synchronized void doStop()\n         _servlets = shs;\n         ServletMapping[] sms = (ServletMapping[])LazyList.toArray(servletMappings, ServletMapping.class);\n         _servletMappings = sms;\n+        \n+        if (_contextHandler != null)\n+            _contextHandler.contextDestroyed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODM0Njgx", "url": "https://github.com/eclipse/jetty.project/pull/4667#pullrequestreview-377834681", "createdAt": "2020-03-19T15:31:04Z", "commit": {"oid": "8da9ee7e76e8b480f1ee3fe87a22ad5cd58b4085"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/cd85d116026ef1f2047458f7ac203f88ac1288af", "committedDate": "2020-03-31T14:26:41Z", "message": "Issue # 4662 Call contextInitialized/Destroyed without ServletHandler\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjU5ODA1", "url": "https://github.com/eclipse/jetty.project/pull/4667#pullrequestreview-386259805", "createdAt": "2020-04-02T09:35:45Z", "commit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTozNTo0NVrOF_jJUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTozODoxN1rOF_jPLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MDQzMg==", "bodyText": "Not a big fan of the name UNSET.\nAn alternative would be to have\n    Boolean initialized; // null==not initialized; TRUE==initialized;  FALSE==destroyed \nHmmm can't use a switch then... but maybe that's not necessary in most cases?\nPerhaps just rename UNSET to STOPPED or IDLE  or  'NOT_INITIALIZED`", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r402180432", "createdAt": "2020-04-02T09:35:45Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -177,6 +177,14 @@ public static void setServerInfo(String serverInfo)\n         __serverInfo = serverInfo;\n     }\n \n+    public enum ContextStatus", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MDk0MA==", "bodyText": "Perhaps a comment here that this can be called earlier in the sequence by ServletHandler.", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r402180940", "createdAt": "2020-04-02T09:36:38Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -823,6 +831,8 @@ protected void doStart() throws Exception\n \n             // defers the calling of super.doStart()\n             startContext();\n+            \n+            contextInitialized();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MTI2OQ==", "bodyText": "perhaps a comment explaining where this can be called from", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r402181269", "createdAt": "2020-04-02T09:37:11Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -885,35 +895,68 @@ protected void startContext() throws Exception\n \n     public void contextDestroyed() throws Exception\n     {\n-        MultiException ex = new MultiException();\n-        ServletContextEvent event = new ServletContextEvent(_scontext);\n-        Collections.reverse(_destroyServletContextListeners);\n-        for (ServletContextListener listener : _destroyServletContextListeners)\n+        switch (_contextStatus)\n         {\n-            try\n+            case INITIALIZED:\n             {\n-                callContextDestroyed(listener, event);\n-            }\n-            catch (Exception x)\n-            {\n-                ex.add(x);\n+                try\n+                {\n+                    //Call context listeners\n+                    MultiException ex = new MultiException();\n+                    ServletContextEvent event = new ServletContextEvent(_scontext);\n+                    Collections.reverse(_destroyServletContextListeners);\n+                    for (ServletContextListener listener : _destroyServletContextListeners)\n+                    {\n+                        try\n+                        {\n+                            callContextDestroyed(listener, event);\n+                        }\n+                        catch (Exception x)\n+                        {\n+                            ex.add(x);\n+                        }\n+                    }\n+                    ex.ifExceptionThrow();\n+                }\n+                finally\n+                {\n+                    _contextStatus = ContextStatus.DESTROYED;\n+                }\n+                break;\n             }\n+            default:\n+                break;\n         }\n-        ex.ifExceptionThrow();\n     }\n-    \n+\n     public void contextInitialized() throws Exception\n     {\n         // Call context listeners", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4MTkzNA==", "bodyText": "perhaps a comment saying where this can be called from.\nAlso can we move the method to be after contextInitialized... I like order to match natural sequence.", "url": "https://github.com/eclipse/jetty.project/pull/4667#discussion_r402181934", "createdAt": "2020-04-02T09:38:17Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -885,35 +895,68 @@ protected void startContext() throws Exception\n \n     public void contextDestroyed() throws Exception\n     {\n-        MultiException ex = new MultiException();\n-        ServletContextEvent event = new ServletContextEvent(_scontext);\n-        Collections.reverse(_destroyServletContextListeners);\n-        for (ServletContextListener listener : _destroyServletContextListeners)\n+        switch (_contextStatus)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd85d116026ef1f2047458f7ac203f88ac1288af"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d57bf3782ef94e1d0a9c4c375ce30c0633aa5e6", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/9d57bf3782ef94e1d0a9c4c375ce30c0633aa5e6", "committedDate": "2020-04-02T10:20:54Z", "message": "Issue #4662 after review\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 493, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}