{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNzQxNjQ3", "number": 4482, "title": "Issue #4321 Refactored Graceful shutdown", "bodyText": "removed stopTimeout from all abstractLifeCycles.  It is on Graceful.LifeCycle, which is only implemented by components that can start a graceful shutdown (eg Server, ContextHandler and QueuedThreadPool)\nSigned-off-by: Greg Wilkins gregw@webtide.com", "createdAt": "2020-01-16T16:42:10Z", "url": "https://github.com/eclipse/jetty.project/pull/4482", "merged": true, "mergeCommit": {"oid": "5aaec6e23f6b5e9dcc418c6121203ffb26c60c85"}, "closed": true, "closedAt": "2020-01-30T16:05:04Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb686mjgH2gAyMzYzNzQxNjQ3OjhmOGRjODRkYWQ5ZjYyYTEyOGZmOGU3ZWQ2MjQ2ZWMyN2E0ZjI4Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_BTLwgFqTM0OTkxODI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd", "committedDate": "2020-01-16T16:40:51Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nremoved stopTimeout from all abstractLifeCycles.  It is on Graceful.LifeCycle, which is only implemented by components that can start a graceful shutdown (eg Server, ContextHandler and QueuedThreadPool)\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjk3MDQ1", "url": "https://github.com/eclipse/jetty.project/pull/4482#pullrequestreview-344297045", "createdAt": "2020-01-17T00:11:48Z", "commit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDoxMTo0OFrOFercrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMTowNjozOVrOFesPsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxMzQ1NA==", "bodyText": "Don't use the _shutdown field directly here could throw NPE if the value can change to null.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r367713454", "createdAt": "2020-01-17T00:11:48Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AbstractConnector.java", "diffHunk": "@@ -345,13 +371,27 @@ protected void interruptAcceptors()\n     @Override\n     public Future<Void> shutdown()\n     {\n-        return _shutdown.shutdown();\n+        Shutdown shutdown = _shutdown;\n+        if (shutdown == null)\n+            return FutureCallback.SUCCEEDED;\n+\n+        // Signal for the acceptors to stop\n+        Future<Void> done = shutdown.shutdown();\n+        interruptAcceptors();\n+\n+        // Reduce the idle timeout of existing connections\n+        for (EndPoint ep : _endpoints)\n+            ep.setIdleTimeout(_shutdownIdleTimeout);\n+\n+        // Return Future that waits for no acceptors and no connections.\n+        return done;\n     }\n \n     @Override\n     public boolean isShutdown()\n     {\n-        return _shutdown.isShutdown();\n+        Shutdown shutdown = _shutdown;\n+        return shutdown == null || _shutdown.isShutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxODc3Ng==", "bodyText": "Should have the @Override annotation.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r367718776", "createdAt": "2020-01-17T00:34:27Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Server.java", "diffHunk": "@@ -173,22 +174,26 @@ public static String getVersion()\n         return Jetty.VERSION;\n     }\n \n-    public boolean getStopAtShutdown()\n-    {\n-        return _stopAtShutdown;\n-    }\n-\n     /**\n      * Set a graceful stop time.\n      * The {@link StatisticsHandler} must be configured so that open connections can\n      * be tracked for a graceful shutdown.\n      *\n-     * @see org.eclipse.jetty.util.component.ContainerLifeCycle#setStopTimeout(long)\n      */\n-    @Override\n     public void setStopTimeout(long stopTimeout)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxODgyNQ==", "bodyText": "@Override annotation.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r367718825", "createdAt": "2020-01-17T00:34:40Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Server.java", "diffHunk": "@@ -173,22 +174,26 @@ public static String getVersion()\n         return Jetty.VERSION;\n     }\n \n-    public boolean getStopAtShutdown()\n-    {\n-        return _stopAtShutdown;\n-    }\n-\n     /**\n      * Set a graceful stop time.\n      * The {@link StatisticsHandler} must be configured so that open connections can\n      * be tracked for a graceful shutdown.\n      *\n-     * @see org.eclipse.jetty.util.component.ContainerLifeCycle#setStopTimeout(long)\n      */\n-    @Override\n     public void setStopTimeout(long stopTimeout)\n     {\n-        super.setStopTimeout(stopTimeout);\n+        _stopTimeout = stopTimeout;\n+    }\n+\n+    @ManagedAttribute(\"Time in ms to gracefully shutdown the server\")\n+    public long getStopTimeout()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyMTIwMg==", "bodyText": "AbstractHandlerContainer seems like a strange place to put the GracefulContainer interface and the shutdown static method. Why is this not done the way you did  Graceful.LifeCycle and have Graceful.Container.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r367721202", "createdAt": "2020-01-17T00:44:56Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/AbstractHandlerContainer.java", "diffHunk": "@@ -139,50 +141,51 @@ public void setServer(Server server)\n             }\n     }\n \n-    /**\n-     * Shutdown nested Gracefule handlers\n-     *\n-     * @param futures A list of Futures which must also be waited on for the shutdown (or null)\n-     * returns A MultiException to which any failures are added or null\n-     */\n-    protected void doShutdown(List<Future<Void>> futures) throws MultiException\n+    public interface GracefulContainer extends Graceful.LifeCycle, Container", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcyNjUxNQ==", "bodyText": "This change is a little concerning, is this somehow related to the graceful shutdown refactor or just a cleanup?", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r367726515", "createdAt": "2020-01-17T01:06:39Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/QueuedThreadPool.java", "diffHunk": "@@ -675,10 +689,17 @@ private boolean addCounts(int deltaThreads, int deltaIdle)\n             int threads = AtomicBiInteger.getHi(encoded);\n             int idle = AtomicBiInteger.getLo(encoded);\n             if (threads == Integer.MIN_VALUE) // This is a marker that the pool is stopped.\n-                return false;\n-            long update = AtomicBiInteger.encode(threads + deltaThreads, idle + deltaIdle);\n-            if (_counts.compareAndSet(encoded, update))\n-                return true;\n+            {\n+                long update = AtomicBiInteger.encode(threads, idle + deltaIdle);\n+                if (_counts.compareAndSet(encoded, update))\n+                    return false;\n+            }\n+            else\n+            {\n+                long update = AtomicBiInteger.encode(threads + deltaThreads, idle + deltaIdle);\n+                if (_counts.compareAndSet(encoded, update))\n+                    return true;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8dc84dad9f62a128ff8e7ed6246ec27a4f28cd"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc8b7a9190e15db08e7d2ad83b183cf90df491a", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/8bc8b7a9190e15db08e7d2ad83b183cf90df491a", "committedDate": "2020-01-17T05:28:15Z", "message": "Issue #4321 Refactored Graceful shutdown\n\ncleanup after review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bfb6ab43950130b4e4be9e17a58a4822e1ad484", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/5bfb6ab43950130b4e4be9e17a58a4822e1ad484", "committedDate": "2020-01-17T05:41:02Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nreinstate other stop tests (more work to do).\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7efb5e4a28e8b0369903ae492ce9c0cdb61ffae2", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/7efb5e4a28e8b0369903ae492ce9c0cdb61ffae2", "committedDate": "2020-01-17T06:16:09Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nFixes for stop test by improving LocalConnector shutdown handling\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90091a38f67331bc7e53a9fec543d0687a8da038", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/90091a38f67331bc7e53a9fec543d0687a8da038", "committedDate": "2020-01-17T06:18:34Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nRemoved broken test on LocalConnector that is already tested in GracefulStopTest\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b967f3d71b95f9ee6a2de889b3c039b340bdd369", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/b967f3d71b95f9ee6a2de889b3c039b340bdd369", "committedDate": "2020-01-17T06:36:20Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nFixed all stop tests\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb52febae22f91176ba576ba50fb568b4185f12", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/ffb52febae22f91176ba576ba50fb568b4185f12", "committedDate": "2020-01-17T10:40:19Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nfixed checkstyle\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7eb14172b73c4d12b62fc2e996117405e808996", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/f7eb14172b73c4d12b62fc2e996117405e808996", "committedDate": "2020-01-20T10:10:17Z", "message": "Merge branch 'jetty-10.0.x' into jetty-10.0.x-4321-GracefulRefactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5405c7292f518b98bd814bf90ac4fe87eeb24b", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/6f5405c7292f518b98bd814bf90ac4fe87eeb24b", "committedDate": "2020-01-20T11:37:46Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nNo stopTimeout JMX attribute\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af13771f24ae655a715bd70bc41be21f51336840", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/af13771f24ae655a715bd70bc41be21f51336840", "committedDate": "2020-01-20T11:52:19Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nDump stopTimeout\ntest with default stopTimeout\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74dc4e6d64de6260616464e80377f88dfd6762b6", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/74dc4e6d64de6260616464e80377f88dfd6762b6", "committedDate": "2020-01-21T07:00:24Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nUSe sendError for 503\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997c1bc0c207499c3b186494a8149dfd247b4ec9", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/997c1bc0c207499c3b186494a8149dfd247b4ec9", "committedDate": "2020-01-21T12:13:26Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nminor cleanups\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91b37e3ae8ef9e559dac771a0ac53cb50f0409b8", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/91b37e3ae8ef9e559dac771a0ac53cb50f0409b8", "committedDate": "2020-01-22T08:40:36Z", "message": "Merge branch 'jetty-10.0.x' into jetty-10.0.x-4321-GracefulRefactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0b1422ae287cf31a6d2670d0164accaf8ebeabb", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/b0b1422ae287cf31a6d2670d0164accaf8ebeabb", "committedDate": "2020-01-22T10:19:04Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nSimplifications after review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzY3Nzcz", "url": "https://github.com/eclipse/jetty.project/pull/4482#pullrequestreview-349367773", "createdAt": "2020-01-28T13:23:08Z", "commit": {"oid": "b0b1422ae287cf31a6d2670d0164accaf8ebeabb"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzoyMzowOFrOFikv5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzoyNjoyOFrOFik1_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc5Nzk4OA==", "bodyText": "I don't understand why this value changed here? Doesn't seem anything to do with shutdown?", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r371797988", "createdAt": "2020-01-28T13:23:08Z", "author": {"login": "janbartel"}, "path": "jetty-jmx/src/test/java/org/eclipse/jetty/jmx/ObjectMBeanTest.java", "diffHunk": "@@ -123,7 +123,7 @@ public void testDerivedAttributes() throws Exception\n \n         assertEquals(\"com.acme.Derived\", derivedInfo.getClassName(), \"name does not match\");\n         assertEquals(\"Test the mbean stuff\", derivedInfo.getDescription(), \"description does not match\");\n-        assertEquals(6, derivedInfo.getAttributes().length, \"attribute count does not match\");\n+        assertEquals(5, derivedInfo.getAttributes().length, \"attribute count does not match\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0b1422ae287cf31a6d2670d0164accaf8ebeabb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc5ODUwMg==", "bodyText": "Again, odd that this has nothing to do with shutdown. Perhaps you are missing a merge from jetty-10.0.x?", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r371798502", "createdAt": "2020-01-28T13:24:14Z", "author": {"login": "janbartel"}, "path": "jetty-maven-plugin/src/it/jetty-start-gwt-it/beer-client/src/main/java/org/olamy/App.java", "diffHunk": "@@ -44,9 +44,9 @@\n      * The message displayed to the user when the server cannot be reached or\n      * returns an error.\n      */\n-    private static final String SERVER_ERROR = \"An error occurred while \"\n-        + \"attempting to contact the server. Please check your network \"\n-        + \"connection and try again.\";\n+    private static final String SERVER_ERROR = \"An error occurred while \" +\n+        \"attempting to contact the server. Please check your network \" +\n+        \"connection and try again.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0b1422ae287cf31a6d2670d0164accaf8ebeabb"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc5OTU1MA==", "bodyText": "The comment at line 40 should be for a CompletableFuture, not just a Future.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r371799550", "createdAt": "2020-01-28T13:26:28Z", "author": {"login": "janbartel"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/component/Graceful.java", "diffHunk": "@@ -43,47 +46,96 @@\n  */\n public interface Graceful", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0b1422ae287cf31a6d2670d0164accaf8ebeabb"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d17882f5a15403bd244b7e0f6054a67e94f1745", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/2d17882f5a15403bd244b7e0f6054a67e94f1745", "committedDate": "2020-01-28T14:14:32Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nafter review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODc2MDE1", "url": "https://github.com/eclipse/jetty.project/pull/4482#pullrequestreview-349876015", "createdAt": "2020-01-29T05:55:20Z", "commit": {"oid": "2d17882f5a15403bd244b7e0f6054a67e94f1745"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNTo1NToyMFrOFi9WNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjoyMTozMFrOFi9sIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMTAxMw==", "bodyText": "Does this really need to be a CompleteableFuture rather than just a Future?\nWould you ever expect the caller of this to complete the future or is it to be done internally like in the Shutdown utility with check().", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r372201013", "createdAt": "2020-01-29T05:55:20Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/component/Graceful.java", "diffHunk": "@@ -43,47 +47,96 @@\n  */\n public interface Graceful\n {\n-    Future<Void> shutdown();\n+    /**\n+     * Shutdown the component. When this method returns, the component should not accept any new load.\n+     * @return A future that is completed once all load on the component is completed\n+     */\n+    CompletableFuture<Void> shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d17882f5a15403bd244b7e0f6054a67e94f1745"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNTc5MA==", "bodyText": "I think this should be the only line in the try/catch, otherwise if it throws the stopTimeout will never be set on the ThreadPool.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r372205790", "createdAt": "2020-01-29T06:18:14Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Server.java", "diffHunk": "@@ -466,21 +464,20 @@ protected void doStop() throws Exception\n \n         MultiException mex = new MultiException();\n \n-        try\n+        if (getStopTimeout() > 0)\n         {\n-            // list if graceful futures\n-            List<Future<Void>> futures = new ArrayList<>();\n-            // First shutdown the network connectors to stop accepting new connections\n-            for (Connector connector : _connectors)\n+            try\n             {\n-                futures.add(connector.shutdown());\n+                long end = System.nanoTime() + TimeUnit.MILLISECONDS.toNanos(getStopTimeout());\n+                Graceful.shutdown(this).get(getStopTimeout(), TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d17882f5a15403bd244b7e0f6054a67e94f1745"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNjYyNg==", "bodyText": "This logic seems wrong to me, we can never set the stopTimeout on the ThreadPool to longer than 1000ms, and if the Graceful.shutdown takes a full stopTimeout we could get a negative value for the ThreadPool stopTimeout.", "url": "https://github.com/eclipse/jetty.project/pull/4482#discussion_r372206626", "createdAt": "2020-01-29T06:21:30Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Server.java", "diffHunk": "@@ -466,21 +464,20 @@ protected void doStop() throws Exception\n \n         MultiException mex = new MultiException();\n \n-        try\n+        if (getStopTimeout() > 0)\n         {\n-            // list if graceful futures\n-            List<Future<Void>> futures = new ArrayList<>();\n-            // First shutdown the network connectors to stop accepting new connections\n-            for (Connector connector : _connectors)\n+            try\n             {\n-                futures.add(connector.shutdown());\n+                long end = System.nanoTime() + TimeUnit.MILLISECONDS.toNanos(getStopTimeout());\n+                Graceful.shutdown(this).get(getStopTimeout(), TimeUnit.MILLISECONDS);\n+                QueuedThreadPool qtp = getBean(QueuedThreadPool.class);\n+                if (qtp != null)\n+                    qtp.setStopTimeout(Math.min(1000L, TimeUnit.NANOSECONDS.toMillis(end - System.nanoTime())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d17882f5a15403bd244b7e0f6054a67e94f1745"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4eaaf8c8f3ebf5687f37bf1a5ab0e9c63c24b3", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/0d4eaaf8c8f3ebf5687f37bf1a5ab0e9c63c24b3", "committedDate": "2020-01-29T07:51:38Z", "message": "Issue #4321 Refactored Graceful shutdown\n\nafter review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTE4MjYw", "url": "https://github.com/eclipse/jetty.project/pull/4482#pullrequestreview-349918260", "createdAt": "2020-01-29T08:03:01Z", "commit": {"oid": "0d4eaaf8c8f3ebf5687f37bf1a5ab0e9c63c24b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 547, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}