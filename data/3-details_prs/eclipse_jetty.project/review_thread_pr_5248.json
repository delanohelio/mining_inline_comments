{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNDc4MzM0", "number": 5248, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoxNzo0N1rOEhf8Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0NToyMVrOEifnkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTYxODI2OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoxNzo0N1rOHO2Cyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMjowNDoxNlrOHPb4tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyNzU2Mg==", "bodyText": "@gregw I think its probably best not to use the deflaters ByteBuffer method here, the CRC32 will need an array from the ByteBuffer anyway, and if we do it ourselves we get the use the ByteBufferPool.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485327562", "createdAt": "2020-09-09T04:17:47Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,7 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0NzU3NQ==", "bodyText": "I have added a comment as to why we are not using the ByteBuffer API for deflaters.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485947575", "createdAt": "2020-09-09T22:04:16Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,7 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyNzU2Mg=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODA4OTA1OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo0Mzo1OVrOHPNprw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo0Mzo1OVrOHPNprw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNDM1MQ==", "bodyText": "Can you use TreeSet instead?\nSet<String> foo = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\nfoo.add(\"Bar\");\nfoo.add(\"bar\");\nfoo.add(\"BAR\");\nfoo.add(\"ZED\");\nfoo.add(\"zed\");\n\nSystem.out.printf(\"Has %d elements%n\", foo.size());\nSystem.out.printf(\"contains('baR') = %b%n\", foo.contains(\"baR\"));\nSystem.out.printf(\"contains('zeD') = %b%n\", foo.contains(\"zeD\"));\nSystem.out.printf(\"contains('baz') = %b%n\", foo.contains(\"baz\"));\nResults in ...\nHas 2 elements\ncontains('baR') = true\ncontains('zeD') = true\ncontains('baz') = false", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485714351", "createdAt": "2020-09-09T15:43:59Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -168,7 +172,7 @@\n     // non-static, as other GzipHandler instances may have different configurations\n     private final IncludeExclude<String> _methods = new IncludeExclude<>();\n     private final IncludeExclude<String> _paths = new IncludeExclude<>(PathSpecSet.class);\n-    private final IncludeExclude<String> _mimeTypes = new IncludeExclude<>();\n+    private final IncludeExclude<String> _mimeTypes = new IncludeExclude<>(CaseInsensitiveSet.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODA5NjcyOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo0NTo0OFrOHPNudQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMjowMzozM1rOHPb35g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw==", "bodyText": "This can be simplified to just ...\n    public static class CaseInsensitiveSet extends TreeSet<String>\n    {\n        public CaseInsensitiveSet()\n        {\n            super(String.CASE_INSENSITIVE_ORDER);\n        }\n    }", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485715573", "createdAt": "2020-09-09T15:45:48Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxNzYzMA==", "bodyText": "I thought about this, won't this slow access down from O(1) to O(log n), and we don't really need it to be sorted. Not sure how much this would actually impact the performance.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485917630", "createdAt": "2020-09-09T20:57:35Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyMDMyMw==", "bodyText": "There's only what? like 5 DispatcherTypes?\nAnd the only impact is on setup/configuration/initialization, no real impact during runtime.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485920323", "createdAt": "2020-09-09T21:02:51Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyNjY4Mg==", "bodyText": "This is more MIME types, but yeah probably won't be that many in the set.\nThe set should be accessed on every request.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485926682", "createdAt": "2020-09-09T21:16:19Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTU4OA==", "bodyText": "Would a AsciiLowerCaseSet in jetty-util be useful (in general)?", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485929588", "createdAt": "2020-09-09T21:22:36Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTk2Ng==", "bodyText": "Another difference ... TreeSet doesn't allow null entries. HashSet does.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485929966", "createdAt": "2020-09-09T21:23:23Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0NzIzNQ==", "bodyText": "I think it could be useful in jetty-util, although I don't know where else it could be used.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485947235", "createdAt": "2020-09-09T22:03:15Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0NzM2Ng==", "bodyText": "I have now moved this to jetty-util.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485947366", "createdAt": "2020-09-09T22:03:33Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw=="}, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODExNTIzOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1MDoxM1rOHPN6DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1MDoxM1rOHPN6DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxODU0MQ==", "bodyText": "How about ...\n    public void setDispatcherTypes(String... dispatchers)\n    {\n        _dispatchers = EnumSet.copyOf(\n            Stream.of(dispatchers)\n                .flatMap(s -> Stream.of(StringUtil.csvSplit(s)))\n                .map(DispatcherType::valueOf)\n                .collect(Collectors.toSet())\n        );\n    }", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485718541", "createdAt": "2020-09-09T15:50:13Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -771,6 +773,19 @@ public void setExcludedPaths(String... pathspecs)\n         _paths.exclude(pathspecs);\n     }\n \n+    /**\n+     * Set of supported {@link DispatcherType} that this filter will operate on.\n+     *\n+     * @param dispatchers the set of {@link DispatcherType} that this filter will operate on\n+     */\n+    public void setDispatcherTypes(String... dispatchers)\n+    {\n+        setDispatcherTypes(Stream.of(dispatchers)\n+            .flatMap(s -> Stream.of(StringUtil.csvSplit(s)))\n+            .map(DispatcherType::valueOf)\n+            .toArray(DispatcherType[]::new));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTcyMjk4OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzoxODoxMVrOHPdb-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMTo1MDo0MVrOHT7LsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ==", "bodyText": "What does \"INFINITE_CAPACITY\" mean?", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485972985", "createdAt": "2020-09-09T23:18:11Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTAxMg==", "bodyText": "It means there is no limit on the number of objects allowed to be pooled.\nThis is now changed later by the setter, as I have made the capacity of the pool configurable after it is constructed. This lets us make the pool final and add it as a bean to the GzipHandler.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485979012", "createdAt": "2020-09-09T23:38:06Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2MjkyNg==", "bodyText": "We want to eventually switch the pools over to using the Pool class, which has it's size set when constructed.  So we need to not assume that the pool size can be configured after construction.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r486962926", "createdAt": "2020-09-11T10:42:33Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY1NDY0MA==", "bodyText": "Opened PR #5295, which uses the new Pool class for the CompressionPool and still allows the pool size to be changed before it is started.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r490654640", "createdAt": "2020-09-18T01:50:41Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjA1MDczOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0NToyMVrOHQZ7yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMjo1NDowNlrOHSAWYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NDE3MQ==", "bodyText": "Good comment, but can we raise a bug on the JVM to provide an efficient implementation of CRC32 that does not copy ByteBuffers?", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r486964171", "createdAt": "2020-09-11T10:45:21Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,9 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        // Ideally we would want to use the ByteBuffer API for Deflaters. However due the the ByteBuffer implementation\n+                        // of the CRC32.update() it is less efficient for us to use this rather than to convert to array ourselves.\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU4NTUyMQ==", "bodyText": "It only does the copying if it is not a DirectBuffer and does not have an array.\nI don't think I can raise JVM bugs anyway, @sbordet could do this.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r488585521", "createdAt": "2020-09-15T11:18:01Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,9 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        // Ideally we would want to use the ByteBuffer API for Deflaters. However due the the ByteBuffer implementation\n+                        // of the CRC32.update() it is less efficient for us to use this rather than to convert to array ourselves.\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NDE3MQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYzOTI1MQ==", "bodyText": "or is a readonly buffer!", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r488639251", "createdAt": "2020-09-15T12:49:44Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,9 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        // Ideally we would want to use the ByteBuffer API for Deflaters. However due the the ByteBuffer implementation\n+                        // of the CRC32.update() it is less efficient for us to use this rather than to convert to array ourselves.\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NDE3MQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0MjE0Nw==", "bodyText": "or if it is read-only!", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r488642147", "createdAt": "2020-09-15T12:54:06Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,9 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        // Ideally we would want to use the ByteBuffer API for Deflaters. However due the the ByteBuffer implementation\n+                        // of the CRC32.update() it is less efficient for us to use this rather than to convert to array ourselves.\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NDE3MQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2377, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}