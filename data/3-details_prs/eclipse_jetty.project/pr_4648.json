{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1Mzc5NTM3", "number": 4648, "title": "Issue #4645 - ForwardedRequestCustomizer now gives 400 response for bad port values", "bodyText": "Issue #4645\nReplace the previous NumberFormatException with an IllegalArgumentException with a more descriptive error message.\nIt would also be possible to change the code to just return if we have an empty X-Forwarded-Port value, which would ignore it. I'm not sure if that would be more correct than throwing.", "createdAt": "2020-03-09T04:29:18Z", "url": "https://github.com/eclipse/jetty.project/pull/4648", "merged": true, "mergeCommit": {"oid": "b497827df0cf9b81d043a5f0747978e0e1d48f8b"}, "closed": true, "closedAt": "2020-03-15T23:35:09Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL0G6oAH2gAyMzg1Mzc5NTM3Ojc5N2QyNTUwNWI5MjI2OGY3NDg0NWFiODgwZjQwNDYxY2NkMTcwMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNRyTtAFqTM3NDM3OTQ2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "797d25505b92268f74845ab880f40461ccd17019", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/797d25505b92268f74845ab880f40461ccd17019", "committedDate": "2020-03-09T02:01:52Z", "message": "Issue #4645 - better error message for empty X-Forwarded-Port value\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMDY3ODA5", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-371067809", "createdAt": "2020-03-09T10:51:22Z", "commit": {"oid": "797d25505b92268f74845ab880f40461ccd17019"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMjExMzQ0", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-371211344", "createdAt": "2020-03-09T14:06:44Z", "commit": {"oid": "797d25505b92268f74845ab880f40461ccd17019"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowNjo0NVrOFzp1yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowNjo0NVrOFzp1yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzIwOQ==", "bodyText": "Perhaps add a new method called parsePort(String rawPort) that does the Integer.parseInt() and also validates the range of values to be sane (port >= 1 && port <= 65535).", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r389707209", "createdAt": "2020-03-09T14:06:45Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -639,19 +639,23 @@ else if (_for == null)\n         @SuppressWarnings(\"unused\")\n         public void handlePort(HttpField field)\n         {\n+            String port = getLeftMost(field.getValue());\n+            if (StringUtil.isEmpty(port))\n+                throw new IllegalArgumentException(field.getName() + \" has empty value\");\n+\n             if (!getForwardedPortAsAuthority())\n             {\n                 if (_for == null)\n-                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(getLeftMost(field.getValue())));\n+                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(port));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797d25505b92268f74845ab880f40461ccd17019"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMjExODUx", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-371211851", "createdAt": "2020-03-09T14:07:21Z", "commit": {"oid": "797d25505b92268f74845ab880f40461ccd17019"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbd89ce1c79ce38265cf6dac3d9307b94023866c", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/dbd89ce1c79ce38265cf6dac3d9307b94023866c", "committedDate": "2020-03-11T07:31:25Z", "message": "Issue #4645 - validate port range & return 400 on bad forwarded headers\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d5ee7b058b04b544af1fb17c1f6ffa1032452693", "committedDate": "2020-03-11T07:41:41Z", "message": "Issue #4645 - handle exceptions from all headers\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjY4NTA2", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-372668506", "createdAt": "2020-03-11T11:17:16Z", "commit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMToxNzoxNlrOF0yu7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMToxNzo0N1rOF0yv0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTQ4NA==", "bodyText": "add the Throwable t as the cause of this exception", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901484", "createdAt": "2020-03-11T11:17:16Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);\n+        throw new BadMessageException(\"Bad header value for \" + field.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTcxMw==", "bodyText": "Don't warn and throw.   Do one or the other.   I think this should just be a debug here.", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901713", "createdAt": "2020-03-11T11:17:47Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/633298b5c7dfee8377c59b3f872f81082049cbf3", "committedDate": "2020-03-11T11:41:31Z", "message": "Issue #4645 - changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzU4ODA5", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-373358809", "createdAt": "2020-03-12T08:34:11Z", "commit": {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozNDoxMVrOF1VN4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozNDoxMVrOF1VN4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjQ2Ng==", "bodyText": "Sorry but... thinking about this more, can we avoid the double try blocks.  onError has no declared exceptions, so whatever it throws can be thrown from this method.  If it doesn't throw then we continue.  Why the need to wrap with a RuntimeException?", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r391466466", "createdAt": "2020-03-12T08:34:11Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -380,9 +381,16 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             for (HttpField field : httpFields)\n             {\n-                MethodHandle handle = _handles.get(field.getName());\n-                if (handle != null)\n-                    handle.invoke(forwarded, field);\n+                try\n+                {\n+                    MethodHandle handle = _handles.get(field.getName());\n+                    if (handle != null)\n+                        handle.invoke(forwarded, field);\n+                }\n+                catch (Throwable t)\n+                {\n+                    onError(field, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcbe704b24ec80cf65876f63caad475f8696d3ee", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/fcbe704b24ec80cf65876f63caad475f8696d3ee", "committedDate": "2020-03-13T02:59:43Z", "message": "Issue #4645 - do not wrap exceptions from onError with RuntimeException\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Mzc5NDY2", "url": "https://github.com/eclipse/jetty.project/pull/4648#pullrequestreview-374379466", "createdAt": "2020-03-13T15:10:26Z", "commit": {"oid": "fcbe704b24ec80cf65876f63caad475f8696d3ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 485, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}