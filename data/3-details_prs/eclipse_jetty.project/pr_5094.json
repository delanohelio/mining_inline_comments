{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjYwNTk3", "number": 5094, "title": "Issue #5088 Review ContextHandler locking", "bodyText": "The locking was primarily as a memory guard for the availability status, which was already volatile.\nHave instead using an AtomicReference with a simple state machine layered on top of start/stop lifecycle.\nThere was also protection for AttributesMap, which is no longer needed as AttributesMap is now concurrent.", "createdAt": "2020-07-29T07:52:14Z", "url": "https://github.com/eclipse/jetty.project/pull/5094", "merged": true, "mergeCommit": {"oid": "66ec16006edb96a5904f60b9aa067dfeb4217528"}, "closed": true, "closedAt": "2020-07-30T15:58:34Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5mKpLgH2gAyNDU4MjYwNTk3OjM2YjJhNGJiYzllNjI4MTg1NzQ3ZDMyYzQwNDQwNjdiYjJiMTU0MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6A62PAH2gAyNDU4MjYwNTk3OjAyYjhlNzEwYTVlNTRkMjU5ZTMzNTkzM2QxMDFhMjM4MTBmMGYwMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/36b2a4bbc9e628185747d32c4044067bb2b15419", "committedDate": "2020-07-29T07:47:47Z", "message": "Issue #5088 Review ContextHandler locking\n\nThe locking was primarily as a memory guard for the availability status, which was already volatile.\nHave instead using an AtomicReference with a simple state machine layered on top of start/stop lifecycle.\nThere was also protection for AttributesMap, which is no longer needed as AttributesMap is now concurrent."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mjc4NzM0", "url": "https://github.com/eclipse/jetty.project/pull/5094#pullrequestreview-457278734", "createdAt": "2020-07-29T07:54:04Z", "commit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NDowNFrOG4s3Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1NDowNFrOG4s3Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODQxOQ==", "bodyText": "oops this is an unrelated change that accidentally slipped in.\nThe uri.getDecodedPath() method  does exactly URIUtil.decodePath(encoded), but caches the results so they can be reused if needed again.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462108419", "createdAt": "2020-07-29T07:54:04Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -1805,7 +1805,7 @@ public void setMetaData(org.eclipse.jetty.http.MetaData.Request request)\n         }\n         else if (encoded.startsWith(\"/\"))\n         {\n-            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(URIUtil.decodePath(encoded));\n+            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(uri.getDecodedPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mjc4NTE0", "url": "https://github.com/eclipse/jetty.project/pull/5094#pullrequestreview-457278514", "createdAt": "2020-07-29T07:53:48Z", "commit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo1Mzo0OFrOG4s2Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODowNzo0MFrOG4tVTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODIzOA==", "bodyText": "strictly speaking this has nothing to do with contexthandler locking.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462108238", "createdAt": "2020-07-29T07:53:48Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -1805,7 +1805,7 @@ public void setMetaData(org.eclipse.jetty.http.MetaData.Request request)\n         }\n         else if (encoded.startsWith(\"/\"))\n         {\n-            path = (encoded.length() == 1) ? \"/\" : URIUtil.canonicalPath(URIUtil.decodePath(encoded));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMDQ2Mg==", "bodyText": "If UNAVAILABLE, should the state go to SHUTDOWN?", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462110462", "createdAt": "2020-07-29T07:57:32Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -777,7 +778,23 @@ public boolean isShutdown()\n     @Override\n     public Future<Void> shutdown()\n     {\n-        _availability = isRunning() ? Availability.SHUTDOWN : Availability.UNAVAILABLE;\n+        while (true)\n+        {\n+            Availability availability = _availability.get();\n+            switch (availability)\n+            {\n+                case STOPPED:\n+                    return new FutureCallback(new IllegalStateException(getState()));\n+                case STARTING:\n+                case AVAILABLE:\n+                    if (!_availability.compareAndSet(availability, Availability.SHUTDOWN))\n+                        continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExMTY2OA==", "bodyText": "Maybe should throw an ISE if you try to set availability whilst shutdown or stopped?", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462111668", "createdAt": "2020-07-29T07:59:38Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -796,12 +813,29 @@ public boolean isAvailable()\n      */\n     public void setAvailable(boolean available)\n     {\n-        synchronized (this)\n+        // Only supported state transitions are:\n+        //   UNAVAILABLE --true---> AVAILABLE\n+        //   STARTING -----false--> UNAVAILABLE\n+        //   AVAILABLE ----false--> UNAVAILABLE\n+        if (available)\n+            _availability.compareAndSet(Availability.UNAVAILABLE, Availability.AVAILABLE);\n+        else\n         {\n-            if (available && isRunning())\n-                _availability = Availability.AVAILABLE;\n-            else if (!available || !isRunning())\n-                _availability = Availability.UNAVAILABLE;\n+            while (true)\n+            {\n+                Availability availability = _availability.get();\n+                switch (availability)\n+                {\n+                    case STARTING:\n+                    case AVAILABLE:\n+                        if (!_availability.compareAndSet(availability, Availability.UNAVAILABLE))\n+                            continue;\n+                        break;\n+                    default:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNDI2Mg==", "bodyText": "Can we have a comment about the meanings of the different states, particularly UNAVAILABLE vs STOPPED, which is a new state.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462114262", "createdAt": "2020-07-29T08:04:14Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ContextHandler.java", "diffHunk": "@@ -230,10 +231,10 @@ public static void setServerInfo(String serverInfo)\n \n     public enum Availability\n     {\n-        UNAVAILABLE, STARTING, AVAILABLE, SHUTDOWN,\n+        STOPPED, STARTING, AVAILABLE, UNAVAILABLE, SHUTDOWN,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjExNjE3Mg==", "bodyText": "Need an explanation of this change as on the face of it, it is the exact opposite of the original intent.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462116172", "createdAt": "2020-07-29T08:07:40Z", "author": {"login": "janbartel"}, "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebAppContext.java", "diffHunk": "@@ -1434,7 +1434,7 @@ protected void stopContext() throws Exception\n                 setClassLoader(null);\n             }\n \n-            setAvailable(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b2a4bbc9e628185747d32c4044067bb2b15419"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1d8a35cdc8fc7ab6287d269b66873ba99a3d090b", "committedDate": "2020-07-29T09:05:17Z", "message": "Issue #5088\n\nupdates from review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzM2NjE5", "url": "https://github.com/eclipse/jetty.project/pull/5094#pullrequestreview-457336619", "createdAt": "2020-07-29T09:10:22Z", "commit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDEwNzk2", "url": "https://github.com/eclipse/jetty.project/pull/5094#pullrequestreview-457410796", "createdAt": "2020-07-29T10:55:01Z", "commit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDo1NTowMVrOG4zOQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDo1NTowMVrOG4zOQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIxMjY3NA==", "bodyText": "This is an unrelated change.", "url": "https://github.com/eclipse/jetty.project/pull/5094#discussion_r462212674", "createdAt": "2020-07-29T10:55:01Z", "author": {"login": "joakime"}, "path": "jetty-util/src/test/java/org/eclipse/jetty/util/URIUtilCanonicalPathTest.java", "diffHunk": "@@ -114,6 +114,13 @@\n                 // paths with encoded segments should remain encoded\n                 // canonicalPath() is not responsible for decoding characters\n                 {\"%2e%2e/\", \"%2e%2e/\"},\n+                {\"/%2e%2e/\", \"/%2e%2e/\"},\n+\n+                // paths with parameters are not elided\n+                // canonicalPath() is not responsible for decoding characters\n+                {\"/foo/.;/bar\", \"/foo/.;/bar\"},\n+                {\"/foo/..;/bar\", \"/foo/..;/bar\"},\n+                {\"/foo/..;/..;/bar\", \"/foo/..;/..;/bar\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8a35cdc8fc7ab6287d269b66873ba99a3d090b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b8e710a5e54d259e335933d101a23810f0f003", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/02b8e710a5e54d259e335933d101a23810f0f003", "committedDate": "2020-07-30T14:57:58Z", "message": "Issue #5088\n\nupdates from review (better this time)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 383, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}