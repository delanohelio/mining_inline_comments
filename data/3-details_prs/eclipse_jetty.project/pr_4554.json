{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxOTYzOTU2", "number": 4554, "title": "Fixes #2788 - Graceful close of HTTP/2 Connection.", "bodyText": "Made HTTP2SessionContainer implement Graceful, so that it can be found\nin the component hierarchy and can shutdown all sessions.\nModified HTTP2ServerSession to reject requests if already closed/shutdown.\nImplemented shutdown in HTTP2Session.\nSigned-off-by: Simone Bordet simone.bordet@gmail.com\nCloses #2788.", "createdAt": "2020-02-06T15:33:39Z", "url": "https://github.com/eclipse/jetty.project/pull/4554", "merged": true, "mergeCommit": {"oid": "678385bfda0f90a0bcccf7f86aa272073c1b4f29"}, "closed": true, "closedAt": "2020-03-10T13:58:42Z", "author": {"login": "sbordet"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBsh4NAH2gAyMzcxOTYzOTU2OjkyZDlkNDZmOGVmYzU3NDBhM2M2NDVjZDYwNjViMjlhMDM3N2VkOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMPbX_gFqTM3MTgwNzQ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/92d9d46f8efc5740a3c645cd6065b29a0377ed9f", "committedDate": "2020-02-06T15:32:50Z", "message": "Fixes #2788 - Graceful close of HTTP/2 Connection.\n\nMade HTTP2SessionContainer implement Graceful, so that it can be found\nin the component hierarchy and can shutdown all sessions.\nModified HTTP2ServerSession to reject requests if already closed/shutdown.\nImplemented shutdown in HTTP2Session.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDg3MjU2", "url": "https://github.com/eclipse/jetty.project/pull/4554#pullrequestreview-355087256", "createdAt": "2020-02-07T11:12:09Z", "commit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMToxMjoxMFrOFm535A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowOTo0MVrOFm7I8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzODQwNA==", "bodyText": "If the above CAS fails, you're going to return an uncompleted callback.", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376338404", "createdAt": "2020-02-07T11:12:10Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -675,26 +674,54 @@ public boolean close(int error, String reason, Callback callback)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)\n             {\n-                case NOT_CLOSED:\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n-                    if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n-                    {\n-                        closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n-                        control(null, callback, closeFrame);\n-                        return true;\n-                    }\n-                    break;\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"Closing {}/{}\", error, reason);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n+                    control(null, callback, closeFrame);\n+                    return true;\n                 }\n-                default:\n+            }\n+            else\n+            {\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n+                callback.succeeded();\n+                return false;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        while (true)\n+        {\n+            CloseState current = closed.get();\n+            if (current == CloseState.NOT_CLOSED)\n+            {\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n                     if (LOG.isDebugEnabled())\n-                        LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n-                    callback.succeeded();\n-                    return false;\n+                        LOG.debug(\"Shutting down {}\", this);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, ErrorCode.NO_ERROR.code, \"shutdown\");\n+                    closeCallback = new Callback.Completable();\n+                    // Only send the close frame when we can flip Hi and Lo = 0, see onStreamClosed().\n+                    if (streamCount.compareAndSet(0, 1, 0, 0))\n+                        control(null, closeCallback, closeFrame);\n+                    return closeCallback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0MzgzMg==", "bodyText": "Implementors of ISession (HTTP2Session?) don't override equals/hashcode. I'm wary of the side-effects this could have.", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376343832", "createdAt": "2020-02-07T11:27:00Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/AbstractHTTP2ServerConnectionFactory.java", "diffHunk": "@@ -296,22 +300,25 @@ protected ServerParser newServerParser(Connector connector, ServerParser.Listene\n     }\n \n     @ManagedObject(\"The container of HTTP/2 sessions\")\n-    public static class HTTP2SessionContainer implements Connection.Listener, Dumpable\n+    public static class HTTP2SessionContainer implements Connection.Listener, Graceful, Dumpable\n     {\n-        private final Set<Session> sessions = ConcurrentHashMap.newKeySet();\n+        private final Set<ISession> sessions = ConcurrentHashMap.newKeySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0OTk5NA==", "bodyText": "The Lo counter might be > 0 when you reach this line, couldn't it?", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376349994", "createdAt": "2020-02-07T11:44:10Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -1041,10 +1068,18 @@ public void onFrame(Frame frame)\n \n     protected void onStreamOpened(IStream stream)\n     {\n+        streamCount.addAndGetLo(1);\n     }\n \n     protected void onStreamClosed(IStream stream)\n     {\n+        if (streamCount.addAndGetLo(-1) == 0)\n+        {\n+            Callback.Completable callback = closeCallback;\n+            // Only send the close frame if we can flip Hi, see shutdown().\n+            if (callback != null && streamCount.compareAndSetHi(0, 1))\n+                control(null, callback, closeFrame);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1MjE5OQ==", "bodyText": "This means you may return a CompletableFuture that doesn't block until shutdown is over. Is that desirable?", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376352199", "createdAt": "2020-02-07T11:50:11Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -675,26 +674,54 @@ public boolean close(int error, String reason, Callback callback)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)\n             {\n-                case NOT_CLOSED:\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n-                    if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n-                    {\n-                        closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n-                        control(null, callback, closeFrame);\n-                        return true;\n-                    }\n-                    break;\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"Closing {}/{}\", error, reason);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n+                    control(null, callback, closeFrame);\n+                    return true;\n                 }\n-                default:\n+            }\n+            else\n+            {\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n+                callback.succeeded();\n+                return false;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        while (true)\n+        {\n+            CloseState current = closed.get();\n+            if (current == CloseState.NOT_CLOSED)\n+            {\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n                     if (LOG.isDebugEnabled())\n-                        LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n-                    callback.succeeded();\n-                    return false;\n+                        LOG.debug(\"Shutting down {}\", this);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, ErrorCode.NO_ERROR.code, \"shutdown\");\n+                    closeCallback = new Callback.Completable();\n+                    // Only send the close frame when we can flip Hi and Lo = 0, see onStreamClosed().\n+                    if (streamCount.compareAndSet(0, 1, 0, 0))\n+                        control(null, closeCallback, closeFrame);\n+                    return closeCallback;\n                 }\n             }\n+            else\n+            {\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Ignoring shutdown, already closed\");\n+                Callback.Completable result = closeCallback;\n+                return result != null ? result : CompletableFuture.completedFuture(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1NDM4OA==", "bodyText": "Don't you have to also call LifeCycle.stop on the session when isShutdown is true?", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376354388", "createdAt": "2020-02-07T11:56:19Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/AbstractHTTP2ServerConnectionFactory.java", "diffHunk": "@@ -296,22 +300,25 @@ protected ServerParser newServerParser(Connector connector, ServerParser.Listene\n     }\n \n     @ManagedObject(\"The container of HTTP/2 sessions\")\n-    public static class HTTP2SessionContainer implements Connection.Listener, Dumpable\n+    public static class HTTP2SessionContainer implements Connection.Listener, Graceful, Dumpable\n     {\n-        private final Set<Session> sessions = ConcurrentHashMap.newKeySet();\n+        private final Set<ISession> sessions = ConcurrentHashMap.newKeySet();\n+        private final AtomicReference<CompletableFuture<Void>> shutdown = new AtomicReference<>();\n \n         @Override\n         public void onOpened(Connection connection)\n         {\n-            Session session = ((HTTP2Connection)connection).getSession();\n+            ISession session = ((HTTP2Connection)connection).getSession();\n             sessions.add(session);\n             LifeCycle.start(session);\n+            if (isShutdown())\n+                shutdown(session);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1ODI4NQ==", "bodyText": "I would clearly document that this shutdown method has to be idempotent as HTTP2SessionContainer might call it twice, and explain the circumstances under which it can be called twice.", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376358285", "createdAt": "2020-02-07T12:07:11Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -675,26 +674,54 @@ public boolean close(int error, String reason, Callback callback)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)\n             {\n-                case NOT_CLOSED:\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n-                    if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n-                    {\n-                        closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n-                        control(null, callback, closeFrame);\n-                        return true;\n-                    }\n-                    break;\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"Closing {}/{}\", error, reason);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n+                    control(null, callback, closeFrame);\n+                    return true;\n                 }\n-                default:\n+            }\n+            else\n+            {\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n+                callback.succeeded();\n+                return false;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1OTE1NA==", "bodyText": "As we discussed, if you protected this sessions collection with a ReentrantReadWriteLock using the read lock to modify the collection and the write lock to shut it down, you could easily guarantee that each session's shutdown method would only ever be called once, and be done with that AtomicBiInteger logic.\nThis would make this code a ton simpler to maintain in the long run.", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r376359154", "createdAt": "2020-02-07T12:09:41Z", "author": {"login": "lorban"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/AbstractHTTP2ServerConnectionFactory.java", "diffHunk": "@@ -296,22 +300,25 @@ protected ServerParser newServerParser(Connector connector, ServerParser.Listene\n     }\n \n     @ManagedObject(\"The container of HTTP/2 sessions\")\n-    public static class HTTP2SessionContainer implements Connection.Listener, Dumpable\n+    public static class HTTP2SessionContainer implements Connection.Listener, Graceful, Dumpable\n     {\n-        private final Set<Session> sessions = ConcurrentHashMap.newKeySet();\n+        private final Set<ISession> sessions = ConcurrentHashMap.newKeySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0MzgzMg=="}, "originalCommit": {"oid": "92d9d46f8efc5740a3c645cd6065b29a0377ed9f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/8b1a669e65f5b97d89883b05eb7d649ae7275081", "committedDate": "2020-02-07T16:56:34Z", "message": "Issue #2788 - Graceful close of HTTP/2 Connection.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODcwNTAw", "url": "https://github.com/eclipse/jetty.project/pull/4554#pullrequestreview-355870500", "createdAt": "2020-02-10T11:38:57Z", "commit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzQwNjc2", "url": "https://github.com/eclipse/jetty.project/pull/4554#pullrequestreview-359340676", "createdAt": "2020-02-15T11:22:59Z", "commit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMToyMjo1OVrOFqOuPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMTozMzoyNVrOFqOwOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyNTcyNQ==", "bodyText": "Can't the whole while (true) loop be replaces with:\n    if (closed.compareAndSet(CloseState.NOT_CLOSED, CloseState.REMOTELY_CLOSED)\n    {\n        closeFrame = frame;\n        notifyClose(this, frame, new DisconnectCallback());\n        return;\n    }\n    if (LOG.isDebugEnable())\n        LOG.debug(\"Ignored {}, alread closed\", frame);\n    return\nThe only time it loops is if the CAS fails and then it is going to return anyway!", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r379825725", "createdAt": "2020-02-15T11:22:59Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -439,27 +442,23 @@ public void onGoAway(final GoAwayFrame frame)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyNTc1Mg==", "bodyText": "ditto loop not needed!", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r379825752", "createdAt": "2020-02-15T11:23:20Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -675,26 +674,56 @@ public boolean close(int error, String reason, Callback callback)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)\n             {\n-                case NOT_CLOSED:\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyNTc4MA==", "bodyText": "ditto loop not needed", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r379825780", "createdAt": "2020-02-15T11:23:49Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -675,26 +674,56 @@ public boolean close(int error, String reason, Callback callback)\n         while (true)\n         {\n             CloseState current = closed.get();\n-            switch (current)\n+            if (current == CloseState.NOT_CLOSED)\n             {\n-                case NOT_CLOSED:\n+                if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n                 {\n-                    if (closed.compareAndSet(current, CloseState.LOCALLY_CLOSED))\n-                    {\n-                        closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n-                        control(null, callback, closeFrame);\n-                        return true;\n-                    }\n-                    break;\n+                    if (LOG.isDebugEnabled())\n+                        LOG.debug(\"Closing {}/{}\", error, reason);\n+                    closeFrame = newGoAwayFrame(CloseState.LOCALLY_CLOSED, error, reason);\n+                    control(null, callback, closeFrame);\n+                    return true;\n                 }\n-                default:\n+            }\n+            else\n+            {\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Ignoring close {}/{}, already closed\", error, reason);\n+                callback.succeeded();\n+                return false;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> shutdown()\n+    {\n+        while (true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyNjIzNA==", "bodyText": "I don't like having two CaS operations serially.  This one should be a loop something like:\nCallback callback;\nwhile(true)\n{\n    long count = streamCount.get();\n    int streams = AtomicBiInteger.getLo(count) - 1;\n    int close = AtomicBiInteger.getHi(count);\n    callback =   (streams == 0 && close == 1) ? closeCallback : null;\n    if (streamCount.compareAndSet(count, 0, streams))\n        break;\n}\ncontrol(null, callback, closeFrame);", "url": "https://github.com/eclipse/jetty.project/pull/4554#discussion_r379826234", "createdAt": "2020-02-15T11:33:25Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-common/src/main/java/org/eclipse/jetty/http2/HTTP2Session.java", "diffHunk": "@@ -1041,10 +1070,18 @@ public void onFrame(Frame frame)\n \n     protected void onStreamOpened(IStream stream)\n     {\n+        streamCount.addAndGetLo(1);\n     }\n \n     protected void onStreamClosed(IStream stream)\n     {\n+        if (streamCount.addAndGetLo(-1) == 0)\n+        {\n+            Callback.Completable callback = closeCallback;\n+            // Only send the close frame if we can flip Hi, see shutdown().\n+            if (callback != null && streamCount.compareAndSet(0, 1, 0, 0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1a669e65f5b97d89883b05eb7d649ae7275081"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "916b3e56ec830835b012f9ac4589681d396c4c92", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/916b3e56ec830835b012f9ac4589681d396c4c92", "committedDate": "2020-03-09T19:01:25Z", "message": "Merged 'jetty-10.0.x' into 'jetty-10.0.x-2788-graceful_http2_close'."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a6c9b8049e5b02912f3b07498ddc21385281bb9", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/3a6c9b8049e5b02912f3b07498ddc21385281bb9", "committedDate": "2020-03-10T00:29:13Z", "message": "Issue #2788 - Graceful close of HTTP/2 Connection.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODA3NDg4", "url": "https://github.com/eclipse/jetty.project/pull/4554#pullrequestreview-371807488", "createdAt": "2020-03-10T09:51:39Z", "commit": {"oid": "3a6c9b8049e5b02912f3b07498ddc21385281bb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 578, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}