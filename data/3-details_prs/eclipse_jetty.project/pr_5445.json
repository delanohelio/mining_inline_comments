{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMTY3NDY0", "number": 5445, "title": "ForwardedRequestCustomizer behavior should not be applied to requests without forwarding headers", "bodyText": "If the request has no Forwarding headers, the customization that ForwardingRequestCustomizer typically does should be skipped.\nCloses #5443\nSigned-off-by: Joakim Erdfelt joakim.erdfelt@gmail.com", "createdAt": "2020-10-13T10:13:25Z", "url": "https://github.com/eclipse/jetty.project/pull/5445", "merged": true, "mergeCommit": {"oid": "4d0edf9ee2b498ae9b9769c2da1b5f96842bcc8d"}, "closed": true, "closedAt": "2020-10-13T17:20:39Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSFwzNAH2gAyNTAyMTY3NDY0OjBiNjQ2ZWU2Yjc4YzVlNGUxZGZmNmRkYmY2NDFiODM5MzYwZDhhODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSKU9cgFqTUwNzU2NTgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/0b646ee6b78c5e4e1dff6ddbf641b839360d8a87", "committedDate": "2020-10-13T10:10:42Z", "message": "Issue #5443 - Forwarding Headers are optional\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzA4MTM0", "url": "https://github.com/eclipse/jetty.project/pull/5445#pullrequestreview-507308134", "createdAt": "2020-10-13T10:51:51Z", "commit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMDo1MTo1MlrOHgg1QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMDo1Mzo0N1rOHgg5SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1NDQwMA==", "bodyText": "why setting here and not below?", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503854400", "createdAt": "2020-10-13T10:51:52Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)\n         {\n-            // set default to https\n-            proto = config.getSecureScheme();\n-        }\n+            String proto = \"http\";\n \n-        // Set Scheme from configured protocol\n-        if (forwarded._proto != null)\n-        {\n-            proto = forwarded._proto;\n-            request.setScheme(proto);\n-        }\n+            // Is secure status configured from headers?\n+            if (forwarded.isSecure())\n+            {\n+                // set default to https\n+                proto = config.getSecureScheme();\n+            }\n \n-        // Set authority\n-        String host = null;\n-        int port = -1;\n+            // Set Scheme from configured protocol\n+            if (forwarded._proto != null)\n+            {\n+                proto = forwarded._proto;\n+                request.setScheme(proto);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1NTQzMg==", "bodyText": "I'm don't think that just because it arrives on the secure port is sufficient to make it secure.  Some ports might do both secure and insecure requests.", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503855432", "createdAt": "2020-10-13T10:53:47Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)\n         {\n-            // set default to https\n-            proto = config.getSecureScheme();\n-        }\n+            String proto = \"http\";\n \n-        // Set Scheme from configured protocol\n-        if (forwarded._proto != null)\n-        {\n-            proto = forwarded._proto;\n-            request.setScheme(proto);\n-        }\n+            // Is secure status configured from headers?\n+            if (forwarded.isSecure())\n+            {\n+                // set default to https\n+                proto = config.getSecureScheme();\n+            }\n \n-        // Set authority\n-        String host = null;\n-        int port = -1;\n+            // Set Scheme from configured protocol\n+            if (forwarded._proto != null)\n+            {\n+                proto = forwarded._proto;\n+                request.setScheme(proto);\n+            }\n \n-        // Use authority from headers, if configured.\n-        if (forwarded._authority != null)\n-        {\n-            host = forwarded._authority._host;\n-            port = forwarded._authority._port;\n-        }\n+            // Set authority\n+            String host = null;\n+            int port = -1;\n \n-        // Fall back to request metadata if needed.\n-        HttpURI requestURI = request.getMetaData().getURI();\n-        if (host == null)\n-        {\n-            host = requestURI.getHost();\n-        }\n-        if (port == MutableHostPort.UNSET) // is unset by headers\n-        {\n-            port = requestURI.getPort();\n-        }\n-        // Don't change port if port == IMPLIED.\n+            // Use authority from headers, if configured.\n+            if (forwarded._authority != null)\n+            {\n+                host = forwarded._authority._host;\n+                port = forwarded._authority._port;\n+            }\n \n-        // Update authority if different from metadata\n-        if (!host.equalsIgnoreCase(requestURI.getHost()) ||\n-            port != requestURI.getPort())\n-        {\n-            httpFields.put(new HostPortHttpField(host, port));\n-            request.setAuthority(host, port);\n-        }\n+            // Fall back to request metadata if needed.\n+            HttpURI requestURI = request.getMetaData().getURI();\n+            if (host == null)\n+            {\n+                host = requestURI.getHost();\n+            }\n+            if (port == MutableHostPort.UNSET) // is unset by headers\n+            {\n+                port = requestURI.getPort();\n+            }\n+            // Don't change port if port == IMPLIED.\n \n-        // Set secure status\n-        if (forwarded.isSecure() ||\n-            proto.equalsIgnoreCase(config.getSecureScheme()) ||\n-            port == getSecurePort(config))\n-        {\n-            request.setSecure(true);\n-            request.setScheme(proto);\n-        }\n+            // Update authority if different from metadata\n+            if (!host.equalsIgnoreCase(requestURI.getHost()) ||\n+                port != requestURI.getPort())\n+            {\n+                httpFields.put(new HostPortHttpField(host, port));\n+                request.setAuthority(host, port);\n+            }\n \n-        // Set Remote Address\n-        if (forwarded.hasFor())\n-        {\n-            int forPort = forwarded._for._port > 0 ? forwarded._for._port : request.getRemotePort();\n-            request.setRemoteAddr(InetSocketAddress.createUnresolved(forwarded._for._host, forPort));\n+            // Set secure status\n+            if (forwarded.isSecure() ||\n+                proto.equalsIgnoreCase(config.getSecureScheme()) ||\n+                port == getSecurePort(config))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87"}, "originalPosition": 127}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzI0MDAw", "url": "https://github.com/eclipse/jetty.project/pull/5445#pullrequestreview-507324000", "createdAt": "2020-10-13T11:14:24Z", "commit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToxNDoyNVrOHghkrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToxNDoyNVrOHghkrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg2NjU0Mg==", "bodyText": "I don't think this match logic should be required.   There are many headers and some are orthogonal to others, so the logic below must be robust and can't be gated by a match, which may be for an unrelated header.\nIn the OPs case, proto must not be changed unless there is an explicit header that changes it - either giving a proto or forcing secure.\nPerhaps this match is an optimisation to avoid several ifs below, but I don't think it is necessary as this customizer is typically only deployed when all request will have such a header.", "url": "https://github.com/eclipse/jetty.project/pull/5445#discussion_r503866542", "createdAt": "2020-10-13T11:14:25Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -461,81 +461,88 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n \n         // Do a single pass through the header fields as it is a more efficient single iteration.\n         Forwarded forwarded = new Forwarded(request, config);\n+        boolean match = false;\n         for (HttpField field : httpFields)\n         {\n             try\n             {\n                 MethodHandle handle = _handles.get(field.getName());\n                 if (handle != null)\n+                {\n+                    match = true;\n                     handle.invoke(forwarded, field);\n+                }\n             }\n             catch (Throwable t)\n             {\n                 onError(field, t);\n             }\n         }\n \n-        String proto = \"http\";\n-\n-        // Is secure status configured from headers?\n-        if (forwarded.isSecure())\n+        if (match)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b646ee6b78c5e4e1dff6ddbf641b839360d8a87"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0681b33ebfaefa7082de5afe615ca01ef49955b", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/f0681b33ebfaefa7082de5afe615ca01ef49955b", "committedDate": "2020-10-13T12:03:37Z", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Simplify isSecure handling in customize.\n+ Simplify handling of `Proxy-Ssl-Id` header.\n+ Simplify handling of `Proxy-auth-cert` header.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abdada05b1d08ade47c1e8e82774fb5a2e98bb26", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/abdada05b1d08ade47c1e8e82774fb5a2e98bb26", "committedDate": "2020-10-13T12:15:38Z", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Improve / document implied secure scheme behaviors\n  for both `Proxy-Ssl-Id` or `Proxy-auth-cert`\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea1103077cb6938d96ddc1c978c7fad7a5cb39e0", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/ea1103077cb6938d96ddc1c978c7fad7a5cb39e0", "committedDate": "2020-10-13T13:20:27Z", "message": "Issue #5443 - Forwarding Headers are optional\n\n+ Additional tests for HTTP/1.0\n+ Overly complex negative test cases for\n   `X-Forwarded-Proto: http` and\n   `X-Proxied-Https: off`\n+ Failure testcase for `X-Proxied-Https: foo`\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "457025bc16c5cd6b4a0ecf547fc281df9839af81", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/457025bc16c5cd6b4a0ecf547fc281df9839af81", "committedDate": "2020-10-13T13:24:49Z", "message": "Issue #5443 - Forwarding Headers are optional\n\nAdditional NPE safety checks.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0721178007a884d2e4ef4b6ecf238266218e900b", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/0721178007a884d2e4ef4b6ecf238266218e900b", "committedDate": "2020-10-13T13:31:32Z", "message": "Issue #5443 - Forwarding Headers are optional\n\nThe `X-Proxied-Https: off` case should have an implied port\nnot a hardcoded port.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89dc16ae0999955699c16b26fbef80d64504c172", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/89dc16ae0999955699c16b26fbef80d64504c172", "committedDate": "2020-10-13T15:27:01Z", "message": "Issue #5443 - Forwarding Headers are optional\n\nCleanup handling of forwarded.authority\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTY1ODAy", "url": "https://github.com/eclipse/jetty.project/pull/5445#pullrequestreview-507565802", "createdAt": "2020-10-13T15:29:49Z", "commit": {"oid": "89dc16ae0999955699c16b26fbef80d64504c172"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 37, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}