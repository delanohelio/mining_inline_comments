{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMzgzNDYz", "number": 5119, "title": "Issue #1337 Use either absolute or relative multipart file location", "bodyText": "Closes #1337\nNow eclipse-ee4j/servlet-api#276 has been merged to the spec, the meaning of Part.write(String) is a bit clearer. This PR implements using either an absolute or relative location (relative to the MultiPartConfigElement.location).", "createdAt": "2020-08-05T13:27:09Z", "url": "https://github.com/eclipse/jetty.project/pull/5119", "merged": true, "mergeCommit": {"oid": "e117fbe8281bd43ec5601a30d39f50a09cbcef22"}, "closed": true, "closedAt": "2020-08-10T08:31:17Z", "author": {"login": "janbartel"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc77K6eAH2gAyNDYzMzgzNDYzOjQyYjllOGJmYWU3MTEwZmU0NmE2MWYzYzJlNjc3OWRhOTliYjVlYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8pWioAFqTQ2MzU1MjI5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5", "committedDate": "2020-08-05T13:23:56Z", "message": "Issue #1337 Use either absolute or relative multipart file location\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjg5NzI0", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-461689724", "createdAt": "2020-08-05T13:57:23Z", "commit": {"oid": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDMxMDM0", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-462031034", "createdAt": "2020-08-05T21:18:01Z", "commit": {"oid": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToxODowMVrOG8a-mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToxODowMVrOG8a-mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwOTc1NQ==", "bodyText": "This is the only relevant part of this change.\nThe rest is just confusing.", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r466009755", "createdAt": "2020-08-05T21:18:01Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -535,20 +541,20 @@ protected void parse()\n         {\n             // sort out the location to which to write the files\n             if (_config.getLocation() == null)\n-                _tmpDir = _contextTmpDir;\n+                _tmpDir = _contextTmpDir.toPath();\n             else if (\"\".equals(_config.getLocation()))\n-                _tmpDir = _contextTmpDir;\n+                _tmpDir = _contextTmpDir.toPath();\n             else\n             {\n-                File f = new File(_config.getLocation());\n-                if (f.isAbsolute())\n-                    _tmpDir = f;\n+                Path location = FileSystems.getDefault().getPath(_config.getLocation());\n+                if (location.isAbsolute())\n+                    _tmpDir = location;\n                 else\n-                    _tmpDir = new File(_contextTmpDir, _config.getLocation());\n+                    _tmpDir = _contextTmpDir.toPath().resolve(location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42b9e8bfae7110fe46a61f3c2e6779da99bb5eb5"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f198ffba10fb3c79042ef0a73fb0298cd27a3d", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/00f198ffba10fb3c79042ef0a73fb0298cd27a3d", "committedDate": "2020-08-06T15:10:30Z", "message": "Issue #1337 Add comments; add blank line to test\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/bf410704ed0f23c5ac651571511ebba85be43c93", "committedDate": "2020-08-07T12:34:39Z", "message": "Issue #1337 Some changes after review.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjg0MjQw", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-463284240", "createdAt": "2020-08-07T12:49:07Z", "commit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMjo0OTowN1rOG9YkSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMjo1MToyMFrOG9YowA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODgyNQ==", "bodyText": "You have the same isAbsolute check in both branches below so perhaps do that here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Path p = Path.of(fileName);\n          \n          \n            \n                        \n          \n          \n            \n                        Path p = Path.of(fileName);\n          \n          \n            \n                        p = p.isAbsolute() ? p : _tmpDir.resolve(p);", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467018825", "createdAt": "2020-08-07T12:49:07Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,17 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);\n+            ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODk1NA==", "bodyText": "move this above", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467018954", "createdAt": "2020-08-07T12:49:24Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,17 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);\n+            \n             if (_file == null)\n             {\n                 _temporary = false;\n \n                 // part data is only in the ByteArrayOutputStream and never been written to disk\n-                _file = new File(_tmpDir, fileName);\n+                if (!p.isAbsolute())\n+                    p = _tmpDir.resolve(p);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxOTE1OA==", "bodyText": "move this absolute check to above", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467019158", "createdAt": "2020-08-07T12:49:48Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -208,7 +214,7 @@ public void write(String fileName) throws IOException\n                 _temporary = false;\n \n                 Path src = _file.toPath();\n-                Path target = src.resolveSibling(fileName);\n+                Path target = (p.isAbsolute() ? p : _tmpDir.resolve(p));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxOTk2OA==", "bodyText": "Note that while I know resolve also handles absolute addresses, I do kind of like seeing it explicit in this code, so you can understand it without the need to have deep knowledge of how resolve behaves.   Maybe have a comment to that effect?", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467019968", "createdAt": "2020-08-07T12:51:20Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,17 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);\n+            ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAxODgyNQ=="}, "originalCommit": {"oid": "bf410704ed0f23c5ac651571511ebba85be43c93"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/bb0a289596c5033d75f781dc557df3ac4b31d6b9", "committedDate": "2020-08-07T12:59:16Z", "message": "Issue #1337 Update after review.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzIzMDcy", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-463323072", "createdAt": "2020-08-07T13:43:23Z", "commit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0MzoyM1rOG9aZSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0MzoyM1rOG9aZSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA0ODc3OA==", "bodyText": "Note. Path.of(String...) is new for Java 11.\nThe original technique would be Paths.get(String...)\n(Just in case you are using these techniques back in Jetty 9.4..x)", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467048778", "createdAt": "2020-08-07T13:43:23Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/MultiPartFormInputStream.java", "diffHunk": "@@ -185,12 +186,16 @@ protected void write(byte[] bytes, int offset, int length) throws IOException\n         @Override\n         public void write(String fileName) throws IOException\n         {\n+            Path p = Path.of(fileName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzI2NTg3", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-463326587", "createdAt": "2020-08-07T13:47:44Z", "commit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0Nzo0NFrOG9ajxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0Nzo0NFrOG9ajxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTQ2MQ==", "bodyText": "Should probably add a test in here to know if the file got deleted (or not).\nThe temp files (note, if the Part was specifically .write(String) then it's no longer a temp file) for a MultiPartFormInputStream should only exist for as long as that MultiPartFormInputStream is live. (ie: if the MPFIS is closed, then the temp files should be deleted), as there's no sane way via the API to access the temporary contents anymore.", "url": "https://github.com/eclipse/jetty.project/pull/5119#discussion_r467051461", "createdAt": "2020-08-07T13:47:44Z", "author": {"login": "joakime"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/MultiPartFormInputStreamTest.java", "diffHunk": "@@ -474,6 +475,77 @@ public void testPartFileNotDeleted() throws Exception\n         assertThat(tptfd.exists(), is(true));  //explicitly written file did not get removed after cleanup\n         tptfd.deleteOnExit(); //clean up test\n     }\n+    \n+    @Test\n+    public void testPartFileAbsolute() throws Exception\n+    {\n+        MultipartConfigElement config = new MultipartConfigElement(_dirname, 1024, 3072, 50);\n+        MultiPartFormInputStream mpis = new MultiPartFormInputStream(new ByteArrayInputStream(createMultipartRequestString(\"tpfa\").getBytes()),\n+            _contentType,\n+            config,\n+            _tmpDir);\n+        mpis.setDeleteOnExit(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTUyMjk5", "url": "https://github.com/eclipse/jetty.project/pull/5119#pullrequestreview-463552299", "createdAt": "2020-08-07T19:12:16Z", "commit": {"oid": "bb0a289596c5033d75f781dc557df3ac4b31d6b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 273, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}