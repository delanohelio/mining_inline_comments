{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMTE0ODY4", "number": 5251, "title": "Issue #5247 ForwardedRequestCustomizer authority order rework", "bodyText": "This is an alternate approach for handling the search order for request.authority in ForwardedRequestCustomizer.\nWith javadoc.", "createdAt": "2020-09-09T20:22:05Z", "url": "https://github.com/eclipse/jetty.project/pull/5251", "merged": true, "mergeCommit": {"oid": "8fe32ce21730bde3c071d1a630aec5acac8f6db1"}, "closed": true, "closedAt": "2020-09-23T21:14:51Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHRw8WgH2gAyNDgzMTE0ODY4OmY3NGNhZGE2NjBlODNiNjZiMWY1YjkzNmRkNzM3YWQ0YTY3NGRmMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLFNT6AH2gAyNDgzMTE0ODY4OmViZmRmOGZjMWI5ZGQ0ZTFhNTgwMzQ2Y2U3NDM3YWE2NGZlNDRiMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f74cada660e83b66b1f5b936dd737ad4a674df0d", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/f74cada660e83b66b1f5b936dd737ad4a674df0d", "committedDate": "2020-09-09T19:56:33Z", "message": "Issue #5247 - Priority based ForwardedRequestCustomizer\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42803030463cb45819848904ddb5d29495e55350", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/42803030463cb45819848904ddb5d29495e55350", "committedDate": "2020-09-09T20:20:21Z", "message": "Issue #5247 - Document ForwardedRequestCustomizer authority search order\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac42cbd1436f6a161ef03e1ca7f9c4a2bf686933", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/ac42cbd1436f6a161ef03e1ca7f9c4a2bf686933", "committedDate": "2020-09-11T16:11:09Z", "message": "Issue #5247 - Improve testing of ForwardedRequestCustomizer\n\n+ Merge ProxyPass tests from CheckReverseProxyHeadersTest into\n  ForwardedRequestCustomizerTest\n+ Deleted CheckReverseProxyHeadersTest.java\n+ Add more tests for ForcedHost configuration\n+ Updated ForwardedRequestCustomizer to conform to expectations\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2233ce23314978f9f7d628cf4b81517e206deb5", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/a2233ce23314978f9f7d628cf4b81517e206deb5", "committedDate": "2020-09-11T16:17:31Z", "message": "Issue #5247 - Introduce ForwardedRequestCustomizer.Priority enum\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59b85b62883ad88f0d48e7cbeeeeefeb845f6f32", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/59b85b62883ad88f0d48e7cbeeeeefeb845f6f32", "committedDate": "2020-09-11T16:58:04Z", "message": "Issue #5247 - Updating Javadoc on ForwardedRequestCustomizer\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385b11dc340c2628c5e38d86bf801937cbd71533", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/385b11dc340c2628c5e38d86bf801937cbd71533", "committedDate": "2020-09-11T17:54:18Z", "message": "Issue #5247 - Disable javadoc lint in compact3 build\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDg2NzM2", "url": "https://github.com/eclipse/jetty.project/pull/5251#pullrequestreview-492486736", "createdAt": "2020-09-21T11:06:22Z", "commit": {"oid": "385b11dc340c2628c5e38d86bf801937cbd71533"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTowNjoyMlrOHVKuNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMToxMDo1NlrOHVK3kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk1NzgxMw==", "bodyText": "Rather than \"Priority\" I think \"Source\" is a better name for this.  Will make more sense in logging to see something like \"source=XFORWARDED_FOR\".  It also matches a lot of our webapp config stuff where we record the source, which is then used to determine the priority.", "url": "https://github.com/eclipse/jetty.project/pull/5251#discussion_r491957813", "createdAt": "2020-09-21T11:06:22Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -516,61 +644,139 @@ private boolean updateForwardedHandle(MethodHandles.Lookup lookup, String header\n         return !_handles.put(headerName, lookup.findVirtual(Forwarded.class, forwardedMethodName, type));\n     }\n \n-    private static class ForcedHostPort extends HostPort\n+    private static class MutableHostPort\n     {\n-        ForcedHostPort(String authority)\n+        public static final int UNSET = -1;\n+        public static final int IMPLIED = 0;\n+\n+        String _host;\n+        Priority _hostPriority = Priority.UNSET;\n+        int _port = UNSET;\n+        Priority _portPriority = Priority.UNSET;\n+\n+        public void setHost(String host, Priority priority)\n         {\n-            super(authority);\n+            if (priority.ordinal() > _hostPriority.ordinal())\n+            {\n+                _host = host;\n+                _hostPriority = priority;\n+            }\n         }\n-    }\n \n-    private static class PossiblyPartialHostPort extends HostPort\n-    {\n-        PossiblyPartialHostPort(String authority)\n+        public void setPort(int port, Priority priority)\n         {\n-            super(authority);\n+            if (priority.ordinal() > _portPriority.ordinal())\n+            {\n+                _port = port;\n+                _portPriority = priority;\n+            }\n         }\n \n-        protected PossiblyPartialHostPort(String host, int port)\n+        public void setHostPort(HostPort hostPort, Priority priority)\n         {\n-            super(host, port);\n+            if (priority.ordinal() > _hostPriority.ordinal())\n+            {\n+                _host = hostPort.getHost();\n+                _hostPriority = priority;\n+            }\n+\n+            int port = hostPort.getPort();\n+            // Is port supplied?\n+            if (port > 0 && priority.ordinal() > _portPriority.ordinal())\n+            {\n+                _port = hostPort.getPort();\n+                _portPriority = priority;\n+            }\n+            // Since we are Host:Port pair, the port could be unspecified\n+            // Meaning it's implied.\n+            // Make sure that we switch the tracked port from unset to implied\n+            else if (_port == UNSET)\n+            {\n+                // set port to implied (with no priority)\n+                _port = IMPLIED;\n+            }\n         }\n-    }\n \n-    private static class PortSetHostPort extends PossiblyPartialHostPort\n-    {\n-        PortSetHostPort(String host, int port)\n+        @Override\n+        public String toString()\n         {\n-            super(host, port);\n+            final StringBuilder sb = new StringBuilder(\"MutableHostPort{\");\n+            sb.append(\"host='\").append(_host).append(\"'/\").append(_hostPriority);\n+            sb.append(\", port=\").append(_port);\n+            sb.append(\"/\").append(_portPriority);\n+            sb.append('}');\n+            return sb.toString();\n         }\n     }\n \n-    private static class Rfc7239HostPort extends HostPort\n+    /**\n+     * Ordered Priority Enum.\n+     * <p>\n+     * Lowest priority first.\n+     * </p>\n+     */\n+    public enum Priority", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "385b11dc340c2628c5e38d86bf801937cbd71533"}, "originalPosition": 335}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2MDIwOQ==", "bodyText": "maybe:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    getAuthority().setHost(hostField.getHost(), Priority.FORWARDED);\n          \n          \n            \n                                    getAuthority().setPort(hostField.getPort(), Priority.FORWARDED);\n          \n          \n            \n                                    getAuthority().setHostPort(hostField.getHost(), hostField.getPort(), Priority.FORWARDED);", "url": "https://github.com/eclipse/jetty.project/pull/5251#discussion_r491960209", "createdAt": "2020-09-21T11:10:56Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -688,34 +861,71 @@ protected void parsedParam(StringBuffer buffer, int valueLength, int paramName,\n                 switch (name)\n                 {\n                     case \"by\":\n+                    {\n                         if (!getProxyAsAuthority())\n                             break;\n                         if (value.startsWith(\"_\") || \"unknown\".equals(value))\n                             break;\n-                        if (_host == null || !(_host instanceof Rfc7239HostPort))\n-                            _host = new Rfc7239HostPort(value);\n+                        HostPort hostField = new HostPort(value);\n+                        getAuthority().setHost(hostField.getHost(), Priority.FORWARDED);\n+                        getAuthority().setPort(hostField.getPort(), Priority.FORWARDED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "385b11dc340c2628c5e38d86bf801937cbd71533"}, "originalPosition": 541}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebfdf8fc1b9dd4e1a580346ce7437aa64fe44b18", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/ebfdf8fc1b9dd4e1a580346ce7437aa64fe44b18", "committedDate": "2020-09-21T15:34:28Z", "message": "Issue #5247 - Updates from review by greg\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 335, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}