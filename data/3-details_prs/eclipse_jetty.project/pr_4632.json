{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjQxOTQ3", "number": 4632, "title": "Issue #4631 - Warning about skipping of <Arg> nodes is in wrong place for <Configure>", "bodyText": "The warning for skipping of <Arg> nodes was left over after the work done in issue #4550\nThis warning isn't appropriate in the original place any more.\nAdded unit tests so that warnings are always in the appropriate place.", "createdAt": "2020-03-02T22:29:12Z", "url": "https://github.com/eclipse/jetty.project/pull/4632", "merged": true, "mergeCommit": {"oid": "965483e4d9b4eac40478b28871f6d1e26d333034"}, "closed": true, "closedAt": "2020-03-10T14:11:22Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ1JnGAH2gAyMzgyNjQxOTQ3OmI4MzljZTYzNjZkYTM0NzU5NmRhZTRiY2NjMWY0OTU5MmQyZDcxOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMTKY3gFqTM3MTk4ODE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b839ce6366da347596dae4bccc1f49592d2d7195", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/b839ce6366da347596dae4bccc1f49592d2d7195", "committedDate": "2020-03-02T22:06:52Z", "message": "Issue #4631 - Fixing XML comment that was accidentally reformatted\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfdffd17d9765071e91eaf9c7d81f14c71bb0494", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/cfdffd17d9765071e91eaf9c7d81f14c71bb0494", "committedDate": "2020-03-02T22:26:40Z", "message": "Issue #4631 - Warning about skipping of <Arg> nodes is in wrong place for <Configure>\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89f2cad2c064655012481421910387f65c2f2430", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/89f2cad2c064655012481421910387f65c2f2430", "committedDate": "2020-03-02T22:33:57Z", "message": "Issue #4631 - Improving testcase\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Nzc1OTU5", "url": "https://github.com/eclipse/jetty.project/pull/4632#pullrequestreview-367775959", "createdAt": "2020-03-03T08:22:10Z", "commit": {"oid": "89f2cad2c064655012481421910387f65c2f2430"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee3246674f4f163736d4f63b066e54dd1348a73", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/3ee3246674f4f163736d4f63b066e54dd1348a73", "committedDate": "2020-03-03T15:57:43Z", "message": "Issue #4631 - Removing test classes\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7e8ed1b7097afd96e8761bd1f02e2193c4bcd2", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/da7e8ed1b7097afd96e8761bd1f02e2193c4bcd2", "committedDate": "2020-03-03T16:00:11Z", "message": "Issue #4631 - Cleaning up configure with index per PR review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69fa180e8890615809aea4e91db97edc06a85e96", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/69fa180e8890615809aea4e91db97edc06a85e96", "committedDate": "2020-03-03T16:27:18Z", "message": "Issue #4631 - More named arg test cases\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc80ebed6c2d0cefadc8e307fded491841e63308", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/cc80ebed6c2d0cefadc8e307fded491841e63308", "committedDate": "2020-03-03T17:52:12Z", "message": "Issue #4631 - Add testConfiguredWithNamedArgNotFirst\n\n+ new testcase where <Arg> is needed, but is not the first node\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDAwNjcx", "url": "https://github.com/eclipse/jetty.project/pull/4632#pullrequestreview-371400671", "createdAt": "2020-03-09T17:50:50Z", "commit": {"oid": "cc80ebed6c2d0cefadc8e307fded491841e63308"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzo1MDo1MVrOFzzH3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzo1MTozN1rOFzzJ2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1OTI5Mg==", "bodyText": "Something weird has gone on in the history!  I thought the idea of passing in the index was so that leading ignored Args could be skipped!", "url": "https://github.com/eclipse/jetty.project/pull/4632#discussion_r389859292", "createdAt": "2020-03-09T17:50:51Z", "author": {"login": "gregw"}, "path": "jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java", "diffHunk": "@@ -493,21 +501,6 @@ public Object configure() throws Exception\n          */\n         public void configure(Object obj, XmlParser.Node cfg, int i) throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc80ebed6c2d0cefadc8e307fded491841e63308"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1OTgwMA==", "bodyText": "I think we should somehow increment the index variable so that the Arg is ignored", "url": "https://github.com/eclipse/jetty.project/pull/4632#discussion_r389859800", "createdAt": "2020-03-09T17:51:37Z", "author": {"login": "gregw"}, "path": "jetty-xml/src/main/java/org/eclipse/jetty/xml/XmlConfiguration.java", "diffHunk": "@@ -466,6 +468,12 @@ public Object configure() throws Exception\n                     throw new IllegalStateException(String.format(\"No matching constructor %s in %s\", oClass, _configuration));\n                 }\n             }\n+            else\n+            {\n+                // The Object already existed, if it has <Arg> nodes, warn about them not being used.\n+                XmlConfiguration.getNodes(_root, \"Arg\")\n+                    .forEach((node) -> LOG.warn(\"Ignored arg {} in {}\", node, this._configuration._location));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc80ebed6c2d0cefadc8e307fded491841e63308"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3149c07a1530c5c560bdad4e4dc4efb015349d", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/ad3149c07a1530c5c560bdad4e4dc4efb015349d", "committedDate": "2020-03-10T13:16:35Z", "message": "Cleanup configuration index usage\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTU1MTMw", "url": "https://github.com/eclipse/jetty.project/pull/4632#pullrequestreview-371955130", "createdAt": "2020-03-10T13:36:07Z", "commit": {"oid": "ad3149c07a1530c5c560bdad4e4dc4efb015349d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTg4MTcy", "url": "https://github.com/eclipse/jetty.project/pull/4632#pullrequestreview-371988172", "createdAt": "2020-03-10T14:12:38Z", "commit": {"oid": "ad3149c07a1530c5c560bdad4e4dc4efb015349d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoxMjozOFrOF0Qlpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoxMjozOFrOF0Qlpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM0MjA1NA==", "bodyText": "I would like to see a test where there is a Arg misplaced, as below, so that we define in a test how we should behave.\n<Configure ...>\n  <Arg>...</Arg>\n  <New ...>...</New>\n  <Arg>...</Arg>\n</Configure>", "url": "https://github.com/eclipse/jetty.project/pull/4632#discussion_r390342054", "createdAt": "2020-03-10T14:12:38Z", "author": {"login": "sbordet"}, "path": "jetty-xml/src/test/java/org/eclipse/jetty/xml/XmlConfigurationTest.java", "diffHunk": "@@ -1309,6 +1318,185 @@ public void testJettyStandardIdsAndPropertiesAndJettyHomeUriAndJettyBaseUri() th\n         }\n     }\n \n+    public static class BarNamed\n+    {\n+        private String foo;\n+        private List<String> zeds;\n+\n+        public BarNamed(@Name(\"foo\") String foo)\n+        {\n+            this.foo = foo;\n+        }\n+\n+        public void addZed(String zed)\n+        {\n+            if (zeds == null)\n+                zeds = new ArrayList<>();\n+            zeds.add(zed);\n+        }\n+\n+        public List<String> getZeds()\n+        {\n+            return zeds;\n+        }\n+\n+        public String getFoo()\n+        {\n+            return foo;\n+        }\n+    }\n+\n+    @Test\n+    public void testConfiguredWithNamedArg() throws Exception\n+    {\n+        XmlConfiguration xmlFoo = asXmlConfiguration(\"foo.xml\",\n+            \"<Configure>\\n\" +\n+                \"  <New id=\\\"foo\\\" class=\\\"java.lang.String\\\">\\n\" +\n+                \"    <Arg>foozball</Arg>\\n\" +\n+                \"  </New>\\n\" +\n+                \"</Configure>\");\n+        XmlConfiguration xmlBar = asXmlConfiguration(\"bar.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg name=\\\"foo\\\"><Ref refid=\\\"foo\\\"/></Arg>\\n\" +\n+                \"</Configure>\");\n+\n+        try (StdErrCapture logCapture = new StdErrCapture(XmlConfiguration.class))\n+        {\n+            Map<String, Object> idMap = mimicXmlConfigurationMain(xmlFoo, xmlBar);\n+            Object obj = idMap.get(\"bar\");\n+            assertThat(\"BarNamed instance created\", obj, instanceOf(BarNamed.class));\n+            BarNamed bar = (BarNamed)obj;\n+            assertThat(\"BarNamed has foo\", bar.getFoo(), is(\"foozball\"));\n+\n+            List<String> warnLogs = logCapture.getLines()\n+                .stream().filter(line -> line.contains(\":WARN:\"))\n+                .collect(Collectors.toList());\n+\n+            assertThat(\"WARN logs size\", warnLogs.size(), is(0));\n+        }\n+    }\n+\n+    @Test\n+    public void testConfiguredWithArgNotUsingName() throws Exception\n+    {\n+        XmlConfiguration xmlFoo = asXmlConfiguration(\"foo.xml\",\n+            \"<Configure>\\n\" +\n+                \"  <New id=\\\"foo\\\" class=\\\"java.lang.String\\\">\\n\" +\n+                \"    <Arg>foozball</Arg>\\n\" +\n+                \"  </New>\\n\" +\n+                \"</Configure>\");\n+        XmlConfiguration xmlBar = asXmlConfiguration(\"bar.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg><Ref refid=\\\"foo\\\"/></Arg>\\n\" + // no name specified\n+                \"</Configure>\");\n+\n+        try (StdErrCapture logCapture = new StdErrCapture(XmlConfiguration.class))\n+        {\n+            Map<String, Object> idMap = mimicXmlConfigurationMain(xmlFoo, xmlBar);\n+            Object obj = idMap.get(\"bar\");\n+            assertThat(\"BarNamed instance created\", obj, instanceOf(BarNamed.class));\n+            BarNamed bar = (BarNamed)obj;\n+            assertThat(\"BarNamed has foo\", bar.getFoo(), is(\"foozball\"));\n+\n+            List<String> warnLogs = logCapture.getLines()\n+                .stream().filter(line -> line.contains(\":WARN:\"))\n+                .collect(Collectors.toList());\n+\n+            assertThat(\"WARN logs size\", warnLogs.size(), is(0));\n+        }\n+    }\n+\n+    @Test\n+    public void testConfiguredWithBadNamedArg() throws Exception\n+    {\n+        XmlConfiguration xmlBar = asXmlConfiguration(\"bar.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg name=\\\"foozball\\\">foozball</Arg>\\n\" + // wrong name specified\n+                \"</Configure>\");\n+\n+        IllegalStateException cause = assertThrows(IllegalStateException.class, () ->\n+            mimicXmlConfigurationMain(xmlBar));\n+\n+        assertThat(\"Cause message\", cause.getMessage(), containsString(\"No matching constructor\"));\n+    }\n+\n+    @Test\n+    public void testConfiguredWithTooManyNamedArgs() throws Exception\n+    {\n+        XmlConfiguration xmlBar = asXmlConfiguration(\"bar.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg name=\\\"foo\\\">foozball</Arg>\\n\" +\n+                \"  <Arg name=\\\"foo\\\">soccer</Arg>\\n\" + // neither should win\n+                \"</Configure>\");\n+\n+        IllegalStateException cause = assertThrows(IllegalStateException.class, () ->\n+            mimicXmlConfigurationMain(xmlBar));\n+\n+        assertThat(\"Cause message\", cause.getMessage(), containsString(\"No matching constructor\"));\n+    }\n+\n+    @Test\n+    public void testConfiguredSameWithNamedArgTwice() throws Exception\n+    {\n+        XmlConfiguration xmlFoo = asXmlConfiguration(\"foo.xml\",\n+            \"<Configure>\\n\" +\n+                \"  <New id=\\\"foo\\\" class=\\\"java.lang.String\\\">\\n\" +\n+                \"    <Arg>foozball</Arg>\\n\" +\n+                \"  </New>\\n\" +\n+                \"</Configure>\");\n+        XmlConfiguration xmlBar = asXmlConfiguration(\"bar.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg name=\\\"foo\\\"><Ref refid=\\\"foo\\\"/></Arg>\\n\" +\n+                \"</Configure>\");\n+        XmlConfiguration xmlAddZed = asXmlConfiguration(\"zed.xml\",\n+            \"<Configure id=\\\"bar\\\" class=\\\"\" + BarNamed.class.getName() + \"\\\">\\n\" +\n+                \"  <Arg name=\\\"foo\\\">baz</Arg>\\n\" + // the invalid line\n+                \"  <Call name=\\\"addZed\\\">\\n\" +\n+                \"    <Arg>plain-zero</Arg>\\n\" +\n+                \"  </Call>\\n\" +\n+                \"</Configure>\");\n+\n+        try (StdErrCapture logCapture = new StdErrCapture(XmlConfiguration.class))\n+        {\n+            Map<String, Object> idMap = mimicXmlConfigurationMain(xmlFoo, xmlBar, xmlAddZed);\n+            Object obj = idMap.get(\"bar\");\n+            assertThat(\"BarNamed instance created\", obj, instanceOf(BarNamed.class));\n+            BarNamed bar = (BarNamed)obj;\n+            assertThat(\"BarNamed has foo\", bar.getFoo(), is(\"foozball\"));\n+            List<String> zeds = bar.getZeds();\n+            assertThat(\"BarNamed has zeds\", zeds, not(empty()));\n+            assertThat(\"Zeds[0]\", zeds.get(0), is(\"plain-zero\"));\n+\n+            List<String> warnLogs = logCapture.getLines()\n+                .stream().filter(line -> line.contains(\":WARN:\"))\n+                .collect(Collectors.toList());\n+\n+            assertThat(\"WARN logs count\", warnLogs.size(), is(1));\n+\n+            String actualWarn = warnLogs.get(0);\n+            assertThat(\"WARN logs\", actualWarn,\n+                allOf(containsString(\"Ignored arg <Arg name=\"),\n+                    containsString(\"zed.xml\")\n+                ));\n+        }\n+    }\n+\n+    /**\n+     * This mimics the XML load behavior in XmlConfiguration.main(String ... args)\n+     */\n+    private Map<String, Object> mimicXmlConfigurationMain(XmlConfiguration... configurations) throws Exception\n+    {\n+        XmlConfiguration last = null;\n+        for (XmlConfiguration configuration : configurations)\n+        {\n+            if (last != null)\n+                configuration.getIdMap().putAll(last.getIdMap());\n+            configuration.configure();\n+            last = configuration;\n+        }\n+        return last.getIdMap();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3149c07a1530c5c560bdad4e4dc4efb015349d"}, "originalPosition": 214}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 479, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}