{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDMyODcx", "number": 4844, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1NjowNFrOD5We6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToyMlrOD5Wi9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDYzNzg1OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ProxyConnectionFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1NjowNFrOGQkM9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1MzowOFrOGQl4kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMzU0Mg==", "bodyText": "I don't think this is correct.\nBy this point, the buffer is guaranteed to have at least _length bytes in it, so Math.min() is not necessary.\nFurthermore, I think it's wrong for LOCAL to upgrade the connection (it happens few lines below) - it was probably wrong before too.\nI don't know exactly what needs to be done when receiving a LOCAL command though - perhaps just read and discard until -1. Let's discuss this.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420023542", "createdAt": "2020-05-05T10:56:04Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ProxyConnectionFactory.java", "diffHunk": "@@ -662,6 +662,10 @@ private void parseBodyAndUpgrade() throws IOException\n                     if (LOG.isDebugEnabled())\n                         LOG.debug(\"Proxy v2 {} {}\", getEndPoint(), proxyEndPoint.toString());\n                 }\n+                else\n+                {\n+                    _buffer.position(_buffer.position() + Math.min(_buffer.remaining(), _length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1MTA4OQ==", "bodyText": "Regarding upgrading: as discussed; the connection should be upgraded and handled normally even when the command is LOCAL.\nRegarding Math.min(), you're right that it's not needed as the buffer is guaranteed to contain at least _length bytes at that point. So I'll remove it.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420051089", "createdAt": "2020-05-05T11:53:08Z", "author": {"login": "lorban"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ProxyConnectionFactory.java", "diffHunk": "@@ -662,6 +662,10 @@ private void parseBodyAndUpgrade() throws IOException\n                     if (LOG.isDebugEnabled())\n                         LOG.debug(\"Proxy v2 {} {}\", getEndPoint(), proxyEndPoint.toString());\n                 }\n+                else\n+                {\n+                    _buffer.position(_buffer.position() + Math.min(_buffer.remaining(), _length));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMzU0Mg=="}, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY0NTU4OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyConnectionTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1ODozMlrOGQkRpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo0Nzo0M1rOGQltuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNDc0MA==", "bodyText": "I'm not sure you should get back a 200 OK response for a LOCAL command.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420024740", "createdAt": "2020-05-05T10:58:32Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyConnectionTest.java", "diffHunk": "@@ -151,6 +151,39 @@ public void testIPv6V2(RequestProcessor p) throws Exception\n         assertThat(response, Matchers.containsString(\"remote=ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff:12345\"));\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"requestProcessors\")\n+    public void testLocalV2(RequestProcessor p) throws Exception\n+    {\n+        String proxy =\n+            // Preamble\n+            \"0D0A0D0A000D0A515549540A\" +\n+\n+                // V2, LOCAL\n+                \"20\" +\n+\n+                // 0x1 : AF_INET    0x1 : STREAM.\n+                \"11\" +\n+\n+                // Address length is 16.\n+                \"0010\" +\n+\n+                // gibberish\n+                \"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\"\n+            ;\n+        String http = \"GET /path HTTP/1.1\\n\" +\n+            \"Host: server:80\\n\" +\n+            \"Connection: close\\n\" +\n+            \"\\n\";\n+\n+        String response = p.sendRequestWaitingForResponse(TypeUtil.fromHexString(proxy), http.getBytes(StandardCharsets.US_ASCII));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0ODMxMw==", "bodyText": "As discussed; the connection should be upgraded and handled normally even when the command is LOCAL.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420048313", "createdAt": "2020-05-05T11:47:43Z", "author": {"login": "lorban"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyConnectionTest.java", "diffHunk": "@@ -151,6 +151,39 @@ public void testIPv6V2(RequestProcessor p) throws Exception\n         assertThat(response, Matchers.containsString(\"remote=ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff:12345\"));\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"requestProcessors\")\n+    public void testLocalV2(RequestProcessor p) throws Exception\n+    {\n+        String proxy =\n+            // Preamble\n+            \"0D0A0D0A000D0A515549540A\" +\n+\n+                // V2, LOCAL\n+                \"20\" +\n+\n+                // 0x1 : AF_INET    0x1 : STREAM.\n+                \"11\" +\n+\n+                // Address length is 16.\n+                \"0010\" +\n+\n+                // gibberish\n+                \"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF\"\n+            ;\n+        String http = \"GET /path HTTP/1.1\\n\" +\n+            \"Host: server:80\\n\" +\n+            \"Connection: close\\n\" +\n+            \"\\n\";\n+\n+        String response = p.sendRequestWaitingForResponse(TypeUtil.fromHexString(proxy), http.getBytes(StandardCharsets.US_ASCII));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNDc0MA=="}, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY0ODIzOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyProtocolTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToyMlrOGQkTNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToyMlrOGQkTNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNTE0MQ==", "bodyText": "I'm not sure a LOCAL command should reply to HTTP requests.", "url": "https://github.com/eclipse/jetty.project/pull/4844#discussion_r420025141", "createdAt": "2020-05-05T10:59:22Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ProxyProtocolTest.java", "diffHunk": "@@ -193,4 +193,81 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n             }\n         }\n     }\n+\n+    @Test\n+    public void testProxyProtocolV2Local() throws Exception\n+    {\n+        start(new AbstractHandler()\n+        {\n+            @Override\n+            public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException\n+            {\n+                baseRequest.setHandled(true);\n+            }\n+        });\n+\n+        try (Socket socket = new Socket(\"localhost\", connector.getLocalPort()))\n+        {\n+            String proxy =\n+                // Preamble\n+                \"0D0A0D0A000D0A515549540A\" +\n+\n+                    // V2, LOCAL\n+                    \"20\" +\n+\n+                    // 0x1 : AF_INET    0x1 : STREAM.  Address length is 2*4 + 2*2 = 12 bytes.\n+                    \"11\" +\n+\n+                    // length of remaining header (4+4+2+2+6+3 = 21)\n+                    \"0015\" +\n+\n+                    // uint32_t src_addr; uint32_t dst_addr; uint16_t src_port; uint16_t dst_port;\n+                    \"C0A80001\" +\n+                    \"7f000001\" +\n+                    \"3039\" +\n+                    \"1F90\" +\n+\n+                    // NOOP value 0\n+                    \"040000\" +\n+\n+                    // NOOP value ABCDEF\n+                    \"040003ABCDEF\";\n+\n+            String request1 =\n+                \"GET /1 HTTP/1.1\\r\\n\" +\n+                    \"Host: localhost\\r\\n\" +\n+                    \"\\r\\n\";\n+            OutputStream output = socket.getOutputStream();\n+            output.write(TypeUtil.fromHexString(proxy));\n+            output.write(request1.getBytes(StandardCharsets.UTF_8));\n+            output.flush();\n+\n+            InputStream input = socket.getInputStream();\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8));\n+            String response1 = reader.readLine();\n+            assertTrue(response1.startsWith(\"HTTP/1.1 200 \"));\n+            while (true)\n+            {\n+                if (reader.readLine().isEmpty())\n+                    break;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f873904a7ad3cd0438e5e514e86042eef866dd"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2513, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}