{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MTk3NjU1", "number": 4534, "title": "Issue #4533 Hard close from Dispatcher", "bodyText": "#4533 Do hard close from Dispatcher so response wrappers may intercept close.\nSigned-off-by: Greg Wilkins gregw@webtide.com", "createdAt": "2020-01-30T17:27:06Z", "url": "https://github.com/eclipse/jetty.project/pull/4534", "merged": true, "mergeCommit": {"oid": "f88eb73a91acd4ed472e5f95e543b0feebee0ff1"}, "closed": true, "closedAt": "2020-01-31T10:55:15Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_d9H1AH2gAyMzY5MTk3NjU1OjcyYjZkNDcwNWJhODI0YjJlYjBjYmFkZTdjNzg5NTc1ZjlhM2ZjZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_rWOUgFqTM1MTM2NzQ0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72b6d4705ba824b2eb0cbade7c789575f9a3fcdb", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/72b6d4705ba824b2eb0cbade7c789575f9a3fcdb", "committedDate": "2020-01-30T17:26:10Z", "message": "Issue #4533 Hard close from Dispatcher\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>\n\n#4533 Do hard close from Dispatcher so response wrappers may intercept close."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDk1MzY2", "url": "https://github.com/eclipse/jetty.project/pull/4534#pullrequestreview-351095366", "createdAt": "2020-01-30T19:47:08Z", "commit": {"oid": "72b6d4705ba824b2eb0cbade7c789575f9a3fcdb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOTo0NzowOFrOFj3uWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOTo0ODowNVrOFj3wQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzQ2Ng==", "bodyText": "I have commented out this line buffer.close(), and the test still passes.\nI'm not sure at this point what are we really testing? I would have expected the test to fail if buffer.close() was commented out?\nIf the point of the test is to verify that the wrapped close() is invoked, can you make it explicit with a boolean or a CountDownLatch?", "url": "https://github.com/eclipse/jetty.project/pull/4534#discussion_r373157466", "createdAt": "2020-01-30T19:47:08Z", "author": {"login": "sbordet"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DispatcherTest.java", "diffHunk": "@@ -373,6 +377,98 @@ public void testForwardFilterToRogerServlet() throws Exception\n         assertThat(rechoResponse, containsString(\"txeTohce\"));\n     }\n \n+    @Test\n+    public void testForwardCloseIntercepted() throws Exception\n+    {\n+        _contextHandler.addFilter(WrappingFilter.class, \"/*\", EnumSet.of(DispatcherType.REQUEST));\n+        _contextHandler.addServlet(ForwardServlet.class, \"/ForwardServlet/*\");\n+        _contextHandler.addServlet(AssertForwardServlet.class, \"/AssertForwardServlet/*\");\n+\n+        String expected =\n+            \"HTTP/1.1 200 OK\\r\\n\" +\n+                \"Content-Type: text/html\\r\\n\" +\n+                \"Content-Length: 0\\r\\n\" +\n+                \"\\r\\n\";\n+\n+        String responses = _connector.getResponse(\"GET /context/ForwardServlet?do=assertforward&do=more&test=1 HTTP/1.0\\n\\n\");\n+\n+        assertEquals(expected, responses);\n+    }\n+\n+    public static class WrappingFilter implements Filter\n+    {\n+        @Override\n+        public void init(FilterConfig filterConfig) throws ServletException\n+        {\n+        }\n+\n+        @Override\n+        public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException\n+        {\n+            ResponseWrapper wrapper = new ResponseWrapper((HttpServletResponse)response);\n+            chain.doFilter(request, wrapper);\n+            wrapper.sendResponse(response.getOutputStream());\n+        }\n+\n+        @Override\n+        public void destroy()\n+        {\n+        }\n+    }\n+\n+    public static class ResponseWrapper extends HttpServletResponseWrapper\n+    {\n+        ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n+\n+        public ResponseWrapper(HttpServletResponse response)\n+        {\n+            super(response);\n+        }\n+\n+        @Override\n+        public ServletOutputStream getOutputStream() throws IOException\n+        {\n+            return new ServletOutputStream()\n+            {\n+                @Override\n+                public boolean isReady()\n+                {\n+                    return true;\n+                }\n+\n+                @Override\n+                public void setWriteListener(WriteListener writeListener)\n+                {\n+                    throw new UnsupportedOperationException();\n+                }\n+\n+                @Override\n+                public void write(int b) throws IOException\n+                {\n+                    buffer.write(b);\n+                }\n+\n+                @Override\n+                public void write(byte[] b, int off, int len) throws IOException\n+                {\n+                    buffer.write(b, off, len);\n+                }\n+\n+                @Override\n+                public void close() throws IOException\n+                {\n+                    buffer.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72b6d4705ba824b2eb0cbade7c789575f9a3fcdb"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1Nzk1NA==", "bodyText": "There remains only one other usage of softClose(). Is it really necessary, or softClose() can be removed?", "url": "https://github.com/eclipse/jetty.project/pull/4534#discussion_r373157954", "createdAt": "2020-01-30T19:48:05Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Dispatcher.java", "diffHunk": "@@ -219,8 +219,18 @@ protected void forward(ServletRequest request, ServletResponse response, Dispatc\n \n                 _contextHandler.handle(_pathInContext, baseRequest, (HttpServletRequest)request, (HttpServletResponse)response);\n \n-                if (!baseRequest.getHttpChannelState().isAsync())\n-                    baseRequest.getResponse().softClose();\n+                // If we are not async and not closed already, then close via the possibly wrapped response.\n+                if (!baseRequest.getHttpChannelState().isAsync() && !baseResponse.getHttpOutput().isClosed())\n+                {\n+                    try\n+                    {\n+                        response.getOutputStream().close();\n+                    }\n+                    catch (IllegalStateException e)\n+                    {\n+                        response.getWriter().close();\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72b6d4705ba824b2eb0cbade7c789575f9a3fcdb"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2428f7c7059dceb132456c00676c78cec269643f", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/2428f7c7059dceb132456c00676c78cec269643f", "committedDate": "2020-01-31T08:41:33Z", "message": "Issue #4533 Hard close from Dispatcher\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>\n\n#4533 improve test after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "befc9fd66dd14268843d190f86d959249bf8b61b", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/befc9fd66dd14268843d190f86d959249bf8b61b", "committedDate": "2020-01-31T08:55:31Z", "message": "Issue #4533 Hard close from Dispatcher\n\nSome renaming of methods to make it clear that softClose should only be used as part of sendError handling.  If softClose is used by other components, then sendError can be prevented from setting the error status.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzY3NDQy", "url": "https://github.com/eclipse/jetty.project/pull/4534#pullrequestreview-351367442", "createdAt": "2020-01-31T09:02:21Z", "commit": {"oid": "befc9fd66dd14268843d190f86d959249bf8b61b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 569, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}