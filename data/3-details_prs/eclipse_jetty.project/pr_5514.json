{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMDM2MjQ0", "number": 5514, "title": "Fixes #5498 ServletHolder cleanup", "bodyText": "Various cleanups for #5498 including:\n\nrenaming multiple _servlet fields in inner classes to avoid confusion\nbetter comments in prepare method to describe why it is needed\ncall prepare from Invoker servlet\nThe _servlet field is not set until after the servlet is initialized\nConsistent wrapping of SingleThreadedWrapper now in initServlet\nThe getServlet method now looks the volatile _servlet to avoid locking if possible\nThe handle method now calls getServletInstance as servlet will have been initialized in prepare", "createdAt": "2020-10-26T13:39:02Z", "url": "https://github.com/eclipse/jetty.project/pull/5514", "merged": true, "mergeCommit": {"oid": "7a0de6af3a41fd6025f55d27c1e12103625347cd"}, "closed": true, "closedAt": "2020-10-28T16:46:50Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWUhH5gH2gAyNTEwMDM2MjQ0OjIwNDczMTJmYTY1NTk4YjgyYzdkNWIzMmI1MDhlYmNmM2NjZTZmYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW_GhrgFqTUxODc3NjExNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2047312fa65598b82c7d5b32b508ebcf3cce6fb4", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/2047312fa65598b82c7d5b32b508ebcf3cce6fb4", "committedDate": "2020-10-26T13:37:51Z", "message": "Fixes #55498 ServletHolder cleanup\n\nVarious cleanups including:\n + renaming multiple `_servlet` fields in inner classes to avoid confusion\n + better comments in prepare method to describe why it is needed\n + call prepare from Invoker servlet\n + The `_servlet` field is not set until after the servlet is initialized\n + Consistent wrapping of `SingleThreadedWrapper` now in `initServlet`\n + The `getServlet` method now looks the volatile `_servlet` to avoid locking if possible\n + The `handle` method now calls `getServletInstance` as servlet will have been initialized in `prepare`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c26d212d7292e93f7ff30a9314f0fb644e9a14", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/b1c26d212d7292e93f7ff30a9314f0fb644e9a14", "committedDate": "2020-10-26T14:28:09Z", "message": "Fixes #5498 ServletHolder cleanup\n\nVarious cleanups including:\n + renaming multiple `_servlet` fields in inner classes to avoid confusion\n + better comments in prepare method to describe why it is needed\n + call prepare from Invoker servlet\n + The `_servlet` field is not set until after the servlet is initialized\n + Consistent wrapping of `SingleThreadedWrapper` now in `initServlet`\n + The `getServlet` method now looks the volatile `_servlet` to avoid locking if possible\n + The `handle` method now calls `getServletInstance` as servlet will have been initialized in `prepare`\n + Found and fixed race with making unavaiable servlet available again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5efa97ba62a44fad5992e2527c14f28811e3df17", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/5efa97ba62a44fad5992e2527c14f28811e3df17", "committedDate": "2020-10-26T15:44:43Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-5498-ServletHolder-cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58afa75aba52b1f80f066651276172725fceda40", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/58afa75aba52b1f80f066651276172725fceda40", "committedDate": "2020-10-27T07:35:14Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-5498-ServletHolder-cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NzA1NDQx", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-517705441", "createdAt": "2020-10-27T13:32:42Z", "commit": {"oid": "58afa75aba52b1f80f066651276172725fceda40"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMzozMjo0M1rOHo8V9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMzozMzowNVrOHo8XFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5Mzc1MQ==", "bodyText": "This doesn't take into account the potential numerical overflow of the timeout timestamp.", "url": "https://github.com/eclipse/jetty.project/pull/5514#discussion_r512693751", "createdAt": "2020-10-27T13:32:43Z", "author": {"login": "lorban"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java", "diffHunk": "@@ -1229,36 +1244,48 @@ public UnavailableServlet(UnavailableException unavailableException, Servlet ser\n             }\n             else\n             {\n-                _servlet = servlet;\n-                _available = System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds());\n+                _unavailableServlet = servlet;\n+                _available.set(System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58afa75aba52b1f80f066651276172725fceda40"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5MzkwOA==", "bodyText": "This doesn't take into account the potential numerical overflow of the timeout timestamp.", "url": "https://github.com/eclipse/jetty.project/pull/5514#discussion_r512693908", "createdAt": "2020-10-27T13:32:55Z", "author": {"login": "lorban"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java", "diffHunk": "@@ -1229,36 +1244,48 @@ public UnavailableServlet(UnavailableException unavailableException, Servlet ser\n             }\n             else\n             {\n-                _servlet = servlet;\n-                _available = System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds());\n+                _unavailableServlet = servlet;\n+                _available.set(System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds()));\n             }\n         }\n \n         @Override\n         public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException\n         {\n-            if (_available == -1)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_NOT_FOUND);\n-            else if (System.nanoTime() < _available)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n-            else\n+            while (true)\n             {\n-                synchronized (ServletHolder.this)\n+                long available = _available.get();\n+                if (available < 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58afa75aba52b1f80f066651276172725fceda40"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY5NDAzNg==", "bodyText": "This doesn't take into account the potential numerical overflow of the timeout timestamp.", "url": "https://github.com/eclipse/jetty.project/pull/5514#discussion_r512694036", "createdAt": "2020-10-27T13:33:05Z", "author": {"login": "lorban"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java", "diffHunk": "@@ -1229,36 +1244,48 @@ public UnavailableServlet(UnavailableException unavailableException, Servlet ser\n             }\n             else\n             {\n-                _servlet = servlet;\n-                _available = System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds());\n+                _unavailableServlet = servlet;\n+                _available.set(System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds()));\n             }\n         }\n \n         @Override\n         public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException\n         {\n-            if (_available == -1)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_NOT_FOUND);\n-            else if (System.nanoTime() < _available)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n-            else\n+            while (true)\n             {\n-                synchronized (ServletHolder.this)\n+                long available = _available.get();\n+                if (available < 0)\n+                {\n+                    ((HttpServletResponse)res).sendError(HttpServletResponse.SC_NOT_FOUND);\n+                    return;\n+                }\n+\n+                if (available == 0 || System.nanoTime() < available)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58afa75aba52b1f80f066651276172725fceda40"}, "originalPosition": 186}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc3ebce5ac257007e1b9d1b1bc6042bb5417144", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/8bc3ebce5ac257007e1b9d1b1bc6042bb5417144", "committedDate": "2020-10-27T14:33:56Z", "message": "Updates from review:\n\n + fixed nanotime overflow\n + fixed several compiler warnings/suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Nzc4ODc4", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-517778878", "createdAt": "2020-10-27T14:38:39Z", "commit": {"oid": "8bc3ebce5ac257007e1b9d1b1bc6042bb5417144"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTM2OTUx", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-517936951", "createdAt": "2020-10-27T17:01:33Z", "commit": {"oid": "8bc3ebce5ac257007e1b9d1b1bc6042bb5417144"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzowMTozM1rOHpG8cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzowMTozM1rOHpG8cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg2NzQ0Mw==", "bodyText": "Can we come up with a solution that removes the while(true) - I think these are best avoided if possible.", "url": "https://github.com/eclipse/jetty.project/pull/5514#discussion_r512867443", "createdAt": "2020-10-27T17:01:33Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java", "diffHunk": "@@ -1229,36 +1237,52 @@ public UnavailableServlet(UnavailableException unavailableException, Servlet ser\n             }\n             else\n             {\n-                _servlet = servlet;\n-                _available = System.nanoTime() + TimeUnit.SECONDS.toNanos(unavailableException.getUnavailableSeconds());\n+                _unavailableServlet = servlet;\n+                long start = System.nanoTime();\n+                while (start == 0)\n+                    start = System.nanoTime();\n+                _unavailableStart = new AtomicLong(start);\n             }\n         }\n \n         @Override\n         public void service(ServletRequest req, ServletResponse res) throws ServletException, IOException\n         {\n-            if (_available == -1)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_NOT_FOUND);\n-            else if (System.nanoTime() < _available)\n-                ((HttpServletResponse)res).sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE);\n-            else\n+            while (true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bc3ebce5ac257007e1b9d1b1bc6042bb5417144"}, "originalPosition": 211}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "546fc57b78c3070453333b4f41aa3a50aae59768", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/546fc57b78c3070453333b4f41aa3a50aae59768", "committedDate": "2020-10-27T17:03:40Z", "message": "Updates from review:\n\n + removed while true from unavailable servlet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTQyNjIx", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-517942621", "createdAt": "2020-10-27T17:07:42Z", "commit": {"oid": "546fc57b78c3070453333b4f41aa3a50aae59768"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTQ1ODEw", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-517945810", "createdAt": "2020-10-27T17:11:09Z", "commit": {"oid": "546fc57b78c3070453333b4f41aa3a50aae59768"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzoxMToxMFrOHpHWrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzoxMToxMFrOHpHWrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NDE1Nw==", "bodyText": "Actually, this isn't right:  we should not call destroyInstance() because this will call servlet.destroy(), but at this stage we will not have called servlet.init().", "url": "https://github.com/eclipse/jetty.project/pull/5514#discussion_r512874157", "createdAt": "2020-10-27T17:11:10Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHolder.java", "diffHunk": "@@ -557,33 +555,35 @@ private void makeUnavailable(final Throwable e)\n     private synchronized void initServlet()\n         throws ServletException\n     {\n+        Servlet servlet = _servlet;\n         try\n         {\n-            if (_servlet == null)\n-                _servlet = getInstance();\n-            if (_servlet == null)\n-                _servlet = newInstance();\n+            if (servlet == null || servlet instanceof UnavailableServlet)\n+                servlet = getInstance();\n+            if (servlet == null)\n+                servlet = newInstance();\n+            if (servlet instanceof javax.servlet.SingleThreadModel)\n+            {\n+                destroyInstance(servlet);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "546fc57b78c3070453333b4f41aa3a50aae59768"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1649d42afb4465bf3f297893642022f5e2ceb0c", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/c1649d42afb4465bf3f297893642022f5e2ceb0c", "committedDate": "2020-10-28T08:46:41Z", "message": "Updates from review:\n\n + Do not destroy servlets unless init has been called.\n + Added TODOs about calling predestroy on instances not created by the holder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea6126aba9bf21de5bf3b42d4ef0dde032e7d16c", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/ea6126aba9bf21de5bf3b42d4ef0dde032e7d16c", "committedDate": "2020-10-28T09:05:02Z", "message": "Updates from review:\n\n + Do not destroy servlets unless init has been called.\n + Added TODOs about calling predestroy on instances not created by the holder.\n + improved dump and toString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4Nzc2MTE2", "url": "https://github.com/eclipse/jetty.project/pull/5514#pullrequestreview-518776116", "createdAt": "2020-10-28T15:14:43Z", "commit": {"oid": "ea6126aba9bf21de5bf3b42d4ef0dde032e7d16c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4984, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}