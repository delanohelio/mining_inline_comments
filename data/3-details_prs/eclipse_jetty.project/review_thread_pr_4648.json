{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1Mzc5NTM3", "number": 4648, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowNjo0NVrODmT01g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozNDoxMVrODnX3qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDk3MzAyOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowNjo0NVrOFzp1yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowNjo0NVrOFzp1yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzIwOQ==", "bodyText": "Perhaps add a new method called parsePort(String rawPort) that does the Integer.parseInt() and also validates the range of values to be sane (port >= 1 && port <= 65535).", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r389707209", "createdAt": "2020-03-09T14:06:45Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -639,19 +639,23 @@ else if (_for == null)\n         @SuppressWarnings(\"unused\")\n         public void handlePort(HttpField field)\n         {\n+            String port = getLeftMost(field.getValue());\n+            if (StringUtil.isEmpty(port))\n+                throw new IllegalArgumentException(field.getName() + \" has empty value\");\n+\n             if (!getForwardedPortAsAuthority())\n             {\n                 if (_for == null)\n-                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(getLeftMost(field.getValue())));\n+                    _for = new PortSetHostPort(_request.getRemoteHost(), Integer.parseInt(port));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797d25505b92268f74845ab880f40461ccd17019"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjU1OTYxOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMToxNzoxNlrOF0yu7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMTo0MzowMVrOF0zgMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTQ4NA==", "bodyText": "add the Throwable t as the cause of this exception", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901484", "createdAt": "2020-03-11T11:17:16Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);\n+        throw new BadMessageException(\"Bad header value for \" + field.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkxNDA5Ng==", "bodyText": "Ok sure, was just being careful of giving away too much information in the response like simone said.", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390914096", "createdAt": "2020-03-11T11:43:01Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);\n+        throw new BadMessageException(\"Bad header value for \" + field.getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTQ4NA=="}, "originalCommit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMjU2MTA0OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMToxNzo0N1rOF0yv0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMToxNzo0N1rOF0yv0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMTcxMw==", "bodyText": "Don't warn and throw.   Do one or the other.   I think this should just be a debug here.", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r390901713", "createdAt": "2020-03-11T11:17:47Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -420,6 +432,12 @@ else if (forwarded._server != null)\n         }\n     }\n \n+    protected void onError(HttpField field, Throwable t)\n+    {\n+        LOG.warn(\"Exception while processing {}\", field, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ee7b058b04b544af1fb17c1f6ffa1032452693"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjEyMTM4OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODozNDoxMVrOF1VN4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzowMTowM1rOF12O9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjQ2Ng==", "bodyText": "Sorry but... thinking about this more, can we avoid the double try blocks.  onError has no declared exceptions, so whatever it throws can be thrown from this method.  If it doesn't throw then we continue.  Why the need to wrap with a RuntimeException?", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r391466466", "createdAt": "2020-03-12T08:34:11Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -380,9 +381,16 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             for (HttpField field : httpFields)\n             {\n-                MethodHandle handle = _handles.get(field.getName());\n-                if (handle != null)\n-                    handle.invoke(forwarded, field);\n+                try\n+                {\n+                    MethodHandle handle = _handles.get(field.getName());\n+                    if (handle != null)\n+                        handle.invoke(forwarded, field);\n+                }\n+                catch (Throwable t)\n+                {\n+                    onError(field, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwNzQxMg==", "bodyText": "oops.. you're right, fixed.", "url": "https://github.com/eclipse/jetty.project/pull/4648#discussion_r392007412", "createdAt": "2020-03-13T03:01:03Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -380,9 +381,16 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             for (HttpField field : httpFields)\n             {\n-                MethodHandle handle = _handles.get(field.getName());\n-                if (handle != null)\n-                    handle.invoke(forwarded, field);\n+                try\n+                {\n+                    MethodHandle handle = _handles.get(field.getName());\n+                    if (handle != null)\n+                        handle.invoke(forwarded, field);\n+                }\n+                catch (Throwable t)\n+                {\n+                    onError(field, t);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2NjQ2Ng=="}, "originalCommit": {"oid": "633298b5c7dfee8377c59b3f872f81082049cbf3"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2660, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}