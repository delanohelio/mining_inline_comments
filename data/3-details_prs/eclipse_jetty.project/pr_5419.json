{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNjQ2OTc2", "number": 5419, "title": "Better support for implied ports on ForwardedRequestCustomizer", "bodyText": "#5417\nImplied ports were taken from the active connector's HttpConfiguration, this was a bad idea.\nSigned-off-by: Joakim Erdfelt joakim.erdfelt@gmail.com", "createdAt": "2020-10-09T14:55:51Z", "url": "https://github.com/eclipse/jetty.project/pull/5419", "merged": true, "mergeCommit": {"oid": "c37c2c59ab8762763f2fc69e92907e137f6c3650"}, "closed": true, "closedAt": "2020-10-13T09:50:52Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ3bmegH2gAyNTAwNjQ2OTc2OjE0OWYzODlmZDhhMmU1ZjgyNTExY2ViNDkyMjIwZWRiZjk2ODM5ZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSFbukgFqTUwNzI1OTE3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/149f389fd8a2e5f82511ceb492220edbf96839d8", "committedDate": "2020-10-09T14:54:57Z", "message": "Issue #5417 - Honoring implied ports on ForwardedRequestCustomizer better\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDU3NDM5", "url": "https://github.com/eclipse/jetty.project/pull/5419#pullrequestreview-506457439", "createdAt": "2020-10-12T09:38:06Z", "commit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwOTozODowNlrOHf29uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwOTozOToxNlrOHf3AuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2ODQ0MA==", "bodyText": "remove this comment", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503168440", "createdAt": "2020-10-12T09:38:06Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de/test/forwarded.jsp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2ODU1OQ==", "bodyText": "remove this comment", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503168559", "createdAt": "2020-10-12T09:38:18Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de/test/forwarded.jsp\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"web.euro.de\").serverPort(443)\n+                    .requestURL(\"https://web.euro.de/test/forwarded.jsp\")\n+                    .remoteAddr(\"192.168.2.6\").remotePort(0)\n+            ),\n+            // RFC7239 Tests with https and proxy provided port\n+            Arguments.of(new Request(\"RFC7239 with proxy provided port on https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de:9443\",\n+                        \"Forwarded: for=192.168.2.6;host=web.euro.de:9443;proto=https;proto-version=h2\"\n+                        // Client: https://web.euro.de:9443/test/forwarded.jsp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2OTAwNg==", "bodyText": "Use another domain name like web.example.org", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503169006", "createdAt": "2020-10-12T09:38:55Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -783,6 +794,71 @@ public void testConfiguredBehavior(Request request, Expectations expectations) t\n         expectations.accept(actual);\n     }\n \n+    public static Stream<Arguments> nonStandardPortCases()\n+    {\n+        return Stream.of(\n+            // RFC7239 Tests with https.\n+            Arguments.of(new Request(\"RFC7239 with https and h2\")\n+                    .headers(\n+                        \"GET /test/forwarded.jsp HTTP/1.1\",\n+                        \"Host: web.euro.de\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2OTIwOA==", "bodyText": "I wonder why we are setting the input buffer  size in this test?", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503169208", "createdAt": "2020-10-12T09:39:16Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -82,6 +84,15 @@ public void init() throws Exception\n         connector = new LocalConnector(server, http);\n         server.addConnector(connector);\n \n+        // Alternate behavior Connector\n+        HttpConnectionFactory httpAlt = new HttpConnectionFactory();\n+        httpAlt.setInputBufferSize(1024);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDYwMTM3", "url": "https://github.com/eclipse/jetty.project/pull/5419#pullrequestreview-506460137", "createdAt": "2020-10-12T09:41:24Z", "commit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwOTo0MToyNVrOHf3GBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwOTo0MToyNVrOHf3GBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3MDU2Nw==", "bodyText": "can you make this comment not look like commented out code.  It is good info to have, but I found the format confusing", "url": "https://github.com/eclipse/jetty.project/pull/5419#discussion_r503170567", "createdAt": "2020-10-12T09:41:25Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -512,12 +512,7 @@ public void customize(Connector connector, HttpConfiguration config, Request req\n         {\n             port = requestURI.getPort();\n         }\n-        if (port == MutableHostPort.IMPLIED) // is implied\n-        {\n-            // get Implied port (from protocol / scheme) and HttpConfiguration\n-            int defaultPort = 80;\n-            port = proto.equalsIgnoreCase(config.getSecureScheme()) ? getSecurePort(config) : defaultPort;\n-        }\n+        // if (port == MutableHostPort.IMPLIED) // is implied, no port change needed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149f389fd8a2e5f82511ceb492220edbf96839d8"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/c2266fdd63dea082dc83fc2ab031867d1d83ecc9", "committedDate": "2020-10-12T09:50:51Z", "message": "Issue #5417 - Cleanup of PR from Review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjU5MTc5", "url": "https://github.com/eclipse/jetty.project/pull/5419#pullrequestreview-507259179", "createdAt": "2020-10-13T09:47:41Z", "commit": {"oid": "c2266fdd63dea082dc83fc2ab031867d1d83ecc9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 33, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}