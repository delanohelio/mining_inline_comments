{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjY4MDQw", "number": 4544, "title": "Issue #4541 Large response header", "bodyText": "Fix #4541 by initially allocated a header buffer of min(_config.getResponseHeaderSize(), _config.getOutputBufferSize())\nOnly allocate a buffer of getResponseHeaderSize if an overflow results.\nThis should have no effect on the majority of responses where getOutputBufferSize is greater than getResponseHeaderSize other than the cost of a min operation.\nSigned-off-by: Greg Wilkins gregw@webtide.com\nCloses #4541", "createdAt": "2020-02-05T09:31:06Z", "url": "https://github.com/eclipse/jetty.project/pull/4544", "merged": true, "mergeCommit": {"oid": "2958cb1d62ae95911270f265dc7e5b461f6897f4"}, "closed": true, "closedAt": "2020-02-20T10:17:39Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBSvC4gH2gAyMzcxMjY4MDQwOjFiNTllNDIyOTQwZWRmZDE5NGEyNzNmZDBjMzc0MGI4NGM3ODY2MGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGHrBIgH2gAyMzcxMjY4MDQwOmE4NTU3NDRhZWI3ZDg3NmY0MWFhYjQwMjhiOGIyMjk5ZjhiMTQ1N2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1b59e422940edfd194a273fd0c3740b84c78660b", "committedDate": "2020-02-05T09:29:41Z", "message": "Issue #4541 Large response header\n\nFix #4541 by initially allocated a header buffer of `min(_config.getResponseHeaderSize(), _config.getOutputBufferSize())`\nOnly allocate a buffer of `getResponseHeaderSize` if an overflow results.\n\nThis should have no effect on the majority of responses where `getOutputBufferSize` is greater than `getResponseHeaderSize` other than the cost of a min operation.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Mjc3ODcz", "url": "https://github.com/eclipse/jetty.project/pull/4544#pullrequestreview-354277873", "createdAt": "2020-02-06T08:45:56Z", "commit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjQ3MDg5", "url": "https://github.com/eclipse/jetty.project/pull/4544#pullrequestreview-354647089", "createdAt": "2020-02-06T17:45:23Z", "commit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzo0NToyM1rOFmkURw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzo0OTo1NFrOFmkdZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NTIyMw==", "bodyText": "Shouldn't we be acquiring based on _header.capacity() or _config.getOutputBufferSize() instead here?\nThe issue that was filed is that we allocate a buffer based on _config.getResponseHeaderSize(), even if it's set to something massive (like 100MB)\nEven though the actual buffer that is required/used is much smaller.", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r375985223", "createdAt": "2020-02-06T17:45:23Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HttpConnection.java", "diffHunk": "@@ -754,8 +757,19 @@ public Action process() throws Exception\n \n                     case NEED_HEADER:\n                     {\n-                        _header = _bufferPool.acquire(_config.getResponseHeaderSize(), HEADER_BUFFER_DIRECT);\n-\n+                        int size;\n+                        if (_header == null)\n+                        {\n+                            size = Math.min(_config.getResponseHeaderSize(), _config.getOutputBufferSize());\n+                        }\n+                        else\n+                        {\n+                            if (_header.capacity() >= _config.getResponseHeaderSize())\n+                                throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Response header too large\");\n+                            size = _config.getResponseHeaderSize();\n+                            _bufferPool.release(_header);\n+                        }\n+                        _header = _bufferPool.acquire(size, HEADER_BUFFER_DIRECT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NzU1Ng==", "bodyText": "Do we have a test where we fail when we attempt to write a header that is too large?\nEg:\nconfig.setResponseHeaderSize(16 * 1024);\n... later ...\nresponse.setHeader(\"X-Foo\", a32kbString);", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r375987556", "createdAt": "2020-02-06T17:49:54Z", "author": {"login": "joakime"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/HttpConnectionTest.java", "diffHunk": "@@ -1258,6 +1259,48 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n         }\n     }\n \n+    @Test\n+    public void testAllowedLargeResponse() throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Njc0MjEy", "url": "https://github.com/eclipse/jetty.project/pull/4544#pullrequestreview-354674212", "createdAt": "2020-02-06T18:28:35Z", "commit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODoyODozNVrOFmlnrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxODozMDo0NlrOFmlr6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNjU3Mg==", "bodyText": "I don't like this. A user of HttpGenerator will call generate(), receive back NEED_HEADER, allocate a small buffer, call generate() again, buffer overflow, receive back NEED_HEADER which break the minimum surprise (I just gave it a header buffer!), and potentially be a spin loop.\nI think we need to make this return value explicit, something like NEED_LARGER_BUFFER, so users of HttpGenerator can understand better what's going on and try again (which may lead again to NEED_LARGER_BUFFER, but eventually it will be enough).", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r376006572", "createdAt": "2020-02-06T18:28:35Z", "author": {"login": "sbordet"}, "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpGenerator.java", "diffHunk": "@@ -445,7 +445,8 @@ else if (status == HttpStatus.NO_CONTENT_204 || status == HttpStatus.NOT_MODIFIE\n                 }\n                 catch (BufferOverflowException e)\n                 {\n-                    throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Response header too large\", e);\n+                    LOG.ignore(e);\n+                    return Result.NEED_HEADER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwNzY1OA==", "bodyText": "See my comment above. If we introduce NEED_LARGER_BUFFER, this if/else can be split in 2 case blocks and be clearer.", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r376007658", "createdAt": "2020-02-06T18:30:46Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HttpConnection.java", "diffHunk": "@@ -754,8 +757,19 @@ public Action process() throws Exception\n \n                     case NEED_HEADER:\n                     {\n-                        _header = _bufferPool.acquire(_config.getResponseHeaderSize(), HEADER_BUFFER_DIRECT);\n-\n+                        int size;\n+                        if (_header == null)\n+                        {\n+                            size = Math.min(_config.getResponseHeaderSize(), _config.getOutputBufferSize());\n+                        }\n+                        else\n+                        {\n+                            if (_header.capacity() >= _config.getResponseHeaderSize())\n+                                throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Response header too large\");\n+                            size = _config.getResponseHeaderSize();\n+                            _bufferPool.release(_header);\n+                        }\n+                        _header = _bufferPool.acquire(size, HEADER_BUFFER_DIRECT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NTIyMw=="}, "originalCommit": {"oid": "1b59e422940edfd194a273fd0c3740b84c78660b"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50c2654b91fda2a0dc5f19ab7b0d5f820738c67", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/f50c2654b91fda2a0dc5f19ab7b0d5f820738c67", "committedDate": "2020-02-06T20:17:58Z", "message": "Fixes #4541 Large Headers\n\nAdded a HEADER_OVERFLOW result as per review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDM0Njcy", "url": "https://github.com/eclipse/jetty.project/pull/4544#pullrequestreview-355034672", "createdAt": "2020-02-07T09:41:00Z", "commit": {"oid": "f50c2654b91fda2a0dc5f19ab7b0d5f820738c67"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo0MTowMVrOFm3Y-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo0MzozOFrOFm3drw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NzcyMg==", "bodyText": "On the client INTERNAL_SERVER_ERROR_500 won't make much sense, so perhaps replace with IllegalArgumentException?\nAlso, headerBuffer should be released to the pool.", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r376297722", "createdAt": "2020-02-07T09:41:01Z", "author": {"login": "sbordet"}, "path": "jetty-client/src/main/java/org/eclipse/jetty/client/http/HttpSenderOverHTTP.java", "diffHunk": "@@ -225,6 +228,10 @@ protected Action process() throws Exception\n                         headerBuffer = httpClient.getByteBufferPool().acquire(httpClient.getRequestBufferSize(), false);\n                         break;\n                     }\n+                    case HEADER_OVERFLOW:\n+                    {\n+                        throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Request header too large\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f50c2654b91fda2a0dc5f19ab7b0d5f820738c67"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5ODkyNw==", "bodyText": "Before throwing, you want to release the _header buffer back to the pool.", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r376298927", "createdAt": "2020-02-07T09:43:38Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HttpConnection.java", "diffHunk": "@@ -754,8 +757,16 @@ public Action process() throws Exception\n \n                     case NEED_HEADER:\n                     {\n-                        _header = _bufferPool.acquire(_config.getResponseHeaderSize(), HEADER_BUFFER_DIRECT);\n+                        _header = _bufferPool.acquire(Math.min(_config.getResponseHeaderSize(), _config.getOutputBufferSize()), HEADER_BUFFER_DIRECT);\n+                        continue;\n+                    }\n \n+                    case HEADER_OVERFLOW:\n+                    {\n+                        if (_header.capacity() >= _config.getResponseHeaderSize())\n+                            throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Response header too large\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f50c2654b91fda2a0dc5f19ab7b0d5f820738c67"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b46b25b450647311e5d4ad6f30c463ca05f84616", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/b46b25b450647311e5d4ad6f30c463ca05f84616", "committedDate": "2020-02-19T21:38:58Z", "message": "release buffer on overflow\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzMwMTY1", "url": "https://github.com/eclipse/jetty.project/pull/4544#pullrequestreview-361730165", "createdAt": "2020-02-20T09:03:34Z", "commit": {"oid": "b46b25b450647311e5d4ad6f30c463ca05f84616"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTowMzozNFrOFsLJsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTowMzozNFrOFsLJsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg2NDM3MA==", "bodyText": "@gregw the header buffer should be released to the pool.\nI'm ok to not change this in 9, but remember to make the change when merging to 10.", "url": "https://github.com/eclipse/jetty.project/pull/4544#discussion_r381864370", "createdAt": "2020-02-20T09:03:34Z", "author": {"login": "sbordet"}, "path": "jetty-client/src/main/java/org/eclipse/jetty/client/http/HttpSenderOverHTTP.java", "diffHunk": "@@ -225,6 +228,10 @@ protected Action process() throws Exception\n                         headerBuffer = httpClient.getByteBufferPool().acquire(httpClient.getRequestBufferSize(), false);\n                         break;\n                     }\n+                    case HEADER_OVERFLOW:\n+                    {\n+                        throw new BadMessageException(INTERNAL_SERVER_ERROR_500, \"Request header too large\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5NzcyMg=="}, "originalCommit": {"oid": "f50c2654b91fda2a0dc5f19ab7b0d5f820738c67"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a855744aeb7d876f41aab4028b8b2299f8b1457f", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/a855744aeb7d876f41aab4028b8b2299f8b1457f", "committedDate": "2020-02-20T09:25:57Z", "message": "release buffer in client as well\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 575, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}