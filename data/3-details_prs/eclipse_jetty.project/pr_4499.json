{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0ODAxNDkx", "number": 4499, "title": "Issue #4495 ReservedThreadExecutor optimise", "bodyText": "Use synchronousQueue for task handoff for #4495\nSigned-off-by: Greg Wilkins gregw@webtide.com", "createdAt": "2020-01-20T12:08:36Z", "url": "https://github.com/eclipse/jetty.project/pull/4499", "merged": true, "mergeCommit": {"oid": "4dbf8a3a9ea51b5ec9744e3d8078bdfc4972e6c9"}, "closed": true, "closedAt": "2020-01-31T18:54:44Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8LZPxgH2gAyMzY0ODAxNDkxOjFlZTY0Y2I1Y2ViMGVkYTAxMzIwYTkwYWY4NGM3MjFiNTE5NGRlOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_zjoTAFqTM1MTY5NjUwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ee64cb5ceb0eda01320a90af84c721b5194de9d", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1ee64cb5ceb0eda01320a90af84c721b5194de9d", "committedDate": "2020-01-20T12:06:55Z", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nUse synchronousQueue for task handoff\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02cd928bfcb7de3bc4dd91897bbcb8aad249d1da", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/02cd928bfcb7de3bc4dd91897bbcb8aad249d1da", "committedDate": "2020-01-20T15:10:04Z", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nupdates from review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd187980004dff9283d7d5b44a57ccb098423b3", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/0dd187980004dff9283d7d5b44a57ccb098423b3", "committedDate": "2020-01-20T15:49:26Z", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nUse a linked queue rather than a deque(as a stack).  This should be simpler, better optimised and less contended.  Idling has been simplified so that a reserve thread is always dropped every idle period.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88b46703118d5ddb69e644af6b83252b73ddd9ef", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/88b46703118d5ddb69e644af6b83252b73ddd9ef", "committedDate": "2020-01-20T16:54:13Z", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nreverted RTE and added a JMH benchmark\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c620bd3431e27e5616a370fc70fb984e00acba", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/d4c620bd3431e27e5616a370fc70fb984e00acba", "committedDate": "2020-01-21T08:27:41Z", "message": "More variants and longer tests\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbda80763e7b9c07dfa5726216c023f1bcd5d4b3", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/bbda80763e7b9c07dfa5726216c023f1bcd5d4b3", "committedDate": "2020-01-21T09:33:06Z", "message": "Added LQ\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d486fb0dd5a5109dbdcc75c75a81b221a795d70d", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/d486fb0dd5a5109dbdcc75c75a81b221a795d70d", "committedDate": "2020-01-21T10:29:34Z", "message": "removed SQ2\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "403cc41f6fd5e1a0874b2d41bc332aaeac43e186", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/403cc41f6fd5e1a0874b2d41bc332aaeac43e186", "committedDate": "2020-01-21T12:41:42Z", "message": "Issue #4495 ReservedThreadExecutor optimise\n\nReplaced real implementation with SQ\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3OTM3Nzc0", "url": "https://github.com/eclipse/jetty.project/pull/4499#pullrequestreview-347937774", "createdAt": "2020-01-24T13:01:29Z", "commit": {"oid": "403cc41f6fd5e1a0874b2d41bc332aaeac43e186"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51807f715136e270bff7af066fcee7d5ebdf2589", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/51807f715136e270bff7af066fcee7d5ebdf2589", "committedDate": "2020-01-31T10:56:22Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4495-ReservedThreadExecutor-Optimise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/458cb8c7edf91e01cd7de436374b737b2485d51f", "committedDate": "2020-01-31T11:03:22Z", "message": "Issue #4495 RTE optimise\n\nRemoved alternate implementations\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDc1Mjk3", "url": "https://github.com/eclipse/jetty.project/pull/4499#pullrequestreview-351475297", "createdAt": "2020-01-31T12:32:41Z", "commit": {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjozMjo0MVrOFkKCZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjozNDoxOVrOFkKErw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1NzUxMA==", "bodyText": "Better catch Throwable here.", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373457510", "createdAt": "2020-01-31T12:32:41Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -264,20 +265,25 @@ public String toString()\n \n     private class ReservedThread implements Runnable\n     {\n-        private final Locker _locker = new Locker();\n-        private final Condition _wakeup = _locker.newCondition();\n+        private final SynchronousQueue<Runnable> _task = new SynchronousQueue<>();\n         private boolean _starting = true;\n-        private Runnable _task = null;\n \n-        public void offer(Runnable task)\n+        public boolean offer(Runnable task)\n         {\n             if (LOG.isDebugEnabled())\n                 LOG.debug(\"{} offer {}\", this, task);\n \n-            try (Locker.Lock lock = _locker.lock())\n+            try\n+            {\n+                _task.put(task);\n+                return true;\n+            }\n+            catch (InterruptedException e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1NzY0NA==", "bodyText": "Should be _idleTime <= 0.", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373457644", "createdAt": "2020-01-31T12:33:03Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -296,37 +302,12 @@ private Runnable reservedWait()\n                 if (!isRunning())\n                     return STOP;\n \n-                boolean idle = false;\n-                try (Locker.Lock lock = _locker.lock())\n+                try\n                 {\n-                    if (_task == null)\n-                    {\n-                        try\n-                        {\n-                            if (_idleTime == 0)\n-                                _wakeup.await();\n-                            else\n-                                idle = !_wakeup.await(_idleTime, _idleTimeUnit);\n-                        }\n-                        catch (InterruptedException e)\n-                        {\n-                            LOG.ignore(e);\n-                        }\n-                    }\n-                    else\n-                    {\n-                        Runnable task = _task;\n-                        _task = null;\n-\n-                        if (LOG.isDebugEnabled())\n-                            LOG.debug(\"{} task={}\", this, task);\n-\n+                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ1ODA5NQ==", "bodyText": "There was a LOG.debug() statement when we had a non-null task that I would like to keep.", "url": "https://github.com/eclipse/jetty.project/pull/4499#discussion_r373458095", "createdAt": "2020-01-31T12:34:19Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/thread/ReservedThreadExecutor.java", "diffHunk": "@@ -296,37 +302,12 @@ private Runnable reservedWait()\n                 if (!isRunning())\n                     return STOP;\n \n-                boolean idle = false;\n-                try (Locker.Lock lock = _locker.lock())\n+                try\n                 {\n-                    if (_task == null)\n-                    {\n-                        try\n-                        {\n-                            if (_idleTime == 0)\n-                                _wakeup.await();\n-                            else\n-                                idle = !_wakeup.await(_idleTime, _idleTimeUnit);\n-                        }\n-                        catch (InterruptedException e)\n-                        {\n-                            LOG.ignore(e);\n-                        }\n-                    }\n-                    else\n-                    {\n-                        Runnable task = _task;\n-                        _task = null;\n-\n-                        if (LOG.isDebugEnabled())\n-                            LOG.debug(\"{} task={}\", this, task);\n-\n+                    Runnable task = _idleTime == 0 ? _task.take() : _task.poll(_idleTime, _idleTimeUnit);\n+                    if (task != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "458cb8c7edf91e01cd7de436374b737b2485d51f"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4708509e3636df5d42b3157afab552ff7c29ffce", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/4708509e3636df5d42b3157afab552ff7c29ffce", "committedDate": "2020-01-31T12:55:59Z", "message": "Issue #4495 RTE optimise\n\nupdates from review\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNjk2NTAz", "url": "https://github.com/eclipse/jetty.project/pull/4499#pullrequestreview-351696503", "createdAt": "2020-01-31T18:36:14Z", "commit": {"oid": "4708509e3636df5d42b3157afab552ff7c29ffce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 553, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}