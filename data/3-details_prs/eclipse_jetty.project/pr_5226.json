{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3OTAyOTkx", "number": 5226, "title": "Issue #5224 X-Forwarded-Host support for port", "bodyText": "", "createdAt": "2020-09-02T15:31:18Z", "url": "https://github.com/eclipse/jetty.project/pull/5226", "merged": true, "mergeCommit": {"oid": "165e59b3e23c145a459fc77551a1d9919d1b0e8e"}, "closed": true, "closedAt": "2020-09-09T16:37:34Z", "author": {"login": "joakime"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE89XkAH2gAyNDc3OTAyOTkxOmU0Y2ExNTMzNjQ2MGE4NGMxZTFiMzNjYWViNDdlNTQxZThiZDcxMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHO4EUgFqTQ4NTIwMDEwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4ca15336460a84c1e1b33caeb47e541e8bd710c", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/e4ca15336460a84c1e1b33caeb47e541e8bd710c", "committedDate": "2020-09-02T14:34:16Z", "message": "Issue #5224 - Test to replicate reported issue\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/e2134b13d794f341dfd4f8e629a0dfeef4eab6cf", "committedDate": "2020-09-02T15:27:33Z", "message": "Issue #5224 - X-Forwarded-Host support for port\n\n+ More test cases\n+ Allowing X-Forwarded-Host to parse port (if present properly)\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTg3MTg3", "url": "https://github.com/eclipse/jetty.project/pull/5226#pullrequestreview-480987187", "createdAt": "2020-09-02T16:18:35Z", "commit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTUwMTg0", "url": "https://github.com/eclipse/jetty.project/pull/5226#pullrequestreview-483550184", "createdAt": "2020-09-07T13:20:07Z", "commit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMzoyMDowN1rOHN_IvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMzoyNToyN1rOHN_TJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyNzk2NA==", "bodyText": "I don't agree with this test.  We should be order independent for such headers.  If we decide that X-Forwarded-Port takes precedent over any port specified in X-Forwarded-Host then it should do so regardless of the order of those headers!", "url": "https://github.com/eclipse/jetty.project/pull/5226#discussion_r484427964", "createdAt": "2020-09-07T13:20:07Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -497,7 +497,67 @@ public void destroy() throws Exception\n                     .requestURL(\"http://fw.example.com:4333/\")\n                     .remoteAddr(\"8.5.4.3\").remotePort(2222)\n             ),\n-\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports)\")\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\",\n+                        \"X-Forwarded-Server: sub2.example.com\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10002)\n+                    .requestURL(\"https://sub1.example.com:10002/\")\n+                    .remoteAddr(\"127.0.0.1\").remotePort(8888)\n+            ),\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports - Server First)\")\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"X-Forwarded-Server: sub2.example.com:10007\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10002)\n+                    .requestURL(\"https://sub1.example.com:10002/\")\n+                    .remoteAddr(\"127.0.0.1\").remotePort(8888)\n+            ),\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports - setForwardedPortAsAuthority = false)\")\n+                    .configureCustomizer((customizer) -> customizer.setForwardedPortAsAuthority(false))\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\",\n+                        \"X-Forwarded-Server: sub2.example.com\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10003)\n+                    .requestURL(\"https://sub1.example.com:10003/\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQyODU2NQ==", "bodyText": "s/hp/hostField/", "url": "https://github.com/eclipse/jetty.project/pull/5226#discussion_r484428565", "createdAt": "2020-09-07T13:21:26Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -598,16 +598,18 @@ public void handleSslSessionId(HttpField field)\n         @SuppressWarnings(\"unused\")\n         public void handleHost(HttpField field)\n         {\n+            HostPort hp = new HostPort(getLeftMost(field.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQzMDYyOQ==", "bodyText": "Ditto the port here should be 10002... in fact isn't that what the code already does?  Wont the code at \ud83d\udc4d https://github.com/eclipse/jetty.project/blob/jetty-9.4.x/jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java#L662\nalways replace the port of the host header?", "url": "https://github.com/eclipse/jetty.project/pull/5226#discussion_r484430629", "createdAt": "2020-09-07T13:25:27Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/ForwardedRequestCustomizerTest.java", "diffHunk": "@@ -497,7 +497,67 @@ public void destroy() throws Exception\n                     .requestURL(\"http://fw.example.com:4333/\")\n                     .remoteAddr(\"8.5.4.3\").remotePort(2222)\n             ),\n-\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports)\")\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\",\n+                        \"X-Forwarded-Server: sub2.example.com\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10002)\n+                    .requestURL(\"https://sub1.example.com:10002/\")\n+                    .remoteAddr(\"127.0.0.1\").remotePort(8888)\n+            ),\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports - Server First)\")\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"X-Forwarded-Server: sub2.example.com:10007\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10002)\n+                    .requestURL(\"https://sub1.example.com:10002/\")\n+                    .remoteAddr(\"127.0.0.1\").remotePort(8888)\n+            ),\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports - setForwardedPortAsAuthority = false)\")\n+                    .configureCustomizer((customizer) -> customizer.setForwardedPortAsAuthority(false))\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\",\n+                        \"X-Forwarded-Server: sub2.example.com\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10003)\n+                    .requestURL(\"https://sub1.example.com:10003/\")\n+                    .remoteAddr(\"127.0.0.1\").remotePort(8888)\n+            ),\n+            Arguments.of(new Request(\"X-Forwarded-* (Multiple Ports Alt Order)\")\n+                    .headers(\n+                        \"GET / HTTP/1.1\",\n+                        \"Host: myhost:10001\",\n+                        \"X-Forwarded-For: 127.0.0.1:8888,127.0.0.2:9999\",\n+                        \"X-Forwarded-Proto: https\",\n+                        \"X-Forwarded-Host: sub1.example.com:10003\",\n+                        \"X-Forwarded-Port: 10002\",\n+                        \"X-Forwarded-Server: sub2.example.com\"\n+                    ),\n+                new Expectations()\n+                    .scheme(\"https\").serverName(\"sub1.example.com\").serverPort(10003)\n+                    .requestURL(\"https://sub1.example.com:10003/\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTgyNTYy", "url": "https://github.com/eclipse/jetty.project/pull/5226#pullrequestreview-483982562", "createdAt": "2020-09-08T10:01:26Z", "commit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDowMToyNlrOHOV3Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDowMToyNlrOHOV3Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwMDI2Ng==", "bodyText": "This would make it the same as handlePort\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                _host = new HostPort(hp.getHost(), _host.getPort());\n          \n          \n            \n                                _host = new HostPort(hp.getHost(), hp.getPort() >0 ? hp.getPort() : _host.getPort());\n          \n      \n    \n    \n  \n\nalternately take the port <= 0 test out of handlePort to get the alternate precedence.", "url": "https://github.com/eclipse/jetty.project/pull/5226#discussion_r484800266", "createdAt": "2020-09-08T10:01:26Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ForwardedRequestCustomizer.java", "diffHunk": "@@ -598,16 +598,18 @@ public void handleSslSessionId(HttpField field)\n         @SuppressWarnings(\"unused\")\n         public void handleHost(HttpField field)\n         {\n+            HostPort hp = new HostPort(getLeftMost(field.getValue()));\n+\n             if (getForwardedPortAsAuthority() && !StringUtil.isEmpty(getForwardedPortHeader()))\n             {\n                 if (_host == null)\n-                    _host = new PossiblyPartialHostPort(getLeftMost(field.getValue()));\n+                    _host = new PossiblyPartialHostPort(hp.getHost(), hp.getPort());\n                 else if (_host instanceof PortSetHostPort)\n-                    _host = new HostPort(HostPort.normalizeHost(getLeftMost(field.getValue())), _host.getPort());\n+                    _host = new HostPort(hp.getHost(), _host.getPort());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2134b13d794f341dfd4f8e629a0dfeef4eab6cf"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2896ed31d6df6173dde11596ef9d2809f4a7cd7d", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/2896ed31d6df6173dde11596ef9d2809f4a7cd7d", "committedDate": "2020-09-08T17:34:53Z", "message": "Issue #5224 - Updating ForwardedRequestCustomizerTest expectations\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjAwMTAy", "url": "https://github.com/eclipse/jetty.project/pull/5226#pullrequestreview-485200102", "createdAt": "2020-09-09T16:34:37Z", "commit": {"oid": "2896ed31d6df6173dde11596ef9d2809f4a7cd7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 327, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}