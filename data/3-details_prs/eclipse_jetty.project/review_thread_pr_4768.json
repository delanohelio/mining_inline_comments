{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNzA5Nzg0", "number": 4768, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzozMzo1OFrODxhHCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzozMzo1OFrODxhHCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjQ5Mjg5OnYy", "diffSide": "RIGHT", "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzozMzo1OFrOGFByKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwODowMjo1NlrOGFCzPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTI5MQ==", "bodyText": "Does it have to be put into the HttpFields instance?  The HTTP/1 does this in the generator, so that as it is committing the headers it looks for an existing content-length header and if one is not found, but the length is known, then the content length header is generated directly into the output buffer without creating a HttpField instance or modifying the info.\nThe h2 approach here still results in different behaviour because the HttpFields class will be different after commit.", "url": "https://github.com/eclipse/jetty.project/pull/4768#discussion_r407925291", "createdAt": "2020-04-14T07:33:58Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java", "diffHunk": "@@ -110,6 +111,13 @@ public void send(MetaData.Response info, boolean isHeadRequest, ByteBuffer conte\n             {\n                 if (commit.compareAndSet(false, true))\n                 {\n+                    if (lastContent)\n+                    {\n+                        HttpFields responseHeaders = info.getFields();\n+                        if (!responseHeaders.contains(HttpHeader.CONTENT_LENGTH))\n+                            responseHeaders.put(HttpHeader.CONTENT_LENGTH, String.valueOf(BufferUtil.length(content)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MTk0OA==", "bodyText": "@gregw HTTP/2 works with frames, so if I can't put the Content-Length inside the HttpFields I would need an additional field HeadersFrame.contentLength which is doable but feels weird.\nAlso, it's not clear what should be done in case of conflicts with the application.\nFor example, if the application specified a different Content-Length value?", "url": "https://github.com/eclipse/jetty.project/pull/4768#discussion_r407941948", "createdAt": "2020-04-14T08:02:56Z", "author": {"login": "sbordet"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java", "diffHunk": "@@ -110,6 +111,13 @@ public void send(MetaData.Response info, boolean isHeadRequest, ByteBuffer conte\n             {\n                 if (commit.compareAndSet(false, true))\n                 {\n+                    if (lastContent)\n+                    {\n+                        HttpFields responseHeaders = info.getFields();\n+                        if (!responseHeaders.contains(HttpHeader.CONTENT_LENGTH))\n+                            responseHeaders.put(HttpHeader.CONTENT_LENGTH, String.valueOf(BufferUtil.length(content)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTI5MQ=="}, "originalCommit": {"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2470, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}