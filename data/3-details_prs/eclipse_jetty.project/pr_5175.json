{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDc1NjIw", "number": 5175, "title": "Issue #5105 - StatisticsHandler Graceful Shutdown of Async Requests", "bodyText": "Issue #5105\nI have rebased this PR onto the branch from PR #5173 from @thomasdraebing.\nIf an async request has already started we do not properly add the AsyncListener to the HttpChannelState and instead treat it as a completed blocking request even though it has not completed. This is because we used the check state.isSuspended() instead of state.isAsyncStarted().\nThis PR also adds an optional configuration to not wait for the suspended requests when doing a graceful shutdown, but instead shutdown when there are no actively dispatched requests. This can be used as a setter on StatisticsHandler or by an ini property on stats.mod.", "createdAt": "2020-08-19T21:47:09Z", "url": "https://github.com/eclipse/jetty.project/pull/5175", "merged": true, "mergeCommit": {"oid": "001def4905b6a5bffd7e53df8e5adabbdc129530"}, "closed": true, "closedAt": "2020-08-28T01:54:46Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAW6x6gH2gAyNDcwNDc1NjIwOmE0NmVkNWI1ZjA2MzMyZThkNTVhYzRjOWVlNWQ4MWQwZWUyMTllMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC7x2eAFqTQ3NjQ3OTYxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a46ed5b5f06332e8d55ac4c9ee5d81d0ee219e2e", "author": {"user": {"login": "thomasdraebing", "name": "Thomas Dr\u00e4bing"}}, "url": "https://github.com/eclipse/jetty.project/commit/a46ed5b5f06332e8d55ac4c9ee5d81d0ee219e2e", "committedDate": "2020-08-19T07:59:21Z", "message": "Also manage graceful shutdown of already started async requests\n\nSigned-off-by: Thomas Draebing <thomas.draebing@sap.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32358b1b7762cda392d499d1cd2077d1ab2b164d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/32358b1b7762cda392d499d1cd2077d1ab2b164d", "committedDate": "2020-08-19T21:27:12Z", "message": "Issue #5105 - fix StatisticsHandler bug with async dispatched requests\n\nIf the request is async dispatched, the check state.isSuspended() is not\ncorrect to determine if the request was async or not. The check\nstate.isAsyncStarted() should be used instead.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a65f00156d7f467c244507127411cb77a286139e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a65f00156d7f467c244507127411cb77a286139e", "committedDate": "2020-08-19T21:27:12Z", "message": "Issue #5105 - add optional configuration to not wait for suspended requests in StatisticsHandler\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/0fae221afab80dda2373bb6bf21ef58b142b957e", "committedDate": "2020-08-19T21:27:12Z", "message": "Issue #5105 - fix GracefulStopTest expectations from 503s to 404s\n\nStatisticsHandler no longer gives 503 responses after shutdown.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTkxMTg0", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-470991184", "createdAt": "2020-08-19T21:52:37Z", "commit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo1MjozN1rOHDbl1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo1MjozN1rOHDbl1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA==", "bodyText": "@gregw are you sure that this behaviour change is ok?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r473359828", "createdAt": "2020-08-19T21:52:37Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTMzMzMz", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-472933333", "createdAt": "2020-08-22T15:24:03Z", "commit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNToyNDowM1rOHFF3lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNTozMDozMFrOHFF55g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA==", "bodyText": "I think this pattern had been used in other handlers and filters... can you check that we've not made the same mistake elsewhere.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101078", "createdAt": "2020-08-22T15:24:03Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTI5OA==", "bodyText": "Not really. This handler should never send a 404. It should either send a 503 or return without handling the request at all.\nI tend to think the later is more flexible and that context handler can send any 503s", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101298", "createdAt": "2020-08-22T15:26:06Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTU1OQ==", "bodyText": "Bad name as \"suspended\" is no longer really a thing and the name is a hangover from completions.\nThe choice is between shutting down on zero request or zero dispatched... how about just asyncGraceful?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101559", "createdAt": "2020-08-22T15:29:35Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -67,6 +66,8 @@\n     private final LongAdder _responses5xx = new LongAdder();\n     private final LongAdder _responsesTotalBytes = new LongAdder();\n \n+    private boolean waitForSuspendedRequestsOnShutdown = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTY3MA==", "bodyText": "start name with set", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101670", "createdAt": "2020-08-22T15:30:30Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +259,16 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete (including suspended requests)\n+     * or whether it should only wait for all the actively dispatched requests to complete.\n+     * @param waitForSuspendedRequests true to wait for suspended requests on graceful shutdown.\n+     */\n+    public void waitForSuspendedRequestsOnShutdown(boolean waitForSuspendedRequests)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 181}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0268c590f118720537e1b72c9a4cb1915cdfc39", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/c0268c590f118720537e1b72c9a4cb1915cdfc39", "committedDate": "2020-08-24T06:19:59Z", "message": "change name of waitForSuspendedRequestsOnShutdown to asyncGraceful\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjU2MTEy", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-473656112", "createdAt": "2020-08-24T16:20:23Z", "commit": {"oid": "c0268c590f118720537e1b72c9a4cb1915cdfc39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyMDoyM1rOHFshhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyMDoyM1rOHFshhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNDQwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <Set name=\"asyncGraceful\">\n          \n          \n            \n                      <Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/>\n          \n          \n            \n                    </Set>\n          \n          \n            \n                    <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>\n          \n      \n    \n    \n  \n\nand when it merges to 10 it becomes:\n        <Set name=\"asyncGraceful\" property=\"jetty.statistics.asyncGraceful\"/>", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475734405", "createdAt": "2020-08-24T16:20:23Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,11 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\">\n+          <Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/>\n+        </Set>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0268c590f118720537e1b72c9a4cb1915cdfc39"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5da1fa35d81584ce0f947b1e12b46e98762192", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2d5da1fa35d81584ce0f947b1e12b46e98762192", "committedDate": "2020-08-25T00:34:59Z", "message": "StatisticsHandler should still return 503 responses on shutdown\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/8edb7682cdedd3c14717eb8fd424db339273aec9", "committedDate": "2020-08-25T00:40:09Z", "message": "DebugHandler should use isAsyncStarted() instead of isSuspended()\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTkzNzMw", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-474193730", "createdAt": "2020-08-25T07:11:09Z", "commit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjQ4Mjcw", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-474648270", "createdAt": "2020-08-25T16:24:12Z", "commit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyNDoxMlrOHGf7vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyOToyOFrOHGgJdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NjcwMw==", "bodyText": "\"asyncGraceful\" does not really convey the notion that is the shutdown that is graceful, and for full requests.\nI would rename this to \"gracefulShutdownWaitsForRequests\".", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476576703", "createdAt": "2020-08-25T16:24:12Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,9 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzY5MA==", "bodyText": "Fix the comment above the if statement too, or remove it altogether so it won't rot.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476577690", "createdAt": "2020-08-25T16:25:41Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -105,15 +106,15 @@ public void onComplete(AsyncEvent event) throws IOException\n             Request request = state.getBaseRequest();\n             final long elapsed = System.currentTimeMillis() - request.getTimeStamp();\n \n-            long d = _requestStats.decrement();\n+            long numRequests = _requestStats.decrement();\n             _requestTimeStats.record(elapsed);\n \n             updateResponse(request);\n \n             _asyncWaitStats.decrement();\n \n             // If we have no more dispatches, should we signal shutdown?\n-            if (d == 0)\n+            if (numRequests == 0 && asyncGraceful)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MDIxNA==", "bodyText": "The getter method is missing and should be annotated with @ManagedAttribute.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476580214", "createdAt": "2020-08-25T16:29:28Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +264,17 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete including\n+     * async requests which are not currently dispatched, or whether it should only wait for all the\n+     * actively dispatched requests to complete.\n+     * @param asyncGraceful true to wait for async requests on graceful shutdown.\n+     */\n+    public void setAsyncGraceful(boolean asyncGraceful)\n+    {\n+        this.asyncGraceful = asyncGraceful;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 182}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9c90d330915933abc49805364f06cb41079f242", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a9c90d330915933abc49805364f06cb41079f242", "committedDate": "2020-08-26T22:59:13Z", "message": "Issue #5105 - change asyncGraceful to gracefulShutdownWaitsForRequests\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d09055b3350ce047fee107c8ca1ee9bfed4ef9b4", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d09055b3350ce047fee107c8ca1ee9bfed4ef9b4", "committedDate": "2020-08-26T21:53:58Z", "message": "Issue #5105 - change asyncGraceful to gracefulShutdownWaitsForRequests\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}, "afterCommit": {"oid": "a9c90d330915933abc49805364f06cb41079f242", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a9c90d330915933abc49805364f06cb41079f242", "committedDate": "2020-08-26T22:59:13Z", "message": "Issue #5105 - change asyncGraceful to gracefulShutdownWaitsForRequests\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDc5NjE4", "url": "https://github.com/eclipse/jetty.project/pull/5175#pullrequestreview-476479618", "createdAt": "2020-08-27T08:03:56Z", "commit": {"oid": "a9c90d330915933abc49805364f06cb41079f242"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 296, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}