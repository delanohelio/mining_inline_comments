{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MDI3MDIz", "number": 5042, "title": "Issue #5019 - hot-reload SSL certificates if keystore file changed", "bodyText": "Issue #5019\nAdded an ssl-reload module which uses Scanner to monitor the keystore file registered with the SslContextFactory and reloads the keystore file if it detects any changes.", "createdAt": "2020-07-13T04:28:56Z", "url": "https://github.com/eclipse/jetty.project/pull/5042", "merged": true, "mergeCommit": {"oid": "bbb0f6617c6f09cc5744d11daa596b2fc49d8744"}, "closed": true, "closedAt": "2020-07-15T23:09:04Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczflZ8AH2gAyNDQ4MDI3MDIzOjI0ZDBlNTBhMGM5YTNlMzVkZjJiMjJiNDNmNGQwNDIwODcyZmFlMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1KU3zgFqTQ0ODkzMjI2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24d0e50a0c9a3e35df2b22b43f4d0420872fae06", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/24d0e50a0c9a3e35df2b22b43f4d0420872fae06", "committedDate": "2020-07-10T08:44:08Z", "message": "Issue #5019 - add class to do SSL keystore hot-reload in new module\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13e034fc5f904f5a79aef21bbdf01016aac3293b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/13e034fc5f904f5a79aef21bbdf01016aac3293b", "committedDate": "2020-07-10T08:44:24Z", "message": "Issue #5019 - add testing for the SslKeyStoreScanner\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34873419ec14e43e58949c8c7052ae6d47b3dcd", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f34873419ec14e43e58949c8c7052ae6d47b3dcd", "committedDate": "2020-07-10T08:44:35Z", "message": "Issue #5019 - add jetty module files and xml to use ssl-reload with start.jar\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80f09e1f712641d8457bcf693930fe1dbfe571d1", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/80f09e1f712641d8457bcf693930fe1dbfe571d1", "committedDate": "2020-07-10T08:44:44Z", "message": "fix issues with the ssl-reload module\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc91f690be247863aab17536779497d0420f0699", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/dc91f690be247863aab17536779497d0420f0699", "committedDate": "2020-07-13T01:33:51Z", "message": "use WorkDirExtension in KeystoreReloadTest to fix failing tests on jenkins\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0705d8ea77390cb9ab8dae4e728a6a3802c4bfe4", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/0705d8ea77390cb9ab8dae4e728a6a3802c4bfe4", "committedDate": "2020-07-13T03:35:47Z", "message": "generalize the exception type tested in KeystoreReloadTest\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDY2NTcw", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-447066570", "createdAt": "2020-07-13T09:07:25Z", "commit": {"oid": "0705d8ea77390cb9ab8dae4e728a6a3802c4bfe4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ee077b7967a1f6ecc9c5d66827c463eea16e3f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/62ee077b7967a1f6ecc9c5d66827c463eea16e3f", "committedDate": "2020-07-13T13:11:09Z", "message": "move code of ssl-reload module to jetty-util, move module files to jetty-server\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/b03643961d9d7be6ed566c42aadb9bd6428a3cfa", "committedDate": "2020-07-13T14:22:21Z", "message": "add tests in KeystoreScannerTest for changes with symlinks\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDI5NTgw", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-447429580", "createdAt": "2020-07-13T16:54:10Z", "commit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjo1NDoxMVrOGwxOyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjo1NDo1OFrOGwxQjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTQzMg==", "bodyText": "This is a comment.\nAdd # to the start please.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791432", "createdAt": "2020-07-13T16:54:11Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/config/modules/ssl-reload.mod", "diffHunk": "@@ -0,0 +1,21 @@\n+DO NOT EDIT - See: https://www.eclipse.org/jetty/documentation/current/startup-modules.html", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTcyNA==", "bodyText": "Feel free to remove this, you have a testcase for it.\nThis works as-is, and makes sense.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791724", "createdAt": "2020-07-13T16:54:40Z", "author": {"login": "joakime"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener\n+{\n+    private static final Logger LOG = Log.getLogger(SslKeyStoreScanner.class);\n+\n+    private final SslContextFactory sslContextFactory;\n+    private final File keystoreFile;\n+    private final List<File> files = new ArrayList<>();\n+    private Scanner _scanner;\n+    private int _scanInterval = 1;\n+\n+    public SslKeyStoreScanner(SslContextFactory sslContextFactory)\n+    {\n+        this.sslContextFactory = sslContextFactory;\n+        this.keystoreFile = new File(URI.create(sslContextFactory.getKeyStorePath())); // getKeyStorePath is giving url instead of path?\n+        if (!keystoreFile.exists())\n+            throw new IllegalArgumentException(\"keystore file does not exist\");\n+        if (keystoreFile.isDirectory())\n+            throw new IllegalArgumentException(\"expected keystore file not directory\");\n+\n+        File parentFile = keystoreFile.getParentFile();\n+        if (!parentFile.exists() || !parentFile.isDirectory())\n+            throw new IllegalArgumentException(\"error obtaining keystore dir\");\n+\n+        files.add(parentFile);\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"created {}\", this);\n+    }\n+\n+    @Override\n+    protected void doStart() throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(this.getClass().getSimpleName() + \".doStart()\");\n+\n+        _scanner = new Scanner();\n+        _scanner.setScanDirs(files);\n+        _scanner.setScanInterval(_scanInterval);\n+        _scanner.setReportDirs(false);\n+        _scanner.setReportExistingFilesOnStartup(false);\n+        _scanner.setScanDepth(1);\n+        _scanner.addListener(this);\n+        _scanner.start();\n+    }\n+\n+    @Override\n+    protected void doStop() throws Exception\n+    {\n+        if (_scanner != null)\n+        {\n+            _scanner.stop();\n+            _scanner.removeListener(this);\n+            _scanner = null;\n+        }\n+    }\n+\n+    @Override\n+    public void fileAdded(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"added {}\", filename);\n+\n+        if (keystoreFile.toPath().toString().equals(filename))\n+            reload();\n+    }\n+\n+    @Override\n+    public void fileChanged(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"changed {}\", filename);\n+\n+        if (keystoreFile.toPath().toString().equals(filename))\n+            reload();\n+    }\n+\n+    @Override\n+    public void fileRemoved(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"removed {}\", filename);\n+\n+        // TODO: do we want to do this?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTg4Nw==", "bodyText": "Perhaps call it KeyStoreScanner ?", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791887", "createdAt": "2020-07-13T16:54:58Z", "author": {"login": "joakime"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDM0NTM2", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-447434536", "createdAt": "2020-07-13T17:00:51Z", "commit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzowMDo1MVrOGwxesA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzowMDo1MVrOGwxesA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTUwNA==", "bodyText": "Perhaps try ... sslContextFactory.getKeyStoreResource().getFile()?", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453795504", "createdAt": "2020-07-13T17:00:51Z", "author": {"login": "joakime"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener\n+{\n+    private static final Logger LOG = Log.getLogger(SslKeyStoreScanner.class);\n+\n+    private final SslContextFactory sslContextFactory;\n+    private final File keystoreFile;\n+    private final List<File> files = new ArrayList<>();\n+    private Scanner _scanner;\n+    private int _scanInterval = 1;\n+\n+    public SslKeyStoreScanner(SslContextFactory sslContextFactory)\n+    {\n+        this.sslContextFactory = sslContextFactory;\n+        this.keystoreFile = new File(URI.create(sslContextFactory.getKeyStorePath())); // getKeyStorePath is giving url instead of path?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDI5NDYy", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-447429462", "createdAt": "2020-07-13T16:54:01Z", "commit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjo1NDowMVrOGwxOaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzowMTozMFrOGwxgOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTMzOQ==", "bodyText": "Remove empty line!", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791339", "createdAt": "2020-07-13T16:54:01Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/etc/jetty-ssl-reload.xml", "diffHunk": "@@ -0,0 +1,13 @@\n+<?xml version=\"1.0\"?><!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure_9_3.dtd\">\n+\n+<Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTY0Ng==", "bodyText": "I don't think there is this jar anymore?", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791646", "createdAt": "2020-07-13T16:54:32Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/modules/ssl-reload.mod", "diffHunk": "@@ -0,0 +1,21 @@\n+DO NOT EDIT - See: https://www.eclipse.org/jetty/documentation/current/startup-modules.html\n+\n+[description]\n+Enables the SSL keystore to be reloaded after any changes are detected on the file system.\n+\n+[tags]\n+connector\n+ssl\n+\n+[depend]\n+ssl\n+\n+[lib]\n+lib/jetty-ssl-reload-${jetty.version}.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5MTk3MQ==", "bodyText": "Drop Ssl from the class name and extend ContainerLifeCycle so we can add the Scanner as a bean.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453791971", "createdAt": "2020-07-13T16:55:04Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5Mzk2Ng==", "bodyText": "Rename the XML file to jetty-ssl-context-reload.xml.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453793966", "createdAt": "2020-07-13T16:58:25Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/modules/ssl-reload.mod", "diffHunk": "@@ -0,0 +1,21 @@\n+DO NOT EDIT - See: https://www.eclipse.org/jetty/documentation/current/startup-modules.html\n+\n+[description]\n+Enables the SSL keystore to be reloaded after any changes are detected on the file system.\n+\n+[tags]\n+connector\n+ssl\n+\n+[depend]\n+ssl\n+\n+[lib]\n+lib/jetty-ssl-reload-${jetty.version}.jar\n+\n+[xml]\n+etc/jetty-ssl-reload.xml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NDM2MA==", "bodyText": "Properties should be jetty.sslContext.reload.scanInterval.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453794360", "createdAt": "2020-07-13T16:59:02Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/modules/ssl-reload.mod", "diffHunk": "@@ -0,0 +1,21 @@\n+DO NOT EDIT - See: https://www.eclipse.org/jetty/documentation/current/startup-modules.html\n+\n+[description]\n+Enables the SSL keystore to be reloaded after any changes are detected on the file system.\n+\n+[tags]\n+connector\n+ssl\n+\n+[depend]\n+ssl\n+\n+[lib]\n+lib/jetty-ssl-reload-${jetty.version}.jar\n+\n+[xml]\n+etc/jetty-ssl-reload.xml\n+\n+[ini-template]\n+# Monitored directory scan period (seconds)\n+# jetty.ssl.reload.scanInterval=1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTY2NQ==", "bodyText": "Make _scanner final and add it as a bean in the constructor.\nHere just configure it and call super to start it.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453795665", "createdAt": "2020-07-13T17:01:06Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener\n+{\n+    private static final Logger LOG = Log.getLogger(SslKeyStoreScanner.class);\n+\n+    private final SslContextFactory sslContextFactory;\n+    private final File keystoreFile;\n+    private final List<File> files = new ArrayList<>();\n+    private Scanner _scanner;\n+    private int _scanInterval = 1;\n+\n+    public SslKeyStoreScanner(SslContextFactory sslContextFactory)\n+    {\n+        this.sslContextFactory = sslContextFactory;\n+        this.keystoreFile = new File(URI.create(sslContextFactory.getKeyStorePath())); // getKeyStorePath is giving url instead of path?\n+        if (!keystoreFile.exists())\n+            throw new IllegalArgumentException(\"keystore file does not exist\");\n+        if (keystoreFile.isDirectory())\n+            throw new IllegalArgumentException(\"expected keystore file not directory\");\n+\n+        File parentFile = keystoreFile.getParentFile();\n+        if (!parentFile.exists() || !parentFile.isDirectory())\n+            throw new IllegalArgumentException(\"error obtaining keystore dir\");\n+\n+        files.add(parentFile);\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"created {}\", this);\n+    }\n+\n+    @Override\n+    protected void doStart() throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(this.getClass().getSimpleName() + \".doStart()\");\n+\n+        _scanner = new Scanner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc5NTg5Nw==", "bodyText": "Remove comment as you have a test case for this behavior and seems to work fine.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r453795897", "createdAt": "2020-07-13T17:01:30Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslKeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,145 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.AbstractLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class SslKeyStoreScanner extends AbstractLifeCycle implements Scanner.DiscreteListener\n+{\n+    private static final Logger LOG = Log.getLogger(SslKeyStoreScanner.class);\n+\n+    private final SslContextFactory sslContextFactory;\n+    private final File keystoreFile;\n+    private final List<File> files = new ArrayList<>();\n+    private Scanner _scanner;\n+    private int _scanInterval = 1;\n+\n+    public SslKeyStoreScanner(SslContextFactory sslContextFactory)\n+    {\n+        this.sslContextFactory = sslContextFactory;\n+        this.keystoreFile = new File(URI.create(sslContextFactory.getKeyStorePath())); // getKeyStorePath is giving url instead of path?\n+        if (!keystoreFile.exists())\n+            throw new IllegalArgumentException(\"keystore file does not exist\");\n+        if (keystoreFile.isDirectory())\n+            throw new IllegalArgumentException(\"expected keystore file not directory\");\n+\n+        File parentFile = keystoreFile.getParentFile();\n+        if (!parentFile.exists() || !parentFile.isDirectory())\n+            throw new IllegalArgumentException(\"error obtaining keystore dir\");\n+\n+        files.add(parentFile);\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"created {}\", this);\n+    }\n+\n+    @Override\n+    protected void doStart() throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(this.getClass().getSimpleName() + \".doStart()\");\n+\n+        _scanner = new Scanner();\n+        _scanner.setScanDirs(files);\n+        _scanner.setScanInterval(_scanInterval);\n+        _scanner.setReportDirs(false);\n+        _scanner.setReportExistingFilesOnStartup(false);\n+        _scanner.setScanDepth(1);\n+        _scanner.addListener(this);\n+        _scanner.start();\n+    }\n+\n+    @Override\n+    protected void doStop() throws Exception\n+    {\n+        if (_scanner != null)\n+        {\n+            _scanner.stop();\n+            _scanner.removeListener(this);\n+            _scanner = null;\n+        }\n+    }\n+\n+    @Override\n+    public void fileAdded(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"added {}\", filename);\n+\n+        if (keystoreFile.toPath().toString().equals(filename))\n+            reload();\n+    }\n+\n+    @Override\n+    public void fileChanged(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"changed {}\", filename);\n+\n+        if (keystoreFile.toPath().toString().equals(filename))\n+            reload();\n+    }\n+\n+    @Override\n+    public void fileRemoved(String filename) throws Exception\n+    {\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"removed {}\", filename);\n+\n+        // TODO: do we want to do this?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03643961d9d7be6ed566c42aadb9bd6428a3cfa"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a83844df32f08a18ba2e78a76f98205a611d1254", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a83844df32f08a18ba2e78a76f98205a611d1254", "committedDate": "2020-07-14T06:10:07Z", "message": "changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTM2MDI4", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-447936028", "createdAt": "2020-07-14T09:20:45Z", "commit": {"oid": "a83844df32f08a18ba2e78a76f98205a611d1254"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOToyMDo0NVrOGxLeqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOToyMjowMVrOGxLhvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyMTQ4MQ==", "bodyText": "Add javadocs.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r454221481", "createdAt": "2020-07-14T09:20:45Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/KeyStoreScanner.java", "diffHunk": "@@ -0,0 +1,126 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.util.ssl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Collections;\n+\n+import org.eclipse.jetty.util.Scanner;\n+import org.eclipse.jetty.util.annotation.ManagedAttribute;\n+import org.eclipse.jetty.util.annotation.ManagedOperation;\n+import org.eclipse.jetty.util.component.ContainerLifeCycle;\n+import org.eclipse.jetty.util.log.Log;\n+import org.eclipse.jetty.util.log.Logger;\n+\n+public class KeyStoreScanner extends ContainerLifeCycle implements Scanner.DiscreteListener", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a83844df32f08a18ba2e78a76f98205a611d1254"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyMjI3MA==", "bodyText": "Drop ssl in the id.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r454222270", "createdAt": "2020-07-14T09:22:01Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/etc/jetty-ssl-context-reload.xml", "diffHunk": "@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\"?><!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure_9_3.dtd\">\n+\n+<Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n+  <Call name=\"addBean\">\n+    <Arg>\n+      <New id=\"sslKeyStoreScanner\" class=\"org.eclipse.jetty.util.ssl.KeyStoreScanner\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a83844df32f08a18ba2e78a76f98205a611d1254"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2541f1f648f86767f9e95d1d002a5ca57fe99e21", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2541f1f648f86767f9e95d1d002a5ca57fe99e21", "committedDate": "2020-07-15T01:20:57Z", "message": "add javadoc for KeyStoreScanner class\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c40ba6922259b7c5c19e71dea2bfc6335c96982b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/c40ba6922259b7c5c19e71dea2bfc6335c96982b", "committedDate": "2020-07-15T05:35:22Z", "message": "add null checks in SslContextFactory for _factory, which could be null if reload failed\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzIyNDQ2", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-448722446", "createdAt": "2020-07-15T08:07:31Z", "commit": {"oid": "c40ba6922259b7c5c19e71dea2bfc6335c96982b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODowNzozMVrOGxzAvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODowNzozMVrOGxzAvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2OTE4MQ==", "bodyText": "Change the message to \"SslContextFactory not started or reload failed\" in the 3 places you have added it.\nWe will know from the stack trace what is unavailable.", "url": "https://github.com/eclipse/jetty.project/pull/5042#discussion_r454869181", "createdAt": "2020-07-15T08:07:31Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/ssl/SslContextFactory.java", "diffHunk": "@@ -1131,6 +1131,9 @@ public SSLContext getSslContext()\n \n         synchronized (this)\n         {\n+            if (_factory == null)\n+                throw new IllegalStateException(\"reload failed SslContext unavailable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c40ba6922259b7c5c19e71dea2bfc6335c96982b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7d99c3bfecf6f67b95f64c031880a0b4832078", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/0f7d99c3bfecf6f67b95f64c031880a0b4832078", "committedDate": "2020-07-15T09:01:15Z", "message": "add documentation for ssl-reload, change exception message in SslContextFactory\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTMyMjY4", "url": "https://github.com/eclipse/jetty.project/pull/5042#pullrequestreview-448932268", "createdAt": "2020-07-15T13:05:55Z", "commit": {"oid": "0f7d99c3bfecf6f67b95f64c031880a0b4832078"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 364, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}