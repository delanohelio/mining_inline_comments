{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjMwODI4", "number": 4721, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToyODowOFrODr_G-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MTowNFrODr_Y2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDQ5MzM3OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContextEvent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToyODowOFrOF8pO0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1MDowNFrOF9h7mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNDQxOA==", "bodyText": "This new boolean parameter requires more brainpower to understand than I'm comfortable with. IMHO it should either be renamed (useProvidedUri?) or documented, or maybe both.", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399134418", "createdAt": "2020-03-27T09:28:08Z", "author": {"login": "lorban"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContextEvent.java", "diffHunk": "@@ -25,25 +25,28 @@\n import javax.servlet.ServletRequest;\n import javax.servlet.ServletResponse;\n \n+import org.eclipse.jetty.http.HttpURI;\n import org.eclipse.jetty.server.handler.ContextHandler.Context;\n import org.eclipse.jetty.util.thread.Scheduler;\n \n public class AsyncContextEvent extends AsyncEvent implements Runnable\n {\n     private final Context _context;\n     private final AsyncContextState _asyncContext;\n+    private final HttpURI _providedUri;\n     private volatile HttpChannelState _state;\n     private ServletContext _dispatchContext;\n     private String _dispatchPath;\n     private volatile Scheduler.Task _timeoutTask;\n     private Throwable _throwable;\n \n-    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response)\n+    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response, boolean provided)\n     {\n         super(null, request, response, null);\n         _context = context;\n         _asyncContext = asyncContext;\n         _state = state;\n+        _providedUri = provided ? new HttpURI(baseRequest.getHttpURI()) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2MzM4NQ==", "bodyText": "I'll pass in the URI and call it baseURI.", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400063385", "createdAt": "2020-03-30T09:50:04Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/AsyncContextEvent.java", "diffHunk": "@@ -25,25 +25,28 @@\n import javax.servlet.ServletRequest;\n import javax.servlet.ServletResponse;\n \n+import org.eclipse.jetty.http.HttpURI;\n import org.eclipse.jetty.server.handler.ContextHandler.Context;\n import org.eclipse.jetty.util.thread.Scheduler;\n \n public class AsyncContextEvent extends AsyncEvent implements Runnable\n {\n     private final Context _context;\n     private final AsyncContextState _asyncContext;\n+    private final HttpURI _providedUri;\n     private volatile HttpChannelState _state;\n     private ServletContext _dispatchContext;\n     private String _dispatchPath;\n     private volatile Scheduler.Task _timeoutTask;\n     private Throwable _throwable;\n \n-    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response)\n+    public AsyncContextEvent(Context context, AsyncContextState asyncContext, HttpChannelState state, Request baseRequest, ServletRequest request, ServletResponse response, boolean provided)\n     {\n         super(null, request, response, null);\n         _context = context;\n         _asyncContext = asyncContext;\n         _state = state;\n+        _providedUri = provided ? new HttpURI(baseRequest.getHttpURI()) : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNDQxOA=="}, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDQ5Nzk0OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToyOToxOFrOF8pRmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToyOToxOFrOF8pRmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTEzMQ==", "bodyText": "I wonder if you shouldn't keep the old constructor here, and not use an extra boolean argument.", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399135131", "createdAt": "2020-03-27T09:29:18Z", "author": {"login": "lorban"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2165,7 +2168,7 @@ public AsyncContext startAsync() throws IllegalStateException\n         HttpChannelState state = getHttpChannelState();\n         if (_async == null)\n             _async = new AsyncContextState(state);\n-        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, this, getResponse());\n+        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, this, getResponse(), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDUwMDMwOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTozMDowMlrOF8pTMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1MDoxNVrOF9h7-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTUzOQ==", "bodyText": "I wonder if you shouldn't pass the providedUri here instead of a boolean.", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399135539", "createdAt": "2020-03-27T09:30:02Z", "author": {"login": "lorban"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2178,17 +2181,8 @@ public AsyncContext startAsync(ServletRequest servletRequest, ServletResponse se\n         HttpChannelState state = getHttpChannelState();\n         if (_async == null)\n             _async = new AsyncContextState(state);\n-        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse);\n+        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2MzQ4MA==", "bodyText": "ack", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400063480", "createdAt": "2020-03-30T09:50:15Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2178,17 +2181,8 @@ public AsyncContext startAsync(ServletRequest servletRequest, ServletResponse se\n         HttpChannelState state = getHttpChannelState();\n         if (_async == null)\n             _async = new AsyncContextState(state);\n-        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse);\n+        AsyncContextEvent event = new AsyncContextEvent(_context, _async, state, this, servletRequest, servletResponse, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzNTUzOQ=="}, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NDUzOTE1OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0MTowNFrOF8psHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDozMDo0MlrOF9jZ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg==", "bodyText": "Couldn't / shouldn't the code of this branch (as well as the new else one) be moved to URIUtil?", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r399141916", "createdAt": "2020-03-27T09:41:04Z", "author": {"login": "lorban"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2391,7 +2385,7 @@ else if (oldQueryParams == null || oldQueryParams.size() == 0)\n                 setQueryString(oldQuery);\n             else if (oldQuery == null)\n                 setQueryString(newQuery);\n-            else\n+            else if (oldQueryParams.keySet().stream().anyMatch(newQueryParams.keySet()::contains))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NzIxNg==", "bodyText": "Hmmm  probably.... but now I'm losing confidence that this code is even necessary in the first place!  The actual parameters maps are merged above with:\n            mergedQueryParams = new MultiMap<>(newQueryParams);\n            mergedQueryParams.addAllValues(oldQueryParams);\nSo surely the actual query string itself should be merged with just\n    setQueryString(newQuery + '&' + oldQuery);\nI think I'll try removing that complex logic and see what fails and then check with the TCK if it should or shouldn't fail like that!", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400067216", "createdAt": "2020-03-30T09:56:16Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2391,7 +2385,7 @@ else if (oldQueryParams == null || oldQueryParams.size() == 0)\n                 setQueryString(oldQuery);\n             else if (oldQuery == null)\n                 setQueryString(newQuery);\n-            else\n+            else if (oldQueryParams.keySet().stream().anyMatch(newQueryParams.keySet()::contains))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4NDEyMQ==", "bodyText": "Ugh!  @janbartel just pointed me at #2074 so we dropped the ball on this a bit as we do have different behaviours and we've not chosen one or the other.   I'm going to experiment with the simplest interpretation and see what the TCK says", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400084121", "createdAt": "2020-03-30T10:24:38Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2391,7 +2385,7 @@ else if (oldQueryParams == null || oldQueryParams.size() == 0)\n                 setQueryString(oldQuery);\n             else if (oldQuery == null)\n                 setQueryString(newQuery);\n-            else\n+            else if (oldQueryParams.keySet().stream().anyMatch(newQueryParams.keySet()::contains))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4NzUxMA==", "bodyText": "Actually cancel that.  I'm going to merge this one as it is mostly unrelated and work on #2074 separately", "url": "https://github.com/eclipse/jetty.project/pull/4721#discussion_r400087510", "createdAt": "2020-03-30T10:30:42Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -2391,7 +2385,7 @@ else if (oldQueryParams == null || oldQueryParams.size() == 0)\n                 setQueryString(oldQuery);\n             else if (oldQuery == null)\n                 setQueryString(newQuery);\n-            else\n+            else if (oldQueryParams.keySet().stream().anyMatch(newQueryParams.keySet()::contains))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTkxNg=="}, "originalCommit": {"oid": "983193071e8f2062e0350cb18b4af0e4e921aff5"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2711, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}