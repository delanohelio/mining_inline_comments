{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTI0ODgw", "number": 4910, "title": "Jetty 9.4.x jdbc session test docker", "bodyText": "reopen of #4905 with correct target branch (jetty-9.4.x)", "createdAt": "2020-05-26T10:39:11Z", "url": "https://github.com/eclipse/jetty.project/pull/4910", "merged": true, "mergeCommit": {"oid": "2b1fa80b63e5e0491830c9871fc67e3d41154d3d"}, "closed": true, "closedAt": "2020-05-27T06:00:24Z", "author": {"login": "olamy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclAdHegH2gAyNDIzMTI0ODgwOmMwYThjZGY4MzdiYTMyMGZmMGExOGNlODAwOGVmMTRiZDYzNjJkZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclLpeKAH2gAyNDIzMTI0ODgwOjczODlmMTYyODViMDhlNWM0NWE1NDBkOTc0ODZmZDAzZjI4NDZjMWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0a8cdf837ba320ff0a18ce8008ef14bd6362dee", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/c0a8cdf837ba320ff0a18ce8008ef14bd6362dee", "committedDate": "2020-05-26T08:33:05Z", "message": "use testcontainers/docker to run jdbc sessions tests with Mariadb remote\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e652bc79d0cb78f246afecffeb3aa1e401f7165", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/5e652bc79d0cb78f246afecffeb3aa1e401f7165", "committedDate": "2020-05-26T08:33:05Z", "message": "remove changes to DatabaseAdaptor with new fields username/password, use our own username/password in maria_db tests\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6", "committedDate": "2020-05-26T08:33:05Z", "message": "bye bye Derby tests, only use mariadb via container\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MjYwNTQ2", "url": "https://github.com/eclipse/jetty.project/pull/4910#pullrequestreview-418260546", "createdAt": "2020-05-26T12:46:11Z", "commit": {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjo0NjoxMVrOGacj8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjo0OTowMFrOGacqdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NDExMg==", "bodyText": "Still need to delete this line setting the derby property.", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430384112", "createdAt": "2020-05-26T12:46:11Z", "author": {"login": "janbartel"}, "path": "tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/JdbcTestHelper.java", "diffHunk": "@@ -60,6 +68,39 @@\n     public static final String COOKIE_COL = \"cooktime\";\n     public static final String CREATE_COL = \"ctime\";\n \n+    static MariaDBContainer MARIAD_DB;\n+\n+    static final String MARIA_DB_USER = \"beer\";\n+    static final String MARIA_DB_PASSWORD = \"pacific_ale\";\n+\n+    static\n+    {\n+        try\n+        {\n+            long start = System.currentTimeMillis();\n+            MARIAD_DB =\n+                new MariaDBContainer(\"mariadb:\" + System.getProperty(\"mariadb.docker.version\", \"10.3.6\"))\n+                    .withUsername(MARIA_DB_USER)\n+                    .withPassword(MARIA_DB_PASSWORD)\n+                    .withDatabaseName(\"sessions\");\n+            MARIAD_DB.withLogConsumer(new Slf4jLogConsumer(MARIADB_LOG)).start();\n+            String containerIpAddress =  MARIAD_DB.getContainerIpAddress();\n+            int mariadbPort = MARIAD_DB.getMappedPort(3306);\n+            DEFAULT_CONNECTION_URL = MARIAD_DB.getJdbcUrl();\n+            DRIVER_CLASS = MARIAD_DB.getDriverClassName();\n+            LOG.info(\"Mariadb container started for {}:{} - {}ms\", containerIpAddress, mariadbPort,\n+                     System.currentTimeMillis() - start);\n+            DEFAULT_CONNECTION_URL = DEFAULT_CONNECTION_URL + \"?user=\" + MARIA_DB_USER +\n+                \"&password=\" + MARIA_DB_PASSWORD;\n+            LOG.info(\"DEFAULT_CONNECTION_URL: {}\", DEFAULT_CONNECTION_URL);\n+        }\n+        catch (Exception e)\n+        {\n+            LOG.error(e.getMessage(), e);\n+            throw new RuntimeException(e.getMessage(), e);\n+        }\n+    }\n+\n     static\n     {\n         System.setProperty(\"derby.system.home\", MavenTestingUtils.getTargetFile(\"test-derby\").getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NDgzMA==", "bodyText": "Just out of interest, if the tables are dropped after every test, you don't need to make the id unique. Fine either way.", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430384830", "createdAt": "2020-05-26T12:47:25Z", "author": {"login": "janbartel"}, "path": "tests/test-sessions/test-jdbc-sessions/src/test/java/org/eclipse/jetty/server/session/SessionTableSchemaTest.java", "diffHunk": "@@ -119,8 +117,10 @@ public void testLoad()\n         _da.initialize();\n         _tableSchema.prepareTables();\n \n+        String id = Long.toString(System.nanoTime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4NTc4Mg==", "bodyText": "The only qualm I have here is that before, the jdbc session tests were being executed automatically but now we need this property set. Just a qualm.", "url": "https://github.com/eclipse/jetty.project/pull/4910#discussion_r430385782", "createdAt": "2020-05-26T12:49:00Z", "author": {"login": "janbartel"}, "path": "tests/test-sessions/test-jdbc-sessions/pom.xml", "diffHunk": "@@ -46,19 +53,61 @@\n       <version>${project.version}</version>\n     </dependency>\n     <dependency>\n-      <groupId>org.apache.derby</groupId>\n-      <artifactId>derby</artifactId>\n+      <groupId>org.eclipse.jetty.toolchain</groupId>\n+      <artifactId>jetty-test-helper</artifactId>\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n-      <groupId>org.apache.derby</groupId>\n-      <artifactId>derbytools</artifactId>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>testcontainers</artifactId>\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n-      <groupId>org.eclipse.jetty.toolchain</groupId>\n-      <artifactId>jetty-test-helper</artifactId>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>mariadb</artifactId>\n+      <version>${testcontainers.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.testcontainers</groupId>\n+      <artifactId>junit-jupiter</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.slf4j</groupId>\n+      <artifactId>slf4j-simple</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.mariadb.jdbc</groupId>\n+      <artifactId>mariadb-java-client</artifactId>\n+      <version>2.6.0</version>\n       <scope>test</scope>\n     </dependency>\n   </dependencies>\n+  <profiles>\n+    <profile>\n+      <id>remote-session-tests</id>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bc9cbcbfa8420cc57f2ed24b2619e37fcc27f6"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9038338644cf27b21b8f575829599b49804bd5c8", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/9038338644cf27b21b8f575829599b49804bd5c8", "committedDate": "2020-05-26T21:29:15Z", "message": "remove derby system property\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7389f16285b08e5c45a540d97486fd03f2846c1b", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/7389f16285b08e5c45a540d97486fd03f2846c1b", "committedDate": "2020-05-26T21:35:32Z", "message": "always run the test except if Docker not available\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 417, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}