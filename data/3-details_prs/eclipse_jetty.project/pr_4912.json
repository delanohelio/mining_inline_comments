{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNTMwODU3", "number": 4912, "title": "Issue #4907 - close websocket suspendState if close frame is received", "bodyText": "Closes #4907\nFixes flaky test SuspendResumeTest.testSuspendAfterClose().\nIf a close frame is received we must close the suspend state so any subsequent calls to suspend() and resume() will throw IllegalStateException.\nThe transition to the close state must be done both when receiving a close frame before the WebSocketFrameListener is called, and in the case when we never received a close frame but the connection has been closed.", "createdAt": "2020-05-27T00:19:07Z", "url": "https://github.com/eclipse/jetty.project/pull/4912", "merged": true, "mergeCommit": {"oid": "33852f51378c0d48863b3236d9fb5309941cb8ca"}, "closed": true, "closedAt": "2020-07-06T02:54:39Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABck_UCuAH2gAyNDIzNTMwODU3OmQ4ZmIxMTZlMTI1MDIxNGI0ODYzZTMwMzA3ZWU0ZGU4YWNhNDczY2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwxU-FAFqTQ0MTIxNTU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8fb116e1250214b4863e30307ee4de8aca473ca", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d8fb116e1250214b4863e30307ee4de8aca473ca", "committedDate": "2020-05-26T07:13:16Z", "message": "Issue #4907 - close suspendState if response close frame is received\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277561e48baba8d6867ad91a7d536dfea48f62d3", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/277561e48baba8d6867ad91a7d536dfea48f62d3", "committedDate": "2020-05-27T00:10:12Z", "message": "Issue #4907 - moved to close state if any close frame is received\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODE4NTk4", "url": "https://github.com/eclipse/jetty.project/pull/4912#pullrequestreview-427818598", "createdAt": "2020-06-10T08:17:23Z", "commit": {"oid": "277561e48baba8d6867ad91a7d536dfea48f62d3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODoxNzoyM1rOGhqAbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODoxNzoyM1rOGhqAbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk0NDQzMA==", "bodyText": "We have just synchronized above, so can this check and change be done in that block?", "url": "https://github.com/eclipse/jetty.project/pull/4912#discussion_r437944430", "createdAt": "2020-06-10T08:17:23Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-jetty-common/src/main/java/org/eclipse/jetty/websocket/common/JettyWebSocketFrameHandler.java", "diffHunk": "@@ -206,6 +206,16 @@ public void onFrame(Frame frame, Callback callback)\n             }\n         }\n \n+        // If we have received a close frame, set state to closed to disallow suspends and resumes.\n+        byte opCode = frame.getOpCode();\n+        if (opCode == OpCode.CLOSE)\n+        {\n+            synchronized (this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "277561e48baba8d6867ad91a7d536dfea48f62d3"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b62c3771bde9ef83c83345a68588f04f4401e8", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/50b62c3771bde9ef83c83345a68588f04f4401e8", "committedDate": "2020-06-16T08:09:29Z", "message": "Issue #4907 - merge synchronized blocks for suspendState\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjE1NTg1", "url": "https://github.com/eclipse/jetty.project/pull/4912#pullrequestreview-441215585", "createdAt": "2020-07-01T21:42:42Z", "commit": {"oid": "50b62c3771bde9ef83c83345a68588f04f4401e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 421, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}