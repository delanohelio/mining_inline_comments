{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNzA5Nzg0", "number": 4768, "title": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.", "bodyText": "Sending Content-Length header if known at the time of sending the\nresponse headers.\nSigned-off-by: Simone Bordet simone.bordet@gmail.com\nCloses #4764.", "createdAt": "2020-04-13T15:58:23Z", "url": "https://github.com/eclipse/jetty.project/pull/4768", "merged": true, "mergeCommit": {"oid": "0953a93335dd19f4de9822359a5f67bc9329a7ad"}, "closed": true, "closedAt": "2020-04-14T21:31:22Z", "author": {"login": "sbordet"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXRCqVAH2gAyNDAyNzA5Nzg0OmRjODlmN2YyNjRjMTUwM2Q3YTRhNzBmYmRjZjIzMDI0ZmUyYmQ1MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXhdeSAH2gAyNDAyNzA5Nzg0OjBlMzBkNmI3NTE1ZGY5N2MwMmY5OWM1ODliNDNiNTEzMDQzYWM5MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/dc89f7f264c1503d7a4a70fbdcf23024fe2bd504", "committedDate": "2020-04-13T15:57:38Z", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nSending Content-Length header if known at the time of sending the\nresponse headers.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNjcxMDQy", "url": "https://github.com/eclipse/jetty.project/pull/4768#pullrequestreview-392671042", "createdAt": "2020-04-14T07:33:58Z", "commit": {"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzozMzo1OFrOGFByKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNzozMzo1OFrOGFByKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTI5MQ==", "bodyText": "Does it have to be put into the HttpFields instance?  The HTTP/1 does this in the generator, so that as it is committing the headers it looks for an existing content-length header and if one is not found, but the length is known, then the content length header is generated directly into the output buffer without creating a HttpField instance or modifying the info.\nThe h2 approach here still results in different behaviour because the HttpFields class will be different after commit.", "url": "https://github.com/eclipse/jetty.project/pull/4768#discussion_r407925291", "createdAt": "2020-04-14T07:33:58Z", "author": {"login": "gregw"}, "path": "jetty-http2/http2-server/src/main/java/org/eclipse/jetty/http2/server/HttpTransportOverHTTP2.java", "diffHunk": "@@ -110,6 +111,13 @@ public void send(MetaData.Response info, boolean isHeadRequest, ByteBuffer conte\n             {\n                 if (commit.compareAndSet(false, true))\n                 {\n+                    if (lastContent)\n+                    {\n+                        HttpFields responseHeaders = info.getFields();\n+                        if (!responseHeaders.contains(HttpHeader.CONTENT_LENGTH))\n+                            responseHeaders.put(HttpHeader.CONTENT_LENGTH, String.valueOf(BufferUtil.length(content)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc89f7f264c1503d7a4a70fbdcf23024fe2bd504"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e85b3e169e30d604b1af11a7518086e5545b0ce", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/2e85b3e169e30d604b1af11a7518086e5545b0ce", "committedDate": "2020-04-14T09:44:58Z", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nUpdates after review.\nNow the Content-Length header is generated by HpackEncoder based on\nMetaData.contentLength, so that the MetaData.HttpFields are not modified.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e96bf862152f0b301d27be12cae051d9bec6d14", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/3e96bf862152f0b301d27be12cae051d9bec6d14", "committedDate": "2020-04-14T09:45:48Z", "message": "Merged branch 'jetty-9.4.x' into 'jetty-9.4.x-4764-http2_content_length'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzkxODk3", "url": "https://github.com/eclipse/jetty.project/pull/4768#pullrequestreview-392791897", "createdAt": "2020-04-14T10:16:46Z", "commit": {"oid": "3e96bf862152f0b301d27be12cae051d9bec6d14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e30d6b7515df97c02f99c589b43b513043ac920", "author": {"user": {"login": "sbordet", "name": "Simone Bordet"}}, "url": "https://github.com/eclipse/jetty.project/commit/0e30d6b7515df97c02f99c589b43b513043ac920", "committedDate": "2020-04-14T11:05:24Z", "message": "Fixes #4764 - HTTP2 Jetty Server does not send back content-length.\n\nFixed InterleavingTest that was using the wrong MetaData.Response constructor.\nFixed handling of HEAD methods in HttpTransportOverHTTP2.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 342, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}