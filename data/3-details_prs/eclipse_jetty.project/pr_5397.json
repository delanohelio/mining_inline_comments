{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTY1NDQx", "number": 5397, "title": "Fixes #5378 Setting Holders during STARTING", "bodyText": "Fixes #5378 Holders are now started/initialized if needed by a new utility method", "createdAt": "2020-10-05T16:13:44Z", "url": "https://github.com/eclipse/jetty.project/pull/5397", "merged": true, "mergeCommit": {"oid": "721a05eb9d71d6ba6ee4ff57555a8a4efcef50ed"}, "closed": true, "closedAt": "2020-10-07T21:22:56Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPmJaDAH2gAyNDk3OTY1NDQxOjlhMWNhZGFkZTRlZjNiMDI0MDVkMGM3ZTRlMmI5ZDZjMjAwYzU1MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQIv0tAFqTUwMzY0MzQyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d", "committedDate": "2020-10-05T16:12:46Z", "message": "Fixes #5378 Setting Holders during STARTING\n\nHolders are now started/initialized if needed by a new utility method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzU0MDA0", "url": "https://github.com/eclipse/jetty.project/pull/5397#pullrequestreview-502754004", "createdAt": "2020-10-06T09:31:42Z", "commit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMTo0MlrOHc97DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMzo1OFrOHc-ASQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNjcxNg==", "bodyText": "Can we put in some comments about what is really being tested here, which is the various states in which the ServletContextHandler, ServletHandler can be in when a servlet/filter/listener is added.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500136716", "createdAt": "2020-10-06T09:31:42Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzMzNQ==", "bodyText": "Can we also please add tests for all the types of objects: adding servlets, filters and listeners from servlets, filters and listeners to make sure that the jetty apis are doing what we expect", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137335", "createdAt": "2020-10-06T09:32:40Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzk2NQ==", "bodyText": "So this means that in the past, adding a listener when the ServletHandler had already started would not have worked, because it never would have been started or initialized - unless someone also happened to add a filter or servlet mapping.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137965", "createdAt": "2020-10-06T09:33:46Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -800,10 +823,7 @@ public void addListener(ListenerHolder listener)\n     public void setListeners(ListenerHolder[] listeners)\n     {\n         if (listeners != null)\n-            for (ListenerHolder holder : listeners)\n-            {\n-                holder.setServletHandler(this);\n-            }\n+            initializeHolders(listeners);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzODA1Nw==", "bodyText": "Delete this line.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500138057", "createdAt": "2020-10-06T09:33:58Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");\n \n         _server.start();\n \n-\n         String request =\n-            \"GET /hello HTTP/1.0\\n\" +\n+            \"GET /test HTTP/1.0\\n\" +\n             \"Host: localhost\\n\" +\n             \"\\n\";\n         String response = _connector.getResponse(request);\n         assertThat(response, containsString(\"200 OK\"));\n+        assertThat(response, containsString(\"filter: filter\"));\n         assertThat(response, containsString(\"Test\"));\n \n-        handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/*\", EnumSet.of(DispatcherType.REQUEST));\n-        handler.addServletWithMapping(new ServletHolder(new HelloServlet()), \"/hello/*\");\n+\n+        handler.addServletWithMapping(new ServletHolder(new HelloServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/hello/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/hello/*\");\n \n         _server.dumpStdErr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e1e0985833e33a97eacdd972b97825eb21cbac0", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/9e1e0985833e33a97eacdd972b97825eb21cbac0", "committedDate": "2020-10-06T12:51:19Z", "message": "Fixes #5378 Setting Holders during STARTING\n\nHolders are now started/initialized if needed by a new utility method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjQzNDIz", "url": "https://github.com/eclipse/jetty.project/pull/5397#pullrequestreview-503643423", "createdAt": "2020-10-07T08:31:30Z", "commit": {"oid": "9e1e0985833e33a97eacdd972b97825eb21cbac0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 21, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}