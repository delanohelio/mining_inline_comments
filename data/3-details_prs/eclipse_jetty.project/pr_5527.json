{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjAyMDMy", "number": 5527, "title": "Fixes #5521 ResourceCollection NPE", "bodyText": "Fix constructor and addPath so that all resources in a RC must exist when created for #5521", "createdAt": "2020-10-28T14:43:50Z", "url": "https://github.com/eclipse/jetty.project/pull/5527", "merged": true, "mergeCommit": {"oid": "1904d326fc58fa1775e6ce20f29c87aec77064e4"}, "closed": true, "closedAt": "2020-11-04T07:56:18Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW-pH2AH2gAyNTExNjAyMDMyOmExZTgzNzUzMGVlY2FlZTllM2FiZTFmNzgwZWNhNzI3MjFkZjZkMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY99WLAFqTUyMjc5NDIxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1e837530eecaee9e3abe1f780eca72721df6d14", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/a1e837530eecaee9e3abe1f780eca72721df6d14", "committedDate": "2020-10-28T14:42:36Z", "message": "Fixes #5521 ResourceCollection NPE\n\nFix constructor and addPath so that all resources in a RC must exist when created."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4Nzc2Nzk2", "url": "https://github.com/eclipse/jetty.project/pull/5527#pullrequestreview-518776796", "createdAt": "2020-10-28T15:15:20Z", "commit": {"oid": "a1e837530eecaee9e3abe1f780eca72721df6d14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToxNToyMFrOHpvQ7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToxNToyMFrOHpvQ7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyODA0NA==", "bodyText": "Is it possible to get here if there are no resources in the RC?\nI thought we prevented that in the constructors.", "url": "https://github.com/eclipse/jetty.project/pull/5527#discussion_r513528044", "createdAt": "2020-10-28T15:15:20Z", "author": {"login": "joakime"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -247,27 +247,28 @@ public Resource addPath(String path) throws IOException\n         ArrayList<Resource> resources = null;\n \n         // Attempt a simple (single) Resource lookup that exists\n+        Resource addedResource = null;\n         for (Resource res : _resources)\n         {\n-            Resource r = res.addPath(path);\n-            if (!r.isDirectory() && r.exists())\n-            {\n-                // Return simple (non-directory) Resource\n-                return r;\n-            }\n-\n+            addedResource = res.addPath(path);\n+            if (!addedResource.exists())\n+                continue;\n+            if (!addedResource.isDirectory())\n+                return addedResource; // Return simple (non-directory) Resource\n             if (resources == null)\n-            {\n                 resources = new ArrayList<>();\n-            }\n+            resources.add(addedResource);\n+        }\n \n-            resources.add(r);\n+        if (resources == null)\n+        {\n+            if (addedResource != null)\n+                return addedResource; // This will not exist", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e837530eecaee9e3abe1f780eca72721df6d14"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60665745ebd8f586c9418ade001937ac5e5c4859", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/60665745ebd8f586c9418ade001937ac5e5c4859", "committedDate": "2020-10-28T16:12:25Z", "message": "Fixes #5521 ResourceCollection NPE\n\nCleanup the vestiges of non existent directories detected by resource ending in /"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288340aea6392ac8a0fd9c0f9edb04400a537425", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/288340aea6392ac8a0fd9c0f9edb04400a537425", "committedDate": "2020-10-28T21:08:04Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5521-ResourceCollection-NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae4f9f6fa841d1b56a8b3714864ff41558c59752", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/ae4f9f6fa841d1b56a8b3714864ff41558c59752", "committedDate": "2020-10-28T22:23:11Z", "message": "Fixes #5521 ResourceCollection NPE\n\nRevert adding paths ending in / as jar:file resource needs them"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMzc1NDY4", "url": "https://github.com/eclipse/jetty.project/pull/5527#pullrequestreview-522375468", "createdAt": "2020-11-03T10:46:25Z", "commit": {"oid": "ae4f9f6fa841d1b56a8b3714864ff41558c59752"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMDo0NjoyNlrOHspO0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMDo0NjoyNlrOHspO0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU3NDkyOA==", "bodyText": "The addPath method IMHO is problematic:\n\nthe javadoc is wrong, it does NOT only return the first contained resource, it can return a ResourceCollection of directories\nwhat is returned is inconsistent: you either get back a single directory that does not exist, or a ResourceCollection of directories that do\nyou get different results depending on the implementation of addPath by the various Resource subclasses: for example, PathResource  will throw MalformedURLException if you give it a path that tries to escape above the root, but URLResource will just return you the original path", "url": "https://github.com/eclipse/jetty.project/pull/5527#discussion_r516574928", "createdAt": "2020-11-03T10:46:26Z", "author": {"login": "janbartel"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -247,27 +247,28 @@ public Resource addPath(String path) throws IOException\n         ArrayList<Resource> resources = null;\n \n         // Attempt a simple (single) Resource lookup that exists\n+        Resource addedResource = null;\n         for (Resource res : _resources)\n         {\n-            Resource r = res.addPath(path);\n-            if (!r.isDirectory() && r.exists())\n-            {\n-                // Return simple (non-directory) Resource\n-                return r;\n-            }\n-\n+            addedResource = res.addPath(path);\n+            if (!addedResource.exists())\n+                continue;\n+            if (!addedResource.isDirectory())\n+                return addedResource; // Return simple (non-directory) Resource\n             if (resources == null)\n-            {\n                 resources = new ArrayList<>();\n-            }\n+            resources.add(addedResource);\n+        }\n \n-            resources.add(r);\n+        if (resources == null)\n+        {\n+            if (addedResource != null)\n+                return addedResource; // This will not exist", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyODA0NA=="}, "originalCommit": {"oid": "a1e837530eecaee9e3abe1f780eca72721df6d14"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1acef42b5d8f3def272a6c3bdd183bbf834d9878", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1acef42b5d8f3def272a6c3bdd183bbf834d9878", "committedDate": "2020-11-03T16:28:28Z", "message": "feedback from review\n\nimproved javadoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjc2MzQz", "url": "https://github.com/eclipse/jetty.project/pull/5527#pullrequestreview-522676343", "createdAt": "2020-11-03T16:33:32Z", "commit": {"oid": "1acef42b5d8f3def272a6c3bdd183bbf834d9878"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzk0MjE3", "url": "https://github.com/eclipse/jetty.project/pull/5527#pullrequestreview-522794217", "createdAt": "2020-11-03T19:02:38Z", "commit": {"oid": "1acef42b5d8f3def272a6c3bdd183bbf834d9878"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4987, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}