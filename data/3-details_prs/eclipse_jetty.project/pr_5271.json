{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MzcxMTg2", "number": 5271, "title": "Issue #5022 Filter Cache cleanup", "bodyText": "Issue #5022 Filter Cache cleanup:\n\nFixed many compiler warnings\nremoved old LazyList leftovers\nDon't create holder string for source unless required\nOnly have a single type of chain, so it can be wrapped regardless of cache\nReverse mappings lists to make filter chain creation easier\nbuild chain directly rather than build a list then a chain\n\nSigned-off-by: Greg Wilkins gregw@webtide.com", "createdAt": "2020-09-15T15:15:57Z", "url": "https://github.com/eclipse/jetty.project/pull/5271", "merged": true, "mergeCommit": {"oid": "c40b955e09f9cecc3c9048aecedda34a144def5e"}, "closed": true, "closedAt": "2020-10-05T11:29:12Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJJUasAH2gAyNDg3MzcxMTg2OmQyMWVkZmNkZGMyNzZlZjE1OGQ3ZTQ0YjBhZGVhZDYxZGM2ZmI1M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNqzOggH2gAyNDg3MzcxMTg2OjFjZWNmZWFlNWEwYjEwNzBhNjhjMmI1NDEyNDZlZGQ3YjZmZjRjOGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d21edfcddc276ef158d7e44b0adead61dc6fb53d", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/d21edfcddc276ef158d7e44b0adead61dc6fb53d", "committedDate": "2020-09-15T15:14:00Z", "message": "Issue #5022 Filter Cache cleanup\n\nIssue #5022 Filter Cache cleanup:\n + Fixed many compiler warnings\n + removed old LazyList leftovers\n + Don't create holder string for source unless required\n + Only have a single type of chain, so it can be wrapped regardless of cache\n + Reverse mappings lists to make filter chain creation easier\n + build chain directly rather than build a list then a chain\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODIxODA2", "url": "https://github.com/eclipse/jetty.project/pull/5271#pullrequestreview-488821806", "createdAt": "2020-09-15T15:45:10Z", "commit": {"oid": "d21edfcddc276ef158d7e44b0adead61dc6fb53d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo0NToxMVrOHSISaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo0NToxMVrOHSISaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3MjIwMQ==", "bodyText": "The Servlet Spec requires that the first filters in the chain are the url style mappings, and then the servlet name mappings. This does it the other way around, doesn't it?", "url": "https://github.com/eclipse/jetty.project/pull/5271#discussion_r488772201", "createdAt": "2020-09-15T15:45:11Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -591,69 +592,69 @@ public void doHandle(String target, Request baseRequest, HttpServletRequest requ\n             return _servletPathMap.getMatch(target);\n         }\n \n-        if (_servletNameMap == null)\n-            return null;\n         ServletHolder holder = _servletNameMap.get(target);\n         if (holder == null)\n             return null;\n         return new MappedResource<>(null, holder);\n     }\n \n+    private FilterChain linkFilterChain(ServletHolder servletHolder, FilterHolder filterHolder, FilterChain chain)\n+    {\n+        if (chain == null)\n+            chain = new ServletFilterChain(servletHolder);\n+        FilterChain next = newFilterChain(filterHolder.getFilter(), chain);\n+        return filterHolder.isAsyncSupported() ? next : new NotAsyncFilterChain(filterHolder, chain);\n+    }\n+\n+    /**\n+     * Create a FilterChain that calls the passed filter with the passed chain\n+     * @param filter The filter to invoke\n+     * @param chain The chain to pass to the filter\n+     * @return A FilterChain that invokes the filter with the chain\n+     */\n+    protected FilterChain newFilterChain(Filter filter, FilterChain chain)\n+    {\n+        return new Chain(filter, chain);\n+    }\n+\n     protected FilterChain getFilterChain(Request baseRequest, String pathInContext, ServletHolder servletHolder)\n     {\n         String key = pathInContext == null ? servletHolder.getName() : pathInContext;\n         int dispatch = FilterMapping.dispatch(baseRequest.getDispatcherType());\n \n-        if (_filterChainsCached && _chainCache != null)\n+        if (_filterChainsCached)\n         {\n             FilterChain chain = _chainCache[dispatch].get(key);\n             if (chain != null)\n                 return chain;\n         }\n \n-        // Build list of filters (list of FilterHolder objects)\n-        List<FilterHolder> filters = new ArrayList<>();\n-\n-        // Path filters\n-        if (pathInContext != null && _filterPathMappings != null)\n-        {\n-            for (FilterMapping filterPathMapping : _filterPathMappings)\n-            {\n-                if (filterPathMapping.appliesTo(pathInContext, dispatch))\n-                    filters.add(filterPathMapping.getFilterHolder());\n-            }\n-        }\n+        FilterChain chain = null;\n \n-        // Servlet name filters\n         if (servletHolder != null && _filterNameMappings != null && !_filterNameMappings.isEmpty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d21edfcddc276ef158d7e44b0adead61dc6fb53d"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "006659c336b1f1faf793883509d4c1921d49fcab", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/006659c336b1f1faf793883509d4c1921d49fcab", "committedDate": "2020-09-15T18:51:47Z", "message": "added comment to explain ordering\n\nSigned-off-by: gregw <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b9925a0f68a287d468a1f82e8c7ba9688ae317", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/52b9925a0f68a287d468a1f82e8c7ba9688ae317", "committedDate": "2020-09-15T20:03:17Z", "message": "More cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25a1f9afdced1b6479e46ddc4ac927b1e130cab2", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/25a1f9afdced1b6479e46ddc4ac927b1e130cab2", "committedDate": "2020-09-16T14:06:52Z", "message": "fixed toString format\nturn off debug in OSGI test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Nzg2NTY2", "url": "https://github.com/eclipse/jetty.project/pull/5271#pullrequestreview-489786566", "createdAt": "2020-09-16T16:12:58Z", "commit": {"oid": "25a1f9afdced1b6479e46ddc4ac927b1e130cab2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d476e53cd9542f1ae0a211dc9e41216bf868d69", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/4d476e53cd9542f1ae0a211dc9e41216bf868d69", "committedDate": "2020-09-22T09:47:45Z", "message": "Merge branch 'jetty-9.4.x' into jetty-9.4.x-5022-FilterChainCleanup\n\n# Conflicts:\n#\tjetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java\n#\tjetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cecfeae5a0b1070a68c2b541246edd7b6ff4c8a", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/1cecfeae5a0b1070a68c2b541246edd7b6ff4c8a", "committedDate": "2020-09-29T16:30:13Z", "message": "Merge branch 'jetty-9.4.x' into jetty-9.4.x-5022-FilterChainCleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 341, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}