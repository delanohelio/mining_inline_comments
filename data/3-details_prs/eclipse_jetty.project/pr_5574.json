{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1ODMyNDMx", "number": 5574, "title": "Issue #5499 - Reduce buffer allocations and copying from ByteAccumulator", "bodyText": "Issue #5499\n\nAdd utility classes to jetty-io, ByteBufferOutputStream2 and ByteBufferAccumulator.\nImplement ByteAccumulator with the ByteBufferAccumulator and make it AutoCloseable.\nAdd getBuffer method to ByteAccumulator, allowing you to write directly to the internal buffer instead of copying.", "createdAt": "2020-11-05T06:36:36Z", "url": "https://github.com/eclipse/jetty.project/pull/5574", "merged": true, "mergeCommit": {"oid": "05ac060d7a6050ae3837e54e7e47b37cd9c527f6"}, "closed": true, "closedAt": "2020-12-15T09:43:35Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpEfDAH2gAyNTE1ODMyNDMxOjFmNWI0NDY0NjI5NDRhN2EwZDM2MDUzYzA5NzcwNzc0YjY0MGE5Y2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmTyMrgH2gAyNTE1ODMyNDMxOjQxY2ZmYTBiYzRkYzI2ZWMzMTVkMWEwYmFhNTk2OWYxODc2OGQzYjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f5b446462944a7a0d36053c09770774b640a9cc", "author": {"user": {"login": "leonchen83", "name": "Baoyi Chen"}}, "url": "https://github.com/eclipse/jetty.project/commit/1f5b446462944a7a0d36053c09770774b640a9cc", "committedDate": "2020-10-30T16:08:30Z", "message": "Fix issue #5499\n\nthis PR let the ByteAccumulator recyclable. after invoke ByteAccumulator.transferTo method\nwe can invoke ByteAccumulator.recycle method to reuse byte[] via ByteAccumulator.newByteBuffer method\n\nSigned-off-by: Baoyi Chen <chen.bao.yi@qq.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05dafb89ab5eb6dc961d3bc0ae84682b560289cd", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/05dafb89ab5eb6dc961d3bc0ae84682b560289cd", "committedDate": "2020-11-05T02:42:47Z", "message": "Move work on ByteAccumulator to jetty-util\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "145bcff64916420dd5e02722dbaf48dc77e93786", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/145bcff64916420dd5e02722dbaf48dc77e93786", "committedDate": "2020-11-05T02:43:00Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-ByteAccumulator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3c3e24cab543ab501ec1267015326fb2de63adb", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a3c3e24cab543ab501ec1267015326fb2de63adb", "committedDate": "2020-11-05T03:38:19Z", "message": "Use the ByteBufferPool in the ByteAccumulator\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bcae9968b562926f1037b213ee5dbe42b858775", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7bcae9968b562926f1037b213ee5dbe42b858775", "committedDate": "2020-11-05T06:19:05Z", "message": "allow writing directly into the ByteAccumulator\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/6e9572215b30df8e00cb52238b3703f699819523", "committedDate": "2020-11-05T08:11:34Z", "message": "ByteAccumulator transferTo expects buffer in fill mode.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDE2ODU4", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-524016858", "createdAt": "2020-11-05T08:23:05Z", "commit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODoyMzowNVrOHt4B-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo0MDo0N1rOHt4ruw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NTk3OA==", "bodyText": "Can you call this nextBuffer or ensureBuffer or something not get to try to make it clear that you are accessing a buffer that is held and managed by the accumulator", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517865978", "createdAt": "2020-11-05T08:23:05Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NzEwMw==", "bodyText": "Why is the while needed here?  Wont the getBuffer always return a buffer with enough space to put the passed buffer into?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517867103", "createdAt": "2020-11-05T08:25:01Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())\n+        {\n+            ByteBuffer b = getBuffer(buffer.remaining());\n+            int pos = BufferUtil.flipToFill(b);\n+            BufferUtil.put(buffer, b);\n+            BufferUtil.flipToFlush(b, pos);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MDEyNA==", "bodyText": "Perhaps also have a method ByteBuffer takeBuffer() which can take a single buffer from the pool with all the contents. This could be the the originally allocated one if _buffers.size()==1, or a newly allocated one.\n... but only add this method if you can find a use for it.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517870124", "createdAt": "2020-11-05T08:30:03Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())\n+        {\n+            ByteBuffer b = getBuffer(buffer.remaining());\n+            int pos = BufferUtil.flipToFill(b);\n+            BufferUtil.put(buffer, b);\n+            BufferUtil.flipToFlush(b, pos);\n+        }\n+    }\n+\n+    public void writeTo(ByteBuffer buffer)\n+    {\n+        int pos = BufferUtil.flipToFill(buffer);\n+        for (ByteBuffer bb : _buffers)\n+        {\n+            buffer.put(bb);\n+        }\n+        BufferUtil.flipToFlush(buffer, pos);\n+    }\n+\n+    public void writeTo(OutputStream out) throws IOException\n+    {\n+        for (ByteBuffer bb : _buffers)\n+        {\n+            BufferUtil.writeTo(bb, out);\n+        }\n+    }\n+\n+    @Override\n+    public void close()\n+    {\n+        for (ByteBuffer buffer : _buffers)\n+        {\n+            _bufferPool.release(buffer);\n+        }\n+        _buffers.clear();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MTIzNQ==", "bodyText": "this could be a use for ByteAccumulator.takeByteBuffer.\nNote that I prefer using take  rather than to if the caller becomes responsible for releasing the returned buffer", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517871235", "createdAt": "2020-11-05T08:31:49Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MTc2NQ==", "bodyText": "Is there really a need to remember the combined ByteBuffer?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517871765", "createdAt": "2020-11-05T08:32:42Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MjAxMA==", "bodyText": "Is while loop needed?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517872010", "createdAt": "2020-11-05T08:33:09Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return BufferUtil.EMPTY_BUFFER;\n+\n+        if (_combinedByteBuffer != null && length == _combinedByteBuffer.remaining())\n+            return _combinedByteBuffer;\n+\n+        ByteBuffer buffer = _bufferPool.acquire(_size, false);\n+        _accumulator.writeTo(buffer);\n+        if (_combinedByteBuffer != null)\n+        {\n+            _bufferPool.release(_combinedByteBuffer);\n+            _combinedByteBuffer = buffer;\n+        }\n+\n+        return buffer;\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a byte array.\n+     * @return the content in a byte array.\n+     */\n+    public byte[] toByteArray()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return new byte[0];\n+\n+        byte[] bytes = new byte[_size];\n+        ByteBuffer buffer = BufferUtil.toBuffer(bytes);\n+        _accumulator.writeTo(buffer);\n+        return bytes;\n+    }\n+\n+    public int size()\n+    {\n+        return _accumulator.getLength();\n+    }\n+\n+    @Override\n+    public void write(int b)\n+    {\n+        write(new byte[]{(byte)b}, 0, 1);\n+    }\n+\n+    @Override\n+    public void write(byte[] b, int off, int len)\n+    {\n+        write(BufferUtil.toBuffer(b, off, len));\n+    }\n+\n+    public void write(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MjQ3Mw==", "bodyText": "You need to null/release _combinedByteBuffer here or just not have it it.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517872473", "createdAt": "2020-11-05T08:33:50Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return BufferUtil.EMPTY_BUFFER;\n+\n+        if (_combinedByteBuffer != null && length == _combinedByteBuffer.remaining())\n+            return _combinedByteBuffer;\n+\n+        ByteBuffer buffer = _bufferPool.acquire(_size, false);\n+        _accumulator.writeTo(buffer);\n+        if (_combinedByteBuffer != null)\n+        {\n+            _bufferPool.release(_combinedByteBuffer);\n+            _combinedByteBuffer = buffer;\n+        }\n+\n+        return buffer;\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a byte array.\n+     * @return the content in a byte array.\n+     */\n+    public byte[] toByteArray()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return new byte[0];\n+\n+        byte[] bytes = new byte[_size];\n+        ByteBuffer buffer = BufferUtil.toBuffer(bytes);\n+        _accumulator.writeTo(buffer);\n+        return bytes;\n+    }\n+\n+    public int size()\n+    {\n+        return _accumulator.getLength();\n+    }\n+\n+    @Override\n+    public void write(int b)\n+    {\n+        write(new byte[]{(byte)b}, 0, 1);\n+    }\n+\n+    @Override\n+    public void write(byte[] b, int off, int len)\n+    {\n+        write(BufferUtil.toBuffer(b, off, len));\n+    }\n+\n+    public void write(ByteBuffer buffer)\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3NTM0Mw==", "bodyText": "Are the copy methods actually used now?   Isn't the accumulator filled by calling getBuffer and writing directly to that?\nIf we don't need the copy methods then deprecate or remove these methods.\nAlternately leave ByteAccumulator as is and deprecate the whole class.  Instead directly use ByteBufferAccumulator", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517875343", "createdAt": "2020-11-05T08:38:46Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/extensions/compress/ByteAccumulator.java", "diffHunk": "@@ -19,56 +19,77 @@\n package org.eclipse.jetty.websocket.common.extensions.compress;\n \n import java.nio.ByteBuffer;\n-import java.util.ArrayList;\n-import java.util.List;\n \n+import org.eclipse.jetty.io.ByteBufferAccumulator;\n+import org.eclipse.jetty.io.ByteBufferPool;\n import org.eclipse.jetty.util.BufferUtil;\n import org.eclipse.jetty.websocket.api.MessageTooLargeException;\n \n-public class ByteAccumulator\n+public class ByteAccumulator implements AutoCloseable\n {\n-    private final List<byte[]> chunks = new ArrayList<>();\n+    private final ByteBufferAccumulator accumulator;\n     private final int maxSize;\n     private int length = 0;\n \n     public ByteAccumulator(int maxOverallBufferSize)\n     {\n-        this.maxSize = maxOverallBufferSize;\n+        this(maxOverallBufferSize, null);\n     }\n \n-    public void copyChunk(byte[] buf, int offset, int length)\n+    public ByteAccumulator(int maxOverallBufferSize, ByteBufferPool byteBufferPool)\n     {\n-        if (this.length + length > maxSize)\n-        {\n-            String err = String.format(\"Resulting message size [%,d] is too large for configured max of [%,d]\", this.length + length, maxSize);\n-            throw new MessageTooLargeException(err);\n-        }\n+        this.maxSize = maxOverallBufferSize;\n+        this.accumulator = new ByteBufferAccumulator(byteBufferPool);\n+    }\n \n-        byte[] copy = new byte[length - offset];\n-        System.arraycopy(buf, offset, copy, 0, length);\n+    public int getLength()\n+    {\n+        return accumulator.getLength();\n+    }\n \n-        chunks.add(copy);\n-        this.length += length;\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        return accumulator.getBuffer(minAllocationSize);\n     }\n \n-    public int getLength()\n+    public void copyChunk(byte[] buf, int offset, int length)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3NjY2Nw==", "bodyText": "Do we really need these copy methods?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r517876667", "createdAt": "2020-11-05T08:40:47Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzU1MTQ4", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-524755148", "createdAt": "2020-11-05T23:35:23Z", "commit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMzozNToyM1rOHuawpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMzozOToxMFrOHua1Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNDk4Mw==", "bodyText": "This should have a min size that it will go to. Say we have a buffer with 10 bytes remaining, we probably don't want to requesting a buffer that small.\nSomething like:\nbuffer = _bufferPool.acquire(Math.max(minAllocationSize, 1024), false);", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518434983", "createdAt": "2020-11-05T23:35:23Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNTAyNg==", "bodyText": "No, the buffer may have space left over from the previous write. In that case this space will be filled first before allocating a new buffer.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518435026", "createdAt": "2020-11-05T23:35:32Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 3;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer getBuffer()\n+    {\n+        return getBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())\n+        {\n+            ByteBuffer b = getBuffer(buffer.remaining());\n+            int pos = BufferUtil.flipToFill(b);\n+            BufferUtil.put(buffer, b);\n+            BufferUtil.flipToFlush(b, pos);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NzEwMw=="}, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNTQyMg==", "bodyText": "We need to remember it so that we release it when close() is called.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518435422", "createdAt": "2020-11-05T23:36:41Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MTc2NQ=="}, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNTQ5Mw==", "bodyText": "Right now it is not the responsibility of the caller to release this buffer, it is released on close().", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518435493", "createdAt": "2020-11-05T23:36:54Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MTIzNQ=="}, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNTUyNQ==", "bodyText": "It is needed because you could get a buffer from the _accumulator which does not have enough remaining space to fill all the content. The second call to getBuffer will then allocate a new buffer.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518435525", "createdAt": "2020-11-05T23:37:01Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,144 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return BufferUtil.EMPTY_BUFFER;\n+\n+        if (_combinedByteBuffer != null && length == _combinedByteBuffer.remaining())\n+            return _combinedByteBuffer;\n+\n+        ByteBuffer buffer = _bufferPool.acquire(_size, false);\n+        _accumulator.writeTo(buffer);\n+        if (_combinedByteBuffer != null)\n+        {\n+            _bufferPool.release(_combinedByteBuffer);\n+            _combinedByteBuffer = buffer;\n+        }\n+\n+        return buffer;\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a byte array.\n+     * @return the content in a byte array.\n+     */\n+    public byte[] toByteArray()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return new byte[0];\n+\n+        byte[] bytes = new byte[_size];\n+        ByteBuffer buffer = BufferUtil.toBuffer(bytes);\n+        _accumulator.writeTo(buffer);\n+        return bytes;\n+    }\n+\n+    public int size()\n+    {\n+        return _accumulator.getLength();\n+    }\n+\n+    @Override\n+    public void write(int b)\n+    {\n+        write(new byte[]{(byte)b}, 0, 1);\n+    }\n+\n+    @Override\n+    public void write(byte[] b, int off, int len)\n+    {\n+        write(BufferUtil.toBuffer(b, off, len));\n+    }\n+\n+    public void write(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3MjAxMA=="}, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNjE2Mw==", "bodyText": "I think we need to maintain the ByteAccumulator to not break anyone. I have tried to only add new methods and not change the signatures of existing ones. So these copy methods stay.\nI will deprecate the whole class.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518436163", "createdAt": "2020-11-05T23:39:10Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/extensions/compress/ByteAccumulator.java", "diffHunk": "@@ -19,56 +19,77 @@\n package org.eclipse.jetty.websocket.common.extensions.compress;\n \n import java.nio.ByteBuffer;\n-import java.util.ArrayList;\n-import java.util.List;\n \n+import org.eclipse.jetty.io.ByteBufferAccumulator;\n+import org.eclipse.jetty.io.ByteBufferPool;\n import org.eclipse.jetty.util.BufferUtil;\n import org.eclipse.jetty.websocket.api.MessageTooLargeException;\n \n-public class ByteAccumulator\n+public class ByteAccumulator implements AutoCloseable\n {\n-    private final List<byte[]> chunks = new ArrayList<>();\n+    private final ByteBufferAccumulator accumulator;\n     private final int maxSize;\n     private int length = 0;\n \n     public ByteAccumulator(int maxOverallBufferSize)\n     {\n-        this.maxSize = maxOverallBufferSize;\n+        this(maxOverallBufferSize, null);\n     }\n \n-    public void copyChunk(byte[] buf, int offset, int length)\n+    public ByteAccumulator(int maxOverallBufferSize, ByteBufferPool byteBufferPool)\n     {\n-        if (this.length + length > maxSize)\n-        {\n-            String err = String.format(\"Resulting message size [%,d] is too large for configured max of [%,d]\", this.length + length, maxSize);\n-            throw new MessageTooLargeException(err);\n-        }\n+        this.maxSize = maxOverallBufferSize;\n+        this.accumulator = new ByteBufferAccumulator(byteBufferPool);\n+    }\n \n-        byte[] copy = new byte[length - offset];\n-        System.arraycopy(buf, offset, copy, 0, length);\n+    public int getLength()\n+    {\n+        return accumulator.getLength();\n+    }\n \n-        chunks.add(copy);\n-        this.length += length;\n+    public ByteBuffer getBuffer(int minAllocationSize)\n+    {\n+        return accumulator.getBuffer(minAllocationSize);\n     }\n \n-    public int getLength()\n+    public void copyChunk(byte[] buf, int offset, int length)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg3NTM0Mw=="}, "originalCommit": {"oid": "6e9572215b30df8e00cb52238b3703f699819523"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c44df0724150c1247702fadee1b9fc5045f9975", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/3c44df0724150c1247702fadee1b9fc5045f9975", "committedDate": "2020-11-06T03:09:13Z", "message": "changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543", "committedDate": "2020-11-06T07:52:11Z", "message": "adjust minimum space in ByteBufferAccumulator before buffer allocation\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTMxMDUy", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-524931052", "createdAt": "2020-11-06T08:09:45Z", "commit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODowOTo0NVrOHuj3Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODowOTo0NVrOHuj3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NDExNQ==", "bodyText": "So I was confused by the signature. So how about this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ByteBuffer ensureBuffer(int minAllocationSize)\n          \n          \n            \n                public ByteBuffer ensureBuffer(int minCapacity, int minAllicationSize)\n          \n      \n    \n    \n  \n\nSo you pass in both the minim capacity and the size that you'd like to allocate at", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518584115", "createdAt": "2020-11-06T08:09:45Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 8;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer ensureBuffer()\n+    {\n+        return ensureBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer ensureBuffer(int minAllocationSize)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTMxNDMx", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-524931431", "createdAt": "2020-11-06T08:10:22Z", "commit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMDoyMlrOHuj4Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMDoyMlrOHuj4Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NDQwMw==", "bodyText": "Not sure that you need to do this as the pool implementations already quantise and roundup capacity.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518584403", "createdAt": "2020-11-06T08:10:22Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private static final int MIN_SPACE = 8;\n+    private static final int DEFAULT_BUFFER_SIZE = 1024;\n+\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer ensureBuffer()\n+    {\n+        return ensureBuffer(DEFAULT_BUFFER_SIZE);\n+    }\n+\n+    public ByteBuffer ensureBuffer(int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= MIN_SPACE)\n+        {\n+            buffer = _bufferPool.acquire(Math.max(DEFAULT_BUFFER_SIZE, minAllocationSize), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTMzMDI2", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-524933026", "createdAt": "2020-11-06T08:13:07Z", "commit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMzowN1rOHuj9Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoxMzowN1rOHuj9Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NTYxNA==", "bodyText": "How could the combined buffer ever have the wrong length?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r518585614", "createdAt": "2020-11-06T08:13:07Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,149 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private ByteBuffer _combinedByteBuffer;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()\n+    {\n+        int length = _accumulator.getLength();\n+        if (length == 0)\n+            return BufferUtil.EMPTY_BUFFER;\n+\n+        if (_combinedByteBuffer != null && length == _combinedByteBuffer.remaining())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dc0d9932d7e73170b80daa6a3fa06ce9ab2e543"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/595d4bfcc422c5965e55a8146d7bc87842dafe8e", "committedDate": "2020-11-11T11:18:26Z", "message": "changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTUxOTE1", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-528151915", "createdAt": "2020-11-11T13:02:58Z", "commit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMzowMjo1OVrOHxMP1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMzowNjo1MFrOHxMYRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MjkzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ByteBuffer takeByteBuffer()\n          \n          \n            \n                {\n          \n          \n            \n                    int length = getLength();\n          \n          \n            \n                    ByteBuffer combinedBuffer = _bufferPool.acquire(length, false);\n          \n          \n            \n                    for (ByteBuffer buffer : _buffers)\n          \n          \n            \n                    {\n          \n          \n            \n                        combinedBuffer.put(buffer);\n          \n          \n            \n                    }\n          \n          \n            \n                    return combinedBuffer;\n          \n          \n            \n                }\n          \n          \n            \n                public ByteBuffer takeByteBuffer()\n          \n          \n            \n                {\n          \n          \n            \n                    int length = getLength();\n          \n          \n            \n                    switch(length)\n          \n          \n            \n                    {\n          \n          \n            \n                        case 0:\n          \n          \n            \n                            return null; // TODO or empty buffer from pool?\n          \n          \n            \n                        case 1:\n          \n          \n            \n                            return _buffers.remove(0);\n          \n          \n            \n                        default:\n          \n          \n            \n                    \u00a0       ByteBuffer combinedBuffer = _bufferPool.acquire(length, false);\n          \n          \n            \n                    \u00a0       for (ByteBuffer buffer : _buffers)\n          \n          \n            \n                    \u00a0       {\n          \n          \n            \n                        \u00a0       combinedBuffer.put(buffer);\n          \n          \n            \n                        \u00a0       _bufferPool.release(buffer);\n          \n          \n            \n                    \u00a0       }\n          \n          \n            \n                    \u00a0       _buffers.clear();\n          \n          \n            \n                   \u00a0        return combinedBuffer;\n          \n          \n            \n                   \u00a0}\n          \n          \n            \n                }", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r521342934", "createdAt": "2020-11-11T13:02:59Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,138 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer ensureBuffer(int minSize, int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= minSize)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())\n+        {\n+            ByteBuffer b = ensureBuffer(0, buffer.remaining());\n+            int pos = BufferUtil.flipToFill(b);\n+            BufferUtil.put(buffer, b);\n+            BufferUtil.flipToFlush(b, pos);\n+        }\n+    }\n+\n+    public ByteBuffer takeByteBuffer()\n+    {\n+        int length = getLength();\n+        ByteBuffer combinedBuffer = _bufferPool.acquire(length, false);\n+        for (ByteBuffer buffer : _buffers)\n+        {\n+            combinedBuffer.put(buffer);\n+        }\n+        return combinedBuffer;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MzI5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _buffers.forEach(_bufferPool::release);\n          \n          \n            \n                    _buffers.clear();", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r521343292", "createdAt": "2020-11-11T13:03:42Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,138 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBuffer ensureBuffer(int minSize, int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) <= minSize)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);\n+            _buffers.add(buffer);\n+        }\n+\n+        return buffer;\n+    }\n+\n+    public void copyBytes(byte[] buf, int offset, int length)\n+    {\n+        copyBuffer(BufferUtil.toBuffer(buf, offset, length));\n+    }\n+\n+    public void copyBuffer(ByteBuffer buffer)\n+    {\n+        while (buffer.hasRemaining())\n+        {\n+            ByteBuffer b = ensureBuffer(0, buffer.remaining());\n+            int pos = BufferUtil.flipToFill(b);\n+            BufferUtil.put(buffer, b);\n+            BufferUtil.flipToFlush(b, pos);\n+        }\n+    }\n+\n+    public ByteBuffer takeByteBuffer()\n+    {\n+        int length = getLength();\n+        ByteBuffer combinedBuffer = _bufferPool.acquire(length, false);\n+        for (ByteBuffer buffer : _buffers)\n+        {\n+            combinedBuffer.put(buffer);\n+        }\n+        return combinedBuffer;\n+    }\n+\n+    public ByteBuffer toByteBuffer()\n+    {\n+        if (_buffers.size() == 1)\n+            return _buffers.get(0);\n+\n+        ByteBuffer combinedBuffer = takeByteBuffer();\n+        _buffers.forEach(_bufferPool::release);\n+        _buffers.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0NDE1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final ByteBufferPool _bufferPool;", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r521344151", "createdAt": "2020-11-11T13:05:08Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,114 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0NDY2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n          \n          \n            \n                    _accumulator = new ByteBufferAccumulator(bufferPool);\n          \n          \n            \n                    _accumulator = new ByteBufferAccumulator((bufferPool == null) ? new NullByteBufferPool() : bufferPool);", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r521344660", "createdAt": "2020-11-11T13:06:04Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,114 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0NTA5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ByteBuffer toByteBuffer()\n          \n          \n            \n                {\n          \n          \n            \n                    return _accumulator.toByteBuffer();\n          \n          \n            \n                }\n          \n          \n            \n                public ByteBuffer toByteBuffer()\n          \n          \n            \n                {\n          \n          \n            \n                    return _accumulator.toByteBuffer();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public ByteBuffer takeByteBuffer()\n          \n          \n            \n                {\n          \n          \n            \n                    return _accumulator.takeByteBuffer();\n          \n          \n            \n                }", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r521345093", "createdAt": "2020-11-11T13:06:50Z", "author": {"login": "gregw"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferOutputStream2.java", "diffHunk": "@@ -0,0 +1,114 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+\n+/**\n+ * This class implements an output stream in which the data is written into a list of ByteBuffer,\n+ * the buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * Designed to mimic {@link java.io.ByteArrayOutputStream} but with better memory usage, and less copying.\n+ */\n+public class ByteBufferOutputStream2 extends OutputStream\n+{\n+    private final ByteBufferAccumulator _accumulator;\n+    private final ByteBufferPool _bufferPool;\n+    private int _size = 0;\n+\n+    public ByteBufferOutputStream2()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferOutputStream2(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+        _accumulator = new ByteBufferAccumulator(bufferPool);\n+    }\n+\n+    /**\n+     * Get an aggregated content written to the OutputStream in a ByteBuffer.\n+     * @return the content in a ByteBuffer.\n+     */\n+    public ByteBuffer toByteBuffer()\n+    {\n+        return _accumulator.toByteBuffer();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595d4bfcc422c5965e55a8146d7bc87842dafe8e"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d75e6de1b27d72a6ddd8d75759a1deefa76b75b9", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d75e6de1b27d72a6ddd8d75759a1deefa76b75b9", "committedDate": "2020-11-11T21:48:50Z", "message": "add takeByteBuffer method to ByteBufferOutputStream2\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0031e0585c4c464cc12d285c2c41f2d0e6ec9ea", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/e0031e0585c4c464cc12d285c2c41f2d0e6ec9ea", "committedDate": "2020-11-12T22:22:57Z", "message": "Issue #5499 - takeBuffer releases all the buffers in the list\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7bed39239e6e4b8309803a14fa0702380d65bd9", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/e7bed39239e6e4b8309803a14fa0702380d65bd9", "committedDate": "2020-11-12T22:56:32Z", "message": "Issue #5499 - add javadoc for ByteBufferAccumulator\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1aa5dcd14c77f7ccb15cd2dbe8ce21e18b5cb7f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a1aa5dcd14c77f7ccb15cd2dbe8ce21e18b5cb7f", "committedDate": "2020-11-16T07:33:38Z", "message": "Issue #5499 - use ByteBufferAccumulator for websocket compression\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5788fe609dae59ca82dfc21489f41e5bba3add40", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/5788fe609dae59ca82dfc21489f41e5bba3add40", "committedDate": "2020-11-16T07:43:22Z", "message": "Fix ByteBufferAccumulator minSize\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c46d96fcea0a1f6c328f472916a39875786b89b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7c46d96fcea0a1f6c328f472916a39875786b89b", "committedDate": "2020-11-17T06:11:47Z", "message": "Issue #5499 - add tests for ByteBufferAccumulator\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTkzMzAx", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-532193301", "createdAt": "2020-11-17T09:53:50Z", "commit": {"oid": "7c46d96fcea0a1f6c328f472916a39875786b89b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTo1Mzo1MFrOH0s4lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTo1Mzo1MFrOH0s4lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAyMzM4Mw==", "bodyText": "you have both a length field and getLength method on the accumulator.  Use one or the other.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r525023383", "createdAt": "2020-11-17T09:53:50Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/extensions/compress/ByteAccumulator.java", "diffHunk": "@@ -19,56 +19,92 @@\n package org.eclipse.jetty.websocket.common.extensions.compress;\n \n import java.nio.ByteBuffer;\n-import java.util.ArrayList;\n-import java.util.List;\n \n+import org.eclipse.jetty.io.ByteBufferAccumulator;\n+import org.eclipse.jetty.io.ByteBufferPool;\n import org.eclipse.jetty.util.BufferUtil;\n import org.eclipse.jetty.websocket.api.MessageTooLargeException;\n \n-public class ByteAccumulator\n+/**\n+ * @deprecated use {@link ByteBufferAccumulator} instead.\n+ */\n+@Deprecated\n+public class ByteAccumulator implements AutoCloseable\n {\n-    private final List<byte[]> chunks = new ArrayList<>();\n+    private static final int MIN_SPACE = 8;\n+\n+    private final ByteBufferAccumulator accumulator;\n     private final int maxSize;\n     private int length = 0;\n \n     public ByteAccumulator(int maxOverallBufferSize)\n+    {\n+        this(maxOverallBufferSize, null);\n+    }\n+\n+    public ByteAccumulator(int maxOverallBufferSize, ByteBufferPool byteBufferPool)\n     {\n         this.maxSize = maxOverallBufferSize;\n+        this.accumulator = new ByteBufferAccumulator(byteBufferPool);\n     }\n \n-    public void copyChunk(byte[] buf, int offset, int length)\n+    public int getLength()\n     {\n-        if (this.length + length > maxSize)\n+        return accumulator.getLength();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c46d96fcea0a1f6c328f472916a39875786b89b"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f63a741b0f0131300fb5d8e1e040e1c74a73c059", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f63a741b0f0131300fb5d8e1e040e1c74a73c059", "committedDate": "2020-11-17T10:16:38Z", "message": "use local length field for ByteAccumulator.getLength()\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2629845f173a8e14f287a393d17192685a229eb6", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2629845f173a8e14f287a393d17192685a229eb6", "committedDate": "2020-11-17T11:16:35Z", "message": "update ByteAccumulator length on copies\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjg5MTk1", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-540689195", "createdAt": "2020-11-30T08:34:57Z", "commit": {"oid": "2629845f173a8e14f287a393d17192685a229eb6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODozNDo1N1rOH7wdyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODo0OToxNlrOH7w9hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQyMjA5MQ==", "bodyText": "Hardcoding non-direct buffer type maybe isn't that wise. How about making that boolean a constructor parameter?", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r532422091", "createdAt": "2020-11-30T08:34:57Z", "author": {"login": "lorban"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,199 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * Accumulates data into a list of ByteBuffers which can then be combined into a single buffer or written to an OutputStream.\n+ * The buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * The method {@link #ensureBuffer(int, int)} is used to write directly to the last buffer stored in the buffer list,\n+ * if there is less than a certain amount of space available in that buffer then a new one will be allocated and returned instead.\n+ * @see #ensureBuffer(int, int)\n+ */\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    /**\n+     * Get the amount of bytes which have been accumulated.\n+     * This will add up the remaining of each buffer in the accumulator.\n+     * @return the total length of the content in the accumulator.\n+     */\n+    public int getLength()\n+    {\n+        int length = 0;\n+        for (ByteBuffer buffer : _buffers)\n+            length += buffer.remaining();\n+        return length;\n+    }\n+\n+    public ByteBufferPool getByteBufferPool()\n+    {\n+        return _bufferPool;\n+    }\n+\n+    /**\n+     * Get the last buffer of the accumulator, this can be written to directly to avoid copying into the accumulator.\n+     * @param minAllocationSize new buffers will be allocated to have at least this size.\n+     * @return a buffer with at least {@code minSize} space to write into.\n+     */\n+    public ByteBuffer ensureBuffer(int minAllocationSize)\n+    {\n+        return ensureBuffer(1, minAllocationSize);\n+    }\n+\n+    /**\n+     * Get the last buffer of the accumulator, this can be written to directly to avoid copying into the accumulator.\n+     * @param minSize the smallest amount of remaining space before a new buffer is allocated.\n+     * @param minAllocationSize new buffers will be allocated to have at least this size.\n+     * @return a buffer with at least {@code minSize} space to write into.\n+     */\n+    public ByteBuffer ensureBuffer(int minSize, int minAllocationSize)\n+    {\n+        ByteBuffer buffer = _buffers.isEmpty() ? BufferUtil.EMPTY_BUFFER : _buffers.get(_buffers.size() - 1);\n+        if (BufferUtil.space(buffer) < minSize)\n+        {\n+            buffer = _bufferPool.acquire(minAllocationSize, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2629845f173a8e14f287a393d17192685a229eb6"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzMDIxNA==", "bodyText": "This length accumulation could potentially overflow Integer.MAX_VALUE. We should handle this by either returning a long from here, or detecting the integer overflow and throwing an exception.", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r532430214", "createdAt": "2020-11-30T08:49:16Z", "author": {"login": "lorban"}, "path": "jetty-io/src/main/java/org/eclipse/jetty/io/ByteBufferAccumulator.java", "diffHunk": "@@ -0,0 +1,199 @@\n+//\n+//  ========================================================================\n+//  Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//  ------------------------------------------------------------------------\n+//  All rights reserved. This program and the accompanying materials\n+//  are made available under the terms of the Eclipse Public License v1.0\n+//  and Apache License v2.0 which accompanies this distribution.\n+//\n+//      The Eclipse Public License is available at\n+//      http://www.eclipse.org/legal/epl-v10.html\n+//\n+//      The Apache License v2.0 is available at\n+//      http://www.opensource.org/licenses/apache2.0.php\n+//\n+//  You may elect to redistribute this code under either of these licenses.\n+//  ========================================================================\n+//\n+\n+package org.eclipse.jetty.io;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jetty.util.BufferUtil;\n+\n+/**\n+ * Accumulates data into a list of ByteBuffers which can then be combined into a single buffer or written to an OutputStream.\n+ * The buffer list automatically grows as data is written to it, the buffers are taken from the\n+ * supplied {@link ByteBufferPool} or freshly allocated if one is not supplied.\n+ *\n+ * The method {@link #ensureBuffer(int, int)} is used to write directly to the last buffer stored in the buffer list,\n+ * if there is less than a certain amount of space available in that buffer then a new one will be allocated and returned instead.\n+ * @see #ensureBuffer(int, int)\n+ */\n+public class ByteBufferAccumulator implements AutoCloseable\n+{\n+    private final List<ByteBuffer> _buffers = new ArrayList<>();\n+    private final ByteBufferPool _bufferPool;\n+\n+    public ByteBufferAccumulator()\n+    {\n+        this(null);\n+    }\n+\n+    public ByteBufferAccumulator(ByteBufferPool bufferPool)\n+    {\n+        _bufferPool = (bufferPool == null) ? new NullByteBufferPool() : bufferPool;\n+    }\n+\n+    /**\n+     * Get the amount of bytes which have been accumulated.\n+     * This will add up the remaining of each buffer in the accumulator.\n+     * @return the total length of the content in the accumulator.\n+     */\n+    public int getLength()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2629845f173a8e14f287a393d17192685a229eb6"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a51b5db209de7186dcd99d324e230506624a5d6a", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/a51b5db209de7186dcd99d324e230506624a5d6a", "committedDate": "2020-11-30T22:45:45Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-ByteAccumulator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602cd7e5c0b613b17bfa7ca4a8a18874a07a2e6b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/602cd7e5c0b613b17bfa7ca4a8a18874a07a2e6b", "committedDate": "2020-11-30T22:51:09Z", "message": "throw ArithmeticException on integer overflow from size\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dce1cbffd0768bd172108aba2523f0a17f548f0", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/6dce1cbffd0768bd172108aba2523f0a17f548f0", "committedDate": "2020-11-30T23:07:18Z", "message": "Make ByteBufferAccumulator direct configurable\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzk3NjQ2", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-541797646", "createdAt": "2020-12-01T11:18:41Z", "commit": {"oid": "6dce1cbffd0768bd172108aba2523f0a17f548f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aedc50048fa114f964903d61b8b30aeece83463", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/8aedc50048fa114f964903d61b8b30aeece83463", "committedDate": "2020-12-01T13:07:38Z", "message": "fix missing usage of the new _direct field in ByteBufferAccumulator\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNTM1MzUx", "url": "https://github.com/eclipse/jetty.project/pull/5574#pullrequestreview-542535351", "createdAt": "2020-12-02T06:39:01Z", "commit": {"oid": "8aedc50048fa114f964903d61b8b30aeece83463"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwNjozOTowMVrOH9McVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwNjozOTowMVrOH9McVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkyOTA0Ng==", "bodyText": "close() method invoked by DeflateFrameExtension.java#L64\nand PerMessageDeflateExtension.java#L81\ntransferTo method no need add extra close method", "url": "https://github.com/eclipse/jetty.project/pull/5574#discussion_r533929046", "createdAt": "2020-12-02T06:39:01Z", "author": {"login": "leonchen83"}, "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/extensions/compress/ByteAccumulator.java", "diffHunk": "@@ -19,56 +19,92 @@\n package org.eclipse.jetty.websocket.common.extensions.compress;\n \n import java.nio.ByteBuffer;\n-import java.util.ArrayList;\n-import java.util.List;\n \n+import org.eclipse.jetty.io.ByteBufferAccumulator;\n+import org.eclipse.jetty.io.ByteBufferPool;\n import org.eclipse.jetty.util.BufferUtil;\n import org.eclipse.jetty.websocket.api.MessageTooLargeException;\n \n-public class ByteAccumulator\n+/**\n+ * @deprecated use {@link ByteBufferAccumulator} instead.\n+ */\n+@Deprecated\n+public class ByteAccumulator implements AutoCloseable\n {\n-    private final List<byte[]> chunks = new ArrayList<>();\n+    private static final int MIN_SPACE = 8;\n+\n+    private final ByteBufferAccumulator accumulator;\n     private final int maxSize;\n     private int length = 0;\n \n     public ByteAccumulator(int maxOverallBufferSize)\n+    {\n+        this(maxOverallBufferSize, null);\n+    }\n+\n+    public ByteAccumulator(int maxOverallBufferSize, ByteBufferPool byteBufferPool)\n     {\n         this.maxSize = maxOverallBufferSize;\n+        this.accumulator = new ByteBufferAccumulator(byteBufferPool, false);\n     }\n \n-    public void copyChunk(byte[] buf, int offset, int length)\n+    public int getLength()\n     {\n-        if (this.length + length > maxSize)\n+        return length;\n+    }\n+\n+    public ByteBuffer ensureBuffer(int minAllocationSize)\n+    {\n+        return accumulator.ensureBuffer(MIN_SPACE, minAllocationSize);\n+    }\n+\n+    public void addLength(int read)\n+    {\n+        length += read;\n+        if (length > maxSize)\n         {\n-            String err = String.format(\"Resulting message size [%,d] is too large for configured max of [%,d]\", this.length + length, maxSize);\n+            String err = String.format(\"Resulting message size [%d] is too large for configured max of [%d]\", length, maxSize);\n             throw new MessageTooLargeException(err);\n         }\n-\n-        byte[] copy = new byte[length - offset];\n-        System.arraycopy(buf, offset, copy, 0, length);\n-\n-        chunks.add(copy);\n-        this.length += length;\n     }\n \n-    public int getLength()\n+    public void copyChunk(byte[] buf, int offset, int length)\n     {\n-        return length;\n+        copyChunk(BufferUtil.toBuffer(buf, offset, length));\n     }\n \n-    public void transferTo(ByteBuffer buffer)\n+    public void copyChunk(ByteBuffer buffer)\n     {\n-        if (buffer.remaining() < length)\n+        int remaining = buffer.remaining();\n+        if (length + remaining > maxSize)\n         {\n-            throw new IllegalArgumentException(String.format(\"Not enough space in ByteBuffer remaining [%d] for accumulated buffers length [%d]\",\n-                buffer.remaining(), length));\n+            String err = String.format(\"Resulting message size [%d] is too large for configured max of [%d]\", length + remaining, maxSize);\n+            throw new MessageTooLargeException(err);\n         }\n \n-        int position = buffer.position();\n-        for (byte[] chunk : chunks)\n+        length += remaining;\n+        accumulator.copyBuffer(buffer);\n+    }\n+\n+    public void transferTo(ByteBuffer buffer)\n+    {\n+        // For some reason this method expects the buffer in fill mode but returns a buffer in flush mode.\n+        BufferUtil.flipToFlush(buffer, 0);\n+\n+        int availableSpace = BufferUtil.space(buffer);\n+        if (availableSpace < length)\n         {\n-            buffer.put(chunk, 0, chunk.length);\n+            String err = String.format(\"Not enough space in ByteBuffer remaining [%d] for accumulated buffers length [%d]\", availableSpace, length);\n+            throw new IllegalArgumentException(err);\n         }\n-        BufferUtil.flipToFlush(buffer, position);\n+\n+        accumulator.writeTo(buffer);\n+        close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aedc50048fa114f964903d61b8b30aeece83463"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b3cffb49f6efebb62d1e4e91309ebffaf3cb089", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/8b3cffb49f6efebb62d1e4e91309ebffaf3cb089", "committedDate": "2020-12-08T03:34:55Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-ByteAccumulator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41cffa0bc4dc26ec315d1a0baa5969f18768d3b5", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/41cffa0bc4dc26ec315d1a0baa5969f18768d3b5", "committedDate": "2020-12-15T05:49:23Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-ByteAccumulator"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}