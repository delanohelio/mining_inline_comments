{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MjMxODU1", "number": 5045, "title": "Avoid large allocations of temporary buffers in BuferUtil", "bodyText": "Hi, Jetty Maintainers!\nWe have recently noticed that our jetty instances suffer from a large number of young GC pauses. The allocation profiler pointed out that a large number of allocations is occurring in BufferUtil#writeTo.\n\nIn our use-case, we're receiving a large number of WebSocket messages from many connections but most of them are very small, typically tiny keep-alive frames. The change in this PR can help to avoid allocating 4K temporary arrays when only a few bytes need to be copied. This could potentially be optimised even further with a specialised implementation for o.e.j.u.ByteArrayOutputStream2, however, the change won't be as simple.\nAdditionally, I ran o.e.j.u.BufferUtilTest#testWriteToMicrobenchmark with capacity = 1024, iterations = 1000 and it showed a measurable difference in the number of young gc cycles.\nBefore:\n2020-07-15 13:21:50.986:WARN:oeju.BufferUtilTest:main: overall average: 3ms\n\n[0.500s][info   ][gc,heap,exit ] Heap\n[0.500s][info   ][gc,heap,exit ]  garbage-first heap   total 2097152K, used 79872K [0x0000000780000000, 0x0000000800000000)\n[0.500s][info   ][gc,heap,exit ]   region size 1024K, 79 young (80896K), 0 survivors (0K)\n[0.500s][info   ][gc,heap,exit ]  Metaspace       used 12797K, capacity 13316K, committed 13696K, reserved 1060864K\n[0.500s][info   ][gc,heap,exit ]   class space    used 1321K, capacity 1537K, committed 1664K, reserved 1048576K\n\nAfter:\n2020-07-15 13:20:21.798:WARN:oeju.BufferUtilTest:main: overall average: 2ms\n\n[0.497s][info   ][gc,heap,exit ] Heap\n[0.497s][info   ][gc,heap,exit ]  garbage-first heap   total 2097152K, used 50176K [0x0000000780000000, 0x0000000800000000)\n[0.497s][info   ][gc,heap,exit ]   region size 1024K, 50 young (51200K), 0 survivors (0K)\n[0.497s][info   ][gc,heap,exit ]  Metaspace       used 12788K, capacity 13316K, committed 13696K, reserved 1060864K\n[0.497s][info   ][gc,heap,exit ]   class space    used 1321K, capacity 1537K, committed 1664K, reserved 1048576K\n\nAs a reference, previous a similar change was introduced in #4561. I'm also happy to open a separate PR for the 10.0.x branch if it sounds good to you.", "createdAt": "2020-07-15T04:12:59Z", "url": "https://github.com/eclipse/jetty.project/pull/5045", "merged": true, "mergeCommit": {"oid": "6b57654b03c2ca3e8d7c780de17222050c79b9be"}, "closed": true, "closedAt": "2020-07-15T08:07:27Z", "author": {"login": "SerCeMan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1CvrEgH2gAyNDQ5MjMxODU1OjE1NTQ3NjhmZTMxNWU2ZjU2NjUyZTc1MGRiMDkzN2ExNWFhMTkyZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1GC-ggFqTQ0ODcyMTg5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1554768fe315e6f56652e750db0937a15aa192f6", "author": {"user": {"login": "SerCeMan", "name": "Sergey Tselovalnikov"}}, "url": "https://github.com/eclipse/jetty.project/commit/1554768fe315e6f56652e750db0937a15aa192f6", "committedDate": "2020-07-15T04:15:57Z", "message": "Avoid large allocations of tmp buffers in buferutil\n\nSigned-off-by: Sergey Tselovalnikov <sergeicelov@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2f451e1b43726d41b0b7b365ce2db54c2c7bb7b", "author": {"user": {"login": "SerCeMan", "name": "Sergey Tselovalnikov"}}, "url": "https://github.com/eclipse/jetty.project/commit/f2f451e1b43726d41b0b7b365ce2db54c2c7bb7b", "committedDate": "2020-07-15T04:14:25Z", "message": "Avoid large allocations of tmp buffers in buferutil\n\nSigned-off-by: Sergey Tselovalnikov <sergeicelov@gmail.com>"}, "afterCommit": {"oid": "1554768fe315e6f56652e750db0937a15aa192f6", "author": {"user": {"login": "SerCeMan", "name": "Sergey Tselovalnikov"}}, "url": "https://github.com/eclipse/jetty.project/commit/1554768fe315e6f56652e750db0937a15aa192f6", "committedDate": "2020-07-15T04:15:57Z", "message": "Avoid large allocations of tmp buffers in buferutil\n\nSigned-off-by: Sergey Tselovalnikov <sergeicelov@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjYyODg0", "url": "https://github.com/eclipse/jetty.project/pull/5045#pullrequestreview-448662884", "createdAt": "2020-07-15T06:29:33Z", "commit": {"oid": "1554768fe315e6f56652e750db0937a15aa192f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjYzNzg4", "url": "https://github.com/eclipse/jetty.project/pull/5045#pullrequestreview-448663788", "createdAt": "2020-07-15T06:31:30Z", "commit": {"oid": "1554768fe315e6f56652e750db0937a15aa192f6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjozMTozMVrOGxwH1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjozMTozMVrOGxwH1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgyMTg0Ng==", "bodyText": "Actually slight change would be better.  No need to assign the buffer in the loop:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        byte[] bytes = null;\n          \n          \n            \n                        while (buffer.hasRemaining())\n          \n          \n            \n                        {\n          \n          \n            \n                            int byteCountToWrite = Math.min(buffer.remaining(), TEMP_BUFFER_SIZE);\n          \n          \n            \n                            if (bytes == null)\n          \n          \n            \n                                bytes = new byte[byteCountToWrite];\n          \n          \n            \n                        byte[] bytes = new byte[Math.min(buffer.remaining(), TEMP_BUFFER_SIZE)];\n          \n          \n            \n                        while (buffer.hasRemaining())\n          \n          \n            \n                        {", "url": "https://github.com/eclipse/jetty.project/pull/5045#discussion_r454821846", "createdAt": "2020-07-15T06:31:31Z", "author": {"login": "gregw"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/BufferUtil.java", "diffHunk": "@@ -553,10 +553,12 @@ public static void writeTo(ByteBuffer buffer, OutputStream out) throws IOExcepti\n         }\n         else\n         {\n-            byte[] bytes = new byte[TEMP_BUFFER_SIZE];\n+            byte[] bytes = null;\n             while (buffer.hasRemaining())\n             {\n                 int byteCountToWrite = Math.min(buffer.remaining(), TEMP_BUFFER_SIZE);\n+                if (bytes == null)\n+                    bytes = new byte[byteCountToWrite];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1554768fe315e6f56652e750db0937a15aa192f6"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d19267910a03b7a5fe72ecc95daeeed42c4144", "author": {"user": {"login": "SerCeMan", "name": "Sergey Tselovalnikov"}}, "url": "https://github.com/eclipse/jetty.project/commit/99d19267910a03b7a5fe72ecc95daeeed42c4144", "committedDate": "2020-07-15T07:03:16Z", "message": "review feedback\n\nSigned-off-by: Sergey Tselovalnikov <sergeicelov@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzIxODk1", "url": "https://github.com/eclipse/jetty.project/pull/5045#pullrequestreview-448721895", "createdAt": "2020-07-15T08:06:45Z", "commit": {"oid": "99d19267910a03b7a5fe72ecc95daeeed42c4144"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 367, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}