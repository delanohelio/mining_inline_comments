{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTg0Mzc2", "number": 4750, "title": "Issue #4747 - fix some test failures for jetty-10 with websocket tck", "bodyText": "Issue #4747\n\n\nDefault close status code should be normal status.\n\n\nSessionID should return same String instance. Also using the object hash code is probably not suited to be used as a unique ID and not get collisions. Now using UUID.randomUUID() instead which is sufficiently random and large enough to generate unique IDs.\n\n\nThrowing in onClose now calls onError. Also fixes a bug where onClosed may never be called if onFrame throws.\n\n\nFix to make WS path parameters work when deployed with a context path.\n\n\nCorrectly copy headers in JsrUpgradeListener. Multiple headers with the same name did not copy properly and were lost.\n\n\nFilter out synthetic methods when looking for annotated methods on a class so bridge methods are not found.\n\n\nThe servers websocket handshake response is allowed to not select a subprotocol from the offered subprotocols by the client as long as it does not include the subprotocol header in the response.", "createdAt": "2020-04-07T01:16:45Z", "url": "https://github.com/eclipse/jetty.project/pull/4750", "merged": true, "mergeCommit": {"oid": "53246f977c702030e1fca2771bdee068c6910c39"}, "closed": true, "closedAt": "2020-04-23T00:22:03Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUxQxTAH2gAyMzk5OTg0Mzc2OjY2NGNiODFlNmRkYmE1YWMzZDg2ODM4NjQyMjgwODFmNGJhNjE5NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaODvOAFqTM5ODU0Njc0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "664cb81e6ddba5ac3d8683864228081f4ba61972", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/664cb81e6ddba5ac3d8683864228081f4ba61972", "committedDate": "2020-04-05T21:48:14Z", "message": "Issue #4747 - Default close status code should be normal status\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2028b99e83f1304388ab572edc40682e3e7a0823", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2028b99e83f1304388ab572edc40682e3e7a0823", "committedDate": "2020-04-06T01:54:16Z", "message": "Issue #4747 - SessionID should return same String instance\n\nUsing the object hash code is not random enough to use as a unique ID.\nNow using UUID.randomUUID() instead which sufficiently random.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54ee3f393907d9e945fd8b6128cb40443406aa5c", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/54ee3f393907d9e945fd8b6128cb40443406aa5c", "committedDate": "2020-04-06T10:28:57Z", "message": "Issue #4747 - Throwing in onClose now calls onError\n\n- This applies to the javax onClose method not the core onClosed method.\n- Also fixes a bug where onClosed may never be called if onFrame throws.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "625dfd1a4d0b82b6174452b3c669e723388eebe5", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/625dfd1a4d0b82b6174452b3c669e723388eebe5", "committedDate": "2020-04-07T02:18:29Z", "message": "Issue #4747 - Fix WS path params to work within a context path\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d40e0e25d4710760fd071556e6e7912d5ad3ede", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/3d40e0e25d4710760fd071556e6e7912d5ad3ede", "committedDate": "2020-04-07T05:06:25Z", "message": "Issue #4747 - correctly copy headers in websocket JsrUpgradeListener\n\nHeaders with the same name may not have been copied properly for\nheader values inspected and modified with a Configurator.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "committedDate": "2020-04-08T05:31:42Z", "message": "Issue #4747 - filter out synthetic annotated methods\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c053b48ef76ba57ba43ab6fec5f30c3f1c819898", "author": {"user": {"login": "olamy", "name": "Olivier Lamy"}}, "url": "https://github.com/eclipse/jetty.project/commit/c053b48ef76ba57ba43ab6fec5f30c3f1c819898", "committedDate": "2020-04-08T02:04:39Z", "message": "fix missing header\n\nSigned-off-by: olivier lamy <oliver.lamy@gmail.com>"}, "afterCommit": {"oid": "4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "committedDate": "2020-04-08T05:31:42Z", "message": "Issue #4747 - filter out synthetic annotated methods\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45f822ed328a93e0457c27308bed12290a827780", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/45f822ed328a93e0457c27308bed12290a827780", "committedDate": "2020-04-08T07:08:52Z", "message": "Issue #4747 - server is allowed to not select a websocket subprotocol\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjI5NDA5", "url": "https://github.com/eclipse/jetty.project/pull/4750#pullrequestreview-397229409", "createdAt": "2020-04-21T11:15:20Z", "commit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToxNToyMVrOGJAPnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToxNzo1OFrOGJAV0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NDM2NA==", "bodyText": "I would much rather keep CloseStatus immutable and replace the entire object than have it partially immutable.\nWhy isn't the cause known when it is created? feels wrong!", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412094364", "createdAt": "2020-04-21T11:15:21Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/CloseStatus.java", "diffHunk": "@@ -211,6 +211,11 @@ public boolean isAbnormal()\n         return !isOrdinary(code);\n     }\n \n+    public void initCause(Throwable cause)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NTU0Ng==", "bodyText": "this seams wrong.  If we were closed for some other reason, then adding a cause to it could put the wrong cause against a close reason.", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412095546", "createdAt": "2020-04-21T11:17:17Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketSessionState.java", "diffHunk": "@@ -123,6 +123,28 @@ public boolean onClosed(CloseStatus closeStatus)\n         }\n     }\n \n+    /**\n+     * This should only be called directly before closing the connection when we are in {@link State#CLOSED} state.\n+     * This ensures an abnormal close status and if we have no error in the CloseStatus we will set one.\n+     * @param t the error which occurred.\n+     */\n+    public void onError(Throwable t)\n+    {\n+        synchronized (this)\n+        {\n+            if (_sessionState != State.CLOSED || _closeStatus == null)\n+                throw new IllegalArgumentException();\n+\n+            // Override any normal close status.\n+            if (!_closeStatus.isAbnormal())\n+                _closeStatus = new CloseStatus(CloseStatus.SERVER_ERROR, t);\n+\n+            // Otherwise set the error if it wasn't already set to notify onError as well as onClose.\n+            if (_closeStatus.getCause() == null)\n+                _closeStatus.initCause(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NTk1NQ==", "bodyText": "revert to commented out DEBUG", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412095955", "createdAt": "2020-04-21T11:17:58Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-core/src/test/resources/jetty-logging.properties", "diffHunk": "@@ -1,5 +1,5 @@\n # Jetty Logging using jetty-slf4j-impl\n-# org.eclipse.jetty.LEVEL=DEBUG\n+org.eclipse.jetty.LEVEL=INFO", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjM0MTQw", "url": "https://github.com/eclipse/jetty.project/pull/4750#pullrequestreview-397234140", "createdAt": "2020-04-21T11:22:36Z", "commit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToyMjozNlrOGJAgxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToyMjozNlrOGJAgxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5ODc1Ng==", "bodyText": "So it is OK to not select a subprotocol?", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412098756", "createdAt": "2020-04-21T11:22:36Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/client/ClientUpgradeRequest.java", "diffHunk": "@@ -409,8 +409,6 @@ else if (values.length == 1)\n \n         // Verify the negotiated subprotocol\n         List<String> offeredSubProtocols = getSubProtocols();\n-        if (negotiatedSubProtocol == null && !offeredSubProtocols.isEmpty())\n-            throw new WebSocketException(\"Upgrade failed: no subprotocol selected from offered subprotocols \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjM2MjQ2", "url": "https://github.com/eclipse/jetty.project/pull/4750#pullrequestreview-397236246", "createdAt": "2020-04-21T11:25:46Z", "commit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToyNTo0NlrOGJAoTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMToyNTo0NlrOGJAoTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEwMDY4Nw==", "bodyText": "This looks like it may be called a few times per upgade? if so, perhaps do the addPaths in the constructor.", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412100687", "createdAt": "2020-04-21T11:25:46Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-servlet/src/main/java/org/eclipse/jetty/websocket/servlet/ServletUpgradeRequest.java", "diffHunk": "@@ -314,6 +315,14 @@ public URI getRequestURI()\n         return requestURI;\n     }\n \n+    /**\n+     * @return the path within the context, combination of the ServletPath with the PathInfo.\n+     */\n+    public String getPathInContext()\n+    {\n+        return URIUtil.addPaths(request.getServletPath(), request.getPathInfo());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45f822ed328a93e0457c27308bed12290a827780"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1163261a0b2018395478f6ecfe51a3dc1f6cfc5", "author": {"user": {"login": "joakime", "name": "Joakim Erdfelt"}}, "url": "https://github.com/eclipse/jetty.project/commit/d1163261a0b2018395478f6ecfe51a3dc1f6cfc5", "committedDate": "2020-04-21T14:07:31Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-4747-WebSocketTCK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b51a0ad4583039ef0ccf3e261f19d5b8fcfd711b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/b51a0ad4583039ef0ccf3e261f19d5b8fcfd711b", "committedDate": "2020-04-22T07:39:41Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-4747-WebSocketTCK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6e58e693b10f09621e1c7721b01389e6021d2e6", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/c6e58e693b10f09621e1c7721b01389e6021d2e6", "committedDate": "2020-04-22T08:10:49Z", "message": "Issue #4747 - changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTMxMTI0", "url": "https://github.com/eclipse/jetty.project/pull/4750#pullrequestreview-398531124", "createdAt": "2020-04-22T19:52:07Z", "commit": {"oid": "c6e58e693b10f09621e1c7721b01389e6021d2e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTQ2NzQ3", "url": "https://github.com/eclipse/jetty.project/pull/4750#pullrequestreview-398546747", "createdAt": "2020-04-22T20:10:52Z", "commit": {"oid": "c6e58e693b10f09621e1c7721b01389e6021d2e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 530, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}