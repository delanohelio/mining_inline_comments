{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjgwMDA4", "number": 5213, "title": "Issue #5170 - fix NPE during websocket upgrade", "bodyText": "Closes #5170\nDuring the WebSocket client upgrade, if the upgrade response completes before the upgrade request then we NPE or potentially just lose the initial bytes of the websocket connection which would corrupt or lose the initial websocket frames.\nThis change makes it so during an upgrade we do not release the network buffer in the HttpReceiverOverHttp until onUpgradeFrom() is called. This prevents the NPE and we do not lose the data for the initial websocket buffer.", "createdAt": "2020-08-31T12:55:09Z", "url": "https://github.com/eclipse/jetty.project/pull/5213", "merged": true, "mergeCommit": {"oid": "cdb12b41301f30b02d367e96826bcd2ed083c39c"}, "closed": true, "closedAt": "2020-09-02T08:00:20Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEOiqkAH2gAyNDc2MjgwMDA4OmFlNjIxODA0MTYyMjZkY2I0ZjdkMTQ0MjM4N2M1MTIzZjViZWUwOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE2_DygFqTQ4MDU1ODIxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae62180416226dcb4f7d1442387c5123f5bee092", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/ae62180416226dcb4f7d1442387c5123f5bee092", "committedDate": "2020-08-31T08:29:28Z", "message": "Issue #5170 - ensure bytes after 101 response isn't lost during upgrade\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/abb5ae881257788d3de84801e3f7c2228961fc37", "committedDate": "2020-09-01T00:03:18Z", "message": "HttpExchange could be null during parse()\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDM5NzAx", "url": "https://github.com/eclipse/jetty.project/pull/5213#pullrequestreview-479439701", "createdAt": "2020-09-01T06:39:40Z", "commit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNjozOTo0MFrOHKmkJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNjozOTo0MFrOHKmkJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg3OTY1Mg==", "bodyText": "Previously the test for upgrade was: connection != endPoint.getConnection()\nNow it is just 101 response status.   Don't we support upgrade like paths (eg for http2) that are not 101s?", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r480879652", "createdAt": "2020-09-01T06:39:40Z", "author": {"login": "gregw"}, "path": "jetty-client/src/main/java/org/eclipse/jetty/client/http/HttpReceiverOverHTTP.java", "diffHunk": "@@ -235,6 +235,10 @@ private boolean parse()\n \n             if (complete)\n             {\n+                HttpExchange httpExchange = getHttpExchange();\n+                if (httpExchange != null && httpExchange.getResponse().getStatus() == HttpStatus.SWITCHING_PROTOCOLS_101)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTA5MzQz", "url": "https://github.com/eclipse/jetty.project/pull/5213#pullrequestreview-480109343", "createdAt": "2020-09-01T20:56:53Z", "commit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDo1Njo1M1rOHLH8Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDo1NzoxNFrOHLH9Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwNw==", "bodyText": "This is now printing the whole stack trace, while before it was only a line.\nI am not convinced that we should log this at WARN level, because any I/O error due to the other peer will show up as a big stack trace in the logs.\nI'd change warn() to debug().", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481426507", "createdAt": "2020-09-01T20:56:53Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-core-common/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketConnection.java", "diffHunk": "@@ -469,9 +469,12 @@ private void fillAndParse()\n         }\n         catch (Throwable t)\n         {\n-            LOG.warn(t.toString());\n-            BufferUtil.clear(networkBuffer.getBuffer());\n-            releaseNetworkBuffer();\n+            LOG.warn(\"Error during fillAndParse()\", t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjY5MA==", "bodyText": "Why do you need the NPE guard now?", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481426690", "createdAt": "2020-09-01T20:57:14Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-core-common/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketConnection.java", "diffHunk": "@@ -469,9 +469,12 @@ private void fillAndParse()\n         }\n         catch (Throwable t)\n         {\n-            LOG.warn(t.toString());\n-            BufferUtil.clear(networkBuffer.getBuffer());\n-            releaseNetworkBuffer();\n+            LOG.warn(\"Error during fillAndParse()\", t);\n+            if (networkBuffer != null)\n+            {\n+                BufferUtil.clear(networkBuffer.getBuffer());\n+                releaseNetworkBuffer();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bdcea2a49410ddbb048ad393f779d61d5cc017f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/5bdcea2a49410ddbb048ad393f779d61d5cc017f", "committedDate": "2020-09-01T23:55:18Z", "message": "change log warning for fillAndParse errors to debug log\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTU4MjE5", "url": "https://github.com/eclipse/jetty.project/pull/5213#pullrequestreview-480558219", "createdAt": "2020-09-02T07:36:41Z", "commit": {"oid": "5bdcea2a49410ddbb048ad393f779d61d5cc017f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 313, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}