{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTA1MDAw", "number": 5307, "title": "Issue #5304 HTTP2 HostHeader", "bodyText": "#5304\nUpdated HostHeaderCustomizer to actually add the Host header, either from values passed in the custructor or from the getServerName and getServerPort methods.\nThe HttpURI is no longer updated.\nSigned-off-by: Greg Wilkins gregw@webtide.com", "createdAt": "2020-09-21T19:15:32Z", "url": "https://github.com/eclipse/jetty.project/pull/5307", "merged": true, "mergeCommit": {"oid": "0ac34ff2b8a73d6d2f99bd8751ffac34791d78f3"}, "closed": true, "closedAt": "2020-09-23T13:05:53Z", "author": {"login": "gregw"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLIW0ZAH2gAyNDkwNTA1MDAwOjI1NmM2NjkyZGQwODNmZjYwNTA2NWUxYWJlZGNjY2RlYThjNjhlNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLrdHFgFqTQ5NDU4ODA0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "256c6692dd083ff605065e1abedcccdea8c68e71", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/256c6692dd083ff605065e1abedcccdea8c68e71", "committedDate": "2020-09-21T19:14:34Z", "message": "Issue #5304 HTTP2 HostHeader\n\nUpdated HostHeaderCustomizer to actually add the Host header, either from values passed in the custructor or from the getServerName and getServerPort methods.\n\nThe HttpURI is no longer updated.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTQ3MTA2", "url": "https://github.com/eclipse/jetty.project/pull/5307#pullrequestreview-492947106", "createdAt": "2020-09-21T20:15:22Z", "commit": {"oid": "256c6692dd083ff605065e1abedcccdea8c68e71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoxNToyMlrOHVg2bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoxNToyMlrOHVg2bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMDM2NA==", "bodyText": "Some javadoc here saying this usage will result in using the serverName/serverPort from the Request?", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492320364", "createdAt": "2020-09-21T20:15:22Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -19,30 +19,30 @@\n package org.eclipse.jetty.server;\n \n import java.util.Objects;\n-import javax.servlet.http.HttpServletRequest;\n \n-import org.eclipse.jetty.http.HttpURI;\n+import org.eclipse.jetty.http.HostPortHttpField;\n+import org.eclipse.jetty.http.HttpFields;\n+import org.eclipse.jetty.http.HttpHeader;\n+import org.eclipse.jetty.http.HttpScheme;\n+import org.eclipse.jetty.http.HttpVersion;\n \n /**\n- * Customizes requests that lack the {@code Host} header (for example, HTTP 1.0 requests).\n+ * Adds a missing {@code Host} header (for example, HTTP 1.0 or 2.0 requests).\n  * <p>\n- * In case of HTTP 1.0 requests that lack the {@code Host} header, the application may issue\n- * a redirect, and the {@code Location} header is usually constructed from the {@code Host}\n- * header; if the {@code Host} header is missing, the server may query the connector for its\n- * IP address in order to construct the {@code Location} header, and thus leak to clients\n- * internal IP addresses.\n- * <p>\n- * This {@link HttpConfiguration.Customizer} is configured with a {@code serverName} and\n- * optionally a {@code serverPort}.\n- * If the {@code Host} header is absent, the configured {@code serverName} will be set on\n- * the request so that {@link HttpServletRequest#getServerName()} will return that value,\n- * and likewise for {@code serverPort} and {@link HttpServletRequest#getServerPort()}.\n+ * The host and port may be provided in the constructor or taken from the\n+ * {@link Request#getServerName()} and {@link Request#getServerPort()} methods.\n+ * </p>\n  */\n public class HostHeaderCustomizer implements HttpConfiguration.Customizer\n {\n     private final String serverName;\n     private final int serverPort;\n \n+    public HostHeaderCustomizer()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256c6692dd083ff605065e1abedcccdea8c68e71"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTQ3NDYx", "url": "https://github.com/eclipse/jetty.project/pull/5307#pullrequestreview-492947461", "createdAt": "2020-09-21T20:15:55Z", "commit": {"oid": "256c6692dd083ff605065e1abedcccdea8c68e71"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoxNTo1NlrOHVg3iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoxNTo1NlrOHVg3iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMDY1MQ==", "bodyText": "This forwards to this(String, int) which requires that serverName is not null.", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492320651", "createdAt": "2020-09-21T20:15:56Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -19,30 +19,30 @@\n package org.eclipse.jetty.server;\n \n import java.util.Objects;\n-import javax.servlet.http.HttpServletRequest;\n \n-import org.eclipse.jetty.http.HttpURI;\n+import org.eclipse.jetty.http.HostPortHttpField;\n+import org.eclipse.jetty.http.HttpFields;\n+import org.eclipse.jetty.http.HttpHeader;\n+import org.eclipse.jetty.http.HttpScheme;\n+import org.eclipse.jetty.http.HttpVersion;\n \n /**\n- * Customizes requests that lack the {@code Host} header (for example, HTTP 1.0 requests).\n+ * Adds a missing {@code Host} header (for example, HTTP 1.0 or 2.0 requests).\n  * <p>\n- * In case of HTTP 1.0 requests that lack the {@code Host} header, the application may issue\n- * a redirect, and the {@code Location} header is usually constructed from the {@code Host}\n- * header; if the {@code Host} header is missing, the server may query the connector for its\n- * IP address in order to construct the {@code Location} header, and thus leak to clients\n- * internal IP addresses.\n- * <p>\n- * This {@link HttpConfiguration.Customizer} is configured with a {@code serverName} and\n- * optionally a {@code serverPort}.\n- * If the {@code Host} header is absent, the configured {@code serverName} will be set on\n- * the request so that {@link HttpServletRequest#getServerName()} will return that value,\n- * and likewise for {@code serverPort} and {@link HttpServletRequest#getServerPort()}.\n+ * The host and port may be provided in the constructor or taken from the\n+ * {@link Request#getServerName()} and {@link Request#getServerPort()} methods.\n+ * </p>\n  */\n public class HostHeaderCustomizer implements HttpConfiguration.Customizer\n {\n     private final String serverName;\n     private final int serverPort;\n \n+    public HostHeaderCustomizer()\n+    {\n+        this(null, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "256c6692dd083ff605065e1abedcccdea8c68e71"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e694995ca4d76640ef0ee7f8265b9bac86843f", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/38e694995ca4d76640ef0ee7f8265b9bac86843f", "committedDate": "2020-09-22T09:18:51Z", "message": "Issue #5304 HTTP2 HostHeader\n\n + Found and fixed bug in HttpFields\n + Added port normalization support to HttpScheme\n + added test\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b25630b1fa18edeecfe61726053a654a586cec7", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/2b25630b1fa18edeecfe61726053a654a586cec7", "committedDate": "2020-09-22T09:19:50Z", "message": "blank line\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78988713b3ab4c721b155d26558e6fda68365954", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/78988713b3ab4c721b155d26558e6fda68365954", "committedDate": "2020-09-22T10:12:38Z", "message": "Issue #5304 HTTP2 HostHeader\n\n + refixed bug in HttpFields\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e93b84ce23341d6e68e360c89e52a39dca006c5", "committedDate": "2020-09-22T11:43:36Z", "message": "Issue #5304 HTTP2 HostHeader\n\n + still fixing HttpFields bug\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzkxMTA0", "url": "https://github.com/eclipse/jetty.project/pull/5307#pullrequestreview-493391104", "createdAt": "2020-09-22T12:09:36Z", "commit": {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjowOTozNlrOHV25Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjoxMzo0NFrOHV3CfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MTUwNg==", "bodyText": "Don't you want to setHttpURI() if the port is normalized in a way that's different then serverPort too?", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492681506", "createdAt": "2020-09-22T12:09:36Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -57,15 +60,26 @@ public HostHeaderCustomizer(String serverName)\n      */\n     public HostHeaderCustomizer(String serverName, int serverPort)\n     {\n-        this.serverName = Objects.requireNonNull(serverName);\n+        this.serverName = serverName;\n         this.serverPort = serverPort;\n     }\n \n     @Override\n     public void customize(Connector connector, HttpConfiguration channelConfig, Request request)\n     {\n-        if (request.getHeader(\"Host\") == null)\n-            // TODO set the field as well?\n-            request.setHttpURI(HttpURI.build(request.getHttpURI()).host(serverName).port(serverPort));\n+        if (request.getHttpVersion() != HttpVersion.HTTP_1_1 && !request.getHttpFields().contains(HttpHeader.HOST))\n+        {\n+            String host = serverName == null ? request.getServerName() : serverName;\n+            int port = HttpScheme.normalizePort(request.getScheme(), serverPort == 0 ? request.getServerPort() : serverPort);\n+\n+            if (serverName != null || serverPort > 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ==", "bodyText": "This looks odd, why is this not httpFields.addAll(request.getHttpFields()); ?\nAlso, doesn't this change the request.getHttpFields() to now be Mutable?\nWhat if this was ...\nHttpFields updated = HttpFields.build(\n   request.getHttpFields(), \n   new HostPortHttpFields(host, port));\nrequest.setHttpFields(updated);\nWhere there is a new method .build(HttpFields original, HttpField ... fields) ?", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492683901", "createdAt": "2020-09-22T12:13:44Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -57,15 +60,26 @@ public HostHeaderCustomizer(String serverName)\n      */\n     public HostHeaderCustomizer(String serverName, int serverPort)\n     {\n-        this.serverName = Objects.requireNonNull(serverName);\n+        this.serverName = serverName;\n         this.serverPort = serverPort;\n     }\n \n     @Override\n     public void customize(Connector connector, HttpConfiguration channelConfig, Request request)\n     {\n-        if (request.getHeader(\"Host\") == null)\n-            // TODO set the field as well?\n-            request.setHttpURI(HttpURI.build(request.getHttpURI()).host(serverName).port(serverPort));\n+        if (request.getHttpVersion() != HttpVersion.HTTP_1_1 && !request.getHttpFields().contains(HttpHeader.HOST))\n+        {\n+            String host = serverName == null ? request.getServerName() : serverName;\n+            int port = HttpScheme.normalizePort(request.getScheme(), serverPort == 0 ? request.getServerPort() : serverPort);\n+\n+            if (serverName != null || serverPort > 0)\n+                request.setHttpURI(HttpURI.build(request.getHttpURI()).authority(host, port));\n+\n+            HttpFields original = request.getHttpFields();\n+            HttpFields.Mutable httpFields = HttpFields.build(original.size() + 1);\n+            httpFields.add(new HostPortHttpField(host, port));\n+            httpFields.add(request.getHttpFields());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3b765c45f8e2405507d846feedffe6bd09b99f4", "author": {"user": {"login": "gregw", "name": "Greg Wilkins"}}, "url": "https://github.com/eclipse/jetty.project/commit/c3b765c45f8e2405507d846feedffe6bd09b99f4", "committedDate": "2020-09-22T12:57:43Z", "message": "Issue #5304 HTTP2 Host Header\n\nupdates from review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzY5MDI2", "url": "https://github.com/eclipse/jetty.project/pull/5307#pullrequestreview-493769026", "createdAt": "2020-09-22T19:12:39Z", "commit": {"oid": "c3b765c45f8e2405507d846feedffe6bd09b99f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxOToxMjozOVrOHWIs7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxOToxMjozOVrOHWIs7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk3MzI5NA==", "bodyText": "This still changes future requests on request.getHttpFields() to be a HttpFields.Mutable, right?\nI don't think that's desired.", "url": "https://github.com/eclipse/jetty.project/pull/5307#discussion_r492973294", "createdAt": "2020-09-22T19:12:39Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/HostHeaderCustomizer.java", "diffHunk": "@@ -57,15 +60,26 @@ public HostHeaderCustomizer(String serverName)\n      */\n     public HostHeaderCustomizer(String serverName, int serverPort)\n     {\n-        this.serverName = Objects.requireNonNull(serverName);\n+        this.serverName = serverName;\n         this.serverPort = serverPort;\n     }\n \n     @Override\n     public void customize(Connector connector, HttpConfiguration channelConfig, Request request)\n     {\n-        if (request.getHeader(\"Host\") == null)\n-            // TODO set the field as well?\n-            request.setHttpURI(HttpURI.build(request.getHttpURI()).host(serverName).port(serverPort));\n+        if (request.getHttpVersion() != HttpVersion.HTTP_1_1 && !request.getHttpFields().contains(HttpHeader.HOST))\n+        {\n+            String host = serverName == null ? request.getServerName() : serverName;\n+            int port = HttpScheme.normalizePort(request.getScheme(), serverPort == 0 ? request.getServerPort() : serverPort);\n+\n+            if (serverName != null || serverPort > 0)\n+                request.setHttpURI(HttpURI.build(request.getHttpURI()).authority(host, port));\n+\n+            HttpFields original = request.getHttpFields();\n+            HttpFields.Mutable httpFields = HttpFields.build(original.size() + 1);\n+            httpFields.add(new HostPortHttpField(host, port));\n+            httpFields.add(request.getHttpFields());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MzkwMQ=="}, "originalCommit": {"oid": "4e93b84ce23341d6e68e360c89e52a39dca006c5"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTg4MDQ3", "url": "https://github.com/eclipse/jetty.project/pull/5307#pullrequestreview-494588047", "createdAt": "2020-09-23T12:08:07Z", "commit": {"oid": "c3b765c45f8e2405507d846feedffe6bd09b99f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 9, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}