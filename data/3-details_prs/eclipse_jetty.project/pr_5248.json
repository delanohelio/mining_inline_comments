{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNDc4MzM0", "number": 5248, "title": "Issue #5198 - update gzip handler", "bodyText": "Fixes #5198 - We now use the ByteBuffer API for inflaters/deflaters for GzipHandler.\nFixes #4988 - The GzipHandlers IncludeExclude for the MIME types now uses case insensitive set.\nFixes #1761 - Added extra configuration in the .ini file for gzip.mod.\nFixes #5246 - add deflater/inflater pools to server dump.", "createdAt": "2020-09-09T04:09:04Z", "url": "https://github.com/eclipse/jetty.project/pull/5248", "merged": true, "mergeCommit": {"oid": "df085a610f0499ae30695da0834ead164955d96d"}, "closed": true, "closedAt": "2020-09-21T00:41:17Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGd4BSgH2gAyNDgyNDc4MzM0Ojc2NDJiZThmZDA0NDZkZmUwMDRjMzkzMDNkNWM5Yjc4OWI4YmEwY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKBM6MgFqTQ5MTI1MDA5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7642be8fd0446dfe004c39303d5c9b789b8ba0ce", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7642be8fd0446dfe004c39303d5c9b789b8ba0ce", "committedDate": "2020-09-07T07:29:13Z", "message": "Issue #4988 - make the MIME type comparison in GzipHandler case insensitive\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17ec87f51ccc3761644230412d250bd82ac89e74", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/17ec87f51ccc3761644230412d250bd82ac89e74", "committedDate": "2020-09-07T23:46:51Z", "message": "Issue #1761 - add extra .ini file configuration for gzip.mod\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bdd82eb5ef1c9426eaea246932f51e27c9b443d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/3bdd82eb5ef1c9426eaea246932f51e27c9b443d", "committedDate": "2020-09-08T05:27:21Z", "message": "Issue #5198 - GzipHandler should use InflaterPool as well as DeflaterPool\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a04b3eb19820c66b65d026cfd972a49689dc582", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/7a04b3eb19820c66b65d026cfd972a49689dc582", "committedDate": "2020-09-08T07:10:36Z", "message": "Issue #5198 - use ByteBuffer API for inflater/deflaters for GzipHandler\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed89cbccdf694b79aa831ea90ea3c46994b5b8b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2ed89cbccdf694b79aa831ea90ea3c46994b5b8b", "committedDate": "2020-09-09T00:39:15Z", "message": "Issue #5246 - add Inflater/Deflater pools to server dump\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e6827c539898f99d6ce636699cfd5eda63f8afa", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e6827c539898f99d6ce636699cfd5eda63f8afa", "committedDate": "2020-09-09T03:53:09Z", "message": "Issue #5198 - fix usage of inflater/deflater ByteBuffer API\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/2f23c5936e0159d345a93035d7ef14be87516efd", "committedDate": "2020-09-09T04:03:42Z", "message": "Issue #5198 - revert usage of deflater ByteBuffer API for GzipHandler\n\nThe CRC32 checksum may need to convert the ByteBuffer to an array anyway so\nwe are better off not setting the deflater input with ByteBuffer directly.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjQ5NDI0", "url": "https://github.com/eclipse/jetty.project/pull/5248#pullrequestreview-484649424", "createdAt": "2020-09-09T04:17:47Z", "commit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoxNzo0N1rOHO2Cyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDoxNzo0N1rOHO2Cyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyNzU2Mg==", "bodyText": "@gregw I think its probably best not to use the deflaters ByteBuffer method here, the CRC32 will need an array from the ByteBuffer anyway, and if we do it ourselves we get the use the ByteBufferPool.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485327562", "createdAt": "2020-09-09T04:17:47Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,7 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTQ0ODky", "url": "https://github.com/eclipse/jetty.project/pull/5248#pullrequestreview-485144892", "createdAt": "2020-09-09T15:43:59Z", "commit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo0Mzo1OVrOHPNprw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1MDoxM1rOHPN6DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNDM1MQ==", "bodyText": "Can you use TreeSet instead?\nSet<String> foo = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\nfoo.add(\"Bar\");\nfoo.add(\"bar\");\nfoo.add(\"BAR\");\nfoo.add(\"ZED\");\nfoo.add(\"zed\");\n\nSystem.out.printf(\"Has %d elements%n\", foo.size());\nSystem.out.printf(\"contains('baR') = %b%n\", foo.contains(\"baR\"));\nSystem.out.printf(\"contains('zeD') = %b%n\", foo.contains(\"zeD\"));\nSystem.out.printf(\"contains('baz') = %b%n\", foo.contains(\"baz\"));\nResults in ...\nHas 2 elements\ncontains('baR') = true\ncontains('zeD') = true\ncontains('baz') = false", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485714351", "createdAt": "2020-09-09T15:43:59Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -168,7 +172,7 @@\n     // non-static, as other GzipHandler instances may have different configurations\n     private final IncludeExclude<String> _methods = new IncludeExclude<>();\n     private final IncludeExclude<String> _paths = new IncludeExclude<>(PathSpecSet.class);\n-    private final IncludeExclude<String> _mimeTypes = new IncludeExclude<>();\n+    private final IncludeExclude<String> _mimeTypes = new IncludeExclude<>(CaseInsensitiveSet.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTU3Mw==", "bodyText": "This can be simplified to just ...\n    public static class CaseInsensitiveSet extends TreeSet<String>\n    {\n        public CaseInsensitiveSet()\n        {\n            super(String.CASE_INSENSITIVE_ORDER);\n        }\n    }", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485715573", "createdAt": "2020-09-09T15:45:48Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,17 +902,60 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n+    }\n+\n+    protected DeflaterPool newDeflaterPool()\n+    {\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);\n     }\n \n     @Override\n     public String toString()\n     {\n         return String.format(\"%s@%x{%s,min=%s,inflate=%s}\", getClass().getSimpleName(), hashCode(), getState(), _minGzipSize, _inflateBufferSize);\n     }\n+\n+    public static class CaseInsensitiveSet extends HashSet<String>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxODU0MQ==", "bodyText": "How about ...\n    public void setDispatcherTypes(String... dispatchers)\n    {\n        _dispatchers = EnumSet.copyOf(\n            Stream.of(dispatchers)\n                .flatMap(s -> Stream.of(StringUtil.csvSplit(s)))\n                .map(DispatcherType::valueOf)\n                .collect(Collectors.toSet())\n        );\n    }", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485718541", "createdAt": "2020-09-09T15:50:13Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -771,6 +773,19 @@ public void setExcludedPaths(String... pathspecs)\n         _paths.exclude(pathspecs);\n     }\n \n+    /**\n+     * Set of supported {@link DispatcherType} that this filter will operate on.\n+     *\n+     * @param dispatchers the set of {@link DispatcherType} that this filter will operate on\n+     */\n+    public void setDispatcherTypes(String... dispatchers)\n+    {\n+        setDispatcherTypes(Stream.of(dispatchers)\n+            .flatMap(s -> Stream.of(StringUtil.csvSplit(s)))\n+            .map(DispatcherType::valueOf)\n+            .toArray(DispatcherType[]::new));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f23c5936e0159d345a93035d7ef14be87516efd"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f2abf21df6b3014f3a2351badee58a858f826c4b", "committedDate": "2020-09-09T22:02:59Z", "message": "Move AsciiLowerCaseSet to jetty-util & changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDY0OTgy", "url": "https://github.com/eclipse/jetty.project/pull/5248#pullrequestreview-485464982", "createdAt": "2020-09-09T23:18:11Z", "commit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzoxODoxMVrOHPdb-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzoxODoxMVrOHPdb-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ==", "bodyText": "What does \"INFINITE_CAPACITY\" mean?", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r485972985", "createdAt": "2020-09-09T23:18:11Z", "author": {"login": "joakime"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Njk4NjU5", "url": "https://github.com/eclipse/jetty.project/pull/5248#pullrequestreview-486698659", "createdAt": "2020-09-11T10:42:33Z", "commit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0MjozM1rOHQZ27g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0NToyMVrOHQZ7yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2MjkyNg==", "bodyText": "We want to eventually switch the pools over to using the Pool class, which has it's size set when constructed.  So we need to not assume that the pool size can be configured after construction.", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r486962926", "createdAt": "2020-09-11T10:42:33Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHandler.java", "diffHunk": "@@ -887,12 +903,38 @@ public void setDeflaterPoolCapacity(int capacity)\n         if (isStarted())\n             throw new IllegalStateException(getState());\n \n-        poolCapacity = capacity;\n+        _deflaterPool.setCapacity(capacity);\n+    }\n+\n+    /**\n+     * Gets the maximum number of Inflators that the DeflaterPool can hold.\n+     *\n+     * @return the Deflater pool capacity\n+     */\n+    public int getInflaterPoolCapacity()\n+    {\n+        return _inflaterPool.getCapacity();\n+    }\n+\n+    /**\n+     * Sets the maximum number of Inflators that the DeflaterPool can hold.\n+     */\n+    public void setInflaterPoolCapacity(int capacity)\n+    {\n+        if (isStarted())\n+            throw new IllegalStateException(getState());\n+\n+        _inflaterPool.setCapacity(capacity);\n+    }\n+\n+    protected InflaterPool newInflaterPool()\n+    {\n+        return new InflaterPool(CompressionPool.INFINITE_CAPACITY, true);\n     }\n \n-    protected DeflaterPool newDeflaterPool(int capacity)\n+    protected DeflaterPool newDeflaterPool()\n     {\n-        return new DeflaterPool(capacity, Deflater.DEFAULT_COMPRESSION, true);\n+        return new DeflaterPool(CompressionPool.INFINITE_CAPACITY, Deflater.DEFAULT_COMPRESSION, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3Mjk4NQ=="}, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NDE3MQ==", "bodyText": "Good comment, but can we raise a bug on the JVM to provide an efficient implementation of CRC32 that does not copy ByteBuffers?", "url": "https://github.com/eclipse/jetty.project/pull/5248#discussion_r486964171", "createdAt": "2020-09-11T10:45:21Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/gzip/GzipHttpOutputInterceptor.java", "diffHunk": "@@ -355,7 +354,9 @@ protected Action process() throws Exception\n                         int off = slice.arrayOffset() + slice.position();\n                         int len = slice.remaining();\n                         _crc.update(array, off, len);\n-                        _deflater.setInput(array, off, len);  // TODO use ByteBuffer API in Jetty-10\n+                        // Ideally we would want to use the ByteBuffer API for Deflaters. However due the the ByteBuffer implementation\n+                        // of the CRC32.update() it is less efficient for us to use this rather than to convert to array ourselves.\n+                        _deflater.setInput(array, off, len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjUwMDk4", "url": "https://github.com/eclipse/jetty.project/pull/5248#pullrequestreview-491250098", "createdAt": "2020-09-18T08:20:29Z", "commit": {"oid": "f2abf21df6b3014f3a2351badee58a858f826c4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 333, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}