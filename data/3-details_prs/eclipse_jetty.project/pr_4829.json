{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwODE5ODE5", "number": 4829, "title": "Issue #4825 - Implement spec requirements for Request.newPushBuilder", "bodyText": "Closes #4825\nImplement spec for javax.servlet.http.PushBuilder according to the javadoc, and as tested for by the tck.", "createdAt": "2020-04-29T16:27:14Z", "url": "https://github.com/eclipse/jetty.project/pull/4829", "merged": true, "mergeCommit": {"oid": "f154151016abe4da31026adf6b0a28bfdc24ef4a"}, "closed": true, "closedAt": "2020-05-01T09:07:07Z", "author": {"login": "janbartel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccWf8jAH2gAyNDEwODE5ODE5OjJmY2YwZmQ4YTdmYTBkNzc3ZDNhODI5NjFlZGFmM2U0MDQ2ODFjMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccuznDAFqTQwMzYzMjA1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fcf0fd8a7fa0d777d3a82961edaf3e404681c1b", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/2fcf0fd8a7fa0d777d3a82961edaf3e404681c1b", "committedDate": "2020-04-29T11:08:46Z", "message": "Issue #4825 Implement spec requirements for Request.newPushBuilder\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa758c25e2f6895b97683874894e4958c8fbb251", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/fa758c25e2f6895b97683874894e4958c8fbb251", "committedDate": "2020-04-29T16:17:39Z", "message": "Issue #4825 Check method for PushBuilder.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40d316d11ea68989be1e11967673c07c1869f66f", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/40d316d11ea68989be1e11967673c07c1869f66f", "committedDate": "2020-04-29T16:26:31Z", "message": "Issue #4825 Add extra tests for PushBuilder method\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/3fd71839e13738906cd64e63c487b4201c2a4d3f", "committedDate": "2020-04-29T16:46:30Z", "message": "Issue #4825 Fix checkstyle problems\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyOTkxNTQx", "url": "https://github.com/eclipse/jetty.project/pull/4829#pullrequestreview-402991541", "createdAt": "2020-04-29T19:56:29Z", "commit": {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxOTo1NjoyOVrOGOOrUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMDo0Njo0NFrOGOQV5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3MzcxNQ==", "bodyText": "Please make this field have the correct case (all upper case).", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417573715", "createdAt": "2020-04-29T19:56:29Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/PushBuilderImpl.java", "diffHunk": "@@ -39,6 +42,13 @@\n     private static final Logger LOG = LoggerFactory.getLogger(PushBuilderImpl.class);\n \n     private static final HttpField JettyPush = new HttpField(\"x-http2-push\", \"PushBuilder\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU3Njk4NA==", "bodyText": "You can easily coalesce the null-check and the switch into a single if (header == SET_COOKIE).\nHow about SET_COOKIE2 (I'm ok to not consider it, just raising the issue of whether we want to explicitly not consider it).", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417576984", "createdAt": "2020-04-29T20:02:10Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -410,12 +416,55 @@ public PushBuilder newPushBuilder()\n             id = getRequestedSessionId();\n         }\n \n+        Map<String,String> cookies = new HashMap<>();\n+        Cookie[] existingCookies = getCookies();\n+        if (existingCookies != null)\n+        {        \n+            for (Cookie c: getCookies())\n+            {\n+                cookies.put(c.getName(), c.getValue());\n+            }\n+        }\n+\n+        //Any Set-Cookies that were set on the response must be set as Cookies on the\n+        //PushBuilder, unless the max-age of the cookie is <= 0\n+        HttpFields responseFields = getResponse().getHttpFields();\n+        for (HttpField field : responseFields)\n+        {\n+            HttpHeader header = field.getHeader();\n+            if (header == null)\n+                continue;\n+            switch (header)\n+            {\n+                case SET_COOKIE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwMDk5OA==", "bodyText": "I'm not sure handling these things at PushBuilder creation is the correct moment to do it.\nIs the TCK testing for this?\nI would rather add cookies, authorization headers, etc. just before the call to push(), to integrate also what the application is providing.\nFor example, if the application calls pushBuilder.addHeader(\"cookie\", \"a=b\") is it added to the ones computed above, or it replaces them, etc.?", "url": "https://github.com/eclipse/jetty.project/pull/4829#discussion_r417600998", "createdAt": "2020-04-29T20:46:44Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/Request.java", "diffHunk": "@@ -410,12 +416,55 @@ public PushBuilder newPushBuilder()\n             id = getRequestedSessionId();\n         }\n \n+        Map<String,String> cookies = new HashMap<>();\n+        Cookie[] existingCookies = getCookies();\n+        if (existingCookies != null)\n+        {        \n+            for (Cookie c: getCookies())\n+            {\n+                cookies.put(c.getName(), c.getValue());\n+            }\n+        }\n+\n+        //Any Set-Cookies that were set on the response must be set as Cookies on the\n+        //PushBuilder, unless the max-age of the cookie is <= 0\n+        HttpFields responseFields = getResponse().getHttpFields();\n+        for (HttpField field : responseFields)\n+        {\n+            HttpHeader header = field.getHeader();\n+            if (header == null)\n+                continue;\n+            switch (header)\n+            {\n+                case SET_COOKIE:\n+                {\n+                    HttpCookie cookie = ((SetCookieHttpField)field).getHttpCookie();\n+                    if (cookie.getMaxAge() > 0)\n+                        cookies.put(cookie.getName(), cookie.getValue());\n+                    else\n+                        cookies.remove(cookie.getName());\n+                    continue;\n+                }\n+                default:\n+                    continue;\n+            }\n+        }\n+        \n+        if (!cookies.isEmpty())\n+        {\n+            StringBuilder buff = new StringBuilder();\n+            for (Map.Entry<String,String> entry : cookies.entrySet())\n+            {\n+                if (buff.length() > 0)\n+                    buff.append(\"; \");\n+                buff.append(entry.getKey()).append('=').append(entry.getValue());\n+            }\n+            fields.add(new HttpField(HttpHeader.COOKIE, buff.toString()));\n+        }\n+        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd71839e13738906cd64e63c487b4201c2a4d3f"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "087d91bd82c16fa42a37fa4d58fca0314552f54e", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/087d91bd82c16fa42a37fa4d58fca0314552f54e", "committedDate": "2020-04-29T21:43:31Z", "message": "Issue #4825 Changes after review\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjMyMDUw", "url": "https://github.com/eclipse/jetty.project/pull/4829#pullrequestreview-403632050", "createdAt": "2020-04-30T15:27:58Z", "commit": {"oid": "087d91bd82c16fa42a37fa4d58fca0314552f54e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 366, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}