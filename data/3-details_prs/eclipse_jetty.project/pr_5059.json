{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNzQwMDM4", "number": 5059, "title": "Issue #4824 - add configuration on RemoteEndpoint for maxOutgoingFrames", "bodyText": "Attempt to address issue #4824 at the Jetty WebSocket API level.\nIf there are more than maxOutgoingFrames waiting to send, any additional sends will fail immediately instead of continuing to queue up in the flusher. The callback will be failed immediately but it will not fail the entire ws connection.\nThis method is called maxOutgoingFrames but its not really as the implementation could later on decide to fragment each send from the WebSocketRemoteEndpoint into multiple frames.", "createdAt": "2020-07-17T03:53:48Z", "url": "https://github.com/eclipse/jetty.project/pull/5059", "merged": true, "mergeCommit": {"oid": "1256261cdad86251cd5461f1a88afd0386359831"}, "closed": true, "closedAt": "2020-09-10T00:51:11Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcchPsLAH2gAyNDUwNzQwMDM4OjcxZGYzYjU3ZWVmMDgwNDAyMDMzMzdmNmQ4M2ZmMjhhZGM4NmQ3Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHVHd2AH2gAyNDUwNzQwMDM4OmI0NGI2MjAzOGM3MjUyNDQzM2RhNWM0ODJjMDY1MTI1NzY4OWMwMjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "71df3b57eef08040203337f6d83ff28adc86d7c7", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/71df3b57eef08040203337f6d83ff28adc86d7c7", "committedDate": "2020-04-29T23:39:58Z", "message": "Issue #4824 - add configuration on RemoteEndpoint for maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "576b1e23230aed8660b8e6f1bf296b001dd1eebb", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/576b1e23230aed8660b8e6f1bf296b001dd1eebb", "committedDate": "2020-09-02T00:07:19Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4824-WSmaxOutgoingFrames"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjM3MTU1", "url": "https://github.com/eclipse/jetty.project/pull/5059#pullrequestreview-480637155", "createdAt": "2020-09-02T09:19:35Z", "commit": {"oid": "576b1e23230aed8660b8e6f1bf296b001dd1eebb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToxOTozNVrOHLmfKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToxOTozNVrOHLmfKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkyNjk1Mg==", "bodyText": "Please change the exception from IOException to WritePendingException.", "url": "https://github.com/eclipse/jetty.project/pull/5059#discussion_r481926952", "createdAt": "2020-09-02T09:19:35Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-common/src/main/java/org/eclipse/jetty/websocket/common/WebSocketRemoteEndpoint.java", "diffHunk": "@@ -303,6 +305,19 @@ public void uncheckedSendFrame(WebSocketFrame frame, WriteCallback callback)\n         BatchMode batchMode = BatchMode.OFF;\n         if (frame.isDataFrame())\n             batchMode = getBatchMode();\n+\n+        if (maxNumOutgoingFrames > 0 && frame.isDataFrame())\n+        {\n+            // Increase the number of outgoing frames, will be decremented when callback is completed.\n+            int outgoingFrames = numOutgoingFrames.incrementAndGet();\n+            callback = from(callback, numOutgoingFrames::decrementAndGet);\n+            if (outgoingFrames > maxNumOutgoingFrames)\n+            {\n+                callback.writeFailed(new IOException(\"Exceeded max outgoing frames: \" + outgoingFrames + \">\" + maxNumOutgoingFrames));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "576b1e23230aed8660b8e6f1bf296b001dd1eebb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f788260abd097308fb5f560baca2345a59d4175f", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/f788260abd097308fb5f560baca2345a59d4175f", "committedDate": "2020-09-03T04:58:09Z", "message": "Issue #4824 - use WritePendingException instead of IOException\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c9f8730b3881585f814ecbd32733b801e52f4d", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/52c9f8730b3881585f814ecbd32733b801e52f4d", "committedDate": "2020-09-04T00:45:47Z", "message": "Issue #4824 - create test for WebSocket maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDE5MzQ5", "url": "https://github.com/eclipse/jetty.project/pull/5059#pullrequestreview-482419349", "createdAt": "2020-09-04T07:25:11Z", "commit": {"oid": "52c9f8730b3881585f814ecbd32733b801e52f4d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzoyNToxMVrOHNCpzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzoyNToxMVrOHNCpzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzNzAwNg==", "bodyText": "Please add some text that explains what happens if the limit is exceeded.\nWhat operation will get what exception, etc.", "url": "https://github.com/eclipse/jetty.project/pull/5059#discussion_r483437006", "createdAt": "2020-09-04T07:25:11Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-api/src/main/java/org/eclipse/jetty/websocket/api/RemoteEndpoint.java", "diffHunk": "@@ -141,6 +141,24 @@\n      */\n     void setBatchMode(BatchMode mode);\n \n+    /**\n+     * Set the maximum number of frames which allowed to be waiting to be sent at any one time.\n+     * The default value is -1, this indicates there is no limit on how many frames can be\n+     * queued to be sent by the implementation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c9f8730b3881585f814ecbd32733b801e52f4d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5810b930d756f5e1f0878cb6b202abc78ecb164", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/b5810b930d756f5e1f0878cb6b202abc78ecb164", "committedDate": "2020-09-04T07:43:36Z", "message": "Issue #5824 - improve javadocs for RemoteEndpoint maxOutgoingFrames\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTU4MTc0", "url": "https://github.com/eclipse/jetty.project/pull/5059#pullrequestreview-483558174", "createdAt": "2020-09-07T13:32:18Z", "commit": {"oid": "b5810b930d756f5e1f0878cb6b202abc78ecb164"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd7920143d1d968f014f4cfc8799f0b64234d3c", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/4fd7920143d1d968f014f4cfc8799f0b64234d3c", "committedDate": "2020-09-09T23:46:12Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-4824-WSmaxOutgoingFrames"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44b62038c72524433da5c482c0651257689c027", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/b44b62038c72524433da5c482c0651257689c027", "committedDate": "2020-09-09T23:50:52Z", "message": "reorder methods for maxOutgoingFrames, fix javadoc\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 370, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}