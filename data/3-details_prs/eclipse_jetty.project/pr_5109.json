{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxODk2MTk5", "number": 5109, "title": "Issue #5108 - improve scalability of WebSocket SessionTrackers", "bodyText": "Issue #5108\nUse a set based on ConcurrentHashMap instead of CopyOnWriteArraySet for the WebSocket SessionTrackers.\n\nThe current data structure for SessionTracker is CopyOnWriteArraySet, which has the following description in the javadoc.\n\nIt is best suited for applications in which set sizes generally stay small, read-only operations vastly outnumber mutative operations, and you need to prevent interference among threads during traversal.\nMutative operations (add, set, remove, etc.) are expensive since they usually entail copying the entire underlying array.\nTraversal via iterators is fast and cannot encounter interference from other threads.\n\n\nThis seems particularly badly suited to our use case.\n\nWe probably will not have a small set size.\nWrite operations usually outnumber the read operations. (assuming they don't call getSessions() very often).\nIt may be the case where we never iterate over the open sessions until doStop().", "createdAt": "2020-08-03T01:34:23Z", "url": "https://github.com/eclipse/jetty.project/pull/5109", "merged": true, "mergeCommit": {"oid": "8af767f3a621efa508d49da31c5dd0e066ae7662"}, "closed": true, "closedAt": "2020-08-04T10:28:29Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7HC-eAH2gAyNDYxODk2MTk5OmQzNzUwMWRjZTBjMzJjOTM5ZGJlMGNkYjUyZmFkMzdmYWM3M2M2MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7jTLFAFqTQ2MDY1MzI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d37501dce0c32c939dbe0cdb52fad37fac73c60a", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/d37501dce0c32c939dbe0cdb52fad37fac73c60a", "committedDate": "2020-08-03T00:40:12Z", "message": "Issue #5108 - use HashSet for SessionTrackers to improve scalability\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODA5Njcz", "url": "https://github.com/eclipse/jetty.project/pull/5109#pullrequestreview-459809673", "createdAt": "2020-08-03T07:38:04Z", "commit": {"oid": "d37501dce0c32c939dbe0cdb52fad37fac73c60a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzozODowNFrOG6vKuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNzozODowNFrOG6vKuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MzM4NA==", "bodyText": "Using a naked HashSet is way better than CopyOnWriteArraySet.\nHowever, I think you can do even better with Collections.newSetFromMap(new ConcurrentHashMap<>()).\nIn this way, we don't use a lock at all (as CHM will take care of that) and we don't need to do all the work that CopyOnWriteArraySet does.", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464243384", "createdAt": "2020-08-03T07:38:04Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/javax-websocket-client-impl/src/main/java/org/eclipse/jetty/websocket/jsr356/JsrSessionTracker.java", "diffHunk": "@@ -19,37 +19,47 @@\n package org.eclipse.jetty.websocket.jsr356;\n \n import java.util.Collections;\n+import java.util.HashSet;\n import java.util.Set;\n-import java.util.concurrent.CopyOnWriteArraySet;\n+import javax.websocket.Session;\n \n import org.eclipse.jetty.util.component.AbstractLifeCycle;\n import org.eclipse.jetty.util.component.LifeCycle;\n \n public class JsrSessionTracker extends AbstractLifeCycle implements JsrSessionListener\n {\n-    private CopyOnWriteArraySet<JsrSession> sessions = new CopyOnWriteArraySet<>();\n+    private final Set<JsrSession> sessions = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d37501dce0c32c939dbe0cdb52fad37fac73c60a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/85c4fc53350a8162496ed8c79dfc28215e5bb07e", "committedDate": "2020-08-03T08:26:14Z", "message": "Issue #5108 - use set based on ConcurrentHashMap and remove synchronized blocks\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODk5NzAw", "url": "https://github.com/eclipse/jetty.project/pull/5109#pullrequestreview-459899700", "createdAt": "2020-08-03T09:56:17Z", "commit": {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTo1NjoxN1rOG6zdnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTo1NjoxN1rOG6zdnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMxMzc1OQ==", "bodyText": "while iterating over the set is thread safe, it doesn't prevent other sessions from being added while you are iterating.  So either you need to ensure that once you are stopping, new sessions can't be added, or you need some outer while (sessions.size()>0) loop.", "url": "https://github.com/eclipse/jetty.project/pull/5109#discussion_r464313759", "createdAt": "2020-08-03T09:56:17Z", "author": {"login": "gregw"}, "path": "jetty-websocket/javax-websocket-client-impl/src/main/java/org/eclipse/jetty/websocket/jsr356/JsrSessionTracker.java", "diffHunk": "@@ -49,7 +51,7 @@ public void onSessionClosed(JsrSession session)\n     @Override\n     protected void doStop() throws Exception\n     {\n-        for (JsrSession session : sessions)\n+        for (Session session : sessions)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTE5ODIw", "url": "https://github.com/eclipse/jetty.project/pull/5109#pullrequestreview-460119820", "createdAt": "2020-08-03T15:24:33Z", "commit": {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjUzMjgw", "url": "https://github.com/eclipse/jetty.project/pull/5109#pullrequestreview-460653280", "createdAt": "2020-08-04T09:35:14Z", "commit": {"oid": "85c4fc53350a8162496ed8c79dfc28215e5bb07e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 396, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}