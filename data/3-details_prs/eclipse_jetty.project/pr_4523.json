{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzYyMjY3", "number": 4523, "title": "Issue #4502 - allow changing of close response from jetty and javax websocket onClose events", "bodyText": "Issue #4502\nAllow sending frames or custom close codes from Jetty WebSocket onWebSocketClose event or the java.websocket onClose event.\nCloses #4502", "createdAt": "2020-01-29T04:25:38Z", "url": "https://github.com/eclipse/jetty.project/pull/4523", "merged": true, "mergeCommit": {"oid": "19354d0c2445b52516d435b34a7124e6ff5b5d11"}, "closed": true, "closedAt": "2020-01-29T22:10:48Z", "author": {"login": "lachlan-roberts"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb--G0qAH2gAyMzY4MzYyMjY3OjRlZjIwOGU5ZjYyMjgyZmY4YTkzMTVlZjgwZDQ3YjQzY2U5YTcwZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_FH-wAFqTM1MDA2OTI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ef208e9f62282ff8a9315ef80d47b43ce9a70f8", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/4ef208e9f62282ff8a9315ef80d47b43ce9a70f8", "committedDate": "2020-01-29T04:19:48Z", "message": "Issue #4502 - onClose can now be triggered on receiving a close frame\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd27a9f28a66754675cd2db0f11a8b3e3593503", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/fdd27a9f28a66754675cd2db0f11a8b3e3593503", "committedDate": "2020-01-29T04:20:36Z", "message": "Issue #4502 - add onClose tests for Jetty and Javax WS APIs\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458", "author": {"user": {"login": "lachlan-roberts", "name": "Lachlan"}}, "url": "https://github.com/eclipse/jetty.project/commit/8638fb2cc3ed80c7410249a31ad253d67479a458", "committedDate": "2020-01-29T08:13:03Z", "message": "Fix broken test cases\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTcwMjc4", "url": "https://github.com/eclipse/jetty.project/pull/4523#pullrequestreview-349970278", "createdAt": "2020-01-29T09:38:34Z", "commit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozODozNVrOFjB9BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0MToxNlrOFjCCZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NjQ4NQ==", "bodyText": "How can this happen?  Is this a problem with Core?", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372276485", "createdAt": "2020-01-29T09:38:35Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)\n+    {\n+        notifyOnClose(CloseStatus.getCloseStatus(frame), callback);\n+    }\n+\n     @Override\n     public void onClosed(CloseStatus closeStatus, Callback callback)\n     {\n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onJavaxWebSocketSessionClosed(session));\n+    }\n+\n+    private void notifyOnClose(CloseStatus closeStatus, Callback callback)\n+    {\n+        // Make sure onClose is only notified once.\n+        if (!closeNotified.compareAndSet(false, true))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3Nzg2MA==", "bodyText": "why public?  surely protected?", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372277860", "createdAt": "2020-01-29T09:41:16Z", "author": {"login": "gregw"}, "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTk2Nzgz", "url": "https://github.com/eclipse/jetty.project/pull/4523#pullrequestreview-349996783", "createdAt": "2020-01-29T10:19:22Z", "commit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxOToyMlrOFjDPKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMzoyMFrOFjDWaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzUxMg==", "bodyText": "You don't want to wrap a RuntimeException inside another... the old code was correct.", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372297512", "createdAt": "2020-01-29T10:19:22Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/FutureCallback.java", "diffHunk": "@@ -163,9 +163,7 @@ public void block(long timeout, TimeUnit unit) throws IOException\n         {\n             Throwable cause = e.getCause();\n             if (cause instanceof RuntimeException)\n-                throw (RuntimeException)cause;\n-            else if (cause instanceof IOException)\n-                throw (IOException)cause;\n+                throw new RuntimeException(cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5ODc5Ng==", "bodyText": "notifyOnClose() has a guard to avoid notifying more than once, but then container.notifySessionListeners() will be called more than once, so either notifyOnClose() returns a boolean or you need to be tighter with the once-only semantic.", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372298796", "createdAt": "2020-01-29T10:22:11Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)\n+    {\n+        notifyOnClose(CloseStatus.getCloseStatus(frame), callback);\n+    }\n+\n     @Override\n     public void onClosed(CloseStatus closeStatus, Callback callback)\n     {\n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onJavaxWebSocketSessionClosed(session));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTM2OA==", "bodyText": "Ditto above.", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372299368", "createdAt": "2020-01-29T10:23:20Z", "author": {"login": "sbordet"}, "path": "jetty-websocket/websocket-jetty-common/src/main/java/org/eclipse/jetty/websocket/common/JettyWebSocketFrameHandler.java", "diffHunk": "@@ -287,6 +295,19 @@ public void onClosed(CloseStatus closeStatus, Callback callback)\n             state = SuspendState.CLOSED;\n         }\n \n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onWebSocketSessionClosed(session));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDY5MjYw", "url": "https://github.com/eclipse/jetty.project/pull/4523#pullrequestreview-350069260", "createdAt": "2020-01-29T12:29:15Z", "commit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjoyOToxNVrOFjGtKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjoyOToxNVrOFjGtKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDM0Ng==", "bodyText": "I see now, leave this rewrapping then, so applications will have a nicer stack trace that get lost because we unwrap ExecutionException.", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372354346", "createdAt": "2020-01-29T12:29:15Z", "author": {"login": "sbordet"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/FutureCallback.java", "diffHunk": "@@ -163,9 +163,7 @@ public void block(long timeout, TimeUnit unit) throws IOException\n         {\n             Throwable cause = e.getCause();\n             if (cause instanceof RuntimeException)\n-                throw (RuntimeException)cause;\n-            else if (cause instanceof IOException)\n-                throw (IOException)cause;\n+                throw new RuntimeException(cause);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzUxMg=="}, "originalCommit": {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 565, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}