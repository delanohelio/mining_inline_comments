{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDc1NjIw", "number": 5175, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo1MjozN1rOEaLEKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyOToyOFrOEcJgaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1ODc5NzIxOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo1MjozN1rOHDbl1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoxODoxOFrOHFscpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA==", "bodyText": "@gregw are you sure that this behaviour change is ok?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r473359828", "createdAt": "2020-08-19T21:52:37Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTI5OA==", "bodyText": "Not really. This handler should never send a 404. It should either send a 503 or return without handling the request at all.\nI tend to think the later is more flexible and that context handler can send any 503s", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101298", "createdAt": "2020-08-22T15:26:06Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDU3NQ==", "bodyText": "The StatisticsHandler is not sending the 404, it is not handling the request and then the HttpChannel is sending a 404 because the request was not handled. Previously we were sending 503s from the StatisticsHandler now we are not.\nIf the StatisticsHandler is wrapping a ContextHandler then the ContextHandler won't be able to send any 503s as the request will never get there.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475364575", "createdAt": "2020-08-24T06:16:51Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczMzE1OA==", "bodyText": "Ah I wasn't looking closely enough.    But I still think we shouldn't change this behaviour, at least not in 9", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475733158", "createdAt": "2020-08-24T16:18:18Z", "author": {"login": "gregw"}, "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTgyNzUzOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNToyNDowM1rOHFF3lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMDo0NDoyMVrOHF9VUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA==", "bodyText": "I think this pattern had been used in other handlers and filters... can you check that we've not made the same mistake elsewhere.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101078", "createdAt": "2020-08-22T15:24:03Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2OTA0Mw==", "bodyText": "I think there might be a similar issue in DebugHandler but that look like the only one.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475369043", "createdAt": "2020-08-24T06:29:47Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczMjU4OA==", "bodyText": "OK - fix it in the PR", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475732588", "createdAt": "2020-08-24T16:17:25Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAwOTgwOQ==", "bodyText": "Looks like DebugHandler is deprecated and its replacement DebugListener does not have the same issue.\nI have pushed a fix to this PR for DebugHandler.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476009809", "createdAt": "2020-08-25T00:44:21Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTgzMTYxOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNToyOTozNVrOHFF5dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNToyOTozNVrOHFF5dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTU1OQ==", "bodyText": "Bad name as \"suspended\" is no longer really a thing and the name is a hangover from completions.\nThe choice is between shutting down on zero request or zero dispatched... how about just asyncGraceful?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101559", "createdAt": "2020-08-22T15:29:35Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -67,6 +66,8 @@\n     private final LongAdder _responses5xx = new LongAdder();\n     private final LongAdder _responsesTotalBytes = new LongAdder();\n \n+    private boolean waitForSuspendedRequestsOnShutdown = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTgzMjU5OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNTozMDozMFrOHFF55g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNTozMDozMFrOHFF55g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTY3MA==", "bodyText": "start name with set", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101670", "createdAt": "2020-08-22T15:30:30Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +259,16 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete (including suspended requests)\n+     * or whether it should only wait for all the actively dispatched requests to complete.\n+     * @param waitForSuspendedRequests true to wait for suspended requests on graceful shutdown.\n+     */\n+    public void waitForSuspendedRequestsOnShutdown(boolean waitForSuspendedRequests)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e"}, "originalPosition": 181}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NDIzOTU2OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyMDoyM1rOHFshhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyMDoyM1rOHFshhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNDQwNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <Set name=\"asyncGraceful\">\n          \n          \n            \n                      <Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/>\n          \n          \n            \n                    </Set>\n          \n          \n            \n                    <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>\n          \n      \n    \n    \n  \n\nand when it merges to 10 it becomes:\n        <Set name=\"asyncGraceful\" property=\"jetty.statistics.asyncGraceful\"/>", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475734405", "createdAt": "2020-08-24T16:20:23Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,11 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\">\n+          <Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/>\n+        </Set>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0268c590f118720537e1b72c9a4cb1915cdfc39"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTQ5MDkwOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyNDoxMlrOHGf7vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMjoxODoxOVrOHHJWAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NjcwMw==", "bodyText": "\"asyncGraceful\" does not really convey the notion that is the shutdown that is graceful, and for full requests.\nI would rename this to \"gracefulShutdownWaitsForRequests\".", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476576703", "createdAt": "2020-08-25T16:24:12Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,9 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAzMDAzNw==", "bodyText": "The graceful shutdown of waiting for requests isn't enabled by this setter, it is just switching the mode to whether we wait for async requests or not. Would gracefulShutdownWaitsForAsyncRequests be a better name?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r477030037", "createdAt": "2020-08-26T04:41:45Z", "author": {"login": "lachlan-roberts"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,9 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NjcwMw=="}, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3ODQ1NA==", "bodyText": "@lachlan-roberts it waits for requests, whether they are async or not, so no need for async in the name.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r477078454", "createdAt": "2020-08-26T07:03:11Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,9 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NjcwMw=="}, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI1NTE2OQ==", "bodyText": "gracefulShutdownOnRequestsComplete ?", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r477255169", "createdAt": "2020-08-26T12:18:19Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/config/etc/jetty-stats.xml", "diffHunk": "@@ -5,7 +5,9 @@\n <Configure id=\"Server\" class=\"org.eclipse.jetty.server.Server\">\n   <Call name=\"insertHandler\">\n     <Arg>\n-      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\"></New>\n+      <New id=\"StatsHandler\" class=\"org.eclipse.jetty.server.handler.StatisticsHandler\">\n+        <Set name=\"asyncGraceful\"><Property name=\"jetty.statistics.asyncGraceful\" default=\"true\"/></Set>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NjcwMw=="}, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTQ5NzIxOnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyNTo0MVrOHGf_mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyNTo0MVrOHGf_mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzY5MA==", "bodyText": "Fix the comment above the if statement too, or remove it altogether so it won't rot.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476577690", "createdAt": "2020-08-25T16:25:41Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -105,15 +106,15 @@ public void onComplete(AsyncEvent event) throws IOException\n             Request request = state.getBaseRequest();\n             final long elapsed = System.currentTimeMillis() - request.getTimeStamp();\n \n-            long d = _requestStats.decrement();\n+            long numRequests = _requestStats.decrement();\n             _requestTimeStats.record(elapsed);\n \n             updateResponse(request);\n \n             _asyncWaitStats.decrement();\n \n             // If we have no more dispatches, should we signal shutdown?\n-            if (d == 0)\n+            if (numRequests == 0 && asyncGraceful)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTUxMzM5OnYy", "diffSide": "RIGHT", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyOToyOFrOHGgJdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjoyOToyOFrOHGgJdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MDIxNA==", "bodyText": "The getter method is missing and should be annotated with @ManagedAttribute.", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476580214", "createdAt": "2020-08-25T16:29:28Z", "author": {"login": "sbordet"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +264,17 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete including\n+     * async requests which are not currently dispatched, or whether it should only wait for all the\n+     * actively dispatched requests to complete.\n+     * @param asyncGraceful true to wait for async requests on graceful shutdown.\n+     */\n+    public void setAsyncGraceful(boolean asyncGraceful)\n+    {\n+        this.asyncGraceful = asyncGraceful;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9"}, "originalPosition": 182}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2319, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}