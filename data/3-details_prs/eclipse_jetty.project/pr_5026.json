{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Mjg0MzAy", "number": 5026, "title": "Issue #5025 - wrong welcome file handling with dispatcher.include() a\u2026", "bodyText": "\u2026nd non-default mapping", "createdAt": "2020-07-04T13:23:01Z", "url": "https://github.com/eclipse/jetty.project/pull/5026", "merged": true, "mergeCommit": {"oid": "b08fd185c8920a5a6f2d53b079377fc83d612482"}, "closed": true, "closedAt": "2020-07-15T12:29:33Z", "author": {"login": "grgrzybek"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxoBMugBqjM1MTI1NjI2MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1JzBygFqTQ0ODkwMzY0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e8954c7d12c707276a6bb1833b7dd5b38e30a31", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e8954c7d12c707276a6bb1833b7dd5b38e30a31", "committedDate": "2020-07-04T13:21:56Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping"}, "afterCommit": {"oid": "c7d114f67d13417f97fb2601d683b266ad39ea2e", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/c7d114f67d13417f97fb2601d683b266ad39ea2e", "committedDate": "2020-07-04T13:25:39Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7d114f67d13417f97fb2601d683b266ad39ea2e", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/c7d114f67d13417f97fb2601d683b266ad39ea2e", "committedDate": "2020-07-04T13:25:39Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}, "afterCommit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/72d3d1d6034cd267e78adb8acc7b02f2312e0089", "committedDate": "2020-07-04T13:51:50Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjE3MTg3", "url": "https://github.com/eclipse/jetty.project/pull/5026#pullrequestreview-442617187", "createdAt": "2020-07-04T15:54:49Z", "commit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNTo1NDo0OVrOGs8oSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNTo1NDo0OVrOGs8oSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ==", "bodyText": "This should be GET /context/gateway/ HTTP/1.0\\r\\n\\r\\n as you are requesting content belonging to the url-pattern of /gateway/* which the request to /gateway will not match.", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449783881", "createdAt": "2020-07-04T15:54:49Z", "author": {"login": "joakime"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,46 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet() {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");\n+\n+        String rawResponse;\n+        HttpTester.Response response;\n+\n+        // Test included alt default\n+        rawResponse = connector.getResponse(\"GET /context/gateway HTTP/1.0\\r\\n\\r\\n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/72d3d1d6034cd267e78adb8acc7b02f2312e0089", "committedDate": "2020-07-04T13:51:50Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}, "afterCommit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/a14a665af6587eabe82c621690eb77956d9641d8", "committedDate": "2020-07-04T15:57:23Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjE3Mzcy", "url": "https://github.com/eclipse/jetty.project/pull/5026#pullrequestreview-442617372", "createdAt": "2020-07-04T15:58:17Z", "commit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNTo1ODo0MlrOGs8pbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNTo1ODo0OFrOGs8pfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDE3NQ==", "bodyText": "This addServlet should be done before Server.start()", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784175", "createdAt": "2020-07-04T15:58:42Z", "author": {"login": "joakime"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,48 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet()\n+        {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException\n+            {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDE4OA==", "bodyText": "This addServlet should be done before Server.start()", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784188", "createdAt": "2020-07-04T15:58:48Z", "author": {"login": "joakime"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,48 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjczNDA0", "url": "https://github.com/eclipse/jetty.project/pull/5026#pullrequestreview-445673404", "createdAt": "2020-07-09T14:30:07Z", "commit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDozMDowN1rOGvT0NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDozMzo1MVrOGvT-zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2MDkxNg==", "bodyText": "I think this is a good solution. I would delete the extra \"if\" at line 406 because that can never happen, unless there's a bug in jetty :)", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r452260916", "createdAt": "2020-07-09T14:30:07Z", "author": {"login": "janbartel"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ResourceService.java", "diffHunk": "@@ -401,8 +401,13 @@ protected void sendWelcome(HttpContent content, String pathInContext, boolean en\n \n         if (welcome != null)\n         {\n+            String servletPath = included ? (String)request.getAttribute(RequestDispatcher.INCLUDE_SERVLET_PATH)\n+                    : request.getServletPath();\n+            if (servletPath == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2MzYzMQ==", "bodyText": "I think you've got 2 differents tests to do here:\n\n\nurl is /context/gateway  WITHOUT the trailing slash, which will go to line 377 of ResourceService that does a 302 redirect to url that adds the trailing slash\n\n\nurl is /context/gateway/  WITH the trailing slash, which will go to the code at line 402 of ResourceService", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r452263631", "createdAt": "2020-07-09T14:33:51Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,46 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet() {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");\n+\n+        String rawResponse;\n+        HttpTester.Response response;\n+\n+        // Test included alt default\n+        rawResponse = connector.getResponse(\"GET /context/gateway HTTP/1.0\\r\\n\\r\\n\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ=="}, "originalCommit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a14a665af6587eabe82c621690eb77956d9641d8", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/a14a665af6587eabe82c621690eb77956d9641d8", "committedDate": "2020-07-04T15:57:23Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}, "afterCommit": {"oid": "84395958f612ea53839f00ac00dd1ab5564e77af", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/84395958f612ea53839f00ac00dd1ab5564e77af", "committedDate": "2020-07-10T12:16:56Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "committedDate": "2020-07-10T12:19:15Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84395958f612ea53839f00ac00dd1ab5564e77af", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/84395958f612ea53839f00ac00dd1ab5564e77af", "committedDate": "2020-07-10T12:16:56Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}, "afterCommit": {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "author": {"user": {"login": "grgrzybek", "name": "Grzegorz Grzybek"}}, "url": "https://github.com/eclipse/jetty.project/commit/93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "committedDate": "2020-07-10T12:19:15Z", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzkwNDgw", "url": "https://github.com/eclipse/jetty.project/pull/5026#pullrequestreview-448790480", "createdAt": "2020-07-15T09:37:28Z", "commit": {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwOTozNzoyOFrOGx2TOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwOTozNzoyOFrOGx2TOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyMzA2Nw==", "bodyText": "@grgrzybek I'd still like to see one request with GET /context/gateway and one with GET /context/gateway/, because the first one will do a redirect before doing the new include path handling: I just want to ensure that we've exercised both codepaths.", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r454923067", "createdAt": "2020-07-15T09:37:28Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,46 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet() {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");\n+\n+        String rawResponse;\n+        HttpTester.Response response;\n+\n+        // Test included alt default\n+        rawResponse = connector.getResponse(\"GET /context/gateway HTTP/1.0\\r\\n\\r\\n\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ=="}, "originalCommit": {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTAzNjQ4", "url": "https://github.com/eclipse/jetty.project/pull/5026#pullrequestreview-448903648", "createdAt": "2020-07-15T12:28:57Z", "commit": {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 356, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}