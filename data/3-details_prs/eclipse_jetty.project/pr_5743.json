{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMTU2OTE1", "number": 5743, "title": "max usage count fixes", "bodyText": "Closes #5741", "createdAt": "2020-12-01T09:26:30Z", "url": "https://github.com/eclipse/jetty.project/pull/5743", "merged": true, "mergeCommit": {"oid": "6199c975d2dd59a8fabc60689bec34f5d0b1f624"}, "closed": true, "closedAt": "2020-12-01T14:19:25Z", "author": {"login": "lorban"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh2J_FgH2gAyNTMwMTU2OTE1OjBmZjFiZmRkNWU0ZDZkYjZiNmRkNzgyNzliNjMxN2ZlM2JiZjljNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh6rGBABqjQwNTc0MjY1ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ff1bfdd5e4d6db6b6dd78279b6317fe3bbf9c57", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/0ff1bfdd5e4d6db6b6dd78279b6317fe3bbf9c57", "committedDate": "2020-12-01T09:02:31Z", "message": "fix bug that messes up the max usage count when the entries' max usage counter overflows\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzExMDI3", "url": "https://github.com/eclipse/jetty.project/pull/5743#pullrequestreview-541711027", "createdAt": "2020-12-01T09:32:56Z", "commit": {"oid": "e2c480124fa71cd1abc019e390fdde7cc547186f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwOTozMjo1NlrOH8hXJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwOTozMjo1NlrOH8hXJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIyMzIwNQ==", "bodyText": "Would it not be better to do all the removals whilst the lock is held and only do the closing after releasing the lock:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<Entry> copy;\n          \n          \n            \n                    try (Locker.Lock l = locker.lock())\n          \n          \n            \n                    {\n          \n          \n            \n                        copy = new ArrayList<>(entries);\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    // Iterate the copy and close overused entries.\n          \n          \n            \n                    for (Entry entry : copy)\n          \n          \n            \n                    {\n          \n          \n            \n                        if (entry.isIdleAndOverUsed() && remove(entry) && entry.pooled instanceof Closeable)\n          \n          \n            \n                            IO.close((Closeable)entry.pooled);\n          \n          \n            \n                    }\n          \n          \n            \n                    List<Entry> overused = new ArrayList();\n          \n          \n            \n                    try (Locker.Lock l = locker.lock())\n          \n          \n            \n                    {\n          \n          \n            \n                        // look for overused here and if found remove from entries and add to overused\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    // Iterate the copy and close overused entries.\n          \n          \n            \n                    for (Entry entry : overused)\n          \n          \n            \n                    {\n          \n          \n            \n                        if (entry.pooled instanceof Closeable)\n          \n          \n            \n                            IO.close((Closeable)entry.pooled);\n          \n          \n            \n                    }", "url": "https://github.com/eclipse/jetty.project/pull/5743#discussion_r533223205", "createdAt": "2020-12-01T09:32:56Z", "author": {"login": "gregw"}, "path": "jetty-util/src/main/java/org/eclipse/jetty/util/Pool.java", "diffHunk": "@@ -166,16 +166,42 @@ public final void setMaxMultiplex(int maxMultiplex)\n         this.maxMultiplex = maxMultiplex;\n     }\n \n+    /**\n+     * Get the maximum number of times the entries of the pool\n+     * can be acquired.\n+     * @return the max usage count.\n+     */\n     public int getMaxUsageCount()\n     {\n         return maxUsageCount;\n     }\n \n+    /**\n+     * Change the max usage count of the pool's entries. All existing\n+     * idle entries over this new max usage are removed and closed.\n+     * @param maxUsageCount the max usage count.\n+     */\n     public final void setMaxUsageCount(int maxUsageCount)\n     {\n         if (maxUsageCount == 0)\n             throw new IllegalArgumentException(\"Max usage count must be != 0\");\n         this.maxUsageCount = maxUsageCount;\n+\n+        if (closed)\n+            return;\n+\n+        List<Entry> copy;\n+        try (Locker.Lock l = locker.lock())\n+        {\n+            copy = new ArrayList<>(entries);\n+        }\n+\n+        // Iterate the copy and close overused entries.\n+        for (Entry entry : copy)\n+        {\n+            if (entry.isIdleAndOverUsed() && remove(entry) && entry.pooled instanceof Closeable)\n+                IO.close((Closeable)entry.pooled);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c480124fa71cd1abc019e390fdde7cc547186f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzk4Njk4", "url": "https://github.com/eclipse/jetty.project/pull/5743#pullrequestreview-541798698", "createdAt": "2020-12-01T11:20:13Z", "commit": {"oid": "be5de288ed0a13448d3183ce3b760bb07a23a370"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e6f4aeb8bdbcb140ba99ba6480c9127844758b", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/44e6f4aeb8bdbcb140ba99ba6480c9127844758b", "committedDate": "2020-12-01T14:18:06Z", "message": "sweep the entries list when the max usage count is changed\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be5de288ed0a13448d3183ce3b760bb07a23a370", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/be5de288ed0a13448d3183ce3b760bb07a23a370", "committedDate": "2020-12-01T10:18:11Z", "message": "improve the entries list' sweep when the max usage count is changed\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}, "afterCommit": {"oid": "44e6f4aeb8bdbcb140ba99ba6480c9127844758b", "author": {"user": {"login": "lorban", "name": "Ludovic Orban"}}, "url": "https://github.com/eclipse/jetty.project/commit/44e6f4aeb8bdbcb140ba99ba6480c9127844758b", "committedDate": "2020-12-01T14:18:06Z", "message": "sweep the entries list when the max usage count is changed\n\nSigned-off-by: Ludovic Orban <lorban@bitronix.be>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 590, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}