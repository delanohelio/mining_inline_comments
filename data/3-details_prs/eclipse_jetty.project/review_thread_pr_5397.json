{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTY1NDQx", "number": 5397, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMTo0MlrOEqpR1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMzo1OFrOEqpVDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMTUxOTU3OnYy", "diffSide": "RIGHT", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMTo0MlrOHc97DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMTo0MlrOHc97DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNjcxNg==", "bodyText": "Can we put in some comments about what is really being tested here, which is the various states in which the ServletContextHandler, ServletHandler can be in when a servlet/filter/listener is added.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500136716", "createdAt": "2020-10-06T09:31:42Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMTUyMzM0OnYy", "diffSide": "RIGHT", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMjo0MFrOHc99dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMjo0MFrOHc99dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzMzNQ==", "bodyText": "Can we also please add tests for all the types of objects: adding servlets, filters and listeners from servlets, filters and listeners to make sure that the jetty apis are doing what we expect", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137335", "createdAt": "2020-10-06T09:32:40Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMTUyNzM0OnYy", "diffSide": "RIGHT", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMzo0NlrOHc9_7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTowODo0OFrOHdBMiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzk2NQ==", "bodyText": "So this means that in the past, adding a listener when the ServletHandler had already started would not have worked, because it never would have been started or initialized - unless someone also happened to add a filter or servlet mapping.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500137965", "createdAt": "2020-10-06T09:33:46Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -800,10 +823,7 @@ public void addListener(ListenerHolder listener)\n     public void setListeners(ListenerHolder[] listeners)\n     {\n         if (listeners != null)\n-            for (ListenerHolder holder : listeners)\n-            {\n-                holder.setServletHandler(this);\n-            }\n+            initializeHolders(listeners);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE5MDM0NQ==", "bodyText": "yep - 2nd bug!", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500190345", "createdAt": "2020-10-06T11:08:48Z", "author": {"login": "gregw"}, "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -800,10 +823,7 @@ public void addListener(ListenerHolder listener)\n     public void setListeners(ListenerHolder[] listeners)\n     {\n         if (listeners != null)\n-            for (ListenerHolder holder : listeners)\n-            {\n-                holder.setServletHandler(this);\n-            }\n+            initializeHolders(listeners);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzNzk2NQ=="}, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMTUyNzgyOnYy", "diffSide": "RIGHT", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMzo1OFrOHc-ASQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozMzo1OFrOHc-ASQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzODA1Nw==", "bodyText": "Delete this line.", "url": "https://github.com/eclipse/jetty.project/pull/5397#discussion_r500138057", "createdAt": "2020-10-06T09:33:58Z", "author": {"login": "janbartel"}, "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/ServletContextHandlerTest.java", "diffHunk": "@@ -1651,21 +1651,35 @@ public void testProgrammaticFilterServlet() throws Exception\n         ServletHandler handler = new ServletHandler();\n         _server.setHandler(context);\n         context.setHandler(handler);\n-        handler.addServletWithMapping(new ServletHolder(new TestServlet()), \"/\");\n+        handler.addServletWithMapping(new ServletHolder(new TestServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/test/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/test\");\n \n         _server.start();\n \n-\n         String request =\n-            \"GET /hello HTTP/1.0\\n\" +\n+            \"GET /test HTTP/1.0\\n\" +\n             \"Host: localhost\\n\" +\n             \"\\n\";\n         String response = _connector.getResponse(request);\n         assertThat(response, containsString(\"200 OK\"));\n+        assertThat(response, containsString(\"filter: filter\"));\n         assertThat(response, containsString(\"Test\"));\n \n-        handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/*\", EnumSet.of(DispatcherType.REQUEST));\n-        handler.addServletWithMapping(new ServletHolder(new HelloServlet()), \"/hello/*\");\n+\n+        handler.addServletWithMapping(new ServletHolder(new HelloServlet()\n+        {\n+            @Override\n+            public void init() throws ServletException\n+            {\n+                handler.addFilterWithMapping(new FilterHolder(new MyFilter()), \"/hello/*\", EnumSet.of(DispatcherType.REQUEST));\n+            }\n+        }), \"/hello/*\");\n \n         _server.dumpStdErr();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1cadade4ef3b02405d0c7e4e2b9d6c200c550d"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2257, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}