{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjkxNjQw", "number": 5097, "title": "Issue #2609 - Uniform Find Expired Sessions", "bodyText": "Closes #2609\nMake uniform across all types of SessionDataStore the way that expired and \"orphaned\" sessions are searched for and evaluated.\n\nPreviously each AbstractSessionDataStore subclass implemented the method doGetExpired(Set candidates) in whatever way they liked, leading to session expiry behaviour differences across different persistence technologies (eg jdbc, hazelcast, infinispan etc etc).\nThis change refactors that method into 3 different methods:  doGetExpired(Set candidates, long time), doGetExpired(long time) and cleanOrphans() to be implemented by subclasses, with the AbstractSessionDataStore orchestrating when these 3 methods are to be called.\nPreviously, it was unclear which sessions a SessionDataStore was considering for expiry, or for being orphaned, or how often these checks would be run. Now the AbstractDataStore determines the frequency of:\n\nchecking the candidate list of expired sessions suggested by the SessionCache\nchecking for other sessions for this context that were managed by other nodes that have expired in the persistent store, and determining uniformly the definition of that expiry time (ie how far past their expiry time is regarded as being expired and unused)\nsummarily deleting sessions for any context and managed by any node that are long past their expiry time (so called \"orphan\" session), and determining uniformly the definition of \"long past\" expiry\nas part of this work, found ways to implement these expiry and orphan methods for technologies such as Hazelcast, Infinispan and GCloud which were previously unable to proactively find expired sessions so that all SessionDataStores now all fully support full session lifecycle handling.\n\n\n\nMoved the exists(String id) method from subclasses up to the baseclass AbstractSessionDataStore and introduced the doExists(String id) method for subclasses to implement.\n\nIn this way the baseclass ensures that the subclass does the existence test in the scope of the context class loader (as is done for store() and load() where serialization may come into play).\n\nUpdated version of Hazelcast for the hazelcast session module.\nSome code cleanups along the way like removing blank lines, printlns, unused methods etc.", "createdAt": "2020-07-29T08:51:08Z", "url": "https://github.com/eclipse/jetty.project/pull/5097", "merged": true, "mergeCommit": {"oid": "ad9d702adba9e5409a7426cdb81868ad07d203c4"}, "closed": true, "closedAt": "2020-08-31T10:39:31Z", "author": {"login": "janbartel"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABY7ctsNgH2gAyNDU4MjkxNjQwOjlhMTU4ZWIxM2ZhOTllMTEzZDEyYTc3YWE1YTY1NzRiYjliM2I3MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCnVgGAH2gAyNDU4MjkxNjQwOjAzNzc4NGFhZTcxN2FhMTZkMGJiMzYwZjQ5NTk3NTBmNmJjMTc4Yzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a158eb13fa99e113d12a77aa5a6574bb9b3b700", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/9a158eb13fa99e113d12a77aa5a6574bb9b3b700", "committedDate": "2018-05-31T17:10:15Z", "message": "Issue #2609 WIP\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63b2e010a19e2de17e7393a4293e4e2251075b0f", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/63b2e010a19e2de17e7393a4293e4e2251075b0f", "committedDate": "2018-11-19T13:00:05Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-2609-findexpiredsessions\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7c1c7d2afe8765caca5e9b5b297920bb1340127", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/c7c1c7d2afe8765caca5e9b5b297920bb1340127", "committedDate": "2018-11-19T14:27:21Z", "message": "Issue #2609 Updates and renaming. WIP.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce5689956335e1808be7b1a5d7779451765a5cc0", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/ce5689956335e1808be7b1a5d7779451765a5cc0", "committedDate": "2019-01-30T04:41:23Z", "message": "Merge remote-tracking branch 'origin/jetty-9.4.x' into jetty-9.4.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dc045282c84c2dbd4dbcfe3f5948c5eead87a6b", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/4dc045282c84c2dbd4dbcfe3f5948c5eead87a6b", "committedDate": "2019-01-30T22:19:46Z", "message": "Issue #2609 WIP\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0092e448cbfbe95373fac20bc775b5e20a01c5", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/7c0092e448cbfbe95373fac20bc775b5e20a01c5", "committedDate": "2019-01-30T22:19:46Z", "message": "Issue #2609 Updates and renaming. WIP.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "663d4e5c8b4218ecfe807fcd21403abc0b1bc7e5", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/663d4e5c8b4218ecfe807fcd21403abc0b1bc7e5", "committedDate": "2019-01-30T22:37:02Z", "message": "Merge branch 'jetty-9.4.x-2609-findexpiredsessions' of github.com:eclipse/jetty.project into jetty-9.4.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd4518a4fb15249c0eb37249f8c93d161cd322f", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/cdd4518a4fb15249c0eb37249f8c93d161cd322f", "committedDate": "2019-01-31T06:50:30Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f17c141d213fea75a8e40bfd7393d67d68ec40", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/d1f17c141d213fea75a8e40bfd7393d67d68ec40", "committedDate": "2019-02-05T04:50:45Z", "message": "Issue #2609 Make orthogonal all session stores' search for expired\nsessions.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43449dc676803e181e675e0327defefdcd956da0", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/43449dc676803e181e675e0327defefdcd956da0", "committedDate": "2019-02-05T04:52:10Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e222c5d4eb68ce9aa4964ed15ae45500ce7b179", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/4e222c5d4eb68ce9aa4964ed15ae45500ce7b179", "committedDate": "2020-06-24T16:45:43Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f49822b125aa755380aa8022d7e73173e40f36", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/c3f49822b125aa755380aa8022d7e73173e40f36", "committedDate": "2020-06-29T13:51:56Z", "message": "Issue #2609 WIP\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39ea506f9d4f7219225827f78e4bdfeb305ec338", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/39ea506f9d4f7219225827f78e4bdfeb305ec338", "committedDate": "2020-06-29T13:52:57Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6334dbb983c53500a7b801c4d5742d9fcffc06", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/fd6334dbb983c53500a7b801c4d5742d9fcffc06", "committedDate": "2020-07-01T09:53:49Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0748d4544971914175125d68c4c13fd0c64e9841", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/0748d4544971914175125d68c4c13fd0c64e9841", "committedDate": "2020-07-01T14:33:50Z", "message": "Issue #2609 WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fa1a64a9163c04147c093b77bb7d639d39f073b", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/0fa1a64a9163c04147c093b77bb7d639d39f073b", "committedDate": "2020-07-01T15:09:17Z", "message": "Issue #2609 WIP\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e709dc96b707699476a3f6ac7764c165ca3e54", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/99e709dc96b707699476a3f6ac7764c165ca3e54", "committedDate": "2020-07-22T09:52:02Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf7e717b216b655aac39d8acd21495a69de3b00", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/8cf7e717b216b655aac39d8acd21495a69de3b00", "committedDate": "2020-07-27T13:56:38Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5248e7c54efc9d7223fbcf081019661551891752", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/5248e7c54efc9d7223fbcf081019661551891752", "committedDate": "2020-07-28T08:52:33Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ecf1c0bbac326d3347db119197948d0cae4991c", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/8ecf1c0bbac326d3347db119197948d0cae4991c", "committedDate": "2020-07-28T10:14:55Z", "message": "Code cleanup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/bfedf204eb2fd4772ffa9043ee4f22c337554456", "committedDate": "2020-07-29T08:28:10Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzc4MjIz", "url": "https://github.com/eclipse/jetty.project/pull/5097#pullrequestreview-457378223", "createdAt": "2020-07-29T10:06:03Z", "commit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowNjowNFrOG4xqYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDowOTowNlrOG4xxHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4NzEwNw==", "bodyText": "use a lamba instead of new Runnable() like elsewhere in this class", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r462187107", "createdAt": "2020-07-29T10:06:04Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionDataStore.java", "diffHunk": "@@ -159,20 +228,101 @@ public void run()\n             throw exception.get();\n     }\n \n+    @Override\n+    public boolean exists(String id) throws Exception\n+    {\n+        final AtomicReference<Exception> exception = new AtomicReference<>();\n+        final AtomicReference<Boolean> result = new AtomicReference<>();\n+        Runnable r = new Runnable()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE4ODgzMA==", "bodyText": "Since the behaviour of  doGetExpired has changed a bit, is there a better name for it?", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r462188830", "createdAt": "2020-07-29T10:09:06Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionDataStore.java", "diffHunk": "@@ -159,20 +228,101 @@ public void run()\n             throw exception.get();\n     }\n \n+    @Override\n+    public boolean exists(String id) throws Exception\n+    {\n+        final AtomicReference<Exception> exception = new AtomicReference<>();\n+        final AtomicReference<Boolean> result = new AtomicReference<>();\n+        Runnable r = new Runnable()\n+        {\n+            @Override\n+            public void run()\n+            {\n+                try\n+                {\n+                    result.set(doExists(id));\n+                }\n+                catch (Exception e)\n+                {\n+                    exception.set(e);\n+                }\n+            }\n+        };\n+\n+        _context.run(r);\n+        if (exception.get() != null)\n+            throw exception.get();\n+        \n+        return result.get();\n+    }\n+\n     @Override\n     public Set<String> getExpired(Set<String> candidates)\n     {\n         if (!isStarted())\n             throw new IllegalStateException(\"Not started\");\n+        long now = System.currentTimeMillis();\n         \n+        // 1. always verify the set of candidates we've been given\n+        //by the sessioncache\n+        Set<String> expired = new HashSet<>();\n+        Set<String> expiredCandidates = doGetExpired(candidates, now);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzkyMTM4", "url": "https://github.com/eclipse/jetty.project/pull/5097#pullrequestreview-457392138", "createdAt": "2020-07-29T10:26:26Z", "commit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoyNjoyN1rOG4yUWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoyNjoyN1rOG4yUWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE5Nzg1MA==", "bodyText": "Maybe use a single AtomicReference here and use instanceof check for the exception?  Still ugly, but in a different way.", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r462197850", "createdAt": "2020-07-29T10:26:27Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionDataStore.java", "diffHunk": "@@ -159,20 +228,101 @@ public void run()\n             throw exception.get();\n     }\n \n+    @Override\n+    public boolean exists(String id) throws Exception\n+    {\n+        final AtomicReference<Exception> exception = new AtomicReference<>();\n+        final AtomicReference<Boolean> result = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfedf204eb2fd4772ffa9043ee4f22c337554456"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fcae3fc191a6f7609e25eaa246762f391513d25", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/8fcae3fc191a6f7609e25eaa246762f391513d25", "committedDate": "2020-08-10T09:23:10Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af3bc98a41a680dcb24f9a389de2deb64e61e56", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/9af3bc98a41a680dcb24f9a389de2deb64e61e56", "committedDate": "2020-08-10T10:00:48Z", "message": "Issue #2609 Use lambdas consistently\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298d040fd4fb38f43ddd23ee1297b46ace2391da", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/298d040fd4fb38f43ddd23ee1297b46ace2391da", "committedDate": "2020-08-10T15:31:27Z", "message": "Issue #2609 Changes after partial review.\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/175a6d9f4ea847d134a3425ae2e3728f4ea792be", "committedDate": "2020-08-11T08:57:25Z", "message": "Issue #2609 Fix javadoc\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTgwMzk5", "url": "https://github.com/eclipse/jetty.project/pull/5097#pullrequestreview-465980399", "createdAt": "2020-08-12T14:36:45Z", "commit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozNjo0NVrOG_kRtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1MTozMlrOG_k8Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNzgzMQ==", "bodyText": "killZombies would have been a much better name... or maybe slayZombies.\nuseQueries is a little meaningless... how about scavengeWithQueries or queryForExpired ?", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r469307831", "createdAt": "2020-08-12T14:36:45Z", "author": {"login": "gregw"}, "path": "jetty-documentation/src/main/asciidoc/distribution-guide/sessions/session-configuration-hazelcast.adoc", "diffHunk": "@@ -95,8 +95,8 @@ jetty.session.hazelcast.onlyClient::\n Hazelcast instance will be configured in client mode\n jetty.session.hazelcast.configurationLocation::\n Path to an an Hazelcast xml configuration file\n-jetty.session.hazelcast.scavengeZombies::\n-True/False. `False` by default. If `true`, jetty will use hazelcast queries to find sessions that are no longer being used on any jetty node and whose expiry time has passed. If you enable this option, and your session stores attributes that reference classes from inside your webapp, or jetty classes, you will need to ensure that these classes are available on each of your hazelcast instances.\n+jetty.session.hazelcast.useQueries::", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwOTQ2NA==", "bodyText": "IS this really only for Infinispan? Look generally useful.", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r469309464", "createdAt": "2020-08-12T14:39:03Z", "author": {"login": "gregw"}, "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/InfinispanKeyBuilder.java", "diffHunk": "@@ -0,0 +1,31 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.session.infinispan;\n+\n+/**\n+ *\n+ *\n+ */\n+public class InfinispanKeyBuilder\n+{\n+    public static String build(String contextPath, String vhost, String id)\n+    {\n+        return contextPath + \"_\" + vhost + \"_\" + id;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxMDgyNg==", "bodyText": "Result is a better name, as it has nothing to do with a Runnable", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r469310826", "createdAt": "2020-08-12T14:40:57Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionDataStore.java", "diffHunk": "@@ -39,8 +39,52 @@\n     protected SessionContext _context; //context associated with this session data store\n     protected int _gracePeriodSec = 60 * 60; //default of 1hr \n     protected long _lastExpiryCheckTime = 0; //last time in ms that getExpired was called\n+    protected long _lastOrphanSweepTime = 0; //last time in ms that we deleted orphaned sessions\n     protected int _savePeriodSec = 0; //time in sec between saves\n-\n+    \n+    /**\n+     * Small utility class to allow us to\n+     * return a result and an Exception\n+     * from invocation of Runnables.\n+     *\n+     * @param <V> the type of the result.\n+     */\n+    private class RunnableResult<V>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxMTUwNQ==", "bodyText": "or queryForOrphans?", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r469311505", "createdAt": "2020-08-12T14:41:52Z", "author": {"login": "gregw"}, "path": "jetty-documentation/src/main/asciidoc/distribution-guide/sessions/session-configuration-hazelcast.adoc", "diffHunk": "@@ -95,8 +95,8 @@ jetty.session.hazelcast.onlyClient::\n Hazelcast instance will be configured in client mode\n jetty.session.hazelcast.configurationLocation::\n Path to an an Hazelcast xml configuration file\n-jetty.session.hazelcast.scavengeZombies::\n-True/False. `False` by default. If `true`, jetty will use hazelcast queries to find sessions that are no longer being used on any jetty node and whose expiry time has passed. If you enable this option, and your session stores attributes that reference classes from inside your webapp, or jetty classes, you will need to ensure that these classes are available on each of your hazelcast instances.\n+jetty.session.hazelcast.useQueries::", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNzgzMQ=="}, "originalCommit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxODY4Ng==", "bodyText": "This is much better, but the lambda is a little on the big size.  Perhaps move the body to an inner class like:\n    private class RunStore extends RunnableResult<Object> implements Runnable\n    {\n        String _id;\n        SessionData data;\n        ... etc.\n        public void run()\n        {\n            // do everything from lambda and save in self as a result\n        }\n    }\nThen this method becomes:\n        final RunStore runStore = new RunStore(id, data);\n        _context.run(runStore);\n        runStore.throwIfException();", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r469318686", "createdAt": "2020-08-12T14:51:32Z", "author": {"login": "gregw"}, "path": "jetty-server/src/main/java/org/eclipse/jetty/server/session/AbstractSessionDataStore.java", "diffHunk": "@@ -114,49 +200,63 @@ public void store(String id, SessionData data) throws Exception\n         if (data == null)\n             return;\n \n-        final AtomicReference<Exception> exception = new AtomicReference<Exception>();\n+        final RunnableResult<Object> result = new RunnableResult<>();\n \n-        Runnable r = new Runnable()\n+        Runnable r = () ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175a6d9f4ea847d134a3425ae2e3728f4ea792be"}, "originalPosition": 176}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8e210f57208bc7f59d217f9922bed3f712898ec", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/f8e210f57208bc7f59d217f9922bed3f712898ec", "committedDate": "2020-08-12T15:34:55Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63531e6ff40bd1be383156216ced42b4335df561", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/63531e6ff40bd1be383156216ced42b4335df561", "committedDate": "2020-08-12T16:03:14Z", "message": "Issue #2609 Reduce scope of Runnable for store(SessionData)\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ed36ef3d739a8a3736fd1f9b6d0ab12f76da938", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/9ed36ef3d739a8a3736fd1f9b6d0ab12f76da938", "committedDate": "2020-08-12T16:06:56Z", "message": "Issue #2609 Rename RunnableResult to Result\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9d988494ec1f281735ad26d40e38f74f504297", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/ad9d988494ec1f281735ad26d40e38f74f504297", "committedDate": "2020-08-21T08:40:36Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b81377c93557334577d2d7ed8f32eecdc662068", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/3b81377c93557334577d2d7ed8f32eecdc662068", "committedDate": "2020-08-24T13:02:02Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7b232030d670665302c91e2cf1e93cbd238cd2a", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/d7b232030d670665302c91e2cf1e93cbd238cd2a", "committedDate": "2020-08-24T14:31:30Z", "message": "Issue #2609 Fix FileSessionDataStoreTest.testCleanOrphans\n\nSigned-off-by: Jan Bartel <janb@webtide.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1419266f4522a5528c87287825bd86afa64df499", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/1419266f4522a5528c87287825bd86afa64df499", "committedDate": "2020-08-24T16:07:23Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjg0ODkw", "url": "https://github.com/eclipse/jetty.project/pull/5097#pullrequestreview-473684890", "createdAt": "2020-08-24T16:57:09Z", "commit": {"oid": "1419266f4522a5528c87287825bd86afa64df499"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjo1NzowOVrOHFuCAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjo1NzowOVrOHFuCAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1OTEwNQ==", "bodyText": "That has mismatched parameters now.", "url": "https://github.com/eclipse/jetty.project/pull/5097#discussion_r475759105", "createdAt": "2020-08-24T16:57:09Z", "author": {"login": "joakime"}, "path": "jetty-nosql/src/main/java/org/eclipse/jetty/nosql/mongodb/MongoSessionDataStore.java", "diffHunk": "@@ -269,7 +269,7 @@ public SessionData doLoad(String id) throws Exception\n     public boolean delete(String id) throws Exception\n     {\n         if (LOG.isDebugEnabled())\n-            LOG.debug(\"Remove:session {} for context {}\", id, _context);\n+            LOG.debug(\"Remove:session {} for context \", id, _context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1419266f4522a5528c87287825bd86afa64df499"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "037784aae717aa16d0bb360f4959750f6bc178c8", "author": {"user": {"login": "janbartel", "name": "Jan Bartel"}}, "url": "https://github.com/eclipse/jetty.project/commit/037784aae717aa16d0bb360f4959750f6bc178c8", "committedDate": "2020-08-26T08:14:52Z", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-2609-findexpiredsessions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 385, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}