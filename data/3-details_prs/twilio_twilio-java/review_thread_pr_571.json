{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MzYxNzI1", "number": 571, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzo0NToxNVrOEdOr9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDozODoxMFrOEkt6fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5MDg0Nzg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzo0NToxNVrOHIRFKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTo1NDo1MVrOHIimcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDUwNQ==", "bodyText": "This is not the proper solution and there are many other characters which this would not solve for. Proper changes are needed in com.twilio.http.Request.buildURL()", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r478430505", "createdAt": "2020-08-27T13:45:15Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -285,7 +285,12 @@ private static String encodeParameters(final Map<String, List<String>> params) {\n                         continue;\n                     }\n \n-                    String encodedValue = URLEncoder.encode(value, \"UTF-8\");\n+                    String encodedValue;\n+                    if (value.startsWith(\"+\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d000d44c11a75f33f8d556527819ef510daa777"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNjMxMw==", "bodyText": "buildURL() appears to be constructing the URL properly (I compared the current method with the method prior to #558). The issue seems to be within encodeParameters() where each parameter is encoded. In the case of a phone number, it appears we should not encode the + sign. contructURL() is where we add the parameters to the final URL.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r478706313", "createdAt": "2020-08-27T21:29:07Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -285,7 +285,12 @@ private static String encodeParameters(final Map<String, List<String>> params) {\n                         continue;\n                     }\n \n-                    String encodedValue = URLEncoder.encode(value, \"UTF-8\");\n+                    String encodedValue;\n+                    if (value.startsWith(\"+\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDUwNQ=="}, "originalCommit": {"oid": "0d000d44c11a75f33f8d556527819ef510daa777"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwNzE1NQ==", "bodyText": "The first page works fine which is where encodeParameters is called. The second page fails because buildURL is re-encoding the already-encoded parameters.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r478707155", "createdAt": "2020-08-27T21:30:53Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -285,7 +285,12 @@ private static String encodeParameters(final Map<String, List<String>> params) {\n                         continue;\n                     }\n \n-                    String encodedValue = URLEncoder.encode(value, \"UTF-8\");\n+                    String encodedValue;\n+                    if (value.startsWith(\"+\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDUwNQ=="}, "originalCommit": {"oid": "0d000d44c11a75f33f8d556527819ef510daa777"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxNzU1Mw==", "bodyText": "I'm not seeing where buildURL is re-encoding the parameters. Might be easier to talk through it?\nI added code to decode each value first before encoding. That seems to work locally, checking tests.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r478717553", "createdAt": "2020-08-27T21:54:51Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -285,7 +285,12 @@ private static String encodeParameters(final Map<String, List<String>> params) {\n                         continue;\n                     }\n \n-                    String encodedValue = URLEncoder.encode(value, \"UTF-8\");\n+                    String encodedValue;\n+                    if (value.startsWith(\"+\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDUwNQ=="}, "originalCommit": {"oid": "0d000d44c11a75f33f8d556527819ef510daa777"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5Nzg4ODg3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMjowNTo1OVrOHJVpng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMjowNTo1OVrOHJVpng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU1Mzk1MA==", "bodyText": "https://en.wikipedia.org/wiki/URI_fragment\n\nThe fragment identifier introduced by a hash mark # is the optional last part of a URL for a document.\n\nThis places it before the query.\nWhat about just decoding the query part before constructing the URI?", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r479553950", "createdAt": "2020-08-28T22:05:59Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -174,9 +174,14 @@ private String buildURL() {\n \n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n-\n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n+            String getQuery = \"\";\n+            if( parsedUrl.getQuery() != null ) {\n+                getQuery = \"?\" + parsedUrl.getQuery();\n+            }\n+            String constructedURI = new URI(\n+                    parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n+                    parsedUrl.getPath(), null, parsedUrl.getRef()).toString() + getQuery;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2737afd0198107e55f1f716f2178858cfa1a0ab"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjg3NTkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoyMTo1OVrOHJ_mSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoxNjoxN1rOHKBc2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MTIyNg==", "bodyText": "new URI().toString() from a new URI().toString()? This looks even more overly-complicated. Can we just drop the usage of URI and construct the URL similar to what we do in other languages?", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r480241226", "createdAt": "2020-08-31T16:21:59Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -174,9 +174,18 @@ private String buildURL() {\n \n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n-\n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n+            String getQuery = \"\";\n+            if( parsedUrl.getQuery() != null ) {\n+                getQuery = \"?\" + parsedUrl.getQuery();\n+            }\n+            String getFragment = \"\";\n+            if( parsedUrl.getRef() != null ) {\n+                getFragment = \"#\" + parsedUrl.getRef();\n+            }\n+            String constructedURI = new URI(\n+                    parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n+                    parsedUrl.getPath(), null,null).toString() + getQuery + getFragment;\n+            return new URI(constructedURI).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef6c2d2826b1900f6d350aff6cbfd2b779d267fe"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3MTU3OA==", "bodyText": "I'll give constructing the URL manually a shot.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r480271578", "createdAt": "2020-08-31T17:16:17Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -174,9 +174,18 @@ private String buildURL() {\n \n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n-\n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n+            String getQuery = \"\";\n+            if( parsedUrl.getQuery() != null ) {\n+                getQuery = \"?\" + parsedUrl.getQuery();\n+            }\n+            String getFragment = \"\";\n+            if( parsedUrl.getRef() != null ) {\n+                getFragment = \"#\" + parsedUrl.getRef();\n+            }\n+            String constructedURI = new URI(\n+                    parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n+                    parsedUrl.getPath(), null,null).toString() + getQuery + getFragment;\n+            return new URI(constructedURI).toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MTIyNg=="}, "originalCommit": {"oid": "ef6c2d2826b1900f6d350aff6cbfd2b779d267fe"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDM3NTUxOnYy", "diffSide": "LEFT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNToyNTo1N1rOHNR_sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNToyNTo1N1rOHNR_sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY4ODM2OA==", "bodyText": "Nooooooooo", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r483688368", "createdAt": "2020-09-04T15:25:57Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -284,7 +299,6 @@ private static String encodeParameters(final Map<String, List<String>> params) {\n                     if (value == null) {\n                         continue;\n                     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4f84d3a15b8c63ecdeea13ea94308b14abd775"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDM3OTg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNToyNzowNlrOHNSCRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNToyNzowNlrOHNSCRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY4OTAyOQ==", "bodyText": "This var isn't needed.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r483689029", "createdAt": "2020-09-04T15:27:06Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +175,24 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            int port = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4f84d3a15b8c63ecdeea13ea94308b14abd775"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDM5MzY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNToyOTozOVrOHNSKyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMzoxMTo0NFrOHOw-_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5MTIxMQ==", "bodyText": "Does this handle URLs with embedded credentials.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r483691211", "createdAt": "2020-09-04T15:29:39Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +175,24 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            int port = -1;\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                port = parsedUrl.getPort();\n+                urlPort = \":\" + port;\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String path = parsedUrl.getPath().replace(\"|\", \"%7C\");\n+            String query = null;\n+            if (parsedUrl.getQuery() != null) {\n+                query = \"?\" + parsedUrl.getQuery();\n+            }\n+            String ref = null;\n+            if (parsedUrl.getRef() != null) {\n+                ref = \"#\" + parsedUrl.getRef();\n+            }\n+            return joinIgnoreNull(\"\", protocol, host, urlPort, path, query, ref);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4f84d3a15b8c63ecdeea13ea94308b14abd775"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NDY3MQ==", "bodyText": "Now it does. Great catch!", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r485244671", "createdAt": "2020-09-08T23:11:44Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +175,24 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            int port = -1;\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                port = parsedUrl.getPort();\n+                urlPort = \":\" + port;\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String path = parsedUrl.getPath().replace(\"|\", \"%7C\");\n+            String query = null;\n+            if (parsedUrl.getQuery() != null) {\n+                query = \"?\" + parsedUrl.getQuery();\n+            }\n+            String ref = null;\n+            if (parsedUrl.getRef() != null) {\n+                ref = \"#\" + parsedUrl.getRef();\n+            }\n+            return joinIgnoreNull(\"\", protocol, host, urlPort, path, query, ref);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5MTIxMQ=="}, "originalCommit": {"oid": "be4f84d3a15b8c63ecdeea13ea94308b14abd775"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDM5NzY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozMDoxN1rOHNSNLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozMDoxN1rOHNSNLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5MTgyMQ==", "bodyText": "This needs to use a proper encoder. There are many other characters that it would cover.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r483691821", "createdAt": "2020-09-04T15:30:17Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +175,24 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            int port = -1;\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                port = parsedUrl.getPort();\n+                urlPort = \":\" + port;\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String path = parsedUrl.getPath().replace(\"|\", \"%7C\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be4f84d3a15b8c63ecdeea13ea94308b14abd775"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NzAwNzg3OnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNToxNjowNlrOHQjGRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjo0NzoxM1rOHQmQew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNDMwOA==", "bodyText": "I don't like adding new dependencies when existing dependencies will do the job.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r487114308", "createdAt": "2020-09-11T15:16:06Z", "author": {"login": "childish-sambino"}, "path": "pom.xml", "diffHunk": "@@ -228,6 +228,11 @@\n       <version>3.4.1</version>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>commons-lang</groupId>\n+      <artifactId>commons-lang</artifactId>\n+      <version>2.4</version>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d080a42ef502f9ba40a5c0ef6281beb7e4c443e7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NjA3NQ==", "bodyText": "Ah, we can use the Guava Joiner for now and then we switch it out after dropping support for Java 7. Good catch, thanks!", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r487166075", "createdAt": "2020-09-11T16:47:13Z", "author": {"login": "thinkingserious"}, "path": "pom.xml", "diffHunk": "@@ -228,6 +228,11 @@\n       <version>3.4.1</version>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>commons-lang</groupId>\n+      <artifactId>commons-lang</artifactId>\n+      <version>2.4</version>\n+    </dependency>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNDMwOA=="}, "originalCommit": {"oid": "d080a42ef502f9ba40a5c0ef6281beb7e4c443e7"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDEyOTE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDowMjowOVrOHSbUNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDowMjowOVrOHSbUNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4Mzk1Nw==", "bodyText": "Simplify these for readability: String query = parsedUrl.getQuery() != null ? \"?\" + parsedUrl.getQuery() : null;", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r489083957", "createdAt": "2020-09-16T00:02:09Z", "author": {"login": "eshanholtz"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,28 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");\n+            String encodedPath = Joiner.on(\"/\").join(pathPieces);\n+            String query = null;\n+            if (parsedUrl.getQuery() != null) {\n+                query = \"?\" + parsedUrl.getQuery();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0bc241f52c7be29f0d5e43d35b9ffff87180938"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzkzMTIxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1NToxNlrOHTmrQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0Nzo0M1rOHTy_EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ==", "bodyText": "I don't understand this pathPieces logic. Needs a comment.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490318659", "createdAt": "2020-09-17T14:55:16Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMTY3Mg==", "bodyText": "Comment added. The idea is to only encode the path portion of the URL.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490331672", "createdAt": "2020-09-17T15:12:23Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ5NTQ0MQ==", "bodyText": "So if you have /foo|bar/baz|qux only baz/qux gets encoded?", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490495441", "createdAt": "2020-09-17T19:15:48Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMTgyMQ==", "bodyText": "Yes, baz|qux would only be encoded. Based on our tests, I'm assuming this case does not happen. If we do expect that use case, then perhaps we should encode all pieces of the path, save / characters.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490511821", "createdAt": "2020-09-17T19:34:24Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNjYxOQ==", "bodyText": "We don't control where the characters needing encoding would be. Best to encode them all.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490516619", "createdAt": "2020-09-17T19:40:33Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMDMzNw==", "bodyText": "Updated", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490520337", "createdAt": "2020-09-17T19:47:43Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODY1OQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzkzMzY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1NTo0MlrOHTmsxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNToxMzo0NlrOHTniAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxOTA0NQ==", "bodyText": "Spacing looks off. Are you using IntelliJ to format?", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490319045", "createdAt": "2020-09-17T14:55:42Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");\n+            String encodedPath = Joiner.on(\"/\").join(pathPieces);\n+            String query = parsedUrl.getQuery() != null ? \"?\" + parsedUrl.getQuery() : null;\n+            String ref = parsedUrl.getRef() != null ? \"#\" + parsedUrl.getRef() : null;\n+            String credentials  = parsedUrl.getUserInfo() != null ? parsedUrl.getUserInfo() + \"@\" : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMjY3Mg==", "bodyText": "Nice! The formatter caught a stray space after credentials.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490332672", "createdAt": "2020-09-17T15:13:46Z", "author": {"login": "thinkingserious"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,19 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);\n+            pathPieces[pathPieces.length-1] = URLEncoder.encode(pathPieces[pathPieces.length-1], \"UTF-8\");\n+            String encodedPath = Joiner.on(\"/\").join(pathPieces);\n+            String query = parsedUrl.getQuery() != null ? \"?\" + parsedUrl.getQuery() : null;\n+            String ref = parsedUrl.getRef() != null ? \"#\" + parsedUrl.getRef() : null;\n+            String credentials  = parsedUrl.getUserInfo() != null ? parsedUrl.getUserInfo() + \"@\" : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxOTA0NQ=="}, "originalCommit": {"oid": "380c84cf831a92765ab1182162dd0ce72b74f926"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTAyOTUxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOToxNDoxNVrOHTxaVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOToxNDoxNVrOHTxaVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ5NDU1MQ==", "bodyText": "Default limit is already 0 so second arg not needed.", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490494551", "createdAt": "2020-09-17T19:14:15Z", "author": {"login": "childish-sambino"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,20 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }\n+            String protocol = parsedUrl.getProtocol() + \"://\";\n+            String[] pathPieces = parsedUrl.getPath().split(\"/\", 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e25c5d1ef274c27d3dc8ffd402120def87b5506"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTM2NDQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/twilio/http/Request.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDozODoxMFrOHT0quA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDozODoxMFrOHT0quA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0Nzg5Ng==", "bodyText": "Could do one more simplification here similar to below:\nString urlPort = parsedUrl.getPort() != -1 ? \":\" + parsedUrl.getPort() : null;", "url": "https://github.com/twilio/twilio-java/pull/571#discussion_r490547896", "createdAt": "2020-09-17T20:38:10Z", "author": {"login": "eshanholtz"}, "path": "src/main/java/com/twilio/http/Request.java", "diffHunk": "@@ -175,9 +176,21 @@ private String buildURL() {\n                 host = joinIgnoreNull(\".\", product, targetEdge, targetRegion, domain);\n             }\n \n-            return new URI(parsedUrl.getProtocol(), parsedUrl.getUserInfo(), host, parsedUrl.getPort(),\n-                    parsedUrl.getPath(), parsedUrl.getQuery(), parsedUrl.getRef()).toURL().toString();\n-        } catch (final MalformedURLException | URISyntaxException e) {\n+            String urlPort = null;\n+            if (parsedUrl.getPort() != -1) {\n+                urlPort = \":\" + parsedUrl.getPort();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeda0b263ab173e741adf56c8d3807ae02499bca"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1926, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}