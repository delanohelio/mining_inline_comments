{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTE2MjAy", "number": 12133, "title": "Update sync status after processing the entire sync", "bodyText": "Marking paths as sync during the sync is inaccurate, because the syncs for descendants are run in a separate thread pool. Therefore, only mark the root path as synced after everything is finished. This also reduces the number of entries in the sync cache, instead of marking each path in the tree.\nFixes #12106", "createdAt": "2020-09-23T16:58:44Z", "url": "https://github.com/Alluxio/alluxio/pull/12133", "merged": true, "mergeCommit": {"oid": "e8b5f6d8182d0d673395016d902c71852c09e018"}, "closed": true, "closedAt": "2020-10-01T21:31:23Z", "author": {"login": "gpang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLvlZJgH2gAyNDkxOTE2MjAyOjNmMDRlZjcxZGRlMGFmYzNjOTJlNmVmZTk0MTExYmRkYzk0MGJiOGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOCH04AFqTQ5OTc1MzUwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/3f04ef71dde0afc3c92e6efe94111bddc940bb8e", "committedDate": "2020-09-23T16:56:47Z", "message": "Update sync status after processing the entire sync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTMwNzIw", "url": "https://github.com/Alluxio/alluxio/pull/12133#pullrequestreview-494930720", "createdAt": "2020-09-23T18:24:43Z", "commit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyNDo0M1rOHW7H2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyNDo0M1rOHW7H2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTM4NQ==", "bodyText": "So now, if two RPCs on the same path come in at the same time, we'll end up doing a lot more work, right?", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493799385", "createdAt": "2020-09-23T18:24:43Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -387,9 +387,15 @@ public boolean sync() throws AccessControlException, InvalidPathException {\n           syncPathCount + failedSyncPathCount, syncPathCount, failedSyncPathCount, end - start,\n           mRootScheme);\n     }\n+    boolean success = syncPathCount > 0;\n+    if (success) {\n+      // update the sync path cache for the root of the sync\n+      // TODO(gpang): Do we need special handling for failures and thread interrupts?\n+      mUfsSyncPathCache.notifySyncedPath(mRootScheme.getPath().getPath(), mDescendantType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTUwMjg0", "url": "https://github.com/Alluxio/alluxio/pull/12133#pullrequestreview-494950284", "createdAt": "2020-09-23T18:44:16Z", "commit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODo0NDoxNlrOHW74iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODo0NDoxNlrOHW74iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgxMTg0OQ==", "bodyText": "slightly concerned about failure and cancellations, because we would mark the directory as synced when perhaps only one file in the directory is synced. It would also prevent it from everything in the directory getting synced for a while..", "url": "https://github.com/Alluxio/alluxio/pull/12133#discussion_r493811849", "createdAt": "2020-09-23T18:44:16Z", "author": {"login": "yuzhu"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -387,9 +387,15 @@ public boolean sync() throws AccessControlException, InvalidPathException {\n           syncPathCount + failedSyncPathCount, syncPathCount, failedSyncPathCount, end - start,\n           mRootScheme);\n     }\n+    boolean success = syncPathCount > 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTIwNDY4", "url": "https://github.com/Alluxio/alluxio/pull/12133#pullrequestreview-495120468", "createdAt": "2020-09-23T23:35:22Z", "commit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NzUzNTA1", "url": "https://github.com/Alluxio/alluxio/pull/12133#pullrequestreview-499753505", "createdAt": "2020-09-30T19:40:32Z", "commit": {"oid": "3f04ef71dde0afc3c92e6efe94111bddc940bb8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3597, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}