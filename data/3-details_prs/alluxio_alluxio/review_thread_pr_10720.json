{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMTQ2MDYw", "number": 10720, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTowN1rODX9qoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNzowNlrODYQNkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU0MTc2OnYy", "diffSide": "RIGHT", "path": "job/server/src/main/java/alluxio/job/plan/transform/CompactDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTowN1rOFdjRpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTowN1rOFdjRpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMDk4MA==", "bodyText": "Is this \"job\" or \"task\"?", "url": "https://github.com/Alluxio/alluxio/pull/10720#discussion_r366530980", "createdAt": "2020-01-14T19:31:07Z", "author": {"login": "gpang"}, "path": "job/server/src/main/java/alluxio/job/plan/transform/CompactDefinition.java", "diffHunk": "@@ -44,6 +45,7 @@\n public final class CompactDefinition\n     extends AbstractVoidPlanDefinition<CompactConfig, ArrayList<CompactTask>> {\n   private static final Logger LOG = LoggerFactory.getLogger(CompactDefinition.class);\n+  private static final int JOBS_PER_WORKER = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7779ee4a03b314692cfd592066cfc3e85b508868"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU1MDkxOnYy", "diffSide": "RIGHT", "path": "job/server/src/main/java/alluxio/job/plan/transform/CompactDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozNDoyMVrOFdjXkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozNDoyMVrOFdjXkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMjQ5OQ==", "bodyText": "can we add a simple unit test to see that selectExecutors() returns multiple tasks per host?", "url": "https://github.com/Alluxio/alluxio/pull/10720#discussion_r366532499", "createdAt": "2020-01-14T19:34:21Z", "author": {"login": "gpang"}, "path": "job/server/src/main/java/alluxio/job/plan/transform/CompactDefinition.java", "diffHunk": "@@ -111,7 +113,13 @@ private boolean shouldIgnore(URIStatus status) {\n \n     Set<Pair<WorkerInfo, ArrayList<CompactTask>>> result = Sets.newHashSet();\n     for (Map.Entry<WorkerInfo, ArrayList<CompactTask>> assignment : assignments.entrySet()) {\n-      result.add(new Pair<>(assignment.getKey(), assignment.getValue()));\n+      List<List<CompactTask>> partitioned = CommonUtils.partition(\n+          assignment.getValue(), JOBS_PER_WORKER);\n+      for (List<CompactTask> compactTasks : partitioned) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7779ee4a03b314692cfd592066cfc3e85b508868"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU3ODQ3OnYy", "diffSide": "RIGHT", "path": "job/server/src/test/java/alluxio/job/plan/transform/CompactDefinitionSelectExecutorsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNjoyN1rOFeAUkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNjoyN1rOFeAUkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNjg2NA==", "bodyText": "NIT: can we make this a local variable like numFiles, and we can use it here, and also at the end of the test when we verify.", "url": "https://github.com/Alluxio/alluxio/pull/10720#discussion_r367006864", "createdAt": "2020-01-15T17:26:27Z", "author": {"login": "gpang"}, "path": "job/server/src/test/java/alluxio/job/plan/transform/CompactDefinitionSelectExecutorsTest.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.job.plan.transform;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.URIStatus;\n+import alluxio.collections.Pair;\n+import alluxio.job.JobServerContext;\n+import alluxio.job.SelectExecutorsContext;\n+import alluxio.job.plan.SelectExecutorsTest;\n+import alluxio.wire.WorkerInfo;\n+\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class CompactDefinitionSelectExecutorsTest extends SelectExecutorsTest {\n+\n+  private static final String INPUT_DIR = \"/input\";\n+  private static final String OUTPUT_DIR = \"/output\";\n+\n+  @Test\n+  public void testExecutorsParallel() throws Exception {\n+    CompactConfig config = new CompactConfig(null, INPUT_DIR, OUTPUT_DIR, \"test\", 100);\n+\n+    List<URIStatus> inputFiles = new ArrayList<>();\n+    for (int i = 0; i < 50; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe1f2a9d63dc69fe3f0b75601e444fae8cfdeaab"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzU4MDMyOnYy", "diffSide": "RIGHT", "path": "job/server/src/test/java/alluxio/job/plan/transform/CompactDefinitionSelectExecutorsTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxNzoyNzowNlrOFeAV0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowODowM1rOFeBiJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNzE4Nw==", "bodyText": "Would this have been only 4 in the previous version?", "url": "https://github.com/Alluxio/alluxio/pull/10720#discussion_r367007187", "createdAt": "2020-01-15T17:27:06Z", "author": {"login": "gpang"}, "path": "job/server/src/test/java/alluxio/job/plan/transform/CompactDefinitionSelectExecutorsTest.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.job.plan.transform;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.URIStatus;\n+import alluxio.collections.Pair;\n+import alluxio.job.JobServerContext;\n+import alluxio.job.SelectExecutorsContext;\n+import alluxio.job.plan.SelectExecutorsTest;\n+import alluxio.wire.WorkerInfo;\n+\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class CompactDefinitionSelectExecutorsTest extends SelectExecutorsTest {\n+\n+  private static final String INPUT_DIR = \"/input\";\n+  private static final String OUTPUT_DIR = \"/output\";\n+\n+  @Test\n+  public void testExecutorsParallel() throws Exception {\n+    CompactConfig config = new CompactConfig(null, INPUT_DIR, OUTPUT_DIR, \"test\", 100);\n+\n+    List<URIStatus> inputFiles = new ArrayList<>();\n+    for (int i = 0; i < 50; i++) {\n+      inputFiles.add(newFile(Integer.toString(i)));\n+    }\n+\n+    when(mMockFileSystem.listStatus(new AlluxioURI(INPUT_DIR))).thenReturn(inputFiles);\n+\n+    Set<Pair<WorkerInfo, ArrayList<CompactTask>>> result = new CompactDefinition().selectExecutors(\n+        config, SelectExecutorsTest.JOB_WORKERS, new SelectExecutorsContext(1,\n+            new JobServerContext(mMockFileSystem, mMockFileSystemContext, mMockUfsManager)));\n+    assertEquals(40, result.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe1f2a9d63dc69fe3f0b75601e444fae8cfdeaab"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAyNjcyNw==", "bodyText": "That's correct.", "url": "https://github.com/Alluxio/alluxio/pull/10720#discussion_r367026727", "createdAt": "2020-01-15T18:08:03Z", "author": {"login": "bradyoo"}, "path": "job/server/src/test/java/alluxio/job/plan/transform/CompactDefinitionSelectExecutorsTest.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.job.plan.transform;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.URIStatus;\n+import alluxio.collections.Pair;\n+import alluxio.job.JobServerContext;\n+import alluxio.job.SelectExecutorsContext;\n+import alluxio.job.plan.SelectExecutorsTest;\n+import alluxio.wire.WorkerInfo;\n+\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class CompactDefinitionSelectExecutorsTest extends SelectExecutorsTest {\n+\n+  private static final String INPUT_DIR = \"/input\";\n+  private static final String OUTPUT_DIR = \"/output\";\n+\n+  @Test\n+  public void testExecutorsParallel() throws Exception {\n+    CompactConfig config = new CompactConfig(null, INPUT_DIR, OUTPUT_DIR, \"test\", 100);\n+\n+    List<URIStatus> inputFiles = new ArrayList<>();\n+    for (int i = 0; i < 50; i++) {\n+      inputFiles.add(newFile(Integer.toString(i)));\n+    }\n+\n+    when(mMockFileSystem.listStatus(new AlluxioURI(INPUT_DIR))).thenReturn(inputFiles);\n+\n+    Set<Pair<WorkerInfo, ArrayList<CompactTask>>> result = new CompactDefinition().selectExecutors(\n+        config, SelectExecutorsTest.JOB_WORKERS, new SelectExecutorsContext(1,\n+            new JobServerContext(mMockFileSystem, mMockFileSystemContext, mMockUfsManager)));\n+    assertEquals(40, result.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwNzE4Nw=="}, "originalCommit": {"oid": "fe1f2a9d63dc69fe3f0b75601e444fae8cfdeaab"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2215, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}