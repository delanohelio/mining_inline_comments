{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDQxMzU0", "number": 10904, "title": "Fix the MultiValueMetricsAggregator and reduce overhead", "bodyText": "Fix the bug of MetricsSystem.getMasterMetrics(). It previously only returns the metric stored in MetricsRegistry with the exact same name. In this PR, it returns the metrics that start with the given metric name (the metrics can have multiple tags).\nReduce the logics in update MultiValueMetricsAggregator values, reduce the traverse of the whole metrics.", "createdAt": "2020-02-13T19:13:31Z", "url": "https://github.com/Alluxio/alluxio/pull/10904", "merged": true, "mergeCommit": {"oid": "8e59b2b29600c1571b3eb49214a38c9d130e4df4"}, "closed": true, "closedAt": "2020-02-14T22:17:14Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD_zJAAH2gAyMzc1MDQxMzU0OjMzNzRkMGU1MGY4ZmM2YTU0Mjg4NWViMzQ1N2ZhMjMzNzM5ZGJjYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEXArOAFqTM1OTI0ODI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3374d0e50f8fc6a542885eb3457fa233739dbca4", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/3374d0e50f8fc6a542885eb3457fa233739dbca4", "committedDate": "2020-02-13T19:07:44Z", "message": "Reconstruct the MultiValueMetricsAggregator to reduce overhead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad322c1ff7e677671fb26a48ca2476a5cbc5c7d3", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/ad322c1ff7e677671fb26a48ca2476a5cbc5c7d3", "committedDate": "2020-02-13T19:28:08Z", "message": "Tmp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c2aebcf329e79e061d840bc27e9245f673e0f79", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7c2aebcf329e79e061d840bc27e9245f673e0f79", "committedDate": "2020-02-13T21:01:59Z", "message": "Add throughput gauge test in MetricsMasterTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ff1c630e8a47de7a81bf883079acfa71946b73d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/8ff1c630e8a47de7a81bf883079acfa71946b73d", "committedDate": "2020-02-13T22:27:38Z", "message": "Before solving conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d714855aa07264bc838153cbfb131f57817f583c", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d714855aa07264bc838153cbfb131f57817f583c", "committedDate": "2020-02-13T22:28:07Z", "message": "Solve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjQ3Njk5", "url": "https://github.com/Alluxio/alluxio/pull/10904#pullrequestreview-358647699", "createdAt": "2020-02-14T00:35:38Z", "commit": {"oid": "d714855aa07264bc838153cbfb131f57817f583c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDozNTozOFrOFpoSNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDozNTozOFrOFpoSNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5NTk1Nw==", "bodyText": "Would it be easier to just use startsWith as a string instead of using regex?", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379195957", "createdAt": "2020-02-14T00:35:38Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -621,19 +625,25 @@ public static Timer timer(String name) {\n   }\n \n   /**\n-   * Gets master metric with the given metric name.\n+   * Gets all the master metrics belongs to the given metric names.\n    *\n-   * @param name the name of the metric to get\n-   * @return a metric set with the master metric of the given metric name\n+   * @param metricNames the name of the metrics to get\n+   * @return a metric map from metric name to metrics with this name\n    */\n-  public static Set<Metric> getMasterMetric(String name) {\n-    Set<Metric> set = new HashSet<>();\n-    String fullName = getMasterMetricName(name);\n-    Metric alluxioMetric = getMetricValue(fullName);\n-    if (alluxioMetric != null) {\n-      set.add(alluxioMetric);\n+  public static Map<String, Set<Metric>> getMasterMetrics(Set<String> metricNames) {\n+    Map<String, Set<Metric>> res = new HashMap<>();\n+    for (Map.Entry<String, com.codahale.metrics.Metric> entry\n+        : METRIC_REGISTRY.getMetrics().entrySet()) {\n+      Matcher matcher = METRIC_NAME_PATTERN.matcher(entry.getKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d714855aa07264bc838153cbfb131f57817f583c"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62665ca1d6bf0d9288d62bde72f0fd53cc58c182", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/62665ca1d6bf0d9288d62bde72f0fd53cc58c182", "committedDate": "2020-02-14T02:52:50Z", "message": "Before solving conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5960932fb4404f2bd99adb8a14e91f6c4c1b04ea", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5960932fb4404f2bd99adb8a14e91f6c4c1b04ea", "committedDate": "2020-02-14T02:54:23Z", "message": "Solve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452b220ed15f4d03d62b4c3376676e332d9f4427", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/452b220ed15f4d03d62b4c3376676e332d9f4427", "committedDate": "2020-02-14T18:09:01Z", "message": "Change clear time to atomicLong"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1dbd330ce23176cc1fd674e3e0ed52ddc21f2bf", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/c1dbd330ce23176cc1fd674e3e0ed52ddc21f2bf", "committedDate": "2020-02-14T18:43:21Z", "message": "Fix MetricsStoreTest.clearAndGetClearTime() test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9009b4efdcbc8a704fb34366365fd537bad895", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/cd9009b4efdcbc8a704fb34366365fd537bad895", "committedDate": "2020-02-14T18:55:58Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a856d512093badd15b467696ad005d02bd7f8582", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a856d512093badd15b467696ad005d02bd7f8582", "committedDate": "2020-02-14T20:05:05Z", "message": "Fix aggregator bug and add corresponding tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjA4NTA0", "url": "https://github.com/Alluxio/alluxio/pull/10904#pullrequestreview-359208504", "createdAt": "2020-02-14T20:44:31Z", "commit": {"oid": "a856d512093badd15b467696ad005d02bd7f8582"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDo0NDozMlrOFqDJpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDo0NDozMlrOFqDJpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjEzMw==", "bodyText": "nit: This seems like an odd line break. Does it not fit on one line?", "url": "https://github.com/Alluxio/alluxio/pull/10904#discussion_r379636133", "createdAt": "2020-02-14T20:44:32Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -53,8 +51,10 @@\n  */\n public class DefaultMetricsMaster extends CoreMaster implements MetricsMaster, NoopJournaled {\n   private static final Logger LOG = LoggerFactory.getLogger(DefaultMetricsMaster.class);\n-  private final Set<MultiValueMetricsAggregator> mMultiValueMetricsAggregatorRegistry =\n-      new HashSet<>();\n+  // A map from the to be aggregated metric name to aggregator itself\n+  // This registry only holds aggregator for master metrics\n+  private final Map<String, MultiValueMetricsAggregator>\n+      mAggregatorRegistry = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a856d512093badd15b467696ad005d02bd7f8582"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "399501a99eb45dff3cd6306ae00ef305e6047436", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/399501a99eb45dff3cd6306ae00ef305e6047436", "committedDate": "2020-02-14T21:34:31Z", "message": "small comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjQ4Mjkx", "url": "https://github.com/Alluxio/alluxio/pull/10904#pullrequestreview-359248291", "createdAt": "2020-02-14T22:10:20Z", "commit": {"oid": "399501a99eb45dff3cd6306ae00ef305e6047436"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}