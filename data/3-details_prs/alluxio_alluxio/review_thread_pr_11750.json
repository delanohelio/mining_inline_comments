{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NjI5Nzk3", "number": 11750, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo0OTowMFrOENaTpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzo0MToyNVrOENcbpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDk3OTU5OnYy", "diffSide": "LEFT", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo0OTowMFrOGwFOHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzowMDozM1rOGwH0KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng==", "bodyText": "can we keep this test case? \"s3a://\" + BUCKET_NAME + \"/test/\"", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453070366", "createdAt": "2020-07-10T20:49:00Z", "author": {"login": "gpang"}, "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,8 +244,8 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test/\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35cbb5800f8e7c4d93216063c23cc74854a28a57"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDk5OQ==", "bodyText": "No because I don't think /test/ is actually a valid input to this function. It was becuase I thought it was a valid input that I made this mistake.", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453070999", "createdAt": "2020-07-10T20:50:32Z", "author": {"login": "bradyoo"}, "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,8 +244,8 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test/\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}, "originalCommit": {"oid": "35cbb5800f8e7c4d93216063c23cc74854a28a57"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5MzY2NQ==", "bodyText": "We can't pass in directory paths to this method? I thought any s3 UFS path can be passed to this method?", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453093665", "createdAt": "2020-07-10T21:53:30Z", "author": {"login": "gpang"}, "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,8 +244,8 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test/\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}, "originalCommit": {"oid": "35cbb5800f8e7c4d93216063c23cc74854a28a57"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExMjg3Mw==", "bodyText": "I think directories are also allowed, since a few lines above, we have \"s3a://\" + BUCKET_NAME + \"/\" which is a directory.", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453112873", "createdAt": "2020-07-10T23:00:33Z", "author": {"login": "gpang"}, "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,8 +244,8 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test/\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}, "originalCommit": {"oid": "35cbb5800f8e7c4d93216063c23cc74854a28a57"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTMwNDg5OnYy", "diffSide": "RIGHT", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoyNToyNFrOGwINgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoyNToyNFrOGwINgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExOTM2MA==", "bodyText": "Can we do the full matrix of test cases?\ntest\ntest/\n/test\n/test/\n\nare these also possible?\n\"\"\n\"/\"", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453119360", "createdAt": "2020-07-10T23:25:24Z", "author": {"login": "gpang"}, "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,7 +244,7 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTMwNjAyOnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoyNjowMlrOGwIOHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzoyNjowMlrOGwIOHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExOTUxNw==", "bodyText": "Can we save this normalized root at the top, so both branches can re-use it?", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453119517", "createdAt": "2020-07-10T23:26:02Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n+    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (!path.equals(normalizedPath)) {\n+      stripedKey = CommonUtils.stripPrefixIfPresent(\n+          normalizedPath,\n+          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTMxMTc2OnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzozMDowOFrOGwIRZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzozODoxNFrOGwIYEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDM1Nw==", "bodyText": "What is an example where this will make a difference? PathUtils.normalizePath just adds a separator at the end, so does this only apply to the single string s3://bucket?", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453120357", "createdAt": "2020-07-10T23:30:08Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMjA2Ng==", "bodyText": "That is correct.", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453122066", "createdAt": "2020-07-10T23:38:14Z", "author": {"login": "bradyoo"}, "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDM1Nw=="}, "originalCommit": {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTMxMzM3OnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzozMTowMVrOGwISUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzozMTowMVrOGwISUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDU5NA==", "bodyText": "(nit) reuse the result from line 1123?", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453120594", "createdAt": "2020-07-10T23:31:01Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n+    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (!path.equals(normalizedPath)) {\n+      stripedKey = CommonUtils.stripPrefixIfPresent(\n+          normalizedPath,\n+          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTMyNzczOnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzo0MToyNVrOGwIang==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMzo0MToyNVrOGwIang==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMjcxOA==", "bodyText": "mRootKeySupplier.get() is a memoized function so don't be concerned about callng twice.", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453122718", "createdAt": "2020-07-10T23:41:25Z", "author": {"login": "bradyoo"}, "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,16 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (mRootKeySupplier.get().equals(path)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1427, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}