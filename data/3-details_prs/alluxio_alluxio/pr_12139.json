{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMDc4ODI5", "number": 12139, "title": "Fix deadlock of racing worker client acquisition and file completion", "bodyText": "Fix bug: fuse pod hang forever if open&read many files without close  the files\nRoot cause:\nmBlockInStream in AlluxioFileInStream won't be released even reading to end of the block.\nIn this case, BlockWorkerClient will be held in BlockInStream. Given many files opened, BlockWorkerClient in the pool will be exhausted and the following operations will be blocked.\nFix:\nRelease mBlockInStream after reading to end of the block.", "createdAt": "2020-09-23T22:45:06Z", "url": "https://github.com/Alluxio/alluxio/pull/12139", "merged": true, "mergeCommit": {"oid": "53e9cee1deba5062011cda4509fb59da7db815b0"}, "closed": true, "closedAt": "2020-09-29T00:18:32Z", "author": {"login": "chaowangnk1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL0YhZgH2gAyNDkyMDc4ODI5OjdmMzhhMTk2MDk4NTZmMGMxMDMzOGIwZGJhMzcxODJmMmUyYjQwZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNc5LngFqTQ5Nzk4MDc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f38a19609856f0c10338b0dba37182f2e2b40dd", "author": {"user": {"login": "chaowangnk1", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7f38a19609856f0c10338b0dba37182f2e2b40dd", "committedDate": "2020-09-23T22:32:15Z", "message": "Fix bug: fuse pod hang forever if open&read many files without close the files\nRoot cause:\n      mBlockInStream in AlluxioFileInStream won't be released even reading to end of the block.\n      In this case, BlockWorkerClient will be held in BlockInStream. Given many files opened, BlockWorkerClient in the pool will be exhausted and the following operations will be blocked.\nFix:\n      Release mBlockInStream after reading to end of the block."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzYzNjU1", "url": "https://github.com/Alluxio/alluxio/pull/12139#pullrequestreview-497763655", "createdAt": "2020-09-28T17:49:54Z", "commit": {"oid": "7f38a19609856f0c10338b0dba37182f2e2b40dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo0OTo1NFrOHZJVag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo0OTo1NFrOHZJVag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTM4Ng==", "bodyText": "The setting of mBlockInStream = null is handled in closeBlockInStream.", "url": "https://github.com/Alluxio/alluxio/pull/12139#discussion_r496129386", "createdAt": "2020-09-28T17:49:54Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java", "diffHunk": "@@ -147,6 +147,10 @@ public int read() throws IOException {\n         if (result != -1) {\n           mPosition++;\n         }\n+        if (mBlockInStream.remaining() == 0) {\n+          closeBlockInStream(mBlockInStream);\n+          mBlockInStream = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f38a19609856f0c10338b0dba37182f2e2b40dd"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzY1NDM3", "url": "https://github.com/Alluxio/alluxio/pull/12139#pullrequestreview-497765437", "createdAt": "2020-09-28T17:52:19Z", "commit": {"oid": "7f38a19609856f0c10338b0dba37182f2e2b40dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c", "author": {"user": {"login": "chaowangnk1", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c", "committedDate": "2020-09-28T23:24:28Z", "message": "Address comments & add UT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTY2OTQ4", "url": "https://github.com/Alluxio/alluxio/pull/12139#pullrequestreview-497966948", "createdAt": "2020-09-28T23:34:21Z", "commit": {"oid": "6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff3b3a4f0511fa447d006bd08c587db891a9a6ca", "author": {"user": {"login": "chaowangnk1", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/ff3b3a4f0511fa447d006bd08c587db891a9a6ca", "committedDate": "2020-09-28T23:40:13Z", "message": "Apply the logic to mCachedPositionedStream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e332f12d03dc3f05da3d42b6c1d4467bf3c4171", "author": {"user": {"login": "chaowangnk1", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5e332f12d03dc3f05da3d42b6c1d4467bf3c4171", "committedDate": "2020-09-28T23:55:41Z", "message": "Add new UTs instead of updating existing UTs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTc4NDU4", "url": "https://github.com/Alluxio/alluxio/pull/12139#pullrequestreview-497978458", "createdAt": "2020-09-29T00:10:23Z", "commit": {"oid": "5e332f12d03dc3f05da3d42b6c1d4467bf3c4171"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTgwNzg3", "url": "https://github.com/Alluxio/alluxio/pull/12139#pullrequestreview-497980787", "createdAt": "2020-09-29T00:18:03Z", "commit": {"oid": "5e332f12d03dc3f05da3d42b6c1d4467bf3c4171"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3601, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}