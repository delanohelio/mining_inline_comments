{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MTczMTA0", "number": 10968, "title": "Reduce getWorkerInfoList RPCs on client and job servers", "bodyText": "AlluxioBlockStore was originally a singleton before 2.0, so AlluxioBlockStore.getWorkerInfoList can keep worker info cached across Input and Output Streams. However after 2.0, AlluxioBlockStore becomes instance class and the cached worker info list can only benefit its owner stream, causing performance issues due to too many unnecessary client-master RPCs when reading / writing many small files, as described #10959\nThis PR moves getWorkerInfoList and getAllWorkers to FileSystemContext as the shared state.\nThis PR also changes the job servers to use cached worker info list instead of keep getting the most updated worker info list.\nFix #10959  and close #9977", "createdAt": "2020-02-21T08:54:29Z", "url": "https://github.com/Alluxio/alluxio/pull/10968", "merged": true, "mergeCommit": {"oid": "8c74baf0e3e0e3016bfe43a0f6d10a6ff27aa29b"}, "closed": true, "closedAt": "2020-02-22T00:09:30Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGbq2UAH2gAyMzc4MTczMTA0Ojg0N2NmMDQxYjM1NGE1YjIyMzJjMTM4MTc3MjgwYzNlZmIzMmRlYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGoMIigH2gAyMzc4MTczMTA0OmU1Y2Y0MjRhYzIxMmRhZDcxYWEyZTk2Zjg4ZTZjYTE2OTVkNjNlM2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/847cf041b354a5b2232c138177280c3efb32dea0", "committedDate": "2020-02-21T08:43:52Z", "message": "Keep workerInfoList cached across InStream and OutStream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzczNDU3", "url": "https://github.com/Alluxio/alluxio/pull/10968#pullrequestreview-362773457", "createdAt": "2020-02-21T16:55:22Z", "commit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjo1NToyM1rOFs9xFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNjo1Njo0OVrOFs90lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5MzY1NQ==", "bodyText": "Should we just use the guava cache, like here: https://github.com/Alluxio/alluxio/pull/10963/files#diff-2d2ca0120802269babf6451df30b6279R273", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382693655", "createdAt": "2020-02-21T16:55:23Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -149,6 +154,14 @@\n   /** Whether to do URI scheme validation for file systems using this context.  */\n   private boolean mUriValidationEnabled = true;\n \n+  /** Cached map for workers. */\n+  @GuardedBy(\"this\")\n+  private volatile List<BlockWorkerInfo> mWorkerInfoList = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY5NDU1MA==", "bodyText": "It seems like the only difference between this method and getAllWorkers is that this one is cached (so maybe stale)? It is not clear from the method names, and or java doc.", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382694550", "createdAt": "2020-02-21T16:56:49Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes\n+   */\n+  public synchronized List<BlockWorkerInfo> getEligibleWorkers() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzk5MDcx", "url": "https://github.com/Alluxio/alluxio/pull/10968#pullrequestreview-362799071", "createdAt": "2020-02-21T17:37:22Z", "commit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzozNzoyMlrOFs_AFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzozNzoyMlrOFs_AFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxMzg3Ng==", "bodyText": "Change all the getAllWorkers to getEligibleWorkers?\ni tested locally that if all job servers used getEligibleWorkers() instead of getAllWorkers(), a large amount of getWorkerInfoList call will be reduced on the job server side.\nThis is because instead of creating a AlluxioBlockStore each time when needed, Those context used in job server definitions and job utils internally contain a shared JobServerContext which contains a FileSystemContext.\nThis FileSystemContext is shared so that the cached worker info list is shared.", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382713876", "createdAt": "2020-02-21T17:37:22Z", "author": {"login": "LuQQiu"}, "path": "job/server/src/main/java/alluxio/job/plan/migrate/MigrateDefinition.java", "diffHunk": "@@ -181,8 +181,7 @@ private void checkMigrateValid(MigrateConfig config, FileSystem fs) throws Excep\n     for (WorkerInfo workerInfo : jobWorkerInfoList) {\n       hostnameToWorker.put(workerInfo.getAddress().getHost(), workerInfo);\n     }\n-    List<BlockWorkerInfo> alluxioWorkerInfoList =\n-        AlluxioBlockStore.create(context.getFsContext()).getAllWorkers();\n+    List<BlockWorkerInfo> alluxioWorkerInfoList = context.getFsContext().getAllWorkers();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847cf041b354a5b2232c138177280c3efb32dea0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc3d51ed945c72b2dba43ce38eb4c167934ded38", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/bc3d51ed945c72b2dba43ce38eb4c167934ded38", "committedDate": "2020-02-21T18:44:44Z", "message": "Change to use getEligibleWorkers and fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/033d3263dddefad5de9ceddee3d559816e3b336f", "committedDate": "2020-02-21T19:02:56Z", "message": "Rename getEligibleWorkers to getCachedWorkers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTM0ODMy", "url": "https://github.com/Alluxio/alluxio/pull/10968#pullrequestreview-362934832", "createdAt": "2020-02-21T21:42:52Z", "commit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQwNDg2", "url": "https://github.com/Alluxio/alluxio/pull/10968#pullrequestreview-362940486", "createdAt": "2020-02-21T21:54:56Z", "commit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTo1NDo1NlrOFtFuKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTo1NDo1NlrOFtFuKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyMzk3OQ==", "bodyText": "can you mention in javadoc this method returning list of workers is relatively cheap as the result  is cached, but may not be update to date and refer to method getAllWorkers if users want to get most update-to-date list?", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382823979", "createdAt": "2020-02-21T21:54:56Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQyODIy", "url": "https://github.com/Alluxio/alluxio/pull/10968#pullrequestreview-362942822", "createdAt": "2020-02-21T21:59:58Z", "commit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTo1OTo1OFrOFtF1tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTo1OTo1OFrOFtF1tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTkwOA==", "bodyText": "can you indicate that this method is more expensive than getCachedWorkers?", "url": "https://github.com/Alluxio/alluxio/pull/10968#discussion_r382825908", "createdAt": "2020-02-21T21:59:58Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -562,6 +578,28 @@ public synchronized WorkerNetAddress getLocalWorker() throws IOException {\n     return mLocalWorker;\n   }\n \n+  /**\n+   * @return the info of all block workers eligible for reads and writes\n+   */\n+  public synchronized List<BlockWorkerInfo> getCachedWorkers() throws IOException {\n+    if (mWorkerInfoList == null || mWorkerRefreshPolicy.attempt()) {\n+      mWorkerInfoList = getAllWorkers();\n+    }\n+    return mWorkerInfoList;\n+  }\n+\n+  /**\n+   * @return the info of all block workers", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033d3263dddefad5de9ceddee3d559816e3b336f"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf8c6fa5891089151aa5c0912b1734b9d629de9b", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/cf8c6fa5891089151aa5c0912b1734b9d629de9b", "committedDate": "2020-02-21T22:58:26Z", "message": "Add descriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5cf424ac212dad71aa2e96f88e6ca1695d63e3d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/e5cf424ac212dad71aa2e96f88e6ca1695d63e3d", "committedDate": "2020-02-21T23:19:05Z", "message": "Fix java docs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4874, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}