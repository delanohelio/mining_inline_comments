{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMzY2NTU1", "number": 11194, "title": "Use worker podIP for connect and hostIP for block locations", "bodyText": "This change addresses #11172\nThis removes the need of hostNetwork in K8s environment. The worker still registers with master using the node IP (this can be retrieved using K8s downward API, no need for hostNetwork). But the client now finds the worker using container virtual IP.\nIn this way, locality-aware scheduling is preserved (by workers using node IP), but the client side can find the worker using its virtual IP. The need for escalated network access like hostNetwork and hostPort are removed.", "createdAt": "2020-03-20T06:01:23Z", "url": "https://github.com/Alluxio/alluxio/pull/11194", "merged": true, "mergeCommit": {"oid": "4d6126a5d9e03128c01ca73f2a8cad12558e981c"}, "closed": true, "closedAt": "2020-04-06T06:20:53Z", "author": {"login": "jiacheliu3"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOtrhKgH2gAyMzkxMzY2NTU1OjhkN2RlYjAyMGQ5NzJlMmI4OTI3ODRmYzhkNmVlNTcxYmYzYTFiNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU3-dTAH2gAyMzkxMzY2NTU1OjRlMGFhZmYxYTY1ZmY0ODRlM2QxY2E1NDRhM2ZhNGFkNzIyZDM5NTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8d7deb020d972e2b892784fc8d6ee571bf3a1b64", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/8d7deb020d972e2b892784fc8d6ee571bf3a1b64", "committedDate": "2020-03-18T02:14:17Z", "message": "try register with worker node hostname"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "305b544453f7d4b8ebe9108e55cc09f7d7b91c3f", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/305b544453f7d4b8ebe9108e55cc09f7d7b91c3f", "committedDate": "2020-03-19T04:17:06Z", "message": "do the translation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a2e8c972a8066586c38c2bba9b06063c53eb542", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/9a2e8c972a8066586c38c2bba9b06063c53eb542", "committedDate": "2020-03-19T12:15:37Z", "message": "change to WORKER_NODE_HOSTNAME"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30586ace7b8aeb7b533a73b4fa6fac7ab934d8dd", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/30586ace7b8aeb7b533a73b4fa6fac7ab934d8dd", "committedDate": "2020-03-20T04:20:17Z", "message": "getOutStream translation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a23ba03349dbbb6985953a1cbd3b49aa0d53ed8e", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/a23ba03349dbbb6985953a1cbd3b49aa0d53ed8e", "committedDate": "2020-03-20T06:19:24Z", "message": "include worker yaml change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a4a007293c0751a2fe2bed51efba5c59841496c", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/8a4a007293c0751a2fe2bed51efba5c59841496c", "committedDate": "2020-03-20T06:24:23Z", "message": "update configmap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0d3e33e65338e8a272766920ea047a9bbc14d40", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/c0d3e33e65338e8a272766920ea047a9bbc14d40", "committedDate": "2020-03-29T10:55:45Z", "message": "working example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c3f8539b109207bcebf24d8667197042e32df8", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e2c3f8539b109207bcebf24d8667197042e32df8", "committedDate": "2020-04-01T03:30:52Z", "message": "use alluxio.worker.container.hostname"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460da7006c03ab2c961bf13d1bfac113986de271", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/460da7006c03ab2c961bf13d1bfac113986de271", "committedDate": "2020-04-01T04:06:08Z", "message": "prepare for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2252ce2c414d0cf3cc2d6edb5ccd78dfe479df5", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e2252ce2c414d0cf3cc2d6edb5ccd78dfe479df5", "committedDate": "2020-04-01T06:26:57Z", "message": "update templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47a5a9a6a4bb66997e3b1159aba7462d2a084c6", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/f47a5a9a6a4bb66997e3b1159aba7462d2a084c6", "committedDate": "2020-04-01T07:19:32Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c49c567efcbcb59d2d3ce4a03d3a02624e8e49", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/00c49c567efcbcb59d2d3ce4a03d3a02624e8e49", "committedDate": "2020-04-01T12:02:33Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/14bd1c8a9cad43e7f419b69a58be1583d721cb35", "committedDate": "2020-04-01T12:03:56Z", "message": "revert change in Dockerfile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTAzMzY0", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-386103364", "createdAt": "2020-04-02T04:41:40Z", "commit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNDo0MTo0MFrOF_bDtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNDo1MDoyM1rOF_bLXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0NzkyNQ==", "bodyText": "I suggest not replacing the field here and instead using containerHost instead of host in https://github.com/Alluxio/alluxio/blob/master/core/common/src/main/java/alluxio/util/network/NetworkAddressUtils.java#L631\nThis is used across both read and write paths (GrpcDataReader and GrpcDataWriter) and will act as the single point of change", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402047925", "createdAt": "2020-04-02T04:41:40Z", "author": {"login": "madanadit"}, "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -214,6 +214,15 @@ public BlockInStream getInStream(BlockInfo info, InStreamOptions options,\n     }\n \n     try {\n+      // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+      // to establish the connection.\n+      if (!dataSource.getContainerHost().equals(\"\")) {\n+        String containerName = dataSource.getContainerHost();\n+        LOG.debug(\"Worker is in a container. Replace host {} with container host {}\",\n+                dataSource.getHost(), containerName);\n+        dataSource.setHost(containerName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0ODA4OQ==", "bodyText": "this redundant translation can be avoided with the change in NetworkAddressUtils", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402048089", "createdAt": "2020-04-02T04:42:26Z", "author": {"login": "madanadit"}, "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -264,6 +273,15 @@ public BlockOutStream getOutStream(long blockId, long blockSize, WorkerNetAddres\n     }\n     LOG.debug(\"Create block outstream for {} of block size {} at address {}, using options: {}\",\n         blockId, blockSize, address, options);\n+\n+    // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+    // to establish the connection.\n+    if (!address.getContainerHost().equals(\"\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0OTg4NQ==", "bodyText": "same here, this block also ends up calling NetworkAddressUtils to create GrpcDataWriter", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402049885", "createdAt": "2020-04-02T04:50:23Z", "author": {"login": "madanadit"}, "path": "core/client/fs/src/main/java/alluxio/client/block/AlluxioBlockStore.java", "diffHunk": "@@ -333,6 +351,17 @@ public BlockOutStream getOutStream(long blockId, long blockSize, OutStreamOption\n           \"Not enough workers for replications, %d workers selected but %d required\",\n           workerAddressList.size(), initialReplicas));\n     }\n+\n+    // ALLUXIO-11172: If the worker is in a container, use the container hostname\n+    // to establish the connection.\n+    for (WorkerNetAddress workerAddress : workerAddressList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODY2Nzcw", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-386866770", "createdAt": "2020-04-03T00:32:36Z", "commit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDozMjozNlrOGABKYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDozMjozNlrOGABKYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MjIyNA==", "bodyText": "Update the javadoc?", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r402672224", "createdAt": "2020-04-03T00:32:36Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/wire/WorkerNetAddress.java", "diffHunk": "@@ -53,6 +54,14 @@ public String getHost() {\n     return mHost;\n   }\n \n+  /**\n+   * @return the host of the worker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14bd1c8a9cad43e7f419b69a58be1583d721cb35"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51498ac9b186f26706dd985c8d2745dc71194605", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/51498ac9b186f26706dd985c8d2745dc71194605", "committedDate": "2020-04-03T06:15:29Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec39cd3d580fd45ed27a3dc119c289a69cd56859", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/ec39cd3d580fd45ed27a3dc119c289a69cd56859", "committedDate": "2020-04-03T06:17:35Z", "message": "revert change in AlluxioBlockStore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDAzNzEy", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-387403712", "createdAt": "2020-04-03T16:24:41Z", "commit": {"oid": "ec39cd3d580fd45ed27a3dc119c289a69cd56859"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjoyNDo0MVrOGAc2Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjoyNDo0MVrOGAc2Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEyNTg0Nw==", "bodyText": "instead of changing al numbers, set containerHost = 7", "url": "https://github.com/Alluxio/alluxio/pull/11194#discussion_r403125847", "createdAt": "2020-04-03T16:24:41Z", "author": {"login": "madanadit"}, "path": "core/transport/src/main/proto/grpc/common.proto", "diffHunk": "@@ -116,11 +116,12 @@ message NetAddress {\n  */\n message WorkerNetAddress {\n   optional string host = 1;\n-  optional int32 rpcPort = 2;\n-  optional int32 dataPort = 3;\n-  optional int32 webPort = 4;\n-  optional string domainSocketPath = 5;\n-  optional TieredIdentity tieredIdentity = 6;\n+  optional string containerHost = 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec39cd3d580fd45ed27a3dc119c289a69cd56859"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDA0MTU5", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-387404159", "createdAt": "2020-04-03T16:25:17Z", "commit": {"oid": "ec39cd3d580fd45ed27a3dc119c289a69cd56859"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bee6c36c1b7be94ee2850a83354367e8000358f", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/4bee6c36c1b7be94ee2850a83354367e8000358f", "committedDate": "2020-04-05T15:15:59Z", "message": "resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODQ3MDQ3", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-387847047", "createdAt": "2020-04-05T18:30:06Z", "commit": {"oid": "4bee6c36c1b7be94ee2850a83354367e8000358f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODY2MzM0", "url": "https://github.com/Alluxio/alluxio/pull/11194#pullrequestreview-387866334", "createdAt": "2020-04-05T22:05:39Z", "commit": {"oid": "4bee6c36c1b7be94ee2850a83354367e8000358f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d004d11de1e6c40ea40414fc2091064009140418", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/d004d11de1e6c40ea40414fc2091064009140418", "committedDate": "2020-04-06T05:25:34Z", "message": "merging and resolving conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e0aaff1a65ff484e3d1ca544a3fa4ad722d3958", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/4e0aaff1a65ff484e3d1ca544a3fa4ad722d3958", "committedDate": "2020-04-06T05:37:34Z", "message": "update CHANGELOG"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4688, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}