{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTcyMDE0", "number": 11972, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODozNDo1OVrOEYLvXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo0MDowNFrOEYL3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNzkzNjMwOnYy", "diffSide": "RIGHT", "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODozNDo1OVrOHAYj6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTowNzozNFrOHAZxzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDQ1Nw==", "bodyText": "Shall we use junit expectedMessage?\nexpectedEx.expectMessage(\"message to expect\");\n\nsee\nhttps://stackoverflow.com/questions/2469911/how-do-i-assert-my-exception-message-with-junit-test-annotation", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470164457", "createdAt": "2020-08-13T18:34:59Z", "author": {"login": "apc999"}, "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "diffHunk": "@@ -585,6 +587,46 @@ public void getBlockLocationsNoUfsLocationsWithFallback() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void appendExistingNotSupported() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {\n+      alluxioHadoopFs.append(path, 100);\n+      fail(\"append() of existing file is expected to fail\");\n+    } catch (IOException e) {\n+      assertEquals(\"append() to existing Alluxio path is currently not supported: \" + path,\n+          e.getMessage());\n+    }\n+    alluxioHadoopFs.close();\n+  }\n+\n+  @Test\n+  public void createWithoutOverwrite() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    when(alluxioFs.createFile(eq(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))), any()))\n+        .thenThrow(new FileAlreadyExistsException(path.toString()));\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4NDM5Nw==", "bodyText": "In general, I have been favoring the manual catching, mainly because the ExpectedException only works with 1 exception per test. It is common that tests might expect multiple exceptions in a test, so I tend to manually catch the Exception. In these specific tests, we only deal with 1 Exception, so ExpectedException would have worked, but I usually avoid using it because of that limitation.", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470184397", "createdAt": "2020-08-13T19:07:34Z", "author": {"login": "gpang"}, "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "diffHunk": "@@ -585,6 +587,46 @@ public void getBlockLocationsNoUfsLocationsWithFallback() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void appendExistingNotSupported() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {\n+      alluxioHadoopFs.append(path, 100);\n+      fail(\"append() of existing file is expected to fail\");\n+    } catch (IOException e) {\n+      assertEquals(\"append() to existing Alluxio path is currently not supported: \" + path,\n+          e.getMessage());\n+    }\n+    alluxioHadoopFs.close();\n+  }\n+\n+  @Test\n+  public void createWithoutOverwrite() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    when(alluxioFs.createFile(eq(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))), any()))\n+        .thenThrow(new FileAlreadyExistsException(path.toString()));\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDQ1Nw=="}, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNzkzNzk3OnYy", "diffSide": "RIGHT", "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODozNToyNlrOHAYk2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTowMTowM1rOHAZj7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDY5OQ==", "bodyText": "I will make this try-with-resource to make sure it is closed", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470164699", "createdAt": "2020-08-13T18:35:26Z", "author": {"login": "apc999"}, "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "diffHunk": "@@ -585,6 +587,46 @@ public void getBlockLocationsNoUfsLocationsWithFallback() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void appendExistingNotSupported() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {\n+      alluxioHadoopFs.append(path, 100);\n+      fail(\"append() of existing file is expected to fail\");\n+    } catch (IOException e) {\n+      assertEquals(\"append() to existing Alluxio path is currently not supported: \" + path,\n+          e.getMessage());\n+    }\n+    alluxioHadoopFs.close();\n+  }\n+\n+  @Test\n+  public void createWithoutOverwrite() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    when(alluxioFs.createFile(eq(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))), any()))\n+        .thenThrow(new FileAlreadyExistsException(path.toString()));\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDg3OQ==", "bodyText": "same comments apply to other parts", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470164879", "createdAt": "2020-08-13T18:35:47Z", "author": {"login": "apc999"}, "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "diffHunk": "@@ -585,6 +587,46 @@ public void getBlockLocationsNoUfsLocationsWithFallback() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void appendExistingNotSupported() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {\n+      alluxioHadoopFs.append(path, 100);\n+      fail(\"append() of existing file is expected to fail\");\n+    } catch (IOException e) {\n+      assertEquals(\"append() to existing Alluxio path is currently not supported: \" + path,\n+          e.getMessage());\n+    }\n+    alluxioHadoopFs.close();\n+  }\n+\n+  @Test\n+  public void createWithoutOverwrite() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    when(alluxioFs.createFile(eq(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))), any()))\n+        .thenThrow(new FileAlreadyExistsException(path.toString()));\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDY5OQ=="}, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4MDg0Ng==", "bodyText": "Done", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470180846", "createdAt": "2020-08-13T19:01:03Z", "author": {"login": "gpang"}, "path": "core/client/hdfs/src/test/java/alluxio/hadoop/AbstractFileSystemTest.java", "diffHunk": "@@ -585,6 +587,46 @@ public void getBlockLocationsNoUfsLocationsWithFallback() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void appendExistingNotSupported() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);\n+\n+    try {\n+      alluxioHadoopFs.append(path, 100);\n+      fail(\"append() of existing file is expected to fail\");\n+    } catch (IOException e) {\n+      assertEquals(\"append() to existing Alluxio path is currently not supported: \" + path,\n+          e.getMessage());\n+    }\n+    alluxioHadoopFs.close();\n+  }\n+\n+  @Test\n+  public void createWithoutOverwrite() throws Exception {\n+    Path path = new Path(\"/file\");\n+    alluxio.client.file.FileSystem alluxioFs =\n+        mock(alluxio.client.file.FileSystem.class);\n+    when(alluxioFs.exists(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))))\n+        .thenReturn(true);\n+    when(alluxioFs.createFile(eq(new AlluxioURI(HadoopUtils.getPathWithoutScheme(path))), any()))\n+        .thenThrow(new FileAlreadyExistsException(path.toString()));\n+    FileSystem alluxioHadoopFs = new FileSystem(alluxioFs);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NDY5OQ=="}, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNzk1NjA0OnYy", "diffSide": "RIGHT", "path": "core/server/master/src/main/java/alluxio/master/file/meta/InodeTree.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo0MDowNFrOHAYvow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOToxNToxOFrOHAaCLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NzQ1OQ==", "bodyText": "not clear to me. do we mean:\nNot allowed to create a new file or dir with existing path?", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470167459", "createdAt": "2020-08-13T18:40:04Z", "author": {"login": "apc999"}, "path": "core/server/master/src/main/java/alluxio/master/file/meta/InodeTree.java", "diffHunk": "@@ -675,16 +676,22 @@ public InodeDirectory getRoot() {\n     // helper method for the shared logic.\n     AlluxioURI path = inodePath.getUri();\n     if (path.isRoot()) {\n-      String errorMessage = ExceptionMessage.FILE_ALREADY_EXISTS.getMessage(path);\n+      String errorMessage = \"Not allowed to create existing root path: \" + path;\n       LOG.error(errorMessage);\n       throw new FileAlreadyExistsException(errorMessage);\n     }\n     if (inodePath.fullPathExists()) {\n       if (context instanceof CreateDirectoryContext\n           && ((CreateDirectoryContext) context).getOptions().getAllowExists()) {\n-        return new ArrayList<>();\n+        return Collections.emptyList();\n       } else {\n-        throw new FileAlreadyExistsException(path);\n+        String pathType = \"file\";\n+        if (context instanceof CreateDirectoryContext) {\n+          pathType = \"directory\";\n+        }\n+        String errorMessage =\n+            String.format(\"Not allowed to create existing %s: %s\", pathType, path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4ODU4OQ==", "bodyText": "I updated it. Does the message make more sense?", "url": "https://github.com/Alluxio/alluxio/pull/11972#discussion_r470188589", "createdAt": "2020-08-13T19:15:18Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/meta/InodeTree.java", "diffHunk": "@@ -675,16 +676,22 @@ public InodeDirectory getRoot() {\n     // helper method for the shared logic.\n     AlluxioURI path = inodePath.getUri();\n     if (path.isRoot()) {\n-      String errorMessage = ExceptionMessage.FILE_ALREADY_EXISTS.getMessage(path);\n+      String errorMessage = \"Not allowed to create existing root path: \" + path;\n       LOG.error(errorMessage);\n       throw new FileAlreadyExistsException(errorMessage);\n     }\n     if (inodePath.fullPathExists()) {\n       if (context instanceof CreateDirectoryContext\n           && ((CreateDirectoryContext) context).getOptions().getAllowExists()) {\n-        return new ArrayList<>();\n+        return Collections.emptyList();\n       } else {\n-        throw new FileAlreadyExistsException(path);\n+        String pathType = \"file\";\n+        if (context instanceof CreateDirectoryContext) {\n+          pathType = \"directory\";\n+        }\n+        String errorMessage =\n+            String.format(\"Not allowed to create existing %s: %s\", pathType, path);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NzQ1OQ=="}, "originalCommit": {"oid": "c95dde48a8d38c8e704c66d4c008cc40a56c1e02"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1297, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}