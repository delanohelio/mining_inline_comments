{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTQyMDU1", "number": 10919, "title": "Allow superuser to stopActiveSync w/o a lock", "bodyText": "A full scan for active sync acquires a write lock on the syncPoint which prevents the permission check for stopSync to proceed. This PR skips the read lock needed on the inode for the permission check if the user is a super user. This allows us to terminate a long-running full scan early.", "createdAt": "2020-02-14T19:34:55Z", "url": "https://github.com/Alluxio/alluxio/pull/10919", "merged": true, "mergeCommit": {"oid": "0e047f9bbbc95af660b1e2d27351bfb8f475892b"}, "closed": true, "closedAt": "2020-02-18T16:44:20Z", "author": {"login": "madanadit"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEUqApAH2gAyMzc1NTQyMDU1OjNjZTIzOGY4Y2EwOGYyZGQ4ODIyZTk1MGI4NjdlOTIyOWU5ZjU5Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFkqrTAFqTM2MDQ5MzkxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3ce238f8ca08f2dd8822e950b867e9229e9f59b9", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/3ce238f8ca08f2dd8822e950b867e9229e9f59b9", "committedDate": "2020-02-14T19:25:46Z", "message": "Alloq super user to stopSync w/o a lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17b608b592ba6c0362313812f2b0d007804e5836", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/17b608b592ba6c0362313812f2b0d007804e5836", "committedDate": "2020-02-14T19:30:12Z", "message": "Cleanup logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1f59e01a01fe7c9a5d4c4ac7c67ff60abe1ed7d", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/b1f59e01a01fe7c9a5d4c4ac7c67ff60abe1ed7d", "committedDate": "2020-02-14T19:31:14Z", "message": "Remove newline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjA0NDk5", "url": "https://github.com/Alluxio/alluxio/pull/10919#pullrequestreview-359204499", "createdAt": "2020-02-14T20:36:11Z", "commit": {"oid": "b1f59e01a01fe7c9a5d4c4ac7c67ff60abe1ed7d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDozNjoxMVrOFqC9nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDozNjoxMVrOFqC9nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzA1NQ==", "bodyText": "can we add a TODO saying we can remove this once a sync doesn't require a write lock during the sync?", "url": "https://github.com/Alluxio/alluxio/pull/10919#discussion_r379633055", "createdAt": "2020-02-14T20:36:11Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -3817,21 +3817,35 @@ public void startSync(AlluxioURI syncPoint)\n   @Override\n   public void stopSync(AlluxioURI syncPoint)\n       throws IOException, InvalidPathException, AccessControlException {\n-    LockingScheme lockingScheme = new LockingScheme(syncPoint, LockPattern.WRITE_EDGE, false);\n-    try (RpcContext rpcContext = createRpcContext();\n-        LockedInodePath inodePath =\n-            mInodeTree.lockInodePath(lockingScheme.getPath(), lockingScheme.getPattern());\n-        FileSystemMasterAuditContext auditContext =\n-             createAuditContext(\"stopSync\", syncPoint, null,\n-                 inodePath.getParentInodeOrNull())) {\n+    try (RpcContext rpcContext = createRpcContext()) {\n+      boolean isSuperUser = true;\n       try {\n-        mPermissionChecker.checkParentPermission(Mode.Bits.WRITE, inodePath);\n+        mPermissionChecker.checkSuperUser();\n       } catch (AccessControlException e) {\n-        auditContext.setAllowed(false);\n-        throw e;\n+        isSuperUser = false;\n+      }\n+      if (isSuperUser) {\n+        // Stop sync w/o acquiring an inode lock to terminate an initial full scan (if running)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1f59e01a01fe7c9a5d4c4ac7c67ff60abe1ed7d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjA2MTQy", "url": "https://github.com/Alluxio/alluxio/pull/10919#pullrequestreview-359206142", "createdAt": "2020-02-14T20:39:38Z", "commit": {"oid": "b1f59e01a01fe7c9a5d4c4ac7c67ff60abe1ed7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1138329e47f98ec92251db735c903b8d24575b0e", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/1138329e47f98ec92251db735c903b8d24575b0e", "committedDate": "2020-02-14T20:55:34Z", "message": "Add TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a181d5045e363e017db6b83a0dc979b1d706c94", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/3a181d5045e363e017db6b83a0dc979b1d706c94", "committedDate": "2020-02-15T00:31:48Z", "message": "Add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5bf032ee0d00af276eaaf04c40860d29c72b645", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/a5bf032ee0d00af276eaaf04c40860d29c72b645", "committedDate": "2020-02-15T00:33:11Z", "message": "be consistent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDkzOTEx", "url": "https://github.com/Alluxio/alluxio/pull/10919#pullrequestreview-360493911", "createdAt": "2020-02-18T16:38:54Z", "commit": {"oid": "a5bf032ee0d00af276eaaf04c40860d29c72b645"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4962, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}