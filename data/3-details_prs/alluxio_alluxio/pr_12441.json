{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzg1MDkx", "number": 12441, "title": "Prevent unnecessary inode syncing", "bodyText": "Fix #12372\nBefore this PR, running\nbin/alluxio fs ls -Dalluxio.user.file.metadata.sync.interval=0 /path\n\nwill trigger syncing inodes:\n(1) /path\n(2) /path/{children}\n(3) /path/{children}/{children} (added to pending inode queue when InodeSyncStream traversing (2))\nReading (3) is unnecessary w.r.t. the command we are interested. This PR check and prevent setting flag syncChildren unnecessarily.\nIn addition, this patch also saves one unnecessary RPC on ls command.", "createdAt": "2020-10-31T06:51:08Z", "url": "https://github.com/Alluxio/alluxio/pull/12441", "merged": true, "mergeCommit": {"oid": "63d565de53326378471dcbadda26d3afe708e8a1"}, "closed": true, "closedAt": "2020-11-03T02:38:42Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdX18qHgBqjM5NDM4Mzg1OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYvX92ABqjM5NTA4MTQ1MDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "559351ce4cd2d42d1f41b0d5974812521e4bf807", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/559351ce4cd2d42d1f41b0d5974812521e4bf807", "committedDate": "2020-10-31T06:50:34Z", "message": "Prevent unnecessary inode syncing"}, "afterCommit": {"oid": "c244a32207dd159984f92ff6db4ede1ff536f287", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/c244a32207dd159984f92ff6db4ede1ff536f287", "committedDate": "2020-10-31T07:08:31Z", "message": "Prevent unnecessary inode syncing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTYyNTk2", "url": "https://github.com/Alluxio/alluxio/pull/12441#pullrequestreview-521962596", "createdAt": "2020-11-02T20:17:35Z", "commit": {"oid": "c244a32207dd159984f92ff6db4ede1ff536f287"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzozNVrOHsUL8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxNzozNVrOHsUL8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIzMDEzMA==", "bodyText": "Can we encode this desired behavior in a simple unittest?", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516230130", "createdAt": "2020-11-02T20:17:35Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -569,9 +570,16 @@ private void syncExistingInodeMetadata(LockedInodePath inodePath)\n       }\n     }\n \n-    syncChildren = syncChildren\n-        && inode.isDirectory()\n-        && mDescendantType != DescendantType.NONE;\n+    // Only sync children when\n+    // (1) DescendantType.ALL or (2) syncing root of this stream && DescendantType.ONE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c244a32207dd159984f92ff6db4ede1ff536f287"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c244a32207dd159984f92ff6db4ede1ff536f287", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/c244a32207dd159984f92ff6db4ede1ff536f287", "committedDate": "2020-10-31T07:08:31Z", "message": "Prevent unnecessary inode syncing"}, "afterCommit": {"oid": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "committedDate": "2020-11-03T01:34:09Z", "message": "Prevent unnecessary inode syncing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTQ2NzY2", "url": "https://github.com/Alluxio/alluxio/pull/12441#pullrequestreview-522146766", "createdAt": "2020-11-03T01:47:10Z", "commit": {"oid": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMTo0NzoxMFrOHsdznw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMTo0NzoxMFrOHsdznw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4Nzc0Mw==", "bodyText": "Does this work because recursive is false by default? We want it false, right?", "url": "https://github.com/Alluxio/alluxio/pull/12441#discussion_r516387743", "createdAt": "2020-11-03T01:47:10Z", "author": {"login": "gpang"}, "path": "tests/src/test/java/alluxio/client/fs/UfsSyncIntegrationTest.java", "diffHunk": "@@ -168,6 +184,21 @@ public void listDirSync() throws Exception {\n     checkListStatus(ROOT_DIR, options, true);\n   }\n \n+  // https://github.com/Alluxio/alluxio/issues/12372\n+  @Test\n+  public void listDirSyncOnlyTouchingChildren() throws Exception {\n+    String dir1 = PathUtils.concatPath(EXISTING_DIR, \"dir_should_sync\");\n+    String dir2 = PathUtils.concatPath(dir1, \"dir_should_not_sync\");\n+    new File(ufsPath(dir1)).mkdirs();\n+    new File(ufsPath(dir2)).mkdirs();\n+    ListStatusPOptions optionsAlways = ListStatusPOptions.newBuilder()\n+        .setLoadMetadataType(LoadMetadataPType.NEVER).setCommonOptions(PSYNC_ALWAYS).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "committedDate": "2020-11-03T02:02:51Z", "message": "Prevent unnecessary inode syncing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/0931f9b8ddda365d030a94c6b98fde3a9f3e5966", "committedDate": "2020-11-03T01:34:09Z", "message": "Prevent unnecessary inode syncing"}, "afterCommit": {"oid": "5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5776fe02fac0afbdd8c26ea1f8c2d6ea81519a13", "committedDate": "2020-11-03T02:02:51Z", "message": "Prevent unnecessary inode syncing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3515, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}