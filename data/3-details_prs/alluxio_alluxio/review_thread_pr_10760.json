{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzOTE4OTIw", "number": 10760, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTozNzo1MVrODY6x6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjowNjo1MFrODY_Ajw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU1NDY0OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTozNzo1MVrOFfDQGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMToyNVrOFfG52Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMzQ0OA==", "bodyText": "[ERROR] alluxio.client.file.cache.store.LocalPageStore.get(PageId, int) may fail to clean up java.io.InputStream on checked exception [alluxio.client.file.cache.store.LocalPageStore, alluxio.client.file.cache.store.LocalPageStore] Obligation to clean up resource created at LocalPageStore.java:[line 78] is not dischargedPath continues at LocalPageStore.java:[line 79] OBL_UNSATISFIED_OBLIGATION_EXCEPTION_EDGE", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368103448", "createdAt": "2020-01-17T19:37:51Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+      throws IOException, PageNotFoundException {\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n     FileInputStream fis = new FileInputStream(p.toFile());\n+    fis.skip(pageOffset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzI4OQ==", "bodyText": "Fixed.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163289", "createdAt": "2020-01-17T22:31:25Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+      throws IOException, PageNotFoundException {\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n     FileInputStream fis = new FileInputStream(p.toFile());\n+    fis.skip(pageOffset);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMzQ0OA=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU2NTg5OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0MjowN1rOFfDW9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMTo1NlrOFfG6Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTIwNw==", "bodyText": "what is expected if pageOffset > page len? Exception or an empty channel?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105207", "createdAt": "2020-01-17T19:42:07Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -78,7 +78,21 @@ static PageStore create(AlluxioConfiguration conf) {\n    * @throws IOException\n    * @throws PageNotFoundException when the page isn't found in the store\n    */\n-  ReadableByteChannel get(PageId pageId) throws IOException,\n+  default ReadableByteChannel get(PageId pageId) throws IOException,\n+      PageNotFoundException {\n+    return get(pageId, 0);\n+  }\n+\n+  /**\n+   * Gets part of a page from the store to the destination channel.\n+   *\n+   * @param pageId page identifier\n+   * @param pageOffset offset within page\n+   * @return the number of bytes read\n+   * @throws IOException\n+   * @throws PageNotFoundException when the page isn't found in the store\n+   */\n+  ReadableByteChannel get(PageId pageId, int pageOffset) throws IOException,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzQzMA==", "bodyText": "Will throw an IllegalArgumentException just to be safe.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163430", "createdAt": "2020-01-17T22:31:56Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -78,7 +78,21 @@ static PageStore create(AlluxioConfiguration conf) {\n    * @throws IOException\n    * @throws PageNotFoundException when the page isn't found in the store\n    */\n-  ReadableByteChannel get(PageId pageId) throws IOException,\n+  default ReadableByteChannel get(PageId pageId) throws IOException,\n+      PageNotFoundException {\n+    return get(pageId, 0);\n+  }\n+\n+  /**\n+   * Gets part of a page from the store to the destination channel.\n+   *\n+   * @param pageId page identifier\n+   * @param pageOffset offset within page\n+   * @return the number of bytes read\n+   * @throws IOException\n+   * @throws PageNotFoundException when the page isn't found in the store\n+   */\n+  ReadableByteChannel get(PageId pageId, int pageOffset) throws IOException,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTIwNw=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU2ODE3OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0MzowN1rOFfDYYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMjowNVrOFfG6gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTU3MQ==", "bodyText": "3 -> offset", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105571", "createdAt": "2020-01-17T19:43:07Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {\n+    mOptions.setRootDir(mTemp.getRoot().getAbsolutePath());\n+    int len = 32;\n+    int offset = 3;\n+    try (PageStore store = PageStore.create(mOptions)) {\n+      PageId id = new PageId(0, 0);\n+      store.put(id, BufferUtils.getIncreasingByteArray(len));\n+      ByteBuffer buf = ByteBuffer.allocate(1024);\n+      try (ReadableByteChannel channel = store.get(id, offset)) {\n+        channel.read(buf);\n+      }\n+      buf.flip();\n+      assertTrue(BufferUtils.equalIncreasingByteBuffer(3, len - offset, buf));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzQ1Nw==", "bodyText": "Updated.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163457", "createdAt": "2020-01-17T22:32:05Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {\n+    mOptions.setRootDir(mTemp.getRoot().getAbsolutePath());\n+    int len = 32;\n+    int offset = 3;\n+    try (PageStore store = PageStore.create(mOptions)) {\n+      PageId id = new PageId(0, 0);\n+      store.put(id, BufferUtils.getIncreasingByteArray(len));\n+      ByteBuffer buf = ByteBuffer.allocate(1024);\n+      try (ReadableByteChannel channel = store.get(id, offset)) {\n+        channel.read(buf);\n+      }\n+      buf.flip();\n+      assertTrue(BufferUtils.equalIncreasingByteBuffer(3, len - offset, buf));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTU3MQ=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU2OTc5OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0Mzo0OFrOFfDZgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMjoxNFrOFfG6rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTg1OA==", "bodyText": "also test the case offset exceeding page len?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105858", "createdAt": "2020-01-17T19:43:48Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzUwMA==", "bodyText": "Added.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163500", "createdAt": "2020-01-17T22:32:14Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTg1OA=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU3MTI4OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0NDoyOFrOFfDadw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMjoyM1rOFfG6zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjEwMw==", "bodyText": "Precondition to check page Offset is positive?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368106103", "createdAt": "2020-01-17T19:44:28Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzUzNQ==", "bodyText": "Added.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163535", "createdAt": "2020-01-17T22:32:23Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjEwMw=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDU3MTYwOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0NDozNlrOFfDarQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozMjozMlrOFfG6-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjE1Nw==", "bodyText": "Precondition to check page Offset is positive?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368106157", "createdAt": "2020-01-17T19:44:36Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -76,14 +76,15 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException,\n-      PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MzU3Ng==", "bodyText": "Added.", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368163576", "createdAt": "2020-01-17T22:32:32Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -76,14 +76,15 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException,\n-      PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjE1Nw=="}, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI0NzUxOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjowNjo1MFrOFfJtKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjowNjo1MFrOFfJtKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTE5Mw==", "bodyText": "nit: is Throwable required here to avoid the warning or can we just catch IOException or Exception ?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368209193", "createdAt": "2020-01-18T06:06:50Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,13 +69,24 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+      throws IOException, PageNotFoundException {\n+    Preconditions.checkArgument(pageOffset >= 0, \"page offset should be non-negative\");\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n+    File f = p.toFile();\n+    Preconditions.checkArgument(pageOffset <= f.length(),\n+        \"page offset %s exceeded page size %s\", pageOffset, f.length());\n     FileInputStream fis = new FileInputStream(p.toFile());\n-    return fis.getChannel();\n+    try {\n+      fis.skip(pageOffset);\n+      return fis.getChannel();\n+    } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae0e2486c52291262fa40717759a27aa3ce19c7"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2068, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}