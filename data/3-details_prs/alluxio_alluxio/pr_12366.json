{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MjY4MTAw", "number": 12366, "title": "Avoid loads ufs jars multiple times during journal formatting", "bodyText": "Fix #12113\nI do the following test, and can only search one line loading core jars output, it is my expected.\nalluxio formatMaster\nI also start the master to check master can start successful, check alluxio master log only contains one line loading core jars output, it is my expected.", "createdAt": "2020-10-22T12:52:23Z", "url": "https://github.com/Alluxio/alluxio/pull/12366", "merged": true, "mergeCommit": {"oid": "22b67274fd032ce46532c3e21a46e973c7ccc307"}, "closed": true, "closedAt": "2020-12-11T17:56:57Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVB_YpgBqjM5MDkwNzY3MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdknYzhAFqTU0ODcwMDg2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b8733f0cefbef20b7a72f42a5cac12cc2bcfe88", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/0b8733f0cefbef20b7a72f42a5cac12cc2bcfe88", "committedDate": "2020-10-22T12:50:50Z", "message": "Avoid loads ufs jars multiple times during journal formatting"}, "afterCommit": {"oid": "6fc1222a58feacc679a8f467260eff4fc0f9f147", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/6fc1222a58feacc679a8f467260eff4fc0f9f147", "committedDate": "2020-10-22T13:28:32Z", "message": "Avoid loads ufs jars multiple times during journal formatting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fc1222a58feacc679a8f467260eff4fc0f9f147", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/6fc1222a58feacc679a8f467260eff4fc0f9f147", "committedDate": "2020-10-22T13:28:32Z", "message": "Avoid loads ufs jars multiple times during journal formatting"}, "afterCommit": {"oid": "aed1c84e46d24cb2904bb16f9d7f1ef7e18e20da", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/aed1c84e46d24cb2904bb16f9d7f1ef7e18e20da", "committedDate": "2020-10-22T14:32:25Z", "message": "Avoid loads ufs jars multiple times during journal formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDgzMDkw", "url": "https://github.com/Alluxio/alluxio/pull/12366#pullrequestreview-538083090", "createdAt": "2020-11-25T01:05:27Z", "commit": {"oid": "9ae1e175c96b710856ba4648d30022d2b9c10a12"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTowNToyOFrOH5fN7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTowNToyOFrOH5fN7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MjM0OQ==", "bodyText": "The root UFS is different from the journal UFS. If the UfsManager doesn't have it already, it should have a method for acquiring the journal UFS (to also use the journal conf, instead of the root ufs conf).\nYou can basically think of the journal UFS as a different mount point (separate from any other mount point), which is just for accessing the journal UFS.", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r530042349", "createdAt": "2020-11-25T01:05:28Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/ufs/UfsJournal.java", "diffHunk": "@@ -146,7 +146,8 @@ protected static UnderFileSystemConfiguration getJournalUfsConf() {\n    */\n   public UfsJournal(URI location, Master master, long quietPeriodMs,\n       Supplier<Set<JournalSink>> journalSinks) {\n-    this(location, master, UnderFileSystem.Factory.create(location.toString(), getJournalUfsConf()),\n+    this(location, master, master.getMasterContext().getUfsManager().getRoot().acquireUfsResource()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ae1e175c96b710856ba4648d30022d2b9c10a12"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cabf8c6b7243b74dc69be23accaaca082dd7582", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/0cabf8c6b7243b74dc69be23accaaca082dd7582", "committedDate": "2020-11-30T04:54:14Z", "message": "Avoid loads ufs jars multiple times during journal formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f275b65929707ae026496bf82278dd656f84b18b", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/f275b65929707ae026496bf82278dd656f84b18b", "committedDate": "2020-11-30T04:54:14Z", "message": "Add a missing java doc for NoopUfsManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec5815f65bf31ccd5a43f6d1508d9435d11bfce1", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/ec5815f65bf31ccd5a43f6d1508d9435d11bfce1", "committedDate": "2020-11-30T04:54:14Z", "message": "use journal mountpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7314e42ebbba2a917ce00f6758034139353ad7fa", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/7314e42ebbba2a917ce00f6758034139353ad7fa", "committedDate": "2020-11-30T04:54:14Z", "message": "fix the style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0573c82f9f392c18e0dbc0e6667e7de402089d3", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/b0573c82f9f392c18e0dbc0e6667e7de402089d3", "committedDate": "2020-11-30T09:56:46Z", "message": "Add journal mountpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e3641c1e8b350acb77a24c31ffdfc3cf260f892", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/7e3641c1e8b350acb77a24c31ffdfc3cf260f892", "committedDate": "2020-11-28T15:04:40Z", "message": "fix the style"}, "afterCommit": {"oid": "b0573c82f9f392c18e0dbc0e6667e7de402089d3", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/b0573c82f9f392c18e0dbc0e6667e7de402089d3", "committedDate": "2020-11-30T09:56:46Z", "message": "Add journal mountpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/163d57bbc5584cab16af55ad7f55f396fa05c81b", "committedDate": "2020-11-30T10:36:21Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTM0NTU5", "url": "https://github.com/Alluxio/alluxio/pull/12366#pullrequestreview-546534559", "createdAt": "2020-12-07T21:04:09Z", "commit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMTowNDowOVrOIA6nUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMToyNTo0NlrOIA7ZzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzMTI1MA==", "bodyText": "I don't these parameters are necessary. The journal is a not actually a mount point. There is already a config prefix for the journal config: https://github.com/Alluxio/alluxio/blob/v2.4.1/core/common/src/main/java/alluxio/conf/PropertyKey.java#L1163", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537831250", "createdAt": "2020-12-07T21:04:09Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -1241,6 +1241,45 @@ public String toString() {\n           .setScope(Scope.MASTER)\n           .build();\n \n+  //\n+  // Mount table journal related properties", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzMzM5MA==", "bodyText": "Why is this change necessary?", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537833390", "createdAt": "2020-12-07T21:07:41Z", "author": {"login": "gpang"}, "path": "tests/src/test/java/alluxio/client/hadoop/FileSystemRenameIntegrationTest.java", "diffHunk": "@@ -236,7 +236,7 @@ public void basicRenameTest7() throws Exception {\n     // Due to Hadoop 1 support we stick with the deprecated version. If we drop support for it\n     // FSDataOutputStream.hflush will be the new one.\n     //#ifdef HADOOP1\n-    o.sync();\n+//    o.sync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNTM2OQ==", "bodyText": "Calling getJournalUfsConf(), or doing the same operations as that method (https://github.com/Alluxio/alluxio/blob/v2.4.1/core/server/common/src/main/java/alluxio/master/journal/ufs/UfsJournal.java#L131), is important. Is the new behavior equivalent to the previous call to getJournalUfsConf()?", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537835369", "createdAt": "2020-12-07T21:10:59Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/ufs/UfsJournal.java", "diffHunk": "@@ -146,7 +146,9 @@ protected static UnderFileSystemConfiguration getJournalUfsConf() {\n    */\n   public UfsJournal(URI location, Master master, long quietPeriodMs,\n       Supplier<Set<JournalSink>> journalSinks) {\n-    this(location, master, UnderFileSystem.Factory.create(location.toString(), getJournalUfsConf()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzOTAyOQ==", "bodyText": "Does the NOOP one require this implementation?", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537839029", "createdAt": "2020-12-07T21:17:04Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/NoopUfsManager.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.master;\n+\n+import alluxio.conf.ServerConfiguration;\n+import alluxio.underfs.AbstractUfsManager;\n+import alluxio.underfs.UnderFileSystem;\n+import alluxio.util.network.NetworkAddressUtils;\n+\n+import java.io.IOException;\n+\n+/**\n+ * Implementation of UfsManager that does nothing. This is useful for testing and\n+ * for situations where we don't want to start a real UfsManager,e.g. when formatting the journal.\n+ */\n+public class NoopUfsManager extends AbstractUfsManager {\n+\n+  @Override\n+  protected void connectUfs(UnderFileSystem fs) throws IOException {\n+    fs.connectFromMaster(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0MzQyMQ==", "bodyText": "It looks like we are reusing the mounts to store the journal UFS as well. Can you document that in a comment somewhere? Maybe near the top of this class?", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537843421", "createdAt": "2020-12-07T21:24:31Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/underfs/AbstractUfsManager.java", "diffHunk": "@@ -209,6 +210,30 @@ public UfsClient getRoot() {\n     }\n   }\n \n+  @Override\n+  public UfsClient getJournal() {\n+    synchronized (this) {\n+      if (mJournalUfsClient == null) {\n+        String uri = ServerConfiguration.get(PropertyKey.MASTER_MOUNT_TABLE_JOURNAL_UFS);\n+        boolean readOnly =\n+            ServerConfiguration.getBoolean(PropertyKey.MASTER_MOUNT_TABLE_JOURNAL_READONLY);\n+        boolean shared = ServerConfiguration\n+            .getBoolean(PropertyKey.MASTER_MOUNT_TABLE_JOURNAL_SHARED);\n+        Map<String, String> conf =\n+            ServerConfiguration.getNestedProperties(PropertyKey.MASTER_MOUNT_TABLE_JOURNAL_OPTION);\n+        addMount(IdUtils.JOURNAL_MOUNT_ID, new AlluxioURI(uri),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NDE3Mg==", "bodyText": "NIT: I think this only applies to UFS journal, so maybe rename this toUFS_JOURNAL_MOUNT_ID, and add a comment that the journal ufs is stored as a special mount in the ufs manager.", "url": "https://github.com/Alluxio/alluxio/pull/12366#discussion_r537844172", "createdAt": "2020-12-07T21:25:46Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/IdUtils.java", "diffHunk": "@@ -34,6 +34,7 @@\n   public static final long INVALID_WORKER_ID = -1;\n   public static final long INVALID_MOUNT_ID = -1;\n   public static final long ROOT_MOUNT_ID = 1;\n+  public static final long JOURNAL_MOUNT_ID = Long.MAX_VALUE - 10000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163d57bbc5584cab16af55ad7f55f396fa05c81b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ec18e42f854d0539f97a1b7622c5c29d254e93", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/76ec18e42f854d0539f97a1b7622c5c29d254e93", "committedDate": "2020-12-08T16:25:39Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa77fe6113b4b30064f01dac77896312fbcc587", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/cfa77fe6113b4b30064f01dac77896312fbcc587", "committedDate": "2020-12-09T06:05:47Z", "message": "address comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9936552018908eea0c3e5eaed6c2735f77c07c40", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/9936552018908eea0c3e5eaed6c2735f77c07c40", "committedDate": "2020-12-09T06:08:46Z", "message": "address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzAwODYz", "url": "https://github.com/Alluxio/alluxio/pull/12366#pullrequestreview-548700863", "createdAt": "2020-12-09T23:31:54Z", "commit": {"oid": "9936552018908eea0c3e5eaed6c2735f77c07c40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3469, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}