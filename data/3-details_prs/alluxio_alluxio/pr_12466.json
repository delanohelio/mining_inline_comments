{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDEwNDk1", "number": 12466, "title": "Prevent the grpc reader from waiting for a server response", "bodyText": "When a grpc reader is closing, there is no message that it is expecting from the server, however, it is currently waiting for some confirmation from the server. This can sometimes lead to an exception in the close() phase of the reader, which is unnecessary, since the client is completely finished with reading.\nIn this change, we avoid waiting long for the server when the reader is closing. If something does occur during the wait, we ignore it. This avoids any unnecessary timeouts or errors during close(), after the client is finished reading successfully.", "createdAt": "2020-11-06T00:01:34Z", "url": "https://github.com/Alluxio/alluxio/pull/12466", "merged": true, "mergeCommit": {"oid": "3715744770022a5c3d131b865a32addd977cb482"}, "closed": true, "closedAt": "2020-11-11T01:00:45Z", "author": {"login": "gpang"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZpd6FgH2gAyNTE2NDEwNDk1OmY3OTE4YzEwZmVmMTZkZWJhZGY2NjRlN2QyOGVlYzc4OWQ4ZTBiODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbTLr2gFqTUyNzc2NjQwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7918c10fef16debadf664e7d28eec789d8e0b81", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/f7918c10fef16debadf664e7d28eec789d8e0b81", "committedDate": "2020-11-05T21:44:07Z", "message": "Make a shared variable volatile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53b8b30e424e9a0ce55e4bcfa92d5d1eb03e5e35", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/53b8b30e424e9a0ce55e4bcfa92d5d1eb03e5e35", "committedDate": "2020-11-06T00:00:34Z", "message": "Avoid waiting for server when reader is closing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae3866705eb26a62d2534f74fb993057caabae6", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/fae3866705eb26a62d2534f74fb993057caabae6", "committedDate": "2020-11-06T01:41:05Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3c356782a748c6c1589ab273a0148438274908e", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/d3c356782a748c6c1589ab273a0148438274908e", "committedDate": "2020-11-06T17:28:50Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a34757f8a802dc8e10c49729895425f0161a67f", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/6a34757f8a802dc8e10c49729895425f0161a67f", "committedDate": "2020-11-06T18:18:09Z", "message": "Update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7", "committedDate": "2020-11-06T21:30:58Z", "message": "[WIP] test logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc58b4add0b018635039c0dcdb14bd35ba964082", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/bc58b4add0b018635039c0dcdb14bd35ba964082", "committedDate": "2020-11-06T22:18:18Z", "message": "[WIP] logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53956500a62cb345aab7681d2321ceb0624137cd", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/53956500a62cb345aab7681d2321ceb0624137cd", "committedDate": "2020-11-06T23:01:41Z", "message": "[WIP] logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cff25845bc280cfcd8dfd72eb8888192c12140e", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/7cff25845bc280cfcd8dfd72eb8888192c12140e", "committedDate": "2020-11-07T18:12:43Z", "message": "Revert \"[WIP] test logging\"\n\nThis reverts commit bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7."}, "afterCommit": {"oid": "53956500a62cb345aab7681d2321ceb0624137cd", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/53956500a62cb345aab7681d2321ceb0624137cd", "committedDate": "2020-11-06T23:01:41Z", "message": "[WIP] logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4", "committedDate": "2020-11-09T18:38:27Z", "message": "[WIP] more logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c324bf93b11348c56c44201350f660cceef3d0c1", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/c324bf93b11348c56c44201350f660cceef3d0c1", "committedDate": "2020-11-09T19:15:09Z", "message": "[WIP] more logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a68c17642916d34e6328a16c5f88c9bf807d23e", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/4a68c17642916d34e6328a16c5f88c9bf807d23e", "committedDate": "2020-11-09T21:27:01Z", "message": "Revert \"[WIP] more logging\"\n\nThis reverts commit c324bf93b11348c56c44201350f660cceef3d0c1."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103056d6b54bfc22aab6abf9e94b4bfc8deb0e64", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/103056d6b54bfc22aab6abf9e94b4bfc8deb0e64", "committedDate": "2020-11-09T21:27:32Z", "message": "Revert \"[WIP] more logging\"\n\nThis reverts commit 85612f7e85ad8a216367f2ada89cc4ac2e9d6ce4."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d3266b7402b1d6abbfcf4358ae7a48287273fd", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/64d3266b7402b1d6abbfcf4358ae7a48287273fd", "committedDate": "2020-11-09T21:27:53Z", "message": "Revert \"[WIP] logging\"\n\nThis reverts commit 53956500a62cb345aab7681d2321ceb0624137cd."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ecf003ef84e8c55015c918ec528d6552812319", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/51ecf003ef84e8c55015c918ec528d6552812319", "committedDate": "2020-11-09T21:28:00Z", "message": "Revert \"[WIP] logging\"\n\nThis reverts commit bc58b4add0b018635039c0dcdb14bd35ba964082."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80e64405d54c4eaf39b5a8ec91f7884b63b6fa0d", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/80e64405d54c4eaf39b5a8ec91f7884b63b6fa0d", "committedDate": "2020-11-09T21:28:06Z", "message": "Revert \"[WIP] test logging\"\n\nThis reverts commit bce8fe97e9a3ea0e1493b1c712766d37cd2afdd7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/92473d5211490f35dc21b3067baedc389535d9f5", "committedDate": "2020-11-09T21:39:58Z", "message": "Wait a short amount of time for the close to propagate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzM3ODc4", "url": "https://github.com/Alluxio/alluxio/pull/12466#pullrequestreview-526737878", "createdAt": "2020-11-09T23:31:16Z", "commit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzozMToxN1rOHwFuqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzozNzowOFrOHwF3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzU2Mw==", "bodyText": "Is the default buffer size (16) not large enough? With 2MB message size we are looking at 32MB buffer per reader, this can grow quickly if multi-thread reading is used.", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520187563", "createdAt": "2020-11-09T23:31:17Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -77,7 +78,9 @@\n   public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> rpcFunc,\n       int bufferSize, String description) {\n     LOG.debug(\"Opening stream ({})\", description);\n-    mResponses = new ArrayBlockingQueue<>(bufferSize);\n+    // Use an unlimited queue to avoid blocking the network threads. Depend on custom flow\n+    // control to limit the size of buffer.\n+    mResponses = new LinkedBlockingQueue<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4OTc0OQ==", "bodyText": "Some applications may depend on the closure to be done on the server side so they can perform other operations on the file safely. Having the reader skip the wait may cause subsequent operations to fail.", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520189749", "createdAt": "2020-11-09T23:37:08Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcDataReader.java", "diffHunk": "@@ -168,7 +169,19 @@ public void close() throws IOException {\n         return;\n       }\n       mStream.close();\n-      mStream.waitForComplete(mDataTimeoutMs);\n+\n+      // When a reader is closed, there is technically nothing the client requires from the server.\n+      // However, the server does need to cleanup resources for a client close(), including closing\n+      // or canceling any temp blocks. Therefore, we should wait for some amount of time for the\n+      // server to finish cleanup, but it should not be very long (since the client is finished\n+      // with the read). Also, if there is any error when waiting for the complete, it should be\n+      // ignored since again, the client is completely finished with the read.\n+      try {\n+        // Wait a short time for the server to finish the close, and then let the client continue.\n+        mStream.waitForComplete(5 * Constants.SECOND_MS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47d0833fff093d88284d215771877974f8098148", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/47d0833fff093d88284d215771877974f8098148", "committedDate": "2020-11-10T00:14:53Z", "message": "Limit buffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzU2Njc4", "url": "https://github.com/Alluxio/alluxio/pull/12466#pullrequestreview-526756678", "createdAt": "2020-11-10T00:16:40Z", "commit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoxNjo0MFrOHwGt7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDoxNjo0MFrOHwGt7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzc1Ng==", "bodyText": "I originally saw this grow to around 20-25 before.\nI changed it back, but is it a bad thing to block the grpc thread? Because that will sometimes happen if the size is 16.", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520203756", "createdAt": "2020-11-10T00:16:40Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -77,7 +78,9 @@\n   public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> rpcFunc,\n       int bufferSize, String description) {\n     LOG.debug(\"Opening stream ({})\", description);\n-    mResponses = new ArrayBlockingQueue<>(bufferSize);\n+    // Use an unlimited queue to avoid blocking the network threads. Depend on custom flow\n+    // control to limit the size of buffer.\n+    mResponses = new LinkedBlockingQueue<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NzU2Mw=="}, "originalCommit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTEwNTMz", "url": "https://github.com/Alluxio/alluxio/pull/12466#pullrequestreview-527510533", "createdAt": "2020-11-10T18:51:04Z", "commit": {"oid": "47d0833fff093d88284d215771877974f8098148"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo1MTowNFrOHwqxSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo1MTowNFrOHwqxSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5NDQ0MA==", "bodyText": "If another client tries to read this block, there shouldn't be an issue, since they would only be grabbing a read lock, which should be allowed. I don't think another client can write lock the block, since Alluxio blocks are write-once-read-many. Can you think of any other problem behavior?\nIdeally, I would have just removed this waitForComplete entirely, but there are some tests which require some async caching tasks to complete (even though async caching in general is best-effort). Because of these tests, waiting some short amount of time is beneficial for the tests.", "url": "https://github.com/Alluxio/alluxio/pull/12466#discussion_r520794440", "createdAt": "2020-11-10T18:51:04Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcDataReader.java", "diffHunk": "@@ -168,7 +169,19 @@ public void close() throws IOException {\n         return;\n       }\n       mStream.close();\n-      mStream.waitForComplete(mDataTimeoutMs);\n+\n+      // When a reader is closed, there is technically nothing the client requires from the server.\n+      // However, the server does need to cleanup resources for a client close(), including closing\n+      // or canceling any temp blocks. Therefore, we should wait for some amount of time for the\n+      // server to finish cleanup, but it should not be very long (since the client is finished\n+      // with the read). Also, if there is any error when waiting for the complete, it should be\n+      // ignored since again, the client is completely finished with the read.\n+      try {\n+        // Wait a short time for the server to finish the close, and then let the client continue.\n+        mStream.waitForComplete(5 * Constants.SECOND_MS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4OTc0OQ=="}, "originalCommit": {"oid": "92473d5211490f35dc21b3067baedc389535d9f5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdce7fc62ea0db739424d07517f602eb034b389d", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/cdce7fc62ea0db739424d07517f602eb034b389d", "committedDate": "2020-11-11T00:15:39Z", "message": "Add client parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NzY2NDAx", "url": "https://github.com/Alluxio/alluxio/pull/12466#pullrequestreview-527766401", "createdAt": "2020-11-11T00:54:09Z", "commit": {"oid": "cdce7fc62ea0db739424d07517f602eb034b389d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3402, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}