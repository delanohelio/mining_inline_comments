{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5NzgwMjE3", "number": 10821, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjoxOToxM1rODdJdhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTo1OTozMVrODd5AOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODkwMzExOnYy", "diffSide": "RIGHT", "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjoxOToxM1rOFlldnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoxOTowNFrOFlm7qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw==", "bodyText": "Is the intention to only filter out this tmp folder, or any blocks within it? Because as it, won't this only filter out just that single folder?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374955423", "createdAt": "2020-02-04T22:19:13Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NjQ0Mw==", "bodyText": "There should really only be one object in that directory that isn't a file which is the .tmp_blocks directory. Listing the objects underneath is not needed since this directory will get deleted anyways. The main point is to avoid logging the ERROR since it has/will alarm certain users.", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374956443", "createdAt": "2020-02-04T22:21:30Z", "author": {"login": "ns1123"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NzQzMA==", "bodyText": "My last comment is how the value of the WORKER_DATA_TMP_FOLDER might match path.getName() - can the user specify a relative path? will it still match path.getName() if the config specifies a relative or absolute?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374967430", "createdAt": "2020-02-04T22:47:21Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3NDcyMQ==", "bodyText": "WORKER_DATA_TMP_FOLDER must be a relative path. We don't allow an absolute path for this property. Path.getName() will also only get the last index of the path so this match should be correct.", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374974721", "createdAt": "2020-02-04T23:06:12Z", "author": {"login": "ns1123"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3NjI4Mw==", "bodyText": "couldn't someone specify path1/path2 - configuration would return that, but then the path.getName() would only have path2?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374976283", "createdAt": "2020-02-04T23:10:26Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3OTEwMw==", "bodyText": "I think path.getName() would only have path1, but I see your concern. Is this something we reasonably see happening?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374979103", "createdAt": "2020-02-04T23:17:57Z", "author": {"login": "ns1123"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3OTQ5Nw==", "bodyText": "If the goal is to remove the message we need to account for the property being configured to something other than the default. Otherwise is there a point in looking up the configuration?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r374979497", "createdAt": "2020-02-04T23:19:04Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -125,7 +125,9 @@ private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n     }\n     for (File path : paths) {\n       if (!path.isFile()) {\n-        LOG.error(\"{} in StorageDir is not a file\", path.getAbsolutePath());\n+        if (!path.getName().equals(ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk1NTQyMw=="}, "originalCommit": {"oid": "6506a197a3bfb1c03124a84374d3ba0cebf0827c"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjY2MDEwOnYy", "diffSide": "RIGHT", "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTozODowN1rOFmv56g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTo1NjozOFrOFmwK0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NTA4Mg==", "bodyText": "can we use a method from PathUtils instead?", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r376175082", "createdAt": "2020-02-07T01:38:07Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -109,11 +111,11 @@ public static StorageDir newStorageDir(StorageTier tier, int dirIndex, long capa\n    * @throws WorkerOutOfSpaceException when metadata can not be added due to limited left space\n    */\n   private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n-      WorkerOutOfSpaceException {\n+      WorkerOutOfSpaceException, InvalidPathException {\n     // Create the storage directory path\n     boolean isDirectoryNewlyCreated = FileUtils.createStorageDirPath(mDirPath,\n         ServerConfiguration.get(PropertyKey.WORKER_DATA_FOLDER_PERMISSIONS));\n-\n+    String tmpDir = ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER).split(\"/\")[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b0d3504977e77173bc01797d1c6b7710d9582a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3OTQxMA==", "bodyText": "Done as per your suggestion.", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r376179410", "createdAt": "2020-02-07T01:56:38Z", "author": {"login": "ns1123"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageDir.java", "diffHunk": "@@ -109,11 +111,11 @@ public static StorageDir newStorageDir(StorageTier tier, int dirIndex, long capa\n    * @throws WorkerOutOfSpaceException when metadata can not be added due to limited left space\n    */\n   private void initializeMeta() throws BlockAlreadyExistsException, IOException,\n-      WorkerOutOfSpaceException {\n+      WorkerOutOfSpaceException, InvalidPathException {\n     // Create the storage directory path\n     boolean isDirectoryNewlyCreated = FileUtils.createStorageDirPath(mDirPath,\n         ServerConfiguration.get(PropertyKey.WORKER_DATA_FOLDER_PERMISSIONS));\n-\n+    String tmpDir = ServerConfiguration.get(PropertyKey.WORKER_DATA_TMP_FOLDER).split(\"/\")[0];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NTA4Mg=="}, "originalCommit": {"oid": "b8b0d3504977e77173bc01797d1c6b7710d9582a"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjY5MjQwOnYy", "diffSide": "RIGHT", "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageTier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTo1OTozMVrOFmwNUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTo1OTozMVrOFmwNUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE4MDA1MQ==", "bodyText": "is this still necessary? it is", "url": "https://github.com/Alluxio/alluxio/pull/10821#discussion_r376180051", "createdAt": "2020-02-07T01:59:31Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/meta/StorageTier.java", "diffHunk": "@@ -100,7 +100,7 @@ private void initStorageTier()\n             dirMedium[mediumTypeindex]);\n         totalCapacity += capacity;\n         mDirs.put(i, dir);\n-      } catch (IOException e) {\n+      } catch (IOException | InvalidPathException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba082d1acbd78eb858a49857614dda513a78c84"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2118, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}