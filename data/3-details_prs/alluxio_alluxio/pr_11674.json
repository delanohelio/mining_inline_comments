{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODI2Njk1", "number": 11674, "title": "Refactor FSM RPC cancellation support", "bodyText": "This PR enables FSM internal call-trackers by default for all RPCs.\nIt also improves the overall RPC cancellation coverage by including sync sessions.\nFixes #11672", "createdAt": "2020-06-26T23:40:24Z", "url": "https://github.com/Alluxio/alluxio/pull/11674", "merged": true, "mergeCommit": {"oid": "0236618189bfbc5811a3c26f4eb3c2b21205415f"}, "closed": true, "closedAt": "2020-07-07T06:17:44Z", "author": {"login": "ggezer"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvL98KAH2gAyNDQwODI2Njk1OjI5MDM3ZThmMWM4NTBkMGE4YzhkMmZhMzcwYjFkZTI2ODVjNzFhMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyazrAAFqTQ0MzQ4NzgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "29037e8f1c850d0a8c8d2fa370b1de2685c71a18", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/29037e8f1c850d0a8c8d2fa370b1de2685c71a18", "committedDate": "2020-06-26T23:37:08Z", "message": "Refactor FSM RPC cancellation support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "247fc2f2e6dda6029a80d4dd9bb82bf4eeecc582", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/247fc2f2e6dda6029a80d4dd9bb82bf4eeecc582", "committedDate": "2020-06-26T23:37:32Z", "message": "Track original calls during sync session"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a170431ad4e66fba553c6ca682056f7811c997", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/44a170431ad4e66fba553c6ca682056f7811c997", "committedDate": "2020-06-26T23:43:11Z", "message": "Add transport tracker for createFile/createDirectory RPCs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8ef106eb6e3ca6731e904041598695535659a5", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/3b8ef106eb6e3ca6731e904041598695535659a5", "committedDate": "2020-06-27T03:49:45Z", "message": "fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/20cc3348ec88f2237cf9606d9e3792f031e1b4b0", "committedDate": "2020-06-27T05:10:29Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQ3NjY5", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-438647669", "createdAt": "2020-06-26T23:46:26Z", "commit": {"oid": "44a170431ad4e66fba553c6ca682056f7811c997"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzo0NjoyNlrOGpxYLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwNzowMzo1NlrOGpz4nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MzgwNQ==", "bodyText": "I don't think this needs to be here.\nThe check in the main sync() method should be enough", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446453805", "createdAt": "2020-06-26T23:46:26Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -632,6 +638,7 @@ private void loadMetadataForPath(LockedInodePath inodePath)\n   private void loadMetadata(LockedInodePath inodePath, LoadMetadataContext context)\n       throws AccessControlException, BlockInfoException, FileAlreadyCompletedException,\n       FileDoesNotExistException, InvalidFileSizeException, InvalidPathException, IOException {\n+    mRpcContext.throwIfCancelled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44a170431ad4e66fba553c6ca682056f7811c997"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5MzQ1Ng==", "bodyText": "I can't comment on this part. @gpang you probably have more context?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446493456", "createdAt": "2020-06-27T06:46:02Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -440,7 +441,17 @@ public DefaultFileSystemMaster(BlockMaster blockMaster, CoreMasterContext master\n         ? ServerConfiguration.getList(PropertyKey.MASTER_PERSISTENCE_BLACKLIST, \",\")\n         : Collections.emptyList();\n \n-    mStateLockCallTracker = () -> masterContext.getStateLockManager().interruptCycleTicking();\n+    mStateLockCallTracker = new CallTracker() {\n+      @Override\n+      public boolean isCancelled() {\n+        return masterContext.getStateLockManager().interruptCycleTicking();\n+      }\n+\n+      @Override\n+      public Type getType() {\n+        return Type.STATE_LOCK_TRACKER;\n+      }\n+    };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5Mzk4MA==", "bodyText": "this line break isn't necessary?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446493980", "createdAt": "2020-06-27T06:52:44Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -204,7 +204,8 @@\n    * @param loadOnly whether to only load new metadata, rather than update existing metadata\n    */\n   public InodeSyncStream(LockingScheme rootPath, DefaultFileSystemMaster fsMaster,\n-      RpcContext rpcContext, DescendantType descendantType, FileSystemMasterCommonPOptions options,\n+      RpcContext rpcContext, DescendantType descendantType,\n+      FileSystemMasterCommonPOptions options,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5Mzk5OA==", "bodyText": "I don't think anything changed here?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446493998", "createdAt": "2020-06-27T06:52:54Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -246,8 +247,8 @@ public InodeSyncStream(LockingScheme rootPath, DefaultFileSystemMaster fsMaster,\n   public InodeSyncStream(LockingScheme rootScheme, DefaultFileSystemMaster fsMaster,\n       RpcContext rpcContext, DescendantType descendantType, FileSystemMasterCommonPOptions options,\n       boolean isGetFileInfo, boolean forceSync, boolean loadOnly) {\n-    this(rootScheme, fsMaster, rpcContext, descendantType, options, null, null, null,\n-        isGetFileInfo, forceSync, loadOnly);\n+    this(rootScheme, fsMaster, rpcContext, descendantType, options, null, null, null, isGetFileInfo,\n+        forceSync, loadOnly);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NDYyMg==", "bodyText": "if withTracker returns the generic type of the OperationContext (C in your implementation), then is it necessary to include the cast to CreateDirectoryContext? It just doesn't seem clean.\nedit - I looked into it and figured out the issue. Poor use of generics. Change the class definition of CreatePathContext to remove the need to cast\nold:\npublic abstract class CreatePathContext<T extends GeneratedMessageV3.Builder<?>, K>\n    extends OperationContext<T, CreatePathContext> {\nnew:\npublic abstract class CreatePathContext<T extends GeneratedMessageV3.Builder<?>,\n    K extends OperationContext> extends OperationContext<T, K> {", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446494622", "createdAt": "2020-06-27T07:00:13Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/FileSystemMasterClientServiceHandler.java", "diffHunk": "@@ -148,8 +148,8 @@ public void createDirectory(CreateDirectoryPRequest request,\n     CreateDirectoryPOptions options = request.getOptions();\n     RpcUtils.call(LOG, () -> {\n       AlluxioURI pathUri = getAlluxioURI(request.getPath());\n-      mFileSystemMaster.createDirectory(pathUri,\n-          CreateDirectoryContext.create(options.toBuilder()));\n+      mFileSystemMaster.createDirectory(pathUri, (CreateDirectoryContext) CreateDirectoryContext\n+          .create(options.toBuilder()).withTracker(new GrpcCallTracker(responseObserver)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NDY5Ng==", "bodyText": "See other comment.\nChange to the CreatePathContext class def removed the need for the extra cast", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446494696", "createdAt": "2020-06-27T07:01:15Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/FileSystemMasterClientServiceHandler.java", "diffHunk": "@@ -159,8 +159,10 @@ public void createFile(CreateFilePRequest request,\n       StreamObserver<CreateFilePResponse> responseObserver) {\n     RpcUtils.call(LOG, () -> {\n       AlluxioURI pathUri = getAlluxioURI(request.getPath());\n-      return CreateFilePResponse.newBuilder().setFileInfo(GrpcUtils.toProto(mFileSystemMaster\n-          .createFile(pathUri, CreateFileContext.create(request.getOptions().toBuilder()))))\n+      return CreateFilePResponse.newBuilder()\n+          .setFileInfo(GrpcUtils.toProto(mFileSystemMaster.createFile(pathUri,\n+              (CreateFileContext) CreateFileContext.create(request.getOptions().toBuilder())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NDgxMw==", "bodyText": "The list of call trackers should always be small, correct? 1 most of the time?\nAre there any cases when we could have more than that?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446494813", "createdAt": "2020-06-27T07:03:04Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/file/contexts/OperationContext.java", "diffHunk": "@@ -11,54 +11,89 @@\n \n package alluxio.master.file.contexts;\n \n+import com.google.protobuf.GeneratedMessageV3;\n+\n import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n \n /**\n  * Used as a base class for wrapping context around proto messages.\n  *\n  * @param <T> Proto message type\n+ * @param <C> extended type\n  */\n @NotThreadSafe\n-public class OperationContext<T extends com.google.protobuf.GeneratedMessageV3.Builder<?>> {\n+public class OperationContext<T extends GeneratedMessageV3.Builder, C extends OperationContext> {\n   // Proto message that is being wrapped\n   private T mOptionsBuilder;\n   // Used to track client call status.\n-  private CallTracker mCallTracker;\n+  private List<CallTracker> mCallTrackers;\n \n   /**\n    * Creates an instance with given proto message.\n    *\n    * @param optionsBuilder Internal proto message builder instance\n    */\n   public OperationContext(T optionsBuilder) {\n-    this(optionsBuilder, null);\n     mOptionsBuilder = optionsBuilder;\n-    mCallTracker = CallTracker.NOOP_TRACKER;\n+    mCallTrackers = new LinkedList<>();\n   }\n \n   /**\n-   * Creates an instance with given proto message.\n+   * @return underlying proto message instance\n+   */\n+  public T getOptions() {\n+    return mOptionsBuilder;\n+  }\n+\n+  /**\n+   * Used to transfer trackers of a context to this instance.\n+   * This is required when creating internal contexts.\n    *\n-   * @param optionsBuilder Internal proto message builder instance\n-   * @param callTracker client call tracker, or {@code null} if no tracking is desired\n+   * @param context the source context\n+   * @return the updated instance\n    */\n-  public OperationContext(T optionsBuilder, CallTracker callTracker) {\n-    mOptionsBuilder = optionsBuilder;\n-    mCallTracker = callTracker;\n+  public C withTracker(OperationContext context) {\n+    mCallTrackers = context.mCallTrackers;\n+    return (C) this;\n   }\n \n   /**\n-   * @return underlying proto message instance\n+   * Updates this context with a new tracker.\n+   *\n+   * @param tracker the new call tracker\n+   * @return the updated instance\n    */\n-  public T getOptions() {\n-    return mOptionsBuilder;\n+  public C withTracker(CallTracker tracker) {\n+    mCallTrackers.add(tracker);\n+    return (C) this;\n   }\n \n   /**\n-   * TODO(ggezer): Make the call-tracker infra note the source of cancellation.\n-   * @return {@code true} if the call is cancelled by the client\n+   * @return the list of trackers that have cancelled this operation\n    */\n-  public boolean isCancelled() {\n-    return mCallTracker.isCancelled();\n+  public List<CallTracker> getCancelledTrackers() {\n+    boolean trackerCancelled = false;\n+    for (CallTracker tracker : mCallTrackers) {\n+      if (tracker.isCancelled()) {\n+        trackerCancelled = true;\n+        break;\n+      }\n+    }\n+\n+    if (!trackerCancelled) {\n+      return Collections.emptyList();\n+    }\n+\n+    List<CallTracker> cancelledTrackers = new LinkedList<>();\n+    for (CallTracker tracker : mCallTrackers) {\n+      if (tracker.isCancelled()) {\n+        cancelledTrackers.add(tracker);\n+      }\n+    }\n+\n+    return cancelledTrackers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5NDg3OQ==", "bodyText": "Would like to see some test coverage on throwing for cancelled trackers.", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r446494879", "createdAt": "2020-06-27T07:03:56Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/test/java/alluxio/master/file/RpcContextTest.java", "diffHunk": "@@ -34,11 +35,12 @@\n public final class RpcContextTest {\n   private BlockDeletionContext mMockBDC = mock(BlockDeletionContext.class);\n   private JournalContext mMockJC = mock(JournalContext.class);\n+  private OperationContext mMockOC = mock(OperationContext.class);\n   private RpcContext mRpcContext;\n \n   @Before\n   public void before() {\n-    mRpcContext = new RpcContext(mMockBDC, mMockJC);\n+    mRpcContext = new RpcContext(mMockBDC, mMockJC, mMockOC);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20cc3348ec88f2237cf9606d9e3792f031e1b4b0"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edccea3cb3e1672e15e5531516eeaa048e411e1c", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/edccea3cb3e1672e15e5531516eeaa048e411e1c", "committedDate": "2020-06-27T20:33:10Z", "message": "Avoid type cast"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9eb65e2384635679b0b9edfbbef5bc3cd772a2", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/8f9eb65e2384635679b0b9edfbbef5bc3cd772a2", "committedDate": "2020-06-28T03:52:26Z", "message": "minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afdeca93912228d01c818ada4a01e77711c10dce", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/afdeca93912228d01c818ada4a01e77711c10dce", "committedDate": "2020-06-28T04:45:48Z", "message": "fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/85725ebcdc9edbf4df2aa0edfef8991f31bb7e05", "committedDate": "2020-06-28T05:32:19Z", "message": "Fix unconfirmed-cast bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTAyOTgx", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-439502981", "createdAt": "2020-06-29T21:10:22Z", "commit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMToxMDoyMlrOGqiV4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMToyNTozNVrOGqiymw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1NjAzNA==", "bodyText": "I think it is strange to have an API called withTracker but the input parameter is not a tracker but a context? Why can't we just use the other implementation only?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r447256034", "createdAt": "2020-06-29T21:10:22Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/contexts/OperationContext.java", "diffHunk": "@@ -11,54 +11,89 @@\n \n package alluxio.master.file.contexts;\n \n+import com.google.protobuf.GeneratedMessageV3;\n+\n import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n \n /**\n  * Used as a base class for wrapping context around proto messages.\n  *\n  * @param <T> Proto message type\n+ * @param <C> extended type\n  */\n @NotThreadSafe\n-public class OperationContext<T extends com.google.protobuf.GeneratedMessageV3.Builder<?>> {\n+public class OperationContext<T extends GeneratedMessageV3.Builder, C extends OperationContext> {\n   // Proto message that is being wrapped\n   private T mOptionsBuilder;\n   // Used to track client call status.\n-  private CallTracker mCallTracker;\n+  private List<CallTracker> mCallTrackers;\n \n   /**\n    * Creates an instance with given proto message.\n    *\n    * @param optionsBuilder Internal proto message builder instance\n    */\n   public OperationContext(T optionsBuilder) {\n-    this(optionsBuilder, null);\n     mOptionsBuilder = optionsBuilder;\n-    mCallTracker = CallTracker.NOOP_TRACKER;\n+    mCallTrackers = new LinkedList<>();\n   }\n \n   /**\n-   * Creates an instance with given proto message.\n+   * @return underlying proto message instance\n+   */\n+  public T getOptions() {\n+    return mOptionsBuilder;\n+  }\n+\n+  /**\n+   * Used to transfer trackers of a context to this instance.\n+   * This is required when creating internal contexts.\n    *\n-   * @param optionsBuilder Internal proto message builder instance\n-   * @param callTracker client call tracker, or {@code null} if no tracking is desired\n+   * @param context the source context\n+   * @return the updated instance\n    */\n-  public OperationContext(T optionsBuilder, CallTracker callTracker) {\n-    mOptionsBuilder = optionsBuilder;\n-    mCallTracker = callTracker;\n+  public C withTracker(OperationContext context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2MzM4Nw==", "bodyText": "Is the only reason for this, to have a withTracker() call? It seems inconvenient to add the same class as a template class parameter. Instead, can't we just have a setTracker(), that updates the instance, and we just pass in the instance to the rpc call?", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r447263387", "createdAt": "2020-06-29T21:25:35Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/contexts/OperationContext.java", "diffHunk": "@@ -11,54 +11,89 @@\n \n package alluxio.master.file.contexts;\n \n+import com.google.protobuf.GeneratedMessageV3;\n+\n import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n \n /**\n  * Used as a base class for wrapping context around proto messages.\n  *\n  * @param <T> Proto message type\n+ * @param <C> extended type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzYwNzIw", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-440360720", "createdAt": "2020-06-30T20:27:44Z", "commit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMDoyNzo0NFrOGrNPlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMDoyNzo0NFrOGrNPlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk1ODkzNQ==", "bodyText": "I still have this question.", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r447958935", "createdAt": "2020-06-30T20:27:44Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/file/contexts/OperationContext.java", "diffHunk": "@@ -11,54 +11,89 @@\n \n package alluxio.master.file.contexts;\n \n+import com.google.protobuf.GeneratedMessageV3;\n+\n import javax.annotation.concurrent.NotThreadSafe;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n \n /**\n  * Used as a base class for wrapping context around proto messages.\n  *\n  * @param <T> Proto message type\n+ * @param <C> extended type\n  */\n @NotThreadSafe\n-public class OperationContext<T extends com.google.protobuf.GeneratedMessageV3.Builder<?>> {\n+public class OperationContext<T extends GeneratedMessageV3.Builder, C extends OperationContext> {\n   // Proto message that is being wrapped\n   private T mOptionsBuilder;\n   // Used to track client call status.\n-  private CallTracker mCallTracker;\n+  private List<CallTracker> mCallTrackers;\n \n   /**\n    * Creates an instance with given proto message.\n    *\n    * @param optionsBuilder Internal proto message builder instance\n    */\n   public OperationContext(T optionsBuilder) {\n-    this(optionsBuilder, null);\n     mOptionsBuilder = optionsBuilder;\n-    mCallTracker = CallTracker.NOOP_TRACKER;\n+    mCallTrackers = new LinkedList<>();\n   }\n \n   /**\n-   * Creates an instance with given proto message.\n+   * @return underlying proto message instance\n+   */\n+  public T getOptions() {\n+    return mOptionsBuilder;\n+  }\n+\n+  /**\n+   * Used to transfer trackers of a context to this instance.\n+   * This is required when creating internal contexts.\n    *\n-   * @param optionsBuilder Internal proto message builder instance\n-   * @param callTracker client call tracker, or {@code null} if no tracking is desired\n+   * @param context the source context\n+   * @return the updated instance\n    */\n-  public OperationContext(T optionsBuilder, CallTracker callTracker) {\n-    mOptionsBuilder = optionsBuilder;\n-    mCallTracker = callTracker;\n+  public C withTracker(OperationContext context) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1NjAzNA=="}, "originalCommit": {"oid": "85725ebcdc9edbf4df2aa0edfef8991f31bb7e05"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08bab3efaec06703a8b1b6f20d0110dd5617f3a5", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/08bab3efaec06703a8b1b6f20d0110dd5617f3a5", "committedDate": "2020-06-30T20:34:17Z", "message": "remove dead method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDQyNTk5", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-440442599", "createdAt": "2020-06-30T23:01:45Z", "commit": {"oid": "08bab3efaec06703a8b1b6f20d0110dd5617f3a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e705645a3467925735fc89140240fb54feaa932", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/9e705645a3467925735fc89140240fb54feaa932", "committedDate": "2020-07-06T22:00:29Z", "message": "Don't throw during laodMetadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "189e4b8641253bafb1c0fc10cfaead84983fb39a", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/189e4b8641253bafb1c0fc10cfaead84983fb39a", "committedDate": "2020-07-06T22:11:39Z", "message": "Add UT for RpcContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDQ0MDM1", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-443444035", "createdAt": "2020-07-06T22:22:28Z", "commit": {"oid": "189e4b8641253bafb1c0fc10cfaead84983fb39a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjoyMjoyOFrOGto8zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjoyMjoyOFrOGto8zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxMDAyOQ==", "bodyText": "This is a good case for the ExpectedException rule since there aren't any assertions afterwards ;)", "url": "https://github.com/Alluxio/alluxio/pull/11674#discussion_r450510029", "createdAt": "2020-07-06T22:22:28Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/test/java/alluxio/master/file/RpcContextTest.java", "diffHunk": "@@ -105,6 +108,46 @@ public void journalContextThrows() throws Throwable {\n     checkClose(jcException);\n   }\n \n+  @Test\n+  public void testCallTrackers() throws Throwable {\n+    InternalOperationContext opCtx = new InternalOperationContext();\n+    // Add a call tracker that's always cancelled.\n+    opCtx = opCtx.withTracker(new CallTracker() {\n+      @Override\n+      public boolean isCancelled() {\n+        return true;\n+      }\n+\n+      @Override\n+      public Type getType() {\n+        return Type.GRPC_CLIENT_TRACKER;\n+      }\n+    });\n+    // Add a call tracker that's never cancelled.\n+    opCtx = opCtx.withTracker(new CallTracker() {\n+      @Override\n+      public boolean isCancelled() {\n+        return false;\n+      }\n+\n+      @Override\n+      public Type getType() {\n+        return Type.STATE_LOCK_TRACKER;\n+      }\n+    });\n+    // Create RPC context.\n+    RpcContext rpcCtx = new RpcContext(mMockBDC, mMockJC, opCtx);\n+    // Verify the RPC is cancelled due to tracker that's always cancelled.\n+    assertTrue(rpcCtx.isCancelled());\n+    try {\n+      // Verify cancellation throws.\n+      rpcCtx.throwIfCancelled();\n+      fail(\"Call should have been cancelled.\");\n+    } catch (RuntimeException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "189e4b8641253bafb1c0fc10cfaead84983fb39a"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81e68a6c08d5a1be22633874979e300813214239", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/81e68a6c08d5a1be22633874979e300813214239", "committedDate": "2020-07-06T23:48:13Z", "message": "Use expected-exc rule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDg3ODMw", "url": "https://github.com/Alluxio/alluxio/pull/11674#pullrequestreview-443487830", "createdAt": "2020-07-07T00:36:16Z", "commit": {"oid": "81e68a6c08d5a1be22633874979e300813214239"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4396, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}