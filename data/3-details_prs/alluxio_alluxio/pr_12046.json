{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NTY3NjQ0", "number": 12046, "title": "Remove synchronized in ConfigHashSync", "bodyText": "If the ConfigHashSync's Heartbeat thread is running, the client can't be closed. Unfortunately, the cancel on heartbeat thread that gets called can be unreliable at times and as a result, there is a possibility of a deadlock.\nOne Thread:\n(waiting on ConfigHashSync synchronized)\nat alluxio.client.file.ConfigHashSync.close(ConfigHashSync.java:112)\nat alluxio.client.file.FileSystemContextReinitializer.close(FileSystemContextReinitializer.java:189)\n(has FileSystemContext synchronized lock)\nat alluxio.client.file.FileSystemContext.close(FileSystemContext.java:262)\nHeartBeatThread:\n(waiting on FileSystemContext's synchronized lock)\nat alluxio.client.file.FileSystemContext.getMasterAddress(FileSystemContext.java:417)\nat alluxio.client.file.FileSystemContext.reinit(FileSystemContext.java:348)\n(has ConfigHashSync synchronized lock)\nat alluxio.client.file.ConfigHashSync.heartbeat(ConfigHashSync.java:95)\nResolve this by removing synchronized on ConfigHashSync since all of its instance variables are threadsafe.", "createdAt": "2020-08-28T18:11:36Z", "url": "https://github.com/Alluxio/alluxio/pull/12046", "merged": true, "mergeCommit": {"oid": "c3985b152461ca8b139a41d6c8c5806128e480bf"}, "closed": true, "closedAt": "2020-08-31T20:05:14Z", "author": {"login": "bradyoo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDY-C7AH2gAyNDc1NTY3NjQ0OjU4MzRiZmQzMGI5YjJmYTlhOWQyZjhkMmNmMzZiMmUxNWY2MTI3ZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEUI9OgFqTQ3ODY5MjkzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7", "committedDate": "2020-08-28T18:04:30Z", "message": "Remove synchronized in ConfigHashSync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDIyODky", "url": "https://github.com/Alluxio/alluxio/pull/12046#pullrequestreview-478022892", "createdAt": "2020-08-28T21:00:13Z", "commit": {"oid": "5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMTowMDoxM1rOHJUUkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMTowMDoxM1rOHJUUkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzMjE3OQ==", "bodyText": "I'm not entirely sure we are allowed to remove this synchronized. However, I know we can remove the one with close(), since it just calls another method which is already synchronized. If we just remove the synchronized on the ConfigHashSync#close(), that should remove the deadlock cycle, right?\nI'm just concerned that synchronized might be required for heartbeat().", "url": "https://github.com/Alluxio/alluxio/pull/12046#discussion_r479532179", "createdAt": "2020-08-28T21:00:13Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/ConfigHashSync.java", "diffHunk": "@@ -72,7 +72,7 @@ public void resetMetaMasterConfigClient(MasterClientContext context) {\n   }\n \n   @Override\n-  public synchronized void heartbeat() {\n+  public void heartbeat() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDIzNjIz", "url": "https://github.com/Alluxio/alluxio/pull/12046#pullrequestreview-478023623", "createdAt": "2020-08-28T21:01:38Z", "commit": {"oid": "5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMTowMTozOFrOHJUWoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMTowMTozOFrOHJUWoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzMjcwNA==", "bodyText": "mClient is used in this method.. so what if another thread closes it before an operation on mClient?", "url": "https://github.com/Alluxio/alluxio/pull/12046#discussion_r479532704", "createdAt": "2020-08-28T21:01:38Z", "author": {"login": "yuzhu"}, "path": "core/client/fs/src/main/java/alluxio/client/file/ConfigHashSync.java", "diffHunk": "@@ -72,7 +72,7 @@ public void resetMetaMasterConfigClient(MasterClientContext context) {\n   }\n \n   @Override\n-  public synchronized void heartbeat() {\n+  public void heartbeat() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5834bfd30b9b2fa9a9d2f8d2cf36b2e15f6127d7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b4ac3c248a8fa9e0c7572460298a73f2336d18", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/a8b4ac3c248a8fa9e0c7572460298a73f2336d18", "committedDate": "2020-08-28T21:30:51Z", "message": "bring back synchronized in heartbeat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjkyOTM2", "url": "https://github.com/Alluxio/alluxio/pull/12046#pullrequestreview-478692936", "createdAt": "2020-08-31T15:00:49Z", "commit": {"oid": "a8b4ac3c248a8fa9e0c7572460298a73f2336d18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3635, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}