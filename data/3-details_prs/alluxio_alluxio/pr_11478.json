{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNDY5NzEz", "number": 11478, "title": "Implement non-intrusive locking for backups", "bodyText": "This is to eliminate the impact of backups when the leader has hung RPCs.\nBackup not backing off from an exclusive lock acquisition was causing a pile of shared acquisition attempts.", "createdAt": "2020-05-26T21:19:49Z", "url": "https://github.com/Alluxio/alluxio/pull/11478", "merged": true, "mergeCommit": {"oid": "0b5b5a4edda2e1aa9b9a50da115ce5ee3ddf8b71"}, "closed": true, "closedAt": "2020-05-28T00:35:21Z", "author": {"login": "ggezer"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclL3JKAFqTQxODcwNDA4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclivIeAFqTQxOTY5OTY3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NzA0MDg2", "url": "https://github.com/Alluxio/alluxio/pull/11478#pullrequestreview-418704086", "createdAt": "2020-05-26T21:49:56Z", "commit": {"oid": "6cfe2a93bb7453e501362d2cb2ebfc9263a1af23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTo0OTo1NlrOGaxhjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTo0OTo1NlrOGaxhjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzU2Nw==", "bodyText": "If this times out, will the backup not be scheduled until the next time, or will there be some sort of retry?", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r430727567", "createdAt": "2020-05-26T21:49:56Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/backup/BackupLeaderRole.java", "diffHunk": "@@ -250,16 +253,15 @@ private void activateWorkerConnection(Connection workerConnection) {\n    */\n   private void scheduleLocalBackup(BackupPRequest request) {\n     mLocalBackupFuture = mExecutorService.submit(() -> {\n-      try (LockResource lr = new LockResource(mStatePauseLock)) {\n-        try {\n-          mBackupTracker.updateState(BackupState.Running);\n-          AlluxioURI backupUri = takeBackup(request, mBackupTracker.getEntryCounter());\n-          mBackupTracker.updateBackupUri(backupUri);\n-          mBackupTracker.updateState(BackupState.Completed);\n-        } catch (IOException e) {\n-          mBackupTracker.updateError(\n-              new BackupException(String.format(\"Local backup failed: %s\", e.getMessage()), e));\n-        }\n+      try (LockResource stateLockResource =\n+          new LockResource(mStatePauseLock, mStateLockTimeout, TimeUnit.MILLISECONDS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cfe2a93bb7453e501362d2cb2ebfc9263a1af23"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5161f0a3216ea47ab2dd42e475132d6a2182215", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/b5161f0a3216ea47ab2dd42e475132d6a2182215", "committedDate": "2020-05-27T03:29:05Z", "message": "Implement non-intrusive locking for backups"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cfe2a93bb7453e501362d2cb2ebfc9263a1af23", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/6cfe2a93bb7453e501362d2cb2ebfc9263a1af23", "committedDate": "2020-05-26T21:19:16Z", "message": "Acquire the state-lock with a timeout"}, "afterCommit": {"oid": "b5161f0a3216ea47ab2dd42e475132d6a2182215", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/b5161f0a3216ea47ab2dd42e475132d6a2182215", "committedDate": "2020-05-27T03:29:05Z", "message": "Implement non-intrusive locking for backups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2696924c2897af3d664e294a430e83a3993f19f", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/c2696924c2897af3d664e294a430e83a3993f19f", "committedDate": "2020-05-27T18:57:14Z", "message": "Fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjAxOTQ2", "url": "https://github.com/Alluxio/alluxio/pull/11478#pullrequestreview-419601946", "createdAt": "2020-05-27T20:56:38Z", "commit": {"oid": "c2696924c2897af3d664e294a430e83a3993f19f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDo1NjozOFrOGbc1Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMToxODoxN1rOGbdgDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzNzE1MA==", "bodyText": "are alluxio.master.backup.state.lock.timeout and alluxio.master.daily.backup.state.lock.timeout equivalent, but for CLI vs daily backup?", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431437150", "createdAt": "2020-05-27T20:56:38Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -4776,12 +4805,20 @@ private static String javadocLink(String fullyQualifiedClassname) {\n         \"alluxio.master.backup.connect.interval.max\";\n     public static final String MASTER_BACKUP_ABANDON_TIMEOUT =\n         \"alluxio.master.backup.abandon.timeout\";\n+    public static final String MASTER_BACKUP_STATE_LOCK_TIMEOUT =\n+        \"alluxio.master.backup.state.lock.timeout\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2696924c2897af3d664e294a430e83a3993f19f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0ODA3OA==", "bodyText": "is this supposed to be deadlineMs - System.currentTimeMillis()?", "url": "https://github.com/Alluxio/alluxio/pull/11478#discussion_r431448078", "createdAt": "2020-05-27T21:18:17Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/resource/LockResource.java", "diffHunk": "@@ -70,6 +72,41 @@ public LockResource(Lock lock, boolean acquireLock, boolean useTryLock) {\n     }\n   }\n \n+  /**\n+   * Creates a new instance of {@link LockResource} using the given lock.\n+   *\n+   * This method will use the {@link Lock#tryLock(long, TimeUnit)} internally in a loop\n+   * for trying to grab the lock without causing total blockage of other waiters of the lock.\n+   *\n+   * @param lock  the lock to acquire\n+   * @param tryMs the duration to attempt acquiring the lock\n+   * @param sleepMs the wait duration after failed attempt to acquire the lock\n+   * @param timeoutMs the total duration to try acquiring the lock in a loop\n+   * @throws InterruptedException if interrupted while acquiring the lock\n+   * @throws TimeoutException if the lock was not acquired after given timeout\n+   */\n+  public LockResource(Lock lock, long tryMs, long sleepMs, long timeoutMs)\n+      throws InterruptedException, TimeoutException {\n+    mLock = lock;\n+    long deadlineMs = System.currentTimeMillis() + timeoutMs;\n+    boolean lockAcquired = false;\n+    while (System.currentTimeMillis() < deadlineMs) {\n+      if (mLock.tryLock(tryMs, TimeUnit.MILLISECONDS)) {\n+        lockAcquired = true;\n+        break;\n+      } else {\n+        long remainingWaitMs = deadlineMs = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2696924c2897af3d664e294a430e83a3993f19f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a50925fd0df04ecddbd0916caee7ee71f0d70218", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/a50925fd0df04ecddbd0916caee7ee71f0d70218", "committedDate": "2020-05-27T21:29:22Z", "message": "Add integration test for shell-backup timeouts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e6758456a90384bc4bd3484632b4faad00b5d9e", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/5e6758456a90384bc4bd3484632b4faad00b5d9e", "committedDate": "2020-05-27T21:33:12Z", "message": "fix typo-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Njk5Njcx", "url": "https://github.com/Alluxio/alluxio/pull/11478#pullrequestreview-419699671", "createdAt": "2020-05-28T00:29:32Z", "commit": {"oid": "5e6758456a90384bc4bd3484632b4faad00b5d9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4437, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}