{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDY0NDI0", "number": 11894, "title": "Add java 11 support for cleaning direct buffers", "bodyText": "", "createdAt": "2020-08-04T00:43:04Z", "url": "https://github.com/Alluxio/alluxio/pull/11894", "merged": true, "mergeCommit": {"oid": "2dd813e9986270a8ded468f663e181450bc3fbc0"}, "closed": true, "closedAt": "2020-08-06T18:07:06Z", "author": {"login": "yuzhu"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7bqOHAH2gAyNDYyNDY0NDI0OjMwMTcwZDgzNmE2NTlkNGViN2VhODMwYWY5OGM1OTI4YmUyYmIwY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8Jer2AFqTQ2MjIwOTg1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30170d836a659d4eb7ea830af98c5928be2bb0cf", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/30170d836a659d4eb7ea830af98c5928be2bb0cf", "committedDate": "2020-08-04T00:41:10Z", "message": "add java 11 support for cleaning direct buffers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e8e1f41271cc092154dad4b511b338a3a1d3566", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/6e8e1f41271cc092154dad4b511b338a3a1d3566", "committedDate": "2020-08-04T00:58:24Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65f6bba1f9a686cb7044715966982045ec4dd1ac", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/65f6bba1f9a686cb7044715966982045ec4dd1ac", "committedDate": "2020-08-04T01:17:48Z", "message": "add synchronized to the cleaner methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86fbe73481287d9e14320d1c52901a06ef6f0111", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/86fbe73481287d9e14320d1c52901a06ef6f0111", "committedDate": "2020-08-04T01:34:13Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDYyOTU1", "url": "https://github.com/Alluxio/alluxio/pull/11894#pullrequestreview-460462955", "createdAt": "2020-08-04T02:57:39Z", "commit": {"oid": "86fbe73481287d9e14320d1c52901a06ef6f0111"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMjo1NzozOVrOG7PR7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMjo1NzozOVrOG7PR7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTUxOQ==", "bodyText": "I would suggest making this a static constant as this is going to be constant for the life of the JVM.\nAlso, I've seen in the JVM that this can report 1.8 for java 8, and 11 for java 11. I'm not sure if that would make a difference", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r464769519", "createdAt": "2020-08-04T02:57:39Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +53,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {\n+    Preconditions.checkNotNull(buffer, \"buffer is null\");\n+    Preconditions.checkArgument(buffer.isDirect(), \"buffer isn't a DirectByteBuffer\");\n+    int javaVersion = Integer.parseInt(System.getProperty(\"java.version\").split(\"\\\\D+\")[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86fbe73481287d9e14320d1c52901a06ef6f0111"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "468cf7995437188e097cdb19e864901fad8ca998", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/468cf7995437188e097cdb19e864901fad8ca998", "committedDate": "2020-08-04T03:39:42Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/1b4e225d9e2afa0fe5e957202ef69ed1c564eb25", "committedDate": "2020-08-04T03:54:03Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDE1NTUz", "url": "https://github.com/Alluxio/alluxio/pull/11894#pullrequestreview-461015553", "createdAt": "2020-08-04T17:19:13Z", "commit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzoxOToxM1rOG7qAkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNzoyMzo0MlrOG7qKqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzQ0Mg==", "bodyText": "Please add a comment on what this will return. I'm assuming 8 for java 1.8, 11 for java 11 ?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207442", "createdAt": "2020-08-04T17:19:13Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzY0NA==", "bodyText": "Will there always be a dot?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207644", "createdAt": "2020-08-04T17:19:34Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {\n+    String version = System.getProperty(\"java.version\");\n+    if (version.startsWith(\"1.\")) {\n+      version = version.substring(2, 3);\n+    } else {\n+      int dot = version.indexOf(\".\");\n+      if (dot != -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNzcyMQ==", "bodyText": "Will this always work?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465207721", "createdAt": "2020-08-04T17:19:42Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,18 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  private static int initMajorVersion() {\n+    String version = System.getProperty(\"java.version\");\n+    if (version.startsWith(\"1.\")) {\n+      version = version.substring(2, 3);\n+    } else {\n+      int dot = version.indexOf(\".\");\n+      if (dot != -1) {\n+        version = version.substring(0, dot);\n+      }\n+    }\n+    return Integer.parseInt(version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwOTc1Nw==", "bodyText": "What was the reason for making everything synchronized? Is it for initializing the method variable, or is it also for the actual cleaning part?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465209757", "createdAt": "2020-08-04T17:23:15Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +55,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIxMDAyNA==", "bodyText": "Is this comment true? Will it be 1.8 or will it be 8?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465210024", "createdAt": "2020-08-04T17:23:42Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -118,6 +120,13 @@ public static long getCurrentMs() {\n     return System.currentTimeMillis();\n   }\n \n+  /**\n+   * @return the current jvm major version, such as 1.8 or 11", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b4e225d9e2afa0fe5e957202ef69ed1c564eb25"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30", "committedDate": "2020-08-04T17:35:56Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTkyMDk1", "url": "https://github.com/Alluxio/alluxio/pull/11894#pullrequestreview-461992095", "createdAt": "2020-08-05T20:17:04Z", "commit": {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMDoxNzowNFrOG8ZFgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMDoxNzowNFrOG8ZFgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3ODc1Mw==", "bodyText": "can you add one or more unit test(s) for this method", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465978753", "createdAt": "2020-08-05T20:17:04Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/util/CommonUtils.java", "diffHunk": "@@ -852,5 +861,22 @@ public static boolean isAddressReachable(String hostname, int port) {\n     return result;\n   }\n \n+  /**\n+   * @return the major version of the current JVM, 8 for 1.8, 11 for java 11\n+   * see https://www.oracle.com/java/technologies/javase/versioning-naming.html for reference\n+   */\n+  private static int initMajorVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTkyNjk0", "url": "https://github.com/Alluxio/alluxio/pull/11894#pullrequestreview-461992694", "createdAt": "2020-08-05T20:18:00Z", "commit": {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMDoxODowMFrOG8ZHUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMDoxODowMFrOG8ZHUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3OTIxOA==", "bodyText": "do we have a test for this?", "url": "https://github.com/Alluxio/alluxio/pull/11894#discussion_r465979218", "createdAt": "2020-08-05T20:18:00Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/util/io/BufferUtils.java", "diffHunk": "@@ -51,6 +55,53 @@ public static int byteToInt(byte b) {\n    * this direct buffer should be discarded. This is unsafe operation and currently a work-around to\n    * avoid huge memory occupation caused by memory map.\n    *\n+   * @param buffer bytebuffer\n+   */\n+  public static synchronized void cleanDirectBuffer(ByteBuffer buffer) {\n+    Preconditions.checkNotNull(buffer, \"buffer is null\");\n+    Preconditions.checkArgument(buffer.isDirect(), \"buffer isn't a DirectByteBuffer\");\n+    int javaVersion = CommonUtils.getJavaVersion();\n+    if (javaVersion < 9) {\n+      cleanDirectBufferJava8(buffer);\n+    } else {\n+      cleanDirectBufferJava11(buffer);\n+    }\n+  }\n+\n+  /**\n+   * <p>\n+   * Note: This calls the cleaner method on jdk 9+.\n+   * See <a\n+   * href=\"https://stackoverflow.com/questions/2972986/how-to-unmap-a-file-from-memory-mapped-\n+   * using-filechannel-in-java\"\n+   * >more discussion</a>.\n+   *\n+   * @param buffer the byte buffer to be unmapped, this must be a direct buffer\n+   */\n+  private static synchronized void cleanDirectBufferJava11(ByteBuffer buffer) {\n+    try {\n+      if (sByteBufferCleanerMethod == null || sUnsafeClass == null) {\n+        try {\n+          sUnsafeClass = Class.forName(\"sun.misc.Unsafe\");\n+        } catch (Exception e) {\n+          // jdk.internal.misc.Unsafe doesn't yet have an invokeCleaner() method,\n+          // but that method should be added if sun.misc.Unsafe is removed.\n+          sUnsafeClass = Class.forName(\"jdk.internal.misc.Unsafe\");\n+        }\n+        sByteBufferCleanerMethod = sUnsafeClass.getMethod(\"invokeCleaner\", ByteBuffer.class);\n+        sByteBufferCleanerMethod.setAccessible(true);\n+      }\n+      Field theUnsafeField = sUnsafeClass.getDeclaredField(\"theUnsafe\");\n+      theUnsafeField.setAccessible(true);\n+      Object theUnsafe = theUnsafeField.get(null);\n+      sByteBufferCleanerMethod.invoke(theUnsafe, buffer);\n+    } catch (Exception e) {\n+      LOG.warn(\"Failed to unmap direct ByteBuffer: {}, error message: {}\",\n+          buffer.getClass().getName(), e.getMessage());\n+    }\n+  }\n+\n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7173339e3ebe8f3165c1d6e2e7741d6c1bd29b30"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f3cd9c0efc833e51ee839875f431a41bcd66f25", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/2f3cd9c0efc833e51ee839875f431a41bcd66f25", "committedDate": "2020-08-06T04:51:17Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fbf7b158bc07c71941af7cc7d9d133f2d55dff0", "author": {"user": {"login": "yuzhu", "name": "David Zhu"}}, "url": "https://github.com/Alluxio/alluxio/commit/6fbf7b158bc07c71941af7cc7d9d133f2d55dff0", "committedDate": "2020-08-06T05:15:58Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMjA5ODU4", "url": "https://github.com/Alluxio/alluxio/pull/11894#pullrequestreview-462209858", "createdAt": "2020-08-06T06:04:12Z", "commit": {"oid": "6fbf7b158bc07c71941af7cc7d9d133f2d55dff0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4208, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}