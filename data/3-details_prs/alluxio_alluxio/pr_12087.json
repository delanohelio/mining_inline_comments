{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNjgwNTc2", "number": 12087, "title": "Fix slow and contented local cache restart", "bodyText": "remove restore logic to a separate background thread meanwhile open the cache manager in a \"readonly\" mode to other query threads. in this way, early queries will suffer from low hit ratio but hopefully they will catch up.\nhandle capacity exceeding gracefully: instead of failing the restore and delete all pages on disk, just remove the excessive pages", "createdAt": "2020-09-09T09:02:08Z", "url": "https://github.com/Alluxio/alluxio/pull/12087", "merged": true, "mergeCommit": {"oid": "dbfc695833795414e308b0bddc3f66a92a7a3af4"}, "closed": true, "closedAt": "2020-09-17T21:12:52Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHP5BjAFqTQ4NTI1ODA3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ2iaggH2gAyNDgyNjgwNTc2OjYxODIyZGZiNWRiYjA3MDQwMzZiMzRiYWZmOWIxMWYyNTJlNTM0MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjU4MDcw", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-485258070", "createdAt": "2020-09-09T17:45:33Z", "commit": {"oid": "39056b7ebb206a567b685d3f625dc3c84ff3fa5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzo0NTozNFrOHPTIJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzo0NTozNFrOHPTIJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwNDA2OQ==", "bodyText": "Will this part be performant enough if there are a large number of extra pages? Is there any way to parallelize or otherwise delete the rest of the stream at once after we detect the metastore is out of space?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r485804069", "createdAt": "2020-09-09T17:45:34Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -107,10 +107,13 @@ private static boolean restore(\n           LOG.error(\"Invalid page info\");\n           return false;\n         }\n-        metaStore.addPage(pageInfo.getPageId(), pageInfo);\n+        PageId pageId = pageInfo.getPageId();\n+        metaStore.addPage(pageId, pageInfo);\n         if (metaStore.bytes() > pageStore.getCacheSize()) {\n-          LOG.error(\"Loaded pages exceed cache capacity ({} bytes)\", pageStore.getCacheSize());\n-          return false;\n+          metaStore.removePage(pageId);\n+          pageStore.delete(pageId);\n+          LOG.warn(\"Abandon {} in restore: cache size is {} bytes and {} bytes used\",\n+              pageInfo, pageStore.getCacheSize(), metaStore.bytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39056b7ebb206a567b685d3f625dc3c84ff3fa5f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjU4MjYw", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-485258260", "createdAt": "2020-09-09T17:45:51Z", "commit": {"oid": "39056b7ebb206a567b685d3f625dc3c84ff3fa5f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2130dc563b0acb2b9ebfcabee5af3fbf0073ce15", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/2130dc563b0acb2b9ebfcabee5af3fbf0073ce15", "committedDate": "2020-09-09T18:46:37Z", "message": "Fix slow and contented local cache restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39056b7ebb206a567b685d3f625dc3c84ff3fa5f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/39056b7ebb206a567b685d3f625dc3c84ff3fa5f", "committedDate": "2020-09-09T09:00:29Z", "message": "Fix slow and contented local cache restart"}, "afterCommit": {"oid": "2130dc563b0acb2b9ebfcabee5af3fbf0073ce15", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/2130dc563b0acb2b9ebfcabee5af3fbf0073ce15", "committedDate": "2020-09-09T18:46:37Z", "message": "Fix slow and contented local cache restart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDE3MTAx", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-485417101", "createdAt": "2020-09-09T21:29:46Z", "commit": {"oid": "2130dc563b0acb2b9ebfcabee5af3fbf0073ce15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b5d71b4554cc31b9969eef63de283a3ac4143a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/65b5d71b4554cc31b9969eef63de283a3ac4143a", "committedDate": "2020-09-12T07:45:03Z", "message": "Move initialization to background"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/73d9ad510e0647bba18112f038baab9b03bd6f82", "committedDate": "2020-09-12T20:56:38Z", "message": "Remove unnecessary lock and tryLock"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d09de99a1192b07b38da11af15db92aafeb90a0", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/4d09de99a1192b07b38da11af15db92aafeb90a0", "committedDate": "2020-09-12T07:50:40Z", "message": "Remove unnecessary lock and tryLock"}, "afterCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/73d9ad510e0647bba18112f038baab9b03bd6f82", "committedDate": "2020-09-12T20:56:38Z", "message": "Remove unnecessary lock and tryLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjc3ODcy", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488277872", "createdAt": "2020-09-15T02:24:39Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyNDo0MFrOHRuIaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyNDo0MFrOHRuIaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0MzY1Nw==", "bodyText": "Should this be a write lock because we might delete the page if there is not enough space?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r488343657", "createdAt": "2020-09-15T02:24:40Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -424,9 +408,87 @@ public boolean delete(PageId pageId) {\n     }\n   }\n \n+  @Override\n+  public State state() {\n+    return mState.get();\n+  }\n+\n+  /**\n+   * Restores a page store a the configured location, updating meta store.\n+   */\n+  private void restoreOrInit(PageStoreOptions options) {\n+    Preconditions.checkState(mState.get() == READ_ONLY);\n+    if (!restore(options)) {\n+      try {\n+        mPageStore.close();\n+        try (LockResource r = new LockResource(mMetaLock.writeLock())) {\n+          mMetaStore.reset();\n+        }\n+        PageStore.initialize(options);\n+        mPageStore = PageStore.create(options);\n+      } catch (Exception e) {\n+        LOG.error(\"Failed to clean up PageStore\", e);\n+        return;\n+      }\n+    }\n+    mState.set(READ_WRITE);\n+    Metrics.STATE.inc();\n+  }\n+\n+  private boolean restore(PageStoreOptions options) {\n+    LOG.info(\"Attempt to restore PageStore with {}\", options);\n+    Path rootDir = Paths.get(options.getRootDir());\n+    if (!Files.exists(rootDir)) {\n+      LOG.error(\"Failed to restore PageStore: Directory {} does not exist\", rootDir);\n+      return false;\n+    }\n+    long discardedPages = 0;\n+    long discardedBytes = 0;\n+    try (Stream<PageInfo> stream = mPageStore.getPages()) {\n+      Iterator<PageInfo> iterator = stream.iterator();\n+      while (iterator.hasNext()) {\n+        PageInfo pageInfo = iterator.next();\n+        if (pageInfo == null) {\n+          LOG.error(\"Invalid page info\");\n+          return false;\n+        }\n+        PageId pageId = pageInfo.getPageId();\n+        ReadWriteLock pageLock = getPageLock(pageId);\n+        try (LockResource r = new LockResource(pageLock.readLock())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "originalPosition": 233}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjc4NzQx", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488278741", "createdAt": "2020-09-15T02:27:13Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyNzoxM1rOHRuLaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyNzoxM1rOHRuLaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NDQyNA==", "bodyText": "Is this description accurate? It looks like we only have two states?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r488344424", "createdAt": "2020-09-15T02:27:13Z", "author": {"login": "calvinjia"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -938,6 +950,12 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STATE =\n+      new Builder(Name.CLIENT_CACHE_STATE)\n+          .setDescription(\"State of the cache: 0 (NOT_READY), 1 (READ_ONLY) and 2 (READ_WRITE)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjc4ODc4", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488278878", "createdAt": "2020-09-15T02:27:41Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjc5NDM2", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488279436", "createdAt": "2020-09-15T02:29:23Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyOToyNFrOHRuNpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyOToyNFrOHRuNpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NDk5Ng==", "bodyText": "One concern here is if multiple threads can go into restoreOrInit.", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r488344996", "createdAt": "2020-09-15T02:29:24Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -424,9 +408,87 @@ public boolean delete(PageId pageId) {\n     }\n   }\n \n+  @Override\n+  public State state() {\n+    return mState.get();\n+  }\n+\n+  /**\n+   * Restores a page store a the configured location, updating meta store.\n+   */\n+  private void restoreOrInit(PageStoreOptions options) {\n+    Preconditions.checkState(mState.get() == READ_ONLY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "originalPosition": 196}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjc5NTg0", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488279584", "createdAt": "2020-09-15T02:29:53Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyOTo1M1rOHRuOLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjoyOTo1M1rOHRuOLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NTEzNQ==", "bodyText": "Are we guaranteed create is only called once? Otherwise we could queue up multiple restoreOrInit", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r488345135", "createdAt": "2020-09-15T02:29:53Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -69,99 +74,67 @@\n   private static final Logger LOG = LoggerFactory.getLogger(LocalCacheManager.class);\n \n   private static final int LOCK_SIZE = 1024;\n+\n   private final long mPageSize;\n   private final long mCacheSize;\n   private final boolean mAsyncWrite;\n+  private final boolean mAsyncRestore;\n   /** A readwrite lock pool to guard individual pages based on striping. */\n   private final ReadWriteLock[] mPageLocks = new ReentrantReadWriteLock[LOCK_SIZE];\n-  private final PageStore mPageStore;\n+  private PageStore mPageStore;\n   /** A readwrite lock to guard metadata operations. */\n   private final ReadWriteLock mMetaLock = new ReentrantReadWriteLock();\n   @GuardedBy(\"mMetaLock\")\n   private final MetaStore mMetaStore;\n+  /** Executor service for execute the init tasks. */\n+  private final ExecutorService mInitService;\n   /** Executor service for execute the async cache tasks. */\n   private final ExecutorService mAsyncCacheExecutor;\n   private final ConcurrentHashSet<PageId> mPendingRequests;\n+  /** State of this cache. */\n+  private final AtomicReference<CacheManager.State> mState = new AtomicReference<>(READ_ONLY);\n \n   /**\n-   * Restores a page store a the configured location, updating meta store and evictor.\n-   *\n-   * @param pageStore page store\n-   * @param options page store options\n-   * @param metaStore meta store\n-   * @return whether the restore succeeds or not\n+   * @param conf the Alluxio configuration\n+   * @return an instance of {@link LocalCacheManager}\n    */\n-  private static boolean restore(\n-      PageStore pageStore, PageStoreOptions options, MetaStore metaStore) {\n-    LOG.info(\"Attempt to restore PageStore with {}\", options);\n-    Path rootDir = Paths.get(options.getRootDir());\n-    if (!Files.exists(rootDir)) {\n-      LOG.error(\"Failed to restore PageStore: Directory {} does not exist\", rootDir);\n-      return false;\n-    }\n-    try (Stream<PageInfo> stream = pageStore.getPages()) {\n-      Iterator<PageInfo> iterator = stream.iterator();\n-      while (iterator.hasNext()) {\n-        PageInfo pageInfo = iterator.next();\n-        if (pageInfo == null) {\n-          LOG.error(\"Invalid page info\");\n-          return false;\n-        }\n-        metaStore.addPage(pageInfo.getPageId(), pageInfo);\n-        if (metaStore.bytes() > pageStore.getCacheSize()) {\n-          LOG.error(\"Loaded pages exceed cache capacity ({} bytes)\", pageStore.getCacheSize());\n-          return false;\n-        }\n-      }\n-    } catch (Exception e) {\n-      LOG.error(\"Failed to restore PageStore\", e);\n-      return false;\n-    }\n-    LOG.info(\"Restored PageStore with {} existing pages and {} bytes\", metaStore.pages(),\n-        metaStore.bytes());\n-    return true;\n+  public static LocalCacheManager create(AlluxioConfiguration conf) throws IOException {\n+    MetaStore metaStore = MetaStore.create(CacheEvictor.create(conf));\n+    PageStoreOptions options = PageStoreOptions.create(conf);\n+    PageStore pageStore = PageStore.create(options);\n+    return create(conf, metaStore, pageStore, options);\n   }\n \n   /**\n    * @param conf the Alluxio configuration\n+   * @param metaStore the meta store manages the metadata\n+   * @param pageStore the page store manages the cache data\n+   * @param options page store options\n    * @return an instance of {@link LocalCacheManager}\n    */\n-  public static LocalCacheManager create(AlluxioConfiguration conf) throws IOException {\n-    MetaStore metaStore = MetaStore.create(CacheEvictor.create(conf));\n-    PageStoreOptions options = PageStoreOptions.create(conf);\n-    PageStore pageStore = null;\n-    boolean restored = false;\n-    try {\n-      pageStore = PageStore.create(options, false);\n-      restored = restore(pageStore, options, metaStore);\n-    } catch (Exception e) {\n-      LOG.error(\"Failed to restore PageStore\", e);\n-    }\n-    if (!restored) {\n-      if (pageStore != null) {\n-        try {\n-          pageStore.close();\n-        } catch (Exception e) {\n-          LOG.error(\"Failed to close PageStore\", e);\n-        }\n-      }\n-      metaStore.reset();\n-      pageStore = PageStore.create(options, true);\n+  @VisibleForTesting\n+  static LocalCacheManager create(AlluxioConfiguration conf, MetaStore metaStore,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "originalPosition": 123}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgwMjgw", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-488280280", "createdAt": "2020-09-15T02:32:07Z", "commit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozMjowOFrOHRuQlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozMjowOFrOHRuQlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NTc0OQ==", "bodyText": "If restoreOrInit hasn't completed, is it safe for get calls? Will there be some objects which could be null?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r488345749", "createdAt": "2020-09-15T02:32:08Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java", "diffHunk": "@@ -18,7 +18,35 @@\n /**\n  * Interface for managing cached pages.\n  */\n-public interface CacheManager extends AutoCloseable  {\n+public interface CacheManager extends AutoCloseable {\n+\n+  /**\n+   * State of a cache.\n+   */\n+  enum State {\n+    /**\n+     * this cache is read only.\n+     */\n+    READ_ONLY(0),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9ad510e0647bba18112f038baab9b03bd6f82"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5634289fc867f1bf9ed65db4a1058e1e21fab467", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5634289fc867f1bf9ed65db4a1058e1e21fab467", "committedDate": "2020-09-16T04:45:22Z", "message": "Address comments"}, "afterCommit": {"oid": "029be108e9bb8833cb792e7faafb4b32c8a3ad1d", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/029be108e9bb8833cb792e7faafb4b32c8a3ad1d", "committedDate": "2020-09-16T04:48:07Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5007dad40d4a3200bfd7c9401d202618dde07292", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5007dad40d4a3200bfd7c9401d202618dde07292", "committedDate": "2020-09-16T04:49:06Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "029be108e9bb8833cb792e7faafb4b32c8a3ad1d", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/029be108e9bb8833cb792e7faafb4b32c8a3ad1d", "committedDate": "2020-09-16T04:48:07Z", "message": "Address comments"}, "afterCommit": {"oid": "5007dad40d4a3200bfd7c9401d202618dde07292", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5007dad40d4a3200bfd7c9401d202618dde07292", "committedDate": "2020-09-16T04:49:06Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05cde3ad3652f40a7421c5a0637db9094f571c2", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/d05cde3ad3652f40a7421c5a0637db9094f571c2", "committedDate": "2020-09-16T06:31:32Z", "message": "Add NOT_IN_USE state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDYwNjYx", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-490060661", "createdAt": "2020-09-16T22:23:57Z", "commit": {"oid": "d05cde3ad3652f40a7421c5a0637db9094f571c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMjoyMzo1OFrOHTGPUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMjoyMzo1OFrOHTGPUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4NzIxOA==", "bodyText": "Should this be -1, 0, and 1?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r489787218", "createdAt": "2020-09-16T22:23:58Z", "author": {"login": "calvinjia"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -938,6 +956,12 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STATE =\n+      new Builder(Name.CLIENT_CACHE_STATE)\n+          .setDescription(\"State of the cache: 0 (NOT_IN_USE), 1 (READ_ONLY) and 2 (READ_WRITE)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05cde3ad3652f40a7421c5a0637db9094f571c2"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0b1c9ef39e74e577afeb3a2fe33e9b1136158cc", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/f0b1c9ef39e74e577afeb3a2fe33e9b1136158cc", "committedDate": "2020-09-17T10:06:56Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6219f7461abaef9bc7d18f45ed5ab3ca417b187", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/b6219f7461abaef9bc7d18f45ed5ab3ca417b187", "committedDate": "2020-09-17T07:21:41Z", "message": "Fix tests"}, "afterCommit": {"oid": "f0b1c9ef39e74e577afeb3a2fe33e9b1136158cc", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/f0b1c9ef39e74e577afeb3a2fe33e9b1136158cc", "committedDate": "2020-09-17T10:06:56Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a2d1b477af0fb432ffb4a596842e9beedaa0124", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/0a2d1b477af0fb432ffb4a596842e9beedaa0124", "committedDate": "2020-09-17T10:30:40Z", "message": "Use trylock since LocalCacheManager.create can be slow now"}, "afterCommit": {"oid": "b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a", "committedDate": "2020-09-17T18:21:07Z", "message": "Use trylock since LocalCacheManager.create can be slow now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTAyOTg0", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-490902984", "createdAt": "2020-09-17T19:07:38Z", "commit": {"oid": "b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTowNzozOFrOHTxMYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTowNzozOFrOHTxMYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ5MDk3OA==", "bodyText": "Should this be return -1 not sure if this counts as error or page not found?", "url": "https://github.com/Alluxio/alluxio/pull/12087#discussion_r490490978", "createdAt": "2020-09-17T19:07:38Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -371,6 +358,11 @@ public int get(PageId pageId, int pageOffset, int bytesToRead, byte[] buffer,\n         \"buffer does not have enough space: bufferLength=%s offsetInBuffer=%s bytesToRead=%s\",\n         buffer.length, offsetInBuffer, bytesToRead);\n     LOG.debug(\"get({},pageOffset={}) enters\", pageId, pageOffset);\n+    if (mState.get() == NOT_IN_USE) {\n+      Metrics.GET_NOT_READY_ERRORS.inc();\n+      Metrics.GET_ERRORS.inc();\n+      return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a"}, "originalPosition": 183}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "974998e67adbab9ca0ec9e158b8f0edd6a1a265a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/974998e67adbab9ca0ec9e158b8f0edd6a1a265a", "committedDate": "2020-09-17T19:14:01Z", "message": "Use trylock since LocalCacheManager.create can be slow now"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/b7ddd0c4e53fa2cbc541833ab3b4b9a85ac5370a", "committedDate": "2020-09-17T18:21:07Z", "message": "Use trylock since LocalCacheManager.create can be slow now"}, "afterCommit": {"oid": "974998e67adbab9ca0ec9e158b8f0edd6a1a265a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/974998e67adbab9ca0ec9e158b8f0edd6a1a265a", "committedDate": "2020-09-17T19:14:01Z", "message": "Use trylock since LocalCacheManager.create can be slow now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTE0MjI5", "url": "https://github.com/Alluxio/alluxio/pull/12087#pullrequestreview-490914229", "createdAt": "2020-09-17T19:20:41Z", "commit": {"oid": "974998e67adbab9ca0ec9e158b8f0edd6a1a265a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61822dfb5dbb0704036b34baff9b11f252e53410", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/61822dfb5dbb0704036b34baff9b11f252e53410", "committedDate": "2020-09-17T19:55:01Z", "message": "Fix failing integration tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3563, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}