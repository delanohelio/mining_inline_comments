{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDg4Mzcy", "number": 10908, "title": "Add metrics tests", "bodyText": "This PR does some cleaning jobs of metrics:\n(1) Add time loggings for metrics related methods\n(2) Reduce the heavy string operations by memorizing the result of escapePath\n(3) Reduce the call for METRIC_REGISTRY.getGauges() since each getGauges call traverse the whole metrics and make a full copy of gauges.\n(4) Add the MetricsStoreTest and MetricsSystemTest", "createdAt": "2020-02-13T21:08:22Z", "url": "https://github.com/Alluxio/alluxio/pull/10908", "merged": true, "mergeCommit": {"oid": "50146ce36a2d78aa207a39b3af271092552c3e56"}, "closed": true, "closedAt": "2020-02-14T02:50:14Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEBhHFgH2gAyMzc1MDg4MzcyOjhiNjI5M2MyYmM4MTFmODhlM2YzODc0MjQ2YmM1NmIwMDQ1ZTFmMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEFJSdgFqTM1ODY2MTg0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b6293c2bc811f88e3f3874246bc56b0045e1f04", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/8b6293c2bc811f88e3f3874246bc56b0045e1f04", "committedDate": "2020-02-13T21:07:51Z", "message": "Add metrics tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c60de875277e612e02e808923fcbde181e035bea", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/c60de875277e612e02e808923fcbde181e035bea", "committedDate": "2020-02-13T21:44:50Z", "message": "Fix MetricsStoreTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTk3NTQy", "url": "https://github.com/Alluxio/alluxio/pull/10908#pullrequestreview-358597542", "createdAt": "2020-02-13T22:27:15Z", "commit": {"oid": "c60de875277e612e02e808923fcbde181e035bea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjoyNzoxNlrOFplxSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozMDozM1rOFpl2qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDc2Mg==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOG.info(\"Clearing the metrics store and metrics system in {} ms\",\n          \n          \n            \n                LOG.info(\"Cleared the metrics store and metrics system in {} ms\",", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379154762", "createdAt": "2020-02-13T22:27:16Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -203,13 +205,16 @@ public void init() {\n    * the metrics inside metrics sets.\n    */\n   public void clear() {\n+    long start = System.currentTimeMillis();\n     try (LockResource r = new LockResource(mLock.writeLock())) {\n       for (Counter counter : mClusterCounters.values()) {\n         counter.dec(counter.getCount());\n       }\n       mLastClearTime = System.currentTimeMillis();\n       MetricsSystem.resetAllMetrics();\n     }\n+    LOG.info(\"Clearing the metrics store and metrics system in {} ms\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c60de875277e612e02e808923fcbde181e035bea"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTU4Ng==", "bodyText": "what does memoizing do for us here?", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379155586", "createdAt": "2020-02-13T22:29:12Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/underfs/UnderFileSystemWithLogging.java", "diffHunk": "@@ -57,6 +59,8 @@\n   private final UnderFileSystem mUnderFileSystem;\n   private final UnderFileSystemConfiguration mConf;\n   private final String mPath;\n+  private final Supplier<String> mEscapedPath =\n+      CommonUtils.memoize(this::escapePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c60de875277e612e02e808923fcbde181e035bea"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTc4MQ==", "bodyText": "I feel like this will be a spammy log at INFO level", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379155781", "createdAt": "2020-02-13T22:29:41Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -718,6 +731,8 @@ public static synchronized void resetAllMetrics() {\n       METRIC_REGISTRY.timer(timerName);\n     }\n     LAST_REPORTED_METRICS.clear();\n+    LOG.info(\"Reset all metrics in the metrics system in {}ms\",\n+        System.currentTimeMillis() - startTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c60de875277e612e02e808923fcbde181e035bea"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjEzOQ==", "bodyText": "If you're looking to escape into URI-compatible paths I would look somewhere in apache commons utils", "url": "https://github.com/Alluxio/alluxio/pull/10908#discussion_r379156139", "createdAt": "2020-02-13T22:30:33Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/metrics/MetricsSystem.java", "diffHunk": "@@ -395,7 +397,9 @@ public static String stripInstanceAndHost(String metricsName) {\n    * @return the string representing the escaped URI\n    */\n   public static String escape(AlluxioURI uri) {\n-    return uri.toString().replace(\"%\", \"%25\").replace(\"/\", \"%2F\").replace(\".\", \"%2E\");\n+    return CACHED_ESCAPED_PATH.computeIfAbsent(uri,\n+        u -> u.toString().replace(\"%\", \"%25\")\n+            .replace(\"/\", \"%2F\").replace(\".\", \"%2E\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c60de875277e612e02e808923fcbde181e035bea"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d5d443ae23f7163e46c9d48b9776297300a521", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f8d5d443ae23f7163e46c9d48b9776297300a521", "committedDate": "2020-02-13T22:59:16Z", "message": "Add metrics system tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66704368b5af9a502bcdabdc83f52359d3b16757", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/66704368b5af9a502bcdabdc83f52359d3b16757", "committedDate": "2020-02-13T23:28:23Z", "message": "Merge remote-tracking branch 'upstream/master' into metricsTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d4750fbcd8dbb9258538995bb254da2bb4a2fa", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/93d4750fbcd8dbb9258538995bb254da2bb4a2fa", "committedDate": "2020-02-13T23:29:17Z", "message": "Merge os master and solve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1802886aef6309a2621ed0777ee87a978500c86", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/e1802886aef6309a2621ed0777ee87a978500c86", "committedDate": "2020-02-14T00:09:31Z", "message": "Directly remember the escaped path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761c87d348b2719649bea83e30c54f90d3dd1bc0", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/761c87d348b2719649bea83e30c54f90d3dd1bc0", "committedDate": "2020-02-14T00:10:45Z", "message": "small fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjYxODQ2", "url": "https://github.com/Alluxio/alluxio/pull/10908#pullrequestreview-358661846", "createdAt": "2020-02-14T01:21:27Z", "commit": {"oid": "761c87d348b2719649bea83e30c54f90d3dd1bc0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4954, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}