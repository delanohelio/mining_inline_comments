{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3Njc4NzY5", "number": 11983, "title": "Fix ClosedByInterruptException issue in local cache", "bodyText": "This patch aims to fix periodic ClosedByInterruptException thrown to local cache.\n2020-08-12T15:06:00.020-0700    ERROR   20200812_220058_08274_gyew8.1.0.9-586-95713     alluxio.client.file.cache.LocalCacheManager     Failed to get existing page PageId{FileId=47a1abdb3874925210b14e81720f4e8f, PageIndex=181}: {}\njava.nio.channels.ClosedByInterruptException\n        at java.base/java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:199)\n        at java.base/sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:228)\n        at alluxio.client.file.cache.LocalCacheManager.getPage(LocalCacheManager.java:457)\n        at alluxio.client.file.cache.LocalCacheManager.get(LocalCacheManager.java:362)\n        at alluxio.client.file.cache.NoExceptionCacheManager.get(NoExceptionCacheManager.java:62)\n        at alluxio.client.file.cache.LocalCacheFileInStream.positionedRead(LocalCacheFileInStream.java:216)\n        at com.facebook.presto.cache.alluxio.AlluxioCachingHdfsFileInputStream.read(AlluxioCachingHdfsFileInputStream.java:69)\n        at com.facebook.presto.cache.alluxio.AlluxioCachingHdfsFileInputStream.readFully(AlluxioCachingHdfsFileInputStream.java:86)\n\nReason of seeing this exception is due to the use of FileChannel when reading a page from local disk.\nA FileChanel is Interruptible based on its javadoc\nOn read, it will throw a ClosedByInterruptException If another thread interrupts the current thread while the read operation is in progress, thereby closing the channel and setting the current thread's interrupt status. And there is very little we can do to prevent or recover from channel close.\nTherefore in this patch, we replace Filechannel with FileInputStream", "createdAt": "2020-08-13T23:18:48Z", "url": "https://github.com/Alluxio/alluxio/pull/11983", "merged": true, "mergeCommit": {"oid": "6211542c4f1a9a67a0c324a0c8969ae015620498"}, "closed": true, "closedAt": "2020-08-16T17:35:44Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-oZ27AH2gAyNDY3Njc4NzY5OjQzYTQ5ZWRlNzMwNWY1Njc0NGU5NGIxZWNjNmQ0YWIyM2FiMmZmNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_ND_RABqjM2NTg3MjY1NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43a49ede7305f56744e94b1ecc6d4ab23ab2ff73", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/43a49ede7305f56744e94b1ecc6d4ab23ab2ff73", "committedDate": "2020-08-13T23:13:50Z", "message": "Fix ClosedByInterruptException issue in local cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjMxOTIw", "url": "https://github.com/Alluxio/alluxio/pull/11983#pullrequestreview-467231920", "createdAt": "2020-08-14T00:07:58Z", "commit": {"oid": "43a49ede7305f56744e94b1ecc6d4ab23ab2ff73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowNzo1OFrOHAhwxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowNzo1OFrOHAhwxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMxNTIwNQ==", "bodyText": "Do we need to do this read in a loop since we are not guaranteed to read the full data in one call?", "url": "https://github.com/Alluxio/alluxio/pull/11983#discussion_r470315205", "createdAt": "2020-08-14T00:07:58Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -88,23 +86,22 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+  public int get(PageId pageId, int pageOffset, byte[] buffer, int bufferOffset)\n       throws IOException, PageNotFoundException {\n     Preconditions.checkArgument(pageOffset >= 0, \"page offset should be non-negative\");\n+    Preconditions.checkArgument(buffer.length >= bufferOffset, \"page offset %s should be \"\n+        + \"less or equal than buffer length %s\", bufferOffset, buffer.length);\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n-    File f = p.toFile();\n-    Preconditions.checkArgument(pageOffset <= f.length(),\n-        \"page offset %s exceeded page size %s\", pageOffset, f.length());\n-    FileInputStream fis = new FileInputStream(p.toFile());\n-    try {\n-      fis.skip(pageOffset);\n-      return fis.getChannel();\n-    } catch (Throwable t) {\n-      fis.close();\n-      throw t;\n+    long fileLen = p.toFile().length();\n+    Preconditions.checkArgument(pageOffset <= fileLen,\n+        \"page offset %s exceeded page size %s\", pageOffset, fileLen);\n+    try (RandomAccessFile localFile = new RandomAccessFile(p.toString(), \"r\")) {\n+      localFile.skipBytes(pageOffset);\n+      return localFile.read(buffer, bufferOffset, (int) Math.min(fileLen - pageOffset,\n+          buffer.length - bufferOffset));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43a49ede7305f56744e94b1ecc6d4ab23ab2ff73"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjMyMDMz", "url": "https://github.com/Alluxio/alluxio/pull/11983#pullrequestreview-467232033", "createdAt": "2020-08-14T00:08:18Z", "commit": {"oid": "43a49ede7305f56744e94b1ecc6d4ab23ab2ff73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowODoxOFrOHAhxjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMDowODoxOFrOHAhxjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMxNTQwNw==", "bodyText": "Same comment about read", "url": "https://github.com/Alluxio/alluxio/pull/11983#discussion_r470315407", "createdAt": "2020-08-14T00:08:18Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -123,9 +121,12 @@ public ReadableByteChannel get(PageId pageId, int pageOffset)\n       }\n       Preconditions.checkArgument(pageOffset <= page.length,\n           \"page offset %s exceeded page size %s\", pageOffset, page.length);\n-      ByteArrayInputStream bais = new ByteArrayInputStream(page);\n-      bais.skip(pageOffset);\n-      return Channels.newChannel(bais);\n+\n+      try (ByteArrayInputStream bais = new ByteArrayInputStream(page)) {\n+        bais.skip(pageOffset);\n+        return bais.read(buffer, bufferOffset,\n+            Math.min(page.length - pageOffset, buffer.length - bufferOffset));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43a49ede7305f56744e94b1ecc6d4ab23ab2ff73"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4109d8268ae29286c6158c0b71b3aa19331f1d0", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/f4109d8268ae29286c6158c0b71b3aa19331f1d0", "committedDate": "2020-08-14T18:05:54Z", "message": "Merge branch 'branch-2.2.2-p' of github.com:Alluxio/alluxio into branch-2.2.2-p-interrupt"}, "afterCommit": {"oid": "411e94f6bfb1d4d6a059c26f75798cf2dacc0c1d", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/411e94f6bfb1d4d6a059c26f75798cf2dacc0c1d", "committedDate": "2020-08-14T18:08:48Z", "message": "Merge branch 'branch-2.2.2-p' of github.com:Alluxio/alluxio into branch-2.2.2-p-interrupt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODE1MDI4", "url": "https://github.com/Alluxio/alluxio/pull/11983#pullrequestreview-467815028", "createdAt": "2020-08-14T19:07:23Z", "commit": {"oid": "411e94f6bfb1d4d6a059c26f75798cf2dacc0c1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19dfe93dbba190527b4766a7cadd525de88a213", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/d19dfe93dbba190527b4766a7cadd525de88a213", "committedDate": "2020-08-15T17:56:14Z", "message": "Merge branch 'branch-2.2.2-p' of github.com:Alluxio/alluxio into branch-2.2.2-p-interrupt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "411e94f6bfb1d4d6a059c26f75798cf2dacc0c1d", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/411e94f6bfb1d4d6a059c26f75798cf2dacc0c1d", "committedDate": "2020-08-14T18:08:48Z", "message": "Merge branch 'branch-2.2.2-p' of github.com:Alluxio/alluxio into branch-2.2.2-p-interrupt"}, "afterCommit": {"oid": "d19dfe93dbba190527b4766a7cadd525de88a213", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/d19dfe93dbba190527b4766a7cadd525de88a213", "committedDate": "2020-08-15T17:56:14Z", "message": "Merge branch 'branch-2.2.2-p' of github.com:Alluxio/alluxio into branch-2.2.2-p-interrupt"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4136, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}