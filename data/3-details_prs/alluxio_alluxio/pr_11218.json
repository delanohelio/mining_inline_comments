{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Mzc3MzIz", "number": 11218, "title": "Create new client pool map during context reinit", "bodyText": "When a FileSystemContext is re-initialized, any acquired clients are expected to be released back into the same pool.\nBefore this change, it's possible for the following scenario to occur:\n\nA thread would acquire a block worker client from the pool map with key A.\nThe context is re-initialized. All pools in the map are closed, the pool map is cleared\nAnother thread acquires a block worker client with key A as well. This creates a new pool map entry with the same key A.\nThe original thread tries to release the client it acquired before, and it releases back into the new blockworker client pool. The pool is not the same as before, and an exception is thrown.\n\nFixes #11221", "createdAt": "2020-03-30T03:02:19Z", "url": "https://github.com/Alluxio/alluxio/pull/11218", "merged": true, "mergeCommit": {"oid": "b844eaa27707978712053aa51f240448f1d3aab2"}, "closed": true, "closedAt": "2020-03-31T17:34:27Z", "author": {"login": "ZacBlanco"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSljLlAH2gAyMzk1Mzc3MzIzOjc5ODNmM2MzZWMxNGFlNDRhZDAwNWE2MTU5MmIyNjEwYWY5ZTQxYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTGJWOgFqTM4NDkzMDE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7983f3c3ec14ae44ad005a61592b2610af9e41bf", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/7983f3c3ec14ae44ad005a61592b2610af9e41bf", "committedDate": "2020-03-30T03:01:38Z", "message": "Create new client pool map during context reinit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MjQ4MTAy", "url": "https://github.com/Alluxio/alluxio/pull/11218#pullrequestreview-384248102", "createdAt": "2020-03-30T21:34:17Z", "commit": {"oid": "7983f3c3ec14ae44ad005a61592b2610af9e41bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42c590439f1ebba9a9749154dfcaf6c74c71cd5f", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/42c590439f1ebba9a9749154dfcaf6c74c71cd5f", "committedDate": "2020-03-30T22:46:38Z", "message": "Clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzEwNjI5", "url": "https://github.com/Alluxio/alluxio/pull/11218#pullrequestreview-384310629", "createdAt": "2020-03-30T23:49:32Z", "commit": {"oid": "42c590439f1ebba9a9749154dfcaf6c74c71cd5f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzo0OTozMlrOF-AVBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzo1MDowNlrOF-AVtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MTQxNQ==", "bodyText": "remove empty line", "url": "https://github.com/Alluxio/alluxio/pull/11218#discussion_r400561415", "createdAt": "2020-03-30T23:49:32Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/ConfigHashSync.java", "diffHunk": "@@ -92,6 +92,7 @@ public synchronized void heartbeat() {\n         mContext.getClientContext().getPathConfHash());\n     if (isClusterConfUpdated || isPathConfUpdated) {\n       try {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42c590439f1ebba9a9749154dfcaf6c74c71cd5f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MTU5MA==", "bodyText": "Why don't we want to clear anymore?", "url": "https://github.com/Alluxio/alluxio/pull/11218#discussion_r400561590", "createdAt": "2020-03-30T23:50:06Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -282,13 +283,13 @@ private synchronized void closeContext() throws IOException {\n       mFileSystemMasterClientPool = null;\n       mBlockMasterClientPool.close();\n       mBlockMasterClientPool = null;\n-      for (BlockWorkerClientPool pool : mBlockWorkerClientPool.values()) {\n+      for (BlockWorkerClientPool pool : mBlockWorkerClientPoolMap.values()) {\n         pool.close();\n       }\n       // Close worker group after block master clients in order to allow\n       // clean termination for open streams.\n       mWorkerGroup.shutdownGracefully(1L, 10L, TimeUnit.SECONDS);\n-      mBlockWorkerClientPool.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42c590439f1ebba9a9749154dfcaf6c74c71cd5f"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "826d4da2745879e62584793d1d01d7520fe0a142", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/826d4da2745879e62584793d1d01d7520fe0a142", "committedDate": "2020-03-30T23:55:51Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTMwMTg5", "url": "https://github.com/Alluxio/alluxio/pull/11218#pullrequestreview-384930189", "createdAt": "2020-03-31T17:00:17Z", "commit": {"oid": "826d4da2745879e62584793d1d01d7520fe0a142"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4708, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}