{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3ODM0MjUw", "number": 12475, "title": "Add block lock related metrics and catch throwable", "bodyText": "#12444\nThe metrics from metrics/prometheus is\nWorker_Block_Remover_BlocksToRemoved_Success_Count_XX 2.0\nWorker_Block_Remover_BlocksToRemoved_Take_Count_XX 2.0\nWorker_Block_Remover_BlocksToRemoved_Size 0.0\nWorker_Block_Remover_RemovingBlocks_Size 0.0", "createdAt": "2020-11-09T15:14:44Z", "url": "https://github.com/Alluxio/alluxio/pull/12475", "merged": true, "mergeCommit": {"oid": "67dc33d29d19ac4804ce7429aa203a93b515b6ca"}, "closed": true, "closedAt": "2020-11-19T03:43:42Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda2DYbAH2gAyNTE3ODM0MjUwOjRmYzRjNTlmYmQyNzhlZDcwZTVkYjcxNzBhZGZkODhmMTQwYWI0NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd6WuIgFqTUzNDA1OTUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4fc4c59fbd278ed70e5db7170adfd88f140ab454", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/4fc4c59fbd278ed70e5db7170adfd88f140ab454", "committedDate": "2020-11-09T14:57:50Z", "message": "Log some information when tryLock fail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99a7bda902d7159766f57bc2b66f9b3ec93b7795", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/99a7bda902d7159766f57bc2b66f9b3ec93b7795", "committedDate": "2020-11-09T15:45:01Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0fa2cdeaa61a4138ab7bcc5cbaf75be399c0a19", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/e0fa2cdeaa61a4138ab7bcc5cbaf75be399c0a19", "committedDate": "2020-11-10T01:54:35Z", "message": "Add some metrics to measure the status of AsyncBlockRemover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c", "committedDate": "2020-11-10T02:20:22Z", "message": "Fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDAyMTY5", "url": "https://github.com/Alluxio/alluxio/pull/12475#pullrequestreview-529402169", "createdAt": "2020-11-12T19:03:44Z", "commit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowMzo0NFrOHyJcOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxOTowMVrOHyKD3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0NTUyOQ==", "bodyText": "For all the locks, by convention, which do we log, lockid or block id?\nBetter to log in the same way", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522345529", "createdAt": "2020-11-12T19:03:44Z", "author": {"login": "LuQQiu"}, "path": "core/server/worker/src/main/java/alluxio/worker/grpc/ShortCircuitBlockReadHandler.java", "diffHunk": "@@ -140,7 +140,11 @@ public void onCompleted() {\n       @Override\n       public OpenLocalBlockResponse call() throws Exception {\n         if (mLockId != BlockLockManager.INVALID_LOCK_ID) {\n-          mWorker.unlockBlock(mLockId);\n+          try {\n+            mWorker.unlockBlock(mLockId);\n+          } catch (BlockDoesNotExistException e) {\n+            LOG.warn(\"Failed to unlock lock {} with error {}.\", mLockId, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0ODQwOQ==", "bodyText": "Change to .setIsClusterAggregated(false)?\nOur current way of defining cluster aggregated metrics is:\n\nSet MetricKey with  .setIsClusterAggregated(true) so that this metrics is reported to the leading master\nCreate a MetricKey like CLUSTER_WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT to represent the aggregated cluster metric.\nIn MetricStore.initCounterKeys add the cluster metric and worker metrics pair into the map", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522348409", "createdAt": "2020-11-12T19:07:55Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,30 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT)\n+          .setDescription(\"Total number of asyncBlockRemover take block count\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0OTU4NQ==", "bodyText": "no need to log session since we didn't track session correctly after Alluxio 1.5", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522349585", "createdAt": "2020-11-12T19:09:42Z", "author": {"login": "LuQQiu"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/BlockLockManager.java", "diffHunk": "@@ -111,7 +111,18 @@ public long lockBlock(long sessionId, long blockId, BlockLockType blockLockType)\n       }\n       lock = blockLock.writeLock();\n     }\n-    lock.lock();\n+    try {\n+      if (!lock.tryLock(1L, TimeUnit.MINUTES)) {\n+        LOG.warn(\"tryLock {} block {} for session {} failed after 1 min, \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MDcwMw==", "bodyText": "If interrupted, do we still lock?\nIf tryLock failed, do we still lock?\n@apc999 What's your thoughts?", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522350703", "createdAt": "2020-11-12T19:11:08Z", "author": {"login": "LuQQiu"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/BlockLockManager.java", "diffHunk": "@@ -111,7 +111,18 @@ public long lockBlock(long sessionId, long blockId, BlockLockType blockLockType)\n       }\n       lock = blockLock.writeLock();\n     }\n-    lock.lock();\n+    try {\n+      if (!lock.tryLock(1L, TimeUnit.MINUTES)) {\n+        LOG.warn(\"tryLock {} block {} for session {} failed after 1 min, \"\n+                + \"lock reference count = {}\",\n+            blockLockType, blockId, sessionId, blockLock.getReferenceCount());\n+        lock.lock();\n+      }\n+    } catch (InterruptedException e) {\n+      Thread.currentThread().interrupt();\n+      lock.lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTEwMw==", "bodyText": "Similar to PropertyKey, the MetricKey targets to be viewed by users who may not view Alluxio source codes. Can you help change the MetricKey name and description to be easier to understand?\nSuggestion: WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT -> WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT\nWORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_SUCCESS_COUNT -> WORKER_BLOCKS_REMOVER_REMOVED_COUNT\nwill be even better if we can track the try remove and removed in the whole worker not only in AsyncRemover if possible.", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522355103", "createdAt": "2020-11-12T19:18:00Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,30 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTQ4OA==", "bodyText": "The total number of blocks tried to be removed from this worker by asynchronous block remover.", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522355488", "createdAt": "2020-11-12T19:18:42Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,30 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT)\n+          .setDescription(\"Total number of asyncBlockRemover take block count\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTY3Ng==", "bodyText": "Similar for all other metric key names and descriptions", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r522355676", "createdAt": "2020-11-12T19:19:01Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,30 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVED_TAKE_COUNT)\n+          .setDescription(\"Total number of asyncBlockRemover take block count\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTQ4OA=="}, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c39634bd0af90747c51c0680be56ab19ef1152c", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/4c39634bd0af90747c51c0680be56ab19ef1152c", "committedDate": "2020-11-16T02:52:16Z", "message": "Modify the description and name of metrickey, log lockId and blockId."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d6b6b29d9385397d78706e8e538f58416da9d9d", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/4d6b6b29d9385397d78706e8e538f58416da9d9d", "committedDate": "2020-11-16T03:40:49Z", "message": "Fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxODE1MzIx", "url": "https://github.com/Alluxio/alluxio/pull/12475#pullrequestreview-531815321", "createdAt": "2020-11-16T21:49:06Z", "commit": {"oid": "4d6b6b29d9385397d78706e8e538f58416da9d9d"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTo0OTowNlrOH0U1Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTo1MjozMFrOH0VKbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyOTMwNw==", "bodyText": "Will it be better to change to WORKER_BLOCK_REMOVER_TRY_REMOVE_BLOCKS_SIZE", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r524629307", "createdAt": "2020-11-16T21:49:06Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,34 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT)\n+          .setDescription(\"The total number of blocks tried to be removed from this worker \"\n+              + \"by asynchronous block remover.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_REMOVED_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_REMOVED_COUNT)\n+          .setDescription(\"The total number of blocks was removed from this worker \"\n+              + \"by asynchronous block remover.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVE_SIZE =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6b6b29d9385397d78706e8e538f58416da9d9d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMDI4NA==", "bodyText": "The total number of blocks removed", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r524630284", "createdAt": "2020-11-16T21:49:41Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,34 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT)\n+          .setDescription(\"The total number of blocks tried to be removed from this worker \"\n+              + \"by asynchronous block remover.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_REMOVED_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_REMOVED_COUNT)\n+          .setDescription(\"The total number of blocks was removed from this worker \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6b6b29d9385397d78706e8e538f58416da9d9d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMDY1MQ==", "bodyText": "to be removed", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r524630651", "createdAt": "2020-11-16T21:49:53Z", "author": {"login": "LuQQiu"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -740,6 +740,34 @@ public MetricKey build() {\n           .setMetricType(MetricType.GAUGE)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_TRY_REMOVE_COUNT)\n+          .setDescription(\"The total number of blocks tried to be removed from this worker \"\n+              + \"by asynchronous block remover.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_REMOVED_COUNT =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_REMOVED_COUNT)\n+          .setDescription(\"The total number of blocks was removed from this worker \"\n+              + \"by asynchronous block remover.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVE_SIZE =\n+      new Builder(Name.WORKER_BLOCK_REMOVER_BLOCKS_TO_REMOVE_SIZE)\n+          .setDescription(\"The size of blocks to remove from this worker \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6b6b29d9385397d78706e8e538f58416da9d9d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzMTQwNQ==", "bodyText": "Make sense!", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r524631405", "createdAt": "2020-11-16T21:50:22Z", "author": {"login": "LuQQiu"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/BlockLockManager.java", "diffHunk": "@@ -111,7 +111,18 @@ public long lockBlock(long sessionId, long blockId, BlockLockType blockLockType)\n       }\n       lock = blockLock.writeLock();\n     }\n-    lock.lock();\n+    try {\n+      if (!lock.tryLock(1L, TimeUnit.MINUTES)) {\n+        LOG.warn(\"tryLock {} block {} for session {} failed after 1 min, \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0OTU4NQ=="}, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYzNDczNA==", "bodyText": "Can you help remove this tryLock changes in this PR for now? Other logics LGTM.\nI have a PR to move all lock.lock() to tryLock() #12507\nbut still need more discussion with @apc999 to see if we want to move to tryLock", "url": "https://github.com/Alluxio/alluxio/pull/12475#discussion_r524634734", "createdAt": "2020-11-16T21:52:30Z", "author": {"login": "LuQQiu"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/BlockLockManager.java", "diffHunk": "@@ -111,7 +111,18 @@ public long lockBlock(long sessionId, long blockId, BlockLockType blockLockType)\n       }\n       lock = blockLock.writeLock();\n     }\n-    lock.lock();\n+    try {\n+      if (!lock.tryLock(1L, TimeUnit.MINUTES)) {\n+        LOG.warn(\"tryLock {} block {} for session {} failed after 1 min, \"\n+                + \"lock reference count = {}\",\n+            blockLockType, blockId, sessionId, blockLock.getReferenceCount());\n+        lock.lock();\n+      }\n+    } catch (InterruptedException e) {\n+      Thread.currentThread().interrupt();\n+      lock.lock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MDcwMw=="}, "originalCommit": {"oid": "94a812fa41c13c9a7632ee527aaf9ec1b6fdb27c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad3ef4dc392032e44d5e617ae4656026cea8908", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/aad3ef4dc392032e44d5e617ae4656026cea8908", "committedDate": "2020-11-17T09:57:00Z", "message": "Fix metrics name and description to make it easy to understand"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDU5NTE1", "url": "https://github.com/Alluxio/alluxio/pull/12475#pullrequestreview-534059515", "createdAt": "2020-11-19T03:40:21Z", "commit": {"oid": "aad3ef4dc392032e44d5e617ae4656026cea8908"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3409, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}