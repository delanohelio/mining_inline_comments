{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1ODY3NDkw", "number": 11414, "title": "Prevent secondary UFS journal from modifying journal files", "bodyText": "Fixes #11415", "createdAt": "2020-05-11T05:02:23Z", "url": "https://github.com/Alluxio/alluxio/pull/11414", "merged": true, "mergeCommit": {"oid": "b358b1a6a3edab9b4ec90cdbaef60e5c92f3a105"}, "closed": true, "closedAt": "2020-05-11T18:09:39Z", "author": {"login": "gpang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgIbXBgH2gAyNDE1ODY3NDkwOmFiNzU5YjlmNDg1ZDFmODU1ZjBhZjA1NTRmYmFjYTNkNTljMWI5ZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgTHMpgFqTQwOTM3OTA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/ab759b9f485d1f855f0af0554fbaca3d59c1b9d5", "committedDate": "2020-05-11T05:00:47Z", "message": "Prevent secondary UFS journal to modify journal files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODY1NTEz", "url": "https://github.com/Alluxio/alluxio/pull/11414#pullrequestreview-408865513", "createdAt": "2020-05-11T05:19:42Z", "commit": {"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODY4NTEw", "url": "https://github.com/Alluxio/alluxio/pull/11414#pullrequestreview-408868510", "createdAt": "2020-05-11T05:29:28Z", "commit": {"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNToyOToyOFrOGTM_2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNToyOToyOFrOGTM_2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc4OTA4Mg==", "bodyText": "We could still lose primacy after the check, but that's fine because the rename will not pick up the wrong journal file? (ie. we check for primacy between updating current and attempting rename)", "url": "https://github.com/Alluxio/alluxio/pull/11414#discussion_r422789082", "createdAt": "2020-05-11T05:29:28Z", "author": {"login": "calvinjia"}, "path": "core/server/common/src/main/java/alluxio/master/journal/ufs/UfsJournalLogWriter.java", "diffHunk": "@@ -314,10 +329,19 @@ private void completeLog(UfsJournalFile currentLog, long nextSequenceNumber) thr\n       }\n       return;\n     }\n-    LOG.info(\"Completing log {} with next sequence number {}\", current, nextSequenceNumber);\n     String completed = UfsJournalFile\n         .encodeLogFileLocation(mJournal, currentLog.getStart(), nextSequenceNumber).toString();\n \n+    try {\n+      // Check again before the rename\n+      checkIsWritable();\n+    } catch (JournalClosedException e) {\n+      // Do not throw error, just ignore if the journal is not writable\n+      LOG.warn(\"Skipping completeLog() since journal is not writable. error: {}\", e.getMessage());\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5"}, "originalPosition": 123}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODY4NTc2", "url": "https://github.com/Alluxio/alluxio/pull/11414#pullrequestreview-408868576", "createdAt": "2020-05-11T05:29:40Z", "commit": {"oid": "ab759b9f485d1f855f0af0554fbaca3d59c1b9d5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909", "committedDate": "2020-05-11T05:42:08Z", "message": "Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTM2Mzgz", "url": "https://github.com/Alluxio/alluxio/pull/11414#pullrequestreview-408936383", "createdAt": "2020-05-11T07:47:55Z", "commit": {"oid": "daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Mzc5MDcw", "url": "https://github.com/Alluxio/alluxio/pull/11414#pullrequestreview-409379070", "createdAt": "2020-05-11T17:27:43Z", "commit": {"oid": "daca2f0b2e9ec03fb26de75cfe6e6edb3c99d909"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4622, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}