{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjMzNDIw", "number": 10847, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOToxNDowMVrODdcxLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQyMDowNzozMFrODeS08w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjA2NjM5OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOToxNDowMVrOFmD3fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo1MDoyOFrOFmJ6iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MzU2NA==", "bodyText": "Do we want hashmap or just a page object that has the size?", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375453564", "createdAt": "2020-02-05T19:14:01Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page size. */\n+  private final Map<PageId, Long> mPageMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "913b3d995c1e71ec9bab2d54ab970d1ab9b2246b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MjY1MQ==", "bodyText": "Actually we may need to store more page information later, so having a page info kind of object makes sense, for now we can keep it a long.", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375552651", "createdAt": "2020-02-05T22:50:28Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page size. */\n+  private final Map<PageId, Long> mPageMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MzU2NA=="}, "originalCommit": {"oid": "913b3d995c1e71ec9bab2d54ab970d1ab9b2246b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjcwMjExOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo1NDo0M1rOFmKBLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMjoxMzo1MFrOFnOqyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDM0OQ==", "bodyText": "I think we need a loop here where we evict data, since there is no guarantee one victim is sufficient?", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375554349", "createdAt": "2020-02-05T22:54:43Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3OTExNQ==", "bodyText": "As discussed, we will make best effort and evict at most one page to keep put concurrent", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376679115", "createdAt": "2020-02-08T02:13:50Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDM0OQ=="}, "originalCommit": {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjcwNjMwOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo1NjoyMVrOFmKDqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMjoxNDowM1rOFnOq2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw==", "bodyText": "Unrelated question - in some places we do operation first then evictor update and in others we do evictor update then operation, what is the reasoning?", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375554987", "createdAt": "2020-02-05T22:56:21Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);\n           } else {\n-            mMetaStore.addPage(pageId);\n+            mMetaStore.addPage(pageId, page.length);\n           }\n         }\n+      } catch (PageNotFoundException e) {\n+        throw new IllegalStateException(\"we shall not reach here\");\n       }\n       if (alreadyCached) {\n         try {\n-          mPageStore.delete(pageId);\n+          mPageStore.delete(pageId, pageSize);\n         } catch (PageNotFoundException e) {\n           throw new IllegalStateException(\n               String.format(\"Page store is missing page %s.\", pageId), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NjI4NQ==", "bodyText": "that is unintentional. Let's fix that issue in #10816", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r375996285", "createdAt": "2020-02-06T18:07:21Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);\n           } else {\n-            mMetaStore.addPage(pageId);\n+            mMetaStore.addPage(pageId, page.length);\n           }\n         }\n+      } catch (PageNotFoundException e) {\n+        throw new IllegalStateException(\"we shall not reach here\");\n       }\n       if (alreadyCached) {\n         try {\n-          mPageStore.delete(pageId);\n+          mPageStore.delete(pageId, pageSize);\n         } catch (PageNotFoundException e) {\n           throw new IllegalStateException(\n               String.format(\"Page store is missing page %s.\", pageId), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw=="}, "originalCommit": {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3OTEzMQ==", "bodyText": "fixed in later commit. PTAL", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376679131", "createdAt": "2020-02-08T02:14:03Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,25 +119,31 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public void put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n-\n+    long victimSize = 0;\n+    long pageSize = 0;\n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n       boolean alreadyCached;\n       boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n         alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n+        if (alreadyCached) {\n+          pageSize = mMetaStore.getPageSize(pageId);\n+        } else {\n+          needEvict = mPageStore.bytes() + page.length > mCacheSize;\n           if (needEvict) {\n             victim = mEvictor.evict();\n+            victimSize = mMetaStore.getPageSize(victim);\n           } else {\n-            mMetaStore.addPage(pageId);\n+            mMetaStore.addPage(pageId, page.length);\n           }\n         }\n+      } catch (PageNotFoundException e) {\n+        throw new IllegalStateException(\"we shall not reach here\");\n       }\n       if (alreadyCached) {\n         try {\n-          mPageStore.delete(pageId);\n+          mPageStore.delete(pageId, pageSize);\n         } catch (PageNotFoundException e) {\n           throw new IllegalStateException(\n               String.format(\"Page store is missing page %s.\", pageId), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1NDk4Nw=="}, "originalCommit": {"oid": "29ff1f156d08a3d0dca484b071b76b867284a94c"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDAwOTY0OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzoyNzozOFrOFnPlOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzoyNzozOFrOFnPlOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDA3Mg==", "bodyText": "I changed the behavior here a bit: if page to insert exists, it returns false now", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376694072", "createdAt": "2020-02-08T07:27:38Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -120,38 +119,32 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   }\n \n   @Override\n-  public void put(PageId pageId, byte[] page) throws IOException {\n+  public boolean put(PageId pageId, byte[] page) throws IOException {\n     PageId victim = null;\n+    long victimPageSize = 0;\n+    boolean enoughSpace;\n \n     ReadWriteLock pageLock = getPageLock(pageId);\n     try (LockResource r = new LockResource(pageLock.writeLock())) {\n-      boolean alreadyCached;\n-      boolean needEvict = false;\n       try (LockResource r2 = new LockResource(mMetaLock.writeLock())) {\n-        alreadyCached = mMetaStore.hasPage(pageId);\n-        if (!alreadyCached) {\n-          needEvict = mPageStore.size() + 1 > mCacheSize;\n-          if (needEvict) {\n-            victim = mEvictor.evict();\n-          } else {\n-            mMetaStore.addPage(pageId);\n-          }\n+        if (mMetaStore.hasPage(pageId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25b62b227001879b5efc03f8d41e800d010075da"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDAxMDEzOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzoyODozOFrOFnPlcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwNzoyODozOFrOFnPlcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NDEzMA==", "bodyText": "now we consistently update page store first followed by updating evictor", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376694130", "createdAt": "2020-02-08T07:28:38Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -205,8 +204,9 @@ public ReadableByteChannel get(PageId pageId, int pageOffset)\n       if (!hasPage) {\n         return null;\n       }\n+      ReadableByteChannel ret = mPageStore.get(pageId, pageOffset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25b62b227001879b5efc03f8d41e800d010075da"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDQ0OTgwOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMjozNDo1MVrOFnS-Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMjozNDo1MVrOFnS-Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc0OTYyNg==", "bodyText": "Let's test with real implementation of MetaStore and PageStore instead the mock. FYI", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376749626", "createdAt": "2020-02-09T02:34:51Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "diffHunk": "@@ -54,66 +51,148 @@\n \n   private LocalCacheManager mCacheManager;\n   private InstancedConfiguration mConf = ConfigurationTestUtils.defaults();\n-  private HashSetMetaStore mMetaStore;\n-  private HashMapPageStore mPageStore;\n+  private MetaStore mMetaStore;\n+  private PageStore mPageStore;\n   private CacheEvictor mEvictor;\n \n+  @Rule\n+  public TemporaryFolder mTemp = new TemporaryFolder();\n+\n   @Rule\n   public final ExpectedException mThrown = ExpectedException.none();\n \n   @Before\n   public void before() {\n     mConf.set(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES);\n     mConf.set(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES);\n-    mMetaStore = new HashSetMetaStore();\n-    mPageStore = new HashMapPageStore();\n+    mConf.set(PropertyKey.USER_CLIENT_CACHE_DIR, mTemp.getRoot().getAbsolutePath());\n+    mMetaStore = MetaStore.create();\n+    mPageStore = PageStore.create(mConf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da2b9688546343efd53b68fe8eb48936e2a5a0a3"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDkyMzM5OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQyMDowNzozMFrOFnWvCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMTo1NzoxMlrOFn3DEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTI3Mw==", "bodyText": "addPage requires PageInfo now.", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r376811273", "createdAt": "2020-02-09T20:07:30Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page info. */\n+  private final Map<PageId, PageInfo> mPageMap = new HashMap<>();\n \n   @Override\n   public boolean hasPage(PageId pageId) {\n-    return mPageMap.contains(pageId);\n+    return mPageMap.containsKey(pageId);\n   }\n \n   @Override\n-  public boolean addPage(PageId pageId) {\n-    return mPageMap.add(pageId);\n+  public void addPage(PageId pageId, PageInfo pageInfo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae9c00dc366dfc54f59548decaf6593fcc451ad9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MDY4OA==", "bodyText": "Do we still need to pass in separate page id now that PageInfo has the id?", "url": "https://github.com/Alluxio/alluxio/pull/10847#discussion_r377340688", "createdAt": "2020-02-10T21:57:12Z", "author": {"login": "bf8086"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,29 +13,39 @@\n \n import alluxio.exception.PageNotFoundException;\n \n-import java.util.HashSet;\n-import java.util.Set;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n-  private final Set<PageId> mPageMap = new HashSet<>();\n+  /** A map from PageId to page info. */\n+  private final Map<PageId, PageInfo> mPageMap = new HashMap<>();\n \n   @Override\n   public boolean hasPage(PageId pageId) {\n-    return mPageMap.contains(pageId);\n+    return mPageMap.containsKey(pageId);\n   }\n \n   @Override\n-  public boolean addPage(PageId pageId) {\n-    return mPageMap.add(pageId);\n+  public void addPage(PageId pageId, PageInfo pageInfo) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxMTI3Mw=="}, "originalCommit": {"oid": "ae9c00dc366dfc54f59548decaf6593fcc451ad9"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2149, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}