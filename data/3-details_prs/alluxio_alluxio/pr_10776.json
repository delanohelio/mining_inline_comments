{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NTY2NjQy", "number": 10776, "title": "Allow local cache to recover from existing files", "bodyText": "Add functionality to detect previously cached data on local storage and reuse them if the data is compatible.", "createdAt": "2020-01-21T22:53:15Z", "url": "https://github.com/Alluxio/alluxio/pull/10776", "merged": true, "mergeCommit": {"oid": "723bd4613566253c4b02c4500450cec3ea618261"}, "closed": true, "closedAt": "2020-02-09T04:32:58Z", "author": {"login": "bf8086"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8pKsBAH2gAyMzY1NTY2NjQyOjgyZmY1NzllMTZjNjg2MDc2ZWIxY2ZlYzYzNGU1OTQ2NDc4Njg3MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCg4dtAFqTM1NTU4MzE2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82ff579e16c686076eb1cfec634e59464786872d", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/82ff579e16c686076eb1cfec634e59464786872d", "committedDate": "2020-01-21T22:48:10Z", "message": "allow local cache to recover from existing files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760", "committedDate": "2020-01-21T23:20:51Z", "message": "fix findbugs and add more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MjYyMzEy", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-346262312", "createdAt": "2020-01-21T23:29:00Z", "commit": {"oid": "759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzoyOTowMFrOFgMPeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzozMzoxOFrOFgMUPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5OTMyMQ==", "bodyText": "Would be nice to know why its incompatible.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369299321", "createdAt": "2020-01-21T23:29:00Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,7 +85,64 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootPath = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    options.setRootDir(rootPath);\n+    Path confPath = Paths.get(rootPath, CONF_FILE);\n+    boolean canLoad = false;\n+    if (Files.exists(confPath)) {\n+      Properties properties = ConfigurationUtils.loadPropertiesFromFile(confPath.toString());\n+      if (properties != null) {\n+        AlluxioProperties alluxioProperties = new AlluxioProperties();\n+        alluxioProperties.merge(properties, Source.DEFAULT);\n+        AlluxioConfiguration cacheConf = new InstancedConfiguration(alluxioProperties);\n+        // check store type\n+        if (cacheConf.get(PropertyKey.USER_CLIENT_CACHE_STORE_TYPE).equals(\n+            conf.get(PropertyKey.USER_CLIENT_CACHE_STORE_TYPE))\n+            // check page size\n+            && cacheConf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE)\n+            == conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE)\n+            // check enough cache size\n+            && cacheConf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE)\n+            <= conf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE)\n+            // check alluxio version\n+            && cacheConf.get(PropertyKey.VERSION).equals(\n+            conf.get(PropertyKey.VERSION))) {\n+          LOG.info(\"Found recoverable local cache at {}\", rootPath);\n+          canLoad = true;\n+        } else {\n+          LOG.info(\"Found local cache at {} with incompatible configuration.\", rootPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwMDE5Nw==", "bodyText": "It feels kind of weird to not do the loading here. Also, could you put the clean up/load compatibility logic in another method, this method is doing a lot.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369300197", "createdAt": "2020-01-21T23:31:58Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,7 +85,64 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootPath = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    options.setRootDir(rootPath);\n+    Path confPath = Paths.get(rootPath, CONF_FILE);\n+    boolean canLoad = false;\n+    if (Files.exists(confPath)) {\n+      Properties properties = ConfigurationUtils.loadPropertiesFromFile(confPath.toString());\n+      if (properties != null) {\n+        AlluxioProperties alluxioProperties = new AlluxioProperties();\n+        alluxioProperties.merge(properties, Source.DEFAULT);\n+        AlluxioConfiguration cacheConf = new InstancedConfiguration(alluxioProperties);\n+        // check store type\n+        if (cacheConf.get(PropertyKey.USER_CLIENT_CACHE_STORE_TYPE).equals(\n+            conf.get(PropertyKey.USER_CLIENT_CACHE_STORE_TYPE))\n+            // check page size\n+            && cacheConf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE)\n+            == conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE)\n+            // check enough cache size\n+            && cacheConf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE)\n+            <= conf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE)\n+            // check alluxio version\n+            && cacheConf.get(PropertyKey.VERSION).equals(\n+            conf.get(PropertyKey.VERSION))) {\n+          LOG.info(\"Found recoverable local cache at {}\", rootPath);\n+          canLoad = true;\n+        } else {\n+          LOG.info(\"Found local cache at {} with incompatible configuration.\", rootPath);\n+        }\n+      }\n+    }\n+    if (!canLoad) {\n+      LOG.info(\"Clean cache directory {}\", rootPath);\n+      File rootDir = new File(rootPath);\n+      try {\n+        if (Files.isDirectory(rootDir.toPath())) {\n+          FileUtils.deleteDirectory(rootDir);\n+        }\n+        FileUtils.forceMkdir(rootDir);\n+      } catch (IOException e) {\n+        throw new IllegalStateException(\n+            String.format(\"failed to clean cache directory %s\", rootDir), e);\n+      }\n+      Properties properties = new Properties();\n+      PropertyKey[] keys = new PropertyKey[]{\n+          PropertyKey.USER_CLIENT_CACHE_STORE_TYPE,\n+          PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE,\n+          PropertyKey.USER_CLIENT_CACHE_SIZE,\n+          PropertyKey.VERSION\n+      };\n+      for (PropertyKey key : keys) {\n+        properties.setProperty(key.getName(), conf.get(key));\n+      }\n+      try (FileOutputStream stream = new FileOutputStream(confPath.toString())) {\n+        properties.store(stream, \"Alluxio local cache configuration\");\n+      } catch (IOException e) {\n+        throw new IllegalStateException(\n+            String.format(\"failed to write cache configuration to file %s\", confPath), e);\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwMDU0MQ==", "bodyText": "Should we warn on files we were unable to recover? Also should we delete them?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369300541", "createdAt": "2020-01-21T23:33:18Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -111,17 +114,45 @@ private Path getFilePath(PageId pageId) {\n         Long.toString(pageId.getPageIndex()));\n   }\n \n-  @Override\n-  public void close() {\n+  /**\n+   * @param path path of a file\n+   * @return the corresponding page id, or null if the file name does not match the pattern\n+   */\n+  private PageId getPageId(Path path) {\n+    Path parent = Preconditions.checkNotNull(path.getParent());\n+    if (!Paths.get(mRoot).equals(parent.getParent())) {\n+      return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "759c7a34d4e2b6c66d3ade3fe56cf8f16ca2e760"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c719d5d6079a32f694f64d6400244a82b6327f31", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/c719d5d6079a32f694f64d6400244a82b6327f31", "committedDate": "2020-01-22T01:40:27Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/50959948f2e5b7577e5a7f1a6964ff5fdaac222f", "committedDate": "2020-01-22T18:26:53Z", "message": "fix findbugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODU0NDUy", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-346854452", "createdAt": "2020-01-22T19:44:55Z", "commit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOTo0NDo1NVrOFgovIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTowNDoyNVrOFgq7OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc2NjE3Nw==", "bodyText": "This will prevent applications like Presto to start. Shall we just try best-effort and ignore the existing pages failed to load?\nThis makes the constructor too complicated. Depending whether we want to throw Exceptions, if yes, better to  create a factory method to handle the part of code possibly throw exceptions.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369766177", "createdAt": "2020-01-22T19:44:55Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -91,6 +92,16 @@ public LocalCacheManager(FileSystemContext fsContext) {\n     for (int i = 0; i < LOCK_SIZE; i++) {\n       mPageLocks[i] = new ReentrantReadWriteLock();\n     }\n+    Collection<PageId> pages;\n+    try {\n+      pages = mPageStore.load();\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"failed to scan page cache\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3MjM0MA==", "bodyText": "nit: instead of a Collection<PageId>, is it safer & more efficient to return Iterable<PageId> in case there are too many pages or the underline PageStore implementation already provides a Iterable ?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369772340", "createdAt": "2020-01-22T19:57:42Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -120,4 +239,12 @@ ReadableByteChannel get(PageId pageId, int pageOffset) throws IOException,\n    * @return the number of pages stored\n    */\n   int size();\n+\n+  /**\n+   * Loads page store from local storage and returns all page ids.\n+   *\n+   * @return collection of ids representing all pages loaded from disk\n+   * @throws IOException if any error occurs\n+   */\n+  Collection<PageId> load() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3NDE1MA==", "bodyText": "@Nullable", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369774150", "createdAt": "2020-01-22T20:01:21Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -111,17 +114,55 @@ private Path getFilePath(PageId pageId) {\n         Long.toString(pageId.getPageIndex()));\n   }\n \n-  @Override\n-  public void close() {\n+  /**\n+   * @param path path of a file\n+   * @return the corresponding page id, or null if the file name does not match the pattern\n+   */\n+  private PageId getPageId(Path path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5NjQ5OQ==", "bodyText": "How about making the encoding/decoding between PageId & file path in util methods or a maybe even a separate class. In this way, it is much easier to maintain in the future to change the encoding scheme", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369796499", "createdAt": "2020-01-22T20:52:49Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -111,17 +114,55 @@ private Path getFilePath(PageId pageId) {\n         Long.toString(pageId.getPageIndex()));\n   }\n \n-  @Override\n-  public void close() {\n+  /**\n+   * @param path path of a file\n+   * @return the corresponding page id, or null if the file name does not match the pattern\n+   */\n+  private PageId getPageId(Path path) {\n+    Path parent = Preconditions.checkNotNull(path.getParent());\n+    if (!Paths.get(mRoot).equals(parent.getParent())) {\n+      return null;\n+    }\n     try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up local page store directory\", e);\n+      Path fileName = Preconditions.checkNotNull(path.getFileName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5ODc4OQ==", "bodyText": "same here, might be easier to maintain to have separate encoder/decoder logic or class, rather than leaving the logic in different member methods.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369798789", "createdAt": "2020-01-22T20:57:30Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -106,22 +109,45 @@ public void delete(PageId pageId) throws PageNotFoundException {\n   @Override\n   public void close() {\n     mDb.close();\n-    try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up rocksDB root directory.\");\n-    }\n   }\n \n   private byte[] getPageKey(PageId pageId) {\n-    ByteBuffer buf = ByteBuffer.allocate(16);\n+    ByteBuffer buf = ByteBuffer.allocate(KEY_LEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5OTI0MQ==", "bodyText": "add test case in LocalPageStore?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369799241", "createdAt": "2020-01-22T20:58:28Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -111,17 +114,55 @@ private Path getFilePath(PageId pageId) {\n         Long.toString(pageId.getPageIndex()));\n   }\n \n-  @Override\n-  public void close() {\n+  /**\n+   * @param path path of a file\n+   * @return the corresponding page id, or null if the file name does not match the pattern\n+   */\n+  private PageId getPageId(Path path) {\n+    Path parent = Preconditions.checkNotNull(path.getParent());\n+    if (!Paths.get(mRoot).equals(parent.getParent())) {\n+      return null;\n+    }\n     try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up local page store directory\", e);\n+      Path fileName = Preconditions.checkNotNull(path.getFileName());\n+      Path parentName = Preconditions.checkNotNull(parent.getFileName());\n+      long pageIndex = Long.parseLong(fileName.toString());\n+      long fileId = Long.parseLong(parentName.toString());\n+      return new PageId(fileId, pageIndex);\n+    } catch (NumberFormatException e) {\n+      return null;\n     }\n   }\n \n+  @Override\n+  public void close() {\n+    // no-op\n+  }\n+\n   @Override\n   public int size() {\n     return mSize.get();\n   }\n+\n+  @Override\n+  public Collection<PageId> load() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5OTQxMg==", "bodyText": "add test case in RocksPageStore?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369799412", "createdAt": "2020-01-22T20:58:52Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -106,22 +109,45 @@ public void delete(PageId pageId) throws PageNotFoundException {\n   @Override\n   public void close() {\n     mDb.close();\n-    try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up rocksDB root directory.\");\n-    }\n   }\n \n   private byte[] getPageKey(PageId pageId) {\n-    ByteBuffer buf = ByteBuffer.allocate(16);\n+    ByteBuffer buf = ByteBuffer.allocate(KEY_LEN);\n     buf.putLong(pageId.getFileId());\n     buf.putLong(pageId.getPageIndex());\n     return buf.array();\n   }\n \n+  /**\n+   * @param key key of a record\n+   * @return the corresponding page id, or null if the key does not match the pattern\n+   */\n+  private PageId getPageId(byte[] key) {\n+    if (key.length != KEY_LEN) {\n+      return null;\n+    }\n+    ByteBuffer buf = ByteBuffer.wrap(key);\n+    long fileId = buf.getLong();\n+    long pageIndex = buf.getLong();\n+    return new PageId(fileId, pageIndex);\n+  }\n+\n   @Override\n   public int size() {\n     return mSize.get();\n   }\n+\n+  @Override\n+  public Collection<PageId> load() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc5OTg3MA==", "bodyText": "why is this needed?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369799870", "createdAt": "2020-01-22T20:59:50Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "diffHunk": "@@ -67,7 +68,7 @@\n   public final ExpectedException mThrown = ExpectedException.none();\n \n   @Before\n-  public void before() {\n+  public void before() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwMjA0MA==", "bodyText": "why we need to reload the cache conf from path? Can't we trust the argument passed in?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r369802040", "createdAt": "2020-01-22T21:04:25Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -73,6 +94,104 @@ static PageStore create(AlluxioConfiguration conf) {\n     return create(options);\n   }\n \n+  /**\n+   * Checks if the data at the store location is compatible with the current configuration.\n+   *\n+   * @param conf the Alluxio configuration\n+   * @return true if the data is compatible with the configuration, false otherwise\n+   */\n+  static boolean isCompatible(AlluxioConfiguration conf) {\n+    String rootPath = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    Path confPath = Paths.get(rootPath, CONF_FILE);\n+    if (!Files.exists(confPath)) {\n+      return false;\n+    }\n+    Properties properties = ConfigurationUtils.loadPropertiesFromFile(confPath.toString());\n+    if (properties == null) {\n+      return false;\n+    }\n+    AlluxioProperties alluxioProperties = new AlluxioProperties();\n+    alluxioProperties.merge(properties, Source.DEFAULT);\n+    AlluxioConfiguration cacheConf = new InstancedConfiguration(alluxioProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50959948f2e5b7577e5a7f1a6964ff5fdaac222f"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7e4c219096d1557efcc0d3bde15ca90dd6e60a1", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a7e4c219096d1557efcc0d3bde15ca90dd6e60a1", "committedDate": "2020-01-28T01:27:11Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7e1f51da44e29e82d1a4962fba1f65103fed4e9", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/b7e1f51da44e29e82d1a4962fba1f65103fed4e9", "committedDate": "2020-01-28T19:44:53Z", "message": "fix checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc154bf5713c8319b18a2110b707544c4cec2df5", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/fc154bf5713c8319b18a2110b707544c4cec2df5", "committedDate": "2020-01-28T23:17:44Z", "message": "fix initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/9558f49d680082fff54fec8db7b2bf6da3b1c1b5", "committedDate": "2020-01-28T23:51:36Z", "message": "address more comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODQ3NDE0", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-349847414", "createdAt": "2020-01-29T03:48:53Z", "commit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzo0ODo1M1rOFi74JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzo0ODo1M1rOFi74JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3NjkzMg==", "bodyText": "nit \"pageSize the size of the page in bytes\" (is it?)", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372176932", "createdAt": "2020-01-29T03:48:53Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/PageStoreOptions.java", "diffHunk": "@@ -48,4 +63,46 @@ public void setRootDir(String rootDir) {\n   public String getRootDir() {\n     return mRootDir;\n   }\n+\n+  /**\n+   * @return the size of the page\n+   */\n+  public long getPageSize() {\n+    return mPageSize;\n+  }\n+\n+  /**\n+   * @param pageSize the size of the page", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODQ3NTMz", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-349847533", "createdAt": "2020-01-29T03:49:34Z", "commit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzo0OTozNFrOFi74iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjoyMDoxNlrOFi9q-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3NzAzMw==", "bodyText": "nit \"the size of the cache in bytes\" (is it?)", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372177033", "createdAt": "2020-01-29T03:49:34Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/PageStoreOptions.java", "diffHunk": "@@ -48,4 +63,46 @@ public void setRootDir(String rootDir) {\n   public String getRootDir() {\n     return mRootDir;\n   }\n+\n+  /**\n+   * @return the size of the page\n+   */\n+  public long getPageSize() {\n+    return mPageSize;\n+  }\n+\n+  /**\n+   * @param pageSize the size of the page\n+   */\n+  public void setPageSize(long pageSize) {\n+    mPageSize = pageSize;\n+  }\n+\n+  /**\n+   * @return the size of the cache\n+   */\n+  public long getCacheSize() {\n+    return mCacheSize;\n+  }\n+\n+  /**\n+   * @param cacheSize the size of the cache\n+   */\n+  public void setCacheSize(long cacheSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3ODc1NQ==", "bodyText": "it looks to me once the CacheManager.create failed (e.g., wrong path permission and etc), we will escalate the exception. But next time on openFile we will go through the same procedure again because sCacheManager is still null, without remembering previous failures. Maybe using memoize or memoizeWithExpiration?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372178755", "createdAt": "2020-01-29T04:00:21Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -604,11 +604,11 @@ private void initializeLocalWorker() throws IOException {\n   /**\n    * @return the client side cache manager\n    */\n-  public CacheManager getCacheManager() {\n+  public CacheManager getCacheManager() throws IOException {\n     return getCacheManager(this);\n   }\n \n-  private static CacheManager getCacheManager(FileSystemContext fsContext) {\n+  private static CacheManager getCacheManager(FileSystemContext fsContext) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3OTA4Mg==", "bodyText": "why sampling logger? do we expect a lot of openFile?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372179082", "createdAt": "2020-01-29T04:02:20Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileSystem.java", "diffHunk": "@@ -34,9 +44,15 @@ public LocalCacheFileSystem(FileSystem fs, FileSystemContext fsContext) {\n   }\n \n   @Override\n-  public FileInStream openFile(AlluxioURI path, OpenFilePOptions options) {\n+  public FileInStream openFile(AlluxioURI path, OpenFilePOptions options)\n+      throws IOException, AlluxioException {\n     // TODO(calvin): We should add another API to reduce the cost of openFile\n-    return new LocalCacheFileInStream(path, options, mDelegatedFileSystem,\n-        mFsContext.getCacheManager());\n+    try {\n+      return new LocalCacheFileInStream(path, options, mDelegatedFileSystem,\n+          mFsContext.getCacheManager());\n+    } catch (IOException e) {\n+      SAMPLING_LOGGER.warn(\"Failed to create LocalCacheFileInStream {}\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5NzEzOQ==", "bodyText": "line 86 and 102 should go to a helper method in this way it is easier to maintain and change this logic in the future.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372197139", "createdAt": "2020-01-29T05:36:49Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,10 +81,35 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootDir = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    initialize(rootDir, storeType);\n+    Path storePath = Paths.get(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR), storeType.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5NzUwNw==", "bodyText": "it looks correct to me to throw IOE here when failed to create the storePath. However, shall we also throw IOE if we failed to clean the other possible dirs?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372197507", "createdAt": "2020-01-29T05:38:27Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,10 +81,35 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootDir = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    initialize(rootDir, storeType);\n+    Path storePath = Paths.get(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR), storeType.name());\n+    options.setRootDir(storePath.toString());\n+    options.setPageSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE));\n+    options.setCacheSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE));\n+    options.setAlluxioVersion(conf.get(PropertyKey.VERSION));\n     return create(options);\n   }\n \n+  /**\n+   * Initialize a page store at the configured location.\n+   * Data from different store type will be removed.\n+   *\n+   * @param rootPath root path of the page store\n+   * @param storeType the page store type\n+   */\n+  static void initialize(String rootPath, PageStoreType storeType) throws IOException {\n+    Path storePath = Paths.get(rootPath, storeType.name());\n+    Files.createDirectories(storePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5Nzk1NQ==", "bodyText": "in general, we should avoid throw checked exceptions in a constructor --- this may leave unfinished instance creation with state hard to clean.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372197955", "createdAt": "2020-01-29T05:40:54Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -43,14 +49,35 @@\n \n   private final String mRoot;\n   private final AtomicInteger mSize = new AtomicInteger(0);\n+  private final long mPageSize;\n \n   /**\n    * Creates a new instance of {@link LocalPageStore}.\n    *\n    * @param options options for the local page store\n+   * @throws IOException when fails to create a {@link LocalPageStore}\n    */\n-  public LocalPageStore(LocalPageStoreOptions options) {\n+  public LocalPageStore(LocalPageStoreOptions options) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5OTQ2NQ==", "bodyText": "how about using regexp to parse the path and extract info from the path? The code will be shorter and more efficient", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372199465", "createdAt": "2020-01-29T05:47:58Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -107,21 +134,65 @@ public void delete(PageId pageId) throws IOException, PageNotFoundException {\n   }\n \n   private Path getFilePath(PageId pageId) {\n-    return Paths.get(mRoot, Long.toString(pageId.getFileId()),\n+    return Paths.get(mRoot, Long.toString(mPageSize), Long.toString(pageId.getFileId()),\n         Long.toString(pageId.getPageIndex()));\n   }\n \n-  @Override\n-  public void close() {\n+  /**\n+   * @param path path of a file\n+   * @return the corresponding page id, or null if the file name does not match the pattern\n+   */\n+  @Nullable\n+  private PageId getPageId(Path path) {\n+    Path parent = path.getParent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMDM4Mw==", "bodyText": "How about putting this part in the factory method.\ntypically we should keep constructor easy and clean", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372200383", "createdAt": "2020-01-29T05:52:08Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -43,14 +49,35 @@\n \n   private final String mRoot;\n   private final AtomicInteger mSize = new AtomicInteger(0);\n+  private final long mPageSize;\n \n   /**\n    * Creates a new instance of {@link LocalPageStore}.\n    *\n    * @param options options for the local page store\n+   * @throws IOException when fails to create a {@link LocalPageStore}\n    */\n-  public LocalPageStore(LocalPageStoreOptions options) {\n+  public LocalPageStore(LocalPageStoreOptions options) throws IOException {\n     mRoot = options.getRootDir();\n+    mPageSize = options.getPageSize();\n+    Path rootDir = Paths.get(mRoot);\n+    try {\n+      boolean invalidPage = Files.exists(rootDir) && Files.walk(rootDir)\n+          .filter(Files::isRegularFile)\n+          .anyMatch(path -> {\n+            if (getPageId(path) == null) {\n+              return true;\n+            }\n+            mSize.incrementAndGet();\n+            return false;\n+          });\n+      if (invalidPage || (long) mSize.get() * mPageSize > options.getCacheSize()) {\n+        FileUtils.cleanDirectory(new File(mRoot));\n+        mSize.set(0);\n+      }\n+    } catch (IOException e) {\n+      throw new IOException(String.format(\"can't initialize page store at %s\", mRoot), e);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMDkzNw==", "bodyText": "same comment here. we should avoid throwing exception for constructors", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372200937", "createdAt": "2020-01-29T05:54:56Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -48,20 +57,43 @@\n    * Creates a new instance of {@link PageStore} backed by RocksDB.\n    *\n    * @param options options for the rocks page store\n+   * @throws IOException when fails to create a {@link RocksPageStore}\n    */\n-  public RocksPageStore(RocksPageStoreOptions options) {\n+  public RocksPageStore(RocksPageStoreOptions options) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjI3MA==", "bodyText": "nits:\n\nsince this helper method requires no instance state, possibly turned into a static method. so as the next method.\nnaming: getKeyFromPageId and getPageIdFromKey to be more explicit on the function? Leaving this up to you.", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372202270", "createdAt": "2020-01-29T06:01:40Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -106,22 +138,80 @@ public void delete(PageId pageId) throws PageNotFoundException {\n   @Override\n   public void close() {\n     mDb.close();\n-    try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up rocksDB root directory.\");\n-    }\n   }\n \n   private byte[] getPageKey(PageId pageId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMzYwOA==", "bodyText": "still mark nullable", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372203608", "createdAt": "2020-01-29T06:08:27Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -106,22 +138,80 @@ public void delete(PageId pageId) throws PageNotFoundException {\n   @Override\n   public void close() {\n     mDb.close();\n-    try {\n-      FileUtils.deleteDirectory(new File(mRoot));\n-    } catch (IOException e) {\n-      LOG.warn(\"Failed to clean up rocksDB root directory.\");\n-    }\n   }\n \n   private byte[] getPageKey(PageId pageId) {\n-    ByteBuffer buf = ByteBuffer.allocate(16);\n+    ByteBuffer buf = ByteBuffer.allocate(KEY_LEN);\n     buf.putLong(pageId.getFileId());\n     buf.putLong(pageId.getPageIndex());\n     return buf.array();\n   }\n \n+  /**\n+   * @param key key of a record\n+   * @return the corresponding page id, or null if the key does not match the pattern\n+   */\n+  @Nullable\n+  private PageId getPageId(byte[] key) {\n+    if (key.length != KEY_LEN) {\n+      return null;\n+    }\n+    ByteBuffer buf = ByteBuffer.wrap(key);\n+    long fileId = buf.getLong();\n+    long pageIndex = buf.getLong();\n+    return new PageId(fileId, pageIndex);\n+  }\n+\n   @Override\n   public int size() {\n     return mSize.get();\n   }\n+\n+  @Override\n+  public Collection<PageId> getPages() {\n+    try (RocksIterator iter = mDb.newIterator()) {\n+      return Streams.stream(new PageIterator(iter)).collect(Collectors.toList());\n+    }\n+  }\n+\n+  private class PageIterator implements Iterator<PageId>, AutoCloseable {\n+    private final RocksIterator mIter;\n+    private PageId mValue;\n+\n+    PageIterator(RocksIterator iter) {\n+      mIter = iter;\n+      mIter.seekToFirst();\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+      return ensureValue() != null;\n+    }\n+\n+    @Override\n+    public PageId next() {\n+      PageId value = ensureValue();\n+      mIter.next();\n+      mValue = null;\n+      return value;\n+    }\n+\n+    private PageId ensureValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNjMzMA==", "bodyText": "all page values are the same, can we use different page content here?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r372206330", "createdAt": "2020-01-29T06:20:16Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -101,6 +112,25 @@ public void getOffsetOverflow() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getPages() throws Exception {\n+    mOptions.setRootDir(mTemp.getRoot().getAbsolutePath());\n+    int len = 32;\n+    int count = 16;\n+    byte[] data = BufferUtils.getIncreasingByteArray(len);\n+    Set<PageId> pages = new HashSet<>(count);\n+    try (PageStore store = PageStore.create(mOptions)) {\n+      for (int i = 0; i < count; i++) {\n+        PageId id = new PageId(0, i);\n+        store.put(id, data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b79fa3cd798dccb741b6edbc303894b544772c84", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/b79fa3cd798dccb741b6edbc303894b544772c84", "committedDate": "2020-01-30T00:11:12Z", "message": "address some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533e6168a5fa4c951531f5f934a57182dbbd4f4a", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/533e6168a5fa4c951531f5f934a57182dbbd4f4a", "committedDate": "2020-01-30T00:21:42Z", "message": "fix javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5ef202e90e0f74d4ffba00e12bc90df206384af8", "committedDate": "2020-01-31T00:21:37Z", "message": "extract store path getter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjU0MTk1", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-351254195", "createdAt": "2020-01-31T01:47:23Z", "commit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMTo0NzoyNFrOFj_aRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMjoxMzo1MFrOFj_ufA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4MzM5OA==", "bodyText": "nit: e.toString() see code convention here: https://docs.alluxio.io/os/user/stable/en/contributor/Code-Conventions.html#warn-log-level", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373283398", "createdAt": "2020-01-31T01:47:24Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -602,22 +603,29 @@ private void initializeLocalWorker() throws IOException {\n   }\n \n   /**\n-   * @return the client side cache manager\n+   * @return the client side cache manager, or null if failed to create the cache manager\n    */\n+  @Nullable\n   public CacheManager getCacheManager() {\n     return getCacheManager(this);\n   }\n \n+  @Nullable\n   private static CacheManager getCacheManager(FileSystemContext fsContext) {\n     // TODO(feng): support multiple cache managers\n     if (sCacheManager == null) {\n       synchronized (FileSystemContext.class) {\n         if (sCacheManager == null) {\n-          sCacheManager = CacheManager.create(fsContext);\n+          try {\n+            sCacheManager = Optional.of(CacheManager.create(fsContext));\n+          } catch (IOException e) {\n+            LOG.warn(\"Failed to create CacheManager: {}\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4NTE0NA==", "bodyText": "make sense", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373285144", "createdAt": "2020-01-31T01:56:02Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -101,6 +112,25 @@ public void getOffsetOverflow() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getPages() throws Exception {\n+    mOptions.setRootDir(mTemp.getRoot().getAbsolutePath());\n+    int len = 32;\n+    int count = 16;\n+    byte[] data = BufferUtils.getIncreasingByteArray(len);\n+    Set<PageId> pages = new HashSet<>(count);\n+    try (PageStore store = PageStore.create(mOptions)) {\n+      for (int i = 0; i < count; i++) {\n+        PageId id = new PageId(0, i);\n+        store.put(id, data);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNjMzMA=="}, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4NjMyOQ==", "bodyText": "Pattern.quote(rootDir.toString()) to escape the root path?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373286329", "createdAt": "2020-01-31T02:02:03Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -43,14 +51,38 @@\n \n   private final String mRoot;\n   private final AtomicInteger mSize = new AtomicInteger(0);\n+  private final long mPageSize;\n+  private final Pattern mPagePattern;\n \n   /**\n    * Creates a new instance of {@link LocalPageStore}.\n    *\n    * @param options options for the local page store\n+   * @throws IOException when fails to create a {@link LocalPageStore}\n    */\n-  public LocalPageStore(LocalPageStoreOptions options) {\n+  public LocalPageStore(LocalPageStoreOptions options) throws IOException {\n     mRoot = options.getRootDir();\n+    mPageSize = options.getPageSize();\n+    Path rootDir = Paths.get(mRoot);\n+    mPagePattern = Pattern.compile(\n+        String.format(\"%s/%d/(\\\\d+)/(\\\\d+)\", rootDir.toString(), mPageSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4NjUwOQ==", "bodyText": "LOG.warn this page?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373286509", "createdAt": "2020-01-31T02:02:55Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -43,14 +51,38 @@\n \n   private final String mRoot;\n   private final AtomicInteger mSize = new AtomicInteger(0);\n+  private final long mPageSize;\n+  private final Pattern mPagePattern;\n \n   /**\n    * Creates a new instance of {@link LocalPageStore}.\n    *\n    * @param options options for the local page store\n+   * @throws IOException when fails to create a {@link LocalPageStore}\n    */\n-  public LocalPageStore(LocalPageStoreOptions options) {\n+  public LocalPageStore(LocalPageStoreOptions options) throws IOException {\n     mRoot = options.getRootDir();\n+    mPageSize = options.getPageSize();\n+    Path rootDir = Paths.get(mRoot);\n+    mPagePattern = Pattern.compile(\n+        String.format(\"%s/%d/(\\\\d+)/(\\\\d+)\", rootDir.toString(), mPageSize));\n+    try {\n+      boolean invalidPage = Files.exists(rootDir) && Files.walk(rootDir)\n+          .filter(Files::isRegularFile)\n+          .anyMatch(path -> {\n+            if (getPageId(path) == null) {\n+              return true;\n+            }\n+            mSize.incrementAndGet();\n+            return false;\n+          });\n+      if (invalidPage || (long) mSize.get() * mPageSize > options.getCacheSize()) {\n+        FileUtils.cleanDirectory(new File(mRoot));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4NjcxNQ==", "bodyText": "LocalPageStore -> PageStore ?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373286715", "createdAt": "2020-01-31T02:04:00Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -20,23 +20,34 @@\n import alluxio.conf.AlluxioConfiguration;\n import alluxio.conf.PropertyKey;\n import alluxio.exception.PageNotFoundException;\n+import alluxio.util.io.FileUtils;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n import java.nio.channels.ReadableByteChannel;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n \n /**\n  * A simple abstraction on the storage to put, get and delete pages. The implementation of this\n  * class does not need to provide thread-safety.\n  */\n public interface PageStore extends AutoCloseable {\n+  Logger LOG = LoggerFactory.getLogger(LocalPageStore.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4ODIyOA==", "bodyText": "We should log warn the fallback. However, if you are concerned that the log is too frequent, we can check if getCacheManager() equals null at the factory method alluxio.client.file.FileSystem.Factory#create; in case yes, fallback to returning a normal filesystem instance even USER_LOCAL_CACHE_ENABLED is true and LOG.warn the fallback?\nThen in here, we can simply Precondition.checkNotNull(cacheManager).", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373288228", "createdAt": "2020-01-31T02:12:01Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileSystem.java", "diffHunk": "@@ -34,9 +37,14 @@ public LocalCacheFileSystem(FileSystem fs, FileSystemContext fsContext) {\n   }\n \n   @Override\n-  public FileInStream openFile(AlluxioURI path, OpenFilePOptions options) {\n+  public FileInStream openFile(AlluxioURI path, OpenFilePOptions options)\n+      throws IOException, AlluxioException {\n     // TODO(calvin): We should add another API to reduce the cost of openFile\n+    CacheManager cacheManager = mFsContext.getCacheManager();\n+    if (cacheManager == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4ODQ3MQ==", "bodyText": "ack", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373288471", "createdAt": "2020-01-31T02:13:20Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,10 +81,35 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootDir = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    initialize(rootDir, storeType);\n+    Path storePath = Paths.get(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR), storeType.name());\n+    options.setRootDir(storePath.toString());\n+    options.setPageSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE));\n+    options.setCacheSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE));\n+    options.setAlluxioVersion(conf.get(PropertyKey.VERSION));\n     return create(options);\n   }\n \n+  /**\n+   * Initialize a page store at the configured location.\n+   * Data from different store type will be removed.\n+   *\n+   * @param rootPath root path of the page store\n+   * @param storeType the page store type\n+   */\n+  static void initialize(String rootPath, PageStoreType storeType) throws IOException {\n+    Path storePath = Paths.get(rootPath, storeType.name());\n+    Files.createDirectories(storePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5NzUwNw=="}, "originalCommit": {"oid": "9558f49d680082fff54fec8db7b2bf6da3b1c1b5"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4ODU3Mg==", "bodyText": "same case for https://docs.alluxio.io/os/user/stable/en/contributor/Code-Conventions.html#warn-log-level", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r373288572", "createdAt": "2020-01-31T02:13:50Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -69,10 +80,50 @@ static PageStore create(AlluxioConfiguration conf) {\n         throw new IllegalArgumentException(String.format(\"Unrecognized store type %s\",\n             storeType.name()));\n     }\n-    options.setRootDir(conf.get(PropertyKey.USER_CLIENT_CACHE_DIR));\n+    String rootDir = conf.get(PropertyKey.USER_CLIENT_CACHE_DIR);\n+    initialize(rootDir, storeType);\n+    Path storePath = getStorePath(storeType, rootDir);\n+    options.setRootDir(storePath.toString());\n+    options.setPageSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE));\n+    options.setCacheSize(conf.getBytes(PropertyKey.USER_CLIENT_CACHE_SIZE));\n+    options.setAlluxioVersion(conf.get(PropertyKey.VERSION));\n     return create(options);\n   }\n \n+  /**\n+   * Gets store path given root directory and store type.\n+   *\n+   * @param storeType the type of the page store\n+   * @param rootDir the root directory path\n+   * @return the store directory path\n+   */\n+  static Path getStorePath(PageStoreType storeType, String rootDir) {\n+    return Paths.get(rootDir, storeType.name());\n+  }\n+\n+  /**\n+   * Initialize a page store at the configured location.\n+   * Data from different store type will be removed.\n+   *\n+   * @param rootPath root path of the page store\n+   * @param storeType the page store type\n+   */\n+  static void initialize(String rootPath, PageStoreType storeType) throws IOException {\n+    Path storePath = getStorePath(storeType, rootPath);\n+    Files.createDirectories(storePath);\n+    LOG.info(\"Clean cache directory {}\", rootPath);\n+    try (Stream<Path> stream = Files.list(Paths.get(rootPath))) {\n+      stream.filter(path -> !storePath.equals(path))\n+          .forEach(path -> {\n+            try {\n+              FileUtils.deletePathRecursively(path.toString());\n+            } catch (IOException e) {\n+              LOG.warn(\"failed to delete {} in cache directory: {}\", path, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "057c5e194684c640b3eed6e1c4bc0157f1fe5795", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/057c5e194684c640b3eed6e1c4bc0157f1fe5795", "committedDate": "2020-02-03T22:48:25Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTg3MDY1", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-352587065", "createdAt": "2020-02-03T21:48:45Z", "commit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo0ODo0NlrOFlBIrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo1MDozNlrOFlBMFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MDIzNg==", "bodyText": "I don't see the benefit of using optional here since we are defaulting to null anyway?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r374360236", "createdAt": "2020-02-03T21:48:46Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -92,7 +93,7 @@\n   /**\n    * The local cache manager for the file system.\n    */\n-  private static volatile CacheManager sCacheManager;\n+  private static volatile Optional<CacheManager> sCacheManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MTExMA==", "bodyText": "It is strange that the interface's create method instantiates a specific implementation?", "url": "https://github.com/Alluxio/alluxio/pull/10776#discussion_r374361110", "createdAt": "2020-02-03T21:50:36Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java", "diffHunk": "@@ -22,13 +22,13 @@\n /**\n  * Interface for managing cached pages.\n  */\n-public interface CacheManager {\n+public interface CacheManager extends AutoCloseable  {\n   /**\n    * @param fsContext filesystem context\n    * @return an instance of {@link CacheManager}\n    */\n-  static CacheManager create(FileSystemContext fsContext) {\n-    return new LocalCacheManager(fsContext);\n+  static CacheManager create(FileSystemContext fsContext) throws IOException {\n+    return LocalCacheManager.create(fsContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ef202e90e0f74d4ffba00e12bc90df206384af8"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f378b8c647deef5fcb879a2572108b97697eb5", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a1f378b8c647deef5fcb879a2572108b97697eb5", "committedDate": "2020-02-03T23:20:32Z", "message": "Add a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjM5Mjgw", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-352639280", "createdAt": "2020-02-03T23:38:17Z", "commit": {"oid": "a1f378b8c647deef5fcb879a2572108b97697eb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1bb7024a0387bfb78226408912b0e84c24003e1", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f1bb7024a0387bfb78226408912b0e84c24003e1", "committedDate": "2020-02-04T23:39:55Z", "message": "Merge branch 'lite' into lite-recovery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c87e82666410b67113236ef30b9fecc79f1828fe", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/c87e82666410b67113236ef30b9fecc79f1828fe", "committedDate": "2020-02-05T00:00:56Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTgzMTY5", "url": "https://github.com/Alluxio/alluxio/pull/10776#pullrequestreview-355583169", "createdAt": "2020-02-09T04:32:34Z", "commit": {"oid": "c87e82666410b67113236ef30b9fecc79f1828fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3119, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}