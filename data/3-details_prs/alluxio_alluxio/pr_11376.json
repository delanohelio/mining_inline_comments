{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTg0MDQz", "number": 11376, "title": "Improve PR build by inspecting PR diff", "bodyText": "we currently use this jenkins plugin to run our PR build checks: https://plugins.jenkins.io/ghprb/\nthe plugin defines an environment variable for the target branch that the PR is going to merge into. that means we can run git --no-pager diff origin/master --name-only to get a list of files that were changed in the PR. note this change also required a few tweaks to the jenkins job, most importantly the addition of pulling more refs so i can reference the ref marked as origin/master\nsince we have two checks, one for the maven build and one for docs, i defined two booleans that get set to true if a corresponding file is found in the diff. if this target branch variable is not available, it defaults to running all checks.\nif there are more files or folders that we can incorporate into the diff check, we can waste less cycles running irrelevant checks", "createdAt": "2020-05-03T10:53:40Z", "url": "https://github.com/Alluxio/alluxio/pull/11376", "merged": true, "mergeCommit": {"oid": "8141b60f9eaf52dcccc5995364da356474f6b0c5"}, "closed": true, "closedAt": "2020-05-05T18:41:38Z", "author": {"login": "Xenorith"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdoiiogH2gAyNDEyNTg0MDQzOmI1NWJhNzllZmFlNTM0NWEzZDMxNzk5NGE4MjI4NjI1ZDgyNTVmNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceW6rkgFqTQwNTk2OTk5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b55ba79efae5345a3d317994a8228625d8255f64", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/b55ba79efae5345a3d317994a8228625d8255f64", "committedDate": "2020-05-03T10:43:49Z", "message": "Improve PR build by inspecting PR diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2cbded6e2fa535cc81d6431851dc4c7af0b12bc", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/a2cbded6e2fa535cc81d6431851dc4c7af0b12bc", "committedDate": "2020-05-03T11:53:15Z", "message": "set -x in build scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a89320d23327019871e4470c030410566ad2fadf", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/a89320d23327019871e4470c030410566ad2fadf", "committedDate": "2020-05-04T08:49:35Z", "message": "use refs/remotes/ prefix for diff target"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67c101874f9c052e8f83ee2304c851ff586b7b0e", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/67c101874f9c052e8f83ee2304c851ff586b7b0e", "committedDate": "2020-05-04T09:20:13Z", "message": "debug cuz i think it should be working..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/ebd4fc28e25bc7c5355841e503d4877b7520b50d", "committedDate": "2020-05-04T09:51:48Z", "message": "remove debug lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mjg1NjY2", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405285666", "createdAt": "2020-05-04T19:33:42Z", "commit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTozMzo0M1rOGQPFZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTozNDoxNlrOGQPGsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3NzU0Mw==", "bodyText": "what about the case where there is no diff, and we simply want to generate the jacoco report?", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419677543", "createdAt": "2020-05-04T19:33:43Z", "author": {"login": "ZacBlanco"}, "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then\n+      # if any file starts with \"docs/\", run doc check\n+      RUN_DOC_CHECK=\"true\"\n+    else\n+      # if any other files are in the diff, run maven\n+      RUN_MAVEN=\"true\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3Nzg3Mw==", "bodyText": "similarly, if there's no files in the diff and we just want to generate sonar reports, how will we do that now?", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419677873", "createdAt": "2020-05-04T19:34:16Z", "author": {"login": "ZacBlanco"}, "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then\n+      # if any file starts with \"docs/\", run doc check\n+      RUN_DOC_CHECK=\"true\"\n+    else\n+      # if any other files are in the diff, run maven\n+      RUN_MAVEN=\"true\"\n+    fi\n+  done < prFiles.diff\n+  rm prFiles.diff\n fi\n \n-./dev/scripts/check-docs.sh\n+if [ \"$RUN_MAVEN\" == \"true\" ]; then\n+  # Set things up so that the current user has a real name and can authenticate.\n+  myuid=$(id -u)\n+  mygid=$(id -g)\n+  echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n+\n+  export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n+\n+  if [ -z \"${ALLUXIO_BUILD_FORKCOUNT}\" ]\n+  then\n+    ALLUXIO_BUILD_FORKCOUNT=4\n+  fi\n+\n+  mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n+\n+  if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n+  then\n+    # A separate step to run jacoco report, with all the generated coverage data. This requires the\n+    # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n+    #\n+    # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n+    # since these modules do not contain any source code to track for code coverage.\n+    mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n+    # run sonar analysis\n+    mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+  fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzY1OTA4", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405365908", "createdAt": "2020-05-04T21:36:33Z", "commit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMTozNjozM1rOGQTIcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMTozNjozM1rOGQTIcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0Mzg1OA==", "bodyText": "@ZacBlanco i think this check addresses the scenario for the master builds. if this script isn't invoked by the PR build, this env var won't be set => defaults to running everything", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419743858", "createdAt": "2020-05-04T21:36:33Z", "author": {"login": "Xenorith"}, "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzczMjM4", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405373238", "createdAt": "2020-05-04T21:49:28Z", "commit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mzg2OTIx", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405386921", "createdAt": "2020-05-04T22:17:19Z", "commit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjoxNzoxOVrOGQUPBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjoxNzoxOVrOGQUPBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MTkyNg==", "bodyText": "@Xenorith the following under integration also do not require a maven build: dataproc, docker, emr, kuberneres, vagrant", "url": "https://github.com/Alluxio/alluxio/pull/11376#discussion_r419761926", "createdAt": "2020-05-04T22:17:19Z", "author": {"login": "madanadit"}, "path": "dev/jenkins/build.sh", "diffHunk": "@@ -13,36 +13,68 @@\n #\n # This script is run from inside the Docker container\n #\n-set -e\n-\n-# Set things up so that the current user has a real name and can authenticate.\n-myuid=$(id -u)\n-mygid=$(id -g)\n-echo \"$myuid:x:$myuid:$mygid:anonymous uid:/home/jenkins:/bin/false\" >> /etc/passwd\n-\n-export MAVEN_OPTS=\"-Dorg.slf4j.simpleLogger.showDateTime=true -Dorg.slf4j.simpleLogger.dateTimeFormat=HH:mm:ss.SSS\"\n-\n-if [ -z ${ALLUXIO_BUILD_FORKCOUNT} ]\n-then\n-  ALLUXIO_BUILD_FORKCOUNT=4\n-fi\n+set -ex\n \n if [ -n \"${ALLUXIO_GIT_CLEAN}\" ]\n then\n   git clean -fdx\n fi\n-mvn -Duser.home=/home/jenkins -T 4C clean install -Pdeveloper -Dmaven.javadoc.skip -Dsurefire.forkCount=${ALLUXIO_BUILD_FORKCOUNT} $@\n \n-if [ -n \"${ALLUXIO_SONAR_ARGS}\" ]\n-then\n-  # A separate step to run jacoco report, with all the generated coverage data. This requires the\n-  # previous 'install' step to generate the jacoco exec data with the 'jacoco' profile.\n-  #\n-  # Must exclude some of the modules that fail to run verify again without a clean step. This is ok\n-  # since these modules do not contain any source code to track for code coverage.\n-  mvn -T 4C -Dfindbugs.skip -Dcheckstyle.skip -DskipTests -Dmaven.javadoc.skip -Dlicense.skip -PjacocoReport verify -pl '!webui,!shaded,!shaded/client,!shaded/hadoop'\n-  # run sonar analysis\n-  mvn $(echo \"${ALLUXIO_SONAR_ARGS}\") sonar:sonar\n+RUN_MAVEN=\"false\"\n+RUN_DOC_CHECK=\"false\"\n+if [ -z \"${TARGET_BRANCH}\" ]; then\n+  # if no target branch is specified, run all checks\n+  RUN_MAVEN=\"true\"\n+  RUN_DOC_CHECK=\"true\"\n+else\n+  git --no-pager diff \"refs/remotes/origin/${TARGET_BRANCH}\" --name-only > prFiles.diff\n+  echo \"PR diff is:\"\n+  cat prFiles.diff\n+\n+  while IFS=\"\" read -r filepath || [ -n \"$filepath\" ]; do\n+    if [[ ${filepath} =~ ^docs/.* ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd4fc28e25bc7c5355841e503d4877b7520b50d"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e59bd26c1a08dd7482bd5dfabe0e8ce4855aad42", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e59bd26c1a08dd7482bd5dfabe0e8ce4855aad42", "committedDate": "2020-05-04T22:33:33Z", "message": "exclude some integration folders from check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mzk1NDg2", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405395486", "createdAt": "2020-05-04T22:37:08Z", "commit": {"oid": "e59bd26c1a08dd7482bd5dfabe0e8ce4855aad42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a75a936443136353078b20888bd5a72bfff9a01e", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/a75a936443136353078b20888bd5a72bfff9a01e", "committedDate": "2020-05-04T23:50:13Z", "message": "force run all checks if modifying dev/"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be529693ea65a5de3fd13a330ec8182d1452c67", "author": {"user": {"login": "Xenorith", "name": "Rico Chiu"}}, "url": "https://github.com/Alluxio/alluxio/commit/8be529693ea65a5de3fd13a330ec8182d1452c67", "committedDate": "2020-05-04T23:55:11Z", "message": "woops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTY5OTkz", "url": "https://github.com/Alluxio/alluxio/pull/11376#pullrequestreview-405969993", "createdAt": "2020-05-05T16:45:49Z", "commit": {"oid": "8be529693ea65a5de3fd13a330ec8182d1452c67"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4584, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}