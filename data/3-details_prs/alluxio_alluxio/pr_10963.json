{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDEyMjQz", "number": 10963, "title": "Cache the getWorkerInfoList results and refresh periodically", "bodyText": "getWorkerInfoList() is fast by itself, but it requires all the live worker locks and may introduce contention.\nOur clients and job servers need to use getWorkerinfoList() to select job executor, find local hostnames or know which worker to read from/write to. A large amount of getWorkerInfoList call may be triggered. Cache the worker info list and refresh periodically can help prevent those heavy load and lock contention", "createdAt": "2020-02-20T22:44:00Z", "url": "https://github.com/Alluxio/alluxio/pull/10963", "merged": true, "mergeCommit": {"oid": "d587b031c3ace1e5d915f73079ed6d363fca31f7"}, "closed": true, "closedAt": "2020-02-22T01:26:13Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGTCczAH2gAyMzc4MDEyMjQzOmZmZDcwYTQzODA2MzYyNzRhYTlkMzQ1ZGI5ZTY0ZjA2YjIyODViZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGpqEQgFqTM2Mjk5NDYxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ffd70a4380636274aa9d345db9e64f06b2285bd7", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/ffd70a4380636274aa9d345db9e64f06b2285bd7", "committedDate": "2020-02-20T22:40:30Z", "message": "Cache the getWorkerInfoList results and refresh periodically"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjk5NTYz", "url": "https://github.com/Alluxio/alluxio/pull/10963#pullrequestreview-362299563", "createdAt": "2020-02-20T23:07:56Z", "commit": {"oid": "ffd70a4380636274aa9d345db9e64f06b2285bd7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzowNzo1N1rOFsmUxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzowOTo0NFrOFsmW-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMwOTU3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          + \"after being cached for this time period. \")\n          \n          \n            \n                          + \"after being cached for this time period.\")\n          \n      \n    \n    \n  \n\nAlso, can you add what the implications may be if it is too short, and too long?", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382309575", "createdAt": "2020-02-20T23:07:57Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2079,6 +2079,14 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.MASTER)\n               .build();\n+  public static final PropertyKey MASTER_WORKER_INFO_CACHE_REFRESH_TIME =\n+      new Builder(Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME)\n+          .setDefaultValue(\"10sec\")\n+          .setDescription(\"The worker information list will be refreshed \"\n+              + \"after being cached for this time period. \")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffd70a4380636274aa9d345db9e64f06b2285bd7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMDEzNg==", "bodyText": "Can we include the information from e in this exception message?", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382310136", "createdAt": "2020-02-20T23:09:44Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/block/DefaultBlockMaster.java", "diffHunk": "@@ -407,6 +431,14 @@ public long getUsedBytes() {\n     if (mSafeModeManager.isInSafeMode()) {\n       throw new UnavailableException(ExceptionMessage.MASTER_IN_SAFEMODE.getMessage());\n     }\n+    try {\n+      return mWorkerInfoCache.get(WORKER_INFO_CACHE_KEY);\n+    } catch (ExecutionException e) {\n+      throw new UnavailableException(\"Unable to get worker info list from cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffd70a4380636274aa9d345db9e64f06b2285bd7"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7125ccaabdf6bcd42e41d788eccb63019d7ea796", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7125ccaabdf6bcd42e41d788eccb63019d7ea796", "committedDate": "2020-02-20T23:49:16Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e87cd8567042e98597a652a5369a865fb4caaf72", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/e87cd8567042e98597a652a5369a865fb4caaf72", "committedDate": "2020-02-21T03:07:31Z", "message": "Add property key description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODI5NDY3", "url": "https://github.com/Alluxio/alluxio/pull/10963#pullrequestreview-362829467", "createdAt": "2020-02-21T18:29:51Z", "commit": {"oid": "e87cd8567042e98597a652a5369a865fb4caaf72"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoyOTo1MVrOFtAdQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODozMDoxMFrOFtAd4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNzcyOQ==", "bodyText": "should all integration tests just use a shorter refresh time, like 20ms?", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382737729", "createdAt": "2020-02-21T18:29:51Z", "author": {"login": "gpang"}, "path": "core/common/src/test/java/alluxio/ConfigurationTestUtils.java", "diffHunk": "@@ -140,6 +140,9 @@ public static InstancedConfiguration defaults() {\n     conf.put(PropertyKey.MASTER_PERSISTENCE_INITIAL_INTERVAL_MS, \"20ms\");\n     conf.put(PropertyKey.MASTER_PERSISTENCE_SCHEDULER_INTERVAL_MS, \"20ms\");\n \n+    // faster refresh\n+    conf.put(PropertyKey.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"100ms\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87cd8567042e98597a652a5369a865fb4caaf72"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNzg4OQ==", "bodyText": "if the test config has a faster time, this doesn't have to be set, right?", "url": "https://github.com/Alluxio/alluxio/pull/10963#discussion_r382737889", "createdAt": "2020-02-21T18:30:10Z", "author": {"login": "gpang"}, "path": "tests/src/test/java/alluxio/client/fs/FileOutStreamAsyncWriteIntegrationTest.java", "diffHunk": "@@ -174,7 +175,8 @@ public void asyncWriteNoEvictBeforeBlockCommit() throws Exception {\n       PropertyKey.Name.USER_FILE_PERSISTENCE_INITIAL_WAIT_TIME, \"1min\",\n       PropertyKey.Name.WORKER_MEMORY_SIZE, TINY_WORKER_MEM,\n       PropertyKey.Name.USER_BLOCK_SIZE_BYTES_DEFAULT, TINY_BLOCK_SIZE,\n-      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\"\n+      PropertyKey.Name.USER_FILE_BUFFER_BYTES, \"8k\",\n+      PropertyKey.Name.MASTER_WORKER_INFO_CACHE_REFRESH_TIME, \"20ms\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87cd8567042e98597a652a5369a865fb4caaf72"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81933bd207e6a683b602389feb35daaeb4c216b5", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/81933bd207e6a683b602389feb35daaeb4c216b5", "committedDate": "2020-02-21T19:05:59Z", "message": "Change all the cache refresh time to 20ms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967c855351167a5aad3218e8e4f60060540d5a4d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/967c855351167a5aad3218e8e4f60060540d5a4d", "committedDate": "2020-02-21T23:16:59Z", "message": "Remove change for AsyncWriteIntegrationTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "822a19ded54356463ea128823e6413f06c06392d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/822a19ded54356463ea128823e6413f06c06392d", "committedDate": "2020-02-21T23:10:29Z", "message": "Change refresh time in tests back to 100ms"}, "afterCommit": {"oid": "967c855351167a5aad3218e8e4f60060540d5a4d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/967c855351167a5aad3218e8e4f60060540d5a4d", "committedDate": "2020-02-21T23:16:59Z", "message": "Remove change for AsyncWriteIntegrationTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a68b2d4d538aca56bf195baccf2035c513bb43c", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/2a68b2d4d538aca56bf195baccf2035c513bb43c", "committedDate": "2020-02-22T00:04:58Z", "message": "Merge remote-tracking branch 'upstream/master' into cacheGetWorker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk0NjE5", "url": "https://github.com/Alluxio/alluxio/pull/10963#pullrequestreview-362994619", "createdAt": "2020-02-22T01:01:41Z", "commit": {"oid": "2a68b2d4d538aca56bf195baccf2035c513bb43c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4868, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}