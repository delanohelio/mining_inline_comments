{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1OTcyMzQy", "number": 11151, "title": "Implement async write into local cache", "bodyText": "", "createdAt": "2020-03-10T07:14:56Z", "url": "https://github.com/Alluxio/alluxio/pull/11151", "merged": true, "mergeCommit": {"oid": "ba9756c552ed2a3ff1668508edcd4dc1e814456c"}, "closed": true, "closedAt": "2020-03-12T20:00:57Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMNK72gH2gAyMzg1OTcyMzQyOjNlNGU5ZDUwMjc3ZmY0ZWNlYmQ5MjVkYmRlNDZlZGM3NjJhYzM4NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNAD7HgH2gAyMzg1OTcyMzQyOmJiMjA4M2FmZTJlODRkZmJhMjM2MGJlYTY3OWZmYjEwNjNiNmM4YTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e4e9d50277ff4ecebd925dbde46edc762ac3846", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/3e4e9d50277ff4ecebd925dbde46edc762ac3846", "committedDate": "2020-03-10T07:13:53Z", "message": "Implement async write into local cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f705e263cbb018c9bdfefbc02b8960be5457c99c", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/f705e263cbb018c9bdfefbc02b8960be5457c99c", "committedDate": "2020-03-10T22:35:48Z", "message": "Fix style check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDI1OTUz", "url": "https://github.com/Alluxio/alluxio/pull/11151#pullrequestreview-373025953", "createdAt": "2020-03-11T18:36:38Z", "commit": {"oid": "f705e263cbb018c9bdfefbc02b8960be5457c99c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxODozNjozOFrOF1D6XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxODo0MDowOFrOF1EB8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4Mjk0MQ==", "bodyText": "Since we are using a synchronous queue, should we set core threads to # of async write threads?", "url": "https://github.com/Alluxio/alluxio/pull/11151#discussion_r391182941", "createdAt": "2020-03-11T18:36:38Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -156,16 +165,22 @@ public static LocalCacheManager create(AlluxioConfiguration conf) throws IOExcep\n    * @param pageStore the page store manages the cache data\n    */\n   @VisibleForTesting\n-  LocalCacheManager(AlluxioConfiguration conf, MetaStore metaStore,\n-      PageStore pageStore, CacheEvictor evictor) {\n+  LocalCacheManager(AlluxioConfiguration conf, MetaStore metaStore, PageStore pageStore,\n+      CacheEvictor evictor) {\n     mMetaStore = metaStore;\n     mPageStore = pageStore;\n     mEvictor = evictor;\n     mPageSize = conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE);\n+    mAsyncWrite = conf.getBoolean(PropertyKey.USER_CLIENT_CACHE_ASYNC_WRITE_ENABLED);\n     mCacheSize = pageStore.getCacheSize();\n     for (int i = 0; i < LOCK_SIZE; i++) {\n       mPageLocks[i] = new ReentrantReadWriteLock();\n     }\n+    mPendingRequests = new ConcurrentHashSet<>();\n+    mAsyncCacheExecutor = mAsyncWrite\n+        ? new ThreadPoolExecutor(0, conf.getInt(PropertyKey.USER_CLIENT_CACHE_ASYNC_WRITE_THREADS),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f705e263cbb018c9bdfefbc02b8960be5457c99c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4MzQ3NQ==", "bodyText": "Simplify this by logging a succeeded field?", "url": "https://github.com/Alluxio/alluxio/pull/11151#discussion_r391183475", "createdAt": "2020-03-11T18:37:36Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -209,6 +224,40 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public boolean put(PageId pageId, byte[] page) {\n     LOG.debug(\"put({},{} bytes) enters\", pageId, page.length);\n+    if (!mAsyncWrite) {\n+      boolean inserted = putInternal(pageId, page);\n+      if (inserted) {\n+        LOG.debug(\"put({},{} bytes) exits\", pageId, page.length);\n+      } else {\n+        LOG.debug(\"put({},{} bytes) fails\", pageId, page.length);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f705e263cbb018c9bdfefbc02b8960be5457c99c"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4NDg4MA==", "bodyText": "Could we add metrics?", "url": "https://github.com/Alluxio/alluxio/pull/11151#discussion_r391184880", "createdAt": "2020-03-11T18:40:08Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -209,6 +224,40 @@ private ReadWriteLock getPageLock(PageId pageId) {\n   @Override\n   public boolean put(PageId pageId, byte[] page) {\n     LOG.debug(\"put({},{} bytes) enters\", pageId, page.length);\n+    if (!mAsyncWrite) {\n+      boolean inserted = putInternal(pageId, page);\n+      if (inserted) {\n+        LOG.debug(\"put({},{} bytes) exits\", pageId, page.length);\n+      } else {\n+        LOG.debug(\"put({},{} bytes) fails\", pageId, page.length);\n+      }\n+      return inserted;\n+    }\n+\n+    if (!mPendingRequests.add(pageId)) { // already queued\n+      return false;\n+    }\n+    try {\n+      mAsyncCacheExecutor.submit(() -> {\n+        try {\n+          putInternal(pageId, page);\n+        } finally {\n+          mPendingRequests.remove(pageId);\n+        }\n+      });\n+    } catch (RejectedExecutionException e) { // queue is full, skip\n+      // RejectedExecutionException may be thrown in extreme cases when the\n+      // highly concurrent caching workloads. In these cases, return false\n+      mPendingRequests.remove(pageId);\n+      LOG.debug(\"put({},{} bytes) fails due to full queue\", pageId, page.length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f705e263cbb018c9bdfefbc02b8960be5457c99c"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6394c27fcb56072f02796f9456cf674786258b6", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/d6394c27fcb56072f02796f9456cf674786258b6", "committedDate": "2020-03-11T21:31:05Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8989f2e7ad5ac02164ba34537f98982e051282", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/1a8989f2e7ad5ac02164ba34537f98982e051282", "committedDate": "2020-03-11T21:41:13Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTY1MTk3", "url": "https://github.com/Alluxio/alluxio/pull/11151#pullrequestreview-373165197", "createdAt": "2020-03-11T22:17:11Z", "commit": {"oid": "1a8989f2e7ad5ac02164ba34537f98982e051282"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjoxNzoxMVrOF1LJIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjoxNzoxMVrOF1LJIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwMTQwOA==", "bodyText": "checkstyle?", "url": "https://github.com/Alluxio/alluxio/pull/11151#discussion_r391301408", "createdAt": "2020-03-11T22:17:11Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -173,14 +173,16 @@ public static LocalCacheManager create(AlluxioConfiguration conf) throws IOExcep\n     mPageSize = conf.getBytes(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE);\n     mAsyncWrite = conf.getBoolean(PropertyKey.USER_CLIENT_CACHE_ASYNC_WRITE_ENABLED);\n     mCacheSize = pageStore.getCacheSize();\n-    for (int i = 0; i < LOCK_SIZE; i++) {\n+    for (int i = 0; i < LOCK_SIZE; i ++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a8989f2e7ad5ac02164ba34537f98982e051282"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTY2OTE3", "url": "https://github.com/Alluxio/alluxio/pull/11151#pullrequestreview-373166917", "createdAt": "2020-03-11T22:21:17Z", "commit": {"oid": "1a8989f2e7ad5ac02164ba34537f98982e051282"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29e105e6a8d5b96a8a20cc485da10e2ff1ad0c1", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/b29e105e6a8d5b96a8a20cc485da10e2ff1ad0c1", "committedDate": "2020-03-11T22:31:08Z", "message": "Update LocalCacheManager.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2083afe2e84dfba2360bea679ffb1063b6c8a2", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/bb2083afe2e84dfba2360bea679ffb1063b6c8a2", "committedDate": "2020-03-12T18:31:23Z", "message": "Fix integration tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4846, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}