{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTQ0NDU3", "number": 12658, "title": "Change to journal large table partitions separately", "bodyText": "One of the PRs target to solve issue #12356\nIn the previous implementation, each table is considered as a single journal entry.\nWhen a table has thousands of partitions, the journal entry size can be bigger than 30MB (an example journal entry with about 4000 partitions takes 31MB disk space).\nAlluxio embedded journal raft library - Ratis currently hard-coded the largest journal entry as 30MB which means that all journal entries bigger than 30MB is not allowed in the read path.\nThis PR change from journaling a table with a single big entry to multiple smaller entries by journaling table partitions in different entries.\nTable entries in backup files created before this change are still big entries with all table partitions. Restoring from those backups or restarting the leading master will not be resolved by this PR. This change mainly takes effect when loading table meta into Alluxio for the first time.", "createdAt": "2020-12-17T01:40:30Z", "url": "https://github.com/Alluxio/alluxio/pull/12658", "merged": true, "mergeCommit": {"oid": "d5281a1e58741fa5bf655cc2e35b01a9168ab1bd"}, "closed": true, "closedAt": "2021-01-05T19:12:45Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm5WinAH2gAyNTQxNTQ0NDU3OmZjMTk3NzRjNzg5MDhiNWY0OWM1ZWI4M2QyMTc3OWQ4MGZkM2I1OTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtPtRRgFqTU2MjA1MjM1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc19774c78908b5f49c5eb83d21779d80fd3b596", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/fc19774c78908b5f49c5eb83d21779d80fd3b596", "committedDate": "2020-12-17T01:35:34Z", "message": "Change to journal large table partitions separately"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/02216917292bb32fa22e419fa41eb2cd53fce96b", "committedDate": "2020-12-17T04:47:39Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0OTk1NzUz", "url": "https://github.com/Alluxio/alluxio/pull/12658#pullrequestreview-554995753", "createdAt": "2020-12-17T21:19:11Z", "commit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMToxOToxMVrOIIJMrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMTo0NjowN1rOIIKByQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMDIyMA==", "bodyText": "I think AlluxioCatalog also needs this: https://github.com/Alluxio/alluxio/blob/master/table/server/master/src/main/java/alluxio/master/table/AlluxioCatalog.java#L390", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545410220", "createdAt": "2020-12-17T21:19:11Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -349,6 +355,9 @@ private boolean processJournalEntryInternal(Journal.JournalEntry entry,\n     if (entry.hasAddTable()) {\n       return applyAddTable(context, entry);\n     }\n+    if (entry.hasAddTablePartitions()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMjc1Ng==", "bodyText": "Instead of 1 table iterator and partition list, should we just have a table iterator, and partition iterator? Everything the partition iterator is empty() we just move on to the next table and get the next partition iterator?\nIt seems like mixing an iterator and a list is a bit confusing to follow.", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545422756", "createdAt": "2020-12-17T21:44:04Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -467,14 +508,55 @@ public boolean hasNext() {\n         }\n         Table table = mEntry;\n         mEntry = null;\n-        alluxio.proto.journal.Table.AddTableEntry addTableEntry = table.toJournalProto();\n+        alluxio.proto.journal.Table.AddTableEntry addTableEntry = table.getTableJournalProto();\n         return Journal.JournalEntry.newBuilder().setAddTable(addTableEntry).build();\n       }\n \n       @Override\n       public void remove() {\n         throw new UnsupportedOperationException(\n-            \"GetTableIteratorr#Iterator#remove is not supported.\");\n+            \"GetTableIterator#Iterator#remove is not supported.\");\n+      }\n+    };\n+  }\n+\n+  private Iterator<Journal.JournalEntry> getTablePartitionsIterator() {\n+    final Iterator<Table> it = getTables().iterator();\n+    return new Iterator<Journal.JournalEntry>() {\n+      private List<alluxio.proto.journal.Table.AddTablePartitionsEntry> mPartitionsEntries", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzA1OA==", "bodyText": "Is it perfectly fine output all the tables and then all the individual partition batches?", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423058", "createdAt": "2020-12-17T21:44:41Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -484,7 +566,8 @@ public void remove() {\n     Journal.JournalEntry entry = Journal.JournalEntry.newBuilder().setUpdateDatabaseInfo(\n         toJournalProto(getDatabaseInfo(), mName)).build();\n     return CloseableIterator.noopCloseable(\n-        Iterators.concat(Iterators.singletonIterator(entry), getTableIterator()));\n+        Iterators.concat(Iterators.singletonIterator(entry),\n+            getTableIterator(), getTablePartitionsIterator()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzQxMQ==", "bodyText": "What does this comment mean? What is being removed?", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423411", "createdAt": "2020-12-17T21:45:20Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzY1Mw==", "bodyText": "can we also add the # partitions we are adding in the message?", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423653", "createdAt": "2020-12-17T21:45:49Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version\n+          LOG.info(\"Adding partitions to table {}.{}\", mName, addTablePartitions.getTableName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMzgxNw==", "bodyText": "We are not deleting right?", "url": "https://github.com/Alluxio/alluxio/pull/12658#discussion_r545423817", "createdAt": "2020-12-17T21:46:07Z", "author": {"login": "gpang"}, "path": "table/server/master/src/main/java/alluxio/master/table/Database.java", "diffHunk": "@@ -410,6 +419,38 @@ private boolean applyAddTable(@Nullable JournalContext context, Journal.JournalE\n     return true;\n   }\n \n+  private boolean applyAddTablePartitions(@Nullable JournalContext context,\n+      Journal.JournalEntry entry) {\n+    alluxio.proto.journal.Table.AddTablePartitionsEntry addTablePartitions\n+        = entry.getAddTablePartitions();\n+    if (!addTablePartitions.getDbName().equals(mName)) {\n+      return false;\n+    }\n+\n+    mTables.compute(addTablePartitions.getTableName(), (key, existingTable) -> {\n+      if (existingTable != null) {\n+        if (addTablePartitions.getVersion() == existingTable.getVersion()) {\n+          // this table is being removed, and has the expected version\n+          LOG.info(\"Adding partitions to table {}.{}\", mName, addTablePartitions.getTableName());\n+          if (context != null) {\n+            context.append(entry);\n+          }\n+          existingTable.addPartitions(addTablePartitions);\n+          return existingTable;\n+        }\n+        LOG.info(\"Will not add partitions to table {}.{}, because of mismatched versions. \"\n+                + \"version-to-delete: {} existing-version: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02216917292bb32fa22e419fa41eb2cd53fce96b"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92ad33484414f7a70d29023e2451725c6bd1ce62", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/92ad33484414f7a70d29023e2451725c6bd1ce62", "committedDate": "2020-12-18T03:05:00Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa29d883f45b2f442b2a42dfbef59fbcbf97b56d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/aa29d883f45b2f442b2a42dfbef59fbcbf97b56d", "committedDate": "2020-12-18T19:06:41Z", "message": "Fix findbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fad7ad18091be9449667ae7f916199f0edfac49", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/0fad7ad18091be9449667ae7f916199f0edfac49", "committedDate": "2020-12-18T22:26:12Z", "message": "Merge branch 'master' of github.com:Alluxio/alluxio into partitionJournal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56b4475700c75096ce2d310bcca502ee0c240281", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/56b4475700c75096ce2d310bcca502ee0c240281", "committedDate": "2020-12-18T23:36:55Z", "message": "Fix add table partitions bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNzgzNTAw", "url": "https://github.com/Alluxio/alluxio/pull/12658#pullrequestreview-560783500", "createdAt": "2021-01-04T05:11:51Z", "commit": {"oid": "56b4475700c75096ce2d310bcca502ee0c240281"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a327fc911ceff7d55ecfcdd428a64149011edfc0", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a327fc911ceff7d55ecfcdd428a64149011edfc0", "committedDate": "2021-01-04T21:08:01Z", "message": "Modify TableMasterJournal test to include partition chunk size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMDUyMzU0", "url": "https://github.com/Alluxio/alluxio/pull/12658#pullrequestreview-562052354", "createdAt": "2021-01-05T19:01:51Z", "commit": {"oid": "a327fc911ceff7d55ecfcdd428a64149011edfc0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3364, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}