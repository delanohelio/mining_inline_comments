{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDA5NzM4", "number": 12013, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMjo1MFrOEaFDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOEaJRNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NzgxMTYwOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMjo1MFrOHDR4lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMjo1MFrOHDR4lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMDc4OA==", "bodyText": "Spacing", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473200788", "createdAt": "2020-08-19T17:22:50Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -300,25 +297,25 @@ private boolean putInternal(PageId pageId, byte[] page) {\n       }\n     }\n \n-    Pair<ReadWriteLock, ReadWriteLock> pageLockPair = getPageLockPair(pageId, victim);\n+    Pair<ReadWriteLock, ReadWriteLock> pageLockPair =\n+        getPageLockPair(pageId, victimPageInfo.getPageId());\n     try (LockResource r1 = new LockResource(pageLockPair.getFirst().writeLock());\n-        LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n+         LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NzgxNDMyOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMzo0MVrOHDR6Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODozOTo0OVrOHDUeig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMTIzMA==", "bodyText": "Should we change the metric below to be more specific?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473201230", "createdAt": "2020-08-19T17:23:41Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -300,25 +297,25 @@ private boolean putInternal(PageId pageId, byte[] page) {\n       }\n     }\n \n-    Pair<ReadWriteLock, ReadWriteLock> pageLockPair = getPageLockPair(pageId, victim);\n+    Pair<ReadWriteLock, ReadWriteLock> pageLockPair =\n+        getPageLockPair(pageId, victimPageInfo.getPageId());\n     try (LockResource r1 = new LockResource(pageLockPair.getFirst().writeLock());\n-        LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n+         LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n       try (LockResource r3 = new LockResource(mMetaLock.writeLock())) {\n         if (mMetaStore.hasPage(pageId)) {\n           LOG.debug(\"{} is already inserted by a racing thread\", pageId);\n           // TODO(binfan): we should return more informative result in the future\n           return true;\n         }\n-        if (!mMetaStore.hasPage(victim)) {\n+        if (!mMetaStore.hasPage(victimPageInfo.getPageId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzI3NA==", "bodyText": "count it as PUT_RACING_EVICTION_ERRORS", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473243274", "createdAt": "2020-08-19T18:39:49Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -300,25 +297,25 @@ private boolean putInternal(PageId pageId, byte[] page) {\n       }\n     }\n \n-    Pair<ReadWriteLock, ReadWriteLock> pageLockPair = getPageLockPair(pageId, victim);\n+    Pair<ReadWriteLock, ReadWriteLock> pageLockPair =\n+        getPageLockPair(pageId, victimPageInfo.getPageId());\n     try (LockResource r1 = new LockResource(pageLockPair.getFirst().writeLock());\n-        LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n+         LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n       try (LockResource r3 = new LockResource(mMetaLock.writeLock())) {\n         if (mMetaStore.hasPage(pageId)) {\n           LOG.debug(\"{} is already inserted by a racing thread\", pageId);\n           // TODO(binfan): we should return more informative result in the future\n           return true;\n         }\n-        if (!mMetaStore.hasPage(victim)) {\n+        if (!mMetaStore.hasPage(victimPageInfo.getPageId())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMTIzMA=="}, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NzgxOTIxOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyNTowMlrOHDR9Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1MDowMlrOHDS0Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMjAwNg==", "bodyText": "If this is null, do we need to do something to update the evictor state?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473202006", "createdAt": "2020-08-19T17:25:02Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -74,5 +84,16 @@ public void reset() {\n     mPages.set(0);\n     mBytes.set(0);\n     mPageMap.clear();\n+    mEvictor.reset();\n+  }\n+\n+  @Override\n+  @Nullable\n+  public PageInfo evict() {\n+    PageId victim = mEvictor.evict();\n+    if (victim == null) {\n+      return null;\n+    }\n+    return mPageMap.get(victim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjA4Mg==", "bodyText": "good catch. In theory, this should never happen if evictor is implemented correctly.\nbut no one can guarantee that. corresponding error log and cleanup added", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473216082", "createdAt": "2020-08-19T17:50:02Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -74,5 +84,16 @@ public void reset() {\n     mPages.set(0);\n     mBytes.set(0);\n     mPageMap.clear();\n+    mEvictor.reset();\n+  }\n+\n+  @Override\n+  @Nullable\n+  public PageInfo evict() {\n+    PageId victim = mEvictor.evict();\n+    if (victim == null) {\n+      return null;\n+    }\n+    return mPageMap.get(victim);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMjAwNg=="}, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Nzg0MjU2OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozMTozM1rOHDSL2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozMTozM1rOHDSL2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwNTcyMw==", "bodyText": "Not sure if this comment is accurate, we already removed the victim from the metastore on line 316, so I think we need to go through with the ondisk delete? ie Regardless of enoughSpace, we need to delete the victim as it has been removed from the metastore?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473205723", "createdAt": "2020-08-19T17:31:33Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -327,37 +324,43 @@ private boolean putInternal(PageId pageId, byte[] page) {\n           mMetaStore.addPage(pageId, new PageInfo(pageId, page.length));\n         }\n       }\n-      if (deletePage(victim, victimPageInfo)) {\n+      // Regardless enoughSpace, evicting victim to make progress", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Nzg2MTQ3OnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozNzoxMVrOHDSYTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozNzoxMVrOHDSYTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwODkwOA==", "bodyText": "Change this comment to failed to evict page, remove new page from metastore as there will not be enough space?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473208908", "createdAt": "2020-08-19T17:37:11Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -327,37 +324,43 @@ private boolean putInternal(PageId pageId, byte[] page) {\n           mMetaStore.addPage(pageId, new PageInfo(pageId, page.length));\n         }\n       }\n-      if (deletePage(victim, victimPageInfo)) {\n+      // Regardless enoughSpace, evicting victim to make progress\n+      if (deletePage(victimPageInfo.getPageId())) {\n         Metrics.BYTES_EVICTED_CACHE.mark(victimPageInfo.getPageSize());\n         Metrics.PAGES_EVICTED_CACHE.mark();\n       } else {\n-        LOG.debug(\"Failed to evict page: {}\", victim);\n+        LOG.debug(\"Failed to evict page: {}\", victimPageInfo.getPageId());\n         Metrics.PUT_EVICTION_ERRORS.inc();\n+        // something is wrong to add this page, let's remove it from meta store", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1ODUwMjkzOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOHDYmVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo0NTo1MlrOHDbPbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDgwNw==", "bodyText": "Do we need to return after succeeding?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473310807", "createdAt": "2020-08-19T20:50:56Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -279,87 +278,86 @@ private boolean putInternal(PageId pageId, byte[] page) {\n         }\n       }\n       if (enoughSpace) {\n-        boolean ok = addPage(pageId, page);\n-        if (ok) {\n+        try {\n+          mPageStore.put(pageId, page);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "347a0bf1378b0f3ea4659768fe4a24272086c778"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NDA5NQ==", "bodyText": "oops, good catch!", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473354095", "createdAt": "2020-08-19T21:45:52Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -279,87 +278,86 @@ private boolean putInternal(PageId pageId, byte[] page) {\n         }\n       }\n       if (enoughSpace) {\n-        boolean ok = addPage(pageId, page);\n-        if (ok) {\n+        try {\n+          mPageStore.put(pageId, page);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDgwNw=="}, "originalCommit": {"oid": "347a0bf1378b0f3ea4659768fe4a24272086c778"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1321, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}