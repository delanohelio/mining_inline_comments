{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NDAyMDgz", "number": 12099, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDo0OTowOVrOEjLRyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNjo0Njo1OFrOEjOjGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzIwMzk0OnYy", "diffSide": "RIGHT", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDo0OTowOVrOHRYrUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODoxMTo0MVrOHRg9HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MjE0NA==", "bodyText": "If joinQuorum failed, the master with raft journal system will still run?? Should we shut it down or retry joining?", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r487992144", "createdAt": "2020-09-14T14:49:09Z", "author": {"login": "LuQQiu"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -562,6 +566,38 @@ public synchronized void startInternal() throws InterruptedException, IOExceptio\n       throw new IOException(errorMessage, e.getCause());\n     }\n     LOG.info(\"Started Raft Journal System in {}ms\", System.currentTimeMillis() - startTime);\n+    joinQuorum();\n+  }\n+\n+  private void joinQuorum() {\n+    InetSocketAddress localAddress = mConf.getLocalAddress();\n+    // Send a request to join the quorum.\n+    // If the server is already part of the quorum, this operation is a noop.\n+    AddQuorumServerRequest request = AddQuorumServerRequest.newBuilder()\n+        .setServerAddress(NetAddress.newBuilder()\n+            .setHost(localAddress.getHostString())\n+            .setRpcPort(localAddress.getPort()))\n+        .build();\n+    RaftClient client = createClient();\n+    client.sendReadOnlyAsync(Message.valueOf(\n+        UnsafeByteOperations.unsafeWrap(\n+            JournalQueryRequest\n+                .newBuilder()\n+                .setAddQuorumServerRequest(request)\n+                .build().toByteArray()\n+        ))).whenComplete((reply, t) -> {\n+          if (t != null) {\n+            LOG.error(\"Exception occurred while joining quorum\", t);\n+          }\n+          if (reply != null && reply.getException() != null) {\n+            LOG.error(\"Received an error while joining quorum\", reply.getException());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyNzc3Mw==", "bodyText": "Yes. The join process is a best effort call with a retry policy. When a new quorum is forming a new leader might not be available when master starts. We should not shutdown the master for that. If the master later is rejected by the quorum because the unsuccessful join, the server will be shutdown.", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488127773", "createdAt": "2020-09-14T18:11:41Z", "author": {"login": "bf8086"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -562,6 +566,38 @@ public synchronized void startInternal() throws InterruptedException, IOExceptio\n       throw new IOException(errorMessage, e.getCause());\n     }\n     LOG.info(\"Started Raft Journal System in {}ms\", System.currentTimeMillis() - startTime);\n+    joinQuorum();\n+  }\n+\n+  private void joinQuorum() {\n+    InetSocketAddress localAddress = mConf.getLocalAddress();\n+    // Send a request to join the quorum.\n+    // If the server is already part of the quorum, this operation is a noop.\n+    AddQuorumServerRequest request = AddQuorumServerRequest.newBuilder()\n+        .setServerAddress(NetAddress.newBuilder()\n+            .setHost(localAddress.getHostString())\n+            .setRpcPort(localAddress.getPort()))\n+        .build();\n+    RaftClient client = createClient();\n+    client.sendReadOnlyAsync(Message.valueOf(\n+        UnsafeByteOperations.unsafeWrap(\n+            JournalQueryRequest\n+                .newBuilder()\n+                .setAddQuorumServerRequest(request)\n+                .build().toByteArray()\n+        ))).whenComplete((reply, t) -> {\n+          if (t != null) {\n+            LOG.error(\"Exception occurred while joining quorum\", t);\n+          }\n+          if (reply != null && reply.getException() != null) {\n+            LOG.error(\"Received an error while joining quorum\", reply.getException());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MjE0NA=="}, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzczMDYzOnYy", "diffSide": "RIGHT", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNjo0NToxMlrOHRdz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMTo1MjoyMFrOHRn2hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NjI3Nw==", "bodyText": "This journal request can have various types of requests, like snapshot (above), and now add quorum? There should only be 1 set at a time?\nAlso, should this section be like:\nif (queryRequest.hasGetSnapshotInfoRequest()) {\n...\nelse if (queryRequest.hasGetSnapshotRequest()) {\n...\nelse if (queryRequest.hasAddQuorumServerRequest()) {\n...\n}", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488076277", "createdAt": "2020-09-14T16:45:12Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "diffHunk": "@@ -185,6 +187,17 @@ public StateMachineStorage getStateMachineStorage() {\n         future.complete(reply);\n         return future;\n       }\n+      if (queryRequest.hasAddQuorumServerRequest()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyOTUyMA==", "bodyText": "Yes there should be only one set for a request.\nBoth GetSnapshotInfoRequest and GetSnapshotRequest are handled by SnapshotManager. Only when a valid reply is not given does this function continue to check other types of request.", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488129520", "createdAt": "2020-09-14T18:14:47Z", "author": {"login": "bf8086"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "diffHunk": "@@ -185,6 +187,17 @@ public StateMachineStorage getStateMachineStorage() {\n         future.complete(reply);\n         return future;\n       }\n+      if (queryRequest.hasAddQuorumServerRequest()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NjI3Nw=="}, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE4MTg2NA==", "bodyText": "I see. Can we just add a small comment, either here or above, saying something like handleRequest() handles GetSnapshotInfoRequest and GetSnapshotRequest, or returns null, so that this part handles the other requests (AddQuorumServerRequest).", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488181864", "createdAt": "2020-09-14T19:51:33Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "diffHunk": "@@ -185,6 +187,17 @@ public StateMachineStorage getStateMachineStorage() {\n         future.complete(reply);\n         return future;\n       }\n+      if (queryRequest.hasAddQuorumServerRequest()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NjI3Nw=="}, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI0MDc3Mw==", "bodyText": "Added some comments.", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488240773", "createdAt": "2020-09-14T21:52:20Z", "author": {"login": "bf8086"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "diffHunk": "@@ -185,6 +187,17 @@ public StateMachineStorage getStateMachineStorage() {\n         future.complete(reply);\n         return future;\n       }\n+      if (queryRequest.hasAddQuorumServerRequest()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NjI3Nw=="}, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzczOTc2OnYy", "diffSide": "RIGHT", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNjo0Njo1OFrOHRd5wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODowNToxMlrOHRgu2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3Nzc2Mg==", "bodyText": "Does whenComplete run even on failure?", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488077762", "createdAt": "2020-09-14T16:46:58Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -562,6 +566,38 @@ public synchronized void startInternal() throws InterruptedException, IOExceptio\n       throw new IOException(errorMessage, e.getCause());\n     }\n     LOG.info(\"Started Raft Journal System in {}ms\", System.currentTimeMillis() - startTime);\n+    joinQuorum();\n+  }\n+\n+  private void joinQuorum() {\n+    InetSocketAddress localAddress = mConf.getLocalAddress();\n+    // Send a request to join the quorum.\n+    // If the server is already part of the quorum, this operation is a noop.\n+    AddQuorumServerRequest request = AddQuorumServerRequest.newBuilder()\n+        .setServerAddress(NetAddress.newBuilder()\n+            .setHost(localAddress.getHostString())\n+            .setRpcPort(localAddress.getPort()))\n+        .build();\n+    RaftClient client = createClient();\n+    client.sendReadOnlyAsync(Message.valueOf(\n+        UnsafeByteOperations.unsafeWrap(\n+            JournalQueryRequest\n+                .newBuilder()\n+                .setAddQuorumServerRequest(request)\n+                .build().toByteArray()\n+        ))).whenComplete((reply, t) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEyNDEyMg==", "bodyText": "Yes, it always runs at the end of the action. When the action fails a throwable is given as the second parameter.", "url": "https://github.com/Alluxio/alluxio/pull/12099#discussion_r488124122", "createdAt": "2020-09-14T18:05:12Z", "author": {"login": "bf8086"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -562,6 +566,38 @@ public synchronized void startInternal() throws InterruptedException, IOExceptio\n       throw new IOException(errorMessage, e.getCause());\n     }\n     LOG.info(\"Started Raft Journal System in {}ms\", System.currentTimeMillis() - startTime);\n+    joinQuorum();\n+  }\n+\n+  private void joinQuorum() {\n+    InetSocketAddress localAddress = mConf.getLocalAddress();\n+    // Send a request to join the quorum.\n+    // If the server is already part of the quorum, this operation is a noop.\n+    AddQuorumServerRequest request = AddQuorumServerRequest.newBuilder()\n+        .setServerAddress(NetAddress.newBuilder()\n+            .setHost(localAddress.getHostString())\n+            .setRpcPort(localAddress.getPort()))\n+        .build();\n+    RaftClient client = createClient();\n+    client.sendReadOnlyAsync(Message.valueOf(\n+        UnsafeByteOperations.unsafeWrap(\n+            JournalQueryRequest\n+                .newBuilder()\n+                .setAddQuorumServerRequest(request)\n+                .build().toByteArray()\n+        ))).whenComplete((reply, t) -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3Nzc2Mg=="}, "originalCommit": {"oid": "808ef2e5c1cce7a89b8698fc70279a665f81b29e"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1173, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}