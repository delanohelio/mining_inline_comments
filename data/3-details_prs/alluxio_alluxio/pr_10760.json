{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzOTE4OTIw", "number": 10760, "title": "Optimize offset read from page store", "bodyText": "Add a new offset read API on page store to eliminate buffer copy in LocalCacheManager.", "createdAt": "2020-01-17T01:10:15Z", "url": "https://github.com/Alluxio/alluxio/pull/10760", "merged": true, "mergeCommit": {"oid": "c4174cd381da82abdbc79f0a63429a8899efc6e5"}, "closed": true, "closedAt": "2020-01-20T18:39:03Z", "author": {"login": "bf8086"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7EJ-zgH2gAyMzYzOTE4OTIwOmQ2ZDQ1M2ZlMWJkNTcxNGE1YzNjNGU1Yzk2MzMzYjU2MWIyNWRjMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7dDZUgFqTM0NDkyNzc5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6d453fe1bd5714a5c3c4e5c96333b561b25dc10", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d6d453fe1bd5714a5c3c4e5c96333b561b25dc10", "committedDate": "2020-01-17T01:06:59Z", "message": "optimize offset read"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/315291168928b3f47a0c03033801ab017d7d3f66", "committedDate": "2020-01-17T01:27:30Z", "message": "fix checkstyles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Nzk4OTA2", "url": "https://github.com/Alluxio/alluxio/pull/10760#pullrequestreview-344798906", "createdAt": "2020-01-17T19:37:51Z", "commit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTozNzo1MVrOFfDQGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0NDozNlrOFfDarQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwMzQ0OA==", "bodyText": "[ERROR] alluxio.client.file.cache.store.LocalPageStore.get(PageId, int) may fail to clean up java.io.InputStream on checked exception [alluxio.client.file.cache.store.LocalPageStore, alluxio.client.file.cache.store.LocalPageStore] Obligation to clean up resource created at LocalPageStore.java:[line 78] is not dischargedPath continues at LocalPageStore.java:[line 79] OBL_UNSATISFIED_OBLIGATION_EXCEPTION_EDGE", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368103448", "createdAt": "2020-01-17T19:37:51Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+      throws IOException, PageNotFoundException {\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n     FileInputStream fis = new FileInputStream(p.toFile());\n+    fis.skip(pageOffset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTIwNw==", "bodyText": "what is expected if pageOffset > page len? Exception or an empty channel?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105207", "createdAt": "2020-01-17T19:42:07Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/PageStore.java", "diffHunk": "@@ -78,7 +78,21 @@ static PageStore create(AlluxioConfiguration conf) {\n    * @throws IOException\n    * @throws PageNotFoundException when the page isn't found in the store\n    */\n-  ReadableByteChannel get(PageId pageId) throws IOException,\n+  default ReadableByteChannel get(PageId pageId) throws IOException,\n+      PageNotFoundException {\n+    return get(pageId, 0);\n+  }\n+\n+  /**\n+   * Gets part of a page from the store to the destination channel.\n+   *\n+   * @param pageId page identifier\n+   * @param pageOffset offset within page\n+   * @return the number of bytes read\n+   * @throws IOException\n+   * @throws PageNotFoundException when the page isn't found in the store\n+   */\n+  ReadableByteChannel get(PageId pageId, int pageOffset) throws IOException,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTU3MQ==", "bodyText": "3 -> offset", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105571", "createdAt": "2020-01-17T19:43:07Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {\n+    mOptions.setRootDir(mTemp.getRoot().getAbsolutePath());\n+    int len = 32;\n+    int offset = 3;\n+    try (PageStore store = PageStore.create(mOptions)) {\n+      PageId id = new PageId(0, 0);\n+      store.put(id, BufferUtils.getIncreasingByteArray(len));\n+      ByteBuffer buf = ByteBuffer.allocate(1024);\n+      try (ReadableByteChannel channel = store.get(id, offset)) {\n+        channel.read(buf);\n+      }\n+      buf.flip();\n+      assertTrue(BufferUtils.equalIncreasingByteBuffer(3, len - offset, buf));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNTg1OA==", "bodyText": "also test the case offset exceeding page len?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368105858", "createdAt": "2020-01-17T19:43:48Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/store/PageStoreTest.java", "diffHunk": "@@ -61,6 +64,23 @@ public void test() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getOffset() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjEwMw==", "bodyText": "Precondition to check page Offset is positive?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368106103", "createdAt": "2020-01-17T19:44:28Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,12 +69,14 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNjE1Nw==", "bodyText": "Precondition to check page Offset is positive?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368106157", "createdAt": "2020-01-17T19:44:36Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -76,14 +76,15 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException,\n-      PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "315291168928b3f47a0c03033801ab017d7d3f66"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae0e2486c52291262fa40717759a27aa3ce19c7", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/0ae0e2486c52291262fa40717759a27aa3ce19c7", "committedDate": "2020-01-17T22:30:08Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTI3Nzc4", "url": "https://github.com/Alluxio/alluxio/pull/10760#pullrequestreview-344927778", "createdAt": "2020-01-18T06:06:50Z", "commit": {"oid": "0ae0e2486c52291262fa40717759a27aa3ce19c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjowNjo1MFrOFfJtKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjowNjo1MFrOFfJtKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTE5Mw==", "bodyText": "nit: is Throwable required here to avoid the warning or can we just catch IOException or Exception ?", "url": "https://github.com/Alluxio/alluxio/pull/10760#discussion_r368209193", "createdAt": "2020-01-18T06:06:50Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,13 +69,24 @@ public void put(PageId pageId, byte[] page) throws IOException {\n   }\n \n   @Override\n-  public ReadableByteChannel get(PageId pageId) throws IOException, PageNotFoundException {\n+  public ReadableByteChannel get(PageId pageId, int pageOffset)\n+      throws IOException, PageNotFoundException {\n+    Preconditions.checkArgument(pageOffset >= 0, \"page offset should be non-negative\");\n     Path p = getFilePath(pageId);\n     if (!Files.exists(p)) {\n       throw new PageNotFoundException(p.toString());\n     }\n+    File f = p.toFile();\n+    Preconditions.checkArgument(pageOffset <= f.length(),\n+        \"page offset %s exceeded page size %s\", pageOffset, f.length());\n     FileInputStream fis = new FileInputStream(p.toFile());\n-    return fis.getChannel();\n+    try {\n+      fis.skip(pageOffset);\n+      return fis.getChannel();\n+    } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae0e2486c52291262fa40717759a27aa3ce19c7"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTI3Nzk2", "url": "https://github.com/Alluxio/alluxio/pull/10760#pullrequestreview-344927796", "createdAt": "2020-01-18T06:07:25Z", "commit": {"oid": "0ae0e2486c52291262fa40717759a27aa3ce19c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4994, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}