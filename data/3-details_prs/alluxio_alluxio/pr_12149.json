{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzU1MjY3", "number": 12149, "title": "Add worker master periodical connections timeout", "bodyText": "In a cluster with multiple masters using embedded journal, when network partitioned the original leading master, leadership changes to a new leading master. The workers hang in GRPC connections with the previous leading master and don't register with the new leading master.\nThis PR adds the timeout to periodical connections (operations) between workers and leading masters to prevent workers from hanging forever.", "createdAt": "2020-09-27T18:02:37Z", "url": "https://github.com/Alluxio/alluxio/pull/12149", "merged": true, "mergeCommit": {"oid": "aef043b50e4bd32d92205585eab1c1c76a30f2b4"}, "closed": true, "closedAt": "2020-09-28T21:49:48Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNC6clAH2gAyNDkzNzU1MjY3OjcwMmQ2NjY0MjcyYjFlMTZjMmVlZGY2MDk0MDFlZGE2N2IxMGUxMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNZTbhAFqTQ5Nzg1NzM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "702d6664272b1e16c2eedf609401eda67b10e128", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/702d6664272b1e16c2eedf609401eda67b10e128", "committedDate": "2020-09-27T18:01:54Z", "message": "Add worker master periodical connect timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/3410365afce65884ffea8c85bd551d0c722ea605", "committedDate": "2020-09-27T18:24:21Z", "message": "Change to default 5min"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MTM0NzMz", "url": "https://github.com/Alluxio/alluxio/pull/12149#pullrequestreview-497134733", "createdAt": "2020-09-28T01:02:40Z", "commit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwMTowMjo0MFrOHYrrSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwMToxNDo0OVrOHYry2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY0MzQ2NQ==", "bodyText": "It can be somehow confusing to have both WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT and WORKER_MASTER_CONNECT_RETRY_TIMEOUT in the configuration. Can we have a more distinguishable name for this one? How about WORKER_MASTER_PERIODICAL_RPC_TIMEOUT?", "url": "https://github.com/Alluxio/alluxio/pull/12149#discussion_r495643465", "createdAt": "2020-09-28T01:02:40Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2651,6 +2651,16 @@ public String toString() {\n       .setConsistencyCheckLevel(ConsistencyCheckLevel.ENFORCE)\n       .setScope(Scope.WORKER)\n       .build();\n+  public static final PropertyKey WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY0MzU0NA==", "bodyText": "(nit) Please sort the property name by alphabetical order.", "url": "https://github.com/Alluxio/alluxio/pull/12149#discussion_r495643544", "createdAt": "2020-09-28T01:03:13Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2651,6 +2651,16 @@ public String toString() {\n       .setConsistencyCheckLevel(ConsistencyCheckLevel.ENFORCE)\n       .setScope(Scope.WORKER)\n       .build();\n+  public static final PropertyKey WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT =\n+      new Builder(Name.WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY0NDU5OA==", "bodyText": "pingService is used in a bunch of places including client and job services. We probably want to use a different configuration property. Can we maybe reuse the USER_MASTER_POLLING_TIMEOUT or something more generic?", "url": "https://github.com/Alluxio/alluxio/pull/12149#discussion_r495644598", "createdAt": "2020-09-28T01:09:47Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/util/network/NetworkAddressUtils.java", "diffHunk": "@@ -670,7 +671,9 @@ public static void pingService(InetSocketAddress address, alluxio.grpc.ServiceTy\n         .build();\n     try {\n       ServiceVersionClientServiceGrpc.ServiceVersionClientServiceBlockingStub versionClient =\n-          ServiceVersionClientServiceGrpc.newBlockingStub(channel);\n+          ServiceVersionClientServiceGrpc.newBlockingStub(channel)\n+              .withDeadlineAfter(conf.getMs(PropertyKey.WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY0NTQwMg==", "bodyText": "Can we explain in description how the value of the property can affect the delay before a worker attempt to register with a new primary master?", "url": "https://github.com/Alluxio/alluxio/pull/12149#discussion_r495645402", "createdAt": "2020-09-28T01:14:49Z", "author": {"login": "bf8086"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2651,6 +2651,16 @@ public String toString() {\n       .setConsistencyCheckLevel(ConsistencyCheckLevel.ENFORCE)\n       .setScope(Scope.WORKER)\n       .build();\n+  public static final PropertyKey WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT =\n+      new Builder(Name.WORKER_MASTER_PERIODICAL_CONNECT_TIMEOUT)\n+          .setDefaultValue(\"5min\")\n+          .setDescription(\"Timeout for periodical connections between workers \"\n+              + \"and the leading master. Periodical connections between workers \"\n+              + \"and previous leading master may hang which prevents workers \"\n+              + \"from registering with the new leading master \"\n+              + \"during flaky network situations.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3410365afce65884ffea8c85bd551d0c722ea605"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "323a52544ca655e441c8e8f49577200ba041ff8d", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/323a52544ca655e441c8e8f49577200ba041ff8d", "committedDate": "2020-09-28T04:11:36Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzUzNDU5", "url": "https://github.com/Alluxio/alluxio/pull/12149#pullrequestreview-497753459", "createdAt": "2020-09-28T17:35:18Z", "commit": {"oid": "323a52544ca655e441c8e8f49577200ba041ff8d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzozNToxOFrOHZI1XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzozNToxOFrOHZI1XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyMTE4MQ==", "bodyText": "Does this control the connection phase, or the entire RPC duration as well?\nAlso, is 5m too long? This means if there is a failover, workers will take 5 minutes to re-connect?\nHow did failovers work before this parameter?", "url": "https://github.com/Alluxio/alluxio/pull/12149#discussion_r496121181", "createdAt": "2020-09-28T17:35:18Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -2657,6 +2657,18 @@ public String toString() {\n           .setDefaultValue(\"1hour\")\n           .setScope(Scope.WORKER)\n           .build();\n+  public static final PropertyKey WORKER_MASTER_PERIODICAL_RPC_TIMEOUT =\n+      new Builder(Name.WORKER_MASTER_PERIODICAL_RPC_TIMEOUT)\n+          .setDefaultValue(\"5min\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "323a52544ca655e441c8e8f49577200ba041ff8d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzUzNTU0", "url": "https://github.com/Alluxio/alluxio/pull/12149#pullrequestreview-497753554", "createdAt": "2020-09-28T17:35:27Z", "commit": {"oid": "323a52544ca655e441c8e8f49577200ba041ff8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee5cac6cfcf5f1bcad453d30a98585b12716a0b", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/3ee5cac6cfcf5f1bcad453d30a98585b12716a0b", "committedDate": "2020-09-28T18:32:39Z", "message": "Reset timeout back to 1min"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "720e27447218368cba8cc703bb5dcc2a20ea269c", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/720e27447218368cba8cc703bb5dcc2a20ea269c", "committedDate": "2020-09-28T19:56:36Z", "message": "Change to 5min"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODU3Mzc3", "url": "https://github.com/Alluxio/alluxio/pull/12149#pullrequestreview-497857377", "createdAt": "2020-09-28T20:07:06Z", "commit": {"oid": "720e27447218368cba8cc703bb5dcc2a20ea269c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3612, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}