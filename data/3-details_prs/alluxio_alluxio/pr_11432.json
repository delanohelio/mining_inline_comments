{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MzAzNjcy", "number": 11432, "title": "Stop worker heartbeat executor first on shutdown", "bodyText": "Fixes #11421", "createdAt": "2020-05-14T23:57:46Z", "url": "https://github.com/Alluxio/alluxio/pull/11432", "merged": true, "mergeCommit": {"oid": "7dd858d4cfd2799c518fc3211617e9447be04af1"}, "closed": true, "closedAt": "2020-05-19T20:34:01Z", "author": {"login": "ZacBlanco"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchWJOLAH2gAyNDE4MzAzNjcyOjEwYmI1NjQxMDQyYmZjMzIyNGZmOTMzYTU2MGQ0OGEyYzVkYzkzNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci6jSugFqTQxNDgwMDgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10bb5641042bfc3224ff933a560d48a2c5dc935f", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/10bb5641042bfc3224ff933a560d48a2c5dc935f", "committedDate": "2020-05-14T23:33:34Z", "message": "Interrupt worker heartbeat thread on shutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzQwNTQw", "url": "https://github.com/Alluxio/alluxio/pull/11432#pullrequestreview-412340540", "createdAt": "2020-05-15T04:33:18Z", "commit": {"oid": "10bb5641042bfc3224ff933a560d48a2c5dc935f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNDozMzoxOFrOGV2KOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNDozMzoxOFrOGV2KOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU2MDYzNQ==", "bodyText": "Can you try swapping below two lines in DefaultBlockWorker::stop() instead of this logic?\n// Stop heart-beat executors and clients.\nmResourceCloser.close();\n// Stop the base. (closes executors.)\nsuper.stop();", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r425560635", "createdAt": "2020-05-15T04:33:18Z", "author": {"login": "ggezer"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -621,19 +621,33 @@ private Metrics() {} // prevent instantiation\n   @NotThreadSafe\n   public final class StorageChecker implements HeartbeatExecutor {\n \n+    private volatile boolean mClosed = false;\n+    private final AtomicReference<Thread> mThread = new AtomicReference<>(null);\n+\n     @Override\n     public void heartbeat() {\n+      if (mClosed) {\n+        return;\n+      }\n+      mThread.set(Thread.currentThread());\n       try {\n         mBlockStore.checkStorage();\n       } catch (Exception e) {\n         LOG.warn(\"Failed to check storage: {}\", e.toString());\n         LOG.debug(\"Exception: \", e);\n       }\n+      mThread.set(null);\n     }\n \n     @Override\n     public void close() {\n-      // Nothing to clean up", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10bb5641042bfc3224ff933a560d48a2c5dc935f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e4cbde6b7d0d020816e74912efa828c783061aa", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/2e4cbde6b7d0d020816e74912efa828c783061aa", "committedDate": "2020-05-15T18:33:05Z", "message": "Revert \"Interrupt worker heartbeat thread on shutdown\"\n\nThis reverts commit 10bb5641042bfc3224ff933a560d48a2c5dc935f."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/7232652b4ae290e49e8204f0fe4896c6cd8a5ad9", "committedDate": "2020-05-15T18:33:38Z", "message": "Swap abstract worker shutdown with resource closer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTIwMjEz", "url": "https://github.com/Alluxio/alluxio/pull/11432#pullrequestreview-412920213", "createdAt": "2020-05-15T19:41:57Z", "commit": {"oid": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0MTo1N1rOGWRp9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0MTo1N1rOGWRp9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ==", "bodyText": "It seems like this order is important. Do we know why this has to be the order, and can we add that into the comments here? It is not obvious with the code.", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r426011125", "createdAt": "2020-05-15T19:41:57Z", "author": {"login": "gpang"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -251,10 +251,10 @@ public void start(WorkerNetAddress address) throws IOException {\n    */\n   @Override\n   public void stop() throws IOException {\n-    // Stop heart-beat executors and clients.\n-    mResourceCloser.close();\n     // Stop the base. (closes executors.)\n     super.stop();\n+    // Stop heart-beat executors and clients.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787423189a5d3d2bad0eab9e67cf5c157fd4b26d", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/787423189a5d3d2bad0eab9e67cf5c157fd4b26d", "committedDate": "2020-05-18T19:32:30Z", "message": "Try using client pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f", "committedDate": "2020-05-18T19:32:47Z", "message": "Revert \"Try using client pool\"\n\nThis reverts commit 787423189a5d3d2bad0eab9e67cf5c157fd4b26d."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTE3OTcz", "url": "https://github.com/Alluxio/alluxio/pull/11432#pullrequestreview-413917973", "createdAt": "2020-05-18T20:31:11Z", "commit": {"oid": "e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzE1MDE0", "url": "https://github.com/Alluxio/alluxio/pull/11432#pullrequestreview-414715014", "createdAt": "2020-05-19T18:28:35Z", "commit": {"oid": "e5fe11f4a9f2c6c3993e9ea0911f8a5e7b4f565f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODoyODozNVrOGXtTVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODoyODozNVrOGXtTVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxMjY2Mw==", "bodyText": "Can we add this info as a comment, since this ordering is intentional and critical.", "url": "https://github.com/Alluxio/alluxio/pull/11432#discussion_r427512663", "createdAt": "2020-05-19T18:28:35Z", "author": {"login": "gpang"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -251,10 +251,10 @@ public void start(WorkerNetAddress address) throws IOException {\n    */\n   @Override\n   public void stop() throws IOException {\n-    // Stop heart-beat executors and clients.\n-    mResourceCloser.close();\n     // Stop the base. (closes executors.)\n     super.stop();\n+    // Stop heart-beat executors and clients.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTEyNQ=="}, "originalCommit": {"oid": "7232652b4ae290e49e8204f0fe4896c6cd8a5ad9"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30c0ef0070bda4b2b225c5c02309c095dba44d77", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/30c0ef0070bda4b2b225c5c02309c095dba44d77", "committedDate": "2020-05-19T18:32:39Z", "message": "Add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODAwODAw", "url": "https://github.com/Alluxio/alluxio/pull/11432#pullrequestreview-414800800", "createdAt": "2020-05-19T20:32:33Z", "commit": {"oid": "30c0ef0070bda4b2b225c5c02309c095dba44d77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4639, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}