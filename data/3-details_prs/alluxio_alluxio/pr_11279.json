{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNDA3MTYz", "number": 11279, "title": "Make config reinit executor static", "bodyText": "Each FSContext instance creates a new single threaded executor pool for meta master config sync. For long running clients such as yarn RM, if the filesystem is not closed properly we would leak all non-static resources unless garbage collected.\nFixes: #11344", "createdAt": "2020-04-12T22:15:00Z", "url": "https://github.com/Alluxio/alluxio/pull/11279", "merged": true, "mergeCommit": {"oid": "a2aa339182dc4e935ad29f28d66202ac4c586210"}, "closed": true, "closedAt": "2020-04-27T19:39:17Z", "author": {"login": "madanadit"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXB-u7AFqTM5MTkwMDExNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb0g-TgFqTQwMTI2MzYxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTAwMTE0", "url": "https://github.com/Alluxio/alluxio/pull/11279#pullrequestreview-391900114", "createdAt": "2020-04-12T22:24:41Z", "commit": {"oid": "c2b711360fbd7e8380cb9c7b672f6844980d6da6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQyMjoyNDo0MlrOGEZLJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQyMjoyNDo0MlrOGEZLJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1OTk0Mw==", "bodyText": "I suspect the first submission will hold the thread and rest will never have a chance to run.", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r407259943", "createdAt": "2020-04-12T22:24:42Z", "author": {"login": "ggezer"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContextReinitializer.java", "diffHunk": "@@ -55,9 +57,7 @@\n   public FileSystemContextReinitializer(FileSystemContext context) {\n     mContext = context;\n     mExecutor = new ConfigHashSync(context);\n-    mExecutorService = Executors.newSingleThreadExecutor(ThreadFactoryUtils.build(\n-        \"config-hash-master-heartbeat-%d\", true));\n-    mExecutorService.submit(\n+    REINIT_EXECUTOR.submit(\n         new HeartbeatThread(HeartbeatContext.META_MASTER_CONFIG_HASH_SYNC, mContext.getId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b711360fbd7e8380cb9c7b672f6844980d6da6"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTUyNzI0", "url": "https://github.com/Alluxio/alluxio/pull/11279#pullrequestreview-391952724", "createdAt": "2020-04-13T04:33:23Z", "commit": {"oid": "93c173268d99be47a3795b356beb304189eb0932"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNDozMzoyM1rOGEceBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNDozMzoyM1rOGEceBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMxMzkyNA==", "bodyText": "Can you store the Future<?> in order to cancel it during reinitializer shutdown?", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r407313924", "createdAt": "2020-04-13T04:33:23Z", "author": {"login": "ggezer"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContextReinitializer.java", "diffHunk": "@@ -55,14 +62,17 @@\n   public FileSystemContextReinitializer(FileSystemContext context) {\n     mContext = context;\n     mExecutor = new ConfigHashSync(context);\n-    mExecutorService = Executors.newSingleThreadExecutor(ThreadFactoryUtils.build(\n-        \"config-hash-master-heartbeat-%d\", true));\n-    mExecutorService.submit(\n-        new HeartbeatThread(HeartbeatContext.META_MASTER_CONFIG_HASH_SYNC, mContext.getId(),\n-            mExecutor, mContext.getClientContext().getClusterConf().getMs(\n-                PropertyKey.USER_CONF_SYNC_INTERVAL),\n-            mContext.getClientContext().getClusterConf(),\n-            mContext.getClientContext().getUserState()));\n+    REINIT_EXECUTOR.scheduleAtFixedRate(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93c173268d99be47a3795b356beb304189eb0932"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87491ec9de577a78e458bf10a5431663f4863ac7", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/87491ec9de577a78e458bf10a5431663f4863ac7", "committedDate": "2020-04-24T02:51:10Z", "message": "Make reinit executor static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198966094e4430ecb757f9ee8bdd8e6812d064e1", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/198966094e4430ecb757f9ee8bdd8e6812d064e1", "committedDate": "2020-04-24T02:51:12Z", "message": "Do not close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f21c58cb858f1ae8d0ad0a47e059dc572a04f5c", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/9f21c58cb858f1ae8d0ad0a47e059dc572a04f5c", "committedDate": "2020-04-24T02:51:12Z", "message": "Remove single threaded executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09a1ba2b8140f6469283692bf2124aeab91276a6", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/09a1ba2b8140f6469283692bf2124aeab91276a6", "committedDate": "2020-04-24T02:51:12Z", "message": "Cancel future on close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "812323d54d5546b14b4fc7f0b93add37d40cea78", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/812323d54d5546b14b4fc7f0b93add37d40cea78", "committedDate": "2020-04-24T02:51:12Z", "message": "fix close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "committedDate": "2020-04-24T02:51:12Z", "message": "Fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fbe85c70cb92c3c238791fdcdb215ec58e314d6", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/3fbe85c70cb92c3c238791fdcdb215ec58e314d6", "committedDate": "2020-04-24T02:39:46Z", "message": "Fix test"}, "afterCommit": {"oid": "ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/ed8467eb05904bdb43a1b034ca482ca9ad38f86f", "committedDate": "2020-04-24T02:51:12Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "597b12b0f330776e6ab80fadd2e719de43a66d93", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/597b12b0f330776e6ab80fadd2e719de43a66d93", "committedDate": "2020-04-24T03:10:31Z", "message": "Fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTE3NjY5", "url": "https://github.com/Alluxio/alluxio/pull/11279#pullrequestreview-401117669", "createdAt": "2020-04-27T16:23:23Z", "commit": {"oid": "597b12b0f330776e6ab80fadd2e719de43a66d93"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTE4NTc4", "url": "https://github.com/Alluxio/alluxio/pull/11279#pullrequestreview-401118578", "createdAt": "2020-04-27T16:24:33Z", "commit": {"oid": "597b12b0f330776e6ab80fadd2e719de43a66d93"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNDozM1rOGMsKmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoyNDozM1rOGMsKmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTcwNw==", "bodyText": "Can't we just set minCapacity to 0 here rathat than defining a new prop?\nI don't see a scenario where we'd set it anything else.", "url": "https://github.com/Alluxio/alluxio/pull/11279#discussion_r415959707", "createdAt": "2020-04-27T16:24:33Z", "author": {"login": "ggezer"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/BlockWorkerClientPool.java", "diffHunk": "@@ -48,12 +48,14 @@\n    *\n    * @param userState the parent userState\n    * @param address address of the worker\n+   * @param minCapacity the minimum capacity of the pool\n    * @param maxCapacity the maximum capacity of the pool\n    * @param alluxioConf Alluxio configuration\n    */\n-  public BlockWorkerClientPool(UserState userState, GrpcServerAddress address, int maxCapacity,\n-      AlluxioConfiguration alluxioConf) {\n-    super(Options.defaultOptions().setMaxCapacity(maxCapacity).setGcExecutor(GC_EXECUTOR));\n+  public BlockWorkerClientPool(UserState userState, GrpcServerAddress address, int minCapacity,\n+      int maxCapacity, AlluxioConfiguration alluxioConf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "597b12b0f330776e6ab80fadd2e719de43a66d93"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d80d204b21c42075a3759cfd54e3d05e6a5e2f1", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/1d80d204b21c42075a3759cfd54e3d05e6a5e2f1", "committedDate": "2020-04-27T18:33:12Z", "message": "Update default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818ddd7628b0a4030a05ce5a08ad82392bb5089c", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/818ddd7628b0a4030a05ce5a08ad82392bb5089c", "committedDate": "2020-04-27T18:34:14Z", "message": "Make hidden"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e2d0d22991dd548501a93c808de8896f6fc2340", "author": {"user": {"login": "madanadit", "name": "Adit Madan"}}, "url": "https://github.com/Alluxio/alluxio/commit/6e2d0d22991dd548501a93c808de8896f6fc2340", "committedDate": "2020-04-27T18:40:01Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjYzNjE0", "url": "https://github.com/Alluxio/alluxio/pull/11279#pullrequestreview-401263614", "createdAt": "2020-04-27T19:33:07Z", "commit": {"oid": "6e2d0d22991dd548501a93c808de8896f6fc2340"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4752, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}