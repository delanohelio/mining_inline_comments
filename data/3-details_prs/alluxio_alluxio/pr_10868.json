{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjQ3NTkz", "number": 10868, "title": "Refactor the client cache to use string file id", "bodyText": "This allows certain client filesystem to use UUID as file id without worrying about collision.", "createdAt": "2020-02-07T23:49:17Z", "url": "https://github.com/Alluxio/alluxio/pull/10868", "merged": true, "mergeCommit": {"oid": "5230d8eb81507fac665476eca0e0c75e39de0680"}, "closed": true, "closedAt": "2020-02-12T07:24:15Z", "author": {"login": "bf8086"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDYrR7gH2gAyMzcyNjQ3NTkzOmU1NjUxZWNhNWE0NjIzNWM3MmZhM2NjMTc2YTZmOTY2MzlhOGQxNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDhIfoAFqTM1NzIzMjUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5651eca5a46235c72fa3cc176a6f96639a8d14d", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/e5651eca5a46235c72fa3cc176a6f96639a8d14d", "committedDate": "2020-02-11T21:32:51Z", "message": "refactor the client cache to use string file id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa5f6ab0cde6949fbdb6bfb103c29160f212651f", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/aa5f6ab0cde6949fbdb6bfb103c29160f212651f", "committedDate": "2020-02-11T21:34:55Z", "message": "fix checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bfb4dd538837e3488a970fea99032c1686d99bc", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7bfb4dd538837e3488a970fea99032c1686d99bc", "committedDate": "2020-02-11T21:34:56Z", "message": "fix FileIno equality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78b78dbd05de5d2a552e96a3ac53e07b219829d", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d78b78dbd05de5d2a552e96a3ac53e07b219829d", "committedDate": "2020-02-11T21:38:51Z", "message": "fix unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47497e50a18ec27e55e5d64298ffc457c848a601", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/47497e50a18ec27e55e5d64298ffc457c848a601", "committedDate": "2020-02-08T00:03:55Z", "message": "fix FileIno equality"}, "afterCommit": {"oid": "d78b78dbd05de5d2a552e96a3ac53e07b219829d", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d78b78dbd05de5d2a552e96a3ac53e07b219829d", "committedDate": "2020-02-11T21:38:51Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/8356f8da93560af872e511a07d8bc6ae1ba16aa0", "committedDate": "2020-02-12T00:15:23Z", "message": "fix read small page and add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTE1MjQw", "url": "https://github.com/Alluxio/alluxio/pull/10868#pullrequestreview-357115240", "createdAt": "2020-02-12T00:25:53Z", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNTo1NFrOFod_eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNTo1NFrOFod_eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3ODc0NA==", "bodyText": "Good catch", "url": "https://github.com/Alluxio/alluxio/pull/10868#discussion_r377978744", "createdAt": "2020-02-12T00:25:54Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java", "diffHunk": "@@ -112,12 +112,13 @@ public int read(byte[] b, int off, int len) throws IOException {\n       return -1;\n     }\n     int bytesRead = 0;\n+    long lengthToRead = Math.min(len, mStatus.getLength() - mPosition);\n     // for each page, check if it is available in the cache\n-    while (bytesRead < len && mPosition < mStatus.getLength()) {\n+    while (bytesRead < lengthToRead) {\n       long currentPage = mPosition / mPageSize;\n       int currentPageOffset = (int) (mPosition % mPageSize);\n-      int bytesLeftInPage = (int) Math.min(mPageSize - currentPageOffset, len - bytesRead);\n-      PageId pageId = new PageId(mStatus.getFileId(), currentPage);\n+      int bytesLeftInPage = (int) Math.min(mPageSize - currentPageOffset, lengthToRead - bytesRead);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTE1NjQ2", "url": "https://github.com/Alluxio/alluxio/pull/10868#pullrequestreview-357115646", "createdAt": "2020-02-12T00:27:02Z", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNzowMlrOFoeAxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNzowMlrOFoeAxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3OTA3OQ==", "bodyText": "Is it intentional to reverse the key order?", "url": "https://github.com/Alluxio/alluxio/pull/10868#discussion_r377979079", "createdAt": "2020-02-12T00:27:02Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -151,9 +155,10 @@ public void close() {\n   }\n \n   private static byte[] getKeyFromPageId(PageId pageId) {\n-    ByteBuffer buf = ByteBuffer.allocate(KEY_LEN);\n-    buf.putLong(pageId.getFileId());\n+    byte[] fileId = pageId.getFileId().getBytes();\n+    ByteBuffer buf = ByteBuffer.allocate(Long.BYTES + fileId.length);\n     buf.putLong(pageId.getPageIndex());\n+    buf.put(fileId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTE1OTA2", "url": "https://github.com/Alluxio/alluxio/pull/10868#pullrequestreview-357115906", "createdAt": "2020-02-12T00:27:45Z", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNzo0NVrOFoeB0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDoyNzo0NVrOFoeB0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3OTM0Nw==", "bodyText": "Do you know how much more expensive this is compared to getLong?", "url": "https://github.com/Alluxio/alluxio/pull/10868#discussion_r377979347", "createdAt": "2020-02-12T00:27:45Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/RocksPageStore.java", "diffHunk": "@@ -163,12 +168,12 @@ public void close() {\n    */\n   @Nullable\n   private static PageId getPageIdFromKey(byte[] key) {\n-    if (key.length != KEY_LEN) {\n+    if (key.length < Long.BYTES) {\n       return null;\n     }\n     ByteBuffer buf = ByteBuffer.wrap(key);\n-    long fileId = buf.getLong();\n     long pageIndex = buf.getLong();\n+    String fileId = Charset.defaultCharset().decode(buf).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTI5NDQy", "url": "https://github.com/Alluxio/alluxio/pull/10868#pullrequestreview-357129442", "createdAt": "2020-02-12T01:09:14Z", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjMyNTMw", "url": "https://github.com/Alluxio/alluxio/pull/10868#pullrequestreview-357232530", "createdAt": "2020-02-12T07:24:00Z", "commit": {"oid": "8356f8da93560af872e511a07d8bc6ae1ba16aa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3219, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}