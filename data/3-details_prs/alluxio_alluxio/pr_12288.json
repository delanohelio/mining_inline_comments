{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTM3ODQy", "number": 12288, "title": "Fix LostStorageIntegrationTest failure on user 'root'", "bodyText": "Fix #12187\nWith this PR, root user and none-root user can pass the LostStorageIntegrationTest by exexuted\n# mvn test -Dtest=LostStorageIntegrationTest -pl tests\nthe following is the test by root user.\n[root@c2eaf3f187f2 alluxio]# /softwares/apache-maven-3.6.3/bin/mvn test -Dtest=LostStorageIntegrationTest -pl tests\n[INFO] Scanning for projects...\n[WARNING]\n[WARNING] Some problems were encountered while building the effective model for org.alluxio:alluxio-shaded-hadoop:jar:3.3.0\n[WARNING] 'version' contains an expression but should be a constant. @ org.alluxio:alluxio-shaded-hadoop:${ufs.hadoop.version}, /projects/github/alluxio/shaded/hadoop/pom.xml, line 23, column 12\n[WARNING]\n[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.\n[WARNING]\n[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.\n[WARNING]\n[INFO]\n[INFO] ---------------------< org.alluxio:alluxio-tests >----------------------\n[INFO] Building Alluxio Tests 2.4.0-SNAPSHOT\n[INFO] --------------------------------[ jar ]---------------------------------\n[INFO]\n[INFO] --- maven-enforcer-plugin:3.0.0-M3:enforce (enforce-maven) @ alluxio-tests ---\n[INFO]\n[INFO] --- maven-enforcer-plugin:3.0.0-M3:enforce (enforce-versions) @ alluxio-tests ---\n[INFO]\n[INFO] --- maven-checkstyle-plugin:2.17:check (checkstyle) @ alluxio-tests ---\n[INFO] Starting audit...\nAudit done.\n[INFO]\n[INFO] --- license-maven-plugin:4.0.rc1:check (default) @ alluxio-tests ---\n[INFO] Checking licenses...\n[WARNING] Unable to find a comment style definition for some files. You may want to add a custom mapping for the relevant file extensions.\n[INFO]\n[INFO] --- maven-resources-plugin:2.7:resources (default-resources) @ alluxio-tests ---\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\n[INFO] skip non existing resourceDirectory /projects/github/alluxio/tests/src/main/resources\n[INFO]\n[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ alluxio-tests ---\n[INFO] Changes detected - recompiling the module!\n[INFO] Compiling 16 source files to /projects/github/alluxio/tests/target/classes\n[INFO] /projects/github/alluxio/tests/src/main/java/alluxio/master/backcompat/BackwardsCompatibilityJournalGenerator.java: Some input files use or override a deprecated API.\n[INFO] /projects/github/alluxio/tests/src/main/java/alluxio/master/backcompat/BackwardsCompatibilityJournalGenerator.java: Recompile with -Xlint:deprecation for details.\n[INFO]\n[INFO] >>> spotbugs-maven-plugin:4.0.4:check (default) > :spotbugs @ alluxio-tests >>>\n[INFO]\n[INFO] --- spotbugs-maven-plugin:4.0.4:spotbugs (spotbugs) @ alluxio-tests ---\n[INFO] Fork Value is true\n[INFO] Done SpotBugs Analysis....\n[INFO]\n[INFO] <<< spotbugs-maven-plugin:4.0.4:check (default) < :spotbugs @ alluxio-tests <<<\n[INFO]\n[INFO]\n[INFO] --- spotbugs-maven-plugin:4.0.4:check (default) @ alluxio-tests ---\n[INFO] BugInstance size is 0\n[INFO] Error size is 0\n[INFO] No errors/warnings found\n[INFO]\n[INFO] --- jcp:6.1.2:preprocessTests (preprocessSources) @ alluxio-tests ---\n[INFO] Preprocess sources : /projects/github/alluxio/tests/src/test/java\n[INFO] Preprocess destination : /projects/github/alluxio/tests/target/generated-test-sources/preprocessed\n[INFO] -----------------------------------------------------------------\n[INFO] Completed, preprocessed 209 files, copied 0 files, elapsed time 14016ms\n[INFO] A Compile source root has been removed from the root list [/projects/github/alluxio/tests/src/test/java]\n[INFO] The New compile source root has been added into the list [/projects/github/alluxio/tests/target/generated-test-sources/preprocessed]\n[INFO]\n[INFO] --- maven-resources-plugin:2.7:testResources (default-testResources) @ alluxio-tests ---\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\n[INFO] Copying 10 resources\n[INFO]\n[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ alluxio-tests ---\n[INFO] Changes detected - recompiling the module!\n[INFO] Compiling 201 source files to /projects/github/alluxio/tests/target/test-classes\n[INFO] /projects/github/alluxio/tests/target/generated-test-sources/preprocessed/alluxio/client/fs/FileSystemMasterRestartIntegrationTest.java: Some input files use or override a deprecated API.\n[INFO] /projects/github/alluxio/tests/target/generated-test-sources/preprocessed/alluxio/client/fs/FileSystemMasterRestartIntegrationTest.java: Recompile with -Xlint:deprecation for details.\n[INFO] /projects/github/alluxio/tests/target/generated-test-sources/preprocessed/alluxio/server/ft/MasterFaultToleranceIntegrationTest.java: Some input files use unchecked or unsafe operations.\n[INFO] /projects/github/alluxio/tests/target/generated-test-sources/preprocessed/alluxio/server/ft/MasterFaultToleranceIntegrationTest.java: Recompile with -Xlint:unchecked for details.\n[INFO]\n[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ alluxio-tests ---\n[INFO]\n[INFO] -------------------------------------------------------\n[INFO]  T E S T S\n[INFO] -------------------------------------------------------\n[INFO] Running alluxio.server.tieredstore.LostStorageIntegrationTest\n[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 112.123 s - in alluxio.server.tieredstore.LostStorageIntegrationTest\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  06:03 min\n[INFO] Finished at: 2020-10-14T03:20:08Z\n[INFO] ------------------------------------------------------------------------", "createdAt": "2020-10-14T06:19:00Z", "url": "https://github.com/Alluxio/alluxio/pull/12288", "merged": true, "mergeCommit": {"oid": "8b481d01ea51288f2911a55512abe559fc5f6714"}, "closed": true, "closedAt": "2020-10-15T05:13:28Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSUgX4AH2gAyNTAzMTM3ODQyOjE2ZGQyZmZkMWY1NWQzZjk0Y2FmMDk2ODBiOGVmNTkwNDkwMDA5N2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSqtIlgFqTUwODk0MTUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16dd2ffd1f55d3f94caf09680b8ef5904900097c", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/16dd2ffd1f55d3f94caf09680b8ef5904900097c", "committedDate": "2020-10-14T03:21:20Z", "message": "Fix LostStorageIntegrationTest failure on user 'root'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjIyNzM2", "url": "https://github.com/Alluxio/alluxio/pull/12288#pullrequestreview-508622736", "createdAt": "2020-10-14T18:33:53Z", "commit": {"oid": "16dd2ffd1f55d3f94caf09680b8ef5904900097c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODozMzo1M1rOHhf_yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODozNzo0OVrOHhgIoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4OTI5MQ==", "bodyText": "Please fix the comment way", "url": "https://github.com/Alluxio/alluxio/pull/12288#discussion_r504889291", "createdAt": "2020-10-14T18:33:53Z", "author": {"login": "LuQQiu"}, "path": "tests/src/test/java/alluxio/server/tieredstore/LostStorageIntegrationTest.java", "diffHunk": "@@ -60,9 +78,21 @@ public void reportLostStorageInWorkerRegister() throws Exception {\n     File hddDir = Files.createTempDir();\n     String hddPath = hddDir.getAbsolutePath();\n \n-    // Set to read only so worker storage paths cannot be initialize\n-    ssdDir.setReadOnly();\n-    hddDir.setReadOnly();\n+//    // Mock no write permission so worker storage paths cannot be initialize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16dd2ffd1f55d3f94caf09680b8ef5904900097c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MTU1Mw==", "bodyText": "Why need two mockito mock?\ncan the path be strings other than ssdPath and hdd path?", "url": "https://github.com/Alluxio/alluxio/pull/12288#discussion_r504891553", "createdAt": "2020-10-14T18:37:49Z", "author": {"login": "LuQQiu"}, "path": "tests/src/test/java/alluxio/server/tieredstore/LostStorageIntegrationTest.java", "diffHunk": "@@ -60,9 +78,21 @@ public void reportLostStorageInWorkerRegister() throws Exception {\n     File hddDir = Files.createTempDir();\n     String hddPath = hddDir.getAbsolutePath();\n \n-    // Set to read only so worker storage paths cannot be initialize\n-    ssdDir.setReadOnly();\n-    hddDir.setReadOnly();\n+//    // Mock no write permission so worker storage paths cannot be initialize\n+    PowerMockito.mockStatic(StorageDir.class);\n+    Mockito.when(StorageDir.newStorageDir(any(StorageTier.class),\n+        anyInt(),\n+        anyLong(),\n+        anyLong(),\n+        anyString(),\n+        anyString())).thenCallRealMethod();\n+    Mockito.when(StorageDir.newStorageDir(any(StorageTier.class),\n+        anyInt(),\n+        anyLong(),\n+        anyLong(),\n+        or(startsWith(ssdPath), startsWith(hddPath)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16dd2ffd1f55d3f94caf09680b8ef5904900097c"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/Alluxio/alluxio/commit/483e5392d3ad598852e6e93cc4e337c8b741dfc2", "committedDate": "2020-10-14T23:50:25Z", "message": "Fix the comment way"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODQ5MDA0", "url": "https://github.com/Alluxio/alluxio/pull/12288#pullrequestreview-508849004", "createdAt": "2020-10-14T23:57:45Z", "commit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODUwMTE4", "url": "https://github.com/Alluxio/alluxio/pull/12288#pullrequestreview-508850118", "createdAt": "2020-10-15T00:01:03Z", "commit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDowMTowM1rOHhsFRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDowMTowM1rOHhsFRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4NzMwMw==", "bodyText": "is this because StorageDir is final?\nIn case yes, lets change public final class StorageDir to be public class StorageDir.\nIn general, we should avoid using PowerMock which has a lot limitation", "url": "https://github.com/Alluxio/alluxio/pull/12288#discussion_r505087303", "createdAt": "2020-10-15T00:01:03Z", "author": {"login": "apc999"}, "path": "tests/src/test/java/alluxio/server/tieredstore/LostStorageIntegrationTest.java", "diffHunk": "@@ -38,6 +53,9 @@\n /**\n  * Tests for getting worker lost storage information.\n  */\n+@RunWith(PowerMockRunner.class)\n+@PrepareForTest({StorageDir.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODUwNzgx", "url": "https://github.com/Alluxio/alluxio/pull/12288#pullrequestreview-508850781", "createdAt": "2020-10-15T00:03:00Z", "commit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTQxNTEy", "url": "https://github.com/Alluxio/alluxio/pull/12288#pullrequestreview-508941512", "createdAt": "2020-10-15T05:13:11Z", "commit": {"oid": "483e5392d3ad598852e6e93cc4e337c8b741dfc2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3549, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}