{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDg3NDE2", "number": 12368, "title": "Support passing FileOpener for local cache", "bodyText": "", "createdAt": "2020-10-22T18:43:37Z", "url": "https://github.com/Alluxio/alluxio/pull/12368", "merged": true, "mergeCommit": {"oid": "a98c6dbe312a125ee09daf4fa08c7498cd67e951"}, "closed": true, "closedAt": "2020-10-23T18:24:58Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVGe7-AH2gAyNTA4NDg3NDE2OjY5YzUxZmVhMzQyYzYwZWM3NmU0OTU0MDc0YmJmMmVkODMyYzYxNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVZ1yGgFqTUxNTg1OTQ1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/69c51fea342c60ec76e4954074bbf2ed832c6170", "committedDate": "2020-10-22T18:42:52Z", "message": "Support customized way to open InputStream for local cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDI2ODQ4", "url": "https://github.com/Alluxio/alluxio/pull/12368#pullrequestreview-515026848", "createdAt": "2020-10-22T18:54:55Z", "commit": {"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODo1NDo1NlrOHmvgSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTowNTozNlrOHmv4xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NjI1MA==", "bodyText": "Could we call this mExternalFileOpener?", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510386250", "createdAt": "2020-10-22T18:54:56Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java", "diffHunk": "@@ -48,13 +46,11 @@\n \n   /** Local store to store pages. */\n   private final CacheManager mCacheManager;\n-  /** External storage system. */\n-  private final FileSystem mExternalFs;\n   /** Path of the file. */\n   private final AlluxioURI mPath;\n   /** File info, fetched from external FS. */\n   private final URIStatus mStatus;\n-  private final OpenFilePOptions mOpenOptions;\n+  private final FileInStreamOpener mFileInStreamOpener;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NzE0MA==", "bodyText": "Will this cause a performance regression because getStatus will no longer be called lazily?", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510387140", "createdAt": "2020-10-22T18:56:26Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileSystem.java", "diffHunk": "@@ -56,7 +56,7 @@ public FileInStream openFile(AlluxioURI path, OpenFilePOptions options)\n     if (mCacheManager == null || mCacheManager.state() == CacheManager.State.NOT_IN_USE) {\n       return mDelegatedFileSystem.openFile(path, options);\n     }\n-    return new LocalCacheFileInStream(path, options, mDelegatedFileSystem, mCacheManager);\n+    return openFile(mDelegatedFileSystem.getStatus(path), options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MjUxOA==", "bodyText": "Do we only need 2 of these three methods? ie. the interface open(Path, int) and implementation open(URIStatus, int)? We should always use the hadoop file opener if cache is not enabled?\nAlso, buffer size is only respected if the cache is not enabled?", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510392518", "createdAt": "2020-10-22T19:05:36Z", "author": {"login": "calvinjia"}, "path": "core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java", "diffHunk": "@@ -112,10 +121,8 @@ public FSDataInputStream open(Path path, int bufferSize) throws IOException {\n     if (mCacheManager == null) {\n       return mExternalFileSystem.open(path, bufferSize);\n     }\n-    return new FSDataInputStream(new HdfsFileInputStream(\n-        new LocalCacheFileInStream(new AlluxioURI(path.toString()),\n-            OpenFilePOptions.getDefaultInstance(), mExternalFileSystemWrapper, mCacheManager),\n-        statistics));\n+    URIStatus status = HadoopUtils.toAlluxioUriStatus(mExternalFileSystem.getFileStatus(path));\n+    return open(status, bufferSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b1a64c2550981c2aa4d60da62bc87c01eca792", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/a2b1a64c2550981c2aa4d60da62bc87c01eca792", "committedDate": "2020-10-23T07:57:39Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODU5NDU4", "url": "https://github.com/Alluxio/alluxio/pull/12368#pullrequestreview-515859458", "createdAt": "2020-10-23T17:16:01Z", "commit": {"oid": "a2b1a64c2550981c2aa4d60da62bc87c01eca792"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3475, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}