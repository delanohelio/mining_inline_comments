{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2ODY5Mjk2", "number": 10936, "title": "Make the addition of client metrics heartbeats asynchronous", "bodyText": "When client metrics is enabled, the master starts up takes four more minutes. The four more minutes are taken by PollingMasterInquireClient.getPrimaryRpcAddress  in FileSystemContext.initContext. getPrimaryRpcAddress() retries 44 times and takes 2 minutes each call which heavily delays the master starts up. The primary rpc address is used for load configuration from the leading master and initialize metrics heartbeat.\nThis PR put the load configuration logics in the metrics heartbeat thread, so that client metrics logic in FileSystemContext will not block actual operations.", "createdAt": "2020-02-18T22:31:19Z", "url": "https://github.com/Alluxio/alluxio/pull/10936", "merged": true, "mergeCommit": {"oid": "7c311906421137822deee83c50a5d8b06fb8b1da"}, "closed": true, "closedAt": "2020-02-21T18:37:45Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFrG_-AFqTM2MDc2Mjg5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGj-BbgFqTM2MjgyNTk0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzYyODk4", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-360762898", "createdAt": "2020-02-19T00:09:15Z", "commit": {"oid": "834c162f27a67587892ef287ecf5623aa5d8097b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDowOToxNVrOFrW81g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDowOToxNVrOFrW81g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwOTExMA==", "bodyText": "Does it make sense to report client metrics at all from the master?", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r381009110", "createdAt": "2020-02-19T00:09:15Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -231,14 +232,16 @@ private synchronized void initContext(ClientContext ctx,\n         .setMasterInquireClient(masterInquireClient).build();\n     mMetricsEnabled = getClusterConf().getBoolean(PropertyKey.USER_METRICS_COLLECTION_ENABLED);\n     if (mMetricsEnabled) {\n-      try {\n-        InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();\n-        mMasterClientContext.loadConf(masterAddr, true, true);\n-      } catch (UnavailableException e) {\n-        LOG.error(\"Failed to get master address during initialization\", e);\n-      } catch (AlluxioStatusException ae) {\n-        LOG.error(\"Failed to load configuration from \"\n-            + \"meta master during initialization\", ae);\n+      if (CommonUtils.PROCESS_TYPE.get() != CommonUtils.ProcessType.MASTER) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "834c162f27a67587892ef287ecf5623aa5d8097b"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzcwNDc2", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-360770476", "createdAt": "2020-02-19T00:32:26Z", "commit": {"oid": "2883f8d0f0677f5e453a76ba922823225f619516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDozMjoyNlrOFrXVhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDozMjoyNlrOFrXVhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNTQyOQ==", "bodyText": "I don't understand why this would take longer if the process is the master. Is there some kind of race condition?", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r381015429", "createdAt": "2020-02-19T00:32:26Z", "author": {"login": "ZacBlanco"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -230,8 +231,11 @@ private synchronized void initContext(ClientContext ctx,\n     mMasterClientContext = MasterClientContext.newBuilder(ctx)\n         .setMasterInquireClient(masterInquireClient).build();\n     mMetricsEnabled = getClusterConf().getBoolean(PropertyKey.USER_METRICS_COLLECTION_ENABLED);\n-    if (mMetricsEnabled) {\n+    if (mMetricsEnabled && CommonUtils.PROCESS_TYPE.get() != CommonUtils.ProcessType.MASTER) {\n+      // TODO(lu) report clients metrics in master process\n       try {\n+        // clients may be used in the master process before master starts.\n+        // Retry getting master addresses in this circumstance may block master starting up\n         InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2883f8d0f0677f5e453a76ba922823225f619516"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzczNzk1", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-360773795", "createdAt": "2020-02-19T00:42:44Z", "commit": {"oid": "2883f8d0f0677f5e453a76ba922823225f619516"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzIwMDQw", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362320040", "createdAt": "2020-02-20T23:57:43Z", "commit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1Nzo0NFrOFsnYPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1Nzo0NFrOFsnYPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNjg0NQ==", "bodyText": "It seems out of place to start the metric system in the heartbeat.", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r382326845", "createdAt": "2020-02-20T23:57:44Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/metrics/MetricsHeartbeatContext.java", "diffHunk": "@@ -177,13 +206,43 @@ public static synchronized void addHeartbeat(ClientContext ctx,\n           sAppId, PropertyKey.Name.USER_APP_ID);\n     }\n \n+    if (MetricsSystem.getNumSinks() == 0) {\n+      MetricsSystem.startSinks(ctx.getClusterConf().get(PropertyKey.METRICS_CONF_FILE));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzIxMDQ0", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362321044", "createdAt": "2020-02-21T00:00:30Z", "commit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDowMDozMFrOFsnblA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDowMDozMFrOFsnblA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNzcwMA==", "bodyText": "Is it necessary to start the metrics system asynchronously? Only the heartbeat needs the master address right? Instead of computing master address, could we compute it lazily during the heartbeat call (and thus use the heartbeat thread, making the submission of the heartbeat thread lightweight)?", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r382327700", "createdAt": "2020-02-21T00:00:30Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -231,17 +230,7 @@ private synchronized void initContext(ClientContext ctx,\n         .setMasterInquireClient(masterInquireClient).build();\n     mMetricsEnabled = getClusterConf().getBoolean(PropertyKey.USER_METRICS_COLLECTION_ENABLED);\n     if (mMetricsEnabled) {\n-      try {\n-        InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();\n-        mMasterClientContext.loadConf(masterAddr, true, true);\n-      } catch (UnavailableException e) {\n-        LOG.error(\"Failed to get master address during initialization\", e);\n-      } catch (AlluxioStatusException ae) {\n-        LOG.error(\"Failed to load configuration from \"\n-            + \"meta master during initialization\", ae);\n-      }\n-      MetricsSystem.startSinks(getClusterConf().get(PropertyKey.METRICS_CONF_FILE));\n-      MetricsHeartbeatContext.addHeartbeat(getClientContext(), masterInquireClient);\n+      MetricsHeartbeatContext.asyncAddHeartbeat(getClientContext(), masterInquireClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzIxMzc1", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362321375", "createdAt": "2020-02-21T00:01:27Z", "commit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzIxNDM4", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362321438", "createdAt": "2020-02-21T00:01:40Z", "commit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDowMTo0MVrOFsnc-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDowMTo0MVrOFsnc-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyODA1Nw==", "bodyText": "10 seconds seems like a long shutdown timeout to me. For metrics, I would prefer it to have as little impact as possible on the shutdown of the JVM. Maybe 2-3 seconds is better?", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r382328057", "createdAt": "2020-02-21T00:01:41Z", "author": {"login": "ZacBlanco"}, "path": "core/client/fs/src/main/java/alluxio/client/metrics/MetricsHeartbeatContext.java", "diffHunk": "@@ -52,6 +59,7 @@\n @ThreadSafe\n public class MetricsHeartbeatContext {\n   private static final Logger LOG = LoggerFactory.getLogger(MetricsHeartbeatContext.class);\n+  private static final long SHUTDOWN_TIMEOUT_MS = 10 * Constants.SECOND_MS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5abb10f03caefad7e09de2249bf76c65dd436fb", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f5abb10f03caefad7e09de2249bf76c65dd436fb", "committedDate": "2020-02-21T01:59:01Z", "message": "Put the getPrimaryRpc and loadConf logics into the ClientMasterSync heartbeat thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5fa84cc87ff666b7a2ce8320c0f6ca257293079", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f5fa84cc87ff666b7a2ce8320c0f6ca257293079", "committedDate": "2020-02-20T01:19:59Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "f5abb10f03caefad7e09de2249bf76c65dd436fb", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f5abb10f03caefad7e09de2249bf76c65dd436fb", "committedDate": "2020-02-21T01:59:01Z", "message": "Put the getPrimaryRpc and loadConf logics into the ClientMasterSync heartbeat thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzYwMjEx", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362360211", "createdAt": "2020-02-21T02:07:48Z", "commit": {"oid": "f5abb10f03caefad7e09de2249bf76c65dd436fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMjowNzo0OFrOFspgvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMjowNzo0OFrOFspgvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM2MTc5MQ==", "bodyText": "Should we still create mMasterClient when we fail above? Since heartbeat will be called periodically, it might be easier to just no-op this heartbeat and try again next time?", "url": "https://github.com/Alluxio/alluxio/pull/10936#discussion_r382361791", "createdAt": "2020-02-21T02:07:48Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/metrics/ClientMasterSync.java", "diffHunk": "@@ -85,4 +94,32 @@ public synchronized void heartbeat() {\n       SAMPLING_LOG.warn(\"Failed to send metrics to master: {}\", e.toString());\n     }\n   }\n+\n+  /**\n+   * Close the metrics master client.\n+   */\n+  public synchronized void close() {\n+    if (mMasterClient != null) {\n+      mMasterClient.close();\n+    }\n+  }\n+\n+  /**\n+   * Loads configuration and initialize metrics master client.\n+   */\n+  private void loadConfAndInitClient() {\n+    try {\n+      InetSocketAddress masterAddr = mInquireClient.getPrimaryRpcAddress();\n+      mContext.loadConf(masterAddr, true, true);\n+    } catch (UnavailableException e) {\n+      SAMPLING_LOG.error(\"Failed to get master address during initialization: {}\", e.toString());\n+    } catch (AlluxioStatusException ae) {\n+      SAMPLING_LOG.error(\"Failed to load configuration from \"\n+          + \"meta master during initialization: {}\", ae.toString());\n+    }\n+    mMasterClient = new RetryHandlingMetricsMasterClient(MasterClientContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5abb10f03caefad7e09de2249bf76c65dd436fb"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f155b4f9149e44d259de0ab47c29165d05b242a", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/6f155b4f9149e44d259de0ab47c29165d05b242a", "committedDate": "2020-02-21T02:39:15Z", "message": "If loadConf failed, no heartbeat will be triggered"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzkzNDYx", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362393461", "createdAt": "2020-02-21T04:28:57Z", "commit": {"oid": "6f155b4f9149e44d259de0ab47c29165d05b242a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODI1OTQ4", "url": "https://github.com/Alluxio/alluxio/pull/10936#pullrequestreview-362825948", "createdAt": "2020-02-21T18:24:03Z", "commit": {"oid": "6f155b4f9149e44d259de0ab47c29165d05b242a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4991, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}