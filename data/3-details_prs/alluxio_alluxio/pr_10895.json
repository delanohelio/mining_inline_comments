{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MjY2NjU3", "number": 10895, "title": "Pass readonly option on root mount", "bodyText": "This resolves issue #10812 (comment)\nCorrectly propagate root mount options alluxio.master.mount.table.root.readonly to MountTable\nAfter the change:\n$ bin/alluxio fs mount                                                                                     \n/xxx/alluxio/underFSStorage  on  /  (local, capacity=420.03GB, used=-1B(0%), read-only, not shared, properties={})\n$ bin/alluxio getConf --master | grep readonly\nalluxio.master.mount.table.root.readonly=true\nalluxio.underfs.object.store.mount.shared.publicly=false\n$ bin/alluxio fs copyFromLocal ./LICENSE /LICENSE                                                          \nA write operation on /LICENSE under a readonly mount point / is not allowed", "createdAt": "2020-02-12T11:54:54Z", "url": "https://github.com/Alluxio/alluxio/pull/10895", "merged": true, "mergeCommit": {"oid": "68a4842db751c1a9cef943c59fb635e9f932ca2e"}, "closed": true, "closedAt": "2020-02-13T16:55:36Z", "author": {"login": "jiacheliu3"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDTkHdAH2gAyMzc0MjY2NjU3OmZhZmIwZjdhNzNkN2U4NTExZTVlMTU5MzBjMWM2MmI4NjIyNjI5YWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD957MAFqTM1ODM4NjQxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fafb0f7a73d7e8511e5e15930c1c62b8622629ae", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/fafb0f7a73d7e8511e5e15930c1c62b8622629ae", "committedDate": "2020-02-11T15:35:30Z", "message": "debug root mount issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9ec19bb463d57813a3700d2580adb26f18b4b88", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/f9ec19bb463d57813a3700d2580adb26f18b4b88", "committedDate": "2020-02-12T11:52:15Z", "message": "propagate readonly and shared field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45f5e1cb1262708ee25611b307c89de914f032e4", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/45f5e1cb1262708ee25611b307c89de914f032e4", "committedDate": "2020-02-12T12:11:20Z", "message": "revert debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e000d739f49b7473f31f5783cf63eb8224d389b5", "committedDate": "2020-02-12T12:57:06Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDU0NTM3", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-357454537", "createdAt": "2020-02-12T13:36:17Z", "commit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDk2MTI1", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-357496125", "createdAt": "2020-02-12T14:30:29Z", "commit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNDozMDoyOVrOFowuRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNDozMDoyOVrOFowuRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI4NTYzNg==", "bodyText": "@gpang Does the original implementation look like a bug to you?", "url": "https://github.com/Alluxio/alluxio/pull/10895#discussion_r378285636", "createdAt": "2020-02-12T14:30:29Z", "author": {"login": "jiacheliu3"}, "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -456,13 +456,22 @@ public DefaultFileSystemMaster(BlockMaster blockMaster, CoreMasterContext master\n \n   private static MountInfo getRootMountInfo(MasterUfsManager ufsManager) {\n     try (CloseableResource<UnderFileSystem> resource = ufsManager.getRoot().acquireUfsResource()) {\n+      boolean shared;\n+      if (resource.get().isObjectStorage()) {\n+        shared = ServerConfiguration.getBoolean(\n+                PropertyKey.UNDERFS_OBJECT_STORE_MOUNT_SHARED_PUBLICLY);\n+      } else {\n+        shared = ServerConfiguration.getBoolean(\n+                PropertyKey.MASTER_MOUNT_TABLE_ROOT_SHARED);\n+      }\n+      boolean readonly = ServerConfiguration.getBoolean(\n+              PropertyKey.MASTER_MOUNT_TABLE_ROOT_READONLY);\n       String rootUfsUri = ServerConfiguration.get(PropertyKey.MASTER_MOUNT_TABLE_ROOT_UFS);\n-      boolean shared = resource.get().isObjectStorage()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97d202e23df8624408ef7d5699d85889de4dbd20", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/97d202e23df8624408ef7d5699d85889de4dbd20", "committedDate": "2020-02-12T14:35:02Z", "message": "revert change on property 'shared'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTE3NDky", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-357517492", "createdAt": "2020-02-12T14:55:28Z", "commit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNDo1NToyOVrOFoxtnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNDo1NToyOVrOFoxtnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMwMTg1Mw==", "bodyText": "I tried to update shared to this logic which seems more correct. And subsequently found issue #10896\nThe issue related to shared seems deeper than I thought. I will revert the change regarding shared field and focus on readonly in this PR. I will attempt on the shared field in a separate PR later.", "url": "https://github.com/Alluxio/alluxio/pull/10895#discussion_r378301853", "createdAt": "2020-02-12T14:55:29Z", "author": {"login": "jiacheliu3"}, "path": "core/server/master/src/main/java/alluxio/master/file/DefaultFileSystemMaster.java", "diffHunk": "@@ -456,13 +456,22 @@ public DefaultFileSystemMaster(BlockMaster blockMaster, CoreMasterContext master\n \n   private static MountInfo getRootMountInfo(MasterUfsManager ufsManager) {\n     try (CloseableResource<UnderFileSystem> resource = ufsManager.getRoot().acquireUfsResource()) {\n+      boolean shared;\n+      if (resource.get().isObjectStorage()) {\n+        shared = ServerConfiguration.getBoolean(\n+                PropertyKey.UNDERFS_OBJECT_STORE_MOUNT_SHARED_PUBLICLY);\n+      } else {\n+        shared = ServerConfiguration.getBoolean(\n+                PropertyKey.MASTER_MOUNT_TABLE_ROOT_SHARED);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e000d739f49b7473f31f5783cf63eb8224d389b5"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ac2730a5ac1f93a82f511b138b7f637f81d141e", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/3ac2730a5ac1f93a82f511b138b7f637f81d141e", "committedDate": "2020-02-13T15:07:02Z", "message": "added integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7167c829da64efe58f8e497b0f432905c56ef2eb", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/7167c829da64efe58f8e497b0f432905c56ef2eb", "committedDate": "2020-02-13T15:19:07Z", "message": "indentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzQ4Mzg0", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-358348384", "createdAt": "2020-02-13T16:10:05Z", "commit": {"oid": "7167c829da64efe58f8e497b0f432905c56ef2eb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoxMDowNVrOFpZ7Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoxMDowNVrOFpZ7Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk2MDY3NQ==", "bodyText": "Can we make this a ClassRule so we dont have to re-create the cluster for each test? Starting a cluster is costly. (I think this also means the variable will have to be static)", "url": "https://github.com/Alluxio/alluxio/pull/10895#discussion_r378960675", "createdAt": "2020-02-13T16:10:05Z", "author": {"login": "gpang"}, "path": "tests/src/test/java/alluxio/client/fs/FileSystemReadonlyTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static junit.framework.TestCase.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.conf.PropertyKey;\n+import alluxio.conf.ServerConfiguration;\n+import alluxio.exception.AccessControlException;\n+import alluxio.master.file.FileSystemMaster;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.wire.MountPointInfo;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.util.Map;\n+\n+/**\n+ * Test behavior of {@link FileSystemMaster}, when the paths are readonly.\n+ */\n+public class FileSystemReadonlyTest {\n+  @Rule", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7167c829da64efe58f8e497b0f432905c56ef2eb"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c21423529060ae3fe5aa2d7a8d74ac186bf2f6f8", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/c21423529060ae3fe5aa2d7a8d74ac186bf2f6f8", "committedDate": "2020-02-13T16:18:58Z", "message": "classrule for test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzcwMjM3", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-358370237", "createdAt": "2020-02-13T16:36:03Z", "commit": {"oid": "c21423529060ae3fe5aa2d7a8d74ac186bf2f6f8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Mzg2NDEy", "url": "https://github.com/Alluxio/alluxio/pull/10895#pullrequestreview-358386412", "createdAt": "2020-02-13T16:55:20Z", "commit": {"oid": "c21423529060ae3fe5aa2d7a8d74ac186bf2f6f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4937, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}