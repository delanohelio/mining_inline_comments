{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NzQ2ODQ1", "number": 12101, "title": "Improve entrypoint.sh to better support dynamic non-root user", "bodyText": "When running with non-root user in alluxio-worker container, non-root user may not have the write permission to the tiered store directories. This PR fixed this issue by changing the permission of tiered store dirs to 777.", "createdAt": "2020-09-11T07:27:05Z", "url": "https://github.com/Alluxio/alluxio/pull/12101", "merged": true, "mergeCommit": {"oid": "1933ed3632030dd766b8df8be5a7038cc9bec00b"}, "closed": true, "closedAt": "2020-10-21T07:03:36Z", "author": {"login": "iluoeli"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHsaQAAH2gAyNDg0NzQ2ODQ1OjgxMmNmYjFhMDRiMjkwM2Y4OTI0NmU5YzI4NDRjNTcxNDJiY2Q0ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSoqB9gFqTUwODkwMDU2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "812cfb1a04b2903f89246e9c2844c57142bcd481", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/812cfb1a04b2903f89246e9c2844c57142bcd481", "committedDate": "2020-09-11T02:59:12Z", "message": "Fix entrypoint.sh for supporint dynamic non-root"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/568689d99aad707fbf72eefef19c5f0385cecc50", "committedDate": "2020-09-11T04:59:22Z", "message": "Improve entrypoint.h"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTIyNTIz", "url": "https://github.com/Alluxio/alluxio/pull/12101#pullrequestreview-486922523", "createdAt": "2020-09-11T15:47:04Z", "commit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTo0NzowNFrOHQkP3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTo0NzowNFrOHQkP3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMzE0OA==", "bodyText": "this value may also contain a comma-delimited list of directories. We should handle that case too.", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r487133148", "createdAt": "2020-09-11T15:47:04Z", "author": {"login": "ZacBlanco"}, "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32e4374b9a099a05957c8685391075cf46b791b8", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/32e4374b9a099a05957c8685391075cf46b791b8", "committedDate": "2020-09-21T02:16:07Z", "message": "Support comma-delimited list of directories"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a24bbcad99b77d5dc15530db9f189d115695d2e", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/9a24bbcad99b77d5dc15530db9f189d115695d2e", "committedDate": "2020-09-21T02:25:04Z", "message": "Small fix of entrypoint.sh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODAyNTQ2", "url": "https://github.com/Alluxio/alluxio/pull/12101#pullrequestreview-492802546", "createdAt": "2020-09-21T16:49:16Z", "commit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjo0OToxN1rOHVZ1oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowMjoyNFrOHVaTag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNTQ3Mg==", "bodyText": "is there a reason the argument was changes from ${ARGS} here to $*?", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r492205472", "createdAt": "2020-09-21T16:49:17Z", "author": {"login": "ZacBlanco"}, "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\\n+          xargs -I {} chmod -R 777 {}\n+      fi\n+      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh $*\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMzA5OA==", "bodyText": "I tested the script and it still doesn't seem to work\nI created directores a1 and a2 in my working directory, the same place I ran this command.\n#!/usr/bin/env bash\nset -x\ntvar=\"-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\"\n\necho \"$tvar\" | tr ' ' '\\n' | \\\ngrep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\ncut -d '=' -f 2 | \\\ngrep -Ev \"^$\" | \\\nxargs -I {} chmod -R 777 {}\n\noutput:\n+ tvar=-Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ echo -Dalluxio.worker.tieredstore.level0.dirs.path=a1,a2\n+ tr ' ' '\\n'\n+ grep 'alluxio.worker.tieredstore.level[0-9].dirs.path'\n+ cut -d = -f 2\n+ grep -Ev '^$'\n+ xargs -I '{}' chmod -R 777 '{}'\nchmod: cannot access 'a1,a2': No such file or directory", "url": "https://github.com/Alluxio/alluxio/pull/12101#discussion_r492213098", "createdAt": "2020-09-21T17:02:24Z", "author": {"login": "ZacBlanco"}, "path": "integration/docker/entrypoint.sh", "diffHunk": "@@ -159,7 +159,16 @@ function setup_for_dynamic_non_root {\n       mkdir -p /journal\n       chown -R ${ALLUXIO_USERNAME}:${ALLUXIO_GROUP} /opt/* /journal\n       chmod -R g=u /opt/* /journal\n-      exec su ${ALLUXIO_USERNAME} -c \"/entrypoint.sh ${ARGS}\"\n+      # Chmod the dirs of tiered stores for alluxio worker\n+      # to ensure write permission for non-root user.\n+      if [[ \"$1\" == \"worker\" || \"$1\" == \"worker-only\" ]]; then\n+        echo \"$ALLUXIO_JAVA_OPTS\" | tr ' ' '\\n' | \\\n+          grep \"alluxio.worker.tieredstore.level[0-9].dirs.path\" | \\\n+          cut -d '=' -f 2 | \\\n+          grep -Ev \"^$\" | \\\n+          xargs -I {} chmod -R 777 {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "568689d99aad707fbf72eefef19c5f0385cecc50"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTAwNTY3", "url": "https://github.com/Alluxio/alluxio/pull/12101#pullrequestreview-508900567", "createdAt": "2020-10-15T02:50:00Z", "commit": {"oid": "9a24bbcad99b77d5dc15530db9f189d115695d2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3575, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}