{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4Mzk0MTI0", "number": 10970, "title": "Fix potential resource leak issues in LocalPageStore", "bodyText": "Close Files.walk stream resource in LocalPageStore", "createdAt": "2020-02-21T17:36:06Z", "url": "https://github.com/Alluxio/alluxio/pull/10970", "merged": true, "mergeCommit": {"oid": "ecef4201c2e0587ddea73332ff82914fd4c06e7c"}, "closed": true, "closedAt": "2020-02-24T19:36:19Z", "author": {"login": "bradyoo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGjRBjAH2gAyMzc4Mzk0MTI0OmFmOTY5NTU4NjM2ZGQ3NjcyNDhiYjgxNWE1NzY0MmE0YTAyMjZmYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGm9RqgH2gAyMzc4Mzk0MTI0OjBhY2RiOGZmMGQxZGNlNDQyODdmZTNjODY0MGEwM2YxZGM0MzlhOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af969558636dd767248bb815a57642a4a0226fbb", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/af969558636dd767248bb815a57642a4a0226fbb", "committedDate": "2020-02-21T17:34:54Z", "message": "Close Files.walk stream resource in LocalPageStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/523d6d2210af40c2eb230b2f9ab510158a04de75", "committedDate": "2020-02-21T17:54:32Z", "message": "Make the channel returned by LocalPageStore.get also close the input stream on close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODY0NjY3", "url": "https://github.com/Alluxio/alluxio/pull/10970#pullrequestreview-362864667", "createdAt": "2020-02-21T19:29:44Z", "commit": {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOToyOTo0NFrOFtCH-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOToyOTo0NFrOFtCH-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NTA0OA==", "bodyText": "Make a vanilla delegating file channel and then a subclass that does the closing? This also will fix the strangeness of having the delegating filechannel require an inputstream in the constructor.", "url": "https://github.com/Alluxio/alluxio/pull/10970#discussion_r382765048", "createdAt": "2020-02-21T19:29:44Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/DelegatingFileChannel.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache.store;\n+\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.channels.ReadableByteChannel;\n+import java.nio.channels.WritableByteChannel;\n+\n+/**\n+ * A delegating {@link FileChannel} that also closes the FileInputStream as well.\n+ */\n+public class DelegatingFileChannel extends FileChannel {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODY1MDI2", "url": "https://github.com/Alluxio/alluxio/pull/10970#pullrequestreview-362865026", "createdAt": "2020-02-21T19:30:23Z", "commit": {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTozMDoyM1rOFtCJAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTozMDoyM1rOFtCJAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NTMxNQ==", "bodyText": "Do you mind doing the filter outside of the try? (See #getPages)", "url": "https://github.com/Alluxio/alluxio/pull/10970#discussion_r382765315", "createdAt": "2020-02-21T19:30:23Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,9 +69,12 @@ public LocalPageStore(LocalPageStoreOptions options) throws IOException {\n     mPagePattern = Pattern.compile(\n         String.format(\"%s/%d/(\\\\d+)/(\\\\d+)\", Pattern.quote(rootDir.toString()), mPageSize));\n     try {\n-      boolean invalidPage = Files.exists(rootDir) && Files.walk(rootDir)\n-          .filter(Files::isRegularFile)\n-          .anyMatch(path -> {\n+\n+      boolean invalidPage = false;\n+\n+      if (Files.exists(rootDir)) {\n+        try (Stream<Path> pathStream = Files.walk(rootDir).filter(Files::isRegularFile)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32934e9b28fc0b83efcfc64b68ce872e55b986a0", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/32934e9b28fc0b83efcfc64b68ce872e55b986a0", "committedDate": "2020-02-21T20:53:59Z", "message": "Feedback + Undo DelegatingFileChannel changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acdb8ff0d1dce44287fe3c8640a03f1dc439a99", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/0acdb8ff0d1dce44287fe3c8640a03f1dc439a99", "committedDate": "2020-02-21T21:52:57Z", "message": "fix formatting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4877, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}