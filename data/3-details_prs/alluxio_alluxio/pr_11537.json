{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMTM2Mzkw", "number": 11537, "title": "Add a cache for PropertyKey.isValid", "bodyText": "In certain applications like Presto, frequently initializing FileSystem instance may be costly in CPU overhead. Further analysis shows when Hadoop configuration is large, regexp used in Alluxio to check whether an given configuration property from Hadoop can be recognized by Alluxio property template contributed a lot to the CPU overhead.\nThis PR aims to remove this cost. My initial attempt was to introduce extra logic to avoid  PropertyKey.isValid. However, this approach has a fairly large footprint in multiple most basic and important classes in Alluxio codebase, and increases complexity. I am concerned with the potential risk to reason and maintain the code after a patch like this.\nLater I decided to instead  add a cache inside PropertyKey.isValid, given the inquiries are likely to be repeated. This approach has much less footprint to the codebase. In this PR I also cleaned up AbstractFileSystem.initialize in terms of configuration init.", "createdAt": "2020-06-10T00:44:03Z", "url": "https://github.com/Alluxio/alluxio/pull/11537", "merged": true, "mergeCommit": {"oid": "63fae67e18b49314d01bee3e9616b0cf25b44461"}, "closed": true, "closedAt": "2020-06-11T01:06:30Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpuz6pgFqTQyNzYzOTUzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqA4B3ABqjM0MzE2MDExMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjM5NTMw", "url": "https://github.com/Alluxio/alluxio/pull/11537#pullrequestreview-427639530", "createdAt": "2020-06-10T00:49:19Z", "commit": {"oid": "6601d8daf343772615cd118e94389ef3e3f20116"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMDo0OToxOVrOGhhLOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMDo0OToxOVrOGhhLOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc5OTczNg==", "bodyText": "let's put all configuration merge in the same place, rather than distributed in multiple methods", "url": "https://github.com/Alluxio/alluxio/pull/11537#discussion_r437799736", "createdAt": "2020-06-10T00:49:19Z", "author": {"login": "apc999"}, "path": "core/client/hdfs/src/main/java/alluxio/hadoop/AbstractFileSystem.java", "diffHunk": "@@ -473,15 +473,23 @@ public synchronized void initialize(URI uri, org.apache.hadoop.conf.Configuratio\n     mStatistics = statistics;\n     mUri = URI.create(mAlluxioHeader);\n \n+    // take the URI properties, hadoop configuration, and given Alluxio configuration and merge\n+    // all three into a single object.\n     Map<String, Object> uriConfProperties = getConfigurationFromUri(uri);\n-\n+    Map<String, Object> hadoopConfProperties =\n+        HadoopConfigurationUtils.getConfigurationFromHadoop(conf);\n+    LOG.info(\"Creating Alluxio configuration from Hadoop configuration {}, uri configuration {}\",\n+        hadoopConfProperties, uriConfProperties);\n     AlluxioProperties alluxioProps =\n         (alluxioConfiguration != null) ? alluxioConfiguration.copyProperties()\n             : ConfigurationUtils.defaults();\n-    LOG.info(\"Creating Alluxio configuration from Hadoop configuration {}, uri configuration {}\",\n-        conf, uriConfProperties);\n-    AlluxioConfiguration alluxioConf = mergeConfigurations(uriConfProperties, conf, alluxioProps);\n-    mAlluxioConf = alluxioConf;\n+    // Merge relevant Hadoop configuration into Alluxio's configuration.\n+    alluxioProps.merge(hadoopConfProperties, Source.RUNTIME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6601d8daf343772615cd118e94389ef3e3f20116"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b7192cd574b5218a9c351b23cc9c979146c6e55", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5b7192cd574b5218a9c351b23cc9c979146c6e55", "committedDate": "2020-06-10T00:55:16Z", "message": "Add a cache for isValid"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6601d8daf343772615cd118e94389ef3e3f20116", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/6601d8daf343772615cd118e94389ef3e3f20116", "committedDate": "2020-06-10T00:32:33Z", "message": "Add a cache for isValid"}, "afterCommit": {"oid": "5b7192cd574b5218a9c351b23cc9c979146c6e55", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/5b7192cd574b5218a9c351b23cc9c979146c6e55", "committedDate": "2020-06-10T00:55:16Z", "message": "Add a cache for isValid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjQyMTQx", "url": "https://github.com/Alluxio/alluxio/pull/11537#pullrequestreview-427642141", "createdAt": "2020-06-10T00:58:27Z", "commit": {"oid": "5b7192cd574b5218a9c351b23cc9c979146c6e55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjcxNzcw", "url": "https://github.com/Alluxio/alluxio/pull/11537#pullrequestreview-427671770", "createdAt": "2020-06-10T02:38:21Z", "commit": {"oid": "5b7192cd574b5218a9c351b23cc9c979146c6e55"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMjozODoyMlrOGhi3nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwMjozODoyMlrOGhi3nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzgyNzQ4NQ==", "bodyText": "Presto was using this method\nhttps://github.com/prestodb/presto/blob/472538a02722c5409649533f9a602b5b76d9dd2d/presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java#L98", "url": "https://github.com/Alluxio/alluxio/pull/11537#discussion_r437827485", "createdAt": "2020-06-10T02:38:22Z", "author": {"login": "jainxrohit"}, "path": "core/client/hdfs/src/main/java/alluxio/hadoop/HadoopConfigurationUtils.java", "diffHunk": "@@ -30,35 +24,25 @@\n  */\n @ThreadSafe\n public final class HadoopConfigurationUtils {\n-  private static final Logger LOG = LoggerFactory.getLogger(HadoopConfigurationUtils.class);\n-\n   private HadoopConfigurationUtils() {} // Prevent instantiation.\n \n   /**\n-   * Merges Hadoop {@link org.apache.hadoop.conf.Configuration} with Alluxio properties.\n+   * Extracts relevant configuration from Hadoop {@link org.apache.hadoop.conf.Configuration}.\n    *\n-   * @param hadoopConf the {@link org.apache.hadoop.conf.Configuration} to merge\n-   * @param alluxioProps the Alluxio properties to merge\n-   * @return a configuration with properties all merged\n+   * @param hadoopConf the {@link org.apache.hadoop.conf.Configuration} to extract\n+   * @return all relevant properties in a Map instance\n    */\n-  public static InstancedConfiguration mergeHadoopConfiguration(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b7192cd574b5218a9c351b23cc9c979146c6e55"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf1061a34144e60a0055860d16c8390bd559f79", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/aaf1061a34144e60a0055860d16c8390bd559f79", "committedDate": "2020-06-10T18:19:43Z", "message": "Add back mergeHadoopConfiguration to keep Presto compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bf83108220ddf49597d7049d155fa25e821072c", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/4bf83108220ddf49597d7049d155fa25e821072c", "committedDate": "2020-06-10T21:51:47Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c66466807bc4c122977d5dc5eebdbb94ae97234f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/c66466807bc4c122977d5dc5eebdbb94ae97234f", "committedDate": "2020-06-10T20:49:25Z", "message": "Fix tests"}, "afterCommit": {"oid": "4bf83108220ddf49597d7049d155fa25e821072c", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/4bf83108220ddf49597d7049d155fa25e821072c", "committedDate": "2020-06-10T21:51:47Z", "message": "Fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4490, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}