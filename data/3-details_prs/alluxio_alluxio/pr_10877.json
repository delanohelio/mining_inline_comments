{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMzk4NTc4", "number": 10877, "title": "Fix meter bug to calculate throughput value at master directly", "bodyText": "Alluxio clients are usually short-lived especially those created through running Alluxio CLI. Alluxio throughput is recorded as MetricType:Meter. Meter.getOneMinuteRate() can be zero when the data is first marked since the one minute rate is a one-minute exponentially-weighted moving average rate. When a client is shutting down, it will report metrics the last time to leader master. Because they are too short-lived, the reported meter.getOneMinuteRate() is always zero, client metrics can be considered as lost in this scenario.\nIn this PR, cluster throughput values are not aggregated value of client/worker reported meter one minute rate anymore. Instead, cluster throughput value is calculated when requested by dividing cluster bytes counter to the metrics uptime (the last time that the metrics store is cleared).\nBecause of this change, only counter value needs to be reported to the leading master, many logics in the leading master metrics store to store the individual metrics of types other than counter can be removed. In addition, when the should report counters are all zero, client heartbeats to report metrics will not be triggered. A large amount of client heartbeat overhead is reduced.", "createdAt": "2020-02-10T23:05:59Z", "url": "https://github.com/Alluxio/alluxio/pull/10877", "merged": true, "mergeCommit": {"oid": "997d57be0cc0e242ed085d362364ae365a423620"}, "closed": true, "closedAt": "2020-02-12T01:20:53Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDFZCuAH2gAyMzczMzk4NTc4OjA3ODNjYjllMTMyZjNhNDNiOWI0OGI1YjA3ZmZhY2U3ZjIyY2I4ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDb0g1gFqTM1NzEzMDU5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0783cb9e132f3a43b9b48b5b07fface7f22cb8eb", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/0783cb9e132f3a43b9b48b5b07fface7f22cb8eb", "committedDate": "2020-02-10T23:04:44Z", "message": "Calculate throughput value at master directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11fc055f60e0b0fa778f01996abd4c526f615cb9", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/11fc055f60e0b0fa778f01996abd4c526f615cb9", "committedDate": "2020-02-10T23:18:53Z", "message": "small fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af91b66ba974ac879df714554cfbb6bb6c3f294b", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/af91b66ba974ac879df714554cfbb6bb6c3f294b", "committedDate": "2020-02-10T23:34:18Z", "message": "Remove MetricsMasterTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/fd97126e89608e99f41a0c54e8af32665fc8135b", "committedDate": "2020-02-11T21:03:02Z", "message": "Reduce copy for the client metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDU1MTc0", "url": "https://github.com/Alluxio/alluxio/pull/10877#pullrequestreview-357055174", "createdAt": "2020-02-11T22:50:13Z", "commit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo1MDoxM1rOFocDrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMzowMToyN1rOFocUpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NzA1Mg==", "bodyText": "What's the reasoning for using 10 seconds?", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377947052", "createdAt": "2020-02-11T22:50:13Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3221,7 +3203,7 @@ public String toString() {\n   public static final PropertyKey USER_METRICS_HEARTBEAT_INTERVAL_MS =\n       new Builder(Name.USER_METRICS_HEARTBEAT_INTERVAL_MS)\n           .setAlias(\"alluxio.user.metrics.heartbeat.interval.ms\")\n-          .setDefaultValue(\"1min\")\n+          .setDefaultValue(\"10sec\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTkwMg==", "bodyText": "@calvinjia has a PR out that will use either hostname or App ID if it is set. Maybe we should consider updating this argument name as well? #10890", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377949902", "createdAt": "2020-02-11T22:57:29Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -132,45 +76,34 @@ public void putWorkerMetrics(String hostname, List<Metric> metrics) {\n       return;\n     }\n     try (LockResource r = new LockResource(mLock.readLock())) {\n-      mLastReportedTimeMap.put(getFullInstanceId(hostname, null), System.currentTimeMillis());\n       putReportedMetrics(InstanceType.WORKER, metrics);\n     }\n   }\n \n   /**\n-   * Put the metrics from a client with a hostname and a client id. If all the old metrics\n-   * associated with this instance will be removed and then replaced by the latest.\n+   * Put the metrics from a client with a hostname.\n    *\n    * @param hostname the hostname of the client\n-   * @param clientId the id of the client\n    * @param metrics the new metrics\n    */\n-  public void putClientMetrics(String hostname, String clientId, List<Metric> metrics) {\n+  public void putClientMetrics(String hostname, List<Metric> metrics) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTM5Nw==", "bodyText": "why are these all set to false now?", "url": "https://github.com/Alluxio/alluxio/pull/10877#discussion_r377951397", "createdAt": "2020-02-11T23:01:27Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -668,7 +668,7 @@ public MetricKey build() {\n           .setDescription(\"Bytes read throughput from Alluxio storage \"\n               + \"via domain socket by this worker\")\n           .setMetricType(MetricType.METER)\n-          .setIsClusterAggregated(true)\n+          .setIsClusterAggregated(false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTMwNTk1", "url": "https://github.com/Alluxio/alluxio/pull/10877#pullrequestreview-357130595", "createdAt": "2020-02-12T01:12:39Z", "commit": {"oid": "fd97126e89608e99f41a0c54e8af32665fc8135b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4922, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}