{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMzE3OTM1", "number": 11650, "title": "Refactor stream reader/writer tracking", "bodyText": "Extends BlockReader and BlockWriter interfaces from a new BlockClient interface for simplifying the block tracking interfaces. It also adds more traces to be able to track open stream reader/writer counts.", "createdAt": "2020-06-26T00:15:57Z", "url": "https://github.com/Alluxio/alluxio/pull/11650", "merged": true, "mergeCommit": {"oid": "0742ea0785e70c5be6561f6443f0622b2f9306db"}, "closed": true, "closedAt": "2020-07-01T23:55:58Z", "author": {"login": "ggezer"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu4BLRAFqTQzNzk0MTg1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwy_BMAFqTQ0MTI1OTk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQxODUz", "url": "https://github.com/Alluxio/alluxio/pull/11650#pullrequestreview-437941853", "createdAt": "2020-06-26T00:22:33Z", "commit": {"oid": "222159dcdb3d834202a46f86e259cb393acde6d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoyMjozM1rOGpP-gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoyMjozM1rOGpP-gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNjU2Mg==", "bodyText": "can we encapsulate this into some kind of object so that we can keep the open/close messages consistent?", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r445906562", "createdAt": "2020-06-26T00:22:33Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/management/DefaultStoreLoadTracker.java", "diffHunk": "@@ -96,6 +101,8 @@ public void writerClosed(BlockWriter writer, BlockStoreLocation location) {\n    * Used to activate stream reader/writer for load tracking.\n    */\n   private void streamOpened(Object stream, BlockStoreLocation location) {\n+    LOG.debug(\"Stream opened. Type: {}, Id: {}, Location: {}\",\n+        stream.getClass().getSimpleName(), System.identityHashCode(stream), location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222159dcdb3d834202a46f86e259cb393acde6d1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9", "committedDate": "2020-06-26T00:47:11Z", "message": "Refactor block reader/writer tracking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "222159dcdb3d834202a46f86e259cb393acde6d1", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/222159dcdb3d834202a46f86e259cb393acde6d1", "committedDate": "2020-06-26T00:14:08Z", "message": "Trace worker stream activity"}, "afterCommit": {"oid": "3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9", "committedDate": "2020-06-26T00:47:11Z", "message": "Refactor block reader/writer tracking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDIxNjgy", "url": "https://github.com/Alluxio/alluxio/pull/11650#pullrequestreview-438021682", "createdAt": "2020-06-26T05:26:53Z", "commit": {"oid": "3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNToyNjo1M1rOGpUHOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNToyNjo1M1rOGpUHOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3NDMyOQ==", "bodyText": "Do the BlockClientListener implementations implement hashCode and equals?", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r445974329", "createdAt": "2020-06-26T05:26:53Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/io/BlockStreamTracker.java", "diffHunk": "@@ -21,14 +21,14 @@\n  */\n public class BlockStreamTracker {\n   /** List of listeners for this tracker. */\n-  private static Set<BlockStreamListener> sListeners = new ConcurrentHashSet<>();\n+  private static Set<BlockClientListener> sListeners = new ConcurrentHashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aeae322bdbef3c077cc5746b55b0cfd7c8e31d9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf99d6f10c3d6fa381413742c2b56c18f4cf1db0", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/cf99d6f10c3d6fa381413742c2b56c18f4cf1db0", "committedDate": "2020-06-26T06:07:08Z", "message": "fix listener registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6029d6bf0745dc7887a36324462f67e244ecac50", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/6029d6bf0745dc7887a36324462f67e244ecac50", "committedDate": "2020-06-26T07:09:58Z", "message": "fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc6c317009a413f9f240dfa57c9655fd35b879e", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/7cc6c317009a413f9f240dfa57c9655fd35b879e", "committedDate": "2020-06-26T18:45:50Z", "message": "Extend more block clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bfa723351ec5b77dccf935aad4b44a245ec4567", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/5bfa723351ec5b77dccf935aad4b44a245ec4567", "committedDate": "2020-06-26T19:09:19Z", "message": "use cow list"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDI2ODYw", "url": "https://github.com/Alluxio/alluxio/pull/11650#pullrequestreview-440426860", "createdAt": "2020-06-30T22:22:27Z", "commit": {"oid": "5bfa723351ec5b77dccf935aad4b44a245ec4567"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjoyMjoyN1rOGrQgNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjoyNToyOFrOGrQkkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjM0Mw==", "bodyText": "I think the code would be cleaner if BlockReader and BlockWriter were an abstract classes which extended AbstractBlockClient so that is wouldn't require both an extends and implements here. Then we could just have the default constructor for the Reader/writer set its type to READER/WRITER and you wouldn't need super(READER)/super(WRITER) everywhere since it would be taken care of by the class def extending BlockReader or BlockWriter", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r448012343", "createdAt": "2020-06-30T22:22:27Z", "author": {"login": "ZacBlanco"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/RemoteBlockReader.java", "diffHunk": "@@ -29,7 +30,7 @@\n /**\n  * Reads a block from a remote worker node. This should only be used for reading entire blocks.\n  */\n-public class RemoteBlockReader implements BlockReader {\n+public class RemoteBlockReader extends AbstractBlockClient implements BlockReader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bfa723351ec5b77dccf935aad4b44a245ec4567"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMzQ1OA==", "bodyText": "I would prefer using AutoCloseable unless you think there is a reason we shouldn't? It will make these all compatible with the try-with-resources pattern", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r448013458", "createdAt": "2020-06-30T22:25:28Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/worker/block/io/BlockClient.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.worker.block.io;\n+\n+import java.io.Closeable;\n+\n+/**\n+ * Base interface for block reader/writers.\n+ */\n+public interface BlockClient extends Closeable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bfa723351ec5b77dccf935aad4b44a245ec4567"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "854a15ebc15bb31f7ed63d6f55ded57a3d63c812", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/854a15ebc15bb31f7ed63d6f55ded57a3d63c812", "committedDate": "2020-07-01T18:37:26Z", "message": "Change class composition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTMwNDQ2", "url": "https://github.com/Alluxio/alluxio/pull/11650#pullrequestreview-441130446", "createdAt": "2020-07-01T19:10:54Z", "commit": {"oid": "854a15ebc15bb31f7ed63d6f55ded57a3d63c812"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxMDo1NFrOGryK4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxMToxOVrOGryL0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MzkzOA==", "bodyText": "this should be final?", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r448563938", "createdAt": "2020-07-01T19:10:54Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/worker/block/io/BlockClient.java", "diffHunk": "@@ -11,10 +11,57 @@\n \n package alluxio.worker.block.io;\n \n+import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n- * Base interface for block reader/writers.\n+ * Provides basic tracking and representation for block reader/writer clients.\n  */\n-public interface BlockClient extends Closeable {\n+public abstract class BlockClient implements Closeable {\n+  private static final Logger LOG = LoggerFactory.getLogger(BlockClient.class);\n+\n+  /** Used to keep unique client ids. */\n+  private static AtomicInteger sNextClientId = new AtomicInteger(0);\n+\n+  /** Internal client id. */\n+  private int mClientId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "854a15ebc15bb31f7ed63d6f55ded57a3d63c812"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2Mzk4Ng==", "bodyText": "This should be final?", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r448563986", "createdAt": "2020-07-01T19:11:00Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/worker/block/io/BlockClient.java", "diffHunk": "@@ -11,10 +11,57 @@\n \n package alluxio.worker.block.io;\n \n+import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n- * Base interface for block reader/writers.\n+ * Provides basic tracking and representation for block reader/writer clients.\n  */\n-public interface BlockClient extends Closeable {\n+public abstract class BlockClient implements Closeable {\n+  private static final Logger LOG = LoggerFactory.getLogger(BlockClient.class);\n+\n+  /** Used to keep unique client ids. */\n+  private static AtomicInteger sNextClientId = new AtomicInteger(0);\n+\n+  /** Internal client id. */\n+  private int mClientId;\n+  /** the client type. */\n+  private Type mClientType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "854a15ebc15bb31f7ed63d6f55ded57a3d63c812"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NDE3OA==", "bodyText": "I think this should also be final since it's the reference to the AtomicInteger object", "url": "https://github.com/Alluxio/alluxio/pull/11650#discussion_r448564178", "createdAt": "2020-07-01T19:11:19Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/worker/block/io/BlockClient.java", "diffHunk": "@@ -11,10 +11,57 @@\n \n package alluxio.worker.block.io;\n \n+import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n- * Base interface for block reader/writers.\n+ * Provides basic tracking and representation for block reader/writer clients.\n  */\n-public interface BlockClient extends Closeable {\n+public abstract class BlockClient implements Closeable {\n+  private static final Logger LOG = LoggerFactory.getLogger(BlockClient.class);\n+\n+  /** Used to keep unique client ids. */\n+  private static AtomicInteger sNextClientId = new AtomicInteger(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "854a15ebc15bb31f7ed63d6f55ded57a3d63c812"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b2d803effc46ca0d44d47ab1eb1411f9f2c9d3", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/65b2d803effc46ca0d44d47ab1eb1411f9f2c9d3", "committedDate": "2020-07-01T21:54:16Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09af0e3e659a8d0dca4802e4b395256c81a88ae9", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/09af0e3e659a8d0dca4802e4b395256c81a88ae9", "committedDate": "2020-07-01T22:28:19Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjU5OTYz", "url": "https://github.com/Alluxio/alluxio/pull/11650#pullrequestreview-441259963", "createdAt": "2020-07-01T23:38:32Z", "commit": {"oid": "09af0e3e659a8d0dca4802e4b395256c81a88ae9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4383, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}