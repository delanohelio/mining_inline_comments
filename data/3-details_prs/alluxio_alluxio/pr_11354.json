{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDEyNDI4", "number": 11354, "title": "Stop tracking connections in copycat client/server", "bodyText": "Many connections can be created by the transport layer, but it is rare for copycat to close the client. Tracking the created connections is unnecessary because copycat closes them before closing the clients anyways. This prevents us from holding on to the connection references for extended periods of time, which then causes behavior resembling a memory leak.\nAdditionally we bump the copycat version to 1.2.15 to avoid cycling connections. 1.2.15 introduces a changes to the KeepAliveResponse serde to respect unresolved addresses.\nFixes #11355", "createdAt": "2020-04-26T04:07:23Z", "url": "https://github.com/Alluxio/alluxio/pull/11354", "merged": true, "mergeCommit": {"oid": "9706dfeae779f9178357c38bf8b47034515dcacc"}, "closed": true, "closedAt": "2020-04-27T04:52:02Z", "author": {"login": "ZacBlanco"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbSl7CgH2gAyNDA5MDEyNDI4OmU4NzJhYWZjZWMxNjRhOTUyYmFmYWNkZDc2OGE1MjMzZGU5YjE1Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbhQVogH2gAyNDA5MDEyNDI4OjE4NmMwYTk3ZDU3OWRlYWQwZWZkNmE5YmQxMzI4Yjc1M2Q0MWEyZjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e872aafcec164a952bafacdd768a5233de9b1529", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/e872aafcec164a952bafacdd768a5233de9b1529", "committedDate": "2020-04-26T04:01:45Z", "message": "Stop tracking connections in copycat client/server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDU2NTIy", "url": "https://github.com/Alluxio/alluxio/pull/11354#pullrequestreview-400456522", "createdAt": "2020-04-26T04:18:34Z", "commit": {"oid": "e872aafcec164a952bafacdd768a5233de9b1529"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwNDoxODozNFrOGL-b2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQwNDoxODozNFrOGL-b2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTIxMDQ1OQ==", "bodyText": "nit: update the comment", "url": "https://github.com/Alluxio/alluxio/pull/11354#discussion_r415210459", "createdAt": "2020-04-26T04:18:34Z", "author": {"login": "ggezer"}, "path": "core/server/common/src/main/java/alluxio/master/transport/GrpcMessagingServer.java", "diffHunk": "@@ -140,40 +127,16 @@ public GrpcMessagingServer(AlluxioConfiguration conf, UserState userState,\n     }\n \n     LOG.debug(\"Closing messaging server: {}\", mGrpcServer);\n-    // Close created connections.\n-    List<CompletableFuture<Void>> connectionCloseFutures = new ArrayList<>(mConnections.size());\n-    for (Connection connection : mConnections) {\n-      connectionCloseFutures.add(connection.close());\n-    }\n-    mConnections.clear();\n-\n-    CompletableFuture<Void> future = new CompletableFuture<>();\n-    CompletableFuture.allOf(connectionCloseFutures.toArray(new CompletableFuture[0]))\n-        .whenComplete((result, error) -> {\n-          // Shut down gRPC server once all connections are closed.\n-          try {\n-            mGrpcServer.shutdown();\n-          } catch (Exception e) {\n-            LOG.warn(\"Failed to close messaging gRPC server: {}\", mGrpcServer);\n-          } finally {\n-            mGrpcServer = null;\n-          }\n-          // Complete the future with result from connection shut downs.\n-          if (error == null) {\n-            future.complete(result);\n-          } else {\n-            future.completeExceptionally(error);\n-          }\n-        });\n-    return future;\n-  }\n \n-  /**\n-   * Used to keep track of all connections created by this server instance.\n-   *\n-   * @param serverConnection new client connection\n-   */\n-  private synchronized void addNewConnection(Connection serverConnection) {\n-    mConnections.add(serverConnection);\n+    return CompletableFuture.runAsync(() -> {\n+      // Shut down gRPC server once all connections are closed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e872aafcec164a952bafacdd768a5233de9b1529"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e445af19227e3d6002c6df685353d8d521d21fb", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/5e445af19227e3d6002c6df685353d8d521d21fb", "committedDate": "2020-04-26T08:48:07Z", "message": "Remove outdated comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "186c0a97d579dead0efd6a9bd1328b753d41a2f8", "author": {"user": {"login": "ZacBlanco", "name": "Zac Blanco"}}, "url": "https://github.com/Alluxio/alluxio/commit/186c0a97d579dead0efd6a9bd1328b753d41a2f8", "committedDate": "2020-04-26T21:06:45Z", "message": "Bump copycat version to 1.2.15"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4565, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}