{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDQ3MTky", "number": 11224, "title": "Parallelize DistributedLoadCommand client's job completion check", "bodyText": "After submitting a large number of jobs to the JobService, the code previously checked if some of the jobs are complete in serial, this code changes that to be done in parallel so that new jobs can be scheduled more quickly.", "createdAt": "2020-03-31T16:24:50Z", "url": "https://github.com/Alluxio/alluxio/pull/11224", "merged": true, "mergeCommit": {"oid": "d341e59e1a063f5d2551c4653f1825cb320634dc"}, "closed": true, "closedAt": "2020-04-03T19:37:07Z", "author": {"login": "bradyoo"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTFn2rAH2gAyMzk2NDQ3MTkyOmMxNTk5M2Y5N2U1YjQzYTk0M2U2ZjU5MzFiMTg5NjhhMGM2YmM2ODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUEZ0FgFqTM4NzQ1MDIwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c15993f97e5b43a943e6f5931b18968a0c6bc680", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/c15993f97e5b43a943e6f5931b18968a0c6bc680", "committedDate": "2020-03-31T16:23:42Z", "message": "Change checking for job completions in DistributedLoadCommand to be done in parallel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/79fd7b6c6f7df5898eed4e2d63212b833d3beae8", "committedDate": "2020-03-31T17:40:30Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDIyMDA1", "url": "https://github.com/Alluxio/alluxio/pull/11224#pullrequestreview-387422005", "createdAt": "2020-04-03T16:50:43Z", "commit": {"oid": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1MDo0M1rOGAdymw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1MDo0M1rOGAdymw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTI3NQ==", "bodyText": "Was the issue that checking everything in serial was too slow? Because this still waits for all the jobs to be checked.", "url": "https://github.com/Alluxio/alluxio/pull/11224#discussion_r403141275", "createdAt": "2020-04-03T16:50:43Z", "author": {"login": "gpang"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -194,38 +195,34 @@ private JobAttempt newJob(AlluxioURI filePath, int replication) {\n   }\n \n   /**\n-   * Waits one job to complete.\n+   * Waits for at least one job to complete.\n    */\n-  private void waitJob() throws IOException {\n-    boolean removed = false;\n+  private void waitJob() {\n+    AtomicBoolean removed = new AtomicBoolean(false);\n     while (true) {\n-      Iterator<JobAttempt> iterator = mSubmittedJobAttempts.iterator();\n-\n-      while (iterator.hasNext()) {\n-        JobAttempt jobAttempt = iterator.next();\n+      mSubmittedJobAttempts = mSubmittedJobAttempts.parallelStream().filter((jobAttempt) -> {\n         Status check = jobAttempt.check();\n-\n         switch (check) {\n           case CREATED:\n           case RUNNING:\n-            continue;\n+            return true;\n           case CANCELED:\n           case COMPLETED:\n-            removed = true;\n-            jobAttempt.close();\n-            iterator.remove();\n-            continue;\n-          case FAILED:\n-            if (!jobAttempt.run()) {\n-              removed = true;\n-              iterator.remove();\n+            removed.set(true);\n+            try {\n+              jobAttempt.close();\n+            } catch (IOException e) {\n+              LOG.warn(\"Unable to close job master client\", e);\n             }\n-            continue;\n+            return false;\n+          case FAILED:\n+            removed.set(true);\n+            return false;\n           default:\n             throw new IllegalStateException(String.format(\"Unexpected Status: %s\", check));\n         }\n-      }\n-      if (removed) {\n+      }).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDUwMjAw", "url": "https://github.com/Alluxio/alluxio/pull/11224#pullrequestreview-387450200", "createdAt": "2020-04-03T17:32:23Z", "commit": {"oid": "79fd7b6c6f7df5898eed4e2d63212b833d3beae8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4712, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}