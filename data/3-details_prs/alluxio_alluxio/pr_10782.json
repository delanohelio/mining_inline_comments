{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MTAwMzg0", "number": 10782, "title": "Add metricsMaster.getMetrics() and fix fsadmin report metrics", "bodyText": "Expose all metrics stored in the leading master via MetricsMasterClient.getMetrics().\nChange fsadmin report metrics command to show all metrics.", "createdAt": "2020-01-22T22:46:05Z", "url": "https://github.com/Alluxio/alluxio/pull/10782", "merged": true, "mergeCommit": {"oid": "a5ea8ce724766cd6fe100d1e48afc7517004cb65"}, "closed": true, "closedAt": "2020-01-31T01:30:05Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb89t8xgH2gAyMzY2MTAwMzg0OmQxZTFmZWJiMmMwM2QxNWMwZWE3NWYzYjUxNGFkYTYxYjM4NzlmNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_k36sgFqTM1MTI0OTYyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1e1febb2c03d15c0ea75f3b514ada61b3879f5e", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d1e1febb2c03d15c0ea75f3b514ada61b3879f5e", "committedDate": "2020-01-22T22:44:47Z", "message": "Add metricsMaster.getMetrics() and fix fsadmin report metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0d561338cc73a1978a5c8bece0c2078bd313e3", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/3d0d561338cc73a1978a5c8bece0c2078bd313e3", "committedDate": "2020-01-23T04:57:56Z", "message": "small fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9169b1b8ffad540d8706d2698f78293fd7428c00", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/9169b1b8ffad540d8706d2698f78293fd7428c00", "committedDate": "2020-01-23T05:32:35Z", "message": "Modify metrics docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NjYyMzQz", "url": "https://github.com/Alluxio/alluxio/pull/10782#pullrequestreview-347662343", "createdAt": "2020-01-23T22:53:15Z", "commit": {"oid": "9169b1b8ffad540d8706d2698f78293fd7428c00"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMjo1MzoxNVrOFhPSoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMjo1NDo0NlrOFhPUng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5Nzg1Ng==", "bodyText": "One line?", "url": "https://github.com/Alluxio/alluxio/pull/10782#discussion_r370397856", "createdAt": "2020-01-23T22:53:15Z", "author": {"login": "calvinjia"}, "path": "shell/src/main/java/alluxio/cli/fsadmin/command/ReportCommand.java", "diffHunk": "@@ -149,7 +149,7 @@ public int run(CommandLine cl) throws IOException {\n         break;\n       case METRICS:\n         MetricsCommand metricsCommand = new MetricsCommand(\n-            mMetaClient, mPrintStream);\n+            mMetricsClient, mPrintStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9169b1b8ffad540d8706d2698f78293fd7428c00"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5ODM2Ng==", "bodyText": "There is no easy way to iterate over these? Could we just output the values in the map, that would also avoid the need to expose getMasterMetricName?", "url": "https://github.com/Alluxio/alluxio/pull/10782#discussion_r370398366", "createdAt": "2020-01-23T22:54:46Z", "author": {"login": "calvinjia"}, "path": "shell/src/main/java/alluxio/cli/fsadmin/report/MetricsCommand.java", "diffHunk": "@@ -120,40 +126,68 @@ public int run() throws IOException {\n         + String.format(mInfoFormat, \"Miss\", cacheMissPercentage));\n \n     mPrintStream.println(\"\\nLogical Operations: \");\n-    printMetric(MasterMetrics.DIRECTORIES_CREATED, \"Directories Created\", false);\n-    printMetric(MasterMetrics.FILE_BLOCK_INFOS_GOT, \"File Block Infos Got\", false);\n-    printMetric(MasterMetrics.FILE_INFOS_GOT, \"File Infos Got\", false);\n-    printMetric(MasterMetrics.FILES_COMPLETED, \"Files Completed\", false);\n-    printMetric(MasterMetrics.FILES_CREATED, \"Files Created\", false);\n-    printMetric(MasterMetrics.FILES_FREED, \"Files Freed\", false);\n-    printMetric(MasterMetrics.FILES_PERSISTED, \"Files Persisted\", false);\n-    printMetric(MasterMetrics.NEW_BLOCKS_GOT, \"New Blocks Got\", false);\n-    printMetric(MasterMetrics.PATHS_DELETED, \"Paths Deleted\", false);\n-    printMetric(MasterMetrics.PATHS_MOUNTED, \"Paths Mounted\", false);\n-    printMetric(MasterMetrics.PATHS_RENAMED, \"Paths Renamed\", false);\n-    printMetric(MasterMetrics.PATHS_UNMOUNTED, \"Paths Unmounted\", false);\n+    printMetric(MetricsSystem.getMasterMetricName(MasterMetrics.DIRECTORIES_CREATED),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9169b1b8ffad540d8706d2698f78293fd7428c00"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7090d49c0ef8507f314407f59d8689088ac4d7ad", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7090d49c0ef8507f314407f59d8689088ac4d7ad", "committedDate": "2020-01-24T19:13:42Z", "message": "Modify fsadmin report metrics to show all metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1490f28655241b11f6a229e610107703e33f97ae", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/1490f28655241b11f6a229e610107703e33f97ae", "committedDate": "2020-01-24T20:56:04Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f299daef06d2da789ae0484d182e8daf383aefa5", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f299daef06d2da789ae0484d182e8daf383aefa5", "committedDate": "2020-01-24T21:12:08Z", "message": "small fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ea721602ec2d3355b0a51bf1dade5e9da9919e8", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5ea721602ec2d3355b0a51bf1dade5e9da9919e8", "committedDate": "2020-01-24T22:17:59Z", "message": "fix MetricsCommandIntegrationTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDMzOTUz", "url": "https://github.com/Alluxio/alluxio/pull/10782#pullrequestreview-349033953", "createdAt": "2020-01-27T22:56:53Z", "commit": {"oid": "5ea721602ec2d3355b0a51bf1dade5e9da9919e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjo1Njo1M1rOFiUWtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjo1ODozNlrOFiUY5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyOTM5Ng==", "bodyText": "is the cast here correct? Or should we make numFiles + 1 a double (applies to all cases in tests)", "url": "https://github.com/Alluxio/alluxio/pull/10782#discussion_r371529396", "createdAt": "2020-01-27T22:56:53Z", "author": {"login": "calvinjia"}, "path": "tests/src/test/java/alluxio/server/ft/journal/TriggeredCheckpointTest.java", "diffHunk": "@@ -107,9 +107,9 @@ private void createFiles(MultiProcessCluster cluster, int numFiles)\n     for (int i = 0; i < numFiles; i++) {\n       fs.createFile(new AlluxioURI(\"/file\" + i)).close();\n     }\n-    MetaMasterClient meta = cluster.getMetaMasterClient();\n-    assertEquals(numFiles + 1,\n-        meta.getMetrics().get(\"Master.\" + MasterMetrics.TOTAL_PATHS).getLongValue());\n+    MetricsMasterClient metricsMasterClient = cluster.getMetricsMasterClient();\n+    assertEquals(numFiles + 1, (long) metricsMasterClient\n+        .getMetrics().get(\"Master.\" + MasterMetrics.TOTAL_PATHS).getDoubleValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea721602ec2d3355b0a51bf1dade5e9da9919e8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyOTk1Nw==", "bodyText": "Do we want to use tabs or something for pretty alignment?", "url": "https://github.com/Alluxio/alluxio/pull/10782#discussion_r371529957", "createdAt": "2020-01-27T22:58:36Z", "author": {"login": "calvinjia"}, "path": "shell/src/main/java/alluxio/cli/fsadmin/report/MetricsCommand.java", "diffHunk": "@@ -11,44 +11,44 @@\n \n package alluxio.cli.fsadmin.report;\n \n-import alluxio.client.meta.MetaMasterClient;\n+import alluxio.client.metrics.MetricsMasterClient;\n import alluxio.grpc.MetricValue;\n-import alluxio.metrics.ClientMetrics;\n-import alluxio.metrics.MasterMetrics;\n-import alluxio.metrics.MetricsSystem;\n-import alluxio.metrics.WorkerMetrics;\n import alluxio.util.FormatUtils;\n \n+import com.google.common.math.DoubleMath;\n+\n import java.io.IOException;\n import java.io.PrintStream;\n import java.text.DecimalFormat;\n import java.text.DecimalFormatSymbols;\n import java.util.Locale;\n import java.util.Map;\n-import java.util.TreeMap;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n \n /**\n  * Prints Alluxio metrics information.\n  */\n public class MetricsCommand {\n+  private static final String BYTES_METRIC_IDENTIFIER = \"Bytes\";\n+  private static final String THROUGHPUT_METRIC_IDENTIFIER = \"Throughput\";\n   private static final DecimalFormat DECIMAL_FORMAT\n       = new DecimalFormat(\"###,###.#####\", new DecimalFormatSymbols(Locale.US));\n-  private static final String INDENT = \"    \";\n+  private static final String INFO_FORMAT = \"%s  (Type: %s, Value: %s)%n\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea721602ec2d3355b0a51bf1dade5e9da9919e8"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ca671825fa0c4b1a8b2b8c0cb0c89c491f71c6", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/f3ca671825fa0c4b1a8b2b8c0cb0c89c491f71c6", "committedDate": "2020-01-28T06:21:44Z", "message": "Only prints Alluxio metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72bafb6e025348e4523befe63930abcbe7ef26c1", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/72bafb6e025348e4523befe63930abcbe7ef26c1", "committedDate": "2020-01-28T06:42:27Z", "message": "Fix metricsCommandTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjQ5NjI5", "url": "https://github.com/Alluxio/alluxio/pull/10782#pullrequestreview-351249629", "createdAt": "2020-01-31T01:29:49Z", "commit": {"oid": "72bafb6e025348e4523befe63930abcbe7ef26c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3130, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}