{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NjA3MzY1", "number": 10777, "title": "Stop Alluxio processes properly", "bodyText": "There are 3 main categories of fixes:\n\nRegister shutdown hooks for all processes\nMake abstract worker implementation restartable in compliance with Server interface\nFix various resource disposal issues\n\nThse all together will prevent many gRPC level warnings.", "createdAt": "2020-01-22T00:44:36Z", "url": "https://github.com/Alluxio/alluxio/pull/10777", "merged": true, "mergeCommit": {"oid": "7963ba2132ad429e9ebd5249d9de77ce8da8be2b"}, "closed": true, "closedAt": "2020-01-29T00:07:41Z", "author": {"login": "ggezer"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8qzJkAH2gAyMzY1NjA3MzY1OjZlMTY1NTRkZDhhY2I2ZmI2ZjQwZmQyODdlZmNmYmU4NWE2NDEwMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-6ajkAFqTM0OTc4ODY5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/6e16554dd8acb6fb6f40fd287efcfbe85a641014", "committedDate": "2020-01-22T00:42:16Z", "message": "Stop Alluxio processes properly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjY4NTY4", "url": "https://github.com/Alluxio/alluxio/pull/10777#pullrequestreview-346668568", "createdAt": "2020-01-22T15:19:02Z", "commit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNToxOTowMlrOFgf80A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNToyMzoxOFrOFggHPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyMjIyNA==", "bodyText": "is the thread rename intentional?", "url": "https://github.com/Alluxio/alluxio/pull/10777#discussion_r369622224", "createdAt": "2020-01-22T15:19:02Z", "author": {"login": "gpang"}, "path": "job/server/src/main/java/alluxio/worker/JobWorker.java", "diffHunk": "@@ -69,8 +68,7 @@\n    * @param ufsManager the ufs manager\n    */\n   JobWorker(FileSystem filesystem, FileSystemContext fsContext, UfsManager ufsManager) {\n-    super(\n-        Executors.newFixedThreadPool(1, ThreadFactoryUtils.build(\"job-worker-heartbeat-%d\", true)));\n+    super(ExecutorServiceFactories.fixedThreadPool(\"job-worker-executor\", 1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyNDg5Mg==", "bodyText": "is this the heartbeat thread or something else?", "url": "https://github.com/Alluxio/alluxio/pull/10777#discussion_r369624892", "createdAt": "2020-01-22T15:23:18Z", "author": {"login": "gpang"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -147,8 +143,7 @@\n   DefaultBlockWorker(BlockMasterClientPool blockMasterClientPool,\n       FileSystemMasterClient fileSystemMasterClient, Sessions sessions, BlockStore blockStore,\n       UfsManager ufsManager) {\n-    super(Executors\n-        .newFixedThreadPool(4, ThreadFactoryUtils.build(\"block-worker-heartbeat-%d\", true)));\n+    super(ExecutorServiceFactories.fixedThreadPool(\"block-worker-executor\", 4));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODEzNjE5", "url": "https://github.com/Alluxio/alluxio/pull/10777#pullrequestreview-348813619", "createdAt": "2020-01-27T16:47:09Z", "commit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjo0NzoxMFrOFiJvbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjo0NzoxMFrOFiJvbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM1NTUwMw==", "bodyText": "is this supposed to be in the if statement too?", "url": "https://github.com/Alluxio/alluxio/pull/10777#discussion_r371355503", "createdAt": "2020-01-27T16:47:10Z", "author": {"login": "gpang"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/AsyncBlockRemover.java", "diffHunk": "@@ -103,9 +106,12 @@ public void run() {\n           mBlockWorker.removeBlock(Sessions.MASTER_COMMAND_SESSION_ID, blockToBeRemoved);\n           LOG.debug(\"Block {} is removed in thread {}.\", blockToBeRemoved, mThreadName);\n         } catch (InterruptedException e) {\n-          Thread.currentThread().interrupt();\n-          LOG.warn(\"{} got interrupted while it was cleaning block {}.\",\n-              mThreadName, blockToBeRemoved);\n+          // Only log warning if interrupted not due to a shutdown.\n+          if (!mShutdown) {\n+            Thread.currentThread().interrupt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDQ0Mjcz", "url": "https://github.com/Alluxio/alluxio/pull/10777#pullrequestreview-349044273", "createdAt": "2020-01-27T23:21:37Z", "commit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMzoyMTozN1rOFiU3kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMzoyMTozN1rOFiU3kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUzNzgwOA==", "bodyText": "Should we have a mechanism for ensuring the shutdown of resources which need to be closed/stopped(ie. Closer)?", "url": "https://github.com/Alluxio/alluxio/pull/10777#discussion_r371537808", "createdAt": "2020-01-27T23:21:37Z", "author": {"login": "calvinjia"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -254,40 +251,35 @@ public void start(WorkerNetAddress address) throws IOException {\n    * Stops the block worker. This method should only be called to terminate the worker.\n    */\n   @Override\n-  public void stop() {\n+  public void stop() throws IOException {\n     // Steps to shutdown:\n     // 1. Gracefully shut down the runnables running in the executors.\n-    // 2. Shutdown the executors.\n-    // 3. Shutdown the clients. This needs to happen after the executors is shutdown because\n+    // 2. Shutdown the clients. This needs to happen after the executors is shutdown because\n     //    runnables running in the executors might be using the clients.\n+    // 3. Shutdown base worker. (closes executors.)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e16554dd8acb6fb6f40fd287efcfbe85a641014"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41ad003489b98ee5d989f77a4d9bc38cb768c45c", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/41ad003489b98ee5d989f77a4d9bc38cb768c45c", "committedDate": "2020-01-28T20:23:35Z", "message": "Use closer for resource disposal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "275c3d201fb0820e3222cc7e6349f703224b5146", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/275c3d201fb0820e3222cc7e6349f703224b5146", "committedDate": "2020-01-28T20:28:41Z", "message": "Properly exit from async block remoer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2175056994f1e2da96c3f2057cec10c883204c2", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/d2175056994f1e2da96c3f2057cec10c883204c2", "committedDate": "2020-01-28T21:48:28Z", "message": "Increase block worker executor thread count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d39fe982612e81f60ce1ded37915abe42efc134c", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/d39fe982612e81f60ce1ded37915abe42efc134c", "committedDate": "2020-01-28T23:23:41Z", "message": "Register clients to closer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzc5ODk4", "url": "https://github.com/Alluxio/alluxio/pull/10777#pullrequestreview-349779898", "createdAt": "2020-01-28T23:36:01Z", "commit": {"oid": "d39fe982612e81f60ce1ded37915abe42efc134c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzozNjowMlrOFi4VqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzozNjowMlrOFi4VqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExODk1Mw==", "bodyText": "mBlockMasterClientPool = mResourceCloser.register?", "url": "https://github.com/Alluxio/alluxio/pull/10777#discussion_r372118953", "createdAt": "2020-01-28T23:36:02Z", "author": {"login": "calvinjia"}, "path": "core/server/worker/src/main/java/alluxio/worker/block/DefaultBlockWorker.java", "diffHunk": "@@ -147,11 +149,11 @@\n   DefaultBlockWorker(BlockMasterClientPool blockMasterClientPool,\n       FileSystemMasterClient fileSystemMasterClient, Sessions sessions, BlockStore blockStore,\n       UfsManager ufsManager) {\n-    super(Executors\n-        .newFixedThreadPool(4, ThreadFactoryUtils.build(\"block-worker-heartbeat-%d\", true)));\n-    mBlockMasterClientPool = blockMasterClientPool;\n+    super(ExecutorServiceFactories.fixedThreadPool(\"block-worker-executor\", 5));\n+    mResourceCloser = Closer.create();\n+    mResourceCloser.register(mBlockMasterClientPool = blockMasterClientPool);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d39fe982612e81f60ce1ded37915abe42efc134c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8156e2f1285aea2ce93a39ec9ce9d71d4495106b", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/8156e2f1285aea2ce93a39ec9ce9d71d4495106b", "committedDate": "2020-01-28T23:50:52Z", "message": "Avoid owning a client in block worker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dda2f46a8120b45fe8320aa5eaa60b255797e8e", "author": {"user": {"login": "ggezer", "name": "G\u00f6kt\u00fcrk Gezer"}}, "url": "https://github.com/Alluxio/alluxio/commit/7dda2f46a8120b45fe8320aa5eaa60b255797e8e", "committedDate": "2020-01-28T23:52:14Z", "message": "Fix closer registrations for client pools"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzg4Njkw", "url": "https://github.com/Alluxio/alluxio/pull/10777#pullrequestreview-349788690", "createdAt": "2020-01-29T00:01:44Z", "commit": {"oid": "7dda2f46a8120b45fe8320aa5eaa60b255797e8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3122, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}