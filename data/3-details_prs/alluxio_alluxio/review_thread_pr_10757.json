{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzODkxNzA2", "number": 10757, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyMzo0NVrODY_Csw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyNjozOVrODY_DDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI1Mjk5OnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyMzo0NVrOFfJvzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxOToxNzoxMVrOFfnXEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTg2OQ==", "bodyText": "I actually suggest to remove the assertions around mCacheManager which is implementation details for integration tests (meant to be testing user-facing APIs and mCacheManager is not). Something like the below looks great to me already:\n @Test\n  public void read() throws Exception {\n    AlluxioURI path = new AlluxioURI(mFilePath);\n    FileSystemTestUtils.createByteFile(\n        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n    // read a file to populate the cache\n    try (FileInStream stream = mFileSystem.openFile(path)) {\n      assertTrue(BufferUtils.equalIncreasingByteArray(\n          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n    }\n    mClusterResource.get().stopWorkers();\n    // verify reading from local cache\n    try (InputStream stream = mFileSystem.openFile(path)) {\n      assertTrue(BufferUtils.equalIncreasingByteArray(\n          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n    }\n  }", "url": "https://github.com/Alluxio/alluxio/pull/10757#discussion_r368209869", "createdAt": "2020-01-18T06:23:45Z", "author": {"login": "apc999"}, "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.Constants;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.PropertyKey;\n+import alluxio.exception.status.UnavailableException;\n+import alluxio.grpc.WritePType;\n+import alluxio.testutils.BaseIntegrationTest;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.util.io.BufferUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.io.ByteStreams;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.InputStream;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+\n+public final class LocalCacheFileInStreamIntegrationTest extends BaseIntegrationTest {\n+  private static final int PAGE_SIZE_BYTES = Constants.KB;\n+  private static final int PAGE_COUNT = 32;\n+  private static final int CACHE_SIZE_BYTES = PAGE_COUNT * PAGE_SIZE_BYTES;\n+\n+  @Rule\n+  public LocalAlluxioClusterResource mClusterResource =\n+      new LocalAlluxioClusterResource.Builder()\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_BLOCK_SIZE_BYTES_DEFAULT, Constants.MB)\n+          .setProperty(PropertyKey.USER_LOCAL_CACHE_ENABLED, true)\n+          .build();\n+\n+  @Rule\n+  public final ExpectedException mThrown = ExpectedException.none();\n+\n+  private FileSystemContext mFsContext;\n+  private CacheManager mCacheManager;\n+  private FileSystem mFileSystem;\n+  private String mFilePath;\n+\n+  @Before\n+  public void before() throws Exception {\n+    mFsContext = FileSystemContext.create(mClusterResource.get().getClient().getConf());\n+    mCacheManager = mFsContext.getCacheManager();\n+    mFileSystem = mClusterResource.get().getClient(mFsContext);\n+    mFilePath = PathUtils.uniqPath();\n+  }\n+\n+  @After\n+  public void after() throws Exception {\n+    mFsContext.close();\n+  }\n+\n+  @Test\n+  public void read() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c174c562dfcbbc38840597c3a3cedcfc565b8063"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5NTA1Nw==", "bodyText": "I am fine removing it here since we test the cache indirectly through offline read. I wouldn't rule out using implementation details in integration tests where it is hard to verify results just through the public interface.", "url": "https://github.com/Alluxio/alluxio/pull/10757#discussion_r368695057", "createdAt": "2020-01-20T19:17:11Z", "author": {"login": "bf8086"}, "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.Constants;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.PropertyKey;\n+import alluxio.exception.status.UnavailableException;\n+import alluxio.grpc.WritePType;\n+import alluxio.testutils.BaseIntegrationTest;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.util.io.BufferUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.io.ByteStreams;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.InputStream;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+\n+public final class LocalCacheFileInStreamIntegrationTest extends BaseIntegrationTest {\n+  private static final int PAGE_SIZE_BYTES = Constants.KB;\n+  private static final int PAGE_COUNT = 32;\n+  private static final int CACHE_SIZE_BYTES = PAGE_COUNT * PAGE_SIZE_BYTES;\n+\n+  @Rule\n+  public LocalAlluxioClusterResource mClusterResource =\n+      new LocalAlluxioClusterResource.Builder()\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_BLOCK_SIZE_BYTES_DEFAULT, Constants.MB)\n+          .setProperty(PropertyKey.USER_LOCAL_CACHE_ENABLED, true)\n+          .build();\n+\n+  @Rule\n+  public final ExpectedException mThrown = ExpectedException.none();\n+\n+  private FileSystemContext mFsContext;\n+  private CacheManager mCacheManager;\n+  private FileSystem mFileSystem;\n+  private String mFilePath;\n+\n+  @Before\n+  public void before() throws Exception {\n+    mFsContext = FileSystemContext.create(mClusterResource.get().getClient().getConf());\n+    mCacheManager = mFsContext.getCacheManager();\n+    mFileSystem = mClusterResource.get().getClient(mFsContext);\n+    mFilePath = PathUtils.uniqPath();\n+  }\n+\n+  @After\n+  public void after() throws Exception {\n+    mFsContext.close();\n+  }\n+\n+  @Test\n+  public void read() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTg2OQ=="}, "originalCommit": {"oid": "c174c562dfcbbc38840597c3a3cedcfc565b8063"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI1MzUxOnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyNTozNlrOFfJwCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxOToxNzo0NFrOFfnXpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTkzMA==", "bodyText": "same here, page becomes implementation details which should be hidden from Stream APIs. Similar comments on the other test cases", "url": "https://github.com/Alluxio/alluxio/pull/10757#discussion_r368209930", "createdAt": "2020-01-18T06:25:36Z", "author": {"login": "apc999"}, "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.Constants;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.PropertyKey;\n+import alluxio.exception.status.UnavailableException;\n+import alluxio.grpc.WritePType;\n+import alluxio.testutils.BaseIntegrationTest;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.util.io.BufferUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.io.ByteStreams;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.InputStream;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+\n+public final class LocalCacheFileInStreamIntegrationTest extends BaseIntegrationTest {\n+  private static final int PAGE_SIZE_BYTES = Constants.KB;\n+  private static final int PAGE_COUNT = 32;\n+  private static final int CACHE_SIZE_BYTES = PAGE_COUNT * PAGE_SIZE_BYTES;\n+\n+  @Rule\n+  public LocalAlluxioClusterResource mClusterResource =\n+      new LocalAlluxioClusterResource.Builder()\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_BLOCK_SIZE_BYTES_DEFAULT, Constants.MB)\n+          .setProperty(PropertyKey.USER_LOCAL_CACHE_ENABLED, true)\n+          .build();\n+\n+  @Rule\n+  public final ExpectedException mThrown = ExpectedException.none();\n+\n+  private FileSystemContext mFsContext;\n+  private CacheManager mCacheManager;\n+  private FileSystem mFileSystem;\n+  private String mFilePath;\n+\n+  @Before\n+  public void before() throws Exception {\n+    mFsContext = FileSystemContext.create(mClusterResource.get().getClient().getConf());\n+    mCacheManager = mFsContext.getCacheManager();\n+    mFileSystem = mClusterResource.get().getClient(mFsContext);\n+    mFilePath = PathUtils.uniqPath();\n+  }\n+\n+  @After\n+  public void after() throws Exception {\n+    mFsContext.close();\n+  }\n+\n+  @Test\n+  public void read() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    // read a file to populate the cache\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {\n+      assertNotNull(channel);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(Channels.newInputStream(channel))));\n+    }\n+    mClusterResource.get().stopWorkers();\n+    // verify reading from local cache\n+    try (InputStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+  }\n+\n+  @Test\n+  public void positionedRead() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      byte[] buffer = new byte[PAGE_SIZE_BYTES / 4];\n+      int bytesRead = stream.positionedRead(PAGE_SIZE_BYTES / 10, buffer, 0, buffer.length);\n+      assertEquals(buffer.length, bytesRead);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(PAGE_SIZE_BYTES / 10, buffer.length, buffer));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c174c562dfcbbc38840597c3a3cedcfc565b8063"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY5NTIwNA==", "bodyText": "Done.", "url": "https://github.com/Alluxio/alluxio/pull/10757#discussion_r368695204", "createdAt": "2020-01-20T19:17:44Z", "author": {"login": "bf8086"}, "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.Constants;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.PropertyKey;\n+import alluxio.exception.status.UnavailableException;\n+import alluxio.grpc.WritePType;\n+import alluxio.testutils.BaseIntegrationTest;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.util.io.BufferUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.io.ByteStreams;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.InputStream;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+\n+public final class LocalCacheFileInStreamIntegrationTest extends BaseIntegrationTest {\n+  private static final int PAGE_SIZE_BYTES = Constants.KB;\n+  private static final int PAGE_COUNT = 32;\n+  private static final int CACHE_SIZE_BYTES = PAGE_COUNT * PAGE_SIZE_BYTES;\n+\n+  @Rule\n+  public LocalAlluxioClusterResource mClusterResource =\n+      new LocalAlluxioClusterResource.Builder()\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_BLOCK_SIZE_BYTES_DEFAULT, Constants.MB)\n+          .setProperty(PropertyKey.USER_LOCAL_CACHE_ENABLED, true)\n+          .build();\n+\n+  @Rule\n+  public final ExpectedException mThrown = ExpectedException.none();\n+\n+  private FileSystemContext mFsContext;\n+  private CacheManager mCacheManager;\n+  private FileSystem mFileSystem;\n+  private String mFilePath;\n+\n+  @Before\n+  public void before() throws Exception {\n+    mFsContext = FileSystemContext.create(mClusterResource.get().getClient().getConf());\n+    mCacheManager = mFsContext.getCacheManager();\n+    mFileSystem = mClusterResource.get().getClient(mFsContext);\n+    mFilePath = PathUtils.uniqPath();\n+  }\n+\n+  @After\n+  public void after() throws Exception {\n+    mFsContext.close();\n+  }\n+\n+  @Test\n+  public void read() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    // read a file to populate the cache\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {\n+      assertNotNull(channel);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(Channels.newInputStream(channel))));\n+    }\n+    mClusterResource.get().stopWorkers();\n+    // verify reading from local cache\n+    try (InputStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+  }\n+\n+  @Test\n+  public void positionedRead() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      byte[] buffer = new byte[PAGE_SIZE_BYTES / 4];\n+      int bytesRead = stream.positionedRead(PAGE_SIZE_BYTES / 10, buffer, 0, buffer.length);\n+      assertEquals(buffer.length, bytesRead);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(PAGE_SIZE_BYTES / 10, buffer.length, buffer));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTkzMA=="}, "originalCommit": {"oid": "c174c562dfcbbc38840597c3a3cedcfc565b8063"}, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTI1Mzg4OnYy", "diffSide": "RIGHT", "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyNjozOVrOFfJwOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNjoyNjozOVrOFfJwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwOTk3Ng==", "bodyText": "Once we removed try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {...} we should be asserting only on the pages just read?", "url": "https://github.com/Alluxio/alluxio/pull/10757#discussion_r368209976", "createdAt": "2020-01-18T06:26:39Z", "author": {"login": "apc999"}, "path": "tests/src/test/java/alluxio/client/fs/LocalCacheFileInStreamIntegrationTest.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.fs;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.Constants;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileSystem;\n+import alluxio.client.file.FileSystemContext;\n+import alluxio.client.file.FileSystemTestUtils;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.PageId;\n+import alluxio.conf.PropertyKey;\n+import alluxio.exception.status.UnavailableException;\n+import alluxio.grpc.WritePType;\n+import alluxio.testutils.BaseIntegrationTest;\n+import alluxio.testutils.LocalAlluxioClusterResource;\n+import alluxio.util.io.BufferUtils;\n+import alluxio.util.io.PathUtils;\n+\n+import com.google.common.io.ByteStreams;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.InputStream;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+\n+public final class LocalCacheFileInStreamIntegrationTest extends BaseIntegrationTest {\n+  private static final int PAGE_SIZE_BYTES = Constants.KB;\n+  private static final int PAGE_COUNT = 32;\n+  private static final int CACHE_SIZE_BYTES = PAGE_COUNT * PAGE_SIZE_BYTES;\n+\n+  @Rule\n+  public LocalAlluxioClusterResource mClusterResource =\n+      new LocalAlluxioClusterResource.Builder()\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_PAGE_SIZE, PAGE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_CLIENT_CACHE_SIZE, CACHE_SIZE_BYTES)\n+          .setProperty(PropertyKey.USER_BLOCK_SIZE_BYTES_DEFAULT, Constants.MB)\n+          .setProperty(PropertyKey.USER_LOCAL_CACHE_ENABLED, true)\n+          .build();\n+\n+  @Rule\n+  public final ExpectedException mThrown = ExpectedException.none();\n+\n+  private FileSystemContext mFsContext;\n+  private CacheManager mCacheManager;\n+  private FileSystem mFileSystem;\n+  private String mFilePath;\n+\n+  @Before\n+  public void before() throws Exception {\n+    mFsContext = FileSystemContext.create(mClusterResource.get().getClient().getConf());\n+    mCacheManager = mFsContext.getCacheManager();\n+    mFileSystem = mClusterResource.get().getClient(mFsContext);\n+    mFilePath = PathUtils.uniqPath();\n+  }\n+\n+  @After\n+  public void after() throws Exception {\n+    mFsContext.close();\n+  }\n+\n+  @Test\n+  public void read() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    // read a file to populate the cache\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {\n+      assertNotNull(channel);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(Channels.newInputStream(channel))));\n+    }\n+    mClusterResource.get().stopWorkers();\n+    // verify reading from local cache\n+    try (InputStream stream = mFileSystem.openFile(path)) {\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(stream)));\n+    }\n+  }\n+\n+  @Test\n+  public void positionedRead() throws Exception {\n+    AlluxioURI path = new AlluxioURI(mFilePath);\n+    FileSystemTestUtils.createByteFile(\n+        mFileSystem, mFilePath, WritePType.MUST_CACHE, PAGE_SIZE_BYTES);\n+    try (FileInStream stream = mFileSystem.openFile(path)) {\n+      byte[] buffer = new byte[PAGE_SIZE_BYTES / 4];\n+      int bytesRead = stream.positionedRead(PAGE_SIZE_BYTES / 10, buffer, 0, buffer.length);\n+      assertEquals(buffer.length, bytesRead);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(PAGE_SIZE_BYTES / 10, buffer.length, buffer));\n+    }\n+    // verify locally cached data\n+    URIStatus status = mFileSystem.getStatus(path);\n+    try (ReadableByteChannel channel = mCacheManager.get(new PageId(status.getFileId(), 0))) {\n+      assertNotNull(channel);\n+      assertTrue(BufferUtils.equalIncreasingByteArray(\n+          PAGE_SIZE_BYTES, ByteStreams.toByteArray(Channels.newInputStream(channel))));\n+    }\n+    mClusterResource.get().stopWorkers();\n+    // verify reading whole page from local cache\n+    try (InputStream stream = mFileSystem.openFile(path)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c174c562dfcbbc38840597c3a3cedcfc565b8063"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2252, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}