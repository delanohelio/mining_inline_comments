{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDA5NzM4", "number": 12013, "title": "Fix local cache locking", "bodyText": "Fix two issues:\n(1) Previously MetaStore and Evictor are both used as the state to make eviction decisions, but they are not put in the same critical section, and not coordinated to be consistent in tricky cases of failed page store deletes. This PR makes evictor a part of MetaStore so their content will always be consistent\n(2) Eviction is a 2PC (phase 1 in metastore and phase 2 in pagestore), this PR fixes the undo logic when this 2PC failed in the middle.", "createdAt": "2020-08-19T08:36:37Z", "url": "https://github.com/Alluxio/alluxio/pull/12013", "merged": true, "mergeCommit": {"oid": "03e0bd82fdcb2b64cbb67459842dc0c844aae8fc"}, "closed": true, "closedAt": "2020-08-20T05:50:22Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAe-rfgFqTQ3MDY4NDgwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAjizyABqjM2NzI4NTM3OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg0ODA3", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470684807", "createdAt": "2020-08-19T17:22:50Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMjo1MFrOHDR4lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMjo1MFrOHDR4lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMDc4OA==", "bodyText": "Spacing", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473200788", "createdAt": "2020-08-19T17:22:50Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -300,25 +297,25 @@ private boolean putInternal(PageId pageId, byte[] page) {\n       }\n     }\n \n-    Pair<ReadWriteLock, ReadWriteLock> pageLockPair = getPageLockPair(pageId, victim);\n+    Pair<ReadWriteLock, ReadWriteLock> pageLockPair =\n+        getPageLockPair(pageId, victimPageInfo.getPageId());\n     try (LockResource r1 = new LockResource(pageLockPair.getFirst().writeLock());\n-        LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n+         LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg1Mzg2", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470685386", "createdAt": "2020-08-19T17:23:41Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMzo0MVrOHDR6Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyMzo0MVrOHDR6Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMTIzMA==", "bodyText": "Should we change the metric below to be more specific?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473201230", "createdAt": "2020-08-19T17:23:41Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -300,25 +297,25 @@ private boolean putInternal(PageId pageId, byte[] page) {\n       }\n     }\n \n-    Pair<ReadWriteLock, ReadWriteLock> pageLockPair = getPageLockPair(pageId, victim);\n+    Pair<ReadWriteLock, ReadWriteLock> pageLockPair =\n+        getPageLockPair(pageId, victimPageInfo.getPageId());\n     try (LockResource r1 = new LockResource(pageLockPair.getFirst().writeLock());\n-        LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n+         LockResource r2 = new LockResource(pageLockPair.getSecond().writeLock())) {\n       try (LockResource r3 = new LockResource(mMetaLock.writeLock())) {\n         if (mMetaStore.hasPage(pageId)) {\n           LOG.debug(\"{} is already inserted by a racing thread\", pageId);\n           // TODO(binfan): we should return more informative result in the future\n           return true;\n         }\n-        if (!mMetaStore.hasPage(victim)) {\n+        if (!mMetaStore.hasPage(victimPageInfo.getPageId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg2NDEy", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470686412", "createdAt": "2020-08-19T17:25:02Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyNTowMlrOHDR9Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyNTowMlrOHDR9Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMjAwNg==", "bodyText": "If this is null, do we need to do something to update the evictor state?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473202006", "createdAt": "2020-08-19T17:25:02Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -74,5 +84,16 @@ public void reset() {\n     mPages.set(0);\n     mBytes.set(0);\n     mPageMap.clear();\n+    mEvictor.reset();\n+  }\n+\n+  @Override\n+  @Nullable\n+  public PageInfo evict() {\n+    PageId victim = mEvictor.evict();\n+    if (victim == null) {\n+      return null;\n+    }\n+    return mPageMap.get(victim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjkxMTQx", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470691141", "createdAt": "2020-08-19T17:31:33Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozMTozM1rOHDSL2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozMTozM1rOHDSL2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwNTcyMw==", "bodyText": "Not sure if this comment is accurate, we already removed the victim from the metastore on line 316, so I think we need to go through with the ondisk delete? ie Regardless of enoughSpace, we need to delete the victim as it has been removed from the metastore?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473205723", "createdAt": "2020-08-19T17:31:33Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -327,37 +324,43 @@ private boolean putInternal(PageId pageId, byte[] page) {\n           mMetaStore.addPage(pageId, new PageInfo(pageId, page.length));\n         }\n       }\n-      if (deletePage(victim, victimPageInfo)) {\n+      // Regardless enoughSpace, evicting victim to make progress", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjk1MzY5", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470695369", "createdAt": "2020-08-19T17:37:11Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozNzoxMVrOHDSYTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzozNzoxMVrOHDSYTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwODkwOA==", "bodyText": "Change this comment to failed to evict page, remove new page from metastore as there will not be enough space?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473208908", "createdAt": "2020-08-19T17:37:11Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -327,37 +324,43 @@ private boolean putInternal(PageId pageId, byte[] page) {\n           mMetaStore.addPage(pageId, new PageInfo(pageId, page.length));\n         }\n       }\n-      if (deletePage(victim, victimPageInfo)) {\n+      // Regardless enoughSpace, evicting victim to make progress\n+      if (deletePage(victimPageInfo.getPageId())) {\n         Metrics.BYTES_EVICTED_CACHE.mark(victimPageInfo.getPageSize());\n         Metrics.PAGES_EVICTED_CACHE.mark();\n       } else {\n-        LOG.debug(\"Failed to evict page: {}\", victim);\n+        LOG.debug(\"Failed to evict page: {}\", victimPageInfo.getPageId());\n         Metrics.PUT_EVICTION_ERRORS.inc();\n+        // something is wrong to add this page, let's remove it from meta store", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjk5MjQ3", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470699247", "createdAt": "2020-08-19T17:42:33Z", "commit": {"oid": "56166b4ab033552d0c277ce688c3780443e0964c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTM1MTY5", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470935169", "createdAt": "2020-08-19T20:50:56Z", "commit": {"oid": "347a0bf1378b0f3ea4659768fe4a24272086c778"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOHDYmVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo1MDo1NlrOHDYmVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDgwNw==", "bodyText": "Do we need to return after succeeding?", "url": "https://github.com/Alluxio/alluxio/pull/12013#discussion_r473310807", "createdAt": "2020-08-19T20:50:56Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheManager.java", "diffHunk": "@@ -279,87 +278,86 @@ private boolean putInternal(PageId pageId, byte[] page) {\n         }\n       }\n       if (enoughSpace) {\n-        boolean ok = addPage(pageId, page);\n-        if (ok) {\n+        try {\n+          mPageStore.put(pageId, page);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "347a0bf1378b0f3ea4659768fe4a24272086c778"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTQ0MTUy", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470944152", "createdAt": "2020-08-19T20:55:02Z", "commit": {"oid": "347a0bf1378b0f3ea4659768fe4a24272086c778"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTkyMDIx", "url": "https://github.com/Alluxio/alluxio/pull/12013#pullrequestreview-470992021", "createdAt": "2020-08-19T21:54:15Z", "commit": {"oid": "3d59ec65147308deb70894eb85315da93db485e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52df2dbea99a0aada5b31e20f0a9d1c521e7e66a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/52df2dbea99a0aada5b31e20f0a9d1c521e7e66a", "committedDate": "2020-08-19T22:41:45Z", "message": "Fix local cache locking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d59ec65147308deb70894eb85315da93db485e4", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/3d59ec65147308deb70894eb85315da93db485e4", "committedDate": "2020-08-19T21:49:04Z", "message": "Address comments"}, "afterCommit": {"oid": "52df2dbea99a0aada5b31e20f0a9d1c521e7e66a", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/52df2dbea99a0aada5b31e20f0a9d1c521e7e66a", "committedDate": "2020-08-19T22:41:45Z", "message": "Fix local cache locking"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4150, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}