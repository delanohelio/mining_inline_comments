{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NTEzOTU0", "number": 11573, "title": "Reduce number of clients in DistributedLoadCommand", "bodyText": "Creating many clients in DistributedLoadCommand creates an issue in certain environments. Reduce the number of clients and also remove the parallelism around it to prevent race conditions when using the same client.", "createdAt": "2020-06-16T23:13:24Z", "url": "https://github.com/Alluxio/alluxio/pull/11573", "merged": true, "mergeCommit": {"oid": "bc24833d3e5fc687fd51a08209ae255cd66d543b"}, "closed": true, "closedAt": "2020-06-17T22:27:35Z", "author": {"login": "bradyoo"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr9nA_gH2gAyNDM1NTEzOTU0OjAzYzVhMTkxNzg0M2IyYjZiYTgxNzBmMzQ5MTA0OGNlZDU4MGM4NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsRSpNAFqTQzMjgxMTAzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/03c5a1917843b2b6ba8170f3491048ced580c844", "committedDate": "2020-06-16T23:11:39Z", "message": "Reduce number of clients in DistributedLoadCommand"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTcwNTA4", "url": "https://github.com/Alluxio/alluxio/pull/11573#pullrequestreview-431970508", "createdAt": "2020-06-17T00:01:45Z", "commit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMDowMTo0NlrOGkxHgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMDowMzo0M1rOGkxJqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ==", "bodyText": "Does this method spin over checking jobs?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441206659", "createdAt": "2020-06-17T00:01:46Z", "author": {"login": "ggezer"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -200,7 +200,7 @@ private JobAttempt newJob(AlluxioURI filePath, int replication) {\n   private void waitJob() {\n     AtomicBoolean removed = new AtomicBoolean(false);\n     while (true) {\n-      mSubmittedJobAttempts = mSubmittedJobAttempts.parallelStream().filter((jobAttempt) -> {\n+      mSubmittedJobAttempts = mSubmittedJobAttempts.stream().filter((jobAttempt) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzA5OQ==", "bodyText": "Do you need the path-conf here?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207099", "createdAt": "2020-06-17T00:03:18Z", "author": {"login": "ggezer"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -186,8 +180,14 @@ public int run(CommandLine cl) throws AlluxioException, IOException {\n    * @param replication The replication of file to load into Alluxio memory\n    */\n   private JobAttempt newJob(AlluxioURI filePath, int replication) {\n+    final ClientContext clientContext = ClientContext.create(mFsContext.getPathConf(filePath));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNzIxMQ==", "bodyText": "Why can't we just use this one always?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441207211", "createdAt": "2020-06-17T00:03:43Z", "author": {"login": "ggezer"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -67,15 +67,12 @@\n   private class JobAttempt {\n     private final LoadConfig mJobConfig;\n     private final RetryPolicy mRetryPolicy;\n-    private final JobMasterClient mClient;\n \n     private Long mJobId;\n \n-    private JobAttempt(LoadConfig jobConfig, RetryPolicy retryPolicy, ClientContext clientContext) {\n+    private JobAttempt(LoadConfig jobConfig, RetryPolicy retryPolicy) {\n       mJobConfig = jobConfig;\n       mRetryPolicy = retryPolicy;\n-      mClient = JobMasterClient.Factory.create(\n-          JobMasterClientContext.newBuilder(clientContext).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTc1MTc2", "url": "https://github.com/Alluxio/alluxio/pull/11573#pullrequestreview-431975176", "createdAt": "2020-06-17T00:16:47Z", "commit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMDoxNjo0OFrOGkxXsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMDoxNjo0OFrOGkxXsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxMDgwMQ==", "bodyText": "Was this a bug?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441210801", "createdAt": "2020-06-17T00:16:48Z", "author": {"login": "ggezer"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -209,11 +209,6 @@ private void waitJob() {\n           case CANCELED:\n           case COMPLETED:\n             removed.set(true);\n-            try {\n-              jobAttempt.close();\n-            } catch (IOException e) {\n-              LOG.warn(\"Unable to close job master client\", e);\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b75f52239572c702b3b4d04a94ee7c57f9145a9", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/6b75f52239572c702b3b4d04a94ee7c57f9145a9", "committedDate": "2020-06-17T16:50:22Z", "message": "feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjI5NzYw", "url": "https://github.com/Alluxio/alluxio/pull/11573#pullrequestreview-432629760", "createdAt": "2020-06-17T17:41:13Z", "commit": {"oid": "6b75f52239572c702b3b4d04a94ee7c57f9145a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo0MToxM1rOGlQSpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo0MToxM1rOGlQSpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcxNzQxNQ==", "bodyText": "Can you override the Command#close() and close this client there?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441717415", "createdAt": "2020-06-17T17:41:13Z", "author": {"login": "ggezer"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -145,7 +147,11 @@ private Status check() {\n   public DistributedLoadCommand(FileSystemContext fsContext) {\n     super(fsContext);\n     mSubmittedJobAttempts = Lists.newArrayList();\n-    mClient = null;\n+\n+    InstancedConfiguration conf = new InstancedConfiguration(ConfigurationUtils.defaults());\n+    final ClientContext clientContext = ClientContext.create(conf);\n+    mClient = JobMasterClient.Factory.create(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b75f52239572c702b3b4d04a94ee7c57f9145a9"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f703150ca0003f5e19a6c04ae52d0371616a7dff", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/f703150ca0003f5e19a6c04ae52d0371616a7dff", "committedDate": "2020-06-17T17:46:25Z", "message": "feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjQ5Mjk2", "url": "https://github.com/Alluxio/alluxio/pull/11573#pullrequestreview-432649296", "createdAt": "2020-06-17T18:06:36Z", "commit": {"oid": "f703150ca0003f5e19a6c04ae52d0371616a7dff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODowNjozN1rOGlRN2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODowNjozN1rOGlRN2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMjU2OQ==", "bodyText": "This whole structure seems strange? Could we not just have a threadpool/executor service that just runs tasks, one for each path? The generator just goes through the tree and adds tasks. It is strange that there is this spin loop that has to check all jobs?", "url": "https://github.com/Alluxio/alluxio/pull/11573#discussion_r441732569", "createdAt": "2020-06-17T18:06:37Z", "author": {"login": "gpang"}, "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -200,7 +200,7 @@ private JobAttempt newJob(AlluxioURI filePath, int replication) {\n   private void waitJob() {\n     AtomicBoolean removed = new AtomicBoolean(false);\n     while (true) {\n-      mSubmittedJobAttempts = mSubmittedJobAttempts.parallelStream().filter((jobAttempt) -> {\n+      mSubmittedJobAttempts = mSubmittedJobAttempts.stream().filter((jobAttempt) -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwNjY1OQ=="}, "originalCommit": {"oid": "03c5a1917843b2b6ba8170f3491048ced580c844"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb5d21059e515c7992c03235e773a576777bb58b", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/cb5d21059e515c7992c03235e773a576777bb58b", "committedDate": "2020-06-17T20:10:54Z", "message": "bring back path conf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "690d25993785d49edbfc43d3307b7df69ad06fcc", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/690d25993785d49edbfc43d3307b7df69ad06fcc", "committedDate": "2020-06-17T21:01:22Z", "message": "mFsContext's client context is good enough"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad2b75c1a4e360a2a197ef925fdef9b5a25944c2", "author": {"user": {"login": "bradyoo", "name": "Bradley Yoo"}}, "url": "https://github.com/Alluxio/alluxio/commit/ad2b75c1a4e360a2a197ef925fdef9b5a25944c2", "committedDate": "2020-06-17T21:03:15Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODExMDM5", "url": "https://github.com/Alluxio/alluxio/pull/11573#pullrequestreview-432811039", "createdAt": "2020-06-17T22:07:30Z", "commit": {"oid": "ad2b75c1a4e360a2a197ef925fdef9b5a25944c2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4527, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}