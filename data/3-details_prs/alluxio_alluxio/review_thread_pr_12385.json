{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5Mjc2MTI3", "number": 12385, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNTozNToyNFrOExkgGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODo0MzowOVrOEygCEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDEzNzIxOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNTozNToyNFrOHnying==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTozNjo0OFrOHojVFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4NDU3NA==", "bodyText": "Do the corresponding page stores need to handle InterruptedException? For example, LocalPageStore will throw an IOException if it catches any exception, so we will not see TimeoutException?", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r511484574", "createdAt": "2020-10-24T15:35:24Z", "author": {"login": "calvinjia"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ *\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout.\n+ */\n+public class TimeLimitedPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+\n+  /**\n+   * @param pageStore page store\n+   * @param timeout time out in ms\n+   */\n+  public TimeLimitedPageStore(PageStore pageStore, long timeout) {\n+    mPageStore = pageStore;\n+    mTimeoutMs = timeout;\n+    mTimeLimter = SimpleTimeLimiter.create(Executors.newCachedThreadPool());\n+  }\n+\n+  @Override\n+  public void put(PageId pageId, byte[] page) throws IOException {\n+    try {\n+      Callable<Void> callable = () -> {\n+        mPageStore.put(pageId, page);\n+        return null;\n+      };\n+      mTimeLimter.callWithTimeout(callable, mTimeoutMs, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4MzkyNw==", "bodyText": "we will need to handle InterruptedException  here. Updated the code.\nLocalPageStore shouldn't make any change", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512283927", "createdAt": "2020-10-26T21:36:48Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ *\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout.\n+ */\n+public class TimeLimitedPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+\n+  /**\n+   * @param pageStore page store\n+   * @param timeout time out in ms\n+   */\n+  public TimeLimitedPageStore(PageStore pageStore, long timeout) {\n+    mPageStore = pageStore;\n+    mTimeoutMs = timeout;\n+    mTimeLimter = SimpleTimeLimiter.create(Executors.newCachedThreadPool());\n+  }\n+\n+  @Override\n+  public void put(PageId pageId, byte[] page) throws IOException {\n+    try {\n+      Callable<Void> callable = () -> {\n+        mPageStore.put(pageId, page);\n+        return null;\n+      };\n+      mTimeLimter.callWithTimeout(callable, mTimeoutMs, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4NDU3NA=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTM2Mzg5OnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDoxMDo1MlrOHoghOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowMTo0NFrOHoqoRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNzg4Mw==", "bodyText": "Update this description.", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512237883", "createdAt": "2020-10-26T20:10:52Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -962,6 +962,24 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_DELETE_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_DELETE_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwMzUyNQ==", "bodyText": "done", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512403525", "createdAt": "2020-10-27T04:01:44Z", "author": {"login": "apc999"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -962,6 +962,24 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_DELETE_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_DELETE_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNzg4Mw=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTM2NDIwOnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDoxMDo1OFrOHoghaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowMTo0OVrOHoqoUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNzkzMQ==", "bodyText": "Update this description.", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512237931", "createdAt": "2020-10-26T20:10:58Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -962,6 +962,24 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_DELETE_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_DELETE_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_GET_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_GET_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwMzUzOA==", "bodyText": "done", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512403538", "createdAt": "2020-10-27T04:01:49Z", "author": {"login": "apc999"}, "path": "core/common/src/main/java/alluxio/metrics/MetricKey.java", "diffHunk": "@@ -962,6 +962,24 @@ public MetricKey build() {\n           .setMetricType(MetricType.COUNTER)\n           .setIsClusterAggregated(false)\n           .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_DELETE_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_DELETE_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")\n+          .setMetricType(MetricType.COUNTER)\n+          .setIsClusterAggregated(false)\n+          .build();\n+  public static final MetricKey CLIENT_CACHE_STORE_GET_TIMEOUT =\n+      new Builder(Name.CLIENT_CACHE_STORE_GET_TIMEOUT)\n+          .setDescription(\"Number of timeouts when writing new pages to page store.\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzNzkzMQ=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTM2NjczOnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDoxMTo0MVrOHogjAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxMDoyMlrOHoqwHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzODMzNw==", "bodyText": "operations? Which operations are affected? Also, is there a setting that disables the timeout?", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512238337", "createdAt": "2020-10-26T20:11:41Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,12 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_STORE_TIMEOUT =\n+      new Builder(Name.USER_CLIENT_CACHE_STORE_TIMEOUT)\n+          .setDescription(\"The timeout for page store options\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNTUzNA==", "bodyText": "read/write/delete operations -> updated in description\nthis parameter is not set by default which means disabling timeout..\nAdd more clarification", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512405534", "createdAt": "2020-10-27T04:10:22Z", "author": {"login": "apc999"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,12 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_STORE_TIMEOUT =\n+      new Builder(Name.USER_CLIENT_CACHE_STORE_TIMEOUT)\n+          .setDescription(\"The timeout for page store options\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzODMzNw=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTQwOTcyOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDoyMzo0MVrOHog8iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxNDoyMFrOHoqz4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NDg3NQ==", "bodyText": "Is there a way to create a threadpool that can have named threads? Does the threadpool ever have to be shutdown at the end?", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512244875", "createdAt": "2020-10-26T20:23:41Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ *\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout.\n+ */\n+public class TimeLimitedPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+\n+  /**\n+   * @param pageStore page store\n+   * @param timeout time out in ms\n+   */\n+  public TimeLimitedPageStore(PageStore pageStore, long timeout) {\n+    mPageStore = pageStore;\n+    mTimeoutMs = timeout;\n+    mTimeLimter = SimpleTimeLimiter.create(Executors.newCachedThreadPool());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNjQ5Ng==", "bodyText": "good call. added a reference to ServiceExecuttor and put shutdown in close", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512406496", "createdAt": "2020-10-27T04:14:20Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeLimitedPageStore.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ *\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout.\n+ */\n+public class TimeLimitedPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+\n+  /**\n+   * @param pageStore page store\n+   * @param timeout time out in ms\n+   */\n+  public TimeLimitedPageStore(PageStore pageStore, long timeout) {\n+    mPageStore = pageStore;\n+    mTimeoutMs = timeout;\n+    mTimeLimter = SimpleTimeLimiter.create(Executors.newCachedThreadPool());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NDg3NQ=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTQxODYwOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDoyNjoxMlrOHohCDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxNTowNlrOHoq0qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NjI4Ng==", "bodyText": "will this test take 10s? That seems too long? Would a timeout like 1s be good enough?", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512246286", "createdAt": "2020-10-26T20:26:12Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "diffHunk": "@@ -612,6 +615,45 @@ public void failedPageStoreDeleteOnEviction() throws Exception {\n     assertArrayEquals(PAGE1, mBuf);\n   }\n \n+  @Test\n+  public void putTimeout() throws Exception {\n+    mConf.set(PropertyKey.USER_CLIENT_CACHE_STORE_TIMEOUT, \"10s\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNjY5OA==", "bodyText": "changed to 2sec", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512406698", "createdAt": "2020-10-27T04:15:06Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LocalCacheManagerTest.java", "diffHunk": "@@ -612,6 +615,45 @@ public void failedPageStoreDeleteOnEviction() throws Exception {\n     assertArrayEquals(PAGE1, mBuf);\n   }\n \n+  @Test\n+  public void putTimeout() throws Exception {\n+    mConf.set(PropertyKey.USER_CLIENT_CACHE_STORE_TIMEOUT, \"10s\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI0NjI4Ng=="}, "originalCommit": {"oid": "a4061ad19c7477d9ae9c6d1c7bbd5846d54cb2b9"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzg3NTMzOnYy", "diffSide": "RIGHT", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeBoundPageStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODozOToxMVrOHpLUtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOToyOToyM1rOHpNOKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzOTE5MA==", "bodyText": "NIT: spelling", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512939190", "createdAt": "2020-10-27T18:39:11Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeBoundPageStore.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.client.file.cache.store.PageStoreOptions;\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.SynchronousQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout. Note that, this page store will not queue any request.\n+ */\n+public class TimeBoundPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+  private final ExecutorService mExecuttorService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk3MDI4Mg==", "bodyText": "fixed", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512970282", "createdAt": "2020-10-27T19:29:23Z", "author": {"login": "apc999"}, "path": "core/client/fs/src/main/java/alluxio/client/file/cache/TimeBoundPageStore.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import alluxio.client.file.cache.store.PageStoreOptions;\n+import alluxio.exception.PageNotFoundException;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.SimpleTimeLimiter;\n+import com.google.common.util.concurrent.TimeLimiter;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.SynchronousQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.stream.Stream;\n+\n+/**\n+ * A wrapper class on PageStore with timeout. Note that, this page store will not queue any request.\n+ */\n+public class TimeBoundPageStore implements PageStore {\n+  private final PageStore mPageStore;\n+  private final long mTimeoutMs;\n+  private final TimeLimiter mTimeLimter;\n+  private final ExecutorService mExecuttorService;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzOTE5MA=="}, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzg5MDc1OnYy", "diffSide": "RIGHT", "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODo0MzowOVrOHpLeRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMToyMDoyNFrOHpRc6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0MTYzOA==", "bodyText": "would it be easier to just have a timeout of -1 represent disabled, instead of 2 consistent parameters?", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512941638", "createdAt": "2020-10-27T18:43:09Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,33 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_DURATION =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_DURATION)\n+          .setDefaultValue(\"60sec\")\n+          .setDescription(\"The timeout duration for local I/O operations on \"\n+              + \"reading/writing/deleting in the cache. Local cache operations that time out will \"\n+              + \"fail and fallback to external file system.\")\n+          .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.CLIENT)\n+          .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_ENABLED =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_ENABLED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk3NjM0MQ==", "bodyText": "that's my original way . but it was not a good practise as you need to be very careful to call\nconf.getMs(PropertyKey.USER_CLIENT_CACHE_TIMEOUT_DURATION) which will throw Exception when this is set to -1.\nthis will complicate the source code. IN this case, i prefer a bit more verbose but make sure the produciton\ncode is more type-safe", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r512976341", "createdAt": "2020-10-27T19:36:43Z", "author": {"login": "apc999"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,33 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_DURATION =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_DURATION)\n+          .setDefaultValue(\"60sec\")\n+          .setDescription(\"The timeout duration for local I/O operations on \"\n+              + \"reading/writing/deleting in the cache. Local cache operations that time out will \"\n+              + \"fail and fallback to external file system.\")\n+          .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.CLIENT)\n+          .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_ENABLED =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_ENABLED)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0MTYzOA=="}, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzNDM4Ng==", "bodyText": "Why will it throw an exception? We do this for sync interval: https://github.com/Alluxio/alluxio/blob/master/core/common/src/test/java/alluxio/conf/InstancedConfigurationTest.java#L395", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r513034386", "createdAt": "2020-10-27T21:10:09Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,33 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_DURATION =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_DURATION)\n+          .setDefaultValue(\"60sec\")\n+          .setDescription(\"The timeout duration for local I/O operations on \"\n+              + \"reading/writing/deleting in the cache. Local cache operations that time out will \"\n+              + \"fail and fallback to external file system.\")\n+          .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.CLIENT)\n+          .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_ENABLED =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_ENABLED)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0MTYzOA=="}, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAzOTU5NA==", "bodyText": "ah, sounds good", "url": "https://github.com/Alluxio/alluxio/pull/12385#discussion_r513039594", "createdAt": "2020-10-27T21:20:24Z", "author": {"login": "apc999"}, "path": "core/common/src/main/java/alluxio/conf/PropertyKey.java", "diffHunk": "@@ -3648,6 +3648,33 @@ public String toString() {\n           .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n           .setScope(Scope.CLIENT)\n           .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_DURATION =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_DURATION)\n+          .setDefaultValue(\"60sec\")\n+          .setDescription(\"The timeout duration for local I/O operations on \"\n+              + \"reading/writing/deleting in the cache. Local cache operations that time out will \"\n+              + \"fail and fallback to external file system.\")\n+          .setConsistencyCheckLevel(ConsistencyCheckLevel.WARN)\n+          .setScope(Scope.CLIENT)\n+          .build();\n+  public static final PropertyKey USER_CLIENT_CACHE_TIMEOUT_ENABLED =\n+      new Builder(Name.USER_CLIENT_CACHE_TIMEOUT_ENABLED)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0MTYzOA=="}, "originalCommit": {"oid": "d4232dd2eded4d05a43e294f7dd45ff8ffa1bbe2"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1086, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}