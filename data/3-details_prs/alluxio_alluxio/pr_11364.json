{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjc1MDk2", "number": 11364, "title": "Provide AlluxioJniFuse", "bodyText": "", "createdAt": "2020-04-28T18:04:34Z", "url": "https://github.com/Alluxio/alluxio/pull/11364", "merged": true, "mergeCommit": {"oid": "5adff91e1017827725e3c1d2e6e6bee4f5f9fa13"}, "closed": true, "closedAt": "2020-05-01T16:19:21Z", "author": {"login": "iluoeli"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb7wOvgH2gAyNDEwMjc1MDk2OmM0N2NkMGE1OWY0MDRmMjE4MmU1NThhNWE4YTYwZGMyOTY4NzM1MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdEIxKgFqTQwNDI1MTUyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c47cd0a59f404f2182e558a5a8a60dc296873520", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/c47cd0a59f404f2182e558a5a8a60dc296873520", "committedDate": "2020-04-28T03:59:07Z", "message": "Add struct\n\nNow we can define jnr style structure, and access field just like jnr-fuse."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f5d7dfb18c6393ef5a3640c08807b40ac56bdd", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/e6f5d7dfb18c6393ef5a3640c08807b40ac56bdd", "committedDate": "2020-04-28T09:22:53Z", "message": "Add AlluxioJniFuse.java & AlluxioJniFuseFileSystem.java\n\nMost codes are copied from former AlluxioFuse."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e596005bb9639ebee0bc6761d9c516152126e21", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/8e596005bb9639ebee0bc6761d9c516152126e21", "committedDate": "2020-04-28T09:26:01Z", "message": "Add libjnifuse\n\nNow we can run basic read-only AlluxioFuseFileSystem.\nNOTE: jni cache is not supported."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "625eeec855bd0e1040b5eee98c80f2013ad3ca45", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/625eeec855bd0e1040b5eee98c80f2013ad3ca45", "committedDate": "2020-04-28T18:01:27Z", "message": "Refactor libjnifuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "633d4945ff4b6af1ac9341e2198ed7a3a272cd21", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/633d4945ff4b6af1ac9341e2198ed7a3a272cd21", "committedDate": "2020-04-29T01:30:30Z", "message": "Fix style and refactor package"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db5ec2359661e08bc977a71ae4a4c4d048f2866b", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/db5ec2359661e08bc977a71ae4a4c4d048f2866b", "committedDate": "2020-04-29T01:17:58Z", "message": "Fix style and refactor package"}, "afterCommit": {"oid": "778bc66194618727549f1cb3a7ce817dc4f0cf1f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/778bc66194618727549f1cb3a7ce817dc4f0cf1f", "committedDate": "2020-04-27T07:05:38Z", "message": "Improve Fuse Makefile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "633d4945ff4b6af1ac9341e2198ed7a3a272cd21", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/633d4945ff4b6af1ac9341e2198ed7a3a272cd21", "committedDate": "2020-04-29T01:30:30Z", "message": "Fix style and refactor package"}, "afterCommit": {"oid": "778bc66194618727549f1cb3a7ce817dc4f0cf1f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/778bc66194618727549f1cb3a7ce817dc4f0cf1f", "committedDate": "2020-04-27T07:05:38Z", "message": "Improve Fuse Makefile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884c8e671c0b6ede80972b0018ad418f493cb9b4", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/884c8e671c0b6ede80972b0018ad418f493cb9b4", "committedDate": "2020-04-29T04:41:23Z", "message": "Revert unnecessary formatting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70e1bdd797a5bc52d701b68ab24c01e93bbe57b9", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/70e1bdd797a5bc52d701b68ab24c01e93bbe57b9", "committedDate": "2020-04-29T05:39:05Z", "message": "Cleanup AlluxioFuse"}, "afterCommit": {"oid": "e425edead51e52d2c929b6c9cf00dd63b04afbca", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/e425edead51e52d2c929b6c9cf00dd63b04afbca", "committedDate": "2020-04-29T05:42:25Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e425edead51e52d2c929b6c9cf00dd63b04afbca", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/e425edead51e52d2c929b6c9cf00dd63b04afbca", "committedDate": "2020-04-29T05:42:25Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}, "afterCommit": {"oid": "68bb678f2befaab21bdb1f4bcebacd754eaf41f3", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/68bb678f2befaab21bdb1f4bcebacd754eaf41f3", "committedDate": "2020-04-29T06:38:41Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4", "committedDate": "2020-04-29T06:48:34Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68bb678f2befaab21bdb1f4bcebacd754eaf41f3", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/68bb678f2befaab21bdb1f4bcebacd754eaf41f3", "committedDate": "2020-04-29T06:38:41Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}, "afterCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4", "committedDate": "2020-04-29T06:48:34Z", "message": "Cleanup AlluxioFuse to reduce PR footprint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDAwMzI2", "url": "https://github.com/Alluxio/alluxio/pull/11364#pullrequestreview-402400326", "createdAt": "2020-04-29T06:49:33Z", "commit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNjo0OTozM1rOGNxv5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzozNDowNlrOGNy_bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5OTc0OA==", "bodyText": "Introduce alluxio.jnifuse.FuseException  rather than still referencing jnrfuse", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417099748", "createdAt": "2020-04-29T06:49:33Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/fuse/AlluxioFuse.java", "diffHunk": "@@ -60,32 +94,29 @@ public static void main(String[] args) {\n       System.exit(1);\n     }\n \n-    final FileSystem tfs = FileSystem.Factory.create(conf);\n-    final AlluxioFuseFileSystem fs = new AlluxioFuseFileSystem(tfs, opts, conf);\n-    final List<String> fuseOpts = opts.getFuseOpts();\n-    // Force direct_io in FUSE: writes and reads bypass the kernel page\n-    // cache and go directly to alluxio. This avoids extra memory copies\n-    // in the write path.\n-    fuseOpts.add(\"-odirect_io\");\n+    try (final FileSystem fs = FileSystem.Factory.create(conf)) {\n+      final AlluxioFuseFileSystem fuseFs = new AlluxioFuseFileSystem(fs, opts, conf);\n+      final List<String> fuseOpts = opts.getFuseOpts();\n+      // Force direct_io in FUSE: writes and reads bypass the kernel page\n+      // cache and go directly to alluxio. This avoids extra memory copies\n+      // in the write path.\n+      // TODO: support kernel_cache (https://github.com/Alluxio/alluxio/issues/10840)\n+      fuseOpts.add(\"-odirect_io\");\n \n-    try {\n-      fs.mount(Paths.get(opts.getMountPoint()), true, opts.isDebug(),\n-          fuseOpts.toArray(new String[0]));\n-      LOG.info(\"Mounted Alluxio: mount point=\\\"{}\\\", opts=\\\"{}\\\"\",\n-          opts.getMountPoint(), fuseOpts.toArray(new String[0]));\n-    } catch (FuseException e) {\n-      LOG.error(\"Failed to mount {}\", opts.getMountPoint(), e);\n-      // only try to umount file system when exception occurred.\n-      // jnr-fuse registers JVM shutdown hook to ensure fs.umount()\n-      // will be executed when this process is exiting.\n-      fs.umount();\n-    } finally {\n       try {\n-        tfs.close();\n-        LOG.info(\"Closed Alluxio file system.\");\n-      } catch (Exception e) {\n-        LOG.error(\"Failed to close Alluxio file system\", e);\n+        fuseFs.mount(Paths.get(opts.getMountPoint()), true, opts.isDebug(),\n+            fuseOpts.toArray(new String[0]));\n+        LOG.info(\"Mounted Alluxio: mount point=\\\"{}\\\", OPTIONS=\\\"{}\\\"\",\n+            opts.getMountPoint(), fuseOpts.toArray(new String[0]));\n+      } catch (FuseException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwMTA3Nw==", "bodyText": "Why Pinter to long? do we fill anything here?", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417101077", "createdAt": "2020-04-29T06:52:42Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/fuse/AlluxioFuseFileSystem.java", "diffHunk": "@@ -641,14 +642,14 @@ private int readInternal(String path, Pointer buf, @size_t long size, @off_t lon\n    * @return 0 on success, a negative value on error\n    */\n   @Override\n-  public int readdir(String path, Pointer buff, FuseFillDir filter,\n-      @off_t long offset, FuseFileInfo fi) {\n+  public int readdir(String path, long buff, FuseFillDir filter, @off_t long offset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 244}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwMTY2Mg==", "bodyText": "hard to tell what this class from the name. can you add javadoc for this class (required for all public classes or style checker will fail)", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417101662", "createdAt": "2020-04-29T06:54:12Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/FuseFillDir.java", "diffHunk": "@@ -7,27 +7,28 @@\n  * either express or implied, as more fully set forth in the License.\n  *\n  * See the NOTICE file distributed with this work for information regarding copyright ownership.\n- *\n  */\n \n package alluxio.jnifuse;\n \n+import alluxio.jnifuse.struct.FileStat;\n+\n import java.nio.ByteBuffer;\n \n-public class FuseFiller {\n+public class FuseFillDir {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwMTgwMQ==", "bodyText": "javadoc all public method in Alluxio code base", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417101801", "createdAt": "2020-04-29T06:54:31Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/FuseFillDir.java", "diffHunk": "@@ -7,27 +7,28 @@\n  * either express or implied, as more fully set forth in the License.\n  *\n  * See the NOTICE file distributed with this work for information regarding copyright ownership.\n- *\n  */\n \n package alluxio.jnifuse;\n \n+import alluxio.jnifuse.struct.FileStat;\n+\n import java.nio.ByteBuffer;\n \n-public class FuseFiller {\n+public class FuseFillDir {\n   long address;\n \n-  FuseFiller(long address) {\n+  FuseFillDir(long address) {\n     this.address = address;\n   }\n \n-  public native int doFill(long bufaddr, String name, ByteBuffer stbuf, long off);\n+  public native int fill(long address, long bufaddr, String name, ByteBuffer stbuf, long off);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwMjYzNg==", "bodyText": "this class is claimed as abstract but no method is claimed as abstract.\nI would make all api methods abstract.", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417102636", "createdAt": "2020-04-29T06:56:23Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/FuseStubFS.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse;\n+\n+import alluxio.jnifuse.struct.FileStat;\n+import alluxio.jnifuse.struct.FuseContext;\n+import alluxio.jnifuse.struct.FuseFileInfo;\n+import alluxio.jnifuse.struct.Statvfs;\n+import alluxio.util.OSUtils;\n+\n+import org.apache.commons.lang.NotImplementedException;\n+import ru.serce.jnrfuse.ErrorCodes;\n+import ru.serce.jnrfuse.FuseException;\n+import ru.serce.jnrfuse.utils.MountUtils;\n+import ru.serce.jnrfuse.utils.SecurityUtils;\n+\n+import java.nio.ByteBuffer;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Abstract class for Fuse FS Stub.\n+ */\n+public abstract class FuseStubFS {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwNDc1Mw==", "bodyText": "For your info, Im cool to leave alluxio.jnifuse.struct to use your current c-like style for readability.", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417104753", "createdAt": "2020-04-29T07:01:14Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/struct/FileStat.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import alluxio.util.OSUtils;\n+\n+import java.nio.ByteBuffer;\n+\n+public class FileStat extends Struct {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwNTk5NQ==", "bodyText": "remove two empty lines (line 24, 25)", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417105995", "createdAt": "2020-04-29T07:04:04Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/struct/FuseContext.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import java.nio.ByteBuffer;\n+\n+public class FuseContext extends Struct {\n+\n+  public final Unsigned32 uid = new Unsigned32();\n+  public final Unsigned32 gid = new Unsigned32();\n+\n+  public FuseContext(ByteBuffer buffer) {\n+    super(buffer);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExMzYxNA==", "bodyText": "depending on the fuse version, can you duoble check this is consistent with https://github.com/libfuse/libfuse/blob/fuse_2_9_bugfix/include/fuse_common.h (if we target fuse 2.9)\nplease include the link to the header file in the javadoc\ninclude in javadoc that this works with only Linux or MacOS (if that is the case)", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417113614", "createdAt": "2020-04-29T07:20:49Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/struct/FuseFileInfo.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import java.nio.ByteBuffer;\n+\n+public class FuseFileInfo extends Struct {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExMzg5NQ==", "bodyText": "newline needed", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417113895", "createdAt": "2020-04-29T07:21:22Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseFileSystem.cc", "diffHunk": "@@ -0,0 +1,167 @@\n+#include <fuse.h>\n+#include <stdio.h>\n+#include <string.h>\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <stdlib.h>\n+#include <jni.h>\n+\n+#include \"JniFuseFileSystem.h\"\n+#include \"debug.h\"\n+#include \"fuse.h\"\n+\n+using namespace jnifuse;\n+\n+JniFuseFileSystem::JniFuseFileSystem()\n+{\n+}\n+\n+JniFuseFileSystem::~JniFuseFileSystem()\n+{\n+}\n+\n+void JniFuseFileSystem::init(JNIEnv* env, jobject obj)\n+{\n+    env->GetJavaVM(&this->jvm);\n+    this->fs = env->NewGlobalRef(obj);\n+\n+    this->getattrOper = new GetattrOperation(this);\n+    this->openOper = new OpenOperation(this);\n+    this->readOper = new ReadOperation(this);\n+    this->readdirOper = new ReaddirOperation(this);\n+}\n+\n+JniFuseFileSystem* JniFuseFileSystem::getInstance()\n+{\n+    static JniFuseFileSystem* instance = nullptr;\n+    if (instance == nullptr) {\n+        instance = new JniFuseFileSystem();\n+    }\n+    return instance;\n+}\n+\n+JNIEnv* JniFuseFileSystem::getEnv()\n+{\n+    JNIEnv* env;\n+    this->jvm->AttachCurrentThreadAsDaemon((void **)&env, NULL);\n+    return env;\n+}\n+\n+jobject JniFuseFileSystem::getFSObj()\n+{\n+    return this->fs;\n+}\n+\n+Operation::Operation()\n+{\n+}\n+\n+Operation::~Operation()\n+{\n+}\n+\n+GetattrOperation::GetattrOperation(JniFuseFileSystem* fs) \n+{\n+    this->fs = fs;\n+    JNIEnv* env = this->fs->getEnv();\n+    this->obj = this->fs->getFSObj();\n+    this->clazz = env->GetObjectClass(this->fs->getFSObj());\n+    this->signature = \"(Ljava/lang/String;Ljava/nio/ByteBuffer;)I\";\n+    this->methodID = env->GetMethodID(this->clazz, \"getattrCallback\", signature);\n+}\n+\n+int GetattrOperation::call(const char *path, struct stat* stbuf)\n+{\n+    JNIEnv* env = this->fs->getEnv();\n+    jstring jspath = env->NewStringUTF(path);\n+    jobject buffer = env->NewDirectByteBuffer((void *)stbuf, sizeof(struct stat));\n+\n+    int ret = env->CallIntMethod(this->obj, this->methodID, jspath, buffer);\n+    \n+    env->DeleteLocalRef(jspath);\n+    env->DeleteLocalRef(buffer);\n+\n+    return ret;\n+}\n+\n+OpenOperation::OpenOperation(JniFuseFileSystem* fs)\n+{\n+    this->fs = fs;\n+    JNIEnv* env = this->fs->getEnv();\n+    this->obj = this->fs->getFSObj();\n+    this->clazz = env->GetObjectClass(this->fs->getFSObj());\n+    this->signature = \"(Ljava/lang/String;Ljava/nio/ByteBuffer;)I\";\n+    this->methodID = env->GetMethodID(this->clazz, \"openCallback\", signature);\n+}\n+\n+int OpenOperation::call(const char *path, struct fuse_file_info *fi)\n+{\n+    JNIEnv* env = this->fs->getEnv();\n+    jstring jspath = env->NewStringUTF(path);\n+    jobject fibuf = env->NewDirectByteBuffer((void *)fi, sizeof(struct fuse_file_info));\n+\n+    int ret = env->CallIntMethod(this->obj, this->methodID, jspath, fibuf);\n+\n+    env->DeleteLocalRef(jspath);\n+    env->DeleteLocalRef(fibuf);\n+\n+    return ret;\n+}\n+\n+ReadOperation::ReadOperation(JniFuseFileSystem* fs)\n+{\n+    this->fs = fs;\n+    JNIEnv* env = this->fs->getEnv();\n+    this->obj = this->fs->getFSObj();\n+    this->clazz = env->GetObjectClass(this->fs->getFSObj());\n+    this->signature = \"(Ljava/lang/String;Ljava/nio/ByteBuffer;JJLjava/nio/ByteBuffer;)I\";\n+    this->methodID = env->GetMethodID(this->clazz, \"readCallback\", signature);\n+}\n+\n+int ReadOperation::call(const char *path, char *buf, size_t size, off_t offset, struct fuse_file_info *fi)\n+{\n+    JNIEnv* env = this->fs->getEnv();\n+    jstring jspath = env->NewStringUTF(path);\n+    jobject buffer = env->NewDirectByteBuffer((void *)buf, size);\n+    jobject fibuf = env->NewDirectByteBuffer((void *)fi, sizeof(struct fuse_file_info));\n+    \n+    int ret = env->CallIntMethod(this->obj, this->methodID, jspath, buffer, size, offset, fibuf);\n+\n+    env->DeleteLocalRef(jspath);\n+    env->DeleteLocalRef(buffer);\n+    env->DeleteLocalRef(fibuf);\n+\n+    return ret;\n+}\n+\n+ReaddirOperation::ReaddirOperation(JniFuseFileSystem* fs)\n+{\n+    this->fs = fs;\n+    JNIEnv* env = this->fs->getEnv();\n+    this->obj = this->fs->getFSObj();\n+    this->clazz = env->GetObjectClass(this->fs->getFSObj());\n+    this->signature = \"(Ljava/lang/String;JLalluxio/jnifuse/FuseFillDir;JLjava/nio/ByteBuffer;)I\";\n+    this->methodID = env->GetMethodID(this->clazz, \"readdirCallback\", signature);\n+\n+    this->fillerclazz = env->FindClass(\"alluxio/jnifuse/FuseFillDir\");\n+    this->fillerconstructor = env->GetMethodID(fillerclazz, \"<init>\", \"(J)V\");\n+}\n+\n+int ReaddirOperation::call(const char* path, void* buf, fuse_fill_dir_t filler,\n+        off_t offset, struct fuse_file_info* fi) {\n+    \n+    JNIEnv* env = this->fs->getEnv();\n+\n+    jobject fillerobj = env->NewObject(this->fillerclazz, this->fillerconstructor, (void *)filler);\n+    \n+    jstring jspath = env->NewStringUTF(path);\n+    jobject fibuf = env->NewDirectByteBuffer((void *)fi, sizeof(struct fuse_file_info));\n+\n+    int ret = env->CallIntMethod(this->obj, this->methodID, jspath, buf, fillerobj, offset, fibuf);\n+\n+    env->DeleteLocalRef(fillerobj);\n+    env->DeleteLocalRef(jspath);\n+    env->DeleteLocalRef(fibuf);\n+\n+    return ret;\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNDI4OQ==", "bodyText": "same here, double check the version and include the link to the corresponding header file in javadoc", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417114289", "createdAt": "2020-04-29T07:22:11Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/struct/Statvfs.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import java.nio.ByteBuffer;\n+\n+public class Statvfs extends Struct {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNTIwOA==", "bodyText": "keep each section of include sorted", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417115208", "createdAt": "2020-04-29T07:24:05Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseFileSystem.cc", "diffHunk": "@@ -0,0 +1,167 @@\n+#include <fuse.h>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNTcyMQ==", "bodyText": "newline needed", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417115721", "createdAt": "2020-04-29T07:25:11Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseFileSystem.h", "diffHunk": "@@ -0,0 +1,77 @@\n+#ifndef _JNI_FUSE_FILE_SYSTEM_H\n+#define _JNI_FUSE_FILE_SYSTEM_H\n+\n+#include \"jni.h\"\n+\n+namespace jnifuse {\n+\n+class Operation;\n+class GetattrOperation;\n+class OpenOperation;\n+class ReadOperation;\n+class ReaddirOperation;\n+    \n+class JniFuseFileSystem\n+{\n+private:\n+    JniFuseFileSystem();\n+    ~JniFuseFileSystem();\n+public:\n+    static JniFuseFileSystem* getInstance();\n+    void init(JNIEnv* env, jobject obj);\n+    JNIEnv* getEnv();\n+    jobject getFSObj();\n+private:\n+    JavaVM* jvm;\n+    jobject fs;\n+public:\n+    GetattrOperation *getattrOper;\n+    OpenOperation* openOper;\n+    ReadOperation* readOper;\n+    ReaddirOperation* readdirOper;\n+};\n+\n+class Operation\n+{\n+protected:\n+    JniFuseFileSystem* fs;\n+    jclass clazz;\n+    jobject obj;\n+    jmethodID methodID;\n+    const char *signature;\n+public:\n+    Operation();\n+    ~Operation();\n+};\n+\n+class GetattrOperation: public Operation {\n+public:\n+    GetattrOperation(JniFuseFileSystem* fs);\n+    int call(const char *path, struct stat* stbuf);\n+};\n+\n+class OpenOperation: public Operation {\n+public:\n+    OpenOperation(JniFuseFileSystem* fs);\n+    int call(const char *path, struct fuse_file_info *fi);\n+};\n+\n+class ReadOperation: public Operation {\n+public:\n+    ReadOperation(JniFuseFileSystem* fs);\n+    int call(const char *path, char *buf, size_t size, off_t offset, struct fuse_file_info *fi);\n+};\n+\n+class ReaddirOperation: public Operation {\n+public:\n+    ReaddirOperation(JniFuseFileSystem* fs);\n+    int call(const char* path, void* buf, fuse_fill_dir_t filler,\n+            off_t offset, struct fuse_file_info* fi);\n+private:\n+    jclass fillerclazz;\n+    jmethodID fillerconstructor;\n+};\n+\n+}\n+\n+#endif", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNTkzMw==", "bodyText": "isn't this needed?", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417115933", "createdAt": "2020-04-29T07:25:38Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseHelper.cc", "diffHunk": "@@ -0,0 +1,108 @@\n+#define FUSE_USE_VERSION 26\n+\n+#include <fuse.h>\n+#include <stdio.h>\n+#include <string.h>\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <stdlib.h>\n+#include <jni.h>\n+\n+#include \"debug.h\"\n+#include \"JniFuseFileSystem.h\"\n+\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\n+static int getattr_wrapper(const char *path, struct stat* stbuf)\n+{\n+  LOGD(\"getattr %s\", path);\n+\n+  int ret = jnifuse::JniFuseFileSystem::getInstance()->getattrOper->call(path, stbuf);\n+\n+  LOGD(\"file %s: size=%ld, mod=%d\", path, stbuf->st_size, stbuf->st_mode);\n+\n+  return ret;\n+}\n+\n+static int open_wrapper(const char *path, struct fuse_file_info *fi)\n+{\n+  LOGD(\"open %s\\n\", path);\n+\n+  int ret = jnifuse::JniFuseFileSystem::getInstance()->openOper->call(path, fi);\n+\n+  return ret;\n+}\n+\n+static int read_wrapper(const char *path, char *buf, size_t size, off_t offset,\n+\t\t      struct fuse_file_info *fi)\n+{\n+    LOGD(\"read: %s\\n\", path);\n+\n+    int ret = jnifuse::JniFuseFileSystem::getInstance()->readOper->call(path, buf, size, offset, fi);\n+\n+    LOGD(\"nread=%d\\n\", ret);\n+\n+    return ret;\n+}\n+\n+static int readdir_wrapper(const char* path, void* buf, fuse_fill_dir_t filler,\n+            off_t offset, struct fuse_file_info* fi)\n+{\n+    LOGD(\"readdir: %s\\n\", path);\n+\n+    int ret = jnifuse::JniFuseFileSystem::getInstance()->readdirOper->call(path, buf, filler, offset, fi);\n+\n+    return ret;\n+}\n+\n+// TODO: Add more operations\n+// NOTE: \n+static struct fuse_operations jnifuse_oper = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNjAxNQ==", "bodyText": "newline", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417116015", "createdAt": "2020-04-29T07:25:47Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseHelper.cc", "diffHunk": "@@ -0,0 +1,108 @@\n+#define FUSE_USE_VERSION 26\n+\n+#include <fuse.h>\n+#include <stdio.h>\n+#include <string.h>\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <stdlib.h>\n+#include <jni.h>\n+\n+#include \"debug.h\"\n+#include \"JniFuseFileSystem.h\"\n+\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\n+static int getattr_wrapper(const char *path, struct stat* stbuf)\n+{\n+  LOGD(\"getattr %s\", path);\n+\n+  int ret = jnifuse::JniFuseFileSystem::getInstance()->getattrOper->call(path, stbuf);\n+\n+  LOGD(\"file %s: size=%ld, mod=%d\", path, stbuf->st_size, stbuf->st_mode);\n+\n+  return ret;\n+}\n+\n+static int open_wrapper(const char *path, struct fuse_file_info *fi)\n+{\n+  LOGD(\"open %s\\n\", path);\n+\n+  int ret = jnifuse::JniFuseFileSystem::getInstance()->openOper->call(path, fi);\n+\n+  return ret;\n+}\n+\n+static int read_wrapper(const char *path, char *buf, size_t size, off_t offset,\n+\t\t      struct fuse_file_info *fi)\n+{\n+    LOGD(\"read: %s\\n\", path);\n+\n+    int ret = jnifuse::JniFuseFileSystem::getInstance()->readOper->call(path, buf, size, offset, fi);\n+\n+    LOGD(\"nread=%d\\n\", ret);\n+\n+    return ret;\n+}\n+\n+static int readdir_wrapper(const char* path, void* buf, fuse_fill_dir_t filler,\n+            off_t offset, struct fuse_file_info* fi)\n+{\n+    LOGD(\"readdir: %s\\n\", path);\n+\n+    int ret = jnifuse::JniFuseFileSystem::getInstance()->readdirOper->call(path, buf, filler, offset, fi);\n+\n+    return ret;\n+}\n+\n+// TODO: Add more operations\n+// NOTE: \n+static struct fuse_operations jnifuse_oper = {\n+  // .getattr = getattr_wrapper,\n+  // .open = open_wrapper,\n+  // .read = read_wrapper,\n+  // .readdir = readdir_wrapper\n+};\n+\n+JNIEXPORT jint JNICALL Java_alluxio_jnifuse_LibFuse_fuse_1main_1real\n+  (JNIEnv *env, jobject libfuseobj, jobject obj, jint jargc, jobjectArray jargv)\n+{\n+  LOGD(\"enter fuse_main_real\");\n+\n+  jnifuse::JniFuseFileSystem* fs = jnifuse::JniFuseFileSystem::getInstance();\n+  fs->init(env, obj);\n+\n+  int argc = jargc;\n+  LOGD(\"argc=%d\", argc);\n+\n+  char **argv = (char **)malloc(sizeof(char*) * argc);\n+  int i;\n+  for (i=0; i < argc; i++) {\n+    jstring str = (jstring)env->GetObjectArrayElement(jargv, i);\n+    argv[i] = (char*)env->GetStringUTFChars(str, 0);\n+    LOGD(\"argv[%d]=%s\", i, argv[i]);\n+  }\n+\n+  jnifuse_oper.getattr = getattr_wrapper;\n+  jnifuse_oper.open = open_wrapper;\n+  jnifuse_oper.read = read_wrapper;\n+  jnifuse_oper.readdir = readdir_wrapper;\n+\n+  return fuse_main_real(argc, argv, &jnifuse_oper, sizeof(struct fuse_operations), NULL);\n+}\n+\n+jint JNICALL Java_alluxio_jnifuse_FuseFillDir_fill\n+    (JNIEnv *env, jobject obj, jlong address, jlong bufaddr, jstring name, jobject stbuf, jlong off)\n+{\n+  LOGD(\"enter fill\"); \n+  fuse_fill_dir_t filler = (fuse_fill_dir_t) (void *)address;\n+  const char* fn = env->GetStringUTFChars(name, 0);\n+\n+  return filler((void* )bufaddr, fn, NULL, 0);\n+}\n+\n+#ifdef __cplusplus\n+}\n+#endif", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNjkwMw==", "bodyText": "since you are writing in C++ now, this should be CXX not CC", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417116903", "createdAt": "2020-04-29T07:27:35Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/Makefile", "diffHunk": "@@ -1,6 +1,6 @@\n-CC := gcc\n+CC := g++", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNzExMg==", "bodyText": "CXXFLAGS", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417117112", "createdAt": "2020-04-29T07:28:06Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/Makefile", "diffHunk": "@@ -15,18 +15,18 @@ ifeq ($(UNAME), Darwin)\n \tTARGET_LIB := libjnifuse.dylib\n endif\n \n-CFLAGS = -Wall -fPIC ${INCDIR} ${FUSE_CFLAGS}\n+CFLAGS = -Wall -fPIC -D_FILE_OFFSET_BITS=64 ${INCDIR} ${FUSE_CFLAGS}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExODI3Mw==", "bodyText": "NITPICK: unnecessary empty lines (line 23 27 33 35). let's keep the src code concise and compact in general", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417118273", "createdAt": "2020-04-29T07:30:18Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/test/java/alluxio/jnifuse/struct/FuseFileInfoTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import jnr.ffi.Pointer;\n+import jnr.ffi.Runtime;\n+import org.junit.Test;\n+\n+import java.nio.ByteBuffer;\n+\n+public class FuseFileInfoTest {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExOTAxOA==", "bodyText": "actually a good idea to compare JNI and JNR implementations.\nSo maybe we should not aim to totally remove dependency on JNRFuse but leave it in test scope", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417119018", "createdAt": "2020-04-29T07:31:52Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/test/java/alluxio/jnifuse/struct/StatvfsTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import jnr.ffi.Pointer;\n+import jnr.ffi.Runtime;\n+import org.junit.Test;\n+\n+import java.nio.ByteBuffer;\n+\n+public class StatvfsTest {\n+  @Test\n+  public void offset() {\n+    Statvfs jni = new Statvfs(ByteBuffer.allocate(256));\n+\n+    ru.serce.jnrfuse.struct.Statvfs jnr =\n+        ru.serce.jnrfuse.struct.Statvfs.of(Pointer.wrap(Runtime.getSystemRuntime(), 0x0));\n+\n+    assertEquals(jnr.f_bsize.offset(), jni.f_bsize.offset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExOTI3NQ==", "bodyText": "sort", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417119275", "createdAt": "2020-04-29T07:32:23Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/native/libjnifuse/JniFuseFileSystem.h", "diffHunk": "@@ -0,0 +1,77 @@\n+#ifndef _JNI_FUSE_FILE_SYSTEM_H\n+#define _JNI_FUSE_FILE_SYSTEM_H\n+\n+#include \"jni.h\"\n+\n+namespace jnifuse {\n+\n+class Operation;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyMDExMA==", "bodyText": "this seems not fully implemented for timespec? Now alluxio.fuse.AlluxioFuseFileSystemTest will not compile due to this issue.", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417120110", "createdAt": "2020-04-29T07:34:06Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/jnifuse/struct/FileStat.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.jnifuse.struct;\n+\n+import alluxio.util.OSUtils;\n+\n+import java.nio.ByteBuffer;\n+\n+public class FileStat extends Struct {\n+  public static final int S_IFIFO = 0010000; // named pipe (fifo)\n+  public static final int S_IFCHR = 0020000; // character special\n+  public static final int S_IFDIR = 0040000; // directory\n+  public static final int S_IFBLK = 0060000; // block special\n+  public static final int S_IFREG = 0100000; // regular\n+  public static final int S_IFLNK = 0120000; // symbolic link\n+  public static final int S_IFSOCK = 0140000; // socket\n+  public static final int S_IFMT = 0170000; // file mask for type checks\n+  public static final int S_ISUID = 0004000; // set user id on execution\n+  public static final int S_ISGID = 0002000; // set group id on execution\n+  public static final int S_ISVTX = 0001000; // save swapped text even after use\n+  public static final int S_IRUSR = 0000400; // read permission, owner\n+  public static final int S_IWUSR = 0000200; // write permission, owner\n+  public static final int S_IXUSR = 0000100; // execute/search permission, owner\n+  public static final int S_IRGRP = 0000040; // read permission, group\n+  public static final int S_IWGRP = 0000020; // write permission, group\n+  public static final int S_IXGRP = 0000010; // execute/search permission, group\n+  public static final int S_IROTH = 0000004; // read permission, other\n+  public static final int S_IWOTH = 0000002; // write permission, other\n+  public static final int S_IXOTH = 0000001; // execute permission, other\n+\n+  public static final int ALL_READ = S_IRUSR | S_IRGRP | S_IROTH;\n+  public static final int ALL_WRITE = S_IWUSR | S_IWGRP | S_IWOTH;\n+  public static final int S_IXUGO = S_IXUSR | S_IXGRP | S_IXOTH;\n+\n+  public static boolean S_ISTYPE(int mode, int mask) {\n+    return (mode & S_IFMT) == mask;\n+  }\n+\n+  public static boolean S_ISDIR(int mode) {\n+    return S_ISTYPE(mode, S_IFDIR);\n+  }\n+\n+  public static boolean S_ISCHR(int mode) {\n+    return S_ISTYPE(mode, S_IFCHR);\n+  }\n+\n+  public static boolean S_ISBLK(int mode) {\n+    return S_ISTYPE(mode, S_IFBLK);\n+  }\n+\n+  public static boolean S_ISREG(int mode) {\n+    return S_ISTYPE(mode, S_IFREG);\n+  }\n+\n+  public static boolean S_ISFIFO(int mode) {\n+    return S_ISTYPE(mode, S_IFIFO);\n+  }\n+\n+  public static boolean S_ISLNK(int mode) {\n+    return S_ISTYPE(mode, S_IFLNK);\n+  }\n+\n+  public FileStat(ByteBuffer buffer) {\n+    super(buffer);\n+    // TODO: support Mac & Windows platform\n+    if (OSUtils.isMacOS()) {\n+      System.exit(-1);\n+    } else if (OSUtils.isWindows()) {\n+      System.exit(-1);\n+    } else {\n+      // Linux platform\n+    }\n+    st_dev = new Unsigned64();\n+    pad1 = null;\n+    st_ino = new Unsigned64();\n+    st_nlink = new Unsigned64();\n+    st_mode = new Unsigned32();\n+    st_uid = new Unsigned32();\n+    st_gid = new Unsigned32();\n+    st_rdev = new Unsigned64();\n+    st_size = new SignedLong();\n+    st_blksize = new SignedLong();\n+    st_blocks = new SignedLong();\n+    st_atim = new SignedLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDI3Njk5", "url": "https://github.com/Alluxio/alluxio/pull/11364#pullrequestreview-402427699", "createdAt": "2020-04-29T07:39:42Z", "commit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzozOTo0MlrOGNzJ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzozOTo0MlrOGNzJ5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyMjc5MA==", "bodyText": "NOTE, this is some cleanup work I planned to do a long time ago. unrelated to @iluoeli 's change to switch to JNI", "url": "https://github.com/Alluxio/alluxio/pull/11364#discussion_r417122790", "createdAt": "2020-04-29T07:39:42Z", "author": {"login": "apc999"}, "path": "integration/fuse/src/main/java/alluxio/fuse/AlluxioFuse.java", "diffHunk": "@@ -41,15 +43,47 @@\n public final class AlluxioFuse {\n   private static final Logger LOG = LoggerFactory.getLogger(AlluxioFuse.class);\n \n+  private static final Option MOUNT_POINT_OPTION = Option.builder(\"m\")\n+      .hasArg()\n+      .required(true)\n+      .longOpt(\"mount-point\")\n+      .desc(\"Desired local mount point for alluxio-fuse.\")\n+      .build();\n+\n+  private static final Option ALLUXIO_ROOT_OPTION = Option.builder(\"r\")\n+      .hasArg()\n+      .required(true)\n+      .longOpt(\"alluxio-root\")\n+      .desc(\"Path within alluxio that will be used as the root of the FUSE mount \"\n+          + \"(e.g., /users/foo; defaults to /)\")\n+      .build();\n+\n+  private static final Option HELP_OPTION = Option.builder(\"h\")\n+      .required(false)\n+      .desc(\"Print this HELP_OPTION\")\n+      .build();\n+\n+  private static final Option FUSE_MOUNT_OPTION = Option.builder(\"o\")\n+      .valueSeparator(',')\n+      .required(false)\n+      .hasArgs()\n+      .desc(\"FUSE mount options\")\n+      .build();\n+\n+  private static final Options OPTIONS = new Options()\n+      .addOption(MOUNT_POINT_OPTION)\n+      .addOption(ALLUXIO_ROOT_OPTION)\n+      .addOption(HELP_OPTION)\n+      .addOption(FUSE_MOUNT_OPTION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b4b7230a397e9f54ea43b481ef7ec6a0cb95d4"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2129ab7d099a5ee207ee86079f3174444ff19b2c", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/2129ab7d099a5ee207ee86079f3174444ff19b2c", "committedDate": "2020-04-29T10:28:45Z", "message": "Fix AlluxioFuseFileSystemTest\n\nnot actually fixed Timespec error. I just umcommented it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f39cc3a0c69821bde9bf941f80f80a9255c05f1d", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/f39cc3a0c69821bde9bf941f80f80a9255c05f1d", "committedDate": "2020-04-29T14:35:23Z", "message": "Fix Timespec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "956a8fc4c1d9025169db0e93be8d3bed915cc59d", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/956a8fc4c1d9025169db0e93be8d3bed915cc59d", "committedDate": "2020-04-29T16:00:04Z", "message": "Format c++ code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "720855e9e227b747e6035463735ab877d4f5c47a", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/720855e9e227b747e6035463735ab877d4f5c47a", "committedDate": "2020-04-29T16:08:55Z", "message": "Replace jnr utils with jni utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4aed659c5ea46928e4fd3b6a10f4e00d84aea4d", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/c4aed659c5ea46928e4fd3b6a10f4e00d84aea4d", "committedDate": "2020-04-30T08:04:14Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1b92e10b26218547a7a9c18bea8d167c0637478", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/f1b92e10b26218547a7a9c18bea8d167c0637478", "committedDate": "2020-04-30T09:08:46Z", "message": "Add jni ErrorCodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f26a9c6747a94c437fae7183429d146f0238e7e7", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/f26a9c6747a94c437fae7183429d146f0238e7e7", "committedDate": "2020-05-01T03:53:25Z", "message": "Fix check style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b297606c3b5a6cb7ed806b691f12129286d0031", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/Alluxio/alluxio/commit/6b297606c3b5a6cb7ed806b691f12129286d0031", "committedDate": "2020-05-01T06:55:00Z", "message": "Various cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba5bf9c09b604fa0364c381c6209d7396d5b2397", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/ba5bf9c09b604fa0364c381c6209d7396d5b2397", "committedDate": "2020-05-01T07:38:23Z", "message": "Add Operations: unlink, flush, release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae76dd8335ec39c7fc63b0c0532d7f6dc6891d17", "author": {"user": {"login": "iluoeli", "name": "Luo Yili"}}, "url": "https://github.com/Alluxio/alluxio/commit/ae76dd8335ec39c7fc63b0c0532d7f6dc6891d17", "committedDate": "2020-05-01T07:46:04Z", "message": "Remove duplicate getContext()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjUxNTI5", "url": "https://github.com/Alluxio/alluxio/pull/11364#pullrequestreview-404251529", "createdAt": "2020-05-01T16:19:05Z", "commit": {"oid": "ae76dd8335ec39c7fc63b0c0532d7f6dc6891d17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4573, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}