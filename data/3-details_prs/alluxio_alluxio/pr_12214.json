{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODQ2NTg2", "number": 12214, "title": "Fix backup coordination and error handling", "bodyText": "This change fixed a few issues related to backup:\n\n\nMake backup interrupt correctly when raft journal needs to reload from a snapshot. Currently if backup occurs right before a journal reload it can buffer up some entries and then corrupt journal by resuming after the reload is completed. This change added an interrupt callback to make sure backup is correctly canceled and journal is resumed before a reload happens.\n\n\nBlock backup when journal is being reloaded. When a raft journal is being reloaded, the backup should not happen because it will capture inconsistent state while the master metadata is re-applied from snapshot.\n\n\nCancel backup sub-tasks properly. Currently when a backup is cancelled due to error or interruption, the sub-tasks do not explicitly respond to interrupt signals, leaving them running in background while opening backup service for more requests. This causes increased memory consumption when multiple backup tasks are running concurrently.\n\n\nIncomplete backups. There is currently no way to tell if a backup file is incomplete before restoring it to the cluster. This change added a marker file after the backup is done to indicate the completeness.", "createdAt": "2020-10-09T22:22:50Z", "url": "https://github.com/Alluxio/alluxio/pull/12214", "merged": true, "mergeCommit": {"oid": "a0a56f25e75b442ae95b44c22b94bd2138e6beb2"}, "closed": true, "closedAt": "2020-10-10T01:22:24Z", "author": {"login": "bf8086"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ8aPDgH2gAyNTAwODQ2NTg2OjYzNDU1NWNiNmUyOGZiYmYxYzM4ODBjMDhmMjAzOTQ3M2Q0MTExYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRAUergFqTUwNjA1MTAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "634555cb6e28fbbf1c3880c08f2039473d4111a5", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/634555cb6e28fbbf1c3880c08f2039473d4111a5", "committedDate": "2020-10-09T20:42:59Z", "message": "Fix backup coordination and error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebcfdf696026bf42f876991c20e3a447a4096e2e", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/ebcfdf696026bf42f876991c20e3a447a4096e2e", "committedDate": "2020-10-09T22:00:35Z", "message": "Interrupt correctly on pause"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df44b3f47859e4d21f21b3dbf483f32f6bab1662", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/df44b3f47859e4d21f21b3dbf483f32f6bab1662", "committedDate": "2020-10-09T11:14:17Z", "message": "(wip) fix backup"}, "afterCommit": {"oid": "ebcfdf696026bf42f876991c20e3a447a4096e2e", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/ebcfdf696026bf42f876991c20e3a447a4096e2e", "committedDate": "2020-10-09T22:00:35Z", "message": "Interrupt correctly on pause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "856382f1f8d90788f0a9f2ceaeacede80bd05f36", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/856382f1f8d90788f0a9f2ceaeacede80bd05f36", "committedDate": "2020-10-09T22:25:55Z", "message": "Fix checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d0f27ea7a3cda4f58979a4fea0e1a4654aeecb", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/c2d0f27ea7a3cda4f58979a4fea0e1a4654aeecb", "committedDate": "2020-10-09T22:27:55Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDI0NTk0", "url": "https://github.com/Alluxio/alluxio/pull/12214#pullrequestreview-506024594", "createdAt": "2020-10-09T22:41:03Z", "commit": {"oid": "c2d0f27ea7a3cda4f58979a4fea0e1a4654aeecb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjo0MTowM1rOHfaU7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjo0NjoxNVrOHfafow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5OTI0Nw==", "bodyText": "I am confused as to what this is supposed to be. It is called \"interrupt callback\", but it is set in suspend and used in pause. I don't understand the flow of interaction. Could you explain what this is?", "url": "https://github.com/Alluxio/alluxio/pull/12214#discussion_r502699247", "createdAt": "2020-10-09T22:41:03Z", "author": {"login": "gpang"}, "path": "core/server/common/src/main/java/alluxio/master/journal/raft/JournalStateMachine.java", "diffHunk": "@@ -98,6 +99,7 @@\n   private volatile long mNextSequenceNumberToRead = 0;\n   private volatile boolean mSnapshotting = false;\n   private volatile boolean mIsLeader = false;\n+  private volatile Runnable mInterruptCallback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2d0f27ea7a3cda4f58979a4fea0e1a4654aeecb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwMTk4Nw==", "bodyText": "Does anything look for this file?", "url": "https://github.com/Alluxio/alluxio/pull/12214#discussion_r502701987", "createdAt": "2020-10-09T22:46:15Z", "author": {"login": "gpang"}, "path": "core/server/master/src/main/java/alluxio/master/backup/AbstractBackupRole.java", "diffHunk": "@@ -186,6 +186,8 @@ protected AlluxioURI takeBackup(BackupPRequest request, AtomicLong entryCounter)\n           // Create the backup from master state.\n           mBackupManager.backup(ufsStream, entryCounter);\n         }\n+        // Add a marker file indicating the file is completed.\n+        ufs.create(backupFilePath + \".complete\").close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2d0f27ea7a3cda4f58979a4fea0e1a4654aeecb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a04e5b09e3d43f4f21fcb3eba539251bb054976", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/8a04e5b09e3d43f4f21fcb3eba539251bb054976", "committedDate": "2020-10-09T23:19:51Z", "message": "Add more synchronization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056078a5bc7afbb8586e4727f68a42cb7923e678", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/056078a5bc7afbb8586e4727f68a42cb7923e678", "committedDate": "2020-10-10T00:30:56Z", "message": "Update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b52a8b7c9964a74cf3ad38ca479027dadadb6078", "author": {"user": {"login": "bf8086", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/b52a8b7c9964a74cf3ad38ca479027dadadb6078", "committedDate": "2020-10-10T00:54:41Z", "message": "Add detailed comments for the interrupt process."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDUxMDM2", "url": "https://github.com/Alluxio/alluxio/pull/12214#pullrequestreview-506051036", "createdAt": "2020-10-10T01:16:19Z", "commit": {"oid": "b52a8b7c9964a74cf3ad38ca479027dadadb6078"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3521, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}