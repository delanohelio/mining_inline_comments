{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDU3MzQ4", "number": 11568, "title": "Improve SecureHdfsValidationTask", "bodyText": "This improves SecureHdfsValidationTest by:\n\nImprove the principal pattern to accept realm to have dots like @ALLUXIO.COM.NET\nCheck the core-site.xml to see if the HDFS is secured\nAdd a doc link in the advice for the user", "createdAt": "2020-06-16T08:29:01Z", "url": "https://github.com/Alluxio/alluxio/pull/11568", "merged": true, "mergeCommit": {"oid": "9f29a9f435f434c16a481ffe1a4bdaef1cd294a8"}, "closed": true, "closedAt": "2020-06-19T15:31:36Z", "author": {"login": "jiacheliu3"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrxALTAFqTQzMTI3NzA1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsz7o5gBqjM0NjI3MDExMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc3MDUy", "url": "https://github.com/Alluxio/alluxio/pull/11568#pullrequestreview-431277052", "createdAt": "2020-06-16T08:30:22Z", "commit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDoyMlrOGkQ2YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDoyMlrOGkQ2YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3Nzk4NA==", "bodyText": "Changed to a more lenient format following https://github.com/cloudera/hadoop-common/blob/ca2ff489eb805da4700fb15fa49e539f1c195b89/src/java/org/apache/hadoop/security/KerberosName.java#L53 and the implementation of zookeeper org.apache.zookeeper.server.auth.KerberosName.\nThe previous pattern does not allow dot in the realm like @ALLUXIO.COM", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r440677984", "createdAt": "2020-06-16T08:30:22Z", "author": {"login": "jiacheliu3"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -39,7 +38,7 @@\n    * for more details.\n    */\n   private static final Pattern PRINCIPAL_PATTERN =\n-      Pattern.compile(\"(?<primary>[\\\\w][\\\\w-]*\\\\$?)(/(?<instance>[\\\\w]+))?(@(?<realm>[\\\\w]+))?\");\n+      Pattern.compile(\"(?<primary>[^/@]*)(/(?<instance>[^/@]*))?@(?<realm>[^/@]*)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDA0ODE1", "url": "https://github.com/Alluxio/alluxio/pull/11568#pullrequestreview-432004815", "createdAt": "2020-06-17T01:52:40Z", "commit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMTo1Mjo0MFrOGky4fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjowNDo0NFrOGkzEjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNTU4MQ==", "bodyText": "Can we use org.apache.hadoop.fs.CommonConfigurationKeysPublic#HADOOP_SECURITY_AUTHORIZATION instead?", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r441235581", "createdAt": "2020-06-17T01:52:40Z", "author": {"login": "bf8086"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -51,6 +50,13 @@\n       PRINCIPAL_MAP_MASTER_KEY, PropertyKey.MASTER_KEYTAB_KEY_FILE,\n       PRINCIPAL_MAP_WORKER_KEY, PropertyKey.WORKER_KEYTAB_FILE);\n \n+  private static final String HDFS_AUTHORIZATION_KEY = \"hadoop.security.authorization\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNTc2MA==", "bodyText": "Same here.", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r441235760", "createdAt": "2020-06-17T01:53:20Z", "author": {"login": "bf8086"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -51,6 +50,13 @@\n       PRINCIPAL_MAP_MASTER_KEY, PropertyKey.MASTER_KEYTAB_KEY_FILE,\n       PRINCIPAL_MAP_WORKER_KEY, PropertyKey.WORKER_KEYTAB_FILE);\n \n+  private static final String HDFS_AUTHORIZATION_KEY = \"hadoop.security.authorization\";\n+  private static final String HDFS_AUTHORIZATION_VALUE = \"true\";\n+  private static final String HDFS_AUTHENTICATION_KEY = \"hadoop.security.authentication\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNjYxOA==", "bodyText": "StringUtils.capitalize(mProcess)?", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r441236618", "createdAt": "2020-06-17T01:56:52Z", "author": {"login": "bf8086"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -79,36 +86,72 @@ public SecureHdfsValidationTask(String process, String path, AlluxioConfiguratio\n \n   @Override\n   public String getName() {\n-    return String.format(\"ValidateKerberosForSecureHdfs%s\", mProcess.toUpperCase());\n+    // Convert the first char to upper case\n+    char first = Character.toUpperCase(mProcess.charAt(0));\n+    return String.format(\"ValidateKerberosForSecureHdfs%s\", first + mProcess.substring(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzODI5Nw==", "bodyText": "These properties are not bound to be enabled at the same time, you can have authentication set to \"simple\" but have the authorization on.", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r441238297", "createdAt": "2020-06-17T02:03:16Z", "author": {"login": "bf8086"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -79,36 +86,72 @@ public SecureHdfsValidationTask(String process, String path, AlluxioConfiguratio\n \n   @Override\n   public String getName() {\n-    return String.format(\"ValidateKerberosForSecureHdfs%s\", mProcess.toUpperCase());\n+    // Convert the first char to upper case\n+    char first = Character.toUpperCase(mProcess.charAt(0));\n+    return String.format(\"ValidateKerberosForSecureHdfs%s\", first + mProcess.substring(1));\n   }\n \n   @Override\n   public ValidationUtils.TaskResult validate(Map<String, String> optionsMap) {\n-    if (shouldSkip()) {\n+    if (!HdfsConfValidationTask.isHdfsScheme(mPath)) {\n+      mMsg.append(\"Skip this check as the UFS is not HDFS.\\n\");\n       return new ValidationUtils.TaskResult(ValidationUtils.State.SKIPPED, getName(),\n               mMsg.toString(), mAdvice.toString());\n     }\n+\n+    ValidationUtils.TaskResult loadConfig = loadHdfsConfig();\n+    if (loadConfig.getState() != ValidationUtils.State.OK) {\n+      return loadConfig;\n+    }\n+\n+    // The state is OK when the HDFS is secured\n+    ValidationUtils.TaskResult hdfsSecured = validateSecureHdfs();\n+    if (hdfsSecured.getState() != ValidationUtils.State.OK) {\n+      return hdfsSecured;\n+    }\n+\n     return validatePrincipalLogin();\n   }\n \n-  protected boolean shouldSkip() {\n-    if (!HdfsConfValidationTask.isHdfsScheme(mPath)) {\n-      mMsg.append(\"Skip this check as the UFS is not HDFS.\\n\");\n-      return true;\n-    }\n-    String principal = null;\n-    if (mConf.isSet(mPrincipalProperty)) {\n-      principal = mConf.get(mPrincipalProperty);\n+  private ValidationUtils.TaskResult validateSecureHdfs() {\n+    // Skipped if HDFS is not Kerberized\n+    // Ref: https://docs.cloudera.com/documentation/enterprise/5-16-x/topics\n+    // /cdh_sg_hadoop_security_enable.html\n+    String hadoopAuthentication = mCoreConf.getOrDefault(HDFS_AUTHENTICATION_KEY, \"\");\n+    boolean authenticationEnabled =\n+            hadoopAuthentication.equalsIgnoreCase(HDFS_AUTHENTICATION_VALUE);\n+    String hadoopAuthorization = mCoreConf.getOrDefault(HDFS_AUTHORIZATION_KEY, \"\");\n+    boolean authorizationEnabled = hadoopAuthorization.equals(HDFS_AUTHORIZATION_VALUE);\n+    if (!authenticationEnabled && !authorizationEnabled) {\n+      mMsg.append(\"HDFS is not Kerberized. Skip this test.\");\n+      return new ValidationUtils.TaskResult(ValidationUtils.State.SKIPPED, getName(),\n+              mMsg.toString(), mAdvice.toString());\n     }\n-    if (principal == null || principal.isEmpty()) {\n-      mMsg.append(String.format(\"Skip validation for secure HDFS. %s is not specified.%n\",\n-          PRINCIPAL_MAP.get(mProcess).getName()));\n-      return true;\n+\n+    // Issue an error if the secured HDFS is not configured properly\n+    if (!authenticationEnabled || !authorizationEnabled) {\n+      mMsg.append(String.format(\"Found inconsistent configuration for Hadoop security.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzODY2OA==", "bodyText": "Would be nice to be more specific on which property is missing.", "url": "https://github.com/Alluxio/alluxio/pull/11568#discussion_r441238668", "createdAt": "2020-06-17T02:04:44Z", "author": {"login": "bf8086"}, "path": "shell/src/main/java/alluxio/cli/validation/hdfs/SecureHdfsValidationTask.java", "diffHunk": "@@ -79,36 +86,72 @@ public SecureHdfsValidationTask(String process, String path, AlluxioConfiguratio\n \n   @Override\n   public String getName() {\n-    return String.format(\"ValidateKerberosForSecureHdfs%s\", mProcess.toUpperCase());\n+    // Convert the first char to upper case\n+    char first = Character.toUpperCase(mProcess.charAt(0));\n+    return String.format(\"ValidateKerberosForSecureHdfs%s\", first + mProcess.substring(1));\n   }\n \n   @Override\n   public ValidationUtils.TaskResult validate(Map<String, String> optionsMap) {\n-    if (shouldSkip()) {\n+    if (!HdfsConfValidationTask.isHdfsScheme(mPath)) {\n+      mMsg.append(\"Skip this check as the UFS is not HDFS.\\n\");\n       return new ValidationUtils.TaskResult(ValidationUtils.State.SKIPPED, getName(),\n               mMsg.toString(), mAdvice.toString());\n     }\n+\n+    ValidationUtils.TaskResult loadConfig = loadHdfsConfig();\n+    if (loadConfig.getState() != ValidationUtils.State.OK) {\n+      return loadConfig;\n+    }\n+\n+    // The state is OK when the HDFS is secured\n+    ValidationUtils.TaskResult hdfsSecured = validateSecureHdfs();\n+    if (hdfsSecured.getState() != ValidationUtils.State.OK) {\n+      return hdfsSecured;\n+    }\n+\n     return validatePrincipalLogin();\n   }\n \n-  protected boolean shouldSkip() {\n-    if (!HdfsConfValidationTask.isHdfsScheme(mPath)) {\n-      mMsg.append(\"Skip this check as the UFS is not HDFS.\\n\");\n-      return true;\n-    }\n-    String principal = null;\n-    if (mConf.isSet(mPrincipalProperty)) {\n-      principal = mConf.get(mPrincipalProperty);\n+  private ValidationUtils.TaskResult validateSecureHdfs() {\n+    // Skipped if HDFS is not Kerberized\n+    // Ref: https://docs.cloudera.com/documentation/enterprise/5-16-x/topics\n+    // /cdh_sg_hadoop_security_enable.html\n+    String hadoopAuthentication = mCoreConf.getOrDefault(HDFS_AUTHENTICATION_KEY, \"\");\n+    boolean authenticationEnabled =\n+            hadoopAuthentication.equalsIgnoreCase(HDFS_AUTHENTICATION_VALUE);\n+    String hadoopAuthorization = mCoreConf.getOrDefault(HDFS_AUTHORIZATION_KEY, \"\");\n+    boolean authorizationEnabled = hadoopAuthorization.equals(HDFS_AUTHORIZATION_VALUE);\n+    if (!authenticationEnabled && !authorizationEnabled) {\n+      mMsg.append(\"HDFS is not Kerberized. Skip this test.\");\n+      return new ValidationUtils.TaskResult(ValidationUtils.State.SKIPPED, getName(),\n+              mMsg.toString(), mAdvice.toString());\n     }\n-    if (principal == null || principal.isEmpty()) {\n-      mMsg.append(String.format(\"Skip validation for secure HDFS. %s is not specified.%n\",\n-          PRINCIPAL_MAP.get(mProcess).getName()));\n-      return true;\n+\n+    // Issue an error if the secured HDFS is not configured properly\n+    if (!authenticationEnabled || !authorizationEnabled) {\n+      mMsg.append(String.format(\"Found inconsistent configuration for Hadoop security.\"\n+                      + \" %s=%s but %s=%s.%n\", HDFS_AUTHENTICATION_KEY, hadoopAuthentication,\n+              HDFS_AUTHORIZATION_KEY, hadoopAuthorization));\n+      mAdvice.append(String.format(\"Please enable Hadoop security by setting %s=%s and %s=%s%n.\",\n+              HDFS_AUTHENTICATION_KEY, HDFS_AUTHENTICATION_VALUE, HDFS_AUTHORIZATION_KEY,\n+              HDFS_AUTHORIZATION_VALUE));\n+      return new ValidationUtils.TaskResult(ValidationUtils.State.FAILED, getName(),\n+              mMsg.toString(), mAdvice.toString());\n     }\n-    return false;\n+    return new ValidationUtils.TaskResult(ValidationUtils.State.OK, getName(),\n+            mMsg.toString(), mAdvice.toString());\n   }\n \n   private ValidationUtils.TaskResult validatePrincipalLogin() {\n+    if (!mConf.isSet(mPrincipalProperty) || !mConf.isSet(mKeytabProperty)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce6dbc2f0e5407883f2d78ad74dc15607f13c96"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTkzOTk0", "url": "https://github.com/Alluxio/alluxio/pull/11568#pullrequestreview-432593994", "createdAt": "2020-06-17T16:55:18Z", "commit": {"oid": "3d62c539adde71d4d3d06406cbb6772051fd183a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cca9be40e5372d567690ee1b26b05ffbb361079", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/1cca9be40e5372d567690ee1b26b05ffbb361079", "committedDate": "2020-06-19T14:27:08Z", "message": "improve SecureHdfsCheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e54b09bc841db3245b8d5984793d969bcaeb2dde", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e54b09bc841db3245b8d5984793d969bcaeb2dde", "committedDate": "2020-06-19T14:28:20Z", "message": "update pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a412ce3bf75f993bc96fb590a05f62fe761f748", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/0a412ce3bf75f993bc96fb590a05f62fe761f748", "committedDate": "2020-06-19T14:28:20Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e491d5fcdddcad1c255a968557be8e96185ad013", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e491d5fcdddcad1c255a968557be8e96185ad013", "committedDate": "2020-06-19T14:28:21Z", "message": "add todo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d62c539adde71d4d3d06406cbb6772051fd183a", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/3d62c539adde71d4d3d06406cbb6772051fd183a", "committedDate": "2020-06-17T04:57:28Z", "message": "add todo"}, "afterCommit": {"oid": "e491d5fcdddcad1c255a968557be8e96185ad013", "author": {"user": {"login": "jiacheliu3", "name": "Jiacheng Liu"}}, "url": "https://github.com/Alluxio/alluxio/commit/e491d5fcdddcad1c255a968557be8e96185ad013", "committedDate": "2020-06-19T14:28:21Z", "message": "add todo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4520, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}