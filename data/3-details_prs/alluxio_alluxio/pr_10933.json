{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2Nzk4MzQ3", "number": 10933, "title": "Fix metrics throughput to be per minute value", "bodyText": "Change the throughput calculation to be per minute value instead of per second and use clock for easy testing", "createdAt": "2020-02-18T19:37:32Z", "url": "https://github.com/Alluxio/alluxio/pull/10933", "merged": true, "mergeCommit": {"oid": "2fa8a6e98431b801068ec25558dc93bec6956d67"}, "closed": true, "closedAt": "2020-02-21T02:53:53Z", "author": {"login": "LuQQiu"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFnNt3gH2gAyMzc2Nzk4MzQ3OmE0ZWY2ZjNmMDBiNmQ3YWE1MjIzMTdlN2RhYWI1M2YxYzZlMjEzYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGWfYcgFqTM2MjM2ODc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9", "committedDate": "2020-02-18T19:36:59Z", "message": "small fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjQ2Mjkw", "url": "https://github.com/Alluxio/alluxio/pull/10933#pullrequestreview-360646290", "createdAt": "2020-02-18T20:22:55Z", "commit": {"oid": "a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMDoyMjo1NVrOFrRKbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMDoyMjo1NVrOFrRKbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNDI4Ng==", "bodyText": "nit: is there a reason to make this all caps?", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r380914286", "createdAt": "2020-02-18T20:22:55Z", "author": {"login": "ZacBlanco"}, "path": "shell/src/main/java/alluxio/cli/fsadmin/report/MetricsCommand.java", "diffHunk": "@@ -74,8 +74,7 @@ public int run() throws IOException {\n           // Bytes long can be transformed to human-readable format\n           strValue = FormatUtils.getSizeFromBytes((long) doubleValue);\n           if (name.contains(THROUGHPUT_METRIC_IDENTIFIER)) {\n-            // throughput is calculated as one-minute exponentially-weighted moving average rate\n-            strValue = strValue + \"/min\";\n+            strValue = strValue + \"/SEC\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4ef6f3f00b6d7aa522317e7daab53f1c6e213b9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e458cf1ab00e0ff2a3b694979341d7d19f1286c", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5e458cf1ab00e0ff2a3b694979341d7d19f1286c", "committedDate": "2020-02-18T21:33:28Z", "message": "Update snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c4f85ece178e2b5c64aadeff83628b7f83ec48e", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/5c4f85ece178e2b5c64aadeff83628b7f83ec48e", "committedDate": "2020-02-18T21:56:35Z", "message": "Fix Metrics Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e2554bf0f1ef4891d25b1a0a3e109b259355ac4", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/2e2554bf0f1ef4891d25b1a0a3e109b259355ac4", "committedDate": "2020-02-18T22:36:38Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5b0aeb3c03e37f30a02b7aaff231d519ac0ad55", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/d5b0aeb3c03e37f30a02b7aaff231d519ac0ad55", "committedDate": "2020-02-19T00:44:51Z", "message": "Change throughput to MB/MIN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818b01d9d65189040203c90c057587e6a3321b12", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/818b01d9d65189040203c90c057587e6a3321b12", "committedDate": "2020-02-19T03:21:06Z", "message": "tmp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1982853bcdf0231683d3df65ea6c40ed902b3c0", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/a1982853bcdf0231683d3df65ea6c40ed902b3c0", "committedDate": "2020-02-19T18:41:37Z", "message": "Change metricsStore and set clock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "135a4c89e1c8234e9ebd39efd3e81cae4a50ffa5", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/135a4c89e1c8234e9ebd39efd3e81cae4a50ffa5", "committedDate": "2020-02-19T19:31:32Z", "message": "Fix MetricsMasterTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bce1d750b6bb3b32e186832d852fd37c7d6bc23", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/6bce1d750b6bb3b32e186832d852fd37c7d6bc23", "committedDate": "2020-02-19T19:33:33Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/7a262f12f0337bca68ed9eab7a2e4636630a6c6e", "committedDate": "2020-02-19T20:41:39Z", "message": "Use lower bound of time instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzE4NTQ1", "url": "https://github.com/Alluxio/alluxio/pull/10933#pullrequestreview-362318545", "createdAt": "2020-02-20T23:53:36Z", "commit": {"oid": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1MzozNlrOFsnTNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1NDo0OVrOFsnUqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTU1OA==", "bodyText": "what's the advantage to using mClock vs System.currentTimeMillis?", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382325558", "createdAt": "2020-02-20T23:53:36Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/MetricsStore.java", "diffHunk": "@@ -209,7 +223,7 @@ public void clear() {\n       for (Counter counter : mClusterCounters.values()) {\n         counter.dec(counter.getCount());\n       }\n-      mLastClearTime = System.currentTimeMillis();\n+      mLastClearTime = mClock.millis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTkzMQ==", "bodyText": "hmm if uptime is 0 should we be returning value? or 0?\nIn the off chance of some kind of error, what if uptime is negative?", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382325931", "createdAt": "2020-02-20T23:54:49Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -141,9 +141,11 @@ protected void registerThroughputGauge(String counterName, String throughputName\n         new Gauge<Object>() {\n           @Override\n           public Object getValue() {\n-            long uptime = (System.currentTimeMillis() - mMetricsStore.getLastClearTime())\n-                / Constants.SECOND_MS;\n-            return uptime == 0 ? 0 : MetricsSystem.counter(counterName).getCount() / uptime;\n+            long uptime = (mClock.millis() - mMetricsStore.getLastClearTime())\n+                / Constants.MINUTE_MS;\n+            long value = MetricsSystem.counter(counterName).getCount();\n+            // The value is bytes per minute\n+            return uptime == 0 ? value : value / uptime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a262f12f0337bca68ed9eab7a2e4636630a6c6e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30fd4170a5f36cb57e0a83ef1fa42413c79bee42", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/30fd4170a5f36cb57e0a83ef1fa42413c79bee42", "committedDate": "2020-02-21T00:03:32Z", "message": "Make sure uptime positive"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzMwOTM0", "url": "https://github.com/Alluxio/alluxio/pull/10933#pullrequestreview-362330934", "createdAt": "2020-02-21T00:30:01Z", "commit": {"oid": "30fd4170a5f36cb57e0a83ef1fa42413c79bee42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDozMDowMVrOFsn7pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDozMDowMVrOFsn7pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzNTkxMA==", "bodyText": "I'm not sure if this will still fix the issue?\nA java Clock object can have an offset added to it (See https://docs.oracle.com/javase/8/docs/api/java/time/Clock.html). If the duration is negative it could cause this to return negative for an extended period of time.\nI don't think we use the offset method anywhere, but it would be good to guard against it. I think keeping the code on one line is fine.\nMaybe instead we can simply update the return uptime == 0 ?  to return uptime <= 0 ? value : value / uptime\nor actually - since we should simply return the value within the first minute, maybe it should be\nreturn uptime <= 60 * Constants.SECOND_MS ? value : value / uptime", "url": "https://github.com/Alluxio/alluxio/pull/10933#discussion_r382335910", "createdAt": "2020-02-21T00:30:01Z", "author": {"login": "ZacBlanco"}, "path": "core/server/master/src/main/java/alluxio/master/metrics/DefaultMetricsMaster.java", "diffHunk": "@@ -141,9 +141,13 @@ protected void registerThroughputGauge(String counterName, String throughputName\n         new Gauge<Object>() {\n           @Override\n           public Object getValue() {\n-            long uptime = (System.currentTimeMillis() - mMetricsStore.getLastClearTime())\n-                / Constants.SECOND_MS;\n-            return uptime == 0 ? 0 : MetricsSystem.counter(counterName).getCount() / uptime;\n+            // Divide into two lines so uptime is always zero or positive\n+            long lastClearTime = mMetricsStore.getLastClearTime();\n+            long uptime = (mClock.millis() - lastClearTime)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30fd4170a5f36cb57e0a83ef1fa42413c79bee42"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6375657d2a07afa80e8437218224695304905dcb", "author": {"user": {"login": "LuQQiu", "name": null}}, "url": "https://github.com/Alluxio/alluxio/commit/6375657d2a07afa80e8437218224695304905dcb", "committedDate": "2020-02-21T00:40:14Z", "message": "guarantee uptime reasonable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzY4Nzk1", "url": "https://github.com/Alluxio/alluxio/pull/10933#pullrequestreview-362368795", "createdAt": "2020-02-21T02:41:49Z", "commit": {"oid": "6375657d2a07afa80e8437218224695304905dcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4985, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}