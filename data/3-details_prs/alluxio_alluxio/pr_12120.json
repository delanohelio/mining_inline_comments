{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTQ5ODk3", "number": 12120, "title": "Avoid printing long proto lines in messages and exception descriptions", "bodyText": "When printing a request proto as a log message or exception message, some requests contain large payloads. Those large payloads make it difficult to inspect the message. This change truncates individual lines of message.", "createdAt": "2020-09-21T20:45:40Z", "url": "https://github.com/Alluxio/alluxio/pull/12120", "merged": true, "mergeCommit": {"oid": "b666fdc63c3d2e0683b0e6b629de1db3103a4c93"}, "closed": true, "closedAt": "2020-09-22T16:22:07Z", "author": {"login": "gpang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLJoSQgH2gAyNDkwNTQ5ODk3OjkwNWRiMzI3MGI3Njg5M2JjMmIyYTk2OGUwZDI4NGJiZDQwNThhNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLM8pFAFqTQ5MzA2Njg4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/905db3270b76893bc2b2a968e0d284bbd4058a57", "committedDate": "2020-09-21T20:43:33Z", "message": "Truncate long proto lines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTg0MTM1", "url": "https://github.com/Alluxio/alluxio/pull/12120#pullrequestreview-492984135", "createdAt": "2020-09-21T21:12:49Z", "commit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxMjo0OVrOHVinBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToyMToyMlrOHVi2lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0OTE5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      formatErrorMessage(\"Failed to send request %s: stream is already closed or canceled.\",\n          \n          \n            \n                      formatErrorMessage(\"Failed to send request %s: stream is already closed or cancelled.\",\n          \n      \n    \n    \n  \n\nsince we're editing this line", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492349190", "createdAt": "2020-09-21T21:12:49Z", "author": {"login": "ZacBlanco"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -92,8 +93,9 @@ public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> r\n    */\n   public void send(ReqT request, long timeoutMs) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n-      throw new CancelledException(formatErrorMessage(\n-          \"Failed to send request %s: stream is already closed or canceled.\", request));\n+      throw new CancelledException(\n+          formatErrorMessage(\"Failed to send request %s: stream is already closed or canceled.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0OTU1MQ==", "bodyText": "most of the time its because of the large payload that the line is so large...what if instead we did request.toBuilder().setPayload(null) or something like that instead? Really it's just the payload causing the unreadability, right? I think it would be best to strip out the payload instead? I think its bad practice to be dumping that information in a log anyway.", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492349551", "createdAt": "2020-09-21T21:13:38Z", "author": {"login": "ZacBlanco"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -92,8 +93,9 @@ public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> r\n    */\n   public void send(ReqT request, long timeoutMs) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n-      throw new CancelledException(formatErrorMessage(\n-          \"Failed to send request %s: stream is already closed or canceled.\", request));\n+      throw new CancelledException(\n+          formatErrorMessage(\"Failed to send request %s: stream is already closed or canceled.\",\n+              LogUtils.truncateMessageLines(request)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MDM4OQ==", "bodyText": "Since LogUtils.truncateMessagelines(request) is always called regardless of debug level, we'll always be serializing the payload and allocating a string. I think that we should do a LOG.isDebugEnabled statement around this message if we intend to keep the log call the same", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492350389", "createdAt": "2020-09-21T21:15:28Z", "author": {"login": "ZacBlanco"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -126,7 +130,7 @@ public void send(ReqT request, long timeoutMs) throws IOException {\n   public void send(ReqT request) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n       LOG.debug(\"Failed to send request {}: stream is already closed or canceled. ({})\",\n-          request, mDescription);\n+          LogUtils.truncateMessageLines(request), mDescription);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MzE3Mw==", "bodyText": "at first I thought this was the actual number of \"lines\" in the string. i.e. counting the number of \\n characters. Only after reading this code do I realize its the length of the string. Maybe rename to truncateMessageLineLength?\nAdditionally, do you think another method to limit the number of \\n characters useful?", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492353173", "createdAt": "2020-09-21T21:21:22Z", "author": {"login": "ZacBlanco"}, "path": "core/common/src/main/java/alluxio/util/LogUtils.java", "diffHunk": "@@ -132,4 +136,38 @@ public static void warnWithException(Logger logger, String message, Object ...ar\n       logger.warn(message + \": {}\", args);\n     }\n   }\n+\n+  /**\n+   * Truncates each line of a message to a certain length.\n+   *\n+   * @param message the message to truncate the lines for\n+   * @return the message, with lines truncated to length {@link #MAX_TRUNCATED_LENGTH}\n+   */\n+  public static String truncateMessageLines(Object message) {\n+    return truncateMessageLines(message, MAX_TRUNCATED_LENGTH);\n+  }\n+\n+  /**\n+   * Truncates each line of a message to a certain length.\n+   *\n+   * @param message the message to truncate the lines for\n+   * @param maxLineLength the maximum length of a message line\n+   * @return the message, with lines truncated to the specified length\n+   */\n+  public static String truncateMessageLines(Object message, int maxLineLength) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1bafaca4ae99dff7045173877dfff27ae966b9", "author": {"user": {"login": "gpang", "name": "Gene Pang"}}, "url": "https://github.com/Alluxio/alluxio/commit/4a1bafaca4ae99dff7045173877dfff27ae966b9", "committedDate": "2020-09-21T22:35:19Z", "message": "Update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDIzMjgy", "url": "https://github.com/Alluxio/alluxio/pull/12120#pullrequestreview-493023282", "createdAt": "2020-09-21T22:26:37Z", "commit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyNjozOFrOHVkixw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjozNTowNlrOHVkuZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MDg3MQ==", "bodyText": "Well, the main problem is that we technically cannot assume what type the request is. It can be any type, so we cannot assume it is a proto, or even which proto it is.\nI wanted to avoid adding instanceof calls for various proto types, and so the current mechanism is to just truncate long lines.", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492380871", "createdAt": "2020-09-21T22:26:38Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -92,8 +93,9 @@ public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> r\n    */\n   public void send(ReqT request, long timeoutMs) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n-      throw new CancelledException(formatErrorMessage(\n-          \"Failed to send request %s: stream is already closed or canceled.\", request));\n+      throw new CancelledException(\n+          formatErrorMessage(\"Failed to send request %s: stream is already closed or canceled.\",\n+              LogUtils.truncateMessageLines(request)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0OTU1MQ=="}, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MTMzMw==", "bodyText": "Done.", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492381333", "createdAt": "2020-09-21T22:28:02Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -126,7 +130,7 @@ public void send(ReqT request, long timeoutMs) throws IOException {\n   public void send(ReqT request) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n       LOG.debug(\"Failed to send request {}: stream is already closed or canceled. ({})\",\n-          request, mDescription);\n+          LogUtils.truncateMessageLines(request), mDescription);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MDM4OQ=="}, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4MjM5OQ==", "bodyText": "I renamed the methods.\nLimiting the number of lines could also be useful. We can add that in a later PR.", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492382399", "createdAt": "2020-09-21T22:31:04Z", "author": {"login": "gpang"}, "path": "core/common/src/main/java/alluxio/util/LogUtils.java", "diffHunk": "@@ -132,4 +136,38 @@ public static void warnWithException(Logger logger, String message, Object ...ar\n       logger.warn(message + \": {}\", args);\n     }\n   }\n+\n+  /**\n+   * Truncates each line of a message to a certain length.\n+   *\n+   * @param message the message to truncate the lines for\n+   * @return the message, with lines truncated to length {@link #MAX_TRUNCATED_LENGTH}\n+   */\n+  public static String truncateMessageLines(Object message) {\n+    return truncateMessageLines(message, MAX_TRUNCATED_LENGTH);\n+  }\n+\n+  /**\n+   * Truncates each line of a message to a certain length.\n+   *\n+   * @param message the message to truncate the lines for\n+   * @param maxLineLength the maximum length of a message line\n+   * @return the message, with lines truncated to the specified length\n+   */\n+  public static String truncateMessageLines(Object message, int maxLineLength) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MzE3Mw=="}, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM4Mzg0NQ==", "bodyText": "I didn't know what the correct spelling was, but this site says both are fine: https://www.grammarly.com/blog/canceled-vs-cancelled/\nI changed it to cancelled because that is what the exception name is also using.", "url": "https://github.com/Alluxio/alluxio/pull/12120#discussion_r492383845", "createdAt": "2020-09-21T22:35:06Z", "author": {"login": "gpang"}, "path": "core/client/fs/src/main/java/alluxio/client/block/stream/GrpcBlockingStream.java", "diffHunk": "@@ -92,8 +93,9 @@ public GrpcBlockingStream(Function<StreamObserver<ResT>, StreamObserver<ReqT>> r\n    */\n   public void send(ReqT request, long timeoutMs) throws IOException {\n     if (mClosed || mCanceled || mClosedFromRemote) {\n-      throw new CancelledException(formatErrorMessage(\n-          \"Failed to send request %s: stream is already closed or canceled.\", request));\n+      throw new CancelledException(\n+          formatErrorMessage(\"Failed to send request %s: stream is already closed or canceled.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0OTE5MA=="}, "originalCommit": {"oid": "905db3270b76893bc2b2a968e0d284bbd4058a57"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDY2ODgw", "url": "https://github.com/Alluxio/alluxio/pull/12120#pullrequestreview-493066880", "createdAt": "2020-09-22T00:35:30Z", "commit": {"oid": "4a1bafaca4ae99dff7045173877dfff27ae966b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3586, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}