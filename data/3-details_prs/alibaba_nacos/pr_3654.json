{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODMyODAx", "number": 3654, "title": "[ISSUE#3315]Nacos client support https", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\n#3315\nclient-side support https\nBrief changelog\n\ncommon module add tls part\nJdkHttpClientRequest support https\n\n\nThe http client now uses a unified AbstractNacosRestTemplate, while NacosRestTemplate uses JdkHttpClientRequest as the internal client\n\nTLS classes\nSSLContext\n\n\nTlsHelper\nUtils for build SSLContext\n\n\nSelfKeyManager\nUtils for build customized KeyManager\n\n\nSelfTrustManager\nUtils for build customized TrustManager\n\n\nHostnameVerifier\n\nSelfHostnameVerifier\nA HostnameVerifier verify ipv4 and localhost.\n\nAbstractHttpClientFactory\nDevelopers need to modify the createXXXXRestTemplate method to create an HTTP client supporting https by calling the initTls method\nTLS mode\n\n\nNot support TLS (default)\n\n\nMaking your client support TLS without authentication\n\n\n System.setProperty(TlsSystemConfig.TLS_ENABLE, \"true\");\n\nMaking your client support TLS one-way authentication\n\n System.setProperty(TlsSystemConfig.TLS_ENABLE, \"true\");\n System.setProperty(TlsSystemConfig.CLIENT_AUTH, \"true\");\n System.setProperty(TlsSystemConfig.CLIENT_TRUST_CERT, \"trustCert\");\nTLS file watch\ndefault check interval is 10 min.\ncustomize with the following parameters\nSystem.setProperty(TlsSystemConfig.CHECK_INTERVAL,\"10\")\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-08-20T11:01:02Z", "url": "https://github.com/alibaba/nacos/pull/3654", "merged": true, "mergeCommit": {"oid": "da8fa57f99699436a900e7a0092cacd4f9a47bb7"}, "closed": true, "closedAt": "2020-08-24T10:35:39Z", "author": {"login": "wangweizZZ"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdADVUPAH2gAyNDcwODMyODAxOjIzOTE0NTNhMTgxYTI5MzA3ZDBmMjAyMzAyMWQ2YjJiMGQ1ZTdhODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCAJkSAFqTQ3MzM0NjQ4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2391453a181a29307d0f2023021d6b2b0d5e7a86", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/2391453a181a29307d0f2023021d6b2b0d5e7a86", "committedDate": "2020-08-18T09:10:14Z", "message": "[ISSUE #3315] nacos client support https\n* common module add tls related classes\n* JdkHttpClientRequest support https\n* unified IpUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a837c70dbff78f76f6d38ce1911711b1c90638ed", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/a837c70dbff78f76f6d38ce1911711b1c90638ed", "committedDate": "2020-08-20T08:25:34Z", "message": "[ISSUE #3315] nacos client support https\n* common module add tls related classes\n* JdkHttpClientRequest support https\n* unified IpUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDkxNzc4", "url": "https://github.com/alibaba/nacos/pull/3654#pullrequestreview-471491778", "createdAt": "2020-08-20T11:11:08Z", "commit": {"oid": "a837c70dbff78f76f6d38ce1911711b1c90638ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMToxMTowOFrOHD8B6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMToxMTowOFrOHD8B6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MTMwNg==", "bodyText": "Why SuppressWarnings checkstyle:WhitespaceAround?", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r473891306", "createdAt": "2020-08-20T11:11:08Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/tls/SelfTrustManager.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.tls;\n+\n+import com.alibaba.nacos.common.utils.IoUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.net.ssl.SSLException;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import javax.net.ssl.X509TrustManager;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.security.KeyStore;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.util.Collection;\n+\n+/**\n+ * A TrustManager tool returns the specified TrustManager.\n+ *\n+ * @author wangwei\n+ */\n+public final class SelfTrustManager {\n+    \n+    private static final Logger LOGGER = LoggerFactory.getLogger(SelfTrustManager.class);\n+    \n+    @SuppressWarnings(\"checkstyle:WhitespaceAround\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a837c70dbff78f76f6d38ce1911711b1c90638ed"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c", "committedDate": "2020-08-20T16:18:28Z", "message": "[ISSUE #3315] nacos client support https"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDgxNTMy", "url": "https://github.com/alibaba/nacos/pull/3654#pullrequestreview-472081532", "createdAt": "2020-08-21T01:12:10Z", "commit": {"oid": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxMjoxMFrOHEYPEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxMjoxMFrOHEYPEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1MzQyNA==", "bodyText": "\u8fd9\u91cc\u7684\u903b\u8f91\u662f\u4e0d\u662f\u53ef\u4ee5\u72ec\u7acb\u4e3a\u4e00\u4e2a\u51fd\u6570\uff0c\u770b\u8d77\u6765\u76f8\u5bf9\u7b80\u6d01\u70b9\u3002", "url": "https://github.com/alibaba/nacos/pull/3654#discussion_r474353424", "createdAt": "2020-08-21T01:12:10Z", "author": {"login": "Maijh97"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java", "diffHunk": "@@ -34,7 +46,28 @@\n     @Override\n     public final NacosRestTemplate createNacosRestTemplate() {\n         HttpClientConfig httpClientConfig = buildHttpClientConfig();\n-        return new NacosRestTemplate(assignLogger(), new JdkHttpClientRequest(httpClientConfig));\n+        final JdkHttpClientRequest clientRequest = new JdkHttpClientRequest(httpClientConfig);\n+        \n+        if (TlsSystemConfig.tlsEnable) {\n+            // enable ssl\n+            clientRequest.setSSLContext(loadSSLContext());\n+            final HostnameVerifier hv = HttpsURLConnection.getDefaultHostnameVerifier();\n+            final SelfHostnameVerifier selfHostnameVerifier = new SelfHostnameVerifier(hv);\n+            clientRequest.replaceSSLHostnameVerifier(selfHostnameVerifier);\n+            \n+            try {\n+                TlsFileWatcher.getInstance().addFileChangeListener(new TlsFileWatcher.FileChangeListener() {\n+                    @Override\n+                    public void onChanged(String filePath) {\n+                        clientRequest.setSSLContext(loadSSLContext());\n+                    }\n+                }, TlsSystemConfig.tlsClientTrustCertPath, TlsSystemConfig.tlsClientKeyPath);\n+            } catch (IOException e) {\n+                assignLogger().error(\"add tls file listener fail\", e);\n+            }\n+        }\n+        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTQzMzk2", "url": "https://github.com/alibaba/nacos/pull/3654#pullrequestreview-473143396", "createdAt": "2020-08-24T06:11:14Z", "commit": {"oid": "78a9f6226d0cdc56ca5d9938a11d91f9f410ad3c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ffddebe4c74bee76de36bd0ec82505e648d427", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/85ffddebe4c74bee76de36bd0ec82505e648d427", "committedDate": "2020-08-24T08:34:39Z", "message": "Merge remote-tracking branch 'alibaba/develop' into feature_https"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b654e4bb6a0bd02179805389089915f3085bf96", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/9b654e4bb6a0bd02179805389089915f3085bf96", "committedDate": "2020-08-24T08:39:34Z", "message": "format code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f62c12e282fd910bb09baa21022869821c23c41", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/4f62c12e282fd910bb09baa21022869821c23c41", "committedDate": "2020-08-24T08:37:51Z", "message": "format code"}, "afterCommit": {"oid": "9b654e4bb6a0bd02179805389089915f3085bf96", "author": {"user": {"login": "wangweizZZ", "name": "Gagharv"}}, "url": "https://github.com/alibaba/nacos/commit/9b654e4bb6a0bd02179805389089915f3085bf96", "committedDate": "2020-08-24T08:39:34Z", "message": "format code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzQ2NDg1", "url": "https://github.com/alibaba/nacos/pull/3654#pullrequestreview-473346485", "createdAt": "2020-08-24T10:35:32Z", "commit": {"oid": "9b654e4bb6a0bd02179805389089915f3085bf96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4242, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}