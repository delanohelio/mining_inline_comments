{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMTA4MDEz", "number": 3523, "title": "[ISSUE #3192] replace nacos-config module http client", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nrefer\uff1a #3192\nBrief changelog\nMainly replace the http client used by com.alibaba.nacos.config.server.service.notify.NotifyService  and com.alibaba.nacos.config.server.service.notify.AsyncNotifyService .\nVerifying this change\nSimulate a three-node cluster locally, modify the configuration information on the console, Through debugging, it has been verified that the http client after replacement can work normally.\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-08-05T02:34:21Z", "url": "https://github.com/alibaba/nacos/pull/3523", "merged": true, "mergeCommit": {"oid": "a64a356e4558faa2e46a583b133bb03fecfc3b80"}, "closed": true, "closedAt": "2020-08-06T03:53:28Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc47kBRgH2gAyNDYzMTA4MDEzOjkwNmUwODQzYjI1NjcxY2I1OWU1YTFhNmU2ZWZhYjJkMWY5NDM4MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8HmuHAFqTQ2MjE2OTA5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "906e0843b25671cb59e5a1a6e6efab2d1f94381a", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/906e0843b25671cb59e5a1a6e6efab2d1f94381a", "committedDate": "2020-07-27T06:09:35Z", "message": "nacos-config module replace http client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "935c0bc504fa49412a5bd2ddaa4c1a1c2c5ee019", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/935c0bc504fa49412a5bd2ddaa4c1a1c2c5ee019", "committedDate": "2020-07-31T06:37:05Z", "message": "Merge branch 'develop' into refactor_replace_config_http_client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10472593f961ada3d4206b46a3cbe1fb9224dba9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/10472593f961ada3d4206b46a3cbe1fb9224dba9", "committedDate": "2020-08-04T05:43:37Z", "message": "replace http client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "590aad837204d7e25d43f36f62d3e172ce455c8b", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/590aad837204d7e25d43f36f62d3e172ce455c8b", "committedDate": "2020-08-04T05:47:12Z", "message": "Merge branch 'develop' into refactor_replace_config_http_client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bebb371102fec6dd120fdba1ee5b0b47cc4d1ee3", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/bebb371102fec6dd120fdba1ee5b0b47cc4d1ee3", "committedDate": "2020-08-05T04:31:01Z", "message": "Remove redundant package import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/c1b20b5a3b78acfa729e46c04ac1a88251b2a52e", "committedDate": "2020-08-05T04:38:59Z", "message": "add license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTI2ODI5", "url": "https://github.com/alibaba/nacos/pull/3523#pullrequestreview-462126829", "createdAt": "2020-08-06T01:27:53Z", "commit": {"oid": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMToyNzo1M1rOG8gBIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMTozNToyM1rOG8gJiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5MjMyMw==", "bodyText": "Can unified json utils to Jackson util?", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466092323", "createdAt": "2020-08-06T01:27:53Z", "author": {"login": "KomachiSion"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/service/ConfigSubService.java", "diffHunk": "@@ -178,19 +178,16 @@ public SampleResult call() throws Exception {\n                 }\n                 \n                 String urlAll = getUrl(ip, url) + \"?\" + paramUrl;\n-                com.alibaba.nacos.config.server.service.notify.NotifyService.HttpResult result = NotifyService\n+                RestResult<String> result = NotifyService\n                         .invokeURL(urlAll, null, Constants.ENCODE);\n                 \n                 // Http code 200\n-                if (result.code == HttpURLConnection.HTTP_OK) {\n-                    String json = result.content;\n-                    SampleResult resultObj = JSONUtils.deserializeObject(json, new TypeReference<SampleResult>() {\n+                if (result.ok()) {\n+                    return JSONUtils.deserializeObject(result.getData(), new TypeReference<SampleResult>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5NDQ3NQ==", "bodyText": "Should we modified this restTemplate.get method, if any error when execute get, call the callback.onError in the restTemplate.get rather than throw exception?", "url": "https://github.com/alibaba/nacos/pull/3523#discussion_r466094475", "createdAt": "2020-08-06T01:35:23Z", "author": {"login": "KomachiSion"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/service/notify/AsyncNotifyService.java", "diffHunk": "@@ -138,52 +132,52 @@ private void executeAsyncInvoke() {\n                         // get delay time and set fail count to the task\n                         asyncTaskExecute(task);\n                     } else {\n-                        HttpGet request = new HttpGet(task.url);\n-                        request.setHeader(NotifyService.NOTIFY_HEADER_LAST_MODIFIED,\n-                                String.valueOf(task.getLastModified()));\n-                        request.setHeader(NotifyService.NOTIFY_HEADER_OP_HANDLE_IP, InetUtils.getSelfIp());\n+                        Header header = Header.newInstance();\n+                        header.addParam(NotifyService.NOTIFY_HEADER_LAST_MODIFIED, String.valueOf(task.getLastModified()));\n+                        header.addParam(NotifyService.NOTIFY_HEADER_OP_HANDLE_IP, InetUtils.getSelfIp());\n                         if (task.isBeta) {\n-                            request.setHeader(\"isBeta\", \"true\");\n+                            header.addParam(\"isBeta\", \"true\");\n+                        }\n+                        AsyncNotifyCallBack asyncNotifyCallBack = new AsyncNotifyCallBack(task);\n+                        try {\n+                            restTemplate.get(task.url, header, Query.EMPTY, String.class, asyncNotifyCallBack);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b20b5a3b78acfa729e46c04ac1a88251b2a52e"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c521d0659fec610d1d38936d69f7ab0917d40ead", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/c521d0659fec610d1d38936d69f7ab0917d40ead", "committedDate": "2020-08-06T02:17:25Z", "message": "Delete JOSNUtils and use JacksonUtils instead; modify NacosAsyncRestTemplate exception handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTY5MDk1", "url": "https://github.com/alibaba/nacos/pull/3523#pullrequestreview-462169095", "createdAt": "2020-08-06T03:53:10Z", "commit": {"oid": "c521d0659fec610d1d38936d69f7ab0917d40ead"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4326, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}