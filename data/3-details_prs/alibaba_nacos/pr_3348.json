{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5ODQ0NTY3", "number": 3348, "title": "[ISSUE #3224]nacos-client module http client replace", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\n#3224\nBrief changelog\nReplace the http client in the config package of the nacos-client module\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-07-16T02:08:13Z", "url": "https://github.com/alibaba/nacos/pull/3348", "merged": true, "mergeCommit": {"oid": "63a4e30ae637100902848999dc0c7219af1e8cd4"}, "closed": true, "closedAt": "2020-07-18T06:42:03Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1VPzQAH2gAyNDQ5ODQ0NTY3OjcxNDRjNzRjNjVhMDljZjFjZWUxOTk2OWU5MTViMzcyOWJhMDA2ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2CoLIgFqTQ1MTAzNjYzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7144c74c65a09cf1cee19969e915b3729ba006e2", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7144c74c65a09cf1cee19969e915b3729ba006e2", "committedDate": "2020-07-16T01:49:20Z", "message": "nacos-client module http client replace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3557a705f944cdae33fdb628098f2fb68369358", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/c3557a705f944cdae33fdb628098f2fb68369358", "committedDate": "2020-07-16T02:16:44Z", "message": "fix code style problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e60fd0105c676a10eb28035515bc0315d19c008", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/2e60fd0105c676a10eb28035515bc0315d19c008", "committedDate": "2020-07-16T02:16:51Z", "message": "Merge remote-tracking branch 'origin/refactor_config_http_client' into refactor_config_http_client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/45c19b10daaa6869728d91b07e12ba517b0d55e1", "committedDate": "2020-07-16T04:01:18Z", "message": "add HashMap initialCapacity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjgzMDA3", "url": "https://github.com/alibaba/nacos/pull/3348#pullrequestreview-449683007", "createdAt": "2020-07-16T09:36:12Z", "commit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwOTozNjoxMlrOGyjEfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDowNDo1N1rOGykH1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjU3NQ==", "bodyText": "do not change intend please", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656575", "createdAt": "2020-07-16T09:36:12Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjkwMA==", "bodyText": "do not change intend please", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656900", "createdAt": "2020-07-16T09:36:42Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+\n         String url = Constants.CONFIG_CONTROLLER_PATH;\n-        List<String> params = new ArrayList<String>();\n-        params.add(\"dataId\");\n-        params.add(dataId);\n-        params.add(\"group\");\n-        params.add(group);\n-        params.add(\"content\");\n-        params.add(content);\n+        Map<String, String> params = new HashMap<String, String>(6);\n+        params.put(\"dataId\", dataId);\n+        params.put(\"group\", group);\n+        params.put(\"content\", content);\n         if (StringUtils.isNotEmpty(tenant)) {\n-            params.add(\"tenant\");\n-            params.add(tenant);\n+            params.put(\"tenant\", tenant);\n         }\n         if (StringUtils.isNotEmpty(appName)) {\n-            params.add(\"appName\");\n-            params.add(appName);\n+            params.put(\"appName\", appName);\n         }\n         if (StringUtils.isNotEmpty(tag)) {\n-            params.add(\"tag\");\n-            params.add(tag);\n+            params.put(\"tag\", tag);\n         }\n-        \n-        List<String> headers = new ArrayList<String>();\n+        Map<String, String> headers = new HashMap<String, String>(1);\n         if (StringUtils.isNotEmpty(betaIps)) {\n-            headers.add(\"betaIps\");\n-            headers.add(betaIps);\n+            headers.put(\"betaIps\", betaIps);\n         }\n-        \n-        HttpResult result = null;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1NjkzOQ==", "bodyText": "do not change intend please", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455656939", "createdAt": "2020-07-16T09:36:46Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/config/NacosConfigService.java", "diffHunk": "@@ -226,54 +222,46 @@ private boolean publishConfigInner(String tenant, String dataId, String group, S\n         cr.setContent(content);\n         configFilterChainManager.doFilter(cr, null);\n         content = cr.getContent();\n-        \n+\n         String url = Constants.CONFIG_CONTROLLER_PATH;\n-        List<String> params = new ArrayList<String>();\n-        params.add(\"dataId\");\n-        params.add(dataId);\n-        params.add(\"group\");\n-        params.add(group);\n-        params.add(\"content\");\n-        params.add(content);\n+        Map<String, String> params = new HashMap<String, String>(6);\n+        params.put(\"dataId\", dataId);\n+        params.put(\"group\", group);\n+        params.put(\"content\", content);\n         if (StringUtils.isNotEmpty(tenant)) {\n-            params.add(\"tenant\");\n-            params.add(tenant);\n+            params.put(\"tenant\", tenant);\n         }\n         if (StringUtils.isNotEmpty(appName)) {\n-            params.add(\"appName\");\n-            params.add(appName);\n+            params.put(\"appName\", appName);\n         }\n         if (StringUtils.isNotEmpty(tag)) {\n-            params.add(\"tag\");\n-            params.add(tag);\n+            params.put(\"tag\", tag);\n         }\n-        \n-        List<String> headers = new ArrayList<String>();\n+        Map<String, String> headers = new HashMap<String, String>(1);\n         if (StringUtils.isNotEmpty(betaIps)) {\n-            headers.add(\"betaIps\");\n-            headers.add(betaIps);\n+            headers.put(\"betaIps\", betaIps);\n         }\n-        \n-        HttpResult result = null;\n+\n+        HttpRestResult<String> result = null;\n         try {\n             result = agent.httpPost(url, headers, params, encode, POST_TIMEOUT);\n-        } catch (IOException ioe) {\n-            LOGGER.warn(\"[{}] [publish-single] exception, dataId={}, group={}, msg={}\", agent.getName(), dataId, group,\n-                    ioe.toString());\n+        } catch (Exception ex) {\n+            LOGGER.warn(\"[{}] [publish-single] exception, dataId={}, group={}, msg={}\", agent.getName(), dataId,\n+                group, ex.toString());\n             return false;\n         }\n-        \n-        if (HttpURLConnection.HTTP_OK == result.code) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY1OTk1MQ==", "bodyText": "Where are these logic from?", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455659951", "createdAt": "2020-07-16T09:41:49Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/config/http/ServerHttpAgent.java", "diffHunk": "@@ -358,29 +354,37 @@ public void start() throws NacosException {\n         serverListMgr.start();\n     }\n     \n-    private List<String> getSpasHeaders(List<String> paramValues) throws IOException {\n-        List<String> newHeaders = new ArrayList<String>();\n+    private Header getSpasHeaders(Map<String, String> paramValues, String encode) throws Exception {\n+        Header header = Header.newInstance();\n         // STS \u4e34\u65f6\u51ed\u8bc1\u9274\u6743\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e AK/SK \u9274\u6743\n         if (StsConfig.getInstance().isStsOn()) {\n             StsCredential stsCredential = getStsCredential();\n             accessKey = stsCredential.accessKeyId;\n             secretKey = stsCredential.accessKeySecret;\n-            newHeaders.add(\"Spas-SecurityToken\");\n-            newHeaders.add(stsCredential.securityToken);\n+            header.addParam(\"Spas-SecurityToken\", stsCredential.securityToken);\n         }\n         \n         if (StringUtils.isNotEmpty(accessKey) && StringUtils.isNotEmpty(secretKey)) {\n-            newHeaders.add(\"Spas-AccessKey\");\n-            newHeaders.add(accessKey);\n-            List<String> signHeaders = SpasAdapter.getSignHeaders(paramValues, secretKey);\n+            header.addParam(\"Spas-AccessKey\", accessKey);\n+            Map<String, String> signHeaders = SpasAdapter.getSignHeaders(paramValues, secretKey);\n             if (signHeaders != null) {\n-                newHeaders.addAll(signHeaders);\n+                header.addAll(signHeaders);\n             }\n         }\n-        return newHeaders;\n+        String ts = String.valueOf(System.currentTimeMillis());\n+        String token = MD5Utils.md5Hex(ts + ParamUtil.getAppKey(), Constants.ENCODE);\n+        \n+        header.addParam(Constants.CLIENT_APPNAME_HEADER, ParamUtil.getAppName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "originalPosition": 323}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY3MzgxNQ==", "bodyText": "Is these method refactor correctly? I see the input is come from httpclient.", "url": "https://github.com/alibaba/nacos/pull/3348#discussion_r455673815", "createdAt": "2020-07-16T10:04:57Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/utils/EnvUtil.java", "diffHunk": "@@ -30,45 +28,42 @@\n     \n     public static final Logger LOGGER = LogUtils.logger(EnvUtil.class);\n     \n-    public static void setSelfEnv(Map<String, List<String>> headers) {\n+    public static void setSelfEnv(Header headers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c19b10daaa6869728d91b07e12ba517b0d55e1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e675468e00d59255f371a83224572d6a8b1ef1", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/08e675468e00d59255f371a83224572d6a8b1ef1", "committedDate": "2020-07-16T10:37:57Z", "message": "fix code style problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1f2af01408796cc40028c361fd5902523099b40", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/f1f2af01408796cc40028c361fd5902523099b40", "committedDate": "2020-07-16T13:57:59Z", "message": "Modify the header object, keep the original response header to avoid modifying the original logic code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed8561f2156513f2d3bc60e2ccabd39089d57b0", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/bed8561f2156513f2d3bc60e2ccabd39089d57b0", "committedDate": "2020-07-16T14:04:12Z", "message": "fix code style problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzExMzU1", "url": "https://github.com/alibaba/nacos/pull/3348#pullrequestreview-450311355", "createdAt": "2020-07-17T01:06:36Z", "commit": {"oid": "bed8561f2156513f2d3bc60e2ccabd39089d57b0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c841f6d905198dcb384af6f5fd05a6fd2b87b52", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/2c841f6d905198dcb384af6f5fd05a6fd2b87b52", "committedDate": "2020-07-17T15:20:37Z", "message": "naming http client request exception messages output change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7907b98e5f4ecdf10622e04792d9dbbfcac2be22", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7907b98e5f4ecdf10622e04792d9dbbfcac2be22", "committedDate": "2020-07-17T15:27:55Z", "message": "Merge branch 'develop-upstrem' into refactor_config_http_client\n\n# Conflicts:\n#\tclient/src/main/java/com/alibaba/nacos/client/config/impl/ServerListManager.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7efc8001be3c3dc12733f5b0185379fbba184815", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7efc8001be3c3dc12733f5b0185379fbba184815", "committedDate": "2020-07-17T15:28:37Z", "message": "Merge code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDM2NjM5", "url": "https://github.com/alibaba/nacos/pull/3348#pullrequestreview-451036639", "createdAt": "2020-07-18T06:41:41Z", "commit": {"oid": "7efc8001be3c3dc12733f5b0185379fbba184815"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4299, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}