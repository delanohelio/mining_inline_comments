{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MTE3NTE5", "number": 4363, "title": "Add the function of automatically clearing empty services", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nXXXXX\nBrief changelog\nXX\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-11-29T14:25:13Z", "url": "https://github.com/alibaba/nacos/pull/4363", "merged": true, "mergeCommit": {"oid": "c1e4068dfe423ac272292710d2d50548907e7451"}, "closed": true, "closedAt": "2020-11-30T07:23:25Z", "author": {"login": "paderlol"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhRjItAH2gAyNTI5MTE3NTE5OmM2OTY2N2QwYjBhNjgxZmQ1MzEyMWIzYTMwNjEyNDg3NWQ0NmU1ZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhgIrxgFqTU0MDY0Nzc5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c69667d0b0a681fd53121b3a306124875d46e5d8", "author": {"user": {"login": "paderlol", "name": "paderlol"}}, "url": "https://github.com/alibaba/nacos/commit/c69667d0b0a681fd53121b3a306124875d46e5d8", "committedDate": "2020-11-29T14:23:30Z", "message": "Add the function of automatically clearing empty services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "author": {"user": {"login": "paderlol", "name": "paderlol"}}, "url": "https://github.com/alibaba/nacos/commit/ac9b04bfa58118e08fb060afd7a5008dc674a9ab", "committedDate": "2020-11-29T15:03:31Z", "message": "Fix checkstyle issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTUzMzQ0", "url": "https://github.com/alibaba/nacos/pull/4363#pullrequestreview-540553344", "createdAt": "2020-11-30T01:40:34Z", "commit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0MDozNFrOH7pYog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0NDo1NlrOH7pbwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA4Mg==", "bodyText": "Whether judge isEmpty first will be better?", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306082", "createdAt": "2020-11-30T01:40:34Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java", "diffHunk": "@@ -25,13 +38,48 @@\n     \n     private static final String EMPTY_SERVICE = \"emptyService\";\n     \n+    private final ClientServiceIndexesManager clientServiceIndexesManager;\n+    \n+    public EmptyServiceAutoCleanerV2(ClientServiceIndexesManager clientServiceIndexesManager) {\n+        this.clientServiceIndexesManager = clientServiceIndexesManager;\n+        // TODO get internal from config\n+        GlobalExecutor.scheduleExpiredClientCleaner(this, TimeUnit.SECONDS.toMillis(30), TimeUnit.SECONDS.toMillis(20),\n+                TimeUnit.MILLISECONDS);\n+        \n+    }\n+    \n     @Override\n     public String getType() {\n         return EMPTY_SERVICE;\n     }\n     \n     @Override\n     public void doClean() {\n+        ServiceManager serviceManager = ServiceManager.getInstance();\n+        // Parallel flow opening threshold\n+        int parallelSize = 100;\n+        \n+        for (String each : serviceManager.getAllNamespaces()) {\n+            Set<Service> services = serviceManager.getSingletons(each);\n+            Stream<Service> stream = services.size() > parallelSize ? services.parallelStream() : services.stream();\n+            stream.forEach(this::cleanEmptyService);\n+        }\n+    }\n+    \n+    private void cleanEmptyService(Service service) {\n+        Loggers.SRV_LOG.warn(\"namespace : {}, [{}] services are automatically cleaned\", service.getNamespace(),\n+                service.getGroupedServiceName());\n+        Collection<String> registeredService = clientServiceIndexesManager.getAllClientsRegisteredService(service);\n+        if (isTimeExpired(service) && registeredService.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjg4MA==", "bodyText": "I think this event is not useful.\nIt can be replaced by ServiceMetadataEvent(service, true)", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306880", "createdAt": "2020-11-30T01:44:56Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java", "diffHunk": "@@ -56,4 +56,16 @@ public ServiceChangedEvent(Service service, boolean incrementRevision) {\n             }\n         }\n     }\n+    \n+    /**\n+     * Service data changed event.\n+     */\n+    public static class ServiceRemovedEvent extends ServiceEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "author": {"user": {"login": "paderlol", "name": "paderlol"}}, "url": "https://github.com/alibaba/nacos/commit/a5a389ae2e8d65da7dffd16e2ee818569f892dc8", "committedDate": "2020-11-30T06:48:04Z", "message": "Delete the remove event of the service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjQzOTcx", "url": "https://github.com/alibaba/nacos/pull/4363#pullrequestreview-540643971", "createdAt": "2020-11-30T07:14:13Z", "commit": {"oid": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNDoxM1rOH7uRow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNDoxM1rOH7uRow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4NjIxMQ==", "bodyText": "An invalid blank?", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532386211", "createdAt": "2020-11-30T07:14:13Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java", "diffHunk": "@@ -166,7 +166,7 @@ public void onEvent(Event event) {\n             handleInstanceMetadataEvent((MetadataEvent.InstanceMetadataEvent) event);\n         } else if (event instanceof MetadataEvent.ServiceMetadataEvent) {\n             handleServiceMetadataEvent((MetadataEvent.ServiceMetadataEvent) event);\n-        } else {\n+        }  else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4508982b07b3581349d1addde55b080676a91b9a", "author": {"user": {"login": "paderlol", "name": "paderlol"}}, "url": "https://github.com/alibaba/nacos/commit/4508982b07b3581349d1addde55b080676a91b9a", "committedDate": "2020-11-30T07:18:21Z", "message": "Fix checkstyle issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjQ3Nzkw", "url": "https://github.com/alibaba/nacos/pull/4363#pullrequestreview-540647790", "createdAt": "2020-11-30T07:23:11Z", "commit": {"oid": "4508982b07b3581349d1addde55b080676a91b9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4151, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}