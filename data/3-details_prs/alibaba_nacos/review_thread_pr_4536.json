{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNTE3MTIw", "number": 4536, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0MjoyOFrOFIjN7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0NjoyMVrOFIjR_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NTA5OTMzOnYy", "diffSide": "RIGHT", "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0MjoyOFrOIKiO8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMjoyMTozMFrOILGqSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw==", "bodyText": "use com.alibaba.nacos.common.utils.StringUtil#isBlank  will be better, I think", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547917553", "createdAt": "2020-12-23T11:42:28Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk0NzE2NA==", "bodyText": "use util is better , but it is an object.  I will use com.alibaba.nacos.common.utils.Objects#isNull", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547947164", "createdAt": "2020-12-23T12:59:24Z", "author": {"login": "haoyann"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUxNDM3OQ==", "bodyText": "If nacos_user_key is \"\", whether it return false directly?", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548514379", "createdAt": "2020-12-24T12:21:30Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNzU1Mw=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NTEwOTc0OnYy", "diffSide": "RIGHT", "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0NjoyMVrOIKiUwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QwNTowMjo0MFrOILoUbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA==", "bodyText": "I think this implementation will cause security problem. If you get admin from user input, users can mock or inject this value so that they can change others' password.", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547919040", "createdAt": "2020-12-23T11:46:21Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk0NzE4Mg==", "bodyText": "The current version also has this problem, because admin can modify the password of other users.I just kept this feature.", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r547947182", "createdAt": "2020-12-23T12:59:27Z", "author": {"login": "haoyann"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUxNDA5NA==", "bodyText": "But current judge admin has auth to change other password is used the role queried by datasource.\nYour implementation is used the request input. If I'm not admin, but I call this API with myself input. I will change other's password.\nI am not saying that there is a problem with this function, I just describe that your implementation allows other non-admin users to modify the passwords of other users.", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548514094", "createdAt": "2020-12-24T12:20:01Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0MTEzMw==", "bodyText": "\u62b1\u6b49\uff0c\u6211\u4e0d\u662f\u5f88\u660e\u767d\u60a8\u201cI call this API with myself input. I will change other's password\u201d\u8fd9\u91cc\u8868\u8fbe\u7684\u610f\u601d\uff0c\u56e0\u4e3a\u6211\u770b\u4ee3\u7801\u5728com.alibaba.nacos.core.auth.AuthFilter#doFilter\u8fd9\u91cc\u4f1a\u8c03\u7528\u65b9\u6cd5com.alibaba.nacos.console.senicurity.nacos.NacosAuthManager#login,\u8fd9\u91cc\u5b83\u5c06\u8bbe\u7f6eNACOS_USER_KEY\n        List<RoleInfo> roleInfoList = roleService.getRoles(username);\n        if (roleInfoList != null) {\n            for (RoleInfo roleInfo : roleInfoList) {\n                if (roleInfo.getRole().equals(NacosRoleServiceImpl.GLOBAL_ADMIN_ROLE)) {\n                    user.setGlobalAdmin(true);\n                    break;\n                }\n            }\n        }\n        req.setAttribute(RequestUtil.NACOS_USER_KEY, user);\n\n\u5728\u6211\u7684\u7406\u89e3\u91cc\uff0c\u6211\u5728\u540e\u7eed\u4ecerequest\u4e2d\u53d6\u51fa\u7684NACOS_USER_KEY\u662f\u5df2\u7ecf\u8ba4\u8bc1\u8fc7\u540e\u7684\u7528\u6237\u4fe1\u606f\u3002\u6216\u8bb8\u6709\u54ea\u4e9b\u5730\u65b9\u6211\u6ca1\u6709\u8003\u8651\u5230\u7684\uff0c\u4f1a\u9020\u6210\u60a8\u6240\u8bf4\u7684\u5b89\u5168\u95ee\u9898\u3002\n\u5982\u662f\u786e\u5b9e\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u5728\u8fd9\u91cc\u8ba4\u8bc1\u7684\u65f6\u5019\u8c03\u7528com.alibaba.nacos.console.senicurity.nacos.NacosAuthManager#login\u8fd9\u4e2a\u65b9\u6cd5\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u8fd9\u6837\u5e94\u8be5\u4fdd\u9669\u7684\u3002", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548541133", "createdAt": "2020-12-24T14:12:55Z", "author": {"login": "haoyann"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1NjUwMw==", "bodyText": "\u5982\u679c\u662f\u4eceAuthFilter\u4e2d\u8986\u76d6\u7684\u5e94\u8be5\u4e5f\u53ef\u4ee5\u3002", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548956503", "createdAt": "2020-12-26T07:54:56Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MDU5MA==", "bodyText": "\u90a3\u73b0\u5728\u6211\u9700\u8981\u505a\u4ec0\u4e48\u5462 : )", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r548960590", "createdAt": "2020-12-26T08:46:50Z", "author": {"login": "haoyann"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2NDk3Ng==", "bodyText": "\u4e0a\u9762\u90a3\u4e2a\u95ee\u9898\uff0c \u9700\u4e0d\u9700\u8981\u6362\u6210\u5de5\u5177\u7c7b\u5224\u65ad\uff1f", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r549064976", "createdAt": "2020-12-27T04:48:58Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2NTgzOQ==", "bodyText": "done", "url": "https://github.com/alibaba/nacos/pull/4536#discussion_r549065839", "createdAt": "2020-12-27T05:02:40Z", "author": {"login": "haoyann"}, "path": "console/src/main/java/com/alibaba/nacos/console/controller/UserController.java", "diffHunk": "@@ -146,6 +155,23 @@ public Object updateUser(@RequestParam String username, @RequestParam String new\n         \n         return new RestResult<>(200, \"update user ok!\");\n     }\n+\n+    private boolean hasPermission(String username, HttpServletRequest request) {\n+        if (!authConfigs.isAuthEnabled()) {\n+            return true;\n+        }\n+        if (request.getAttribute(RequestUtil.NACOS_USER_KEY) == null) {\n+            return false;\n+        }\n+\n+        NacosUser user = (NacosUser) request.getAttribute(RequestUtil.NACOS_USER_KEY);\n+        // admin\n+        if (user.isGlobalAdmin()) {\n+            return true;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxOTA0MA=="}, "originalCommit": {"oid": "719b69a653da9415e0642269d5c0d901c95b8caf"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4511, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}