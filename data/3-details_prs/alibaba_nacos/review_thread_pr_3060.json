{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTkzNDY3", "number": 3060, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxMjoxMzozMVrOEFQCVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxMjoxMzozMVrOEFQCVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTQxMDc4OnYy", "diffSide": "RIGHT", "path": "config/src/main/java/com/alibaba/nacos/config/server/service/datasource/ExternalDataSourceProperties.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxMjoxMzozMVrOGjXRTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxMzoyMjowMVrOGjXipw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNDYwNw==", "bodyText": "\u6211\u89c9\u5f97\u8fd9\u4e2a\u5de5\u5177\u662f\u4e0d\u662f\u53ef\u4ee5\u4e0b\u6c89\u5230CollectionUtils\u91cc\u9762\uff1f", "url": "https://github.com/alibaba/nacos/pull/3060#discussion_r439734607", "createdAt": "2020-06-13T12:13:31Z", "author": {"login": "chuntaojun"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/service/datasource/ExternalDataSourceProperties.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+package com.alibaba.nacos.config.server.service.datasource;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.springframework.boot.context.properties.bind.Bindable;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.core.env.Environment;\n+\n+import com.google.common.base.Preconditions;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+/**\n+ * Properties of external DataSource\n+ *\n+ * @author Nacos\n+ */\n+public class ExternalDataSourceProperties {\n+\n+    private final static String JDBC_DRIVER_NAME = \"com.mysql.cj.jdbc.Driver\";\n+    public static final long CONNECTION_TIMEOUT_MS = 3000L;\n+    public static final long VALIDATION_TIMEOUT = 10L;\n+    public static final String TEST_QUERY = \"SELECT 1 FROM dual\";\n+    public static final int DEFAULT_MAX_POOL_SIZE = 20;\n+    public static final int DEFAULT_MINIMUM_IDLE = 50;\n+\n+    private Integer num;\n+    private List<String> url = new ArrayList<>();\n+    private List<String> user = new ArrayList<>();\n+    private List<String> password = new ArrayList<>();\n+    private List<Integer> maxPoolSize = new ArrayList<>();\n+    private List<Integer> minIdle = new ArrayList<>();\n+\n+    public void setNum(Integer num) {\n+        this.num = num;\n+    }\n+\n+    public void setUrl(List<String> url) {\n+        this.url = url;\n+    }\n+\n+    public void setUser(List<String> user) {\n+        this.user = user;\n+    }\n+\n+    public void setPassword(List<String> password) {\n+        this.password = password;\n+    }\n+\n+    public void setMaxPoolSize(List<Integer> maxPoolSize) {\n+        this.maxPoolSize = maxPoolSize;\n+    }\n+\n+    public void setMinIdle(List<Integer> minIdle) {\n+        this.minIdle = minIdle;\n+    }\n+\n+    /**\n+     *\n+     * @param environment\n+     *            {@link Environment}\n+     * @param callback\n+     *            Callback function when constructing data source\n+     * @return List of {@link HikariDataSource}\n+     */\n+    List<HikariDataSource> build(Environment environment, Callback<HikariDataSource> callback) {\n+        List<HikariDataSource> dataSources = new ArrayList<>();\n+        Binder.get(environment).bind(\"db\", Bindable.ofInstance(this));\n+        Preconditions.checkArgument(Objects.nonNull(num), \"db.num is null\");\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(user), \"db.user or db.user.[index] is null\");\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(password), \"db.password or db.password.[index] is null\");\n+        for (int index = 0; index < num; index++) {\n+            int currentSize = index + 1;\n+            Preconditions.checkArgument(url.size() >= currentSize, \"db.url.%s is null\", index);\n+            HikariDataSource ds = new HikariDataSource();\n+            ds.setDriverClassName(JDBC_DRIVER_NAME);\n+            ds.setJdbcUrl(url.get(index).trim());\n+            ds.setUsername(defaultIfNull(user, index, user.get(0)).trim());\n+            ds.setPassword(defaultIfNull(password, index, password.get(0)).trim());\n+            ds.setConnectionTimeout(CONNECTION_TIMEOUT_MS);\n+            ds.setMaximumPoolSize(defaultIfNull(maxPoolSize, index, DEFAULT_MAX_POOL_SIZE));\n+            ds.setMinimumIdle(defaultIfNull(minIdle, index, DEFAULT_MINIMUM_IDLE));\n+            // Check the connection pool every 10 minutes\n+            ds.setValidationTimeout(TimeUnit.MINUTES.toMillis(VALIDATION_TIMEOUT));\n+            ds.setConnectionTestQuery(TEST_QUERY);\n+            dataSources.add(ds);\n+            callback.accept(ds);\n+        }\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(dataSources), \"no datasource available\");\n+        return dataSources;\n+    }\n+\n+    static <T> T defaultIfNull(List<T> collection, int index, T defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b55e68fd41972878ff8d823f7dfcea6a23eeb1f"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczOTA0Nw==", "bodyText": "\u6211\u770b\u4e0b", "url": "https://github.com/alibaba/nacos/pull/3060#discussion_r439739047", "createdAt": "2020-06-13T13:22:01Z", "author": {"login": "paderlol"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/service/datasource/ExternalDataSourceProperties.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+package com.alibaba.nacos.config.server.service.datasource;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.springframework.boot.context.properties.bind.Bindable;\n+import org.springframework.boot.context.properties.bind.Binder;\n+import org.springframework.core.env.Environment;\n+\n+import com.google.common.base.Preconditions;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+/**\n+ * Properties of external DataSource\n+ *\n+ * @author Nacos\n+ */\n+public class ExternalDataSourceProperties {\n+\n+    private final static String JDBC_DRIVER_NAME = \"com.mysql.cj.jdbc.Driver\";\n+    public static final long CONNECTION_TIMEOUT_MS = 3000L;\n+    public static final long VALIDATION_TIMEOUT = 10L;\n+    public static final String TEST_QUERY = \"SELECT 1 FROM dual\";\n+    public static final int DEFAULT_MAX_POOL_SIZE = 20;\n+    public static final int DEFAULT_MINIMUM_IDLE = 50;\n+\n+    private Integer num;\n+    private List<String> url = new ArrayList<>();\n+    private List<String> user = new ArrayList<>();\n+    private List<String> password = new ArrayList<>();\n+    private List<Integer> maxPoolSize = new ArrayList<>();\n+    private List<Integer> minIdle = new ArrayList<>();\n+\n+    public void setNum(Integer num) {\n+        this.num = num;\n+    }\n+\n+    public void setUrl(List<String> url) {\n+        this.url = url;\n+    }\n+\n+    public void setUser(List<String> user) {\n+        this.user = user;\n+    }\n+\n+    public void setPassword(List<String> password) {\n+        this.password = password;\n+    }\n+\n+    public void setMaxPoolSize(List<Integer> maxPoolSize) {\n+        this.maxPoolSize = maxPoolSize;\n+    }\n+\n+    public void setMinIdle(List<Integer> minIdle) {\n+        this.minIdle = minIdle;\n+    }\n+\n+    /**\n+     *\n+     * @param environment\n+     *            {@link Environment}\n+     * @param callback\n+     *            Callback function when constructing data source\n+     * @return List of {@link HikariDataSource}\n+     */\n+    List<HikariDataSource> build(Environment environment, Callback<HikariDataSource> callback) {\n+        List<HikariDataSource> dataSources = new ArrayList<>();\n+        Binder.get(environment).bind(\"db\", Bindable.ofInstance(this));\n+        Preconditions.checkArgument(Objects.nonNull(num), \"db.num is null\");\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(user), \"db.user or db.user.[index] is null\");\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(password), \"db.password or db.password.[index] is null\");\n+        for (int index = 0; index < num; index++) {\n+            int currentSize = index + 1;\n+            Preconditions.checkArgument(url.size() >= currentSize, \"db.url.%s is null\", index);\n+            HikariDataSource ds = new HikariDataSource();\n+            ds.setDriverClassName(JDBC_DRIVER_NAME);\n+            ds.setJdbcUrl(url.get(index).trim());\n+            ds.setUsername(defaultIfNull(user, index, user.get(0)).trim());\n+            ds.setPassword(defaultIfNull(password, index, password.get(0)).trim());\n+            ds.setConnectionTimeout(CONNECTION_TIMEOUT_MS);\n+            ds.setMaximumPoolSize(defaultIfNull(maxPoolSize, index, DEFAULT_MAX_POOL_SIZE));\n+            ds.setMinimumIdle(defaultIfNull(minIdle, index, DEFAULT_MINIMUM_IDLE));\n+            // Check the connection pool every 10 minutes\n+            ds.setValidationTimeout(TimeUnit.MINUTES.toMillis(VALIDATION_TIMEOUT));\n+            ds.setConnectionTestQuery(TEST_QUERY);\n+            dataSources.add(ds);\n+            callback.accept(ds);\n+        }\n+        Preconditions.checkArgument(CollectionUtils.isNotEmpty(dataSources), \"no datasource available\");\n+        return dataSources;\n+    }\n+\n+    static <T> T defaultIfNull(List<T> collection, int index, T defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczNDYwNw=="}, "originalCommit": {"oid": "1b55e68fd41972878ff8d823f7dfcea6a23eeb1f"}, "originalPosition": 108}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4407, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}