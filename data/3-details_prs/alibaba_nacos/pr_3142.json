{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NjUzNzM1", "number": 3142, "title": "[ISSUE #3140]nacos-client module replace http client", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nnacos-client module replace http client\nBrief changelog\nfix: #3140 refer: #2858, #3192\n\n\nUnified use of httpclient\n\n\nuse nacosRestTemplate replace nacos-client module httpClient\n\n\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-06-22T03:07:58Z", "url": "https://github.com/alibaba/nacos/pull/3142", "merged": true, "mergeCommit": {"oid": "6ce8d8ca79d058485ff74cd8b896a44237a3f1ea"}, "closed": true, "closedAt": "2020-06-22T12:42:47Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctm2MwAH2gAyNDM3NjUzNzM1OjEyMmY4ZGQyMTMzMDdhODA3NWMwMDU2NjBlY2Q2ZmE0NjA4ZTk0MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctwM-CgFqTQzNDg4NDE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "122f8dd213307a8075c005660ecd6fa4608e9434", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/122f8dd213307a8075c005660ecd6fa4608e9434", "committedDate": "2020-06-22T01:48:16Z", "message": "nacos-client http client replace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c9c1facf8d2088cb27d5fed40bb8ad51be25aa9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/5c9c1facf8d2088cb27d5fed40bb8ad51be25aa9", "committedDate": "2020-06-22T02:58:27Z", "message": "Merge branch 'develop-upstrem' into refactor_http_client\n\n# Conflicts:\n#\tclient/src/main/java/com/alibaba/nacos/client/naming/net/NamingProxy.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e0347471722904387edd0f073e0ea19a38b9a28", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7e0347471722904387edd0f073e0ea19a38b9a28", "committedDate": "2020-06-22T03:37:34Z", "message": "Remove some explain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/c5eeff0cdaa04f1c86d80190987f05944214b103", "committedDate": "2020-06-22T03:39:10Z", "message": "Remove some explain"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NjgwOTM4", "url": "https://github.com/alibaba/nacos/pull/3142#pullrequestreview-434680938", "createdAt": "2020-06-22T07:50:55Z", "commit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzo1MDo1NlrOGm1i6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwODowNDoxN1rOGm1-Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3NjM2MQ==", "bodyText": "Do not change the indent.", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443376361", "createdAt": "2020-06-22T07:50:56Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java", "diffHunk": "@@ -49,7 +49,7 @@\n  * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n  */\n public enum BaseHttpMethod {\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3Njc0Ng==", "bodyText": "do not change indent please", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443376746", "createdAt": "2020-06-22T07:51:40Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java", "diffHunk": "@@ -34,21 +34,15 @@\n  * @author mai.jh\n  */\n public final class HttpClientBeanHolder {\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MTk1Mw==", "bodyText": "If the tmp variable is only used once, I suggest do not change.", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443381953", "createdAt": "2020-06-22T08:01:32Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "diffHunk": "@@ -78,14 +78,22 @@\n         String contentType = headers.getValue(HttpHeaderConsts.CONTENT_TYPE);\n         InputStream body = response.getBody();\n         T extractBody = null;\n+        boolean typeToStr = String.class.toString().equals(type.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MTk5Nw==", "bodyText": "If the tmp variable is only used once, I suggest do not change.", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443381997", "createdAt": "2020-06-22T08:01:37Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/handler/ResponseHandler.java", "diffHunk": "@@ -78,14 +78,22 @@\n         String contentType = headers.getValue(HttpHeaderConsts.CONTENT_TYPE);\n         InputStream body = response.getBody();\n         T extractBody = null;\n+        boolean typeToStr = String.class.toString().equals(type.toString());\n         if (contentType != null && contentType.startsWith(MediaType.APPLICATION_JSON) && HttpStatus.SC_OK == response\n-                .getStatusCode()) {\n-            extractBody = convert(body, type);\n+            .getStatusCode()) {\n+            // When the type is string type and the response contentType is [application/json],\n+            // then it should be serialized as string\n+            if (typeToStr) {\n+                extractBody = (T) IoUtils.toString(body, headers.getCharset());\n+            } else {\n+                extractBody = convert(body, type);\n+            }\n         }\n         if (extractBody == null) {\n-            if (!String.class.toString().equals(type.toString())) {\n+            if (!typeToStr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MzA0OA==", "bodyText": "What's the mean of From I read the method think it should be exchangeForm, is it?", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443383048", "createdAt": "2020-06-22T08:03:44Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java", "diffHunk": "@@ -298,7 +297,29 @@ public NacosRestTemplate(HttpClientRequest requestClient) {\n                 Query.newInstance().initParams(paramValues), bodyValues);\n         return execute(url, HttpMethod.POST, requestHttpEntity, responseType);\n     }\n-    \n+\n+    /**\n+     * Execute the HTTP method to the given URI template, writing the given request entity to the request, and\n+     * returns the response as {@link HttpRestResult}.\n+     *\n+     * @param url          url\n+     * @param header       http header param\n+     * @param paramValues  http query param\n+     * @param bodyValues   http body param\n+     * @param httpMethod   http method\n+     * @param responseType return type\n+     * @return {@link HttpRestResult}\n+     * @throws Exception ex\n+     */\n+    public <T> HttpRestResult<T> exchangeFrom(String url, Header header,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM4MzM2Ng==", "bodyText": "What's the mean of From I read the method think it should be putFrom, is it?", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443383366", "createdAt": "2020-06-22T08:04:17Z", "author": {"login": "KomachiSion"}, "path": "test/src/test/java/com/alibaba/nacos/test/naming/NamingBase.java", "diffHunk": "@@ -166,39 +170,32 @@ public static boolean verifyInstanceList(List<Instance> instanceList1, List<Inst\n         return true;\n     }\n \n-    public static void prepareServer(int localPort) {\n+    public static void prepareServer(int localPort) throws Exception{\n         prepareServer(localPort, \"UP\");\n     }\n \n-    public static void prepareServer(int localPort, String status) {\n+    public static void prepareServer(int localPort, String status) throws Exception {\n         String url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=overriddenServerStatus&value=\" + status;\n-        List<String> headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        HttpClient.HttpResult result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+        Header header = Header.newInstance();\n+        header.addParam(HttpHeaderConsts.USER_AGENT_HEADER, \"Nacos-Server\");\n+        HttpRestResult<String> result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);\n         System.out.println(result);\n-        Assert.assertEquals(HttpStatus.SC_OK, result.code);\n-\n+        Assert.assertEquals(HttpStatus.SC_OK, result.getCode());\n \n         url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=autoChangeHealthCheckEnabled&value=\" + false;\n-        headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+\n+        result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);\n         System.out.println(result);\n-        Assert.assertEquals(HttpStatus.SC_OK, result.code);\n+        Assert.assertEquals(HttpStatus.SC_OK, result.getCode());\n     }\n \n-    public static void destoryServer(int localPort) {\n+    public static void destoryServer(int localPort) throws Exception{\n         String url = \"http://127.0.0.1:\" + localPort + \"/nacos/v1/ns/operator/switches?entry=autoChangeHealthCheckEnabled&value=\" + true;\n-        List<String> headers = new ArrayList<String>();\n-        headers.add(HttpHeaderConsts.USER_AGENT_HEADER);\n-        headers.add(\"Nacos-Server\");\n-        HttpClient.HttpResult result =\n-            HttpClient.request(url, headers, new HashMap<String, String>(), StringUtils.EMPTY, \"UTF-8\", \"PUT\");\n+        Header header = Header.newInstance();\n+        header.addParam(HttpHeaderConsts.USER_AGENT_HEADER, \"Nacos-Server\");\n+\n+        HttpRestResult<String> result = nacosRestTemplate.putFrom(url, header, Query.EMPTY, new HashMap<>(), String.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5eeff0cdaa04f1c86d80190987f05944214b103"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0ae37587f1067b1c94553b9ac270451761b461bd", "committedDate": "2020-06-22T09:54:59Z", "message": "Adjust some code styles and fix some misspelled method names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODE2Nzg2", "url": "https://github.com/alibaba/nacos/pull/3142#pullrequestreview-434816786", "createdAt": "2020-06-22T10:59:12Z", "commit": {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDo1OToxMlrOGm70HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDo1OTo0NFrOGm71WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTA2OA==", "bodyText": "Do not change intend", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479068", "createdAt": "2020-06-22T10:59:12Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java", "diffHunk": "@@ -59,14 +59,14 @@ protected HttpRequestBase createRequest(String url) {\n             return new HttpGet(url);\n         }\n     },\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTI2NQ==", "bodyText": "Do not change indent", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479265", "createdAt": "2020-06-22T10:59:31Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanHolder.java", "diffHunk": "@@ -36,19 +36,13 @@\n public final class HttpClientBeanHolder {\n     \n     private static final Logger LOGGER = LoggerFactory.getLogger(HttpClientManager.class);\n-    \n-    private static final int TIMEOUT = Integer.getInteger(\"nacos.http.timeout\", 5000);\n-    \n-    private static final HttpClientConfig HTTP_CLIENT_CONFIG = HttpClientConfig.builder().setConTimeOutMillis(TIMEOUT)\n-            .setReadTimeOutMillis(TIMEOUT >> 1).build();\n-    \n+\n     private static final Map<String, NacosRestTemplate> SINGLETON_REST = new HashMap<String, NacosRestTemplate>(10);\n-    \n-    private static final Map<String, NacosAsyncRestTemplate> SINGLETON_ASYNC_REST = new HashMap<String, NacosAsyncRestTemplate>(\n-            10);\n-    \n+\n+    private static final Map<String, NacosAsyncRestTemplate> SINGLETON_ASYNC_REST = new HashMap<String, NacosAsyncRestTemplate>(10);\n+\n     private static final AtomicBoolean ALREADY_SHUTDOWN = new AtomicBoolean(false);\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ3OTM4NQ==", "bodyText": "Do not change indent", "url": "https://github.com/alibaba/nacos/pull/3142#discussion_r443479385", "createdAt": "2020-06-22T10:59:44Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/HttpClientResponse.java", "diffHunk": "@@ -26,39 +26,38 @@\n  * Represents a client-side HTTP response.\n  *\n  * @author mai.jh\n- * @date 2020/5/23\n  */\n public interface HttpClientResponse extends Closeable {\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae37587f1067b1c94553b9ac270451761b461bd"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "662f697b1181cc579615cbee77f1058bf1b5389b", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/662f697b1181cc579615cbee77f1058bf1b5389b", "committedDate": "2020-06-22T11:44:06Z", "message": "Fix code style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb245e15505673261ef72403cd7232a2e7d0473", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7eb245e15505673261ef72403cd7232a2e7d0473", "committedDate": "2020-06-22T11:57:26Z", "message": "fix some misspelled method names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ef0ca3fca9885dca94be6ebd2c4a59991a396b9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0ef0ca3fca9885dca94be6ebd2c4a59991a396b9", "committedDate": "2020-06-22T12:16:58Z", "message": "Fix code style issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODg0MTYw", "url": "https://github.com/alibaba/nacos/pull/3142#pullrequestreview-434884160", "createdAt": "2020-06-22T12:42:17Z", "commit": {"oid": "0ef0ca3fca9885dca94be6ebd2c4a59991a396b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4387, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}