{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMTc1MzEx", "number": 3198, "title": "[ISSUE #3197] NacosRestTemplate enhance", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nNacosRestTemplate enhance to meet the actual http client use\n#3197\nBrief changelog\n\n\nAdd some parameter configuration of http client to the request method\n\n\nAdd an interceptor for nacos resttemplate, can add some logic through the interceptor\n\n\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-06-29T03:33:07Z", "url": "https://github.com/alibaba/nacos/pull/3198", "merged": true, "mergeCommit": {"oid": "c1515b6940c0c8277818d46e6b00384635df7d31"}, "closed": true, "closedAt": "2020-07-13T05:55:28Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv4REZgH2gAyNDQxMTc1MzExOmUyY2ZjNzgxMTc3MjlmNzNmODk0MWEzNTYxN2Y5ZGZkNDZjMGNkNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0auNegFqTQ0Njk5MjUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2cfc78117729f73f8941a35617f9dfd46c0cd6e", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/e2cfc78117729f73f8941a35617f9dfd46c0cd6e", "committedDate": "2020-06-29T03:13:51Z", "message": "enhance nacosRestTemplate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/299b2f94ac1768096d3879b91803b88cf25cb190", "committedDate": "2020-06-29T03:26:55Z", "message": "enhance nacosRestTemplate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09aa8f97000982253ab4a673a6f4111035073b30", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/09aa8f97000982253ab4a673a6f4111035073b30", "committedDate": "2020-06-29T06:37:28Z", "message": "supplement throw exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTE4NDMy", "url": "https://github.com/alibaba/nacos/pull/3198#pullrequestreview-438918432", "createdAt": "2020-06-29T06:32:59Z", "commit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjozMjo1OVrOGqGhtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNzoyMToxNFrOGqHy1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwMDMxMA==", "bodyText": "I think the method name is not good.", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446800310", "createdAt": "2020-06-29T06:32:59Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/DefaultHttpClientRequest.java", "diffHunk": "@@ -69,7 +71,24 @@ static HttpRequestBase build(URI uri, String method, RequestHttpEntity requestHt\n         } else {\n             httpMethod.initEntity(requestHttpEntity.getBody(), headers.getValue(HttpHeaderConsts.CONTENT_TYPE));\n         }\n-        return httpMethod.getRequestBase();\n+        HttpRequestBase requestBase = httpMethod.getRequestBase();\n+        getConfig(requestBase, requestHttpEntity.getHttpClientConfig());\n+        return requestBase;\n+    }\n+    \n+    /**\n+     * Replace the HTTP config created by default with the HTTP config specified in the request\n+     *\n+     * @param requestBase requestBase\n+     * @param httpClientConfig http config\n+     */\n+    private static void getConfig(HttpRequestBase requestBase, HttpClientConfig httpClientConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNzc2Mw==", "bodyText": "iterator is a abstract name, use interceptors maybe better.", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446807763", "createdAt": "2020-06-29T06:51:52Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/InterceptingHttpClientRequest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.model.RequestHttpEntity;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Iterator;\n+\n+/**\n+ * Wrap http client request and perform corresponding interception\n+ *\n+ * @author mai.jh\n+ */\n+public class InterceptingHttpClientRequest implements HttpClientRequest {\n+    \n+    private final HttpClientRequest httpClientRequest;\n+    \n+    private final Iterator<HttpClientRequestInterceptor> iterator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMjk3OQ==", "bodyText": "change this constructer as this(null, header, query, null)?", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446812979", "createdAt": "2020-06-29T07:03:41Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/model/RequestHttpEntity.java", "diffHunk": "@@ -31,19 +32,36 @@\n     \n     private final Header headers = Header.newInstance();\n     \n+    private final HttpClientConfig httpClientConfig;\n+    \n     private final Query query;\n     \n     private Object body;\n     \n     public RequestHttpEntity(Header header, Query query) {\n         handleHeader(header);\n         this.query = query;\n+        this.httpClientConfig = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMzEyNA==", "bodyText": "change this constructer as this(httpClientConfig, header, query, null)?", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446813124", "createdAt": "2020-06-29T07:04:02Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/model/RequestHttpEntity.java", "diffHunk": "@@ -31,19 +32,36 @@\n     \n     private final Header headers = Header.newInstance();\n     \n+    private final HttpClientConfig httpClientConfig;\n+    \n     private final Query query;\n     \n     private Object body;\n     \n     public RequestHttpEntity(Header header, Query query) {\n         handleHeader(header);\n         this.query = query;\n+        this.httpClientConfig = null;\n+    }\n+    \n+    public RequestHttpEntity(HttpClientConfig httpClientConfig, Header header, Query query) {\n+        handleHeader(header);\n+        this.httpClientConfig = httpClientConfig;\n+        this.query = query;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxMzIyNw==", "bodyText": "change this constructer as this(null, header, query, body)?", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446813227", "createdAt": "2020-06-29T07:04:16Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/model/RequestHttpEntity.java", "diffHunk": "@@ -31,19 +32,36 @@\n     \n     private final Header headers = Header.newInstance();\n     \n+    private final HttpClientConfig httpClientConfig;\n+    \n     private final Query query;\n     \n     private Object body;\n     \n     public RequestHttpEntity(Header header, Query query) {\n         handleHeader(header);\n         this.query = query;\n+        this.httpClientConfig = null;\n+    }\n+    \n+    public RequestHttpEntity(HttpClientConfig httpClientConfig, Header header, Query query) {\n+        handleHeader(header);\n+        this.httpClientConfig = httpClientConfig;\n+        this.query = query;\n     }\n     \n     public RequestHttpEntity(Header header, Query query, Object body) {\n         handleHeader(header);\n         this.query = query;\n         this.body = body;\n+        this.httpClientConfig = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "299b2f94ac1768096d3879b91803b88cf25cb190"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyMTA3Ng==", "bodyText": "the Iterate method is too obscure, I suggest change this method.", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r446821076", "createdAt": "2020-06-29T07:21:14Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/InterceptingHttpClientRequest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http.client;\n+\n+import com.alibaba.nacos.common.model.RequestHttpEntity;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Iterator;\n+\n+/**\n+ * Wrap http client request and perform corresponding interception\n+ *\n+ * @author mai.jh\n+ */\n+public class InterceptingHttpClientRequest implements HttpClientRequest {\n+    \n+    private final HttpClientRequest httpClientRequest;\n+    \n+    private final Iterator<HttpClientRequestInterceptor> iterator;\n+    \n+    public InterceptingHttpClientRequest(HttpClientRequest httpClientRequest,\n+            Iterator<HttpClientRequestInterceptor> iterator) {\n+        this.httpClientRequest = httpClientRequest;\n+        this.iterator = iterator;\n+    }\n+    \n+    @Override\n+    public HttpClientResponse execute(URI uri, String httpMethod, RequestHttpEntity requestHttpEntity)\n+            throws Exception {\n+        if (iterator.hasNext()) {\n+            HttpClientRequestInterceptor nextInterceptor = iterator.next();\n+            return nextInterceptor.intercept(uri, httpMethod, requestHttpEntity, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09aa8f97000982253ab4a673a6f4111035073b30"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68bc5140271570307f83794695180bf4876ccb1b", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/68bc5140271570307f83794695180bf4876ccb1b", "committedDate": "2020-06-29T07:45:03Z", "message": "Modify the iterate method of the interceptor and modify some method name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTk5MDcx", "url": "https://github.com/alibaba/nacos/pull/3198#pullrequestreview-439599071", "createdAt": "2020-06-30T01:02:26Z", "commit": {"oid": "68bc5140271570307f83794695180bf4876ccb1b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6346c3247328f9579bbdfce0ae837819b563d7", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0a6346c3247328f9579bbdfce0ae837819b563d7", "committedDate": "2020-07-10T08:37:02Z", "message": "Adjust the way to get HttpClientRequest implement in NacosRestTempalte"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19409ea93d8fd5a1e746d21f2f520ed56dce865", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/d19409ea93d8fd5a1e746d21f2f520ed56dce865", "committedDate": "2020-07-11T02:36:10Z", "message": "Merge branch 'develop-upstrem' into nacos_resttemplate_enhance\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0888f88b53f83b2e034dc9faa10e9f13bc354b", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/cc0888f88b53f83b2e034dc9faa10e9f13bc354b", "committedDate": "2020-07-11T02:50:07Z", "message": "Fix code style issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4038d769034a109682c223d7e2e3e6c867d7ba", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0b4038d769034a109682c223d7e2e3e6c867d7ba", "committedDate": "2020-07-11T02:50:40Z", "message": "Fix code style issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5caa7c89ec5542904d642a63e220b9eeeb6b1ba9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/5caa7c89ec5542904d642a63e220b9eeeb6b1ba9", "committedDate": "2020-07-11T03:03:09Z", "message": "Fix code style issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2abb429da398d56943c98b5fd071e6e6071367c4", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/2abb429da398d56943c98b5fd071e6e6071367c4", "committedDate": "2020-07-11T03:24:31Z", "message": "Fix code style issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTMxNjk1", "url": "https://github.com/alibaba/nacos/pull/3198#pullrequestreview-446931695", "createdAt": "2020-07-13T01:16:54Z", "commit": {"oid": "2abb429da398d56943c98b5fd071e6e6071367c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToxNjo1NFrOGwYuAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToxNjo1NFrOGwYuAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM4OTgyNQ==", "bodyText": "Should we print the interceptor name or class name?", "url": "https://github.com/alibaba/nacos/pull/3198#discussion_r453389825", "createdAt": "2020-07-13T01:16:54Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java", "diffHunk": "@@ -336,6 +460,16 @@ public NacosRestTemplate(HttpClientRequest requestClient) {\n         }\n     }\n     \n+    private HttpClientRequest requestClient() {\n+        if (CollectionUtils.isNotEmpty(interceptors)) {\n+            if (LOGGER.isDebugEnabled()) {\n+                LOGGER.debug(\"Execute via interceptor\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abb429da398d56943c98b5fd071e6e6071367c4"}, "originalPosition": 204}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daee2739936724b9b970f8fc8f9db3299b5a768e", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/daee2739936724b9b970f8fc8f9db3299b5a768e", "committedDate": "2020-07-13T03:22:52Z", "message": "Log output change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d167fcb20493f6ee73ee11afe57fbe48e64b555d", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/d167fcb20493f6ee73ee11afe57fbe48e64b555d", "committedDate": "2020-07-13T05:10:46Z", "message": "Merge branch 'develop-upstrem' into nacos_resttemplate_enhance\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/client/NacosRestTemplate.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTg5NDk5", "url": "https://github.com/alibaba/nacos/pull/3198#pullrequestreview-446989499", "createdAt": "2020-07-13T05:28:22Z", "commit": {"oid": "d167fcb20493f6ee73ee11afe57fbe48e64b555d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTkyNTE5", "url": "https://github.com/alibaba/nacos/pull/3198#pullrequestreview-446992519", "createdAt": "2020-07-13T05:38:09Z", "commit": {"oid": "d167fcb20493f6ee73ee11afe57fbe48e64b555d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4400, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}