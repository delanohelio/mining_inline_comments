{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NzAyNzE4", "number": 3095, "title": "[ISSUE #3094]abstract create nacos restTemplate factory", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nfix: #3094\nWhen using nacos templates,can customize common parameters of http client, such as timeout time and connection time.\n\nAdd HttpClientFactory interface to create NacosRestTemplate and NacosAsyncRestTemplate\nAbstract the AbstractHttpClientFactoryWrapper class, encapsulate the method created, provide custom http client config method\nDefines a unified http client config class\nDefines the tool class creates NacosRestTemplate and NacosAsyncRestTemplate\n\nBrief changelog\nXX\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-06-17T08:53:23Z", "url": "https://github.com/alibaba/nacos/pull/3095", "merged": true, "mergeCommit": {"oid": "e528ea82e9b0b6343e3c855a2de8b9c7119e9400"}, "closed": true, "closedAt": "2020-06-17T09:53:38Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsE_q_gH2gAyNDM1NzAyNzE4OmY2NzlmNTNiM2NlMTQ4NDA1NGNiOWVmODM5ODFkZGE5OGVhY2RjMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsGjBZAFqTQzMjIyODY2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f679f53b3ce1484054cb9ef83981dda98eacdc28", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/f679f53b3ce1484054cb9ef83981dda98eacdc28", "committedDate": "2020-06-17T07:47:55Z", "message": "abstract create nacos restTemplate factory, allowing users to customize the commonly used http client config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f102545224af750e44f38cefeeea69015f4e11b4", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/f102545224af750e44f38cefeeea69015f4e11b4", "committedDate": "2020-06-17T07:56:43Z", "message": "Merge branch 'develop-upstream' into refactor_http_client\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/HttpClientManager.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e75be735ffaf3c3482149195cb48e0715fbb8c1", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0e75be735ffaf3c3482149195cb48e0715fbb8c1", "committedDate": "2020-06-17T08:03:33Z", "message": "add class file license."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc", "committedDate": "2020-06-17T08:45:32Z", "message": "change class file name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjAzNTA0", "url": "https://github.com/alibaba/nacos/pull/3095#pullrequestreview-432203504", "createdAt": "2020-06-17T09:04:46Z", "commit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwOTowNDo0N1rOGk8rDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwOToyMjo0MlrOGk9V2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5NTk4MQ==", "bodyText": "Maybe rename to HttpClientBeanCache or HttpClientBeanHolder will be better.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441395981", "createdAt": "2020-06-17T09:04:47Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanFactory.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http;\n+\n+import com.alibaba.nacos.common.http.client.NacosAsyncRestTemplate;\n+import com.alibaba.nacos.common.http.client.NacosRestTemplate;\n+import com.alibaba.nacos.common.utils.ExceptionUtil;\n+import com.alibaba.nacos.common.utils.ThreadUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Create a rest template\n+ * to ensure that each custom client config and rest template are in one-to-one correspondence\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/16\n+ */\n+@SuppressWarnings(\"all\")\n+public final class HttpClientBeanFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5NzE4OQ==", "bodyText": "merge these line to single line to remove tmp variable.\nlike return getNacosRestTemplate(new DefaultHttpClientConfig());", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441397189", "createdAt": "2020-06-17T09:06:45Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanFactory.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http;\n+\n+import com.alibaba.nacos.common.http.client.NacosAsyncRestTemplate;\n+import com.alibaba.nacos.common.http.client.NacosRestTemplate;\n+import com.alibaba.nacos.common.utils.ExceptionUtil;\n+import com.alibaba.nacos.common.utils.ThreadUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Create a rest template\n+ * to ensure that each custom client config and rest template are in one-to-one correspondence\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/16\n+ */\n+@SuppressWarnings(\"all\")\n+public final class HttpClientBeanFactory {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HttpClientManager.class);\n+\n+    private static final int TIMEOUT = Integer.getInteger(\"nacos.http.timeout\", 5000);\n+\n+    private static HttpClientConfig HTTP_CLIENT_CONFIG = HttpClientConfig.builder()\n+        .setConTimeOutMillis(TIMEOUT).setReadTimeOutMillis(TIMEOUT >> 1).build();\n+\n+    private static final Map<String, NacosRestTemplate> singletonRest = new HashMap<String, NacosRestTemplate>(10);\n+    private static final Map<String, NacosAsyncRestTemplate> singletonAsyncRest = new HashMap<String, NacosAsyncRestTemplate>(10);\n+\n+    private static final AtomicBoolean alreadyShutdown = new AtomicBoolean(false);\n+\n+    static {\n+        ThreadUtils.addShutdownHook(new Runnable() {\n+            @Override\n+            public void run() {\n+                shutdown();\n+            }\n+        });\n+    }\n+\n+    public static NacosRestTemplate getNacosRestTemplate() {\n+        HttpClientFactory httpClientFactory = new DefaultHttpClientConfig();\n+        return getNacosRestTemplate(httpClientFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5ODAwNQ==", "bodyText": "Same as above description.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441398005", "createdAt": "2020-06-17T09:08:10Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientBeanFactory.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http;\n+\n+import com.alibaba.nacos.common.http.client.NacosAsyncRestTemplate;\n+import com.alibaba.nacos.common.http.client.NacosRestTemplate;\n+import com.alibaba.nacos.common.utils.ExceptionUtil;\n+import com.alibaba.nacos.common.utils.ThreadUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Create a rest template\n+ * to ensure that each custom client config and rest template are in one-to-one correspondence\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/16\n+ */\n+@SuppressWarnings(\"all\")\n+public final class HttpClientBeanFactory {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HttpClientManager.class);\n+\n+    private static final int TIMEOUT = Integer.getInteger(\"nacos.http.timeout\", 5000);\n+\n+    private static HttpClientConfig HTTP_CLIENT_CONFIG = HttpClientConfig.builder()\n+        .setConTimeOutMillis(TIMEOUT).setReadTimeOutMillis(TIMEOUT >> 1).build();\n+\n+    private static final Map<String, NacosRestTemplate> singletonRest = new HashMap<String, NacosRestTemplate>(10);\n+    private static final Map<String, NacosAsyncRestTemplate> singletonAsyncRest = new HashMap<String, NacosAsyncRestTemplate>(10);\n+\n+    private static final AtomicBoolean alreadyShutdown = new AtomicBoolean(false);\n+\n+    static {\n+        ThreadUtils.addShutdownHook(new Runnable() {\n+            @Override\n+            public void run() {\n+                shutdown();\n+            }\n+        });\n+    }\n+\n+    public static NacosRestTemplate getNacosRestTemplate() {\n+        HttpClientFactory httpClientFactory = new DefaultHttpClientConfig();\n+        return getNacosRestTemplate(httpClientFactory);\n+    }\n+\n+    public static NacosRestTemplate getNacosRestTemplate(HttpClientFactory httpClientFactory) {\n+        if (httpClientFactory == null) {\n+            throw new NullPointerException(\"httpClientFactory is null\");\n+        }\n+        String factoryName = httpClientFactory.getClass().getName();\n+        NacosRestTemplate nacosRestTemplate = singletonRest.get(factoryName);\n+        if (nacosRestTemplate == null) {\n+            synchronized (singletonRest) {\n+                nacosRestTemplate = singletonRest.get(factoryName);\n+                if (nacosRestTemplate != null) {\n+                    return nacosRestTemplate;\n+                }\n+                nacosRestTemplate = httpClientFactory.createNacosRestTemplate();\n+                singletonRest.put(factoryName, nacosRestTemplate);\n+            }\n+        }\n+        return nacosRestTemplate;\n+    }\n+\n+    public static NacosAsyncRestTemplate getNacosAsyncRestTemplate() {\n+        HttpClientFactory httpClientFactory = new DefaultHttpClientConfig();\n+        return getNacosAsyncRestTemplate(httpClientFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNDQ3Ng==", "bodyText": "AbstractHttpClientFactory is enough.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441404476", "createdAt": "2020-06-17T09:18:42Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactoryWrapper.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http;\n+\n+import com.alibaba.nacos.common.http.client.DefaultAsyncHttpClientRequest;\n+import com.alibaba.nacos.common.http.client.DefaultHttpClientRequest;\n+import com.alibaba.nacos.common.http.client.NacosAsyncRestTemplate;\n+import com.alibaba.nacos.common.http.client.NacosRestTemplate;\n+import org.apache.http.client.config.RequestConfig;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.impl.nio.client.HttpAsyncClients;\n+\n+/**\n+ * AbstractHttpClientFactory\n+ * Let the creator only specify the http client config\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/15\n+ */\n+public abstract class AbstractHttpClientFactoryWrapper implements HttpClientFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNDk1NQ==", "bodyText": "NamingHttpClientFactory will be better. NamingHttpClientConfig make other think it is a config pojo.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441404955", "createdAt": "2020-06-17T09:19:33Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/naming/net/NamingHttpClientManager.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.client.naming.net;\n+\n+import com.alibaba.nacos.common.http.*;\n+import com.alibaba.nacos.common.http.client.NacosRestTemplate;\n+\n+/**\n+ * http Manager\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/14\n+ */\n+public class NamingHttpClientManager {\n+\n+    private static final int READ_TIME_OUT_MILLIS = Integer\n+        .getInteger(\"com.alibaba.nacos.client.naming.rtimeout\", 50000);\n+    private static final int CON_TIME_OUT_MILLIS = Integer\n+        .getInteger(\"com.alibaba.nacos.client.naming.ctimeout\", 3000);\n+    private static final boolean ENABLE_HTTPS = Boolean\n+        .getBoolean(\"com.alibaba.nacos.client.naming.tls.enable\");\n+    private static final int MAX_REDIRECTS = 5;\n+\n+    private static final HttpClientFactory HTTP_CLIENT_FACTORY = new NamingHttpClientConfig();\n+\n+    public static String getPrefix() {\n+        if (ENABLE_HTTPS) {\n+            return \"https://\";\n+        }\n+        return \"http://\";\n+    }\n+\n+    public static NacosRestTemplate getNacosRestTemplate() {\n+        return HttpClientBeanFactory.getNacosRestTemplate(HTTP_CLIENT_FACTORY);\n+    }\n+\n+    private static class NamingHttpClientConfig extends AbstractHttpClientFactoryWrapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNTU3Nw==", "bodyText": "Same problem as NamingHttpClientConfig. DefaultHttpClientFactory will be better.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441405577", "createdAt": "2020-06-17T09:20:28Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/DefaultHttpClientConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.common.http;\n+\n+/**\n+ * default http client factory\n+ *\n+ * @author mai.jh\n+ * @date 2020/6/15\n+ */\n+public class DefaultHttpClientConfig extends AbstractHttpClientFactoryWrapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNjkzOA==", "bodyText": "Why add this two blank line? Please remove.", "url": "https://github.com/alibaba/nacos/pull/3095#discussion_r441406938", "createdAt": "2020-06-17T09:22:42Z", "author": {"login": "KomachiSion"}, "path": "example/src/main/java/com/alibaba/nacos/example/NamingExample.java", "diffHunk": "@@ -55,4 +55,6 @@ public void onEvent(Event event) {\n             }\n         });\n     }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a135e9fd42281b6cfc6cb39fd40263be8d4cc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b2b4fe2574d41f608936fd33962fc9f32a06b6", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/49b2b4fe2574d41f608936fd33962fc9f32a06b6", "committedDate": "2020-06-17T09:33:11Z", "message": "Adjust some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjI4NjY5", "url": "https://github.com/alibaba/nacos/pull/3095#pullrequestreview-432228669", "createdAt": "2020-06-17T09:36:26Z", "commit": {"oid": "49b2b4fe2574d41f608936fd33962fc9f32a06b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4367, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}