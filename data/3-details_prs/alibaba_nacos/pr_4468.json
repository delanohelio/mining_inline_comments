{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4MjE0MTkx", "number": 4468, "title": "[ISSUE-#4467] Fix snowflake id problem", "bodyText": "What is the purpose of the change\nFix-#4467", "createdAt": "2020-12-12T14:45:35Z", "url": "https://github.com/alibaba/nacos/pull/4468", "merged": true, "mergeCommit": {"oid": "2546f052e4e23fa4d49b6b398628c441af0c6a10"}, "closed": true, "closedAt": "2020-12-15T04:56:06Z", "author": {"login": "horizonzy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdl8B27AFqTU1MTAwMDM3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmQYvsAFqTU1MjA0NDkyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDAwMzc5", "url": "https://github.com/alibaba/nacos/pull/4468#pullrequestreview-551000379", "createdAt": "2020-12-14T02:07:38Z", "commit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMjowNzozOVrOIE9AkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMjowNzozOVrOIE9AkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA==", "bodyText": "Bad implementation I think. If oldInstance exist, only use instance id of old instance, can't change instanceId.\nThe original implementation also has some problem", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542064784", "createdAt": "2020-12-14T02:07:39Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8335d9e3edb5d9b728e4e77e632277157bc09137", "author": {"user": {"login": "horizonzy", "name": "\u8d75\u5ef6"}}, "url": "https://github.com/alibaba/nacos/commit/8335d9e3edb5d9b728e4e77e632277157bc09137", "committedDate": "2020-12-14T15:48:32Z", "message": "fix snowflake id problem"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a", "author": {"user": {"login": "horizonzy", "name": "\u8d75\u5ef6"}}, "url": "https://github.com/alibaba/nacos/commit/241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a", "committedDate": "2020-12-12T14:37:38Z", "message": "fix snowflake id problem"}, "afterCommit": {"oid": "8335d9e3edb5d9b728e4e77e632277157bc09137", "author": {"user": {"login": "horizonzy", "name": "\u8d75\u5ef6"}}, "url": "https://github.com/alibaba/nacos/commit/8335d9e3edb5d9b728e4e77e632277157bc09137", "committedDate": "2020-12-14T15:48:32Z", "message": "fix snowflake id problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97336186716b818842fe700c30802760ed9aac90", "author": {"user": {"login": "horizonzy", "name": "\u8d75\u5ef6"}}, "url": "https://github.com/alibaba/nacos/commit/97336186716b818842fe700c30802760ed9aac90", "committedDate": "2020-12-14T15:51:43Z", "message": "revert code format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMDQ0OTI1", "url": "https://github.com/alibaba/nacos/pull/4468#pullrequestreview-552044925", "createdAt": "2020-12-15T01:51:52Z", "commit": {"oid": "97336186716b818842fe700c30802760ed9aac90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4062, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}