{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNzk3ODAx", "number": 2841, "title": "Feature 1.3.0 beta grpc", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\n#2840\nBrief changelog\nXX\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-05-20T14:43:15Z", "url": "https://github.com/alibaba/nacos/pull/2841", "merged": true, "mergeCommit": {"oid": "e9f1e8fb981713b3824bc742292829eb962aeded"}, "closed": true, "closedAt": "2020-05-24T05:58:43Z", "author": {"login": "chuntaojun"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcf3c6zAH2gAyNDIwNzk3ODAxOmZhNTc2OTM4MWMyYWI5Nzc0NDM5MmJmMWUwNjM2Y2U5NWE2NjU2YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckG_KzgH2gAyNDIwNzk3ODAxOjBlNTJkMDQ1N2NhMWJlOTRlNWNiYzNiMWE2ZWIzMWJjOGEzYzcyZjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa5769381c2ab97744392bf1e0636ce95a6656af", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/fa5769381c2ab97744392bf1e0636ce95a6656af", "committedDate": "2020-05-10T09:14:06Z", "message": "feat: jraft use grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4871eff3363a2fdb13cd83ef6eb138f441704a79", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/4871eff3363a2fdb13cd83ef6eb138f441704a79", "committedDate": "2020-05-11T10:02:09Z", "message": "fix: nonr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "588b184ce29c4c4092051871fd1a56abd5c35aa3", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/588b184ce29c4c4092051871fd1a56abd5c35aa3", "committedDate": "2020-05-11T10:02:28Z", "message": "fix: none"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f921225ad61d8445411bbe53969d4d20a94ca10", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/5f921225ad61d8445411bbe53969d4d20a94ca10", "committedDate": "2020-05-11T12:21:11Z", "message": "feat: use jraft-grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e231590335c4df0a377f004a182d9424f3598e07", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/e231590335c4df0a377f004a182d9424f3598e07", "committedDate": "2020-05-14T06:38:46Z", "message": "fix: grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c6a03724aec5db983bb9287be6f4a19d11612a4", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/0c6a03724aec5db983bb9287be6f4a19d11612a4", "committedDate": "2020-05-14T08:25:41Z", "message": "fix: fix grpc-version bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08623c9ef32870a13a81a5ba561d5e1bc74b6d32", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/08623c9ef32870a13a81a5ba561d5e1bc74b6d32", "committedDate": "2020-05-14T10:10:40Z", "message": "refactor: support grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2de3c0ea41aeb4cdb245652ed9210272974da2", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/bc2de3c0ea41aeb4cdb245652ed9210272974da2", "committedDate": "2020-05-14T11:56:15Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into feature_1.3.0_beta_grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5af8229633c1935e69f1ce116b5c9fe06bc63bd", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/f5af8229633c1935e69f1ce116b5c9fe06bc63bd", "committedDate": "2020-05-14T12:35:32Z", "message": "refactor: merge develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b86f633c8a0ad49efc85d5f5b83c7a0cc8d33c27", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/b86f633c8a0ad49efc85d5f5b83c7a0cc8d33c27", "committedDate": "2020-05-16T06:36:49Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into feature_1.3.0_beta_grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07dd129dd0feb6beb40d01127093eabaced569b2", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/07dd129dd0feb6beb40d01127093eabaced569b2", "committedDate": "2020-05-17T08:22:49Z", "message": "refactor: fixed instance information update heartbeat information not updating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "587a0937c9c506bc3a4447f247697c9e786ca61c", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/587a0937c9c506bc3a4447f247697c9e786ca61c", "committedDate": "2020-05-17T15:13:40Z", "message": "refactor: perform consistency logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f39cc8d75e30332845563cee99766b942c26e26", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/5f39cc8d75e30332845563cee99766b942c26e26", "committedDate": "2020-05-18T03:00:11Z", "message": "refactor: jraft protocol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ac48059cbf3fb8323ac48d3788473f3e07c7987", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/5ac48059cbf3fb8323ac48d3788473f3e07c7987", "committedDate": "2020-05-18T07:45:20Z", "message": "fix: fixed future.join blocking thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e467b26ef67d02c994f75f0859bdc05c15f67cb7", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/e467b26ef67d02c994f75f0859bdc05c15f67cb7", "committedDate": "2020-05-19T03:21:00Z", "message": "style: fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ff9031c512c1caadca7535f0f1f97df5c7b66c", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/c6ff9031c512c1caadca7535f0f1f97df5c7b66c", "committedDate": "2020-05-20T14:47:54Z", "message": "refactor: remove extraneous code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTExOTUy", "url": "https://github.com/alibaba/nacos/pull/2841#pullrequestreview-415911952", "createdAt": "2020-05-21T06:36:49Z", "commit": {"oid": "c6ff9031c512c1caadca7535f0f1f97df5c7b66c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNjozNjo0OVrOGYn39Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNjozNjo0OVrOGYn39Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ3MjMwOQ==", "bodyText": "Using logger is better way, right ?", "url": "https://github.com/alibaba/nacos/pull/2841#discussion_r428472309", "createdAt": "2020-05-21T06:36:49Z", "author": {"login": "EasonFeng5870"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/filter/TransferToLeaderFilter.java", "diffHunk": "@@ -174,6 +174,9 @@ public void doFilter(ServletRequest request, ServletResponse response,\n \t\t\t\t\tString headerName = headerNames.nextElement();\n \t\t\t\t\theaders.set(headerName, req.getHeader(headerName));\n \t\t\t\t}\n+\n+\t\t\t\tSystem.out.println(reqUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6ff9031c512c1caadca7535f0f1f97df5c7b66c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c615699933dcc0eadc9f99d9c87a8e947df88571", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/c615699933dcc0eadc9f99d9c87a8e947df88571", "committedDate": "2020-05-21T06:53:23Z", "message": "refactor: removes the request forwarding logic for the configuration module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87a32a926bb7c3fa1b6b6f07ccd5ba9bdb9b728b", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/87a32a926bb7c3fa1b6b6f07ccd5ba9bdb9b728b", "committedDate": "2020-05-21T10:08:29Z", "message": "refactor: merge develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "451351cfc0ceae3cd82d6aff96ad8c05d791a991", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/451351cfc0ceae3cd82d6aff96ad8c05d791a991", "committedDate": "2020-05-21T12:28:32Z", "message": "refactor: optimize message publishers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be75c582c2798a5d58cac0af58847e2704190662", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/be75c582c2798a5d58cac0af58847e2704190662", "committedDate": "2020-05-21T14:09:10Z", "message": "Merge remote-tracking branch 'origin' into feature_1.3.0_beta_grpc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e52484a464cbbcd2b3644e09b9724599f23a2b8", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/5e52484a464cbbcd2b3644e09b9724599f23a2b8", "committedDate": "2020-05-21T14:11:43Z", "message": "refactor: removes the Http forward for the configuration module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Njg5MDU1", "url": "https://github.com/alibaba/nacos/pull/2841#pullrequestreview-416689055", "createdAt": "2020-05-22T06:59:16Z", "commit": {"oid": "5e52484a464cbbcd2b3644e09b9724599f23a2b8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNjo1OToxNlrOGZMsrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzowOToyN1rOGZM67A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3NTYzMQ==", "bodyText": "Here, you can print the expcetion error info.", "url": "https://github.com/alibaba/nacos/pull/2841#discussion_r429075631", "createdAt": "2020-05-22T06:59:16Z", "author": {"login": "zongtanghu"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/HttpClientManager.java", "diffHunk": "@@ -69,4 +66,18 @@ public static NAsyncHttpClient getAsyncHttpClient() {\n \t\treturn ASYNC_HTTP_CLIENT;\n \t}\n \n+\tpublic static void shutdown() {\n+\t\tif (!alreadyShutdown.compareAndSet(false, true)) {\n+\t\t\treturn;\n+\t\t}\n+\t\tlogger.warn(\"[HttpClientManager] Start destroying HttpClient\");\n+\t\ttry {\n+\t\t\tSYNC_HTTP_CLIENT.close();\n+\t\t\tASYNC_HTTP_CLIENT.close();\n+\t\t}\n+\t\tcatch (Exception ignore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e52484a464cbbcd2b3644e09b9724599f23a2b8"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3ODI1MQ==", "bodyText": "This variabler's meaning is uncertain.Maybe, isOpenService, is better.", "url": "https://github.com/alibaba/nacos/pull/2841#discussion_r429078251", "createdAt": "2020-05-22T07:06:33Z", "author": {"login": "zongtanghu"}, "path": "config/src/main/java/com/alibaba/nacos/config/server/filter/CurcuitFilter.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.config.server.filter;\n+\n+import com.alibaba.nacos.common.utils.ExceptionUtil;\n+import com.alibaba.nacos.common.utils.Observable;\n+import com.alibaba.nacos.common.utils.Observer;\n+import com.alibaba.nacos.config.server.constant.Constants;\n+import com.alibaba.nacos.config.server.model.event.RaftDBErrorEvent;\n+import com.alibaba.nacos.config.server.model.event.RaftDBErrorRecoverEvent;\n+import com.alibaba.nacos.consistency.cp.CPProtocol;\n+import com.alibaba.nacos.core.cluster.Member;\n+import com.alibaba.nacos.core.cluster.MemberMetaDataConstants;\n+import com.alibaba.nacos.core.cluster.ServerMemberManager;\n+import com.alibaba.nacos.core.code.ControllerMethodsCache;\n+import com.alibaba.nacos.core.notify.Event;\n+import com.alibaba.nacos.core.notify.NotifyCenter;\n+import com.alibaba.nacos.core.notify.listener.SmartSubscribe;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import javax.annotation.PostConstruct;\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.security.AccessControlException;\n+import java.util.List;\n+\n+/**\n+ * If the embedded distributed storage is enabled, all requests are routed to the Leader\n+ * node for processing, and the maximum number of forwards for a single request cannot\n+ * exceed three\n+ *\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+@SuppressWarnings(\"all\")\n+public class CurcuitFilter implements Filter {\n+\n+\t@Autowired\n+\tprivate ServerMemberManager memberManager;\n+\n+\t@Autowired\n+\tprivate CPProtocol protocol;\n+\n+\t@Autowired\n+\tprivate ControllerMethodsCache controllerMethodsCache;\n+\n+\tprivate volatile boolean downgrading = false;\n+\tprivate volatile boolean openService = false;\n+\n+\t@PostConstruct\n+\tprotected void init() {\n+\t\tlistenerSelfInCluster();\n+\t\tregisterSubscribe();\n+\t}\n+\n+\t@Override\n+\tpublic void doFilter(ServletRequest request, ServletResponse response,\n+\t\t\tFilterChain chain) throws IOException, ServletException {\n+\n+\t\tHttpServletRequest req = (HttpServletRequest) request;\n+\t\tHttpServletResponse resp = (HttpServletResponse) response;\n+\n+\t\tif (!openService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e52484a464cbbcd2b3644e09b9724599f23a2b8"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3OTI3Ng==", "bodyText": "Maybe, the class name can be changed to ProtobufSerializer is better!", "url": "https://github.com/alibaba/nacos/pull/2841#discussion_r429079276", "createdAt": "2020-05-22T07:09:27Z", "author": {"login": "zongtanghu"}, "path": "consistency/src/main/java/com/alibaba/nacos/consistency/utils/ProtobufUtils.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ *\n+ *  * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *  *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  * you may not use this file except in compliance with the License.\n+ *  * You may obtain a copy of the License at\n+ *  *\n+ *  *      http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * Unless required by applicable law or agreed to in writing, software\n+ *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  * See the License for the specific language governing permissions and\n+ *  * limitations under the License.\n+ *\n+ */\n+\n+package com.alibaba.nacos.consistency.utils;\n+\n+import com.alibaba.nacos.consistency.entity.GetRequest;\n+import com.alibaba.nacos.consistency.entity.Log;\n+import com.alibaba.nacos.consistency.exception.ConsistencyException;\n+import com.google.protobuf.Message;\n+\n+/**\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+public final class ProtobufUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e52484a464cbbcd2b3644e09b9724599f23a2b8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41703f98051e61e36ca47cc48247568064a3a3e3", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/41703f98051e61e36ca47cc48247568064a3a3e3", "committedDate": "2020-05-22T15:12:50Z", "message": "refactor: code optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3368396ae37841f6690da8c1d7080242dd04c27", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/b3368396ae37841f6690da8c1d7080242dd04c27", "committedDate": "2020-05-22T15:40:18Z", "message": "refactor: remove libs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6426440a8e65de246f7bd00929b4e61289289351", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/6426440a8e65de246f7bd00929b4e61289289351", "committedDate": "2020-05-23T06:33:56Z", "message": "refactor: code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e52d0457ca1be94e5cbc3b1a6eb31bc8a3c72f9", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/0e52d0457ca1be94e5cbc3b1a6eb31bc8a3c72f9", "committedDate": "2020-05-23T13:35:47Z", "message": "refactor: modify method name to avoid ambiguity"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4448, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}