{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5OTMzOTk0", "number": 3637, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NDowN1rOEZzApg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMjoyNTo1MlrOEZ9BhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDg1NjA2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/com/alibaba/nacos/api/naming/pojo/ServiceInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NDowN1rOHC00cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NDowN1rOHC00cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNDU5NQ==", "bodyText": "fail count should not be attribute of ServiceInfo. It should be maintained in UpdateTask.", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472724595", "createdAt": "2020-08-19T05:44:07Z", "author": {"login": "KomachiSion"}, "path": "api/src/main/java/com/alibaba/nacos/api/naming/pojo/ServiceInfo.java", "diffHunk": "@@ -48,6 +48,8 @@\n     \n     private long cacheMillis = 1000L;\n     \n+    private long failCount = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDg2NjE2OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NjozNlrOHC068w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NjozNlrOHC068w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNjI1OQ==", "bodyText": "The exception delay time should be calculate in catch\nAnd the algorithm should be enhance. Such as double time then last time. And the max delay time is not more than 60s.", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472726259", "createdAt": "2020-08-19T05:46:36Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "diffHunk": "@@ -411,7 +412,7 @@ public void run() {\n                     return;\n                 }\n                 \n-                delayTime = serviceObj.getCacheMillis();\n+                delayTime = serviceObj.getCacheMillis() + Math.min(serviceObj.getFailCount() * 1000L, 10000L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDg3MDMwOnYy", "diffSide": "RIGHT", "path": "naming/src/main/java/com/alibaba/nacos/naming/controllers/InstanceController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NzozNlrOHC09iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNTo0NzozNlrOHC09iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcyNjkyMQ==", "bodyText": "If updPort > 0 , it should be pushCacheMillis.\nSee the logic in 541 line.", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472726921", "createdAt": "2020-08-19T05:47:36Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/controllers/InstanceController.java", "diffHunk": "@@ -516,21 +516,21 @@ public ObjectNode doSrvIpxt(String namespaceId, String serviceName, String agent\n         ClientInfo clientInfo = new ClientInfo(agent);\n         ObjectNode result = JacksonUtils.createEmptyJsonNode();\n         Service service = serviceManager.getService(namespaceId, serviceName);\n-        \n+        long cacheMillis = switchDomain.getDefaultCacheMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787ad9301ceeeb8531a2dfbcb5f10a9bf4c18e6b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NjQ5NjY5OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMjoyNTo1MlrOHDE9EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjoyMjozNVrOHDm6sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4ODk0NA==", "bodyText": "The implementation may cause delayTime << failCount become negative number when failCount=54.", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r472988944", "createdAt": "2020-08-19T12:25:52Z", "author": {"login": "KomachiSion"}, "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "diffHunk": "@@ -412,12 +419,14 @@ public void run() {\n                 }\n                 \n                 delayTime = serviceObj.getCacheMillis();\n-                \n+                failCount = 0;\n             } catch (Throwable e) {\n+                failCount++;\n                 NAMING_LOGGER.warn(\"[NA] failed to update serviceName: \" + serviceName, e);\n             } finally {\n                 if (delayTime > 0) {\n-                    executor.schedule(this, delayTime, TimeUnit.MILLISECONDS);\n+                    executor.schedule(this, Math.min(delayTime << failCount, DEFAULT_DELAY * 60),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f21aceb9c4a60a85d0202c5c1b6464a8054b6a78"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0NTM5Mw==", "bodyText": "now, the failCunt cat't limit 6.", "url": "https://github.com/alibaba/nacos/pull/3637#discussion_r473545393", "createdAt": "2020-08-20T02:22:35Z", "author": {"login": "horizonzy"}, "path": "client/src/main/java/com/alibaba/nacos/client/naming/core/HostReactor.java", "diffHunk": "@@ -412,12 +419,14 @@ public void run() {\n                 }\n                 \n                 delayTime = serviceObj.getCacheMillis();\n-                \n+                failCount = 0;\n             } catch (Throwable e) {\n+                failCount++;\n                 NAMING_LOGGER.warn(\"[NA] failed to update serviceName: \" + serviceName, e);\n             } finally {\n                 if (delayTime > 0) {\n-                    executor.schedule(this, delayTime, TimeUnit.MILLISECONDS);\n+                    executor.schedule(this, Math.min(delayTime << failCount, DEFAULT_DELAY * 60),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4ODk0NA=="}, "originalCommit": {"oid": "f21aceb9c4a60a85d0202c5c1b6464a8054b6a78"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4334, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}