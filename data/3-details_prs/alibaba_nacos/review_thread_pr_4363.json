{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MTE3NTE5", "number": 4363, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0MDozNFrOE-d6dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNDoxM1rOE-hYvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzOTM3MjY4OnYy", "diffSide": "RIGHT", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0MDozNFrOH7pYog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0MDozNFrOH7pYog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjA4Mg==", "bodyText": "Whether judge isEmpty first will be better?", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306082", "createdAt": "2020-11-30T01:40:34Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/cleaner/EmptyServiceAutoCleanerV2.java", "diffHunk": "@@ -25,13 +38,48 @@\n     \n     private static final String EMPTY_SERVICE = \"emptyService\";\n     \n+    private final ClientServiceIndexesManager clientServiceIndexesManager;\n+    \n+    public EmptyServiceAutoCleanerV2(ClientServiceIndexesManager clientServiceIndexesManager) {\n+        this.clientServiceIndexesManager = clientServiceIndexesManager;\n+        // TODO get internal from config\n+        GlobalExecutor.scheduleExpiredClientCleaner(this, TimeUnit.SECONDS.toMillis(30), TimeUnit.SECONDS.toMillis(20),\n+                TimeUnit.MILLISECONDS);\n+        \n+    }\n+    \n     @Override\n     public String getType() {\n         return EMPTY_SERVICE;\n     }\n     \n     @Override\n     public void doClean() {\n+        ServiceManager serviceManager = ServiceManager.getInstance();\n+        // Parallel flow opening threshold\n+        int parallelSize = 100;\n+        \n+        for (String each : serviceManager.getAllNamespaces()) {\n+            Set<Service> services = serviceManager.getSingletons(each);\n+            Stream<Service> stream = services.size() > parallelSize ? services.parallelStream() : services.stream();\n+            stream.forEach(this::cleanEmptyService);\n+        }\n+    }\n+    \n+    private void cleanEmptyService(Service service) {\n+        Loggers.SRV_LOG.warn(\"namespace : {}, [{}] services are automatically cleaned\", service.getNamespace(),\n+                service.getGroupedServiceName());\n+        Collection<String> registeredService = clientServiceIndexesManager.getAllClientsRegisteredService(service);\n+        if (isTimeExpired(service) && registeredService.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzOTM3ODUyOnYy", "diffSide": "RIGHT", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0NDo1NlrOH7pbwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMTo0NDo1NlrOH7pbwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMwNjg4MA==", "bodyText": "I think this event is not useful.\nIt can be replaced by ServiceMetadataEvent(service, true)", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532306880", "createdAt": "2020-11-30T01:44:56Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/event/service/ServiceEvent.java", "diffHunk": "@@ -56,4 +56,16 @@ public ServiceChangedEvent(Service service, boolean incrementRevision) {\n             }\n         }\n     }\n+    \n+    /**\n+     * Service data changed event.\n+     */\n+    public static class ServiceRemovedEvent extends ServiceEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9b04bfa58118e08fb060afd7a5008dc674a9ab"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzOTk0MTczOnYy", "diffSide": "RIGHT", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNDoxM1rOH7uRow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoxNDoxM1rOH7uRow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4NjIxMQ==", "bodyText": "An invalid blank?", "url": "https://github.com/alibaba/nacos/pull/4363#discussion_r532386211", "createdAt": "2020-11-30T07:14:13Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/v2/metadata/NamingMetadataManager.java", "diffHunk": "@@ -166,7 +166,7 @@ public void onEvent(Event event) {\n             handleInstanceMetadataEvent((MetadataEvent.InstanceMetadataEvent) event);\n         } else if (event instanceof MetadataEvent.ServiceMetadataEvent) {\n             handleServiceMetadataEvent((MetadataEvent.ServiceMetadataEvent) event);\n-        } else {\n+        }  else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5a389ae2e8d65da7dffd16e2ee818569f892dc8"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4278, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}