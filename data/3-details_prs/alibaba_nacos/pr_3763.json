{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNDg0NjA0", "number": 3763, "title": "[ISSUE#3192] naming module replace http client", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nfor: #3192\nBrief changelog\nMainly use the new http client, replacing the existing http client of the naming-module.\nVerifying this change\nSimulate a three-node cluster locally,\nverifying Service registration, service instance synchronization normal work.\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-09-05T08:54:49Z", "url": "https://github.com/alibaba/nacos/pull/3763", "merged": true, "mergeCommit": {"oid": "5e4429f0e4af12c9da141280155395f63cbb3e37"}, "closed": true, "closedAt": "2020-09-15T01:18:21Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBqOy8AH2gAyNDgwNDg0NjA0OmM3OGQ4NmJmZTAxNjY2OGY1YWU3MGY5ODIyYjE0YjVjZGNkYzgzMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI9XMFAFqTQ4ODI1NzIxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c78d86bfe016668f5ae70f9822b14b5cdcdc8332", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/c78d86bfe016668f5ae70f9822b14b5cdcdc8332", "committedDate": "2020-08-23T09:03:20Z", "message": "naming module replace http client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bb3bfcc9767ee201c75c931ac77f6fbb15581e9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0bb3bfcc9767ee201c75c931ac77f6fbb15581e9", "committedDate": "2020-08-25T12:10:32Z", "message": "refactor: naming module replace http client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3f9f2671c882041160bcb4a6651fa017dbb18c", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/3e3f9f2671c882041160bcb4a6651fa017dbb18c", "committedDate": "2020-08-26T05:02:50Z", "message": "Merge branch 'develop' into develop-issue#3192"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00df691a779abaf7eadca398e9269479c821d18a", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/00df691a779abaf7eadca398e9269479c821d18a", "committedDate": "2020-08-27T05:06:37Z", "message": "refactor: naming module replace http client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f079254e7233e9c8486651110644ffedfb4850e4", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/f079254e7233e9c8486651110644ffedfb4850e4", "committedDate": "2020-08-28T11:52:39Z", "message": "refactor: Add apache http client Factory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eefe3e1c324d36bc8ec00cd697ad4f34768e61c", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/3eefe3e1c324d36bc8ec00cd697ad4f34768e61c", "committedDate": "2020-09-01T06:04:48Z", "message": "Merge branch 'develop' into develop-issue#3192\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/BaseHttpMethod.java\n#\tnaming/src/main/java/com/alibaba/nacos/naming/misc/NamingProxy.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48dd543114a6be999441f81ff7658ea250aa66a1", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/48dd543114a6be999441f81ff7658ea250aa66a1", "committedDate": "2020-09-02T09:24:10Z", "message": "refactor: naming module replace http client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "799582fc21bf833fc6648e84eff934ecc47df2ff", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/799582fc21bf833fc6648e84eff934ecc47df2ff", "committedDate": "2020-09-02T15:21:04Z", "message": "fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2994fa50b11d8169acb87965f640878abec64405", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/2994fa50b11d8169acb87965f640878abec64405", "committedDate": "2020-09-02T15:53:55Z", "message": "refactor: Add http client config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23b486f1120f909045a0f29db04cf7846a613e93", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/23b486f1120f909045a0f29db04cf7846a613e93", "committedDate": "2020-09-04T06:54:28Z", "message": "refactor: naming module HttpClientManager change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "353572194404e43e7cb8b9016ca8b01da38fabc3", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/353572194404e43e7cb8b9016ca8b01da38fabc3", "committedDate": "2020-09-04T07:00:35Z", "message": "Merge branch 'develop' into develop-issue#3192\n\n# Conflicts:\n#\tnaming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/92152fef6bac447a3b7b77e94f3ba025917ddba5", "committedDate": "2020-09-05T08:48:34Z", "message": "refactor: naming module HttpClientManager change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjE2NDAw", "url": "https://github.com/alibaba/nacos/pull/3763#pullrequestreview-483216400", "createdAt": "2020-09-07T03:05:10Z", "commit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzowNToxMFrOHNu16Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzowNjo0N1rOHNu3Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTAwMQ==", "bodyText": "In this part, I suggest that you refactor like following:\nif (!result.ok()) {\n    Loggers.RAFT.warn(...);\n    return;\n}\n\nthe other codes do not changed except remove `return 0`", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161001", "createdAt": "2020-09-07T03:05:10Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -287,21 +294,28 @@ public void signalDelete(final String key) throws Exception {\n             \n             for (final String server : peers.allServersWithoutMySelf()) {\n                 String url = buildUrl(server, API_ON_DEL);\n-                HttpClient.asyncHttpDeleteLarge(url, null, json.toString(), new AsyncCompletionHandler<Integer>() {\n+                asyncRestTemplate.delete(url, Header.EMPTY, json.toString(), String.class, new Callback<String>() {\n                     @Override\n-                    public Integer onCompleted(Response response) throws Exception {\n-                        if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n+                    public void onReceive(RestResult<String> result) {\n+                        if (result.ok()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTIzNg==", "bodyText": "Same suggest as above. Otherwise others code do not change in fact, but the author changed.", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161236", "createdAt": "2020-09-07T03:06:17Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -458,22 +472,29 @@ private void sendVote() {\n             for (final String server : peers.allServersWithoutMySelf()) {\n                 final String url = buildUrl(server, API_VOTE);\n                 try {\n-                    HttpClient.asyncHttpPost(url, null, params, new AsyncCompletionHandler<Integer>() {\n+                    asyncRestTemplate.postForm(url, Header.EMPTY, params, String.class, new Callback<String>() {\n                         @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                Loggers.RAFT\n-                                        .error(\"NACOS-RAFT vote failed: {}, url: {}\", response.getResponseBody(), url);\n-                                return 1;\n+                        public void onReceive(RestResult<String> result) {\n+                            if (result.ok()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTI5NQ==", "bodyText": "Same suggest as above.", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161295", "createdAt": "2020-09-07T03:06:39Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -605,29 +626,35 @@ private void sendBeat() throws IOException, InterruptedException {\n                     if (Loggers.RAFT.isDebugEnabled()) {\n                         Loggers.RAFT.debug(\"send beat to server \" + server);\n                     }\n-                    HttpClient.asyncHttpPostLarge(url, null, compressedBytes, new AsyncCompletionHandler<Integer>() {\n-                        @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                Loggers.RAFT.error(\"NACOS-RAFT beat failed: {}, peer: {}\", response.getResponseBody(),\n-                                        server);\n-                                MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                                return 1;\n-                            }\n-                            \n-                            peers.update(JacksonUtils.toObj(response.getResponseBody(), RaftPeer.class));\n-                            if (Loggers.RAFT.isDebugEnabled()) {\n-                                Loggers.RAFT.debug(\"receive beat response from: {}\", url);\n-                            }\n-                            return 0;\n-                        }\n-                        \n-                        @Override\n-                        public void onThrowable(Throwable t) {\n-                            Loggers.RAFT.error(\"NACOS-RAFT error while sending heart-beat to peer: {} {}\", server, t);\n-                            MetricsMonitor.getLeaderSendBeatFailedException().increment();\n-                        }\n-                    });\n+                    asyncRestTemplate.post(url, Header.newInstance(), Query.EMPTY, compressedBytes, String.class,\n+                            new Callback<String>() {\n+                                @Override\n+                                public void onReceive(RestResult<String> result) {\n+                                    if (result.ok()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5"}, "originalPosition": 209}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MTMxNQ==", "bodyText": "Same suggest as above.", "url": "https://github.com/alibaba/nacos/pull/3763#discussion_r484161315", "createdAt": "2020-09-07T03:06:47Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/consistency/persistent/raft/RaftCore.java", "diffHunk": "@@ -745,88 +772,103 @@ public RaftPeer receivedBeat(JsonNode beat) throws Exception {\n                             processedCount, beatDatums.size(), datums.size());\n                     \n                     // update datum entry\n-                    String url = buildUrl(remote.ip, API_GET) + \"?keys=\" + URLEncoder.encode(keys, \"UTF-8\");\n-                    HttpClient.asyncHttpGet(url, null, null, new AsyncCompletionHandler<Integer>() {\n-                        @Override\n-                        public Integer onCompleted(Response response) throws Exception {\n-                            if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {\n-                                return 1;\n-                            }\n-                            \n-                            List<JsonNode> datumList = JacksonUtils\n-                                    .toObj(response.getResponseBody(), new TypeReference<List<JsonNode>>() {\n-                                    });\n-                            \n-                            for (JsonNode datumJson : datumList) {\n-                                Datum newDatum = null;\n-                                OPERATE_LOCK.lock();\n-                                try {\n-                                    \n-                                    Datum oldDatum = getDatum(datumJson.get(\"key\").asText());\n-                                    \n-                                    if (oldDatum != null && datumJson.get(\"timestamp\").asLong() <= oldDatum.timestamp\n-                                            .get()) {\n-                                        Loggers.RAFT\n-                                                .info(\"[NACOS-RAFT] timestamp is smaller than that of mine, key: {}, remote: {}, local: {}\",\n-                                                        datumJson.get(\"key\").asText(),\n-                                                        datumJson.get(\"timestamp\").asLong(), oldDatum.timestamp);\n-                                        continue;\n+                    String url = buildUrl(remote.ip, API_GET);\n+                    asyncRestTemplate.get(url, Header.EMPTY, Query.newInstance().addParam(\"keys\", keys), String.class,\n+                            new Callback<String>() {\n+                                @Override\n+                                public void onReceive(RestResult<String> result) {\n+                                    if (result.ok()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92152fef6bac447a3b7b77e94f3ba025917ddba5"}, "originalPosition": 272}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f820f5def7949509c0a34b8f9540f08f19e54b3a", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/f820f5def7949509c0a34b8f9540f08f19e54b3a", "committedDate": "2020-09-08T05:02:30Z", "message": "refactor: naming module replace http client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "427599eef8750ae5a541def297fc8ebaaf9b58b4", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/427599eef8750ae5a541def297fc8ebaaf9b58b4", "committedDate": "2020-09-08T05:06:07Z", "message": "fix code style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODE1NTAy", "url": "https://github.com/alibaba/nacos/pull/3763#pullrequestreview-483815502", "createdAt": "2020-09-08T06:00:41Z", "commit": {"oid": "427599eef8750ae5a541def297fc8ebaaf9b58b4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c3e36ba41f074b9c757f4bb6e9af9987fcd5f77", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/7c3e36ba41f074b9c757f4bb6e9af9987fcd5f77", "committedDate": "2020-09-08T08:02:53Z", "message": "refactor: fix JDK http client Use error problem."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd13ba2dc977c2f3592ee500904ac7c488754b2a", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/fd13ba2dc977c2f3592ee500904ac7c488754b2a", "committedDate": "2020-09-08T09:36:10Z", "message": "refactor: Query And Header entity init Add non-empty judgment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d139a0f8807a2089710ae4e7535ede4eda030f6", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/0d139a0f8807a2089710ae4e7535ede4eda030f6", "committedDate": "2020-09-08T14:22:23Z", "message": "Enhance the asynchronous http delete request method to support body passing parameters."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjEwMTUy", "url": "https://github.com/alibaba/nacos/pull/3763#pullrequestreview-484610152", "createdAt": "2020-09-09T01:58:47Z", "commit": {"oid": "0d139a0f8807a2089710ae4e7535ede4eda030f6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa9a3be2baa3d6bc2b8839852acc85728caeddec", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/aa9a3be2baa3d6bc2b8839852acc85728caeddec", "committedDate": "2020-09-14T14:42:28Z", "message": "refactor: apache http client set MaxConnTotal and maxConnPerRoute."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjU3MjEx", "url": "https://github.com/alibaba/nacos/pull/3763#pullrequestreview-488257211", "createdAt": "2020-09-15T01:18:10Z", "commit": {"oid": "aa9a3be2baa3d6bc2b8839852acc85728caeddec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4270, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}