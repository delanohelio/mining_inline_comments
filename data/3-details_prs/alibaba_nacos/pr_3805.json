{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NzI2NDY2", "number": 3805, "title": "feature issue #3804", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\n#3804\nBrief changelog\nXX\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-09-11T07:03:25Z", "url": "https://github.com/alibaba/nacos/pull/3805", "merged": true, "mergeCommit": {"oid": "7fd4d9a5d1206063460828de747afe132466bf58"}, "closed": true, "closedAt": "2020-09-18T08:05:37Z", "author": {"login": "chuntaojun"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsEmNHAH2gAyNDg0NzI2NDY2Ojk1ODVkNTVhZGNjZmZkZTUwMzg1ZWQ5YWY4OWQzODVlYmZjZDUzYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKA7d_AFqTQ5MTIzNjc4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9585d55adccffde50385ed9af89d385ebfcd53c6", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/9585d55adccffde50385ed9af89d385ebfcd53c6", "committedDate": "2020-06-17T07:20:06Z", "message": "improvement: merge upstream/develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29df82f694c9ed80ae7e28bd7acb507386972ec7", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/29df82f694c9ed80ae7e28bd7acb507386972ec7", "committedDate": "2020-06-18T15:15:01Z", "message": "refactor: merge upstream develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78167ab1e72c3db2d2a1fa0da68caed994db6c19", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/78167ab1e72c3db2d2a1fa0da68caed994db6c19", "committedDate": "2020-06-19T03:39:46Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7915e4fc647f9861636df7b049cdcaaef930968d", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/7915e4fc647f9861636df7b049cdcaaef930968d", "committedDate": "2020-06-19T13:40:16Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7cf3055421c48942092ca57bc66458ab9a0313", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/9e7cf3055421c48942092ca57bc66458ab9a0313", "committedDate": "2020-06-24T02:43:54Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d8b55cca0738f8fa0dbedcff89c1e001b87322a", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/3d8b55cca0738f8fa0dbedcff89c1e001b87322a", "committedDate": "2020-06-24T07:52:09Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07f84efa557cb122af23b7312d006270d8d0198", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/a07f84efa557cb122af23b7312d006270d8d0198", "committedDate": "2020-06-24T10:21:37Z", "message": "feat: merge upstream develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1811027f98595a96110de97ff1c4ef39cee9887", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/f1811027f98595a96110de97ff1c4ef39cee9887", "committedDate": "2020-06-29T08:22:27Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abee9c4dcf7af484e433340c827b13d1d1d23360", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/abee9c4dcf7af484e433340c827b13d1d1d23360", "committedDate": "2020-07-16T16:06:39Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ac93b95eba7c641cffecdb1e9684d0621fcfed", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/63ac93b95eba7c641cffecdb1e9684d0621fcfed", "committedDate": "2020-08-21T05:27:16Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b39970a0e107371db0250992031dee9f1d040265", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/b39970a0e107371db0250992031dee9f1d040265", "committedDate": "2020-09-11T05:33:03Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into new_develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/cd596e9cdc9fef270f6ced9b680711eff8cae877", "committedDate": "2020-09-11T07:04:00Z", "message": "feat: manage the loading of configuration files uniformly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bde78ff5dcd572f0de98463d67853be2bb964eb", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/7bde78ff5dcd572f0de98463d67853be2bb964eb", "committedDate": "2020-09-11T07:41:37Z", "message": "fix: fix copyright style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTM1NzYx", "url": "https://github.com/alibaba/nacos/pull/3805#pullrequestreview-486535761", "createdAt": "2020-09-11T07:24:19Z", "commit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzoyNDoyMFrOHQRajA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzo0MzoxN1rOHQR-jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNDU4OA==", "bodyText": "What's the reason create this class?", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486824588", "createdAt": "2020-09-11T07:24:20Z", "author": {"login": "KomachiSion"}, "path": "sys/src/main/java/com/alibaba/nacos/sys/Main.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.sys;\n+\n+/**\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+public class Main {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyNTgwOQ==", "bodyText": "Why change the indentation of lecense?", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486825809", "createdAt": "2020-09-11T07:26:49Z", "author": {"login": "KomachiSion"}, "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosDefaultPropertySourceEnvironmentPostProcessor.java", "diffHunk": "@@ -1,20 +1,20 @@\n /*\n- * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgyOTUyNg==", "bodyText": "Why exclude these classes\uff1f", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486829526", "createdAt": "2020-09-11T07:34:48Z", "author": {"login": "KomachiSion"}, "path": "console/src/main/resources/application.properties", "diffHunk": "@@ -175,3 +175,14 @@ nacos.istio.mcp.server.enabled=false\n # nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe\n ### rpc request timeout, default 5 seconds\n # nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000\n+\n+\n+## HTTP Encoding\n+spring.http.encoding.force=true\n+spring.http.encoding.enabled=true\n+\n+## i18n\n+spring.messages.encoding=UTF-8\n+\n+## Exclude Spring Boot Auto-Configuration class(es)\n+spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMzE5OQ==", "bodyText": "I found this inner class only used in current class line 97. And each time create a new one. Can this inner class refactor to some private method.\nIf there are other same package class need this class. Whether extract as an single class will be better?", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486833199", "createdAt": "2020-09-11T07:42:05Z", "author": {"login": "KomachiSion"}, "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosAutoRefreshPropertySourceLoader.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/*\n+ *  Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package com.alibaba.nacos.sys.env;\n+\n+import com.alibaba.nacos.api.exception.NacosException;\n+import com.alibaba.nacos.common.JustForTest;\n+import com.alibaba.nacos.sys.file.FileChangeEvent;\n+import com.alibaba.nacos.sys.file.FileWatcher;\n+import com.alibaba.nacos.sys.file.WatchFileCenter;\n+import com.alibaba.nacos.sys.utils.ApplicationUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.boot.env.OriginTrackedMapPropertySource;\n+import org.springframework.boot.env.PropertySourceLoader;\n+import org.springframework.boot.origin.Origin;\n+import org.springframework.boot.origin.OriginTrackedValue;\n+import org.springframework.boot.origin.TextResourceOrigin;\n+import org.springframework.core.env.PropertySource;\n+import org.springframework.core.io.Resource;\n+import org.springframework.util.Assert;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.LineNumberReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Support for configuring automatic refresh and loading into the Environment.\n+ *\n+ * @author <a href=\"mailto:liaochuntao@live.com\">liaochuntao</a>\n+ */\n+public class NacosAutoRefreshPropertySourceLoader implements PropertySourceLoader {\n+    \n+    private final Map<String, Object> properties = new ConcurrentHashMap<>(16);\n+    \n+    private Resource holder = null;\n+    \n+    @Override\n+    public String[] getFileExtensions() {\n+        return new String[] {\"properties\"};\n+    }\n+    \n+    @Override\n+    public List<PropertySource<?>> load(String name, Resource resource) throws IOException {\n+        holder = resource;\n+        Map<String, ?> tmp = loadProperties(resource);\n+        properties.putAll(tmp);\n+    \n+        try {\n+            WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), new FileWatcher() {\n+                @Override\n+                public void onChange(FileChangeEvent event) {\n+                    try {\n+                        Map<String, ?> tmp1 = loadProperties(holder);\n+                        properties.putAll(tmp1);\n+                    } catch (IOException ignore) {\n+                    \n+                    }\n+                }\n+            \n+                @Override\n+                public boolean interest(String context) {\n+                    return StringUtils.contains(context, \"application.properties\");\n+                }\n+            });\n+        } catch (NacosException ignore) {\n+        \n+        }\n+    \n+        if (properties.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return Collections\n+                .singletonList(new OriginTrackedMapPropertySource(\"nacos_application_conf\", properties));\n+    }\n+    \n+    private Map<String, ?> loadProperties(Resource resource) throws IOException {\n+        return new OriginTrackedPropertiesLoader(resource).load();\n+    }\n+    \n+    @JustForTest\n+    protected Map<String, Object> getProperties() {\n+        return properties;\n+    }\n+    \n+    static class OriginTrackedPropertiesLoader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd596e9cdc9fef270f6ced9b680711eff8cae877"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMzgwNw==", "bodyText": "This file has been deleted?", "url": "https://github.com/alibaba/nacos/pull/3805#discussion_r486833807", "createdAt": "2020-09-11T07:43:17Z", "author": {"login": "KomachiSion"}, "path": "sys/src/main/java/com/alibaba/nacos/sys/env/NacosDefaultPropertySourceEnvironmentPostProcessor.java", "diffHunk": "@@ -56,7 +57,7 @@\n      * @see ResourcePatternResolver#CLASSPATH_ALL_URL_PREFIX\n      */\n     public static final String RESOURCE_LOCATION_PATTERN =\n-            CLASSPATH_ALL_URL_PREFIX + \"META-INF/nacos-default.properties\";\n+            ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + \"META-INF/nacos-default.properties\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bde78ff5dcd572f0de98463d67853be2bb964eb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f98f1f3a77519b6ace45cd3cc89bffed9f0df070", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/f98f1f3a77519b6ace45cd3cc89bffed9f0df070", "committedDate": "2020-09-16T02:12:24Z", "message": "style: fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa187b1ed403df18334fba9a780845db396066d3", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/aa187b1ed403df18334fba9a780845db396066d3", "committedDate": "2020-09-16T02:34:59Z", "message": "feat: merge upstream develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7488453b3c131b1a55f9d26b8345bc46e09f3e", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/ba7488453b3c131b1a55f9d26b8345bc46e09f3e", "committedDate": "2020-09-16T06:02:59Z", "message": "fix: fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d4e4a0c949718d1f1333b9b367efadb67a6d36", "author": {"user": {"login": "chuntaojun", "name": "liaochuntao"}}, "url": "https://github.com/alibaba/nacos/commit/f8d4e4a0c949718d1f1333b9b367efadb67a6d36", "committedDate": "2020-09-17T14:33:08Z", "message": "Merge branch 'develop' of https://github.com/alibaba/nacos into feat_config_env"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjM2Nzgw", "url": "https://github.com/alibaba/nacos/pull/3805#pullrequestreview-491236780", "createdAt": "2020-09-18T08:01:26Z", "commit": {"oid": "f8d4e4a0c949718d1f1333b9b367efadb67a6d36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4282, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}