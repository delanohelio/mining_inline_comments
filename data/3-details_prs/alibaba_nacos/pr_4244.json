{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMTk1NjYy", "number": 4244, "title": "[ISSUE #4225]  Replace http client in HttpHealthCheckProcessor", "bodyText": "Please do not create a Pull Request without creating an issue first.\nWhat is the purpose of the change\nfix: #4225\nBrief changelog\nRemove the com.ning Async HTTP client and replace it with a unified HTTP client.\nVerifying this change\n\nRegister a persistent service\nUse HTTP health checks\nHealth check normal\n\nFollow this checklist to help us incorporate your contribution quickly and easily:\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean package apache-rat:check findbugs:findbugs -Dmaven.test.skip=true to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.", "createdAt": "2020-11-17T07:12:43Z", "url": "https://github.com/alibaba/nacos/pull/4244", "merged": true, "mergeCommit": {"oid": "6f4dbf065fb483905ef5af2fc237a27004934819"}, "closed": true, "closedAt": "2020-11-19T11:07:45Z", "author": {"login": "Maijh97"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdc72blAH2gAyNTIyMTk1NjYyOjAwM2UxYTk3Y2NjNTlkMTBjZWUwMTJjZjAyMWEyNGY3MjRjNjcxNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd4WTYgFqTUzNDAwODkzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "003e1a97ccc59d10cee012cf021a24f724c67175", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/003e1a97ccc59d10cee012cf021a24f724c67175", "committedDate": "2020-11-16T02:50:58Z", "message": "for #42255\uff0c Replace http client in HttpHealthCheckProcessor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "893d36a16c5a74830499e12243015b8f328f4764", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/893d36a16c5a74830499e12243015b8f328f4764", "committedDate": "2020-11-17T07:05:05Z", "message": "Restore the old version number."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fdd9a03c80d6f5168ad6b18be3dafae525762bb", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/1fdd9a03c80d6f5168ad6b18be3dafae525762bb", "committedDate": "2020-11-17T07:14:20Z", "message": "Merge branch 'develop' into develop-issue#4225\n\n# Conflicts:\n#\tcommon/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDgyNjE0", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-532082614", "createdAt": "2020-11-17T07:33:01Z", "commit": {"oid": "1fdd9a03c80d6f5168ad6b18be3dafae525762bb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzozMzowMVrOH0ngVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzozMzowMVrOH0ngVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzNTI1NA==", "bodyText": "use getIoReactorConfig directly, no need to use attribute.", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r524935254", "createdAt": "2020-11-17T07:33:01Z", "author": {"login": "KomachiSion"}, "path": "common/src/main/java/com/alibaba/nacos/common/http/AbstractHttpClientFactory.java", "diffHunk": "@@ -70,20 +71,28 @@ public void onChanged(String filePath) {\n     public NacosAsyncRestTemplate createNacosAsyncRestTemplate() {\n         final HttpClientConfig originalRequestConfig = buildHttpClientConfig();\n         final RequestConfig requestConfig = getRequestConfig();\n+        final IOReactorConfig ioReactorConfig = getIoReactorConfig();\n         return new NacosAsyncRestTemplate(assignLogger(), new DefaultAsyncHttpClientRequest(\n                 HttpAsyncClients.custom()\n                         .addInterceptorLast(new RequestContent(true))\n+                        .setDefaultIOReactorConfig(ioReactorConfig)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fdd9a03c80d6f5168ad6b18be3dafae525762bb"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4f1a5a1bd4704bc4424fe82bd0517e0eb57988", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/ce4f1a5a1bd4704bc4424fe82bd0517e0eb57988", "committedDate": "2020-11-17T07:42:52Z", "message": "Removes temporary attributes from a method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/622b63430a4461ed3fefc9dcadecde66dd37e0c3", "committedDate": "2020-11-17T09:03:28Z", "message": "fix Code style."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzIxNTQ1", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-532321545", "createdAt": "2020-11-17T12:41:50Z", "commit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTg4NzI3", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-532188727", "createdAt": "2020-11-17T09:48:44Z", "commit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTo0ODo0NFrOH0sqaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjozNzo1N1rOH0-RkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxOTc1NQ==", "bodyText": "\u53ef\u4ee5\u5305\u88c5\u5728http\u6a21\u5757\u5185\u90e8\uff0cHttpUtils.isTimeoutException()", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r525019755", "createdAt": "2020-11-17T09:48:44Z", "author": {"login": "chuntaojun"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/healthcheck/HttpHealthCheckProcessor.java", "diffHunk": "@@ -180,18 +153,17 @@ public Integer onCompleted(Response response) throws Exception {\n                         switchDomain.getHttpHealthParams());\n             }\n             \n-            return httpCode;\n         }\n         \n         @Override\n-        public void onThrowable(Throwable t) {\n+        public void onError(Throwable t) {\n             ip.setCheckRt(System.currentTimeMillis() - startTime);\n             \n             Throwable cause = t;\n             int maxStackDepth = 50;\n             for (int deepth = 0; deepth < maxStackDepth && cause != null; deepth++) {\n                 if (cause instanceof SocketTimeoutException || cause instanceof ConnectTimeoutException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwODMwNA==", "bodyText": "\u8fd9\u91cc\u7684\u53c2\u6570\u5e94\u5f53\u540e\u9762\u53ef\u4ee5\u5bf9\u5916\u53ef\u914d\u7f6e\u5316\u7684\uff0c\u800c\u4e0d\u662f\u5199\u6b7b\u7684", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r525308304", "createdAt": "2020-11-17T16:37:57Z", "author": {"login": "chuntaojun"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java", "diffHunk": "@@ -146,4 +163,27 @@ protected Logger assignLogger() {\n             return SRV_LOG;\n         }\n     }\n+    \n+    private static class ProcessorHttpClientFactory extends AbstractHttpClientFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMDAyMzQ3", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-533002347", "createdAt": "2020-11-18T02:25:41Z", "commit": {"oid": "622b63430a4461ed3fefc9dcadecde66dd37e0c3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/03dc338bf4b8d470dcf06d9e3ed8c82fcfaf60b5", "committedDate": "2020-11-18T08:23:20Z", "message": "Use the EnvUtil.getProperty() method to get the HTTP parameter, leaving it customizable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc8f87bcb62ce6470be69b260840668671b21e7c", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/bc8f87bcb62ce6470be69b260840668671b21e7c", "committedDate": "2020-11-18T08:28:56Z", "message": "Fix error symbol."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dfc61cfa14aeccf47488efecc860ae2004563a9", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/9dfc61cfa14aeccf47488efecc860ae2004563a9", "committedDate": "2020-11-18T08:34:29Z", "message": "Remove excess package import."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNDE0MDYz", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-533414063", "createdAt": "2020-11-18T12:52:38Z", "commit": {"oid": "9dfc61cfa14aeccf47488efecc860ae2004563a9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjo1MjozOFrOH1sUTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjo1MzoxMFrOH1sVkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA2MjY3MQ==", "bodyText": "Static final variable get from properties? Static final means that it's a constants. Should not be configed.", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r526062671", "createdAt": "2020-11-18T12:52:38Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/misc/HttpClientManager.java", "diffHunk": "@@ -131,16 +147,58 @@ protected Logger assignLogger() {\n     }\n     \n     private static class ApacheSyncHttpClientFactory extends AbstractApacheHttpClientFactory {\n-    \n+        \n         @Override\n         protected HttpClientConfig buildHttpClientConfig() {\n-            return HttpClientConfig.builder()\n-                    .setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n+            return HttpClientConfig.builder().setConnectionTimeToLive(500, TimeUnit.MILLISECONDS)\n                     .setMaxConnTotal(Runtime.getRuntime().availableProcessors() * 2)\n-                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors())\n-                    .setMaxRedirects(0).build();\n+                    .setMaxConnPerRoute(Runtime.getRuntime().availableProcessors()).setMaxRedirects(0).build();\n+        }\n+        \n+        @Override\n+        protected Logger assignLogger() {\n+            return SRV_LOG;\n         }\n+    }\n     \n+    private static class ProcessorHttpClientFactory extends AbstractHttpClientFactory {\n+        \n+        private static final int CONNECTION_REQUEST_TIMEOUT = EnvUtil", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dfc61cfa14aeccf47488efecc860ae2004563a9"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA2Mjk5Mg==", "bodyText": "Naming Constants should not be in parent module.", "url": "https://github.com/alibaba/nacos/pull/4244#discussion_r526062992", "createdAt": "2020-11-18T12:53:10Z", "author": {"login": "KomachiSion"}, "path": "sys/src/main/java/com/alibaba/nacos/sys/env/Constants.java", "diffHunk": "@@ -63,4 +63,33 @@\n     String NACOS_SERVER_HEADER = \"Nacos-Server\";\n     \n     String REQUEST_PATH_SEPARATOR = \"-->\";\n+    \n+    /**\n+     * ============ naming persistent health check http env.\n+     */\n+    String NAMING_PERSISTENT = \"nacos.naming.persistent\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dfc61cfa14aeccf47488efecc860ae2004563a9"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b585c9e91e6bce64709e7923715e3c2078a4161", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/2b585c9e91e6bce64709e7923715e3c2078a4161", "committedDate": "2020-11-18T13:31:00Z", "message": "Rollback the code about the custom HTTP parameter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae443b0a9c4fa8c23bda656537366f1a68e8bf8", "author": {"user": {"login": "Maijh97", "name": "mai.jh"}}, "url": "https://github.com/alibaba/nacos/commit/fae443b0a9c4fa8c23bda656537366f1a68e8bf8", "committedDate": "2020-11-18T13:31:34Z", "message": "fix Code style."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDA4OTMw", "url": "https://github.com/alibaba/nacos/pull/4244#pullrequestreview-534008930", "createdAt": "2020-11-19T01:20:05Z", "commit": {"oid": "fae443b0a9c4fa8c23bda656537366f1a68e8bf8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4100, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}