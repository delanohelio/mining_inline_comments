{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4MjE0MTkx", "number": 4468, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMjowNzozOVrOFExJDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMjowNzozOVrOFExJDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwNTQzNzU4OnYy", "diffSide": "RIGHT", "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwMjowNzozOVrOIE9AkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNToxNDowM1rOIFVQHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA==", "bodyText": "Bad implementation I think. If oldInstance exist, only use instance id of old instance, can't change instanceId.\nThe original implementation also has some problem", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542064784", "createdAt": "2020-12-14T02:07:39Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2ODQyOA==", "bodyText": "Some situation.\n1. old instance didn't use snowflake generator, new instance use snowflake generator. New instance id should be snowflake Id.\n\n2.old instance use snowflake generator, new instance isn't use  snowflake generator. New instance id shouldn't remains old instance Id. \n\n3.old instance and new instance all use snowflake generator, new instance should remains old instance Id.", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542068428", "createdAt": "2020-12-14T02:21:18Z", "author": {"login": "horizonzy"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMxNTAzNw==", "bodyText": "Must deregister instance and register again.\n\n\nSame as the first\n\n\nyes it is.", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542315037", "createdAt": "2020-12-14T11:32:42Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMxNTk2OQ==", "bodyText": "Instance id is a binder like ip and port (so default id generate from ip and port), If user want to change, they must deregister the older and register new. Can't update it directly.", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542315969", "createdAt": "2020-12-14T11:34:16Z", "author": {"login": "KomachiSion"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2MTk4Mg==", "bodyText": "Instance id is a binder like ip and port (so default id generate from ip and port), If user want to change, they must deregister the older and register new. Can't update it directly.\n\nagree", "url": "https://github.com/alibaba/nacos/pull/4468#discussion_r542461982", "createdAt": "2020-12-14T15:14:03Z", "author": {"login": "horizonzy"}, "path": "naming/src/main/java/com/alibaba/nacos/naming/core/ServiceManager.java", "diffHunk": "@@ -811,7 +811,15 @@ public Instance getInstance(String namespaceId, String serviceName, String clust\n             if (UtilsAndCommons.UPDATE_INSTANCE_ACTION_REMOVE.equals(action)) {\n                 instanceMap.remove(instance.getDatumKey());\n             } else {\n-                instance.setInstanceId(instance.generateInstanceId(currentInstanceIds));\n+                String instanceIdGenerator = instance.getInstanceIdGenerator();\n+                if (Constants.SNOWFLAKE_INSTANCE_ID_GENERATOR.equalsIgnoreCase(instanceIdGenerator)) {\n+                    Instance oldInstance = instanceMap.get(instance.getDatumKey());\n+                    if (oldInstance != null && oldInstance.isSnowflakeId()) {\n+                        instance.setInstanceId(oldInstance.getInstanceId());\n+                    } else {\n+                        instance.setInstanceId(generateSnowflakeInstanceId(currentInstanceIds));\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjA2NDc4NA=="}, "originalCommit": {"oid": "241e9ea5acf1be6ebf4206d3a3cc9ec19f84103a"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4505, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}