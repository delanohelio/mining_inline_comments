{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwODAzNDc3", "number": 7573, "title": "Allow null consume in BatchPushSource", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nBatchSource records allow sources to return a null record to indicate that the batch is done.\nFor BatchPushSource, since we are using LinkedBlockingQueue, user's cannot simply pass a null value. Thus we need a special mechanism to indicate the end of a batch.\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-07-17T05:47:36Z", "url": "https://github.com/apache/pulsar/pull/7573", "merged": true, "mergeCommit": {"oid": "4e1a677171ab40504bd6306dee832cf900ed4472"}, "closed": true, "closedAt": "2020-07-17T22:19:37Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyqm03gH2gAyNDUwODAzNDc3OmNkN2NiZTVmMTJkMzU5Yzk1OGE1ZTY2MTEyNDVkMWYxM2Q3ZTA5M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc14blggFqTQ1MDg4NDE4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "committedDate": "2020-07-07T19:00:43Z", "message": "Added upgrade notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "committedDate": "2020-07-08T20:35:54Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ba7f344b8056adb759c040f529094f5ca9d67f", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a3ba7f344b8056adb759c040f529094f5ca9d67f", "committedDate": "2020-07-12T16:17:19Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "committedDate": "2020-07-12T22:43:18Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0728460c11e7babb09d47427818bda7092846cd", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b0728460c11e7babb09d47427818bda7092846cd", "committedDate": "2020-07-13T20:40:54Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77bb46778d1ef87c5c14694b634ba9d14e945b74", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/77bb46778d1ef87c5c14694b634ba9d14e945b74", "committedDate": "2020-07-13T23:47:34Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000336c993a9c92871470b5ded18724d94cd41c6", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/000336c993a9c92871470b5ded18724d94cd41c6", "committedDate": "2020-07-14T18:53:11Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "committedDate": "2020-07-15T15:39:38Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee44e3ba01e6793331134ac43e7ca636d49a03ab", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ee44e3ba01e6793331134ac43e7ca636d49a03ab", "committedDate": "2020-07-16T23:33:16Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b02b546faad21540133e66b63d9e691561f4c45", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/4b02b546faad21540133e66b63d9e691561f4c45", "committedDate": "2020-07-17T05:44:01Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2bd44c422da521454bbb61bfc28c3649c3585af", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b2bd44c422da521454bbb61bfc28c3649c3585af", "committedDate": "2020-07-17T05:45:20Z", "message": "Allow null message to be passed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1298d777b911177c3385c66a12c97e3bf310fd75", "committedDate": "2020-07-17T07:05:37Z", "message": "More private impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODE3MzAy", "url": "https://github.com/apache/pulsar/pull/7573#pullrequestreview-450817302", "createdAt": "2020-07-17T17:00:06Z", "commit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzowMDowN1rOGzaZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzowMDowN1rOGzaZiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2MzA4MQ==", "bodyText": "Can we add some comments about how to use this?", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456563081", "createdAt": "2020-07-17T17:00:07Z", "author": {"login": "jerrypeng"}, "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -32,6 +30,13 @@\n  */\n public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n+    private static class NullRecord implements Record {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODE4OTg3", "url": "https://github.com/apache/pulsar/pull/7573#pullrequestreview-450818987", "createdAt": "2020-07-17T17:02:40Z", "commit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzowMjo0MVrOGzaeZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzowMjo0MVrOGzaeZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2NDMyNA==", "bodyText": "A small optimization: Just declare a final variable and re-use", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456564324", "createdAt": "2020-07-17T17:02:41Z", "author": {"login": "jerrypeng"}, "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -41,17 +46,26 @@ public BatchPushSource() {\n \n     @Override\n     public Record<T> readNext() throws Exception {\n-        return queue.take();\n+        Record<T> record = queue.take();\n+        if (record instanceof NullRecord) {\n+            return null;\n+        } else {\n+            return record;\n+        }\n     }\n \n     /**\n      * Send this message to be written to Pulsar.\n-     *\n+     * Pass null if you you are done with this task\n      * @param record next message from source which should be sent to a Pulsar topic\n      */\n     public void consume(Record<T> record) {\n         try {\n-            queue.put(record);\n+            if (record != null) {\n+                queue.put(record);\n+            } else {\n+                queue.put(new NullRecord());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODE5MDgy", "url": "https://github.com/apache/pulsar/pull/7573#pullrequestreview-450819082", "createdAt": "2020-07-17T17:02:50Z", "commit": {"oid": "1298d777b911177c3385c66a12c97e3bf310fd75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4556970ceab0403c5be09ee4b8c238b383a8559", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/e4556970ceab0403c5be09ee4b8c238b383a8559", "committedDate": "2020-07-17T17:42:01Z", "message": "Fix unittest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a9070ef02bb75d5335187b427e271fa6a8bd8a1e", "committedDate": "2020-07-17T17:43:53Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg0MTgx", "url": "https://github.com/apache/pulsar/pull/7573#pullrequestreview-450884181", "createdAt": "2020-07-17T18:48:53Z", "commit": {"oid": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo0ODo1M1rOGzdp3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo0ODo1M1rOGzdp3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNjQxNQ==", "bodyText": "Wouldn't it be easier to allow users to place a null value inside their existing Record class and then test for that condition rather than creating a NullRecord class?  e.g.\nprivate static final boolean isNull(Record rec) { return (rec == null) || (rec.getValue() == null); }\nThen you could just call this method instead of using the instanceof NullRecord check", "url": "https://github.com/apache/pulsar/pull/7573#discussion_r456616415", "createdAt": "2020-07-17T18:48:53Z", "author": {"login": "david-streamlio"}, "path": "pulsar-io/core/src/main/java/org/apache/pulsar/io/core/BatchPushSource.java", "diffHunk": "@@ -32,26 +30,43 @@\n  */\n public abstract class BatchPushSource<T> implements BatchSource<T> {\n \n+    private static class NullRecord implements Record {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9070ef02bb75d5335187b427e271fa6a8bd8a1e"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 642, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}