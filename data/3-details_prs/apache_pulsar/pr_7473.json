{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1Nzc2ODA0", "number": 7473, "title": "[pulsar-broker] Cleanup already deleted namespace topics", "bodyText": "Motivation\nWe are having frequent issues when user removes cluster from the global namespace where broker from removed-cluster fails to unload topic and namespace bundle still loaded with the broker. It happens when broker from removed-cluster receives below error\n17:38:52.199 [pulsar-io-22-28] ERROR org.apache.pulsar.broker.service.persistent.PersistentReplicator - [persistent://prop/global/ns/tp1][east -> west] Failed to close dispatch rate limiter: org.apache.pulsar.client.api.PulsarClientException: Producer was not registered on the connection\n:\n17:38:52.199 [pulsar-io-22-28] WARN  org.apache.pulsar.broker.service.AbstractReplicator - [persistent://prop/global/ns/tp1][east -> west]] Exception: 'org.apache.pulsar.client.api.PulsarClientException: Producer was not registered on the connection' occured while trying to close the producer. retrying again in 0.1 s\n:\n17:38:52.351 [pulsar-io-22-37] ERROR org.apache.pulsar.broker.service.persistent.PersistentTopic - [persistent://prop/global/ns/tp1] Error closing topic\njava.util.concurrent.CompletionException: org.apache.pulsar.client.api.PulsarClientException: Producer was not registered on the connection\n        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:331) ~[?:?]\n\nModification\nSource Broker should return explicit error-code when producer is already closed and dest-broker from removed-cluster should handle this error and clean up the replicator and topic gracefully.", "createdAt": "2020-07-07T23:53:03Z", "url": "https://github.com/apache/pulsar/pull/7473", "merged": true, "mergeCommit": {"oid": "38155f6619b74cf6ab4e9ab7ea31a7e09629433f"}, "closed": true, "closedAt": "2020-07-14T00:13:41Z", "author": {"login": "rdhabalia"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcysDIGAH2gAyNDQ1Nzc2ODA0OjU3MDEzMmQ4ZjBlY2M3YzA1MjM3NjlhYmFkYjgzYzJjMDFiZTk4ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczoaHigFqTQ0NjYzNjYwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "570132d8f0ecc7c0523769abadb83c2c01be98de", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/570132d8f0ecc7c0523769abadb83c2c01be98de", "committedDate": "2020-07-07T20:41:32Z", "message": "[pulsar-broker] Cleanup already deleted namespace topics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/972ae3e1d179ad491506302a230dddceaa9651f6", "committedDate": "2020-07-08T01:12:01Z", "message": "add error-codes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eed805674a74208517e0e7f4b68dcb5d86e1c372", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/eed805674a74208517e0e7f4b68dcb5d86e1c372", "committedDate": "2020-07-07T23:45:20Z", "message": "add error-codes"}, "afterCommit": {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/972ae3e1d179ad491506302a230dddceaa9651f6", "committedDate": "2020-07-08T01:12:01Z", "message": "add error-codes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzU0NDA0", "url": "https://github.com/apache/pulsar/pull/7473#pullrequestreview-444754404", "createdAt": "2020-07-08T13:18:09Z", "commit": {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODE5NzY4", "url": "https://github.com/apache/pulsar/pull/7473#pullrequestreview-444819768", "createdAt": "2020-07-08T14:25:04Z", "commit": {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDoyNTowNFrOGuqpbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDoyNTowNFrOGuqpbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU4NjQxMg==", "bodyText": "Since we're treating it as a \"success\" case here, another option would be to have the close request to return \"ok\" when closing a non-existing producer. what do you think?", "url": "https://github.com/apache/pulsar/pull/7473#discussion_r451586412", "createdAt": "2020-07-08T14:25:04Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentReplicator.java", "diffHunk": "@@ -760,11 +761,13 @@ private void checkReplicatedSubscriptionMarker(Position position, MessageImpl<?>\n         final CompletableFuture<Void> future = new CompletableFuture<>();\n \n         super.disconnect(failIfHasBacklog).thenRun(() -> {\n-            dispatchRateLimiter.ifPresent(DispatchRateLimiter::close);\n-            future.complete(null);\n+            cleanAfterDisconnect(future);\n         }).exceptionally(ex -> {\n             Throwable t = (ex instanceof CompletionException ? ex.getCause() : ex);\n-            if (t instanceof TopicBusyException == false) {\n+            if (t instanceof AlreadyClosedException) {\n+                cleanAfterDisconnect(future);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "972ae3e1d179ad491506302a230dddceaa9651f6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "487462bd78c3ef9f988175c561bbd6ecf7b082be", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/487462bd78c3ef9f988175c561bbd6ecf7b082be", "committedDate": "2020-07-08T18:10:48Z", "message": "Revert \"add error-codes\"\n\nThis reverts commit 972ae3e1d179ad491506302a230dddceaa9651f6."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5dd73a99895d3da7f3a9af431d0265c536f7dd4", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/c5dd73a99895d3da7f3a9af431d0265c536f7dd4", "committedDate": "2020-07-08T18:10:52Z", "message": "Revert \"[pulsar-broker] Cleanup already deleted namespace topics\"\n\nThis reverts commit 570132d8f0ecc7c0523769abadb83c2c01be98de."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b257ef4b21f691e8936a384e7ea198761f3bf6c", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/0b257ef4b21f691e8936a384e7ea198761f3bf6c", "committedDate": "2020-07-08T20:34:05Z", "message": "send success if producer is already closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22bfe2c59afc915f465b3f7c6b6d40235b42bf50", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/22bfe2c59afc915f465b3f7c6b6d40235b42bf50", "committedDate": "2020-07-08T20:34:21Z", "message": "send success if consumer is already closed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjM2NjA4", "url": "https://github.com/apache/pulsar/pull/7473#pullrequestreview-446636608", "createdAt": "2020-07-10T19:00:57Z", "commit": {"oid": "22bfe2c59afc915f465b3f7c6b6d40235b42bf50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 557, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}