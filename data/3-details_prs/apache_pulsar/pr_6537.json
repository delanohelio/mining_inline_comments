{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MTQxMjA2", "number": 6537, "title": "[Issue 5903] Support `compact` all partitions of a partitioned topic", "bodyText": "Motivation\nFixes #5903\nIf there is a partitioned topic with too many partitions, users need to compact one by one.\nModifications\nAsync method triggerCompaction and support to compact on a partitioned topic.", "createdAt": "2020-03-14T03:56:16Z", "url": "https://github.com/apache/pulsar/pull/6537", "merged": true, "mergeCommit": {"oid": "9634eb79773adc399397aa3a73e23118281a1737"}, "closed": true, "closedAt": "2020-03-19T05:45:48Z", "author": {"login": "murong00"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNx0uRAFqTM3NDc3MDgwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPFTY7gFqTM3NzQzNzc5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzcwODA0", "url": "https://github.com/apache/pulsar/pull/6537#pullrequestreview-374770804", "createdAt": "2020-03-15T04:30:02Z", "commit": {"oid": "a9d685d451231a66abbac68245c3745708998a77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNDozMDowMlrOF2c3tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwNDozMDowMlrOF2c3tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY0MDQzOQ==", "bodyText": "@murong00 thanks for the contribute, Would you please help add a test that really called into and execute the compact?  Seems this is only the top level method call, and not called into the methods, and some of the code in PersistentTopicsBase.java seems not covered.\nIf there is no ut framework for this, we could add a integration test for it.", "url": "https://github.com/apache/pulsar/pull/6537#discussion_r392640439", "createdAt": "2020-03-15T04:30:02Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/PersistentTopicsTest.java", "diffHunk": "@@ -439,4 +439,33 @@ public void testRevokePartitionedTopic() {\n             Assert.assertEquals(partitionPermissions.get(role), null);\n         }\n     }\n+\n+    @Test\n+    public void testTriggerCompactionTopic() {\n+        final String partitionTopicName = \"test-part\";\n+        final String nonPartitionTopicName = \"test-non-part\";\n+\n+        // trigger compaction on non-existing topic\n+        AsyncResponse response = mock(AsyncResponse.class);\n+        persistentTopics.compact(response, testTenant, testNamespace, \"non-existing-topic\", true);\n+        ArgumentCaptor<RestException> errCaptor = ArgumentCaptor.forClass(RestException.class);\n+        verify(response, timeout(5000).times(1)).resume(errCaptor.capture());\n+        Assert.assertEquals(errCaptor.getValue().getResponse().getStatus(), Response.Status.NOT_FOUND.getStatusCode());\n+\n+        // create non partitioned topic and compaction on it\n+        response = mock(AsyncResponse.class);\n+        persistentTopics.createNonPartitionedTopic(testTenant, testNamespace, nonPartitionTopicName, true);\n+        persistentTopics.compact(response, testTenant, testNamespace, nonPartitionTopicName, true);\n+        ArgumentCaptor<Response> responseCaptor = ArgumentCaptor.forClass(Response.class);\n+        verify(response, timeout(5000).times(1)).resume(responseCaptor.capture());\n+        Assert.assertEquals(responseCaptor.getValue().getStatus(), Response.Status.NO_CONTENT.getStatusCode());\n+\n+        // create partitioned topic and compaction on it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d685d451231a66abbac68245c3745708998a77"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEyMTkz", "url": "https://github.com/apache/pulsar/pull/6537#pullrequestreview-376512193", "createdAt": "2020-03-18T01:44:06Z", "commit": {"oid": "ab3a71147486386687eca2d441992866516e09e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "654f69d3702fb00a88ffb0ec1245b3a58efdd76e", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/654f69d3702fb00a88ffb0ec1245b3a58efdd76e", "committedDate": "2020-03-18T10:54:03Z", "message": "Resolve conflict."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b96a0268951929fa425cab002d23038525c4217", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/2b96a0268951929fa425cab002d23038525c4217", "committedDate": "2020-03-18T10:56:23Z", "message": "Add a unit test to cover the compact logic."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab3a71147486386687eca2d441992866516e09e5", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/ab3a71147486386687eca2d441992866516e09e5", "committedDate": "2020-03-17T03:01:51Z", "message": "Add a unit test to cover the compact logic."}, "afterCommit": {"oid": "2b96a0268951929fa425cab002d23038525c4217", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/2b96a0268951929fa425cab002d23038525c4217", "committedDate": "2020-03-18T10:56:23Z", "message": "Add a unit test to cover the compact logic."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NDM3Nzk2", "url": "https://github.com/apache/pulsar/pull/6537#pullrequestreview-377437796", "createdAt": "2020-03-19T05:45:39Z", "commit": {"oid": "2b96a0268951929fa425cab002d23038525c4217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 8, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}