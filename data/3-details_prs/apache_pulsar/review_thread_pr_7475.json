{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1ODI0Mzgw", "number": 7475, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMToyNjoyOFrOEMcb5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODoxOToxMlrOENAV3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDg0MjYyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMToyNjoyOFrOGujk1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDo1ODoyNlrOGusLdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDU1MA==", "bodyText": "If we take usage from cgroup, we should take limit from cgroup also.", "url": "https://github.com/apache/pulsar/pull/7475#discussion_r451470550", "createdAt": "2020-07-08T11:26:28Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "diffHunk": "@@ -87,45 +100,36 @@ public void calculateBrokerHostUsage() {\n         double totalNicUsageTx = getTotalNicUsageTxKb(nics);\n         double totalNicUsageRx = getTotalNicUsageRxKb(nics);\n         double totalCpuLimit = getTotalCpuLimit();\n-        CpuStat cpuStat = getTotalCpuUsage();\n \n         SystemResourceUsage usage = new SystemResourceUsage();\n         long now = System.currentTimeMillis();\n+        double elapsedSeconds = (now - lastCollection) / 1000d;\n+        double cpuUsage = getTotalCpuUsage(elapsedSeconds);\n \n         if (lastCollection == 0L) {\n             usage.setMemory(getMemUsage());\n             usage.setBandwidthIn(new ResourceUsage(0d, totalNicLimit));\n             usage.setBandwidthOut(new ResourceUsage(0d, totalNicLimit));\n-            usage.setCpu(new ResourceUsage(0d, totalCpuLimit));\n         } else {\n-            double elapsedSeconds = (now - lastCollection) / 1000d;\n             double nicUsageTx = (totalNicUsageTx - lastTotalNicUsageTx) / elapsedSeconds;\n             double nicUsageRx = (totalNicUsageRx - lastTotalNicUsageRx) / elapsedSeconds;\n-\n-            if (cpuStat != null && lastCpuStat != null) {\n-                // we need two non null stats to get a usage report\n-                long cpuTimeDiff = cpuStat.getTotalTime() - lastCpuStat.getTotalTime();\n-                long cpuUsageDiff = cpuStat.getUsage() - lastCpuStat.getUsage();\n-                double cpuUsage = ((double) cpuUsageDiff / (double) cpuTimeDiff) * totalCpuLimit;\n-                usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n-            }\n-\n-            usage.setMemory(getMemUsage());\n-            usage.setBandwidthIn(new ResourceUsage(nicUsageRx, totalNicLimit));\n-            usage.setBandwidthOut(new ResourceUsage(nicUsageTx, totalNicLimit));\n         }\n \n-        lastTotalNicUsageTx = totalNicUsageTx;\n-        lastTotalNicUsageRx = totalNicUsageRx;\n-        lastCpuStat = cpuStat;\n-        lastCollection = System.currentTimeMillis();\n-        this.usage = usage;\n+        usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n     }\n \n     private double getTotalCpuLimit() {\n         return 100 * Runtime.getRuntime().availableProcessors();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34e6998061ec1e1811f0d7fad3dd2cb1fb7386c3"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU4MDk5Ng==", "bodyText": "The available processors reported by JVM are already taking the limit from cgroups.", "url": "https://github.com/apache/pulsar/pull/7475#discussion_r451580996", "createdAt": "2020-07-08T14:17:56Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "diffHunk": "@@ -87,45 +100,36 @@ public void calculateBrokerHostUsage() {\n         double totalNicUsageTx = getTotalNicUsageTxKb(nics);\n         double totalNicUsageRx = getTotalNicUsageRxKb(nics);\n         double totalCpuLimit = getTotalCpuLimit();\n-        CpuStat cpuStat = getTotalCpuUsage();\n \n         SystemResourceUsage usage = new SystemResourceUsage();\n         long now = System.currentTimeMillis();\n+        double elapsedSeconds = (now - lastCollection) / 1000d;\n+        double cpuUsage = getTotalCpuUsage(elapsedSeconds);\n \n         if (lastCollection == 0L) {\n             usage.setMemory(getMemUsage());\n             usage.setBandwidthIn(new ResourceUsage(0d, totalNicLimit));\n             usage.setBandwidthOut(new ResourceUsage(0d, totalNicLimit));\n-            usage.setCpu(new ResourceUsage(0d, totalCpuLimit));\n         } else {\n-            double elapsedSeconds = (now - lastCollection) / 1000d;\n             double nicUsageTx = (totalNicUsageTx - lastTotalNicUsageTx) / elapsedSeconds;\n             double nicUsageRx = (totalNicUsageRx - lastTotalNicUsageRx) / elapsedSeconds;\n-\n-            if (cpuStat != null && lastCpuStat != null) {\n-                // we need two non null stats to get a usage report\n-                long cpuTimeDiff = cpuStat.getTotalTime() - lastCpuStat.getTotalTime();\n-                long cpuUsageDiff = cpuStat.getUsage() - lastCpuStat.getUsage();\n-                double cpuUsage = ((double) cpuUsageDiff / (double) cpuTimeDiff) * totalCpuLimit;\n-                usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n-            }\n-\n-            usage.setMemory(getMemUsage());\n-            usage.setBandwidthIn(new ResourceUsage(nicUsageRx, totalNicLimit));\n-            usage.setBandwidthOut(new ResourceUsage(nicUsageTx, totalNicLimit));\n         }\n \n-        lastTotalNicUsageTx = totalNicUsageTx;\n-        lastTotalNicUsageRx = totalNicUsageRx;\n-        lastCpuStat = cpuStat;\n-        lastCollection = System.currentTimeMillis();\n-        this.usage = usage;\n+        usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n     }\n \n     private double getTotalCpuLimit() {\n         return 100 * Runtime.getRuntime().availableProcessors();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDU1MA=="}, "originalCommit": {"oid": "34e6998061ec1e1811f0d7fad3dd2cb1fb7386c3"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxMTUxMQ==", "bodyText": "@ivankelly  Yes, actually, the availableProcessor is capped to discrete CPU units, so we could read fractional CPU quotas from cgoup.\nUpdated here, PTAL again.", "url": "https://github.com/apache/pulsar/pull/7475#discussion_r451611511", "createdAt": "2020-07-08T14:58:26Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "diffHunk": "@@ -87,45 +100,36 @@ public void calculateBrokerHostUsage() {\n         double totalNicUsageTx = getTotalNicUsageTxKb(nics);\n         double totalNicUsageRx = getTotalNicUsageRxKb(nics);\n         double totalCpuLimit = getTotalCpuLimit();\n-        CpuStat cpuStat = getTotalCpuUsage();\n \n         SystemResourceUsage usage = new SystemResourceUsage();\n         long now = System.currentTimeMillis();\n+        double elapsedSeconds = (now - lastCollection) / 1000d;\n+        double cpuUsage = getTotalCpuUsage(elapsedSeconds);\n \n         if (lastCollection == 0L) {\n             usage.setMemory(getMemUsage());\n             usage.setBandwidthIn(new ResourceUsage(0d, totalNicLimit));\n             usage.setBandwidthOut(new ResourceUsage(0d, totalNicLimit));\n-            usage.setCpu(new ResourceUsage(0d, totalCpuLimit));\n         } else {\n-            double elapsedSeconds = (now - lastCollection) / 1000d;\n             double nicUsageTx = (totalNicUsageTx - lastTotalNicUsageTx) / elapsedSeconds;\n             double nicUsageRx = (totalNicUsageRx - lastTotalNicUsageRx) / elapsedSeconds;\n-\n-            if (cpuStat != null && lastCpuStat != null) {\n-                // we need two non null stats to get a usage report\n-                long cpuTimeDiff = cpuStat.getTotalTime() - lastCpuStat.getTotalTime();\n-                long cpuUsageDiff = cpuStat.getUsage() - lastCpuStat.getUsage();\n-                double cpuUsage = ((double) cpuUsageDiff / (double) cpuTimeDiff) * totalCpuLimit;\n-                usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n-            }\n-\n-            usage.setMemory(getMemUsage());\n-            usage.setBandwidthIn(new ResourceUsage(nicUsageRx, totalNicLimit));\n-            usage.setBandwidthOut(new ResourceUsage(nicUsageTx, totalNicLimit));\n         }\n \n-        lastTotalNicUsageTx = totalNicUsageTx;\n-        lastTotalNicUsageRx = totalNicUsageRx;\n-        lastCpuStat = cpuStat;\n-        lastCollection = System.currentTimeMillis();\n-        this.usage = usage;\n+        usage.setCpu(new ResourceUsage(cpuUsage, totalCpuLimit));\n     }\n \n     private double getTotalCpuLimit() {\n         return 100 * Runtime.getRuntime().availableProcessors();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3MDU1MA=="}, "originalCommit": {"oid": "34e6998061ec1e1811f0d7fad3dd2cb1fb7386c3"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMDY5MzcxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowOTo0M1rOGvcTeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODowOTo0M1rOGvcTeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5OTk5Mw==", "bodyText": "log.error(\"Failed to read CPU usage from {}\", CGROUPS_CPU_USAGE_PATH, e);", "url": "https://github.com/apache/pulsar/pull/7475#discussion_r452399993", "createdAt": "2020-07-09T18:09:43Z", "author": {"login": "rdhabalia"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "diffHunk": "@@ -137,18 +167,36 @@ private double getTotalCpuLimit() {\n      * Line is split in \"words\", filtering the first. The sum of all numbers give the amount of cpu cycles used this\n      * far. Real CPU usage should equal the sum substracting the idle cycles, this would include iowait, irq and steal.\n      */\n-    private CpuStat getTotalCpuUsage() {\n+    private double getTotalCpuUsageForEntireHost() {\n         try (Stream<String> stream = Files.lines(Paths.get(\"/proc/stat\"))) {\n             String[] words = stream.findFirst().get().split(\"\\\\s+\");\n \n             long total = Arrays.stream(words).filter(s -> !s.contains(\"cpu\")).mapToLong(Long::parseLong).sum();\n-\n             long idle = Long.parseLong(words[4]);\n+            long usage = total - idle;\n+\n+            double currentUsage = (usage - lastCpuUsage)  / (total - lastCpuTotalTime) * getTotalCpuLimit();\n+\n+            lastCpuUsage = usage;\n+            lastCpuTotalTime = total;\n \n-            return new CpuStat(total, total - idle);\n+            return currentUsage;\n         } catch (IOException e) {\n-            LOG.error(\"Failed to read CPU usage from /proc/stat\", e);\n-            return null;\n+            log.error(\"Failed to read CPU usage from /proc/stat\", e);\n+            return -1;\n+        }\n+    }\n+\n+    private double getTotalCpuUsageForCGroup(double elapsedTimeSeconds) {\n+        try {\n+            long usage = readLongFromFile(CGROUPS_CPU_USAGE_PATH);\n+            double currentUsage = usage - lastCpuUsage;\n+            lastCpuUsage = usage;\n+\n+            return 100 * currentUsage / elapsedTimeSeconds / TimeUnit.SECONDS.toNanos(1);\n+        } catch (IOException e) {\n+            log.error(\"Failed to read CPU usage from \" + CGROUPS_CPU_USAGE_PATH, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5d702194b864f581feb2618e7f167fcd6557c2"}, "originalPosition": 173}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMDcyNTQyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODoxOToxMlrOGvcn2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODoxOToxMlrOGvcn2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNTIwOA==", "bodyText": "log.warn(\"Failed to check cgroup CPU usage file {}\", e.getMessage());", "url": "https://github.com/apache/pulsar/pull/7475#discussion_r452405208", "createdAt": "2020-07-09T18:19:12Z", "author": {"login": "rdhabalia"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/loadbalance/impl/LinuxBrokerHostUsageImpl.java", "diffHunk": "@@ -73,6 +80,16 @@ public LinuxBrokerHostUsageImpl(int hostUsageCheckIntervalMin,\n         this.overrideBrokerNicSpeedGbps = overrideBrokerNicSpeedGbps;\n         executorService.scheduleAtFixedRate(this::calculateBrokerHostUsage, 0,\n                 hostUsageCheckIntervalMin, TimeUnit.MINUTES);\n+\n+        boolean isCGroupsEnabled = false;\n+        try {\n+             isCGroupsEnabled = Files.exists(Paths.get(CGROUPS_CPU_USAGE_PATH));\n+        } catch (Exception e) {\n+            log.warn(\"Failed to check cgroup CPU usage file\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5d702194b864f581feb2618e7f167fcd6557c2"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2441, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}