{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDM5OTk2", "number": 6700, "title": "Improve backlogSize stats in the topic.", "bodyText": "Motivation\nWhen all subscriptions have no backlogs, but the backlog size of the topic stats is not 0. So this PR improves the backlog size calculation of the managed ledger.\nModifications\nIf all entries are consumed, return the ledger size as the consumed size.\nVerifying this change\nA new unit test added.\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-04-09T13:57:57Z", "url": "https://github.com/apache/pulsar/pull/6700", "merged": true, "mergeCommit": {"oid": "d72e383bcdd5159ad49807213da5393dd716e9df"}, "closed": true, "closedAt": "2020-04-12T12:04:25Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV_wFfAFqTM5MDk4MTc5Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWwCcsABqjMyMjQ2Njk2MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTgxNzkz", "url": "https://github.com/apache/pulsar/pull/6700#pullrequestreview-390981793", "createdAt": "2020-04-09T17:15:02Z", "commit": {"oid": "3e2394a7cf6f8094ca3a41cd3bc388adb80336a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDAxODkz", "url": "https://github.com/apache/pulsar/pull/6700#pullrequestreview-391001893", "createdAt": "2020-04-09T17:44:24Z", "commit": {"oid": "3e2394a7cf6f8094ca3a41cd3bc388adb80336a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo0NDoyNFrOGDi6ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo0NDoyNFrOGDi6ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3MDk1NA==", "bodyText": "The test should assert here instead of printing. Also make sure it's more robust against race conditions", "url": "https://github.com/apache/pulsar/pull/6700#discussion_r406370954", "createdAt": "2020-04-09T17:44:24Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -2424,4 +2424,30 @@ public void testTopicStatsLastExpireTimestampForSubscription() throws PulsarAdmi\n \n         Assert.assertTrue(admin.topics().getStats(topic).subscriptions.values().iterator().next().lastExpireTimestamp > 0L);\n     }\n+\n+    @Test\n+    public void testBacklogSizeShouldBeZeroWhenConsumerAckedAllMessages() throws Exception {\n+        final String topic = \"persistent://prop-xyz/ns1/testBacklogSizeShouldBeZeroWhenConsumerAckedAllMessages\";\n+        Consumer<byte[]> consumer = pulsarClient.newConsumer()\n+                .topic(topic)\n+                .subscriptionName(\"sub-1\")\n+                .subscribe();\n+        Producer<byte[]> producer = pulsarClient.newProducer()\n+                .topic(topic)\n+                .create();\n+\n+        for (int i = 0; i < 33; i++) {\n+            producer.send(new byte[1024 * i * 5]);\n+        }\n+\n+        for (int i = 0; i < 33; i++) {\n+            consumer.acknowledgeCumulative(consumer.receive());\n+        }\n+\n+        // Wait ack send\n+        Thread.sleep(1000);\n+\n+        TopicStats topicStats = admin.topics().getStats(topic);\n+        System.out.println(topicStats.backlogSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2394a7cf6f8094ca3a41cd3bc388adb80336a1"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0b19a3da536683e6dd054d0ec75689a3058698d", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/c0b19a3da536683e6dd054d0ec75689a3058698d", "committedDate": "2020-04-12T01:30:17Z", "message": "Improve backlogSize stats in the topic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1427260193f4e27e0279ecaec80c20bd0b12114", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f1427260193f4e27e0279ecaec80c20bd0b12114", "committedDate": "2020-04-12T01:30:17Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b522e25e14a6f0062eb158ea288be097391c006", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/2b522e25e14a6f0062eb158ea288be097391c006", "committedDate": "2020-04-11T18:05:10Z", "message": "Merge remote-tracking branch 'apache/master' into fix_backlog_size"}, "afterCommit": {"oid": "f1427260193f4e27e0279ecaec80c20bd0b12114", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f1427260193f4e27e0279ecaec80c20bd0b12114", "committedDate": "2020-04-12T01:30:17Z", "message": "Fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4910, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}