{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNDg4MDc5", "number": 7406, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODoxNjo1NlrOEKaUYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wMVQwODoxNzo1MVrOF5MGiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MzUyNDE2OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODoxNjo1NlrOGrbsOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjozNjoyNlrOGrkEMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NTY0Mw==", "bodyText": "What's the advantage of this over \"new HashSet<>()\"?", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r448195643", "createdAt": "2020-07-01T08:16:56Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -167,10 +171,26 @@\n     private volatile boolean autoReadDisabledRateLimiting = false;\n     private FeatureFlags features;\n     // Flag to manage throttling-publish-buffer by atomically enable/disable read-channel.\n-    private volatile boolean autoReadDisabledPublishBufferLimiting = false;\n-    private static final AtomicLongFieldUpdater<ServerCnx> MSG_PUBLISH_BUFFER_SIZE_UPDATER =\n-            AtomicLongFieldUpdater.newUpdater(ServerCnx.class, \"messagePublishBufferSize\");\n-    private volatile long messagePublishBufferSize = 0;\n+    private boolean autoReadDisabledPublishBufferLimiting = false;\n+\n+    private final long maxPendingBytesPerThread;\n+    private final long resumeThresholdPendingBytesPerThread;\n+\n+    // Number of bytes pending to be published from a single specific IO thread.\n+    private static final FastThreadLocal<MutableLong> pendingBytesPerThread = new FastThreadLocal<MutableLong>() {\n+        @Override\n+        protected MutableLong initialValue() throws Exception {\n+            return new MutableLong();\n+        }\n+    };\n+\n+    // A set of connections tied to the current thread\n+    private static final FastThreadLocal<Set<ServerCnx>> cnxsPerThread = new FastThreadLocal<Set<ServerCnx>>() {\n+        @Override\n+        protected Set<ServerCnx> initialValue() throws Exception {\n+            return Collections.newSetFromMap(new IdentityHashMap<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7060160c44b4f8366eff31b4e1ce6cd7ddb1a74"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMjg0OA==", "bodyText": "Since ServerCnx doesn't have a hashCode() method I thought to be on the safe side to just make sure to use ==  operator instead of hashing. Honestly, I'm not 100% sure that would make difference in practice.", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r448332848", "createdAt": "2020-07-01T12:36:26Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -167,10 +171,26 @@\n     private volatile boolean autoReadDisabledRateLimiting = false;\n     private FeatureFlags features;\n     // Flag to manage throttling-publish-buffer by atomically enable/disable read-channel.\n-    private volatile boolean autoReadDisabledPublishBufferLimiting = false;\n-    private static final AtomicLongFieldUpdater<ServerCnx> MSG_PUBLISH_BUFFER_SIZE_UPDATER =\n-            AtomicLongFieldUpdater.newUpdater(ServerCnx.class, \"messagePublishBufferSize\");\n-    private volatile long messagePublishBufferSize = 0;\n+    private boolean autoReadDisabledPublishBufferLimiting = false;\n+\n+    private final long maxPendingBytesPerThread;\n+    private final long resumeThresholdPendingBytesPerThread;\n+\n+    // Number of bytes pending to be published from a single specific IO thread.\n+    private static final FastThreadLocal<MutableLong> pendingBytesPerThread = new FastThreadLocal<MutableLong>() {\n+        @Override\n+        protected MutableLong initialValue() throws Exception {\n+            return new MutableLong();\n+        }\n+    };\n+\n+    // A set of connections tied to the current thread\n+    private static final FastThreadLocal<Set<ServerCnx>> cnxsPerThread = new FastThreadLocal<Set<ServerCnx>>() {\n+        @Override\n+        protected Set<ServerCnx> initialValue() throws Exception {\n+            return Collections.newSetFromMap(new IdentityHashMap<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NTY0Mw=="}, "originalCommit": {"oid": "f7060160c44b4f8366eff31b4e1ce6cd7ddb1a74"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MzY3Njg0OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODo1ODo0MVrOGrdMhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjozODowM1rOGrkHmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyMDI5Mw==", "bodyText": "Is this exported via prometheus? It would be better to have separate event counters for pause and resume so that if pausing happens between prometheus pulls we can see it.", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r448220293", "createdAt": "2020-07-01T08:58:41Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2307,4 +2253,16 @@ private boolean isSystemTopic(String topic) {\n     public void setInterceptor(BrokerInterceptor interceptor) {\n         this.interceptor = interceptor;\n     }\n+\n+    public void pausedConnections(int numberOfConnections) {\n+        pausedConnections.addAndGet(numberOfConnections);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7060160c44b4f8366eff31b4e1ce6cd7ddb1a74"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzMzcyMQ==", "bodyText": "Good point. I just exposed it here to for validation in the tests, though it makes sense to expose the 2 counters.", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r448333721", "createdAt": "2020-07-01T12:38:03Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2307,4 +2253,16 @@ private boolean isSystemTopic(String topic) {\n     public void setInterceptor(BrokerInterceptor interceptor) {\n         this.interceptor = interceptor;\n     }\n+\n+    public void pausedConnections(int numberOfConnections) {\n+        pausedConnections.addAndGet(numberOfConnections);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIyMDI5Mw=="}, "originalCommit": {"oid": "f7060160c44b4f8366eff31b4e1ce6cd7ddb1a74"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzk1NTExNDMzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wMVQwODoxNzo1MVrOJThSwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wMVQyMjo0MDozNlrOJTpFng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDQ0ODE5Mw==", "bodyText": "The reading frequency here should be very low, only used in unit tests or metrics, why not use longAdder", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r624448193", "createdAt": "2021-05-01T08:17:51Z", "author": {"login": "315157973"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -269,18 +267,13 @@\n     private Channel listenChannelTls;\n \n     private boolean preciseTopicPublishRateLimitingEnable;\n-    private final long maxMessagePublishBufferBytes;\n-    private final long resumeProducerReadMessagePublishBufferBytes;\n-    private volatile boolean reachMessagePublishBufferThreshold;\n+    private final AtomicInteger pausedConnections = new AtomicInteger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb620e2f45d4b16c32dc998a26e529f007ac0911"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDU3NTkwMg==", "bodyText": "Good point, changed that.", "url": "https://github.com/apache/pulsar/pull/7406#discussion_r624575902", "createdAt": "2021-05-01T22:40:36Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -269,18 +267,13 @@\n     private Channel listenChannelTls;\n \n     private boolean preciseTopicPublishRateLimitingEnable;\n-    private final long maxMessagePublishBufferBytes;\n-    private final long resumeProducerReadMessagePublishBufferBytes;\n-    private volatile boolean reachMessagePublishBufferThreshold;\n+    private final AtomicInteger pausedConnections = new AtomicInteger();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDQ0ODE5Mw=="}, "originalCommit": {"oid": "fb620e2f45d4b16c32dc998a26e529f007ac0911"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2392, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}