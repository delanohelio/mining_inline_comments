{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwNjk2Mjk4", "number": 7198, "title": "[pulsar-client-cpp] Support Seek on Partitioned Topic by Time", "bodyText": "Modifications\nSupport seek on partitioned topic.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n Make sure that seeking on partitioned topic by time is working.", "createdAt": "2020-06-08T04:21:24Z", "url": "https://github.com/apache/pulsar/pull/7198", "merged": true, "mergeCommit": {"oid": "2add228dd39ecf480179c16abaf87871461c4458"}, "closed": true, "closedAt": "2020-06-08T14:13:11Z", "author": {"login": "k2la"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpIb_8AH2gAyNDMwNjk2Mjk4OjQ5YmIzNjU0YjJkNmM3ZTRlMDI1ZWNmYjFjN2JjOThjYmFmZTZjZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpQvYugFqTQyNjI1OTk0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "49bb3654b2d6c7e4e025ecfb1c7bc98cbafe6cec", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/49bb3654b2d6c7e4e025ecfb1c7bc98cbafe6cec", "committedDate": "2020-06-08T04:06:48Z", "message": "support seek on partitioned topic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTEzMTg0", "url": "https://github.com/apache/pulsar/pull/7198#pullrequestreview-425913184", "createdAt": "2020-06-08T04:48:42Z", "commit": {"oid": "49bb3654b2d6c7e4e025ecfb1c7bc98cbafe6cec"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDo0ODo0MlrOGgPHIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNDo0OToxNVrOGgPHhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1NTIwMg==", "bodyText": "The message id is only relative to 1 partition. Seeking with same message id on multiple partition will position the subscription in the wrong position.", "url": "https://github.com/apache/pulsar/pull/7198#discussion_r436455202", "createdAt": "2020-06-08T04:48:42Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/PartitionedConsumerImpl.cc", "diffHunk": "@@ -542,11 +542,27 @@ void PartitionedConsumerImpl::handleGetConsumerStats(Result res, BrokerConsumerS\n }\n \n void PartitionedConsumerImpl::seekAsync(const MessageId& msgId, ResultCallback callback) {\n-    callback(ResultOperationNotSupported);\n+    Lock stateLock(mutex_);\n+    if (state_ != Ready) {\n+        callback(ResultAlreadyClosed);\n+        return;\n+    }\n+    stateLock.unlock();\n+    for (ConsumerList::const_iterator i = consumers_.begin(); i != consumers_.end(); i++) {\n+        (*i)->seekAsync(msgId, callback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49bb3654b2d6c7e4e025ecfb1c7bc98cbafe6cec"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ1NTMwMA==", "bodyText": "The mutex should be released before triggering the callback, since that might be blocking", "url": "https://github.com/apache/pulsar/pull/7198#discussion_r436455300", "createdAt": "2020-06-08T04:49:15Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/PartitionedConsumerImpl.cc", "diffHunk": "@@ -542,11 +542,27 @@ void PartitionedConsumerImpl::handleGetConsumerStats(Result res, BrokerConsumerS\n }\n \n void PartitionedConsumerImpl::seekAsync(const MessageId& msgId, ResultCallback callback) {\n-    callback(ResultOperationNotSupported);\n+    Lock stateLock(mutex_);\n+    if (state_ != Ready) {\n+        callback(ResultAlreadyClosed);\n+        return;\n+    }\n+    stateLock.unlock();\n+    for (ConsumerList::const_iterator i = consumers_.begin(); i != consumers_.end(); i++) {\n+        (*i)->seekAsync(msgId, callback);\n+    }\n }\n \n void PartitionedConsumerImpl::seekAsync(uint64_t timestamp, ResultCallback callback) {\n-    callback(ResultOperationNotSupported);\n+    Lock stateLock(mutex_);\n+    if (state_ != Ready) {\n+        callback(ResultAlreadyClosed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49bb3654b2d6c7e4e025ecfb1c7bc98cbafe6cec"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a1ee4b022dfd0e77f68a737e95dd478a1a962ee", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/0a1ee4b022dfd0e77f68a737e95dd478a1a962ee", "committedDate": "2020-06-08T05:30:48Z", "message": "mutex is released before triggering callback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4a6c8cce6641c44a28820700da40c36a88df84", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/6e4a6c8cce6641c44a28820700da40c36a88df84", "committedDate": "2020-06-08T06:38:10Z", "message": "seeking for msgId is not supported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700388d128db1a202e7cf0915fad29e377f0909c", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/700388d128db1a202e7cf0915fad29e377f0909c", "committedDate": "2020-06-08T07:14:30Z", "message": "make format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjU5OTQ4", "url": "https://github.com/apache/pulsar/pull/7198#pullrequestreview-426259948", "createdAt": "2020-06-08T13:47:13Z", "commit": {"oid": "700388d128db1a202e7cf0915fad29e377f0909c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2794, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}