{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwODM4NjU4", "number": 8780, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDoyOVrOE_iMlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDoyOVrOE_iMlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU2MDIxOnYy", "diffSide": "RIGHT", "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDoyOVrOH9Se2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDoyMzo0MlrOH-RrcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA==", "bodyText": "Why cannot we use a similar approach as for the Java and Python runtimes (JsonFormat.printer)?\n\n  \n    \n      pulsar/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java\n    \n    \n         Line 349\n      in\n      a045d92\n    \n    \n    \n    \n\n        \n          \n           args.add(\"'\" + JsonFormat.printer().omittingInsignificantWhitespace().print(instanceConfig.getFunctionDetails()) + \"'\"); \n        \n    \n  \n\n\nYou're fixing the issue for non-k8s runtimes, but wouldn't the problem with json parsing still occur in k8s runtime?", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534027994", "createdAt": "2020-12-02T09:44:29Z", "author": {"login": "vaihtovirta"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0ODIzNQ==", "bodyText": "Go Runtime is different from Python and Java Functions runtime, this is mainly the language itself. Go Runtime separately encapsulates the GoInstanceConfig object to process the data transmitted from FunctionDetails, so we can\u2019t use the methods carried by protobuf itself to parse . In Go Runtime, we use -instance-conf to receive and process all parameter information.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534048235", "createdAt": "2020-12-02T10:13:31Z", "author": {"login": "wolfstudy"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4MTIyNw==", "bodyText": "But we could use a similar quote escaping mechanism with JsonPrinter, couldn't we?\nMy concern that your solution might still produce an incorrectly escaped string if k8sruntime == true.\nIt'd be great to have some integration tests that verify a function that has user-config can be successfully started in K8S runtime.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534081227", "createdAt": "2020-12-02T11:04:26Z", "author": {"login": "vaihtovirta"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE4NjYwMg==", "bodyText": "But we could use a similar quote escaping mechanism with JsonPrinter, couldn't we?\n\nThis library is provided by k8s, maybe it is not suitable for Go Runtime here, right?", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534186602", "createdAt": "2020-12-02T13:58:58Z", "author": {"login": "wolfstudy"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE4ODk4NQ==", "bodyText": "Again, In go runtime, we have no way to directly parse the parameters passed in from the command line. This is limited by go instance. We converted all the configuration to GoInstanceConfig for processing. The reason for this problem is because in the runtime of the process , Due to the introduction of single quotation marks in config content, the problem of nesting of single quotation marks may occur when creating functions.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534188985", "createdAt": "2020-12-02T14:02:23Z", "author": {"login": "wolfstudy"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3OTU5MQ==", "bodyText": "I realized JsonPrinter accepts protobuf's MessageOrBuilder, fair enough.\nStill, we have to be sure that a string like --user-config='{\"foo\": \"bar\"}' is propagated correctly when wrapped into single quotes.\nHere's a simple example:\n# Current approach: single quotes in the json get removed after wrapping the clause with additional single quotes. \n\u279c echo '--user-config='{\"foo\": \"bar\"}''\n\u279c --user-config={foo: bar}\n\n\n# Possible option: prefix with $ and use escaping \\'\n\u279c echo $'--user-config=\\'{\"foo\": \"bar\"}\\''\n\u279c --user-config='{\"foo\": \"bar\"}'\nWhat do you think?", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534379591", "createdAt": "2020-12-02T18:13:42Z", "author": {"login": "vaihtovirta"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNDQyNg==", "bodyText": "Still, we have to be sure that a string like --user-config='{\"foo\": \"bar\"}' is propagated correctly when wrapped into single quotes.\n\nWhy? As far as I understand it, --user-config must be JSON. Strings that begin with single quotes are invalid JSON, full stop. If you specify this on the command line, your shell will take care of this, and if you put it in that value on purpose, then your function will fail and that is expected behavior.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534524426", "createdAt": "2020-12-02T22:28:23Z", "author": {"login": "flowchartsman"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU1NTU2Ng==", "bodyText": "Having looked into it a bit more, I see now that the k8s runtime shells out to issue some chmod hacks and run exec on the go binary itself. While this seems suboptimal, I at least understand what's going on a bit better now. I was talking with @addisonj a bit about this and would it make more sense to build the arguments and then only later post process them to add quotes if the runtime is k8s?", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534555566", "createdAt": "2020-12-02T23:36:12Z", "author": {"login": "flowchartsman"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2MDM2Ng==", "bodyText": "Thanks @vaihtovirta @flowchartsman work for this, If we have a better solution, we can send an issue to track this issue.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r534660366", "createdAt": "2020-12-03T04:31:18Z", "author": {"login": "wolfstudy"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA2MzQwOA==", "bodyText": "@flowchartsman I see, I realized -instance-conf takes a json string as an argument, so my previous message doesn't make sense.", "url": "https://github.com/apache/pulsar/pull/8780#discussion_r535063408", "createdAt": "2020-12-03T10:23:42Z", "author": {"login": "vaihtovirta"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/RuntimeUtils.java", "diffHunk": "@@ -224,11 +226,13 @@\n         ObjectMapper objectMapper = ObjectMapperFactory.getThreadLocal();\n         String configContent = objectMapper.writeValueAsString(goInstanceConfig);\n \n-        // Nit: at present, the implementation of go function depends on pulsar-client-go,\n-        // pulsar-client-go uses cgo, so the currently uploaded executable doesn't support cross-compilation.\n         args.add(originalCodeFileName);\n         args.add(\"-instance-conf\");\n-        args.add(\"'\" + configContent + \"'\");\n+        if (k8sRuntime) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNzk5NA=="}, "originalCommit": {"oid": "179eccc86f6251114767fcc8f57b8e967d10c65e"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2751, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}