{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MTUwMTE4", "number": 6128, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0MjoyMVrODaFvXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0MjoyMVrODaFvXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NjgzNjE1OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0MjoyMVrOFg2Txw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwNzo0MzoyOFrOFkgiJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ==", "bodyText": "Generally the cacert should be the same. What scenario let you to this problem?", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r369988551", "createdAt": "2020-01-23T08:42:21Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYzNjI2Nw==", "bodyText": "This is internal client, and the setting should be brokerClientXXX", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r370636267", "createdAt": "2020-01-24T13:36:59Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2MTg0NA==", "bodyText": "yes, I get that. I'm just wondering what sort of set up requires a different CA cert for broker client and for the server. The broker client is going to connect to other brokers in the same cluster, which will have the same CA.\nMy concern here is that people will have configured with only the tls certificate path, and not the broker client tls cert path. This change will break their configuration. Given than both paths are likely to be the same, if broker client tls cert path is empty, it should fall back to tls certificate path.", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r370661844", "createdAt": "2020-01-24T14:30:04Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3OTI1MQ==", "bodyText": "@ivankelly, Thanks. A user meet this issue in their environment. As you mentioned, the content of path for the 2 configs could be the same, but we should provide the ability for user to set it differently. All the auth logic is the same for internal client, in all the admin-client and the replicator-client, it is all set as this change, this is the only place that is not align.", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r372879251", "createdAt": "2020-01-30T10:49:26Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0MDYxMA==", "bodyText": "Providing the ability to have different values is good. However, current behaviour is that just setting tlsCertificateFilePath is enough for both. This change requires that both values are set, which breaks people using the current behaviour. The correct fix here is to use brokerClientTrustCertsFilePath it is non-empty, otherwise use tlsCertificateFilePath.", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r373440610", "createdAt": "2020-01-31T11:43:23Z", "author": {"login": "ivankelly"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyNjA4NA==", "bodyText": "@ivankelly. thanks. changed following your comments, and merged with latest master", "url": "https://github.com/apache/pulsar/pull/6128#discussion_r373826084", "createdAt": "2020-02-02T07:43:28Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -873,12 +873,16 @@ public synchronized PulsarClient getClient() throws PulsarServerException {\n                 ClientBuilder builder = PulsarClient.builder()\n                     .serviceUrl(this.getConfiguration().isTlsEnabled()\n                                 ? this.brokerServiceUrlTls : this.brokerServiceUrl)\n-                    .enableTls(this.getConfiguration().isTlsEnabled())\n-                    .allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection())\n-                    .tlsTrustCertsFilePath(this.getConfiguration().getTlsCertificateFilePath());\n+                    .enableTls(this.getConfiguration().isTlsEnabled());\n+\n+                if (this.getConfiguration().isBrokerClientTlsEnabled()) {\n+                    builder.allowTlsInsecureConnection(this.getConfiguration().isTlsAllowInsecureConnection());\n+                    builder.tlsTrustCertsFilePath(this.getConfiguration().getBrokerClientTrustCertsFilePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODU1MQ=="}, "originalCommit": {"oid": "4f889e5c3e0345ba5effb8139d8d6611cbf89ba7"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2000, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}