{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTQyMzQw", "number": 7266, "title": "[pulsar-broker] Dispatch batch messages according consumer permits", "bodyText": "Motivation\nRight now, dispatching of batch messages is not predictable for a shared-subscription. Dispatcher doesn't consider number of batch messages in an entry which can cause higher number of message delivery than consumer receiver-queue.\nFor example:\nIf a topic has message-entries with 100 batched message in an entry.\nIf consumer has receiver queue=40 and has available-permits=20. then broker dispatches 20 entries with total 2000 (20*100) messages in it. because of that consumer's will high number of messages than expected and we can see available-permits in negative.\nModification\n\nFind out average number of batch messages in an entry\nDispatch messages considering total batch-messages in an entry\n\nResult\nIt will avoid dispatching higher number of messages than consumer's available-permit and will fix -ve available-permits.", "createdAt": "2020-06-13T01:45:46Z", "url": "https://github.com/apache/pulsar/pull/7266", "merged": true, "mergeCommit": {"oid": "a6aed551026825ef2de6b1ac5916d17daf1af5c3"}, "closed": true, "closedAt": "2021-05-17T09:46:13Z", "author": {"login": "rdhabalia"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrq1zEAFqTQzMTA5NTIyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeXm3uFAFqTY2MDc3MzQzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDk1MjI0", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-431095224", "createdAt": "2020-06-16T01:19:18Z", "commit": {"oid": "ed8073efd83226bbb5f4ef06ec2088eb24a7174d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMToxOToxOFrOGkH84Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMToxOToxOFrOGkH84Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMjE5Mw==", "bodyText": "I think we better not add message related concepts to the entry. Maybe we can add a context carrier in the entry. What do you think?", "url": "https://github.com/apache/pulsar/pull/7266#discussion_r440532193", "createdAt": "2020-06-16T01:19:18Z", "author": {"login": "codelipenghui"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/Entry.java", "diffHunk": "@@ -65,4 +65,39 @@\n      */\n     boolean release();\n \n+    /**\n+     * Get number of batch messages into the entry.\n+     * @return\n+     */\n+    int getNumberOfBatchMessages();\n+\n+    /**\n+     * Set number of batch messages into the entry.\n+     * @param numberOfBatchMessages\n+     */\n+    void setNumberOfBatchMessages(int numberOfBatchMessages);\n+\n+    /**\n+     * Set data size of the entry.\n+     * @param totalSizeInBytes\n+     */\n+    void setTotalSizeInBytes(int totalSizeInBytes);\n+\n+    /**\n+     * Set total number of chunked messages in entry.\n+     * @param totalChunkedMessages\n+     */\n+    void setTotalChunkedMessages(int totalChunkedMessages);\n+\n+    /**\n+     * Get total data size of the entry.\n+     * @return\n+     */\n+    int getTotalSizeInBytes();\n+\n+    /**\n+     * Get total number of chuncked messages.\n+     * @return\n+     */\n+    int getTotalChunkedMessages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed8073efd83226bbb5f4ef06ec2088eb24a7174d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjU4NjU1NjQw", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-658655640", "createdAt": "2021-05-13T07:27:45Z", "commit": {"oid": "ed8073efd83226bbb5f4ef06ec2088eb24a7174d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xM1QwNzoyNzo0NVrOJaXHfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xM1QwNzoyNzo0NVrOJaXHfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTYyMTUwMg==", "bodyText": "I agree with @codelipenghui\nit is unfortunate to add these methods here.\nwe are going to use them (and the underlying fields) only on the Dispatcher.\nit would be better (for instance) to have some EntryWithMetatadata object in Dispatcher that wraps the Entry and adds these fields", "url": "https://github.com/apache/pulsar/pull/7266#discussion_r631621502", "createdAt": "2021-05-13T07:27:45Z", "author": {"login": "eolivelli"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/Entry.java", "diffHunk": "@@ -65,4 +65,39 @@\n      */\n     boolean release();\n \n+    /**\n+     * Get number of batch messages into the entry.\n+     * @return\n+     */\n+    int getNumberOfBatchMessages();\n+\n+    /**\n+     * Set number of batch messages into the entry.\n+     * @param numberOfBatchMessages\n+     */\n+    void setNumberOfBatchMessages(int numberOfBatchMessages);\n+\n+    /**\n+     * Set data size of the entry.\n+     * @param totalSizeInBytes\n+     */\n+    void setTotalSizeInBytes(int totalSizeInBytes);\n+\n+    /**\n+     * Set total number of chunked messages in entry.\n+     * @param totalChunkedMessages\n+     */\n+    void setTotalChunkedMessages(int totalChunkedMessages);\n+\n+    /**\n+     * Get total data size of the entry.\n+     * @return\n+     */\n+    int getTotalSizeInBytes();\n+\n+    /**\n+     * Get total number of chuncked messages.\n+     * @return\n+     */\n+    int getTotalChunkedMessages();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzMjE5Mw=="}, "originalCommit": {"oid": "ed8073efd83226bbb5f4ef06ec2088eb24a7174d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35320be4aa6ee5de0bf960324e59d3be472f2c7e", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/35320be4aa6ee5de0bf960324e59d3be472f2c7e", "committedDate": "2021-05-14T00:43:03Z", "message": "[pulsar-broker] Dispatch batch messages according consumer permits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed8073efd83226bbb5f4ef06ec2088eb24a7174d", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/ed8073efd83226bbb5f4ef06ec2088eb24a7174d", "committedDate": "2020-06-13T01:27:27Z", "message": "[pulsar-broker] Dispatch batch messages according consumer permits"}, "afterCommit": {"oid": "b835c350a3ceb4b4506d686d59d89ca23b25b48a", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/b835c350a3ceb4b4506d686d59d89ca23b25b48a", "committedDate": "2021-05-14T17:08:51Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b835c350a3ceb4b4506d686d59d89ca23b25b48a", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/b835c350a3ceb4b4506d686d59d89ca23b25b48a", "committedDate": "2021-05-14T17:08:51Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "218c28a69af98aaea45f2bd62f18a132ef04ef85", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/218c28a69af98aaea45f2bd62f18a132ef04ef85", "committedDate": "2021-05-14T17:14:39Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "218c28a69af98aaea45f2bd62f18a132ef04ef85", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/218c28a69af98aaea45f2bd62f18a132ef04ef85", "committedDate": "2021-05-14T17:14:39Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "1a0d784e292043053d1f452f6ac1c4c920792c41", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/1a0d784e292043053d1f452f6ac1c4c920792c41", "committedDate": "2021-05-14T17:16:23Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a0d784e292043053d1f452f6ac1c4c920792c41", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/1a0d784e292043053d1f452f6ac1c4c920792c41", "committedDate": "2021-05-14T17:16:23Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "cac9f3af35a9bdd4041d71b0de331125787caedd", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/cac9f3af35a9bdd4041d71b0de331125787caedd", "committedDate": "2021-05-14T17:33:31Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYwMTYyMDc5", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-660162079", "createdAt": "2021-05-14T20:00:00Z", "commit": {"oid": "cac9f3af35a9bdd4041d71b0de331125787caedd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xNFQyMDowMDowMFrOJbc93w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0xNFQyMDowMDowMFrOJbc93w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjc2NTkxOQ==", "bodyText": "Are you sure?", "url": "https://github.com/apache/pulsar/pull/7266#discussion_r632765919", "createdAt": "2021-05-14T20:00:00Z", "author": {"login": "eolivelli"}, "path": "conf/bkenv.sh", "diffHunk": "@@ -39,7 +39,7 @@ BOOKIE_MEM=${BOOKIE_MEM:-${PULSAR_MEM:-\"-Xms2g -Xmx2g -XX:MaxDirectMemorySize=2g\n BOOKIE_GC=${BOOKIE_GC:-${PULSAR_GC:-\"-XX:+UseG1GC -XX:MaxGCPauseMillis=10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=32 -XX:ConcGCThreads=32 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB\"}}\n \n # Extra options to be passed to the jvm\n-BOOKIE_EXTRA_OPTS=\"${BOOKIE_EXTRA_OPTS:-\"-Dio.netty.leakDetectionLevel=disabled ${PULSAR_EXTRA_OPTS:-\"-Dio.netty.recycler.maxCapacity.default=1000 -Dio.netty.recycler.linkCapacity=1024\"}\"} ${BOOKIE_MEM} ${BOOKIE_GC}\"\n+BOOKIE_EXTRA_OPTS=\"${BOOKIE_EXTRA_OPTS:-\"-Dio.netty.leakDetectionLevel=advanced ${PULSAR_EXTRA_OPTS:-\"-Dio.netty.recycler.maxCapacity.default=1000 -Dio.netty.recycler.linkCapacity=1024\"}\"} ${BOOKIE_MEM} ${BOOKIE_GC}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cac9f3af35a9bdd4041d71b0de331125787caedd"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cac9f3af35a9bdd4041d71b0de331125787caedd", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/cac9f3af35a9bdd4041d71b0de331125787caedd", "committedDate": "2021-05-14T17:33:31Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "20fbcc97d2c04e91a88be789680693fdd53f4413", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/20fbcc97d2c04e91a88be789680693fdd53f4413", "committedDate": "2021-05-14T22:34:37Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20fbcc97d2c04e91a88be789680693fdd53f4413", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/20fbcc97d2c04e91a88be789680693fdd53f4413", "committedDate": "2021-05-14T22:34:37Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "3cb03346f202ae8a08b0eb108d9c05e221bda914", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/3cb03346f202ae8a08b0eb108d9c05e221bda914", "committedDate": "2021-05-15T01:20:00Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "739c32f0089192fa2cba2016f3f6896a0b5aee81", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/739c32f0089192fa2cba2016f3f6896a0b5aee81", "committedDate": "2021-05-15T01:23:03Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cb03346f202ae8a08b0eb108d9c05e221bda914", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/3cb03346f202ae8a08b0eb108d9c05e221bda914", "committedDate": "2021-05-15T01:20:00Z", "message": "Remove entry api and added entry-wrapper"}, "afterCommit": {"oid": "739c32f0089192fa2cba2016f3f6896a0b5aee81", "author": {"user": {"login": "rdhabalia", "name": "Rajan Dhabalia"}}, "url": "https://github.com/apache/pulsar/commit/739c32f0089192fa2cba2016f3f6896a0b5aee81", "committedDate": "2021-05-15T01:23:03Z", "message": "Remove entry api and added entry-wrapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYwMzA4NDQ3", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-660308447", "createdAt": "2021-05-15T05:26:09Z", "commit": {"oid": "739c32f0089192fa2cba2016f3f6896a0b5aee81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYwNjg1NjM4", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-660685638", "createdAt": "2021-05-17T08:14:22Z", "commit": {"oid": "739c32f0089192fa2cba2016f3f6896a0b5aee81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjYwNzczNDM2", "url": "https://github.com/apache/pulsar/pull/7266#pullrequestreview-660773436", "createdAt": "2021-05-17T09:45:54Z", "commit": {"oid": "739c32f0089192fa2cba2016f3f6896a0b5aee81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 686, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}