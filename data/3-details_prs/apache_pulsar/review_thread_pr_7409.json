{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNTI2MTUx", "number": 7409, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyODo1N1rOEKfZOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowNjo0OFrOELF_Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NDM1NTc3OnYy", "diffSide": "RIGHT", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyODo1N1rOGrjzwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNzozNzo1OVrOGsA_tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODY0MA==", "bodyText": "This is still not safe. There cannot be a race condition to resolve the recycling.\nIn this case it can happen:\n\nthread-1 calls recycle and CAS succeeds\nthread-2 gets a the object from pool\nthread-3 sees recycled==false and does the CAS again, recycle a different object that is in use.\n\nYou cannot use Recyclable for objects with a shared ownership. Either change the logic to avoid race conditions, or use ref-counting.", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r448328640", "createdAt": "2020-07-01T12:28:57Z", "author": {"login": "merlimat"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -1197,11 +1199,13 @@ private BitSetRecyclable(Handle<BitSetRecyclable> recyclerHandle) {\n     }\n \n     public static BitSetRecyclable create() {\n-        return RECYCLER.get();\n+        BitSetRecyclable instance = RECYCLER.get();\n+        instance.recycled.set(false);\n+        return instance;\n     }\n \n     public void recycle() {\n-        if (recyclerHandle != null) {\n+        if (recyclerHandle != null && recycled.compareAndSet(false, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM1NzYyNQ==", "bodyText": "Make sense. Thanks.", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r448357625", "createdAt": "2020-07-01T13:20:16Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -1197,11 +1199,13 @@ private BitSetRecyclable(Handle<BitSetRecyclable> recyclerHandle) {\n     }\n \n     public static BitSetRecyclable create() {\n-        return RECYCLER.get();\n+        BitSetRecyclable instance = RECYCLER.get();\n+        instance.recycled.set(false);\n+        return instance;\n     }\n \n     public void recycle() {\n-        if (recyclerHandle != null) {\n+        if (recyclerHandle != null && recycled.compareAndSet(false, true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODY0MA=="}, "originalCommit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgwNjgzOQ==", "bodyText": "@merlimat I have addressed your comments, please take a look again, thanks.", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r448806839", "createdAt": "2020-07-02T07:37:59Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -1197,11 +1199,13 @@ private BitSetRecyclable(Handle<BitSetRecyclable> recyclerHandle) {\n     }\n \n     public static BitSetRecyclable create() {\n-        return RECYCLER.get();\n+        BitSetRecyclable instance = RECYCLER.get();\n+        instance.recycled.set(false);\n+        return instance;\n     }\n \n     public void recycle() {\n-        if (recyclerHandle != null) {\n+        if (recyclerHandle != null && recycled.compareAndSet(false, true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODY0MA=="}, "originalCommit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMDY3ODQ2OnYy", "diffSide": "RIGHT", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowNjo0OFrOGsg36w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowNjo0OFrOGsg36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyOTEzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.concurrent.atomic.AtomicBoolean;", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r449329131", "createdAt": "2020-07-03T01:06:48Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -27,6 +27,7 @@\n import java.nio.LongBuffer;\n import java.util.Arrays;\n import java.util.BitSet;\n+import java.util.concurrent.atomic.AtomicBoolean;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "067c4509dc9615c969557178180cb44bf47cc15b"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2395, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}