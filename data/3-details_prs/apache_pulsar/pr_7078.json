{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MjUxOTA1", "number": 7078, "title": "introduce precise topic publish rate limiting", "bodyText": "Fixes #6975\nMotivation\nFor now,  pulsar limits  publish rate of topic by a period task runs every topicPublisherThrottlingTickTimeMillis. That means in the time topicPublisherThrottlingTickTimeMillis, the limit can't take effect.\nThis PR enable precise topic publish rate limit on broker.", "createdAt": "2020-05-28T05:09:25Z", "url": "https://github.com/apache/pulsar/pull/7078", "merged": true, "mergeCommit": {"oid": "c64b22ab8b6bc908ea75aeccd589c80aa8ce562b"}, "closed": true, "closedAt": "2020-06-02T02:38:28Z", "author": {"login": "aloyszhang"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclnBm4ABqjMzODExMzE4MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnLkkxAFqTQyMjMwNDIxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de2db937941cc20d11db430c76a2e207dc7b7044", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/de2db937941cc20d11db430c76a2e207dc7b7044", "committedDate": "2020-05-28T05:02:36Z", "message": "introduce precise topic publish rate limiting"}, "afterCommit": {"oid": "183766adf6237f8b689f1caf0b674ae9744edc2f", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/183766adf6237f8b689f1caf0b674ae9744edc2f", "committedDate": "2020-05-28T05:30:19Z", "message": "introduce precise topic publish rate limiting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "183766adf6237f8b689f1caf0b674ae9744edc2f", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/183766adf6237f8b689f1caf0b674ae9744edc2f", "committedDate": "2020-05-28T05:30:19Z", "message": "introduce precise topic publish rate limiting"}, "afterCommit": {"oid": "e124a91c83004085e2e616722f04a509234c1752", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/e124a91c83004085e2e616722f04a509234c1752", "committedDate": "2020-05-28T05:34:52Z", "message": "introduce precise topic publish rate limiting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTkyOTU1", "url": "https://github.com/apache/pulsar/pull/7078#pullrequestreview-420592955", "createdAt": "2020-05-29T01:16:57Z", "commit": {"oid": "e124a91c83004085e2e616722f04a509234c1752"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNjYyNTQ2", "url": "https://github.com/apache/pulsar/pull/7078#pullrequestreview-420662546", "createdAt": "2020-05-29T05:32:28Z", "commit": {"oid": "e124a91c83004085e2e616722f04a509234c1752"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNTozMjoyOVrOGcPTIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNTozMjoyOVrOGcPTIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2Mzk2OA==", "bodyText": "I'd say in general to avoid volatile in all cases in which the exact semantic of read after write consistency is required. In this case we can probably just rely on dirty reads", "url": "https://github.com/apache/pulsar/pull/7078#discussion_r432263968", "createdAt": "2020-05-29T05:32:29Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/PublishRateLimiter.java", "diffHunk": "@@ -66,6 +69,83 @@\n      * @param clusterName\n      */\n     void update(PublishRate maxPublishRate);\n+\n+    /**\n+     * try to acquire permit\n+     * @param numbers\n+     * @param bytes\n+     * */\n+    boolean tryAcquire(int numbers, long bytes);\n+}\n+\n+class PrecisPublishLimiter implements PublishRateLimiter {\n+    protected volatile int publishMaxMessageRate = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e124a91c83004085e2e616722f04a509234c1752"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "committedDate": "2020-06-01T02:03:49Z", "message": "introduce precise topic publish rate limiting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73642e07e148de9e50b6dd833422a2921b8b5f26", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/73642e07e148de9e50b6dd833422a2921b8b5f26", "committedDate": "2020-05-30T09:49:02Z", "message": "Merge branch 'master' into precise-limit"}, "afterCommit": {"oid": "b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/b91a9749f13af0d3f40db322d1e8e1d6bf2beffc", "committedDate": "2020-06-01T02:03:49Z", "message": "introduce precise topic publish rate limiting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743ae77cc6a3a07c72a1cfcc1079fa677a29a19c", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/743ae77cc6a3a07c72a1cfcc1079fa677a29a19c", "committedDate": "2020-06-01T03:34:38Z", "message": "add license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzA0MjEx", "url": "https://github.com/apache/pulsar/pull/7078#pullrequestreview-422304211", "createdAt": "2020-06-02T02:38:02Z", "commit": {"oid": "743ae77cc6a3a07c72a1cfcc1079fa677a29a19c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2723, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}