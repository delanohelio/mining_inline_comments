{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTkwMjMy", "number": 8725, "title": "Issue 8677: Cannot get lastMessageId for an empty topic due to message retention", "bodyText": "When we are trimming the ledgers we are saving the currentLedger but as soon as your restart the broker the currentLedger is not containing the lastMessageId (because it is a fresh new ledger).\nChanges:\n\nadd test case on pulsar-broker that reproduces the issue reported but the user\nlog a message when we are trimming the ledger at lastAddConfirmedEntry\nadd test case that prevent changes in the future on ManagedLedgerImpl\nfix a minor issue in PersistentTopic#getLastMessageId, a return keyword was missing and we continued with a call ti ManagedLedger, the CompletableFuture was already 'completed' so the final result is not changed (but we are saving resources)\n\nFixes #8677", "createdAt": "2020-11-26T16:56:16Z", "url": "https://github.com/apache/pulsar/pull/8725", "merged": true, "mergeCommit": {"oid": "5054642966adc97808ca8e97a4e22170e5964b0b"}, "closed": true, "closedAt": "2020-12-07T13:16:44Z", "author": {"login": "eolivelli"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf6ccbgH2gAyNTI4MTkwMjMyOjAwZjJjNTM5MjkyMGZiMzg3MDg1ZWEzNDZjZWQzYzk1M2U0NTE4NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj1Yn_gFqTU0NjEzNjkzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00f2c5392920fb387085ea346ced3c953e451857", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/00f2c5392920fb387085ea346ced3c953e451857", "committedDate": "2020-11-25T08:54:27Z", "message": "Issue 8677: Cannot get lastMessageId for an empty topic (due to message retention)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef67b865c6ecbe2b6a8420e29277dd5573e66c7", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/5ef67b865c6ecbe2b6a8420e29277dd5573e66c7", "committedDate": "2020-11-25T09:01:45Z", "message": "fix pom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4dbb2b82ecc594a3d4ed50d1c17b6ce8f1c477a", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/d4dbb2b82ecc594a3d4ed50d1c17b6ce8f1c477a", "committedDate": "2020-11-26T16:50:52Z", "message": "Issue 8677: Cannot get lastMessageId for an empty topic (due to message retention)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce28dcb8caed96447684e3be03c7acd822be4fd", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/bce28dcb8caed96447684e3be03c7acd822be4fd", "committedDate": "2020-11-26T16:52:55Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82f46f724104d35d8b41a3ad4dbe7937d44279b7", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/82f46f724104d35d8b41a3ad4dbe7937d44279b7", "committedDate": "2020-11-27T07:43:59Z", "message": "Fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d95a13a591a6616ec28e550d2ff215422b3b432", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/9d95a13a591a6616ec28e550d2ff215422b3b432", "committedDate": "2020-11-27T07:50:11Z", "message": "Merge remote-tracking branch 'origin/master' into fix/lastmessageid-retention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTc2OTUy", "url": "https://github.com/apache/pulsar/pull/8725#pullrequestreview-540576952", "createdAt": "2020-11-30T03:22:07Z", "commit": {"oid": "9d95a13a591a6616ec28e550d2ff215422b3b432"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMzoyMjowN1rOH7quMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMzoyMjowN1rOH7quMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjMyNzk4Ng==", "bodyText": "I am not sure this is the right fix. It changes the trim behavior which causes a rolled ledger to never be deleted until a new message is produced. I think a correct fix is to fix getLastMessageId behavior to correctly handle an empty ledger case.", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r532327986", "createdAt": "2020-11-30T03:22:07Z", "author": {"login": "sijie"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -2089,6 +2089,10 @@ void internalTrimConsumedLedgers(CompletableFuture<?> promise) {\n                     log.debug(\"[{}] Ledger {} skipped for deletion as it is currently being written to\", name,\n                             ls.getLedgerId());\n                     break;\n+                } else if (currentLastConfirmedEntry != null && ls.getLedgerId() == currentLastConfirmedEntry.getLedgerId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d95a13a591a6616ec28e550d2ff215422b3b432"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671f9ee40557cc2bd8758148a117c414633b905e", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/671f9ee40557cc2bd8758148a117c414633b905e", "committedDate": "2020-11-30T16:28:54Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f23077495e0595ec67bdb320525ed4f79eb4ee0f", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/f23077495e0595ec67bdb320525ed4f79eb4ee0f", "committedDate": "2020-11-30T16:29:03Z", "message": "Merge remote-tracking branch 'origin/master' into fix/lastmessageid-retention"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/fb7d688ac4ca8bd99981a05668af708088b689cc", "committedDate": "2020-11-30T16:41:15Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NzE4NTYz", "url": "https://github.com/apache/pulsar/pull/8725#pullrequestreview-544718563", "createdAt": "2020-12-04T07:42:24Z", "commit": {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTQyODMx", "url": "https://github.com/apache/pulsar/pull/8725#pullrequestreview-545942831", "createdAt": "2020-12-07T08:58:53Z", "commit": {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODo1ODo1M1rOIAcQnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODo1ODo1M1rOIAcQnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzMzkxNg==", "bodyText": "Seems not related to this PR?", "url": "https://github.com/apache/pulsar/pull/8725#discussion_r537333916", "createdAt": "2020-12-07T08:58:53Z", "author": {"login": "codelipenghui"}, "path": ".gitignore", "diffHunk": "@@ -30,6 +30,9 @@ pulsar-functions/worker/src/test/resources/\n *.iml\n *.iws\n \n+# NetBeans\n+nb-configuration.xml\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTM2OTMw", "url": "https://github.com/apache/pulsar/pull/8725#pullrequestreview-546136930", "createdAt": "2020-12-07T13:16:27Z", "commit": {"oid": "fb7d688ac4ca8bd99981a05668af708088b689cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 992, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}