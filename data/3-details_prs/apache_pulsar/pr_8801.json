{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNDc3MjE4", "number": 8801, "title": "Add setter for the reader subscription name", "bodyText": "Fixes #8787\nMotivation\nIn the current reader, we set the subscription name combine with a random part.\nModifications\nadd subscription setter\nVerifying this change\nReaderTest#testReaderSubName", "createdAt": "2020-12-03T04:54:21Z", "url": "https://github.com/apache/pulsar/pull/8801", "merged": true, "mergeCommit": {"oid": "8089f3670ad81ca50946168f49023ef9ba24488e"}, "closed": true, "closedAt": "2020-12-07T02:37:46Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdibuY7AH2gAyNTMxNDc3MjE4OjliNjNhNTllOTk3ZmI0YTY3MjkxMzQxOTQyOGQ2ODg2NmRmZmNkNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi5iOfAFqTU0NTA2MTk4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b63a59e997fb4a672913419428d68866dffcd5e", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/9b63a59e997fb4a672913419428d68866dffcd5e", "committedDate": "2020-12-03T04:48:46Z", "message": "support reader name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNjU1OTky", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-543655992", "createdAt": "2020-12-03T07:03:27Z", "commit": {"oid": "9b63a59e997fb4a672913419428d68866dffcd5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNzowMzoyN1rOH9_wBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNzowMzoyN1rOH9_wBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDc2OTY3MA==", "bodyText": "Overall looks good. I found if both the subscriptionRolePrefix and subscriptionName are specified, it will take the subscriptionName. Could you please also add a test case for this?", "url": "https://github.com/apache/pulsar/pull/8801#discussion_r534769670", "createdAt": "2020-12-03T07:03:27Z", "author": {"login": "zymap"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ReaderTest.java", "diffHunk": "@@ -397,4 +396,32 @@ public void testKeyHashRangeReader() throws IOException {\n         }\n \n     }\n+\n+    @Test\n+    public void testReaderSubName() throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testReaderSubName\";\n+        final String subName = \"my-sub-name\";\n+\n+        Reader<String> reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest)\n+                .create();\n+        ReaderImpl<String> readerImpl = (ReaderImpl<String>) reader;\n+        assertEquals(readerImpl.getConsumer().getSubscription(), subName);\n+        reader.close();\n+\n+        final String topic2 = \"persistent://my-property/my-ns/testReaderSubName2\";\n+        admin.topics().createPartitionedTopic(topic2, 3);\n+\n+        reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic2)\n+                .startMessageId(MessageId.earliest)\n+                .create();\n+        MultiTopicsReaderImpl<String> multiTopicsReader = (MultiTopicsReaderImpl<String>) reader;\n+        multiTopicsReader.getMultiTopicsConsumer().getConsumers()\n+                .forEach(consumerImpl -> assertEquals(consumerImpl.getSubscription(), subName));\n+        multiTopicsReader.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b63a59e997fb4a672913419428d68866dffcd5e"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNjgxNDQ1", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-543681445", "createdAt": "2020-12-03T07:49:30Z", "commit": {"oid": "9b63a59e997fb4a672913419428d68866dffcd5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNzo0OTozMFrOH-EITw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNzo0OTozMFrOH-EITw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg0MTQyMw==", "bodyText": "It would be better if we could add this test case: when creating two readers with the same subscriptionName at the same time, the second one should fail.", "url": "https://github.com/apache/pulsar/pull/8801#discussion_r534841423", "createdAt": "2020-12-03T07:49:30Z", "author": {"login": "RobertIndie"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ReaderTest.java", "diffHunk": "@@ -397,4 +396,32 @@ public void testKeyHashRangeReader() throws IOException {\n         }\n \n     }\n+\n+    @Test\n+    public void testReaderSubName() throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testReaderSubName\";\n+        final String subName = \"my-sub-name\";\n+\n+        Reader<String> reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest)\n+                .create();\n+        ReaderImpl<String> readerImpl = (ReaderImpl<String>) reader;\n+        assertEquals(readerImpl.getConsumer().getSubscription(), subName);\n+        reader.close();\n+\n+        final String topic2 = \"persistent://my-property/my-ns/testReaderSubName2\";\n+        admin.topics().createPartitionedTopic(topic2, 3);\n+\n+        reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic2)\n+                .startMessageId(MessageId.earliest)\n+                .create();\n+        MultiTopicsReaderImpl<String> multiTopicsReader = (MultiTopicsReaderImpl<String>) reader;\n+        multiTopicsReader.getMultiTopicsConsumer().getConsumers()\n+                .forEach(consumerImpl -> assertEquals(consumerImpl.getSubscription(), subName));\n+        multiTopicsReader.close();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b63a59e997fb4a672913419428d68866dffcd5e"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f2e05bba304bf9c403e2a8c1decb1ec83b05ab8", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/3f2e05bba304bf9c403e2a8c1decb1ec83b05ab8", "committedDate": "2020-12-04T02:44:46Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9453610595641a7b457e2d4bb6f76fff79302835", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/9453610595641a7b457e2d4bb6f76fff79302835", "committedDate": "2020-12-04T05:53:54Z", "message": "change unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Njg4MzUw", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-544688350", "createdAt": "2020-12-04T06:32:59Z", "commit": {"oid": "9453610595641a7b457e2d4bb6f76fff79302835"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjozMjo1OVrOH_CyHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjozMzo1MFrOH_CzTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2NzkzMg==", "bodyText": "Nit:  try-with-resources", "url": "https://github.com/apache/pulsar/pull/8801#discussion_r535867932", "createdAt": "2020-12-04T06:32:59Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ReaderTest.java", "diffHunk": "@@ -397,4 +398,70 @@ public void testKeyHashRangeReader() throws IOException {\n         }\n \n     }\n+\n+    @Test\n+    public void testReaderSubName() throws Exception {\n+        doTestReaderSubName(true);\n+        doTestReaderSubName(false);\n+    }\n+\n+    public void doTestReaderSubName(boolean setPrefix) throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testReaderSubName\" + System.currentTimeMillis();\n+        final String subName = \"my-sub-name\";\n+\n+        ReaderBuilder<String> builder = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest);\n+        if (setPrefix) {\n+            builder = builder.subscriptionRolePrefix(subName + System.currentTimeMillis());\n+        }\n+        Reader<String> reader = builder.create();\n+        ReaderImpl<String> readerImpl = (ReaderImpl<String>) reader;\n+        assertEquals(readerImpl.getConsumer().getSubscription(), subName);\n+        reader.close();\n+\n+        final String topic2 = \"persistent://my-property/my-ns/testReaderSubName2\" + System.currentTimeMillis();\n+        admin.topics().createPartitionedTopic(topic2, 3);\n+        builder = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic2)\n+                .startMessageId(MessageId.earliest);\n+        if (setPrefix) {\n+            builder = builder.subscriptionRolePrefix(subName + System.currentTimeMillis());\n+        }\n+        reader = builder.create();\n+        MultiTopicsReaderImpl<String> multiTopicsReader = (MultiTopicsReaderImpl<String>) reader;\n+        multiTopicsReader.getMultiTopicsConsumer().getConsumers()\n+                .forEach(consumerImpl -> assertEquals(consumerImpl.getSubscription(), subName));\n+        multiTopicsReader.close();\n+    }\n+\n+    @Test\n+    public void testSameSubName() throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testSameSubName\";\n+        final String subName = \"my-sub-name\";\n+\n+        Reader<String> reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest).create();\n+        Reader<String> reader2 = null;\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9453610595641a7b457e2d4bb6f76fff79302835"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2ODIzOQ==", "bodyText": "Can we assert that after closing the first reader it is possible to create a new reader with the same subscription name?", "url": "https://github.com/apache/pulsar/pull/8801#discussion_r535868239", "createdAt": "2020-12-04T06:33:50Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ReaderTest.java", "diffHunk": "@@ -397,4 +398,70 @@ public void testKeyHashRangeReader() throws IOException {\n         }\n \n     }\n+\n+    @Test\n+    public void testReaderSubName() throws Exception {\n+        doTestReaderSubName(true);\n+        doTestReaderSubName(false);\n+    }\n+\n+    public void doTestReaderSubName(boolean setPrefix) throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testReaderSubName\" + System.currentTimeMillis();\n+        final String subName = \"my-sub-name\";\n+\n+        ReaderBuilder<String> builder = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest);\n+        if (setPrefix) {\n+            builder = builder.subscriptionRolePrefix(subName + System.currentTimeMillis());\n+        }\n+        Reader<String> reader = builder.create();\n+        ReaderImpl<String> readerImpl = (ReaderImpl<String>) reader;\n+        assertEquals(readerImpl.getConsumer().getSubscription(), subName);\n+        reader.close();\n+\n+        final String topic2 = \"persistent://my-property/my-ns/testReaderSubName2\" + System.currentTimeMillis();\n+        admin.topics().createPartitionedTopic(topic2, 3);\n+        builder = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic2)\n+                .startMessageId(MessageId.earliest);\n+        if (setPrefix) {\n+            builder = builder.subscriptionRolePrefix(subName + System.currentTimeMillis());\n+        }\n+        reader = builder.create();\n+        MultiTopicsReaderImpl<String> multiTopicsReader = (MultiTopicsReaderImpl<String>) reader;\n+        multiTopicsReader.getMultiTopicsConsumer().getConsumers()\n+                .forEach(consumerImpl -> assertEquals(consumerImpl.getSubscription(), subName));\n+        multiTopicsReader.close();\n+    }\n+\n+    @Test\n+    public void testSameSubName() throws Exception {\n+        final String topic = \"persistent://my-property/my-ns/testSameSubName\";\n+        final String subName = \"my-sub-name\";\n+\n+        Reader<String> reader = pulsarClient.newReader(Schema.STRING)\n+                .subscriptionName(subName)\n+                .topic(topic)\n+                .startMessageId(MessageId.earliest).create();\n+        Reader<String> reader2 = null;\n+        try {\n+            reader2 = pulsarClient.newReader(Schema.STRING)\n+                    .subscriptionName(subName)\n+                    .topic(topic)\n+                    .startMessageId(MessageId.earliest).create();\n+            fail(\"should fail\");\n+        } catch (PulsarClientException e) {\n+            assertTrue(e instanceof PulsarClientException.ConsumerBusyException);\n+            assertTrue(e.getMessage().contains(\"Exclusive consumer is already connected\"));\n+        }\n+\n+        reader.close();\n+        if (reader2 != null) {\n+            reader2.close();\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9453610595641a7b457e2d4bb6f76fff79302835"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b03e4b604cce70fb1a3b001536d260ed6581bc4", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/5b03e4b604cce70fb1a3b001536d260ed6581bc4", "committedDate": "2020-12-04T06:46:56Z", "message": "change unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Nzg1Mzc5", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-544785379", "createdAt": "2020-12-04T09:24:19Z", "commit": {"oid": "5b03e4b604cce70fb1a3b001536d260ed6581bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Nzg4NzQx", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-544788741", "createdAt": "2020-12-04T09:28:36Z", "commit": {"oid": "5b03e4b604cce70fb1a3b001536d260ed6581bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDYxOTgw", "url": "https://github.com/apache/pulsar/pull/8801#pullrequestreview-545061980", "createdAt": "2020-12-04T15:32:38Z", "commit": {"oid": "5b03e4b604cce70fb1a3b001536d260ed6581bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1027, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}