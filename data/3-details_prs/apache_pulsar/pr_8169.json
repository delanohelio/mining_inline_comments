{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NDMxNDM4", "number": 8169, "title": "[broker] Add command to delete a cluster's metadata from ZK", "bodyText": "Motivation\nWhen we share the same ZK and BK cluster with multiple broker clusters, if a cluster was removed, its metadata in ZK should also be removed.\nModifications\n\nAdd a PulsarClusterMetadataTeardown class to delete the relative nodes from ZK;\nWrap the class to bin/pulsar script.", "createdAt": "2020-09-30T11:09:36Z", "url": "https://github.com/apache/pulsar/pull/8169", "merged": true, "mergeCommit": {"oid": "d41729f422b215f53bd88c2eec6d1d112e804778"}, "closed": true, "closedAt": "2020-10-01T04:24:41Z", "author": {"login": "BewareMyPower"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN6vFBAH2gAyNDk1NDMxNDM4OjZjODc2NzAzYzk2ZGFjNjkzNTI0ODQ1Y2U4OTdlM2I1MWY0OTllYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOJncMAFqTQ5OTk5OTY3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6c876703c96dac693524845ce897e3b51f499ea4", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/6c876703c96dac693524845ce897e3b51f499ea4", "committedDate": "2020-09-30T11:04:10Z", "message": "Add command to delete a cluster's metadata from ZK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDcxODk5", "url": "https://github.com/apache/pulsar/pull/8169#pullrequestreview-499471899", "createdAt": "2020-09-30T14:09:14Z", "commit": {"oid": "6c876703c96dac693524845ce897e3b51f499ea4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDowOToxNFrOHafcqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDowOToxNFrOHafcqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MDI2Ng==", "bodyText": "Maybe some of these parameters could be read from conf file?", "url": "https://github.com/apache/pulsar/pull/8169#discussion_r497540266", "createdAt": "2020-09-30T14:09:14Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/PulsarClusterMetadataTeardown.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar;\n+\n+import com.beust.jcommander.JCommander;\n+import com.beust.jcommander.Parameter;\n+import org.apache.pulsar.zookeeper.ZooKeeperClientFactory;\n+import org.apache.pulsar.zookeeper.ZookeeperClientFactoryImpl;\n+import org.apache.zookeeper.KeeperException;\n+import org.apache.zookeeper.ZKUtil;\n+import org.apache.zookeeper.ZooKeeper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Teardown the metadata for a existed Pulsar cluster\n+ */\n+public class PulsarClusterMetadataTeardown {\n+\n+    private static class Arguments {\n+        @Parameter(names = { \"-zk\",\n+                \"--zookeeper\"}, description = \"Local ZooKeeper quorum connection string\", required = true)\n+        private String zookeeper;\n+\n+        @Parameter(names = {\n+                \"--zookeeper-session-timeout-ms\"\n+        }, description = \"Local zookeeper session timeout ms\")\n+        private int zkSessionTimeoutMillis = 30000;\n+\n+        @Parameter(names = { \"-c\", \"-cluster\" }, description = \"Cluster name\")\n+        private String cluster;\n+\n+        @Parameter(names = { \"-cs\", \"--configuration-store\" }, description = \"Configuration Store connection string\")\n+        private String configurationStore;\n+\n+        @Parameter(names = { \"-h\", \"--help\" }, description = \"Show this help message\")\n+        private boolean help = false;\n+    }\n+\n+    public static void main(String[] args) throws InterruptedException {\n+        Arguments arguments = new Arguments();\n+        JCommander jcommander = new JCommander();\n+        try {\n+            jcommander.addObject(arguments);\n+            jcommander.parse(args);\n+            if (arguments.help) {\n+                jcommander.usage();\n+                return;\n+            }\n+        } catch (Exception e) {\n+            jcommander.usage();\n+            throw e;\n+        }\n+\n+        ZooKeeper localZk = initZk(arguments.zookeeper, arguments.zkSessionTimeoutMillis);\n+\n+        deleteZkNodeRecursively(localZk, \"/bookies\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c876703c96dac693524845ce897e3b51f499ea4"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5OTk5Njcw", "url": "https://github.com/apache/pulsar/pull/8169#pullrequestreview-499999670", "createdAt": "2020-10-01T04:24:24Z", "commit": {"oid": "6c876703c96dac693524845ce897e3b51f499ea4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 129, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}