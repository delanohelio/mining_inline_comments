{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NDkwMzQ0", "number": 9056, "title": "Add streaming dispatcher.", "bodyText": "Related to  #3804\nMotivation\nTrying to streamline the dispatcher's read requests to manager ledger instead of micro batch.\nModifications\nCreated a StreamingEntryReader that can streamline read request to managed ledger.\nCreated StreamingDispatcher interface with necessary method to interact with StreamingEntryReader.\nCreated PersistentStreamingDispatcherSingleActive/MultipleConsumer that make use of StreamingEntryReader to read entries from managed ledger.\nAdd config to use streaming dispatcher.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change added tests and can be verified as follows:\nAdd unit tests.\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): no\nThe public API: no\nThe schema: no\nThe default values of configurations: no\nThe wire protocol: no\nThe rest endpoints: no\nThe admin cli options: no\nAnything that affects deployment: no\n\nDocumentation\n\nDoes this pull request introduce a new feature? yes", "createdAt": "2020-12-25T01:22:09Z", "url": "https://github.com/apache/pulsar/pull/9056", "merged": true, "mergeCommit": {"oid": "8cfaf48e1dc97e30050cb29c106b614d6b9bc69c"}, "closed": true, "closedAt": "2021-02-02T04:02:52Z", "author": {"login": "MarvinCai"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpd1zugH2gAyNTQ1NDkwMzQ0OjQxZDQ0Y2ZjYjVjM2Y4Mjc1NDg4NTc4NzhlNzU4MGRlNWVmN2Q4MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2DnxRAFqTU4MDk2ODAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41d44cfcb5c3f827548857878e7580de5ef7d80d", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/41d44cfcb5c3f827548857878e7580de5ef7d80d", "committedDate": "2020-12-25T01:14:09Z", "message": "Add streaming dispatcher."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5", "committedDate": "2020-12-25T22:13:06Z", "message": "Update situation reach end of topic.\nAdd debug print for ut."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjMyODEw", "url": "https://github.com/apache/pulsar/pull/9056#pullrequestreview-559632810", "createdAt": "2020-12-29T17:34:16Z", "commit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzozNDoxN1rOIMUceA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzo0NDoxOFrOIMUoOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODc5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                void notifyWaitingEntryCallBack() {\n          \n          \n            \n                void notifyWaitingEntryCallBacks() {", "url": "https://github.com/apache/pulsar/pull/9056#discussion_r549788792", "createdAt": "2020-12-29T17:34:17Z", "author": {"login": "sijie"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -1915,6 +1920,21 @@ void notifyCursors() {\n         }\n     }\n \n+    void notifyWaitingEntryCallBack() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODkxMA==", "bodyText": "Can you mark this feature as a preview feature?", "url": "https://github.com/apache/pulsar/pull/9056#discussion_r549788910", "createdAt": "2020-12-29T17:34:37Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -667,6 +667,12 @@\n     )\n     private boolean preciseDispatcherFlowControl = false;\n \n+    @FieldContext(\n+        category = CATEGORY_SERVER,\n+        doc = \"Whether to use streaming read dispatcher.\"\n+    )\n+    private boolean streamingDispatch = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODk2Ng==", "bodyText": "It would be great to add more documentation about this feature.", "url": "https://github.com/apache/pulsar/pull/9056#discussion_r549788966", "createdAt": "2020-12-29T17:34:50Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -667,6 +667,12 @@\n     )\n     private boolean preciseDispatcherFlowControl = false;\n \n+    @FieldContext(\n+        category = CATEGORY_SERVER,\n+        doc = \"Whether to use streaming read dispatcher.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5MTgwMA==", "bodyText": "final?", "url": "https://github.com/apache/pulsar/pull/9056#discussion_r549791800", "createdAt": "2020-12-29T17:44:18Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentStreamingDispatcherMultipleConsumers.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.persistent;\n+\n+import com.google.common.collect.Lists;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.bookkeeper.mledger.Entry;\n+import org.apache.bookkeeper.mledger.ManagedCursor;\n+import org.apache.bookkeeper.mledger.Position;\n+import org.apache.bookkeeper.mledger.impl.ManagedCursorImpl;\n+import org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl;\n+import org.apache.bookkeeper.mledger.impl.PositionImpl;\n+import org.apache.bookkeeper.mledger.util.SafeRun;\n+import org.apache.pulsar.broker.service.Consumer;\n+import org.apache.pulsar.broker.service.Subscription;\n+import org.apache.pulsar.broker.service.streamingdispatch.PendingReadEntryRequest;\n+import org.apache.pulsar.broker.service.streamingdispatch.StreamingDispatcher;\n+import org.apache.pulsar.broker.service.streamingdispatch.StreamingEntryReader;\n+\n+/**\n+ * A {@link PersistentDispatcherMultipleConsumers} implemented {@link StreamingDispatcher}.\n+ * It'll use {@link StreamingEntryReader} to read new entries instead read as micro batch from managed ledger.\n+ */\n+@Slf4j\n+public class PersistentStreamingDispatcherMultipleConsumers extends PersistentDispatcherMultipleConsumers\n+    implements StreamingDispatcher {\n+\n+    private StreamingEntryReader streamingEntryReader = new StreamingEntryReader((ManagedCursorImpl) cursor,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1bf5aa8a0bb3aed6ae48ab69711873c7b9787d5"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "242e61d316a9318f7127c2883dc5658d57ebd146", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/242e61d316a9318f7127c2883dc5658d57ebd146", "committedDate": "2021-01-06T00:25:40Z", "message": "Merge remote-tracking branch 'apache-pulsar/master' into streamline-dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474ed8b5627f47d7e8b7d1c46a29442268877ef0", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/474ed8b5627f47d7e8b7d1c46a29442268877ef0", "committedDate": "2021-01-06T07:46:19Z", "message": "Address comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f02621bb6a14d5057eff99eb5da33557c01cc5e", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/2f02621bb6a14d5057eff99eb5da33557c01cc5e", "committedDate": "2021-01-06T18:32:41Z", "message": "Try remove unnecessary synchronization in StreamingEntryReader."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c296481639f0ff2ce39ab46b0e106bf1076b2b22", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/c296481639f0ff2ce39ab46b0e106bf1076b2b22", "committedDate": "2021-01-08T05:45:04Z", "message": "Try run tests for streaming dispatcher as separate mvn command."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4NjQyODMz", "url": "https://github.com/apache/pulsar/pull/9056#pullrequestreview-568642833", "createdAt": "2021-01-14T21:32:23Z", "commit": {"oid": "c296481639f0ff2ce39ab46b0e106bf1076b2b22"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMTozMjoyM1rOIT4COQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMTozMjoyM1rOIT4COQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcxMTkyOQ==", "bodyText": "@MarvinCai Can you write a test case for this class?", "url": "https://github.com/apache/pulsar/pull/9056#discussion_r557711929", "createdAt": "2021-01-14T21:32:23Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/streamingdispatch/StreamingEntryReader.java", "diffHunk": "@@ -0,0 +1,338 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.streamingdispatch;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReferenceFieldUpdater;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.bookkeeper.mledger.AsyncCallbacks;\n+import org.apache.bookkeeper.mledger.Entry;\n+import org.apache.bookkeeper.mledger.ManagedLedgerException;\n+import org.apache.bookkeeper.mledger.Position;\n+import org.apache.bookkeeper.mledger.WaitingEntryCallBack;\n+import org.apache.bookkeeper.mledger.impl.ManagedCursorImpl;\n+import org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl;\n+import org.apache.bookkeeper.mledger.impl.PositionImpl;\n+import org.apache.bookkeeper.mledger.util.SafeRun;\n+import org.apache.pulsar.broker.service.persistent.PersistentTopic;\n+import org.apache.pulsar.broker.transaction.buffer.exceptions.TransactionNotSealedException;\n+import org.apache.pulsar.client.impl.Backoff;\n+\n+/**\n+ * Entry reader that fulfill read request by streamline the read instead of reading with micro batch.\n+ */\n+@Slf4j\n+@RequiredArgsConstructor\n+public class StreamingEntryReader implements AsyncCallbacks.ReadEntryCallback, WaitingEntryCallBack {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c296481639f0ff2ce39ab46b0e106bf1076b2b22"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMTc4NDc4", "url": "https://github.com/apache/pulsar/pull/9056#pullrequestreview-570178478", "createdAt": "2021-01-18T05:25:19Z", "commit": {"oid": "c296481639f0ff2ce39ab46b0e106bf1076b2b22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884a49c5fe3e0d5137bc634f4d7106377a2ece09", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/884a49c5fe3e0d5137bc634f4d7106377a2ece09", "committedDate": "2021-02-01T09:45:39Z", "message": "Merge remote-tracking branch 'apache-pulsar/master' into streamline-dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "081a569d2877f6492cba71ef06a1ea0560e837e7", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/081a569d2877f6492cba71ef06a1ea0560e837e7", "committedDate": "2021-02-01T16:52:42Z", "message": "Fix import for proto generated type."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwOTY1MTc2", "url": "https://github.com/apache/pulsar/pull/9056#pullrequestreview-580965176", "createdAt": "2021-02-02T03:53:20Z", "commit": {"oid": "081a569d2877f6492cba71ef06a1ea0560e837e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwOTY4MDM3", "url": "https://github.com/apache/pulsar/pull/9056#pullrequestreview-580968037", "createdAt": "2021-02-02T04:02:18Z", "commit": {"oid": "081a569d2877f6492cba71ef06a1ea0560e837e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 840, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}