{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMDQ1ODA4", "number": 8992, "title": "PIP-68: WaitForExclusive producer access mode", "bodyText": "Motivation\nImplemented the 2nd part of the proposal for PIP-68.\nWith WaitForExclusive mode, a producer is pending until there are other producers connected and then it will be created.\nThe change in the client logic is to make sure that we don't time out the producer creation request. The broker will send a 1st response saying that the producer creation is pending. At this point the client will disable the timeout on the original request.", "createdAt": "2020-12-17T18:26:02Z", "url": "https://github.com/apache/pulsar/pull/8992", "merged": true, "mergeCommit": {"oid": "99476d3196ffe5968d52d571b0be59f8eeeb8fea"}, "closed": true, "closedAt": "2020-12-18T22:20:51Z", "author": {"login": "merlimat"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnHwDLAH2gAyNTQyMDQ1ODA4OmIyM2UxMjI3OGQ0MzY0MDZlOTNjZmM1OWMyMTViNTNiNjM1ODY3Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABe-d5TmAFqTc1NDYyNzI1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b23e12278d436406e93cfc59c215b53b63586769", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/b23e12278d436406e93cfc59c215b53b63586769", "committedDate": "2020-12-17T18:22:06Z", "message": "PIP-68: WaitForExclusive producer access mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5259839ff07e053b41dcc190f25af645d8c7ac0", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/b5259839ff07e053b41dcc190f25af645d8c7ac0", "committedDate": "2020-12-17T18:50:43Z", "message": "Fixed checkstyle issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzAwMjAx", "url": "https://github.com/apache/pulsar/pull/8992#pullrequestreview-555300201", "createdAt": "2020-12-18T08:46:04Z", "commit": {"oid": "b5259839ff07e053b41dcc190f25af645d8c7ac0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/a57c2534c105e8b750cc7fc2602f00647c26ad40", "committedDate": "2020-12-18T19:15:56Z", "message": "Fixed log level to info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1Nzg4NTAx", "url": "https://github.com/apache/pulsar/pull/8992#pullrequestreview-555788501", "createdAt": "2020-12-18T20:18:13Z", "commit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMDoxODoxM1rOIIxgjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMDoyMToyN1rOIIxlvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MDY2OA==", "bodyText": "Typo  qeuue", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546070668", "createdAt": "2020-12-18T20:18:13Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1192,6 +1193,17 @@ protected void handleProducer(final CommandProducer cmdProducer) {\n                                     }\n                                     return null;\n                                 });\n+\n+                                producerQueuedFuture.thenRun(() -> {\n+                                    // If the producer is queued waiting, we will get an immediate notification\n+                                    // that we need to pass to client\n+                                    if (isActive()) {\n+                                        log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MTk5Ng==", "bodyText": "What happens if the PulsarClient gets closed or there is a network error?\nAre we guaranteed to fail and do not wait forever?", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546071996", "createdAt": "2020-12-18T20:21:27Z", "author": {"login": "eolivelli"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ClientCnx.java", "diffHunk": "@@ -468,6 +469,19 @@ protected void handleProducerSuccess(CommandProducerSuccess success) {\n                     success.getRequestId(), success.getProducerName());\n         }\n         long requestId = success.getRequestId();\n+        if (!success.getProducerReady()) {\n+            // We got a success operation but the producer is not ready. This means that the producer has been queued up\n+            // in broker. We need to leave the future pending until we get the final confirmation. We just mark that\n+            // we have received a response, in order to avoid the timeout.\n+            TimedCompletableFuture<?> requestFuture = (TimedCompletableFuture<?>) pendingRequests.get(requestId);\n+            if (requestFuture != null) {\n+                log.info(\"{} Producer {} has been queued up at broker. request: {}\", ctx.channel(),\n+                        success.getProducerName(), requestId);\n+                requestFuture.markAsResponded();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NzkyMzcy", "url": "https://github.com/apache/pulsar/pull/8992#pullrequestreview-555792372", "createdAt": "2020-12-18T20:25:23Z", "commit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMDoyNToyM1rOIIxsuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMDoyNToyM1rOIIxsuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3Mzc4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                    log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);\n          \n          \n            \n                                                    log.info(\"[{}] Producer is waiting in queue: {}\", remoteAddress, producer);", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546073784", "createdAt": "2020-12-18T20:25:23Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1192,6 +1193,17 @@ protected void handleProducer(final CommandProducer cmdProducer) {\n                                     }\n                                     return null;\n                                 });\n+\n+                                producerQueuedFuture.thenRun(() -> {\n+                                    // If the producer is queued waiting, we will get an immediate notification\n+                                    // that we need to pass to client\n+                                    if (isActive()) {\n+                                        log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd614a912d055085e011cd83c9f7769b3d3a54ad", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/dd614a912d055085e011cd83c9f7769b3d3a54ad", "committedDate": "2020-12-18T20:25:31Z", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java"}}, {"__typename": "PullRequestReview", "id": "PRR_kwDOA7PXtM4s-rKy", "url": "https://github.com/apache/pulsar/pull/8992#pullrequestreview-754627250", "createdAt": "2021-09-15T03:21:31Z", "commit": {"oid": "dd614a912d055085e011cd83c9f7769b3d3a54ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wOS0xNVQwMzoyMTozMVrOKj-HvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wOS0xNVQwMzoyMTozMVrOKj-HvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "PRRC_kwDOA7PXtM4qP4e9", "bodyText": "Hi @merlimat @sijie , this place makes me a little puzzled and I would like to ask why we need to change readlock to writelock?", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r708806589", "createdAt": "2021-09-15T03:21:31Z", "author": {"login": "wuzhanpeng"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -337,14 +342,15 @@ public String getReplicatorPrefix() {\n     }\n \n     @Override\n-    public CompletableFuture<Optional<Long>> addProducer(Producer producer) {\n+    public CompletableFuture<Optional<Long>> addProducer(Producer producer,\n+            CompletableFuture<Void> producerQueuedFuture) {\n         checkArgument(producer.getTopic() == this);\n \n         CompletableFuture<Optional<Long>> future = new CompletableFuture<>();\n \n-        incrementTopicEpochIfNeeded(producer)\n-                .thenAccept(epoch -> {\n-                    lock.readLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd614a912d055085e011cd83c9f7769b3d3a54ad"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 795, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}