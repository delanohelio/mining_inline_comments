{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjU4NTU3", "number": 8796, "title": "[Issue 8751] Update Dockerfile for Pulsar and Dashboard to Create and Use pulsar User (nonroot user)", "bodyText": "Fixes #8751\nMotivation\nPulsar does not need to run as the root user. This PR updates the pulsar and the pulsar dashboard images to make them run as a new pulsar user (user 1000 10000 and group 10001). This change increases the security of pulsar images.\nModifications\nUpdate two Dockerfiles to create a pulsar user, chown the appropriate directories, and then use that user by default.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\nI manually verified that the docker images run with the correct user and file permissions. As this is my first commit, I'm not familiar with pulsar testing. Are there tests that run against the produced docker images? If so, then there is likely no further testing needed.\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): no\nThe public API: no\nThe schema:  no\nThe default values of configurations: no\nThe wire protocol: no\nThe rest endpoints: no\nThe admin cli options: no\nAnything that affects deployment: yes\nIn order to deploy this new docker container, users will need to update the journal and ledgers directories on the host to be owned by user 1000 10000 and group 1000 10001.\n\nDocumentation\nDocumentation will be required for this change because users will need to set up their hosts differently to properly give permission to user 1000 10000 and group 1000 10001 in order to allow the container to write to the appropriate host volumes. However, I'd like to see if this approach is accepted before adding documentation.", "createdAt": "2020-12-02T20:03:02Z", "url": "https://github.com/apache/pulsar/pull/8796", "merged": true, "mergeCommit": {"oid": "4264a67a84d9a9f4a49cebc591c46b252dcf4e45"}, "closed": true, "closedAt": "2021-02-16T04:17:52Z", "author": {"login": "michaeljmarshall"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiUS0ZgBqjQwNjQxODMyMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd4-VBOAH2gAyNTMxMjU4NTU3OjQ3YjhlODRiZGE1MDAzMzAxZTA0YTFmNjIwNWU5YzQzOTVmMjE0MGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6aeedab8cc6a99a6cdc17e6dbf6d0865401ee20", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/a6aeedab8cc6a99a6cdc17e6dbf6d0865401ee20", "committedDate": "2020-12-02T18:59:00Z", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)"}, "afterCommit": {"oid": "37f5787181ead262447a1b6a4019cbdec48cfd84", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/37f5787181ead262447a1b6a4019cbdec48cfd84", "committedDate": "2020-12-02T20:09:06Z", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37f5787181ead262447a1b6a4019cbdec48cfd84", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/37f5787181ead262447a1b6a4019cbdec48cfd84", "committedDate": "2020-12-02T20:09:06Z", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)"}, "afterCommit": {"oid": "8fa7d02afb01abb8b0f8484188750f415f5af04d", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/8fa7d02afb01abb8b0f8484188750f415f5af04d", "committedDate": "2020-12-03T05:43:34Z", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNjE4OTYw", "url": "https://github.com/apache/pulsar/pull/8796#pullrequestreview-543618960", "createdAt": "2020-12-03T06:32:52Z", "commit": {"oid": "8fa7d02afb01abb8b0f8484188750f415f5af04d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODY0OTU1", "url": "https://github.com/apache/pulsar/pull/8796#pullrequestreview-547864955", "createdAt": "2020-12-09T06:04:23Z", "commit": {"oid": "a2df5ea955da6086ad6668e7313c1968ba3c8e11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNjowNDoyNFrOICEAEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNjowNDoyNFrOICEAEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMzYxOA==", "bodyText": "@michaeljmarshall when the docker image is used in Kubernetes, the helm chart will mount the disks to /pulsar/data. Does it change the permission?", "url": "https://github.com/apache/pulsar/pull/8796#discussion_r539033618", "createdAt": "2020-12-09T06:04:24Z", "author": {"login": "sijie"}, "path": "docker/pulsar/Dockerfile", "diffHunk": "@@ -53,21 +55,25 @@ RUN python3.7 get-pip.py\n \n RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 10\n \n-ADD target/python-client/ /pulsar/pulsar-client\n-ADD target/cpp-client/ /pulsar/cpp-client\n+ADD --chown=pulsar:pulsar target/python-client/ /pulsar/pulsar-client\n+ADD --chown=pulsar:pulsar target/cpp-client/ /pulsar/cpp-client\n RUN echo networkaddress.cache.ttl=1 >> $JAVA_HOME/jre/lib/security/java.security\n RUN apt-get update \\\n      && apt install -y /pulsar/cpp-client/*.deb \\\n      && apt-get clean \\\n+     && chown -R pulsar:pulsar /pulsar/cpp-client/\n      && rm -rf /var/lib/apt/lists/*\n \n+# Start using the pulsar user to ensure container defaults to run as non root user\n+USER pulsar\n+\n+# Directories will have correct permission because we switched to the pulsar user\n+RUN mkdir /pulsar/conf /pulsar/data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2df5ea955da6086ad6668e7313c1968ba3c8e11"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2df5ea955da6086ad6668e7313c1968ba3c8e11", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/a2df5ea955da6086ad6668e7313c1968ba3c8e11", "committedDate": "2020-12-04T06:04:50Z", "message": "Fix latest-version-test Dockerfile; Optimize use of chown in Dockerfile"}, "afterCommit": {"oid": "f4019a1bdb7e89c53a1e8ae3d9d928cbabd16efd", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/f4019a1bdb7e89c53a1e8ae3d9d928cbabd16efd", "committedDate": "2020-12-09T06:46:14Z", "message": "Fix latest-version-test Dockerfile; Optimize use of chown in Dockerfile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91d8a2e1b2f9f8f36e95a9c0b0514d517b4bac6d", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/91d8a2e1b2f9f8f36e95a9c0b0514d517b4bac6d", "committedDate": "2020-12-31T23:29:46Z", "message": "Run pip install as root user to make dependencies available to root and pulsar users"}, "afterCommit": {"oid": "077a95edfd51223b301411870424525c7dfe1548", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/077a95edfd51223b301411870424525c7dfe1548", "committedDate": "2021-01-01T21:57:04Z", "message": "Run pip install as root user to make dependencies available to root and pulsar users"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8830159334337992be31be549a1400ce96d6232e", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/8830159334337992be31be549a1400ce96d6232e", "committedDate": "2021-01-05T04:09:47Z", "message": "Add some documentation; use user 10000 and group 10001"}, "afterCommit": {"oid": "8c95f6beff6347254971ce57aae0f1e78b070c34", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/8c95f6beff6347254971ce57aae0f1e78b070c34", "committedDate": "2021-01-08T04:42:10Z", "message": "Add some documentation; use user 10000 and group 10001"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c95f6beff6347254971ce57aae0f1e78b070c34", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/8c95f6beff6347254971ce57aae0f1e78b070c34", "committedDate": "2021-01-08T04:42:10Z", "message": "Add some documentation; use user 10000 and group 10001"}, "afterCommit": {"oid": "c324cef45eff1c38d42fe78fa34b0bf64a58a7a6", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/c324cef45eff1c38d42fe78fa34b0bf64a58a7a6", "committedDate": "2021-02-06T07:51:36Z", "message": "Rebase and make compatible for OpenShift"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg4MjM3MDE5", "url": "https://github.com/apache/pulsar/pull/8796#pullrequestreview-588237019", "createdAt": "2021-02-11T04:06:40Z", "commit": {"oid": "c7c94609cf77cb415acf95edfc0f0e768469a4ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc013062fbe847cd88159fd79953b9212d491a7", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/cbc013062fbe847cd88159fd79953b9212d491a7", "committedDate": "2021-02-11T05:12:14Z", "message": "Update Dockerfiles to Create and Use pulsar User (nonroot user)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7ac1b498dcf87922b845f22999bd5fb1a165d9", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/cc7ac1b498dcf87922b845f22999bd5fb1a165d9", "committedDate": "2021-02-11T05:12:14Z", "message": "Fix latest-version-test Dockerfile; Optimize use of chown in Dockerfile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9eec32a06dd39c4d4a49d7434435e90130c712f", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/d9eec32a06dd39c4d4a49d7434435e90130c712f", "committedDate": "2021-02-11T05:12:14Z", "message": "Fix missed backslash; explicitly create and chown pulsar directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a5c0efb9d20c4d0e222f673bd3aaffa25a9d1a", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/31a5c0efb9d20c4d0e222f673bd3aaffa25a9d1a", "committedDate": "2021-02-11T05:12:14Z", "message": "Configure supervisord to spawn components with pulsar user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25fcc33b3a6d5883fba93fc30893730ff8a6e004", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/25fcc33b3a6d5883fba93fc30893730ff8a6e004", "committedDate": "2021-02-11T05:12:14Z", "message": "Run pip install as root user to make dependencies available to root and pulsar users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ba1865e914a7ecab8569be1194671f068e47039", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/8ba1865e914a7ecab8569be1194671f068e47039", "committedDate": "2021-02-11T05:12:14Z", "message": "Add some documentation; use user 10000 and group 10001"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7da0d3c17ca27470c1e932ef28e677542e2fbc", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/cb7da0d3c17ca27470c1e932ef28e677542e2fbc", "committedDate": "2021-02-11T05:12:14Z", "message": "Rebase and make compatible for OpenShift"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7830466d3d96342546d2f2007e28c76958bf8a1", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/d7830466d3d96342546d2f2007e28c76958bf8a1", "committedDate": "2021-02-11T05:12:14Z", "message": "Fix documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7c94609cf77cb415acf95edfc0f0e768469a4ad", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/c7c94609cf77cb415acf95edfc0f0e768469a4ad", "committedDate": "2021-02-07T05:44:59Z", "message": "Fix documentation"}, "afterCommit": {"oid": "d7830466d3d96342546d2f2007e28c76958bf8a1", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/d7830466d3d96342546d2f2007e28c76958bf8a1", "committedDate": "2021-02-11T05:12:14Z", "message": "Fix documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47b8e84bda5003301e04a1f6205e9c4395f2140a", "author": {"user": {"login": "michaeljmarshall", "name": "Michael Marshall"}}, "url": "https://github.com/apache/pulsar/commit/47b8e84bda5003301e04a1f6205e9c4395f2140a", "committedDate": "2021-02-11T05:34:04Z", "message": "Fix typo; improve getting started documentation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1023, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}