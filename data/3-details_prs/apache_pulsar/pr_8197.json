{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3Mzg3Mjk1", "number": 8197, "title": "fix pulsar service close exception", "bodyText": "Fix #8196\nMotivation\nIn BrokerService#close, it close interceptor first and close workerGroup in the second. However, in workerGroup.shutdownGracefully(), it will call ServerCnx#channelInactive method. The code with bug as follow.\ngetBrokerService().getInterceptor().onConnectionClosed(this);\n\nIt doesn't check whether getBrokerService().getInterceptor() is null and call onConnectionClosed may cause NullPointerException.\nChanges\n\nIn BrokerService#close, close workerGroup first and close interceptor in the second.\nIn ServerCnx#channelInactive, check getBrokerService().getInterceptor() whether is null before call onConnectionClosed method.", "createdAt": "2020-10-04T06:57:56Z", "url": "https://github.com/apache/pulsar/pull/8197", "merged": true, "mergeCommit": {"oid": "01cd0bcf2e01aad324a641546ee433bf0e20ddb1"}, "closed": true, "closedAt": "2020-10-05T22:28:45Z", "author": {"login": "hangc0276"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPJXdSAH2gAyNDk3Mzg3Mjk1OjhiZTI2Y2ZjMTQzMGUwMmE2MDk4YmNhMGRiODM0NDhjN2QwYmRmYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPrhGJAFqTUwMjQ2NDI4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8be26cfc1430e02a6098bca0db83448c7d0bdfb3", "author": {"user": {"login": "hangc0276", "name": "Hang Chen"}}, "url": "https://github.com/apache/pulsar/commit/8be26cfc1430e02a6098bca0db83448c7d0bdfb3", "committedDate": "2020-10-04T06:40:52Z", "message": "fix pulsar service close exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c2280be72f43678e401b7ec5d45d62f9492a64", "author": {"user": {"login": "hangc0276", "name": "Hang Chen"}}, "url": "https://github.com/apache/pulsar/commit/43c2280be72f43678e401b7ec5d45d62f9492a64", "committedDate": "2020-10-04T06:57:32Z", "message": "format code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjAwNjYx", "url": "https://github.com/apache/pulsar/pull/8197#pullrequestreview-501600661", "createdAt": "2020-10-04T08:13:02Z", "commit": {"oid": "43c2280be72f43678e401b7ec5d45d62f9492a64"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwODoxMzowMlrOHcF4kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwODoxMzowMlrOHcF4kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIxODU3Nw==", "bodyText": "In BrokerService we are setting this field to null.\nWe could run into some NPE anyway in the future.\nIt is better to assign the result of getInterceptor to a local variable and then deference it safely, without calling twice this getter", "url": "https://github.com/apache/pulsar/pull/8197#discussion_r499218577", "createdAt": "2020-10-04T08:13:02Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -215,7 +215,9 @@ public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n         super.channelInactive(ctx);\n         isActive = false;\n         log.info(\"Closed connection from {}\", remoteAddress);\n-        getBrokerService().getInterceptor().onConnectionClosed(this);\n+        if (getBrokerService().getInterceptor() != null) {\n+            getBrokerService().getInterceptor().onConnectionClosed(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43c2280be72f43678e401b7ec5d45d62f9492a64"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa", "author": {"user": {"login": "hangc0276", "name": "Hang Chen"}}, "url": "https://github.com/apache/pulsar/commit/e80cbadf3a4a8016b938d20e63bed0a78576bdfa", "committedDate": "2020-10-04T08:52:52Z", "message": "use local variable to avoid calling getInterceptor twice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjAzNTU4", "url": "https://github.com/apache/pulsar/pull/8197#pullrequestreview-501603558", "createdAt": "2020-10-04T08:54:09Z", "commit": {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjA0NTY5", "url": "https://github.com/apache/pulsar/pull/8197#pullrequestreview-501604569", "createdAt": "2020-10-04T09:08:13Z", "commit": {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjA1NDU5", "url": "https://github.com/apache/pulsar/pull/8197#pullrequestreview-501605459", "createdAt": "2020-10-04T09:19:41Z", "commit": {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNDY0Mjgx", "url": "https://github.com/apache/pulsar/pull/8197#pullrequestreview-502464281", "createdAt": "2020-10-05T22:28:10Z", "commit": {"oid": "e80cbadf3a4a8016b938d20e63bed0a78576bdfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 139, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}